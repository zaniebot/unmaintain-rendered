<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[ty] Simplify union lower bounds and intersection upper bounds in constraint sets - astral-sh/ruff #21871</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[ty] Simplify union lower bounds and intersection upper bounds in constraint sets</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/21871">#21871</a>
        opened by <a href="https://github.com/dcreager">@dcreager</a>
        on 2025-12-09 19:29
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/dcreager">@dcreager</a> on 2025-12-09 19:29</div>
            <div class="timeline-body"><p>In a constraint set, it's not useful for an upper bound to be an intersection type, or for a lower bound to be a union type. Both of those can be rewritten as simpler BDDs:</p>
<pre><code>T ≤ α &amp; β  ⇒ (T ≤ α) ∧ (T ≤ β)
T ≤ α &amp; ¬β ⇒ (T ≤ α) ∧ ¬(T ≤ β)
α | β ≤ T  ⇒ (α ≤ T) ∧ (β ≤ T)
</code></pre>
<p>We were seeing performance issues on #21551 when <em>not</em> performing this simplification. For instance, <code>pandas</code> was producing some constraint sets involving intersections of 8-9 different types. Our sequent map calculation was timing out calculating all of the different permutations of those types:</p>
<pre><code>t1 &amp; t2 &amp; t3 → t1
t1 &amp; t2 &amp; t3 → t2
t1 &amp; t2 &amp; t3 → t3
t1 &amp; t2 &amp; t3 → t1 &amp; t2
t1 &amp; t2 &amp; t3 → t1 &amp; t3
t1 &amp; t2 &amp; t3 → t2 &amp; t3
</code></pre>
<p>(and then imagine what that looks like for 9 types instead of 3...)</p>
<p>With this change, all of those permutations are now encoded in the BDD structure itself, which is very good at simplifying that kind of thing.</p>
<p>Pulling this out of #21551 for separate review.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @dcreager on 2025-12-09 19:29</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @AlexWaygood by @dcreager on 2025-12-09 19:29</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @sharkdp by @dcreager on 2025-12-09 19:29</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">internal</span> added by @dcreager on 2025-12-09 19:29</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ty</span> added by @dcreager on 2025-12-09 19:29</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/astral-sh-bot[bot]">@astral-sh-bot[bot]</a> on 2025-12-09 19:31</div>
            <div class="timeline-body"><!-- generated-comment typing_conformance_diagnostics_diff -->

<h2>Diagnostic diff on <a href="https://github.com/python/typing/tree/9f6d8ced7cd1c8d92687a4e9c96d7716452e471e/conformance">typing conformance tests</a></h2>
<p>No changes detected when running ty on typing conformance tests ✅</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/astral-sh-bot[bot]">@astral-sh-bot[bot]</a> on 2025-12-09 19:33</div>
            <div class="timeline-body"><!-- generated-comment mypy_primer -->

<h2><code>mypy_primer</code> results</h2>
<details>
<summary>Changes were detected when running on open source projects</summary>

<pre><code class="language-diff">beartype (https://github.com/beartype/beartype)
+ beartype/claw/_package/clawpkgtrie.py:66:29: warning[unsupported-base] Unsupported class base with type `&lt;class 'dict[str, PackagesTrieBlacklist]'&gt; | &lt;class 'dict[str, Divergent]'&gt;`
+ beartype/claw/_package/clawpkgtrie.py:247:29: warning[unsupported-base] Unsupported class base with type `&lt;class 'dict[str, PackagesTrieWhitelist]'&gt; | &lt;class 'dict[str, Divergent]'&gt;`
- Found 492 diagnostics
+ Found 494 diagnostics

scikit-build-core (https://github.com/scikit-build/scikit-build-core)
+ src/scikit_build_core/build/_pathutil.py:25:38: error[invalid-argument-type] Argument to function `__new__` is incorrect: Expected `str | PathLike[str]`, found `DirEntry[Path]`
+ src/scikit_build_core/build/_pathutil.py:27:24: error[invalid-argument-type] Argument to function `__new__` is incorrect: Expected `str | PathLike[str]`, found `DirEntry[Path]`
+ src/scikit_build_core/build/wheel.py:98:20: error[no-matching-overload] No overload of bound method `__init__` matches arguments
- Found 41 diagnostics
+ Found 44 diagnostics


</code></pre>
</details>

<p>No memory usage changes detected ✅</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/ty_python_semantic/src/types/constraints.rs</code>:721 on 2025-12-09 21:43</div>
            <div class="timeline-body"><p>Nit: would it make sense to check these conditions separately, immediately after constructing <code>lower</code> and <code>upper</code> respectively? Given that this is an OR, it seems like if <code>lower</code> does not simplify, there's no point in attempting to simplify <code>upper</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/ty_python_semantic/src/types/constraints.rs</code>:2767 on 2025-12-09 21:51</div>
            <div class="timeline-body"><p>Trying to understand what's going on here and how it relates to the previous code. Previously we'd have gotten back a &quot;simplified&quot; constraint with union lower bound and/or intersection upper bound, and we'd have added the pair-implication and single-implications above. Now we just... do nothing? Can you add a comment giving a little explanation for why that's OK?</p>
<p>I guess maybe it's because we now never insert such a &quot;complex intersected constraint&quot; above, so we also don't need to include it in our sequent map?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/ty_python_semantic/src/types/constraints.rs</code>:2172 on 2025-12-09 21:52</div>
            <div class="timeline-body"><p>And this is fine because it's always ok for <code>simplify</code> to do nothing.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> approved on 2025-12-09 21:52</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dcreager">@dcreager</a> on <code>crates/ty_python_semantic/src/types/constraints.rs</code>:721 on 2025-12-09 23:15</div>
            <div class="timeline-body"><p>My thinking was that the disjointness check should take precedence, though I'm having trouble coming up with a specific example where the ordering of the checks would matter.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dcreager">@dcreager</a> on <code>crates/ty_python_semantic/src/types/constraints.rs</code>:2172 on 2025-12-09 23:16</div>
            <div class="timeline-body"><p>That, and also that if the intersection doesn't collapse to a single type, it's not really a simplification. Comment added</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dcreager">@dcreager</a> on <code>crates/ty_python_semantic/src/types/constraints.rs</code>:2767 on 2025-12-09 23:21</div>
            <div class="timeline-body"><p>Right, the sequent map is trying to record which constraints might possibly appear in the BDD, and how they relate to each other. We don't need it to include constraints that we're never going to add to the BDD.</p>
<p>Added a comment</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dcreager">@dcreager</a> reviewed on 2025-12-09 23:22</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2025-12-09 23:24</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/ty_python_semantic/src/types/constraints.rs</code>:721 on 2025-12-09 23:24</div>
            <div class="timeline-body"><p>Ah, I didn't think about that, I think you're right that if we can identify disjointness we want to do that. I think that means not worth changing anything here.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @dcreager on 2025-12-10 00:49</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @dcreager on 2025-12-10 00:49</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-12-10 00:49</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-12-10 08:55</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/ty_python_semantic/src/types/constraints.rs</code>:505 on 2025-12-10 08:55</div>
            <div class="timeline-body"><p>You write these as implications, but don't we need those to be equivalences?</p>
<p>The one about negations looks interesting. I guess it could be simplified to <code>T ≤ ¬β ⇒ ¬(T ≤ β)</code>, since the intersection part of it is already covered by the first rule. But more importantly, is this really correct? The left hand side seems to always be true for <code>T = Never</code>, whereas the right hand side seems to always be false for <code>T = Never</code>. That would mean it's not even true as an implication?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dcreager">@dcreager</a> reviewed on 2025-12-10 14:38</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dcreager">@dcreager</a> on <code>crates/ty_python_semantic/src/types/constraints.rs</code>:505 on 2025-12-10 14:38</div>
            <div class="timeline-body"><blockquote>
<p>The one about negations looks interesting. I guess it could be simplified to <code>T ≤ ¬β ⇒ ¬(T ≤ β)</code>, since the intersection part of it is already covered by the first rule. But more importantly, is this really correct? The left hand side seems to always be true for <code>T = Never</code>, whereas the right hand side seems to always be false for <code>T = Never</code>. That would mean it's not even true as an implication?</p>
</blockquote>
<p>Ah good catch! Negation doesn't distribute through the check like I wrote it. It should be something like</p>
<pre><code>T ≤ ¬α &amp; ¬β ⇒ (T ≤ ¬α) ∧ (T ≤ ¬β)
</code></pre>
<p>i.e. we can still separate out the negation elements of the intersection, but they should remain negated types and a positive ≤ check.</p>
<p>I'll fix this in a follow-on PR.</p>
<blockquote>
<p>You write these as implications, but don't we need those to be equivalences?</p>
</blockquote>
<p>They are equivalences, but we're using this as a normalization step, so we only want to apply them in the direction that I've written them. That is, the goal with this change is that the upper bound of a constraint will never be an intersection type anymore. (and ditto for the lower bound never being a union type)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-12-10 14:47</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/ty_python_semantic/src/types/constraints.rs</code>:505 on 2025-12-10 14:47</div>
            <div class="timeline-body"><blockquote>
<blockquote>
<p>You write these as implications, but don't we need those to be equivalences?</p>
</blockquote>
<p>They are equivalences, but we're using this as a normalization step, so we only want to apply them in the direction that I've written them. That is, the goal with this change is that the upper bound of a constraint will never be an intersection type anymore. (and ditto for the lower bound never being a union type)</p>
</blockquote>
<p>:+1:</p>
<p>I'm being pedantic, but I think what I meant was: we need these to be equivalences, or otherwise, the structural simplification that we apply here (in one direction) might lead to a constraint set that is not equivalent to the original constraint set anymore. But even if my thinking is correct, there's no need to change anything. The arrows can also just represent the direction in which we're performing the simplification. I mainly wanted to understand.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dcreager">@dcreager</a> reviewed on 2025-12-10 15:54</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dcreager">@dcreager</a> on <code>crates/ty_python_semantic/src/types/constraints.rs</code>:505 on 2025-12-10 15:54</div>
            <div class="timeline-body"><blockquote>
<p>we need these to be equivalences, or otherwise, the structural simplification that we apply here (in one direction) might lead to a constraint set that is not equivalent to the original constraint set anymore.</p>
</blockquote>
<p>Got it! I think I got this meaning correct in the new comment in https://github.com/astral-sh/ruff/pull/21897</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 16:42:35 UTC
    </footer>
</body>
</html>
