<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[`pyupgrade`]  Apply `UP008` only when the `__class__` cell exists - astral-sh/ruff #19424</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[<code>pyupgrade</code>]  Apply <code>UP008</code> only when the <code>__class__</code> cell exists</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/19424">#19424</a>
        opened by <a href="https://github.com/IDrokin117">@IDrokin117</a>
        on 2025-07-18 15:33
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/IDrokin117">@IDrokin117</a></div>
            <div class="timeline-body">Summary
<p>Resolves #19357</p>
<p>Skip UP008 diagnostic for <code>builtins.super(P, self)</code> calls when <code>__class__</code> is not referenced locally, preventing incorrect fixes.</p>
<p><strong>Note:</strong> I haven&#x27;t found concrete information about which cases <code>__class__</code> will be loaded into the scope. Let me know if anyone has references, it would be useful to enhance the implementation. I did a lot of tests to determine when <code>__class__</code> is loaded. Considered sources:</p>
<ol>
<li><a href="https://docs.python.org/3/library/functions.html#super">Python doc super</a></li>
<li><a href="https://docs.python.org/3/tutorial/classes.html">Python doc classes</a></li>
<li><a href="https://peps.python.org/pep-3135/#specification">pep-3135</a></li>
</ol>
<p>As I understand it, Python will inject at runtime into local scope a <code>__class__</code> variable if it detects references to <code>super</code> or <code>__class__</code>. This allows calling <code>super()</code> and passing appropriate parameters. However, the compiler doesn&#x27;t do the same for <code>builtins.super</code>, so we need to somehow introduce <code>__class__</code> into the local scope.</p>
<p>I figured out <code>__class__</code> will be in scope with valid value when two conditions are met:</p>
<ol>
<li><code>super</code> or <code>__class__</code> names have been loaded within function scope</li>
<li><code>__class__</code> is not overridden.</li>
</ol>
<p>I think my solution isn&#x27;t elegant, so I would be appreciate a detailed review.</p>
Test Plan
<p>Added 19 test cases, updated snapshots.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-07-18 15:43</div>
            <div class="timeline-body">

<code>ruff-ecosystem</code> results
Linter (stable)
<p>✅ ecosystem check detected no linter changes.</p>
Linter (preview)
<p>✅ ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Converted to draft by <a href="https://github.com/IDrokin117">@IDrokin117</a> on 2025-07-20 13:13</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by <a href="https://github.com/IDrokin117">@IDrokin117</a> on 2025-07-21 15:01</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/IDrokin117">@IDrokin117</a> on 2025-07-24 12:56</div>
            <div class="timeline-body"><p>@ntBre Could you please review a PR?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/ntBre">@ntBre</a> by <a href="https://github.com/ntBre">@ntBre</a> on 2025-07-24 13:04</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by <a href="https://github.com/ntBre">@ntBre</a> on 2025-07-24 13:04</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">fixes</span> added by <a href="https://github.com/ntBre">@ntBre</a> on 2025-07-24 13:04</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntBre">@ntBre</a> on 2025-07-24 13:04</div>
            <div class="timeline-body"><p>Will do! Sorry, I&#x27;m a bit behind on my review queue, but this has been on the list.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/pyupgrade/rules/super_call_with_parameters.rs</code>:103 on 2025-08-07 15:58</div>
            <div class="timeline-body"><p>Oh I see, you need <code>func_stmt</code> below. I <em>think</em> you can use something like this:</p>
<pre><code>let Some(func_stmt @ Stmt::FunctionDef(ast::StmtFunctionDef {
    ...
</code></pre>
<p>in the old version, but this is fine if not.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/pyupgrade/rules/super_call_with_parameters.rs</code>:207 on 2025-08-07 15:59</div>
            <div class="timeline-body"><pre><code>
/// Returns `true` if the function contains load references to `__class__` or `super` without
</code></pre>
<p>tiny nit</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_python_ast/src/helpers.rs</code>:1 on 2025-08-07 16:01</div>
            <div class="timeline-body"><p>Does this need to be in the <code>ruff_python_ast</code> crate? It usually makes sense to define the visitor next to the rule using it, if it&#x27;s only used by that rule.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/pyupgrade/rules/super_call_with_parameters.rs</code>:223 on 2025-08-07 16:04</div>
            <div class="timeline-body"><p>Because these are both <code>any</code>, I think we can just check these conditions as the visitor visits and avoid needing to collect a <code>Vec</code> of expressions. We may even be able to terminate the visitor early in that case.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/pyupgrade/rules/super_call_with_parameters.rs</code>:224 on 2025-08-07 16:05</div>
            <div class="timeline-body"><p>This looks like a cheaper check than visiting a <code>Stmt</code>, so we should probably check this first and return early if it&#x27;s true (?)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/pyupgrade/rules/super_call_with_parameters.rs</code>:228 on 2025-08-07 16:06</div>
            <div class="timeline-body"><p>I think you can use <code>match_builtin_expr</code> for this:</p>
<p>https://github.com/astral-sh/ruff/blob/96ffd8a134d62f5426c9d94d15adb21100d90f01/crates/ruff_python_semantic/src/model.rs#L319</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/resources/test/fixtures/pyupgrade/UP008.py</code>:156 on 2025-08-07 16:11</div>
            <div class="timeline-body"><p>I think we could strip these examples down a little bit, just to make it clearer which parts are important. For example, I don&#x27;t think the parent class even needs to exist actually, and the same with the following calls. Basically I&#x27;d just use this:</p>
<pre><code>class ChildD1:
    def f(self):
        if False: __class__ # Python injects __class__ into scope
        builtins.super(ChildD1, self).f()
</code></pre>
<p>unless I&#x27;m missing some other critical part of the example.</p>
<p>Or we could maybe preserve one of the parent classes and the calls, if it&#x27;s helpful to be able to run the code. I just don&#x27;t think we need one parent class per example, if they&#x27;re all the same, at least.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-08-07 16:23</div>
            <div class="timeline-body"><p>Thanks, this looks great! Sorry again for the delay.</p>
<p>I just had a few small suggestions.</p>
<p>Thanks for the docs links too. I skimmed over a few of those, and I think you&#x27;ve captured everything I understood from them and from the issue too :)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/IDrokin117">@IDrokin117</a> on <code>crates/ruff_linter/src/rules/pyupgrade/rules/super_call_with_parameters.rs</code>:103 on 2025-08-07 18:55</div>
            <div class="timeline-body"><p>Got it. Changed to @ usage</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/IDrokin117">@IDrokin117</a> on <code>crates/ruff_linter/src/rules/pyupgrade/rules/super_call_with_parameters.rs</code>:207 on 2025-08-07 19:00</div>
            <div class="timeline-body"><p>Edited</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/IDrokin117">@IDrokin117</a> on <code>crates/ruff_python_ast/src/helpers.rs</code>:1 on 2025-08-07 19:09</div>
            <div class="timeline-body"><p>I did it just because at least <code>AwaitVisitor</code> and <code>RaiseStatementVisitor</code> are defined in helpers, but are used only once in rules (<code>cancel_scope_no_checkpoint</code> and <code>raise_without_from_inside_except</code> respectively) similar to my use case. But yes, it makes sense to move it next to the rule. Done.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/IDrokin117">@IDrokin117</a> on <code>crates/ruff_linter/src/rules/pyupgrade/rules/super_call_with_parameters.rs</code>:224 on 2025-08-07 19:21</div>
            <div class="timeline-body"><p>Good point. Moved it to the beginning.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/IDrokin117">@IDrokin117</a> on <code>crates/ruff_linter/src/rules/pyupgrade/rules/super_call_with_parameters.rs</code>:228 on 2025-08-07 19:34</div>
            <div class="timeline-body"><p><code>match_builtin_expr(&amp;call.func, &quot;super&quot;)</code> returns true for both cases: <code>super()</code> and <code>builtins.super()</code>, but I need to check only the second case.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/IDrokin117">@IDrokin117</a> on <code>crates/ruff_linter/src/rules/pyupgrade/rules/super_call_with_parameters.rs</code>:223 on 2025-08-07 21:06</div>
            <div class="timeline-body"><p>My intention was to make it simple and not necessarily optimized.<br>
I have reworked it, and now it is implemented according to your recommendation, but I think it is more complex to read. I would appreciate any simplification advice.</p>
<p>BTW, it was intentional to pass conditions due to initialization rather than hardcode them in <code>visit_expr</code>. In my opinion, it provides more flexibility for future changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/IDrokin117">@IDrokin117</a> on <code>crates/ruff_linter/resources/test/fixtures/pyupgrade/UP008.py</code>:156 on 2025-08-07 21:18</div>
            <div class="timeline-body"><p>Make sense for me. Removed duplicated parents and instance creation with method calling.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/IDrokin117">@IDrokin117</a> reviewed on 2025-08-07 21:21</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/ntBre">@ntBre</a> by <a href="https://github.com/IDrokin117">@IDrokin117</a> on 2025-08-09 20:08</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntBre">@ntBre</a> on 2025-08-13 18:22</div>
            <div class="timeline-body"><p>I just came back to this notification right after reviewing <a href="https://github.com/astral-sh/ruff/pull/19783">astral-sh/ruff#19783</a>. I somehow hadn&#x27;t connected these two before, but now I&#x27;m wondering if they have the same root cause. I think if we&#x27;re able to work out a neat, general solution for binding the <code>__class__</code> cell it might help here too.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntBre">@ntBre</a> on 2025-08-26 13:54</div>
            <div class="timeline-body"><p>We added a new <code>ScopeKind::DunderClassCell</code> (and <code>BindingKind::DunderClassCell</code>) in <a href="https://github.com/astral-sh/ruff/pull/20048">astral-sh/ruff#20048</a>. I don&#x27;t believe that will resolve the issue addressed by this PR, but would you mind seeing if it makes anything easier? I was hoping it might help to avoid the new <code>Visitor</code>, but I think we&#x27;ll still need some rule-specific changes in any case.</p>
<p>Thanks again for your work here :)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/IDrokin117">@IDrokin117</a> on 2025-08-26 18:05</div>
            <div class="timeline-body"><p>@ntBre Good news! Here are my thoughts after reviewing the new feature.<br>
It seems the <code>__class__</code> binding is being created in any case now, regardless of whether <code>__class__</code> and <code>super</code> names are present. Am I right? This is going to be simple and good for some rules, but not for this case. Since the <code>__class__</code> binding pretends to always exist within a method, it doesn&#x27;t provide any new information. I mean, if a <code>__class__</code> cell is available, then <code>builtins.super()</code> has to work. But that&#x27;s not true since <code>__class__</code> is not always available. I see two options to resolve the issue:</p>
<ol>
<li>Left the extra visitor to ensure determination of whether <code>__class__</code> is really injected at runtime based on specific rules.</li>
<li>Simplify the rule and apply it only if <code>super()</code> is encountered, ignoring <code>builtins.super()</code>.</li>
</ol>
<p>Since I&#x27;ve already implemented tailored <code>__class__</code> determination, I prefer the first option. What do you think?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntBre">@ntBre</a> on 2025-08-29 13:34</div>
            <div class="timeline-body"><p>Thanks for looking into it and rebasing the PR!</p>
<blockquote>
<p>It seems the <code>__class__</code> binding is being created in any case now, regardless of whether <code>__class__</code> and <code>super</code> names are present. Am I right?</p>
</blockquote>
<p>Yes that&#x27;s right, we didn&#x27;t try to detect if <code>__class__</code> or <code>super</code> was used, so it makes sense that it may not help here.</p>
<blockquote>
<ol>
<li>Left the extra visitor to ensure determination of whether <code>__class__</code> is really injected at runtime based on specific rules.</li>
<li>Simplify the rule and apply it only if <code>super()</code> is encountered, ignoring <code>builtins.super()</code>.</li>
</ol>
<p>Since I&#x27;ve already implemented tailored <code>__class__</code> determination, I prefer the first option. What do you think?</p>
</blockquote>
<p>Makes sense to me, I&#x27;ll give this another review soon!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/pyupgrade/rules/super_call_with_parameters.rs</code>:225 on 2025-09-09 15:45</div>
            <div class="timeline-body"><p>Would it make sense to combine these conditions in one closure? Maybe something like:</p>
<pre><code>        |expr: &amp;Expr| {
            expr.as_name_expr()
                .is_some_and(|name| matches!(name.id.as_str(), &quot;super&quot; | &quot;__class__&quot;) &amp;&amp; name.ctx.is_load())
        },
</code></pre>
<p>I think it could even make sense just to hard-code this check into the visitor since we&#x27;re not really using it generically, as far as I can tell.</p>
<p>I think you might have been addressing this in <a href="https://github.com/astral-sh/ruff/pull/19424#discussion_r2261395337">this comment</a>, but we can always make it more general in the future if we have to. I&#x27;m not really foreseeing that at the moment.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/pyupgrade/rules/super_call_with_parameters.rs</code>:243 on 2025-09-09 15:51</div>
            <div class="timeline-body"><p>Would an <code>Option&lt;&amp;&#x27;a Expr&gt;</code> make sense here? It looks like we only ever check if it&#x27;s empty or not, which could be <code>is_none</code> instead (and <code>Some(expr)</code> instead of <code>insert(0)</code>). Or just a boolean flag since it looks like we just want to record whether we found it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/pyupgrade/rules/super_call_with_parameters.rs</code>:212 on 2025-09-09 15:59</div>
            <div class="timeline-body"><p>Based on my reading of the <a href="https://docs.python.org/3/reference/datamodel.html#creating-the-class-object">docs</a> we found for the other <code>__class__</code> PR, I think we may need to check <em>all</em> of the methods in a class definition:</p>
<blockquote>
<p><code>__class__</code> is an implicit closure reference created by the compiler if <strong>any methods</strong> in a class body refer to either <code>__class__</code> or <code>super</code>.</p>
</blockquote>
<p>(emphasis mine)</p>
<p>This could be quite expensive since we&#x27;d have to re-visit the whole class body, so it might still make sense to approximate the behavior by only checking each function separately. But we could still add a test and document the limitation, at least.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-09-09 16:11</div>
            <div class="timeline-body"><p>Thanks! Just a couple of minor simplification suggestions and one corner case from the docs.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dscorbett">@dscorbett</a> on <code>crates/ruff_linter/src/rules/pyupgrade/rules/super_call_with_parameters.rs</code>:212 on 2025-09-09 16:47</div>
            <div class="timeline-body"><p>Each method is considered individually. <code>__class__</code> in one method has no effect on another.</p>
<pre><code>&gt;&gt;&gt; class C(str):
...     def f1(self):
...         return super().__len__()
...     def f2(self):
...         import builtins
...         return builtins.super().__len__()
... 
&gt;&gt;&gt; C().f1()
0
&gt;&gt;&gt; C().f2()
Traceback (most recent call last):
  File &quot;&lt;python-input-2&gt;&quot;, line 1, in &lt;module&gt;
    C().f2()
    ~~~~~~^^
  File &quot;&lt;python-input-0&gt;&quot;, line 6, in f2
    return builtins.super().__len__()
           ~~~~~~~~~~~~~~^^
RuntimeError: super(): __class__ cell not found
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dscorbett">@dscorbett</a> reviewed on 2025-09-09 16:47</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/IDrokin117">@IDrokin117</a> reviewed on 2025-09-09 16:50</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/IDrokin117">@IDrokin117</a> on <code>crates/ruff_linter/src/rules/pyupgrade/rules/super_call_with_parameters.rs</code>:212 on 2025-09-09 16:50</div>
            <div class="timeline-body"><p>At least test case <code>ChildI2</code> covers it</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-09-09 16:55</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/pyupgrade/rules/super_call_with_parameters.rs</code>:212 on 2025-09-09 16:55</div>
            <div class="timeline-body"><p>Ah okay, thanks. I should have actually tested it instead of reading so much into the phrasing. And I overlooked the existing test :facepalm: thank you both!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/IDrokin117">@IDrokin117</a> reviewed on 2025-09-09 18:08</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/IDrokin117">@IDrokin117</a> on <code>crates/ruff_linter/src/rules/pyupgrade/rules/super_call_with_parameters.rs</code>:225 on 2025-09-09 18:08</div>
            <div class="timeline-body"><p>I simplified the Visitor</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/IDrokin117">@IDrokin117</a> on <code>crates/ruff_linter/src/rules/pyupgrade/rules/super_call_with_parameters.rs</code>:243 on 2025-09-09 18:09</div>
            <div class="timeline-body"><p>Made it boolean</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/IDrokin117">@IDrokin117</a> reviewed on 2025-09-09 18:09</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/ntBre">@ntBre</a> by <a href="https://github.com/IDrokin117">@IDrokin117</a> on 2025-09-09 18:09</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> approved on 2025-09-09 18:58</div>
            <div class="timeline-body"><p>Thanks!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from &quot;[`pyupgrade`]  Apply UP008 only when the __class__ cell exists (`UP008`)&quot; to &quot;[`pyupgrade`]  Apply `UP008` only when the `__class__` cell exists (`UP008`)&quot; by <a href="https://github.com/ntBre">@ntBre</a> on 2025-09-09 18:58</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from &quot;[`pyupgrade`]  Apply `UP008` only when the `__class__` cell exists (`UP008`)&quot; to &quot;[`pyupgrade`]  Apply `UP008` only when the `__class__` cell exists&quot; by <a href="https://github.com/ntBre">@ntBre</a> on 2025-09-09 18:59</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/ntBre">@ntBre</a> on 2025-09-09 18:59</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/ntBre">@ntBre</a> on 2025-09-09 18:59</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:16:46 UTC
    </footer>
</body>
</html>
