<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>`ruff server`: Support publish diagnostics as a fallback when pull diagnostics aren't supported - astral-sh/ruff #11092</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1><code>ruff server</code>: Support publish diagnostics as a fallback when pull diagnostics aren't supported</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/11092">#11092</a>
        opened by <a href="https://github.com/snowsignal">@snowsignal</a>
        on 2024-04-22 20:17
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/snowsignal">@snowsignal</a></div>
            <div class="timeline-body"><h2>Summary</h2>
<p>Fixes #11059</p>
<p>Several major editors don't support <a href="https://microsoft.github.io/language-server-protocol/specifications/lsp/3.17/specification/#textDocument_pullDiagnostics">pull diagnostics</a>, a method of sending diagnostics to the client that was introduced in version <code>0.3.17</code> of the specification. Until now, <code>ruff server</code> has only used pull diagnostics, which resulted in diagnostics not being available on Neovim and Helix, which don't support pull diagnostics yet (though Neovim <code>10.0</code> will have support for this).</p>
<p><code>ruff server</code> will now utilize the older method of sending diagnostics, known as 'publish diagnostics', when pull diagnostics aren't supported by the client. This involves re-linting a document every time it is opened or modified, and then sending the diagnostics generated from that lint to the client via the <code>textDocument/publishDiagnostics</code> notification.</p>
<h2>Test Plan</h2>
<p>The easiest way to test that this PR works is to check if diagnostics show up on Neovim <code>&lt;=0.9</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">server</span> added by @snowsignal on 2024-04-22 20:17</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone "Ruff Server: Beta" by @snowsignal on 2024-04-22 20:17</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/snowsignal">@snowsignal</a> reviewed on 2024-04-22 20:21</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/snowsignal">@snowsignal</a> on <code>crates/ruff_server/src/server/api/notifications/did_change.rs</code>:46 on 2024-04-22 20:21</div>
            <div class="timeline-body"><p>We can <code>.unwrap()</code> here instead of throwing an error because the document is guaranteed to exist (we've already modified it) which means that the snapshot should also exist.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2024-04-22 20:29</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> approved on 2024-04-23 01:34</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @snowsignal on 2024-04-23 04:06</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @snowsignal on 2024-04-23 04:06</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-04-23 04:06</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2024-04-23 04:40</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_server/src/server/api/notifications/did_change.rs</code>:46 on 2024-04-23 04:40</div>
            <div class="timeline-body"><p>I'd add it as a <code>SAFETY:</code> comment for posterity.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2024-04-23 04:49</div>
            <div class="timeline-body"><p>Thank you for implementing it so quickly!</p>
<p>Unless it's already done, we'd need to clear the diagnostics for the document for <code>on_close</code> event otherwise the diagnostics will remain in the &quot;Problems&quot; tab even after closing the file. Refer https://github.com/astral-sh/ruff-lsp/blob/187d7790be0783b9ac41ce025a724cf389bf575c/ruff_lsp/server.py#L459-L464</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-04-23 07:29</div>
            <div class="timeline-body"><p>I think our old extension also had an option to pull diagnostics only on save. But I don't mind pushing this out until we're asked to build this (especially because we can't really support it when using pull diagnostics)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-04-23 08:46</div>
            <div class="timeline-body"><p>@MichaReiser Are you referring to <code>onType</code> / <code>onSave</code> option value? I was about to comment on that.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/snowsignal">@snowsignal</a> on 2024-04-23 19:41</div>
            <div class="timeline-body"><p>@dhruvmanila I've opened an issue (https://github.com/astral-sh/ruff/issues/11114) to solve the problem you mentioned earlier.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/snowsignal">@snowsignal</a> on 2024-04-23 19:43</div>
            <div class="timeline-body"><p>As for the <code>onSave</code>/<code>onType</code> setting - I was going to hold off on implementing that unless there seems to be a need for it.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:03:56 UTC
    </footer>
</body>
</html>
