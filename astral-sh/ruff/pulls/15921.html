<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[`ruff`] Analyze deferred annotations before enforcing `mutable-(data)class-default` and `function-call-in-dataclass-default-argument` (`RUF008`,`RUF009`,`RUF012`) - astral-sh/ruff #15921</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[<code>ruff</code>] Analyze deferred annotations before enforcing <code>mutable-(data)class-default</code> and <code>function-call-in-dataclass-default-argument</code> (<code>RUF008</code>,<code>RUF009</code>,<code>RUF012</code>)</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/15921">#15921</a>
        opened by <a href="https://github.com/dylwil3">@dylwil3</a>
        on 2025-02-04 01:46
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/dylwil3">@dylwil3</a> on 2025-02-04 01:46</div>
            <div class="timeline-body"><p>This PR moves the rules <a href="https://docs.astral.sh/ruff/rules/mutable-dataclass-default/#mutable-dataclass-default-ruf008"><code>mutable-dataclass-default</code> (<code>RUF008</code>)</a>, <a href="https://docs.astral.sh/ruff/rules/function-call-in-dataclass-default-argument/#function-call-in-dataclass-default-argument-ruf009">function-call-in-dataclass-default-argument (RUF009)</a>, and <a href="https://docs.astral.sh/ruff/rules/mutable-class-default/#mutable-class-default-ruf012"><code>mutable-class-default</code> (<code>RUF012</code>)</a>   to the checker for deferred scopes, which avoids false positives caused by a failure to account for deferred resolution of annotations.</p>
<p>This PR does not address the issue of stringized annotations, which are also deferred but require a different approach.</p>
<p>Closes #15857</p>
<hr />
<p>Note: As a consequence of this change, no lint for <code>RUF012</code> will be emitted in the following example with a <code>NameError</code>:</p>
<pre><code class="language-python">class A:
   mutable_default : ClassVar[list[int]] = []

from typing import ClassVar
</code></pre>
<p>But that's okay - it's not the job of <code>RUF012</code> or <code>RUF008</code> to detect this.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @dylwil3 on 2025-02-04 01:46</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">rule</span> added by @dylwil3 on 2025-02-04 01:46</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-02-04 01:52</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>ℹ️ ecosystem check <strong>detected linter changes</strong>. (+5 -5 violations, +0 -0 fixes in 1 projects; 54 projects unchanged)</p>
<details><summary><a href="https://github.com/apache/superset">apache/superset</a> (+5 -5 violations, +0 -0 fixes)</summary>
<p>
<pre>ruff check --no-cache --exit-zero --ignore RUF9 --no-fix --output-format concise --no-preview --select ALL</pre>
</p>
<p>

<pre>
+ <a href='https://github.com/apache/superset/blob/c64018d42135f36e81d0f630176880572e281dc3/superset/commands/dashboard/importers/v1/__init__.py#L47'>superset/commands/dashboard/importers/v1/__init__.py:47:5:</a> D400 First line should end with a period
- <a href='https://github.com/apache/superset/blob/c64018d42135f36e81d0f630176880572e281dc3/superset/commands/dashboard/importers/v1/__init__.py#L47'>superset/commands/dashboard/importers/v1/__init__.py:47:5:</a> D400 First line should end with a period
- <a href='https://github.com/apache/superset/blob/c64018d42135f36e81d0f630176880572e281dc3/superset/models/helpers.py#L992'>superset/models/helpers.py:992:13:</a> D401 First line of docstring should be in imperative mood: "Some engines change the case or generate bespoke column names, either by"
+ <a href='https://github.com/apache/superset/blob/c64018d42135f36e81d0f630176880572e281dc3/superset/models/helpers.py#L992'>superset/models/helpers.py:992:13:</a> D401 First line of docstring should be in imperative mood: "Some engines change the case or generate bespoke column names, either by"
- <a href='https://github.com/apache/superset/blob/c64018d42135f36e81d0f630176880572e281dc3/superset/models/helpers.py#L992'>superset/models/helpers.py:992:13:</a> D415 First line should end with a period, question mark, or exclamation point
+ <a href='https://github.com/apache/superset/blob/c64018d42135f36e81d0f630176880572e281dc3/superset/models/helpers.py#L992'>superset/models/helpers.py:992:13:</a> D415 First line should end with a period, question mark, or exclamation point
+ <a href='https://github.com/apache/superset/blob/c64018d42135f36e81d0f630176880572e281dc3/tests/integration_tests/security_tests.py#L2023'>tests/integration_tests/security_tests.py:2023:9:</a> ANN201 Missing return type annotation for public function `test_get_guest_user_with_request_form`
- <a href='https://github.com/apache/superset/blob/c64018d42135f36e81d0f630176880572e281dc3/tests/integration_tests/security_tests.py#L2023'>tests/integration_tests/security_tests.py:2023:9:</a> ANN201 Missing return type annotation for public function `test_get_guest_user_with_request_form`
+ <a href='https://github.com/apache/superset/blob/c64018d42135f36e81d0f630176880572e281dc3/tests/integration_tests/sql_validator_tests.py#L102'>tests/integration_tests/sql_validator_tests.py:102:9:</a> ANN201 Missing return type annotation for public function `test_valid_syntax`
- <a href='https://github.com/apache/superset/blob/c64018d42135f36e81d0f630176880572e281dc3/tests/integration_tests/sql_validator_tests.py#L102'>tests/integration_tests/sql_validator_tests.py:102:9:</a> ANN201 Missing return type annotation for public function `test_valid_syntax`
</pre>

</p>
</details>
<details><summary>Changes by rule (4 rules affected)</summary>
<p>

<p>| code | total | + violation | - violation | + fix | - fix |
| ---- | ------- | --------- | -------- | ----- | ---- |
| ANN201 | 4 | 2 | 2 | 0 | 0 |
| D400 | 2 | 1 | 1 | 0 | 0 |
| D401 | 2 | 1 | 1 | 0 | 0 |
| D415 | 2 | 1 | 1 | 0 | 0 |</p>
</p>
</details>

<h3>Linter (preview)</h3>
<p>ℹ️ ecosystem check <strong>detected linter changes</strong>. (+6 -6 violations, +0 -0 fixes in 1 projects; 54 projects unchanged)</p>
<details><summary><a href="https://github.com/apache/superset">apache/superset</a> (+6 -6 violations, +0 -0 fixes)</summary>
<p>
<pre>ruff check --no-cache --exit-zero --ignore RUF9 --no-fix --output-format concise --preview --select ALL</pre>
</p>
<p>

<pre>
+ <a href='https://github.com/apache/superset/blob/c64018d42135f36e81d0f630176880572e281dc3/superset/commands/chart/importers/v1/__init__.py#L1'>superset/commands/chart/importers/v1/__init__.py:1:1:</a> D104 Missing docstring in public package
- <a href='https://github.com/apache/superset/blob/c64018d42135f36e81d0f630176880572e281dc3/superset/commands/chart/importers/v1/__init__.py#L1'>superset/commands/chart/importers/v1/__init__.py:1:1:</a> D104 Missing docstring in public package
+ <a href='https://github.com/apache/superset/blob/c64018d42135f36e81d0f630176880572e281dc3/superset/connectors/sqla/models.py#L789'>superset/connectors/sqla/models.py:789:9:</a> D102 Missing docstring in public method
- <a href='https://github.com/apache/superset/blob/c64018d42135f36e81d0f630176880572e281dc3/superset/connectors/sqla/models.py#L789'>superset/connectors/sqla/models.py:789:9:</a> D102 Missing docstring in public method
+ <a href='https://github.com/apache/superset/blob/c64018d42135f36e81d0f630176880572e281dc3/superset/models/helpers.py#L626'>superset/models/helpers.py:626:9:</a> D102 Missing docstring in public method
- <a href='https://github.com/apache/superset/blob/c64018d42135f36e81d0f630176880572e281dc3/superset/models/helpers.py#L626'>superset/models/helpers.py:626:9:</a> D102 Missing docstring in public method
+ <a href='https://github.com/apache/superset/blob/c64018d42135f36e81d0f630176880572e281dc3/superset/models/helpers.py#L818'>superset/models/helpers.py:818:9:</a> D102 Missing docstring in public method
- <a href='https://github.com/apache/superset/blob/c64018d42135f36e81d0f630176880572e281dc3/superset/models/helpers.py#L818'>superset/models/helpers.py:818:9:</a> D102 Missing docstring in public method
+ <a href='https://github.com/apache/superset/blob/c64018d42135f36e81d0f630176880572e281dc3/tests/integration_tests/security/row_level_security_tests.py#L170'>tests/integration_tests/security/row_level_security_tests.py:170:9:</a> ANN202 Missing return type annotation for private function `_get_test_dataset`
- <a href='https://github.com/apache/superset/blob/c64018d42135f36e81d0f630176880572e281dc3/tests/integration_tests/security/row_level_security_tests.py#L170'>tests/integration_tests/security/row_level_security_tests.py:170:9:</a> ANN202 Missing return type annotation for private function `_get_test_dataset`
- <a href='https://github.com/apache/superset/blob/c64018d42135f36e81d0f630176880572e281dc3/tests/integration_tests/sql_validator_tests.py#L115'>tests/integration_tests/sql_validator_tests.py:115:9:</a> PLR6301 Method `test_invalid_syntax` could be a function, class method, or static method
+ <a href='https://github.com/apache/superset/blob/c64018d42135f36e81d0f630176880572e281dc3/tests/integration_tests/sql_validator_tests.py#L115'>tests/integration_tests/sql_validator_tests.py:115:9:</a> PLR6301 Method `test_invalid_syntax` could be a function, class method, or static method
</pre>

</p>
</details>
<details><summary>Changes by rule (4 rules affected)</summary>
<p>

<p>| code | total | + violation | - violation | + fix | - fix |
| ---- | ------- | --------- | -------- | ----- | ---- |
| D102 | 6 | 3 | 3 | 0 | 0 |
| D104 | 2 | 1 | 1 | 0 | 0 |
| ANN202 | 2 | 1 | 1 | 0 | 0 |
| PLR6301 | 2 | 1 | 1 | 0 | 0 |</p>
</p>
</details>

</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_linter/src/rules/ruff/snapshots/ruff_linter__rules__ruff__tests__RUF012_RUF012.py.snap</code>:77 on 2025-02-04 08:44</div>
            <div class="timeline-body"><p>Hmm, why are we emitting an error here? It looks like it already is annotated with ClassVar?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> approved on 2025-02-04 08:45</div>
            <div class="timeline-body"><p>Looks good, just one question</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-02-04 08:58</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/ruff/rules/mutable_class_default.rs</code>:82 on 2025-02-04 08:58</div>
            <div class="timeline-body"><p>Unrelated to this PR: It's sort of annoying that you had to change the method signature just because you can only get a read-only <code>Checker</code> here. I think we should start refactoring <code>Checker</code> so that:</p>
<ul>
<li>Add a <code>Checker::push_diagnostic</code> or <code>report_diagnostic</code> method</li>
<li>Maybe: Add a <code>Checker::extend_diagnostics</code> or <code>report_diagnostics</code> method</li>
<li>Then, change <code>Checker::diagnostics</code> to a <code>RefCell&lt;Vec&lt;Diagnostic&gt;&gt;</code></li>
</ul>
<p>Doing so has a few advantages:</p>
<ul>
<li>It is no longer required to take a <code>&amp;mut Checker</code> only to push diagnostics</li>
<li>We have a central place to perform some operation on diagnostics. E.g. we could adopt Red Knot's approach to filter out suppressed diagnostics when they're emitted instead of filtering them out at the very end.</li>
</ul>
<p>Obviously, this isn't something for this PR but maybe a fun refactor for another day ;)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Daverball">@Daverball</a> reviewed on 2025-02-04 15:11</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/Daverball">@Daverball</a> on <code>crates/ruff_linter/src/rules/ruff/rules/mutable_class_default.rs</code>:82 on 2025-02-04 15:11</div>
            <div class="timeline-body"><p>Yes, please. Every single time I've run into lifetime issues or borrow checker complaints, it was because of a mutable borrow of <code>Checker</code>. This also would allow us to pass the checker directly into some of the helper functions, instead of having to pass five separate arguments that are all just borrowed from the checker.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dylwil3">@dylwil3</a> reviewed on 2025-02-04 22:29</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dylwil3">@dylwil3</a> on <code>crates/ruff_linter/src/rules/ruff/snapshots/ruff_linter__rules__ruff__tests__RUF012_RUF012.py.snap</code>:77 on 2025-02-04 22:29</div>
            <div class="timeline-body"><p>Somehow I forgot to actually check that stringized annotations were working... and they aren't!</p>
<p>It turns out that fixing that is gonna require other changes (and I noticed a few other affected rules). So I'm gonna leave that as a followup PR and just solve the problem in the linked issue for this PR. I did move one other related rule to <code>deferred_scopes</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dylwil3">@dylwil3</a> reviewed on 2025-02-04 22:30</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dylwil3">@dylwil3</a> on <code>crates/ruff_linter/src/rules/ruff/rules/mutable_class_default.rs</code>:82 on 2025-02-04 22:30</div>
            <div class="timeline-body"><p>Sounds like fun I'll give it a shot!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "[`ruff`] Analyze deferred annotations before enforcing `mutable-(data)class-default` (`RUF008`,`RUF012`)" to "[`ruff`] Analyze deferred annotations before enforcing `mutable-(data)class-default` and `function-call-in-dataclass-default-argument` (`RUF008`,`RUF009`,`RUF012`)" by @dylwil3 on 2025-02-04 22:31</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_linter/src/rules/ruff/snapshots/ruff_linter__rules__ruff__tests__RUF012_RUF012.py.snap</code>:77 on 2025-02-05 12:33</div>
            <div class="timeline-body"><p>Ahh, and I see this isn't a regression; we also have this false negative on <code>main</code>. Feel free to merge, in that case!</p>
<p>Probably a lot more rules should be using this helper function when they inspect annotations: https://github.com/astral-sh/ruff/blob/eb08345fd5434ed3db243233df6dd91757a6af3b/crates/ruff_linter/src/checkers/ast/mod.rs#L453-L471</p>
<p>(I introduced the helper in #12951 ;)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-02-05 12:33</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @dylwil3 on 2025-02-05 12:44</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @dylwil3 on 2025-02-05 12:44</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dylwil3">@dylwil3</a> reviewed on 2025-02-05 12:47</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dylwil3">@dylwil3</a> on <code>crates/ruff_linter/src/rules/ruff/snapshots/ruff_linter__rules__ruff__tests__RUF012_RUF012.py.snap</code>:77 on 2025-02-05 12:47</div>
            <div class="timeline-body"><p>Yes exactly! Originally I started to use that helpful helper, but then noticed the number of places I had to put it was sort of exploding. So I wanted to take a step back in a separate PR and either see if there's a better way or if that failed then at least separate that change from the one in this PR.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 19:57:52 UTC
    </footer>
</body>
</html>
