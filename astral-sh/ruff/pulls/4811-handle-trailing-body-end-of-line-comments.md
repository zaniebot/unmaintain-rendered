```yaml
number: 4811
title: Handle trailing body end-of-line comments
type: pull_request
state: merged
author: MichaReiser
labels:
  - internal
  - formatter
assignees: []
merged: true
base: main
head: trailing-end-of-line-body-commnts
created_at: 2023-06-02T12:57:02Z
updated_at: 2023-06-03T13:17:35Z
url: https://github.com/astral-sh/ruff/pull/4811
synced_at: 2026-01-12T03:50:03Z
```

# Handle trailing body end-of-line comments

---

_Pull request opened by @MichaReiser on 2023-06-02 12:57_

### Summary

This PR adds custom logic to handle end-of-line comments of the last statement in a body. 

For example: 

```python
while True:
    if something.changed:
        do.stuff()  # trailing comment

b
```

The `# trailing comment` is a trailing comment of the `do.stuff()` expression statement. We incorrectly attached the comment as a trailing comment of the enclosing `while` statement  because the comment is between the end of the while statement (the `while` statement ends right after `do.stuff()`) and before the `b` statement. 


This PR fixes the placement to correctly attach these comments to the last statement in a body (recursively). 

## Test Plan

I reviewed the snapshots and they now look correct. This may appear odd because a lot comments have now disappeared. This is the expected result because we use `verbatim` formatting for the block statements (like `while`) and that means that it only formats the inner content of the block, but not any trailing comments. The comments were visible before, because they were associated with the block statement (e.g. `while`). 


---

_Comment by @MichaReiser on 2023-06-02 12:57_

Current dependencies on/for this PR:
* main
  * **PR #4811** <a href="https://app.graphite.dev/github/pr/charliermarsh/ruff/4811" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a>  ðŸ‘ˆ
    * **PR #4812** <a href="https://app.graphite.dev/github/pr/charliermarsh/ruff/4812" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a> 

This comment was auto-generated by [Graphite](https://app.graphite.dev/github/pr/charliermarsh/ruff/4811?utm_source=stack-comment).

---

_Assigned to @MichaReiser by @MichaReiser on 2023-06-02 13:01_

---

_Label `internal` added by @MichaReiser on 2023-06-02 13:01_

---

_Label `autoformatter` added by @MichaReiser on 2023-06-02 13:01_

---

_Comment by @github-actions[bot] on 2023-06-02 13:36_

## PR Check Results
### Ecosystem
âœ… ecosystem check detected no changes.

### Benchmark
#### Linux
```
group                                      main                                   pr
-----                                      ----                                   --
linter/all-rules/large/dataset.py          1.00     20.2Â±0.65ms     2.0 MB/sec    1.04     21.1Â±0.82ms  1978.8 KB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      4.6Â±0.23ms     3.7 MB/sec    1.09      5.0Â±0.27ms     3.4 MB/sec
linter/all-rules/numpy/globals.py          1.00   576.8Â±17.94Âµs     5.1 MB/sec    1.02   590.4Â±28.78Âµs     5.0 MB/sec
linter/all-rules/pydantic/types.py         1.00      8.1Â±0.29ms     3.2 MB/sec    1.07      8.6Â±0.38ms     3.0 MB/sec
linter/default-rules/large/dataset.py      1.00      9.5Â±0.23ms     4.3 MB/sec    1.16     11.1Â±0.32ms     3.7 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00      2.0Â±0.06ms     8.2 MB/sec    1.12      2.3Â±0.07ms     7.3 MB/sec
linter/default-rules/numpy/globals.py      1.00    238.4Â±9.18Âµs    12.4 MB/sec    1.09   259.3Â±10.96Âµs    11.4 MB/sec
linter/default-rules/pydantic/types.py     1.00      4.2Â±0.16ms     6.1 MB/sec    1.15      4.8Â±0.18ms     5.3 MB/sec
parser/large/dataset.py                    1.01      7.2Â±0.21ms     5.7 MB/sec    1.00      7.1Â±0.15ms     5.7 MB/sec
parser/numpy/ctypeslib.py                  1.00  1394.2Â±37.84Âµs    11.9 MB/sec    1.00  1400.9Â±46.49Âµs    11.9 MB/sec
parser/numpy/globals.py                    1.03    140.0Â±5.53Âµs    21.1 MB/sec    1.00    136.2Â±5.57Âµs    21.7 MB/sec
parser/pydantic/types.py                   1.00      3.1Â±0.09ms     8.3 MB/sec    1.00      3.1Â±0.12ms     8.3 MB/sec
```

#### Windows
```
group                                      main                                   pr
-----                                      ----                                   --
linter/all-rules/large/dataset.py          1.00     17.2Â±0.16ms     2.4 MB/sec    1.01     17.3Â±0.18ms     2.4 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      4.4Â±0.04ms     3.8 MB/sec    1.00      4.4Â±0.03ms     3.8 MB/sec
linter/all-rules/numpy/globals.py          1.00    450.9Â±4.89Âµs     6.5 MB/sec    1.00    451.0Â±8.44Âµs     6.5 MB/sec
linter/all-rules/pydantic/types.py         1.00      7.4Â±0.07ms     3.5 MB/sec    1.00      7.4Â±0.07ms     3.5 MB/sec
linter/default-rules/large/dataset.py      1.00      8.5Â±0.05ms     4.8 MB/sec    1.01      8.6Â±0.06ms     4.7 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00  1816.5Â±34.84Âµs     9.2 MB/sec    1.01  1826.9Â±13.93Âµs     9.1 MB/sec
linter/default-rules/numpy/globals.py      1.00    196.2Â±1.53Âµs    15.0 MB/sec    1.01    198.7Â±3.41Âµs    14.8 MB/sec
linter/default-rules/pydantic/types.py     1.00      3.9Â±0.04ms     6.5 MB/sec    1.00      3.9Â±0.02ms     6.5 MB/sec
parser/large/dataset.py                    1.01      6.7Â±0.03ms     6.1 MB/sec    1.00      6.6Â±0.03ms     6.1 MB/sec
parser/numpy/ctypeslib.py                  1.00   1259.6Â±7.92Âµs    13.2 MB/sec    1.00  1255.1Â±10.58Âµs    13.3 MB/sec
parser/numpy/globals.py                    1.01    131.9Â±1.84Âµs    22.4 MB/sec    1.00    130.6Â±1.12Âµs    22.6 MB/sec
parser/pydantic/types.py                   1.01      2.8Â±0.02ms     9.0 MB/sec    1.00      2.8Â±0.02ms     9.1 MB/sec
```
<!-- thollander/actions-comment-pull-request "PR Check Results" -->

---

_Marked ready for review by @MichaReiser on 2023-06-02 15:12_

---

_@charliermarsh approved on 2023-06-02 15:25_

---

_Comment by @MichaReiser on 2023-06-03 13:16_

@MichaReiser started a stack merge that includes this pull request via [Graphite](https://app.graphite.dev/github/pr/charliermarsh/ruff/4811).

---

_Merged by @MichaReiser on 2023-06-03 13:17_

---

_Closed by @MichaReiser on 2023-06-03 13:17_

---

_Branch deleted on 2023-06-03 13:17_

---

_Comment by @MichaReiser on 2023-06-03 13:17_

@MichaReiser merged this pull request with [Graphite](https://app.graphite.dev/github/pr/charliermarsh/ruff/4811).

---
