<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[`flake8-simplify`]: if-to-dict - astral-sh/ruff #2767</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1></h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/2767">#2767</a>
        opened by <a href="https://github.com/colin99d">@colin99d</a>
        on 2023-02-11 15:43
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/colin99d">@colin99d</a></div>
            <div class="timeline-body"><p>Closes #998</p>
<p>If this isn't merged tomorrow, I will add more tests. Tests included are the ones that flake8-simplify has.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/spaceone">@spaceone</a> on <code>crates/ruff/src/rules/flake8_simplify/rules/ast_if.rs</code>:77 on 2023-02-11 18:43</div>
            <div class="timeline-body"><pre><code class="language-suggestion">    /// ```python
    /// if x = 1:
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/spaceone">@spaceone</a> reviewed on 2023-02-11 18:43</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/spaceone">@spaceone</a> reviewed on 2023-02-11 18:44</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/spaceone">@spaceone</a> on <code>crates/ruff/src/rules/flake8_simplify/rules/ast_if.rs</code>:549 on 2023-02-11 18:44</div>
            <div class="timeline-body"><p>what if <code>s</code> contains a <code>&quot;</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Converted to draft by @colin99d on 2023-02-12 20:27</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @colin99d on 2023-02-12 20:34</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/colin99d">@colin99d</a> reviewed on 2023-02-12 21:51</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/colin99d">@colin99d</a> on <code>crates/ruff/src/rules/flake8_simplify/rules/ast_if.rs</code>:549 on 2023-02-12 21:51</div>
            <div class="timeline-body"><p>Thank you for brining this up. @charliermarsh how do you want me to handle this? Usually we just detect what the type of quotation mark is at the beginning, and use that everywhere. But, this will not work here because if there is a tuple, we will have no way of knowing what the quotation marks were. I say the two options here are:</p>
<ol>
<li>The &quot;lazy&quot; way: just format strings in debug (I implemented this already).<ul>
<li>Pro: Already implemented, a fixer could switch the quotation marks back</li>
<li>Con: All inner double quotations would now be escaped in the users code</li>
</ul>
</li>
<li>The &quot;hard&quot; way: write some code to figure out the starting parenthesis for each tuple item.<ul>
<li>Pro: Users would have strings formatted EXACLTY as they want them</li>
<li>Con: Since rust_python does not give us locations for each item, we would need to find ourselves. Which probably involves going to tokens and then back</li>
</ul>
</li>
</ol>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/colin99d">@colin99d</a> on 2023-02-12 21:53</div>
            <div class="timeline-body"><p>I should note. This PR improves upon the original. In the original the tuple <code>(1, 2, 3)</code> would be converted to the string <code>'1, 2, 3'</code>. This code preserves the tuple.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/spaceone">@spaceone</a> reviewed on 2023-02-12 23:00</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/spaceone">@spaceone</a> on <code>crates/ruff/src/rules/flake8_simplify/rules/ast_if.rs</code>:549 on 2023-02-12 23:00</div>
            <div class="timeline-body"><p>does <code>unparse_expr(s, checker.stylist)</code> help? tbh I don't understand what the code does.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/colin99d">@colin99d</a> on <code>crates/ruff/src/rules/flake8_simplify/rules/ast_if.rs</code>:549 on 2023-02-13 01:14</div>
            <div class="timeline-body"><p>The issue would be that each item in the tuple could have a different type of quotation mark.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/colin99d">@colin99d</a> reviewed on 2023-02-13 01:14</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-02-13 02:36</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff/src/rules/flake8_simplify/rules/ast_if.rs</code>:549 on 2023-02-13 02:36</div>
            <div class="timeline-body"><p>We should try to use the <code>unparse_constant</code> method of <code>Generator</code> for this rather than implementing <code>constant_to_str</code> here. But separately, it's fine to pass <code>checker.stylist</code> in there and just use the quotation mark that was detected. If the user is mixing quotation marks anyway, it's fine if we modify some of them -- it's kind of like, if the user is mixing indentation styles, we won't respect that either.</p>
<p>(Is there any reason that changing the quotation marks would be a problem, apart from that it might surprise some users?)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/colin99d">@colin99d</a> reviewed on 2023-02-15 01:50</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/colin99d">@colin99d</a> on <code>crates/ruff/src/rules/flake8_simplify/rules/ast_if.rs</code>:549 on 2023-02-15 01:50</div>
            <div class="timeline-body"><p>The issue I see is with a tuple like <code>(&quot;hello&quot;, 'I say &quot;hi&quot;')</code> -&gt; <code>(&quot;hello&quot;, &quot;I say &quot;hi&quot;&quot;)</code>. And I think this might happen commonly, because if I ever want quotes inside of a string, this is what I would do. I would rather not autofix at all, then have a fix that breaks even 1% of the time. Just let me know what you want me to do!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-02-15 02:53</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff/src/rules/flake8_simplify/rules/ast_if.rs</code>:549 on 2023-02-15 02:53</div>
            <div class="timeline-body"><p>Will try to review this soon, not tonight but maybe tomorrow. Sorry!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/colin99d">@colin99d</a> reviewed on 2023-02-15 02:54</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/colin99d">@colin99d</a> on <code>crates/ruff/src/rules/flake8_simplify/rules/ast_if.rs</code>:549 on 2023-02-15 02:54</div>
            <div class="timeline-body"><p>Your merging an entire auto formatter, so ABSLOTELY no worries!! And, thank you so much for all the hard work. Can't wait until my CI is just:</p>
<pre><code>pip install ruff==1.0.0
ruff .
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff/src/rules/flake8_simplify/rules/ast_if.rs</code>:111 on 2023-02-15 08:05</div>
            <div class="timeline-body"><p>Nit: You can directly use <code>String::new(&quot;Use...&quot;)</code> because you're not using any formatting arguments.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff/src/rules/flake8_simplify/rules/ast_if.rs</code>:632 on 2023-02-15 08:33</div>
            <div class="timeline-body"><p>Nit: You could make use of Rust's pattern matching to remove some of the nesting but it's not necessarily more readable</p>
<pre><code class="language-suggestion">if let ExprKind::Name { .. } = &amp;left.node {
            if let [Cmpop::Eq] = ops.as_slice() {
                if let [Expr {
                    node: ExprKind::Constant { .. },
                    ..
                }] = comparators.as_slice()
                {
                    if let [Stmt {
                        node: StmtKind::Return { .. },
                        ..
                    }] = body
                    {
                        if let [Stmt {
                            node: StmtKind::If { .. },
                            ..
                        }] = orelse
                        {
                            return true;
                        }
                    }
                }
            }
        }
</code></pre>
<p>or even</p>
<pre><code class="language-rust">    if let ExprKind::Compare {
        left,
        ops,
        comparators,
    } = &amp;test.node
    {
        return matches!(
            (
                &amp;left.node,
                ops.as_slice(),
                comparators.as_slice(),
                body,
                orelse
            ),
            (
                ExprKind::Name { .. },
                [Cmpop::Eq],
                [Expr {
                    node: ExprKind::Constant { .. },
                    ..
                }],
                [Stmt {
                    node: StmtKind::Return { .. },
                    ..
                }],
                [Stmt {
                    node: StmtKind::If { .. },
                    ..
                }]
            )
        );
    }
    false
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff/src/rules/flake8_simplify/rules/ast_if.rs</code>:671 on 2023-02-15 08:35</div>
            <div class="timeline-body"><p>What happens if the byte sequence isn't valid utf-8? I would expect this call to fail. Would it be better to change the return type to <code>Option&lt;String&gt;</code> or <code>Result&lt;SomeError, String&gt;</code> so that the method can return <code>None</code> if the constant cannot be converted to a string?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff/src/rules/flake8_simplify/rules/ast_if.rs</code>:730 on 2023-02-15 08:44</div>
            <div class="timeline-body"><p>You can avoid the unwrap by using <code>while let Some(child) = child</code></p>
<pre><code class="language-suggestion">while let Some(current) = child.take() {
        if !should_proceed_child(current, &amp;variable) {
            return;
        }
        if let StmtKind::If { test, body, orelse } = &amp;current.node {
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff/src/rules/flake8_simplify/rules/ast_if.rs</code>:734 on 2023-02-15 08:46</div>
            <div class="timeline-body"><p>Nit: You can use Rust's let else chain to simplify this code</p>
<pre><code class="language-suggestion">                let Some(clean_value) = value else { return; };
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff/src/rules/flake8_simplify/rules/ast_if.rs</code>:753 on 2023-02-15 08:46</div>
            <div class="timeline-body"><p>Nit: Delete?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff/src/rules/flake8_simplify/rules/ast_if.rs</code>:777 on 2023-02-15 08:49</div>
            <div class="timeline-body"><p>Nit:</p>
<pre><code class="language-suggestion">            match orelse.as_slice() {
                [Stmt {
                    node: StmtKind::If { .. },
                    ..
                }] =&gt; {
                    child = orelse.get(0);
                }
                [Stmt {
                    node: StmtKind::Return { value },
                    ..
                }] =&gt; {
                    let final_value = match value {
                        Some(item) =&gt; checker
                            .locator
                            .slice_source_code_range(&amp;Range::from_located(item)),
                        None =&gt; &quot;None&quot;,
                    };
                    else_value = Some(final_value.to_string());
                    child = None;
                }
                [_] =&gt; return,
                _ =&gt; child = None,
            }
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-02-15 08:49</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-02-15 13:22</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff/src/rules/flake8_simplify/rules/ast_if.rs</code>:111 on 2023-02-15 13:22</div>
            <div class="timeline-body"><p>Though it's not obvious, the use of <code>format!</code> here is significant as we pick up the <code>format!</code> calls and use them to generate documentation on the possible message formats (see: <code>#[derive_message_formats]</code>).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/colin99d">@colin99d</a> on 2023-02-17 01:01</div>
            <div class="timeline-body"><p>@charliermarsh I was able to get all the fixes in, and it looks like I was wrong. This handles the quotes correctly! @MichaReiser thank you for all the feedback! The code definitly looks cleaner now.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-02-20 19:09</div>
            <div class="timeline-body"><p>(Working on this now.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @charliermarsh on 2023-02-20 20:01</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2023-02-20 20:01</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 16:56:09 UTC
    </footer>
</body>
</html>
