<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[ty] Avoid unnecessary argument type expansion - astral-sh/ruff #19999</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[ty] Avoid unnecessary argument type expansion</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/19999">#19999</a>
        opened by <a href="https://github.com/dhruvmanila">@dhruvmanila</a>
        on 2025-08-20 06:29
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a></div>
            <div class="timeline-body"><h2>Summary</h2>
<p>Part of: https://github.com/astral-sh/ty/issues/868</p>
<p>This PR adds a heuristic to avoid argument type expansion if it's going to eventually lead to no matching overload.</p>
<p>This is done by checking whether the non-expandable argument types are assignable to the corresponding annotated parameter type. If one of them is not assignable to all of the remaining overloads, then argument type expansion isn't going to help.</p>
<h2>Test Plan</h2>
<p>Add mdtest that would otherwise take a long time because of the number of arguments that it would need to expand (30).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">performance</span> added by @dhruvmanila on 2025-08-20 06:29</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ty</span> added by @dhruvmanila on 2025-08-20 06:29</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-08-20 06:31</div>
            <div class="timeline-body"><!-- generated-comment typing_conformance_diagnostics_diff -->

<h2>Diagnostic diff on <a href="https://github.com/python/typing/tree/d4f39b27a4a47aac8b6d4019e1b0b5b3156fabdc/conformance">typing conformance tests</a></h2>
<p>No changes detected when running ty on typing conformance tests ✅</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-08-20 06:33</div>
            <div class="timeline-body"><!-- generated-comment mypy_primer -->

<h2><code>mypy_primer</code> results</h2>
<p>No ecosystem changes detected ✅
No memory usage changes detected ✅</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2025-08-20 10:02</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ty_python_semantic/resources/mdtest/call/overloads.md</code>:679 on 2025-08-20 10:02</div>
            <div class="timeline-body"><p>Considering the same example, but pass in <code>A()</code> as the first argument and use <code>a=None</code> instead of <code>a=1</code> for the parameter above, this would still continue with the expansion. The reason being that <code>A()</code> matches parameter of at least one overload which means we cannot skip argument type expansion.</p>
<p>I'm trying to think through what kind of heuristic to have that would avoid the expansion in this case as well. This would still lead to no-matching-overload because even though <code>Unknown</code> is assignable to <code>int</code>, the spec says that <em>all</em> argument lists resulting from an expansion should evaluate successfully and there's no such expansion as expanding <code>Unknown | None</code> leads to argument lists where at least one would have <code>None</code> which isn't assignable to <code>int</code>.</p>
<p>Regardless, I think it'd be best to set a higher limit on the expansion.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2025-08-20 10:17</div>
            <div class="timeline-body"><p>EDIT: Nevermind, it <em>is</em> because ty doesn't support <code>**kwargs</code> and the new logic should avoid checking those arguments to skip argument type expansion for now.</p>
<blockquote>
<pre><code class="language-diff">rotki (https://github.com/rotki/rotki)
+ rotkehlchen/tests/db/test_db.py:377:13: error[no-matching-overload] No overload of bound method `set_dynamic_cache` matches arguments
+ rotkehlchen/tests/db/test_db.py:378:20: error[no-matching-overload] No overload of bound method `get_dynamic_cache` matches arguments
+ rotkehlchen/tests/db/test_db.py:418:20: error[no-matching-overload] No overload of bound method `get_dynamic_cache` matches arguments
- Found 1588 diagnostics
+ Found 1591 diagnostics
</code></pre>
</blockquote>
<p>I wasn't expecting any mypy-primer diff but it seems that we have new diagnostics :)</p>
<p>I think this might be due to the fact that ty doesn't support <code>**kwargs</code> yet but I'm looking into it a bit closely. The main reason I think that is because when I remove the <code>**kwargs</code> in the call, the diagnostic disappear.</p>
<p>https://github.com/user-attachments/assets/6cecc561-3252-468d-8d4b-551d7f537268</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @dhruvmanila on 2025-08-20 10:17</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @dhruvmanila on 2025-08-20 10:17</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @AlexWaygood by @dhruvmanila on 2025-08-20 10:17</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @sharkdp by @dhruvmanila on 2025-08-20 10:17</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @dcreager by @dhruvmanila on 2025-08-20 10:17</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-08-20 17:38</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_python_semantic/src/types/call/arguments.rs</code>:230 on 2025-08-20 17:38</div>
            <div class="timeline-body"><p>Should we add a note to <code>expand_type</code> to update <code>is_type_expandable</code> (maybe rename to <code>is_expandable_type</code> for symmetry)  if necessary</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/ty_python_semantic/resources/mdtest/call/overloads.md</code>:679 on 2025-08-20 18:26</div>
            <div class="timeline-body"><p>Yes, I think there will be cases where we can't avoid actually trying all the expansions and see if any of them work -- best we can do there is optimize the expansions as best we can (e.g. iterator instead of eagerly materialized?) and then set a reasonable limit.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/ty_python_semantic/src/types/call/bind.rs</code>:1331 on 2025-08-20 18:30</div>
            <div class="timeline-body"><p>Would it make sense to first explicitly check if there are any expandable arguments (using the new method you added), then do this check, then actually expand the arguments? This way even if the heuristic applies, we've already generated the expansion, just haven't used the expansions yet.</p>
<p>But maybe generating the expansions is very cheap relative to actually trying the call with new argument types, so this doesn't matter?</p>
<p>And I guess we'd slow down the fast path slightly if we first check all arguments for expandability, then separately expand them?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> approved on 2025-08-20 18:30</div>
            <div class="timeline-body"><p>Nice, thank you!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2025-08-21 05:59</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ty_python_semantic/src/types/call/bind.rs</code>:1331 on 2025-08-21 05:59</div>
            <div class="timeline-body"><p>Yeah, I don't think this would really matter in practice mainly because there are only a few differences between <code>expand_type</code> and <code>is_type_expandable</code> which are (1) collecting the enum members from the metadata (both method generates the metadata) (2) performing multi-cartesian product of tuple elements and (3) allocation. I guess it wouldn't hurt to avoid allocating when it's easy to do so. Let me try it, I think I'll make this change.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2025-08-21 06:06</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ty_python_semantic/src/types/call/bind.rs</code>:1331 on 2025-08-21 06:06</div>
            <div class="timeline-body"><p>Ah right, so the main reason I did it at this location is so that the bindings state is the one before the type checking step, so that we only skip the overloads that have been filtered by the arity check.</p>
<p>So, we'd either have to pay the cost of either</p>
<ul>
<li>Allocation for the first expansion, taking the bindings snapshot. We'd skip the snapshot if there are no expansion in this case.</li>
<li>Always take the binding snapshot, check whether expansion needs to happen using the logic in this PR, skip allocating for the first expansion if there's no need</li>
</ul>
<p>I think going with the latter sounds reasonable i.e., instead of always allocating the first expansion, we'd always allocate the bindings snapshot.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2025-08-21 06:08</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ty_python_semantic/src/types/call/bind.rs</code>:1331 on 2025-08-21 06:08</div>
            <div class="timeline-body"><p>Hmm, but then there's complication on restoring the snapshots at the correct places. I think I'll leave this as is for now.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @dhruvmanila on 2025-08-21 06:13</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @dhruvmanila on 2025-08-21 06:13</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-08-21 06:13</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:15:11 UTC
    </footer>
</body>
</html>
