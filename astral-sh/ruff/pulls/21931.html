<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[`flake8-bugbear`] Allow `B901` in pytest hook wrappers - astral-sh/ruff #21931</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[<code>flake8-bugbear</code>] Allow <code>B901</code> in pytest hook wrappers</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/ruff/pull/21931">#21931</a>
        opened by <a href="https://github.com/assadyousuf">@assadyousuf</a>
        on 2025-12-12 04:00
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/assadyousuf">@assadyousuf</a></div>
            <div class="timeline-body">Summary
<p>Stop raising return-in-generator with pytest hook wrappers (@hookimpl(wrapper=True)). They are specifically designed to use this pattern: https://docs.pytest.org/en/stable/how-to/writing_hook_functions.html#hook-wrappers-executing-around-other-hooks</p>
<p>Before: return-in-generator reports would surface with pytest hook wrappers</p>
<p>After: specifically check for pytest hook wrappers before reporting return-in-generator</p>
<p>Testing:
Wrote some tests to cover different cases</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">rule</span> added by <a href="https://github.com/ntBre">@ntBre</a> on 2025-12-12 18:27</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">preview</span> added by <a href="https://github.com/ntBre">@ntBre</a> on 2025-12-12 18:27</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/resources/test/fixtures/flake8_bugbear/B901.py</code>:3 on 2025-12-17 16:02</div>
            <div class="timeline-body"><p>Thanks for updating this! This kind of thing is a bit fragile, though. Would you mind instead using something like a <code># B901</code> comment on each of the lines that should trigger the diagnostic?</p>
<p>That should allow us to delete this line, which will also offset the new pytest import and avoid churn in the snapshot line numbers.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/astral-sh-bot[bot]">@astral-sh-bot[bot]</a> on 2025-12-17 16:12</div>
            <div class="timeline-body">

<code>ruff-ecosystem</code> results
Linter (stable)
<p>✅ ecosystem check detected no linter changes.</p>
Linter (preview)
<p>ℹ️ ecosystem check <strong>detected linter changes</strong>. (+0 -24 violations, +0 -0 fixes in 5 projects; 50 projects unchanged)</p>
<a href="https://github.com/PlasmaPy/PlasmaPy">PlasmaPy/PlasmaPy</a> (+0 -5 violations, +0 -0 fixes)
<p>
<pre>ruff check --no-cache --exit-zero --no-fix --output-format concise --preview</pre>
</p>
<p>

<pre>
- <a href="https://github.com/PlasmaPy/PlasmaPy/blob/8f90993a45b0a722f4ed22dda676718be0230913/.github/scripts/authors_in_cff.py#L40">.github/scripts/authors_in_cff.py:40:10:</a> FURB101 `Path.open()` followed by `read()` can be replaced by `pathlib.Path(&quot;CITATION.cff&quot;).read_text()`
- <a href="https://github.com/PlasmaPy/PlasmaPy/blob/8f90993a45b0a722f4ed22dda676718be0230913/.github/scripts/citation_updater.py#L69">.github/scripts/citation_updater.py:69:10:</a> FURB103 [*] `Path.open()` followed by `write()` can be replaced by `citation_rst_file.write_text(citation_rst_text)`
- <a href="https://github.com/PlasmaPy/PlasmaPy/blob/8f90993a45b0a722f4ed22dda676718be0230913/docs/_author_list_from_cff.py#L193">docs/_author_list_from_cff.py:193:10:</a> FURB103 [*] `Path.open()` followed by `write()` can be replaced by `pathlib.Path(rst_file).write_text(authors_rst, encoding=&quot;utf-8&quot;)`
- <a href="https://github.com/PlasmaPy/PlasmaPy/blob/8f90993a45b0a722f4ed22dda676718be0230913/docs/_global_substitutions.py#L217">docs/_global_substitutions.py:217:10:</a> FURB103 [*] `Path.open()` followed by `write()` can be replaced by `pathlib.Path(rst_file).write_text(content, encoding=&quot;utf-8&quot;)`
- <a href="https://github.com/PlasmaPy/PlasmaPy/blob/8f90993a45b0a722f4ed22dda676718be0230913/tests/utils/data/test_downloader.py#L191">tests/utils/data/test_downloader.py:191:10:</a> FURB103 [*] `Path.open()` followed by `write()` can be replaced by `filepath.write_text(&quot;Not data&quot;)`
</pre>

</p>

<a href="https://github.com/langchain-ai/langchain">langchain-ai/langchain</a> (+0 -3 violations, +0 -0 fixes)
<p>
<pre>ruff check --no-cache --exit-zero --no-fix --output-format concise --preview</pre>
</p>
<p>

<pre>
- <a href="https://github.com/langchain-ai/langchain/blob/71778cb72116ab896e89e288fcdede868ea4f395/libs/partners/chroma/langchain_chroma/vectorstores.py#L489">libs/partners/chroma/langchain_chroma/vectorstores.py:489:14:</a> FURB101 `Path.open()` followed by `read()` can be replaced by `Path(uri).read_bytes()`
- <a href="https://github.com/langchain-ai/langchain/blob/71778cb72116ab896e89e288fcdede868ea4f395/libs/standard-tests/langchain_tests/conftest.py#L70">libs/standard-tests/langchain_tests/conftest.py:70:14:</a> FURB101 [*] `Path.open()` followed by `read()` can be replaced by `cassette_path.read_bytes()`
- <a href="https://github.com/langchain-ai/langchain/blob/71778cb72116ab896e89e288fcdede868ea4f395/libs/standard-tests/langchain_tests/conftest.py#L88">libs/standard-tests/langchain_tests/conftest.py:88:14:</a> FURB103 [*] `Path.open()` followed by `write()` can be replaced by `cassette_path.write_bytes(data)`
</pre>

</p>

<a href="https://github.com/scikit-build/scikit-build-core">scikit-build/scikit-build-core</a> (+0 -6 violations, +0 -0 fixes)
<p>
<pre>ruff check --no-cache --exit-zero --no-fix --output-format concise --preview</pre>
</p>
<p>

<pre>
- <a href="https://github.com/scikit-build/scikit-build-core/blob/20153a10c0e967198cd1a47b4b0796a6aae5d6d0/src/scikit_build_core/ast/ast.py#L88">src/scikit_build_core/ast/ast.py:88:10:</a> FURB101 `Path.open()` followed by `read()` can be replaced by `Path(sys.argv[1]).read_text(encoding=&quot;utf-8-sig&quot;)`
- <a href="https://github.com/scikit-build/scikit-build-core/blob/20153a10c0e967198cd1a47b4b0796a6aae5d6d0/src/scikit_build_core/ast/tokenizer.py#L77">src/scikit_build_core/ast/tokenizer.py:77:10:</a> FURB101 `Path.open()` followed by `read()` can be replaced by `Path(sys.argv[1]).read_text(encoding=&quot;utf-8-sig&quot;)`
- <a href="https://github.com/scikit-build/scikit-build-core/blob/20153a10c0e967198cd1a47b4b0796a6aae5d6d0/src/scikit_build_core/metadata/regex.py#L58">src/scikit_build_core/metadata/regex.py:58:10:</a> FURB101 `Path.open()` followed by `read()` can be replaced by `Path(input_filename).read_text(encoding=&quot;utf-8&quot;)`
- <a href="https://github.com/scikit-build/scikit-build-core/blob/20153a10c0e967198cd1a47b4b0796a6aae5d6d0/tests/test_dynamic_metadata.py#L274">tests/test_dynamic_metadata.py:274:10:</a> FURB103 [*] `Path.open()` followed by `write()` can be replaced by `Path(&quot;__init__.py&quot;).write_text(&quot;__version__ = &#x27;0.1.0&#x27;&quot;)`
- <a href="https://github.com/scikit-build/scikit-build-core/blob/20153a10c0e967198cd1a47b4b0796a6aae5d6d0/tests/test_dynamic_metadata.py#L290">tests/test_dynamic_metadata.py:290:10:</a> FURB103 [*] `Path.open()` followed by `write()` can be replaced by `Path(&quot;version.hpp&quot;)....`
- <a href="https://github.com/scikit-build/scikit-build-core/blob/20153a10c0e967198cd1a47b4b0796a6aae5d6d0/tests/test_dynamic_metadata.py#L326">tests/test_dynamic_metadata.py:326:10:</a> FURB103 [*] `Path.open()` followed by `write()` can be replaced by `Path(&quot;version.hpp&quot;)....`
</pre>

</p>

<a href="https://github.com/indico/indico">indico/indico</a> (+0 -1 violations, +0 -0 fixes)
<p>
<pre>ruff check --no-cache --exit-zero --no-fix --output-format concise --preview</pre>
</p>
<p>

<pre>
- <a href="https://github.com/indico/indico/blob/158b2a603253b4099d4943b3efa31b33e4fbe908/indico/vendor/django_mail/message.py#L369">indico/vendor/django_mail/message.py:369:14:</a> FURB101 `Path.open()` followed by `read()` can be replaced by `path.read_bytes()`
</pre>

</p>

<a href="https://github.com/pytest-dev/pytest">pytest-dev/pytest</a> (+0 -9 violations, +0 -0 fixes)
<p>
<pre>ruff check --no-cache --exit-zero --no-fix --output-format concise --preview</pre>
</p>
<p>

<pre>
- <a href="https://github.com/pytest-dev/pytest/blob/2fb64da82c83d4a485b3b2626ab8b39ede340d43/src/_pytest/faulthandler.py#L102">src/_pytest/faulthandler.py:102:9:</a> B901 Using `yield` and `return {value}` in a generator function can lead to confusing behavior
- <a href="https://github.com/pytest-dev/pytest/blob/2fb64da82c83d4a485b3b2626ab8b39ede340d43/src/_pytest/helpconfig.py#L152">src/_pytest/helpconfig.py:152:5:</a> B901 Using `yield` and `return {value}` in a generator function can lead to confusing behavior
- <a href="https://github.com/pytest-dev/pytest/blob/2fb64da82c83d4a485b3b2626ab8b39ede340d43/src/_pytest/setuponly.py#L36">src/_pytest/setuponly.py:36:9:</a> B901 Using `yield` and `return {value}` in a generator function can lead to confusing behavior
- <a href="https://github.com/pytest-dev/pytest/blob/2fb64da82c83d4a485b3b2626ab8b39ede340d43/src/_pytest/warnings.py#L109">src/_pytest/warnings.py:109:9:</a> B901 Using `yield` and `return {value}` in a generator function can lead to confusing behavior
- <a href="https://github.com/pytest-dev/pytest/blob/2fb64da82c83d4a485b3b2626ab8b39ede340d43/src/_pytest/warnings.py#L118">src/_pytest/warnings.py:118:9:</a> B901 Using `yield` and `return {value}` in a generator function can lead to confusing behavior
- <a href="https://github.com/pytest-dev/pytest/blob/2fb64da82c83d4a485b3b2626ab8b39ede340d43/src/_pytest/warnings.py#L128">src/_pytest/warnings.py:128:9:</a> B901 Using `yield` and `return {value}` in a generator function can lead to confusing behavior
- <a href="https://github.com/pytest-dev/pytest/blob/2fb64da82c83d4a485b3b2626ab8b39ede340d43/src/_pytest/warnings.py#L89">src/_pytest/warnings.py:89:9:</a> B901 Using `yield` and `return {value}` in a generator function can lead to confusing behavior
- <a href="https://github.com/pytest-dev/pytest/blob/2fb64da82c83d4a485b3b2626ab8b39ede340d43/src/_pytest/warnings.py#L98">src/_pytest/warnings.py:98:9:</a> B901 Using `yield` and `return {value}` in a generator function can lead to confusing behavior
- <a href="https://github.com/pytest-dev/pytest/blob/2fb64da82c83d4a485b3b2626ab8b39ede340d43/testing/conftest.py#L91">testing/conftest.py:91:5:</a> B901 Using `yield` and `return {value}` in a generator function can lead to confusing behavior
</pre>

</p>

Changes by rule (3 rules affected)
<p>

<p>| code | total | + violation | - violation | + fix | - fix |
| ---- | ------- | --------- | -------- | ----- | ---- |
| B901 | 9 | 0 | 9 | 0 | 0 |
| FURB103 | 8 | 0 | 8 | 0 | 0 |
| FURB101 | 7 | 0 | 7 | 0 | 0 |</p>
</p>


</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/flake8_pytest_style/helpers.rs</code>:80 on 2025-12-17 16:16</div>
            <div class="timeline-body"><p>We have a helper for this kind of thing:</p>
<p>https://github.com/astral-sh/ruff/blob/0f373603ebd007196af4f211e14d421024a6b947/crates/ruff_python_ast/src/nodes.rs#L3317-L3318</p>
<p>and a smaller one for the boolean literal:</p>
<p>https://github.com/astral-sh/ruff/blob/0f373603ebd007196af4f211e14d421024a6b947/crates/ruff_python_ast/src/helpers.rs#L675-L676</p>
<p>I think we may want to accept more arguments here, though. I checked <code>help(pytest.hookimpl)</code> in the REPL, and this is the signature:</p>
<pre><code>class HookimplMarker(builtins.object)
 |  __call__(
 |      self,
 |      function: _F | None = None,
 |      hookwrapper: bool = False,
 |      optionalhook: bool = False,
 |      tryfirst: bool = False,
 |      trylast: bool = False,
 |      specname: str | None = None,
 |      wrapper: bool = False
 |  ) -&gt; _F | Callable[[_F], _F]
</code></pre>
<p>so it seems that <code>wrapper</code> could technically also be passed positionally. I also think the <code>hookwrapper</code> argument has a similar function, although it&#x27;s referred to as the &quot;old-style hook wrapper&quot; in the <a href="https://pluggy.readthedocs.io/en/stable/index.html#wrappers">pluggy docs</a>, which the pytest docs redirected me to.</p>
<p>If we decide to accept either <code>wrapper</code> or <code>hookwrapper</code> and look for them positionally too, we could do something like:</p>
<pre><code>let hookwrapper = arguments.find_argument_value(&quot;hookwrapper&quot;, 1);
let wrapper = arguments.find_argument_value(&quot;wrapper&quot;, 6);
</code></pre>
<p>and then process the returned <code>Option</code>s.</p>
<p>I&#x27;m assuming that most usage in the wild will be with a keyword <code>wrapper</code> argument, though.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/flake8_pytest_style/mod.rs</code>:7 on 2025-12-17 16:17</div>
            <div class="timeline-body"><p>nit: I&#x27;d probably omit this and just import straight from <code>helpers</code> in the rule file.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-12-17 16:22</div>
            <div class="timeline-body"><p>Thank you! This looks great to me overall. I just had a couple of small suggestions besides the snapshots needing to be updated.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from &quot;Fixes #21881: return-in-generator (B901) - should not be reported on pytest hook wrappers&quot; to &quot;[`flake8-bugbear`] Allow `B901` in pytest hook wrappers&quot; by <a href="https://github.com/ntBre">@ntBre</a> on 2025-12-17 16:24</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:21:39 UTC
    </footer>
</body>
</html>
