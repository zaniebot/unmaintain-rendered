<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fix test that checks for black and linter compatibility - astral-sh/ruff #6992</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Fix test that checks for black and linter compatibility</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/pull/6992">#6992</a>
        opened by <a href="https://github.com/zanieb">@zanieb</a>
        on 2023-08-29 18:35
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a></div>
            <div class="timeline-body"><p>This test was disabled because the fixture files moved; here I enable the test again and update the directory to cover our the correct Python fixtures.</p>
<p>I also updated the output to be usable and display all mismatches on failure instead of just the first one.</p>
<p>Before</p>
<pre><code>thread 'test_ruff_black_compatibility' panicked at 'assertion failed: `(left == right)`
  left: `Ok(&quot;# Errors\nprint(\&quot;foo %(foo)d bar %(bar)d\&quot; % {\&quot;foo\&quot;: \&quot;1\&quot;, \&quot;bar\&quot;: \&quot;2\&quot;})\n\n\&quot;foo {:e} bar {}\&quot;.format(\&quot;1\&quot;, 2)\n\n\&quot;%d\&quot; % \&quot;1\&quot;\n\&quot;{:o}\&quot;.format(\&quot;1\&quot;)\n\&quot;%(key)d\&quot; % {\&quot;key\&quot;: \&quot;1\&quot;}\nf\&quot;{1.1:x}\&quot;\nf\&quot;{1.1:x}\&quot;\n\&quot;%d\&quot; % []\n\&quot;%d\&quot; % ([],)\n\&quot;%(key)d\&quot; % {\&quot;key\&quot;: []}\nprint(\&quot;%d\&quot; % (\&quot;{}\&quot;.format(\&quot;nested\&quot;),))\n\&quot;%d\&quot; % ((1, 2, 3),)\n\&quot;%d\&quot; % (1 if x &gt; 0 else [])\n\n# False negatives\nWORD = \&quot;abc\&quot;\n\&quot;%d\&quot; % WORD\n\&quot;%d %s\&quot; % (WORD, WORD)\nVALUES_TO_FORMAT = (1, \&quot;2\&quot;, 3.0)\n\&quot;%d %d %f\&quot; % VALUES_TO_FORMAT\n\n# OK\n\&quot;%d %s %f\&quot; % VALUES_TO_FORMAT\n\&quot;{}\&quot;.format(\&quot;1\&quot;)\n\&quot;{} {} {}\&quot;.format(\&quot;1\&quot;, 2, 3.5)\nprint(\&quot;%d %d\&quot; % (1, 1.1))\nf\&quot;{1}\&quot;\n\&quot;%d\&quot; % 1\nf\&quot;{1:f}\&quot;\nf\&quot;{1}\&quot;\nf\&quot;{1}\&quot;\n\&quot;%d\&quot; % 1\n\&quot;%(key)d\&quot; % {\&quot;key\&quot;: 1}\nf\&quot;{1:f}\&quot;\nf\&quot;{1:f}\&quot;\n\&quot;%d\&quot; % 1.1\n\&quot;%(key)d\&quot; % {\&quot;key\&quot;: 1.1}\n\&quot;%s\&quot; % []\nf\&quot;{[]}\&quot;\nf\&quot;{None}\&quot;\nf\&quot;{None}\&quot;\nprint(\&quot;{}\&quot;.format(\&quot;{}\&quot;.format(\&quot;nested\&quot;)))\nprint(\&quot;{}\&quot;.format(\&quot;%d\&quot; % (5,)))\n\&quot;%d %d\&quot; % \&quot;1\&quot;\n\&quot;%d%d\&quot; % \&quot;1\&quot;\n\&quot;-%f\&quot; % time.time()\n\&quot;{!r}\&quot;.format(object[\&quot;dn\&quot;])\nrf\&quot;\\{ord(c):03o}\&quot;\n(\&quot;%02X\&quot; % int(_) for _ in o)\n\&quot;%s;range=%d-*\&quot; % (attr, upper + 1)\n\&quot;%d\&quot; % (len(foo),)\n\&quot;({!r}, {!r}, {!r}, {!r})\&quot;.format(hostname, address, username, \&quot;$PASSWORD\&quot;)\n\&quot;{!r}\&quot;.format(\n    {\n        \&quot;server_school_roles\&quot;: server_school_roles,\n        \&quot;is_school_multiserver_domain\&quot;: is_school_multiserver_domain,\n    }\n)\n\&quot;%d\&quot; % (1 if x &gt; 0 else 2)\n&quot;)`,
 right: `Ok(&quot;# Errors\nprint(\&quot;foo %(foo)d bar %(bar)d\&quot; % {\&quot;foo\&quot;: \&quot;1\&quot;, \&quot;bar\&quot;: \&quot;2\&quot;})\n\n\&quot;foo {:e} bar {}\&quot;.format(\&quot;1\&quot;, 2)\n\n\&quot;%d\&quot; % \&quot;1\&quot;\n\&quot;{:o}\&quot;.format(\&quot;1\&quot;)\n\&quot;%(key)d\&quot; % {\&quot;key\&quot;: \&quot;1\&quot;}\nf\&quot;{1.1:x}\&quot;\nf\&quot;{1.1:x}\&quot;\n\&quot;%d\&quot; % []\n\&quot;%d\&quot; % ([],)\n\&quot;%(key)d\&quot; % {\&quot;key\&quot;: []}\nprint(\&quot;%d\&quot; % (\&quot;{}\&quot;.format(\&quot;nested\&quot;),))\n\&quot;%d\&quot; % ((1, 2, 3),)\n\&quot;%d\&quot; % (1 if x &gt; 0 else [])\n\n# False negatives\nWORD = \&quot;abc\&quot;\n\&quot;%d\&quot; % WORD\n\&quot;%d %s\&quot; % (WORD, WORD)\nVALUES_TO_FORMAT = (1, \&quot;2\&quot;, 3.0)\n\&quot;%d %d %f\&quot; % VALUES_TO_FORMAT\n\n# OK\n\&quot;%d %s %f\&quot; % VALUES_TO_FORMAT\n\&quot;{}\&quot;.format(\&quot;1\&quot;)\n\&quot;{} {} {}\&quot;.format(\&quot;1\&quot;, 2, 3.5)\nprint(\&quot;%d %d\&quot; % (1, 1.1))\nf\&quot;{1}\&quot;\n\&quot;%d\&quot; % 1\nf\&quot;{1:f}\&quot;\nf\&quot;{1}\&quot;\nf\&quot;{1}\&quot;\n\&quot;%d\&quot; % 1\n\&quot;%(key)d\&quot; % {\&quot;key\&quot;: 1}\nf\&quot;{1:f}\&quot;\nf\&quot;{1:f}\&quot;\n\&quot;%d\&quot; % 1.1\n\&quot;%(key)d\&quot; % {\&quot;key\&quot;: 1.1}\n\&quot;%s\&quot; % []\nf\&quot;{[]}\&quot;\nf\&quot;{None}\&quot;\nf\&quot;{None}\&quot;\nprint(\&quot;{}\&quot;.format(\&quot;{}\&quot;.format(\&quot;nested\&quot;)))\nprint(\&quot;{}\&quot;.format(\&quot;%d\&quot; % (5,)))\n\&quot;%d %d\&quot; % \&quot;1\&quot;\n\&quot;%d%d\&quot; % \&quot;1\&quot;\n\&quot;-%f\&quot; % time.time()\n\&quot;{!r}\&quot;.format(object[\&quot;dn\&quot;])\nrf\&quot;\\{ord(c):03o}\&quot;\n(\&quot;%02X\&quot; % int(_) for _ in o)\n\&quot;%s;range=%d-*\&quot; % (attr, upper + 1)\n\&quot;%d\&quot; % (len(foo),)\n\&quot;({!r}, {!r}, {!r}, {!r})\&quot;.format(hostname, address, username, \&quot;$PASSWORD\&quot;)\n\&quot;{!r}\&quot;.format(\n    {\n        \&quot;server_school_roles\&quot;: server_school_roles,\n        \&quot;is_school_multiserver_domain\&quot;: is_school_multiserver_domain,\n    },\n)\n\&quot;%d\&quot; % (1 if x &gt; 0 else 2)\n&quot;)`: Mismatch found for /Users/mz/eng/src/astral-sh/ruff/crates/ruff/resources/test/fixtures/pylint/bad_string_format_type.py', crates/ruff_cli/tests/black_compatibility_test.rs:136:5
</code></pre>
<p>After</p>
<pre><code>Mismatch found for /Users/mz/eng/src/astral-sh/ruff/crates/ruff/resources/test/fixtures/pyflakes/F541.py
---------- FIRST ----------
# OK
a = &quot;abc&quot;
b = f&quot;ghi{'jkl'}&quot;

# Errors
c = &quot;def&quot;
d = &quot;def&quot; + &quot;ghi&quot;
e = &quot;def&quot; + &quot;ghi&quot;
f = &quot;a&quot; &quot;b&quot; &quot;c&quot; r&quot;d&quot; r&quot;e&quot;
g = &quot;&quot;

# OK
g = f&quot;ghi{123:{45}}&quot;

# Error
h = &quot;xyz&quot;

v = 23.234234

# OK
f&quot;{v:0.2f}&quot;
f&quot;{f'{v:0.2f}'}&quot;

# Errors
f&quot;{v:{'0.2f'}}&quot;
f&quot;{''}&quot;
&quot;{test}&quot;
&quot;{ 40 }&quot;
&quot;{a {x}&quot;
&quot;{{x}}&quot;
&quot;&quot;
&quot;&quot;
(&quot;&quot; r&quot;&quot;)

# To be fixed
# Error: f-string: single '}' is not allowed at line 41 column 8
# f&quot;\{{x}}&quot;


---------- SECOND ----------
# OK
a = &quot;abc&quot;
b = f&quot;ghi{'jkl'}&quot;

# Errors
c = &quot;def&quot;
d = &quot;def&quot; + &quot;ghi&quot;
e = &quot;def&quot; + &quot;ghi&quot;
f = &quot;abc&quot; r&quot;de&quot;
g = &quot;&quot;

# OK
g = f&quot;ghi{123:{45}}&quot;

# Error
h = &quot;xyz&quot;

v = 23.234234

# OK
f&quot;{v:0.2f}&quot;
f&quot;{f'{v:0.2f}'}&quot;

# Errors
f&quot;{v:{'0.2f'}}&quot;
f&quot;{''}&quot;
&quot;{test}&quot;
&quot;{ 40 }&quot;
&quot;{a {x}&quot;
&quot;{{x}}&quot;
&quot;&quot;
&quot;&quot;
(&quot;&quot; r&quot;&quot;)

# To be fixed
# Error: f-string: single '}' is not allowed at line 41 column 8
# f&quot;\{{x}}&quot;


---------- DIFF ----------
@@ -6,7 +6,7 @@
 c = &quot;def&quot;
 d = &quot;def&quot; + &quot;ghi&quot;
 e = &quot;def&quot; + &quot;ghi&quot;
-f = &quot;a&quot; &quot;b&quot; &quot;c&quot; r&quot;d&quot; r&quot;e&quot;
+f = &quot;abc&quot; r&quot;de&quot;
 g = &quot;&quot;
 
 # OK


Error: 30 mismatches found
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2023-08-29 18:41</div>
            <div class="timeline-body"><p>There are ~15 mismatches that would need to be fixed or ignored before this can be merged.</p>
<p>The output could be cleaned up a bit more, I just hacked together an improvement so I could see what work needs to be done to get us back to âœ… here.</p>
<p>I see the general idea for this as more valuable for testing with <em>our</em> formatter in the long-term rather than Black. It's unclear if it's worth investing more into this test harness since it is relatively specific to the Black daemon.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2023-09-29 14:50</div>
            <div class="timeline-body"><p>Not a priority for me right now</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @zanieb on 2023-09-29 14:50</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 16:59:55 UTC
    </footer>
</body>
</html>
