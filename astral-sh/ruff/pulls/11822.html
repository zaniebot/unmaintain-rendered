<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>red-knot: `source_text`, `line_index`, and `parsed_module` queries - astral-sh/ruff #11822</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>red-knot: <code>source_text</code>, <code>line_index</code>, and <code>parsed_module</code> queries</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/11822">#11822</a>
        opened by <a href="https://github.com/MichaReiser">@MichaReiser</a>
        on 2024-06-10 11:19
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a></div>
            <div class="timeline-body">Summary
<p>This PR adds the most basic file-based queries that are needed for semantic analysis, linting and formatting:</p>
<ul>
<li><code>source_text</code>: Reads the content of a file. Changing a file&#x27;s revision markes the query result as stale. I excluded jupyter notebook support for now.</li>
<li><code>line_index</code>: Computes the line index for a file&#x27;s source text.</li>
<li><code>parsed_module</code>: Parses the file&#x27;s text to a python module, infering the file type from the file extension.</li>
</ul>
Test Plan
<p>I added a few unit tests that demonstrate the basic functionality.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/dhruvmanila">@dhruvmanila</a> by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-06-10 11:19</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-06-10 11:19</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from &quot;red-knot: `source_text`, `line_index`, and `parsed_module` queries&quot; to &quot;red-knot[salsa part 3]: `source_text`, `line_index`, and `parsed_module` queries&quot; by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-06-11 13:56</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for <a href="https://github.com/dhruvmanila">@dhruvmanila</a> removed by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-06-11 13:57</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/carljm">@carljm</a> by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-06-11 13:57</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/AlexWaygood">@AlexWaygood</a> by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-06-11 13:57</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2024-06-11 14:25</div>
            <div class="timeline-body">

<code>ruff-ecosystem</code> results
Linter (stable)
<p>ℹ️ ecosystem check <strong>encountered linter errors</strong>. (no lint changes; 1 project error)</p>
<a href="https://github.com/mlflow/mlflow">mlflow/mlflow</a> (error)
<p>

<pre><code>Failed to clone mlflow/mlflow: error: RPC failed; curl 55 Failed sending HTTP2 data
error: 27308 bytes of body are still expected
fetch-pack: unexpected disconnect while reading sideband packet
fatal: early EOF
fatal: fetch-pack: invalid index-pack output
</code></pre>
</p>


Linter (preview)
<p>✅ ecosystem check detected no linter changes.</p>
Formatter (stable)
<p>✅ ecosystem check detected no format changes.</p>
Formatter (preview)
<p>✅ ecosystem check detected no format changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/ruff_db/src/parsed.rs</code>:16 on 2024-06-12 13:40</div>
            <div class="timeline-body"><pre><code>/// AST even if the file contains syntax errors. The parse errors
/// are then accessible through [`Parsed::errors`].
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/ruff_db/src/parsed.rs</code>:31 on 2024-06-12 13:43</div>
            <div class="timeline-body"><p>Does it make sense to assume a file is Python if it has no extension? Is that an existing Ruff behavior? That seems likely to lead to a lot of syntax/parsing errors. From a user perspective, I would expect to have to specially request via config if I want Ruff to treat an unknown-extension file as Python source.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/ruff_db/src/parsed.rs</code>:18 on 2024-06-12 13:45</div>
            <div class="timeline-body"><p>I found this sentence confusing on first read. Clearer would be:</p>
<pre><code>/// Salsa caches the parse tree between invocations if the `VfsFile` hasn&#x27;t changed, but the query
/// doesn&#x27;t make use of Salsa&#x27;s additional optimization
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/ruff_db/src/parsed.rs</code>:68 on 2024-06-12 13:48</div>
            <div class="timeline-body"><p>Tests also for stub file, vendored stub file, and unknown-extension file?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/ruff_python_ast/src/lib.rs</code>:87 on 2024-06-12 13:50</div>
            <div class="timeline-body"><p>As mentioned above, this does not seem to me like desirable behavior. Even if we do want this behavior at the user level, it still seems like surprising and undesirable behavior at the level of a library method like this to return a default that is a total guess and hides the actual nature of the underlying data. Better to return <code>None</code> or <code>PySourceType::Unknown</code> and let the caller decide what default they want.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> approved on 2024-06-12 13:53</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2024-06-12 13:54</div>
            <div class="timeline-body"><p>Oh, and let&#x27;s make sure to fix the clippy errors before merging this.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-06-12 14:46</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_db/src/parsed.rs</code>:31 on 2024-06-12 14:46</div>
            <div class="timeline-body"><p>We&#x27;ll need to filter out non-python files (according to the user&#x27;s configuration) when walking the workspace so that we never end up calling parse on these files.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-06-12 14:47</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_ast/src/lib.rs</code>:87 on 2024-06-12 14:47</div>
            <div class="timeline-body"><p>I don&#x27;t plan on changing this, as this matches Ruff&#x27;s current behavior.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_db/src/file_system.rs</code>:55 on 2024-06-12 15:47</div>
            <div class="timeline-body"><pre><code>    /// * [`None`], if there is no file name (e.g. if the path ends in `/..`);
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_db/src/parsed.rs</code>:14 on 2024-06-12 15:48</div>
            <div class="timeline-body"><pre><code>/// The query uses Ruff&#x27;s error-resilient parser. That means that the parser always succeeds to produce a
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> approved on 2024-06-12 16:37</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-06-13 07:13</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_db/src/parsed.rs</code>:68 on 2024-06-13 07:13</div>
            <div class="timeline-body"><p>I added a test for vendored paths. I prefer to not add a test for unknown extensions and stub files because I then end up re-testing <code>PySourceType::from_extension</code>. I rather want to have integration tests for different file types (We write a lot of integration tests in ruff and only few unit tests. What we have in these PRs is already way above the average number of unit tests)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-06-13 07:14</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_db/src/file_system.rs</code>:55 on 2024-06-13 07:14</div>
            <div class="timeline-body"><p>This is the documentation from <code>Path::extension</code> :D I rather keep it as is.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from &quot;red-knot[salsa part 3]: `source_text`, `line_index`, and `parsed_module` queries&quot; to &quot;red-knot: `source_text`, `line_index`, and `parsed_module` queries&quot; by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-06-13 07:19</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-06-13 07:37</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-06-13 07:37</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-06-13 07:37</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:04:36 UTC
    </footer>
</body>
</html>
