```yaml
number: 6452
title: Format docstrings
type: pull_request
state: merged
author: konstin
labels:
  - formatter
assignees: []
merged: true
base: main
head: docstring_formatting
created_at: 2023-08-09T17:31:15Z
updated_at: 2023-08-14T13:51:17Z
url: https://github.com/astral-sh/ruff/pull/6452
synced_at: 2026-01-12T15:55:21Z
```

# Format docstrings

---

_@konstin_

**Summary** Implement docstring formatting

**Test Plan** Matches black's `docstring.py` fixture exactly, added some new cases for what is hard to debug with black and with what black doesn't cover.

similarity index:

main:
zulip: 0.99702
django: 0.99784
warehouse: 0.99585
build: 0.75623
transformers: 0.99469
cpython: 0.75989
typeshed: 0.74853

this branch:

zulip: 0.99702
django: 0.99784
warehouse: 0.99585
build: 0.75623
transformers: 0.99464
cpython: 0.75517
typeshed: 0.74853

The regression in transformers is actually an improvement in a file they don't format with black (they run `black examples tests src utils setup.py conftest.py`, the difference is in hubconf.py). cpython doesn't use black.

Closes #6196 

---

_Comment by @konstin on 2023-08-09 17:31_

Current dependencies on/for this PR:
* main
  * **PR #6443** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/6443" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a> 
    * **PR #6452** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/6452" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a>  ðŸ‘ˆ
      * **PR #6477** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/6477" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a> 
        * **PR #6507** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/6507" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a> 
          * **PR #6561** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/6561" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a> 

This comment was auto-generated by [Graphite](https://app.graphite.dev/github/pr/astral-sh/ruff/6452?utm_source=stack-comment).

---

_Comment by @github-actions[bot] on 2023-08-09 18:16_

## PR Check Results
### Benchmark
#### Linux
```
group                                      main                                    pr
-----                                      ----                                    --
formatter/large/dataset.py                 1.07      4.5Â±0.24ms     9.1 MB/sec     1.00      4.2Â±0.28ms     9.7 MB/sec
formatter/numpy/ctypeslib.py               1.00  917.4Â±111.86Âµs    18.2 MB/sec     1.02   934.8Â±50.51Âµs    17.8 MB/sec
formatter/numpy/globals.py                 1.07     94.3Â±8.19Âµs    31.3 MB/sec     1.00     87.8Â±6.88Âµs    33.6 MB/sec
formatter/pydantic/types.py                1.00  1840.5Â±101.76Âµs    13.9 MB/sec    1.01  1858.7Â±122.12Âµs    13.7 MB/sec
linter/all-rules/large/dataset.py          1.15     14.4Â±0.36ms     2.8 MB/sec     1.00     12.6Â±0.59ms     3.2 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.04      3.7Â±0.09ms     4.6 MB/sec     1.00      3.5Â±0.21ms     4.7 MB/sec
linter/all-rules/numpy/globals.py          1.00   503.5Â±25.79Âµs     5.9 MB/sec     1.02   513.2Â±25.14Âµs     5.7 MB/sec
linter/all-rules/pydantic/types.py         1.10      7.3Â±0.26ms     3.5 MB/sec     1.00      6.6Â±0.46ms     3.9 MB/sec
linter/default-rules/large/dataset.py      1.22      7.9Â±0.64ms     5.2 MB/sec     1.00      6.5Â±0.37ms     6.3 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.11  1560.3Â±91.43Âµs    10.7 MB/sec     1.00  1402.0Â±51.38Âµs    11.9 MB/sec
linter/default-rules/numpy/globals.py      1.06   192.9Â±22.40Âµs    15.3 MB/sec     1.00   182.7Â±11.65Âµs    16.1 MB/sec
linter/default-rules/pydantic/types.py     1.00      3.3Â±0.15ms     7.7 MB/sec     1.01      3.3Â±0.34ms     7.7 MB/sec
```

#### Windows
```
group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.00      4.3Â±0.01ms     9.5 MB/sec    1.01      4.3Â±0.03ms     9.4 MB/sec
formatter/numpy/ctypeslib.py               1.00    822.8Â±8.78Âµs    20.2 MB/sec    1.01   831.1Â±10.91Âµs    20.0 MB/sec
formatter/numpy/globals.py                 1.00     85.4Â±0.59Âµs    34.6 MB/sec    1.04     88.9Â±8.72Âµs    33.2 MB/sec
formatter/pydantic/types.py                1.00  1767.3Â±22.52Âµs    14.4 MB/sec    1.01  1787.5Â±22.35Âµs    14.3 MB/sec
linter/all-rules/large/dataset.py          1.00     12.5Â±0.09ms     3.2 MB/sec    1.01     12.7Â±0.07ms     3.2 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      3.5Â±0.01ms     4.7 MB/sec    1.01      3.6Â±0.03ms     4.7 MB/sec
linter/all-rules/numpy/globals.py          1.00    369.7Â±4.87Âµs     8.0 MB/sec    1.01    373.5Â±5.28Âµs     7.9 MB/sec
linter/all-rules/pydantic/types.py         1.00      6.5Â±0.03ms     3.9 MB/sec    1.01      6.6Â±0.05ms     3.9 MB/sec
linter/default-rules/large/dataset.py      1.00      6.9Â±0.02ms     5.9 MB/sec    1.01      6.9Â±0.05ms     5.9 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00   1433.9Â±5.69Âµs    11.6 MB/sec    1.00   1438.8Â±7.70Âµs    11.6 MB/sec
linter/default-rules/numpy/globals.py      1.00    148.4Â±0.83Âµs    19.9 MB/sec    1.01    149.2Â±0.93Âµs    19.8 MB/sec
linter/default-rules/pydantic/types.py     1.00      3.1Â±0.03ms     8.3 MB/sec    1.00      3.1Â±0.02ms     8.3 MB/sec
```
<!-- thollander/actions-comment-pull-request "PR Check Results" -->

---

_Marked ready for review by @konstin on 2023-08-10 09:44_

---

_Label `formatter` added by @konstin on 2023-08-10 09:44_

---

_@konstin reviewed on 2023-08-10 09:46_

---

_Review comment by @konstin on `crates/ruff_python_formatter/tests/snapshots/black_compatibility@miscellaneous__docstring_no_string_normalization.py.snap`:1 on 2023-08-10 09:46_

This is a no string normalization test case, which we don't support

---

_Comment by @MichaReiser on 2023-08-10 10:51_

It would be helpful for me if you could summarise the key points what "format docstring" includes. Having a basic understanding of the rules and not having to infer them from the code, would help me review the changes.

---

_Comment by @konstin on 2023-08-10 11:10_

I've added a summary to the docstring: https://github.com/astral-sh/ruff/pull/6452/files#diff-9ae227f70699315433485961eb6bbeb9a45487857fbfebe473e926e71bc194f5R677-R760

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/statement/suite.rs`:92 on 2023-08-10 14:33_

Hmm, this will get tricky with suppression comments because I had to move the formatting call out of this match (to avoid having to test whether the expression is suppressed in multiple places)

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/statement/suite.rs`:117 on 2023-08-10 14:35_

Calling the expression directly will be problematic when we add `fmt: skip` support because it now becomes necessary to handle the suppression comments here as well.

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/statement/suite.rs`:274 on 2023-08-10 14:35_

Oh no xD... The speedup potential for adding a `implicit_concatenated` to `String` increases day by day

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/tests/snapshots/black_compatibility@miscellaneous__docstring_no_string_normalization.py.snap`:1 on 2023-08-10 14:36_

which one? Do we already track the deviation in an issue?

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/expression/string.rs`:673 on 2023-08-10 14:39_

Should we use the tab size from the options when `IndentStyle::Tab` is used (we can fallback to 8 if it is spaces)? 

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/expression/string.rs`:722 on 2023-08-10 14:39_

Soo pretty

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/expression/string.rs`:695 on 2023-08-10 14:40_

```suggestion
/// * Trim leading whitespace on the first line, again except for a chaperone space
```

What's a chaperone space? Googling doesn't provide any good results

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/expression/string.rs`:737 on 2023-08-10 14:41_

```suggestion
/// Tabs are counted by padding them to the next multiple of 8 according to `str.expandtabs`. When
```

Add a link to `str_expandtabs`. It's otherwise unclear what it refers to

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/expression/string.rs`:789 on 2023-08-10 14:44_

You have to use `universal_newlines` to properly support `\r\n` line endings. I see, you rely on the fact that we normalize newlines. Nice

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/expression/string.rs`:791 on 2023-08-10 14:45_

Can we emit the source position before `string_part.prefix` and the end position at the very end. This will help getting correct source maps.

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/expression/string.rs`:829 on 2023-08-10 14:46_

You want to use `trim_whitespace_start()` and `trim_whitespace_end()` to only trim valid python whitespace.

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/expression/string.rs`:874 on 2023-08-10 14:52_

Can we extract this test into a function if it is the same (and give it a name). That would allow us to document it once. 

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/expression/string.rs`:879 on 2023-08-10 14:52_

Write the end source position after the preferred quotes for proper source maps

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/expression/string.rs`:923 on 2023-08-10 14:52_

```suggestion
        .take_while(|c| c.is_python_whitespace())
```

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/expression/string.rs`:950 on 2023-08-10 14:55_

This repeats itself multiple times. I wonder if it would make sense to implement your type that stores the `Cow` internally and has a `write_slice(range, f)` method. It would remove the `is_normalized` boolean. However, I'm not sure if that plays nicely with `lines` (or a `Slice` enum that allows wrapping a &str and `is_normalized). 



---

_@MichaReiser approved on 2023-08-10 14:58_

Very impressive! I love it how you managed to implement this without allocating in the common case where docstrings are already formatted. 

The main feedback theme is around using `is_python_whitespace`, `trim_whitespace_start`, `trim_whitespace`, and `trim_whitespace_end` instead of the rust provided `trim` methods to only trim valid Python whitespace. 

The other part is that I don't know how to integrate this into my suppression PR xD But you can let me figure this out

---

_@MichaReiser reviewed on 2023-08-10 15:07_

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/expression/string.rs`:121 on 2023-08-10 15:07_

Nit: The `format_docstring` function is the odd one in this file. Most other code uses `Format` implementations. 

---

_Comment by @MichaReiser on 2023-08-10 15:29_

Can you extend your test plan with the similarity index? The perfect implementation wouldn't change the similarity index, any bugs would show up in a regression.

---

_Review requested from @dhruvmanila by @konstin on 2023-08-10 16:24_

---

_Closed by @konstin on 2023-08-10 16:28_

---

_Reopened by @konstin on 2023-08-10 16:28_

---

_Review comment by @konstin on `crates/ruff_python_formatter/src/expression/string.rs`:695 on 2023-08-10 16:29_

i made this term up from a [similar one](https://en.wikipedia.org/wiki/Chaperone_(protein)): it's a space that makes sure that a quote or a backspace inside the string don't get to close to the surrounding quotes

---

_@konstin reviewed on 2023-08-10 16:29_

---

_Review comment by @konstin on `crates/ruff_python_formatter/tests/snapshots/black_compatibility@miscellaneous__docstring_no_string_normalization.py.snap`:1 on 2023-08-10 17:30_

no, we need to decide if we want to support [this option](https://black.readthedocs.io/en/stable/usage_and_configuration/the_basics.html#s-skip-string-normalization)

---

_@konstin reviewed on 2023-08-10 17:30_

---

_@konstin reviewed on 2023-08-10 17:32_

---

_Review comment by @konstin on `crates/ruff_python_formatter/src/statement/suite.rs`:117 on 2023-08-10 17:32_

i'm happy to change to whatever makes it easier with suppression. I initially had a `format_docstring` call here but thought it would be marginally nicer to at least go through the ExprConstant

---

_@konstin reviewed on 2023-08-10 17:32_

---

_Review comment by @konstin on `crates/ruff_python_formatter/src/statement/suite.rs`:274 on 2023-08-10 17:32_

also the confusion for developers would make it worthwhile :bow:

---

_@konstin reviewed on 2023-08-10 17:37_

---

_Review comment by @konstin on `crates/ruff_python_formatter/src/expression/string.rs`:673 on 2023-08-10 17:37_

black always uses 8: https://github.com/psf/black/blob/c36e468794f9256d5e922c399240d49782ba04f1/src/black/strings.py#L61 . imo indentation that mixes tabs and space is fundamentally undefined, so i would pick something that's easy and stable or in this case, black compatible. 

---

_@konstin reviewed on 2023-08-10 17:45_

---

_Review comment by @konstin on `crates/ruff_python_formatter/src/expression/string.rs`:829 on 2023-08-10 17:45_

i tried this, but to my surprise black disagrees and trims like rust instead. This is the diffs i get i make that change: https://gist.github.com/konstin/62227a242cea073a0d62efc19448e4fb

---

_Review comment by @konstin on `crates/ruff_python_formatter/src/expression/string.rs`:923 on 2023-08-10 17:51_

same as above, black uses unicode whitesapce

---

_@konstin reviewed on 2023-08-10 17:51_

---

_@konstin reviewed on 2023-08-10 17:52_

---

_Review comment by @konstin on `crates/ruff_python_formatter/src/expression/string.rs`:950 on 2023-08-10 17:52_

i've though about this but docstring formatting is a special case and i wouldn't overengineer it, it already has enough indirection

---

_@konstin reviewed on 2023-08-10 18:01_

---

_Review comment by @konstin on `crates/ruff_python_formatter/src/expression/string.rs`:121 on 2023-08-10 18:01_

i thought about this too but i didn't find a design that makes this better; i'd rather turn `FormatStringContinuation` into a function call.

In general, what would you think about going more into the direction of trying to make function calls (or some indirection of them) format-able?

---

_Comment by @konstin on 2023-08-10 18:04_

> Can you extend your test plan with the similarity index? The perfect implementation wouldn't change the similarity index, any bugs would show up in a regression.

good point:

main:
zulip: 0.99702
django: 0.99784
warehouse: 0.99585
build: 0.75623
transformers: 0.99469
cpython: 0.75989
typeshed: 0.74853

this branch:
zulip: 0.99702
django: 0.99783
warehouse: 0.99582
build: 0.75623
transformers: 0.99463
cpython: 0.75516
typeshed: 0.74853

this is a regression, i'll investigate

---

_Comment by @charliermarsh on 2023-08-10 18:08_

It _could_ be related to the fact that we format single-quote docstrings, while Black does not. (You're welcome to change that.)

---

_@MichaReiser reviewed on 2023-08-10 18:35_

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/expression/string.rs`:673 on 2023-08-10 18:35_

That's correct, but black doesn't support changing the indent style.

I recommend running some doctest with the default options and once with indent style tab(4)

---

_Comment by @konstin on 2023-08-10 18:48_

black does format single quote docstrings for me.

The problem was a chaperone space where there shouldn't be one, it's fixed now and the similarity scores match again; i updated the PR description.

---

_Comment by @charliermarsh on 2023-08-10 18:51_

Can you document whatever you see around single-quote docstrings in the Black Deviations document, where we claim Black doesn't format them?

---

_Comment by @konstin on 2023-08-10 19:40_

oh that's a slightly different area, it's about formatting the surroundings of the docstring that happens in `FormatSuite` rather than the docstring formatting itself:
```python
class OracleSpatialRefSys(models.Model, SpatialRefSysMixin):
    "Maps to the Oracle MDSYS.CS_SRS table."
    cs_name = models.CharField(max_length=68)
```
unlike black, we format this to
```python
class OracleSpatialRefSys(models.Model, SpatialRefSysMixin):
    "Maps to the Oracle MDSYS.CS_SRS table."

    cs_name = models.CharField(max_length=68)
```
It's code that i only moved around in this PR. I've added a comment but i think it's reasonable for black compatibility to fix that like a compatibility bug later. (From a style perspective, i'd turn single quoted docstrings into triple quoted docstrings)

---

_@MichaReiser reviewed on 2023-08-10 20:28_

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/expression/string.rs`:121 on 2023-08-10 20:28_

You can return a format_with or format_once. 

---

_@MichaReiser reviewed on 2023-08-10 20:30_

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/expression/string.rs`:695 on 2023-08-10 20:30_

Oh okay. We should define it somewhere (if it isn't already the case)

---

_Review comment by @konstin on `crates/ruff_python_formatter/src/expression/string.rs`:673 on 2023-08-11 10:36_

do we actually allow setting the tab width somewhere (or did you mean something else)? `IndentStyle` is `enum IndentStyle { Tab, Space(u8) }`

---

_@konstin reviewed on 2023-08-11 10:36_

---

_@MichaReiser reviewed on 2023-08-11 12:17_

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/expression/string.rs`:673 on 2023-08-11 12:17_

Oh we don't. Its an option on `PrinterOptions` but it seems we never initialize it: 

https://github.com/astral-sh/ruff/blob/3ef1c2e3030028178c87314d7528ecec074cc840/crates/ruff_formatter/src/printer/printer_options/mod.rs#L6-L7

Anyway. adding a test with indent style tab would be good. We can expose the tab width later.

---

_@konstin reviewed on 2023-08-14 12:01_

---

_Review comment by @konstin on `crates/ruff_python_formatter/src/expression/string.rs`:673 on 2023-08-14 12:01_

added 4 spaces, 2 spaces and tab fixture

---

_Merged by @konstin on 2023-08-14 12:28_

---

_Closed by @konstin on 2023-08-14 12:28_

---

_Branch deleted on 2023-08-14 12:29_

---
