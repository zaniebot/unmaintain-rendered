<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Implement copyright notice detection - astral-sh/ruff #4701</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Implement copyright notice detection</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/4701">#4701</a>
        opened by <a href="https://github.com/Ryang20718">@Ryang20718</a>
        on 2023-05-29 07:39
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Ryang20718">@Ryang20718</a></div>
            <div class="timeline-body">Summary
<p>Add copyright notice detection to enforce the presence of copyright headers in Python files.</p>
<p>Configurable settings include: the relevant regular expression, the author name, and the minimum file size, similar to <a href="https://github.com/savoirfairelinux/flake8-copyright">flake8-copyright</a>.</p>
<p>Closes <a href="https://github.com/charliermarsh/ruff/issues/3579">charliermarsh/ruff#3579</a></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/Ryang20718">@Ryang20718</a> on <code>crates/ruff/src/checkers/physical_lines.rs</code>:163 on 2023-05-29 07:46</div>
            <div class="timeline-body"><p>Could also do dep injection here and pass regexp as an arg. However, that would essentially put all the logic in physical_lines.rs. Let me know which you would prefer</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Ryang20718">@Ryang20718</a> reviewed on 2023-05-29 07:46</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by <a href="https://github.com/Ryang20718">@Ryang20718</a> on 2023-05-29 07:50</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2023-05-29 08:24</div>
            <div class="timeline-body">PR Check Results
Benchmark
Linux
<pre><code>group                                      main                                   pr
-----                                      ----                                   --
linter/all-rules/large/dataset.py          1.00     15.2±0.09ms     2.7 MB/sec    1.01     15.3±0.06ms     2.7 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      3.7±0.01ms     4.5 MB/sec    1.10      4.0±0.01ms     4.1 MB/sec
linter/all-rules/numpy/globals.py          1.00    377.8±1.41µs     7.8 MB/sec    1.90    717.4±4.90µs     4.1 MB/sec
linter/all-rules/pydantic/types.py         1.00      6.3±0.01ms     4.0 MB/sec    1.04      6.6±0.01ms     3.9 MB/sec
linter/default-rules/large/dataset.py      1.01      7.5±0.03ms     5.4 MB/sec    1.00      7.5±0.05ms     5.5 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.04  1613.6±11.13µs    10.3 MB/sec    1.00   1549.2±5.07µs    10.7 MB/sec
linter/default-rules/numpy/globals.py      1.06    176.7±0.58µs    16.7 MB/sec    1.00    167.0±0.14µs    17.7 MB/sec
linter/default-rules/pydantic/types.py     1.03      3.4±0.00ms     7.5 MB/sec    1.00      3.3±0.04ms     7.7 MB/sec
parser/large/dataset.py                    1.00      5.7±0.00ms     7.1 MB/sec    1.03      5.9±0.00ms     6.9 MB/sec
parser/numpy/ctypeslib.py                  1.00   1127.4±0.78µs    14.8 MB/sec    1.03   1161.5±4.55µs    14.3 MB/sec
parser/numpy/globals.py                    1.00    115.2±0.39µs    25.6 MB/sec    1.04    119.8±0.36µs    24.6 MB/sec
parser/pydantic/types.py                   1.00      2.5±0.00ms    10.3 MB/sec    1.02      2.5±0.00ms    10.1 MB/sec
</code></pre>
Windows
<pre><code>group                                      main                                   pr
-----                                      ----                                   --
linter/all-rules/large/dataset.py          1.00     16.8±0.22ms     2.4 MB/sec    1.03     17.4±0.44ms     2.3 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      4.4±0.09ms     3.8 MB/sec    1.08      4.7±0.03ms     3.5 MB/sec
linter/all-rules/numpy/globals.py          1.00    465.6±8.56µs     6.3 MB/sec    1.85   859.3±15.41µs     3.4 MB/sec
linter/all-rules/pydantic/types.py         1.00      7.2±0.06ms     3.5 MB/sec    1.06      7.6±0.13ms     3.3 MB/sec
linter/default-rules/large/dataset.py      1.00      8.6±0.20ms     4.7 MB/sec    1.01      8.7±0.12ms     4.7 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.01  1822.8±38.48µs     9.1 MB/sec    1.00  1811.9±32.52µs     9.2 MB/sec
linter/default-rules/numpy/globals.py      1.02    197.2±1.57µs    15.0 MB/sec    1.00    194.2±7.07µs    15.2 MB/sec
linter/default-rules/pydantic/types.py     1.01      3.9±0.03ms     6.6 MB/sec    1.00      3.9±0.05ms     6.6 MB/sec
parser/large/dataset.py                    1.00      6.7±0.04ms     6.1 MB/sec    1.04      7.0±0.03ms     5.8 MB/sec
parser/numpy/ctypeslib.py                  1.00  1279.3±10.69µs    13.0 MB/sec    1.04  1330.2±14.93µs    12.5 MB/sec
parser/numpy/globals.py                    1.00    131.4±1.49µs    22.4 MB/sec    1.06    139.6±2.17µs    21.1 MB/sec
parser/pydantic/types.py                   1.00      2.9±0.04ms     8.9 MB/sec    1.04      3.0±0.02ms     8.6 MB/sec
</code></pre>


</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Ryang20718">@Ryang20718</a> on 2023-05-29 20:40</div>
            <div class="timeline-body"><p>Hi, I made a first stab at implementing <a href="https://github.com/charliermarsh/ruff/pull/4701">charliermarsh/ruff#4701</a> flake8-copyright</p>
<p>However, it seems like the &quot;pre-commit&quot; check in CI is failing due to a lack of copyright headers on some python files in the scripts directory https://github.com/charliermarsh/ruff/actions/runs/5115146921/jobs/9196121487?pr=4701
Wondering if it would be preferable to add the copyright header, disable the check or add noqa C801?</p>
<p>When I tried adding noqa, when emulating CI and running the command locally, it would overwrite my changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Ryang20718">@Ryang20718</a> on 2023-05-29 20:43</div>
            <div class="timeline-body"><p>Sorry if this was documented somewhere/asked again, but wondering if there&#x27;s a group of people to assign as reviewers for PR&#x27;s?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff/src/checkers/physical_lines.rs</code>:179 on 2023-05-30 06:36</div>
            <div class="timeline-body"><p><code>line.len</code> gives you the number of bytes on that line, not the number of characters. The two numbers are different for non-ascii strings (e.g. emojis consist of multiple bytes, but represent a single character)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff/src/rules/flake8_copyright/rules/copyright_header_absent.rs</code>:31 on 2023-05-30 06:37</div>
            <div class="timeline-body"><p>We should gracefully handle the case where the <code>Regex</code> is invalid rather than just panicking.</p>
<p>@charliermarsh is there a place where we could do this deserialization outside of the rule (maybe in the configuration to settings deserialization?)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff/src/rules/flake8_copyright/rules/copyright_header_absent.rs</code>:34 on 2023-05-30 06:39</div>
            <div class="timeline-body"><p>Ruff only supports files up to 4GB. Using a u32 should be fine.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff/src/rules/flake8_copyright/rules/copyright_header_absent.rs</code>:26 on 2023-05-30 06:41</div>
            <div class="timeline-body"><p>Nit: I think it would improve readability if this rule returns a custom enum instead of <code>Option&lt;bool&gt;</code></p>
<pre><code>#[derive(Copy, Clone, Eq, PartialEq)]
enum CopyrightHeaderKind{
	Missing,
	Present,
	TooSmall
}
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff/src/rules/flake8_copyright/rules/copyright_header_absent.rs</code>:22 on 2023-05-30 06:42</div>
            <div class="timeline-body"><p>Is it necessary that this rule runs on every line? Could we instead call the rule just once, passing the full source code? Should this rule only run on comments (or doc-strings)? rather than on all source code?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff/src/rules/flake8_copyright/settings.rs</code>:52 on 2023-05-30 06:42</div>
            <div class="timeline-body"><p>Does the rule use <code>-1</code> to indicate no limit?</p>
<p>I think I would prefer the use of an <code>Option</code> instead.</p>
<pre><code>    pub copyright_min_file_size: Option&lt;u32&gt;,
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-05-30 06:45</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Ryang20718">@Ryang20718</a> reviewed on 2023-05-30 16:20</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/Ryang20718">@Ryang20718</a> on <code>crates/ruff/src/rules/flake8_copyright/rules/copyright_header_absent.rs</code>:22 on 2023-05-30 16:20</div>
            <div class="timeline-body"><p><img src="https://github.com/charliermarsh/ruff/assets/31294356/f2e95a9d-e4ea-47b5-a580-2f4104645a46" alt="image">
I initially asked on discord. I think it would more efficient as well to pass the full source code as well.</p>
<p>Is there any rule that currently does this pattern or should I just create a separate portion in check_physical_lines to pass the entire source code?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Ryang20718">@Ryang20718</a> reviewed on 2023-05-30 16:21</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/Ryang20718">@Ryang20718</a> on <code>crates/ruff/src/rules/flake8_copyright/rules/copyright_header_absent.rs</code>:26 on 2023-05-30 16:21</div>
            <div class="timeline-body"><p>Will do!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Ryang20718">@Ryang20718</a> reviewed on 2023-05-30 16:21</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/Ryang20718">@Ryang20718</a> on <code>crates/ruff/src/rules/flake8_copyright/rules/copyright_header_absent.rs</code>:34 on 2023-05-30 16:21</div>
            <div class="timeline-body"><p>Will fix</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-05-30 20:27</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff/src/rules/flake8_copyright/rules/copyright_header_absent.rs</code>:22 on 2023-05-30 20:27</div>
            <div class="timeline-body"><p>@charliermarsh what&#x27;s your take?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Ryang20718">@Ryang20718</a> reviewed on 2023-05-31 06:42</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/Ryang20718">@Ryang20718</a> on <code>crates/ruff/src/rules/flake8_copyright/rules/copyright_header_absent.rs</code>:31 on 2023-05-31 06:42</div>
            <div class="timeline-body"><p>Made it default to known regex string if user specified regex passed in panics for now, but open to better suggestions</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Ryang20718">@Ryang20718</a> reviewed on 2023-05-31 06:47</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/Ryang20718">@Ryang20718</a> on <code>crates/ruff/src/rules/flake8_copyright/settings.rs</code>:52 on 2023-05-31 06:47</div>
            <div class="timeline-body"><p>converted to u32, max will be 1024 chars with default always be. rule doesn&#x27;t use -1</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-06-05 02:27</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff/src/rules/flake8_copyright/rules/copyright_header_absent.rs</code>:22 on 2023-06-05 02:27</div>
            <div class="timeline-body"><p>Yeah I&#x27;d suggest rewriting to call once per file, especially since it&#x27;s limited to the first N characters anyway.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-06-05 02:29</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff/src/registry.rs</code>:741 on 2023-06-05 02:29</div>
            <div class="timeline-body"><p>Nit: let&#x27;s use <code>CPY</code> here, I&#x27;d like to avoid overloading the <code>C</code> prefix.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-06-05 02:31</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff/src/rules/flake8_copyright/settings.rs</code>:12 on 2023-06-05 02:31</div>
            <div class="timeline-body"><p>Can we do a brief GitHub Codesearch to see how often (if ever) these options are used? And if they&#x27;re important to support?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-06-05 02:31</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff/src/rules/flake8_copyright/settings.rs</code>:1 on 2023-06-05 02:31</div>
            <div class="timeline-body"><p>Nit: double comment pragma here.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-06-05 02:32</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff/src/rules/flake8_copyright/rules/copyright_header_absent.rs</code>:7 on 2023-06-05 02:32</div>
            <div class="timeline-body"><p>Nit: if we do need a lazy regex, lets just use <code>Lazy::new(|| Regex::new(...))</code>, to avoid adding another dependency.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Ryang20718">@Ryang20718</a> reviewed on 2023-06-05 02:53</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/Ryang20718">@Ryang20718</a> on <code>crates/ruff/src/rules/flake8_copyright/settings.rs</code>:12 on 2023-06-05 02:53</div>
            <div class="timeline-body"><p>From a brief text based search on public repos,</p>
<p>Copyright min file size is used in 70+ places. https://github.com/search?q=copyright-min-file-size&amp;type=code
Copyright regexp is used in 370+ places. https://github.com/search?q=copyright-regexp&amp;type=code
Copyright Author is used in 290+ places https://github.com/search?q=%22copyright-author+%3D+%22&amp;type=code</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Ryang20718">@Ryang20718</a> on 2023-06-06 02:19</div>
            <div class="timeline-body"><p>Addressed comments.</p>
<p>This PR should be good for re-review. However, the CI problem still lingers. I tried adding <code># noqa: CPY801</code> to the python files, but autofix removes the line. I could add a line to these scripts such as <code># Copyright (c) 2023 ruff</code> or is there a way we can disable this check when running ruff on this repo for that particular github action?</p>
<p><img src="https://github.com/charliermarsh/ruff/assets/31294356/121b234e-88fd-45c1-9955-6a4d730eace6" alt="image"></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-06-06 02:32</div>
            <div class="timeline-body"><p>Sorry, missed that question -- can we add <code>CPY</code> to the <code>ignore</code> in <code>scripts/pyproject.toml</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Ryang20718">@Ryang20718</a> on 2023-06-06 02:36</div>
            <div class="timeline-body"><p>TIL nested pyproject.toml. Neat!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Ryang20718">@Ryang20718</a> on 2023-06-07 03:02</div>
            <div class="timeline-body"><p>addressed all comments. Wondering if @charliermarsh or @MichaReiser could re-review please?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/charliermarsh">@charliermarsh</a> by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-06-10 01:56</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from &quot;Implement flake8 copyright&quot; to &quot;Implement copyright notice detection&quot; by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-06-11 02:07</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">plugin</span> added by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-06-11 02:09</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-06-11 02:17</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-06-11 02:17</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/gertvdijk">@gertvdijk</a> on 2023-06-20 22:19</div>
            <div class="timeline-body"><p>Hi! Cool to see a another new rule has landed.</p>
<p>Two comments - as seen in 0.0.237:</p>
<ol>
<li><p>The listing of linters appears inconsistent:</p>
<pre><code>$ ruff linter
[...]
 COM flake8-commas
 CPY Copyright-related rules
  C4 flake8-comprehensions
[...]
</code></pre>
<p>That line should have been  <code>CPY flake8-copyright</code>, I think.</p>
</li>
<li><p><a href="https://beta.ruff.rs/docs/rules/missing-copyright-notice/">The docs</a> say ...</p>
<blockquote>
<p>This rule is part of the nursery, a collection of newer lints that are still under development. As such, it must be enabled by explicitly selecting CPY001.</p>
</blockquote>
<p>... but it&#x27;s enabled already using <code>CPY</code> (broader). Could it be an accidental copy/paste from some E-rules?</p>
</li>
</ol>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-06-20 23:05</div>
            <div class="timeline-body"><p>Thanks for this. I had intentionally renamed to &quot;Copyright-related rules&quot; but perhaps that was a mistake.</p>
<p>(I think it&#x27;s probably a bug that <code>--select CPY</code> works... but it&#x27;s not a big deal in this case since the category only has the one rule, so I might not even bother to fix :joy:)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2023-06-20 23:09</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 18:54:02 UTC
    </footer>
</body>
</html>
