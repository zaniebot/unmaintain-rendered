```yaml
number: 9559
title: "Migrate release workflow to `cargo-dist`"
type: pull_request
state: merged
author: charliermarsh
labels:
  - breaking
  - release
assignees: []
merged: true
base: ruff-0.5
head: charlie/cargo-dist-test
created_at: 2024-01-17T05:46:53Z
updated_at: 2024-06-25T17:34:03Z
url: https://github.com/astral-sh/ruff/pull/9559
synced_at: 2026-01-10T21:55:59Z
```

# Migrate release workflow to `cargo-dist`

---

_Pull request opened by @charliermarsh on 2024-01-17 05:46_

## Summary

This PR migrates our release workflow to [`cargo-dist`](https://github.com/axodotdev/cargo-dist). The primary motivation here is that we want to ship dedicated installers for Ruff that work across platforms, and `cargo-dist` gives us those installers out-of-the-box. The secondary motivation is that `cargo-dist` formalizes some of the patterns that we've built up over time in our own release process.

At a high level:

- The `release.yml` file is generated by `cargo-dist` with `cargo dist generate`. It doesn't contain any modifications vis-a-vis the generated file. (If it's edited out of band from generation, the release fails.)
- Our customizations are inserted as custom steps within the `cargo-dist` workflow. Specifically, `build-binaries` builds the wheels and packages them into binaries (as on `main`), while `build-docker.yml` builds the Docker image. `publish-pypi.yml` publishes the wheels to PyPI. This is effectively our `release.yaml` (on `main`), broken down into individual workflows rather than steps within a single workflow.

### Changes from `main`

The workflow is _nearly_ unchanged. We kick off a release manually via the GitHub Action by providing a tag. If the tag doesn't match the `Cargo.toml`, the release fails. If the tag matches an already-existing release, the release fails.

The release proceeds by (in order):

0. Doing some upfront validation via `cargo-dist`.
1. Creating the wheels and archives.
2. Building and pushing the Docker image.
3. Publishing to PyPI (if it's not a "dry run").
4. Creating the GitHub Release (if it's not a "dry run").
5. Notifying `ruff-pre-commit` (if it's not a "dry run").

There are a few changes in the workflow as compared to `main`:

- **We no longer validate the SHA** (just the tag). It's not an input to the job. The Axo team is considering whether / how to support this.
- **Releases are now published directly** (rather than as draft). Again, the Axo team is considering whether / how to support this. The downside of drafts is that the URLs aren't stable, so the installers don't work _as long as the release is in draft_. This is fine for our workflow. It seems like the Axo team will add it.
- Releases already contain the latest entry from the changelog (we don't need to copy it over). This "Just Works", which is nice, though we'll still want to edit them to add contributors.

There are also a few **breaking changes** for consumers of the binaries:

- **We no longer include the version tag in the file name**. This enables users to install via `/latest` URLs on GitHub, and is part of the cargo-dist paradigm.
- **Archives now include an extra level of nesting,** which you can remove with `--strip-components=1` when untarring.

Here's an example release that I created -- I omitted all the artifacts since I was just testing a workflow, so none of the installers or links work, but it gives you a sense for what the release looks like: https://github.com/charliermarsh/cargodisttest/releases/tag/0.1.13.

### Test Plan

I ran a successful release to completion last night, and installed Ruff via the installer:

![Screenshot 2024-01-17 at 12 12 53 AM](https://github.com/astral-sh/ruff/assets/1309177/a5334466-2ca3-4279-a453-e912a0805df2)

![Screenshot 2024-01-17 at 12 12 48 AM](https://github.com/astral-sh/ruff/assets/1309177/63ac969e-69a1-488c-8367-4cb783526ca7)

The piece I'm least confident about is the Docker push. We build the image, but the push fails in my test repo since I haven't wired up the credentials.


---

_Label `release` added by @charliermarsh on 2024-01-17 05:47_

---

_Comment by @codspeed-hq[bot] on 2024-01-17 05:54_

## [CodSpeed Performance Report](https://codspeed.io/astral-sh/ruff/branches/charlie/cargo-dist-test)

### Merging #9559 will **not alter performance**

<sub>Comparing <code>charlie/cargo-dist-test</code> (4557a13) with <code>ruff-0.5</code> (2a28e97)</sub>



### Summary

`✅ 30` untouched benchmarks






---

_Comment by @github-actions[bot] on 2024-01-17 06:27_

<!-- generated-comment ecosystem -->
## `ruff-ecosystem` results
### Linter (stable)
✅ ecosystem check detected no linter changes.

### Linter (preview)
✅ ecosystem check detected no linter changes.

### Formatter (stable)
✅ ecosystem check detected no format changes.

### Formatter (preview)
✅ ecosystem check detected no format changes.




---

_Review requested from @zanieb by @charliermarsh on 2024-01-17 22:09_

---

_Review requested from @konstin by @charliermarsh on 2024-01-17 22:09_

---

_Marked ready for review by @charliermarsh on 2024-01-17 22:09_

---

_@charliermarsh reviewed on 2024-01-17 22:11_

---

_Review comment by @charliermarsh on `.github/workflows/build-binaries.yml`:96 on 2024-01-17 22:11_

One import piece here is that per @Gankra the installers expect that the binary is under a dummy directory of the same name, so we copy the binary into a dummy directory of the same name prior to archiving.

---

_@charliermarsh reviewed on 2024-01-17 22:11_

---

_Review comment by @charliermarsh on `.github/workflows/build-docker.yml`:62 on 2024-01-17 22:11_

`announcement_tag_is_implicit` indicates "dry run".

---

_@zanieb reviewed on 2024-01-18 00:05_

---

_Review comment by @zanieb on `Cargo.toml`:196 on 2024-01-18 00:05_

Could we split these onto multiple lines?

---

_Review comment by @zanieb on `Cargo.toml`:260 on 2024-01-18 00:06_

Why false?

---

_@zanieb reviewed on 2024-01-18 00:06_

---

_@zanieb reviewed on 2024-01-18 00:10_

---

_Review comment by @zanieb on `.github/workflows/release.yml`:73 on 2024-01-18 00:10_

Not for review, but I find this confusing and it doesn't make it clear to me what the behaviors are on pull requests and forks.

---

_@zanieb reviewed on 2024-01-18 00:15_

---

_Review comment by @zanieb on `.github/workflows/build-binaries.yml`:135 on 2024-01-18 00:15_

This is missing `bash` and `set ...` like the rest

---

_@zanieb reviewed on 2024-01-18 00:15_

---

_Review comment by @zanieb on `.github/workflows/build-binaries.yml`:356 on 2024-01-18 00:15_

We have submodules?

---

_@zanieb approved on 2024-01-18 00:17_

---

_Review comment by @konstin on `.github/workflows/build-binaries.yml`:20 on 2024-01-18 09:30_

There's no file with that name, maybe when any workflow changes, or just `.github/workflows/build-binaries.yaml`

```suggestion
      - .github/workflows/*.yaml
```

---

_Review comment by @konstin on `.github/workflows/build-binaries.yml`:96 on 2024-01-18 09:32_

Could you make this a code comment?

---

_Review comment by @konstin on `.github/workflows/build-docker.yml`:45 on 2024-01-18 09:42_

Is this one intentionally only in the docker build?

---

_@konstin approved on 2024-01-18 09:43_

---

_Label `breaking` added by @charliermarsh on 2024-02-08 17:22_

---

_Comment by @charliermarsh on 2024-04-07 03:22_

I'm planning to ship this as part of Ruff v0.4.0 (i.e., in the next few weeks) given that it changes the archive format.

---

_Added to milestone `v0.4.0` by @charliermarsh on 2024-04-07 03:29_

---

_Removed from milestone `v0.4.0` by @dhruvmanila on 2024-04-18 19:49_

---

_Added to milestone `v0.5.0` by @dhruvmanila on 2024-04-18 19:49_

---

_Comment by @charliermarsh on 2024-06-25 14:28_

I will merge this today.

---

_Review requested from @zanieb by @charliermarsh on 2024-06-25 17:04_

---

_Review requested from @konstin by @charliermarsh on 2024-06-25 17:04_

---

_Review requested from @carljm by @charliermarsh on 2024-06-25 17:04_

---

_Review requested from @MichaReiser by @charliermarsh on 2024-06-25 17:04_

---

_Review requested from @dhruvmanila by @charliermarsh on 2024-06-25 17:04_

---

_Merged by @charliermarsh on 2024-06-25 17:34_

---

_Closed by @charliermarsh on 2024-06-25 17:34_

---

_Branch deleted on 2024-06-25 17:34_

---
