```yaml
number: 8044
title: Add test and basic implementation for formatter preview mode
type: pull_request
state: merged
author: konstin
labels:
  - formatter
assignees: []
merged: true
base: main
head: formatter-preview
created_at: 2023-10-18T11:54:14Z
updated_at: 2023-10-26T15:40:50Z
url: https://github.com/astral-sh/ruff/pull/8044
synced_at: 2026-01-12T02:32:41Z
```

# Add test and basic implementation for formatter preview mode

---

_Pull request opened by @konstin on 2023-10-18 11:54_

**Summary** Prepare for the black preview style becoming the black stable style at the end of the year.

This adds a new test file to compare stable and preview on some relevant preview options in black, and makes `format_dev` understand the black preview flag. I've added poetry as a project that uses preview.

I've implemented one specific deviation (collapsing of stub implementation in non-stub files) which showed up in poetry for testing. This also improves poetry compatibility from 0.99891 to 0.99919.

Fixes #7440

New compatibility stats:
| project        | similarity index  | total files       | changed files     |
|----------------|------------------:|------------------:|------------------:|
| cpython        |           0.75803 |              1799 |              1647 |
| django         |           0.99983 |              2772 |                35 |
| home-assistant |           0.99953 |             10596 |               189 |
| poetry         |           0.99919 |               317 |                12 |
| transformers   |           0.99963 |              2657 |               332 |
| twine          |           1.00000 |                33 |                 0 |
| typeshed       |           0.99978 |              3669 |                20 |
| warehouse      |           0.99969 |               654 |                15 |
| zulip          |           0.99970 |              1459 |                22 |


---

_Label `formatter` added by @konstin on 2023-10-18 11:54_

---

_Comment by @github-actions[bot] on 2023-10-18 12:13_

## PR Check Results
### Ecosystem
âœ… ecosystem check detected no changes.



---

_Review comment by @charliermarsh on `crates/ruff_python_formatter/tests/snapshots/format@preview.py.snap`:3 on 2023-10-18 13:54_

Should we instead run every test under preview and non-preview?

---

_@charliermarsh reviewed on 2023-10-18 13:54_

---

_@zanieb reviewed on 2023-10-18 15:11_

---

_Review comment by @zanieb on `crates/ruff_python_formatter/tests/snapshots/format@preview.py.snap`:3 on 2023-10-18 15:11_

If the cost is not too high that seems ideal

---

_Comment by @konstin on 2023-10-18 16:59_

Current dependencies on/for this PR:
* main
  * **PR #8049** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/8049" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a> 
    * **PR #8044** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/8044" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a>  ðŸ‘ˆ

This comment was auto-generated by [Graphite](https://app.graphite.dev/github/pr/astral-sh/ruff/8044?utm_source=stack-comment).

---

_@konstin reviewed on 2023-10-18 17:00_

---

_Review comment by @konstin on `crates/ruff_python_formatter/tests/snapshots/format@preview.py.snap`:3 on 2023-10-18 17:00_

`hyperfine "cargo test -p ruff_python_formatter"` goes from 500ms to 580ms on my machine, acceptable for me. 

Having both versions makes it hard to see what actually changed given our large snapshots, so i opted for instead adding the diff as separate code block if there is one. I also changed all non-function/class tests to use `pass` instead as real code generally does, which i split out to #8049 to keep the diff readable.

---

_@konstin reviewed on 2023-10-18 17:02_

---

_Review comment by @konstin on `crates/ruff_python_formatter/tests/snapshots/format@preview.py.snap`:3 on 2023-10-18 17:02_

I would like to keep `preview.py` as-is though, it's a useful tool for tracking progress and comparing to black (i can diff both snapshots with what the black playground does)

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/tests/fixtures.rs`:150 on 2023-10-18 23:08_

Should we skip this if `options.preview == Enabled` when using a test specific options file? 

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/tests/snapshots/format@statement__function.py.snap`:999 on 2023-10-18 23:10_

I wonder how noisy this gets once we start having many preview style rules. But let's see how it goes.

---

_@MichaReiser approved on 2023-10-18 23:10_

---

_@konstin reviewed on 2023-10-19 09:10_

---

_Review comment by @konstin on `crates/ruff_python_formatter/tests/fixtures.rs`:150 on 2023-10-19 09:10_

This is the no-options-file branch; i think it's better to not mix them to avoid combinatorial explosion

---

_Review requested from @zanieb by @konstin on 2023-10-19 09:11_

---

_Review requested from @charliermarsh by @konstin on 2023-10-19 09:11_

---

_Comment by @charliermarsh on 2023-10-25 19:09_

@konstin - Is this good to merge?

---

_Comment by @konstin on 2023-10-26 15:23_

yep

---

_Merged by @konstin on 2023-10-26 15:33_

---

_Closed by @konstin on 2023-10-26 15:33_

---

_Branch deleted on 2023-10-26 15:33_

---
