<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[`ruff`] Fix syntax error introduced for an empty string followed by a u-prefixed string (`UP025`) - astral-sh/ruff #18899</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[<code>ruff</code>] Fix syntax error introduced for an empty string followed by a u-prefixed string (<code>UP025</code>)</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/18899">#18899</a>
        opened by <a href="https://github.com/lubaskinc0de">@lubaskinc0de</a>
        on 2025-06-23 17:08
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/lubaskinc0de">@lubaskinc0de</a> on 2025-06-23 17:08</div>
            <div class="timeline-body"><h2>Summary</h2>
<p>/closes #18895</p>
<h2>Test Plan</h2>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @ntBre on 2025-06-23 17:37</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">fixes</span> added by @ntBre on 2025-06-23 17:37</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/pyupgrade/rules/unicode_kind_prefix.rs</code>:51 on 2025-06-23 17:54</div>
            <div class="timeline-body"><p>I don't think this arithmetic is necessary. The <code>is_unicode</code> check above confirms that the first character will be a <code>u</code>, so this just boils down to what was inside <code>Edit::range_deletion</code> originally.</p>
<pre><code class="language-suggestion">        let prefix_range = TextRange::at(string.start(), TextSize::new(1));
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-06-23 18:01</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/pyupgrade/rules/unicode_kind_prefix.rs</code>:51 on 2025-06-23 18:09</div>
            <div class="timeline-body"><p>In general, I think something like this might be a simpler version of the current implementation:</p>
<pre><code class="language-rust">        let prefix_range = TextRange::at(string.start(), TextSize::new(1));

        let locator = checker.locator();
        let content = locator
            .slice(TextRange::new(prefix_range.end(), string.end()))
            .to_owned();
        // If the preceding character is equivalent to the quote character, insert a space to avoid a
        // syntax error. For example, when removing the `u` prefix in `&quot;&quot;u&quot;&quot;`, rewrite to `&quot;&quot; &quot;&quot;`
        // instead of `&quot;&quot;&quot;&quot;`.
        // see https://github.com/astral-sh/ruff/issues/18895
        let edit = if locator
            .slice(TextRange::up_to(prefix_range.start()))
            .chars()
            .last()
            .is_some_and(|char| content.starts_with(char))
        {
            Edit::range_replacement(&quot; &quot;.to_string(), prefix_range)
        } else {
            Edit::range_deletion(prefix_range)
        };

        diagnostic.set_fix(Fix::safe_edit(edit));
</code></pre>
<p>This just gives either a deletion like before or simply replaces the <code>u</code> with a space, instead of having to replace the whole string.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/pyupgrade/snapshots/ruff_linter__rules__pyupgrade__tests__UP025.py.snap</code>:284 on 2025-06-23 18:42</div>
            <div class="timeline-body"><p>I'm slightly concerned that we're now adding spaces where they aren't totally necessary. The issue indicated a few more constraints on the problem:</p>
<blockquote>
<p>introduce a syntax error when the prefixed string follows a <strong>non-triple-quoted empty</strong> string with the same kind of quotation marks without an intervening space</p>
</blockquote>
<p>Cases like this (<code>&quot;foo&quot;&quot;bar&quot;</code> and even <code>&quot;foo&quot;&quot;&quot;</code>) are okay, as are empty triple-quoted strings like <code>&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;</code> (8 double quotes):</p>
<pre><code class="language-shell">$ python -m tokenize &lt;&lt;&lt;'&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;'
1,0-1,6:            STRING         '&quot;&quot;&quot;&quot;&quot;&quot;'
1,6-1,8:            STRING         '&quot;&quot;'
1,8-1,9:            NEWLINE        '\n'
2,0-2,0:            ENDMARKER      ''
</code></pre>
<p>I think we could check the kind of the preceding token to see if it's a triple-quoted string, but I don't think we can perform an <code>is_empty</code> check on the tokens.</p>
<p>@MichaReiser what do you think? Is it okay to add spaces where they aren't strictly necessary, or do you know of a better way to check if the previous string part is non-triple-quoted and empty?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-06-23 18:42</div>
            <div class="timeline-body"><p>Thanks! I had a suggestion for a slightly simpler version of the current implementation and also a question that I'm not sure about either.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-06-24 06:45</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/pyupgrade/snapshots/ruff_linter__rules__pyupgrade__tests__UP025.py.snap</code>:284 on 2025-06-24 06:45</div>
            <div class="timeline-body"><p>I think the easiest would be to make this a rule that operates on <code>StringLike</code> and then iterate over all parts. This also ensures that, when removing multiple parts, that the spacing is only inserted when necessary.</p>
<blockquote>
<p>I think we could check the kind of the preceding token to see if it's a triple-quoted string, but I don't think we can perform an is_empty check on the tokens.</p>
</blockquote>
<p>I think this is correct because of line continuations where subtracting the prefix from the range doesn't yield the correct result:</p>
<pre><code class="language-py">a= &quot;\
&quot; u&quot;c&quot;
</code></pre>
<blockquote>
<p>s it okay to add spaces where they aren't strictly necessary, or do you know of a better way to check if the previous string part is non-triple-quoted and empty?</p>
</blockquote>
<p>I think it's fine for as long as it only pads at most one space (never results in two consecutive spaces)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/lubaskinc0de">@lubaskinc0de</a> reviewed on 2025-06-29 11:52</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/lubaskinc0de">@lubaskinc0de</a> on <code>crates/ruff_linter/src/rules/pyupgrade/snapshots/ruff_linter__rules__pyupgrade__tests__UP025.py.snap</code>:284 on 2025-06-29 11:52</div>
            <div class="timeline-body"><p>Going back to this problem, I don't really understand the next steps. Here's the current implementation</p>
<pre><code class="language-rust">/// UP025
pub(crate) fn unicode_kind_prefix(checker: &amp;Checker, string: &amp;StringLiteral) {
    if string.flags.prefix().is_unicode() {
        let mut diagnostic = checker.report_diagnostic(UnicodeKindPrefix, string.range);

        let prefix_range = TextRange::at(string.start(), TextSize::new(1));
        let locator = checker.locator();
        let content = locator
            .slice(TextRange::new(prefix_range.end(), string.end()))
            .to_owned();

        // If the preceding character is equivalent to the quote character, insert a space to avoid a
        // syntax error. For example, when removing the `u` prefix in `&quot;&quot;u&quot;&quot;`, rewrite to `&quot;&quot; &quot;&quot;`
        // instead of `&quot;&quot;&quot;&quot;`.
        // see https://github.com/astral-sh/ruff/issues/18895
        let edit = if locator
            .slice(TextRange::up_to(prefix_range.start()))
            .chars()
            .last()
            .is_some_and(|char| content.starts_with(char))
        {
            Edit::range_replacement(&quot; &quot;.to_string(), prefix_range)
        } else {
            Edit::range_deletion(prefix_range)
        };

        diagnostic.set_fix(Fix::safe_edit(edit));
    }
}
</code></pre>
<p>As far as I understand, it correctly handles the following cases:
before fix:</p>
<pre><code class="language-py">a = &quot;\
&quot; u&quot;c&quot;

f&quot;foo&quot;u&quot;bar&quot;

f&quot;foo&quot; u&quot;bar&quot;

&quot;&quot;u&quot;&quot;
</code></pre>
<p>after fix:</p>
<pre><code class="language-py">a = &quot;\
&quot; &quot;c&quot;

f&quot;foo&quot; &quot;bar&quot;

f&quot;foo&quot; &quot;bar&quot;

&quot;&quot; &quot;&quot;
</code></pre>
<p>In that case, I don't understand the drawbacks of the current simple implementation. Are there any cases that are currently being handled differently than desired?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-06-30 21:43</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/pyupgrade/snapshots/ruff_linter__rules__pyupgrade__tests__UP025.py.snap</code>:284 on 2025-06-30 21:43</div>
            <div class="timeline-body"><p>My argument was that a case like this:</p>
<pre><code class="language-python">f&quot;foo&quot;u&quot;bar&quot;
</code></pre>
<p>is <em>not</em> being handled correctly because we're adding a space that isn't necessary. In other words, this fix would be fine:</p>
<pre><code class="language-python">f&quot;foo&quot;&quot;bar&quot;
</code></pre>
<p>but it's being fixed to</p>
<pre><code class="language-python">f&quot;foo&quot; &quot;bar&quot;
</code></pre>
<p>Micha said that could be okay as long as we never add a second space, but I don't entirely follow the line-continuation example. It does seem to be handled properly in the current version, as you said.</p>
<p>As Micha pointed out, another approach would be to iterate over the parts of the string instead of looking at a single part at a time. Then we could check the conditions mentioned in the issue that actually <em>require</em> a space to be inserted: the preceding string part is not triple quoted and not empty.</p>
<p>To be more concrete, we would pass in <code>value</code> here (or a transformed version of it to allow passing both f-strings and regular strings) instead of passing a single <code>string_part</code> at a time:</p>
<p>https://github.com/astral-sh/ruff/blob/10a14a9fc852afcef30eac5c82ad0671e6ec1b76/crates/ruff_linter/src/checkers/ast/analyze/expression.rs#L1575-L1579</p>
<p>With all that being said, maybe it's not worth worrying about and we can just move ahead with this version. I think the space looks better anyway, and I can't come up with a counter-example that adds a second space.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/lubaskinc0de">@lubaskinc0de</a> reviewed on 2025-07-01 08:35</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/lubaskinc0de">@lubaskinc0de</a> on <code>crates/ruff_linter/src/rules/pyupgrade/snapshots/ruff_linter__rules__pyupgrade__tests__UP025.py.snap</code>:284 on 2025-07-01 08:35</div>
            <div class="timeline-body"><p>I think that the simpler the implementation (and it's quite simple now) the better, and if it works correctly, why not keep it as it is? but it might be worth asking someone else</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/lubaskinc0de">@lubaskinc0de</a> reviewed on 2025-07-01 08:37</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/lubaskinc0de">@lubaskinc0de</a> on <code>crates/ruff_linter/src/rules/pyupgrade/snapshots/ruff_linter__rules__pyupgrade__tests__UP025.py.snap</code>:284 on 2025-07-01 08:37</div>
            <div class="timeline-body"><p>anyway, if you need to do it differently, I'll do it, just tell me</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-07-01 13:31</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/pyupgrade/snapshots/ruff_linter__rules__pyupgrade__tests__UP025.py.snap</code>:284 on 2025-07-01 13:31</div>
            <div class="timeline-body"><p>I think you're right, let's move ahead with the simple fix for now. Thank you!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> approved on 2025-07-01 13:31</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "[``ruff``] Fix introduces a syntax error for an empty string followed by a u-prefixed string (``UP025``)" to "[`ruff`] Fix syntax error introduced for an empty string followed by a u-prefixed string (`UP025`)" by @ntBre on 2025-07-01 13:33</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @ntBre on 2025-07-01 13:34</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @ntBre on 2025-07-01 13:34</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 18:33:37 UTC
    </footer>
</body>
</html>
