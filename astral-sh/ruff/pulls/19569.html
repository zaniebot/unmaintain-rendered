<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[`ruff`] Implement `global-or-nonlocal-in-branch` (`RUF103`) - astral-sh/ruff #19569</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[<code>ruff</code>] Implement <code>global-or-nonlocal-in-branch</code> (<code>RUF103</code>)</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/pull/19569">#19569</a>
        opened by <a href="https://github.com/ya7on">@ya7on</a>
        on 2025-07-26 17:25
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/ya7on">@ya7on</a> on 2025-07-26 17:25</div>
            <div class="timeline-body"><!--
Thank you for contributing to Ruff/ty! To help us out with reviewing, please consider the following:

- Does this pull request include a summary of the change? (See below.)
- Does this pull request include a descriptive title? (Please prefix with `[ty]` for ty pull
  requests.)
- Does this pull request include references to any relevant issues?
-->

<h2>Summary</h2>
<p>Implement the <code>global-or-nonlocal-in-branch</code> rule (<code>RUF103</code>), which detects cases where a variable
declared as <code>global</code> or <code>nonlocal</code> within a function is assigned in a separate branch of the function
without an explicit declaration along that code path. Such usage can be confusing and is often unintended.</p>
<p>Example:</p>
<pre><code class="language-python">g = 1

def f(b: bool) -&gt; None:
    if b:
        global g
        g = 2
    else:
        g = 3

f(False)
print(g)  # 3, not 1
</code></pre>
<p>Closes #6470.</p>
<h2>Test Plan</h2>
<p>Added unit tests covering:</p>
<ul>
<li>Assignments in the same branch as the declaration (no violation).</li>
<li>Assignments in a different branch without declaration (violation).</li>
<li>Cases with multiple branches and CFG paths.</li>
<li><code>nonlocal</code> usage (mirrors the global behavior).</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">rule</span> added by @ntBre on 2025-07-26 18:39</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">preview</span> added by @ntBre on 2025-07-26 18:39</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/codes.rs</code>:1055 on 2025-07-26 18:44</div>
            <div class="timeline-body"><p>I'm not quite sure, but I think the <code>RUF100</code> rules are a bit special. It looks like they're all related to noqa codes. I'd suggest pushing this up to <code>RUF066</code>, which is the next available code after <code>RUF065</code>, which is currently used in https://github.com/astral-sh/ruff/pull/19518.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-07-26 18:47</div>
            <div class="timeline-body"><p>Very cool! This is the first rule I've seen using the control flow graph, and it's closing quite a long-standing rule request too.</p>
<p>I'll leave the review to @dylwil3 since he wrote the CFG code, but I had one small suggestion about the rule code in passing.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @dylwil3 by @ntBre on 2025-07-26 18:48</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-07-26 18:59</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>ℹ️ ecosystem check <strong>detected linter changes</strong>. (+15 -0 violations, +0 -0 fixes in 8 projects; 47 projects unchanged)</p>
<details><summary><a href="https://github.com/apache/airflow">apache/airflow</a> (+4 -0 violations, +0 -0 fixes)</summary>
<p>
<pre>ruff check --no-cache --exit-zero --ignore RUF9 --no-fix --output-format concise --preview --select ALL</pre>
</p>
<p>

<pre>
+ <a href='https://github.com/apache/airflow/blob/2c677a49eccb35d61bc0cf00605ada833de103a2/dev/breeze/src/airflow_breeze/global_constants.py#L669'>dev/breeze/src/airflow_breeze/global_constants.py:669:9:</a> RUF066 The variable PROVIDER_DEPENDENCIES is declared using global, but is used in other branches of this function — this may be unintuitive
+ <a href='https://github.com/apache/airflow/blob/2c677a49eccb35d61bc0cf00605ada833de103a2/dev/breeze/src/airflow_breeze/utils/publish_docs_to_s3.py#L326'>dev/breeze/src/airflow_breeze/utils/publish_docs_to_s3.py:326:17:</a> RUF066 The variable version_error is declared using global, but is used in other branches of this function — this may be unintuitive
+ <a href='https://github.com/apache/airflow/blob/2c677a49eccb35d61bc0cf00605ada833de103a2/scripts/ci/pre_commit/check_providers_subpackages_all_have_init.py#L72'>scripts/ci/pre_commit/check_providers_subpackages_all_have_init.py:72:13:</a> RUF066 The variable fail_pre_commit is declared using global, but is used in other branches of this function — this may be unintuitive
+ <a href='https://github.com/apache/airflow/blob/2c677a49eccb35d61bc0cf00605ada833de103a2/scripts/ci/pre_commit/check_providers_subpackages_all_have_init.py#L73'>scripts/ci/pre_commit/check_providers_subpackages_all_have_init.py:73:13:</a> RUF066 The variable fatal_error is declared using global, but is used in other branches of this function — this may be unintuitive
</pre>

</p>
</details>
<details><summary><a href="https://github.com/bokeh/bokeh">bokeh/bokeh</a> (+3 -0 violations, +0 -0 fixes)</summary>
<p>
<pre>ruff check --no-cache --exit-zero --ignore RUF9 --no-fix --output-format concise --preview --select ALL</pre>
</p>
<p>

<pre>
+ <a href='https://github.com/bokeh/bokeh/blob/829b2a75c402d0d0abd7e37ff201fbdfd949d857/examples/server/app/spectrogram/audio.py#L59'>examples/server/app/spectrogram/audio.py:59:13:</a> RUF066 The variable _f_carrier is declared using global, but is used in other branches of this function — this may be unintuitive
+ <a href='https://github.com/bokeh/bokeh/blob/829b2a75c402d0d0abd7e37ff201fbdfd949d857/examples/server/app/spectrogram/audio.py#L60'>examples/server/app/spectrogram/audio.py:60:13:</a> RUF066 The variable _f_mod is declared using global, but is used in other branches of this function — this may be unintuitive
+ <a href='https://github.com/bokeh/bokeh/blob/829b2a75c402d0d0abd7e37ff201fbdfd949d857/examples/server/app/spectrogram/audio.py#L61'>examples/server/app/spectrogram/audio.py:61:13:</a> RUF066 The variable _ind_mod is declared using global, but is used in other branches of this function — this may be unintuitive
</pre>

</p>
</details>
<details><summary><a href="https://github.com/langchain-ai/langchain">langchain-ai/langchain</a> (+2 -0 violations, +0 -0 fixes)</summary>
<p>
<pre>ruff check --no-cache --exit-zero --ignore RUF9 --no-fix --output-format concise --preview</pre>
</p>
<p>

<pre>
+ <a href='https://github.com/langchain-ai/langchain/blob/efdfa00d1094fa63308e9455b37a200ed3a3d025/libs/core/tests/unit_tests/runnables/test_runnable_events_v2.py#L2444'>libs/core/tests/unit_tests/runnables/test_runnable_events_v2.py:2444:13:</a> RUF066 The variable outer_cancelled is declared using nonlocal, but is used in other branches of this function — this may be unintuitive
+ <a href='https://github.com/langchain-ai/langchain/blob/efdfa00d1094fa63308e9455b37a200ed3a3d025/libs/core/tests/unit_tests/runnables/test_runnable_events_v2.py#L2509'>libs/core/tests/unit_tests/runnables/test_runnable_events_v2.py:2509:13:</a> RUF066 The variable outer_cancelled is declared using nonlocal, but is used in other branches of this function — this may be unintuitive
</pre>

</p>
</details>
<details><summary><a href="https://github.com/latchbio/latch">latchbio/latch</a> (+1 -0 violations, +0 -0 fixes)</summary>
<p>
<pre>ruff check --no-cache --exit-zero --ignore RUF9 --no-fix --output-format concise --preview</pre>
</p>
<p>

<pre>
+ <a href='https://github.com/latchbio/latch/blob/affe3b6d128d108210465445ee59fd90af7b6da7/src/latch/ldata/path.py#L333'>src/latch/ldata/path.py:333:13:</a> RUF066 The variable _download_idx is declared using global, but is used in other branches of this function — this may be unintuitive
</pre>

</p>
</details>
<details><summary><a href="https://github.com/milvus-io/pymilvus">milvus-io/pymilvus</a> (+1 -0 violations, +0 -0 fixes)</summary>
<p>
<pre>ruff check --no-cache --exit-zero --ignore RUF9 --no-fix --output-format concise --preview</pre>
</p>
<p>

<pre>
+ <a href='https://github.com/milvus-io/pymilvus/blob/45080c39c59b5dbc8a5766d8afb9c08bba8d3896/_version_helper.py#L93'>_version_helper.py:93:9:</a> RUF066 The variable version is declared using global, but is used in other branches of this function — this may be unintuitive
</pre>

</p>
</details>
<details><summary><a href="https://github.com/reflex-dev/reflex">reflex-dev/reflex</a> (+1 -0 violations, +0 -0 fixes)</summary>
<p>
<pre>ruff check --no-cache --exit-zero --ignore RUF9 --no-fix --output-format concise --preview</pre>
</p>
<p>

<pre>
+ <a href='https://github.com/reflex-dev/reflex/blob/9d9ff9ec27f9bfff54e7dae0677997229704573f/reflex/utils/exec.py#L191'>reflex/utils/exec.py:191:13:</a> RUF066 The variable frontend_process is declared using global, but is used in other branches of this function — this may be unintuitive
</pre>

</p>
</details>
<details><summary><a href="https://github.com/python-trio/trio">python-trio/trio</a> (+1 -0 violations, +0 -0 fixes)</summary>
<p>
<pre>ruff check --no-cache --exit-zero --ignore RUF9 --no-fix --output-format concise --preview</pre>
</p>
<p>

<pre>
+ <a href='https://github.com/python-trio/trio/blob/e590d39ffa04f751bf10e5b35864686cb7cd6bbb/src/trio/_core/_tests/test_asyncgen.py#L216'>src/trio/_core/_tests/test_asyncgen.py:216:17:</a> RUF066 The variable needs_retry is declared using nonlocal, but is used in other branches of this function — this may be unintuitive
</pre>

</p>
</details>
<details><summary><a href="https://github.com/astropy/astropy">astropy/astropy</a> (+2 -0 violations, +0 -0 fixes)</summary>
<p>
<pre>ruff check --no-cache --exit-zero --ignore RUF9 --no-fix --output-format concise --preview</pre>
</p>
<p>

<pre>
+ <a href='https://github.com/astropy/astropy/blob/6a368438f29ea9b7996022168eaf9e3a675fb668/astropy/io/fits/util.py#L513'>astropy/io/fits/util.py:513:17:</a> RUF066 The variable CHUNKED_FROMFILE is declared using global, but is used in other branches of this function — this may be unintuitive
+ <a href='https://github.com/astropy/astropy/blob/6a368438f29ea9b7996022168eaf9e3a675fb668/astropy/io/fits/util.py#L515'>astropy/io/fits/util.py:515:17:</a> RUF066 The variable CHUNKED_FROMFILE is declared using global, but is used in other branches of this function — this may be unintuitive
</pre>

</p>
</details>
<details><summary>Changes by rule (1 rules affected)</summary>
<p>

<p>| code | total | + violation | - violation | + fix | - fix |
| ---- | ------- | --------- | -------- | ----- | ---- |
| RUF066 | 15 | 15 | 0 | 0 | 0 |</p>
</p>
</details>

</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ya7on">@ya7on</a> reviewed on 2025-07-27 09:58</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ya7on">@ya7on</a> on <code>crates/ruff_linter/src/codes.rs</code>:1055 on 2025-07-27 09:58</div>
            <div class="timeline-body"><p>Thank you so much for reviewing my PR!<br />
This is my first contribution to this repository, so I wasn’t familiar with the rules for choosing a code number.<br />
I’ll update the rule to use RUF066.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dylwil3">@dylwil3</a> on 2025-07-29 12:16</div>
            <div class="timeline-body"><p>Thanks @ya7on ! Have you gotten a chance to look through the ecosystem results? It seems like there are cases where we have a violation even when the assignment is in the same branch (unless I'm missing something). Let me know if the ecosystem results look okay to you and I can take another look.</p>
<p>Also, work on the control flow graph got paused at some point so it's very possible there are some bugs - let me know if you run into trouble or if something doesn't seem to be working right!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ya7on">@ya7on</a> on 2025-07-29 12:38</div>
            <div class="timeline-body"><p>Thanks for the review!</p>
<p>I only tested the rule against the unit tests so far, didn't realize I should also check the ecosystem results. I'll run that and see what comes up. If I find issues, I'll fix them — and if it looks like a CFG bug, I'll come back with questions.</p>
<p>Appreciate you pointing this out!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dylwil3">@dylwil3</a> on 2025-07-29 13:35</div>
            <div class="timeline-body"><p>Thanks! One thing, just in case it wasn't clear:</p>
<blockquote>
<p>I should also check the ecosystem results. I'll run that and see what comes up.</p>
</blockquote>
<p>You don't have to run the ecosystem check yourself - you can click through the results in this comment https://github.com/astral-sh/ruff/pull/19569#issuecomment-3122475062</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ya7on">@ya7on</a> on 2025-07-29 13:45</div>
            <div class="timeline-body"><blockquote>
<p>you can click through the results in this comment https://github.com/astral-sh/ruff/pull/19569#issuecomment-3122475062</p>
</blockquote>
<p>Oh, i see. Thank you! I'll check those results.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ya7on">@ya7on</a> on 2025-07-31 16:32</div>
            <div class="timeline-body"><p>It looks like there is indeed a bug in the control-flow graph. I tried running <code>build_cfg</code> on a more nested function like this</p>
<pre><code class="language-py">def test_func():
    a = True
    b = True
    if a:
        global GLOBAL_NAME
        GLOBAL_NAME = 1
        if b:
            return
</code></pre>
<p>The generated CFG contains only 2 blocks</p>
<p>Block 0 includes:</p>
<pre><code class="language-py">a = True
b = True
if a:
</code></pre>
<p>But block 1 is completely empty. It doesnt include the <code>global</code> statement, the assignment and the inner <code>return</code>.</p>
<p>What would you recommend i do in this case?
I can switch to an AST-only approach for this rule instead of relying on CFG. The algorithm would work by walking through each branch (<code>if</code>, <code>while</code>, <code>for</code>, <code>try</code>) and checking whether a declaration and an assignment appear in different branches.</p>
<p>UPD: after a little debugging i find out following. <code>build_cfg</code> currently does not create separate blocks for statements inside <code>if</code> bodies.
Event control-altering statements like <code>return</code> or nested <code>if</code> are embedded inside a parent <code>StmtIf</code>, and not surfaced into the graph</p>
<pre><code>ControlFlowGraph {
    blocks: [
        Block 0:
            stmts: [
                Assign a = True
                Assign b = True
                If a: [nested body with all other function code]
            ]
            outgoing: [BlockId(1)]
        Block 1:
            stmts: [] // Empty
    ]
}
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dylwil3">@dylwil3</a> on 2025-08-01 21:11</div>
            <div class="timeline-body"><p>Sorry this is my bad - I did not quite remember how much of the CFG work had been merged in. It looks like we never actually merged in the work on if and match statements https://github.com/astral-sh/ruff/pull/17268 (so not much functionality is available then...)</p>
<p>I don't have an immediate answer for when work is planned to continue on that. It's up to you whether you'd like to wait a bit, or whether you'd like to try using the available methods on the <code>SemanticModel</code> for handling branches. Happy to review either way!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-08-18 07:42</div>
            <div class="timeline-body"><p>@ya7on can you help me understand what the status of this PR is? Are you planning additional work or are you waiting on input a review from us?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ya7on">@ya7on</a> on 2025-08-18 08:58</div>
            <div class="timeline-body"><p>@MichaReiser Hi! I am currently not working on this PR as i am waiting for updates or fixes to the CFG. I am happy to return to this once that work is unblocked, but in the meantime i think it makes sense to close this PR for now. Thanks again for the review!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dylwil3">@dylwil3</a> on 2025-08-18 12:25</div>
            <div class="timeline-body"><p>Apologies again @ya7on - I do hope to return to the CFG work at some point!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @dylwil3 on 2025-08-18 12:25</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 17:52:43 UTC
    </footer>
</body>
</html>
