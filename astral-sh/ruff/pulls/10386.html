<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Remove `Expr::Invalid` - astral-sh/ruff #10386</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Remove <code>Expr::Invalid</code></h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/10386">#10386</a>
        opened by <a href="https://github.com/dhruvmanila">@dhruvmanila</a>
        on 2024-03-13 14:57
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a></div>
            <div class="timeline-body">Summary
<p>This PR removes the <code>Expr::Invalid</code> variant from the AST. Instead, we&#x27;ll try to retain as much valid information as possible and use an empty <code>Expr::Name</code> with <code>ExprContext::Invalid</code> as a replacement.</p>
Test Plan
<ul>
<li>[x] All tests pass</li>
<li>[x] No performance regression</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">parser</span> added by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-03-13 14:57</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_python_parser/src/parser/tests/parser.rs</code>:874 on 2024-03-14 03:18</div>
            <div class="timeline-body"><p>This is actually an invalid syntax for which we now raise an error.</p>
<pre><code>$ python3.13 -m ast parser/_.py
Traceback (most recent call last):
  File &quot;parser/_.py&quot;, line 2
    case 1 + 1:
             ^
SyntaxError: imaginary number required in complex literal
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2024-03-14 03:18</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_python_parser/src/parser/statement.rs</code>:1173 on 2024-03-14 03:23</div>
            <div class="timeline-body"><p>The rules are same. I&#x27;ve referenced the CPython parser.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2024-03-14 03:23</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2024-03-14 03:24</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_python_parser/src/parser/pattern.rs</code>:136 on 2024-03-14 03:24</div>
            <div class="timeline-body"><p>If the current token is either a <code>+</code> or <code>-</code>, then the LHS can only be either a number or unary op with a number as stated in the grammar.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2024-03-14 03:25</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_python_parser/src/parser/pattern.rs</code>:166 on 2024-03-14 03:25</div>
            <div class="timeline-body"><p>In a pattern <code>+</code> / <code>-</code> is always used for complex numbers. There can&#x27;t be binary operations in a pattern.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-03-14 03:32</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/MichaReiser">@MichaReiser</a> by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-03-14 03:32</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2024-03-14 03:56</div>
            <div class="timeline-body">

<code>ruff-ecosystem</code> results
Linter (stable)
<p>✅ ecosystem check detected no linter changes.</p>
Linter (preview)
<p>✅ ecosystem check detected no linter changes.</p>
Formatter (stable)
<p>✅ ecosystem check detected no format changes.</p>
Formatter (preview)
<p>✅ ecosystem check detected no format changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-03-14 04:05</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-03-14 04:05</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-03-14 04:05</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_parser/src/parser/pattern.rs</code>:155 on 2024-03-18 13:24</div>
            <div class="timeline-body"><p>What happens with the parsed out <code>lhs</code> in this case? Do we just drop it?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-03-18 13:24</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_parser/src/parser/pattern.rs</code>:186 on 2024-03-18 13:24</div>
            <div class="timeline-body"><p>Same as for <code>lhs</code>. Do we drop the parsed <code>rhs_pattern</code> in case it is invalid?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-03-18 13:24</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_parser/src/parser/pattern.rs</code>:256 on 2024-03-18 13:27</div>
            <div class="timeline-body"><p>We shouldn&#x27;t use <code>ExprName</code> to represent any invalid expression. The idea of <code>ExprName</code> with <code>ctx</code> <code>Invalid</code> is to only be used in situations where the parser must return an expression but the parser isn&#x27;t positioned at an expression. This is different here. We did parse a pattern and we shouldn just convert this pattern to be a name. Doing so can lead to problems downstream, e.g. the formatter would replace the pattern (even when invalid) in the source with an empty name, deleting code!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-03-18 13:27</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_parser/src/parser/pattern.rs</code>:653 on 2024-03-18 13:28</div>
            <div class="timeline-body"><p>Same as above. I don&#x27;t think that converting any pattern to a name is the right thing to do here.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_parser/src/parser/pattern.rs</code>:667 on 2024-03-18 13:28</div>
            <div class="timeline-body"><p>Same, I don&#x27;t think we should convert arbitrary expressions or patterns to <code>ExprName</code> with the <code>ctx</code> <code>Invalid</code>. That can lead to issues downstream</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_parser/src/parser/statement.rs</code>:546 on 2024-03-18 13:29</div>
            <div class="timeline-body"><p>Creating an empty <code>name</code> with context <code>Invalid</code> is valid here but we shouldn&#x27;t consume the token in that case.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-03-18 13:31</div>
            <div class="timeline-body"><p>I think we need to revisit the cases where we use <code>Expr::Name</code> with <code>ctx</code> <code>Invalid</code>. We shouldn&#x27;t use it to represent arbitrary expressions or patterns. We should only use it to represent tokens that could be names (keywords) or in situations where the parser must return an expression but it isn&#x27;t positioned at an expression (in which case we create an empty name).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2024-03-18 13:54</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_python_parser/src/parser/pattern.rs</code>:256 on 2024-03-18 13:54</div>
            <div class="timeline-body"><p>I see. Thanks for pointing it out. Would this mean that the parser should create an expression node which matches the pattern and use that instead? For example, <code>Pattern::Singleton</code> can be converted to <code>Expr::BooleanLiteral</code> / <code>Expr::NoneLiteral</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-03-18 13:58</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_parser/src/parser/pattern.rs</code>:256 on 2024-03-18 13:58</div>
            <div class="timeline-body"><p>I think that would be preferable. I would need to look into the specific recovery case here (a few tests would help) to fully understand how the parser should recover.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2024-03-18 14:08</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_python_parser/src/parser/pattern.rs</code>:256 on 2024-03-18 14:08</div>
            <div class="timeline-body"><p>Yes, my plan for the week is to focus on testing and fixing / updating the logic as required. I&#x27;ll do the match statement first then to get this fixed.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:02:15 UTC
    </footer>
</body>
</html>
