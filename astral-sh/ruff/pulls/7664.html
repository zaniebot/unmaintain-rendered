<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add `cell` field to JSON output format - astral-sh/ruff #7664</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Add <code>cell</code> field to JSON output format</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/7664">#7664</a>
        opened by <a href="https://github.com/dhruvmanila">@dhruvmanila</a>
        on 2023-09-26 06:25
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a></div>
            <div class="timeline-body">Summary
<p>This PR adds a new <code>cell</code> field to the JSON output format which indicates the Notebook cell this diagnostic (and fix) belongs to. It also updates the location for the diagnostic and fixes as per the <code>NotebookIndex</code>. It will be used in the VSCode extension to display the diagnostic in the correct cell.</p>
<p>The diagnostic and edit start and end source locations are translated for the notebook as per the <code>NotebookIndex</code>. The end source location for an edit needs some special handling.</p>
Edit end location
<p>To understand this, the following context is required:</p>
<ol>
<li>Visible lines in Jupyter Notebook vs JSON array strings: The newline is part of the string in the JSON format. This means that if there are 3 visible lines in a cell where the last line is empty then the JSON would contain 2 strings in the source array, both ending with a newline:</li>
</ol>
<p><strong>JSON format:</strong></p>
<pre><code>[
	&quot;# first line\n&quot;,
	&quot;# second line\n&quot;,
]
</code></pre>
<p><strong>Notebook view:</strong></p>
<pre><code>1 # first line
2 # second line
3
</code></pre>
<ol>
<li>If an edit needs to remove an entire line including the newline, then the end location would be the start of the next row.</li>
</ol>
<p>To remove a statement in the following code:</p>
<pre><code>import os
</code></pre>
<p>The edit would be:</p>
<pre><code>start: row 1, col 1
end: row 2, col 1
</code></pre>
<p>Now, here&#x27;s where the problem lies. The notebook index doesn&#x27;t have any information for row 2 because it doesn&#x27;t exists in the actual notebook. The newline was added by Ruff to concatenate the source code and it&#x27;s removed before writing back. But, the edit is computed looking at that newline.</p>
<p>This means that while translating the end location for an edit belong to a Notebook, we need to check if both the start and end location belongs to the same cell. If not, then the end location should be the first character of the next row and if so, translate that back to the last character of the previous row. Taking the above example, the translated location for Notebook would be:</p>
<pre><code>start: row 1, col 1
end: row 1, col 10
</code></pre>
Test Plan
<p>Add test cases for notebook output in the JSON format and update existing snapshots.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2023-09-26 06:25</div>
            <div class="timeline-body"><p>Current dependencies on/for this PR:</p>
<ul>
<li>main<ul>
<li><strong>PR #7921</strong> <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7921"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite"></a><ul>
<li><strong>PR #7925</strong> <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7925"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite"></a><ul>
<li><strong>PR #7664</strong> <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7664"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite"></a>  üëà</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>This comment was auto-generated by <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7664?utm_source=stack-comment">Graphite</a>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/codspeed-hq[bot]">@codspeed-hq[bot]</a> on 2023-09-26 06:40</div>
            <div class="timeline-body"><a href="https://codspeed.io/astral-sh/ruff/branches/dhruv/cell-idx-json-output">CodSpeed Performance Report</a>
Merging #7664 will <strong>not alter performance</strong>
<p>Comparing <code>dhruv/cell-idx-json-output</code> (7aca63a) with <code>main</code> (1e184e6)</p>
Summary
<p><code>‚úÖ 25</code> untouched benchmarks</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">linter</span> added by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2023-10-12 04:16</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2023-10-12 04:17</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/charliermarsh">@charliermarsh</a> by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2023-10-12 04:17</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/konstin">@konstin</a> by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2023-10-12 04:17</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2023-10-12 04:32</div>
            <div class="timeline-body">PR Check Results
Ecosystem
<p>‚ÑπÔ∏è ecosystem check <strong>detected changes</strong>. (+6, -6, 0 error(s))</p>
airflow (+4, -4)
<p>

<pre>
- [*] 16066 fixable with the `--fix` option (6343 hidden fixes can be enabled with the `--unsafe-fixes` option).
+ [*] 16069 fixable with the `--fix` option (6343 hidden fixes can be enabled with the `--unsafe-fixes` option).
- <a href="https://github.com/apache/airflow/blob/1f63199351efe9a240c5ae07ce31b79fb0353d64/airflow/providers/google/cloud/hooks/bigquery.py#L1580">airflow/providers/google/cloud/hooks/bigquery.py:1580:35:</a> PYI055 Multiple `type` members in a union. Combine them into one, e.g., `type[CopyJob | QueryJob | LoadJob | ExtractJob]`.
+ <a href="https://github.com/apache/airflow/blob/1f63199351efe9a240c5ae07ce31b79fb0353d64/airflow/providers/google/cloud/hooks/bigquery.py#L1580">airflow/providers/google/cloud/hooks/bigquery.py:1580:35:</a> PYI055 [*] Multiple `type` members in a union. Combine them into one, e.g., `type[CopyJob | QueryJob | LoadJob | ExtractJob]`.
- <a href="https://github.com/apache/airflow/blob/1f63199351efe9a240c5ae07ce31b79fb0353d64/airflow/providers/google/cloud/hooks/bigquery.py#L1587">airflow/providers/google/cloud/hooks/bigquery.py:1587:14:</a> PYI055 Multiple `type` members in a union. Combine them into one, e.g., `type[CopyJob | QueryJob | LoadJob | ExtractJob]`.
+ <a href="https://github.com/apache/airflow/blob/1f63199351efe9a240c5ae07ce31b79fb0353d64/airflow/providers/google/cloud/hooks/bigquery.py#L1587">airflow/providers/google/cloud/hooks/bigquery.py:1587:14:</a> PYI055 [*] Multiple `type` members in a union. Combine them into one, e.g., `type[CopyJob | QueryJob | LoadJob | ExtractJob]`.
- <a href="https://github.com/apache/airflow/blob/1f63199351efe9a240c5ae07ce31b79fb0353d64/airflow/providers/smtp/hooks/smtp.py#L103">airflow/providers/smtp/hooks/smtp.py:103:15:</a> PYI055 Multiple `type` members in a union. Combine them into one, e.g., `type[smtplib.SMTP_SSL | smtplib.SMTP]`.
+ <a href="https://github.com/apache/airflow/blob/1f63199351efe9a240c5ae07ce31b79fb0353d64/airflow/providers/smtp/hooks/smtp.py#L103">airflow/providers/smtp/hooks/smtp.py:103:15:</a> PYI055 [*] Multiple `type` members in a union. Combine them into one, e.g., `type[smtplib.SMTP_SSL | smtplib.SMTP]`.
</pre>

</p>

bokeh (+2, -2)
<p>

<pre>
- [*] 17800 fixable with the `--fix` option (4727 hidden fixes can be enabled with the `--unsafe-fixes` option).
+ [*] 17801 fixable with the `--fix` option (4727 hidden fixes can be enabled with the `--unsafe-fixes` option).
- <a href="https://github.com/bokeh/bokeh/blob/8fa062ac8938a6c064caa2dd50be7013f04fa2f7/src/bokeh/core/validation/decorators.py#L67">src/bokeh/core/validation/decorators.py:67:13:</a> PYI055 Multiple `type` members in a union. Combine them into one, e.g., `type[Error | Warning]`.
+ <a href="https://github.com/bokeh/bokeh/blob/8fa062ac8938a6c064caa2dd50be7013f04fa2f7/src/bokeh/core/validation/decorators.py#L67">src/bokeh/core/validation/decorators.py:67:13:</a> PYI055 [*] Multiple `type` members in a union. Combine them into one, e.g., `type[Error | Warning]`.
</pre>

</p>

Rules changed: 1

<p>| Rule | Changes | Additions | Removals |
| ---- | ------- | --------- | -------- |
| PYI055 | 8 | 4 | 4 |</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff_notebook/src/index.rs</code>:40 on 2023-10-12 09:29</div>
            <div class="timeline-body"><pre><code>    pub fn translate_location(&amp;self, source_location: &amp;SourceLocation) -&gt; SourceLocation {
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> approved on 2023-10-12 09:29</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2023-10-13 01:06</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2023-10-13 01:06</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2023-10-13 01:06</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 18:57:46 UTC
    </footer>
</body>
</html>
