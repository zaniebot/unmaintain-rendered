<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[red-knot] Flatten `Type::Callable` into four `Type` variants - astral-sh/ruff #17126</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[red-knot] Flatten <code>Type::Callable</code> into four <code>Type</code> variants</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/17126">#17126</a>
        opened by <a href="https://github.com/AlexWaygood">@AlexWaygood</a>
        on 2025-04-01 17:08
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-04-01 17:08</div>
            <div class="timeline-body"><h2>Summary</h2>
<p>Currently our <code>Type::Callable</code> wraps a four-variant <code>CallableType</code> enum. But as time has gone on, I think we've found that the four variants in <code>CallableType</code> are really more different to each other than they are similar to each other:</p>
<ul>
<li><code>GeneralCallableType</code> is a structural type describing all callable types with a certain signature, but the other three types are &quot;literal types&quot;, more similar to the <code>FunctionLiteral</code> variant</li>
<li><code>GeneralCallableType</code> is not a singleton or a single-valued type, but the other three are all single-valued types (<code>WrapperDescriptorDunderGet</code> is even a singleton type)</li>
<li><code>GeneralCallableType</code> has (or should have) ambiguous truthiness, but all possible inhabitants of the other three types are always truthy.</li>
<li>As a structural type, <code>GeneralCallableType</code> can contain inner unions and intersections that must be sorted in some contexts in our internal model, but this is not true for the other three variants.</li>
</ul>
<p>This PR flattens <code>Type::Callable</code> into four distinct <code>Type::</code> variants. In the process, it fixes a number of latent bugs that were concealed by the current architecture but are laid bare by the refactor. Unit tests for these bugs are included in the PR.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by @AlexWaygood on 2025-04-01 17:08</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @dhruvmanila by @AlexWaygood on 2025-04-01 17:08</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @AlexWaygood on 2025-04-01 17:08</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @sharkdp by @AlexWaygood on 2025-04-01 17:08</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @dcreager by @AlexWaygood on 2025-04-01 17:08</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-04-01 17:10</div>
            <div class="timeline-body"><!-- generated-comment mypy_primer -->

<h2><code>mypy_primer</code> results</h2>
<p>No ecosystem changes detected âœ…</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-04-01 17:19</div>
            <div class="timeline-body"><p>Some other notes:</p>
<ul>
<li>This structure more accurately reflects the fact that lots of the <code>Type</code> variants have possible inhabitants that would also inhabit <code>Callable</code> (instances can be callable, class objects are nearly always callable, same for <code>type[]</code> types) -- the distinction implied by the current structure that there are &quot;4 callable types&quot; and all other variants do therefore not represent &quot;callable types&quot; is incorrect</li>
<li>This doesn't fix https://github.com/astral-sh/ruff/issues/17058, but it should make it easier to fix that issue (at least how I'm currently thinking of fixing it!)</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:267 on 2025-04-01 18:11</div>
            <div class="timeline-body"><pre><code class="language-suggestion">    /// The type of an arbitrary callable object with a certain specified signature.
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> approved on 2025-04-01 18:14</div>
            <div class="timeline-body"><p>Nice, yeah I think this structure is less error-prone: avoids grouping very different types together in a way that makes it too easy to wrongly handle them all identically.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @AlexWaygood on 2025-04-01 18:30</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @AlexWaygood on 2025-04-01 18:30</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-04-01 18:30</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2025-04-01 19:39</div>
            <div class="timeline-body"><p>Thanks Alex for doing this! I still want to take a stab at merging the types to reduce the number of variants but that's something for later.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-04-01 21:03</div>
            <div class="timeline-body"><blockquote>
<p>I still want to take a stab at merging the types to reduce the number of variants but that's something for later.</p>
</blockquote>
<p>It would be great if we could postpone this until after https://github.com/astral-sh/ruff/pull/17017 has been merged; that PR makes major changes to two of these callable types, and rebasing on top of this branch here was a significant amount of work already. But in general, that sounds like a good idea :+1:</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 19:41:05 UTC
    </footer>
</body>
</html>
