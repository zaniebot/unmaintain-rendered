<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add most formatter options to `ruff.toml` / `pyproject.toml` - astral-sh/ruff #7566</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Add most formatter options to <code>ruff.toml</code> / <code>pyproject.toml</code></h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/7566">#7566</a>
        opened by <a href="https://github.com/MichaReiser">@MichaReiser</a>
        on 2023-09-21 09:50
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a></div>
            <div class="timeline-body">Summary
<p>This PR adds most formatter configuration options under a new <code>[format]</code> section.</p>
<p><strong>Missing options</strong></p>
<ul>
<li>Tab size</li>
<li>Respecting <code>exclude</code></li>
</ul>
<p>Closes <a href="https://github.com/astral-sh/ruff/issues/7061">astral-sh/ruff#7061</a>
Closes <a href="https://github.com/astral-sh/ruff/issues/7570">#7570</a></p>
Open Questions
<ul>
<li>Should we add <code>line-ending</code> as a global configuration option similar to <code>line-width</code> and <code>tab-size</code> to that <code>Styleist</code> could use it to. My main hesitation is that the formatter should default to <code>LineEnding::Lf</code>, but <code>Styleist</code> uses <code>LineEnding::Auto</code> (which makes sense for a linter).</li>
<li>Naming of <code>LineEnding</code> options: Are people familiar with <code>Lf</code> and <code>CrLf</code> or should we use <code>Unix</code> and <code>Windows</code></li>
</ul>
Test Plan
<ul>
<li>I added a few integration tests.</li>
<li>Unfortunately, it seems <code>insta-cmd</code> normalizes line endings in snapshots (makes sense). So I used a hex viewer to verify that <code>cr-lf</code> results in <code>\r\n</code> line endings</li>
<li>I played around with the settings in the <code>Playground</code></li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-09-21 09:50</div>
            <div class="timeline-body"><p>Current dependencies on/for this PR:</p>
<ul>
<li>main<ul>
<li><strong>PR #7566</strong> <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7566"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite"></a>  üëà<ul>
<li><strong>PR #7591</strong> <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7591"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite"></a><ul>
<li><strong>PR #7593</strong> <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7593"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite"></a><ul>
<li><strong>PR #7549</strong> <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7549"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite"></a><ul>
<li><strong>PR #7599</strong> <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7599"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite"></a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>This comment was auto-generated by <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7566?utm_source=stack-comment">Graphite</a>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-09-21 09:57</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/settings.rs</code>:1 on 2023-09-21 09:57</div>
            <div class="timeline-body"><p>I had to move the file because <code>FiltePatternSet</code> and <code>FilePattern</code> is defined in <code>ruff_linter</code>. We may want to introduce a new crate for these types eventually but moving the struct to <code>ruff_workspace</code> is sufficient for now because the formatter doesn&#x27;t use it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/codspeed-hq[bot]">@codspeed-hq[bot]</a> on 2023-09-21 09:58</div>
            <div class="timeline-body"><a href="https://codspeed.io/astral-sh/ruff/branches/format-options">CodSpeed Performance Report</a>
Merging #7566 will <strong>degrade performances by 3.15%</strong>
<p>Comparing <code>format-options</code> (7a13d26) with <code>main</code> (82978ac)</p>
Summary
<p><code>‚ùå 1</code> regressions
<code>‚úÖ 24</code> untouched benchmarks</p>
<blockquote>
<p>:warning: <em>Please fix the performance issues or <a href="https://codspeed.io/astral-sh/ruff/branches/format-options">acknowledge them on CodSpeed</a>.</em></p>
</blockquote>
Benchmarks breakdown
<p>|     | Benchmark | <code>main</code> | <code>format-options</code> | Change |
| --- | --------- | ----------------------- | ------------------- | ------ |
| ‚ùå | <code>linter/default-rules[large/dataset.py]</code> | 91.1 ms | 94.1 ms | -3.15% |</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_workspace/src/options.rs</code>:2394 on 2023-09-21 09:59</div>
            <div class="timeline-body"><p>Using <code>untagged</code> allows us to support both the old <code>SerializationFormat</code> and <code>Format</code> group. The only downside is that serde&#x27;s error messages aren&#x27;t any useful because it only tells you that what you have is neither of the two.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-09-21 09:59</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">configuration</span> added by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-09-21 10:18</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">formatter</span> added by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-09-21 10:18</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-09-21 10:26</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2023-09-21 10:59</div>
            <div class="timeline-body">PR Check Results
Ecosystem
<p>‚úÖ ecosystem check detected no changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/charliermarsh">@charliermarsh</a> by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-09-21 11:35</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-09-21 13:26</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_workspace/src/options.rs</code>:2452 on 2023-09-21 13:26</div>
            <div class="timeline-body"><p>These end up appearing under a <code>[tool.ruff]</code>, so I think these should be <code>[tool.ruff.format]</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-09-21 13:26</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_workspace/src/options.rs</code>:2452 on 2023-09-21 13:26</div>
            <div class="timeline-body"><p>These end up appearing under a <code>[tool.ruff]</code>, so I think these should be <code>[tool.ruff.format]</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-09-21 13:26</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_workspace/src/options.rs</code>:2444 on 2023-09-21 13:26</div>
            <div class="timeline-body"><p>Is this intentionally commented? (I see the TODO but not sure if it&#x27;s related to this or something else.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_workspace/src/options.rs</code>:2466 on 2023-09-21 13:27</div>
            <div class="timeline-body"><p>Perhaps we can expand on &quot;left separate&quot;, and even include a small example?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-09-21 13:27</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> approved on 2023-09-21 13:27</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2023-09-21 14:50</div>
            <div class="timeline-body"><p>What about the following semantics for a global <code>line-ending</code>?</p>
<ul>
<li><p>line-ending = &quot;auto&quot;</p>
<ul>
<li>i&#x27;m using only the linter: line endings are determined from what the file already uses</li>
<li>i&#x27;m also using the formatter: line endings are changed to LF everywhere</li>
</ul>
</li>
<li><p>line-ending = &quot;native&quot;/&quot;lf&quot;/&quot;cr-lf&quot;</p>
<ul>
<li>i&#x27;m using only the linter: line endings are set to native/lf/cr-lf</li>
<li>i&#x27;m also using the formatter: line endings are changed to native/lf/cr-lf everywhere</li>
</ul>
</li>
</ul>
<p>By default, if a user only uses the linter, they get the usual conservative linter behaviour that tries to match what is already there, and won&#x27;t notice the more aggresive formatter behaviour. If they use the formatter they get maximized consistency, since the formatter runs after the linter, user don&#x27;t need to care about the preservation attempt in the linter. If a user has specific wishes, they can specify. Depending on their git and editor configuration, they also have the native option to keep the platform behaviour.</p>
<p>The <code>formatter</code> section documentation will link all global options that impact formatting style.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-09-21 15:10</div>
            <div class="timeline-body"><blockquote>
<p>What about the following semantics for a global <code>line-ending</code>?</p>
<pre><code>* line-ending = &quot;auto&quot;
  
  * i&#x27;m using only the linter: line endings are determined from what the file already uses
  * i&#x27;m also using the formatter: line endings are changed to LF everywhere

* line-ending = &quot;native&quot;/&quot;lf&quot;/&quot;cr-lf&quot;
  
  * i&#x27;m using only the linter: line endings are set to native/lf/cr-lf
  * i&#x27;m also using the formatter: line endings are changed to native/lf/cr-lf everywhere</code></pre>
<p>By default, if a user only uses the linter, they get the usual conservative linter behaviour that tries to match what is already there, and won&#x27;t notice the more aggresive formatter behaviour. If they use the formatter they get maximized consistency, since the formatter runs after the linter, user don&#x27;t need to care about the preservation attempt in the linter. If a user has specific wishes, they can specify. Depending on their git and editor configuration, they also have the native option to keep the platform behaviour.</p>
<p>The <code>formatter</code> section documentation will link all global options that impact formatting style.</p>
</blockquote>
<p>The challenge is that we don&#x27;t know whether someone uses the formatter other than when they run <code>ruff format</code> or explicitly opt out of formatting using <code>format.enabled = false</code>.</p>
<p>I would also try to make settings as static as possible to avoid confusion. E.g. what happens if formatting is only used in some directories? Does <code>Auto</code> then have the same semantics for all files or depends on whether the file gets formatted?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2023-09-21 21:13</div>
            <div class="timeline-body"><blockquote>
<p>The challenge is that we don&#x27;t know whether someone uses the formatter other than when they run ruff format or explicitly opt out of formatting using format.enabled = false.</p>
<p>I would also try to make settings as static as possible to avoid confusion. E.g. what happens if formatting is only used in some directories? Does Auto then have the same semantics for all files or depends on whether the file gets formatted?</p>
</blockquote>
<p>Assuming that if we run the formatter, we run it consistently after the linter, i don&#x27;t think either of this is a problem: Files that get formatted get LF consistency, files that are not formatted have their line endings preserved by the linter. Put differently, i think the default should be the linter doesn&#x27;t change any line endings (wrt to the file it&#x27;s fixing), while the formatter changes all line endings.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_workspace/src/options.rs</code>:2502 on 2023-09-22 07:17</div>
            <div class="timeline-body"><p>Can we mention what &quot;auto&quot; and &quot;native&quot; mean in the documentation? The &quot;auto&quot; is explained in the example so we could skip that but I would add it for consistency.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2023-09-22 07:20</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/qarmin">@qarmin</a> on 2023-09-22 08:54</div>
            <div class="timeline-body"><p>Default format configuration should be added here - https://github.com/astral-sh/ruff#configuration</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-09-22 10:05</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_workspace/src/options.rs</code>:2502 on 2023-09-22 10:05</div>
            <div class="timeline-body"><p>Makes sense. It&#x27;s a bit unfortunate because we already have the documentation on <code>LineEnding</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-09-22 11:03</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_workspace/src/options.rs</code>:2452 on 2023-09-22 11:03</div>
            <div class="timeline-body"><p>I removed the section from all examples to align it with other examples.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-09-22 11:03</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_workspace/src/options.rs</code>:2444 on 2023-09-22 11:03</div>
            <div class="timeline-body"><p>I decided to remove it for now</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-09-22 11:04</div>
            <div class="timeline-body"><blockquote>
<blockquote>
<p>The challenge is that we don&#x27;t know whether someone uses the formatter other than when they run ruff format or explicitly opt out of formatting using format.enabled = false.
I would also try to make settings as static as possible to avoid confusion. E.g. what happens if formatting is only used in some directories? Does Auto then have the same semantics for all files or depends on whether the file gets formatted?</p>
</blockquote>
<p>Assuming that if we run the formatter, we run it consistently after the linter, i don&#x27;t think either of this is a problem: Files that get formatted get LF consistency, files that are not formatted have their line endings preserved by the linter. Put differently, i think the default should be the linter doesn&#x27;t change any line endings (wrt to the file it&#x27;s fixing), while the formatter changes all line endings.</p>
</blockquote>
<p>I agree with this and I think this aligns with only having <code>line-ending</code> under <code>format</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-09-22 11:20</div>
            <div class="timeline-body"><blockquote>
<p>Default format configuration should be added here - <a href="https://github.com/astral-sh/ruff#configuration">astral-sh/ruff#configuration</a></p>
</blockquote>
<p>Thanks for calling this out. I wasn&#x27;t aware that we list the defaults in the README. I&#x27;m unsure yet what we should do about this, considering that the formatter options are preview only. I&#x27;ll ask internally</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-09-22 15:08</div>
            <div class="timeline-body"><blockquote>
<p>Default format configuration should be added here - <a href="https://github.com/astral-sh/ruff#configuration">astral-sh/ruff#configuration</a></p>
</blockquote>
<p>We discussed this internally. We wait with adding the section until reaching beta / stable.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-09-22 15:47</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-09-22 15:47</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2023-09-22 15:48</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 18:57:37 UTC
    </footer>
</body>
</html>
