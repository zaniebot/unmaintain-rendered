```yaml
number: 6817
title: Use BestFits for non-fluent attribute chains
type: pull_request
state: merged
author: MichaReiser
labels:
  - formatter
assignees: []
merged: true
base: main
head: best-fits-call-expr
created_at: 2023-08-23T12:10:18Z
updated_at: 2023-08-24T12:09:27Z
url: https://github.com/astral-sh/ruff/pull/6817
synced_at: 2026-01-12T02:45:38Z
```

# Use BestFits for non-fluent attribute chains

---

_Pull request opened by @MichaReiser on 2023-08-23 12:10_

## Summary

This is the last part of #6271. It implements the overlong parenthesizing for attribute chains (and call expressions). 

The code changes are minimal. The main reason for this being its own PR is to assess the performance implication (and compatibility win)

Closes #6271

## Test Plan

**Base**


project | similarity index
-- | --
cpython | 0.76058
django | 0.99894
transformers | 0.99842
twine | 0.99929
typeshed | 0.99953
warehouse | 0.99632
zulip | 0.99909



**This PR**
| project      | similarity index |
|--------------|------------------|
| cpython      | 0.76061          |
| django       | 0.99898          |
| transformers | 0.99842          |
| twine        | 0.99929          |
| typeshed     | 0.99953          |
| warehouse    | 0.99637          |
| zulip        | 0.99920          |


<!-- How was it tested? -->


---

_Comment by @MichaReiser on 2023-08-23 12:10_

Current dependencies on/for this PR:
* main
  * **PR #6814** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/6814" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.svg" alt="Graphite" width="10px" height="10px"/></a> 
    * **PR #6815** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/6815" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.svg" alt="Graphite" width="10px" height="10px"/></a> 
      * **PR #6816** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/6816" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.svg" alt="Graphite" width="10px" height="10px"/></a> 
        * **PR #6817** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/6817" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.svg" alt="Graphite" width="10px" height="10px"/></a>  ðŸ‘ˆ
          * **PR #6848** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/6848" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.svg" alt="Graphite" width="10px" height="10px"/></a> 
          * **PR #6819** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/6819" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.svg" alt="Graphite" width="10px" height="10px"/></a> 

This comment was auto-generated by [Graphite](https://app.graphite.dev/github/pr/astral-sh/ruff/6817?utm_source=stack-comment).

---

_Comment by @github-actions[bot] on 2023-08-23 12:57_

## PR Check Results
### Benchmark
#### Linux
```
group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.00      3.6Â±0.03ms    11.3 MB/sec    1.12      4.0Â±0.02ms    10.1 MB/sec
formatter/numpy/ctypeslib.py               1.00    750.6Â±5.37Âµs    22.2 MB/sec    1.09    815.8Â±5.79Âµs    20.4 MB/sec
formatter/numpy/globals.py                 1.00     78.7Â±0.91Âµs    37.5 MB/sec    1.00     78.9Â±2.81Âµs    37.4 MB/sec
formatter/pydantic/types.py                1.00   1539.8Â±9.87Âµs    16.6 MB/sec    1.06  1627.7Â±17.14Âµs    15.7 MB/sec
linter/all-rules/large/dataset.py          1.00     10.4Â±0.04ms     3.9 MB/sec    1.01     10.5Â±0.03ms     3.9 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      2.9Â±0.01ms     5.8 MB/sec    1.00      2.9Â±0.01ms     5.8 MB/sec
linter/all-rules/numpy/globals.py          1.03    329.3Â±5.37Âµs     9.0 MB/sec    1.00    320.9Â±1.09Âµs     9.2 MB/sec
linter/all-rules/pydantic/types.py         1.00      5.4Â±0.02ms     4.7 MB/sec    1.00      5.4Â±0.02ms     4.7 MB/sec
linter/default-rules/large/dataset.py      1.01      5.5Â±0.02ms     7.4 MB/sec    1.00      5.5Â±0.01ms     7.4 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.01   1180.6Â±2.41Âµs    14.1 MB/sec    1.00   1173.3Â±3.49Âµs    14.2 MB/sec
linter/default-rules/numpy/globals.py      1.01    124.1Â±0.26Âµs    23.8 MB/sec    1.00    123.2Â±0.24Âµs    23.9 MB/sec
linter/default-rules/pydantic/types.py     1.00      2.5Â±0.01ms    10.2 MB/sec    1.00      2.5Â±0.01ms    10.2 MB/sec
```

#### Windows
```
group                                      main                                    pr
-----                                      ----                                    --
formatter/large/dataset.py                 1.00      4.7Â±0.20ms     8.6 MB/sec     1.12      5.3Â±0.18ms     7.6 MB/sec
formatter/numpy/ctypeslib.py               1.00   984.9Â±57.81Âµs    16.9 MB/sec     1.13  1112.0Â±56.50Âµs    15.0 MB/sec
formatter/numpy/globals.py                 1.00    100.0Â±5.41Âµs    29.5 MB/sec     1.03    102.7Â±6.29Âµs    28.7 MB/sec
formatter/pydantic/types.py                1.00      2.1Â±0.10ms    12.4 MB/sec     1.08      2.2Â±0.14ms    11.5 MB/sec
linter/all-rules/large/dataset.py          1.14     17.2Â±0.56ms     2.4 MB/sec     1.00     15.1Â±0.43ms     2.7 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.09      4.6Â±0.24ms     3.6 MB/sec     1.00      4.2Â±0.17ms     4.0 MB/sec
linter/all-rules/numpy/globals.py          1.00   524.5Â±26.30Âµs     5.6 MB/sec     1.03   539.6Â±27.55Âµs     5.5 MB/sec
linter/all-rules/pydantic/types.py         1.10      8.8Â±0.60ms     2.9 MB/sec     1.00      8.0Â±0.31ms     3.2 MB/sec
linter/default-rules/large/dataset.py      1.00      8.5Â±0.22ms     4.8 MB/sec     1.02      8.6Â±0.27ms     4.7 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00  1811.3Â±104.88Âµs     9.2 MB/sec    1.01  1824.3Â±65.32Âµs     9.1 MB/sec
linter/default-rules/numpy/globals.py      1.00   224.2Â±10.03Âµs    13.2 MB/sec     1.03    231.0Â±9.34Âµs    12.8 MB/sec
linter/default-rules/pydantic/types.py     1.00      3.9Â±0.16ms     6.6 MB/sec     1.00      3.9Â±0.18ms     6.6 MB/sec
```
<!-- thollander/actions-comment-pull-request "PR Check Results" -->

---

_Renamed from "Use BestFits for non-call chain call expressions" to "Use BestFits for non-fluent call expressions" by @MichaReiser on 2023-08-23 13:57_

---

_Renamed from "Use BestFits for non-fluent call expressions" to "Use BestFits for non-fluent attribute chains" by @MichaReiser on 2023-08-23 16:29_

---

_@MichaReiser reviewed on 2023-08-23 16:40_

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/expression/expr_constant.rs`:106 on 2023-08-23 16:40_

This helped offsetting the performance regression a bit

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/expression/expr_constant.rs`:116 on 2023-08-23 21:35_

Argh, this is more involved. This solution, while simple, lacks the avoid parentheses for the message if it doesn't fit. It probably requires using `best_fitting` on the assertion side as well because we need to run through 4 variations:

* Format test, if_breaks -> don't use best fitting
* Format message, if_breaks -> don't use best fitting
* Variant 1: [test, message]
* Variant 2: [test, expand(message)],
* Variant 3: [expand(test), expand(message)],
* Variant 4: [test, message]

---

_@MichaReiser reviewed on 2023-08-23 21:35_

---

_Label `formatter` added by @MichaReiser on 2023-08-24 09:51_

---

_Marked ready for review by @MichaReiser on 2023-08-24 09:51_

---

_@konstin approved on 2023-08-24 10:36_

---

_Merged by @MichaReiser on 2023-08-24 12:09_

---

_Closed by @MichaReiser on 2023-08-24 12:09_

---

_Branch deleted on 2023-08-24 12:09_

---
