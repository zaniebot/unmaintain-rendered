```yaml
number: 3904
title: Introduce SourceFile to avoid cloning the message filename
type: pull_request
state: merged
author: MichaReiser
labels:
  - internal
assignees: []
merged: true
base: main
head: code-diff
created_at: 2023-04-07T10:02:23Z
updated_at: 2023-04-11T08:40:32Z
url: https://github.com/astral-sh/ruff/pull/3904
synced_at: 2026-01-12T15:55:14Z
```

# Introduce SourceFile to avoid cloning the message filename

---

_@MichaReiser_

This PR introduces a new `SourceFile` type that replaces `SourceCodeBuf`. It stores the filename and, optionally, the content of the file. `SourceFile` uses an `Arc` internally to make it cheap to clone. 

This change was [proposed](https://github.com/charliermarsh/ruff/pull/3897#discussion_r1160290415) by @charliermarsh to avoid allocating a `String` with the `filename` for every `Message`. 

## Performance

This change significantly improves performance for projects with many diagnostics as we can see from the benchmarks that use `--select ALL`. For example, checking all rules with caching enabled improves from 470ms to 406ms

| Command | Mean [ms] | Min [ms] | Max [ms] | Relative |
|:---|---:|---:|---:|---:|
| `./ruff-source-file <cpython_path> -e   ` | 40.1 Â± 2.4 | 35.4 | 45.4 | 1.00 |
| `./ruff-main <cpython_path> -e   ` | 41.8 Â± 2.6 | 37.4 | 47.6 | 1.04 Â± 0.09 |
| `./ruff-source-file <cpython_path> -e --no-cache  ` | 221.9 Â± 8.2 | 211.2 | 236.9 | 5.53 Â± 0.39 |
| `./ruff-main <cpython_path> -e --no-cache  ` | 221.5 Â± 4.3 | 211.7 | 226.3 | 5.52 Â± 0.35 |
| `./ruff-source-file <cpython_path> -e  --select=ALL ` | 405.8 Â± 10.1 | 391.0 | 427.4 | 10.11 Â± 0.66 |
| `./ruff-main <cpython_path> -e  --select=ALL ` | 469.5 Â± 8.6 | 451.0 | 482.2 | 11.69 Â± 0.74 |
| `./ruff-source-file <cpython_path> -e --no-cache --select=ALL ` | 739.1 Â± 17.6 | 714.8 | 770.5 | 18.41 Â± 1.20 |
| `./ruff-main <cpython_path> -e --no-cache --select=ALL ` | 796.1 Â± 13.2 | 780.0 | 820.7 | 19.83 Â± 1.25 |
| `./ruff-source-file <cpython_path> -e   --show-source` | 85.9 Â± 3.7 | 80.0 | 93.1 | 2.14 Â± 0.16 |
| `./ruff-main <cpython_path> -e   --show-source` | 87.5 Â± 2.9 | 82.5 | 93.2 | 2.18 Â± 0.15 |
| `./ruff-source-file <cpython_path> -e --no-cache  --show-source` | 262.4 Â± 6.0 | 253.2 | 272.0 | 6.54 Â± 0.42 |
| `./ruff-main <cpython_path> -e --no-cache  --show-source` | 267.3 Â± 7.4 | 255.7 | 279.7 | 6.66 Â± 0.44 |
| `./ruff-source-file <cpython_path> -e  --select=ALL --show-source` | 1480.3 Â± 22.2 | 1453.7 | 1516.0 | 36.87 Â± 2.30 |
| `./ruff-main <cpython_path> -e  --select=ALL --show-source` | 1551.0 Â± 24.1 | 1499.7 | 1590.7 | 38.63 Â± 2.42 |
| `./ruff-source-file <cpython_path> -e --no-cache --select=ALL --show-source` | 1791.8 Â± 25.6 | 1759.3 | 1845.3 | 44.63 Â± 2.78 |
| `./ruff-main <cpython_path> -e --no-cache --select=ALL --show-source` | 1851.4 Â± 23.0 | 1816.1 | 1887.9 | 46.11 Â± 2.86 |

## Memory Usage

Memory usage reduced from ~813MB to ~686MB when running all rules without showing the source code. 

---

_Comment by @MichaReiser on 2023-04-07 10:02_

Current dependencies on/for this PR:
* main
  * **PR #3895** <a href="https://app.graphite.dev/github/pr/charliermarsh/ruff/3895" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a> 
    * **PR #3896** <a href="https://app.graphite.dev/github/pr/charliermarsh/ruff/3896" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a> 
      * **PR #3897** <a href="https://app.graphite.dev/github/pr/charliermarsh/ruff/3897" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a> 
        * **PR #3901** <a href="https://app.graphite.dev/github/pr/charliermarsh/ruff/3901" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a> 
          * **PR #3904** <a href="https://app.graphite.dev/github/pr/charliermarsh/ruff/3904" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a>  ðŸ‘ˆ
            * **PR #3905** <a href="https://app.graphite.dev/github/pr/charliermarsh/ruff/3905" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a> 
              * **PR #3906** <a href="https://app.graphite.dev/github/pr/charliermarsh/ruff/3906" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a> 

This comment was auto-generated by [Graphite](https://app.graphite.dev/github/pr/charliermarsh/ruff/3904?utm_source=stack-comment).

---

_Marked ready for review by @MichaReiser on 2023-04-07 10:11_

---

_Comment by @github-actions[bot] on 2023-04-07 10:15_

## PR Check Results
### Ecosystem
âœ… ecosystem check detected no changes.

### Benchmark
#### Linux
```
group                                      main                                   pr
-----                                      ----                                   --
linter/all-rules/large/dataset.py          1.00     17.0Â±0.06ms     2.4 MB/sec    1.01     17.1Â±0.10ms     2.4 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      4.3Â±0.01ms     3.9 MB/sec    1.00      4.3Â±0.01ms     3.9 MB/sec
linter/all-rules/numpy/globals.py          1.00    548.9Â±0.85Âµs     5.4 MB/sec    1.00    549.9Â±1.21Âµs     5.4 MB/sec
linter/all-rules/pydantic/types.py         1.00      7.2Â±0.01ms     3.5 MB/sec    1.01      7.3Â±0.02ms     3.5 MB/sec
linter/default-rules/large/dataset.py      1.00      8.6Â±0.02ms     4.7 MB/sec    1.01      8.7Â±0.02ms     4.7 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00   1953.6Â±3.25Âµs     8.5 MB/sec    1.00   1960.6Â±2.92Âµs     8.5 MB/sec
linter/default-rules/numpy/globals.py      1.00    216.7Â±0.60Âµs    13.6 MB/sec    1.08   234.2Â±88.93Âµs    12.6 MB/sec
linter/default-rules/pydantic/types.py     1.00      4.0Â±0.01ms     6.4 MB/sec    1.00      4.0Â±0.01ms     6.4 MB/sec
```

#### Windows
```
group                                      main                                   pr
-----                                      ----                                   --
linter/all-rules/large/dataset.py          1.00     16.0Â±0.10ms     2.5 MB/sec    1.00     16.0Â±0.09ms     2.5 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      4.2Â±0.02ms     4.0 MB/sec    1.00      4.2Â±0.04ms     4.0 MB/sec
linter/all-rules/numpy/globals.py          1.00    437.2Â±6.09Âµs     6.7 MB/sec    1.00    439.3Â±4.69Âµs     6.7 MB/sec
linter/all-rules/pydantic/types.py         1.00      6.9Â±0.07ms     3.7 MB/sec    1.00      6.9Â±0.03ms     3.7 MB/sec
linter/default-rules/large/dataset.py      1.00      8.2Â±0.02ms     5.0 MB/sec    1.00      8.2Â±0.03ms     5.0 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00  1776.8Â±30.37Âµs     9.4 MB/sec    1.01   1788.9Â±9.98Âµs     9.3 MB/sec
linter/default-rules/numpy/globals.py      1.00    186.1Â±2.91Âµs    15.9 MB/sec    1.01    187.4Â±4.94Âµs    15.7 MB/sec
linter/default-rules/pydantic/types.py     1.00      3.8Â±0.02ms     6.8 MB/sec    1.00      3.8Â±0.03ms     6.8 MB/sec
```
<!-- thollander/actions-comment-pull-request "PR Check Results" -->

---

_@charliermarsh approved on 2023-04-07 18:44_

---

_@charliermarsh reviewed on 2023-04-07 18:45_

Nice, thanks for looking into this!

---

_Label `internal` added by @MichaReiser on 2023-04-11 08:24_

---

_Merged by @MichaReiser on 2023-04-11 08:28_

---

_Closed by @MichaReiser on 2023-04-11 08:28_

---

_Branch deleted on 2023-04-11 08:28_

---
