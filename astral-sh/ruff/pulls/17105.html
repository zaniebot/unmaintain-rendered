<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[red-knot] Add callable subtyping for callable instances and bound methods - astral-sh/ruff #17105</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[red-knot] Add callable subtyping for callable instances and bound methods</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/17105">#17105</a>
        opened by <a href="https://github.com/MatthewMckee4">@MatthewMckee4</a>
        on 2025-03-31 23:23
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MatthewMckee4">@MatthewMckee4</a></div>
            <div class="timeline-body">

Summary
<p>Trying to improve #17005
Partially fixes #16953</p>
Test Plan
<p>Update is_subtype_of.md</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-03-31 23:25</div>
            <div class="timeline-body">

<code>mypy_primer</code> results

Changes were detected when running on open source projects

<pre><code>rich (https://github.com/Textualize/rich)
- error[lint:invalid-argument-type] /tmp/mypy_primer/projects/rich/tests/test_progress.py:292:60: Object of type `MockClock` cannot be assigned to parameter `get_time` of function `track`; expected type `(() -&gt; int | float) | None`
- Found 578 diagnostics
+ Found 577 diagnostics

black (https://github.com/psf/black)
- error[lint:invalid-argument-type] /tmp/mypy_primer/projects/black/src/black/__init__.py:1280:48: Object of type `&lt;bound method `readline` of `BytesIO`&gt; | @Todo(instance attribute on class with dynamic base)` cannot be assigned to parameter 1 (`readline`) of function `detect_encoding`; expected type `() -&gt; bytes | bytearray`
- error[lint:invalid-argument-type] /tmp/mypy_primer/projects/black/src/black/__init__.py:1280:48: Object of type `&lt;bound method `readline` of `BytesIO`&gt; | @Todo(instance attribute on class with dynamic base)` cannot be assigned to parameter 1 (`readline`) of function `detect_encoding`; expected type `() -&gt; bytes | bytearray`
- error[lint:invalid-argument-type] /tmp/mypy_primer/projects/black/src/black/__init__.py:1280:48: Object of type `&lt;bound method `readline` of `BytesIO`&gt; | @Todo(instance attribute on class with dynamic base)` cannot be assigned to parameter 1 (`readline`) of function `detect_encoding`; expected type `() -&gt; bytes | bytearray`
- Found 212 diagnostics
+ Found 209 diagnostics

</code></pre>


</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-03-31 23:42</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MatthewMckee4">@MatthewMckee4</a> reviewed on 2025-04-01 00:18</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MatthewMckee4">@MatthewMckee4</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:4341 on 2025-04-01 00:18</div>
            <div class="timeline-body"><p>I&#x27;m not sure this is how we will want to implement this , but i think its right to not check the name of the variable, and since staticmethod is not supported, this should be fine, but when that is implemented i think we will have to check decorators</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by <a href="https://github.com/MatthewMckee4">@MatthewMckee4</a> on 2025-04-01 00:20</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/carljm">@carljm</a> by <a href="https://github.com/MatthewMckee4">@MatthewMckee4</a> on 2025-04-01 00:20</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/AlexWaygood">@AlexWaygood</a> by <a href="https://github.com/MatthewMckee4">@MatthewMckee4</a> on 2025-04-01 00:20</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/sharkdp">@sharkdp</a> by <a href="https://github.com/MatthewMckee4">@MatthewMckee4</a> on 2025-04-01 00:20</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/dcreager">@dcreager</a> by <a href="https://github.com/MatthewMckee4">@MatthewMckee4</a> on 2025-04-01 00:20</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:4335 on 2025-04-01 07:13</div>
            <div class="timeline-body"><p>Is the <code>clone</code> call here necessary, considering that we already clone each parameter on the line below</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-04-01 07:14</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-04-01 07:14</div>
            <div class="timeline-body"><p>Not sure, but this might be a good one for @dcreager to review?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/resources/mdtest/type_properties/is_subtype_of.md</code>:1077 on 2025-04-01 20:27</div>
            <div class="timeline-body"><p>&quot;Bounded&quot; and &quot;bound&quot; have different meanings; the former means &quot;has a bound&quot;, as in a boundary or limit. The latter means &quot;is bound to something&quot; (as in the verb &quot;to bind&quot;). Typevars can be &quot;bounded&quot; if they have a bound; methods are &quot;bound&quot; to an instance.</p>
<pre><code>### Bound methods
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/resources/mdtest/type_properties/is_subtype_of.md</code>:1141 on 2025-04-01 20:29</div>
            <div class="timeline-body"><p>maybe add some negative tests in here as well, to show that we are actually checking the signature?</p>
<p>Would also be interesting in future to test that <code>A.f</code> is a subtype of <code>Callable[[A, int], int]</code>, but this requires self types, so not for this PR. But a test with a TODO comment would be useful here.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> approved on 2025-04-01 20:34</div>
            <div class="timeline-body"><p>This looks reasonable to me! The tests are good, and we can always change the implementation of <code>BoundMethodType::into_callable_type</code> if we decide we need to preserve the first argument.</p>
<p>Thank you!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MatthewMckee4">@MatthewMckee4</a> on <code>crates/red_knot_python_semantic/resources/mdtest/type_properties/is_subtype_of.md</code>:1141 on 2025-04-01 20:53</div>
            <div class="timeline-body"><p>Sure, will add that soon</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MatthewMckee4">@MatthewMckee4</a> reviewed on 2025-04-01 20:53</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dcreager">@dcreager</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:4341 on 2025-04-01 21:05</div>
            <div class="timeline-body"><p>Can you move the part that manipulates the <code>Signature</code> into a new <code>Signature::bind_self</code> method? That will make it a bit more readable here:</p>
<pre><code>        Type::Callable(CallableType::General(GeneralCallableType::new(
            db,
            self.function(db).signature(db).bind_self(),
        )))
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dcreager">@dcreager</a> approved on 2025-04-01 21:06</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MatthewMckee4">@MatthewMckee4</a> reviewed on 2025-04-01 21:13</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MatthewMckee4">@MatthewMckee4</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:4341 on 2025-04-01 21:13</div>
            <div class="timeline-body"><p>Sure</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from &quot;[red-knot] Add callable subtyping for bounded methods&quot; to &quot;[red-knot] Add callable subtyping for callable instances and bound methods&quot; by <a href="https://github.com/carljm">@carljm</a> on 2025-04-01 23:31</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/resources/mdtest/type_properties/is_subtype_of.md</code>:1120 on 2025-04-01 23:33</div>
            <div class="timeline-body"><p>Nit: underscore is a good name for functions we are never calling or referencing, we just want a scope with some type-annotated names in it. It&#x27;s not a good name for functions we actually reference.</p>
<pre><code>def f(fn: Callable[[int], int]) -&gt; None: ...

f(a)
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/resources/mdtest/type_properties/is_subtype_of.md</code>:1146 on 2025-04-01 23:36</div>
            <div class="timeline-body"><pre><code># TODO: This assertion should be true
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2025-04-01 23:37</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/carljm">@carljm</a> on 2025-04-01 23:40</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/carljm">@carljm</a> on 2025-04-01 23:40</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MatthewMckee4">@MatthewMckee4</a> reviewed on 2025-04-01 23:43</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MatthewMckee4">@MatthewMckee4</a> on <code>crates/red_knot_python_semantic/resources/mdtest/type_properties/is_subtype_of.md</code>:1146 on 2025-04-01 23:43</div>
            <div class="timeline-body"><p>Thanks, not sure why i did that</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-04-01 23:49</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:12:47 UTC
    </footer>
</body>
</html>
