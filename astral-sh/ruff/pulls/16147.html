<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Move `red_knot_python_semantic::PythonVersion` to the `ruff_python_ast` crate - astral-sh/ruff #16147</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Move <code>red_knot_python_semantic::PythonVersion</code> to the <code>ruff_python_ast</code> crate</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/16147">#16147</a>
        opened by <a href="https://github.com/ntBre">@ntBre</a>
        on 2025-02-13 23:36
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a></div>
            <div class="timeline-body"><h2>Summary</h2>
<p>This PR moves the <code>PythonVersion</code> struct from the <code>red_knot_python_semantic</code> crate to the <code>ruff_python_ast</code> crate so that it can be used more easily in the syntax error detection work. Compared to that <a href="https://github.com/astral-sh/ruff/pull/16090/">prototype</a> these changes reduce us from 2 <code>PythonVersion</code> structs to 1.</p>
<p>This does not unify any of the <code>PythonVersion</code> <em>enums</em>, but I hope to make some progress on that in a follow-up.</p>
<h2>Test Plan</h2>
<p>Existing tests, this should not change any external behavior.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @ntBre on 2025-02-13 23:36</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @ntBre on 2025-02-13 23:36</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @AlexWaygood by @ntBre on 2025-02-13 23:36</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @sharkdp by @ntBre on 2025-02-13 23:36</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @dhruvmanila by @ntBre on 2025-02-13 23:36</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-02-13 23:45</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Formatter (stable)</h3>
<p>✅ ecosystem check detected no format changes.</p>
<h3>Formatter (preview)</h3>
<p>✅ ecosystem check detected no format changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">internal</span> added by @ntBre on 2025-02-14 00:25</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-02-14 07:29</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot/src/python_version.rs</code>:4 on 2025-02-14 07:29</div>
            <div class="timeline-body"><p>I think I'd like to keep this type because I don't want the parser to depend on clap.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-02-14 07:31</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_wasm/Cargo.toml</code>:25 on 2025-02-14 07:31</div>
            <div class="timeline-body"><p>I think I'd also prefer to keep the wasm wrapper to avoid having the parser depend on wasm-bindgen just for that.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-02-14 07:33</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_parser/src/python_version.rs</code>:5 on 2025-02-14 07:33</div>
            <div class="timeline-body"><p>I'd prefer to only have one python version in the parser crate. Having more than one seems confusing and unnecessary. Let's keep this in the linter if the linter isn't able to migrate to <code>PythonVersion</code> just yet. It makes it clear why the extra type exists and to which type we should migrate to</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-02-14 07:34</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/options.rs</code>:84 on 2025-02-14 07:34</div>
            <div class="timeline-body"><p>I think it shouldn't be much effort to use <code>PythonVersion</code> here.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> requested changes on 2025-02-14 07:35</div>
            <div class="timeline-body"><p>Thanks.</p>
<p>I'd prefer to keep the API boundary Python version types used in the CLI and wasm because I don't want the parser to depend on clap or wasm bindgen (even optionally). It also allows us to add a new python version only to one tool but not the other.</p>
<p>I'd also prefer not to move <code>PyVersion</code> to the parser. I find that confusing. We should keep this type in the linter crate if migrating the linter is too much effort.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-02-14 13:55</div>
            <div class="timeline-body"><p>I agree with unifying these enums/structs to some extent, but it does feel a bit odd to me that we'd have the common type in <code>ruff_python_parser</code>, since it's not really something specific to parsing Python code -- it's a general-purpose type that you could use for lots of things. <code>ruff_python_ast</code> might be a better fit -- or what about <code>ruff_python_stdlib</code>? If we put it there, we could use it in functions like this, which &quot;should really&quot; take a <code>PythonVersion</code> as their argument (it would make the signature much more strongly typed):</p>
<p>https://github.com/astral-sh/ruff/blob/63dd68e0edf606bc54afce091e543e5691552f97/crates/ruff_python_stdlib/src/builtins.rs#L222</p>
<p>I think the disadvantage might be that we'd have to declare an explicit dependency on <code>ruff_python_stdlib</code> from more other crates -- but I doubt that this would be a huge problem in practice, since both Ruff and red-knot already depend on it, and it's a pretty minimal crate that doesn't depend on any other crates in the workspace. Curious for @MichaReiser's thoughts...</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-02-14 14:56</div>
            <div class="timeline-body"><p>I don't think it should be <code>ruff_python_stdlib</code> because I don't want the parser to depend on that crate. I wouldn't mind the ast crate.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-02-14 14:58</div>
            <div class="timeline-body"><p><code>ruff_python_ast</code> works for me -- we can leave the <code>ruff_python_stdlib</code> APIs as-is for now.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntBre">@ntBre</a> on 2025-02-14 15:03</div>
            <div class="timeline-body"><p>Sounds good, I already reverted everything except moving <code>red_knot_python_semantic::PythonVersion</code> to <code>ruff_python_parser</code>, so I will just move that to <code>ruff_python_ast</code> and then see if the formatter can use <code>PythonVersion</code>. I think I ran into <code>serde</code> issues with that yesterday because the (de)serialization needs to be different from red-knot's usage of <code>PythonVersion</code>, but I'll check again.</p>
<p>Thanks for the reviews!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntBre">@ntBre</a> on 2025-02-14 16:14</div>
            <div class="timeline-body"><p><code>PythonVersion</code> is now in the <code>ast</code> crate, going to look at the formatter version now. I'll update the title and description if we just want to leave it here, though.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_python_ast/src/python_version.rs</code>:1 on 2025-02-14 16:49</div>
            <div class="timeline-body"><p>I suggest to reword one of the comments in this file slightly:</p>
<pre><code class="language-diff">diff --git a/crates/ruff_python_ast/src/python_version.rs b/crates/ruff_python_ast/src/python_version.rs
index 727e68f0c..66745f8a4 100644
--- a/crates/ruff_python_ast/src/python_version.rs
+++ b/crates/ruff_python_ast/src/python_version.rs
@@ -2,8 +2,7 @@ use std::fmt;
 
 /// Representation of a Python version.
 ///
-/// Unlike the `TargetVersion` enums in the CLI crates,
-/// this does not necessarily represent a Python version that we actually support.
+/// N.B. This does not necessarily represent a Python version that we actually support.
 #[derive(Debug, Clone, Copy, Eq, PartialEq, Ord, PartialOrd, Hash)]
 pub struct PythonVersion {
     pub major: u8,
@@ -41,8 +40,7 @@ impl PythonVersion {
             PythonVersion::PY312,
             PythonVersion::PY313,
         ]
-        .iter()
-        .copied()
+        .into_iter()
     }
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> approved on 2025-02-14 16:50</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2025-02-14 17:31</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-02-14 17:31</div>
            <div class="timeline-body"><p>Moving the type and doing the unification in separate PRs does make sense to me</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntBre">@ntBre</a> on 2025-02-14 17:33</div>
            <div class="timeline-body"><p>Sounds good. I think I just started having some promising serde results, but it makes sense to open a separate PR. I'll push the change Alex recommended and then merge!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "Unify version structs and enums" to "Move `red_knot_python_semantic::PythonVersion` to the `ruff_python_ast` crate" by @ntBre on 2025-02-14 17:35</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @ntBre on 2025-02-14 17:48</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @ntBre on 2025-02-14 17:48</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-02-14 17:48</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:10:02 UTC
    </footer>
</body>
</html>
