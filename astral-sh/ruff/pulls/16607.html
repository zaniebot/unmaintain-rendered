<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[ruff-0.10] [`flake8-pyi`] Stabilize preview-mode behaviours for `custom-type-var-for-self`(`PYI019`) - astral-sh/ruff #16607</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[ruff-0.10] [<code>flake8-pyi</code>] Stabilize preview-mode behaviours for <code>custom-type-var-for-self</code>(<code>PYI019</code>)</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/16607">#16607</a>
        opened by <a href="https://github.com/AlexWaygood">@AlexWaygood</a>
        on 2025-03-10 17:12
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a></div>
            <div class="timeline-body">Summary
<p>This PR stabilizes several preview-only behaviours for <code>custom-typevar-for-self</code> (<code>PYI019</code>). Namely:</p>
<ul>
<li>A new, more accurate technique is now employed for detecting custom TypeVars that are replaceable with <code>Self</code>. See <a href="https://github.com/astral-sh/ruff/pull/15888">astral-sh/ruff#15888</a> for details.</li>
<li>The range of the diagnostic is now the full function header rather than just the return annotation. (Previously, the rule only applied to methods with return annotations, but this is no longer true due to the changes in the first bullet point.)</li>
<li>The fix is now available even when preview mode is not enabled.</li>
</ul>
Test Plan
<ul>
<li>Existing snapshots that do not have preview mode enabled are updated</li>
<li>Preview-specific snapshots are removed</li>
<li>I&#x27;ll check the ecosystem report on this PR to verify everything&#x27;s as expected</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">rule</span> added by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-03-10 17:12</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/MichaReiser">@MichaReiser</a> by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-03-10 17:12</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/ntBre">@ntBre</a> by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-03-10 17:12</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-03-10 17:18</div>
            <div class="timeline-body">

<code>ruff-ecosystem</code> results
Linter (stable)
<p>ℹ️ ecosystem check <strong>detected linter changes</strong>. (+19 -0 violations, +0 -0 fixes in 5 projects; 50 projects unchanged)</p>
<a href="https://github.com/apache/superset">apache/superset</a> (+1 -0 violations, +0 -0 fixes)
<p>
<pre>ruff check --no-cache --exit-zero --ignore RUF9 --no-fix --output-format concise --no-preview --select ALL</pre>
</p>
<p>

<pre>
+ <a href="https://github.com/apache/superset/blob/644882faffb15f19cacd09850fccecc782411356/superset/sql/parse.py#L167">superset/sql/parse.py:167:21:</a> PYI019 [*] Use `Self` instead of custom TypeVar `TBaseSQLStatement`
</pre>

</p>

<a href="https://github.com/pandas-dev/pandas">pandas-dev/pandas</a> (+1 -0 violations, +0 -0 fixes)
<p>

<pre>
+ <a href="https://github.com/pandas-dev/pandas/blob/781182cbb00d5587e29a0cb7a3d27459a0f0a6dc/pandas/_libs/tslibs/timedeltas.pyi#L97">pandas/_libs/tslibs/timedeltas.pyi:97:16:</a> PYI019 Use `Self` instead of custom TypeVar `_S`
</pre>

</p>

<a href="https://github.com/python/typeshed">python/typeshed</a> (+13 -0 violations, +0 -0 fixes)
<p>
<pre>ruff check --no-cache --exit-zero --ignore RUF9 --no-fix --output-format concise --no-preview --select E,F,FA,I,PYI,RUF,UP,W</pre>
</p>
<p>

<pre>
+ <a href="https://github.com/python/typeshed/blob/041580d6d64f03e8dc7b2fc0f9ff5258e91f6ffb/stdlib/_typeshed/__init__.pyi#L331">stdlib/_typeshed/__init__.pyi:331:16:</a> PYI019 Use `Self` instead of custom TypeVar `Self`
+ <a href="https://github.com/python/typeshed/blob/041580d6d64f03e8dc7b2fc0f9ff5258e91f6ffb/stdlib/_typeshed/__init__.pyi#L333">stdlib/_typeshed/__init__.pyi:333:24:</a> PYI019 Use `Self` instead of custom TypeVar `Self`
+ <a href="https://github.com/python/typeshed/blob/041580d6d64f03e8dc7b2fc0f9ff5258e91f6ffb/stdlib/typing.pyi#L960">stdlib/typing.pyi:960:15:</a> PYI019 [*] Use `Self` instead of custom TypeVar `_T`
+ <a href="https://github.com/python/typeshed/blob/041580d6d64f03e8dc7b2fc0f9ff5258e91f6ffb/stdlib/typing_extensions.pyi#L237">stdlib/typing_extensions.pyi:237:15:</a> PYI019 Use `Self` instead of custom TypeVar `_T`
+ <a href="https://github.com/python/typeshed/blob/041580d6d64f03e8dc7b2fc0f9ff5258e91f6ffb/stubs/PyYAML/yaml/representer.pyi#L28">stubs/PyYAML/yaml/representer.pyi:28:24:</a> PYI019 [*] Use `Self` instead of custom TypeVar `_R`
+ <a href="https://github.com/python/typeshed/blob/041580d6d64f03e8dc7b2fc0f9ff5258e91f6ffb/stubs/PyYAML/yaml/representer.pyi#L30">stubs/PyYAML/yaml/representer.pyi:30:30:</a> PYI019 [*] Use `Self` instead of custom TypeVar `_R`
+ <a href="https://github.com/python/typeshed/blob/041580d6d64f03e8dc7b2fc0f9ff5258e91f6ffb/stubs/protobuf/google/protobuf/internal/containers.pyi#L36">stubs/protobuf/google/protobuf/internal/containers.pyi:36:18:</a> PYI019 [*] Use `Self` instead of custom TypeVar `_M`
+ <a href="https://github.com/python/typeshed/blob/041580d6d64f03e8dc7b2fc0f9ff5258e91f6ffb/stubs/protobuf/google/protobuf/internal/containers.pyi#L52">stubs/protobuf/google/protobuf/internal/containers.pyi:52:18:</a> PYI019 [*] Use `Self` instead of custom TypeVar `_M`
+ <a href="https://github.com/python/typeshed/blob/041580d6d64f03e8dc7b2fc0f9ff5258e91f6ffb/stubs/protobuf/google/protobuf/internal/containers.pyi#L76">stubs/protobuf/google/protobuf/internal/containers.pyi:76:18:</a> PYI019 [*] Use `Self` instead of custom TypeVar `_M`
+ <a href="https://github.com/python/typeshed/blob/041580d6d64f03e8dc7b2fc0f9ff5258e91f6ffb/stubs/protobuf/google/protobuf/internal/containers.pyi#L99">stubs/protobuf/google/protobuf/internal/containers.pyi:99:18:</a> PYI019 [*] Use `Self` instead of custom TypeVar `_M`
+ <a href="https://github.com/python/typeshed/blob/041580d6d64f03e8dc7b2fc0f9ff5258e91f6ffb/stubs/protobuf/google/protobuf/message.pyi#L30">stubs/protobuf/google/protobuf/message.pyi:30:21:</a> PYI019 [*] Use `Self` instead of custom TypeVar `_M`
+ <a href="https://github.com/python/typeshed/blob/041580d6d64f03e8dc7b2fc0f9ff5258e91f6ffb/stubs/protobuf/google/protobuf/message.pyi#L31">stubs/protobuf/google/protobuf/message.pyi:31:23:</a> PYI019 [*] Use `Self` instead of custom TypeVar `_M`
+ <a href="https://github.com/python/typeshed/blob/041580d6d64f03e8dc7b2fc0f9ff5258e91f6ffb/stubs/protobuf/google/protobuf/message.pyi#L34">stubs/protobuf/google/protobuf/message.pyi:34:19:</a> PYI019 [*] Use `Self` instead of custom TypeVar `_M`
</pre>

</p>

<a href="https://github.com/zulip/zulip">zulip/zulip</a> (+2 -0 violations, +0 -0 fixes)
<p>
<pre>ruff check --no-cache --exit-zero --ignore RUF9 --no-fix --output-format concise --no-preview --select ALL</pre>
</p>
<p>

<pre>
+ <a href="https://github.com/zulip/zulip/blob/602d0f4914d09182561042f7000cb5cd29771270/zerver/data_import/slack.py#L109">zerver/data_import/slack.py:109:18:</a> PYI019 [*] Use `Self` instead of custom TypeVar `SlackBotEmailT`
+ <a href="https://github.com/zulip/zulip/blob/602d0f4914d09182561042f7000cb5cd29771270/zerver/lib/thumbnail.py#L55">zerver/lib/thumbnail.py:55:20:</a> PYI019 [*] Use `Self` instead of custom TypeVar `T`
</pre>

</p>

<a href="https://github.com/astropy/astropy">astropy/astropy</a> (+2 -0 violations, +0 -0 fixes)
<p>

<pre>
+ <a href="https://github.com/astropy/astropy/blob/7547cfca16582a47497016b873fa8a14b46b9cf6/astropy/cosmology/_src/core.py#L485">astropy/cosmology/_src/core.py:485:26:</a> PYI019 Use `Self` instead of custom TypeVar `_FlatCosmoT`
+ <a href="https://github.com/astropy/astropy/blob/7547cfca16582a47497016b873fa8a14b46b9cf6/astropy/cosmology/_src/flrw/base.py#L1705">astropy/cosmology/_src/flrw/base.py:1705:16:</a> PYI019 Use `Self` instead of custom TypeVar `_FlatFLRWMixinT`
</pre>

</p>

Changes by rule (1 rules affected)
<p>

<p>| code | total | + violation | - violation | + fix | - fix |
| ---- | ------- | --------- | -------- | ----- | ---- |
| PYI019 | 19 | 19 | 0 | 0 | 0 |</p>
</p>


Linter (preview)
<p>✅ ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-03-10 17:22</div>
            <div class="timeline-body"><p>The ecosystem hits all LGTM</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/flake8_pyi/rules/custom_type_var_for_self.rs</code>:75 on 2025-03-10 18:21</div>
            <div class="timeline-body"><p>Should we update both PEP names. It feels somewhat inconsistent to use a <code>-</code> here but not for PEP 673 (I don&#x27;t think we have a standard for this but I suspect that no dash is more commonly used?)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2025-03-10 18:22</div>
            <div class="timeline-body"><p>Thank you</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> approved on 2025-03-10 22:08</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-03-10 22:10</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/flake8_pyi/rules/custom_type_var_for_self.rs</code>:75 on 2025-03-10 22:10</div>
            <div class="timeline-body"><p>It looks like this <code>PEP-695</code> is only used in a hyphenated expression (<code>[PEP-695]-style</code>), which probably explains the extra dash in this one.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-03-11 16:05</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_linter/src/rules/flake8_pyi/rules/custom_type_var_for_self.rs</code>:75 on 2025-03-11 16:05</div>
            <div class="timeline-body"><p>yes, Brent has it exactly right. The unhyphenated form is usually preferred, so that&#x27;s why &quot;PEP 673&quot; should remain unhyphenated in the docs above this. But PEP-695-style is a hyphenated expression, so it makes sense for the hyphen to remain there between &quot;PEP&quot; and &quot;695&quot;</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-03-11 16:05</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-03-11 16:05</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-03-11 16:05</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:12:10 UTC
    </footer>
</body>
</html>
