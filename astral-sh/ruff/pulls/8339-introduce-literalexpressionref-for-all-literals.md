```yaml
number: 8339
title: "Introduce `LiteralExpressionRef` for all literals"
type: pull_request
state: merged
author: dhruvmanila
labels:
  - internal
assignees: []
merged: true
base: main
head: dhruv/literal-expr-ref
created_at: 2023-10-30T07:37:32Z
updated_at: 2023-10-31T13:04:57Z
url: https://github.com/astral-sh/ruff/pull/8339
synced_at: 2026-01-12T15:55:26Z
```

# Introduce `LiteralExpressionRef` for all literals

---

_@dhruvmanila_

## Summary

This PR adds a new `LiteralExpressionRef` which wraps all of the literal expression nodes in a single enum. This allows for a narrow type when working exclusively with a literal node. Additionally, it also implements a `Expr::as_literal_expr` method to return the new enum if the expression is indeed a literal one.

A few rules have been updated to account for the new enum:
1. `redundant_literal_union`
2. `if_else_block_instead_of_dict_lookup`
3. `magic_value_comparison`

To account for the change in (2), a new `ComparableLiteral` has been added which can be constructed from the new enum (`ComparableLiteral::from(<LiteralExpressionRef>)`).

### Open Questions

1. The new `ComparableLiteral` can be exclusively used via the `LiteralExpressionRef` enum. Should we remove all of the literal variants from `ComparableExpr` and instead have a single `ComparableExpr::Literal(ComparableLiteral)` variant instead?

## Test Plan

`cargo test`

---

_Comment by @dhruvmanila on 2023-10-30 07:37_

Current dependencies on/for this PR:
* main
  * **PR #8339** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/8339" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a>  ðŸ‘ˆ

This comment was auto-generated by [Graphite](https://app.graphite.dev/github/pr/astral-sh/ruff/8339?utm_source=stack-comment).

---

_Label `internal` added by @dhruvmanila on 2023-10-30 07:46_

---

_Comment by @github-actions[bot] on 2023-10-30 07:51_

## PR Check Results
### Ecosystem
âœ… ecosystem check detected no linter changes.

âœ… ecosystem check detected no format changes.



---

_Review comment by @dhruvmanila on `crates/ruff_linter/src/rules/flake8_pyi/rules/redundant_literal_union.rs`:62 on 2023-10-31 06:19_

The old name was confusing. The vector refers to all the elements inside a `typing.Literal`. Maybe `typing_literal_values`?

---

_Review comment by @dhruvmanila on `crates/ruff_linter/src/rules/flake8_pyi/rules/redundant_literal_union.rs`:165 on 2023-10-31 06:20_

I've explicitly mentioned the last 2 variants even though it's not strictly required.

---

_@dhruvmanila reviewed on 2023-10-31 06:25_

---

_Marked ready for review by @dhruvmanila on 2023-10-31 06:25_

---

_Review requested from @MichaReiser by @dhruvmanila on 2023-10-31 06:50_

---

_Review request for @MichaReiser removed by @dhruvmanila on 2023-10-31 06:50_

---

_Review requested from @konstin by @dhruvmanila on 2023-10-31 06:50_

---

_Review requested from @MichaReiser by @dhruvmanila on 2023-10-31 06:51_

---

_Review comment by @konstin on `crates/ruff_linter/src/rules/pylint/rules/magic_value_comparison.rs`:61 on 2023-10-31 11:11_

nit: make this a method on `LiteralExpressionRef`?

---

_@konstin approved on 2023-10-31 11:12_

---

_Review comment by @MichaReiser on `crates/ruff_linter/src/rules/pylint/rules/magic_value_comparison.rs`:61 on 2023-10-31 12:08_

This method seems to be specific to the rule implementation (e.g. it unwraps unary expressions)

---

_Review comment by @MichaReiser on `crates/ruff_linter/src/rules/pylint/settings.rs`:21 on 2023-10-31 12:09_

Can we remove the catch al case or list the literals explicit to make the match exhaustive?

---

_@MichaReiser approved on 2023-10-31 12:10_

---

_@dhruvmanila reviewed on 2023-10-31 12:39_

---

_Review comment by @dhruvmanila on `crates/ruff_linter/src/rules/pylint/rules/magic_value_comparison.rs`:61 on 2023-10-31 12:39_

Yes, it's specific to this rule. It basically unwraps a `Expr` into `LiteralExpressionRef` but includes a unary operation on a literal as well.

---

_@dhruvmanila reviewed on 2023-10-31 12:46_

---

_Review comment by @dhruvmanila on `crates/ruff_linter/src/rules/pylint/settings.rs`:21 on 2023-10-31 12:46_

Yeah, I'll list the literals explicitly.

I thought of merging multiple `ConstantType`, `LiteralType`, etc. into a single enum but it seems that one or the other variants are absent from them, so it's use-case dependent.

---

_Merged by @dhruvmanila on 2023-10-31 12:56_

---

_Closed by @dhruvmanila on 2023-10-31 12:56_

---

_Branch deleted on 2023-10-31 12:56_

---
