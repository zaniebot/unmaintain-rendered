<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[`flake8-comprehensions`] Fix `C420` to prepend whitespace when needed - astral-sh/ruff #18616</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[<code>flake8-comprehensions</code>] Fix <code>C420</code> to prepend whitespace when needed</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/18616">#18616</a>
        opened by <a href="https://github.com/robsdedude">@robsdedude</a>
        on 2025-06-10 19:55
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/robsdedude">@robsdedude</a></div>
            <div class="timeline-body">

Summary
<p>This PR fixes rule C420&#x27;s fix. The fix replaces <code>{...}</code> with <code>dict....(...)</code>. Therefore, if there is any identifier or such right before the fix, the fix will fuse that previous token with <code>dict...</code>.</p>
<p>The example in the issue is</p>
<pre><code>0 or{x: None for x in &quot;x&quot;}
# gets &quot;fixed&quot; to
0 ordict.fromkeys(iterable)
</code></pre>
Related Issues
<p>Fixes: <a href="https://github.com/astral-sh/ruff/issues/18599">astral-sh/ruff#18599</a></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-06-10 20:17</div>
            <div class="timeline-body">

<code>ruff-ecosystem</code> results
Linter (stable)
<p>✅ ecosystem check detected no linter changes.</p>
Linter (preview)
<p>✅ ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/robsdedude">@robsdedude</a> reviewed on 2025-06-10 20:20</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/robsdedude">@robsdedude</a> on <code>crates/ruff_python_parser/src/lexer.rs</code>:1637 on 2025-06-10 20:20</div>
            <div class="timeline-body"><p>Not sure you&#x27;re fine with this PR increasing the coupling of the crates. However, I didn&#x27;t want to duplicate that logic. But maybe there&#x27;s even a better general approach for fixing the issue that works on a higher logical level than chars.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by <a href="https://github.com/robsdedude">@robsdedude</a> on 2025-06-10 20:20</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/MichaReiser">@MichaReiser</a> by <a href="https://github.com/robsdedude">@robsdedude</a> on 2025-06-10 20:21</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/dhruvmanila">@dhruvmanila</a> by <a href="https://github.com/robsdedude">@robsdedude</a> on 2025-06-10 20:21</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by <a href="https://github.com/ntBre">@ntBre</a> on 2025-06-10 20:22</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">fixes</span> added by <a href="https://github.com/ntBre">@ntBre</a> on 2025-06-10 20:22</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_python_parser/src/lexer.rs</code>:1637 on 2025-06-18 18:40</div>
            <div class="timeline-body"><p>This is a neat find, I didn&#x27;t know about this function before.</p>
<p>I think I would have instead reached for something more like was done in <a href="https://github.com/astral-sh/ruff/pull/17648">astral-sh/ruff#17648</a> (checking if two token ranges are adjacent). Would that work here too?</p>
<p>I&#x27;m not totally against using the lexer function if not, but I&#x27;m not sure we really want to make it <code>pub</code> like you  said.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/flake8_comprehensions/rules/unnecessary_dict_comprehension_for_iterable.rs</code>:127 on 2025-06-18 18:46</div>
            <div class="timeline-body"><p>It would be nice to avoid the <code>format!</code> call if we don&#x27;t need any padding, so I&#x27;d probably just in-line <code>fix_padding</code> and put this <code>format!</code> in the <code>true</code> branch (or at least change the signature of <code>fix_padding</code>). I&#x27;m picturing something like this:</p>
<pre><code>let replacement = checker.generator() /* ...the rest of that code */;
let replacement = if needs_padding {
    format!(&quot; {replacement}&quot;)
} else {
    replacement
};
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-06-18 18:49</div>
            <div class="timeline-body"><p>Thanks! This looks good overall, just a couple of suggestions.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_parser/src/lexer.rs</code>:1637 on 2025-06-23 09:04</div>
            <div class="timeline-body"><p>Could we use <code>edits::pad_start</code> instead or <code>is_identifier</code>. I&#x27;d prefer to not make this function public</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-06-23 09:04</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/robsdedude">@robsdedude</a> on <code>crates/ruff_python_parser/src/lexer.rs</code>:1637 on 2025-06-27 22:17</div>
            <div class="timeline-body"><p><code>pad_start</code> sounds exactly like what we want... However, looking at its implementation I suspect (not tested yet) that it&#x27;s implemented incorrectly. It only considers <code>is_ascii_alphabetic</code>. Python&#x27;s identifiers allow much more than ASCII alphabetic characters, which is exactly why I reached for <code>is_identifier_continuation</code>. How do you suggest to proceed? My gut feeling is</p>
<ul>
<li>use <code>pad_start</code> for this PR</li>
<li>open a separate issue to discuss fixing <code>pad_start</code></li>
</ul>
<p>What <code>is_identifier</code> are you referring to? There are multiple functions with that name in the repo :innocent: If you mean <code>ruff_python_stdlib::identifiers::is_identifier</code>, I suppose we could, but it&#x27;d require looking at more than just the preceding character which might only be a valid identifier continuation, but not a start (e.g., a digit). Sounds more costly and error prone.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/robsdedude">@robsdedude</a> reviewed on 2025-06-27 22:17</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/robsdedude">@robsdedude</a> reviewed on 2025-06-27 22:21</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/robsdedude">@robsdedude</a> on <code>crates/ruff_python_parser/src/lexer.rs</code>:1637 on 2025-06-27 22:21</div>
            <div class="timeline-body"><p>Well, maybe in this case it&#x27;s correct because we only care about preceding keywords, which only are contain ASCII alphabetic chars.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/robsdedude">@robsdedude</a> reviewed on 2025-06-27 22:49</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/robsdedude">@robsdedude</a> on <code>crates/ruff_python_parser/src/lexer.rs</code>:1637 on 2025-06-27 22:49</div>
            <div class="timeline-body"><p>Yeah, after looking at some examples in the code-base as well as Python&#x27;s <a href="https://docs.python.org/3/reference/expressions.html#grammar-token-python-grammar-comparison">grammar for expressions</a>, I&#x27;m fairly convinced, that <code>pad</code>, <code>pad_start</code>, and <code>pad_end</code> are fine as long as all edits that are padded are replacing a full expression as those cannot be surrounded by arbitrary identifiers as far as I can tell.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/ntBre">@ntBre</a> by <a href="https://github.com/robsdedude">@robsdedude</a> on 2025-06-27 23:11</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> approved on 2025-06-30 16:38</div>
            <div class="timeline-body"><p>Thanks! This looks really nice with <code>pad_start</code>. Thanks for double checking that it was working correctly too.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from &quot;[`flake8_comprehensions`] Fix `C420` to prepend whitespace when needed&quot; to &quot;[`flake8-comprehensions`] Fix `C420` to prepend whitespace when needed&quot; by <a href="https://github.com/ntBre">@ntBre</a> on 2025-06-30 16:38</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/ntBre">@ntBre</a> on 2025-06-30 16:38</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/ntBre">@ntBre</a> on 2025-06-30 16:38</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-06-30 19:00</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:15:28 UTC
    </footer>
</body>
</html>
