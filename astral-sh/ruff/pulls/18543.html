<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[ty] Add hints to `invalid-type-form` for common mistakes - astral-sh/ruff #18543</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[ty] Add hints to <code>invalid-type-form</code> for common mistakes</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/18543">#18543</a>
        opened by <a href="https://github.com/benbaror">@benbaror</a>
        on 2025-06-08 06:05
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/benbaror">@benbaror</a></div>
            <div class="timeline-body">

Summary
<p>Resolves  <a href="https://github.com/astral-sh/ty/issues/593">astral-sh/ty#593</a></p>
<ol>
<li>Added a hint when using [...] instead of list[]</li>
<li>Emit diagnostic and hint when using (...) instead of tuple[...]</li>
</ol>
Test Plan
<p>Added md tests and snapshot</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/carljm">@carljm</a> by <a href="https://github.com/benbaror">@benbaror</a> on 2025-06-08 06:05</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/AlexWaygood">@AlexWaygood</a> by <a href="https://github.com/benbaror">@benbaror</a> on 2025-06-08 06:05</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/sharkdp">@sharkdp</a> by <a href="https://github.com/benbaror">@benbaror</a> on 2025-06-08 06:05</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/dcreager">@dcreager</a> by <a href="https://github.com/benbaror">@benbaror</a> on 2025-06-08 06:05</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-06-08 11:07</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_python_semantic/src/types/infer.rs</code>:8575 on 2025-06-08 11:07</div>
            <div class="timeline-body"><p>I&#x27;d lean towards <em>only</em> adding this hint if the list has 1 item in the slice. If it&#x27;s <code>[int]</code>, it&#x27;s very likely that the user wanted <code>list[int]</code>, but if it&#x27;s something like <code>[int, str]</code>, it feels to me just as likely that the user wanted <code>tuple[int, str]</code>.</p>
<p>It would also be great if we could say &quot;Did you mean <code>list[int]</code>?&quot; in the suggestion if it was <code>[int]</code>, rather than just &quot;Did you mean to use <code>list[...]</code>?&quot;!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_python_semantic/resources/mdtest/annotations/invalid.md</code>:98 on 2025-06-08 11:11</div>
            <div class="timeline-body"><p>Enabling snapshots for this subsection creates a snapshot that&#x27;s sort-of overwhelmingly huge ðŸ˜† I&#x27;m inclined to add a new subsection to the <code>## Diagnostics for common errors</code> section below, enable snapshots for that new subsection, and add duplicate tests to that section for the nodes where we offer tailored hints. It doesn&#x27;t matter too much if some nodes are tested twice, once without snapshots and once with snapshots!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-06-08 11:11</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-06-08 11:11</div>
            <div class="timeline-body"><p>Thank you -- this looks on the right track! ðŸ˜ƒ</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-06-08 11:14</div>
            <div class="timeline-body">

<code>mypy_primer</code> results

Changes were detected when running on open source projects

<pre><code>trio (https://github.com/python-trio/trio)
+ error[invalid-type-form] src/trio/_core/_generated_io_kqueue.py:62:51: List literals are not allowed in this context in a type expression
+ error[invalid-type-form] src/trio/_core/_io_kqueue.py:150:30: List literals are not allowed in this context in a type expression
+ error[invalid-type-form] src/trio/_core/_io_windows.py:931:29: List literals are not allowed in this context in a type expression
- Found 1064 diagnostics
+ Found 1067 diagnostics

cki-lib (https://gitlab.com/cki-project/cki-lib)
+ error[invalid-type-form] cki_lib/footer.py:75:50: List literals are not allowed in this context in a type expression: Did you mean `tuple[str, str]`?
+ error[invalid-type-form] cki_lib/inttests/remote_responses.py:109:35: List literals are not allowed in this context in a type expression: Did you mean `list[PreparedRequest]`?
- Found 162 diagnostics
+ Found 164 diagnostics

pwndbg (https://github.com/pwndbg/pwndbg)
+ error[invalid-type-form] pwndbg/aglib/disasm/riscv.py:121:54: List literals are not allowed in this context in a type expression: Did you mean `tuple[PwndbgInstruction, Emulator]`?
- Found 2317 diagnostics
+ Found 2318 diagnostics

static-frame (https://github.com/static-frame/static-frame)
- warning[possibly-unbound-implicit-call] static_frame/test/typing/test_index_hierarchy.py:17:22: Method `__getitem__` of type `Unknown | &lt;class &#x27;Index&#x27;&gt;` is possibly unbound
- warning[possibly-unbound-implicit-call] static_frame/test/typing/test_index_hierarchy.py:17:35: Method `__getitem__` of type `Unknown | &lt;class &#x27;Index&#x27;&gt;` is possibly unbound
- warning[possibly-unbound-implicit-call] static_frame/test/typing/test_index_hierarchy.py:20:22: Method `__getitem__` of type `Unknown | &lt;class &#x27;Index&#x27;&gt;` is possibly unbound
- warning[possibly-unbound-implicit-call] static_frame/test/typing/test_index_hierarchy.py:20:35: Method `__getitem__` of type `Unknown | &lt;class &#x27;Index&#x27;&gt;` is possibly unbound
- error[invalid-type-form] static_frame/test/unit/test_type_clinic.py:455:21: List literals are not allowed in this context in a type expression
+ error[invalid-type-form] static_frame/test/unit/test_type_clinic.py:455:21: List literals are not allowed in this context in a type expression: Did you mean `tuple[int, int]`?
- Found 1925 diagnostics
+ Found 1921 diagnostics

mypy (https://github.com/python/mypy)
+ error[invalid-type-form] mypy/typeshed/stdlib/importlib/resources/_common.pyi:19:28: List literals are not allowed in this context in a type expression: Did you mean `list[Unknown | None]`?
+ error[invalid-type-form] mypy/typeshed/stdlib/importlib/resources/_common.pyi:20:23: List literals are not allowed in this context in a type expression: Did you mean `tuple[Unknown | None, Unknown | None]`?
+ error[invalid-type-form] mypy/typeshed/stdlib/importlib/resources/_common.pyi:42:76: Boolean literals are not allowed in this context in a type expression
+ error[invalid-type-form] mypy/typeshed/stdlib/importlib/resources/_functional.pyi:28:92: Boolean literals are not allowed in this context in a type expression
+ error[invalid-type-form] mypy/typeshed/stdlib/typing.pyi:416:53: Variable of type `TypeVar` is not allowed in a type expression
+ error[invalid-type-form] mypy/typeshed/stdlib/typing.pyi:416:74: Variable of type `TypeVar` is not allowed in a type expression
+ error[invalid-type-form] mypy/typeshed/stdlib/typing.pyi:540:37: Variable of type `TypeVar` is not allowed in a type expression
+ error[invalid-type-form] mypy/typeshed/stdlib/typing.pyi:540:49: Variable of type `TypeVar` is not allowed in a type expression
+ error[invalid-type-form] mypy/typeshed/stdlib/typing.pyi:540:64: Variable of type `TypeVar` is not allowed in a type expression
+ error[invalid-type-form] mypy/typeshed/stdlib/typing.pyi:557:48: Variable of type `TypeVar` is not allowed in a type expression
+ error[invalid-type-form] mypy/typeshed/stdlib/typing.pyi:604:48: Variable of type `TypeVar` is not allowed in a type expression
+ error[invalid-type-form] mypy/typeshed/stdlib/typing.pyi:606:69: Variable of type `TypeVar` is not allowed in a type expression
+ error[invalid-type-form] mypy/typeshed/stdlib/typing.pyi:611:30: Variable of type `TypeVar` is not allowed in a type expression
+ error[invalid-type-form] mypy/typeshed/stdlib/typing.pyi:616:30: Variable of type `TypeVar` is not allowed in a type expression
+ error[invalid-type-form] mypy/typeshed/stdlib/typing.pyi:710:41: Variable of type `TypeVar` is not allowed in a type expression
+ error[invalid-type-form] mypy/typeshed/stdlib/typing.pyi:710:49: Variable of type `TypeVar` is not allowed in a type expression
+ error[invalid-type-form] mypy/typeshed/stdlib/typing.pyi:723:41: Variable of type `TypeVar` is not allowed in a type expression
+ error[invalid-type-form] mypy/typeshed/stdlib/typing.pyi:736:46: Variable of type `TypeVar` is not allowed in a type expression
+ error[invalid-type-form] mypy/typeshed/stdlib/typing.pyi:750:34: Variable of type `TypeVar` is not allowed in a type expression
+ error[invalid-type-form] mypy/typeshed/stdlib/typing.pyi:750:39: Variable of type `TypeVar` is not allowed in a type expression
- error[unsupported-operator] mypy/typeshed/stdlib/typing.pyi:776:46: Operator `|` is unsupported between objects of type `TypeVar` and `None`
+ error[invalid-type-form] mypy/typeshed/stdlib/typing.pyi:776:41: Variable of type `TypeVar` is not allowed in a type expression
+ error[invalid-type-form] mypy/typeshed/stdlib/typing.pyi:776:46: Variable of type `TypeVar` is not allowed in a type expression
+ error[invalid-type-form] mypy/typeshed/stdlib/typing.pyi:802:35: Variable of type `TypeVar` is not allowed in a type expression
+ error[invalid-type-form] mypy/typeshed/stdlib/typing.pyi:806:35: Variable of type `TypeVar` is not allowed in a type expression
+ error[invalid-type-form] mypy/typeshed/stdlib/typing.pyi:808:35: Variable of type `TypeVar` is not allowed in a type expression
+ error[invalid-type-form] mypyc/test-data/fixtures/typing-full.pyi:100:38: Variable of type `object` is not allowed in a type expression
+ error[invalid-type-form] mypyc/test-data/fixtures/typing-full.pyi:100:43: Variable of type `object` is not allowed in a type expression
- Found 3183 diagnostics
+ Found 3209 diagnostics

dd-trace-py (https://github.com/DataDog/dd-trace-py)
+ error[invalid-type-form] ddtrace/internal/bytecode_injection/core.py:32:34: List literals are not allowed in this context in a type expression: Did you mean `list[InjectionContext]`?
- Found 6885 diagnostics
+ Found 6886 diagnostics

</code></pre>


</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ty</span> added by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-06-08 11:29</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> approved on 2025-06-08 22:38</div>
            <div class="timeline-body"><p>Thank you, this is excellent! I pushed a refactor so that we don&#x27;t calculate the hinted type so eagerly unless we know we&#x27;re going to emit a diagnostic. That&#x27;s quite important, as there&#x27;s lots of situations where we need to infer types without emitting diagnostics (for example, if we&#x27;re analzying third-party code in <code>site-packages</code> because we followed an import there from first-party code)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from &quot;[ty] `invalid-type-form` Hints and diagnostic for list and tuple&quot; to &quot;[ty] `invalid-type-form` Add hints to `invalid-type-form` for common mistakes&quot; by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-06-08 22:40</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from &quot;[ty] `invalid-type-form` Add hints to `invalid-type-form` for common mistakes&quot; to &quot;[ty] Add hints to `invalid-type-form` for common mistakes&quot; by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-06-08 22:40</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-06-08 23:38</div>
            <div class="timeline-body"><p>That&#x27;s a bit more primer output than I was expecting, but most of it is one of:</p>
<ul>
<li><p>Ty not understanding that <code>typing.TypeVar</code> in mypy&#x27;s vendored version of typeshed is the same class as <code>typing.TypeVar</code> in ty&#x27;s vendored version of typeshed. This isn&#x27;t really a bug, just a weirdness that comes from type-checking all Python files in mypy&#x27;s codebase with ty.</p>
</li>
<li><p>Strange things happening in unreachable code branches, which mean that we don&#x27;t understand that <code>Callable</code> is <code>Callable</code> or <code>Literal</code> is <code>Literal</code> in those branches. That&#x27;s important because we only recognize int literals as being valid inside type expressions when they&#x27;re nested inside <code>Literal</code> slices, and we only recognize list literals as being valid in type expressions if they appear as the first argument to <code>Callable</code>.</p>
<p>We&#x27;re planning on implementing a global solution soon so that we don&#x27;t emit any false positives in unreachable code branches, so I&#x27;m not going to worry too much about this issue either right now.</p>
</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-06-08 23:40</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-06-08 23:40</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">diagnostics</span> added by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2025-06-11 10:44</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:15:19 UTC
    </footer>
</body>
</html>
