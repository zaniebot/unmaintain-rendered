<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>format doctests in docstrings - astral-sh/ruff #8811</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>format doctests in docstrings</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/8811">#8811</a>
        opened by <a href="https://github.com/BurntSushi">@BurntSushi</a>
        on 2023-11-21 20:14
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2023-11-21 20:14</div>
            <div class="timeline-body"><h2>Summary</h2>
<p>This PR adds opt-in support for formatting doctests in docstrings. This reflects initial support and it is intended to add support for Markdown and reStructuredText Python code blocks in the future. But I believe this PR lays the groundwork, and future additions for Markdown and reST should be less costly to add.</p>
<p>It's strongly recommended to review this PR commit-by-commit. The last few commits in particular implement the bulk of the work here and represent the denser portions.</p>
<p>Some things worth mentioning:</p>
<ul>
<li>The formatter is itself not perfect, and it is possible for it to produce invalid Python code. Because of this, reformatted code snippets are checked for Python validity. If they aren't valid, then we (unfortunately silently) bail on formatting that code snippet.</li>
<li>There are a couple places where it would be nice to at least warn the user that doctest formatting failed, but it wasn't clear to me what the best way to do that is.</li>
<li>I haven't yet run this in anger on a real world code base. I think that should happen before merging.</li>
</ul>
<p>Closes #7146</p>
<h2>Test Plan</h2>
<ul>
<li>[x] Pass the local test suite.</li>
<li>[x] Scrutinize ecosystem changes.</li>
<li>[x] Run this formatter on extant code and scrutinize the results. (e.g., CPython, numpy.)</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @charliermarsh by @BurntSushi on 2023-11-21 20:14</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @konstin by @BurntSushi on 2023-11-21 20:14</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2023-11-21 20:30</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>âœ… ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>âœ… ecosystem check detected no linter changes.</p>
<h3>Formatter (stable)</h3>
<p>âœ… ecosystem check detected no format changes.</p>
<h3>Formatter (preview)</h3>
<p>âœ… ecosystem check detected no format changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_python_formatter/src/expression/string.rs</code>:1214 on 2023-11-21 20:49</div>
            <div class="timeline-body"><p>Nit: &quot;should not be allowed&quot;</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_python_formatter/resources/test/fixtures/ruff/docstring_code_examples.py</code>:199 on 2023-11-21 20:51</div>
            <div class="timeline-body"><p>Yeah I'm not sure. I suspect the behavior you have here <em>is</em> desirable? (Any idea what other tools do?)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_python_formatter/resources/test/fixtures/ruff/docstring_code_examples.py</code>:275 on 2023-11-21 20:52</div>
            <div class="timeline-body"><p>This is getting skipped because the doctest fails to parse, right? As in, it's invalid Python?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-11-21 20:53</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-11-21 20:55</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_python_formatter/src/expression/string.rs</code>:1552 on 2023-11-21 20:55</div>
            <div class="timeline-body"><p>Slightly superficial comment, but what's your reaction to splitting the docstring-specific code out into its own file?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_workspace/src/settings.rs</code>:130 on 2023-11-21 21:52</div>
            <div class="timeline-body"><p>I feel like we're going to end up bikeshedding on this name... a few ideas for consideration:</p>
<ul>
<li><code>include_docstrings=true</code> (I like this but it doesn't convey that we're describing <em>code</em> in docstrings)</li>
<li><code>docstrings=true</code></li>
<li><code>include_embedded_code=true</code></li>
<li><code>include_docstring_code=true</code></li>
<li><code>include_docstring_snippets=true</code></li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-11-21 21:52</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_python_formatter/src/expression/string.rs</code>:1196 on 2023-11-21 21:54</div>
            <div class="timeline-body"><p>Hmm yeah. I guess the warning utilities only exist in the linter. We could move those macros to (e.g.) <code>ruff_macro</code>, or something, but I'm not hugely concerned about this.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-11-21 21:54</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-11-21 21:58</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_python_formatter/src/expression/string.rs</code>:1274 on 2023-11-21 21:58</div>
            <div class="timeline-body"><p>Nit: &quot;in which case&quot; (I know this was just moved, but I re-read it so...)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-11-21 21:58</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_python_formatter/src/expression/string.rs</code>:1217 on 2023-11-21 21:58</div>
            <div class="timeline-body"><p>Hmm, we may need to preserve line endings here, right? What if the code uses non-LF line endings, or the formatter has a line ending set?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-11-21 21:59</div>
            <div class="timeline-body"><p>Overall, this looks great, and I appreciate the way you broke it down by commit. I ended up reading the commits one-by-one and found the flow very clear.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2023-11-22 14:07</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ruff_python_formatter/resources/test/fixtures/ruff/docstring_code_examples.py</code>:199 on 2023-11-22 14:07</div>
            <div class="timeline-body"><p>So it looks like <code>blacken-docs</code> behaves like us. But <a href="https://github.com/keewis/blackdoc/blob/822385ba8955e44397288caa07a2d2e3dc933b1e/blackdoc/blacken.py#L72"><code>blackdoc</code> passes the current indentation width to <code>black</code></a> when reformatting a code snippet. From playing with it, it does indeed look like that the max line width is preserved uniformly.</p>
<p>I will also say that as someone who cares a lot about line width, I would want the formatter to wrap lines according to my setting in a global way. i.e., The code snippets shouldn't be treated as starting from the first column.</p>
<p>I'll take a quick look and see if I can make this work <em>robustly</em>. (Emphasis on &quot;robust.&quot; This was why I didn't explore it too much initially.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2023-11-22 14:08</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ruff_python_formatter/resources/test/fixtures/ruff/docstring_code_examples.py</code>:275 on 2023-11-22 14:08</div>
            <div class="timeline-body"><p>Yup! I added a clarifying note to the comment.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2023-11-22 14:09</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ruff_python_formatter/src/expression/string.rs</code>:1552 on 2023-11-22 14:09</div>
            <div class="timeline-body"><p>I thought about this while coding and I was torn. I think I ultimately didn't do it because I thought that we might eventually want to refactor it further (possibly) so that it can be used in other contexts aside from formatting Python code. So I didn't want to spend too much time on making it a &quot;proper&quot; abstraction. With that said, I do believe it lifts pretty cleanly out of this module. I'll try it out and see how it feels.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2023-11-22 14:13</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ruff_workspace/src/settings.rs</code>:130 on 2023-11-22 14:13</div>
            <div class="timeline-body"><p>Yeah that was why I just picked the first thing that came to mind.</p>
<p>Of your list, I like <code>include_docstring_code</code> the best. But I think I do actually like <code>docstring_code</code> the best overall. It kind of feels like the word &quot;include&quot; is a little redundant? Looking at the names of other options, it doesn't look like there is any strong precedent here. Although using &quot;include&quot; here could start a precedent. (I don't know whether we plan on adding a ton of options or not though.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-11-22 14:13</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_python_formatter/src/expression/string.rs</code>:1552 on 2023-11-22 14:13</div>
            <div class="timeline-body"><p>It would also be fine as a separate change / PR after-the-fact if easier and less distracting.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2023-11-22 14:14</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ruff_python_formatter/src/expression/string.rs</code>:1196 on 2023-11-22 14:14</div>
            <div class="timeline-body"><p>All righty. I'll keep it out of scope for now. cc @zanieb since I think you might care about this and might have other ideas  or opinions.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2023-11-22 14:53</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ruff_python_formatter/src/expression/string.rs</code>:1217 on 2023-11-22 14:53</div>
            <div class="timeline-body"><p>I don't believe so, no. I could use <code>\r\n</code> here and things would still turn out okay. I did it this way because immediately after this, we reformat the code snippet with the user's settings, which should include their line ending preferences.</p>
<p>With that said... I tried to write a test for this and failed. I <em>suspect</em> something is mangling or normalizing line endings in our test infrastructure. If I run the formatter directly, then line endings are preserved:</p>
<pre><code>$ rg '\x0D' /tmp/test.py
$ cat /tmp/ruff.toml
[format]
docstring-code = true
$ cargo run -qp ruff_cli format --config /tmp/ruff.toml - &lt; /tmp/test.py | rg '\x0D'
$ cat /tmp/ruff.toml
[format]
docstring-code = true
line-ending = 'cr-lf'
$ cargo run -qp ruff_cli format --config /tmp/ruff.toml - &lt; /tmp/test.py | rg '\x0D'
def doctest_line_ending():
    &quot;&quot;&quot;
    Do cool stuff.
    &gt;&gt;&gt; def foo(x):
    ...     print(x)
    ...
    ...     print(x)
    &quot;&quot;&quot;
    pass
</code></pre>
<p>I'll take a look and see if I can figure out what's swallowing line endings. When I add a test with <code>line-ending = &quot;CarriageReturnLineFeed&quot;</code>, the resulting snapshot does not contain CRLF line endings, but LF only.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_python_formatter/src/expression/string.rs</code>:1217 on 2023-11-22 15:57</div>
            <div class="timeline-body"><p>Take a look at the <code>.gitattributes</code> in the repo root. I believe we normalize to LF except in explicit cases.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-11-22 15:57</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2023-11-22 16:18</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/ruff_workspace/src/settings.rs</code>:130 on 2023-11-22 16:18</div>
            <div class="timeline-body"><p>I was okay with this on the first read, but on a second, I think <code>docstring_code = true | false</code> doesn't have enough meaning alone. Perhaps <code>format_docstring_code</code> would make sense? I also don't mind <code>include_docstring_code</code> but it's not necessarily clear what inclusion means.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2023-11-22 16:19</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/ruff_python_formatter/src/expression/string.rs</code>:1196 on 2023-11-22 16:19</div>
            <div class="timeline-body"><p>Seems really reasonable to move the warning macros unless it's infeasible for some reason. A warning seems better than silence â€” I'd be happy with a new issue to add it later.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ruff_workspace/src/settings.rs</code>:130 on 2023-11-22 16:29</div>
            <div class="timeline-body"><p>Yeah I hadn't gone with <code>format_docstring_code</code> since the option exists in the context of a formatter. But I think I do like that better than <code>include_docstring_code</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2023-11-22 16:29</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2023-11-22 16:30</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ruff_python_formatter/src/expression/string.rs</code>:1217 on 2023-11-22 16:30</div>
            <div class="timeline-body"><p>Ahhhhhhhhhh right. Forgot about <code>.gitattributes</code>. That's it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2023-11-22 16:56</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/ruff_python_formatter/resources/test/fixtures/ruff/docstring_code_examples.py</code>:199 on 2023-11-22 16:56</div>
            <div class="timeline-body"><p>A separate setting <em>might</em> make sense e.g. <code>docstring_code_line_width</code>. I can see arguments for both sides. For me, I care more about a reasonable width in my reference documentation generated from my docstrings and would be okay with starting on the first column.</p>
<p>On a slightly separate note, <code>docstring_code_...</code> settings suggest that <code>docstring_code_enabled</code> may be a better name for toggling this behavior?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2023-11-22 17:01</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ruff_python_formatter/resources/test/fixtures/ruff/docstring_code_examples.py</code>:199 on 2023-11-22 17:01</div>
            <div class="timeline-body"><p>Yeah, that's a good point.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ruff_python_formatter/resources/test/fixtures/ruff/docstring_code_examples.py</code>:199 on 2023-11-22 17:24</div>
            <div class="timeline-body"><p>OK, here is what I suggest:</p>
<ul>
<li>We keep the current behavior which treats the code snippet as starting at column 1. This I think aligns with what @zanieb said about prioritizing the display of the code snippet.</li>
<li>We create an issue tracking a new feature for overriding this behavior to do something different.</li>
</ul>
<p>Probably <code>docstring_code_line_width</code> would be a good thing to add, but I think there's also a different mode of &quot;respect the top-level line width setting.&quot; I don't think you can get that behavior by specifying a distinct concrete docstring code line width, since the formatter needs to take indentation into account.</p>
<p>So basically, there's some implementation work here to change the behavior and also some decisions that need to be made about how we present this behavior.</p>
<p>If this sounds good to y'all I can create a new issue capturing this.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2023-11-22 17:24</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-11-22 17:26</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_python_formatter/resources/test/fixtures/ruff/docstring_code_examples.py</code>:199 on 2023-11-22 17:26</div>
            <div class="timeline-body"><p>I think it's reasonable to proceed with the current behavior and see how it lands with users. We can wait for feedback before prioritizing any further changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-11-22 17:31</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_workspace/src/settings.rs</code>:130 on 2023-11-22 17:31</div>
            <div class="timeline-body"><p>I still feel like none of these are quite right (the docstring itself <em>is</em> code)... It's a really hard thing to convey succinctly. I wish we could do <code>format_doctests</code> but this needs to generalize to embedded Markdown and rST. Is <code>format_docstring_snippets</code> clearer or worse? (At the end of the day, I can live with <code>format_docstring_code</code>.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2023-11-22 18:06</div>
            <div class="timeline-body"><p>I ran the docstring code formatter on CPython (after formatting the code <em>without</em> docstring code formatting enabled) and put the results in one commit: https://github.com/BurntSushi/cpython/commit/19d1c85db9c862172f0cffd0872a942aef26d934</p>
<p>I did a quick pass through them and everything looks like it passes the eyeball test. My next step is to make sure the doctests still run and pass.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2023-11-22 19:00</div>
            <div class="timeline-body"><blockquote>
<p>My next step is to make sure the doctests still run and pass.</p>
</blockquote>
<p>I checked out the <code>main</code> branch of CPython and built it:</p>
<pre><code>$ export CFLAGS=&quot;${CFLAGS/-O2/-O3} -ffat-lto-objects&quot;
$ ./configure --prefix=/usr \
              --enable-shared \
              --with-computed-gotos \
              --enable-optimizations \
              --with-lto \
              --enable-ipv6 \
              --with-system-expat \
              --with-dbmliborder=gdbm:ndbm \
              --with-system-libmpdec \
              --enable-loadable-sqlite-extensions \
              --without-ensurepip \
              --with-tzpath=/usr/share/zoneinfo
$ LC_CTYPE=en_US.UTF-8 make -j8 EXTRA_CFLAGS=&quot;$CFLAGS&quot;
</code></pre>
<p>Then confirmed that I could run some doctests:</p>
<pre><code>$ ./python -m doctest Lib/ipaddress.py -v
</code></pre>
<p>And some of that failed, but the <a href="https://github.com/BurntSushi/cpython/commit/19d1c85db9c862172f0cffd0872a942aef26d934#diff-f67a8b5be6bdc48383d2ab907325a4c75ef998fa7cd0bba382ec2efa7e4f00b5R204-R205jj"><code>summarize_address_range</code></a> doctest passed.</p>
<p>Then I checked out my branch with the reformatted code snippets and re-ran the above. The results remain unchanged.</p>
<p>So at least in that one specific case that looked potentially odd, reformatting didn't break the doctest. (Specifically, the doctest directive in this example is still picked up.)</p>
<p>I haven't been able to figure out how to run all of the doctests yet though.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff_python_formatter/tests/normalizer.rs</code>:19 on 2023-11-23 11:23</div>
            <div class="timeline-body"><blockquote>
<p>This changes the AST normalizer to remove anything that looks like a
code snippet.</p>
</blockquote>
<p>Could we instead remove docstrings from the equality check?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff_workspace/src/options.rs</code>:2831 on 2023-11-23 11:31</div>
            <div class="timeline-body"><p>I think i'd want an option (opt-in) that requires examples to be at least valid python. Maybe a <code>docstring-code</code> variant for <code>always</code> or <code>enforce</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff_workspace/src/settings.rs</code>:130 on 2023-11-23 11:34</div>
            <div class="timeline-body"><p>Adding <code>format_embedded</code> to the list of options.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff_python_formatter/src/expression/string.rs</code>:1079 on 2023-11-23 11:46</div>
            <div class="timeline-body"><p>Taking micha's role here: This should not reference the <code>Formatter</code> but instead <code>impl Format&lt;PyFormatContext&lt;'_&gt;&gt; for DocstringLinePrinter&lt;'_&gt;</code>, or take the formatter as an argument in the print functions.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff_python_formatter/src/expression/string.rs</code>:1196 on 2023-11-23 12:34</div>
            <div class="timeline-body"><p>Strongly prefer showing a warning over failing silently</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff_python_formatter/src/expression/string.rs</code>:1229 on 2023-11-23 12:43</div>
            <div class="timeline-body"><p>We should create an issue for removing this, parsing twice every time seems wasteful</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> approved on 2023-11-23 12:44</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2023-11-27 14:48</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ruff_python_formatter/resources/test/fixtures/ruff/docstring_code_examples.py</code>:199 on 2023-11-27 14:48</div>
            <div class="timeline-body"><p>So one thing I uncovered today is that by allowing docstring lines to exceed the globally configured line width, you wind up with linter errors on long lines. For example, after running the docstring code snippet formatter on polars: https://github.com/BurntSushi/polars/actions/runs/7006619426/job/19058868021?pr=1</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2023-11-27 14:52</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ruff_python_formatter/tests/normalizer.rs</code>:19 on 2023-11-27 14:52</div>
            <div class="timeline-body"><p>I think we could, but I think that would potentially reduce the effectiveness of the test. Today, we still test that the substance of the docstring remains the same (modulo whitespace and code snippets). But if we just removed docstrings entirely, we wouldn't be checking anything.</p>
<p>I don't feel too strongly personally.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ruff_workspace/src/options.rs</code>:2831 on 2023-11-27 14:54</div>
            <div class="timeline-body"><p>My first instinct here is that that would be more of a lint then a formatting option. I'm not sure though.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2023-11-27 14:54</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2023-11-27 14:56</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ruff_python_formatter/src/expression/string.rs</code>:1079 on 2023-11-27 14:56</div>
            <div class="timeline-body"><p>Can you say more? I'm not sure I follow. The <code>DocstringLinePrinter</code> is basically one big logical function call split up into several actual function calls.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @BurntSushi on 2023-11-27 15:16</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2023-11-27 15:39</div>
            <div class="timeline-body"><p>I've split the commit that adds a user facing config option out into #8854 so that we should be able to merge this PR without any user facing changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2023-11-27 16:01</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ruff_python_formatter/resources/test/fixtures/ruff/docstring_code_examples.py</code>:199 on 2023-11-27 16:01</div>
            <div class="timeline-body"><p>Issue created: https://github.com/astral-sh/ruff/issues/8855</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2023-11-27 16:01</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ruff_workspace/src/settings.rs</code>:130 on 2023-11-27 16:01</div>
            <div class="timeline-body"><p>PR for the user facing change created (and removed from this PR): https://github.com/astral-sh/ruff/pull/8854</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2023-11-27 16:05</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ruff_python_formatter/src/expression/string.rs</code>:1196 on 2023-11-27 16:05</div>
            <div class="timeline-body"><p>Issue created: https://github.com/astral-sh/ruff/issues/8856</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2023-11-27 16:08</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ruff_workspace/src/options.rs</code>:2831 on 2023-11-27 16:08</div>
            <div class="timeline-body"><p>Carried this over to #8854: https://github.com/astral-sh/ruff/pull/8854#issuecomment-1828141780</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2023-11-27 16:12</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ruff_python_formatter/src/expression/string.rs</code>:1229 on 2023-11-27 16:12</div>
            <div class="timeline-body"><p>Done https://github.com/astral-sh/ruff/issues/8857</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2023-11-27 16:14</div>
            <div class="timeline-body"><p>All righty, I've filed issues for problems that probably aren't blocking this PR being merged:</p>
<ul>
<li>https://github.com/astral-sh/ruff/issues/8855</li>
<li>https://github.com/astral-sh/ruff/issues/8856</li>
<li>https://github.com/astral-sh/ruff/issues/8857</li>
<li>https://github.com/astral-sh/ruff/issues/8860</li>
<li>https://github.com/astral-sh/ruff/issues/8859</li>
</ul>
<p>I'm going to go ahead and merge this PR. I'd be happy to address any other feedback folks might have!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @BurntSushi on 2023-11-27 16:14</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @BurntSushi on 2023-11-27 16:14</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2023-11-27 16:14</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/tests/normalizer.rs</code>:81 on 2023-11-27 23:59</div>
            <div class="timeline-body"><p>It may be helpful to replace the code snippets with a constant instead, e.g <code>&lt;CODE_SNIPPED: Removed by </code>Normalizer<code>&gt;</code>. It may otherwise be confusing if the AST comparison fails on a docstring that doesn't exist in the source code.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/expression/string.rs</code>:1079 on 2023-11-28 00:04</div>
            <div class="timeline-body"><p>I think the way it is implemented is fine, considering that <code>print</code> takes <code>lines</code> as an argument.</p>
<p>The alternative (that @konstin) suggested is to instead pass <code>lines</code> to the <code>DocstringLinePrinter</code> constructor and implement <code>Format</code> for <code>DocstringLinePrinter</code>. I would then probably rename the struct to <code>DocstringLines</code>, because it is now a struct that knows how to format itself.</p>
<p>However, I believe the problem with that is that <code>Format::format</code> takes <code>&amp;self</code> and not <code>&amp;mut self</code>, making it impossible for the printer to update its internal fields (without using internal mutability)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/expression/string.rs</code>:1278 on 2023-11-28 00:12</div>
            <div class="timeline-body"><p>It took me a while to understand when the line is owned or borrowed although it is well documented. It may help to repeat the struct documentation in a short form:</p>
<p>The actual text (Borrowed: original line in the source, Owned: formatted line) of the line</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/expression/string.rs</code>:1383 on 2023-11-28 00:14</div>
            <div class="timeline-body"><p>Could we add a link to where this regex can be found?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/expression/string.rs</code>:1394 on 2023-11-28 00:16</div>
            <div class="timeline-body"><p>Future perf improvement: Represent as an enum with <code>Tabs(count)</code>, <code>Spaces(count)</code>, and <code>Mixed(String)</code> to avoid allocating for each formatted line.</p>
<p>Or could the indent be a <code> &amp;'a str</code> because it is the indent observed from the source text?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/expression/string.rs</code>:1453 on 2023-11-28 00:24</div>
            <div class="timeline-body"><p>Should <code>Ignore</code> be the <code>Print</code> action? Maybe use <a href="CodeExampleAddAction::Print"><code>Ignore</code></a> so that rustfmt can point out the invalid refernece.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/expression/string.rs</code>:1364 on 2023-11-28 00:25</div>
            <div class="timeline-body"><p>What's the reason for converting these to <code>String</code> rather than storing borrowed <code>&amp;str</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/expression/string.rs</code>:1497 on 2023-11-28 00:28</div>
            <div class="timeline-body"><p>I addmit I haven't read the code in full, but would it be sufficient to check if the indents have the same column/character length as done in the Lexer or is it necessary that the strings match exactly?</p>
<p>See <a href="https://github.com/astral-sh/ruff/blob/8ce138760a182b4765fa6f57b865fe6e9507f41e/crates/ruff_python_parser/src/lexer/indentation.rs#L35-L80"><code>Indentation</code></a> in our lexer.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/expression/string.rs</code>:1217 on 2023-11-28 00:36</div>
            <div class="timeline-body"><p>How about line endings inside of multiline strings? Ideally, we would preserve these. Although we may deliberately decide not to and encourage users to instead use explicit line endings. But changing the line endings inside of strings is theoretically a semantic change.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/expression/string.rs</code>:1240 on 2023-11-28 00:37</div>
            <div class="timeline-body"><p>Could we short-circuit if the source string doesn't contain any triple quotes (or escaped triple quotes)?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-11-28 00:39</div>
            <div class="timeline-body"><p>Thanks for writing the excellent documentation and organizing your commits so thoughtfully. It helped a lot when reviewing the PR (also to find savepoints when being interrupted)</p>
<p>Really impressive work. Well done. I've a few smaller comments. The most important one from a correctness point of view is the handling of newlines inside of multiline strings.</p>
<p>I think I'll learn many new English words from your commit messages ðŸ˜†. So far:</p>
<ul>
<li>rejigger</li>
<li>grok</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2023-11-28 16:22</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ruff_python_formatter/tests/normalizer.rs</code>:81 on 2023-11-28 16:22</div>
            <div class="timeline-body"><p>Yeah I agree that would be nice. I tried it out and unfortunately it's a little tricky to get this right with a non-empty replacement string. I believe the issue here is that reformatting a code snippet can result in more (or fewer) PS2 lines, which in turn means that we'll get more (or fewer) <code>&lt;CODE_SNIPPET: ...&gt;</code> replacements.</p>
<p>I could change the regex to try to match all PS1 and PS2 prompts within a single snippet and replace it in bulk... Hmmm... Let me try that. OK, that was easy. Hah.</p>
<p>Good suggestion!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ruff_python_formatter/src/expression/string.rs</code>:1079 on 2023-11-28 16:25</div>
            <div class="timeline-body"><p>Aye. I also expect this abstraction to get mangled and refactored at some point in the future. Namely, I expect that it will become useful to have &quot;look for Python code snippets&quot; logic outside of the context of the Python formatter. That is to say, I don't expect this is its final form. :-)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2023-11-28 16:25</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2023-11-28 16:27</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ruff_python_formatter/src/expression/string.rs</code>:1278 on 2023-11-28 16:27</div>
            <div class="timeline-body"><p>Love it. Good catch.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2023-11-28 16:29</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ruff_python_formatter/src/expression/string.rs</code>:1383 on 2023-11-28 16:29</div>
            <div class="timeline-body"><p>There are some links further down in the actual doctest parsing code, but I've added another one here.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2023-11-28 16:32</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ruff_python_formatter/src/expression/string.rs</code>:1394 on 2023-11-28 16:32</div>
            <div class="timeline-body"><p>I believe the indent could indeed be a <code>&amp;'src str</code> here, but I went with the simpler approach because the extra allocation here seems marginal to me. We're already allocating other stuff, invoking the formatter and so on.</p>
<p>The reason why I chose to thread through a lifetime parameter for <code>DocstringLine</code> (and not here) is that it gets created for every line in every docstring, regardless of whether there is a code snippet. So I wanted to be a little more cautious there. But by the time we create an <code>indent</code> string, we've already (very likely) committed ourselves to a bunch of extra costs too.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2023-11-28 16:34</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ruff_python_formatter/src/expression/string.rs</code>:1453 on 2023-11-28 16:34</div>
            <div class="timeline-body"><p>Yup, good catch. I had originally named it <code>Ignore</code> but thought better of it. Forgot to update the docs referring to it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2023-11-28 16:37</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ruff_python_formatter/src/expression/string.rs</code>:1364 on 2023-11-28 16:37</div>
            <div class="timeline-body"><p>In addition to <a href="https://github.com/astral-sh/ruff/pull/8811#discussion_r1408057410">my other answer</a>, at least with respect to <code>code</code>, I think when I was writing the types it wasn't obvious to me that the code portion of a line would necessarily be a proper substring of it. But I can't think of any contrary case.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2023-11-28 16:43</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ruff_python_formatter/src/expression/string.rs</code>:1497 on 2023-11-28 16:43</div>
            <div class="timeline-body"><p>The Python <code>doctest</code> module actually requires that the indent be made purely of ASCII space characters. Then it somewhat circuitously takes the length of the indentation in characters, reconstitutes the indentation as a string and then checks that all PS2 prompt lines have the same indentation prefix: https://github.com/python/cpython/blob/0ff6368519ed7542ad8b443de01108690102420a/Lib/doctest.py#L727-L733</p>
<p>Technically we are a little more relaxed here because we allow any kind of whitespace in the indentation. But I preserved the &quot;indentation should be byte-for-byte equivalent&quot; check.</p>
<p>So bottom line is that it's hard for me to say whether this is necessary or not. Probably not. But I do think it is pretty simple? Are you concerned about the costs of carrying the indentation string around? I think for code snippet formatting it is probably a lot less of a concern than when parsing arbitrary Python. The size scales are different.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ruff_python_formatter/src/expression/string.rs</code>:1217 on 2023-11-28 16:46</div>
            <div class="timeline-body"><p>I think Charlie had a similar comment above. The thinking here is that while I'm using <code>\n</code> to assemble a code snippet, that snippet is then fed into the formatter and the line endings used correspond to the user's setting. There is a test for example that this writes out CRLF line endings in code snippets when the user has configured CRLF line endings.</p>
<p>Did I understand you concern correctly here? I feel like I might be missing it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2023-11-28 16:46</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2023-11-28 16:47</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ruff_python_formatter/src/expression/string.rs</code>:1217 on 2023-11-28 16:47</div>
            <div class="timeline-body"><p>Also, there are places in the docstring handling (that existed before my changes) that seem to assume line feed terminators? For example:</p>
<p>https://github.com/astral-sh/ruff/blob/2ade84a29de99eafbac23ef4c6dc9cdf1101e014/crates/ruff_python_formatter/src/expression/string/docstring.rs#L237-L238</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ruff_python_formatter/src/expression/string.rs</code>:1240 on 2023-11-28 16:48</div>
            <div class="timeline-body"><p>Yeah I think you mentioned this in the tracking issue for this. I <em>think</em> you're correct. And if so, yes, I believe we could short circuit. I'm not sure though if we want to keep this check as-is here for now as a conservative posture.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2023-11-28 16:48</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-11-28 23:33</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/expression/string.rs</code>:1217 on 2023-11-28 23:33</div>
            <div class="timeline-body"><p>Yeah, I think the problem is not new due to your changes. It only became evident that this might now be a problem when thinking about code snippets in docstrings (it shouldn't be a problem for non-code text).</p>
<pre><code class="language-python">a = &quot;&quot;&quot;A multiline string
with windows line endings
&quot;&quot;&quot;

b = c
</code></pre>
<img width="859" alt="Screenshot 2023-11-29 at 07 23 49" src="https://github.com/astral-sh/ruff/assets/1203881/f6eb79e4-0844-486a-bb95-046de837fd6d">

<p>My concern is (was) that changing the newlines <strong>inside</strong> of the multiline string could be a semantic change. I tried to read through the Python documentation and only found:</p>
<blockquote>
<p>In triple-quoted literals, unescaped newlines and quotes are allowed (and are retained), except that three unescaped quotes in a row terminate the literal. (A â€œquoteâ€ is the character used to open the literal, i.e. either ' or &quot;.) <a href="https://docs.python.org/3/reference/lexical_analysis.html#string-and-bytes-literals">source</a></p>
</blockquote>
<p>What I understand from the spec is that newlines are retained. Although running the above in a <code>print</code> on my mac normalizes the newlines to <code>\n</code>.</p>
<p>I then tested what the about for</p>
<pre><code class="language-python">a = b&quot;&quot;&quot;A multiline string
with windows line endings
&quot;&quot;&quot;

from binascii import hexlify

print(hexlify(a))
</code></pre>
<p>and it seems python normalizes the newlines even for binary strings to <code>\n</code>. So the retain only means that the newlines are preserved but not in the form they're present in the source code.</p>
<p>So I guess this is not a problem after all (and ruff and Black both normalize newlines inside multiline strings)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/expression/string.rs</code>:1497 on 2023-11-28 23:35</div>
            <div class="timeline-body"><p>I was mainly trying to understand the semantics to ensure we are as strict as Python when it comes to handling indentation. Thanks for the explanation.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-11-28 23:35</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/expression/string.rs</code>:1240 on 2023-11-28 23:37</div>
            <div class="timeline-body"><p>Understood. My only concern is performance because our parser isn't very fast today (I believe it's about 30% or more of the overall formatting time). An alternative could be to only lex the code and see if there are any lexer errors. But I don't know if that's sufficient to detect the kind of errors that could be introduced.</p>
<p>But agree, I don't think it's a high priority. Just trying to brainstorm a few ideas with the hope that there might be a low hanging perf improvement.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-11-28 23:37</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/JacobCoffee">@JacobCoffee</a> on 2023-12-13 20:37</div>
            <div class="timeline-body"><p>~Can #3792, #8237 be closed then?~
Oh i see,</p>
<blockquote>
<p>This reflects initial support and it is intended to add support for Markdown and reStructuredText Python code blocks in the future.</p>
</blockquote>
<p>ðŸ”œ â„¢ï¸</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2023-12-14 12:49</div>
            <div class="timeline-body"><p>@JacobCoffee Yeah I think those issues are about applying <code>ruff</code> to Python code in contexts other than Python source files. Like <code>.md</code> or <code>.rst</code> files. And I think it also applies to <code>ruff</code> generally and not just <code>ruff format</code>.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 23:31:43 UTC
    </footer>
</body>
</html>
