<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[syntax-errors] Improve error message and range for pre-PEP-614 decorator syntax errors - astral-sh/ruff #16581</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[syntax-errors] Improve error message and range for pre-PEP-614 decorator syntax errors</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/16581">#16581</a>
        opened by <a href="https://github.com/AlexWaygood">@AlexWaygood</a>
        on 2025-03-09 22:32
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-03-09 22:32</div>
            <div class="timeline-body"><h2>Summary</h2>
<p>A small followup to https://github.com/astral-sh/ruff/pull/16386. We now tell the user exactly what it was about their decorator that constituted invalid syntax on Python &lt;3.9, and the range now highlights the specific sub-expression that is invalid rather than highlighting the whole decorator</p>
<h2>Test Plan</h2>
<p>Inline snapshots are updated, and new ones are added.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">parser</span> added by @AlexWaygood on 2025-03-09 22:32</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @AlexWaygood on 2025-03-09 22:32</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @dhruvmanila by @AlexWaygood on 2025-03-09 22:32</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @ntBre by @AlexWaygood on 2025-03-09 22:32</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">preview</span> added by @AlexWaygood on 2025-03-09 22:33</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-03-09 22:43</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Formatter (stable)</h3>
<p>✅ ecosystem check detected no format changes.</p>
<h3>Formatter (preview)</h3>
<p>✅ ecosystem check detected no format changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> approved on 2025-03-09 23:53</div>
            <div class="timeline-body"><p>This is great, thank you!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-03-10 00:03</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_python_parser/src/error.rs</code>:642 on 2025-03-10 00:03</div>
            <div class="timeline-body"><p>This is a very minor nit since I don't think this is ever likely to change, but you <em>could</em> use <code>self.kind.changed_version()</code> for the &quot;added in Python 3.9&quot; part if you wanted to mirror the other <code>write!</code> call. I'm happy with the current version too though.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_parser/src/parser/helpers.rs</code>:55 on 2025-03-10 08:45</div>
            <div class="timeline-body"><p>Nit: The function name suggests that it returns a node where, in fact, it returns a message and a range.</p>
<p>I think we should either change the method to return a <code>Option&lt;&amp;Expr&gt;</code> with a second method that allows deriving a display name for the expression or rename the method</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-03-10 08:45</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-03-10 08:45</div>
            <div class="timeline-body"><p>@ntBre and I discussed this and we deliberately decided against it because:</p>
<ul>
<li>It introduces more complexity and an extra cost for every added syntax</li>
<li>It seems low priority considering that &lt; Py39 is end of life</li>
</ul>
<p>I'm not opposed to this change. I just want to make clear that we deliberately decided against it because we wanted to focus our time on higher priority syntax errors and reduce complexity</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2025-03-10 10:25</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_python_parser/tests/snapshots/invalid_syntax@decorator_await_expression_py38.py.snap</code>:94 on 2025-03-10 10:25</div>
            <div class="timeline-body"><p>I actually find the &quot;outside function-call arguments in a decorator&quot; part a bit confusing because it made me think that this is only allowed in function-call arguments. I'd possibly remove it and keep it simply &quot;Cannot use <code>await</code> expression in a decorator on Python 3.8 ...&quot; but then the message cannot be used in a general way because, in this example, the <code>await</code> expression is only not allowed at the top-level (<code>@(await x)</code>) while <code>@decorator(await x)</code> would be ok.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2025-03-10 10:47</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-03-10 11:46</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_python_parser/src/error.rs</code>:642 on 2025-03-10 11:46</div>
            <div class="timeline-body"><p>hmm, yeah. I did it this way because it seemed like a little less indirection. But your suggestion is probably better because it encodes in exactly one place the version the syntax was added in</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-03-10 13:28</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_python_parser/tests/snapshots/invalid_syntax@decorator_await_expression_py38.py.snap</code>:94 on 2025-03-10 13:28</div>
            <div class="timeline-body"><p>Oh, I see. So you interpreted &quot;outside function-call arguments&quot; as meaning &quot;If I add parentheses, it will be valid syntax&quot;?</p>
<p>Hmm, I'm not sure how to clarify that :/ adding the parentheses <em>doesn't</em> make it a function call -- but I can see how a beginner might find the language confusing. Would you find &quot;outside call expression arguments&quot; any clearer?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @AlexWaygood on 2025-03-17 11:17</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @AlexWaygood on 2025-03-17 11:17</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-03-17 11:17</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2025-03-17 11:26</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_python_parser/tests/snapshots/invalid_syntax@decorator_await_expression_py38.py.snap</code>:94 on 2025-03-17 11:26</div>
            <div class="timeline-body"><p>Sorry for the late reply, what I thought it could be interpreted is related to the function that's being decorated and not the decorator itself. But, I think what you've is fine as well. We can iterate if anyone finds it confusing.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 19:49:32 UTC
    </footer>
</body>
</html>
