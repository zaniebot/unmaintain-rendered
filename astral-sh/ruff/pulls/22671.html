<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>`scripts/conformance.py`: fix collection of diagnostics - astral-sh/ruff #22671</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1><code>scripts/conformance.py</code>: fix collection of diagnostics</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/22671">#22671</a>
        opened by <a href="https://github.com/AlexWaygood">@AlexWaygood</a>
        on 2026-01-18 00:47
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a></div>
            <div class="timeline-body"><h2>Summary</h2>
<p>There were two issues with how the script was collecting diagnostics:</p>
<ul>
<li>It was using the pattern <code>path.rglob(&quot;*.py&quot;)</code> to find what the expected diagnostics were, but some tests in the conformance suite use <code>.pyi</code> files.</li>
<li>It was running ty on the whole <code>conformance/tests</code> directory, and reporting all ty errors on that directory that weren't accompanied by <code># E</code> comments as being false positives. But some of the files in that directory (in particular, all files starting with a leading underscore) are not actually test files -- they're just &quot;supporting&quot; files that are imported by the test files. Diagnostics on these files should not be considered as false positives.</li>
</ul>
<h2>Test Plan</h2>
<p>I commented out this section of the script on <code>main</code>:</p>
<pre><code class="language-diff">diff --git a/scripts/conformance.py b/scripts/conformance.py
index 00cbe69181..055aa2801e 100644
--- a/scripts/conformance.py
+++ b/scripts/conformance.py
@@ -537,14 +537,14 @@ def render_summary(grouped_diagnostics: list[GroupedDiagnostics]):
 
     base_header = f&quot;[Typing conformance results]({CONFORMANCE_DIR_WITH_README})&quot;
 
-    if all(diag.change is Change.UNCHANGED for diag in grouped_diagnostics):
-        return dedent(
-            f&quot;&quot;&quot;
-            ## {base_header}
-
-            No changes detected âœ…
-            &quot;&quot;&quot;
-        )
+    # if all(diag.change is Change.UNCHANGED for diag in grouped_diagnostics):
+    #     return dedent(
+    #         f&quot;&quot;&quot;
+    #         ## {base_header}
+
+    #         No changes detected âœ…
+    #         &quot;&quot;&quot;
+    #     )
 
     true_pos_diff = diff_format(true_pos_change, greater_is_better=True)
     false_pos_diff = diff_format(false_pos_change, greater_is_better=False)
</code></pre>
<p>and then ran <code>uv run --no-project scripts/conformance.py --old-ty=./target/debug/ty --new-ty=./target/debug/ty --tests-path=../typing/conformance/tests</code>, with this result:</p>
<hr />
<h2><a href="https://github.com/python/typing/blob/main/conformance/">Typing conformance results</a></h2>
<p>The percentage of diagnostics emitted that were expected errors held steady at 75.87%. The percentage of expected errors that received a diagnostic held steady at 60.50%.</p>
<h3>Summary</h3>
<p>| Metric | Old | New | Diff | Outcome |
|--------|-----|-----|------|---------|
| True Positives  | 654 | 654 | +0 |  |
| False Positives | 208 | 208 | +0 |  |
| False Negatives | 427 | 427 | +0 |  |
| Total Diagnostics | 862 | 862 | +0 |  |
| Precision | 75.87% | 75.87% | +0.00% |  |
| Recall | 60.50% | 60.50% | +0.00% |  |</p>
<hr />
<p>I then checked out this branch, applied the same patch above, and ran the same command, with this result:</p>
<hr />
<h2><a href="https://github.com/python/typing/blob/main/conformance/">Typing conformance results</a></h2>
<p>The percentage of diagnostics emitted that were expected errors held steady at 77.13%. The percentage of expected errors that received a diagnostic held steady at 59.50%.</p>
<h3>Summary</h3>
<p>| Metric | Old | New | Diff | Outcome |
|--------|-----|-----|------|---------|
| True Positives  | 661 | 661 | +0 |  |
| False Positives | 196 | 196 | +0 |  |
| False Negatives | 450 | 450 | +0 |  |
| Total Diagnostics | 857 | 857 | +0 |  |
| Precision | 77.13% | 77.13% | +0.00% |  |
| Recall | 59.50% | 59.50% | +0.00% |  |</p>
<hr />
<p>These are results consistent with what I'd expect given that errors on files beginning with <code>_</code> are now not considered false positives, and given that <code># E</code> comments on <code>.pyi</code> files are now collected as error assertions.</p>
<p>Cc. @WillDuke, if you have time to review ðŸ˜ƒ (obviously no obligation to!)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ci</span> added by @AlexWaygood on 2026-01-18 00:47</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ty</span> added by @AlexWaygood on 2026-01-18 00:47</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/astral-sh-bot[bot]">@astral-sh-bot[bot]</a> on 2026-01-18 00:48</div>
            <div class="timeline-body"><!-- generated-comment typing_conformance_diagnostics_diff -->

<h2><a href="https://github.com/python/typing/blob/9f6d8ced7cd1c8d92687a4e9c96d7716452e471e/conformance/">Typing conformance results</a></h2>
<p>No changes detected âœ…</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/astral-sh-bot[bot]">@astral-sh-bot[bot]</a> on 2026-01-18 00:59</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>âœ… ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>âœ… ecosystem check detected no linter changes.</p>
<h3>Formatter (stable)</h3>
<p>âœ… ecosystem check detected no format changes.</p>
<h3>Formatter (preview)</h3>
<p>âœ… ecosystem check detected no format changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>scripts/conformance.py</code>:300 on 2026-01-18 10:45</div>
            <div class="timeline-body"><p>I'm surprised that Python's globbing doesn't support multiple extensions, e.g. <code>.{py,pyi}</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>scripts/conformance.py</code>:303 on 2026-01-18 10:47</div>
            <div class="timeline-body"><p>Should we skip files starting with an <code>_</code>? I assume it's not strictly necessary, since they never contain any comments matching the error pattern but it feels unnecessary</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>scripts/conformance.py</code>:355 on 2026-01-18 10:47</div>
            <div class="timeline-body"><p>Should we create a helper method that, given a path, returns whether this is a conformance test file?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2026-01-18 10:47</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2026-01-18 11:47</div>
            <div class="timeline-body"><p>I've added helper functions that use the same logic as in the upstream <code>python/typing</code> repo to determine whether a file is a test file or not. I've also added a <code>--force-summary-table</code> CLI option so that it's easier to test and debug changes like this in the future (or to see where our latest conformance results are at, outside of the context of a PR that attempts to improve those results).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @AlexWaygood on 2026-01-18 11:52</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @AlexWaygood on 2026-01-18 11:52</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2026-01-18 11:52</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/WillDuke">@WillDuke</a> on 2026-01-18 12:43</div>
            <div class="timeline-body"><p>Nice catch, sorry I'm late to the party here!</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-18 13:23:47 UTC
    </footer>
</body>
</html>
