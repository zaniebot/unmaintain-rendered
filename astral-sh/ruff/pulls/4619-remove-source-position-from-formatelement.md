```yaml
number: 4619
title: "Remove source position from `FormatElement::DynamicText`"
type: pull_request
state: merged
author: MichaReiser
labels:
  - internal
  - formatter
assignees: []
merged: true
base: main
head: dynamic-text-element-remove-position
created_at: 2023-05-24T07:46:01Z
updated_at: 2023-05-24T14:50:04Z
url: https://github.com/astral-sh/ruff/pull/4619
synced_at: 2026-01-12T15:55:16Z
```

# Remove source position from `FormatElement::DynamicText`

---

_@MichaReiser_

## Summary

This PR removes the `source_position` from the `DynamicText` because it isn't always possible (at least in Ruff) to know the source position for dynamically formatted texts. We now used to pass `TextSize::default` which is incorrect because it will create source mappings from position `0` to the position in the output document, which is obviously incorrect and may drip over consumers of the source map. 

Providing source position information for `dynamic_text`s is still encouraged. That's why I leave the `source_position` on the `dynamic_text` builder as an `Optional` argument. The builder emits the new  `FormatElement::SourcePosition` element if the position is set. 

I decided to introduce the new `FormatElement::SourcePosition` in favor of changing the `position` field on `DynamicText` to `Option<TextSize>` because of:

* Having a dedicated IR element allows us to emit source positions at the start and end of every node even if we don't have a token.
* Changing the field to `Option<TextSize>` on `DynamicText` increases the field from 4 to 8 bytes so that `DynamicText` takes 24 bytes in total. This will prevent us from reducing our `FormatElement` back to 24 bytes again.

## Test Plan

I ran the formatter tests and added a new doctest for the new source position element

---

_Comment by @MichaReiser on 2023-05-24 07:46_

Current dependencies on/for this PR:
* main
  * **PR #4619** <a href="https://app.graphite.dev/github/pr/charliermarsh/ruff/4619" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a>  ðŸ‘ˆ
    * **PR #4622** <a href="https://app.graphite.dev/github/pr/charliermarsh/ruff/4622" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a> 
      * **PR #4632** <a href="https://app.graphite.dev/github/pr/charliermarsh/ruff/4632" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a> 

This comment was auto-generated by [Graphite](https://app.graphite.dev/github/pr/charliermarsh/ruff/4619?utm_source=stack-comment).

---

_@MichaReiser reviewed on 2023-05-24 07:50_

---

_Review comment by @MichaReiser on `crates/ruff_formatter/src/printer/mod.rs`:325 on 2023-05-24 07:50_

I'm fairly certain that `+= text.text_len()` produces incorrect results for dynamic texts (text that haven't been present in the source code. 

Let's assume that the formatter replaces `"String with useless \' escape"` with "String with useless ' escape". It will now map the source position of the `"` to after the end of the string, which is incorrect. The result is worse if the new text is longer than the original text, because it then  maps the source position past the end of the source-string. 

---

_Review comment by @MichaReiser on `crates/ruff_formatter/src/format_element.rs`:389 on 2023-05-24 08:12_

`assert_eq_size` tells you in the error message the sizes of both structs and doesn't just give you some random const evaluation math error.

---

_@MichaReiser reviewed on 2023-05-24 08:12_

---

_Review comment by @MichaReiser on `crates/ruff_formatter/src/builders.rs`:309 on 2023-05-24 08:13_

There are multiple markers per source position because we need to know where it starts and ends in the formatted document.

---

_@MichaReiser reviewed on 2023-05-24 08:13_

---

_Comment by @github-actions[bot] on 2023-05-24 08:34_

## PR Check Results
### Ecosystem
âœ… ecosystem check detected no changes.

### Benchmark
#### Linux
```
group                                      main                                   pr
-----                                      ----                                   --
linter/all-rules/large/dataset.py          1.00     15.0Â±0.13ms     2.7 MB/sec    1.05     15.7Â±0.07ms     2.6 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      3.6Â±0.00ms     4.6 MB/sec    1.02      3.7Â±0.01ms     4.5 MB/sec
linter/all-rules/numpy/globals.py          1.00    374.8Â±4.77Âµs     7.9 MB/sec    1.01    379.7Â±2.21Âµs     7.8 MB/sec
linter/all-rules/pydantic/types.py         1.00      6.2Â±0.02ms     4.1 MB/sec    1.03      6.5Â±0.01ms     4.0 MB/sec
linter/default-rules/large/dataset.py      1.00      7.4Â±0.02ms     5.5 MB/sec    1.10      8.1Â±0.02ms     5.0 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00   1571.9Â±5.17Âµs    10.6 MB/sec    1.05   1649.5Â±2.97Âµs    10.1 MB/sec
linter/default-rules/numpy/globals.py      1.01    174.9Â±0.30Âµs    16.9 MB/sec    1.00    173.7Â±1.73Âµs    17.0 MB/sec
linter/default-rules/pydantic/types.py     1.00      3.4Â±0.01ms     7.6 MB/sec    1.08      3.6Â±0.01ms     7.1 MB/sec
parser/large/dataset.py                    1.00      5.7Â±0.02ms     7.2 MB/sec    1.01      5.7Â±0.01ms     7.1 MB/sec
parser/numpy/ctypeslib.py                  1.00   1116.5Â±2.13Âµs    14.9 MB/sec    1.01   1130.6Â±6.09Âµs    14.7 MB/sec
parser/numpy/globals.py                    1.00    114.7Â±0.26Âµs    25.7 MB/sec    1.02    116.8Â±0.48Âµs    25.3 MB/sec
parser/pydantic/types.py                   1.00      2.4Â±0.00ms    10.4 MB/sec    1.01      2.5Â±0.00ms    10.4 MB/sec
```

#### Windows
```
group                                      main                                    pr
-----                                      ----                                    --
linter/all-rules/large/dataset.py          1.00     16.0Â±0.09ms     2.5 MB/sec     1.00     16.0Â±0.08ms     2.5 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      4.1Â±0.04ms     4.1 MB/sec     1.00      4.1Â±0.04ms     4.1 MB/sec
linter/all-rules/numpy/globals.py          1.00    480.4Â±6.38Âµs     6.1 MB/sec     1.01    484.4Â±4.64Âµs     6.1 MB/sec
linter/all-rules/pydantic/types.py         1.00      6.7Â±0.05ms     3.8 MB/sec     1.00      6.8Â±0.08ms     3.8 MB/sec
linter/default-rules/large/dataset.py      1.02      8.0Â±0.04ms     5.1 MB/sec     1.00      7.8Â±0.04ms     5.2 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.04  1706.7Â±134.30Âµs     9.8 MB/sec    1.00  1648.7Â±12.71Âµs    10.1 MB/sec
linter/default-rules/numpy/globals.py      1.01    191.3Â±2.03Âµs    15.4 MB/sec     1.00    189.0Â±9.69Âµs    15.6 MB/sec
linter/default-rules/pydantic/types.py     1.00      3.6Â±0.02ms     7.2 MB/sec     1.00      3.6Â±0.09ms     7.1 MB/sec
parser/large/dataset.py                    1.00      6.4Â±0.03ms     6.4 MB/sec     1.00      6.4Â±0.03ms     6.4 MB/sec
parser/numpy/ctypeslib.py                  1.00  1188.6Â±13.30Âµs    14.0 MB/sec     1.00  1187.8Â±21.08Âµs    14.0 MB/sec
parser/numpy/globals.py                    1.00    120.5Â±1.67Âµs    24.5 MB/sec     1.00    120.4Â±1.79Âµs    24.5 MB/sec
parser/pydantic/types.py                   1.01      2.7Â±0.03ms     9.6 MB/sec     1.00      2.7Â±0.02ms     9.6 MB/sec
```
<!-- thollander/actions-comment-pull-request "PR Check Results" -->

---

_Label `internal` added by @MichaReiser on 2023-05-24 09:24_

---

_Label `autoformatter` added by @MichaReiser on 2023-05-24 09:24_

---

_@charliermarsh approved on 2023-05-24 14:26_

Is the source position only used for debugging the formatter IR right now?

---

_Comment by @MichaReiser on 2023-05-24 14:36_

> Is the source position only used for debugging the formatter IR right now?

I don't think it's used at all right now. But we'll need it to support range formatting (to extract the selected range from the formatted document). So I thought I put it in place already :) 

---

_Merged by @MichaReiser on 2023-05-24 14:36_

---

_Closed by @MichaReiser on 2023-05-24 14:36_

---

_Branch deleted on 2023-05-24 14:36_

---
