```yaml
number: 5422
title: Fix invalid printer IR error
type: pull_request
state: merged
author: MichaReiser
labels:
  - formatter
assignees: []
merged: true
base: main
head: create-fix-printer-ir-panic
created_at: 2023-06-28T16:35:26Z
updated_at: 2023-06-29T06:09:14Z
url: https://github.com/astral-sh/ruff/pull/5422
synced_at: 2026-01-12T15:55:18Z
```

# Fix invalid printer IR error

---

_@MichaReiser_

<!--
Thank you for contributing to Ruff! To help us out with reviewing, please consider the following:

- Does this pull request include a summary of the change? (See below.)
- Does this pull request include a descriptive title?
- Does this pull request include references to any relevant issues?
-->

## Summary

This PR fixes an issue where formatting the following expression statement resulted in a `FormatError::InvalidDocument`:

```python
{
    "key": (
        [],
    'a'
        'b'
    'c'
    )
}
```

The root cause for the invalid document was that the new `JoinCommaSeparatedBuilder` always returned `Ok(())` even if the
formatting of an item failed. The fix requires consuming `self.result` and only writing the trailing comma if `result` is `Ok`. 

The fix revealed an error with the implicit string continuation formatting where it returned a `FormatError::SyntaxError` for the above example. 
The cause of this is that we call into the RustPython lexer and start lexing from the start of the string. However, the lexer doesn't know that 
the string is parenthesized. I opted for the fix to ignore any indentation errors because we know that the program lexed without errors once (or we wouldn't have an AST). 


<!-- What's the purpose of the change? What does it do, and why? -->

## Test Plan

I added a new test to the continuation fixture test.

<!-- How was it tested? -->


---

_Comment by @MichaReiser on 2023-06-28 16:35_

Current dependencies on/for this PR:
* main
  * **PR #5422** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/5422" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a>  ðŸ‘ˆ

This comment was auto-generated by [Graphite](https://app.graphite.dev/github/pr/astral-sh/ruff/5422?utm_source=stack-comment).

---

_Comment by @github-actions[bot] on 2023-06-28 16:47_

## PR Check Results
### Ecosystem
âœ… ecosystem check detected no changes.

### Benchmark
#### Linux
```
group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.01      8.3Â±0.01ms     4.9 MB/sec    1.00      8.2Â±0.02ms     4.9 MB/sec
formatter/numpy/ctypeslib.py               1.00   1739.5Â±2.16Âµs     9.6 MB/sec    1.00   1733.8Â±3.12Âµs     9.6 MB/sec
formatter/numpy/globals.py                 1.00    188.5Â±0.27Âµs    15.6 MB/sec    1.00    187.9Â±0.29Âµs    15.7 MB/sec
formatter/pydantic/types.py                1.01      3.9Â±0.01ms     6.5 MB/sec    1.00      3.9Â±0.01ms     6.6 MB/sec
linter/all-rules/large/dataset.py          1.00     13.7Â±0.03ms     3.0 MB/sec    1.01     13.9Â±0.22ms     2.9 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      3.5Â±0.02ms     4.8 MB/sec    1.01      3.5Â±0.03ms     4.7 MB/sec
linter/all-rules/numpy/globals.py          1.00    372.4Â±8.75Âµs     7.9 MB/sec    1.00    371.9Â±3.68Âµs     7.9 MB/sec
linter/all-rules/pydantic/types.py         1.00      6.1Â±0.03ms     4.2 MB/sec    1.00      6.1Â±0.01ms     4.2 MB/sec
linter/default-rules/large/dataset.py      1.00      7.1Â±0.01ms     5.8 MB/sec    1.02      7.2Â±0.02ms     5.7 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00   1478.2Â±2.93Âµs    11.3 MB/sec    1.02   1501.2Â±4.36Âµs    11.1 MB/sec
linter/default-rules/numpy/globals.py      1.00    158.2Â±0.81Âµs    18.7 MB/sec    1.01    159.9Â±4.05Âµs    18.5 MB/sec
linter/default-rules/pydantic/types.py     1.00      3.2Â±0.01ms     8.0 MB/sec    1.02      3.2Â±0.00ms     7.9 MB/sec
```

#### Windows
```
group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.00      9.3Â±0.14ms     4.4 MB/sec    1.00      9.3Â±0.13ms     4.4 MB/sec
formatter/numpy/ctypeslib.py               1.00  1944.3Â±14.43Âµs     8.6 MB/sec    1.01  1963.9Â±112.46Âµs     8.5 MB/sec
formatter/numpy/globals.py                 1.00    212.2Â±3.85Âµs    13.9 MB/sec    1.01   214.2Â±15.92Âµs    13.8 MB/sec
formatter/pydantic/types.py                1.00      4.4Â±0.03ms     5.9 MB/sec    1.01      4.4Â±0.03ms     5.8 MB/sec
linter/all-rules/large/dataset.py          1.01     15.5Â±0.12ms     2.6 MB/sec    1.00     15.4Â±0.10ms     2.6 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.01      4.1Â±0.03ms     4.0 MB/sec    1.00      4.1Â±0.02ms     4.1 MB/sec
linter/all-rules/numpy/globals.py          1.01   432.3Â±10.20Âµs     6.8 MB/sec    1.00    427.4Â±6.23Âµs     6.9 MB/sec
linter/all-rules/pydantic/types.py         1.02      7.0Â±0.06ms     3.7 MB/sec    1.00      6.9Â±0.03ms     3.7 MB/sec
linter/default-rules/large/dataset.py      1.00      8.0Â±0.04ms     5.1 MB/sec    1.00      8.0Â±0.04ms     5.1 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00  1674.5Â±12.95Âµs     9.9 MB/sec    1.00   1667.8Â±9.31Âµs    10.0 MB/sec
linter/default-rules/numpy/globals.py      1.00    178.3Â±1.35Âµs    16.6 MB/sec    1.00    178.3Â±1.71Âµs    16.5 MB/sec
linter/default-rules/pydantic/types.py     1.01      3.7Â±0.01ms     7.0 MB/sec    1.00      3.6Â±0.02ms     7.0 MB/sec
```
<!-- thollander/actions-comment-pull-request "PR Check Results" -->

---

_Review requested from @konstin by @MichaReiser on 2023-06-28 17:00_

---

_Label `formatter` added by @MichaReiser on 2023-06-28 17:01_

---

_@konstin approved on 2023-06-28 19:01_

didn't expect this to be two bugs in a trenchcoat, thanks for the fix

---

_Merged by @MichaReiser on 2023-06-29 06:09_

---

_Closed by @MichaReiser on 2023-06-29 06:09_

---

_Branch deleted on 2023-06-29 06:09_

---
