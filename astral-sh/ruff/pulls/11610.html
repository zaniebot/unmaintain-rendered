<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Consider &quot;gap&quot; between tokens for range query - astral-sh/ruff #11610</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Consider &quot;gap&quot; between tokens for range query</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/11610">#11610</a>
        opened by <a href="https://github.com/dhruvmanila">@dhruvmanila</a>
        on 2024-05-30 05:54
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a></div>
            <div class="timeline-body">Summary
<p>This PR updates the methods on <code>Tokens</code> struct to consider the &quot;gap&quot; between tokens. Additionally, it adds a constraint to the methods which is that the offsets shouldn&#x27;t be within the token range otherwise it&#x27;ll panic.</p>
Test Plan
<p>Add unit test cases.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">parser</span> added by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-05-30 05:54</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/MichaReiser">@MichaReiser</a> by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-05-30 05:54</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/AlexWaygood">@AlexWaygood</a> by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-05-30 06:34</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_parser/src/lib.rs</code>:474 on 2024-05-30 06:55</div>
            <div class="timeline-body"><p>I think the error message here is incorrect. The offset can be between two tokens (it can be inside the gap), but it shouldn&#x27;t be inside a token.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_parser/src/lib.rs</code>:445 on 2024-05-30 06:56</div>
            <div class="timeline-body"><p>I think the error message here is incorrect. The end offset can be in between two tokens (it can fall into a gap), but it should never be inside a token.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_parser/src/lib.rs</code>:470 on 2024-05-30 07:10</div>
            <div class="timeline-body"><p>I think <code>saturating_sub</code> here is incorrect when the file contains a BOM header, in which case the first token starts at offset 1 (or 2?).</p>
<p>For <code>offset == 0</code>:</p>
<ul>
<li><code>start == 0</code></li>
<li><code>token.start() == 1</code> (and, therefore, <code>offset != token.start()</code></li>
<li><code>saturating_sub</code> returns <code>0</code> (again the first token)</li>
<li><code>offset</code> &lt; <code>token.end()</code> and panic, where it shouldn&#x27;t. I think we need to manually test here that `start &gt; 0 &amp;&amp; self.get(start - 1).is_some_and...</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_parser/src/lib.rs</code>:478 on 2024-05-30 07:12</div>
            <div class="timeline-body"><p>I think you could use <code>binary_search_by</code> here (and probably above as well). It already makes the distinction for you whether it found an element that precisely started at <code>offset</code> (and <code>partition_point</code> calls into <code>binary_search_by</code>)</p>
<pre><code>        match self.binary_search_by(|token| token.start().cmp(&amp;offset)) {
            Ok(idx) =&gt; &amp;self[idx..],
            Err(idx) =&gt; {
                // Test that the offset doesn&#x27;t fall inside the last token that started before offset.
                if idx &gt; 0 &amp;&amp; self.get(idx - 1).is_some_and(|token| token.end() &gt; offset) {
                    panic!(&quot;Offset cannot be in between a token&quot;)
                }

                // Offset falls between two tokens
                &amp;self[idx..]
            }
        }
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_parser/src/lib.rs</code>:627 on 2024-05-30 07:14</div>
            <div class="timeline-body"><p>Nit: I would consider splitting the tests into smaller tests with more specific names. E.g. <code>tokens_after_offset_at_token_start</code>, <code>tokens_after_offset_inside_token</code>, <code>tokens_after_offset_at_token_end</code>, <code>tokens_after_offset_between_tokens</code></p>
<p>I also recommend to remove the <code>test</code> prefix from test methods. It gives you nicer test names when running the tests.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2024-05-30 07:14</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for <a href="https://github.com/AlexWaygood">@AlexWaygood</a> removed by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-05-30 07:41</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2024-05-30 08:44</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_python_parser/src/lib.rs</code>:478 on 2024-05-30 08:44</div>
            <div class="timeline-body"><p>Oh nice, thanks!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2024-05-30 08:59</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_python_parser/src/lib.rs</code>:470 on 2024-05-30 08:59</div>
            <div class="timeline-body"><p>Good catch. I just checked, it starts at offset 3:</p>
<pre><code>3 Name {
    name: &quot;hello&quot;,
} 8
8 Newline 8
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-05-30 10:05</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-05-30 10:05</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-05-30 10:05</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:04:18 UTC
    </footer>
</body>
</html>
