<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Issue 662 explore globset - astral-sh/ruff #883</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Issue 662 explore globset</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/883">#883</a>
        opened by <a href="https://github.com/CelebrateVC">@CelebrateVC</a>
        on 2022-11-23 00:38
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/CelebrateVC">@CelebrateVC</a></div>
            <div class="timeline-body"><p>Thank you for submitting this pull request! We appreciate you spending the time to work on these changes.</p>
What is the motivation?
<p>In #662 Charlie was asking if <a href="https://docs.rs/globset/0.4.9/globset/">globset</a> could speed up runtimes of file matching. After discussing a test strategy for the use case was decided.</p>
What does this change do?
<p>swaps out <code>glob</code> for <code>globset</code> entirely, Strips code of <code>FilePattern</code> as those are now compiled <code>Glob</code>s which instead of being stored in <code>Vec&lt;FilePattern&gt;</code>s are grouped together in a <code>GlobSet</code>. <code>is_excluded</code> is modified to reflect this change and now takes in GlobSets.</p>
What is your testing strategy?
<p>Compiled the base image using <code>glob</code> and compiled altered code, per Contributing guide, benchmarked using hyperfine. Based on the discussion in #662 kneecapped the linter.rs#lint_path function to immediately return default Diagnostic, in order to exclusively test path discovery. below are current code state benchmarks.</p>
<p><img src="https://user-images.githubusercontent.com/27698263/203447092-d1f7a48c-466b-444b-8202-31b02ff95534.png" alt="image"></p>
Is this related to any issues?
<p>#662 - as above mentioned</p>
Have you read the <a href="https://github.com/charliermarsh/ruff/blob/main/CONTRIBUTING.md">Contributing Guidelines</a>?
<ul>
<li>[x] I have read the <a href="https://github.com/charliermarsh/ruff/blob/main/CONTRIBUTING.md">Contributing Guidelines</a></li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2022-11-23 03:07</div>
            <div class="timeline-body"><p>Nice! It seems like the code both got simpler <em>and</em> there are meaningful performance gains here (I&#x27;m seeing a 10ms difference on the benchmark on my machine, which is a &gt; 3% speed-up).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>src/settings/user.rs</code>:82 on 2022-11-23 03:10</div>
            <div class="timeline-body"><p>I think we should remove <code>Exclusion</code> and just inline the string, now that <code>basename</code> and <code>absolute</code> are identical.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>src/settings/user.rs</code>:51 on 2022-11-23 03:11</div>
            <div class="timeline-body"><p>I think we need to map these to strings somehow -- the current output of <code>cargo run resources/test/fixtures/ --show-settings</code> isn&#x27;t very user-friendly:</p>
<p><img src="https://user-images.githubusercontent.com/1309177/203462366-43255dde-4a8b-4b79-8fcb-4871486d711f.png" alt="Screen Shot 2022-11-22 at 10 10 44 PM"></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>src/fs.rs</code>:163 on 2022-11-23 03:14</div>
            <div class="timeline-body"><p>Nit: can we add more expansive expectations here? Like <code>.expect(&quot;Failed to build GlobSet&quot;)</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>src/settings/configuration.rs</code>:108 on 2022-11-23 03:25</div>
            <div class="timeline-body"><p>Maybe a little tighter as:</p>
<pre><code>let extend_exclude = {
    let mut set = globset::GlobSetBuilder::new();
    for path in options.extend_exclude.unwrap_or_default() {
        set.add(from_user(&amp;path, project_root)?);
    }
    set.build()?
};
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>src/settings/configuration.rs</code>:47 on 2022-11-23 03:26</div>
            <div class="timeline-body"><p>I wonder if this should just be a <code>GlobSet</code>, rather than a vector of <code>Glob</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>src/main.rs</code>:234 on 2022-11-23 03:26</div>
            <div class="timeline-body"><p>I think if we&#x27;re going to <code>for</code>-loop here, maybe just make this part of the body, rather than doing a comprehension with the loop too. What do you think?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>src/settings/types.rs</code>:47 on 2022-11-23 03:27</div>
            <div class="timeline-body"><p>This name made more sense when it was part of <code>FilePattern</code>, since <code>FilePattern::from_user</code> had clear semantics. Maybe we rename to <code>create_glob</code> or <code>glob_from_user_pattern</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>src/settings/types.rs</code>:62 on 2022-11-23 03:28</div>
            <div class="timeline-body"><p>I think this merits a comment. Is this creating a pattern that&#x27;s effectively a union of the absolute and base patterns?</p>
<p>Would it be clearer to instead return two Globs, one for each of those two patterns?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2022-11-23 03:28</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2022-11-23 03:36</div>
            <div class="timeline-body"><p>Thank you for this PR! Let me know if you&#x27;re up for tackling the comments.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/CelebrateVC">@CelebrateVC</a> reviewed on 2022-11-23 03:39</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/CelebrateVC">@CelebrateVC</a> on <code>src/settings/user.rs</code>:51 on 2022-11-23 03:39</div>
            <div class="timeline-body"><p>Good points all around, I&#x27;ll go over everything you have shared and take your advice on improvements, this especially should absolutely be cleaned up to something readable ( all those numbers are character codes so it shouldn&#x27;t be too hard to get strings back out).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>src/settings/user.rs</code>:51 on 2022-11-23 03:44</div>
            <div class="timeline-body"><p>Sounds good! Thank you for your contribution :)</p>
<p>If at any point you feel like you won&#x27;t have time to get to the comments, just let me know and we can figure out a plan.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2022-11-23 03:44</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/CelebrateVC">@CelebrateVC</a> on <code>src/settings/user.rs</code>:51 on 2022-11-23 19:50</div>
            <div class="timeline-body"><p>e4d537d and 9e59346 - Had to keep an uncompiled version of the globs to get the strings needed but settings now look much cleaner</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/CelebrateVC">@CelebrateVC</a> reviewed on 2022-11-23 19:50</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/CelebrateVC">@CelebrateVC</a> on <code>src/settings/configuration.rs</code>:108 on 2022-11-23 19:52</div>
            <div class="timeline-body"><p><a href="https://github.com/charliermarsh/ruff/pull/883/commits/f4660bd72125f2fb61d8d07abfb3681483409dcb">f4660bd</a> - great suggestion</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/CelebrateVC">@CelebrateVC</a> reviewed on 2022-11-23 19:52</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/CelebrateVC">@CelebrateVC</a> on <code>src/settings/configuration.rs</code>:47 on 2022-11-23 19:56</div>
            <div class="timeline-body"><p>This <em>was</em> a great idea, except that we need to use the globs to make settings look nice, but I did clean this up to not include <code>Result</code> anymore just a <code>Lazy&lt;Vec&lt;Glob&gt;&gt;&gt;</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/CelebrateVC">@CelebrateVC</a> reviewed on 2022-11-23 19:56</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/CelebrateVC">@CelebrateVC</a> reviewed on 2022-11-23 20:00</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/CelebrateVC">@CelebrateVC</a> on <code>src/main.rs</code>:234 on 2022-11-23 20:00</div>
            <div class="timeline-body"><p>Absolutely, the map was just an artifact of old code, fixed in 708d408 and further improved by cc32661</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/CelebrateVC">@CelebrateVC</a> reviewed on 2022-11-23 20:02</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/CelebrateVC">@CelebrateVC</a> on <code>src/settings/types.rs</code>:62 on 2022-11-23 20:02</div>
            <div class="timeline-body"><p>2 Globs made much more sense to me, so I basically reimplemented <code>FilePattern::Complex</code> in cc32661 ðŸ¤£</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/CelebrateVC">@CelebrateVC</a> reviewed on 2022-11-23 20:05</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/CelebrateVC">@CelebrateVC</a> on <code>src/fs.rs</code>:163 on 2022-11-23 20:05</div>
            <div class="timeline-body"><p>With the changes in f4660bd, this .expect is no longer needed. (or really it&#x27;s now a <code>?</code> to waterfall errors up)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/CelebrateVC">@CelebrateVC</a> on <code>src/settings/user.rs</code>:82 on 2022-11-23 20:07</div>
            <div class="timeline-body"><p>cc32661 re-split basename and absolute, we should continue to use <code>Exclusions</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/CelebrateVC">@CelebrateVC</a> reviewed on 2022-11-23 20:07</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/CelebrateVC">@CelebrateVC</a> on 2022-11-23 20:17</div>
            <div class="timeline-body"><p>I think that&#x27;s all your reviews addressed.</p>
<p>Benchmarks for me are still showing ~10 ms improvement even after changes. Do LMK if there are any other changes you&#x27;d like to see. I won&#x27;t be on here over Thanksgiving weekend, but we can continue going back and forth on changes after that if any are needed.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2022-11-24 04:24</div>
            <div class="timeline-body"><p>Great, thanks! I&#x27;ll try to get this merged in the next few days.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2022-11-25 03:31</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2022-11-25 03:31</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2022-11-25 03:32</div>
            <div class="timeline-body"><p>@CelebrateVC - Thank you for this! I ended up making some tweaks to restore <code>FilePattern</code> (rather than using a tuple with <code>Option</code>), and moved the <code>GlobSet</code> stuff out of <code>Configuration</code> and into <code>Settings</code> which (I think) simplified a few things.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2022-12-11 17:04</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 18:51:30 UTC
    </footer>
</body>
</html>
