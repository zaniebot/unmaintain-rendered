<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Preserve parentheses around partial call chains - astral-sh/ruff #7109</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Preserve parentheses around partial call chains</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/7109">#7109</a>
        opened by <a href="https://github.com/charliermarsh">@charliermarsh</a>
        on 2023-09-03 20:41
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-09-03 20:41</div>
            <div class="timeline-body"><h2>Summary</h2>
<p>This PR fixes a subtle deviation in call chain formatting, the first being that we weren't preserving parentheses around parts of a call chain, and the second being that we were propagating call chain formatting incorrectly when part of the call chain was parenthesized.</p>
<p>Consider these two cases:</p>
<pre><code class="language-python">(
    (
        df1_aaaaaaaaaaaa.merge()
        .groupby(1,)
    )
    .sum()
)


(
    (
        df1_aaaaaaaaaaaa.merge()
        .groupby(1,)
    )
    .sum()
    .bar()
)
</code></pre>
<p>In the former case, nothing should be call-chain formatted. In the latter, <em>only</em> the <code>.sum().bar()</code> should be call-chain formatted. To implement this, we need to ensure that we (1) retain parentheses around the first part of the call chain, but also (2) avoid propagating the call chain formatting across the parenthesis boundary.</p>
<p>Closes https://github.com/astral-sh/ruff/issues/7050.</p>
<h2>Test Plan</h2>
<p><code>cargo test</code></p>
<p>Small improvement in transformers (12 files went from changed to unchanged).</p>
<p>Before:</p>
<p>| project      | similarity index  | total files       | changed files     |
|--------------|------------------:|------------------:|------------------:|
| cpython      |           0.76083 |              1789 |              1632 |
| django       |           0.99957 |              2760 |                67 |
| transformers |           0.99927 |              2587 |               468 |
| twine        |           0.99982 |                33 |                 1 |
| typeshed     |           0.99978 |              3496 |              2173 |
| warehouse    |           0.99818 |               648 |                24 |
| zulip        |           0.99942 |              1437 |                32 |</p>
<p>After:</p>
<p>| project      | similarity index  | total files       | changed files     |
|--------------|------------------:|------------------:|------------------:|
| cpython      |           0.76083 |              1789 |              1632 |
| django       |           0.99957 |              2760 |                67 |
| <strong>transformers</strong> |           <strong>0.99928</strong> |              <strong>2587</strong> |               <strong>456</strong> |
| twine        |           0.99982 |                33 |                 1 |
| typeshed     |           0.99978 |              3496 |              2173 |
| warehouse    |           0.99818 |               648 |                24 |
| zulip        |           0.99942 |              1437 |                32 |</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @konstin by @charliermarsh on 2023-09-03 20:41</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">formatter</span> added by @charliermarsh on 2023-09-03 21:10</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-09-04 07:08</div>
            <div class="timeline-body"><p>Current dependencies on/for this PR:</p>
<ul>
<li>main<ul>
<li><strong>PR #7109</strong> <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7109" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a>  ðŸ‘ˆ</li>
</ul>
</li>
</ul>
<p>This comment was auto-generated by <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7109?utm_source=stack-comment">Graphite</a>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff_python_formatter/tests/snapshots/format@parentheses__call_chains.py.snap</code>:411 on 2023-09-04 09:29</div>
            <div class="timeline-body"><p>it feels strange that we (and black) don't expand this</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> approved on 2023-09-04 09:32</div>
            <div class="timeline-body"><p>good catch on that edge case! like the #7050 OP i also feel like removing parentheses would be better (semantically, the code isn't nested, so syntactically it also shouldn't be), but i agree with changing this for black compatibility.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @charliermarsh on 2023-09-04 09:57</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2023-09-04 09:57</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2023-09-04 09:57</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 02:46:15 UTC
    </footer>
</body>
</html>
