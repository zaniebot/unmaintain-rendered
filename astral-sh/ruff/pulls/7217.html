<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add PreviewMode option to formatter - astral-sh/ruff #7217</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Add PreviewMode option to formatter</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/7217">#7217</a>
        opened by <a href="https://github.com/MichaReiser">@MichaReiser</a>
        on 2023-09-07 11:08
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a></div>
            <div class="timeline-body">Summary
<p>This PR adds the <code>--preview</code> and <code>--no-preview</code> options to the <code>format</code> command (hidden) and passes it through to the formatte.</p>
Test Plan
<p>I added the <code>dbg(f.options().preview())</code> statement in <code>FormatNodeRule::fmt</code> and verified that the option gets correctly passed to the formatter.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/zanieb">@zanieb</a> by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-09-07 11:09</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-09-07 11:09</div>
            <div class="timeline-body"><p>Current dependencies on/for this PR:</p>
<ul>
<li>main<ul>
<li><strong>PR #7145</strong> <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7145"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite"></a><ul>
<li><strong>PR #7193</strong> <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7193"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite"></a><ul>
<li><strong>PR #7215</strong> <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7215"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite"></a><ul>
<li><strong>PR #7217</strong> <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7217"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite"></a>  üëà<ul>
<li><strong>PR #7219</strong> <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7219"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite"></a>
* <strong>PR #7242</strong> <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7242"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite"></a>
* <strong>PR #7567</strong> <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7567"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite"></a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>This comment was auto-generated by <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7217?utm_source=stack-comment">Graphite</a>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">cli</span> added by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-09-07 11:09</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">formatter</span> added by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-09-07 11:09</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/codspeed-hq[bot]">@codspeed-hq[bot]</a> on 2023-09-07 11:19</div>
            <div class="timeline-body"><a href="https://codspeed.io/astral-sh/ruff/branches/add-preview-flag-to-formatter">CodSpeed Performance Report</a>
Merging #7217 will <strong>degrade performances by 2.54%</strong>
<p>Comparing <code>add-preview-flag-to-formatter</code> (65c5853) with <code>main</code> (41f0aad)</p>
Summary
<p><code>‚ùå 1</code> regressions
<code>‚úÖ 24</code> untouched benchmarks</p>
<blockquote>
<p>:warning: <em>Please fix the performance issues or <a href="https://codspeed.io/astral-sh/ruff/branches/add-preview-flag-to-formatter">acknowledge them on CodSpeed</a>.</em></p>
</blockquote>
Benchmarks breakdown
<p>|     | Benchmark | <code>main</code> | <code>add-preview-flag-to-formatter</code> | Change |
| --- | --------- | ----------------------- | ------------------- | ------ |
| ‚ùå | <code>linter/all-rules[numpy/ctypeslib.py]</code> | 32.6 ms | 33.5 ms | -2.54% |</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2023-09-07 11:24</div>
            <div class="timeline-body">PR Check Results
Ecosystem
<p>‚úÖ ecosystem check detected no changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2023-09-07 13:58</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/ruff_python_formatter/src/options.rs</code>:277 on 2023-09-07 13:58</div>
            <div class="timeline-body"><p>Why this instead of deriving the <code>is</code> macro?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-09-07 13:59</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/options.rs</code>:277 on 2023-09-07 13:59</div>
            <div class="timeline-body"><p>Because I and the <code>is</code> macro aren&#x27;t good friends ;)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2023-09-07 14:01</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/ruff_python_formatter/src/options.rs</code>:277 on 2023-09-07 14:01</div>
            <div class="timeline-body"><p>Hm could you change the other one for consistency then?</p>
<p>Also why lol</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-09-07 14:57</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_python_formatter/src/options.rs</code>:277 on 2023-09-07 14:57</div>
            <div class="timeline-body"><p>Subscribe, I like the <code>is</code> macro :joy:</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-09-07 16:21</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/options.rs</code>:277 on 2023-09-07 16:21</div>
            <div class="timeline-body"><p>Damn, I&#x27;m outmatched</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff_python_formatter/src/expression/mod.rs</code>:719 on 2023-09-08 08:13</div>
            <div class="timeline-body"><p>nit: one magic macro less</p>
<pre><code>        self == OwnParentheses::NonEmpty
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2023-09-08 08:17</div>
            <div class="timeline-body"><p>Is preview mode a global only flag or can it also be hierarchical?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-09-08 08:23</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/expression/mod.rs</code>:719 on 2023-09-08 08:23</div>
            <div class="timeline-body"><p><code>PartialEq</code> is not const :(</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-09-08 08:23</div>
            <div class="timeline-body"><blockquote>
<p>Is preview mode a global only flag or can it also be hierarchical?</p>
</blockquote>
<p>I would expect it to be hierarchical the same way as any other configuration option.</p>
<p>CC: @zanieb</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2023-09-08 08:41</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff_python_formatter/src/expression/mod.rs</code>:719 on 2023-09-08 08:41</div>
            <div class="timeline-body"><p>The compiler knows that these are identical: https://godbolt.org/z/Monn4Y53T</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-09-08 08:51</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/expression/mod.rs</code>:719 on 2023-09-08 08:51</div>
            <div class="timeline-body"><p>That&#x27;s correct but it means that any method using <code>is_non_empty</code> can&#x27;t be <code>const</code> either...</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> approved on 2023-09-08 08:57</div>
            <div class="timeline-body"><p>forgot to approve</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2023-09-08 09:00</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff_python_formatter/src/expression/mod.rs</code>:719 on 2023-09-08 09:00</div>
            <div class="timeline-body"><p>do we need it to be const, given that the function is transparent to the compiler either way?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-09-08 09:10</div>
            <div class="timeline-body"><p>IMO it should match the behavior of other settings (and I assume it will by default based on the implementation): hierarchical, but providing it on the command-line overrides it for all files.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-09-08 09:23</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/expression/mod.rs</code>:719 on 2023-09-08 09:23</div>
            <div class="timeline-body"><p>I prefer keeping functions const if we can because it allows using const on call sites which may enable compile time optimisations that the compiler otherwise would not do (because the function isn&#x27;t marked as <code>const</code>).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-09-08 09:50</div>
            <div class="timeline-body">Merge Activity
<ul>
<li><strong>Sep 8, 5:50 AM</strong>: <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7217">Graphite</a> rebased this pull request as part of a merge.</li>
<li><strong>Sep 8, 6:04 AM</strong>: @MichaReiser merged this pull request with <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7217">Graphite</a>.</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-09-08 10:04</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-09-08 10:04</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2023-09-08 10:04</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">preview</span> added by <a href="https://github.com/zanieb">@zanieb</a> on 2023-09-11 18:37</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 18:57:02 UTC
    </footer>
</body>
</html>
