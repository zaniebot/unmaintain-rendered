<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[ty] improve goto/hover for definitions - astral-sh/ruff #19976</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[ty] improve goto/hover for definitions</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/19976">#19976</a>
        opened by <a href="https://github.com/Gankra">@Gankra</a>
        on 2025-08-18 20:49
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Gankra">@Gankra</a></div>
            <div class="timeline-body"><p>By computing the actual Definition for, well, definitions, we unlock a bunch of richer machinery in the goto/hover subsystems for free.</p>
<p>Fixes <a href="https://github.com/astral-sh/ty/issues/1001">astral-sh/ty#1001</a>
Fixes <a href="https://github.com/astral-sh/ty/issues/1004">astral-sh/ty#1004</a></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/carljm">@carljm</a> by <a href="https://github.com/Gankra">@Gankra</a> on 2025-08-18 20:49</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/AlexWaygood">@AlexWaygood</a> by <a href="https://github.com/Gankra">@Gankra</a> on 2025-08-18 20:49</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/sharkdp">@sharkdp</a> by <a href="https://github.com/Gankra">@Gankra</a> on 2025-08-18 20:49</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/dcreager">@dcreager</a> by <a href="https://github.com/Gankra">@Gankra</a> on 2025-08-18 20:49</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/MichaReiser">@MichaReiser</a> by <a href="https://github.com/Gankra">@Gankra</a> on 2025-08-18 20:49</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Gankra">@Gankra</a> on 2025-08-18 20:50</div>
            <div class="timeline-body"><p>mea culpa: this does not fix <a href="https://github.com/astral-sh/ty/issues/1004">astral-sh/ty#1004</a> <em>for vendored typeshed definitions</em> (possibly stdlib-specific?). It seems like file_to_module doesn&#x27;t understand opened-in-your-ide vendored typeshed files? Something to look into more in a followup.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-08-18 20:52</div>
            <div class="timeline-body">

Diagnostic diff on <a href="https://github.com/python/typing/tree/d4f39b27a4a47aac8b6d4019e1b0b5b3156fabdc/conformance">typing conformance tests</a>
<p>No changes detected when running ty on typing conformance tests ✅</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-08-18 20:53</div>
            <div class="timeline-body">

<code>mypy_primer</code> results
<p>No ecosystem changes detected ✅
No memory usage changes detected ✅</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/Gankra">@Gankra</a> on <code>crates/ty_ide/src/goto_references.rs</code>:409 on 2025-08-18 20:53</div>
            <div class="timeline-body"><p>Love when a fix suddenly enriches an existing test case :D</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Gankra">@Gankra</a> reviewed on 2025-08-18 20:53</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">server</span> added by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-08-18 21:53</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ty</span> added by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-08-18 21:53</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> approved on 2025-08-19 01:03</div>
            <div class="timeline-body"><p>Love it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/Gankra">@Gankra</a> on 2025-08-19 01:42</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/Gankra">@Gankra</a> on 2025-08-19 01:42</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-08-19 01:42</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-08-19 06:42</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_ide/src/goto_references.rs</code>:446 on 2025-08-19 06:42</div>
            <div class="timeline-body"><p>Hmm, is this one correct? It looks like a reference to a different variable with the same name to me</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-08-19 06:44</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_ide/src/goto_references.rs</code>:446 on 2025-08-19 06:44</div>
            <div class="timeline-body"><p>I doubt your PR introduced a bug here, just wondering if we should have a TODO comment or open an issue!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2025-08-19 06:59</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/ty_ide/src/goto_references.rs</code>:446 on 2025-08-19 06:59</div>
            <div class="timeline-body"><p>Same variable, different definitions. Except blocks don&#x27;t create subscopes, they just overwrite whatever was previously in that variable. So I think this is the expected behavior.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-08-19 07:25</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_ide/src/goto_references.rs</code>:446 on 2025-08-19 07:25</div>
            <div class="timeline-body"><p>This also matches pycharm&#x27;s behavior</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-08-19 09:03</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_ide/src/goto_references.rs</code>:446 on 2025-08-19 09:03</div>
            <div class="timeline-body"><blockquote>
<p>Except blocks don&#x27;t create subscopes, they just overwrite whatever was previously in that variable.</p>
</blockquote>
<p>You know that I know that ;) I&#x27;m not sure it&#x27;s relevant, though.</p>
<p>Determining the set of references to a given symbol is important for code actions such as being able to right-click on a symbol in an IDE and rename it. If I right clicked on <code>err</code> here in the <code>except ValueError as err</code> branch, I&#x27;m not sure I&#x27;d expect the <code>err</code> symbol in the second <code>except</code> branch to be renamed as well? It has a wholly independent definition from the <code>err</code> symbol in the first branch</p>
<pre><code>try:
    foo
except ValueError as err:
    print(err)
except TypeError as err:
    print(err)
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-08-19 09:04</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_ide/src/goto_references.rs</code>:446 on 2025-08-19 09:04</div>
            <div class="timeline-body"><p>Obviously not a critical debate to have right now if our current behaviour matches other mainstream language servers, though</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-08-19 09:08</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_ide/src/goto_references.rs</code>:446 on 2025-08-19 09:08</div>
            <div class="timeline-body"><p>That does make sense to me but I think it might get tricky if there are any <code>err</code> usages after the <code>except</code> block. It then is important that they all have the same name or renaming only some of them changes program semantics.</p>
<p>This sort of lookahead is probably just complicated enough that renaming all instances is a reasonable default (it reduces the risk of breaking anything or, at least, can avoid any heavy machinary to figure out if it would)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_ide/src/goto_references.rs</code>:446 on 2025-08-19 09:13</div>
            <div class="timeline-body"><blockquote>
<p>That does make sense to me but I think it might get tricky if there are any <code>err</code> usages after the <code>except</code> block.</p>
</blockquote>
<p>For <code>except</code> definitions specifically, that can&#x27;t happen because although the <code>except</code> branch doesn&#x27;t introduce a new scope, the interpreter inserts an implicit <code>del</code> of the variable bound by the <code>except</code> statement at the end of the block:</p>
<pre><code>&gt;&gt;&gt; try:
...     1 / 0
... except ZeroDivisionError as e:
...     print(e)
...     
division by zero
&gt;&gt;&gt; print(e)
Traceback (most recent call last):
  File &quot;&lt;python-input-1&gt;&quot;, line 1, in &lt;module&gt;
    print(e)
          ^
NameError: name &#x27;e&#x27; is not defined
</code></pre>
<p>but yes, I see your point!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-08-19 09:13</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2025-08-19 15:16</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/ty_ide/src/goto_references.rs</code>:446 on 2025-08-19 15:16</div>
            <div class="timeline-body"><p>I don&#x27;t think we should treat <code>except</code> defined variables differently due to their implicit <code>del</code> behavior; that <em>is</em> going down the route of sort of treating them as a separate sub-scope. And in general, I think Micha&#x27;s comment accurately describes why we shouldn&#x27;t / can&#x27;t try to treat separate definitions of the same variable in the same scope as separate variables for purposes of goto-references, rename, etc.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-08-19 15:26</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_ide/src/goto_references.rs</code>:446 on 2025-08-19 15:26</div>
            <div class="timeline-body"><p>makes sense -- thanks!</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:17:49 UTC
    </footer>
</body>
</html>
