<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Run mypy-primer with `TY_MAX_PARALLELISM=1` - astral-sh/ruff #19059</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Run mypy-primer with <code>TY_MAX_PARALLELISM=1</code></h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/pull/19059">#19059</a>
        opened by <a href="https://github.com/ibraheemdev">@ibraheemdev</a>
        on 2025-07-01 00:22
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ibraheemdev">@ibraheemdev</a></div>
            <div class="timeline-body"><h2>Summary</h2>
<p>The memory usage numbers are currently flaky partly due to memory usage being non-deterministic in multi-threaded runs. Running ty in single-threaded mode in the mypy-primer mode should fix this. From what I understand, mypy-primer has parallelism internally so this might not be significantly slower, but if it is then we'll need a separate CI job for memory usage.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ci</span> added by @ibraheemdev on 2025-07-01 00:22</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ty</span> added by @ibraheemdev on 2025-07-01 00:22</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-07-01 00:27</div>
            <div class="timeline-body"><!-- generated-comment mypy_primer -->

<h2><code>mypy_primer</code> results</h2>
<details>
<summary>Changes were detected when running on open source projects</summary>

<pre><code class="language-diff">freqtrade (https://github.com/freqtrade/freqtrade)
-     memo fields = ~304MB
+     memo fields = ~276MB

schemathesis (https://github.com/schemathesis/schemathesis)
- TOTAL MEMORY USAGE: ~156MB
+ TOTAL MEMORY USAGE: ~171MB

alerta (https://github.com/alerta/alerta)
- TOTAL MEMORY USAGE: ~117MB
+ TOTAL MEMORY USAGE: ~106MB

paasta (https://github.com/yelp/paasta)
-     memo fields = ~156MB
+     memo fields = ~171MB

scikit-learn (https://github.com/scikit-learn/scikit-learn)
- TOTAL MEMORY USAGE: ~652MB
+ TOTAL MEMORY USAGE: ~717MB

</code></pre>
</details>

</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @ibraheemdev on 2025-07-01 00:42</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ibraheemdev">@ibraheemdev</a> on 2025-07-01 00:43</div>
            <div class="timeline-body"><p>It looks like this is about a minute slower (4m as compared to 3m), which seems reasonable? A separate job would likely take more than a minute anyways.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> approved on 2025-07-01 08:29</div>
            <div class="timeline-body"><blockquote>
<p>It looks like this is about a minute slower (4m as compared to 3m), which seems reasonable? A separate job would likely take more than a minute anyways.</p>
</blockquote>
<p>The increase in time seems reasonable to me given that cargo test takes around 4 minutes on Linux.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2025-07-01 08:30</div>
            <div class="timeline-body"><blockquote>
<p>Running ty in single-threaded mode in the mypy-primer mode should fix this.</p>
</blockquote>
<p>I'm assuming this can only be verified after merging this PR?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-07-01 11:52</div>
            <div class="timeline-body"><blockquote>
<p>It looks like this is about a minute slower (4m as compared to 3m), which seems reasonable? A separate job would likely take more than a minute anyways.</p>
</blockquote>
<p>It looks more like ~1m30s slower to me -- it looks like primer generally takes around 3m10s on <code>main</code>, and it takes 4m50s with this PR.</p>
<p>I <em>really</em> love how quickly we get feedback from mypy_primer on PRs currently -- it makes it very easy to quickly spot bugs and iterate on PRs. From that perspective, I would selfishly sort-of prefer the memory report to be a separate primer job that runs concurrently with the existing primer job, so that we can still get feedback on the impact on diagnostics as quickly as possible. I'd expect ty PRs to change the diagnostics being emitted much more often than they have a significant impact on memory usage, anyway.</p>
<p>Neither CI job would be marked as &quot;required&quot;, so we would still be able to merge PRs even if one or neither job hadn't yet completed and we wanted to merge a trivial PR quickly. The only cost would be additional CI resources -- but I actually think that having primer reports be as quick as possible might be worth that cost.</p>
<p>Curious if @sharkdp has opinions</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-07-01 12:18</div>
            <div class="timeline-body"><blockquote>
<p>Curious if @sharkdp has opinions</p>
</blockquote>
<p>I was hesitant to bring it up, but I fully agree with you. mypy_primer feedback is also a crucial development tool for me. I am often waiting for its output. So in that sense, every saved minute is a developer-experience improvement. But it's probably also a bit annoying to create a completely separate job for this.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ibraheemdev">@ibraheemdev</a> on 2025-07-02 11:19</div>
            <div class="timeline-body"><p>I guess the problem with this approach is that we're bottlenecked on the largest project instead of evenly spreading the load. I'm fine to make this a separate job if the speed is important. There's also probably some things we could do to speed it up as is.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @ibraheemdev on 2025-07-02 11:19</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:13:50 UTC
    </footer>
</body>
</html>
