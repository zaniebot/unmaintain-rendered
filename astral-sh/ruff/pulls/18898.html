<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[ty] Include imported sub-modules as attributes on modules for completions - astral-sh/ruff #18898</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[ty] Include imported sub-modules as attributes on modules for completions</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/18898">#18898</a>
        opened by <a href="https://github.com/BurntSushi">@BurntSushi</a>
        on 2025-06-23 15:54
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a></div>
            <div class="timeline-body"><p>This also adds a new <code>ModuleName::relative_to</code> public API to help with
this.</p>
<p>Kudos to @AlexWaygood for the meat of this patch!</p>
<p>Ref <a href="https://github.com/astral-sh/ruff/pull/18830">astral-sh/ruff#18830</a>#discussion_r2161770991</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/carljm">@carljm</a> by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2025-06-23 15:54</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/AlexWaygood">@AlexWaygood</a> by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2025-06-23 15:54</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/sharkdp">@sharkdp</a> by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2025-06-23 15:54</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/dcreager">@dcreager</a> by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2025-06-23 15:54</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/MichaReiser">@MichaReiser</a> by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2025-06-23 15:54</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for <a href="https://github.com/dcreager">@dcreager</a> removed by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2025-06-23 15:55</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for <a href="https://github.com/carljm">@carljm</a> removed by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2025-06-23 15:55</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for <a href="https://github.com/MichaReiser">@MichaReiser</a> removed by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2025-06-23 15:55</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for <a href="https://github.com/sharkdp">@sharkdp</a> removed by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2025-06-23 15:55</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ty</span> added by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-06-23 15:56</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-06-23 15:57</div>
            <div class="timeline-body">

<code>mypy_primer</code> results
<p>No ecosystem changes detected âœ…</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_python_semantic/src/module_name.rs</code>:171 on 2025-06-23 15:58</div>
            <div class="timeline-body"><p>Nit: Can&#x27;t we use <code>self.0.strip_prefix(&amp;*parent.0)</code> directly here or why do we need to check for <code>starts_with</code> firstr?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_python_semantic/src/module_name.rs</code>:173 on 2025-06-23 15:58</div>
            <div class="timeline-body"><p>Should this return <code>None</code> instead of panicking?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_python_semantic/src/module_name.rs</code>:174 on 2025-06-23 16:02</div>
            <div class="timeline-body"><p>Should/could we use this in https://github.com/astral-sh/ruff/blob/c9dff5c7d5bcab2a83f1c3b4a1a80af230ece541/crates/ty_python_semantic/src/module_name.rs#L291-L295</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2025-06-23 16:02</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">server</span> added by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-06-23 16:02</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> approved on 2025-06-23 16:03</div>
            <div class="timeline-body"><p>Nice! ðŸ˜ƒ</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-06-23 16:06</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_python_semantic/src/module_name.rs</code>:171 on 2025-06-23 16:06</div>
            <div class="timeline-body"><blockquote>
<p>why do we need to check for <code>starts_with</code> firstr?</p>
</blockquote>
<p>Just using <code>strip_prefix</code> would give inaccurate results because of the fact that the underlying data is a string rather than a sequence of strings. <code>ModuleName(&quot;importlibbbbb.resources&quot;).starts_with(ModuleName(&quot;importlib&quot;))</code> returns <code>false</code> (which follows Python&#x27;s semantics correctly) but <code>&quot;importlibbbbb.resources&quot;.strip_prefix(&quot;importlib&quot;)</code> returns <code>Some()</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-06-23 16:12</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_python_semantic/src/module_name.rs</code>:173 on 2025-06-23 16:12</div>
            <div class="timeline-body"><p>It&#x27;s a logic error to end up with an empty string here:</p>
<ul>
<li>If <code>self</code> is not a relative <code>ModuleName</code> to <code>parent</code>, <code>self.0.strip_prefix(&amp;*parent.0)</code> will return <code>None</code></li>
<li>If <code>self</code> is the same <code>ModuleName</code> as <code>parent</code>, <code>self.0.strip_prefix(&amp;*parent.0)</code> will return <code>Some(&quot;&quot;)</code> and the second <code>strip_prefix()</code> call will return <code>None</code></li>
</ul>
<p>I don&#x27;t think there&#x27;s any way in which we&#x27;d get an empty string here if both <code>self</code> and <code>parent</code> are valid <code>ModuleName</code>s (which should be guaranteed by the invariants upheld by the <code>ModuleName</code> constructor methods)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-06-23 16:14</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_python_semantic/src/module_name.rs</code>:174 on 2025-06-23 16:14</div>
            <div class="timeline-body"><p>I think that function is doing something different. A better name for that function might be <code>module_name_from_relative_import</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2025-06-23 16:25</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ty_python_semantic/src/module_name.rs</code>:171 on 2025-06-23 16:25</div>
            <div class="timeline-body"><p>I think Micha is right here. While that first <code>strip_prefix</code> call would return <code>Some</code>, the subsequent <code>strip_prefix(&#x27;.&#x27;)</code> call will prevent your example from returning <code>Some</code> overall. Since iterating over the components of a module name is just a simple splitting on <code>.</code>, this seems correct to me.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2025-06-23 16:25</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ty_python_semantic/src/module_name.rs</code>:173 on 2025-06-23 16:25</div>
            <div class="timeline-body"><p>I agree. I distilled Alex&#x27;s reasoning into a small comment on the assert.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2025-06-23 16:26</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ty_python_semantic/src/module_name.rs</code>:174 on 2025-06-23 16:26</div>
            <div class="timeline-body"><p>Aside from using <code>relative_module_name</code> directly and taking this suggestion more holistically, I don&#x27;t see a simpler way of utilizing <code>ModuleName::ancestors</code> (or <code>ModuleName::components</code>) to get what we want here.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-06-23 16:31</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_python_semantic/src/module_name.rs</code>:171 on 2025-06-23 16:31</div>
            <div class="timeline-body"><p>oh of course, right!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2025-06-23 16:31</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ty_python_semantic/src/module_name.rs</code>:171 on 2025-06-23 16:31</div>
            <div class="timeline-body"><p>(Sorry, I just ninja-edited my previous comment. I had written one part backwards. I&#x27;ve updated this PR to get rid of the initial <code>starts_with</code> call.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_python_semantic/src/module_name.rs</code>:180 on 2025-06-23 16:33</div>
            <div class="timeline-body"><p>you could maybe also add a debug assertion encapsulating your explanation in <a href="https://github.com/astral-sh/ruff/pull/18898">astral-sh/ruff#18898</a>#discussion_r2162012481 of why it&#x27;s correct to just rely on the <code>strip_prefix()</code> calls here:</p>
<pre><code>        // At this point, `relative_name` *has* to be a
        // proper suffix of `self`. Otherwise, one of the two
        // `strip_prefix` calls above would return `None`.
        // (Notably, a valid `ModuleName` cannot end with a `.`.)
        assert!(!relative_name.is_empty());
        debug_assert!(self.starts_with(parent));
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> approved on 2025-06-23 16:33</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-06-23 16:36</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_python_semantic/src/module_name.rs</code>:174 on 2025-06-23 16:36</div>
            <div class="timeline-body"><p>I think Micha was suggesting the opposite: that we could make use of the new method you&#x27;re adding in the existing <code>relative_module_name</code> function (which, confusingly, actually constructs an absolute <code>ModuleName</code> from a relative import statement -- close to the opposite to what we&#x27;re doing in this new method, where we take an absolute <code>ModuleName</code> and try to turn it into a relative one)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2025-06-23 16:38</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ty_python_semantic/src/module_name.rs</code>:180 on 2025-06-23 16:38</div>
            <div class="timeline-body"><p>Good point. Done. I thought this was a little paranoid, and I was inclined to resist since <code>strip_prefix</code> seems to make this vacuously true... but that&#x27;s wrong. Because <code>starts_with</code> is smarter than a simple string prefix check. In theory, the implementations could diverge such that this assert does indeed trip.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2025-06-23 16:45</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ty_python_semantic/src/module_name.rs</code>:174 on 2025-06-23 16:45</div>
            <div class="timeline-body"><p>Oh. Derp. Yes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2025-06-23 16:48</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2025-06-23 16:48</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-06-23 16:48</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:15:50 UTC
    </footer>
</body>
</html>
