```yaml
number: 6899
title: Truncate ecosystem comment when necessary
type: pull_request
state: merged
author: MichaReiser
labels:
  - internal
assignees: []
merged: true
base: main
head: ecosystem-truncate-comment
created_at: 2023-08-26T14:41:20Z
updated_at: 2023-08-28T07:58:40Z
url: https://github.com/astral-sh/ruff/pull/6899
synced_at: 2026-01-12T15:55:22Z
```

# Truncate ecosystem comment when necessary

---

_@MichaReiser_

## Summary

This PR ensures that the PR comment action always creates a comment, even if the ecosystem results are huge by:

* Testing on the outcome of the step rather the comment text to prevent an out of memory error
* Use another PR comment plugin that automatically truncates the text if it exceeds GitHubs limit of 65536 characters. 

It would be nice if we could add a custom message when the results are truncated but the plugin does not support that. I think this is already a huge improvement because it prevents that we loose the ecosystem result when it's most needed

## Test Plan

I commented out the traversal of the class body in checker to generate a large regression. 

* The [PR Comment run](https://github.com/astral-sh/ruff/actions/runs/5990006807) with the workflow from main fails 
* The manually scheduled [PR Comment run](https://github.com/astral-sh/ruff/actions/runs/5990009960/job/16246859872) on this branch succeeds

<!-- How was it tested? -->


---

_Comment by @MichaReiser on 2023-08-26 14:41_

Current dependencies on/for this PR:
* main
  * **PR #6899** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/6899" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.svg" alt="Graphite" width="10px" height="10px"/></a>  ðŸ‘ˆ

This comment was auto-generated by [Graphite](https://app.graphite.dev/github/pr/astral-sh/ruff/6899?utm_source=stack-comment).

---

_Converted to draft by @MichaReiser on 2023-08-26 14:42_

---

_Comment by @codspeed-hq[bot] on 2023-08-26 14:58_

## [CodSpeed Performance Report](https://codspeed.io/astral-sh/ruff/branches/ecosystem-truncate-comment)

### Merging #6899 will **not alter performance**

<sub>Comparing <code>ecosystem-truncate-comment</code> (4f8ddd1) with <code>main</code> (f33277a)</sub>



### Summary

`âœ… 16` untouched benchmarks






---

_Comment by @github-actions[bot] on 2023-08-27 09:06_

## PR Check Results
### Ecosystem
âœ… ecosystem check detected no changes.



---

_Label `internal` added by @MichaReiser on 2023-08-27 09:10_

---

_Review requested from @charliermarsh by @MichaReiser on 2023-08-27 09:11_

---

_Marked ready for review by @MichaReiser on 2023-08-27 09:12_

---

_@MichaReiser reviewed on 2023-08-27 09:12_

---

_Review comment by @MichaReiser on `.github/workflows/pr-comment.yaml`:75 on 2023-08-27 09:12_

It needs to be a file to avoid OOMing when loading the content

---

_@charliermarsh approved on 2023-08-27 13:52_

Thank you!

Is "comment << EOF" intended?

<img width="327" alt="Screen Shot 2023-08-27 at 9 52 16 AM" src="https://github.com/astral-sh/ruff/assets/1309177/a6bdfd03-6f64-430f-9ab2-dcb5a1dd036a">


---

_Comment by @MichaReiser on 2023-08-27 13:57_

> Is "comment << EOF" intended?

Sure :laughing: 

---

_Comment by @github-actions[bot] on 2023-08-28 07:01_

## PR Check Results
### Ecosystem
âœ… ecosystem check detected no changes.
<!-- thollander/actions-comment-pull-request "PR Check Results" -->

---

_Comment by @github-actions[bot] on 2023-08-28 07:29_

## PR Check Results
### Ecosystem
âœ… ecosystem check detected no changes.



---

_Comment by @github-actions[bot] on 2023-08-28 07:30_

## PR Check Results
### Ecosystem
âœ… ecosystem check detected no changes.



---

_Merged by @MichaReiser on 2023-08-28 07:58_

---

_Closed by @MichaReiser on 2023-08-28 07:58_

---

_Branch deleted on 2023-08-28 07:58_

---
