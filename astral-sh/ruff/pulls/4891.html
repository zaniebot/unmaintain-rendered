<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Make `C413` fix as suggested for `reversed` call - astral-sh/ruff #4891</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Make <code>C413</code> fix as suggested for <code>reversed</code> call</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/4891">#4891</a>
        opened by <a href="https://github.com/dhruvmanila">@dhruvmanila</a>
        on 2023-06-06 04:32
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a></div>
            <div class="timeline-body"><h2>Summary</h2>
<p>~When the <code>key</code> keyword argument is present, the output for <code>sorted</code> and <code>reversed</code> will be different. This is especially true when the elements are itself a collection. The former will sort only as per the given key while the latter will sort using all the elements present in the collection. This could lead to different output for the suggested auto-fix.~</p>
<p>Look at the comments and the linked issue for description but the gist is that the fix for <code>reversed</code> call will be <code>Suggestion</code> while for others it'll be <code>Automatic</code>.</p>
<h2>Alternative</h2>
<p>We could flag the auto-fix as <code>Suggested</code>, but I would rather not flag it as the diagnostic itself is incorrect.</p>
<h2>Test Plan</h2>
<p><code>cargo test</code></p>
<p>fixes: #4879</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2023-06-06 04:45</div>
            <div class="timeline-body"><h2>PR Check Results</h2>
<h3>Ecosystem</h3>
<p>✅ ecosystem check detected no changes.</p>
<h3>Benchmark</h3>
<h4>Linux</h4>
<pre><code>group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.11      6.4±0.02ms     6.4 MB/sec    1.00      5.7±0.03ms     7.1 MB/sec
formatter/numpy/ctypeslib.py               1.03   1229.0±4.58µs    13.5 MB/sec    1.00  1196.4±14.61µs    13.9 MB/sec
formatter/numpy/globals.py                 1.00    132.1±0.22µs    22.3 MB/sec    1.04    137.5±0.18µs    21.5 MB/sec
formatter/pydantic/types.py                1.07      2.7±0.01ms     9.3 MB/sec    1.00      2.5±0.01ms    10.0 MB/sec
linter/all-rules/large/dataset.py          1.00     14.0±0.03ms     2.9 MB/sec    1.01     14.0±0.19ms     2.9 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.01      3.4±0.00ms     4.9 MB/sec    1.00      3.4±0.01ms     4.9 MB/sec
linter/all-rules/numpy/globals.py          1.01    422.1±0.41µs     7.0 MB/sec    1.00    418.6±0.85µs     7.0 MB/sec
linter/all-rules/pydantic/types.py         1.00      5.9±0.02ms     4.3 MB/sec    1.03      6.1±0.04ms     4.2 MB/sec
linter/default-rules/large/dataset.py      1.00      6.7±0.02ms     6.1 MB/sec    1.01      6.8±0.03ms     6.0 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00   1451.2±3.74µs    11.5 MB/sec    1.00   1457.1±5.27µs    11.4 MB/sec
linter/default-rules/numpy/globals.py      1.00    160.9±0.32µs    18.3 MB/sec    1.01    162.4±0.63µs    18.2 MB/sec
linter/default-rules/pydantic/types.py     1.00      3.0±0.02ms     8.4 MB/sec    1.00      3.0±0.01ms     8.4 MB/sec
</code></pre>
<h4>Windows</h4>
<pre><code>group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.00      6.7±0.08ms     6.1 MB/sec    1.02      6.9±0.06ms     5.9 MB/sec
formatter/numpy/ctypeslib.py               1.00  1297.4±23.27µs    12.8 MB/sec    1.08  1399.3±34.73µs    11.9 MB/sec
formatter/numpy/globals.py                 1.00    141.4±3.14µs    20.9 MB/sec    1.13    159.2±5.35µs    18.5 MB/sec
formatter/pydantic/types.py                1.00      2.9±0.04ms     8.8 MB/sec    1.09      3.2±0.05ms     8.0 MB/sec
linter/all-rules/large/dataset.py          1.00     16.5±0.26ms     2.5 MB/sec    1.02     16.8±0.29ms     2.4 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      4.2±0.05ms     4.0 MB/sec    1.02      4.3±0.10ms     3.9 MB/sec
linter/all-rules/numpy/globals.py          1.01    494.4±8.14µs     6.0 MB/sec    1.00    488.0±6.91µs     6.0 MB/sec
linter/all-rules/pydantic/types.py         1.00      7.0±0.09ms     3.6 MB/sec    1.01      7.1±0.19ms     3.6 MB/sec
linter/default-rules/large/dataset.py      1.02      8.4±0.13ms     4.8 MB/sec    1.00      8.2±0.08ms     4.9 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.03  1769.5±22.96µs     9.4 MB/sec    1.00  1719.4±12.77µs     9.7 MB/sec
linter/default-rules/numpy/globals.py      1.01    197.8±3.34µs    14.9 MB/sec    1.00    195.7±3.91µs    15.1 MB/sec
linter/default-rules/pydantic/types.py     1.02      3.7±0.04ms     6.8 MB/sec    1.00      3.7±0.04ms     6.9 MB/sec
</code></pre>
<!-- thollander/actions-comment-pull-request "PR Check Results" -->

</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @charliermarsh by @charliermarsh on 2023-06-06 14:38</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-06-07 01:21</div>
            <div class="timeline-body"><p>My understanding was that the bug wasn't related to <code>key</code>, but rather, was related to the difference in behavior between <code>reversed(...)</code> and sorting with <code>reverse=True</code> -- but I may be mistaken...</p>
<p>In the former case, you're just exactly reversing the order of elements in the list. In the latter, you're performing a stable sort. The difference comes down to how it breaks ties.</p>
<p>Notice in the issue:</p>
<pre><code class="language-py">&gt;&gt;&gt; original = [(1, 0), (2, 0), (3, 1), (4, 1)]
&gt;&gt;&gt; print(list(reversed(sorted(original, key=lambda x: x[1]))))
[(4, 1), (3, 1), (2, 0), (1, 0)]
&gt;&gt;&gt; print(sorted(original, key=lambda x: x[1], reverse=True))
[(3, 1), (4, 1), (1, 0), (2, 0)]
</code></pre>
<p>With <code>reverse=True</code>, <code>(3, 1)</code> comes before <code>(4, 1)</code> -- that is, elements with the same sort key (<code>1</code>) appear in the same order after sorting, i.e., it's a &quot;stable&quot; sort. With <code>reversed</code>, you're just flipping the entire list, so elements naturally appear out-of-relative-order.</p>
<p>My inclination here is actually to continue flagging this, but make it a suggested rather than an automatic fix with we rewrite <code>reversed</code> to <code>reverse=True</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2023-06-07 13:22</div>
            <div class="timeline-body"><p>Isn't the reason the sorting is different because of the <code>key</code> argument? If you remove the <code>key</code> argument, it results in the same order:</p>
<pre><code class="language-python">&gt;&gt;&gt; original = [(1, 0), (2, 0), (3, 1), (4, 1)]
&gt;&gt;&gt; list(reversed(sorted(original)))
[(4, 1), (3, 1), (2, 0), (1, 0)]
&gt;&gt;&gt; sorted(original, reverse=True)
[(4, 1), (3, 1), (2, 0), (1, 0)]
</code></pre>
<p>The fact that <code>key</code> is present means the sorting is done by comparing against whatever element the key function returns which, if it's a collection, could be any. This is the reason I thought the diagnostic itself is incorrect both could result in different order in the presence of <code>key</code>. I just realize that this should only be true in the <code>reversed</code> case and not with <code>list</code>.</p>
<p>I'm open to suggestion and if you think otherwise I'm happy to update the PR accordingly.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-06-07 13:25</div>
            <div class="timeline-body"><p>But the key is causing us to sort based on comparing the second element of each tuple — hence the introduction of ties, since multiple tuples have 0 and 1 as their second element. Without the key, the ties are broken based on the data alone, so the stable vs. unstable sort distinction is irrelevant. I think it still comes down to whether the sort is stable, not whether the key is customized.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2023-06-07 16:33</div>
            <div class="timeline-body"><p>Oh, got it. I'll update the PR accordingly.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-06-07 17:20</div>
            <div class="timeline-body"><p>Does my explanation make sense though? Do you think it’s correct?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2023-06-07 18:17</div>
            <div class="timeline-body"><blockquote>
<p>Does my explanation make sense though? Do you think it’s correct?</p>
</blockquote>
<p>Yes, the fact that the code is correct but the output <em>might</em> be different makes this a valid diagnostic but <em>could</em> be an incorrect fix.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "Avoid flagging `C413` for `key` is present for `sorted`" to "Make `C413` fix as suggested for `reversed` call" by @dhruvmanila on 2023-06-07 18:28</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @charliermarsh on 2023-06-07 22:23</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2023-06-07 22:23</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-06-07 22:23</div>
            <div class="timeline-body"><p>Thanks :)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2023-06-08 03:08</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 16:57:53 UTC
    </footer>
</body>
</html>
