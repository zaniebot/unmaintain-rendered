<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[`pyupgrade`] Gated behind a preview of separate diagnostics (`UP010`) - astral-sh/ruff #20020</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[<code>pyupgrade</code>] Gated behind a preview of separate diagnostics (<code>UP010</code>)</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/pull/20020">#20020</a>
        opened by <a href="https://github.com/IDrokin117">@IDrokin117</a>
        on 2025-08-21 10:52
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/IDrokin117">@IDrokin117</a></div>
            <div class="timeline-body"><h2>Summary</h2>
<p>Second part of https://github.com/astral-sh/ruff/pull/19769</p>
<p>Separate diagnostic generation for each unused import and range updating accordingly. Gated behind a preview</p>
<h2>Test Plan</h2>
<p>Added preview snapshots</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-08-21 11:02</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/codspeed-hq[bot]">@codspeed-hq[bot]</a> on 2025-08-21 11:02</div>
            <div class="timeline-body"><!-- __CODSPEED_PERFORMANCE_REPORT_COMMENT__ -->

<h2><a href="https://codspeed.io/astral-sh/ruff/branches/IDrokin117%3Afeat%2Fruff-19561-preview">CodSpeed Performance Report</a></h2>
<h3>Merging #20020 will <strong>not alter performance</strong></h3>
<p><sub>Comparing <code>IDrokin117:feat/ruff-19561-preview</code> (affcf04) with <code>main</code> (542f080)</sub></p>
<h3>Summary</h3>
<p><code>✅ 30</code> untouched<br />
<code>⏩ 13</code> skipped[^skipped]</p>
<p>[^skipped]: 13 benchmarks were skipped, so the baseline results were used instead. If they were deleted from the codebase, <a href="https://codspeed.io/astral-sh/ruff/branches/IDrokin117%3Afeat%2Fruff-19561-preview?sectionId=benchmark-comparison-section-baseline-result-skipped">click here and archive them to remove them from the performance reports</a>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Converted to draft by @IDrokin117 on 2025-08-21 12:28</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @IDrokin117 on 2025-08-21 13:05</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/IDrokin117">@IDrokin117</a> on 2025-09-08 18:00</div>
            <div class="timeline-body"><p>@ntBre Could you please review PR?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @ntBre by @ntBre on 2025-09-08 18:01</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">preview</span> added by @ntBre on 2025-09-08 18:01</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntBre">@ntBre</a> on 2025-09-08 18:01</div>
            <div class="timeline-body"><p>Yes, sorry for the delay! We've been preparing for the 0.13 release this past week. I'll be catching up on reviews once that goes out.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-09-19 09:38</div>
            <div class="timeline-body"><p>What's the motivation for splitting the diagnostics? This seems unnecessarily verbose to me. Could we instead use the new sub-diagnostics to highlight the individual ranges?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntBre">@ntBre</a> on 2025-09-19 12:53</div>
            <div class="timeline-body"><p>What I liked about the split diagnostics in https://github.com/astral-sh/ruff/pull/19769#pullrequestreview-3111691918 was mostly just underlining the affected imports instead of the whole import statement, which I think could also be handled by sub-diagnostics.</p>
<p>As one supporting example, we also emit one diagnostic per import for <a href="https://docs.astral.sh/ruff/rules/unused-import/#unused-import-f401">unused-import (F401)</a>. Although we could revisit that as well now that we have sub-diagnostics.</p>
<p>I don't feel too strongly either way, though.</p>
<p><a href="https://play.ruff.rs/bf87eac4-7c5d-45f5-8183-6b1830a84ed1">playground</a></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/IDrokin117">@IDrokin117</a> on 2025-09-23 17:38</div>
            <div class="timeline-body"><p>@ntBre What should I do here? It seems diagnostics work per import as for F401, doesn't it? Should I use sub-diagnostics instead? What piece of code can I take as a &quot;sub-diagnostic&quot; example?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntBre">@ntBre</a> on 2025-09-25 14:50</div>
            <div class="timeline-body"><p>I think we just need to reach agreement on how many diagnostics to emit. If you want to try sub-diagnostics to see how they look, here is a previous comment I used on another PR:</p>
<p>The easiest way is  with <code>secondary_annotation</code> on the guard returned by <code>report_diagnostic</code>:</p>
<p>https://github.com/astral-sh/ruff/blob/2245355931f66def488809a6b9b784f7c294bd49/crates/ruff_linter/src/checkers/ast/mod.rs#L3309-L3311</p>
<p>Here's the one use of it we've added so far:</p>
<p>https://github.com/astral-sh/ruff/blob/2245355931f66def488809a6b9b784f7c294bd49/crates/ruff_linter/src/rules/pyflakes/rules/redefined_while_unused.rs#L195-L198</p>
<p>And an example of the type of diagnostic it produces (the <code>-----</code> underlining is used for secondary annotations):</p>
<p>https://github.com/astral-sh/ruff/blob/2245355931f66def488809a6b9b784f7c294bd49/crates/ruff_linter/src/rules/pyflakes/snapshots/ruff_linter__rules__pyflakes__tests__F811_F811_0.py.snap#L4-L17</p>
<p>There are some other options if that doesn't look good, but that's the easiest place to start.</p>
<hr>

<p>That's not technically a sub-diagnostic, but we've only added a nice helper for secondary annotations rather than <code>SubDiagnostic</code>s proper. The helper code would be quite similar to the annotation version, but I'm happy to help with that if we go that route.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @IDrokin117 on 2025-09-30 19:33</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Reopened by @IDrokin117 on 2025-09-30 19:33</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/IDrokin117">@IDrokin117</a> on 2025-09-30 19:35</div>
            <div class="timeline-body"><p>@ntBre @MichaReiser I've rewritten the diagnostic using secondary_annotation. Please check it and let me know how it looks now.<br />
I've also handled the edge case when there is only one alias in the import statement, so there is no need to underline that specific alias separately.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-09-30 19:43</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/pyupgrade/snapshots/ruff_linter__rules__pyupgrade__tests__UP010_0.py__preview.snap</code>:8 on 2025-09-30 19:43</div>
            <div class="timeline-body"><p>I think if we do go this route, we should narrow the primary diagnostic range to just <code>__future__</code> (or maybe <code>from __future__</code> or <code>from __future__ import</code>) to keep the two ranges from overlapping:</p>
<pre><code class="language-suggestion">1 | from __future__ import nested_scopes, generators
  |      ^^^^^^^^^^        -------------  ----------
</code></pre>
<p>I think I'd still prefer either one diagnostic per import, or just leaving the diagnostic as it is on stable, over this, though. But I'm curious to hear what Micha thinks. Thank you for exploring this!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-10-01 06:28</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/pyupgrade/snapshots/ruff_linter__rules__pyupgrade__tests__UP010_0.py__preview.snap</code>:8 on 2025-10-01 06:28</div>
            <div class="timeline-body"><p>I'd have to double-check but narrowing the range changes the places where suppression comments are allowed.</p>
<p>E.g, the following currently works but I suspect won't work if we narrow the range</p>
<pre><code>from __future__ import (
	nested_scopes, # noqa &lt;RULE&gt;
 	generators
)
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-10-01 06:35</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/pyupgrade/snapshots/ruff_linter__rules__pyupgrade__tests__UP010_0.py__preview.snap</code>:8 on 2025-10-01 06:35</div>
            <div class="timeline-body"><p>Hmm yeah, using multiple annotated ranges and highlighting the entire import statement doesn't help improve readability.</p>
<p>I only found this usage in cargo:</p>
<pre><code>warning: methods `unused1` and `unused2` are never used
  --&gt; src/function/maybe_changed_after.rs:41:19
   |
32 | impl VerifyResult {
   | ----------------- methods in this implementation
...
41 |     pub(crate) fn unused1(&amp;self) {}
   |                   ^^^^^^^
42 |
43 |     pub(crate) fn unused2(&amp;self) {}
   |                   ^^^^^^^
   |
   = note: `#[warn(dead_code)]` on by default
</code></pre>
<p>They use the <code>unused1</code> as the primary range and mark the <code>impl</code> block as a secondary annotation. But doing the same in Ruff requires figuring out how to make our suppression system understand that this diagnostic represents two separate violations (the current assumption is that diagnostics only represent a single error.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-10-01 13:19</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/pyupgrade/snapshots/ruff_linter__rules__pyupgrade__tests__UP010_0.py__preview.snap</code>:8 on 2025-10-01 13:19</div>
            <div class="timeline-body"><p>Ah, would narrowing the noqa range actually be a benefit of separate diagnostics here? Something like this doesn't currently <a href="https://play.ruff.rs/1fa9e588-8306-4480-80d9-f720350e0506">work</a>:</p>
<pre><code class="language-py">from __future__ import ( 
    nested_scopes,  # noqa: UP010
    generators,
) 

generators
</code></pre>
<p>You have to put the noqa <a href="https://play.ruff.rs/1d712d9e-8afa-4082-8872-c70379080045">here</a>:</p>
<pre><code class="language-py">from __future__ import ( # noqa: UP010
    nested_scopes,  
    generators,
) 

generators
</code></pre>
<p>at least that's the only place I found that works.</p>
<p>But yeah, I think secondary annotations are probably better for highlighting additional context that helps to explain the main diagnostic but likely falls outside the normal snippet context window, like in your Rust example.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/IDrokin117">@IDrokin117</a> reviewed on 2025-10-03 13:52</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/IDrokin117">@IDrokin117</a> on <code>crates/ruff_linter/src/rules/pyupgrade/snapshots/ruff_linter__rules__pyupgrade__tests__UP010_0.py__preview.snap</code>:8 on 2025-10-03 13:52</div>
            <div class="timeline-body"><p>It appears that the previous implementation, which uses separate diagnostics, functions well for <code># noqa: UP010</code> per import object. Should I revert to that approach?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-10-04 12:00</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/pyupgrade/snapshots/ruff_linter__rules__pyupgrade__tests__UP010_0.py__preview.snap</code>:8 on 2025-10-04 12:00</div>
            <div class="timeline-body"><p>I'm leaning towards leaving it as is. I don't think that any of the tried approaches greatly improve the rendered diagnostics to justify a breaking change. But maybe Brent thinks differently? I'd otherwise close this PR and suggest that we revisit the rendering once we have figured out how to better handle those cases with our diagnostic system. But thank you a lot for trying out all those different approaches. It was very helpful to drive the decision-making and show where there's some need to improve our diagnostic system.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/pyupgrade/snapshots/ruff_linter__rules__pyupgrade__tests__UP010_0.py__preview.snap</code>:8 on 2025-10-04 15:21</div>
            <div class="timeline-body"><p>Yeah, I think I agree with Micha. Thank you for working on this, I also agree that it was very helpful to see the different options!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-10-04 15:21</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @MichaReiser on 2025-10-06 06:54</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:15:13 UTC
    </footer>
</body>
</html>
