<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add tests for parameters - astral-sh/ruff #10828</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Add tests for parameters</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/10828">#10828</a>
        opened by <a href="https://github.com/dhruvmanila">@dhruvmanila</a>
        on 2024-04-08 03:51
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a></div>
            <div class="timeline-body"><h2>Summary</h2>
<p>This PR adds test cases for parameters in a function definition.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">parser</span> added by @dhruvmanila on 2024-04-08 03:51</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">testing</span> added by @dhruvmanila on 2024-04-08 03:51</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @dhruvmanila on 2024-04-08 12:23</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @dhruvmanila on 2024-04-08 12:23</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_parser/src/error.rs</code>:261 on 2024-04-08 13:45</div>
            <div class="timeline-body"><p>Most other diagnostics have the <em>cannt</em> or <em>expected</em> where this states what happened:</p>
<pre><code class="language-suggestion">                    &quot;Parameter without a default cannot follow a parameter with a default&quot;
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_parser/src/parser/statement.rs</code>:2685 on 2024-04-08 13:47</div>
            <div class="timeline-body"><p>Nit: I think I would move the method to <code>Parser</code> similar to the expression validation function so that you can push the errors directly with <code>self.add_error</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_parser/src/parser/mod.rs</code>:310 on 2024-04-08 13:49</div>
            <div class="timeline-body"><p>I don't think I understand this comment. When is it possible that we parse a node that is to the right of the next token?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_parser/src/parser/statement.rs</code>:2345 on 2024-04-08 13:52</div>
            <div class="timeline-body"><p>I wonder if it still makes sense to have a single function or if it should rather be a <code>parse_function_parameter</code> and <code>parse_lambda_parameter</code> function because there's not much code that is shared between the two kinds (most of the code is different). Or is that not possible because there's a single <code>parse_parameters</code> function that calls into <code>parse_parameter</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_parser/src/parser/statement.rs</code>:2495 on 2024-04-08 13:56</div>
            <div class="timeline-body"><p>Could we use</p>
<pre><code>let param_star_range = self.node_range(star_start)
</code></pre>
<p>instead?</p>
<p>I'm cautious of <code>cover</code> because it can extend the range in unintended ways if we aren't careful.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_parser/src/parser/statement.rs</code>:2550 on 2024-04-08 13:57</div>
            <div class="timeline-body"><p>Same here: Can we use use <code>Parser::node_range</code> to get the range of the <code>double_star</code> and param range</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_parser/src/parser/statement.rs</code>:2459 on 2024-04-09 07:18</div>
            <div class="timeline-body"><p>It would help if you can rephare the &quot;same problem&quot;. It's unclear what it refers to. Is it arguments parsing?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_parser/src/parser/statement.rs</code>:2504 on 2024-04-09 07:24</div>
            <div class="timeline-body"><p>Nit and unrelated to this PR. You could try to add <code>#[cold]</code> to <code>add_error</code> and profile if it speeds up the &quot;happy path&quot; where we have no parse errors.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_parser/src/parser/statement.rs</code>:2600 on 2024-04-09 07:51</div>
            <div class="timeline-body"><p>Is it intentional that this test case is commented out?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_parser/src/parser/statement.rs</code>:2623 on 2024-04-09 07:52</div>
            <div class="timeline-body"><p>What happens if there are two slashes? Does it then swap the parameters twice?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_parser/src/parser/statement.rs</code>:2641 on 2024-04-09 07:54</div>
            <div class="timeline-body"><p>For the future: We may also want to handle keywords here <code>def test(async=true): pass</code> for better error recovery</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_parser/tests/snapshots/invalid_syntax@expressions__lambda_default_parameters.py.snap</code>:93 on 2024-04-09 07:55</div>
            <div class="timeline-body"><p>I think this is fixed now?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2024-04-09 07:58</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2024-04-09 08:05</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_python_parser/src/parser/mod.rs</code>:310 on 2024-04-09 08:05</div>
            <div class="timeline-body"><p>In binary expression, the parser would start by parsing the LHS. then depending on the operator, recurse and parse the RHS.</p>
<p>But, the problem isn't just for binary expressions. It's for the first node where the problem is. Looking the the provided example, the <code>last_token_end</code> isn't part of the node that we're parsing right now. In this scenario, if the node is missing, we'd use the <code>missing_node_range</code> which creates an empty range at the last token end position. But, the current expression hasn't started yet, so this missing node range is going to be outside the parsed expression.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2024-04-09 08:07</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_python_parser/src/parser/statement.rs</code>:2345 on 2024-04-09 08:07</div>
            <div class="timeline-body"><p>It should be possible because of the <code>FunctionKind</code>. We can then call either <code>parse_function_parameter</code> or <code>parse_lambda_parameter</code> depending on the enum variant.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2024-04-09 08:15</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_python_parser/src/parser/statement.rs</code>:2623 on 2024-04-09 08:15</div>
            <div class="timeline-body"><p>Oh, this is a good point. This would then swap the parameters again which would create problem in the AST validation as the positional only parameters are visited first.</p>
<p>In this case, for better error recovery, I think we should extend the existing positional only arguments.</p>
<p>So, for the happy path where <code>/</code> is only once, we'd swap it but for any subsequent <code>/</code>, we'd extend it if there are any arguments.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-04-09 08:30</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_parser/src/parser/statement.rs</code>:2345 on 2024-04-09 08:30</div>
            <div class="timeline-body"><p>Okay, yeah but if it's used in there than it probably doesn't make that much sense. I think leaving it as is is fine.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/codspeed-hq[bot]">@codspeed-hq[bot]</a> on 2024-04-09 14:24</div>
            <div class="timeline-body"><h2><a href="https://codspeed.io/astral-sh/ruff/branches/dhruv/parameters">CodSpeed Performance Report</a></h2>
<h3>Merging #10828 will <strong>degrade performances by 8.96%</strong></h3>
<p><sub>Comparing <code>dhruv/parameters</code> (246426a) with <code>dhruv/parser</code> (8917847)</sub></p>
<h3>Summary</h3>
<p><code>⚡ 1</code> improvements
<code>❌ 2</code> regressions
<code>✅ 27</code> untouched benchmarks</p>
<blockquote>
<p>:warning: <em>Please fix the performance issues or <a href="https://codspeed.io/astral-sh/ruff/branches/dhruv/parameters">acknowledge them on CodSpeed</a>.</em></p>
</blockquote>
<h3>Benchmarks breakdown</h3>
<p>|     | Benchmark | <code>dhruv/parser</code> | <code>dhruv/parameters</code> | Change |
| --- | --------- | ----------------------- | ------------------- | ------ |
| ❌ | <code>parser[large/dataset.py]</code> | 26.5 ms | 28.8 ms | -7.74% |
| ❌ | <code>parser[numpy/ctypeslib.py]</code> | 5 ms | 5.4 ms | -8.96% |
| ⚡ | <code>parser[unicode/pypinyin.py]</code> | 1.7 ms | 1.6 ms | +5.4% |</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2024-04-09 14:38</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Formatter (stable)</h3>
<p>✅ ecosystem check detected no format changes.</p>
<h3>Formatter (preview)</h3>
<p>✅ ecosystem check detected no format changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2024-04-09 15:31</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_python_parser/src/parser/statement.rs</code>:2623 on 2024-04-09 15:31</div>
            <div class="timeline-body"><p>Hmm, no, we'd need to drop the token. For example,</p>
<pre><code class="language-py">def foo(a, /, b, c, /): ...
</code></pre>
<p>Here, only <code>a</code> should be considered as positional-only argument while <code>b</code> and <code>c</code> are regular arguments otherwise the order would be incorrect. This should be the case at least with the current AST.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2024-04-09 15:51</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_python_parser/src/parser/statement.rs</code>:2600 on 2024-04-09 15:51</div>
            <div class="timeline-body"><p>Yes, it turned out to be an actual bug as you pointed out in the following comment (https://github.com/astral-sh/ruff/pull/10828#discussion_r1557145352) that's fixed.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @dhruvmanila on 2024-04-09 15:53</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @dhruvmanila on 2024-04-09 15:53</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-04-09 15:53</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:03:38 UTC
    </footer>
</body>
</html>
