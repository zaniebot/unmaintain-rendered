```yaml
number: 5661
title: "Format `target: annotation = value?` expressions"
type: pull_request
state: merged
author: MichaReiser
labels:
  - formatter
assignees: []
merged: true
base: main
head: format-annotated-assignment
created_at: 2023-07-10T17:58:26Z
updated_at: 2023-07-11T14:40:30Z
url: https://github.com/astral-sh/ruff/pull/5661
synced_at: 2026-01-12T03:36:55Z
```

# Format `target: annotation = value?` expressions

---

_Pull request opened by @MichaReiser on 2023-07-10 17:58_

<!--
Thank you for contributing to Ruff! To help us out with reviewing, please consider the following:

- Does this pull request include a summary of the change? (See below.)
- Does this pull request include a descriptive title?
- Does this pull request include references to any relevant issues?
-->

## Summary

This PR implements formatting of `target: annotation (= value)?` expressions. 

It resulted in me going down a rabbit hole because I then noticed that tuples inside of subscript should not be parenthesized. So I fixed that too. 

<!-- What's the purpose of the change? What does it do, and why? -->

## Test Plan

I added new tests. I fixed the `skip_magic_comma` test to run it with magic comma disabled (This test got me really confused because one test wanted to have trailing comma and this test wanted **not** to have trailing commas). 

<!-- How was it tested? -->


---

_Comment by @MichaReiser on 2023-07-10 17:58_

Current dependencies on/for this PR:
* main
  * **PR #5661** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/5661" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a>  ðŸ‘ˆ
    * **PR #5680** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/5680" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a> 
      * **PR #5683** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/5683" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a> 

This comment was auto-generated by [Graphite](https://app.graphite.dev/github/pr/astral-sh/ruff/5661?utm_source=stack-comment).

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/builders.rs`:9 on 2023-07-10 18:02_

I think this name is better. The rest of the code refers to optional parentheses that we sometimes omit because they are unnecessary. These are parentheses that we always add if the content expands. 

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/expression/mod.rs`:109 on 2023-07-10 18:03_

I moved this, unchanged, to `parentheses.rs`

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/statement/stmt_function_def.rs`:100 on 2023-07-10 18:03_

Function defs are weird. They add parentheses around subscript expressions. 

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/tests/fixtures.rs`:16 on 2023-07-10 18:04_

This adds support for options for black tests.

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/tests/snapshots/black_compatibility@miscellaneous__force_pyi.py.snap`:100 on 2023-07-10 18:05_

Hmm, we'll need into single line bodies at some point. Potentially something that our suite refactor would simplify but we shouldn't be blocked by it.l

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/tests/snapshots/black_compatibility@simple_cases__one_element_subscript.py.snap`:1 on 2023-07-10 18:05_

:partying_face: 

---

_@MichaReiser reviewed on 2023-07-10 18:06_

---

_Label `formatter` added by @MichaReiser on 2023-07-10 18:07_

---

_Review requested from @konstin by @MichaReiser on 2023-07-10 18:07_

---

_Comment by @github-actions[bot] on 2023-07-10 18:42_

## PR Check Results
### Ecosystem
âœ… ecosystem check detected no changes.

### Benchmark
#### Linux
```
group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.00      8.0Â±0.03ms     5.1 MB/sec    1.01      8.1Â±0.02ms     5.0 MB/sec
formatter/numpy/ctypeslib.py               1.00   1859.2Â±7.73Âµs     9.0 MB/sec    1.01   1875.0Â±5.49Âµs     8.9 MB/sec
formatter/numpy/globals.py                 1.00    206.2Â±4.40Âµs    14.3 MB/sec    1.00    206.9Â±1.26Âµs    14.3 MB/sec
formatter/pydantic/types.py                1.00      4.0Â±0.01ms     6.4 MB/sec    1.02      4.1Â±0.01ms     6.3 MB/sec
linter/all-rules/large/dataset.py          1.00     13.5Â±0.10ms     3.0 MB/sec    1.00     13.6Â±0.06ms     3.0 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      3.4Â±0.00ms     4.9 MB/sec    1.00      3.4Â±0.02ms     4.9 MB/sec
linter/all-rules/numpy/globals.py          1.00    432.7Â±0.72Âµs     6.8 MB/sec    1.00    433.4Â±0.97Âµs     6.8 MB/sec
linter/all-rules/pydantic/types.py         1.00      6.0Â±0.02ms     4.3 MB/sec    1.01      6.0Â±0.02ms     4.2 MB/sec
linter/default-rules/large/dataset.py      1.00      6.7Â±0.02ms     6.1 MB/sec    1.01      6.8Â±0.02ms     6.0 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00   1459.5Â±8.10Âµs    11.4 MB/sec    1.01   1468.3Â±4.07Âµs    11.3 MB/sec
linter/default-rules/numpy/globals.py      1.00    166.1Â±1.22Âµs    17.8 MB/sec    1.00    166.8Â±0.26Âµs    17.7 MB/sec
linter/default-rules/pydantic/types.py     1.00      3.0Â±0.01ms     8.5 MB/sec    1.01      3.0Â±0.01ms     8.4 MB/sec
```

#### Windows
```
group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.00     12.2Â±0.39ms     3.3 MB/sec    1.00     12.2Â±0.38ms     3.3 MB/sec
formatter/numpy/ctypeslib.py               1.00      2.8Â±0.14ms     6.1 MB/sec    1.00      2.8Â±0.14ms     6.1 MB/sec
formatter/numpy/globals.py                 1.00   312.2Â±15.55Âµs     9.5 MB/sec    1.01   316.5Â±18.32Âµs     9.3 MB/sec
formatter/pydantic/types.py                1.00      5.8Â±0.20ms     4.4 MB/sec    1.05      6.1Â±0.23ms     4.2 MB/sec
linter/all-rules/large/dataset.py          1.04     21.4Â±0.63ms  1942.5 KB/sec    1.00     20.7Â±0.78ms  2012.2 KB/sec
linter/all-rules/numpy/ctypeslib.py        1.03      5.5Â±0.24ms     3.0 MB/sec    1.00      5.4Â±0.19ms     3.1 MB/sec
linter/all-rules/numpy/globals.py          1.03   664.3Â±31.46Âµs     4.4 MB/sec    1.00   642.8Â±21.80Âµs     4.6 MB/sec
linter/all-rules/pydantic/types.py         1.00      9.5Â±0.36ms     2.7 MB/sec    1.00      9.4Â±0.31ms     2.7 MB/sec
linter/default-rules/large/dataset.py      1.05     11.0Â±0.44ms     3.7 MB/sec    1.00     10.4Â±0.36ms     3.9 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.07      2.3Â±0.12ms     7.2 MB/sec    1.00      2.2Â±0.07ms     7.7 MB/sec
linter/default-rules/numpy/globals.py      1.01   283.2Â±13.42Âµs    10.4 MB/sec    1.00   280.9Â±23.97Âµs    10.5 MB/sec
linter/default-rules/pydantic/types.py     1.04      4.8Â±0.21ms     5.3 MB/sec    1.00      4.7Â±0.14ms     5.5 MB/sec
```
<!-- thollander/actions-comment-pull-request "PR Check Results" -->

---

_Review comment by @konstin on `crates/ruff_python_formatter/src/expression/expr_subscript.rs`:93 on 2023-07-10 18:53_

this is at least have done, and i think an issue link is missing

---

_@konstin approved on 2023-07-10 19:16_

---

_Closed by @MichaReiser on 2023-07-11 12:48_

---

_Reopened by @MichaReiser on 2023-07-11 12:48_

---

_Merged by @MichaReiser on 2023-07-11 14:40_

---

_Closed by @MichaReiser on 2023-07-11 14:40_

---

_Branch deleted on 2023-07-11 14:40_

---
