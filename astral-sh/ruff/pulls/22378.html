<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[ty] Support `dataclass_transform` as a function call - astral-sh/ruff #22378</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[ty] Support <code>dataclass_transform</code> as a function call</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/22378">#22378</a>
        opened by <a href="https://github.com/charliermarsh">@charliermarsh</a>
        on 2026-01-04 23:14
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a></div>
            <div class="timeline-body">Summary
<p>Instead of just as a decorator.</p>
<p>Closes <a href="https://github.com/astral-sh/ty/issues/2319">astral-sh/ty#2319</a>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2026-01-04 23:15</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ty</span> added by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2026-01-04 23:15</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/astral-sh-bot[bot]">@astral-sh-bot[bot]</a> on 2026-01-04 23:16</div>
            <div class="timeline-body">

Diagnostic diff on <a href="https://github.com/python/typing/tree/9f6d8ced7cd1c8d92687a4e9c96d7716452e471e/conformance">typing conformance tests</a>
<p>No changes detected when running ty on typing conformance tests ✅</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/astral-sh-bot[bot]">@astral-sh-bot[bot]</a> on 2026-01-04 23:20</div>
            <div class="timeline-body">

<code>mypy_primer</code> results

Changes were detected when running on open source projects

<pre><code>attrs (https://github.com/python-attrs/attrs)
- tests/test_annotations.py:644:13: error[invalid-assignment] Object of type `&lt;decorator produced by dataclass-like function&gt;` is not assignable to `&lt;class &#x27;C&#x27;&gt;`
+ tests/test_annotations.py:644:13: error[invalid-assignment] Object of type `&lt;class &#x27;tests.test_annotations.TestAnnotations.&lt;locals of function &#x27;test_init_type_hints_fake_module&#x27;&gt;.C @ tests/test_annotations.py:640&#x27;&gt;` is not assignable to `&lt;class &#x27;tests.test_annotations.TestAnnotations.&lt;locals of function &#x27;test_init_type_hints_fake_module&#x27;&gt;.C @ tests/test_annotations.py:640&#x27;&gt;`
- tests/test_make.py:620:13: error[invalid-assignment] Object of type `&lt;decorator produced by dataclass-like function&gt;` is not assignable to `&lt;class &#x27;C&#x27;&gt;`
+ tests/test_make.py:620:13: error[invalid-assignment] Object of type `&lt;class &#x27;tests.test_make.TestAttributes.&lt;locals of function &#x27;test_adds_all_by_default&#x27;&gt;.C @ tests/test_make.py:615&#x27;&gt;` is not assignable to `&lt;class &#x27;tests.test_make.TestAttributes.&lt;locals of function &#x27;test_adds_all_by_default&#x27;&gt;.C @ tests/test_make.py:615&#x27;&gt;`
+ tests/test_make.py:675:13: error[invalid-assignment] Object of type `&lt;class &#x27;tests.test_make.TestAttributes.&lt;locals of function &#x27;test_respects_init_attrs_init&#x27;&gt;.C @ tests/test_make.py:672&#x27;&gt;` is not assignable to `&lt;class &#x27;tests.test_make.TestAttributes.&lt;locals of function &#x27;test_respects_init_attrs_init&#x27;&gt;.C @ tests/test_make.py:672&#x27;&gt;`
+ tests/test_make.py:2872:17: error[invalid-assignment] Object of type `type[tests.test_make.TestAutoDetect.&lt;locals of function &#x27;test_total_ordering&#x27;&gt;.C @ tests/test_make.py:2858] | type[tests.test_make.TestAutoDetect.&lt;locals of function &#x27;test_total_ordering&#x27;&gt;.C @ tests/test_make.py:2858]` is not assignable to `&lt;class &#x27;tests.test_make.TestAutoDetect.&lt;locals of function &#x27;test_total_ordering&#x27;&gt;.C @ tests/test_make.py:2858&#x27;&gt;`
+ tests/test_make.py:2882:16: error[unsupported-operator] Operator `&lt;` is not supported between two objects of type `C | @Todo`
+ tests/test_make.py:2887:16: error[unsupported-operator] Operator `&gt;` is not supported between two objects of type `C | @Todo`
+ tests/test_slots.py:217:10: error[invalid-argument-type] Argument to bound method `__init__` is incorrect: Expected `tests.test_slots.&lt;locals of function &#x27;test_nonslots_these&#x27;&gt;.SimpleOrdinaryClass @ tests/test_slots.py:193`, found `tests.test_slots.&lt;locals of function &#x27;test_nonslots_these&#x27;&gt;.SimpleOrdinaryClass @ tests/test_slots.py:193`
+ tests/test_slots.py:222:9: error[unresolved-attribute] Unresolved attribute `t` on type `SimpleOrdinaryClass`.
+ tests/test_slots.py:224:17: error[invalid-argument-type] Argument to bound method `method` is incorrect: Expected `tests.test_slots.&lt;locals of function &#x27;test_nonslots_these&#x27;&gt;.SimpleOrdinaryClass @ tests/test_slots.py:193`, found `tests.test_slots.&lt;locals of function &#x27;test_nonslots_these&#x27;&gt;.SimpleOrdinaryClass @ tests/test_slots.py:193`
+ tests/test_slots.py:225:27: error[invalid-argument-type] Argument to bound method `classmethod` is incorrect: Expected `type[tests.test_slots.&lt;locals of function &#x27;test_nonslots_these&#x27;&gt;.SimpleOrdinaryClass @ tests/test_slots.py:193]`, found `type[tests.test_slots.&lt;locals of function &#x27;test_nonslots_these&#x27;&gt;.SimpleOrdinaryClass @ tests/test_slots.py:193]`
+ tests/test_slots.py:228:50: error[unresolved-attribute] Class `SimpleOrdinaryClass` has no attribute `__slots__`
+ tests/test_slots.py:230:10: error[invalid-argument-type] Argument to bound method `__init__` is incorrect: Expected `tests.test_slots.&lt;locals of function &#x27;test_nonslots_these&#x27;&gt;.SimpleOrdinaryClass @ tests/test_slots.py:193`, found `tests.test_slots.&lt;locals of function &#x27;test_nonslots_these&#x27;&gt;.SimpleOrdinaryClass @ tests/test_slots.py:193`
+ tests/test_slots.py:232:11: error[invalid-argument-type] Argument to bound method `__init__` is incorrect: Expected `tests.test_slots.&lt;locals of function &#x27;test_nonslots_these&#x27;&gt;.SimpleOrdinaryClass @ tests/test_slots.py:193`, found `tests.test_slots.&lt;locals of function &#x27;test_nonslots_these&#x27;&gt;.SimpleOrdinaryClass @ tests/test_slots.py:193`
- Found 616 diagnostics
+ Found 627 diagnostics

Tanjun (https://github.com/FasterSpeeding/Tanjun)
- tanjun/dependencies/data.py:347:12: error[invalid-return-type] Return type does not match returned value: expected `_T@cached_inject`, found `_T@cached_inject | Coroutine[Any, Any, _T@cached_inject | Coroutine[Any, Any, _T@cached_inject]]`
+ tanjun/dependencies/data.py:347:12: error[invalid-return-type] Return type does not match returned value: expected `_T@cached_inject`, found `Coroutine[Any, Any, _T@cached_inject | Coroutine[Any, Any, _T@cached_inject]] | _T@cached_inject`

static-frame (https://github.com/static-frame/static-frame)
- static_frame/core/bus.py:671:16: error[invalid-return-type] Return type does not match returned value: expected `InterGetItemLocReduces[Bus[Any], object_]`, found `InterGetItemLocReduces[Bus[Any] | Bottom[Series[Any, Any]] | ndarray[Never, Never] | ... omitted 6 union elements, object_]`
+ static_frame/core/bus.py:671:16: error[invalid-return-type] Return type does not match returned value: expected `InterGetItemLocReduces[Bus[Any], object_]`, found `InterGetItemLocReduces[Bus[Any] | Bottom[Index[Any]] | Bottom[Series[Any, Any]] | ... omitted 6 union elements, object_]`
- static_frame/core/bus.py:675:16: error[invalid-return-type] Return type does not match returned value: expected `InterGetItemILocReduces[Bus[Any], object_]`, found `InterGetItemILocReduces[Bus[Any] | Bottom[Index[Any]] | TypeBlocks | ... omitted 6 union elements, object_ | Self@iloc]`
+ static_frame/core/bus.py:675:16: error[invalid-return-type] Return type does not match returned value: expected `InterGetItemILocReduces[Bus[Any], object_]`, found `InterGetItemILocReduces[Bus[Any] | ndarray[Never, Never] | TypeBlocks | ... omitted 6 union elements, object_ | Self@iloc]`
- static_frame/core/series.py:772:16: error[invalid-return-type] Return type does not match returned value: expected `InterGetItemILocReduces[Series[Any, Any], TVDtype@Series]`, found `InterGetItemILocReduces[Series[Any, Any] | Bottom[Index[Any]] | TypeBlocks | ... omitted 6 union elements, TVDtype@Series]`
- static_frame/core/series.py:4072:16: error[invalid-return-type] Return type does not match returned value: expected `InterGetItemILocReduces[SeriesHE[Any, Any], TVDtype@SeriesHE]`, found `InterGetItemILocReduces[Bottom[Series[Any, Any]] | Bottom[Index[Any]] | TypeBlocks | ... omitted 7 union elements, TVDtype@SeriesHE]`
+ static_frame/core/series.py:4072:16: error[invalid-return-type] Return type does not match returned value: expected `InterGetItemILocReduces[SeriesHE[Any, Any], TVDtype@SeriesHE]`, found `InterGetItemILocReduces[Bottom[Series[Any, Any]] | ndarray[Never, Never] | TypeBlocks | ... omitted 7 union elements, TVDtype@SeriesHE]`
- Found 1840 diagnostics
+ Found 1839 diagnostics


</code></pre>


<p>No memory usage changes detected ✅</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2026-01-05 00:46</div>
            <div class="timeline-body"><p>(The <code>hydra-zen</code> diagnostic needs work.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2026-01-05 01:26</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ty_python_semantic/src/types/call/bind.rs</code>:1220 on 2026-01-05 01:26</div>
            <div class="timeline-body"><p>I think this is wrong. It&#x27;s intended to address cases like:</p>
<pre><code>@dataclass_transform()
def hydrated_dataclass(target: type, *, frozen: bool = False) -&gt; Callable[[type[T]], type[T]]:
    def decorator(cls: type[T]) -&gt; type[T]:
        return cls
    return decorator

@hydrated_dataclass(SomeConfig, frozen=True)
class MyConfig:
    pass
</code></pre>
<p>If we make this change <em>without</em> this declared return type handling, then <code>hydrated_dataclass(SomeConfig, frozen=True)</code> returns <code>type[SomeConfig]</code> with dataclass params, and we apply <em>that</em> as a decorator.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2026-01-05 01:28</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/carljm">@carljm</a> by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2026-01-05 01:28</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/AlexWaygood">@AlexWaygood</a> by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2026-01-05 01:28</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/sharkdp">@sharkdp</a> by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2026-01-05 01:28</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/dcreager">@dcreager</a> by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2026-01-05 01:28</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/ty_python_semantic/resources/mdtest/dataclasses/dataclass_transform.md</code>:1124 on 2026-01-10 00:46</div>
            <div class="timeline-body"><p>I&#x27;m impressed that you support this, but I&#x27;m curious where it came up? Did you see this in the ecosystem?</p>
<p>This won&#x27;t work at runtime with stdlib dataclass -- it expects to get a class object, not a <code>typing.GenericAlias</code>. But I suppose there could be third-party dataclass-transforms that are built to handle <code>GenericAlias</code> at runtime?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/ty_python_semantic/resources/mdtest/dataclasses/dataclass_transform.md</code>:1144 on 2026-01-10 00:50</div>
            <div class="timeline-body"><p>What about then using this like <code>MyClass = decorator(SomeClass)</code>?</p>
<p>Doesn&#x27;t seem to work, even on this branch:</p>
<pre><code>class M1:
    x: int

M2 = decorator(M1)

reveal_type(M2)  # reveals `type[M1] &amp; Any`
</code></pre>
<p>And I&#x27;m not sure where the <code>&amp; Any</code> comes from?</p>
<p>(As noted above, I don&#x27;t think any other type checker supports this non-decorator use of a dataclass transform at all, so I don&#x27;t know that we need to support this edge case, just curious why it doesn&#x27;t work when the base case above does.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/ty_python_semantic/resources/mdtest/dataclasses/dataclass_transform.md</code>:1056 on 2026-01-10 00:53</div>
            <div class="timeline-body"><p>Doesn&#x27;t seem like any other type checkers support this, but it&#x27;s cool that we can.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/ty_python_semantic/src/types/function.rs</code>:752 on 2026-01-10 01:22</div>
            <div class="timeline-body"><p>lol, oops</p>
<p>I guess no other caller cared about the ordering here?</p>
<p>Looking at the usage in <code>infer_class_definition</code>, I think we might need a <code>.rev()</code> call there also, to make the behavior match the comment?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/ty_python_semantic/src/types/call/bind.rs</code>:1220 on 2026-01-10 01:25</div>
            <div class="timeline-body"><p>This is an unfortunate ambiguity baked directly into the <code>dataclass_transform</code> spec. It doesn&#x27;t clarify how we are supposed to tell whether the <code>@dataclass_transform</code> decorated function is a decorator or a decorator factory (yet it clearly specifies that both should be supported). I think the spec&#x27;s assumption is that it doesn&#x27;t matter, because only decorator-syntax usage (with <code>@</code>) is supported, and in that case you can tell how it is used (are there parentheses or not). But we are trying to do something more sophisticated here, and I think it means we have to resort to some kind of heuristic.</p>
<p>But I&#x27;m not sure the heuristic should depend on the annotated return type like this; there&#x27;s no real requirement to annotate your dataclass_transform decorator at all. I think a better heuristic might be based solely on the number, kind, and type of arguments. If only one positional argument is given and it&#x27;s a class type, assume we should decorate that class. Otherwise, assume we are returning the real decorator.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> approved on 2026-01-10 01:28</div>
            <div class="timeline-body"><p>This looks pretty good! We are definitely being more ambitious than other type checkers here (and more ambitious than the spec requires), by supporting non-decorator-syntax usages of <code>dataclass_transform</code> at all. Our initial implementation of <code>dataclass_transform</code> kind of set us on this path, by implementing the logic generally in function-call-binding and having a &quot;DataclassTransformer&quot; type, rather than doing everything as a special case in decorator application. And this PR seems pretty good, so I don&#x27;t see much harm in continuing on this path -- it&#x27;s cool if we can support non-decorator-syntax usage like this.</p>
<p>A few comments inline.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2026-01-10 01:30</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/ty_python_semantic/src/types/call/bind.rs</code>:1258 on 2026-01-10 01:30</div>
            <div class="timeline-body"><p>Worth adding a <code>ClassLiteral::with_dataclass_params</code> to DRY this up a bit? We&#x27;re mentioning a lot of extraneous field names here.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2026-01-10 04:14</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ty_python_semantic/resources/mdtest/dataclasses/dataclass_transform.md</code>:1124 on 2026-01-10 04:14</div>
            <div class="timeline-body"><p>I honestly can&#x27;t remember -- I may have asked Claude to add something to verify that we preserve specialization after seeing handling for it in the code?!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2026-01-10 04:14</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ty_python_semantic/src/types/call/bind.rs</code>:1220 on 2026-01-10 04:14</div>
            <div class="timeline-body"><p>(Okay this is very comforting to hear, haha.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2026-01-10 04:44</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ty_python_semantic/src/types/call/bind.rs</code>:1220 on 2026-01-10 04:44</div>
            <div class="timeline-body"><p>I think that wouldn&#x27;t work for this case, since both functions take a single class as its positional arguments:</p>
<pre><code>from typing_extensions import dataclass_transform

@dataclass_transform()
def hydrated_dataclass[T](target: type[T], *, frozen: bool = False):
    def decorator[U](cls: type[U]) -&gt; type[U]:
        return cls
    return decorator
</code></pre>
<p>For now, I combined the two heuristics.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2026-01-10 13:45</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2026-01-10 13:45</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2026-01-10 13:45</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:22:38 UTC
    </footer>
</body>
</html>
