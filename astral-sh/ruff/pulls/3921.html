<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Implement `flake8_todos` - astral-sh/ruff #3921</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Implement <code>flake8_todos</code></h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/3921">#3921</a>
        opened by <a href="https://github.com/evanrittenhouse">@evanrittenhouse</a>
        on 2023-04-09 02:28
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/evanrittenhouse">@evanrittenhouse</a></div>
            <div class="timeline-body"><p>Completes #3870</p>
<p>Will be able to easily clear #3859 when this lands as well.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2023-04-09 02:55</div>
            <div class="timeline-body"><h2>PR Check Results</h2>
<h3>Ecosystem</h3>
<p>✅ ecosystem check detected no changes.</p>
<h3>Benchmark</h3>
<h4>Linux</h4>
<pre><code>group                                      main                                   pr
-----                                      ----                                   --
linter/all-rules/large/dataset.py          1.01     16.7±0.39ms     2.4 MB/sec    1.00     16.5±0.27ms     2.5 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.01      4.0±0.03ms     4.1 MB/sec    1.00      4.0±0.04ms     4.2 MB/sec
linter/all-rules/numpy/globals.py          1.00    489.6±5.34µs     6.0 MB/sec    1.00    489.5±3.05µs     6.0 MB/sec
linter/all-rules/pydantic/types.py         1.00      6.9±0.06ms     3.7 MB/sec    1.00      6.8±0.08ms     3.7 MB/sec
linter/default-rules/large/dataset.py      1.00      8.0±0.05ms     5.1 MB/sec    1.00      8.0±0.09ms     5.1 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.02  1730.9±42.19µs     9.6 MB/sec    1.00  1704.6±15.47µs     9.8 MB/sec
linter/default-rules/numpy/globals.py      1.02   201.4±16.07µs    14.7 MB/sec    1.00    198.3±6.31µs    14.9 MB/sec
linter/default-rules/pydantic/types.py     1.01      3.6±0.02ms     7.0 MB/sec    1.00      3.6±0.04ms     7.1 MB/sec
parser/large/dataset.py                    1.00      6.4±0.03ms     6.3 MB/sec    1.00      6.4±0.05ms     6.3 MB/sec
parser/numpy/ctypeslib.py                  1.00  1247.8±11.91µs    13.3 MB/sec    1.01   1256.3±4.22µs    13.3 MB/sec
parser/numpy/globals.py                    1.05    132.1±3.26µs    22.3 MB/sec    1.00    125.5±1.78µs    23.5 MB/sec
parser/pydantic/types.py                   1.00      2.7±0.02ms     9.3 MB/sec    1.00      2.7±0.02ms     9.3 MB/sec
</code></pre>
<h4>Windows</h4>
<pre><code>group                                      main                                   pr
-----                                      ----                                   --
linter/all-rules/large/dataset.py          1.00     17.0±0.23ms     2.4 MB/sec    1.00     17.0±0.23ms     2.4 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      4.3±0.07ms     3.9 MB/sec    1.00      4.3±0.04ms     3.9 MB/sec
linter/all-rules/numpy/globals.py          1.00    499.7±8.84µs     5.9 MB/sec    1.00   502.2±17.98µs     5.9 MB/sec
linter/all-rules/pydantic/types.py         1.00      7.1±0.10ms     3.6 MB/sec    1.02      7.2±0.13ms     3.5 MB/sec
linter/default-rules/large/dataset.py      1.00      8.3±0.08ms     4.9 MB/sec    1.01      8.4±0.10ms     4.9 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00  1782.8±30.13µs     9.3 MB/sec    1.00  1779.4±39.27µs     9.4 MB/sec
linter/default-rules/numpy/globals.py      1.00    195.3±3.56µs    15.1 MB/sec    1.04    203.2±9.25µs    14.5 MB/sec
linter/default-rules/pydantic/types.py     1.00      3.8±0.04ms     6.8 MB/sec    1.01      3.8±0.05ms     6.7 MB/sec
parser/large/dataset.py                    1.01      6.7±0.05ms     6.0 MB/sec    1.00      6.7±0.06ms     6.1 MB/sec
parser/numpy/ctypeslib.py                  1.00  1291.7±25.15µs    12.9 MB/sec    1.00  1285.8±27.40µs    13.0 MB/sec
parser/numpy/globals.py                    1.00    130.9±2.78µs    22.5 MB/sec    1.00    130.5±2.24µs    22.6 MB/sec
parser/pydantic/types.py                   1.00      2.9±0.04ms     8.8 MB/sec    1.00      2.9±0.06ms     8.9 MB/sec
</code></pre>
<!-- thollander/actions-comment-pull-request "PR Check Results" -->

</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/evanrittenhouse">@evanrittenhouse</a> on <code>crates/ruff/src/rules/flake8_todo/rules.rs</code>:17 on 2023-04-09 03:01</div>
            <div class="timeline-body"><p>Do we actually want to do this? If not, I'll remove this comment when I implement T006.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/evanrittenhouse">@evanrittenhouse</a> reviewed on 2023-04-09 03:01</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/evanrittenhouse">@evanrittenhouse</a> on <code>crates/ruff/src/checkers/tokens.rs</code>:69 on 2023-04-09 03:01</div>
            <div class="timeline-body"><p>I'll start working on these once this PR is merged</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/evanrittenhouse">@evanrittenhouse</a> reviewed on 2023-04-09 03:01</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @evanrittenhouse on 2023-04-09 03:40</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff/src/checkers/tokens.rs</code>:70 on 2023-04-09 05:43</div>
            <div class="timeline-body"><p>As per the <a href="https://beta.ruff.rs/docs/contributing/#rule-naming-convention">naming convention</a>, I think these should be named <code>Missing[X]InTODO</code> (<em>allow missing author in TODO</em>) where <code>X</code> is the missing part.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff/src/registry.rs</code>:802 on 2023-04-09 05:46</div>
            <div class="timeline-body"><p>I think it's better to avoid single letter prefix for posterity, maybe <code>TOD</code>, <code>TDO</code>, <code>TD</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2023-04-09 05:54</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/evanrittenhouse">@evanrittenhouse</a> reviewed on 2023-04-09 16:09</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/evanrittenhouse">@evanrittenhouse</a> on <code>crates/ruff/src/registry.rs</code>:802 on 2023-04-09 16:09</div>
            <div class="timeline-body"><p>Do we use our own error codes? If so, I'm happy to change it - I only used <code>T</code> because <a href="https://github.com/orsinium-labs/flake8-todos">flake8_todos</a> uses it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/evanrittenhouse">@evanrittenhouse</a> on <code>crates/ruff/src/checkers/tokens.rs</code>:70 on 2023-04-09 16:22</div>
            <div class="timeline-body"><p>Changed!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/evanrittenhouse">@evanrittenhouse</a> reviewed on 2023-04-09 16:22</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff/src/registry.rs</code>:802 on 2023-04-09 17:43</div>
            <div class="timeline-body"><blockquote>
<p>Do we use our own error codes?</p>
</blockquote>
<p>We do to avoid collisions as there are multiple error groups in <code>ruff</code> as compared to a single group in individual plugins. Example: <a href="https://beta.ruff.rs/docs/rules/#flake8-tidy-imports-tid">flake8-tidy-imports (TID)</a> vs <a href="https://github.com/adamchainz/flake8-tidy-imports#rules">Plugin repo (I)</a>. But, let @charliermarsh's take the final call on this.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2023-04-09 17:43</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-04-09 22:30</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff/src/registry.rs</code>:802 on 2023-04-09 22:30</div>
            <div class="timeline-body"><p>Yeah that's right -- we typically use three-letter prefixes to avoid collisions, even if it deviates from upstream. I guess <code>TOD</code> or <code>TDO</code> are equally reasonable here.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-04-09 22:31</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff/src/rules/flake8_todo/rules.rs</code>:14 on 2023-04-09 22:31</div>
            <div class="timeline-body"><p>The <a href="https://rust-lang.github.io/api-guidelines/naming.html">Rust naming convention</a> suggests treating acronyms as one word, so all these should be e.g. <code>InvalidTodoTag</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/evanrittenhouse">@evanrittenhouse</a> reviewed on 2023-04-09 23:57</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/evanrittenhouse">@evanrittenhouse</a> on <code>crates/ruff/src/rules/flake8_todo/rules.rs</code>:14 on 2023-04-09 23:57</div>
            <div class="timeline-body"><p>Done</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/evanrittenhouse">@evanrittenhouse</a> on <code>crates/ruff/src/registry.rs</code>:802 on 2023-04-10 02:03</div>
            <div class="timeline-body"><p>Done</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/evanrittenhouse">@evanrittenhouse</a> reviewed on 2023-04-10 02:03</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff/src/rules/flake8_todo/rules.rs</code>:331 on 2023-04-11 07:06</div>
            <div class="timeline-body"><p>Using <code>capture</code> groups is kind of expensive. Is it necessary to get the captures or is it sufficient to only test if the regex matches?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-04-11 07:07</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff/src/rules/flake8_todo/mod.rs</code>:27 on 2023-04-11 09:04</div>
            <div class="timeline-body"><p>You'll have to change this to <code>assert_messages</code> after #3906 lands. It pretty prints the diagnostics instead of serializing them to yaml.</p>
<pre><code class="language-suggestion">        assert_messages!(snapshot, diagnostics);
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-04-11 09:05</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/evanrittenhouse">@evanrittenhouse</a> reviewed on 2023-04-11 12:07</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/evanrittenhouse">@evanrittenhouse</a> on <code>crates/ruff/src/rules/flake8_todo/rules.rs</code>:331 on 2023-04-11 12:07</div>
            <div class="timeline-body"><p>The only two alternatives I could think of were:</p>
<ol>
<li>Write different regexes for each combination of successful/failed rules.</li>
<li>Just capture a TODO tag and perform string manipulations on the line (for example, split at a colon and ensure that the next character is a space). This _could _ involve additional regexes, though I'd have to think about it more.</li>
</ol>
<p>Neither option felt sufficient to warrant using it over capture groups to me, but happy to change approaches if you'd like.</p>
<p>Out of curiosity, how do you know that regex captures are expensive?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff/src/rules/flake8_todo/rules.rs</code>:331 on 2023-04-11 15:21</div>
            <div class="timeline-body"><p>The regex crate documentation has some notes on performance and recommend to only <a href="https://github.com/rust-lang/regex/blob/master/PERFORMANCE.md#only-ask-for-what-you-need">use what you need</a>. That's why I asked if we &quot;need&quot; it, because, if not, it would be an easy performance win. But it's okay to use it if we need it.</p>
<p>You can see some real-world wins in #3735</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-04-11 15:21</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/evanrittenhouse">@evanrittenhouse</a> reviewed on 2023-04-11 15:29</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/evanrittenhouse">@evanrittenhouse</a> on <code>crates/ruff/src/rules/flake8_todo/mod.rs</code>:27 on 2023-04-11 15:29</div>
            <div class="timeline-body"><p>Sounds good!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/evanrittenhouse">@evanrittenhouse</a> reviewed on 2023-04-11 15:34</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/evanrittenhouse">@evanrittenhouse</a> on <code>crates/ruff/src/rules/flake8_todo/rules.rs</code>:331 on 2023-04-11 15:34</div>
            <div class="timeline-body"><p>Oh cool, thanks!</p>
<p>I think that captures are definitely the easiest solution. Matching is very tough since there could be missing pieces at any point in the comment. I checked the benchmarks above and they seem alright.</p>
<p>If it's cool with you, I'm okay to move forward with this approach - if there are any slowdowns in the future, we could revisit this using <code>find</code>? Only issue I see with that for now is that the implementation could be relatively difficult, I think.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-04-12 07:21</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff/src/rules/flake8_todo/rules.rs</code>:331 on 2023-04-12 07:21</div>
            <div class="timeline-body"><p>Sounds good to me!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "Implement T001, T002, T004, T005, and T007" to "Implement TDO001, TDO002, TDO004, TDO005, TDO006, and TDO007" by @evanrittenhouse on 2023-04-13 17:52</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/evanrittenhouse">@evanrittenhouse</a> on 2023-04-14 02:40</div>
            <div class="timeline-body"><p>@charliermarsh Would you prefer I implement TDO003 in this PR as well, or do we allow partial implementation of plugins?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-04-14 02:48</div>
            <div class="timeline-body"><p>Partial is cool, I just haven't had time to sit down and dig in on this one yet.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/evanrittenhouse">@evanrittenhouse</a> on 2023-04-14 02:50</div>
            <div class="timeline-body"><p>Sorry, didn't mean to rush you at all! Just the first time I've tried implementing a plugin, so wasn't sure how we handle that. Please take your time</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/evanrittenhouse">@evanrittenhouse</a> reviewed on 2023-04-15 15:50</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/evanrittenhouse">@evanrittenhouse</a> on <code>crates/ruff/src/rules/flake8_todo/rules.rs</code>:121 on 2023-04-15 15:50</div>
            <div class="timeline-body"><p><code>get_captured_matches()</code> and <code>get_tag_regex_errors()</code> both call <code>TODO_REGEX.captures_iter()</code>, an expensive operation. I'll need to refactor that to only call it once and pass the capture groups around before this gets merged.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/evanrittenhouse">@evanrittenhouse</a> on 2023-04-15 19:47</div>
            <div class="timeline-body"><p>No idea why these errors are happening - will take a closer look in a bit</p>
<p>E: had to bump the ruleset</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "Implement TDO001, TDO002, TDO004, TDO005, TDO006, and TDO007" to "Implement flake8_todo" by @evanrittenhouse on 2023-04-17 00:56</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff/src/rules/flake8_todo/rules.rs</code>:247 on 2023-04-23 13:40</div>
            <div class="timeline-body"><p>Nit: It could be worth using <a href="https://docs.rs/regex/latest/regex/struct.RegexSet.html"><code>RegexSet</code></a> to avoid scanning the same text multiple times</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff/src/rules/flake8_todo/rules.rs</code>:294 on 2023-04-23 13:41</div>
            <div class="timeline-body"><p>Should we use an <code>if-else</code> here to avoid two diagnostics at the same location?</p>
<pre><code class="language-suggestion">			if tag.to_uppercase() == &quot;TODO&quot; {
                    diagnostics_ref.push(Diagnostic::new(
                        InvalidCapitalizationInTodo {
                            tag: String::from(tag),
                        },
                        range,
                    ));
                } else {
	                diagnostics_ref.push(Diagnostic::new(
	                    InvalidTodoTag {
	                        tag: String::from(tag),
	                    },
	                    range,
	                ));
			}   
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-04-23 13:42</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/evanrittenhouse">@evanrittenhouse</a> reviewed on 2023-04-23 13:53</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/evanrittenhouse">@evanrittenhouse</a> on <code>crates/ruff/src/rules/flake8_todo/rules.rs</code>:294 on 2023-04-23 13:53</div>
            <div class="timeline-body"><p>I'm not sure how heavily we frown upon multiple diagnostics in one spot - I thought it'd be fine in this instance since a &quot;toDo&quot;, for example, also isn't the same as &quot;TODO&quot;, so it's technically both invalid and capitalized incorrectly.</p>
<p>Definitely open to making them exclusive though!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/evanrittenhouse">@evanrittenhouse</a> reviewed on 2023-04-23 13:54</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/evanrittenhouse">@evanrittenhouse</a> on <code>crates/ruff/src/rules/flake8_todo/rules.rs</code>:247 on 2023-04-23 13:54</div>
            <div class="timeline-body"><p>Great point! Didn't realize that exits - I'll change it in a couple
hours, out right now</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/evanrittenhouse">@evanrittenhouse</a> reviewed on 2023-04-23 14:15</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/evanrittenhouse">@evanrittenhouse</a> on <code>crates/ruff/src/rules/flake8_todo/rules.rs</code>:294 on 2023-04-23 14:15</div>
            <div class="timeline-body"><p>On that note, @MichaReiser is it worth implementing autofixes for these rules? I think we could do it for all of them except &quot;missing author&quot; and &quot;missing link&quot;.</p>
<p>E: Going to implement an autofix on TDO006 for now. If there's interest I can check into how we'd do the others</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/evanrittenhouse">@evanrittenhouse</a> on 2023-04-25 02:00</div>
            <div class="timeline-body"><p>Re-marking as draft to fix an edge case and clean up the code a little bit</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Converted to draft by @evanrittenhouse on 2023-04-25 02:00</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "Implement flake8_todo" to "Implement `flake8_todo`" by @evanrittenhouse on 2023-04-25 03:27</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/evanrittenhouse">@evanrittenhouse</a> reviewed on 2023-04-25 15:52</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/evanrittenhouse">@evanrittenhouse</a> on <code>crates/ruff/src/rules/flake8_todo/rules.rs</code>:250 on 2023-04-25 15:52</div>
            <div class="timeline-body"><p>This won't lead to false positives since we update the variable on each TODO. Each link check (the only place this matters) will therefore have an updated value.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/evanrittenhouse">@evanrittenhouse</a> on 2023-04-25 16:25</div>
            <div class="timeline-body"><p>Sorry for the false starts. I believe this is good to go now</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @evanrittenhouse on 2023-04-25 16:25</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff/src/rules/flake8_todo/rules.rs</code>:245 on 2023-05-01 08:32</div>
            <div class="timeline-body"><p>We can speed this up using <code>Indexer.comment_ranges()</code>. It gives you the ranges of all comments and you can slice into the text by using <code>Locator.slice</code></p>
<pre><code>for range in indexer.comment_ranges() {
	let comment = locator.slice(*range);
	...
}
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff/src/rules/flake8_todo/rules.rs</code>:83 on 2023-05-01 08:35</div>
            <div class="timeline-body"><p>Should we document the allowed issue-links (including ids <code>TODO-1234</code>)?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff/src/rules/flake8_todo/rules.rs</code>:274 on 2023-05-01 08:39</div>
            <div class="timeline-body"><p>Do we ned to add a check for this at the end of the file. E.g.</p>
<pre><code class="language-python"># TODO
</code></pre>
<p>No link at the end.</p>
<p>An alternative would be to use a peekable iterator and perform a lookahead to see if the next comment is only separated by whitespace from this comment (or a single line break even and whitespace), and contains an issue link</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff/src/rules/flake8_todo/rules.rs</code>:227 on 2023-05-01 08:42</div>
            <div class="timeline-body"><p>Can we use a case-insensitive match instead of writing out all the different combinations of TODO? Should we also match on <code>fixme</code> or <code>FixMe</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff/src/rules/flake8_todo/rules.rs</code>:330 on 2023-05-01 08:47</div>
            <div class="timeline-body"><p>I wonder if it would improve performance if we avoid capture groups altogether by:</p>
<ul>
<li>Using a Regex to find any occurrences of <code>TODO</code>, <code>FIXME</code> or <code>BUG</code> (<code>regex.find(text)</code>)</li>
<li>Then use <code>str</code> methods to test for author, colon, space, etc).</li>
</ul>
<p>I might be wrong but my impression is that it shouldn't be too hard to write and it has the benefit that we have fewer regex (that I personally find hard to understand and maintain) and less capture group matching. What do you think?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff/src/rules/flake8_todo/rules.rs</code>:383 on 2023-05-01 08:49</div>
            <div class="timeline-body"><p>You can use <code>comment.find(['t', 'T'])</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff/src/rules/flake8_todo/snapshots/ruff__rules__flake8_todo__tests__invalid-capitalization-in-todo_TDO006.py.snap</code>:9 on 2023-05-01 08:50</div>
            <div class="timeline-body"><p>Highlighting the whole comment can become very noisy for long comments. I think it would be better only to highlight the problematic section</p>
<pre><code class="language-suggestion">6 | # ToDo(evanrittenhouse): invalid capitalization
  |      ^^^^  TDO006
</code></pre>
<p>This applies to all diagnostics in this PR.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff/src/rules/flake8_todo/snapshots/ruff__rules__flake8_todo__tests__missing-author-in-todo_TDO002.py.snap</code>:9 on 2023-05-01 08:52</div>
            <div class="timeline-body"><pre><code class="language-suggestion">7 | # TODO: this has no author
  |                ^ TDO002
</code></pre>
<p>Carret should be at the <code>:</code> to highlight where the author name was expected.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff/src/rules/flake8_todo/snapshots/ruff__rules__flake8_todo__tests__missing-author-in-todo_TDO002.py.snap</code>:4 on 2023-05-01 08:53</div>
            <div class="timeline-body"><p>Should we extend the message to explain where the author is expected or give an example?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff/src/rules/flake8_todo/snapshots/ruff__rules__flake8_todo__tests__missing-colon-in-todo_TDO004.py.snap</code>:9 on 2023-05-01 08:53</div>
            <div class="timeline-body"><pre><code class="language-suggestion">6 | # TODO(evanrittenhouse) this has no colon
  |                                                ^ TDO004
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff/src/rules/flake8_todo/snapshots/ruff__rules__flake8_todo__tests__missing-link-in-todo_TDO003.py.snap</code>:8 on 2023-05-01 08:55</div>
            <div class="timeline-body"><p>Is the link expected to always appear at the end or on the next line?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff/src/rules/flake8_todo/snapshots/ruff__rules__flake8_todo__tests__missing-space-after-colon-in-todo_TDO007.py.snap</code>:9 on 2023-05-01 08:55</div>
            <div class="timeline-body"><pre><code class="language-suggestion">6 | # TODO(evanrittenhouse):this has no space after a colon
  |                                                 ^ TDO007
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2023-05-01 08:55</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff/src/rules/flake8_todo/rules.rs</code>:175 on 2023-05-01 11:29</div>
            <div class="timeline-body"><p>Autofix titles gives suggestion on what to do, so I think this might be more helpful and inline with other titles:</p>
<pre><code class="language-suggestion">        let InvalidCapitalizationInTodo { tag } = self;
        &quot;Replace `{tag}` with `TODO`&quot;.to_string()
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff/src/rules/flake8_todo/rules.rs</code>:310 on 2023-05-01 11:46</div>
            <div class="timeline-body"><p>nit: Should we use the same pattern as used at other places? Define a mutable diagnostic, check if autofix is enabled and then update the diagnostic with the edits.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff/src/rules/flake8_todo/rules.rs</code>:253 on 2023-05-01 11:52</div>
            <div class="timeline-body"><p>Just curious to know if this is beneficial. If it is, shouldn't it be <em>outside</em> the loop?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2023-05-01 11:52</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/evanrittenhouse">@evanrittenhouse</a> on <code>crates/ruff/src/rules/flake8_todo/rules.rs</code>:330 on 2023-05-01 15:13</div>
            <div class="timeline-body"><p>I can definitely look into it. My worry with <code>str</code> methods is that the rules may not all be applied together, so testing for stuff may get tricky. I'm sure there's a way, but I'll have to check it out.</p>
<p>For example, testing for a colon in <code># TODO: test</code>, <code># TODO we need to fix a few things: a, b, and c</code> and <code># TODO (evanrittenhouse) test</code> is tough because you don't know where the colon should be. Should it be after the closing parenthesis of an author tag - that may not exist. We can't map it off of an offset/column since we don't know how long the author/tag is. We also can't just test if a colon is in the string since it could be in the TODO's text.</p>
<p>Again, I'm sure there's a way, and I agree that it'd be easier to reason about than regex capture groups. Just haven't had a chance to sit down and think about what the detection code would look like :)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/evanrittenhouse">@evanrittenhouse</a> reviewed on 2023-05-01 15:13</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/evanrittenhouse">@evanrittenhouse</a> on <code>crates/ruff/src/rules/flake8_todo/rules.rs</code>:274 on 2023-05-01 15:14</div>
            <div class="timeline-body"><p>I like the idea of a peekable iterator. I'll rework the code to perform a lookahead on one of those rather than the current lookbehind - thanks for the idea!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/evanrittenhouse">@evanrittenhouse</a> reviewed on 2023-05-01 15:14</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff/src/rules/flake8_todo/rules.rs</code>:330 on 2023-05-01 15:24</div>
            <div class="timeline-body"><blockquote>
<p>For example, testing for a colon in # TODO: test, # TODO we need to fix a few things: a, b, and c and # TODO (evanrittenhouse) test</p>
</blockquote>
<p>My understanding is that the colon should either come directly after the <code>TODO</code> or after the author. Is this correct? If so, then we would need to skip the &quot;author&quot; part even if the author rule is disabled. This isn't any different than what the <code>Regex</code> is doing today, it just happens implicitly.</p>
<p>I'm also OK merging as is and playing around with string methods as a separate PR.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-05-01 15:24</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/evanrittenhouse">@evanrittenhouse</a> on <code>crates/ruff/src/rules/flake8_todo/rules.rs</code>:330 on 2023-05-01 15:47</div>
            <div class="timeline-body"><p>Yeah, it'd just be copying the <code>Regex</code> into code. If it's cool with you, I'll probably make the speed adjustments/<code>Peekable</code> changes as mentioned above, then try to merge?</p>
<p>I've noted down the string method stuff in my to-do list, so I'll check that out when I get some time!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/evanrittenhouse">@evanrittenhouse</a> reviewed on 2023-05-01 15:47</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Converted to draft by @evanrittenhouse on 2023-05-02 02:53</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-05-02 07:08</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff/src/rules/flake8_todo/rules.rs</code>:330 on 2023-05-02 07:08</div>
            <div class="timeline-body"><p>Sounds good to me. Thank you</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/evanrittenhouse">@evanrittenhouse</a> reviewed on 2023-05-03 01:25</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/evanrittenhouse">@evanrittenhouse</a> on <code>crates/ruff/src/rules/flake8_todo/snapshots/ruff__rules__flake8_todo__tests__missing-link-in-todo_TDO003.py.snap</code>:8 on 2023-05-03 01:25</div>
            <div class="timeline-body"><p>On the next line. I'm thinking of flagging the line with the <code>TODO</code> and saying along the lines of &quot;the next line should have an issue link&quot;. I think it would break if we tried throwing the diagnostic on the line after the <code>TODO</code> in the case where the <code>TODO</code> is the last line of the file.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/evanrittenhouse">@evanrittenhouse</a> on <code>crates/ruff/src/rules/flake8_todo/rules.rs</code>:376 on 2023-05-04 01:52</div>
            <div class="timeline-body"><p>@MichaReiser Apologies if this is a basic question. Is there a better way to handle the second <code>unwrap()</code> call? This is my first PR really handling the new <code>TextRange/TextSize</code> structs, so not sure if there's a more idiomatic way.</p>
<p>I'm also curious - why do those two structs use <code>u32</code> over <code>usize</code> as their underlying offset measure?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/evanrittenhouse">@evanrittenhouse</a> reviewed on 2023-05-04 01:52</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/evanrittenhouse">@evanrittenhouse</a> reviewed on 2023-05-04 01:57</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/evanrittenhouse">@evanrittenhouse</a> on <code>crates/ruff/src/rules/flake8_todo/rules.rs</code>:245 on 2023-05-04 01:57</div>
            <div class="timeline-body"><p>Can look into this in another PR as it'll involve some larger changes</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-05-04 06:34</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff/src/rules/flake8_todo/rules.rs</code>:376 on 2023-05-04 06:34</div>
            <div class="timeline-body"><blockquote>
<p>Apologies if this is a basic question. Is there a better way to handle the second unwrap() call?</p>
</blockquote>
<p>You can do:</p>
<pre><code>comment.find(['t', 'T']).and_then(|pos| TextSize::try_from(pos).ok()).unwrap()
</code></pre>
<p>I recommend changing the function's return type to <code>TextSize</code>. Using <code>TextSize</code> communicates that this is a byte offset position and not any other index (or integer).</p>
<blockquote>
<p>I'm also curious - why do those two structs use u32 over usize as their underlying offset measure?</p>
</blockquote>
<p>The motivation is that <code>u32</code> requires half the space compared to an <code>usize</code> on 64 bit systems and that should be more than sufficient for any reasonable program (you can represent files up to 4 GB). The result is that ruff uses less memory and is faster because it reads and writes less data, and more data fits into a single L1 cache line.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/evanrittenhouse">@evanrittenhouse</a> reviewed on 2023-05-04 13:29</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/evanrittenhouse">@evanrittenhouse</a> on <code>crates/ruff/src/rules/flake8_todo/rules.rs</code>:376 on 2023-05-04 13:29</div>
            <div class="timeline-body"><p>Ah makes sense. Thanks for the tip and detailed explanation!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @evanrittenhouse on 2023-05-09 15:12</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @evanrittenhouse on 2023-05-09 15:12</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/evanrittenhouse">@evanrittenhouse</a> on 2023-05-09 15:13</div>
            <div class="timeline-body"><p>@MichaReiser Re-requesting review since I ended up getting rid of the regex capture groups to better place diagnostics; quite a bit has changed.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-05-09 18:53</div>
            <div class="timeline-body"><p>I'm happy to review.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/evanrittenhouse">@evanrittenhouse</a> on 2023-05-09 19:02</div>
            <div class="timeline-body"><p>@charliermarsh Go for it!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff/src/rules/flake8_todo/rules.rs</code>:177 on 2023-05-10 07:27</div>
            <div class="timeline-body"><p>Nit:</p>
<pre><code class="language-suggestion">        &quot;Replace `{tag}` with `TODO`&quot;.to_string()
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff/src/rules/flake8_todo/rules.rs</code>:233 on 2023-05-10 07:30</div>
            <div class="timeline-body"><p>Nit: You can use a fixed array here instead since the indices all start at 0</p>
<pre><code class="language-suggestion">
static PATTERN_TAG_LENGTH: &amp;'static [usize] = [
    &quot;TODO&quot;.len(),
    &quot;BUG&quot;.len(),
    &quot;FIXME&quot;.len(),
    &quot;XXX&quot;.len(),
];
</code></pre>
<p>And you can access the length using <code>PATTERN_TAG_LENGTH.get(index)</code> (or even use <code>PATTERN_TAG_LENGTH[index]</code> because the index being out of bounds is a programming error and not something that we need to handle gracefully)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff/src/rules/flake8_todo/rules.rs</code>:245 on 2023-05-10 07:33</div>
            <div class="timeline-body"><p>Nit: Can we use <code>Indexer.comment_ranges()</code> with <code>locator.slice(range)</code> It would avoid iterating over all comments.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff/src/rules/flake8_todo/rules.rs</code>:310 on 2023-05-10 07:38</div>
            <div class="timeline-body"><pre><code class="language-suggestion">        content: &amp;comment[tag_start_offset..tag_start_offset + tag_length]
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff/src/rules/flake8_todo/rules.rs</code>:334 on 2023-05-10 07:42</div>
            <div class="timeline-body"><p>Will this generate two diagnostics, <code>TDO-001</code> and <code>TDO-006</code>, for <code>Todo</code>? I think we should generally avoid emitting multiple diagnostics for the same range when possible if both have the same (manual or automated) fix.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff/src/rules/flake8_todo/rules.rs</code>:348 on 2023-05-10 07:43</div>
            <div class="timeline-body"><p>Nit:</p>
<pre><code class="language-suggestion">                invalid_capitalization.set_fix(Fix::unspecified(Edit::range_replacement(
                    &quot;TODO&quot;.to_string(),
                    tag.range
                )));
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff/src/rules/flake8_todo/rules.rs</code>:367 on 2023-05-10 07:44</div>
            <div class="timeline-body"><p>I believe <code>From</code> should work here</p>
<pre><code class="language-suggestion">    let mut relative_offset: usize = usize::from(tag.range.end() - comment_range.start())
</code></pre>
<p>... or is this the same as using <code>tag.range.len()</code> (you want the length of the tag?)</p>
<p>But I would even recommend to use <code>TextSize</code> to make it clear that this is a byte offset (and not a character index)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff/src/rules/flake8_todo/rules.rs</code>:368 on 2023-05-10 07:47</div>
            <div class="timeline-body"><p>My understanding is that <code>relative_offset</code> is a byte offset. That's why using <code>chars().skip(offset)</code> will give you an incorrect result if the text contains any non-ascii characters because they are 2-4 bytes long.</p>
<pre><code class="language-suggestion">    let mut comment_rest = &amp;comment[usize::from(relative_offset)..];
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff/src/rules/flake8_todo/rules.rs</code>:398 on 2023-05-10 08:12</div>
            <div class="timeline-body"><p>Nit: I think you can simplify this somewhat by using <code>trim_start</code> and <code>starts_with</code></p>
<pre><code class="language-rust">let trimmed = comment_rest.trim_start();
let content_offset = comment_rest.text_len() = trimmed.text_len(); // whitespace length

let author_end = content_offset + if trimmed.starts_with('(') {
	if let Some(end_index) = trimmed.find(')') {
		// Test if it is not empty? 
		TextSize::try_from(end_index + 1).unwrap()
	} else {
		// Missing closing ')'
		// Create a diagnostic?
		trimmed.text_len()
	}
} else {
	diagnostics.push(Diagnostic::new(
          MissingAuthorInTodo,
          TextRange::at(content_offset, TextSize::new(1)),
      ));

	TextSize::new(0)
};

let after_author = &amp;comment_rest[usize::from(author_end)..];

let after_colon = if let Some((_colon, after_colon)) = after_author.split_once(':') {
	if after_colon.starts_with(' ') {
		// all good
		&amp;after_colon[1..]
	} else {
		diagnostics.push(Diagnostic::new(
              MissingSpaceAfterColonInTodo,
              TextRange::at(range, TextSize::new(1)),
          ));
    }
} else {
	// No colon
	diagnostics.push(Diagnostic::new(
          MissingColonInTodo,
          TextRange::at(adjusted_colon_position, TextSize::new(1)),
      ));
};

if after_colon.is_empty() {
	diagnostics.push(Diagnostic::new(
          MissingTextInTodo,
          TextRange::at(comment_range.end(), TextSize::new(1)),
      )),
}
</code></pre>
<p>I don't know if this is really better, but working with strings rather than a char iterator can sometimes be easier.</p>
<p>I haven't updated all ranges.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff/src/rules/flake8_todo/rules.rs</code>:415 on 2023-05-10 08:16</div>
            <div class="timeline-body"><p>Using <code>TextSize::new(1)</code> as length here is unsafe in case the first character after the TODO is a non-ascii character, because it then only includes the first byte of the multi-byte character.</p>
<p>What you can do is either compute the size of the next character <code>text_after_range_end.chars().next().map(TextLen::text_len).unwrap_or_default()</code> or we change the range to highlight the tag (I know, that's the opposite of what I said last time, I'm sorry). Highlighting the tag might be easier.</p>
<p>This is also true for other places where you use <code>TextSize::new(1)</code> as the range's length</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2023-05-10 08:18</div>
            <div class="timeline-body"><p>Amazing work! 🎸🎸🎸</p>
<p>I have a few NIT comments where I let you decide whether you want to address them or keep the code as is.</p>
<p>The one issue that we need to fix before merging is that you use <code>TextSize::new(1)</code> as the range's length where we don't know what the character in that range is. This can panic if the character in that range is a non-ascii character (multi-byte character) because we then slice of the first byte of the character.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/evanrittenhouse">@evanrittenhouse</a> reviewed on 2023-05-10 13:53</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/evanrittenhouse">@evanrittenhouse</a> on <code>crates/ruff/src/rules/flake8_todo/rules.rs</code>:367 on 2023-05-10 13:53</div>
            <div class="timeline-body"><p>So it's technically the distance of the <code>#</code> denoting the start of the comment and the last character of the tag. For example, if you had: <code># TODO</code>, <code>tag.range.len()</code> would be 4 but <code>relative_offset</code> would be 6.</p>
<p>This is because <code>flake8_todo</code> matches <a href="https://github.com/orsinium-labs/flake8-todos/blob/master/flake8_todos/_rules.py#L12">all whitepsace</a> before the tag. Something like <code>#    TODO</code> would still match our regex, where <code>relative offset</code> would be 8, while <code>tag.range.len()</code> would still be 4</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/evanrittenhouse">@evanrittenhouse</a> on <code>crates/ruff/src/rules/flake8_todo/rules.rs</code>:334 on 2023-05-10 13:58</div>
            <div class="timeline-body"><p>Sounds good to me, I'll keep that in mind for future changes as well</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/evanrittenhouse">@evanrittenhouse</a> reviewed on 2023-05-10 13:58</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/evanrittenhouse">@evanrittenhouse</a> reviewed on 2023-05-10 17:50</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/evanrittenhouse">@evanrittenhouse</a> on <code>crates/ruff/src/rules/flake8_todo/rules.rs</code>:415 on 2023-05-10 17:50</div>
            <div class="timeline-body"><p>Ah I see what you mean - okay, yeah. I'll just stick to pointing the new Diagnostic to the <code>tag</code> for now, that seems much easier</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff/src/rules/flake8_todo/rules.rs</code>:93 on 2023-05-10 18:20</div>
            <div class="timeline-body"><p>I'm curious about this rule. It feels much more opinionated than the other rules and perhaps even unconventional (I haven't worked on a project with this requirement before). What are your thoughts on its relevance? I know it's part of the original implementation, but I wonder if this will be a rule that is <code>ignore</code>d more often than is healthy.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-05-10 18:20</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/evanrittenhouse">@evanrittenhouse</a> on <code>crates/ruff/src/rules/flake8_todo/rules.rs</code>:93 on 2023-05-10 18:26</div>
            <div class="timeline-body"><p>It seems a bit different from the others, to be sure. I'd be okay with removing it. Seems like fixing it could take a decent chunk of work (i.e. making a new Github issue or something). Pretty much only included it since it was mentioned in the original <code>flake8-todo</code>.</p>
<p>Please let me know what you think! I think there'll be some additional work here because of the byte offset issue that Micha mentioned above, so happy to work these changes in too.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/evanrittenhouse">@evanrittenhouse</a> reviewed on 2023-05-10 18:26</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-05-10 19:28</div>
            <div class="timeline-body"><p>One common false positive I'm seeing here is around comments that include the word &quot;bug&quot; in them:</p>
<pre><code class="language-py"># We need to do the same for ArchivedAttachment to avoid
# bugs if deleted attachments are later restored.
ArchivedAttachment.objects.filter(messages__recipient_id=stream.recipient_id).update(
    is_realm_public=None
)
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/evanrittenhouse">@evanrittenhouse</a> on 2023-05-10 19:35</div>
            <div class="timeline-body"><p>Hmm, good point.</p>
<p>The regex will only match tags which have whitespace in front of them, so in this case it's catching &quot;bug&quot; because of the space before it (e.g. <code># some bug here</code> wouldn't match our regex since there's non-whitespace before it). I wonder if we could ignore the tag if the line preceding it is a comment? That would solve this case, but on the flip side we'd ignore cases like this:</p>
<pre><code># implement flake8-todo
# BUG: not catching tags properly
</code></pre>
<p>Any thoughts/alternatives are welcome!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-05-10 20:17</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff/src/rules/flake8_todo/rules.rs</code>:93 on 2023-05-10 20:17</div>
            <div class="timeline-body"><p>I looked through a couple repos that have this rule enabled. Of the ~ten I checked, three had this disabled (<a href="https://github.com/project-march/ProjectMarch/blob/1747-ros-implementation-e-stop-and-pdb/.flake8">1</a>, <a href="https://github.com/aws-samples/aws-security-reference-architecture-examples/blob/main/.flake8#L19">2</a>, <a href="https://github.com/interactions-py/interactions.py/blob/stable/setup.cfg#L59">3</a>), although one had the author rules disabled and kept this one. So, maybe we just leave it, and expect people to configure based on their project preferences.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-05-10 20:19</div>
            <div class="timeline-body"><p>Is the issue that we can't rely on capitalization, or parentheses, or the presence of a colon because we're linting against the absence of those things? I'm wondering if we just remove BUG since it's so generic. ESLint's <a href="https://eslint.org/docs/latest/rules/no-warning-comments"><code>no-warning-comments</code></a> rule defaults to TODO, FIXME, and XXX.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/evanrittenhouse">@evanrittenhouse</a> on 2023-05-10 20:51</div>
            <div class="timeline-body"><p>Yep, exactly - the more traditional measures of a TODO tag could be missing. I'm happy to remove <code>BUG</code>. I'm going to implement some of the above changes tonight, so I'll do that then.</p>
<p>E: on second thought, we could make <code>BUG</code>, <code>FIXME</code>, and <code>XXX</code> case-insensitive as well, and only catch the all-uppercase case. That would also effectively force precedence of <code>InvalidTodoTag</code> over <code>InvalidCapitalizationInTodo</code>, which seems like it makes more sense IMHO; if you have <code># fixme: </code>, we should prompt the user to change the tag to <code># TODO</code> vs. <code># FIXME</code>, since the latter would just cause <code>InvalidTodoTag</code> to throw on Ruff's next pass. Feels like that may be the best middle ground?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-05-12 01:02</div>
            <div class="timeline-body"><p>@evanrittenhouse - Do you mind just re-requesting me when the above is reflected, and I'll give it a last look + merge?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/evanrittenhouse">@evanrittenhouse</a> on 2023-05-12 01:04</div>
            <div class="timeline-body"><p>@charliermarsh sounds good. Do we want to go with the uppercase-only regex or do we want to remove BUG entirely?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-05-12 01:08</div>
            <div class="timeline-body"><p>Let's just remove BUG, I think.</p>
<p>Also -- what do you think about using <code>TD</code> instead of <code>TDO</code>? I find the <code>O</code> and the <code>0</code> a bit visually confusing.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/evanrittenhouse">@evanrittenhouse</a> reviewed on 2023-05-12 04:06</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/evanrittenhouse">@evanrittenhouse</a> on <code>crates/ruff/src/rules/flake8_todo/rules.rs</code>:398 on 2023-05-12 04:06</div>
            <div class="timeline-body"><p>Really appreciate this detailed suggestion. Makes it much easier to reason about than the <code>char</code> iterator approach I was using</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @charliermarsh by @evanrittenhouse on 2023-05-12 04:31</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/evanrittenhouse">@evanrittenhouse</a> on 2023-05-12 11:39</div>
            <div class="timeline-body"><p>I'm not super sure why those tests are failing - it seems like they're referencing the old snapshots which no longer exist, but I already removed them so I'm not even really sure why they're being referenced</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/JonathanPlasse">@JonathanPlasse</a> on 2023-05-12 11:59</div>
            <div class="timeline-body"><p>These snapshots must be deleted.</p>
<pre><code>/home/runner/work/ruff/ruff/crates/ruff/src/rules/flake8_todo/snapshots/ruff__rules__flake8_todo__tests__invalid-capitalization-in-todo_TDO006.py.snap
  /home/runner/work/ruff/ruff/crates/ruff/src/rules/flake8_todo/snapshots/ruff__rules__flake8_todo__tests__missing-colon-in-todo_TDO004.py.snap
  /home/runner/work/ruff/ruff/crates/ruff/src/rules/flake8_todo/snapshots/ruff__rules__flake8_todo__tests__missing-author-in-todo_TDO002.py.snap
  /home/runner/work/ruff/ruff/crates/ruff/src/rules/flake8_todo/snapshots/ruff__rules__flake8_todo__tests__missing-text-in-todo_TDO005.py.snap
  /home/runner/work/ruff/ruff/crates/ruff/src/rules/flake8_todo/snapshots/ruff__rules__flake8_todo__tests__invalid-todo-tag_TDO001.py.snap
  /home/runner/work/ruff/ruff/crates/ruff/src/rules/flake8_todo/snapshots/ruff__rules__flake8_todo__tests__missing-space-after-colon-in-todo_TDO007.py.snap
  /home/runner/work/ruff/ruff/crates/ruff/src/rules/flake8_todo/snapshots/ruff__rules__flake8_todo__tests__missing-link-in-todo_TDO003.py.snap
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/JonathanPlasse">@JonathanPlasse</a> on 2023-05-12 12:09</div>
            <div class="timeline-body"><p>You can do this automatically by running</p>
<pre><code class="language-console">cargo insta test --all --all-features --delete-unreferenced-snapshots
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-05-13 13:10</div>
            <div class="timeline-body"><p>Gonna do one pass over the docs then merge.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "Implement `flake8_todo`" to "Implement `flake8_todos`" by @charliermarsh on 2023-05-13 14:01</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-05-13 14:02</div>
            <div class="timeline-body"><p>There is one bug here, whereby links aren't detected in multiline comments, i.e., this is a false positive:</p>
<pre><code class="language-py"># TODO: here's a TODO on the last line with no link
# Here's more content.
# TDO-3870
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @charliermarsh on 2023-05-13 14:19</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2023-05-13 14:19</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2023-05-13 16:05</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 16:57:00 UTC
    </footer>
</body>
</html>
