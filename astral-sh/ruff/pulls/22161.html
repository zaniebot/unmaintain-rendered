<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[ty] Add support for dict literals and dict() calls as default values for parameters with TypedDict types - astral-sh/ruff #22161</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[ty] Add support for dict literals and dict() calls as default values for parameters with TypedDict types</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/ruff/pull/22161">#22161</a>
        opened by <a href="https://github.com/Hugo-Polloli">@Hugo-Polloli</a>
        on 2025-12-23 13:07
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Hugo-Polloli">@Hugo-Polloli</a></div>
            <div class="timeline-body"><h2>Summary</h2>
<p>Fixes https://github.com/astral-sh/ty/issues/2161</p>
<ul>
<li>Infer parameter default expressions using the parameter annotation as type context.</li>
<li>Fix <code>invalid-parameter-default</code> false positives for <code>TypedDict</code> defaults (literals <code>{...}</code> and calls <code>dict(...)</code>).</li>
<li>Add mdtests covering valid and invalid <code>TypedDict</code> defaults plus a non-<code>TypedDict</code> assignability case.</li>
</ul>
<h2>Test Plan</h2>
<ul>
<li><p>Assert no diagnostics for <code>Foo</code> defaults via <code>{&quot;x&quot;: 42}</code> and <code>dict(x=42)</code></p>
</li>
<li><p>Assert <code>invalid-parameter-default</code> for missing key, wrong value type, extra key in <code>Foo</code> defaults and non-assignable default (<code>tuple[int] = ()</code>)</p>
</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/astral-sh-bot[bot]">@astral-sh-bot[bot]</a> on 2025-12-23 13:09</div>
            <div class="timeline-body"><!-- generated-comment typing_conformance_diagnostics_diff -->

<h2>Diagnostic diff on <a href="https://github.com/python/typing/tree/9f6d8ced7cd1c8d92687a4e9c96d7716452e471e/conformance">typing conformance tests</a></h2>
<p>No changes detected when running ty on typing conformance tests âœ…</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/astral-sh-bot[bot]">@astral-sh-bot[bot]</a> on 2025-12-23 13:10</div>
            <div class="timeline-body"><!-- generated-comment mypy_primer -->

<h2><code>mypy_primer</code> results</h2>
<details>
<summary>Changes were detected when running on open source projects</summary>

<pre><code class="language-diff">mypy (https://github.com/python/mypy)
- mypy/typeshed/stdlib/tkinter/__init__.pyi:584:9: error[invalid-parameter-default] Default value of type `dict[Unknown, Unknown]` is not assignable to annotated parameter type `_GridIndexInfo`
- mypy/typeshed/stdlib/tkinter/__init__.pyi:594:9: error[invalid-parameter-default] Default value of type `dict[Unknown, Unknown]` is not assignable to annotated parameter type `_GridIndexInfo`
- Found 1756 diagnostics
+ Found 1754 diagnostics

trio (https://github.com/python-trio/trio)
- src/trio/_core/_ki.py:130:13: error[invalid-parameter-default] Default value of type `ReferenceType[Self@__init__]` is not assignable to annotated parameter type `ReferenceType[WeakKeyIdentityDictionary[_KT@WeakKeyIdentityDictionary, _VT@WeakKeyIdentityDictionary]]`
- Found 482 diagnostics
+ Found 481 diagnostics

prefect (https://github.com/PrefectHQ/prefect)
- src/integrations/prefect-dbt/prefect_dbt/core/settings.py:94:28: error[invalid-assignment] Object of type `T@resolve_block_document_references | dict[str, Any] | str | ... omitted 4 union elements` is not assignable to `dict[str, Any]`
+ src/integrations/prefect-dbt/prefect_dbt/core/settings.py:94:28: error[invalid-assignment] Object of type `T@resolve_block_document_references | dict[str, Any]` is not assignable to `dict[str, Any]`
- src/integrations/prefect-dbt/prefect_dbt/core/settings.py:99:28: error[invalid-assignment] Object of type `T@resolve_variables | str | int | ... omitted 4 union elements` is not assignable to `dict[str, Any]`
+ src/integrations/prefect-dbt/prefect_dbt/core/settings.py:99:28: error[invalid-assignment] Object of type `T@resolve_variables | dict[str, Any]` is not assignable to `dict[str, Any]`
- src/prefect/cli/deploy/_core.py:86:21: error[invalid-assignment] Object of type `T@resolve_block_document_references | dict[str, Any] | str | ... omitted 4 union elements` is not assignable to `dict[str, Any]`
+ src/prefect/cli/deploy/_core.py:86:21: error[invalid-assignment] Object of type `T@resolve_block_document_references | dict[str, Any]` is not assignable to `dict[str, Any]`
- src/prefect/cli/deploy/_core.py:87:21: error[invalid-assignment] Object of type `T@resolve_variables | str | int | ... omitted 4 union elements` is not assignable to `dict[str, Any]`
+ src/prefect/cli/deploy/_core.py:87:21: error[invalid-assignment] Object of type `T@resolve_variables` is not assignable to `dict[str, Any]`
- src/prefect/deployments/steps/core.py:137:38: error[invalid-argument-type] Argument is incorrect: Expected `T@resolve_variables`, found `T@resolve_block_document_references | dict[str, Any] | str | ... omitted 4 union elements`
+ src/prefect/deployments/steps/core.py:137:38: error[invalid-argument-type] Argument is incorrect: Expected `T@resolve_variables`, found `T@resolve_block_document_references | dict[str, Any]`
- src/prefect/utilities/templating.py:320:13: error[invalid-assignment] Invalid subscript assignment with key of type `object` and value of type `T@resolve_block_document_references | dict[str, Any] | str | ... omitted 4 union elements` on object of type `dict[str, Any]`
+ src/prefect/utilities/templating.py:320:13: error[invalid-assignment] Invalid subscript assignment with key of type `object` and value of type `T@resolve_block_document_references | dict[str, Any]` on object of type `dict[str, Any]`
- src/prefect/utilities/templating.py:323:16: error[invalid-return-type] Return type does not match returned value: expected `T@resolve_block_document_references | dict[str, Any]`, found `list[T@resolve_block_document_references | dict[str, Any] | str | ... omitted 5 union elements]`
+ src/prefect/utilities/templating.py:323:16: error[invalid-return-type] Return type does not match returned value: expected `T@resolve_block_document_references | dict[str, Any]`, found `list[T@resolve_block_document_references | dict[str, Any] | Unknown]`
- src/prefect/utilities/templating.py:437:16: error[invalid-return-type] Return type does not match returned value: expected `T@resolve_variables`, found `dict[object, T@resolve_variables | str | int | ... omitted 5 union elements]`
+ src/prefect/utilities/templating.py:437:16: error[invalid-return-type] Return type does not match returned value: expected `T@resolve_variables`, found `dict[object, T@resolve_variables | Unknown]`
- src/prefect/utilities/templating.py:442:16: error[invalid-return-type] Return type does not match returned value: expected `T@resolve_variables`, found `list[T@resolve_variables | str | int | ... omitted 5 union elements]`
+ src/prefect/utilities/templating.py:442:16: error[invalid-return-type] Return type does not match returned value: expected `T@resolve_variables`, found `list[T@resolve_variables | Unknown]`
- src/prefect/workers/base.py:232:13: error[invalid-argument-type] Argument is incorrect: Expected `T@resolve_variables`, found `T@resolve_block_document_references | dict[str, Any] | str | ... omitted 4 union elements`
+ src/prefect/workers/base.py:232:13: error[invalid-argument-type] Argument is incorrect: Expected `T@resolve_variables`, found `T@resolve_block_document_references | dict[str, Any]`
- src/prefect/workers/base.py:234:20: error[invalid-argument-type] Argument expression after ** must be a mapping type: Found `T@resolve_variables | str | int | ... omitted 4 union elements`
+ src/prefect/workers/base.py:234:20: error[invalid-argument-type] Argument expression after ** must be a mapping type: Found `T@resolve_variables`

scikit-build-core (https://github.com/scikit-build/scikit-build-core)
- src/scikit_build_core/build/wheel.py:98:20: error[no-matching-overload] No overload of bound method `__init__` matches arguments
- Found 48 diagnostics
+ Found 47 diagnostics

static-frame (https://github.com/static-frame/static-frame)
- static_frame/core/bus.py:675:16: error[invalid-return-type] Return type does not match returned value: expected `InterGetItemILocReduces[Bus[Any], object_]`, found `InterGetItemILocReduces[Self@iloc | Bus[Any], object_ | Self@iloc]`
+ static_frame/core/bus.py:671:16: error[invalid-return-type] Return type does not match returned value: expected `InterGetItemLocReduces[Bus[Any], object_]`, found `InterGetItemLocReduces[Bus[Any] | TypeBlocks | Batch | ... omitted 6 union elements, object_]`
+ static_frame/core/bus.py:675:16: error[invalid-return-type] Return type does not match returned value: expected `InterGetItemILocReduces[Bus[Any], object_]`, found `InterGetItemILocReduces[Bus[Any] | Bottom[Index[Any]] | TypeBlocks | ... omitted 6 union elements, object_ | Self@iloc]`
- static_frame/core/series.py:772:16: error[invalid-return-type] Return type does not match returned value: expected `InterGetItemILocReduces[Series[Any, Any], TVDtype@Series]`, found `InterGetItemILocReduces[Series[Any, Any] | Bottom[Index[Any]] | TypeBlocks | ... omitted 6 union elements, TVDtype@Series]`
+ static_frame/core/series.py:772:16: error[invalid-return-type] Return type does not match returned value: expected `InterGetItemILocReduces[Series[Any, Any], TVDtype@Series]`, found `InterGetItemILocReduces[Series[Any, Any] | TypeBlocks | Batch | ... omitted 6 union elements, TVDtype@Series]`
+ static_frame/core/yarn.py:418:16: error[invalid-return-type] Return type does not match returned value: expected `InterGetItemILocReduces[Yarn[Any], object_]`, found `InterGetItemILocReduces[Yarn[Any] | TypeBlocks | Batch | ... omitted 6 union elements, object_]`
- Found 1836 diagnostics
+ Found 1838 diagnostics

pandas-stubs (https://github.com/pandas-dev/pandas-stubs)
- pandas-stubs/_typing.pyi:1232:16: warning[unused-ignore-comment] Unused blanket `type: ignore` directive
- tests/frame/test_groupby.py:229:15: error[type-assertion-failure] Type `Series[Any]` does not match asserted type `Series[str | bytes | int | ... omitted 12 union elements]`
- tests/frame/test_groupby.py:625:15: error[type-assertion-failure] Type `Series[Any]` does not match asserted type `Series[str | bytes | int | ... omitted 12 union elements]`
- Found 5160 diagnostics
+ Found 5157 diagnostics


</code></pre>
</details>

<details>
<summary>Memory usage changes were detected when running on open source projects</summary>

<pre><code class="language-diff">trio (https://github.com/python-trio/trio)
-     struct fields = ~11MB
+     struct fields = ~12MB


</code></pre>
</details>

</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ty</span> added by @AlexWaygood on 2025-12-23 13:13</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-12-24 11:30</div>
            <div class="timeline-body"><p>The ecosystem results look great! I wouldn't worry about the new diagnostics on <code>rotki</code> or some of the diagnostics where all that's happening is the message changing slightly. We're a bit nondeterministic right now; those just look like our standard flakes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @Hugo-Polloli on 2025-12-27 14:23</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @Hugo-Polloli on 2025-12-27 14:23</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @AlexWaygood by @Hugo-Polloli on 2025-12-27 14:23</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @sharkdp by @Hugo-Polloli on 2025-12-27 14:23</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @dcreager by @Hugo-Polloli on 2025-12-27 14:23</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Hugo-Polloli">@Hugo-Polloli</a> on 2025-12-27 14:55</div>
            <div class="timeline-body"><blockquote>
<p>The ecosystem results look great! I wouldn't worry about the new diagnostics on <code>rotki</code> or some of the diagnostics where all that's happening is the message changing slightly. We're a bit nondeterministic right now; those just look like our standard flakes.</p>
</blockquote>
<p>Thanks ! I checked too and from my understanding things are looking ok :)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-12-29 09:22</div>
            <div class="timeline-body"><p>Thank you for working on this. Almost the entire team is out this week. It may take a few days before someone finds time to review your PR. Happy holidays.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Hugo-Polloli">@Hugo-Polloli</a> on 2026-01-07 08:49</div>
            <div class="timeline-body"><p>Rebased on main as the branch was getting stale, but it looks like everything is still fine with no conflict/regression, so this PR is ready</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ibraheemdev">@ibraheemdev</a> reviewed on 2026-01-07 19:30</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ibraheemdev">@ibraheemdev</a> on <code>crates/ty_python_semantic/src/types/infer/builder.rs</code>:2626 on 2026-01-07 19:30</div>
            <div class="timeline-body"><p>Why do we need to perform standalone inference here? You can infer an expression with type context using <code>self.infer_expression</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Hugo-Polloli">@Hugo-Polloli</a> reviewed on 2026-01-07 21:15</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/Hugo-Polloli">@Hugo-Polloli</a> on <code>crates/ty_python_semantic/src/types/infer/builder.rs</code>:2626 on 2026-01-07 21:15</div>
            <div class="timeline-body"><p>I started with <code>self.infer_expression</code>, but parameter defaults aren't standalone expressions in the semantic index, so it panics with <code>no entry found for key</code>.
The workaround I found is to synthesize an Expression and run standalone inference in the default's enclosing scope.</p>
<p>Here's the test file I used:</p>
<pre><code class="language-py">class Foo(TypedDict):
    x: int

def ok(default_x: Foo = {&quot;x&quot;: 42}): ... # all good
outer_default_x = 42
def not_ok(default_x: Foo = {&quot;x&quot;: outer_default_x}): ...  # panics
</code></pre>
<p>I'm unsure that my fix is the correct one, I just know I could not get infer_expression to work in this case, though I agree it would be cleaner if we could make it work here, I'm open to suggestions/learning about things I missed!</p>
<p>Also in the meantime I pushed a diff that extract this custom handling to a <code>file_expression_type_with_context</code> function with comments explaining the reasoning if that can help</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ibraheemdev">@ibraheemdev</a> reviewed on 2026-01-08 03:30</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ibraheemdev">@ibraheemdev</a> on <code>crates/ty_python_semantic/src/types/infer/builder.rs</code>:2626 on 2026-01-08 03:30</div>
            <div class="timeline-body"><blockquote>
<p>parameter defaults aren't standalone expressions in the semantic index</p>
</blockquote>
<p>It sounds like you tried <code>infer_standalone_expression</code>, I don't think <code>infer_expression</code> has that panic path?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Hugo-Polloli">@Hugo-Polloli</a> reviewed on 2026-01-08 15:23</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/Hugo-Polloli">@Hugo-Polloli</a> on <code>crates/ty_python_semantic/src/types/infer/builder.rs</code>:2626 on 2026-01-08 15:23</div>
            <div class="timeline-body"><p>oof sorry, &quot;standalone expression&quot; was rly confusing wording on my part! ðŸ«  I didn't mean I used <code>infer_standalone_expression</code>, I tried <code>infer_expression</code>.</p>
<p>The issue is scope, <code>infer_parameter_definition</code> runs with the function body scope, but the parameter defaults are indexed in the enclosing scope. <code>infer_expression</code> resolves names using the current scopeâ€™s <code>ast_ids</code> map. So when defaults reference names from the outer scope (like <code>outer_default_x</code> in my above example), the lookup hits <code>ast_ids.use_id(...)</code> and this is where we panic with <code>no entry found for key</code>.</p>
<p>I hope it makes better sense now?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @ibraheemdev by @ibraheemdev on 2026-01-16 16:43</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-16 17:02:42 UTC
    </footer>
</body>
</html>
