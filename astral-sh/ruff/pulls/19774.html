<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[`pyupgrade`] Fix Unicode escape sequence handling in format string parsing - astral-sh/ruff #19774</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[<code>pyupgrade</code>] Fix Unicode escape sequence handling in format string parsing</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/pull/19774">#19774</a>
        opened by <a href="https://github.com/danparizher">@danparizher</a>
        on 2025-08-05 22:16
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/danparizher">@danparizher</a></div>
            <div class="timeline-body"><h2>Summary</h2>
<p>Fixes #19771</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-08-05 22:27</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @ntBre on 2025-08-06 00:57</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">fixes</span> added by @ntBre on 2025-08-06 00:57</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @ntBre by @ntBre on 2025-08-06 00:58</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_python_literal/src/format.rs</code>:603 on 2025-08-06 16:38</div>
            <div class="timeline-body"><p>I don't think we need to collect here:</p>
<pre><code class="language-suggestion">                for (i, c) in cur_text.chars().iter().enumerate().skip(3) {
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_python_literal/src/format.rs</code>:606 on 2025-08-06 16:40</div>
            <div class="timeline-body"><p>I don't think we need to count the braces, but we need to return some kind of error if we encounter another open brace, based on a quick test in Python. Maybe there's a way to make this work, but it seems to me that braces aren't allowed inside of a <code>\N{...}</code> escape:</p>
<pre><code class="language-pycon">&gt;&gt;&gt; &quot;\N{{angle}}&quot;.format(angle=&quot;angle&quot;)
  File &quot;&lt;python-input-0&gt;&quot;, line 1
    &quot;\N{{angle}}&quot;.format(angle=&quot;angle&quot;)
    ^^^^^^^^^^^^^
SyntaxError: (unicode error) 'unicodeescape' codec can't decode bytes in position 0-9: unknown Unicode character name
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_python_literal/src/format.rs</code>:618 on 2025-08-06 16:41</div>
            <div class="timeline-body"><p>If we <code>push_str(&quot;\\N&quot;)</code> at the start, we can just push individual characters as we go instead of bumping <code>end_pos</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_python_literal/src/format.rs</code>:1093 on 2025-08-06 16:43</div>
            <div class="timeline-body"><p>Ah yeah, this is an error in CPython, so this is the case I think we should return an <code>Err</code> in.</p>
<pre><code class="language-pycon">&gt;&gt;&gt; &quot;\N{LATIN {SMALL} LETTER A}&quot;
  File &quot;&lt;python-input-2&gt;&quot;, line 1
    &quot;\N{LATIN {SMALL} LETTER A}&quot;
    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
SyntaxError: (unicode error) 'unicodeescape' codec can't decode bytes in position 0-15: unknown Unicode character name
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-08-06 16:46</div>
            <div class="timeline-body"><p>Thanks for looking into this!</p>
<p>I'm a bit wary of changing this parsing code, but I had a few nits if we do go this route. We'd probably also want @MichaReiser to take a look here.</p>
<p>This code isn't <em>super</em> widely used, only occurring in ~3 rules or so, so it's not as foundational as I thought initially, but we should still be careful.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @ntBre by @danparizher on 2025-08-07 19:52</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-08-08 10:06</div>
            <div class="timeline-body"><p>I don't think I'll have time anytime soon to review this in detail and I'm also not familiar with this code or the logic around it. @ntBre you're right to be wary. There have been plenty of bugs around f-string handling, https://github.com/astral-sh/ruff/issues?q=sort%3Aupdated-desc%20is%3Aissue%20state%3Aclosed%20UP032</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_literal/src/format.rs</code>:601 on 2025-08-08 10:07</div>
            <div class="timeline-body"><p>These seems guaranteed by the <code>starts_with</code> call on line 597`</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-08-08 10:07</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_literal/src/format.rs</code>:606 on 2025-08-08 10:08</div>
            <div class="timeline-body"><p>It feels a bit silly to update <code>result_string</code> only to undo the changes right after. Can we avoid that?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-08-08 10:08</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_literal/src/format.rs</code>:625 on 2025-08-08 10:09</div>
            <div class="timeline-body"><p>Isn't <code>chars.as_str</code> always guaranteed to be empty if <code>chars.next()</code> is <code>None</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-08-08 10:09</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/IDrokin117">@IDrokin117</a> on 2025-08-10 13:53</div>
            <div class="timeline-body"><p>@danparizher
I've been looking into the same problem while working on the issue https://github.com/astral-sh/ruff/issues/19792
Please examine the potential problems this PR could cause</p>
<ol>
<li>Consider the example below. ruff 0.12.8 doesn't fix it due to missing format keyword <code>snowman</code> (<a href="https://play.ruff.rs/?secondary=AST">playground</a>). However, with the proposed changes, the format will be replaced by f-string. I suppose it is wrong behavior.</li>
</ol>
<pre><code class="language-python"># ruff 0.12.8 
print(&quot;\\N{snowman} {}&quot;.format(1)) # doesn't apply UP032
</code></pre>
<pre><code class="language-python"># With the fix, UP032 will be applied
print(&quot;\\N{snowman} {}&quot;.format(1)) # -&gt; print(f&quot;\\N{snowman} {1}&quot;)
</code></pre>
<ol start="2">
<li>While the fix will resolve the first (1) case, it still has a problem with the second (2) case.</li>
</ol>
<pre><code class="language-python"># ruff 0.12.8 
print(&quot;\N{snowman} {snowman}&quot;.format(snowman=3)) # -&gt; print(f&quot;\N{snowman} {3}&quot;) # (1)
</code></pre>
<pre><code class="language-python"># With the fix, here first {snowman} must also be substituted with {1}.
print(&quot;\\N{snowman} {snowman}&quot;.format(snowman=1)) # -&gt; print(f&quot;\\N{snowman} {1}&quot;) # (2)
</code></pre>
<p><a href="https://github.com/IDrokin117/ruff/commit/4b126db73a634f6573906207bdc8e445d5116525">
Here</a> you can find my solution that correctly addresses the cases mentioned above. Feel free to reuse it in your PR if it makes sense.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-09-30 07:13</div>
            <div class="timeline-body"><p>Closing due to inactivity. I can re-open this PR if you plan to work on this. If anyone else is interested to work in this, feel free to submit a new PR that takes the above feedback into account.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @MichaReiser on 2025-09-30 07:13</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:14:50 UTC
    </footer>
</body>
</html>
