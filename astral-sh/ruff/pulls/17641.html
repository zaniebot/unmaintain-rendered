<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[red-knot] Capture backtrace in &quot;check-failed&quot; diagnostic - astral-sh/ruff #17641</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[red-knot] Capture backtrace in &quot;check-failed&quot; diagnostic</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/17641">#17641</a>
        opened by <a href="https://github.com/MichaReiser">@MichaReiser</a>
        on 2025-04-26 10:14
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a></div>
            <div class="timeline-body"><h2>Summary</h2>
<p>Capture and include the full backtrace in the &quot;check-failed&quot; diagnostic. This also prevents that the default panic handler prints to stdout.</p>
<h2>Test Plan</h2>
<pre><code>error: panic: Panicked at /Users/micha/.cargo/git/checkouts/salsa-e6f3bb7c2a062968/87bf6b6/src/function/fetch.rs:167:25 when checking `/Users/micha/astral/ecosystem/hydpy/hydpy/auxs/statstools.py`: `dependency graph cycle querying try_metaclass_(Id(23c4b)); set cycle_fn/cycle_initial to fixpoint iterate`
info: This indicates a bug in Red Knot.
info: If you could open an issue at https://github.com/astral-sh/ruff/issues/new?title=%5Bred-knot%5D:%20panic we'd be very appreciative!
info: Platform: macos aarch64
info: Args: [&quot;../../ruff/target/debug/red_knot&quot;, &quot;check&quot;, &quot;--python&quot;, &quot;.venv&quot;, &quot;hydpy&quot;]
info: Backtrace:
   0: std::backtrace_rs::backtrace::libunwind::trace
             at /rustc/05f9846f893b09a1be1fc8560e33fc3c815cfecb/library/std/src/../../backtrace/src/backtrace/libunwind.rs:117:9
   1: std::backtrace_rs::backtrace::trace_unsynchronized
             at /rustc/05f9846f893b09a1be1fc8560e33fc3c815cfecb/library/std/src/../../backtrace/src/backtrace/mod.rs:66:14
   2: std::backtrace::Backtrace::create
             at /rustc/05f9846f893b09a1be1fc8560e33fc3c815cfecb/library/std/src/backtrace.rs:331:13
   3: ruff_db::panic::install_hook::{{closure}}::{{closure}}
             at /Users/micha/astral/ruff/crates/ruff_db/src/panic.rs:59:34
   4: &lt;alloc::boxed::Box&lt;F,A&gt; as core::ops::function::Fn&lt;Args&gt;&gt;::call
...
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "[red-knot] Capture backtrace" to "[red-knot] Capture backtrace in "check-failed" diagnostic" by @MichaReiser on 2025-04-26 10:14</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-04-26 10:16</div>
            <div class="timeline-body"><!-- generated-comment mypy_primer -->

<h2><code>mypy_primer</code> results</h2>
<p>No ecosystem changes detected âœ…</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by @MichaReiser on 2025-04-26 11:50</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @MichaReiser on 2025-04-26 11:50</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @MichaReiser on 2025-04-26 11:50</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @AlexWaygood by @MichaReiser on 2025-04-26 11:50</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @sharkdp by @MichaReiser on 2025-04-26 11:50</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @dcreager by @MichaReiser on 2025-04-26 11:50</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/ruff_db/src/panic.rs</code>:112 on 2025-04-28 07:31</div>
            <div class="timeline-body"><p>I'm not sure if I would understand this message without the context of this PR. Maybe something like the following?</p>
<pre><code class="language-suggestion">    #[ignore = &quot;super::catch_unwind installs a custom panic handler, which could effect test isolation&quot;]
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> approved on 2025-04-28 07:31</div>
            <div class="timeline-body"><p>Thank you.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for @carljm removed by @carljm on 2025-04-28 23:13</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @MichaReiser on 2025-04-29 16:58</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @MichaReiser on 2025-04-29 16:58</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-04-29 16:59</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:11:55 UTC
    </footer>
</body>
</html>
