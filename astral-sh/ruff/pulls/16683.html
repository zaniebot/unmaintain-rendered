<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[red-knot] Add `CallableTypeFromFunction` special form - astral-sh/ruff #16683</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[red-knot] Add <code>CallableTypeFromFunction</code> special form</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/16683">#16683</a>
        opened by <a href="https://github.com/dhruvmanila">@dhruvmanila</a>
        on 2025-03-12 16:09
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a></div>
            <div class="timeline-body"><h2>Summary</h2>
<p>This PR adds a new <code>CallableTypeFromFunction</code> special form to allow extracting the abstract signature of a function literal i.e., convert a <code>Type::Function</code> into a <code>Type::Callable</code> (<code>CallableType::General</code>).</p>
<p>This is done to support testing the <code>is_gradual_equivalent_to</code> type relation specifically the case we want to make sure that a function that has parameters with no annotations and does not have a return type annotation is gradual equivalent to <code>Callable[[Any, Any, ...], Any]</code> where the number of parameters should match between the function literal and callable type.</p>
<p>Refer https://github.com/astral-sh/ruff/pull/16634#discussion_r1989976692</p>
<h3>Bikeshedding</h3>
<p>The name <code>CallableTypeFromFunction</code> is a bit too verbose. A possibly alternative from Carl is <code>CallableTypeOf</code> but that would be similar to <code>TypeOf</code> albeit with a limitation that the former only accepts function literal types and errors on other types.</p>
<p>Some other alternatives:</p>
<ul>
<li><code>FunctionSignature</code></li>
<li><code>SignatureOf</code> (similar issues as <code>TypeOf</code>?)</li>
<li>...</li>
</ul>
<h2>Test Plan</h2>
<p>Update <code>type_api.md</code> with a new section that tests this special form, both invalid and valid forms.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by @dhruvmanila on 2025-03-12 16:09</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @dhruvmanila on 2025-03-12 16:09</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @dhruvmanila on 2025-03-12 16:09</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @AlexWaygood by @dhruvmanila on 2025-03-12 16:09</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @sharkdp by @dhruvmanila on 2025-03-12 16:09</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-03-12 16:15</div>
            <div class="timeline-body"><!-- generated-comment mypy_primer -->

<h2><code>mypy_primer</code> results</h2>
<p>No ecosystem changes detected âœ…</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-03-12 18:07</div>
            <div class="timeline-body"><p>More of a high-level comment. I'm not completely convinced that we need a special form in <code>knot_extensions</code> for this. It seems to me like something that could be implemented with core type-system features, once we support generics?</p>
<pre><code class="language-py">def signature_of[*Ts, R](c: Callable[[*Ts], R]) -&gt; Callable[[*Ts], R]:
    return c
</code></pre>
<p>which could be used like <a href="https://mypy-play.net/?mypy=latest&amp;python=3.13&amp;gist=ebd4293f4d70eeed7083577243097ac7">this</a>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-03-12 20:00</div>
            <div class="timeline-body"><blockquote>
<p>something that could be implemented with core type-system features, once we support generics</p>
</blockquote>
<p>This approach can still only express callable types that can be spelled with <code>Callable</code> syntax, which is quite limiting (no named/keyword parameters, no optional/defaulted parameters, no omitted annotations, no overloads...). I think we need this special form because our callable type is capable of expressing many signatures that cannot be spelled using core type forms.</p>
<p>I think a more promising way to (partially?) obviate the need for this special form is &quot;callable Protocols&quot; (that is, a Protocol that defines only a <code>__call__</code> method). But in this case, I'm not sure yet (until we implement protocols) whether we would special-case interpreting that Protocol as a general callable type, or whether it would retain a distinct representation as a Protocol but implement type equivalency with the equivalent callable type. (Or, possibly, we could even transition &quot;general callable type&quot; to simply be one kind of Protocol. Similarly, <code>AlwaysTruthy</code> and <code>AlwaysFalsy</code> <em>could</em> be represented as a <code>Protocol</code> with <code>bool</code> method returning <code>Literal[True]</code> or <code>Literal[False]</code>.)</p>
<p>Given the simplicity of this special form, and the fact that we can use it today to help us test callable type relations more thoroughly, I'm still in favor of landing it. We can always consider removing it later (I guess barring the possibility that it sees wide external adoption, but this is unlikely since it doesn't exist at runtime, and if it does see wide adoption despite that, it suggests that it is useful and shouldn't be removed.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:4305 on 2025-03-12 20:03</div>
            <div class="timeline-body"><p>We may want our general callable type to support overloaded signatures? But this can be left as a future discussion.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> approved on 2025-03-12 20:03</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2025-03-13 02:12</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:4305 on 2025-03-13 02:12</div>
            <div class="timeline-body"><p>Yeah, I mainly meant this as a TODO, will add it there.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2025-03-13 02:15</div>
            <div class="timeline-body"><p>Additionally, this will also be useful to test out assignability because <code>lambda</code> expressions are limited in that sense. Protocols would be the best in that scenarios but this would at least allow us to write tests for all possible forms of <code>Callable</code> annotations along against various function signatures.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @dhruvmanila on 2025-03-13 02:19</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @dhruvmanila on 2025-03-13 02:19</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-03-13 02:19</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:10:43 UTC
    </footer>
</body>
</html>
