<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[`pyupgrade`] Do not report when a UTF-8 comment is followed by a non-UTF-8 one (`UP009`) - astral-sh/ruff #14728</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[<code>pyupgrade</code>] Do not report when a UTF-8 comment is followed by a non-UTF-8 one (<code>UP009</code>)</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/14728">#14728</a>
        opened by <a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a>
        on 2024-12-02 13:06
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a></div>
            <div class="timeline-body">Summary
<p>Resolves #14704.</p>
Test Plan
<p><code>cargo nextest run</code> and <code>cargo insta test</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2024-12-02 13:18</div>
            <div class="timeline-body">

<code>ruff-ecosystem</code> results
Linter (stable)
<p>✅ ecosystem check detected no linter changes.</p>
Linter (preview)
<p>✅ ecosystem check detected no linter changes.</p>
Formatter (stable)
<p>✅ ecosystem check detected no format changes.</p>
Formatter (preview)
<p>✅ ecosystem check detected no format changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dscorbett">@dscorbett</a> reviewed on 2024-12-02 14:15</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dscorbett">@dscorbett</a> on <code>crates/ruff_linter/src/rules/pyupgrade/rules/unnecessary_coding_comment.rs</code>:85 on 2024-12-02 14:15</div>
            <div class="timeline-body"><p>If this block removes both UTF-8 encoding declarations, what happens if there is a third, non-UTF-8 encoding declaration?</p>
<pre><code># coding=utf-8
# coding=utf-8
# coding=ascii
</code></pre>
<p>I think it would be better to only offer the fix for <code>ranges_1</code>. If it is safe to delete <code>ranges_2</code> too, that can happen on the next iteration.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a> reviewed on 2024-12-02 14:34</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a> on <code>crates/ruff_linter/src/rules/pyupgrade/rules/unnecessary_coding_comment.rs</code>:85 on 2024-12-02 14:34</div>
            <div class="timeline-body"><p>Just to be clear, should we:</p>
<ul>
<li>Report both but only suggest a fix for the first?</li>
<li>Report only the first?</li>
<li>Report both, marking the first fix safe but the second fix unsafe?</li>
<li>Another way?</li>
</ul>
<p>Currently this rule is marked as always fixable.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/pyupgrade/rules/unnecessary_coding_comment.rs</code>:131 on 2024-12-03 08:47</div>
            <div class="timeline-body"><p>Oh wow, this still uses the old API. We can address this in a follow up PR but I think we could easily replace this with <code>locator.slice(TextRange::up_to(line_range.start())</code> and then count the number of  lines by calling <code>locator.full_line_end</code> until it reaches the end of the range. We could add this as a method to <code>LineRanges</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/pyupgrade/rules/unnecessary_coding_comment.rs</code>:85 on 2024-12-03 08:54</div>
            <div class="timeline-body"><p>In that case, we shouldn&#x27;t raise a diagnostic for the second encoding comment.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/pyupgrade/rules/unnecessary_coding_comment.rs</code>:74 on 2024-12-03 08:56</div>
            <div class="timeline-body"><p>It would be great if we can avoid collecting the comments here to avoid the allocation. I think doing so should also reduce the amount of code needed below.</p>
<pre><code>let mut comments = comment_ranges.iter().take(...)...

let Some(first) = comments.next() else {
	return None;
}

if let Some(CodingComment::Other) = comments.next() {
	return None;
}

</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> requested changes on 2024-12-03 08:57</div>
            <div class="timeline-body"><p>We should address the case when there are multiple coding comments (that might also be on lines other than the first two)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_source_file/src/line_ranges.rs</code>:331 on 2024-12-04 08:10</div>
            <div class="timeline-body"><p>Nit: i&#x27;d change the method to take a text range instead. It makes it more flexible and it also avoids that the function never terminates if <code>offset</code> == <code>len(text)</code></p>
<pre><code>    /// Returns the zero-based index of the line containing `offset`.
    ///
    /// ## Examples
    ///
    /// ```
    /// # use ruff_text_size::{Ranged, TextRange, TextSize};
    /// # use ruff_source_file::LineRanges;
    ///
    /// let text = &quot;First line\nsecond line\r\nthird line&quot;;
    ///
    /// assert_eq!(text.count_lines_until(TextSize::from(5)), 0);
    /// assert_eq!(text.count_lines_until(TextSize::from(23)), 1);
    /// assert_eq!(text.count_lines_until(TextSize::from(24)), 2);
    /// ```
    ///
    /// ## Panics
    /// If `offset` is out of bounds.
    fn count_lines(&amp;self, range: TextRange) -&gt; u32 {
        let mut count = 0;
        let mut offset = range.start();

				loop {
					let line_end = self.full_line_end(offset);
					if line_end &lt; range.end() {
						count += 1;
						offset = line_end;
				} else {
					break count;
				}
    }
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/resources/test/fixtures/pyupgrade/UP009_utf8_utf8_other.py</code>:1 on 2024-12-04 08:16</div>
            <div class="timeline-body"><p>Nice tests.</p>
<p>Could we add a test for</p>
<pre><code>print(&quot;the following is not a coding comment&quot;)
# -*- coding: utf8 -*-
</code></pre>
<p>The PEP is surprisingly not specific about whether this coding statement is valid or not (I&#x27;d assume it isn&#x27;t but the PEP doesn&#x27;t mention anything about a statement before the coding block so maybe it is?)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-12-04 08:20</div>
            <div class="timeline-body"><p>Wow, thanks for implementing the <code>count_lines</code> method!</p>
<p>There&#x27;s one more edge case that needs handling</p>
<pre><code>#! /usr/bin/env/python
# -*- coding: utf-8 -*-
# -*- coding: ascii -*-
</code></pre>
<p>The second comment gets flagged as unnecessary, which is incorrect because removing it would change the encoding to ascii</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dscorbett">@dscorbett</a> reviewed on 2024-12-04 13:13</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dscorbett">@dscorbett</a> on <code>crates/ruff_linter/resources/test/fixtures/pyupgrade/UP009_utf8_utf8_other.py</code>:1 on 2024-12-04 13:13</div>
            <div class="timeline-body"><p><a href="https://docs.python.org/3/reference/lexical_analysis.html#encoding-declarations">Python’s documentation</a> says “The encoding declaration must appear on a line of its own. If it is the second line, the first line must also be a comment-only line.” so that is just a normal comment, not an encoding declaration.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a> on 2024-12-04 17:37</div>
            <div class="timeline-body"><p>Cases to handle, as a table:</p>
<p>|   1   |   2   |   3   | E |
|:-----:|:-----:|:-----:|:-:|
|   -   |   -   |   -   |   |
|   -   |   -   | UTF-8 |   |
|   -   |   -   | Other |   |
|   -   | UTF-8 |   -   | x |
|   -   | UTF-8 | UTF-8 | x |
|   -   | UTF-8 | Other |   |
|   -   | Other |   -   |   |
|   -   | Other | UTF-8 |   |
|   -   | Other | Other |   |
| UTF-8 |   -   |   -   | x |
| UTF-8 |   -   | UTF-8 | x |
| UTF-8 |   -   | Other | x |
| UTF-8 | UTF-8 |   -   | x |
| UTF-8 | UTF-8 | UTF-8 | x |
| UTF-8 | UTF-8 | Other | x |
| UTF-8 | Other |   -   |   |
| UTF-8 | Other | UTF-8 |   |
| UTF-8 | Other | Other |   |
| Other |   -   |   -   |   |
| Other |   -   | UTF-8 |   |
| Other |   -   | Other |   |
| Other | UTF-8 |   -   |   |
| Other | UTF-8 | UTF-8 |   |
| Other | UTF-8 | Other |   |
| Other | Other |   -   |   |
| Other | Other | UTF-8 |   |
| Other | Other | Other |   |</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a> reviewed on 2024-12-04 17:50</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a> on <code>crates/ruff_source_file/src/line_ranges.rs</code>:331 on 2024-12-04 17:50</div>
            <div class="timeline-body"><p>Fixed the infinite loop bug, but I think this does something entirely different: It counts the number of lines <code>range</code> spans rather than the index of the line <code>offset</code> is placed within.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-12-09 15:55</div>
            <div class="timeline-body"><p>@InSyncWithFoo what&#x27;s the status of this PR? Is it ready for re-review?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/resources/test/fixtures/pyupgrade/UP009_utf8_utf8_other.py</code>:1 on 2024-12-09 15:56</div>
            <div class="timeline-body"><p>Thanks @dscorbett  for the link. That&#x27;s what I expected. Let&#x27;s add a test if there isn&#x27;t one already:</p>
<pre><code># -*- coding: utf8 -*-
print(&quot;the following is not a coding comment&quot;)
# -*- coding: ascii -*-
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-12-09 15:56</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a> on 2024-12-09 16:39</div>
            <div class="timeline-body"><p>@MichaReiser It is. Please do.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a> on <code>crates/ruff_linter/resources/test/fixtures/pyupgrade/UP009_utf8_utf8_other.py</code>:1 on 2024-12-09 17:53</div>
            <div class="timeline-body"><p>Added.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a> reviewed on 2024-12-09 17:53</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-12-10 08:01</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_source_file/src/line_ranges.rs</code>:331 on 2024-12-10 08:01</div>
            <div class="timeline-body"><p>Yes, it is different but <code>count_lines_until</code> can be expressed by <code>count_lines(TextRange::up_to(offset))</code></p>
<p>That&#x27;s why I&#x27;d prefer to only expose the more generic solution because it allows solving more use cacses.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> requested changes on 2024-12-10 08:06</div>
            <div class="timeline-body"><p>Thanks for addressing the feedback.</p>
<p>The rule currently incorrectly flags the following comments:</p>
<pre><code>x = 10
# -*- coding: utf-8 -*-
# -*- coding: utf-8 -*-
</code></pre>
<pre><code>x = 10
# -*- coding: utf-8 -*-
</code></pre>
<p>I think we need to make the <code>comment_ranges</code> iterator more stateful. It should never return <code>Some</code> after it has seen any non-comment. It might be worth implementing a custom iterator and tracking some internal state.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">rule</span> added by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-12-11 09:28</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-12-11 09:28</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-12-11 10:30</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-12-11 10:30</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-12-11 12:52</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:09:06 UTC
    </footer>
</body>
</html>
