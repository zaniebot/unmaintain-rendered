<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[red-knot] handle cycles in MRO/bases resolution - astral-sh/ruff #16693</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[red-knot] handle cycles in MRO/bases resolution</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/16693">#16693</a>
        opened by <a href="https://github.com/carljm">@carljm</a>
        on 2025-03-13 01:03
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a></div>
            <div class="timeline-body"><p>There can be semi-cyclic inheritance patterns (e.g. recursive generics) that are not technically inheritance cycles, but that can cause us to hit Salsa query cycles in evaluating a type&#x27;s MRO. Add fixed-point handling to these MRO-related queries so we don&#x27;t panic on these cycles.</p>
<p>The details of what queries we hit in what order in this case will change as we implement support for generics, but ultimately we will probably need cycle handling for all queries that can re-enter type inference, otherwise we are susceptible to small changes in query execution order causing panics.</p>
<p>Fixes astral-sh/ruff#14333
Further reduces the panicking set of seeds in astral-sh/ty#228</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by <a href="https://github.com/carljm">@carljm</a> on 2025-03-13 01:03</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/MichaReiser">@MichaReiser</a> by <a href="https://github.com/carljm">@carljm</a> on 2025-03-13 01:03</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/AlexWaygood">@AlexWaygood</a> by <a href="https://github.com/carljm">@carljm</a> on 2025-03-13 01:03</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/sharkdp">@sharkdp</a> by <a href="https://github.com/carljm">@carljm</a> on 2025-03-13 01:03</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-03-13 01:09</div>
            <div class="timeline-body">

<code>mypy_primer</code> results
<p>No ecosystem changes detected âœ…</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-03-13 01:22</div>
            <div class="timeline-body"><p>Actually, after looking at this a bit more, I&#x27;m not yet convinced this is the right fix. Investigating a bit more.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Converted to draft by <a href="https://github.com/carljm">@carljm</a> on 2025-03-13 01:22</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by <a href="https://github.com/carljm">@carljm</a> on 2025-03-13 02:38</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-03-13 02:38</div>
            <div class="timeline-body"><p>Ok, I do think this is right, re-submitting for review.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2025-03-13 08:48</div>
            <div class="timeline-body"><p>I don&#x27;t mind all the added tracing calls but I&#x27;m curious how verbose it becomes. But we can always remove them in the future if needed. I can definetely see how they&#x27;re useful and using <code>KNOT_LOG</code> can help to narrow down the scope of logs</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-03-13 15:15</div>
            <div class="timeline-body"><p>The particular reason these tracing calls are important is that Salsa&#x27;s behavior with queries that are methods is currently pretty unfriendly: the queries are all named <code>inner_fn_name_</code> and are very difficult to distinguish from each other in Salsa traces. This is probably something that can be improved in Salsa, and then these traces in red-knot would be less necessary.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/carljm">@carljm</a> on 2025-03-13 15:16</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/carljm">@carljm</a> on 2025-03-13 15:16</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-03-13 15:16</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:12:17 UTC
    </footer>
</body>
</html>
