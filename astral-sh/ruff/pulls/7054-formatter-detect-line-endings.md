```yaml
number: 7054
title: "Formatter: Detect line endings"
type: pull_request
state: merged
author: MichaReiser
labels:
  - cli
  - formatter
assignees: []
merged: true
base: main
head: detect-line-ending
created_at: 2023-09-01T21:35:54Z
updated_at: 2023-09-04T06:09:32Z
url: https://github.com/astral-sh/ruff/pull/7054
synced_at: 2026-01-12T02:45:38Z
```

# Formatter: Detect line endings

---

_Pull request opened by @MichaReiser on 2023-09-01 21:35_

<!--
Thank you for contributing to Ruff! To help us out with reviewing, please consider the following:

- Does this pull request include a summary of the change? (See below.)
- Does this pull request include a descriptive title?
- Does this pull request include references to any relevant issues?
-->

## Summary

This PR changes the ruff cli to detect the default line ending automatically. 

We should add a Cconfiguration option for the default line ending in the future (https://github.com/astral-sh/ruff/issues/7061) but until then, detect the first line ending and use it (to align with Black).

<!-- What's the purpose of the change? What does it do, and why? -->

## Test Plan

I ran `ruff format --check` on the LSP project on windows (before charlie's commit to change to LN) and it doesn't reformat any files. 

But the LSP is a good example why detecting the default generally is not a good idea, because you end up with all kind of line endings in your project

```
[crates\ruff_cli\src\commands\format.rs:150] line_ending = LineFeed
[crates\ruff_cli\src\commands\format.rs:150] path = "C:\\Users\\Micha\\astral\\ruff-lsp\\ruff_lsp\\__init__.py"
[crates\ruff_cli\src\commands\format.rs:150] line_ending = LineFeed
[crates\ruff_cli\src\commands\format.rs:150] path = "C:\\Users\\Micha\\astral\\ruff-lsp\\ruff_lsp\\__main__.py"
[crates\ruff_cli\src\commands\format.rs:150] line_ending = CarriageReturnLineFeed
[crates\ruff_cli\src\commands\format.rs:150] path = "C:\\Users\\Micha\\astral\\ruff-lsp\\tests\\client\\defaults.py"
[crates\ruff_cli\src\commands\format.rs:150] line_ending = CarriageReturnLineFeed
[crates\ruff_cli\src\commands\format.rs:150] path = "C:\\Users\\Micha\\astral\\ruff-lsp\\tests\\test_format.py"
[crates\ruff_cli\src\commands\format.rs:150] line_ending = LineFeed
[crates\ruff_cli\src\commands\format.rs:150] path = "C:\\Users\\Micha\\astral\\ruff-lsp\\ruff_lsp\\settings.py"
[crates\ruff_cli\src\commands\format.rs:150] line_ending = LineFeed
[crates\ruff_cli\src\commands\format.rs:150] path = "C:\\Users\\Micha\\astral\\ruff-lsp\\tests\\client\\constants.py"
[crates\ruff_cli\src\commands\format.rs:150] line_ending = CarriageReturnLineFeed
[crates\ruff_cli\src\commands\format.rs:150] path = "C:\\Users\\Micha\\astral\\ruff-lsp\\tests\\client\\session.py"
[crates\ruff_cli\src\commands\format.rs:150] line_ending = LineFeed
[crates\ruff_cli\src\commands\format.rs:150] path = "C:\\Users\\Micha\\astral\\ruff-lsp\\tests\\client\\__init__.py"
[crates\ruff_cli\src\commands\format.rs:150] line_ending = LineFeed
[crates\ruff_cli\src\commands\format.rs:150] path = "C:\\Users\\Micha\\astral\\ruff-lsp\\tests\\client\\utils.py"
[crates\ruff_cli\src\commands\format.rs:150] line_ending = CarriageReturnLineFeed
```

<!-- How was it tested? -->


---

_Comment by @MichaReiser on 2023-09-01 21:36_

Current dependencies on/for this PR:
* main
  * **PR #7054** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7054" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a>  ðŸ‘ˆ

This comment was auto-generated by [Graphite](https://app.graphite.dev/github/pr/astral-sh/ruff/7054?utm_source=stack-comment).

---

_Label `formatter` added by @MichaReiser on 2023-09-02 07:51_

---

_Renamed from "Detect line endings" to "Formatter: Detect line endings" by @MichaReiser on 2023-09-02 08:02_

---

_Label `cli` added by @MichaReiser on 2023-09-02 08:05_

---

_Marked ready for review by @MichaReiser on 2023-09-02 08:05_

---

_Comment by @github-actions[bot] on 2023-09-02 08:17_

## PR Check Results
### Ecosystem
âœ… ecosystem check detected no changes.



---

_@charliermarsh approved on 2023-09-02 16:46_

Can you help me understand what was happening on `ruff-lsp` on Windows prior to this change (and prior to the change to `.gitattributes`)?

---

_Comment by @charliermarsh on 2023-09-02 16:48_

Also, why are different files reporting different line endings when my editor tells me they're all using LF? E.g., `client/defaults.py`.

---

_Comment by @MichaReiser on 2023-09-02 18:28_

> Can you help me understand what was happening on `ruff-lsp` on Windows prior to this change (and prior to the change to `.gitattributes`)?

It depends on your local git settings but git sometimes converts the line endings of files to use \r\n on checkout and converts it back to \n on commit [autocrlf](https://git-scm.com/book/en/v2/Customizing-Git-Git-Configuration#_core_autocrlf)

> Also, why are different files reporting different line endings when my editor tells me they're all using LF? E.g., client/defaults.py.

Now, I don't know why git only converted some files. Maybe because it checked out some with the new gitattributes, who knows.. I always set the lf explicitly to avoid this mess (and the formatter should default to a fixed line ending)

---

_Merged by @MichaReiser on 2023-09-04 06:09_

---

_Closed by @MichaReiser on 2023-09-04 06:09_

---

_Branch deleted on 2023-09-04 06:09_

---
