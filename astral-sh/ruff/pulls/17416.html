<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[red-knot] make large-union benchmark more challenging - astral-sh/ruff #17416</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[red-knot] make large-union benchmark more challenging</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/17416">#17416</a>
        opened by <a href="https://github.com/carljm">@carljm</a>
        on 2025-04-16 00:36
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a></div>
            <div class="timeline-body">Summary
<p>Now that we&#x27;ve fixed one large source of constant overhead in building large unions of literals, we can afford to make this benchmark a bit nastier, by letting the union get 8x as big (up to 2048 elements, as opposed to just 256 before). The motivation for doing this is so that the benchmark can more clearly show the distinction between constant-overhead optimizations and algorithmic-complexity improvements (which are relatively more important the larger the union in the benchmark gets.)</p>
<p>We expect the largest unions (from large code-generated enums) that we need to support may be around 4k or 5k elements, so ideally we&#x27;d increase the benchmark to that size, but at the moment that still makes the benchmark too slow.</p>
Test Plan
<p><code>cargo bench --bench red_knot</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by <a href="https://github.com/carljm">@carljm</a> on 2025-04-16 00:36</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/codspeed-hq[bot]">@codspeed-hq[bot]</a> on 2025-04-16 00:42</div>
            <div class="timeline-body">



<a href="https://codspeed.io/astral-sh/ruff/branches/cjm%2Fbigunionbench">CodSpeed Performance Report</a>
Merging #17416 will <strong>degrade performances by 96.93%</strong>
<p>Comparing <code>cjm/bigunionbench</code> (3ee7bf3) with <code>main</code> (807a8a7)</p>
Summary
<p><code>❌ 1</code> regressions<br>
<code>✅ 32</code> untouched benchmarks</p>
<blockquote>
<p>:warning: <em>Please fix the performance issues or <a href="https://codspeed.io/astral-sh/ruff/branches/cjm%2Fbigunionbench">acknowledge them on CodSpeed</a>.</em></p>
</blockquote>
Benchmarks breakdown
<p>|     | Benchmark | <code>BASE</code> | <code>HEAD</code> | Change |
| --- | --------- | ----------------------- | ------------------- | ------ |
| ❌ | <code>red_knot_micro[many_string_assignments]</code> | 98.6 ms | 3,211.1 ms | -96.93% |</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-04-16 00:52</div>
            <div class="timeline-body">

<code>ruff-ecosystem</code> results
Linter (stable)
<p>✅ ecosystem check detected no linter changes.</p>
Linter (preview)
<p>✅ ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/carljm">@carljm</a> on 2025-04-16 01:04</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/carljm">@carljm</a> on 2025-04-16 01:04</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-04-16 01:04</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:13:21 UTC
    </footer>
</body>
</html>
