<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[ty] Make the default database truly statically infallible - astral-sh/ruff #22056</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[ty] Make the default database truly statically infallible</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/ruff/pull/22056">#22056</a>
        opened by <a href="https://github.com/Gankra">@Gankra</a>
        on 2025-12-18 17:50
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Gankra">@Gankra</a></div>
            <div class="timeline-body"><h2>Summary</h2>
<p>I usually hate type wizardry but I decided to have some fun (and also I am legitimately worried that we're going to end up in <code>Err</code> whackamole and the previous approach was a huge maintenance hazard).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @Gankra on 2025-12-18 17:50</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @AlexWaygood by @Gankra on 2025-12-18 17:50</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @sharkdp by @Gankra on 2025-12-18 17:50</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @dcreager by @Gankra on 2025-12-18 17:50</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">internal</span> added by @Gankra on 2025-12-18 17:50</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @Gankra on 2025-12-18 17:50</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ty</span> added by @Gankra on 2025-12-18 17:50</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Gankra">@Gankra</a> reviewed on 2025-12-18 17:51</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/Gankra">@Gankra</a> on <code>crates/ty_python_semantic/src/program.rs</code>:219 on 2025-12-18 17:51</div>
            <div class="timeline-body"><p>Here's the heart and soul</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/astral-sh-bot[bot]">@astral-sh-bot[bot]</a> on 2025-12-18 17:51</div>
            <div class="timeline-body"><!-- generated-comment typing_conformance_diagnostics_diff -->

<h2>Diagnostic diff on <a href="https://github.com/python/typing/tree/9f6d8ced7cd1c8d92687a4e9c96d7716452e471e/conformance">typing conformance tests</a></h2>
<p>No changes detected when running ty on typing conformance tests ✅</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for @carljm removed by @carljm on 2025-12-18 17:53</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Gankra">@Gankra</a> reviewed on 2025-12-18 17:53</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/Gankra">@Gankra</a> on <code>crates/ty_server/src/session.rs</code>:524 on 2025-12-18 17:53</div>
            <div class="timeline-body"><p>Here's the glorious payoff.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/astral-sh-bot[bot]">@astral-sh-bot[bot]</a> on 2025-12-18 17:56</div>
            <div class="timeline-body"><!-- generated-comment mypy_primer -->

<h2><code>mypy_primer</code> results</h2>
<details>
<summary>Changes were detected when running on open source projects</summary>

<pre><code class="language-diff">xarray (https://github.com/pydata/xarray)
- xarray/core/dataarray.py:5737:16: error[invalid-return-type] Return type does not match returned value: expected `T_Xarray@map_blocks`, found `DataArray | Dataset`
+ xarray/core/dataarray.py:5737:16: error[invalid-return-type] Return type does not match returned value: expected `T_Xarray@map_blocks`, found `T_Xarray@map_blocks | DataArray | Dataset`
- xarray/core/dataset.py:8866:16: error[invalid-return-type] Return type does not match returned value: expected `T_Xarray@map_blocks`, found `DataArray | Dataset`
+ xarray/core/dataset.py:8866:16: error[invalid-return-type] Return type does not match returned value: expected `T_Xarray@map_blocks`, found `T_Xarray@map_blocks | DataArray | Dataset`

scikit-build-core (https://github.com/scikit-build/scikit-build-core)
- src/scikit_build_core/build/wheel.py:98:20: error[no-matching-overload] No overload of bound method `__init__` matches arguments
- Found 44 diagnostics
+ Found 43 diagnostics

static-frame (https://github.com/static-frame/static-frame)
- static_frame/core/bus.py:671:16: error[invalid-return-type] Return type does not match returned value: expected `InterGetItemLocReduces[Bus[Any], object_]`, found `InterGetItemLocReduces[Bus[Any] | Top[Series[Any, Any]] | TypeBlocks | ... omitted 7 union elements, object_]`
+ static_frame/core/bus.py:671:16: error[invalid-return-type] Return type does not match returned value: expected `InterGetItemLocReduces[Bus[Any], object_]`, found `InterGetItemLocReduces[Bus[Any] | TypeBlocks | Batch | ... omitted 7 union elements, object_]`
- static_frame/core/yarn.py:418:16: error[invalid-return-type] Return type does not match returned value: expected `InterGetItemILocReduces[Yarn[Any], object_]`, found `InterGetItemILocReduces[Yarn[Any] | TypeBlocks | Batch | ... omitted 7 union elements, generic[object]]`
+ static_frame/core/yarn.py:418:16: error[invalid-return-type] Return type does not match returned value: expected `InterGetItemILocReduces[Yarn[Any], object_]`, found `InterGetItemILocReduces[Yarn[Any] | Top[Index[Any]] | TypeBlocks | ... omitted 7 union elements, generic[object]]`

rotki (https://github.com/rotki/rotki)
- rotkehlchen/chain/decoding/tools.py:97:13: error[invalid-argument-type] Argument to function `decode_transfer_direction` is incorrect: Expected `(A@BaseDecoderTools &amp; BTCAddress) | (A@BaseDecoderTools &amp; ChecksumAddress) | (A@BaseDecoderTools &amp; SubstrateAddress) | (A@BaseDecoderTools &amp; SolanaAddress)`, found `A@BaseDecoderTools`
+ rotkehlchen/chain/decoding/tools.py:99:13: error[invalid-argument-type] Argument to function `decode_transfer_direction` is incorrect: Expected `Sequence[A@BaseDecoderTools]`, found `Unknown | tuple[BTCAddress, ...] | tuple[ChecksumAddress, ...] | tuple[SubstrateAddress, ...] | tuple[SolanaAddress, ...]`
- rotkehlchen/chain/decoding/tools.py:98:13: error[invalid-argument-type] Argument to function `decode_transfer_direction` is incorrect: Expected `(A@BaseDecoderTools &amp; BTCAddress) | (A@BaseDecoderTools &amp; ChecksumAddress) | (A@BaseDecoderTools &amp; SubstrateAddress) | (A@BaseDecoderTools &amp; SolanaAddress) | None`, found `A@BaseDecoderTools | None`
- rotkehlchen/chain/decoding/tools.py:99:13: error[invalid-argument-type] Argument to function `decode_transfer_direction` is incorrect: Expected `Sequence[(A@BaseDecoderTools &amp; BTCAddress) | (A@BaseDecoderTools &amp; ChecksumAddress) | (A@BaseDecoderTools &amp; SubstrateAddress) | (A@BaseDecoderTools &amp; SolanaAddress)]`, found `Unknown | tuple[BTCAddress, ...] | tuple[ChecksumAddress, ...] | tuple[SubstrateAddress, ...] | tuple[SolanaAddress, ...]`
- Found 2082 diagnostics
+ Found 2080 diagnostics


</code></pre>
</details>

<p>No memory usage changes detected ✅</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/Gankra">@Gankra</a> on <code>crates/ty_project/src/glob.rs</code>:96 on 2025-12-18 17:56</div>
            <div class="timeline-body"><p>This is as deep as I was willing to propagate fallback logic. These unwraps/panics really should never ever happen and I'm not worried about them.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Gankra">@Gankra</a> reviewed on 2025-12-18 17:56</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Gankra">@Gankra</a> reviewed on 2025-12-18 17:57</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/Gankra">@Gankra</a> on <code>crates/ty_project/src/metadata.rs</code>:115 on 2025-12-18 17:57</div>
            <div class="timeline-body"><p>I was aware of this fallible operation already, I intentionally didn't put handling on it before because the default database doesn't ever reach this branch (but hey, now we Definitely handle it).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Gankra">@Gankra</a> reviewed on 2025-12-18 17:58</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/Gankra">@Gankra</a> on <code>crates/ty_project/src/metadata/options.rs</code>:431 on 2025-12-18 17:58</div>
            <div class="timeline-body"><p>These are totally new to me and potential failures I never looked into (I expect they never could fail with the default database but hey, now we know they won't).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/astral-sh-bot[bot]">@astral-sh-bot[bot]</a> on 2025-12-18 18:01</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Formatter (stable)</h3>
<p>✅ ecosystem check detected no format changes.</p>
<h3>Formatter (preview)</h3>
<p>✅ ecosystem check detected no format changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/geofft">@geofft</a> on <code>crates/ty_python_semantic/src/program.rs</code>:175 on 2025-12-18 19:10</div>
            <div class="timeline-body"><pre><code class="language-suggestion">/// * [`UseDefaultStrategy`]: The code should apply default values and never fail
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/geofft">@geofft</a> reviewed on 2025-12-18 19:27</div>
            <div class="timeline-body"><p>I don't think I'm qualified to actually review this but it seems entirely sensible to me!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_benchmark/benches/ty.rs</code>:92 on 2025-12-19 10:37</div>
            <div class="timeline-body"><p>Would it make sense to instead expose two methods like <code>ProjectDatabase::new</code> (falible by default) and <code>ProjectDatabase::safe</code>? Ideally, the <code>unwrap</code> wouldn't be needed here because we, obviously, want' the safe strategy here</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_project/src/metadata/options.rs</code>:431 on 2025-12-19 10:43</div>
            <div class="timeline-body"><p>They can't with the default database because <code>overrides</code> initializes as <code>None</code> but having this enforced is nice</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_python_semantic/src/program.rs</code>:170 on 2025-12-19 10:44</div>
            <div class="timeline-body"><p>Could we make use of this in many places where we use <code>.unwrap</code> today?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_python_semantic/src/program.rs</code>:219 on 2025-12-19 10:44</div>
            <div class="timeline-body"><p>Is this our own <code>Try</code> trait :D</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_python_semantic/src/program.rs</code>:317 on 2025-12-19 10:45</div>
            <div class="timeline-body"><p>Maybe <code>ErrStrategy</code> or <code>ErrorStrategy</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2025-12-19 10:47</div>
            <div class="timeline-body"><p>This is great. It might make sense for @BurntSushi to also take a look.</p>
<p>What would be nice is if we could hide this implementation detail from the <code>ProjectDatabase::new</code> callers, e.g. by exposing two methods instead of having them pick a strategy (where the <code>safe</code> could also do the unwrapping)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for @AlexWaygood removed by @AlexWaygood on 2025-12-19 14:09</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ty_python_semantic/src/program.rs</code>:170 on 2025-12-19 14:55</div>
            <div class="timeline-body"><p>I think you can just use <code>std::convert::Infallible</code> here instead. (I don't know if it really matters. Probably not. But seems nicer to use the same type as std.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ty_python_semantic/src/program.rs</code>:175 on 2025-12-19 14:59</div>
            <div class="timeline-body"><p>What about naming these <code>FallibleStrategy</code> and <code>InfallibleStrategy</code>?</p>
<p>Although, I do think I like <code>UseDefaultStrategy</code> more than <code>InfallibleStrategy</code>. I think it's more specific.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ty_python_semantic/src/program.rs</code>:218 on 2025-12-19 15:08</div>
            <div class="timeline-body"><p>Great docs. This really helped me understand the approach here.</p>
<p>I might add here that we previously did this at runtime with a simple enum, but that we kept playing whack-a-mole since every call site needed to check the enum. Hence the justification for more sophisticated type wizardry to statically prevent it to force all callers to deal with the possibility of an automatic fallback.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Gankra">@Gankra</a> reviewed on 2025-12-19 15:12</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/Gankra">@Gankra</a> on <code>crates/ruff_benchmark/benches/ty.rs</code>:92 on 2025-12-19 15:12</div>
            <div class="timeline-body"><p>Hm I think the tests/benches do actually want this unwrap() because we want to immediately slam the breaks if they're misconfigured or if someone has broken a common setup. Unless we're trying to emulate the default database experience?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ty_project/src/db.rs</code>:50 on 2025-12-19 15:13</div>
            <div class="timeline-body"><p>Out of curiosity, how come you ended up using an <code>&amp;Strategy</code> here instead of just a <code>Strategy</code>?</p>
<p>If I were to try and answer my own question, I think it's because this assumes less about <code>MisconfigurationStrategy</code>. I think in order to make just <code>Strategy</code> work, you'd need to add a <code>Copy</code> bound to <code>MisconfigurationStrategy</code>?</p>
<p>I guess it doesn't really matter.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ty_python_semantic/src/program.rs</code>:219 on 2025-12-19 15:13</div>
            <div class="timeline-body"><p>Since this is mostly just an internal trait (and probably spiritually sealed at least), I might add a <code>std::fmt::Debug</code> constraint here. That way folks can <code>dbg!</code> it in random code.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ruff_benchmark/benches/ty.rs</code>:92 on 2025-12-19 15:15</div>
            <div class="timeline-body"><p>If we went this route, I'd go with <code>ProjectDatabase::fallible</code> and <code>ProjectDatabase::automatic_defaults</code> or something like that. I'd avoid <code>safe</code> personally, given its confusability with Rust notions of safety.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> approved on 2025-12-19 15:17</div>
            <div class="timeline-body"><p>This seems okay to me. I feel like the GAT is mostly bundled up pretty tight. And the docs on the trait helped me understand the approach. :-)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Gankra">@Gankra</a> reviewed on 2025-12-19 15:29</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/Gankra">@Gankra</a> on <code>crates/ty_project/src/db.rs</code>:50 on 2025-12-19 15:29</div>
            <div class="timeline-body"><p>Yep I just didn't want to add the Copy bound, didn't feel it mattered much.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:18:12 UTC
    </footer>
</body>
</html>
