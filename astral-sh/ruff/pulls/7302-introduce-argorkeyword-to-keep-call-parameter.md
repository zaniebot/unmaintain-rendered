```yaml
number: 7302
title: "Introduce `ArgOrKeyword` to keep call parameter order"
type: pull_request
state: merged
author: konstin
labels:
  - internal
assignees: []
merged: true
base: main
head: arg-or-keyword
created_at: 2023-09-12T12:58:15Z
updated_at: 2023-09-13T08:52:07Z
url: https://github.com/astral-sh/ruff/pull/7302
synced_at: 2026-01-12T15:55:23Z
```

# Introduce `ArgOrKeyword` to keep call parameter order

---

_@konstin_

## Motivation

The `ast::Arguments` for call argument are split into positional arguments (args) and keywords arguments (keywords). We currently assume that call consists of first args and then keywords, which is generally the case, but not always:

```python
f(*args, a=2, *args2, **kwargs)

class A(*args, a=2, *args2, **kwargs):
    pass
```

The consequence is accidentally reordering arguments (https://github.com/astral-sh/ruff/pull/7268).

## Summary

`Arguments::args_and_keywords` returns an iterator of an `ArgOrKeyword` enum that yields args and keywords in the correct order. I've fixed the obvious `args` and `keywords` usages, but there might be some cases with wrong assumptions remaining.

## Test Plan

The generator got new test cases, otherwise the stacked PR (https://github.com/astral-sh/ruff/pull/7268) which uncovered this.


---

_Comment by @konstin on 2023-09-12 12:58_

Current dependencies on/for this PR:
* main
  * **PR #7302** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7302" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a>  ðŸ‘ˆ
    * **PR #7268** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7268" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a> 

This comment was auto-generated by [Graphite](https://app.graphite.dev/github/pr/astral-sh/ruff/7302?utm_source=stack-comment).

---

_Review comment by @MichaReiser on `crates/ruff_python_ast/src/visitor.rs`:576 on 2023-09-12 13:01_

The ordering in this visitor should be the same as the execution order at runtime. 

---

_@MichaReiser reviewed on 2023-09-12 13:01_

---

_@konstin reviewed on 2023-09-12 13:15_

---

_Review comment by @konstin on `crates/ruff_python_ast/src/visitor.rs`:576 on 2023-09-12 13:15_

Input:
```python
def f(*args, **kwargs):
    pass

def g(x):
    print(x)
    return x


f(*g([1]), a=g(2), *g([3]), **g({"4": 5}))
```
Output:
```python
[1]
[3]
2
{'4': 5}
```
:face_with_spiral_eyes: 

---

_Comment by @github-actions[bot] on 2023-09-12 13:17_

## PR Check Results
### Ecosystem
âœ… ecosystem check detected no changes.



---

_@konstin reviewed on 2023-09-12 13:24_

---

_Review comment by @konstin on `crates/ruff_python_ast/src/visitor.rs`:576 on 2023-09-12 13:24_

thanks for making me check

---

_Marked ready for review by @konstin on 2023-09-12 14:51_

---

_Review requested from @MichaReiser by @konstin on 2023-09-12 14:51_

---

_Label `internal` added by @MichaReiser on 2023-09-12 15:38_

---

_Review comment by @MichaReiser on `crates/ruff_python_ast/src/nodes.rs`:2279 on 2023-09-12 15:39_

I find `declared` a bit misleading in this context because I would expect the order match the order of the arguments in the function or class declaration. But what I understand is that this is specific to call expressions and the arguments aren't a declaration (they aren't binding a name). 

Maybe `arguments_preoder()` or `arguments_souce_order`?

---

_Review comment by @MichaReiser on `crates/ruff_python_ast/src/helpers.rs`:216 on 2023-09-12 15:43_

The ordering shouldn't mater for `any_over_expr`, meaning we can use the "cheaper" arguments than keywords iteration. Same for classes.

---

_@MichaReiser approved on 2023-09-12 15:55_

---

_Merged by @konstin on 2023-09-13 08:45_

---

_Closed by @konstin on 2023-09-13 08:45_

---

_Branch deleted on 2023-09-13 08:45_

---
