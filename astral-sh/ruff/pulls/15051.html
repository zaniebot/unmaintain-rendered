<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[`ruff`] Needless `else` clause (`RUF047`) - astral-sh/ruff #15051</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[<code>ruff</code>] Needless <code>else</code> clause (<code>RUF047</code>)</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/15051">#15051</a>
        opened by <a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a>
        on 2024-12-19 01:30
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a> on 2024-12-19 01:30</div>
            <div class="timeline-body"><h2>Summary</h2>
<p>Partially addresses #13929.</p>
<h2>Test Plan</h2>
<p><code>cargo nextest run</code> and <code>cargo insta test</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2024-12-19 01:39</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>ℹ️ ecosystem check <strong>detected linter changes</strong>. (+6 -0 violations, +0 -0 fixes in 2 projects; 53 projects unchanged)</p>
<details><summary><a href="https://github.com/apache/airflow">apache/airflow</a> (+4 -0 violations, +0 -0 fixes)</summary>
<p>
<pre>ruff check --no-cache --exit-zero --ignore RUF9 --no-fix --output-format concise --preview --select ALL</pre>
</p>
<p>

<pre>
+ <a href='https://github.com/apache/airflow/blob/41b151e7dde473ec445f9f78fb4b8db826c368fc/providers/src/airflow/providers/google/cloud/operators/bigquery.py#L1638'>providers/src/airflow/providers/google/cloud/operators/bigquery.py:1638:9:</a> RUF047 [*] Empty `else` clause
+ <a href='https://github.com/apache/airflow/blob/41b151e7dde473ec445f9f78fb4b8db826c368fc/providers/tests/fab/auth_manager/api_endpoints/test_asset_endpoint.py#L38'>providers/tests/fab/auth_manager/api_endpoints/test_asset_endpoint.py:38:5:</a> RUF047 [*] Empty `else` clause
+ <a href='https://github.com/apache/airflow/blob/41b151e7dde473ec445f9f78fb4b8db826c368fc/providers/tests/fab/auth_manager/api_endpoints/test_dag_run_endpoint.py#L44'>providers/tests/fab/auth_manager/api_endpoints/test_dag_run_endpoint.py:44:5:</a> RUF047 [*] Empty `else` clause
+ <a href='https://github.com/apache/airflow/blob/41b151e7dde473ec445f9f78fb4b8db826c368fc/tests/models/test_taskinstance.py#L2388'>tests/models/test_taskinstance.py:2388:17:</a> RUF047 [*] Empty `else` clause
</pre>

</p>
</details>
<details><summary><a href="https://github.com/lnbits/lnbits">lnbits/lnbits</a> (+2 -0 violations, +0 -0 fixes)</summary>
<p>
<pre>ruff check --no-cache --exit-zero --ignore RUF9 --no-fix --output-format concise --preview</pre>
</p>
<p>

<pre>
+ <a href='https://github.com/lnbits/lnbits/blob/51c9d294cdb40c777b1048bbee267b49cdaf7a34/lnbits/core/crud.py#L791'>lnbits/core/crud.py:791:5:</a> RUF047 [*] Empty `else` clause
+ <a href='https://github.com/lnbits/lnbits/blob/51c9d294cdb40c777b1048bbee267b49cdaf7a34/lnbits/core/crud.py#L800'>lnbits/core/crud.py:800:5:</a> RUF047 [*] Empty `else` clause
</pre>

</p>
</details>
<details><summary>Changes by rule (1 rules affected)</summary>
<p>

<p>| code | total | + violation | - violation | + fix | - fix |
| ---- | ------- | --------- | -------- | ----- | ---- |
| RUF047 | 6 | 6 | 0 | 0 | 0 |</p>
</p>
</details>

</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">rule</span> added by @MichaReiser on 2024-12-19 07:27</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">preview</span> added by @MichaReiser on 2024-12-19 07:27</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/ruff/rules/needless_else.rs</code>:14 on 2024-12-19 07:29</div>
            <div class="timeline-body"><pre><code class="language-suggestion">/// Such an else clause does nothing and can be removed.
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/ruff/rules/needless_else.rs</code>:39 on 2024-12-19 07:30</div>
            <div class="timeline-body"><pre><code class="language-suggestion">        &quot;Remove the `else` clause&quot;.to_string()
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @MichaReiser by @MichaReiser on 2024-12-19 08:20</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/ruff/mod.rs</code>:429 on 2024-12-19 08:53</div>
            <div class="timeline-body"><p>The needless-else rule has no <code>mode.is_preview</code> checks. We can add it to the normal <code>rules</code> test, which simplifies promoting them to stable.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/ruff/snapshots/ruff_linter__rules__ruff__tests__preview__RUF047_RUF047_if.py.snap</code>:73 on 2024-12-19 08:54</div>
            <div class="timeline-body"><p>We should not suggest this fix because the comment belongs to the <code>else</code> clause</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/resources/test/fixtures/ruff/RUF047_if.py</code>:60 on 2024-12-19 08:55</div>
            <div class="timeline-body"><p>We should detect that this <code>else</code> branch is useless because the comment belongs to the if block</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> requested changes on 2024-12-19 08:58</div>
            <div class="timeline-body"><p>Thanks.</p>
<p>I refactored your rule to remove some duplication and simplified it to only detect single <code>pass</code> or <code>...</code> statements. PIE790 detects bodies containing both a <code>...</code> and a <code>pass</code> statement.</p>
<p>I further extended the test cases and there's one case where we fail to detect a useless else because of the comment and one case where we marked the else as useless when we should not. We have to take the indent of the comments into consideration.  See https://github.com/astral-sh/ruff/blob/9f3a38d408f473df7a6b3574c5d1389bef303dd5/crates/ruff_python_formatter/src/comments/placement.rs#L552 and https://github.com/astral-sh/ruff/blob/9f3a38d408f473df7a6b3574c5d1389bef303dd5/crates/ruff_python_formatter/src/comments/placement.rs#L641</p>
<p>Maybe we can come up with a simpler heuristic for this specific case?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a> on 2024-12-19 17:29</div>
            <div class="timeline-body"><p>@MichaReiser If indentation is to be taken into consideration, should this be reported or not?</p>
<pre><code class="language-py">if test:
    _4_spaces()
  # 2 spaces
else:
    ...
</code></pre>
<p>What about this?</p>
<pre><code class="language-py">if test:
	_1_tab()  # These two lines would align if tabs are displayed as 1 character wide.
 # 1 space
else:
	...

# Same question, but for 2, 3, 4 spaces?
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-12-20 08:11</div>
            <div class="timeline-body"><p>We should implement it so that it's consistent with the formatter. Your examples get formatted to</p>
<pre><code class="language-py">if test:
    _1_tab()  # These two lines would align if tabs are displayed as 1 character wide.
    # 1 space
else:
    ...

# Same question, but for 2, 3, 4 spaces?

if test:
    _4_spaces()
# 2 spaces
else:
    ...
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-01-03 09:36</div>
            <div class="timeline-body"><p>@InSyncWithFoo do you plan to follow up on this PR?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a> on 2025-01-03 21:26</div>
            <div class="timeline-body"><p>@MichaReiser Yes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a> on 2025-01-20 04:52</div>
            <div class="timeline-body"><p>Took me long enough. I think I got most of it, save for this one:</p>
<pre><code class="language-python">if a:
	b()
else:
	...
	# comment
</code></pre>
<p>I have no idea how to detect that comment: it's not included within <code>else_range</code>. I thought about manual tokens processing, but then I wouldn't know when to stop, because there might not be a next statement at all. Iterating all comments is a lot more expensive than necessary, so that's not a good choice either.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-01-20 10:18</div>
            <div class="timeline-body"><blockquote>
<p>I have no idea how to detect that comment: it's not included within else_range. I thought about manual tokens processing, but then I wouldn't know when to stop, because there might not be a next statement at all. Iterating all comments is a lot more expensive than necessary, so that's not a good choice either.</p>
</blockquote>
<p>I would use the tokens and start at the end of the <code>else_range</code> and skip all tokens until it finds the first new line token. From there, keep taking all tokens until you find the first non-trivia token that isn't a comment. For all comments in that range, test if the indent of the comment is larger than the indent of the <code>else</code> header. If so -&gt; it belongs to the else body. You can stop as soon as you've found the first comment that doesn't belong to the else body.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2025-01-21 08:16</div>
            <div class="timeline-body"><p>Nice</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @MichaReiser on 2025-01-21 08:21</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @MichaReiser on 2025-01-21 08:21</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-01-21 12:30</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 20:06:10 UTC
    </footer>
</body>
</html>
