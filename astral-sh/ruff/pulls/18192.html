<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[ty] Add hint that PEP 604 union syntax is only available in 3.10+ - astral-sh/ruff #18192</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[ty] Add hint that PEP 604 union syntax is only available in 3.10+</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/18192">#18192</a>
        opened by <a href="https://github.com/sharkdp">@sharkdp</a>
        on 2025-05-19 08:12
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-05-19 08:12</div>
            <div class="timeline-body"><h2>Summary</h2>
<p>Add a new diagnostic hint if you try to use PEP 604 <code>X | Y</code> union syntax in a non-type-expression before 3.10:</p>
<p><img src="https://github.com/user-attachments/assets/e29b9335-3273-439f-9d7c-1154b6d00687" alt="image" /></p>
<p>closes https://github.com/astral-sh/ty/issues/437</p>
<h2>Test Plan</h2>
<p>New snapshot test</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @sharkdp on 2025-05-19 08:12</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @AlexWaygood by @sharkdp on 2025-05-19 08:12</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @dcreager by @sharkdp on 2025-05-19 08:12</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ty</span> added by @sharkdp on 2025-05-19 08:12</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">diagnostics</span> added by @sharkdp on 2025-05-19 08:12</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-05-19 08:15</div>
            <div class="timeline-body"><!-- generated-comment mypy_primer -->

<h2><code>mypy_primer</code> results</h2>
<p>No ecosystem changes detected ✅</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-05-19 08:17</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/ty_python_semantic/src/types/infer.rs</code>:5903 on 2025-05-19 08:17</div>
            <div class="timeline-body"><p>One could certainly construct cases where we emit this info even if the user is trying to do something that does not involve type hints, but it seems unlikely? And not too distracting even if?</p>
<p>On the contrary, there are probably also cases where we fail to emit this info due to the class-literal filter above. We could think about relaxing this (e.g. checking if <code>type</code> is in the MRO of both <code>left_ty</code> and <code>right_ty</code>, or further trying to detect other types that might appear in those positions), but I'm not sure if it's worth it?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-05-19 08:31</div>
            <div class="timeline-body"><p>Sweet. I let someone else answer your comment around &quot;filtering&quot;.</p>
<p>It would be nice if we could also show the actual python version, similar to https://github.com/astral-sh/ruff/pull/18068</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/danielhollas">@danielhollas</a> on <code>crates/ty_python_semantic/resources/mdtest/assignment/annotations.md</code>:104 on 2025-05-19 10:54</div>
            <div class="timeline-body"><p>Should there be a test case for stringified annotations (<code>from __future__ import annotations</code>)?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/danielhollas">@danielhollas</a> reviewed on 2025-05-19 10:54</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-05-19 14:34</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/ty_python_semantic/resources/mdtest/assignment/annotations.md</code>:104 on 2025-05-19 14:34</div>
            <div class="timeline-body"><p>I don't understand how that's related to the functionality being added here? <code>int | str</code> in <em>non-type-expressions</em> is an error in Python 3.9 and earlier, no matter if annotations are deferred or not, right?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/danielhollas">@danielhollas</a> reviewed on 2025-05-19 14:45</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/danielhollas">@danielhollas</a> on <code>crates/ty_python_semantic/resources/mdtest/assignment/annotations.md</code>:104 on 2025-05-19 14:45</div>
            <div class="timeline-body"><p>if <code>from __future__ import</code> is present at the top of the file then all annotations are stringified, and so they should not error even in 3.9.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-05-19 14:48</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/ty_python_semantic/resources/mdtest/assignment/annotations.md</code>:104 on 2025-05-19 14:48</div>
            <div class="timeline-body"><p>In annotations, yes. But not in non-type expressions:</p>
<pre><code class="language-pycon">▶ uv run -p 3.9 python
Python 3.9.20 (main, Oct 16 2024, 04:36:33) 
[Clang 18.1.8 ] on linux
Type &quot;help&quot;, &quot;copyright&quot;, &quot;credits&quot; or &quot;license&quot; for more information.
&gt;&gt;&gt; from __future__ import annotations
&gt;&gt;&gt; def f(x: int | str): ...
... 
&gt;&gt;&gt; A = int | str
Traceback (most recent call last):
  File &quot;&lt;stdin&gt;&quot;, line 1, in &lt;module&gt;
TypeError: unsupported operand type(s) for |: 'type' and 'type'
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2025-05-19 14:55</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/ty_python_semantic/resources/mdtest/assignment/annotations.md</code>:104 on 2025-05-19 14:55</div>
            <div class="timeline-body"><p>I think it would be clearer to say &quot;non-annotations&quot; than &quot;non-type-expressions&quot;, since (with implicit type alias support, which we don't fully have yet), <code>int | str</code> in <code>A = int | str</code> should be evaluated as a type expression -- but it will still fail at runtime in older Python versions, regardless of <code>from __future__ import annotations</code>, because it is not syntactically an <em>annotation</em>, and <code>from __future__ import annotations</code> affects only <em>annotations</em>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-05-19 14:57</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_python_semantic/src/types/infer.rs</code>:5900 on 2025-05-19 14:57</div>
            <div class="timeline-body"><p>I think we could probably add the note whenever <code>left_ty</code> and <code>right_ty</code> are both subtypes of <code>KnownClass::Type.to_instance(db)</code>? <code>is_assignable_to</code> would not be appropriate here because e.g. <code>Any</code> is assignable to <code>type</code>, but <code>is_subtype_of</code> should be safe</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2025-05-19 14:59</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/ty_python_semantic/resources/mdtest/assignment/annotations.md</code>:104 on 2025-05-19 14:59</div>
            <div class="timeline-body"><p>(This will probably also add complexity to the implementation to keep these tests passing when we improve our support for implicit type aliases, because we might need to evaluate these both as value expressions -- in order to get these diagnostics -- and as type expressions -- in order to know how to interpret them when used as a type alias. )</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/danielhollas">@danielhollas</a> reviewed on 2025-05-19 15:00</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/danielhollas">@danielhollas</a> on <code>crates/ty_python_semantic/resources/mdtest/assignment/annotations.md</code>:104 on 2025-05-19 15:00</div>
            <div class="timeline-body"><p>I am sorry, I should have read the PR description more closely. The linked issue talks about the union syntax in function definitions so I got confused. I am assuming that error messages coming from type expressions are coming in a separate PR? (ie. to address astral-sh/ty#449).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/ty_python_semantic/src/types/infer.rs</code>:5899 on 2025-05-19 15:03</div>
            <div class="timeline-body"><p>I'm not sure we need to check the RHS type at all here. There could be cases like <code>int | foo</code> where <code>foo</code> is something other than a class literal type where this runtime error would still occur, and this hint would be just as useful.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> approved on 2025-05-19 15:04</div>
            <div class="timeline-body"><p>Thank you!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-05-19 15:08</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_python_semantic/src/types/infer.rs</code>:5899 on 2025-05-19 15:08</div>
            <div class="timeline-body"><p>Yes, if either the l.h.s. or the r.h.s. is a subtype of <code>type</code>, it should be fine to display the hint. <code>TypeVar(&quot;T&quot;) | int</code> succeeds on Python 3.10+ but not on earlier versions</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @sharkdp on 2025-05-19 17:47</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @sharkdp on 2025-05-19 17:47</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-05-19 17:47</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 18:51:29 UTC
    </footer>
</body>
</html>
