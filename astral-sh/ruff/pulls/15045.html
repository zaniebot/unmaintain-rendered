<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Don't special-case class instances in unary expression inference - astral-sh/ruff #15045</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Don't special-case class instances in unary expression inference</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/15045">#15045</a>
        opened by <a href="https://github.com/dcreager">@dcreager</a>
        on 2024-12-18 15:48
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/dcreager">@dcreager</a> on 2024-12-18 15:48</div>
            <div class="timeline-body"><p>We have a handy <code>to_meta_type</code> that does the right thing for class instances, and also works for all of the other types that are “instances of” something.  Unless I'm missing something, this should let us get rid of the catch-all clause in one fell swoop.</p>
<p>cf #14548</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by @dcreager on 2024-12-18 15:48</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @dcreager on 2024-12-18 15:48</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @dcreager on 2024-12-18 15:48</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @AlexWaygood by @dcreager on 2024-12-18 15:48</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @sharkdp by @dcreager on 2024-12-18 15:48</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2024-12-18 16:01</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:3208 on 2024-12-18 16:52</div>
            <div class="timeline-body"><p>Would using <code>Type::call_dunder</code> simplify this even a bit more?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> approved on 2024-12-18 16:53</div>
            <div class="timeline-body"><p>Very nice!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:3196 on 2024-12-18 16:53</div>
            <div class="timeline-body"><p>nit: I know there's a lot of variants in the <code>Type</code> enum, but I'd prefer it if we could explicitly list all the remaining ones in this <code>match</code> arm rather than using <code>_</code> for the second tuple element. The advantage is that if we add another <code>Type</code> variant in the future that we want to special-case in unary expressions (similar to the special-casing we already do for <code>Type::IntLiteral</code> and <code>Type::BooleanLiteral</code> above), there's no chance of us forgetting to add that special-casing. We'll be forced to explicitly consider whether the new variant should be handled in its own <code>match</code> arm or be handled as part of the catch-all fallback case here.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> approved on 2024-12-18 16:56</div>
            <div class="timeline-body"><p>Nice!!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2024-12-18 17:45</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:3196 on 2024-12-18 17:45</div>
            <div class="timeline-body"><p>I'm not so sure explicitly listing all variants is always the best answer. In this case, the handling in this arm really is a generic implementation of the semantics in terms of other type semantics. It should always be correct for <em>any</em> type (even the ones we special case above here), assuming a correct implementation of calling dunder methods (<code>to_meta_type</code>, <code>member</code>, etc -- all of which <em>do</em> use exhaustive matches and we'll be forced to consider for any new Type variant.) Thus, a special case for a new Type variant here would not be required for correctness, it would just potentially offer more precision. I kind of think it's fine, possibly even good, for that &quot;more precision&quot; to be driven only by actual user needs, and not something we are forced to consider.</p>
<p>But I'm really fine with it either way.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:3196 on 2024-12-18 17:50</div>
            <div class="timeline-body"><p>Yes, you're right that there isn't a correctness issue here. But I would expect more precision here to be both trivial to accomplish for any new variants and simpler for us to compute. The <code>IntLiteral()</code> branches above really involve much less work for us than doing the full lookup for an instance type's dunder method in typeshed or user code (which could involve materialising an MRO!). I don't really see a reason <em>not</em> for us to infer the more precise type whenever possible if it's trivial to do so, and I'd at least like us to be forced to consider whether it would be better to do so</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-12-18 17:50</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dcreager">@dcreager</a> reviewed on 2024-12-18 18:25</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dcreager">@dcreager</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:3208 on 2024-12-18 18:25</div>
            <div class="timeline-body"><p>Oh hey look at that!  Yes it would</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dcreager">@dcreager</a> reviewed on 2024-12-18 18:32</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dcreager">@dcreager</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:3196 on 2024-12-18 18:32</div>
            <div class="timeline-body"><p>Sounds like there's a -0 vote from Carl and a +1 from Alex, so I went ahead and expanded the clauses out.  We can always put it back to <code>_</code> in the future if we find this more unwieldy than the benefit.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @dcreager on 2024-12-18 19:37</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @dcreager on 2024-12-18 19:37</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-12-18 19:37</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 20:42:57 UTC
    </footer>
</body>
</html>
