<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[ty] Fix TypeIs generic type narrowing with deferred materialization - astral-sh/ruff #21739</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[ty] Fix TypeIs generic type narrowing with deferred materialization</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/pull/21739">#21739</a>
        opened by <a href="https://github.com/suleymanozkeskin">@suleymanozkeskin</a>
        on 2025-12-01 20:41
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/suleymanozkeskin">@suleymanozkeskin</a></div>
            <div class="timeline-body"><p>Fixes <a href="https://github.com/astral-sh/ty/issues/1703">astral-sh/ty#1703</a></p>
<p>Fixes incomplete type narrowing when using TypeIs with generic union types like: Result[T, E] = Ok[T] | Err[E].</p>
<p>Previously, type parameter E was materialized to &#x27;object&#x27; before specialization could substitute it with concrete types like Exception, causing narrowing to produce Err[Unknown] instead of Err[Exception].</p>
<p>Changes:</p>
<ul>
<li>Added is_materialized flag to TypeIsType to defer materialization</li>
<li>Implemented class-based union element matching for multi-typevar unions in generics.rs</li>
<li>Modified TypeIs creation to delay materialization until after specialization</li>
<li>Added test case for generic TypeIs narrowing to type_guards.md</li>
<li>Removed the comments which had a discussion about: <a href="https://github.com/astral-sh/ruff/pull/20591">astral-sh/ruff#20591</a></li>
</ul>


Summary
<p>This pr should improve type narrowing in cases where generics are used.</p>
Test Plan
<p>I did run the existing tests and added the respective case to type_guards.md to be tested, and it passed.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/carljm">@carljm</a> by <a href="https://github.com/suleymanozkeskin">@suleymanozkeskin</a> on 2025-12-01 20:41</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/AlexWaygood">@AlexWaygood</a> by <a href="https://github.com/suleymanozkeskin">@suleymanozkeskin</a> on 2025-12-01 20:41</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/sharkdp">@sharkdp</a> by <a href="https://github.com/suleymanozkeskin">@suleymanozkeskin</a> on 2025-12-01 20:41</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/dcreager">@dcreager</a> by <a href="https://github.com/suleymanozkeskin">@suleymanozkeskin</a> on 2025-12-01 20:41</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ty</span> added by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-12-01 20:45</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/astral-sh-bot[bot]">@astral-sh-bot[bot]</a> on 2025-12-01 20:47</div>
            <div class="timeline-body">

Diagnostic diff on <a href="https://github.com/python/typing/tree/9f6d8ced7cd1c8d92687a4e9c96d7716452e471e/conformance">typing conformance tests</a>
<p>No changes detected when running ty on typing conformance tests ✅</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/astral-sh-bot[bot]">@astral-sh-bot[bot]</a> on 2025-12-01 20:49</div>
            <div class="timeline-body">

<code>mypy_primer</code> results

Changes were detected when running on open source projects

<pre><code>beartype (https://github.com/beartype/beartype)
- beartype/claw/_package/clawpkgtrie.py:66:29: warning[unsupported-base] Unsupported class base with type `&lt;class &#x27;dict[str, PackagesTrieBlacklist]&#x27;&gt; | &lt;class &#x27;dict[str, Divergent]&#x27;&gt;`
- beartype/claw/_package/clawpkgtrie.py:247:29: warning[unsupported-base] Unsupported class base with type `&lt;class &#x27;dict[str, PackagesTrieWhitelist]&#x27;&gt; | &lt;class &#x27;dict[str, Divergent]&#x27;&gt;`
- Found 494 diagnostics
+ Found 492 diagnostics

scrapy (https://github.com/scrapy/scrapy)
+ scrapy/http/headers.py:32:26: error[invalid-argument-type] Argument to bound method `__init__` is incorrect: Argument type `AnyStr@__init__` does not satisfy constraints (`str`, `bytes`) of type variable `AnyStr`
+ scrapy/http/response/__init__.py:224:13: error[invalid-argument-type] Argument to bound method `__init__` is incorrect: Argument type `AnyStr@follow` does not satisfy constraints (`str`, `bytes`) of type variable `AnyStr`
+ scrapy/http/response/__init__.py:271:17: error[invalid-argument-type] Argument to bound method `follow` is incorrect: Argument type `AnyStr@follow_all` does not satisfy constraints (`str`, `bytes`) of type variable `AnyStr`
+ scrapy/http/response/text.py:206:13: error[invalid-argument-type] Argument to bound method `follow` is incorrect: Argument type `AnyStr@follow` does not satisfy constraints (`str`, `bytes`) of type variable `AnyStr`
+ scrapy/http/response/text.py:279:13: error[invalid-argument-type] Argument to bound method `follow_all` is incorrect: Argument type `AnyStr@follow_all` does not satisfy constraints (`str`, `bytes`) of type variable `AnyStr`
- Found 1735 diagnostics
+ Found 1740 diagnostics

tornado (https://github.com/tornadoweb/tornado)
- tornado/gen.py:808:25: error[invalid-argument-type] Argument to function `future_set_result_unless_cancelled` is incorrect: Expected `Future[Any] | Future[Any]`, found `Unknown | Future[_T@__init__] | None`
+ tornado/gen.py:808:25: error[invalid-argument-type] Argument to function `future_set_result_unless_cancelled` is incorrect: Expected `Future[_T@__init__ | Any] | Future[_T@__init__ | Any]`, found `Unknown | Future[_T@__init__] | None`
- tornado/gen.py:815:41: error[invalid-argument-type] Argument to function `future_set_exc_info` is incorrect: Expected `Future[Unknown] | Future[Unknown]`, found `Unknown | Future[_T@__init__] | None`
+ tornado/gen.py:815:41: error[invalid-argument-type] Argument to function `future_set_exc_info` is incorrect: Expected `Future[_T@__init__] | Future[_T@__init__]`, found `Unknown | Future[_T@__init__] | None`
- tornado/iostream.py:1295:48: error[invalid-argument-type] Argument to function `future_set_result_unless_cancelled` is incorrect: Expected `Future[Self@_handle_connect] | Future[Self@_handle_connect]`, found `(Unknown &amp; ~None) | Future[IOStream]`
- Found 323 diagnostics
+ Found 322 diagnostics

altair (https://github.com/vega/altair)
- altair/utils/plugin_registry.py:110:44: error[invalid-parameter-default] Default value of type `def callable(obj: object, /) -&gt; TypeIs[() -&gt; object]` is not assignable to annotated parameter type `(object, /) -&gt; TypeIs[object]`
- altair/utils/schemapi.py:508:12: error[invalid-return-type] Return type does not match returned value: expected `list[Any]`, found `object`
- Found 1107 diagnostics
+ Found 1105 diagnostics

bokeh (https://github.com/bokeh/bokeh)
+ src/bokeh/layouts.py:116:37: error[invalid-argument-type] Argument to function `_parse_children_arg` is incorrect: Argument type `UIElement` does not satisfy upper bound `LayoutDOM` of type variable `L`
+ src/bokeh/layouts.py:151:37: error[invalid-argument-type] Argument to function `_parse_children_arg` is incorrect: Argument type `UIElement` does not satisfy upper bound `LayoutDOM` of type variable `L`
- Found 856 diagnostics
+ Found 858 diagnostics

streamlit (https://github.com/streamlit/streamlit)
+ lib/streamlit/elements/widgets/select_slider.py:414:70: error[invalid-argument-type] Argument to function `_is_range_value` is incorrect: Expected `T@_select_slider | Sequence[T@_select_slider]`, found `T@_select_slider | Sequence[T@_select_slider] | None`
- Found 124 diagnostics
+ Found 125 diagnostics

ibis (https://github.com/ibis-project/ibis)
- ibis/backends/tests/conftest.py:21:35: error[invalid-type-form] Variable of type `def callable(obj: object, /) -&gt; TypeIs[() -&gt; object]` is not allowed in a type expression
+ ibis/backends/tests/conftest.py:21:35: error[invalid-type-form] Variable of type `def callable(obj: object, /) -&gt; TypeIs[(...) -&gt; object]` is not allowed in a type expression

scipy (https://github.com/scipy/scipy)
- scipy/optimize/_hessian_update_strategy.py:239:21: error[unsupported-operator] Operator `*=` is unsupported between objects of type `None` and `float | ndarray[tuple[Any, ...], dtype[Unknown]]`
+ scipy/optimize/_hessian_update_strategy.py:239:21: error[unsupported-operator] Operator `*=` is unsupported between objects of type `None` and `float | ndarray[tuple[Any, ...], dtype[Any]]`
- scipy/optimize/_hessian_update_strategy.py:244:21: error[unsupported-operator] Operator `*=` is unsupported between objects of type `None` and `float | ndarray[tuple[Any, ...], dtype[Unknown]]`
+ scipy/optimize/_hessian_update_strategy.py:244:21: error[unsupported-operator] Operator `*=` is unsupported between objects of type `None` and `float | ndarray[tuple[Any, ...], dtype[Any]]`


</code></pre>


<p>No memory usage changes detected ✅</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-12-05 02:10</div>
            <div class="timeline-body"><p>Thank you for the PR! I think this PR is not quite the right fix, due to an incomplete analysis of the problem.</p>
<p>Materialization won&#x27;t transform a typevar to <code>object</code>; it will only transform a dynamic type (e.g. <code>Unknown</code> or <code>Any</code>). Materialization is not happening before specialization; it&#x27;s happening after specialization, but specialization fails to infer a type for these type variables (due to limitations of our current constraint solver) and thus they are specialized to <code>Unknown</code>, after which materialization takes effect. The right fix is to improve our constraint solver to handle this case. In <a href="https://github.com/astral-sh/ty/issues/1703">astral-sh/ty#1703</a>#issuecomment-3599797957 I showed an example that demonstrates the same issue occurring without <code>TypeIs</code>, so the fix should not require changes in <code>TypeIs</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/carljm">@carljm</a> on 2025-12-05 02:10</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:21:16 UTC
    </footer>
</body>
</html>
