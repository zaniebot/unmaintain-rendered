```yaml
number: 5211
title: Format function argument separator comments
type: pull_request
state: merged
author: konstin
labels:
  - formatter
assignees: []
merged: true
base: main
head: format_function_argument_separator_comments
created_at: 2023-06-20T15:14:40Z
updated_at: 2023-06-21T18:16:11Z
url: https://github.com/astral-sh/ruff/pull/5211
synced_at: 2026-01-12T15:55:17Z
```

# Format function argument separator comments

---

_@konstin_

## Summary

This is a complete rewrite of the handling of `/` and `*` comment handling in function signatures. The key problem is that slash and star don't have a note. We now parse out the positions of slash and star and their respective preceding and following note. I've left code comments for each possible case of function signature structure and comment placement

## Test Plan

I extended the function statement fixtures with cases that i found. If you have more weird edge cases your input would be appreciated.


---

_Comment by @konstin on 2023-06-20 15:14_

Current dependencies on/for this PR:
* main
  * **PR #5209** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/5209" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a> 
    * **PR #5210** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/5210" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a> 
      * **PR #5211** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/5211" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a>  ðŸ‘ˆ

This comment was auto-generated by [Graphite](https://app.graphite.dev/github/pr/astral-sh/ruff/5211?utm_source=stack-comment).

---

_Comment by @github-actions[bot] on 2023-06-20 15:53_

## PR Check Results
### Ecosystem
âœ… ecosystem check detected no changes.

### Benchmark
#### Linux
```
group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.00      6.9Â±0.02ms     5.9 MB/sec    1.02      7.0Â±0.03ms     5.8 MB/sec
formatter/numpy/ctypeslib.py               1.00   1372.4Â±2.71Âµs    12.1 MB/sec    1.01   1388.3Â±2.43Âµs    12.0 MB/sec
formatter/numpy/globals.py                 1.00    132.4Â±0.26Âµs    22.3 MB/sec    1.01    133.2Â±0.62Âµs    22.2 MB/sec
formatter/pydantic/types.py                1.00      2.8Â±0.02ms     9.0 MB/sec    1.02      2.9Â±0.03ms     8.8 MB/sec
linter/all-rules/large/dataset.py          1.01     13.7Â±0.11ms     3.0 MB/sec    1.00     13.6Â±0.03ms     3.0 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      3.4Â±0.00ms     4.8 MB/sec    1.00      3.4Â±0.01ms     4.8 MB/sec
linter/all-rules/numpy/globals.py          1.00    358.8Â±1.71Âµs     8.2 MB/sec    1.00    358.9Â±1.82Âµs     8.2 MB/sec
linter/all-rules/pydantic/types.py         1.00      6.0Â±0.01ms     4.2 MB/sec    1.00      6.0Â±0.01ms     4.2 MB/sec
linter/default-rules/large/dataset.py      1.00      7.0Â±0.01ms     5.8 MB/sec    1.00      7.0Â±0.02ms     5.8 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00   1463.7Â±4.83Âµs    11.4 MB/sec    1.00   1461.8Â±3.24Âµs    11.4 MB/sec
linter/default-rules/numpy/globals.py      1.00    154.5Â±0.30Âµs    19.1 MB/sec    1.00    154.7Â±0.19Âµs    19.1 MB/sec
linter/default-rules/pydantic/types.py     1.00      3.2Â±0.01ms     8.1 MB/sec    1.00      3.2Â±0.01ms     8.1 MB/sec
```

#### Windows
```
group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.00      7.9Â±0.16ms     5.2 MB/sec    1.08      8.5Â±0.11ms     4.8 MB/sec
formatter/numpy/ctypeslib.py               1.00  1598.8Â±47.53Âµs    10.4 MB/sec    1.06  1692.9Â±30.68Âµs     9.8 MB/sec
formatter/numpy/globals.py                 1.00    157.4Â±4.71Âµs    18.7 MB/sec    1.06    166.5Â±5.38Âµs    17.7 MB/sec
formatter/pydantic/types.py                1.00      3.3Â±0.06ms     7.8 MB/sec    1.08      3.5Â±0.06ms     7.2 MB/sec
linter/all-rules/large/dataset.py          1.00     15.8Â±0.24ms     2.6 MB/sec    1.01     15.9Â±0.29ms     2.6 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.01      4.2Â±0.07ms     4.0 MB/sec    1.00      4.2Â±0.07ms     4.0 MB/sec
linter/all-rules/numpy/globals.py          1.00   512.6Â±12.19Âµs     5.8 MB/sec    1.00   511.7Â±15.62Âµs     5.8 MB/sec
linter/all-rules/pydantic/types.py         1.01      7.2Â±0.14ms     3.6 MB/sec    1.00      7.1Â±0.13ms     3.6 MB/sec
linter/default-rules/large/dataset.py      1.00      8.2Â±0.11ms     5.0 MB/sec    1.00      8.1Â±0.12ms     5.0 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00  1735.6Â±27.66Âµs     9.6 MB/sec    1.00  1739.7Â±27.39Âµs     9.6 MB/sec
linter/default-rules/numpy/globals.py      1.00    202.9Â±7.80Âµs    14.5 MB/sec    1.00    203.1Â±7.58Âµs    14.5 MB/sec
linter/default-rules/pydantic/types.py     1.01      3.7Â±0.07ms     6.9 MB/sec    1.00      3.7Â±0.05ms     6.9 MB/sec
```
<!-- thollander/actions-comment-pull-request "PR Check Results" -->

---

_Label `formatter` added by @konstin on 2023-06-21 09:05_

---

_Marked ready for review by @konstin on 2023-06-21 10:23_

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/comments/placement.rs`:649 on 2023-06-21 11:06_

Nit: Should we pass `slash_and_star` by reference here. It would reduce the number of arguments. We could even implement this method on `slash_and_star`?

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/other/arguments.rs`:270 on 2023-06-21 11:08_

Can we remove this branch? The `else` branch returns `None` and the `else if` can never be `true` if `posonlyargs` is empty.

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/other/arguments.rs`:295 on 2023-06-21 11:46_

Nit: `arguments.kewonlyargs.is_empty` is already handled by the `else` branch (the only case where `.first()` returns `None`)

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/other/arguments.rs`:454 on 2023-06-21 11:49_

Nit: Define a struct with named fields. It's hard to guess the meaning of the text positions and range.

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/other/arguments.rs`:483 on 2023-06-21 11:50_

Nit: `TextRange::new(preceding_end, slash.start).contains(comment_range.start())` Not saying it is better. Just an alternative ;)

---

_@MichaReiser approved on 2023-06-21 11:52_

---

_Review comment by @konstin on `crates/ruff_python_formatter/src/comments/placement.rs`:649 on 2023-06-21 17:36_

i split slash and star into objects, both passed by reference

---

_@konstin reviewed on 2023-06-21 17:36_

---

_@konstin reviewed on 2023-06-21 17:37_

---

_Review comment by @konstin on `crates/ruff_python_formatter/src/other/arguments.rs`:270 on 2023-06-21 17:37_

good catch, this was remnant of the defaults list time

---

_@konstin reviewed on 2023-06-21 17:38_

---

_Review comment by @konstin on `crates/ruff_python_formatter/src/other/arguments.rs`:454 on 2023-06-21 17:38_

refactored the entire code

---

_@konstin reviewed on 2023-06-21 17:40_

---

_Review comment by @konstin on `crates/ruff_python_formatter/src/other/arguments.rs`:483 on 2023-06-21 17:40_

hmm either works, but i'll keep it as is

---

_Merged by @konstin on 2023-06-21 17:56_

---

_Closed by @konstin on 2023-06-21 17:56_

---

_Branch deleted on 2023-06-21 17:56_

---
