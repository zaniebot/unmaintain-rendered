<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[syntax-errors] Document behavior of `global` declarations in `try` nodes before 3.13 - astral-sh/ruff #17285</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[syntax-errors] Document behavior of <code>global</code> declarations in <code>try</code> nodes before 3.13</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/17285">#17285</a>
        opened by <a href="https://github.com/ntBre">@ntBre</a>
        on 2025-04-07 19:51
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/ntBre">@ntBre</a> on 2025-04-07 19:51</div>
            <div class="timeline-body"><h2>Summary</h2>
<p>This PR extends the documentation of the <code>LoadBeforeGlobalDeclaration</code> check to specify the behavior on versions of Python before 3.13. Namely, on Python 3.12, the <code>else</code> clause of a <code>try</code> statement is visited before the <code>except</code> handlers:</p>
<pre><code class="language-pycon">Python 3.12.9 (main, Feb 12 2025, 14:50:50) [Clang 19.1.6 ] on linux
Type &quot;help&quot;, &quot;copyright&quot;, &quot;credits&quot; or &quot;license&quot; for more information.
&gt;&gt;&gt; a = 10
&gt;&gt;&gt; def g():
...     try:
...         1 / 0
...     except:
...         a = 1
...     else:
...         global a
...
&gt;&gt;&gt; def f():
...     try:
...         pass
...     except:
...         global a
...     else:
...         print(a)
...
  File &quot;&lt;stdin&gt;&quot;, line 5
SyntaxError: name 'a' is used prior to global declaration

</code></pre>
<p>The order is swapped on 3.13 (see <a href="https://github.com/python/cpython/issues/111123">CPython#111123</a>):</p>
<pre><code class="language-pycon">Python 3.13.2 (main, Feb  5 2025, 08:05:21) [GCC 14.2.1 20250128] on linux
Type &quot;help&quot;, &quot;copyright&quot;, &quot;credits&quot; or &quot;license&quot; for more information.
&gt;&gt;&gt; a = 10
... def g():
...     try:
...         1 / 0
...     except:
...         a = 1
...     else:
...         global a
...
  File &quot;&lt;python-input-0&gt;&quot;, line 8
    global a
    ^^^^^^^^
SyntaxError: name 'a' is assigned to before global declaration
&gt;&gt;&gt; def f():
...     try:
...         pass
...     except:
...         global a
...     else:
...         print(a)
...
&gt;&gt;&gt;
</code></pre>
<p>The current implementation of PLE0118 is correct for 3.13 but not 3.12: <a href="https://play.ruff.rs/d7467ea6-f546-4a76-828f-8e6b800694c9">playground</a> (it flags the first case regardless of Python version).</p>
<p>We decided to maintain this incorrect diagnostic for Python versions before 3.13 because the pre-3.13 behavior is very unintuitive and confirmed to be a bug, although the bug fix was not backported to earlier versions. This can lead to false positives and false negatives for pre-3.13 code, but we also expect that to be very rare, as demonstrated by the ecosystem check (before the version-dependent check was reverted here).</p>
<h2>Test Plan</h2>
<p>N/a</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">rule</span> added by @ntBre on 2025-04-07 19:51</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @ntBre on 2025-04-07 19:51</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @dhruvmanila by @ntBre on 2025-04-07 19:51</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntBre">@ntBre</a> on 2025-04-07 19:53</div>
            <div class="timeline-body"><p>I just realized that this might need to be gated behind preview since it modifies an existing, stable lint rule. Alternatively, I could just use a different <code>SemanticSyntaxErrorKind</code> here, which seems a little easier. On the other hand, this could probably be considered a bug in the current rule implementation.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-04-07 20:01</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Formatter (stable)</h3>
<p>✅ ecosystem check detected no format changes.</p>
<h3>Formatter (preview)</h3>
<p>✅ ecosystem check detected no format changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntBre">@ntBre</a> on 2025-04-07 20:04</div>
            <div class="timeline-body"><p>Oh, there's a false positive anyway, moving back to draft.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Converted to draft by @ntBre on 2025-04-07 20:04</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntBre">@ntBre</a> on 2025-04-08 16:11</div>
            <div class="timeline-body"><p>The false positive should now be handled by tracking a scope depth in the source-order visitor to avoid flagging more-deeply-nested references. I think functions and classes are the only ways to introduce this kind of scope, in which <code>global</code> statements are also allowed (I don't think you can put a <code>global</code> statement in a comprehension or lambda).</p>
<p>I think <code>u32</code> should be huge overkill for the scope depth tracking, so I'm more than happy to drop the size of that to a more reasonable level, but I wasn't sure how low to go. Is <code>u8</code> enough?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @ntBre on 2025-04-08 16:18</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2025-04-08 22:06</div>
            <div class="timeline-body"><blockquote>
<p>I think <code>u32</code> should be huge overkill for the scope depth tracking, so I'm more than happy to drop the size of that to a more reasonable level, but I wasn't sure how low to go. Is <code>u8</code> enough?</p>
</blockquote>
<p><code>u32</code> should be fine, we use the same for <code>ScopeId</code>:</p>
<p>https://github.com/astral-sh/ruff/blob/058439d5d3f65db515d69359c99838d60776f45e/crates/ruff_python_semantic/src/scope.rs#L188-L194</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2025-04-08 22:07</div>
            <div class="timeline-body"><blockquote>
<p>On Python 3.12, the <code>else</code> clause is visited before the <code>except</code> handlers:</p>
</blockquote>
<p>This is confusing, do we have a source like a changelog entry where the related change is mentioned for context? It might also be useful to add that as comment in the source code.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2025-04-08 22:10</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_python_parser/src/semantic_errors.rs</code>:142 on 2025-04-08 22:10</div>
            <div class="timeline-body"><p>We should use the <code>visit_body</code> method instead in here, orelse, handlers, and finalbody.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntBre">@ntBre</a> on 2025-04-08 22:11</div>
            <div class="timeline-body"><blockquote>
<blockquote>
<p>On Python 3.12, the <code>else</code> clause is visited before the <code>except</code> handlers:</p>
</blockquote>
<p>This is confusing, do we have a source like a changelog entry where the related change is mentioned for context? It might also be useful to add that as comment in the source code.</p>
</blockquote>
<p>This is the <a href="https://github.com/python/cpython/issues/111123">bug report</a> Alex linked to in #11934. I'll look for anything else and at least link to this in the enum variant docs!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2025-04-08 22:14</div>
            <div class="timeline-body"><blockquote>
<p>This is the <a href="https://github.com/python/cpython/issues/111123">bug report</a> Alex linked to in #11934. I'll look for anything else and at least link to this in the enum variant docs!</p>
</blockquote>
<p>I think just linking to the CPython issue should be enough.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2025-04-08 22:24</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_python_parser/src/semantic_errors.rs</code>:142 on 2025-04-08 22:24</div>
            <div class="timeline-body"><p>except for the &quot;handlers&quot; loop</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2025-04-08 22:25</div>
            <div class="timeline-body"><p>(I need to head out now, I'll continue with the review later in the evening as I need to look at it a bit more closely to understand.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-04-09 06:21</div>
            <div class="timeline-body"><blockquote>
<p>I just realized that this might need to be gated behind preview since it modifies an existing, stable lint rule. Alternatively, I could just use a different SemanticSyntaxErrorKind here, which seems a little easier. On the other hand, this could probably be considered a bug in the current rule implementation.</p>
</blockquote>
<p>Can you tell me more in how the new implementation diverges from the existing one?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_parser/src/semantic_errors.rs</code>:139 on 2025-04-09 06:24</div>
            <div class="timeline-body"><p>Using a custom visitor here is probably fine because try statements aren't too deeply nested (they rarely contain nested functions) but this is now a case where the visitor ends up visiting entire suites multiple times:</p>
<ol>
<li>In the <code>TryExcept</code> visitor</li>
<li>The outer visitor</li>
</ol>
<p>I've a weak preference to avoid the double visitation unless it increases complexity by a lot</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_parser/src/semantic_errors.rs</code>:142 on 2025-04-09 06:24</div>
            <div class="timeline-body"><p>I think the easiest here is to call <code>walk_stmt(&amp;visitor, stmt)</code> because this is an exact reimplementation of visiting a try statement.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_parser/src/semantic_errors.rs</code>:1366 on 2025-04-09 06:25</div>
            <div class="timeline-body"><p>What about nested <code>try</code> statements?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_parser/src/semantic_errors.rs</code>:1358 on 2025-04-09 06:26</div>
            <div class="timeline-body"><p>What about lambda expressions?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_parser/src/semantic_errors.rs</code>:1359 on 2025-04-09 06:30</div>
            <div class="timeline-body"><p>I find it unfortunate that we're collecting all identifiers here, even if there isn't a single global statement in the program (which should be the vast majority of programs).</p>
<p>It also has the downside that globals handling is now handled here but also something that we expect the caller to handle (<code>context.global(name)</code>). Could we instead make use that <code>context</code> already provides a <code>global</code> method or extend the <code>context</code> interface to avoid doing this work twice?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_parser/src/semantic_errors.rs</code>:1325 on 2025-04-09 06:31</div>
            <div class="timeline-body"><p>We should store <code>name</code> references here (you have the <code>'a</code> lifetime anyway)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-04-09 06:31</div>
            <div class="timeline-body"><p>We should add a few more tests and explore if there's a way to avoid duplicating the globals handling between the semantic syntax checker and the caller.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntBre">@ntBre</a> on 2025-04-09 12:09</div>
            <div class="timeline-body"><blockquote>
<p>Can you tell me more in how the new implementation diverges from the existing one?</p>
</blockquote>
<p>The divergence is just the version-dependence of the branch visiting order. From the summary:</p>
<blockquote>
<p>The current implementation of PLE0118 is correct for 3.13 but not 3.12: <a href="https://play.ruff.rs/d7467ea6-f546-4a76-828f-8e6b800694c9">playground</a> (it flags the first case regardless of Python version).</p>
</blockquote>
<p>Phrasing it that way, it clearly sounds like a bug, but I think the old behavior was so unintuitive that probably nobody runs into it</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-04-09 12:12</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_python_parser/src/semantic_errors.rs</code>:142 on 2025-04-09 12:12</div>
            <div class="timeline-body"><p><code>walk_stmt</code> would only match one of these orders, right? We need to swap the order of the <code>orelse</code> and <code>handlers</code> visits depending on the version. I could still use it in one of the branches and then inline the whole modified version in the other branch.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_python_parser/src/semantic_errors.rs</code>:1358 on 2025-04-09 12:15</div>
            <div class="timeline-body"><p>Could you expand on that? I thought the <code>SourceOrderVisitor</code> would handle descending into lambda expressions for me. Or do they have another way of accessing an identifier that's not covered here?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-04-09 12:15</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-04-09 12:18</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_python_parser/src/semantic_errors.rs</code>:1366 on 2025-04-09 12:18</div>
            <div class="timeline-body"><p>I don't think <code>try</code> introduces a new scope:</p>
<pre><code class="language-pycon">&gt;&gt;&gt; try:
...     x = 1
... except:
...     pass
...
&gt;&gt;&gt; x
1
&gt;&gt;&gt;
</code></pre>
<p>I think only functions and classes do. Is that what you were asking?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-04-09 13:29</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_parser/src/semantic_errors.rs</code>:1358 on 2025-04-09 13:29</div>
            <div class="timeline-body"><p>Yes, the visitor traverses into lambdas. The question is whether it should (e.g. we don't traverse into nested functions or classes)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-04-09 13:37</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_python_parser/src/semantic_errors.rs</code>:1358 on 2025-04-09 13:37</div>
            <div class="timeline-body"><p>I might be getting confused here. Why don't we traverse into nested functions or classes? I thought the <code>source_order::walk_stmt</code> call in <code>visit_stmt</code> below would handle that.</p>
<p>The idea here was just to collect all identifiers and then compare them to the identifiers in any following <code>global</code> statements. If I missed traversing any kind of node that can contain identifiers, then I think it's a mistake, not my intention.</p>
<p>It sounds like I should add more tests with nested structures in any case.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-04-09 14:00</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_parser/src/semantic_errors.rs</code>:142 on 2025-04-09 14:00</div>
            <div class="timeline-body"><p>You're right, we traverse into function statements but we increase the <code>scope</code> counter. I have to take another look to understand what the scope counter is even used for but I suspect that different rules apply for names and global statements inside nested functions, classes and it's unclear to me if that also applies to lambdas (can't have any global statements but it may have identifiers).</p>
<p>So what I'm looking for is a test that demonstrates the behavior when lambdas are involved.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-04-09 14:24</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_python_parser/src/semantic_errors.rs</code>:139 on 2025-04-09 14:24</div>
            <div class="timeline-body"><p>I'll give this a try (no pun intended). The nice thing about the visitor is that it let me control the order in which things are seen, and I could just swap the order of the visits on different Python versions. I think that order-dependence might be hard to capture otherwise, but I'll play with it a bit.</p>
<p>The easiest thing to do would be to move that reordering into the parent visitor, but that seems too intrusive.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">documentation</span> added by @ntBre on 2025-04-09 16:04</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">rule</span> removed by @ntBre on 2025-04-09 16:04</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntBre">@ntBre</a> on 2025-04-09 16:08</div>
            <div class="timeline-body"><p>Based on our discussion on Discord, I reverted all of the code changes here and simply extended the rule variant documentation to reflect our decision to enforce the 3.13 clause ordering on all Python versions.</p>
<p>I initially planned to keep the inline tests to demonstrate this, but they would now rely on a proper implementation of <code>SemanticSyntaxContext::global</code> for the test context to work, so I just deleted them too. We could add a linter test for PLE0118 showing this, though, if we wanted.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntBre">@ntBre</a> on 2025-04-09 16:17</div>
            <div class="timeline-body"><p>The <code>cargo-shear</code> failure was an issue in downloading/building it, not an extra dependency. I'll try to rerun it</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2025-04-09 16:38</div>
            <div class="timeline-body"><p>Thanks and sorry for not raising this sooner</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntBre">@ntBre</a> on 2025-04-09 16:40</div>
            <div class="timeline-body"><p>No problem at all, I thought it was a useful discussion!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "[syntax-errors] `global` declarations in `try` nodes before 3.13" to "[syntax-errors] Document behavior of `global` declarations in `try` nodes before 3.13" by @ntBre on 2025-04-09 16:51</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @ntBre on 2025-04-09 16:54</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @ntBre on 2025-04-09 16:54</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-04-09 16:54</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 19:41:06 UTC
    </footer>
</body>
</html>
