<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[red-knot] Remove `Type::None` - astral-sh/ruff #14024</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[red-knot] Remove <code>Type::None</code></h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/14024">#14024</a>
        opened by <a href="https://github.com/sharkdp">@sharkdp</a>
        on 2024-10-31 20:09
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a></div>
            <div class="timeline-body"><h2>Summary</h2>
<p>Removes <code>Type::None</code> in favor of <code>KnownClass::NoneType.to_instance(‚Ä¶)</code>.</p>
<p>closes astral-sh/ruff#13670</p>
<h2>Test Plan</h2>
<p>Existing tests pass.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by @sharkdp on 2024-10-31 20:09</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @sharkdp on 2024-10-31 20:09</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @sharkdp on 2024-10-31 20:09</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @AlexWaygood by @sharkdp on 2024-10-31 20:09</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/codspeed-hq[bot]">@codspeed-hq[bot]</a> on 2024-10-31 20:21</div>
            <div class="timeline-body"><h2><a href="https://codspeed.io/astral-sh/ruff/branches/david/remove-type-none">CodSpeed Performance Report</a></h2>
<h3>Merging astral-sh/ruff#14024 will <strong>degrade performances by 4.32%</strong></h3>
<p><sub>Comparing <code>david/remove-type-none</code> (c7d4bdb) with <code>main</code> (e302c2d)</sub></p>
<h3>Summary</h3>
<p><code>‚ùå 1 (üëÅ 1)</code> regressions
<code>‚úÖ 31</code> untouched benchmarks</p>
<h3>Benchmarks breakdown</h3>
<p>|     | Benchmark | <code>main</code> | <code>david/remove-type-none</code> | Change |
| --- | --------- | ----------------------- | ------------------- | ------ |
| üëÅ | <code>red_knot_check_file[incremental]</code> | 4.4 ms | 4.6 ms | -4.32% |</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:641 on 2024-10-31 20:28</div>
            <div class="timeline-body"><p>In the long term, we should be able to remove these branches once we handle this TODO:</p>
<p>https://github.com/astral-sh/ruff/blob/b372fe719814c2178178e7e6ffef9ee52f528f7a/crates/red_knot_python_semantic/src/types.rs#L687-L695</p>
<p>Could you add a TODO comment here to that effect?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2024-10-31 20:29</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>‚úÖ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>‚úÖ ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:3682 on 2024-10-31 20:30</div>
            <div class="timeline-body"><p>This is identical to the branch immediately below it</p>
<pre><code class="language-suggestion"></code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-10-31 20:31</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-10-31 20:32</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:530 on 2024-10-31 20:32</div>
            <div class="timeline-body"><p>We should be able to remove this branch too once we understand that <code>NoneType</code> is a subclass of <code>object</code> (my MRO PR is coming soon!!)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2024-10-31 20:42</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:3682 on 2024-10-31 20:42</div>
            <div class="timeline-body"><p>Oh. Forgot that I had planned ahead!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2024-10-31 20:47</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:530 on 2024-10-31 20:47</div>
            <div class="timeline-body"><p>Note that this is about <code>NoneType &lt;: NoneType</code>. The <code>X &lt;: object</code> case is handled further above.</p>
<p>I'm actually surprised that <code>NoneType &lt;: NoneType</code> doesn't work without this. We have a <code>other == self</code> check in <code>is_subclass_of</code> on the <code>ClassType</code>s. Is that not working correctly? Is it actually checking for equal classes or for some other identity. Like just comparing salsa IDs?</p>
<blockquote>
<p>my MRO PR is coming soon!!</p>
</blockquote>
<p>That will definitely help us remove some cases!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:530 on 2024-10-31 21:06</div>
            <div class="timeline-body"><p><code>self == other</code> is indeed just checking salsa IDs. But Salsa IDs are assigned by Salsa interning, which interns based on struct equality, so that should be the same thing as an <code>Eq</code> check.</p>
<p>It would be good to understand what's happening here. Let me know if you'd like another pair of eyes on it. Maybe it's related to the fact that there are multiple <code>NoneType</code> in typeshed? (The one in <code>_typeshed</code> and the one in <code>types</code> for more recent Python versions.)</p>
<p>Also, I think this branch should go into <code>is_equivalent_to</code> instead of <code>is_subtype_of</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> approved on 2024-10-31 21:10</div>
            <div class="timeline-body"><p>Looks great!</p>
<p>I wonder how much of the perf regression is due to the fact that currently I think every <code>None</code> ends up being a union of the <code>None</code> defined in <code>_typeshed</code> and the one defined in<code>types</code>? This could mean we spend a lot more time in recursive union handling for things like <code>is_subtype_of</code>? If so, this should be largely mitigated by <code>sys.version_info</code> checking.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-11-01 07:35</div>
            <div class="timeline-body"><p>I took a look at the perf regression</p>
<p>What I spotted is  that this branch now spends 5.6% of total time inside <code>infer_function_definition_statement</code> where we only spent 1.6% before.</p>
<p>Expanding the tree shows that the difference comes from <code>infer_decorators</code> that isn't present in the profile for main. I suspect that it comes from</p>
<pre><code class="language-py">@lru_cache(maxsize=None)
def cached_tz(hour_str: str, minute_str: str, sign_str: str) -&gt; timezone:
    sign = 1 if sign_str == &quot;+&quot; else -1
    return timezone(
        timedelta(
            hours=sign * int(hour_str),
            minutes=sign * int(minute_str),
        )
    )
</code></pre>
<p>Inside <code>infer_decorators</code> there's now a call to <code>Type::none</code> which starts semantic indexing and what not of `lru_cache.</p>
<p>I tried to debug if we now infer a more accurate type for <code>lru_cache</code> but both main and this PR infer <code>Todo</code> for</p>
<pre><code class="language-py">from functools import lru_cache
from typing import reveal_type

reveal_type(lru_cache(maxsize=None))
</code></pre>
<p>The main thing that's puzzling me.... Why is the <code>lru_cache</code> type not cached? Shouldn't this bail out early instead of calling into <code>semantic_index</code>?</p>
<p><img src="https://github.com/user-attachments/assets/8e2c5e46-10b2-4aa9-a37c-662dd9388727" alt="image" /></p>
<p>Ohh... never mind. I looked at the warmup phase instead of the incremental path.</p>
<p>This is for the incremental part</p>
<p><img src="https://github.com/user-attachments/assets/821f92ee-d633-4984-9ce6-f8ed64e4c2cf" alt="image" /></p>
<p>The finding is the same... and, for some reason, <code>KnownClass::none</code> is re-executing semantic indexing of the <code>functools</code> module which it should not... Not sure why. We should look into this</p>
<p><a href="https://share.firefox.dev/4f5MNQp">incremental check_types this PR</a></p>
<p><a href="https://share.firefox.dev/4hpRRkh">incremental check_types main</a></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-11-01 07:44</div>
            <div class="timeline-body"><p>Looking at the salsa code. What this suggests is that we don't reuse the same salsa ids and, because of that have cache misses...</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-11-01 08:07</div>
            <div class="timeline-body"><p>I'm not sure what's happening and/or if this is a bug in the benchmark. I copied the tomllib and manually ran the red knot CLI in watch mode and the salsa events indicate that it uses the memoized values except for <code>_re.py</code> that changed.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-11-01 08:50</div>
            <div class="timeline-body"><p>Okay, I might still have looked at the wrong profiles. I now created a PR to use a named closure for the incremental and warmup vs to avoid this in the future.</p>
<ul>
<li><a href="https://share.firefox.dev/48y8LsQ">incremental none</a></li>
<li><a href="https://share.firefox.dev/3YMAAum">incremental main</a></li>
</ul>
<p>I haven't looked at it too closely because salsa's maybe changed after profiles are a bit of a pain but I strongly suspect that the difference mainly comes from that salsa now has to validate the ingredients for the module defining <code>None</code>?  I suspect that addressing https://github.com/astral-sh/ty/issues/242 could help here as well.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2024-11-01 20:55</div>
            <div class="timeline-body"><blockquote>
<p>the difference mainly comes from that salsa now has to validate the ingredients for the module defining <code>None</code></p>
</blockquote>
<p>Is this a speculation or is there evidence pointing to it? I couldn't really follow which comments here are based on looking at the wrong part of the profile :)</p>
<p>This could be, though. I was thinking we would already have a dependence on <code>types</code> module (because <code>builtins</code> imports it), but it's possible tomllib didn't actually resolve the type of any builtin depending on <code>types</code> module, so our lazy per-definition inference might have meant we previously didn't have to semantic-index <code>types</code> module.</p>
<p>If this is the cause of the regression, it's mostly just a weakness in our benchmark. Real-world codebases are likely to already rely on the <code>types</code> module in some way; adding a core typechecking dependency on it should not really be considered a real-world regression, if the regression just comes from &quot;now we have to index that module.&quot;</p>
<p>I still think it's worth seeing whether Salsa-caching the resolution of the type of <code>None</code> makes a difference here. If the regression is entirely due to having all the new ingredients from the <code>types</code> module, then it won't.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sharkdp">@sharkdp</a> on 2024-11-04 11:38</div>
            <div class="timeline-body"><h2>Performance investigation</h2>
<ul>
<li>The original version of this PR had a -4% performance regression on the &quot;incremental&quot; <em>as well as the &quot;cold&quot; benchmark</em> (<a href="https://codspeed.io/astral-sh/ruff/runs/6723f0d664ef40e4a982d256">results</a>). The &quot;cold&quot; benchmark was probably just slightly below the warning/error threshold.</li>
<li>Consequently, a rebase to <code>main</code> (after the merge of https://github.com/astral-sh/ruff/pull/14034 by @MichaReiser) did not help with improving performance. Both versions are still at -4% (<a href="https://codspeed.io/astral-sh/ruff/runs/6728abafa3e6c10bfecc5442">results</a>)</li>
<li>I then tried the suggestion by @carljm and added explicit salsa caching for the lookup of <code>NoneType</code> in 503aa4644d303ee8c5f411af6a07bd44b3108549. The CI run now passes, but the performance regression is still there with -3% for both versions (<a href="https://codspeed.io/astral-sh/ruff/runs/6728b047a3e6c10bfecc544d">results</a>). Not sure if the resolution of these benchmarks is really sub-1%? If so, this is a small improvement.</li>
<li>I checked which modules were resolved when running red-knot on tomllib; On <code>main</code>, we do not load <code>_typeshed</code>; on this branch, we do (due to the explicit lookup of <code>NoneType</code> in typeshed). This alone could probably explain the increase in runtime.</li>
</ul>
<p>This also explains why I <em>didn't</em> see a performance regression when comparing this branch with main on a larger codebase (<code>black</code>). Because we <em>do</em> load <code>_typeshed</code> even on <code>main</code> (for some reason) when running on <code>black</code>. Results:</p>
<p>| Command | Mean [ms] | Min [ms] | Max [ms] | Relative |
|:---|---:|---:|---:|---:|
| <code>./red_knot_main --current-directory /home/shark/black</code> | 113.7 ¬± 3.4 | 105.5 | 120.0 | 1.00 ¬± 0.05 |
| <code>./red_knot_remove_none --current-directory /home/shark/black</code> | 113.2 ¬± 4.3 | 107.3 | 121.1 | 1.00 |</p>
<p>After talking to @MichaReiser, I removed the explicit caching of the <code>NoneType</code> lookup again.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2024-11-04 12:03</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> approved on 2024-11-04 12:07</div>
            <div class="timeline-body"><p>I've only skimmed, but this all LGTM, and I agree that a small perf &quot;regression&quot; here is fine given your analysis (and given the significant improvements to maintainability this gives us)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @sharkdp on 2024-11-04 13:00</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @sharkdp on 2024-11-04 13:00</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-11-04 13:00</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:07:21 UTC
    </footer>
</body>
</html>
