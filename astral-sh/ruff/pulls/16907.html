<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[red-knot] Fix disambiguate display for union types - astral-sh/ruff #16907</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[red-knot] Fix disambiguate display for union types</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/16907">#16907</a>
        opened by <a href="https://github.com/MatthewMckee4">@MatthewMckee4</a>
        on 2025-03-22 00:34
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/MatthewMckee4">@MatthewMckee4</a> on 2025-03-22 00:34</div>
            <div class="timeline-body"><!--
Thank you for contributing to Ruff! To help us out with reviewing, please consider the following:

- Does this pull request include a summary of the change? (See below.)
- Does this pull request include a descriptive title?
- Does this pull request include references to any relevant issues?
-->

<h2>Summary</h2>
<p>When callables are displayed in unions, like:</p>
<pre><code class="language-py">from typing import Callable


def foo(x: Callable[[], int] | None):
    # red-knot: Revealed type is `() -&gt; int | None` [revealed-type]
    reveal_type(x)
</code></pre>
<p>This leaves the type rather ambiguous, to fix this we can add parenthesis to callable type in union</p>
<p>Fixes #16893</p>
<h2>Test Plan</h2>
<p>Update callable annotations tests</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @MatthewMckee4 on 2025-03-22 00:34</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @AlexWaygood by @MatthewMckee4 on 2025-03-22 00:34</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @sharkdp by @MatthewMckee4 on 2025-03-22 00:34</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @dcreager by @MatthewMckee4 on 2025-03-22 00:34</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-03-22 00:40</div>
            <div class="timeline-body"><!-- generated-comment mypy_primer -->

<h2><code>mypy_primer</code> results</h2>
<details>
<summary>Changes were detected when running on open source projects</summary>

<pre><code class="language-diff">isort (https://github.com/pycqa/isort)
- error[lint:call-non-callable] /tmp/mypy_primer/projects/isort/isort/sorting.py:120:34: Object of type `(str, /) -&gt; Any | None` is not callable
+ error[lint:call-non-callable] /tmp/mypy_primer/projects/isort/isort/sorting.py:120:34: Object of type `((str, /) -&gt; Any) | None` is not callable
+ error[lint:invalid-assignment] /tmp/mypy_primer/projects/isort/isort/settings.py:749:9: Object of type `Literal[from_string]` is not assignable to `((str, /) -&gt; Any) | type[Any]`
- error[lint:invalid-assignment] /tmp/mypy_primer/projects/isort/isort/settings.py:749:9: Object of type `Literal[from_string]` is not assignable to `(str, /) -&gt; Any | type[Any]`
- error[lint:invalid-argument-type] /tmp/mypy_primer/projects/isort/isort/output.py:55:17: Object of type `(key) -&gt; Unknown` cannot be assigned to parameter `key` of function `sort`; expected type `(str, /) -&gt; Any | None`
+ error[lint:invalid-argument-type] /tmp/mypy_primer/projects/isort/isort/output.py:55:17: Object of type `(key) -&gt; Unknown` cannot be assigned to parameter `key` of function `sort`; expected type `((str, /) -&gt; Any) | None`
- error[lint:invalid-argument-type] /tmp/mypy_primer/projects/isort/isort/output.py:66:17: Object of type `(key) -&gt; Unknown` cannot be assigned to parameter `key` of function `sort`; expected type `(str, /) -&gt; Any | None`
+ error[lint:invalid-argument-type] /tmp/mypy_primer/projects/isort/isort/output.py:66:17: Object of type `(key) -&gt; Unknown` cannot be assigned to parameter `key` of function `sort`; expected type `((str, /) -&gt; Any) | None`
- error[lint:invalid-argument-type] /tmp/mypy_primer/projects/isort/isort/output.py:113:17: Object of type `partial` cannot be assigned to parameter `key` of function `sort`; expected type `(str, /) -&gt; Any | None`
+ error[lint:invalid-argument-type] /tmp/mypy_primer/projects/isort/isort/output.py:113:17: Object of type `partial` cannot be assigned to parameter `key` of function `sort`; expected type `((str, /) -&gt; Any) | None`
- error[lint:invalid-argument-type] /tmp/mypy_primer/projects/isort/isort/output.py:268:17: Object of type `(key) -&gt; Unknown` cannot be assigned to parameter `key` of function `sort`; expected type `(str, /) -&gt; Any | None`
+ error[lint:invalid-argument-type] /tmp/mypy_primer/projects/isort/isort/output.py:268:17: Object of type `(key) -&gt; Unknown` cannot be assigned to parameter `key` of function `sort`; expected type `((str, /) -&gt; Any) | None`

rich (https://github.com/Textualize/rich)
- error[lint:invalid-argument-type] /tmp/mypy_primer/projects/rich/tests/test_progress.py:292:60: Object of type `MockClock` cannot be assigned to parameter `get_time` of function `track`; expected type `() -&gt; int | float | None`
+ error[lint:invalid-argument-type] /tmp/mypy_primer/projects/rich/tests/test_progress.py:292:60: Object of type `MockClock` cannot be assigned to parameter `get_time` of function `track`; expected type `(() -&gt; int | float) | None`

pyinstrument (https://github.com/joerick/pyinstrument)
+ error[lint:invalid-argument-type] /tmp/mypy_primer/projects/pyinstrument/test/low_level/test_threaded.py:37:24: Object of type `CallCounter` cannot be assigned to parameter 1 (`target`) of function `setstatprofile`; expected type `((FrameType, str, Any, /) -&gt; Any) | None`
- error[lint:invalid-assignment] /tmp/mypy_primer/projects/pyinstrument/test/fake_time_util.py:28:5: Object of type `@Todo | &lt;bound method `get_time` of `FakeClock`&gt;` is not assignable to attribute `timer_func` of type `() -&gt; int | float | None`
+ error[lint:invalid-assignment] /tmp/mypy_primer/projects/pyinstrument/test/fake_time_util.py:28:5: Object of type `@Todo | &lt;bound method `get_time` of `FakeClock`&gt;` is not assignable to attribute `timer_func` of type `(() -&gt; int | float) | None`
- error[lint:invalid-argument-type] /tmp/mypy_primer/projects/pyinstrument/test/low_level/test_threaded.py:37:24: Object of type `CallCounter` cannot be assigned to parameter 1 (`target`) of function `setstatprofile`; expected type `(FrameType, str, Any, /) -&gt; Any | None`

</code></pre>
</details>

</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by @AlexWaygood on 2025-03-22 01:01</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a> reviewed on 2025-03-22 02:49</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a> on <code>crates/red_knot_python_semantic/resources/mdtest/annotations/callable.md</code>:169 on 2025-03-22 02:49</div>
            <div class="timeline-body"><p>What about intersection types?</p>
<pre><code class="language-python">def _(
    c: Intersection[Callable[[Union[int, str]], int], A],
    d: Intersection[A, Callable[[Union[int, str]], int]],
    e: Intersection[A, Callable[[Union[int, str]], int], B],
    f: Intersection[Not[Callable[[int, str], Intersection[int, str]]]]
):
    reveal_type(c)  # revealed: ((int | str, /) -&gt; int) &amp; A
    reveal_type(d)  # revealed: A &amp; ((int | str, /) -&gt; int)
    reveal_type(e)  # revealed: A &amp; ((int | str, /) -&gt; int) &amp; B
    reveal_type(f)  # revealed: ~((int, str, /) -&gt; int &amp; str)
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-03-22 09:55</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_python_semantic/src/types/display.rs</code>:299 on 2025-03-22 09:55</div>
            <div class="timeline-body"><p>Ah, I wish <a href="https://doc.rust-lang.org/std/fmt/fn.from_fn.html"><code>from_fn</code></a> gets stabilizied. It would allow to remove the <code>format!</code> without much ceremony....</p>
<p>Although, I think you can avoid the <code>format</code> call here by using <code>format_args</code> (but not a 100% sure)</p>
<pre><code class="language-suggestion">                    join.entry(&amp;format_args!(&quot;({})&quot;, element.display(self.db)));
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2025-03-22 09:55</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MatthewMckee4">@MatthewMckee4</a> on <code>crates/red_knot_python_semantic/resources/mdtest/annotations/callable.md</code>:169 on 2025-03-22 11:24</div>
            <div class="timeline-body"><p>Good point, right now revealed type of f is <code>~(int, str, /) -&gt; int &amp; str</code>&quot;. We can probably do this in another PR?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MatthewMckee4">@MatthewMckee4</a> reviewed on 2025-03-22 11:24</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-03-22 12:07</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_python_semantic/resources/mdtest/annotations/callable.md</code>:169 on 2025-03-22 12:07</div>
            <div class="timeline-body"><p>Yeah, I think it's fine to do this in another PR.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @MichaReiser on 2025-03-22 12:08</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @MichaReiser on 2025-03-22 12:08</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-03-22 12:21</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 19:41:05 UTC
    </footer>
</body>
</html>
