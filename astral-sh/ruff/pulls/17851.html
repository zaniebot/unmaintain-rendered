<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Implement template strings - astral-sh/ruff #17851</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Implement template strings</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/17851">#17851</a>
        opened by <a href="https://github.com/dylwil3">@dylwil3</a>
        on 2025-05-05 11:04
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/dylwil3">@dylwil3</a> on 2025-05-05 11:04</div>
            <div class="timeline-body"><p>This PR implements template strings (t-strings) in the parser and formatter for Ruff.</p>
<p>I have attempted to arrange the commits for easy review commit-by-commit. They are labeled by what piece of the code they touch, and I have written extended commit messages for some of them to indicate the important bits.</p>
<p>Please let me know if there's anything that can be made clearer or if I can help make the review process smoother!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">python314</span> added by @dylwil3 on 2025-05-05 11:04</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-05-05 11:07</div>
            <div class="timeline-body"><!-- generated-comment mypy_primer -->

<h2><code>mypy_primer</code> results</h2>
<p>No ecosystem changes detected ‚úÖ</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-05-06 17:50</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_python_semantic/src/types/infer.rs</code>:4492 on 2025-05-06 17:50</div>
            <div class="timeline-body"><p>To make the corpus test happy, you need to recurse inside all subnodes of the t-string and store a <code>todo_type!(&quot;Template&quot;)</code> for each sub-node. This is to support a future type-aware linter integration where the linter can query the type of any arbitrary node in the AST and ty will have an answer for it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-05-08 19:36</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_python_semantic/src/types/infer.rs</code>:7886 on 2025-05-08 19:36</div>
            <div class="timeline-body"><pre><code class="language-suggestion">                    format_args!(&quot;T-strings are not allowed in type expressions&quot;),
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-05-08 20:54</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>‚úÖ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>‚úÖ ecosystem check detected no linter changes.</p>
<h3>Formatter (stable)</h3>
<p>‚úÖ ecosystem check detected no format changes.</p>
<h3>Formatter (preview)</h3>
<p>‚úÖ ecosystem check detected no format changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @dylwil3 on 2025-05-14 22:45</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @dylwil3 on 2025-05-14 22:45</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @sharkdp by @dylwil3 on 2025-05-14 22:45</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @dcreager by @dylwil3 on 2025-05-14 22:45</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @dylwil3 on 2025-05-14 22:45</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @dhruvmanila by @dylwil3 on 2025-05-14 22:45</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-05-15 01:34</div>
            <div class="timeline-body"><p>So cool!</p>
<p>I'm assuming the ty bits here are just the minimum to not panic, and we can handle the ty comments I'd have (e.g. some tests, maybe some code sharing between <code>infer_fstring_expression</code> and the f-string portion of <code>infer_tstring_expression</code>) in a separate ty-focused PR later on. Going to leave review on this one to people who know Ruff.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for @carljm removed by @carljm on 2025-05-15 01:34</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_parser/src/lexer/ftstring.rs</code>:9 on 2025-05-15 07:04</div>
            <div class="timeline-body"><p>I find this name a bit awkward. Maybe <code>InterpolatedStringContext</code>. We should also update the file name and the documentation of this struct</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_parser/src/lexer/ftstring.rs</code>:27 on 2025-05-15 07:06</div>
            <div class="timeline-body"><p>Unrelated to your changes but I think I'd prefer to change the constructor to</p>
<pre><code class="language-rust">new(flags: TokenFlags, nesting: u32) -&gt; Option&lt;Self&gt;
</code></pre>
<p>https://github.com/astral-sh/ruff/blob/fa628018b28fa018d7a0e109223186172ef91275/crates/ruff_python_parser/src/lexer.rs#L634-L636</p>
<p>can then call <code>new</code> and only call into <code>lex_fstring</code> if the return value is <code>Some</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_parser/src/lexer/ftstring.rs</code>:44 on 2025-05-15 07:07</div>
            <div class="timeline-body"><p>This seems redundant given that we also have <code>TokenFlags</code>. I haven't seen the usage bits yet but I'd suggest to:</p>
<ul>
<li>Remove <code>FTStringKind</code> entirely</li>
<li>Keep the method but remove the field. The method returns <code>Kind::FString</code> if <code>flags.is_f_string</code> is true and t-string otherwise</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_parser/src/lexer.rs</code>:515 on 2025-05-15 07:10</div>
            <div class="timeline-body"><p>Does CPython distinguish between f-strings and t-strings here. Could we use a single error instead?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_parser/src/lexer.rs</code>:933 on 2025-05-15 07:12</div>
            <div class="timeline-body"><p>What's the reason for duplicating all this logic? I understand that there's no real difference between how f-strings and t-strings are lexed. Could we just pass a <code>InterpolatedStringKind</code> value instead to parametrize the few places where they need to differ?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_parser/src/token.rs</code>:93 on 2025-05-15 07:15</div>
            <div class="timeline-body"><p>We should update the documentation here to clarify that this includes t-strings and review all usages because t-string tokens feel like a string, they're not at runtime.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_ast/src/nodes.rs</code>:563 on 2025-05-15 07:20</div>
            <div class="timeline-body"><p>Could we reuse the format spec between t and f-strings or what's the motivation for having different nodes. What does Python do? The same question applies to other nodes like <code>TStringLiteralElement</code>, <code>TStringInterpolationElement</code> etc.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_ast/src/nodes.rs</code>:1063 on 2025-05-15 07:20</div>
            <div class="timeline-body"><p>Same here. Could we use a single <code>InterpolatedStringFlagsInner</code> instead of duplicating all this code</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_ast/src/expression.rs</code>:89 on 2025-05-15 07:21</div>
            <div class="timeline-body"><p>Update documentation</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_ast/src/expression.rs</code>:93 on 2025-05-15 07:22</div>
            <div class="timeline-body"><p>I've a strong preference towards <code>interpolated_string</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_ast/src/comparable.rs</code>:732 on 2025-05-15 07:25</div>
            <div class="timeline-body"><p>I think it could be desired to have an <code>InterpolatedString</code> enum that abstracts over t and f-strings so that code like this could be reused between. This goes back to my question in the AST crate: What's the motivation for having different nodes (not questioning whether we should have different <code>FString</code> and <code>TString</code> root nodes but do all nodes have to be different?)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_parser/src/parser/expression.rs</code>:1736 on 2025-05-15 07:28</div>
            <div class="timeline-body"><p>What's the reason that we need to buplicate the entire logic here? Can't we share some logic with parsing f-strings, given that they're, as far as I understand, identical?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_parser/src/parser/mod.rs</code>:832 on 2025-05-15 07:28</div>
            <div class="timeline-body"><p>Can we unify the <code>ElementsKind</code> instead of duplicating all the code?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_parser/src/parser/statement.rs</code>:3015 on 2025-05-15 07:29</div>
            <div class="timeline-body"><p>Why this change?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_parser/src/error.rs</code>:89 on 2025-05-15 07:30</div>
            <div class="timeline-body"><p>Same as elsewhere. I don't think we have to duplicate the enum here and instead can use it for both f and t-string (the outer variant is enough to distinguish the two cases and even then, it's not clear to me if that's even required)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_parser/src/string.rs</code>:323 on 2025-05-15 07:32</div>
            <div class="timeline-body"><p>Same here, What's the need for duplicating the entire parse logic? Can't we share most logic with the f-string handling?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_codegen/src/generator.rs</code>:1447 on 2025-05-15 07:33</div>
            <div class="timeline-body"><p>Can't we share some logic with f-string interpolation elemetns?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_codegen/src/generator.rs</code>:1508 on 2025-05-15 07:33</div>
            <div class="timeline-body"><p>Also here and probably other methods</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/flake8_bandit/rules/hardcoded_sql_expression.rs</code>:180 on 2025-05-15 07:35</div>
            <div class="timeline-body"><p>What about f-strings inside t-strings?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/flake8_bandit/rules/hardcoded_tmp_directory.rs</code>:78 on 2025-05-15 07:36</div>
            <div class="timeline-body"><p>We should add a test for all the lint rules that you changed in this PR</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/flake8_pyi/rules/string_or_bytes_too_long.rs</code>:119 on 2025-05-15 07:37</div>
            <div class="timeline-body"><p>Consider adding a <code>count_fstring_chars</code> (and rename the existing one to <code>_expr</code>) to share the f-string logic instead of repeating it here</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/flake8_quotes/rules/avoidable_escaped_quote.rs</code>:232 on 2025-05-15 07:38</div>
            <div class="timeline-body"><p>I don't think this is necessary for t-strings</p>
<p>The examples also need updating and it would be nice if we could share some of the logic with f-strings</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/flake8_quotes/rules/avoidable_escaped_quote.rs</code>:300 on 2025-05-15 07:38</div>
            <div class="timeline-body"><pre><code class="language-suggestion">/// Checks for unnecessary escaped quotes in an t-string.
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/flake8_quotes/rules/avoidable_escaped_quote.rs</code>:442 on 2025-05-15 07:39</div>
            <div class="timeline-body"><p>more f-string references</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/flake8_quotes/rules/avoidable_escaped_quote.rs</code>:305 on 2025-05-15 07:39</div>
            <div class="timeline-body"><p>Same as in other places. Do we need to copy all the code?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> requested changes on 2025-05-15 07:40</div>
            <div class="timeline-body"><p>Thanks for working on this. Exciting to seeing this come together.</p>
<p>I've only reviewed the parser, ast and parts of the linter at this point. Overall, my impression is that we went too far with copy pasting. We should consider more carefully where it is important to have different representations for t- and f-strings and where it is fine to share the same structs or parametrizing functions if they're identical except for e.g. some token kinds. Sharing the same structures should help with reusing more code as well.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dylwil3">@dylwil3</a> on 2025-05-15 11:07</div>
            <div class="timeline-body"><blockquote>
<p>Overall, my impression is that we went too far with copy pasting</p>
</blockquote>
<p>That's fair - I will see what can be done about merging more logic! Thank you!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-05-15 12:38</div>
            <div class="timeline-body"><p>(I'll also leave this mostly to Micha/Dhruv, but please feel free to ping me if there's something specific you want my opinion on!)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2025-05-15 15:47</div>
            <div class="timeline-body"><p>Looking at Micha's review, I'll wait for the follow-up changes to de-duplicate and then review but I agree that we should parameterize the methods and do minimal changes where f-strings and t-strings are different.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dylwil3">@dylwil3</a> reviewed on 2025-05-16 19:15</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dylwil3">@dylwil3</a> on <code>crates/ruff_python_parser/src/lexer/ftstring.rs</code>:9 on 2025-05-16 19:15</div>
            <div class="timeline-body"><p>I don't wanna bikeshed too much on this, so I will likely just apply your suggestion, but two points in favor of the current name:</p>
<ol>
<li>It is pretty unambiguous, even if it's awkward - I don't think I could misinterpret it. On the other hand <code>InterpolatedString</code> is not related to any standard Python terminology, except maybe to <code>Interpolation</code> which is specific to t-strings and <em>not</em> f-strings</li>
<li>It agrees with the terminology used in various places in the CPython parser/lexer (e.g. https://github.com/python/cpython/blob/ac8df4b5892d2e4bd99731e7d87223a35c238f81/Parser/lexer/lexer.c#L41) - but this is not a strong argument since it doesn't appear in, say, the actual grammar reference</li>
</ol>
<p>anyway - if you still want the name to change I'll do it!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dylwil3">@dylwil3</a> reviewed on 2025-05-16 19:18</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dylwil3">@dylwil3</a> on <code>crates/ruff_python_parser/src/lexer.rs</code>:515 on 2025-05-16 19:18</div>
            <div class="timeline-body"><p>We can probably merge these, but the user-facing message in CPython does distinguish between f-strings and t-strings, e.g.:</p>
<pre><code class="language-pycon">&gt;&gt;&gt; t&quot;{name&quot;
  File &quot;&lt;python-input-0&gt;&quot;, line 1
    t&quot;{name&quot;
           ^
SyntaxError: t-string: expecting '}'
&gt;&gt;&gt; f&quot;{name&quot;
  File &quot;&lt;python-input-1&gt;&quot;, line 1
    f&quot;{name&quot;
           ^
SyntaxError: f-string: expecting '}'
</code></pre>
<p>so I'll just have to add a bit of logic to recover the context.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dylwil3">@dylwil3</a> reviewed on 2025-05-16 19:25</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dylwil3">@dylwil3</a> on <code>crates/ruff_python_ast/src/nodes.rs</code>:563 on 2025-05-16 19:25</div>
            <div class="timeline-body"><p>CPython has separate nodes for the format specs and only shares the conversion fields between them (see below). It's possible we could share the <code>?StringLiteralElement</code> pieces, but I would hesitate to merge interpolation elements with expression elements.</p>
<pre><code>fstring_middle:
    | fstring_replacement_field
    | FSTRING_MIDDLE 
fstring_replacement_field:
    | '{' annotated_rhs '='? [fstring_conversion] [fstring_full_format_spec] '}' 
fstring_conversion:
    | &quot;!&quot; NAME 
fstring_full_format_spec:
    | ':' fstring_format_spec* 
fstring_format_spec:
    | FSTRING_MIDDLE 
    | fstring_replacement_field
fstring:
    | FSTRING_START fstring_middle* FSTRING_END 

tstring_format_spec_replacement_field:
    | '{' annotated_rhs '='? [fstring_conversion] [tstring_full_format_spec] '}' 
tstring_format_spec:
    | TSTRING_MIDDLE 
    | tstring_format_spec_replacement_field
tstring_full_format_spec:
    | ':' tstring_format_spec* 
tstring_replacement_field:
    | '{' annotated_rhs '='? [fstring_conversion] [tstring_full_format_spec] '}' 
tstring_middle:
    | tstring_replacement_field
    | TSTRING_MIDDLE 
tstring:
    | TSTRING_START tstring_middle* TSTRING_END 
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dylwil3">@dylwil3</a> on 2025-05-16 19:30</div>
            <div class="timeline-body"><blockquote>
<p>What's the motivation for having different nodes (not questioning whether we should have different FString and TString root nodes but do all nodes have to be different?)</p>
</blockquote>
<p>Just to respond in general to the code duplication (I will still work on merging logic):</p>
<p>My main motivation for keeping so many things separate (e.g. the AST nodes) was to mimic to some extent what is being done in the CPython implementation. Granted, much of their parser is generated, so it's possible they are more comfortable with repetition than we ought to be, but it seemed like, down the line, if changes are introduced such that the behavior of t-strings and f-strings diverges further, this would be easier to maintain. However, I understand if this is too cautious/&quot;YAGNI&quot;-thinking. Anyway, just wanted to put on the record that I wasn't <em>just</em> being lazy for laziness sake üòÑ</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dylwil3">@dylwil3</a> on 2025-05-16 21:35</div>
            <div class="timeline-body"><p>Two quick questions as I continue to merge various things:</p>
<ol>
<li>Is there a standard pattern in Rust to get around the fact that we don't have dependent types? There are several places where merging functions would be possible except that the return types are different. So like, we have a function of signature <code>(data) -&gt; TStringThing</code> and a function of signature <code>(data) -&gt; FStringThing</code>. I want instead to do <code>(data, enum variant?) -&gt; ?? // FStringThing/TStringThing depending on enum variant</code>? I guess am I supposed to do <code>(data) -&gt; T</code> and parameterize by <code>T</code> instead where <code>T</code> is allowed to either be <code>FStringThing</code> or <code>TStringThing</code>? Hopefully this question makes sense...</li>
<li>When I made both <code>FStringElement</code> and <code>TStringElement</code> share a node type (<code>FTStringLiteralElement</code>) (I know you hate the name!), this broke the code generation. Is there some other way I'm supposed to do this in <code>ast.toml</code> or should I modify the script? (Maybe a question for @dcreager ?)</li>
</ol>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-05-17 14:29</div>
            <div class="timeline-body"><p>For 1. Hard to say without seeing a concrete example. The alternative is to use a trait with an associated type:</p>
<pre><code>trait InterpolatedString {
	type Element;
}

fn with_string&lt;S&gt;(string: S) -&gt; S::Element where S: InterpolatedString {}
</code></pre>
<blockquote>
<p>My main motivation for keeping so many things separate (e.g. the AST nodes) was to mimic to some extent what is being done in the CPython implementation.</p>
</blockquote>
<p>I'm fine not sharing some AST nodes, e.g., if they're handled differently by most visitors anyway. I mainly wanted to make sure it was an intentional decision (maybe it was?).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_python_parser/src/lexer.rs</code>:170 on 2025-05-20 17:45</div>
            <div class="timeline-body"><p>I think we can avoid the match expression by either adding a <code>TokenKind::is_ft_string_end</code> or implementing <code>.as_token</code> method on <code>FTStringKind</code>. I'd probably just do the former.</p>
<pre><code class="language-rs">        if let Some(ftstring) = self.ftstrings.current() {
            if !ftstring.is_in_expression(self.nesting) {
                if let Some(token) = self.lex_ftstring_middle_or_end() {
                    if token.is_ft_string_end() {
                        self.ftstrings.pop();
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_python_parser/src/lexer.rs</code>:515 on 2025-05-20 17:48</div>
            <div class="timeline-body"><p>I think we could add a <code>LexicalErrorType::from_ft_string_error</code> similar to <code>ParseErrorType::from_ft_string_error</code> for this</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_python_parser/src/lexer.rs</code>:647 on 2025-05-20 17:49</div>
            <div class="timeline-body"><p>nit: should we have a <code>is_ft_string</code> method instead? Or, is it that the separation is required somewhere else?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_python_parser/src/lexer.rs</code>:807 on 2025-05-20 17:52</div>
            <div class="timeline-body"><p>We could add methods like <code>.end_token</code>, <code>.start_token</code>, etc. to convert <code>FTStringKind</code> to <code>TokenKind</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_python_parser/src/lexer.rs</code>:846 on 2025-05-20 17:53</div>
            <div class="timeline-body"><p><code>LexicalErrorType::from_ft_string_error</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_python_parser/src/lexer.rs</code>:868 on 2025-05-20 17:53</div>
            <div class="timeline-body"><p><code>LexicalErrorType::from_ft_string_error</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_python_parser/src/lexer.rs</code>:947 on 2025-05-20 17:54</div>
            <div class="timeline-body"><p><code>FTStringKind::as_middle_token</code> ?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_python_parser/src/lexer.rs</code>:1458 on 2025-05-20 17:54</div>
            <div class="timeline-body"><p>nit: can we combine these two methods?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_python_parser/src/lexer.rs</code>:2475 on 2025-05-20 17:56</div>
            <div class="timeline-body"><p>Do t-strings have any behavior that's distinct from an f-string for which we should add tests here?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_python_parser/src/lexer/ftstring.rs</code>:24 on 2025-05-20 17:58</div>
            <div class="timeline-body"><p>I think we should keep this assertion and expand the method to either be <code>is_ft_string</code> or add a new <code>is_t_string</code> method. This would mean the <code>panic</code> in <code>FTStringContext::kind</code> can be <code>unreachable</code> instead.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_python_parser/src/string.rs</code>:669 on 2025-05-20 18:10</div>
            <div class="timeline-body"><p>Same question as before regarding whether we need to add tests specific to t-string if there's any exclusive behavior that's not present for f-string.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_python_parser/src/parser/expression.rs</code>:1431 on 2025-05-20 18:11</div>
            <div class="timeline-body"><p>&quot;f/t-string&quot;</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_python_parser/src/parser/expression.rs</code>:1468 on 2025-05-20 18:12</div>
            <div class="timeline-body"><p>These aren't &quot;pep701&quot; ;)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_python_parser/src/string.rs</code>:480 on 2025-05-20 18:13</div>
            <div class="timeline-body"><p>nit: <code>start_token</code>, <code>middle_token</code>, <code>end_token</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_python_parser/src/parser/expression.rs</code>:1609 on 2025-05-20 18:13</div>
            <div class="timeline-body"><p>&quot;f/t-string&quot;</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_python_parser/src/parser/mod.rs</code>:1278 on 2025-05-20 18:17</div>
            <div class="timeline-body"><p>The standalone &quot;f&quot; looks a bit odd, maybe &quot;f/t-string&quot; or &quot;f-string or t-string&quot;?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_python_parser/src/parser/mod.rs</code>:1318 on 2025-05-20 18:18</div>
            <div class="timeline-body"><p>nit: what about &quot;FT_STRING_ELEMENTS&quot; similar to other places?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2025-05-20 18:22</div>
            <div class="timeline-body"><p>Thank you for doing this! This is very large change, taking a break from reviewing but wanted to post the comments that I had so far which are mainly around the parser. Taking a lunch break :)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dylwil3">@dylwil3</a> on <code>crates/ruff_python_ast/src/comparable.rs</code>:732 on 2025-05-20 21:36</div>
            <div class="timeline-body"><p>Turns out that, in this case, I had to do something pretty different than in the f-string case.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dylwil3">@dylwil3</a> reviewed on 2025-05-20 21:36</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dylwil3">@dylwil3</a> on <code>crates/ruff_python_parser/src/lexer.rs</code>:647 on 2025-05-20 21:47</div>
            <div class="timeline-body"><p>Yes I think we need these two flags to be separate once we get to the parser (but we could have a method that gives the union). That's currently the only way we have of telling we're in an f-string vs a t-string when we descend into the node.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dylwil3">@dylwil3</a> reviewed on 2025-05-20 21:47</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dylwil3">@dylwil3</a> on <code>crates/ruff_python_parser/src/lexer.rs</code>:2475 on 2025-05-20 21:52</div>
            <div class="timeline-body"><p>Not during lexing, I don't think!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dylwil3">@dylwil3</a> reviewed on 2025-05-20 21:52</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dylwil3">@dylwil3</a> reviewed on 2025-05-20 22:01</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dylwil3">@dylwil3</a> on <code>crates/ruff_python_parser/src/string.rs</code>:669 on 2025-05-20 22:01</div>
            <div class="timeline-body"><p>Yep! These are the innocuous looking new tests <code>test_parse_f_t_string_concat_{i}</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dylwil3">@dylwil3</a> reviewed on 2025-05-20 22:42</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dylwil3">@dylwil3</a> on <code>crates/ruff_python_parser/src/parser/expression.rs</code>:1468 on 2025-05-20 22:42</div>
            <div class="timeline-body"><p>It's sort of &quot;retroactively&quot; pep701 in the sense that t-strings are meant to have the same flexibility as f-strings post-pep701. not sure what else to call it!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dylwil3">@dylwil3</a> reviewed on 2025-05-20 22:45</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dylwil3">@dylwil3</a> on <code>crates/ruff_python_parser/src/lexer/ftstring.rs</code>:24 on 2025-05-20 22:45</div>
            <div class="timeline-body"><p>I went with Micha's suggestion of having the constructor return an <code>Option</code> - but that still let me change the <code>panic</code> to an <code>unreachable</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dylwil3">@dylwil3</a> reviewed on 2025-05-20 22:50</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dylwil3">@dylwil3</a> on <code>crates/ruff_python_parser/src/lexer.rs</code>:515 on 2025-05-20 22:50</div>
            <div class="timeline-body"><p>merged these, thanks!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dylwil3">@dylwil3</a> reviewed on 2025-05-20 22:51</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dylwil3">@dylwil3</a> on <code>crates/ruff_python_parser/src/lexer.rs</code>:933 on 2025-05-20 22:51</div>
            <div class="timeline-body"><p>merged</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dylwil3">@dylwil3</a> reviewed on 2025-05-20 22:51</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dylwil3">@dylwil3</a> on <code>crates/ruff_python_ast/src/nodes.rs</code>:563 on 2025-05-20 22:51</div>
            <div class="timeline-body"><p>merged now, thank you!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dylwil3">@dylwil3</a> reviewed on 2025-05-20 22:51</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dylwil3">@dylwil3</a> on <code>crates/ruff_python_parser/src/parser/expression.rs</code>:1736 on 2025-05-20 22:51</div>
            <div class="timeline-body"><p>merged!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-05-22 06:21</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_parser/src/lexer/ftstring.rs</code>:9 on 2025-05-22 06:21</div>
            <div class="timeline-body"><p>I agree that there's not much precedence for the term interpolated string. The terms interpolated or string interpolation are used in both the f-string and t-string PEP:</p>
<blockquote>
<p>Many languages that allow similar syntactic constructs (normally called ‚Äústring interpolation‚Äù) allow quote reuse and arbitrary nesting. These languages include JavaScript, Ruby, C#, Bash, Swift and many others. The fact that many languages allow quote reuse can be a compelling argument in favour of allowing it in Python. This is because it will make the language more familiar to users coming from other languages.
https://peps.python.org/pep-0701/#considerations-regarding-quote-reuse</p>
</blockquote>
<blockquote>
<p>Python f-strings are easy to use and very popular. Over time, however, developers have encountered limitations that make them <a href="https://docs.djangoproject.com/en/5.1/ref/utils/#django.utils.html.format_html">unsuitable for certain use cases</a>. In particular, f-strings provide no way to intercept and transform interpolated values before they are combined into a final string.
https://peps.python.org/pep-0750/#motivation</p>
</blockquote>
<p>An other alternative would be <code>FormatString</code> where both <code>f</code> and <code>t</code> strings are format strings. I think it could be somewhat confusing because it is so close to template strings.</p>
<p>A third option is <code>FOrTStringContext</code>. It also looks very ugly but I find it more accurate because there's no such thing as a <code>f</code> and <code>t</code> string.</p>
<p>I think I still prefer <code>InterpolatedString</code> the most because it hast he advantage that it neither implies <code>f</code> or <code>t</code> string -- allowing us to define the term. But I'm fine with any of the other variation (I'm also okay with <code>FT</code> but it would hurt me a little ;))</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_ast/src/generated.rs</code>:2810 on 2025-05-22 06:23</div>
            <div class="timeline-body"><p>Should we rename this to <code>InterpolationElement</code> (with or without the <code>FT</code> prefix) because that's the terminology used throughout PEP750</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-05-22 06:23</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_ast/src/nodes.rs</code>:560 on 2025-05-22 06:24</div>
            <div class="timeline-body"><p>Do we still need the <code>TStringFormatSpec</code> or could we use the <code>FTStringFormatSpec</code> here?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_ast/src/nodes.rs</code>:934 on 2025-05-22 06:25</div>
            <div class="timeline-body"><p>Let's document this type. Specifically, why it is needed given that both <code>FStringFlags</code> and <code>TStringFlags</code> wrap a <code>FTStringFlagsInner</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_ast_integration_tests/tests/comparable.rs</code>:5 on 2025-05-22 06:27</div>
            <div class="timeline-body"><pre><code class="language-suggestion">#[track_caller]
fn assert_comparable(left: &amp;str, right: &amp;str) -&gt; Result&lt;(), ParseError&gt; {
</code></pre>
<p>Adding <code>track_caller</code> has the benefit that an assertion failure will show the call site in the panic message instead of the line in <code>assert_comparble</code> (which is the same for all tests)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_ast_integration_tests/tests/comparable.rs</code>:17 on 2025-05-22 06:27</div>
            <div class="timeline-body"><pre><code class="language-suggestion">#[track_caller]
fn assert_noncomparable(left: &amp;str, right: &amp;str) -&gt; Result&lt;(), ParseError&gt; {
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_parser/src/parser/expression.rs</code>:1443 on 2025-05-22 06:32</div>
            <div class="timeline-body"><p>What you have here is probably fine. An alternative would have been that <code>parse_ftstring</code> returns a struct with <code>elements</code>, <code>flags</code>, and <code>range</code> and the call site either wraps it in a <code>FString</code> or <code>TString</code>. That would allow you to pass a simple <code>enum</code> as argument that parametrizes the token kinds.</p>
<p>Looking more at the <code>InterpolatedString</code>. I think what we have here is complicating things unnecessarily. I looked at the call sites and all call-sites immediately wrap the return value in a <code>StringType::FString</code> or <code>StringType::TString</code>. So I think we can simply change the return type to <code>StringType</code> and then use an enum to parametrize whether its parsing an f or t-string.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_parser/src/parser/mod.rs</code>:823 on 2025-05-22 06:34</div>
            <div class="timeline-body"><p>Do we allow both here because we know/assume that the lexer never emits an <code>FStringEnd</code> in a <code>TString</code> or could recover on both lead to confusion in the parser?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_parser/src/lexer.rs</code>:634 on 2025-05-22 06:37</div>
            <div class="timeline-body"><p>Let's update the comment on line 614</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_parser/src/lexer.rs</code>:768 on 2025-05-22 06:42</div>
            <div class="timeline-body"><p>Maybe (to avoid the expect call)</p>
<pre><code class="language-patch">Subject: [PATCH] nit
---
Index: crates/ruff_python_parser/src/lexer.rs
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
&lt;+&gt;UTF-8
===================================================================
diff --git a/crates/ruff_python_parser/src/lexer.rs b/crates/ruff_python_parser/src/lexer.rs
--- a/crates/ruff_python_parser/src/lexer.rs	(revision 0ccfe03d9a0c0802908f31915aaa049b538f6fd3)
+++ b/crates/ruff_python_parser/src/lexer.rs	(date 1747896114842)
@@ -628,8 +628,8 @@
         };
 
         if let Some(quote) = quote {
-            if self.current_flags.is_ft_string() {
-                return self.lex_ftstring_start(quote);
+            if let Some(kind) = self.try_lex_ftstring_start(quote) {
+                return kind;
             }
 
             return self.lex_string(quote);
@@ -749,8 +749,8 @@
         true
     }
 
-    /// Lex a f-string or t-string start token.
-    fn lex_ftstring_start(&amp;mut self, quote: char) -&gt; TokenKind {
+    /// Lex a f-string or t-string start token if positioned at the start of an f or t-string.
+    fn try_lex_ftstring_start(&amp;mut self, quote: char) -&gt; Option&lt;TokenKind&gt; {
         #[cfg(debug_assertions)]
         debug_assert_eq!(self.cursor.previous(), quote);
 
@@ -762,14 +762,13 @@
             self.current_flags |= TokenFlags::TRIPLE_QUOTED_STRING;
         }
 
-        let ftcontext = FTStringContext::new(self.current_flags, self.nesting)
-            .expect(&quot;Expect to have f or t-string flag set&quot;);
+        let ftcontext = FTStringContext::new(self.current_flags, self.nesting)?;
 
         let kind = ftcontext.kind();
 
         self.ftstrings.push(ftcontext);
 
-        kind.start_token()
+        Some(kind.start_token())
     }
 
     /// Lex a f-string middle or end token.

</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_parser/src/string.rs</code>:517 on 2025-05-22 06:47</div>
            <div class="timeline-body"><p>Nit: I would move this closer to where it is used to limit its visibility further.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_parser/tests/fixtures.rs</code>:43 on 2025-05-22 06:49</div>
            <div class="timeline-body"><p>Maybe add a <code>latest_preview</code> or similar or we'll forget updating it</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/comments/placement.rs</code>:346 on 2025-05-22 06:51</div>
            <div class="timeline-body"><p>Nit: Can we move this next to the <code>AnyNodeRef::FString</code> branch above. It makes it easier to remember that we should update both if we're touching one.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/other/f_t_string.rs</code>:31 on 2025-05-22 06:53</div>
            <div class="timeline-body"><p>TODO: Update comments</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/other/f_t_string.rs</code>:60 on 2025-05-22 06:53</div>
            <div class="timeline-body"><p>Can we reuse this logic between f- and t-strings by having a method that takes <code>t_string.elements.expressions</code> as argument?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/other/f_t_string_format_spec.rs</code>:9 on 2025-05-22 06:56</div>
            <div class="timeline-body"><p>Is this used anywhere? The <code>verbatim_text</code> looks like something's missing here</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/other/f_t_string_interpolated_element.rs</code>:9 on 2025-05-22 06:57</div>
            <div class="timeline-body"><p>Same here. Is this used anywhere? I think this file (along with the other new <code>FTString</code> formating files shouldn't exist because they're listed here https://github.com/astral-sh/ruff/blob/27560b116ac11cdd52f3820b26f73a50f83b3399/crates/ruff_python_formatter/generate.py#L41-L43)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/other/f_t_string_literal_element.rs</code>:9 on 2025-05-22 06:57</div>
            <div class="timeline-body"><p>Delete</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/other/t_string.rs</code>:8 on 2025-05-22 06:57</div>
            <div class="timeline-body"><pre><code class="language-suggestion">/// Formats a t-string which is part of a larger t-string expression.
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/statement/stmt_assign.rs</code>:868 on 2025-05-22 07:01</div>
            <div class="timeline-body"><p>This is one of the most complicated formatting code. We shoudl avoid introducing unnecessary complexity by duplicating code at all cost.</p>
<p>I think a very easy solution here is to introduce an <code>FTString</code> enum that has a <code>FString</code> and <code> TString</code> variant. Then use that in all places where we used <code>FString</code> before.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/string/implicit.rs</code>:176 on 2025-05-22 07:03</div>
            <div class="timeline-body"><p>Can't we just early return here instead of having a mutable state variable?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/string/implicit.rs</code>:353 on 2025-05-22 07:04</div>
            <div class="timeline-body"><p>The code duplication here seems unnecessary (and it uses <code>f-string</code> instead of <code>t-string</code>). Maybe another place where an <code>FTString</code> enum could help.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/string/mod.rs</code>:139 on 2025-05-22 07:05</div>
            <div class="timeline-body"><p>Same here. I rather not duplicate this code.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/string/normalize.rs</code>:55 on 2025-05-22 07:07</div>
            <div class="timeline-body"><p>Is this just a rename or did it change the logic? I think I prefered the way it was written before (less nesting)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/string/normalize.rs</code>:434 on 2025-05-22 07:08</div>
            <div class="timeline-body"><p>Can we remove this duplication?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/string/normalize.rs</code>:958 on 2025-05-22 07:09</div>
            <div class="timeline-body"><p>Not as important, but we may also be able to remove the duplication here</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/string/normalize.rs</code>:1103 on 2025-05-22 07:10</div>
            <div class="timeline-body"><p>Do we need to duplicate this method, if yes, move it next to <code>is_fstring_with_quoted_format_spec_and_debug</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/tests/fixtures.rs</code>:335 on 2025-05-22 07:13</div>
            <div class="timeline-body"><p>This seems like a great way to verify your implementation but I've concerns about maintaining this long-term. Maybe we should just remove it before landing your PR.</p>
<p>I don't think we should run this on all test files. It unnecessarily increases the test wall time where most tests don't even use f-strings.</p>
<p>I'm open to keeping this for a handful of tests but I'm more inclined to simply duplicate some f-string tests and update them to use t-strings.</p>
<p>This will also be hard to maintain if we ever decide to diverge formatting between f- and t-strings.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/flake8_bandit/rules/hardcoded_sql_expression.rs</code>:180 on 2025-05-22 07:16</div>
            <div class="timeline-body"><p>Should we resolve this by adding a TODO for now?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/flake8_bandit/rules/hardcoded_tmp_directory.rs</code>:79 on 2025-05-22 07:16</div>
            <div class="timeline-body"><p>Same here, what about string literals inside t-strings? Maybe add a todo for now</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/flake8_bandit/rules/hardcoded_bind_all_interfaces.rs</code>:74 on 2025-05-22 07:17</div>
            <div class="timeline-body"><p>Let's add a TODO for now. I think this rule should maybe trigger on template strings as well.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/flake8_pyi/rules/string_or_bytes_too_long.rs</code>:97 on 2025-05-22 07:19</div>
            <div class="timeline-body"><p>Unrelated to your PR: Lol, wtf is this? Why the byte length of an expression. This isn't visible.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/flake8_pyi/rules/string_or_bytes_too_long.rs</code>:106 on 2025-05-22 07:20</div>
            <div class="timeline-body"><p>Let's maybe add a TODO and remove t-string hadnling for now. We need to be careful here if the templates inferred type is different based on the interpolations.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/flake8_quotes/rules/unnecessary_escaped_quote.rs</code>:151 on 2025-05-22 07:22</div>
            <div class="timeline-body"><p>Similar to the formatter: It seems annoying that this is necessary. I think it would be valuable to have an enum over <code>FString</code> and <code>TString</code> that gives access to the common elements. This could then be simplified to converting the expression into this <code>InterpolationStringRef</code> enum, and passing it as an argument</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/pycodestyle/rules/invalid_escape_sequence.rs</code>:106 on 2025-05-22 07:23</div>
            <div class="timeline-body"><p>Is the code duplication here necessary?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/ruff/rules/ambiguous_unicode_character.rs</code>:236 on 2025-05-22 07:23</div>
            <div class="timeline-body"><p>Can we avoid the code duplication here?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> requested changes on 2025-05-22 07:24</div>
            <div class="timeline-body"><p>Thanks for removing a lot of the code duplication. The parser and AST changes look great.</p>
<p>There's still a lot of duplication in the formatter and dead code that I like to remove before landing this PR because they are in areas that are already extremelly complicated and I don't want to further increase the complexity.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dylwil3">@dylwil3</a> reviewed on 2025-05-22 17:11</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dylwil3">@dylwil3</a> on <code>crates/ruff_python_ast/src/nodes.rs</code>:560 on 2025-05-22 17:11</div>
            <div class="timeline-body"><p>removed</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dylwil3">@dylwil3</a> reviewed on 2025-05-22 17:14</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dylwil3">@dylwil3</a> on <code>crates/ruff_python_parser/src/parser/mod.rs</code>:823 on 2025-05-22 17:14</div>
            <div class="timeline-body"><blockquote>
<p>because we know/assume that the lexer never emits an <code>FStringEnd</code> in a <code>TString</code></p>
</blockquote>
<p>That was my assumption, yes</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dylwil3">@dylwil3</a> reviewed on 2025-05-22 17:14</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dylwil3">@dylwil3</a> on <code>crates/ruff_python_parser/src/string.rs</code>:517 on 2025-05-22 17:14</div>
            <div class="timeline-body"><p>this is now removed completely</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dylwil3">@dylwil3</a> reviewed on 2025-05-22 17:25</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dylwil3">@dylwil3</a> on <code>crates/ruff_python_formatter/src/other/f_t_string.rs</code>:60 on 2025-05-22 17:25</div>
            <div class="timeline-body"><p>replaced methods with single <code>from_ft_string_elements</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dylwil3">@dylwil3</a> reviewed on 2025-05-22 17:35</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dylwil3">@dylwil3</a> on <code>crates/ruff_python_formatter/src/statement/stmt_assign.rs</code>:868 on 2025-05-22 17:35</div>
            <div class="timeline-body"><p>This was what I originally attempted to do, but did not find it to be a &quot;very easy solution&quot; - probably I was doing something wrong. In order to replace instances of <code>FString</code> and <code>TString</code> with this enum, I would have to implement the various traits used throughout this function (e.g. <code>.format</code>). I started doing that and the amount of boilerplate sort of exploded... moreover, some of the traits were actually not possible to duplicate because certain types were required to be like <code>AnyNodeRef</code>'s etc, so I couldn't have them as my &quot;virtual&quot; AST node enum.</p>
<p>In the end I extracted the duplicated code into the two ugly helper methods you see in these branches (<code>format_ft_string_right_left_helper</code> and <code>format_ft_string_left_right_helper</code>). In particular, there is not really much duplicated code (or at least a lot less than before).</p>
<p>Let me know if you have ideas for how to further reduce the complexity or duplication!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dylwil3">@dylwil3</a> reviewed on 2025-05-22 17:37</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dylwil3">@dylwil3</a> on <code>crates/ruff_python_formatter/src/string/implicit.rs</code>:176 on 2025-05-22 17:37</div>
            <div class="timeline-body"><p>ü§¶</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dylwil3">@dylwil3</a> reviewed on 2025-05-22 17:38</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dylwil3">@dylwil3</a> on <code>crates/ruff_python_formatter/src/string/normalize.rs</code>:55 on 2025-05-22 17:38</div>
            <div class="timeline-body"><p>holdover from when I temporarily had 3 variants in that enum - changed back</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dylwil3">@dylwil3</a> reviewed on 2025-05-22 17:42</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dylwil3">@dylwil3</a> on <code>crates/ruff_python_formatter/tests/fixtures.rs</code>:335 on 2025-05-22 17:42</div>
            <div class="timeline-body"><p>yep I agree - I'll delete it right before landing!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-05-22 17:58</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/statement/stmt_assign.rs</code>:868 on 2025-05-22 17:58</div>
            <div class="timeline-body"><p>Something like this</p>
<pre><code class="language-patch">Index: crates/ruff_python_formatter/src/statement/stmt_assign.rs
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
&lt;+&gt;UTF-8
===================================================================
diff --git a/crates/ruff_python_formatter/src/statement/stmt_assign.rs b/crates/ruff_python_formatter/src/statement/stmt_assign.rs
--- a/crates/ruff_python_formatter/src/statement/stmt_assign.rs	(revision 0ccfe03d9a0c0802908f31915aaa049b538f6fd3)
+++ b/crates/ruff_python_formatter/src/statement/stmt_assign.rs	(date 1747936612596)
@@ -1,7 +1,7 @@
 use ruff_formatter::{FormatError, GroupId, RemoveSoftLinesBuffer, format_args, write};
 use ruff_python_ast::{
-    AnyNodeRef, Expr, ExprAttribute, ExprCall, FString, Operator, StmtAssign, StringLike, TString,
-    TypeParams,
+    AnyNodeRef, Expr, ExprAttribute, ExprCall, ExprFString, ExprTString, FString, Operator,
+    StmtAssign, StringLike, TString, TypeParams,
 };
 
 use crate::builders::parenthesize_if_expands;
@@ -18,6 +18,7 @@
     maybe_parenthesize_expression,
 };
 use crate::other::f_t_string::FTStringLayout;
+use crate::other::f_t_string_element::FormatFTStringElement;
 use crate::statement::trailing_semicolon;
 use crate::string::StringLikeExtensions;
 use crate::string::implicit::{
@@ -291,18 +292,18 @@
                 let can_inline_comment = should_inline_comments(value, *statement, f.context());
 
                 let string_like = StringLike::try_from(*value).ok();
-                let format_f_string =
-                    string_like.and_then(|string| format_f_string_assignment(string, f.context()));
-                let format_t_string =
-                    string_like.and_then(|string| format_t_string_assignment(string, f.context()));
+                let format_ft_string = string_like.and_then(|string| {
+                    format_f_string_assignment(string, f.context())
+                        .or_else(|| format_t_string_assignment(string, f.context()))
+                });
+
                 let format_implicit_flat = string_like.and_then(|string| {
                     FormatImplicitConcatenatedStringFlat::new(string, f.context())
                 });
 
                 if !can_inline_comment
                     &amp;&amp; format_implicit_flat.is_none()
-                    &amp;&amp; format_f_string.is_none()
-                    &amp;&amp; format_t_string.is_none()
+                    &amp;&amp; format_ft_string.is_none()
                 {
                     return maybe_parenthesize_expression(
                         value,
@@ -449,20 +450,11 @@
                         best_fitting![single_line, joined_parenthesized, implicit_expanded]
                             .with_mode(BestFittingMode::AllLines)
                             .fmt(f)?;
-                    } else if let Some(format_t_string) = format_t_string {
-                        format_ft_string_left_right_helper(
-                            value,
-                            *statement,
-                            format_t_string,
-                            &amp;inline_comments,
-                            f,
-                            group_id,
-                        )?;
-                    } else if let Some(format_f_string) = format_f_string {
+                    } else if let Some(format_ft_string) = format_ft_string {
                         format_ft_string_left_right_helper(
                             value,
                             *statement,
-                            format_f_string,
+                            format_ft_string,
                             &amp;inline_comments,
                             f,
                             group_id,
@@ -507,10 +499,10 @@
                 let should_inline_comments = should_inline_comments(value, *statement, f.context());
 
                 let string_like = StringLike::try_from(*value).ok();
-                let format_f_string =
-                    string_like.and_then(|string| format_f_string_assignment(string, f.context()));
-                let format_t_string =
-                    string_like.and_then(|string| format_t_string_assignment(string, f.context()));
+                let format_ft_string = string_like.and_then(|string| {
+                    format_f_string_assignment(string, f.context())
+                        .or_else(|| format_t_string_assignment(string, f.context()))
+                });
                 let format_implicit_flat = string_like.and_then(|string| {
                     FormatImplicitConcatenatedStringFlat::new(string, f.context())
                 });
@@ -519,8 +511,7 @@
                 if !should_inline_comments
                     &amp;&amp; !should_non_inlineable_use_best_fit(value, *statement, f.context())
                     &amp;&amp; format_implicit_flat.is_none()
-                    &amp;&amp; format_f_string.is_none()
-                    &amp;&amp; format_t_string.is_none()
+                    &amp;&amp; format_ft_string.is_none()
                 {
                     return write!(
                         f,
@@ -544,8 +535,7 @@
                 // Don't inline comments for attribute and call expressions for black compatibility
                 let inline_comments = if should_inline_comments
                     || format_implicit_flat.is_some()
-                    || format_f_string.is_some()
-                    || format_t_string.is_some()
+                    || format_ft_string.is_some()
                 {
                     OptionalParenthesesInlinedComments::new(
                         &amp;expression_comments,
@@ -586,8 +576,7 @@
                 // and using the costly `BestFitting` layout if it is already known that only the last variant
                 // can ever fit because the left breaks.
                 if format_implicit_flat.is_none()
-                    &amp;&amp; format_f_string.is_none()
-                    &amp;&amp; format_t_string.is_none()
+                    &amp;&amp; format_ft_string.is_none()
                     &amp;&amp; last_target_breaks
                 {
                     return write!(
@@ -615,16 +604,11 @@
                         } else {
                             format_implicit_flat.fmt(f)
                         }
-                    } else if let Some(format_t_string) = format_t_string.as_ref() {
+                    } else if let Some(format_ft_string) = format_ft_string.as_ref() {
                         // Similar to above, remove any soft line breaks emitted by the f-string
                         // formatting.
                         let mut buffer = RemoveSoftLinesBuffer::new(&amp;mut *f);
-                        write!(buffer, [format_t_string.format()])
-                    } else if let Some(format_f_string) = format_f_string.as_ref() {
-                        // Similar to above, remove any soft line breaks emitted by the f-string
-                        // formatting.
-                        let mut buffer = RemoveSoftLinesBuffer::new(&amp;mut *f);
-                        write!(buffer, [format_f_string.format()])
+                        write!(buffer, [format_ft_string])
                     } else {
                         value.format().with_options(Parentheses::Never).fmt(f)
                     }
@@ -865,29 +849,13 @@
                         .with_mode(BestFittingMode::AllLines)
                         .fmt(f)
                     }
-                } else if let Some(format_t_string) = &amp;format_t_string {
+                } else if let Some(format_ft_string) = &amp;format_ft_string {
                     format_ft_string_right_left_helper(
                         value,
                         *statement,
                         *before_operator,
                         *operator,
-                        format_t_string,
-                        &amp;inline_comments,
-                        f,
-                        &amp;format_value,
-                        &amp;last_target,
-                        last_target_breaks,
-                        &amp;single_line,
-                        &amp;split_target_flat_value,
-                        &amp;flat_target_parenthesize_value,
-                    )
-                } else if let Some(format_f_string) = &amp;format_f_string {
-                    format_ft_string_right_left_helper(
-                        value,
-                        *statement,
-                        *before_operator,
-                        *operator,
-                        format_f_string,
+                        *format_ft_string,
                         &amp;inline_comments,
                         f,
                         &amp;format_value,
@@ -910,6 +878,21 @@
     }
 }
 
+#[derive(Debug, Copy, Clone)]
+enum InterpolationString&lt;'a&gt; {
+    FString(&amp;'a FString),
+    TString(&amp;'a TString),
+}
+
+impl Format&lt;PyFormatContext&lt;'_&gt;&gt; for InterpolationString&lt;'_&gt; {
+    fn fmt(&amp;self, f: &amp;mut PyFormatter) -&gt; FormatResult&lt;()&gt; {
+        match self {
+            InterpolationString::FString(string) =&gt; string.format().fmt(f),
+            InterpolationString::TString(string) =&gt; string.format().fmt(f),
+        }
+    }
+}
+
 /// Formats an f-string that is at the value position of an assignment statement.
 ///
 /// This is just a wrapper around [`FormatFString`] while considering a special case when the
@@ -967,7 +950,7 @@
 fn format_f_string_assignment&lt;'a&gt;(
     string: StringLike&lt;'a&gt;,
     context: &amp;PyFormatContext,
-) -&gt; Option&lt;&amp;'a FString&gt; {
+) -&gt; Option&lt;InterpolationString&lt;'a&gt;&gt; {
     let StringLike::FString(expr) = string else {
         return None;
     };
@@ -987,7 +970,7 @@
         return None;
     }
 
-    Some(f_string)
+    Some(InterpolationString::FString(f_string))
 }
 
 /// Formats a t-string that is at the value position of an assignment statement.
@@ -1047,7 +1030,7 @@
 fn format_t_string_assignment&lt;'a&gt;(
     string: StringLike&lt;'a&gt;,
     context: &amp;PyFormatContext,
-) -&gt; Option&lt;&amp;'a TString&gt; {
+) -&gt; Option&lt;InterpolationString&lt;'a&gt;&gt; {
     let StringLike::TString(expr) = string else {
         return None;
     };
@@ -1067,13 +1050,13 @@
         return None;
     }
 
-    Some(t_string)
+    Some(InterpolationString::TString(t_string))
 }
 
-fn format_ft_string_left_right_helper&lt;'a, T: AsFormat&lt;PyFormatContext&lt;'a&gt;&gt;&gt;(
+fn format_ft_string_left_right_helper&lt;'a&gt;(
     value: &amp;Expr,
     statement: AnyNodeRef&lt;'_&gt;,
-    format_ft_string: &amp;T,
+    format_ft_string: InterpolationString,
     inline_comments: &amp;OptionalParenthesesInlinedComments,
     f: &amp;mut Formatter&lt;PyFormatContext&lt;'a&gt;&gt;,
     group_id: GroupId,
@@ -1083,7 +1066,7 @@
     let ft_string_flat = format_with(|f| {
         let mut buffer = RemoveSoftLinesBuffer::new(&amp;mut *f);
 
-        write!(buffer, [format_ft_string.format()])
+        write!(buffer, [format_ft_string])
     })
     .memoized();
 
@@ -1143,7 +1126,7 @@
     //     expression
     // }moreeeeeeeeeeeeeeeee&quot;
     // ```
-    let format_ft_string = format_with(|f| write!(f, [format_ft_string.format(), inline_comments]));
+    let format_ft_string = format_with(|f| write!(f, [format_ft_string, inline_comments]));
 
     best_fitting![single_line, joined_parenthesized, format_ft_string]
         .with_mode(BestFittingMode::AllLines)
@@ -1152,12 +1135,12 @@
 }
 
 #[expect(clippy::too_many_arguments)]
-fn format_ft_string_right_left_helper&lt;'a, T: AsFormat&lt;PyFormatContext&lt;'a&gt;&gt;&gt;(
+fn format_ft_string_right_left_helper&lt;'a&gt;(
     value: &amp;Expr,
     statement: AnyNodeRef&lt;'_&gt;,
     before_operator: AnyBeforeOperator&lt;'_&gt;,
     operator: AnyAssignmentOperator,
-    format_ft_string: &amp;T,
+    format_ft_string: InterpolationString,
     inline_comments: &amp;OptionalParenthesesInlinedComments,
     f: &amp;mut Formatter&lt;PyFormatContext&lt;'a&gt;&gt;,
     format_value: &amp;Memoized&lt;
@@ -1206,7 +1189,7 @@
     }
 
     let format_ft_string =
-        format_with(|f| write!(f, [format_ft_string.format(), inline_comments])).memoized();
+        format_with(|f| write!(f, [format_ft_string, inline_comments])).memoized();
 
     // Considering the following initial source:
     //
</code></pre>
<p><code>AsFormat</code> is mostly a workaround for the orphan rules. You can implement <code>Format</code> (similar to <code>Display</code> and <code>Debug</code>) directly on types defined in the same crate and pass them to <code>write!</code>.</p>
<p>I strongly suggest inlining the formatting code again. The types look horrible and it's very unidiomatic that <code>f</code> isn't the first argument üòÜ</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dylwil3">@dylwil3</a> reviewed on 2025-05-22 18:35</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dylwil3">@dylwil3</a> on <code>crates/ruff_python_formatter/src/string/implicit.rs</code>:353 on 2025-05-22 18:35</div>
            <div class="timeline-body"><p>Here I just matched further down to <code>TString { elements, ..}</code> and merged the arms.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dylwil3">@dylwil3</a> on <code>crates/ruff_python_formatter/src/string/mod.rs</code>:139 on 2025-05-22 18:43</div>
            <div class="timeline-body"><p>couldn't quite merge the match arms here because <code>TStringFlags</code> and <code>FStringFlags</code> differ - but pulled out the helper function above the match so it wasn't repeated.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dylwil3">@dylwil3</a> reviewed on 2025-05-22 18:43</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dylwil3">@dylwil3</a> reviewed on 2025-05-22 18:51</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dylwil3">@dylwil3</a> on <code>crates/ruff_python_formatter/src/string/normalize.rs</code>:1103 on 2025-05-22 18:51</div>
            <div class="timeline-body"><p>merged</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dylwil3">@dylwil3</a> reviewed on 2025-05-22 18:53</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dylwil3">@dylwil3</a> on <code>crates/ruff_python_formatter/src/string/normalize.rs</code>:958 on 2025-05-22 18:53</div>
            <div class="timeline-body"><p>couldn't quite merge the match arms because <code>TStringFlags</code> and <code>FStringFlags</code> are different so I left this one as is</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2025-05-28 05:32</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_python_parser/src/parser/expression.rs</code>:1468 on 2025-05-28 05:32</div>
            <div class="timeline-body"><p>We can just call it &quot;pep750&quot; unless I'm missing something obvious here?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dylwil3">@dylwil3</a> on <code>crates/ruff_linter/src/rules/flake8_bandit/rules/hardcoded_tmp_directory.rs</code>:79 on 2025-05-29 20:35</div>
            <div class="timeline-body"><p>(I'm making all of these TODOs as you suggest, but I still think it's correct - t-strings would trigger a <code>TypeError</code> when used inside <code>open</code> in the same way that bytes literals would.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dylwil3">@dylwil3</a> reviewed on 2025-05-29 20:35</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dylwil3">@dylwil3</a> reviewed on 2025-05-29 20:58</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dylwil3">@dylwil3</a> on <code>crates/ruff_python_parser/src/token.rs</code>:93 on 2025-05-29 20:58</div>
            <div class="timeline-body"><p>Traced through - it seems to be called in places where we also want t-strings, as far as I can tell. Docs updated.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dylwil3">@dylwil3</a> on <code>crates/ruff_linter/src/rules/flake8_quotes/rules/unnecessary_escaped_quote.rs</code>:151 on 2025-05-29 21:02</div>
            <div class="timeline-body"><p>In this case we can just inline <code>check_f_string</code> and <code>check_t_string</code> for a similar effect</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dylwil3">@dylwil3</a> reviewed on 2025-05-29 21:02</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dylwil3">@dylwil3</a> on <code>crates/ruff_linter/src/rules/flake8_pyi/rules/string_or_bytes_too_long.rs</code>:119 on 2025-05-29 21:03</div>
            <div class="timeline-body"><p>(the TString arm is not a todo in any event)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dylwil3">@dylwil3</a> reviewed on 2025-05-29 21:03</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dylwil3">@dylwil3</a> on <code>crates/ruff_linter/src/rules/flake8_bandit/rules/hardcoded_tmp_directory.rs</code>:78 on 2025-05-29 21:04</div>
            <div class="timeline-body"><p>these are all &quot;todo&quot;s now</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dylwil3">@dylwil3</a> reviewed on 2025-05-29 21:04</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @dylwil3 on 2025-05-29 21:19</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dylwil3">@dylwil3</a> reviewed on 2025-05-29 21:20</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dylwil3">@dylwil3</a> on <code>crates/ruff_python_parser/src/parser/statement.rs</code>:3015 on 2025-05-29 21:20</div>
            <div class="timeline-body"><p>I think it had to do with the change in Python version used for the parser tests? I will investigate...</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_python_ast/src/nodes.rs</code>:2228 on 2025-05-30 05:59</div>
            <div class="timeline-body"><p>This change seems unrelated? Isn't it converting to an f-string?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_python_ast/src/comparable.rs</code>:1078 on 2025-05-30 06:04</div>
            <div class="timeline-body"><p>nit: having both &quot;FTString&quot; and &quot;Interpolated&quot; seems a bit confusing, I'd probably just go with &quot;ExprStringInterpolatedElement&quot; (no &quot;FT&quot; prefix)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_python_ast/src/nodes.rs</code>:934 on 2025-05-30 06:16</div>
            <div class="timeline-body"><p>I'm not sure whether this TODO belongs here, should this be moved to be near the <code>Checker</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_python_ast_integration_tests/tests/snapshots/visitor__t_strings.snap</code>:5 on 2025-05-30 06:21</div>
            <div class="timeline-body"><p>Unrelated to this PR but it would be useful to include the source text in these snapshots otherwise it's difficult to know which source this snapshot belongs to.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_python_formatter/src/statement/stmt_assign.rs</code>:466 on 2025-05-30 06:27</div>
            <div class="timeline-body"><p>I'm not sure why do we need to change the code examples here and in other places where f-strings are used, it might be useful to just keep them as f-strings and just highlight that the logic applies to t-strings as well</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_python_formatter/src/statement/stmt_assign.rs</code>:1053 on 2025-05-30 06:29</div>
            <div class="timeline-body"><p>I think in the AST we use &quot;Interpolated&quot;. I don't have any strong opinions but I'd prefer to be consistent, it makes it easier to grep for related data structure across the code base.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_python_formatter/src/statement/stmt_assign.rs</code>:1069 on 2025-05-30 06:29</div>
            <div class="timeline-body"><p>Newline is missing before the comment.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_python_formatter/src/statement/stmt_assign.rs</code>:1145 on 2025-05-30 06:30</div>
            <div class="timeline-body"><p>Assuming that this is the same comment as in the f-string case, let's just provide a reference in the docstring instead of copy-pasting as otherwise it could get outdated.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_python_formatter/src/statement/stmt_assign.rs</code>:1201 on 2025-05-30 06:32</div>
            <div class="timeline-body"><p>I'd be inclined to just combine this with the f-string function as <code>format_ft_string_assignment</code> which would be another way to avoid duplicating docstrings and comments.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_linter/src/rules/pycodestyle/rules/invalid_escape_sequence.rs</code>:223 on 2025-05-30 06:46</div>
            <div class="timeline-body"><pre><code class="language-suggestion">    // Whether we suggest converting to a raw string or
    // adding backslashes depends on the presence of valid
    // escape characters in the entire f/t-string. Therefore,
    // we must analyze escape characters in each f/t-string
    // element before pushing a diagnostic and fix.
    for element in elements {
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_linter/src/rules/flake8_pyi/rules/string_or_bytes_too_long.rs</code>:97 on 2025-05-30 06:50</div>
            <div class="timeline-body"><p>What do you mean by &quot;this isn't visible&quot; ? I think there was some discussion around this and we settled on just using the expression range for now.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_python_parser/src/lexer/ftstring.rs</code>:9 on 2025-05-30 06:54</div>
            <div class="timeline-body"><p>I don't have a strong preference between the two names, so I'll leave this to you and Micha to decide but if it were upto me I'd use &quot;InterpolatedString&quot; :)</p>
<p>Another data point is that libCST uses &quot;FormattedString&quot; for f-strings</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> approved on 2025-05-30 07:15</div>
            <div class="timeline-body"><p>Thank you again for working on this!</p>
<p>This seems pretty close to landing! I've a few comments but they're mostly around avoiding duplication so I'll leave it up to you.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/flake8_pyi/rules/string_or_bytes_too_long.rs</code>:97 on 2025-05-30 15:36</div>
            <div class="timeline-body"><p>It just feels off. I think I'd prefer to use <code>chars</code> which seems more accurate.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-05-30 15:36</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/pycodestyle/rules/invalid_escape_sequence.rs</code>:76 on 2025-05-30 15:38</div>
            <div class="timeline-body"><p>I'm a bit concerned about the wild mix of terminology used in this PR. I'd prefer if we sticked to one, even if it is <code>FT</code> but we should avoid using different terms for the same thing.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2025-05-30 15:43</div>
            <div class="timeline-body"><p>Awesome. Thank you for addressign all my feedback.</p>
<p>My only concern left is that we use different terminology for the same thing in different places. Sometimes we use FT, sometimes we use InterpolatedString. We should make sure to only use one of the two.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2025-05-30 16:13</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_linter/src/rules/flake8_pyi/rules/string_or_bytes_too_long.rs</code>:97 on 2025-05-30 16:13</div>
            <div class="timeline-body"><p>Ah ok, I see. Yeah, that makes more sense</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dylwil3">@dylwil3</a> reviewed on 2025-05-30 19:36</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dylwil3">@dylwil3</a> on <code>crates/ruff_python_parser/src/lexer/ftstring.rs</code>:9 on 2025-05-30 19:36</div>
            <div class="timeline-body"><p>Done!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dylwil3">@dylwil3</a> on <code>crates/ruff_linter/src/rules/pycodestyle/rules/invalid_escape_sequence.rs</code>:76 on 2025-05-30 19:37</div>
            <div class="timeline-body"><p>should all be aligned now - interpolated string everywhere</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dylwil3">@dylwil3</a> reviewed on 2025-05-30 19:37</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dylwil3">@dylwil3</a> reviewed on 2025-05-30 19:41</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dylwil3">@dylwil3</a> on <code>crates/ruff_linter/src/rules/flake8_pyi/rules/string_or_bytes_too_long.rs</code>:97 on 2025-05-30 19:41</div>
            <div class="timeline-body"><p>now at #18395</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dylwil3">@dylwil3</a> reviewed on 2025-05-30 19:43</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dylwil3">@dylwil3</a> on <code>crates/ruff_python_formatter/tests/fixtures.rs</code>:335 on 2025-05-30 19:43</div>
            <div class="timeline-body"><p>deleted - goodbye fun test!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dylwil3">@dylwil3</a> on <code>crates/ruff_python_ast_integration_tests/tests/snapshots/visitor__t_strings.snap</code>:5 on 2025-05-30 19:44</div>
            <div class="timeline-body"><p>#18394</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dylwil3">@dylwil3</a> reviewed on 2025-05-30 19:44</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dylwil3">@dylwil3</a> on <code>crates/ruff_python_parser/src/parser/statement.rs</code>:3015 on 2025-05-30 19:59</div>
            <div class="timeline-body"><p>confirmed! this became a semantic syntax error in python 3.14, see #17283</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dylwil3">@dylwil3</a> reviewed on 2025-05-30 19:59</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @dylwil3 on 2025-05-30 20:00</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @dylwil3 on 2025-05-30 20:00</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dylwil3">@dylwil3</a> on 2025-05-30 20:01</div>
            <div class="timeline-body"><p>Thank you so much @MichaReiser and @dhruvmanila !!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-05-30 20:01</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-05-30 21:33</div>
            <div class="timeline-body"><p>ü•≥ü•≥ Congrats @dylwil3!!</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 18:45:31 UTC
    </footer>
</body>
</html>
