<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fallback to `requires-python` in certain cases when `target-version` is not found - astral-sh/ruff #16319</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Fallback to <code>requires-python</code> in certain cases when <code>target-version</code> is not found</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/16319">#16319</a>
        opened by <a href="https://github.com/dylwil3">@dylwil3</a>
        on 2025-02-22 19:14
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/dylwil3">@dylwil3</a> on 2025-02-22 19:14</div>
            <div class="timeline-body"><h1>Summary</h1>
<p>This PR introduces the following modifications in configuration resolution:</p>
<ol>
<li><p>In the event where we are reading in a configuration file <code>myconfig</code> with no <code>target-version</code> specified, we will search for a <code>pyproject.toml</code> in the <em>same directory</em> as <code>myconfig</code> and see if it has a <code>requires-python</code> field. If so, we will use that as the <code>target-version</code>.</p>
</li>
<li><p>In the event where...</p>
</li>
</ol>
<ul>
<li>we have not used the flag <code>--isolated</code>, and</li>
<li>we have not found any configuration file, and</li>
<li>we have not passed <code>--config</code> specifying a target version</li>
</ul>
<p>then we will search for a <code>pyproject.toml</code> file with <code>required-python</code> in an ancestor directory and use that if we find it.</p>
<p>We've also added some debug logs to indicate which of these paths is taken.</p>
<h2>Implementation</h2>
<p>Two small things:</p>
<ol>
<li>I have chosen a method that will sometimes re-parse a <code>pyproject.toml</code> file that has already been parsed at some earlier stage in the resolution process. It seemed like avoiding that would require more drastic changes - but maybe there is a clever way that I'm not seeing!</li>
<li>When searching for these fallbacks, I suppress any errors that may occur when parsing <code>pyproject.toml</code>s rather than propagate them. The reasoning here is that we have already found or decided upon a perfectly good configuration, and this is just a &quot;bonus&quot; to find a better guess for the target version.</li>
</ol>
<p>Closes #14813, #16662</p>
<h2>Testing</h2>
<p>The linked issue contains a repo for reproducing the behavior, which we used for a manual test:</p>
<pre><code class="language-console">ruff-F821-repro on ÓÇ† main
‚ùØ uvx ruff check --no-cache
hello.py:9:11: F821 Undefined name `anext`. Consider specifying `requires-python = &quot;&gt;= 3.10&quot;` or `tool.ruff.target-version = &quot;py310&quot;` in your `pyproject.toml` file.
  |
8 | async def main():
9 |     print(anext(g()))
  |           ^^^^^ F821
  |

Found 1 error.

ruff-F821-repro on ÓÇ† main
‚ùØ ../ruff/target/debug/ruff check --no-cache
All checks passed!
</code></pre>
<p>In addition, we've added snapshot tests with the CLI output in some examples. Please let me know if there are some additional scenarios you'd like me to add tests for!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">breaking</span> added by @dylwil3 on 2025-02-22 19:14</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">configuration</span> added by @dylwil3 on 2025-02-22 19:14</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">do-not-merge</span> added by @dylwil3 on 2025-02-22 19:14</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone "v0.10" by @dylwil3 on 2025-02-22 19:14</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-02-22 19:24</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>‚úÖ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>‚úÖ ecosystem check detected no linter changes.</p>
<h3>Formatter (stable)</h3>
<p>‚úÖ ecosystem check detected no format changes.</p>
<h3>Formatter (preview)</h3>
<p>‚úÖ ecosystem check detected no format changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_workspace/src/pyproject.rs</code>:205 on 2025-02-23 09:29</div>
            <div class="timeline-body"><p>Let's log at least a debug message when this happens</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_workspace/src/pyproject.rs</code>:171 on 2025-02-23 09:30</div>
            <div class="timeline-body"><p>Is this function also called for user-level configurations? I'm asking because we should only apply this fallback to project configurations.</p>
<p>We should also avoid this fallback for inherited configuration.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-02-23 09:37</div>
            <div class="timeline-body"><p>Thanks for looking into this.</p>
<p>We may need to restructure the code more. I believe the current implementation also applies the fallback for inherited and maybe even user configurations.</p>
<p>We only want the fallback to apply to top-level project configurations.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dylwil3">@dylwil3</a> on 2025-02-23 14:57</div>
            <div class="timeline-body"><blockquote>
<p>We only want the fallback to apply to top-level project configurations.</p>
</blockquote>
<p>Since configurations are resolved relative the to the file being checked, I just want to confirm that what you mean here is something like the below. (Maybe the implementation is not what you'd prefer, but is the logic doing what you meant?)</p>
<pre><code class="language-diff">diff --git a/crates/ruff_workspace/src/pyproject.rs b/crates/ruff_workspace/src/pyproject.rs
index 9d9bc4199..cbc3958ab 100644
--- a/crates/ruff_workspace/src/pyproject.rs
+++ b/crates/ruff_workspace/src/pyproject.rs
@@ -152,7 +152,10 @@ pub fn find_user_settings_toml() -&gt; Option&lt;PathBuf&gt; {
 }
 
 /// Load `Options` from a `pyproject.toml` or `ruff.toml` file.
-pub(super) fn load_options&lt;P: AsRef&lt;Path&gt;&gt;(path: P) -&gt; Result&lt;Options&gt; {
+pub(super) fn load_options&lt;P: AsRef&lt;Path&gt;&gt;(
+    path: P,
+    version_strategy: TargetVersionStrategy,
+) -&gt; Result&lt;Options&gt; {
     if path.as_ref().ends_with(&quot;pyproject.toml&quot;) {
         let pyproject = parse_pyproject_toml(&amp;path)?;
         let mut ruff = pyproject
@@ -172,16 +175,21 @@ pub(super) fn load_options&lt;P: AsRef&lt;Path&gt;&gt;(path: P) -&gt; Result&lt;Options&gt; {
         if let Ok(ref mut ruff) = ruff {
             if ruff.target_version.is_none() {
                 debug!(&quot;No `target-version` found in `ruff.toml`&quot;);
-                if let Some(dir) = path.as_ref().parent() {
-                    let fallback = get_fallback_target_version(dir);
-                    if fallback.is_some() {
-                        debug!(
+                match version_strategy {
+                    TargetVersionStrategy::Standard =&gt; {}
+                    TargetVersionStrategy::RequiresPythonFallback =&gt; {
+                        if let Some(dir) = path.as_ref().parent() {
+                            let fallback = get_fallback_target_version(dir);
+                            if fallback.is_some() {
+                                debug!(
                             &quot;Deriving `target-version` from `requires-python` in `pyproject.toml`&quot;
                         );
-                    } else {
-                        debug!(&quot;No `pyproject.toml` with `requires-python` in same directory; `target-version` unspecified&quot;);
+                            } else {
+                                debug!(&quot;No `pyproject.toml` with `requires-python` in same directory; `target-version` unspecified&quot;);
+                            }
+                            ruff.target_version = fallback;
+                        }
                     }
-                    ruff.target_version = fallback;
                 }
             }
         }
@@ -236,6 +244,13 @@ fn get_minimum_supported_version(requires_version: &amp;VersionSpecifiers) -&gt; Option
     PythonVersion::iter().find(|version| Version::from(*version) == minimum_version)
 }
 
+#[derive(Debug, Default)]
+pub(super) enum TargetVersionStrategy {
+    #[default]
+    Standard,
+    RequiresPythonFallback,
+}
+
 #[cfg(test)]
 mod tests {
     use std::fs;
diff --git a/crates/ruff_workspace/src/resolver.rs b/crates/ruff_workspace/src/resolver.rs
index f550f810f..ef10119c3 100644
--- a/crates/ruff_workspace/src/resolver.rs
+++ b/crates/ruff_workspace/src/resolver.rs
@@ -23,7 +23,7 @@ use ruff_linter::package::PackageRoot;
 use ruff_linter::packaging::is_package;
 
 use crate::configuration::Configuration;
-use crate::pyproject::settings_toml;
+use crate::pyproject::{settings_toml, TargetVersionStrategy};
 use crate::settings::Settings;
 use crate::{pyproject, FileResolverSettings};
 
@@ -319,7 +319,15 @@ pub fn resolve_configuration(
         }
 
         // Resolve the current path.
-        let options = pyproject::load_options(&amp;path).with_context(|| {
+        let version_strategy = if configurations.is_empty() {
+            TargetVersionStrategy::RequiresPythonFallback
+        } else {
+            // For inherited configurations, we do not attempt to
+            // fill missing `target-version` with `requires-python`
+            // from a nearby `pyproject.toml`
+            TargetVersionStrategy::Standard
+        };
+        let options = pyproject::load_options(&amp;path, version_strategy).with_context(|| {
             if configurations.is_empty() {
                 format!(
                     &quot;Failed to load configuration `{path}`&quot;,
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-02-23 15:14</div>
            <div class="timeline-body"><p>Uhm, hard to say because I'm mostly unfamiliar with this part of Ruff.</p>
<p>Different strategies could be a solution or we start using different methods based on what configuration we're resolving (I think that's what we do in Red Knot)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dylwil3">@dylwil3</a> on 2025-02-23 15:29</div>
            <div class="timeline-body"><p>I guess what I'm trying to say is: what do you mean by &quot;project root&quot;? It doesn't seem to me like that's really a first-class notion in Ruff in the same way that it kind of has to be in <code>uv</code> or Red Knot, as far as I can tell.</p>
<p>Probably I'm just not understanding the design spec here - sorry! So far I think I understand these requirements:</p>
<ul>
<li>[x] (from the issue) If we can't find any configuration but there's a pyproject.toml without a tool.ruff section, don't ignore it and instead use the requires-python from there</li>
<li>[x] (from the issue) If we find a ruff.toml without a target-version, fallback to the pyproject.toml's requires-python at the same level (if there's any).</li>
<li>[ ] Do not use the fallback when resolving user-level configuration</li>
</ul>
<p>But I'm not understanding the requirement around the project root. Would it be possible to give an example of the behavior you're looking for?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-02-23 15:38</div>
            <div class="timeline-body"><p>That's a good point and using the term project root was probably more confusing than helpful (because Ruff doesn't know that concept).</p>
<p>What I meant is that this fallback shouldn't apply to user-level configurations or an extended (<code>extend = &quot;dont_fallback_to_pyproject_toml_here.toml&quot;</code>) configuration.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dylwil3">@dylwil3</a> on 2025-02-23 15:41</div>
            <div class="timeline-body"><p>Excellent, thank you for clarifying! That's what I suspected (and is handled by the diff above). I'll tackle the user-config and inherited config adjustments now. Sorry for the confusion!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dylwil3">@dylwil3</a> on 2025-02-23 18:02</div>
            <div class="timeline-body"><p>@dhruvmanila no urgency here, but before we add this to v0.10 it'd be great if you could double-check that the changes to <code>ruff server</code> make sense. The hope is that the changes will ensure that the settings will be resolved the same way whether you are running the server or passing in paths on the command line.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff/src/resolve.rs</code>:40 on 2025-02-24 09:23</div>
            <div class="timeline-body"><p>Do we need both <code>Relativity</code> and <code>ConfigurationProvenance</code>. I get the impression that <code>Relativity</code> can be derived from <code>Provenance</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff/src/resolve.rs</code>:143 on 2025-02-24 09:25</div>
            <div class="timeline-body"><p>Can we extract the path into a variable and use it both in <code>find_fallback_target_version</code> and when calling <code>into_settings</code>. It required me few cycles to understand whether <code>path_dedot::CWD</code> is correct but I then noticed that it's already what <code>into_setting</code> uses</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff/src/resolve.rs</code>:126 on 2025-02-24 09:27</div>
            <div class="timeline-body"><p>can you explain me the case where we end up in this branch and we'll find a <code>pyproject.toml</code>?</p>
<p>I'd expect that it will always take the <code>Ancestor</code> branch above because there's a <code>pyproject.toml</code> in the current (or any parent) directory unless no such file exists, in which case the override never applies</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_workspace/src/resolver.rs</code>:410 on 2025-02-24 09:48</div>
            <div class="timeline-body"><p>nit: I had to Google what &quot;provenance&quot; meant (TIL), I'd possibly name it <code>ConfigurationOrigin</code> or <code>ConfigurationSource</code></p>
<blockquote>
<p>provenance /pr≈èv‚Ä≤…ô-n…ôns, -n√§ns‚Ä≥/
noun</p>
<ol>
<li>Place of origin; derivation.</li>
</ol>
</blockquote>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff/tests/lint.rs</code>:2094 on 2025-02-24 09:50</div>
            <div class="timeline-body"><p>nit: I'd move the attribute right above the function</p>
<pre><code class="language-suggestion">/// ```
/// tmp
/// ‚îú‚îÄ‚îÄ pyproject.toml #&lt;--- no `[tool.ruff]`
/// ‚îî‚îÄ‚îÄ test.py
/// ```
#[test]
fn requires_python_no_tool() -&gt; Result&lt;()&gt; {
</code></pre>
<p>Same for other tests and structs</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_workspace/src/pyproject.rs</code>:264 on 2025-02-24 09:53</div>
            <div class="timeline-body"><p>Can we document these variants? It might be hard to infer what a standard strategy is without looking at how it's being used üòÖ</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_workspace/src/resolver.rs</code>:334 on 2025-02-24 09:54</div>
            <div class="timeline-body"><p>I think I'd move this as documentation on the variants instead</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_workspace/src/resolver.rs</code>:414 on 2025-02-24 09:59</div>
            <div class="timeline-body"><p>Is this to indicate https://github.com/astral-sh/ruff/blob/5eaf225fc3baf738493ad052575d544e565d74d3/crates/ruff_workspace/src/pyproject.rs#L100-L103 ?</p>
<p>This is in a user specific config directory like <code>~/.config/ruff.toml</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_workspace/src/pyproject.rs</code>:186 on 2025-02-24 10:18</div>
            <div class="timeline-body"><p>I think I'll reword it to indicate we've <em>derived</em> the target-version from a pyproject.toml</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_workspace/src/resolver.rs</code>:306 on 2025-02-24 10:22</div>
            <div class="timeline-body"><p>Can we update the function documentation to indicate what does <code>None</code> mean here?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_workspace/src/pyproject.rs</code>:174 on 2025-02-24 10:25</div>
            <div class="timeline-body"><p>Nit</p>
<pre><code class="language-suggestion">				let path = path.as_ref();
        let mut ruff = parse_ruff_toml(path);
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff/src/resolve.rs</code>:119 on 2025-02-24 10:25</div>
            <div class="timeline-body"><p>nit: It's unclear to me what does this convert into, it might be useful to explicitly use the <code>from</code> syntax</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff/src/resolve.rs</code>:117 on 2025-02-24 10:26</div>
            <div class="timeline-body"><p>Same as earlier comment about using the past tense</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_workspace/src/pyproject.rs</code>:186 on 2025-02-24 10:26</div>
            <div class="timeline-body"><pre><code class="language-suggestion">			                            &quot;Deriving `target-version` from `requires-python` in `pyproject.toml`&quot;
			                        );
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_workspace/src/pyproject.rs</code>:191 on 2025-02-24 10:27</div>
            <div class="timeline-body"><pre><code class="language-suggestion">                            if let Some(fallback) = get_fallback_target_version(dir) {
                                debug!(
			                            &quot;Deriving `target-version` from `requires-python` in `pyproject.toml`&quot;
			                        );
			                        ruff.target_version = Some(fallback);
                            } else {
                                debug!(&quot;No `pyproject.toml` with `requires-python` in same directory; `target-version` unspecified&quot;);
                            }
                        }
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_workspace/src/pyproject.rs</code>:263 on 2025-02-24 10:28</div>
            <div class="timeline-body"><p>Let's add some documentation to what either strategy means.</p>
<p>I find <code>Standard</code> a bit confusing, considering that it isn't the standard for most <code>ruff.toml</code> files. Maybe <code>NoFallback</code>, <code>RequiresPythonFallback</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_workspace/src/pyproject.rs</code>:258 on 2025-02-24 10:29</div>
            <div class="timeline-body"><p>I suggest removing the default bacause it's important that we make a deliberate decision for every call site</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2025-02-24 10:29</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2025-02-24 10:31</div>
            <div class="timeline-body"><blockquote>
<p>@dhruvmanila no urgency here, but before we add this to v0.10 it'd be great if you could double-check that the changes to <code>ruff server</code> make sense. The hope is that the changes will ensure that the settings will be resolved the same way whether you are running the server or passing in paths on the command line.</p>
</blockquote>
<p>Yeah, I think it makes sense although I'd also test it out in an editor context. I can add it to my todo but I was wondering if you had done any testing in an editor (VS Code or any other)?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_workspace/src/resolver.rs</code>:306 on 2025-02-24 11:11</div>
            <div class="timeline-body"><p>Let's make <code>ConfigurationProvenance</code> <code>Copy</code> instead of passing it by reference</p>
<pre><code class="language-suggestion">    provenance: Option&lt;ConfigurationProvenance&gt;,
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_workspace/src/resolver.rs</code>:387 on 2025-02-24 11:11</div>
            <div class="timeline-body"><pre><code class="language-suggestion">    provenance: Option&lt;ConfigurationProvenance&gt;,
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_workspace/src/resolver.rs</code>:335 on 2025-02-24 11:18</div>
            <div class="timeline-body"><p>Let's add a test what happens for:</p>
<p><code>pyproject.toml</code></p>
<pre><code class="language-toml">requires-python = &quot;&gt;=3.9&quot;
</code></pre>
<p><em>ruff.toml</em></p>
<pre><code class="language-toml">extend = &quot;./shared/base_config.toml&quot;
</code></pre>
<p><code>shared/base_config.toml</code></p>
<pre><code class="language-toml">target-version = &quot;py310&quot;
</code></pre>
<p>I think red-knot respects the 3.9 in this case, even though the extended configuration sets the <code>target-version</code> to 3.10. This is mainly because it simplifies the resolution and there's an argument that either behavior is correct.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_workspace/src/resolver.rs</code>:735 on 2025-02-24 11:19</div>
            <div class="timeline-body"><p>It's not clear to me why using <code>None</code> here is correct (or when using <code>None</code> is correct in general). Can you tell me a bit more about it?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-02-24 11:20</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dylwil3">@dylwil3</a> reviewed on 2025-02-28 23:15</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dylwil3">@dylwil3</a> on <code>crates/ruff_workspace/src/resolver.rs</code>:410 on 2025-02-28 23:15</div>
            <div class="timeline-body"><p>https://github.com/astral-sh/ruff/pull/16319/commits/abc6af21d5bde0ba30d961b257895288c7b46a05</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dylwil3">@dylwil3</a> on <code>crates/ruff/tests/lint.rs</code>:2094 on 2025-02-28 23:16</div>
            <div class="timeline-body"><p>https://github.com/astral-sh/ruff/pull/16319/commits/d117da27a5fad0a2bcf06fe36d84d5684253ba5a</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dylwil3">@dylwil3</a> reviewed on 2025-02-28 23:16</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dylwil3">@dylwil3</a> reviewed on 2025-02-28 23:17</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dylwil3">@dylwil3</a> on <code>crates/ruff_workspace/src/pyproject.rs</code>:264 on 2025-02-28 23:17</div>
            <div class="timeline-body"><p>https://github.com/astral-sh/ruff/pull/16319/commits/0a64d65b0c586407050d212d38fc17d1bf65c1d2</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dylwil3">@dylwil3</a> on <code>crates/ruff_workspace/src/resolver.rs</code>:334 on 2025-02-28 23:18</div>
            <div class="timeline-body"><p>I did both, with a more abbreviated version on the enum itself</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dylwil3">@dylwil3</a> reviewed on 2025-02-28 23:18</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dylwil3">@dylwil3</a> reviewed on 2025-02-28 23:21</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dylwil3">@dylwil3</a> on <code>crates/ruff_workspace/src/resolver.rs</code>:414 on 2025-02-28 23:21</div>
            <div class="timeline-body"><p>yep! added this as an example to doc comment in this commit: https://github.com/astral-sh/ruff/pull/16319/commits/af82f19da8c125ae21cb90341c59142cbfffbf63</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dylwil3">@dylwil3</a> reviewed on 2025-02-28 23:21</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dylwil3">@dylwil3</a> on <code>crates/ruff_workspace/src/pyproject.rs</code>:186 on 2025-02-28 23:21</div>
            <div class="timeline-body"><p>https://github.com/astral-sh/ruff/pull/16319/commits/edcebd55dccd34cbac081f737e74c9646bc10849</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dylwil3">@dylwil3</a> reviewed on 2025-02-28 23:22</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dylwil3">@dylwil3</a> on <code>crates/ruff_workspace/src/resolver.rs</code>:306 on 2025-02-28 23:22</div>
            <div class="timeline-body"><p>added <code>Unknown</code> variant with doc-comment; removed <code>Option</code>s: https://github.com/astral-sh/ruff/pull/16319/commits/af82f19da8c125ae21cb90341c59142cbfffbf63</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dylwil3">@dylwil3</a> reviewed on 2025-02-28 23:22</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dylwil3">@dylwil3</a> on <code>crates/ruff/src/resolve.rs</code>:119 on 2025-02-28 23:22</div>
            <div class="timeline-body"><p>https://github.com/astral-sh/ruff/pull/16319/commits/5c1b8def4bf6510cad79ce4c60b64999b473b0eb</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dylwil3">@dylwil3</a> on <code>crates/ruff/src/resolve.rs</code>:117 on 2025-02-28 23:22</div>
            <div class="timeline-body"><p>https://github.com/astral-sh/ruff/pull/16319/commits/edcebd55dccd34cbac081f737e74c9646bc10849</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dylwil3">@dylwil3</a> reviewed on 2025-02-28 23:22</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dylwil3">@dylwil3</a> reviewed on 2025-02-28 23:23</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dylwil3">@dylwil3</a> on <code>crates/ruff/src/resolve.rs</code>:40 on 2025-02-28 23:23</div>
            <div class="timeline-body"><p>https://github.com/astral-sh/ruff/pull/16319/commits/fe825a71dab8d72e84d5df4488f8c5cd67b6d6c7</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dylwil3">@dylwil3</a> reviewed on 2025-02-28 23:26</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dylwil3">@dylwil3</a> on <code>crates/ruff/src/resolve.rs</code>:126 on 2025-02-28 23:26</div>
            <div class="timeline-body"><p>Added clarification here: https://github.com/astral-sh/ruff/pull/16319/commits/80501d04548e877d37cdc53230a91b4604b9dc37</p>
<p>You'll end up here if you had a <code>pyproject.toml</code> file that did not contain a <code>[tool.ruff]</code> table. This is implicit in the <code>Ancestor</code> branch above because <code>find_settings_toml</code> only looks for <code>pyproject.toml</code> files that contain a <code>[tool.ruff]</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dylwil3">@dylwil3</a> reviewed on 2025-02-28 23:27</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dylwil3">@dylwil3</a> on <code>crates/ruff_workspace/src/pyproject.rs</code>:174 on 2025-02-28 23:27</div>
            <div class="timeline-body"><p>made this change in various places where there were multiple calls to <code>as_ref</code> in situations like this: https://github.com/astral-sh/ruff/pull/16319/commits/5c2ef01e0ccd448eb818e8331895be8f30b56d6b</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dylwil3">@dylwil3</a> reviewed on 2025-02-28 23:27</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dylwil3">@dylwil3</a> on <code>crates/ruff_workspace/src/pyproject.rs</code>:186 on 2025-02-28 23:27</div>
            <div class="timeline-body"><p>instead I made the spacing match the <code>debug</code> call in the other branch: https://github.com/astral-sh/ruff/pull/16319/commits/ffd2dbf679d01f3bbd071ec30c836c166fcc46f0</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dylwil3">@dylwil3</a> reviewed on 2025-02-28 23:28</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dylwil3">@dylwil3</a> on <code>crates/ruff_workspace/src/pyproject.rs</code>:191 on 2025-02-28 23:28</div>
            <div class="timeline-body"><p>I don't think I can quite do this because I need to use <code>fallback</code> (as an <code>Option&lt;_&gt;</code>) right below this.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dylwil3">@dylwil3</a> reviewed on 2025-02-28 23:29</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dylwil3">@dylwil3</a> on <code>crates/ruff_workspace/src/pyproject.rs</code>:263 on 2025-02-28 23:29</div>
            <div class="timeline-body"><p>https://github.com/astral-sh/ruff/pull/16319/commits/0a64d65b0c586407050d212d38fc17d1bf65c1d2</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dylwil3">@dylwil3</a> reviewed on 2025-02-28 23:29</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dylwil3">@dylwil3</a> on <code>crates/ruff_workspace/src/pyproject.rs</code>:258 on 2025-02-28 23:29</div>
            <div class="timeline-body"><p>https://github.com/astral-sh/ruff/pull/16319/commits/0a64d65b0c586407050d212d38fc17d1bf65c1d2</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dylwil3">@dylwil3</a> reviewed on 2025-02-28 23:30</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dylwil3">@dylwil3</a> on <code>crates/ruff_workspace/src/resolver.rs</code>:306 on 2025-02-28 23:30</div>
            <div class="timeline-body"><p>https://github.com/astral-sh/ruff/pull/16319/commits/ccadd49bd09f0f6ac96363427d3f5e8cedcdd0d4</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dylwil3">@dylwil3</a> reviewed on 2025-02-28 23:30</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dylwil3">@dylwil3</a> on <code>crates/ruff_workspace/src/resolver.rs</code>:335 on 2025-02-28 23:30</div>
            <div class="timeline-body"><p>yep the behavior here matches red knot https://github.com/astral-sh/ruff/pull/16319/commits/d9e144e8d82563128e57bd523ccd060bbd0b0f5d</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dylwil3">@dylwil3</a> reviewed on 2025-02-28 23:31</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dylwil3">@dylwil3</a> on <code>crates/ruff_workspace/src/resolver.rs</code>:735 on 2025-02-28 23:31</div>
            <div class="timeline-body"><p>tried to clarify here (replacing <code>None</code> with new variant <code>Unknown</code> which signals that the configuration origin is unknown to the caller: https://github.com/astral-sh/ruff/pull/16319/commits/af82f19da8c125ae21cb90341c59142cbfffbf63</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dylwil3">@dylwil3</a> reviewed on 2025-02-28 23:36</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dylwil3">@dylwil3</a> on <code>crates/ruff/src/resolve.rs</code>:143 on 2025-02-28 23:36</div>
            <div class="timeline-body"><p>I'm not sure, it depends on what behavior we want.</p>
<p>The way I have it currently set up I'm trying to make the behavior change as little as possible, so I've kept the settings resolution path the same no matter what, but attempted to find a fallback version using the same logic as we did when searching for a user configuration file. That logic would start from the stdin filename directory if it was passed in.</p>
<p>In other words, I don't think I can extract a <code>path</code> variable here since I may be passing a different value to <code>find_fallback_target_version</code> than I am to <code>into_settings</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dylwil3">@dylwil3</a> on 2025-02-28 23:38</div>
            <div class="timeline-body"><blockquote>
<blockquote>
<p>@dhruvmanila no urgency here, but before we add this to v0.10 it'd be great if you could double-check that the changes to <code>ruff server</code> make sense. The hope is that the changes will ensure that the settings will be resolved the same way whether you are running the server or passing in paths on the command line.</p>
</blockquote>
<p>Yeah, I think it makes sense although I'd also test it out in an editor context. I can add it to my todo but I was wondering if you had done any testing in an editor (VS Code or any other)?</p>
</blockquote>
<p>I haven't tried it in an editor yet but I will!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff/src/resolve.rs</code>:119 on 2025-03-03 10:34</div>
            <div class="timeline-body"><p>Nit: I think I'd find it helpful to include the fallback version in the log message: <em>Derived <code>target-version</code> from <code>requires-python</code> setting ({fallback})</em></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff/tests/lint.rs</code>:2126 on 2025-03-03 10:35</div>
            <div class="timeline-body"><p>It's unconventional to assert on the log messages. Could we use <code>--show-settings</code> instead?</p>
<p>It may also be useful to include an assertion before that explicitly asserts that the <code>target-version</code> is not <code>3.11</code> if the <code>pyproject.toml</code> doesn't exist.</p>
<p>The same applies for other tests.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff/tests/lint.rs</code>:2752 on 2025-03-03 10:39</div>
            <div class="timeline-body"><p>It seems all tests are specific to when the <code>pyproject.toml</code> has no <code>tool.ruff</code> table. Do we need a test for when the <code>pyproject.toml</code> has a <code>tool.ruff</code> section?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_workspace/src/pyproject.rs</code>:186 on 2025-03-03 10:40</div>
            <div class="timeline-body"><p>Nit: Same as above, I'd find it useful to include the parsed version in here.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2025-03-03 10:40</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dylwil3">@dylwil3</a> on <code>crates/ruff/tests/lint.rs</code>:2126 on 2025-03-04 12:35</div>
            <div class="timeline-body"><p>I did this but then I had to change some of the explicit lower versions to 3.10 so that you could tell the difference between &quot;defaulting to 3.9&quot; and &quot;reading 3.9 from a toml file&quot;</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dylwil3">@dylwil3</a> reviewed on 2025-03-04 12:35</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-03-10 14:25</div>
            <div class="timeline-body"><p>@dylwil3 feel free to merge this into the ruff-0.10 feature branch once it's ready (I already changed the base)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">do-not-merge</span> removed by @MichaReiser on 2025-03-10 14:25</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> approved on 2025-03-12 04:17</div>
            <div class="timeline-body"><p>The changes all look correct to me for the server settings.</p>
<p>Edit: Wait, I'm seeing some discrepancies in the editor context.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2025-03-12 04:39</div>
            <div class="timeline-body"><p>I'm currently testing out this in an editor context using some of the test cases mentioned in https://github.com/astral-sh/ruff/blob/8aa8c56cad2697c0e4c6a86aa997221e842dcfea/crates/ruff/tests/lint.rs</p>
<p>https://github.com/astral-sh/ruff/blob/8aa8c56cad2697c0e4c6a86aa997221e842dcfea/crates/ruff/tests/lint.rs#L2088-L2094</p>
<p>For this test case, the target version in the editor is still giving me 3.9. As per the test case, it should be 3.11 ? The debug information gives me that the indexed configuration file is empty even though the project has a <code>pyproject.toml</code> file (without <code>tool.ruff</code> heading). I think this is because the server uses the <code>settings_toml</code> function that skips the <code>pyproject.toml</code> file without a <code>tool.ruff</code> heading:</p>
<p>https://github.com/astral-sh/ruff/blob/ba44e9de13edca36041bfe258f728ebbe3916970/crates/ruff_workspace/src/pyproject.rs#L81-L85</p>
<p>I believe this isn't expected? Sorry for taking this on at the last moment before the 0.10 release.</p>
<p>https://github.com/astral-sh/ruff/blob/8aa8c56cad2697c0e4c6a86aa997221e842dcfea/crates/ruff/tests/lint.rs#L2716-L2724</p>
<p>For this test case, I'm seeing the incorrect behavior where the target version is still 3.9.</p>
<p>https://github.com/astral-sh/ruff/blob/8aa8c56cad2697c0e4c6a86aa997221e842dcfea/crates/ruff/tests/lint.rs#L2397-L2404</p>
<p>For this test case, I'm seeing the correct behavior where the target version is 3.11.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-03-12 07:16</div>
            <div class="timeline-body"><p>@dylwil3 can you also take a look at https://github.com/astral-sh/ruff/issues/16662 to verify if it is fixed with your changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dylwil3">@dylwil3</a> on 2025-03-12 10:30</div>
            <div class="timeline-body"><p>Thanks Dhruv, looking into this now!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/codspeed-hq[bot]">@codspeed-hq[bot]</a> on 2025-03-12 11:40</div>
            <div class="timeline-body"><!-- __CODSPEED_PERFORMANCE_REPORT_COMMENT__ -->

<!-- __CODSPEED_INSTRUMENTATION_PERFORMANCE_REPORT_COMMENT__ -->

<h2><a href="https://codspeed.io/astral-sh/ruff/branches/dylwil3%3Arequires-python">CodSpeed Performance Report</a></h2>
<h3>Merging #16319 will <strong>degrade performances by 4.6%</strong></h3>
<p><sub>Comparing <code>dylwil3:requires-python</code> (dc26d44) with <code>micha/ruff-0.10</code> (d622137)</sub></p>
<h3>Summary</h3>
<p><code>‚ùå 1</code> regressions<br />
<code>‚úÖ 31</code> untouched benchmarks</p>
<blockquote>
<p>:warning: <em>Please fix the performance issues or <a href="https://codspeed.io/astral-sh/ruff/branches/dylwil3%3Arequires-python">acknowledge them on CodSpeed</a>.</em></p>
</blockquote>
<h3>Benchmarks breakdown</h3>
<p>|     | Benchmark | <code>BASE</code> | <code>HEAD</code> | Change |
| --- | --------- | ----------------------- | ------------------- | ------ |
| ‚ùå | <code>red_knot_check_file[incremental]</code> | 5.2 ms | 5.5 ms | -4.6% |</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dylwil3">@dylwil3</a> on 2025-03-12 12:10</div>
            <div class="timeline-body"><p>@dhruvmanila Thanks for catching the error! I was able to verify my attempted fix with the server in Helix, but I wasn't sure how to use my local build to test in VSCode. Is there documentation for how to do that somewhere?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-03-12 12:22</div>
            <div class="timeline-body"><blockquote>
<p>@dhruvmanila Thanks for catching the error! I was able to verify my attempted fix with the server in Helix, but I wasn't sure how to use my local build to test in VSCode. Is there documentation for how to do that somewhere?</p>
</blockquote>
<p>It's relatively straightforward for as long as it doesn't require changes to the extension itself.</p>
<ul>
<li>Install Ruff's VS code extension</li>
<li>Open the settings and set <code>ruff.path</code> to your debug ruff binary:</li>
</ul>
<p>The following is my configuration</p>
<pre><code class="language-json">{
    &quot;ruff.path&quot;: [
        &quot;/Users/micha/astral/ruff/target/debug/ruff&quot;,
    ]
}
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dylwil3">@dylwil3</a> on 2025-03-12 13:13</div>
            <div class="timeline-body"><p>Update: It looks like the case where there's no <code>ruff.toml</code> or <code>[tool.ruff]</code> in any <code>pyproject.toml</code> (but there is a <code>requires-python</code>) is still not working as expected for the server. I believe it's because the logic here for the &quot;fallback to default in the absence of any config files&quot; case was not reproduced in the <code>server</code>:</p>
<p>https://github.com/astral-sh/ruff/blob/b098255d2ef14b92a024b141368e1c4f3f876e14/crates/ruff/src/resolve.rs#L104-L115</p>
<p>Looking into it now - sorry for all the last minute hullabaloo close to the release!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dylwil3">@dylwil3</a> on 2025-03-12 15:28</div>
            <div class="timeline-body"><p>I believe the <code>server</code> behavior is now fixed! ü§û  I wish there were a way to write tests for it, but I tried out the failing examples in VSCode and printed the configs and they work now.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2025-03-12 16:50</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_server/src/session/index/ruff_settings.rs</code>:305 on 2025-03-12 16:50</div>
            <div class="timeline-body"><p>If I'm understanding this change correctly, we'd now have a fallback settings for <em>every</em> directory in the project. I think this might create an unexpected behavior because for a file in a nested directory, it would use this fallback settings instead of the settings from the project root? Let me test this out.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_server/src/session/index/ruff_settings.rs</code>:305 on 2025-03-12 16:54</div>
            <div class="timeline-body"><p>Yeah, I tested out, I think this is an incorrect fix. Consider the following directory structure:</p>
<pre><code>.
‚îú‚îÄ‚îÄ nested
‚îÇ¬†¬† ‚îî‚îÄ‚îÄ foo
‚îÇ¬†¬†     ‚îî‚îÄ‚îÄ test.py
‚îú‚îÄ‚îÄ pyproject.toml
‚îî‚îÄ‚îÄ test.py
</code></pre>
<p>The <code>nested/foo/test.py</code> does not consider any settings from <code>pyproject.toml</code>, it's only the <code>test.py</code> file that will consider it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2025-03-12 16:54</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_server/src/session/index/ruff_settings.rs</code>:92 on 2025-03-12 17:06</div>
            <div class="timeline-body"><p>Does that mean that we'll pick up the <code>requires-python</code> constraint even if a user uses <code>editor-only</code> in their settings. I'd be a bit confused if <code>editor-only</code> loads any project settings. @dhruvmanila what's your take on this?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-03-12 17:06</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_server/src/session/index/ruff_settings.rs</code>:305 on 2025-03-12 17:07</div>
            <div class="timeline-body"><p>It's not entirely clear to me why the change here is necessary. Shouldn't the changes above be sufficient?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-03-12 17:07</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_server/src/session/index/ruff_settings.rs</code>:92 on 2025-03-12 17:13</div>
            <div class="timeline-body"><p>Yeah, I don't think we should be looking at any of the config files if the configuration preference is <code>editorOnly</code> unless the user has explicitly asks us using the <code>ruff.configuration</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2025-03-12 17:13</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dylwil3">@dylwil3</a> reviewed on 2025-03-12 17:30</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dylwil3">@dylwil3</a> on <code>crates/ruff_server/src/session/index/ruff_settings.rs</code>:92 on 2025-03-12 17:30</div>
            <div class="timeline-body"><p>I think we won't have gotten this far in the code in that case, though, right? We exited earlier here:</p>
<p>https://github.com/astral-sh/ruff/blob/dd2313ab0faea90abf66a75f1b5c388e728d9d0a/crates/ruff_server/src/session/index/ruff_settings.rs#L114-L123</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-03-13 09:09</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff/src/resolve.rs</code>:92 on 2025-03-13 09:09</div>
            <div class="timeline-body"><p>It seems inconsistent that we don't apply the fallback behavior if a user only has the user-level configuration. It means that we won't pick up the right python version if you have:</p>
<ul>
<li>a user level ruff configuration</li>
<li>but use a <code>pyproject.toml</code> without a <code>tool.ruff</code> section at the project level</li>
</ul>
<p>I think it would be good to apply the <code>requires-python</code> fallback in this case as well.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2025-03-13 09:56</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_server/src/session/index/ruff_settings.rs</code>:92 on 2025-03-13 09:56</div>
            <div class="timeline-body"><p>That branch will be calling <code>RuffSettings::editor_only</code> to create a default configuration so we'll be getting there in this case.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-03-13 11:00</div>
            <div class="timeline-body"><p>I pushed three new commits:</p>
<ol>
<li>This is more a quality of life improvement: The server now shows logs emitted with <code>log::debug</code> (instead of <code>tracing::debug</code>)</li>
<li>Changes the behavior for user-level configurations: A <code>pyproject.toml</code> now always overrides the <code>target-version</code> from the user-level configuration. I'm not a 100% if this is the right change but it's what we do in Red Knot. However, Red Knot's model is slightly different so I'm not sure if this behavior makes sense for Ruff. Maybe it's best to revert it but i'm interested in feedback</li>
<li>The main changes on the server side</li>
</ol>
<p>@dhruvmanila and @dylwil3 could yo uboth take a look</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-03-13 11:05</div>
            <div class="timeline-body"><p>@dylwil3 we should also update https://docs.astral.sh/ruff/configuration/#config-file-discovery or have a new section explaining the <code>target-version</code> discovery but we can do this in a separate PR</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2025-03-13 11:22</div>
            <div class="timeline-body"><blockquote>
<p>2. Changes the behavior for user-level configurations: A <code>pyproject.toml</code> now always overrides the <code>target-version</code> from the user-level configuration. I'm not a 100% if this is the right change but it's what we do in Red Knot. However, Red Knot's model is slightly different so I'm not sure if this behavior makes sense for Ruff. Maybe it's best to revert it but i'm interested in feedback</p>
</blockquote>
<p>IIUC, between a user-level config (<code>~/.config/ruff.toml</code>) and the <code>pyproject.toml</code> in the project, Ruff will prefer to use the <code>requires-python</code> in the project config if present. If not, it'll use the one in the user-level config if present.</p>
<p>Why are you not sure about the behavior in Ruff? I think preferring a project specific version makes sense intuitively, I'd be surprised to see that the <code>requires-python</code> isn't being picked up by Ruff even though it's defined in the project config.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dylwil3">@dylwil3</a> on 2025-03-13 11:31</div>
            <div class="timeline-body"><blockquote>
<p>I pushed three new commits:</p>
</blockquote>
<p>Thank you, this looks awesome!</p>
<blockquote>
<ol>
<li>This is more a quality of life improvement: The server now shows logs emitted with <code>log::debug</code> (instead of <code>tracing::debug</code>)</li>
</ol>
</blockquote>
<p>‚úÖ</p>
<blockquote>
<ol start="2">
<li>Changes the behavior for user-level configurations: A <code>pyproject.toml</code> now always overrides the <code>target-version</code> from the user-level configuration. I'm not a 100% if this is the right change but it's what we do in Red Knot. However, Red Knot's model is slightly different so I'm not sure if this behavior makes sense for Ruff. Maybe it's best to revert it but i'm interested in feedback</li>
</ol>
</blockquote>
<p>This seems intuitive to me.</p>
<blockquote>
<ol start="3">
<li>The main changes on the server side</li>
</ol>
</blockquote>
<p>Tested this in VSCode and looks good! The behavior Dhruv pointed out before with a nested file no longer occurs, and the fallback matches the CLI behavior in the edge case where there is no <code>[tool.ruff]</code> or <code>ruff.toml</code> anywhere (so, in Dhruv's example, if you open VSCode from <code>tmp</code> you'll get a different target version than you would by opening VSCode from <code>nested/foo</code>).</p>
<p>I will work on some documentation!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-03-13 11:32</div>
            <div class="timeline-body"><p>Okay, so I think this PR is ready to land, assuming my changes look good.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2025-03-13 11:44</div>
            <div class="timeline-body"><p>The code looks good, thank you for addressing the issues. I also did some quick testing (not the same ones as Dylan).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @dylwil3 on 2025-03-13 11:49</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @dylwil3 on 2025-03-13 11:49</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dylwil3">@dylwil3</a> on 2025-03-13 11:49</div>
            <div class="timeline-body"><p>Thanks so much @dhruvmanila  and @MichaReiser !!</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 19:49:31 UTC
    </footer>
</body>
</html>
