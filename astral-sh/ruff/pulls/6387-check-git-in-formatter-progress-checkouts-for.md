```yaml
number: 6387
title: Check .git in formatter progress checkouts for build
type: pull_request
state: merged
author: konstin
labels: []
assignees: []
merged: true
base: main
head: ci_check_dot_git_for_build
created_at: 2023-08-07T11:11:15Z
updated_at: 2023-08-08T15:47:32Z
url: https://github.com/astral-sh/ruff/pull/6387
synced_at: 2026-01-12T02:52:04Z
```

# Check .git in formatter progress checkouts for build

---

_Pull request opened by @konstin on 2023-08-07 11:11_

From the formatter progress CI logs:
```
2023-08-07T03:49:02.5178602Z + mkdir -p /home/runner/work/ruff/ruff/target/progress_projects
2023-08-07T03:49:02.5193474Z + '[' '!' -d /home/runner/work/ruff/ruff/target/progress_projects/build ']'
2023-08-07T03:49:02.5194228Z + '[' '!' -d /home/runner/work/ruff/ruff/target/progress_projects/django ']'
2023-08-07T03:49:02.5194966Z + git clone --filter=tree:0 https://github.com/django/django /home/runner/work/ruff/ruff/target/progress_projects/django
2023-08-07T03:49:02.5209260Z Cloning into '/home/runner/work/ruff/ruff/target/progress_projects/django'...
```
```
2023-08-07T03:51:17.4726088Z [2m2023-08-07T03:51:17.472404Z[0m [31mERROR[0m Failed /home/runner/work/ruff/ruff/target/progress_projects/build: no python files in ["/home/runner/work/ruff/ruff/target/progress_projects/build"]
```

Seems that build exists but is an empty cached folder. These changes should fix this by a) checking for `.git` instead of just the folder existing b) running the commit checkout unconditionally. The latter is also important if we ever want to update the SHAs.


---

_Comment by @konstin on 2023-08-07 11:11_

Current dependencies on/for this PR:
* main
  * **PR #6387** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/6387" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a>  ðŸ‘ˆ

This comment was auto-generated by [Graphite](https://app.graphite.dev/github/pr/astral-sh/ruff/6387?utm_source=stack-comment).

---

_Marked ready for review by @konstin on 2023-08-07 11:52_

---

_Comment by @konstin on 2023-08-07 11:52_

The CI failure is unrelated, this fixes the problem with build it was intended to fix

---

_Comment by @MichaReiser on 2023-08-07 12:06_

Do we know what's caching the folder in the first place? Because I didn't see any caching configuration related to it.

---

_Comment by @konstin on 2023-08-07 12:26_

i don't know what caused this initially

---

_Comment by @github-actions[bot] on 2023-08-08 09:29_

## PR Check Results
### Ecosystem
âœ… ecosystem check detected no changes.

### Benchmark
#### Linux
```
group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.00      9.6Â±0.03ms     4.2 MB/sec    1.01      9.7Â±0.11ms     4.2 MB/sec
formatter/numpy/ctypeslib.py               1.00  1911.5Â±10.91Âµs     8.7 MB/sec    1.01  1925.8Â±15.82Âµs     8.6 MB/sec
formatter/numpy/globals.py                 1.00    217.1Â±4.16Âµs    13.6 MB/sec    1.00    217.8Â±4.35Âµs    13.5 MB/sec
formatter/pydantic/types.py                1.00      4.1Â±0.03ms     6.3 MB/sec    1.01      4.1Â±0.07ms     6.2 MB/sec
linter/all-rules/large/dataset.py          1.01     12.1Â±0.06ms     3.4 MB/sec    1.00     12.1Â±0.04ms     3.4 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      3.2Â±0.01ms     5.2 MB/sec    1.00      3.2Â±0.02ms     5.2 MB/sec
linter/all-rules/numpy/globals.py          1.00    450.7Â±1.70Âµs     6.5 MB/sec    1.00    451.9Â±3.76Âµs     6.5 MB/sec
linter/all-rules/pydantic/types.py         1.00      5.5Â±0.02ms     4.6 MB/sec    1.00      5.5Â±0.03ms     4.6 MB/sec
linter/default-rules/large/dataset.py      1.00      6.3Â±0.04ms     6.5 MB/sec    1.00      6.3Â±0.02ms     6.5 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00   1344.9Â±4.83Âµs    12.4 MB/sec    1.01   1357.2Â±6.64Âµs    12.3 MB/sec
linter/default-rules/numpy/globals.py      1.00    153.3Â±0.48Âµs    19.2 MB/sec    1.00    153.0Â±0.97Âµs    19.3 MB/sec
linter/default-rules/pydantic/types.py     1.00      2.8Â±0.01ms     9.1 MB/sec    1.00      2.8Â±0.01ms     9.1 MB/sec
```

#### Windows
```
group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.01     10.0Â±0.09ms     4.1 MB/sec    1.00      9.9Â±0.08ms     4.1 MB/sec
formatter/numpy/ctypeslib.py               1.00  1898.1Â±18.96Âµs     8.8 MB/sec    1.00  1889.8Â±19.60Âµs     8.8 MB/sec
formatter/numpy/globals.py                 1.00    207.3Â±3.43Âµs    14.2 MB/sec    1.01    208.5Â±5.58Âµs    14.2 MB/sec
formatter/pydantic/types.py                1.01      4.2Â±0.04ms     6.1 MB/sec    1.00      4.2Â±0.05ms     6.1 MB/sec
linter/all-rules/large/dataset.py          1.01     12.8Â±0.11ms     3.2 MB/sec    1.00     12.7Â±0.11ms     3.2 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.01      3.5Â±0.07ms     4.8 MB/sec    1.00      3.4Â±0.03ms     4.9 MB/sec
linter/all-rules/numpy/globals.py          1.01    428.9Â±5.66Âµs     6.9 MB/sec    1.00    423.9Â±5.59Âµs     7.0 MB/sec
linter/all-rules/pydantic/types.py         1.01      5.9Â±0.06ms     4.3 MB/sec    1.00      5.8Â±0.07ms     4.4 MB/sec
linter/default-rules/large/dataset.py      1.01      6.9Â±0.06ms     5.9 MB/sec    1.00      6.8Â±0.07ms     6.0 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.01  1415.3Â±20.63Âµs    11.8 MB/sec    1.00  1401.4Â±23.87Âµs    11.9 MB/sec
linter/default-rules/numpy/globals.py      1.00    158.8Â±3.55Âµs    18.6 MB/sec    1.03   164.3Â±30.36Âµs    18.0 MB/sec
linter/default-rules/pydantic/types.py     1.01      3.0Â±0.04ms     8.4 MB/sec    1.00      3.0Â±0.04ms     8.5 MB/sec
```
<!-- thollander/actions-comment-pull-request "PR Check Results" -->

---

_Review requested from @MichaReiser by @konstin on 2023-08-08 09:31_

---

_@MichaReiser requested changes on 2023-08-08 09:55_

Okay I think I know what the problem is. If I understand it correctly, the script clones into the `target` directory. However, the target directory gets cached by [`rust-cache`. ](https://github.com/Swatinem/rust-cache).

I didn't see an option to exclude a specific directory. One option could be to add a CLI command that removes the checked-out project directory to avoid including them in the rust cache.


---

_Comment by @konstin on 2023-08-08 10:14_

I think it does clean "Anything that is not a dependency.", it's just that `build` looks like something that needs to be cached (https://github.com/Swatinem/rust-cache/blob/b919e1427f59422679cf2ed5fc6ddc010f753026/src/cleanup.ts#L37)

---

_@MichaReiser approved on 2023-08-08 15:44_

Yeah. You're right. You can see how the repository isn't restored in the [job's debug log](https://github.com/astral-sh/ruff/actions/runs/5795617584/job/15718180198). 

I'm a bit hesitant about adding workarounds for issues that we don't understand (and it seems to be working fine now).  But I also don't want to block this further.

---

_Merged by @konstin on 2023-08-08 15:46_

---

_Closed by @konstin on 2023-08-08 15:46_

---

_Branch deleted on 2023-08-08 15:46_

---
