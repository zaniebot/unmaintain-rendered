<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[ty] Add `python.ty.disableLanguageServices` config - astral-sh/ruff #18230</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[ty] Add <code>python.ty.disableLanguageServices</code> config</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/18230">#18230</a>
        opened by <a href="https://github.com/dhruvmanila">@dhruvmanila</a>
        on 2025-05-20 19:10
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2025-05-20 19:10</div>
            <div class="timeline-body"><h2>Summary</h2>
<p>PR adding support for it in the VS Code extension: https://github.com/astral-sh/ty-vscode/pull/36</p>
<p>This PR adds support for <code>python.ty.disableLanguageServices</code> to the ty language server by accepting this as server setting.</p>
<p>This has the same issue as https://github.com/astral-sh/ty/issues/282 in that it only works when configured globally. Fixing that requires support for multiple workspaces in the server itself.</p>
<p>I also went ahead and did a similar refactor as the Ruff server to use &quot;Options&quot; and &quot;Settings&quot; to keep the code consistent although the combine functionality doesn't exists yet because workspace settings isn't supported in the ty server.</p>
<h2>Test Plan</h2>
<p>Refer to https://github.com/astral-sh/ty-vscode/pull/36 for the test demo.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">server</span> added by @dhruvmanila on 2025-05-20 19:10</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ty</span> added by @dhruvmanila on 2025-05-20 19:10</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-05-20 19:13</div>
            <div class="timeline-body"><!-- generated-comment mypy_primer -->

<h2><code>mypy_primer</code> results</h2>
<p>No ecosystem changes detected ✅</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2025-05-20 19:53</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ty_server/src/session/settings.rs</code>:27 on 2025-05-20 19:53</div>
            <div class="timeline-body"><p>An alternative here is to avoid introducing &quot;Python&quot; struct and directly use <code>disableLanguageServices</code> in <code>ClientSettings</code> like:</p>
<pre><code class="language-rs">struct ClientSettings {
	disable_language_services: Option&lt;bool&gt;
}
</code></pre>
<p>The disadvantage for this is that in VS Code the setting would be <code>python.ty.disableLanguageServices</code> while in other editors it would just be <code>disableLanguageServices</code>.</p>
<p>This PR keeps it consistent across editors and this is what we want as well because once <code>workspace/didChangeConfiguration</code> notification support is added, we'd directly query the client (editor) to get this setting value instead of mirroring the structure here.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2025-05-20 20:07</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ty_server/src/server/api/requests/completion.rs</code>:36 on 2025-05-20 20:07</div>
            <div class="timeline-body"><p>I tried doing this centrally in <code>background_request_task</code> but that didn't work:</p>
<pre><code class="language-diff">diff --git a/crates/ty_server/src/server/api.rs b/crates/ty_server/src/server/api.rs
index a9dd9da1d0..9899184fd4 100644
--- a/crates/ty_server/src/server/api.rs
+++ b/crates/ty_server/src/server/api.rs
@@ -143,7 +143,18 @@ fn background_request_task&lt;'a, R: traits::BackgroundDocumentRequestHandler&gt;(
 
         Box::new(move |notifier, responder| {
             let _span = tracing::trace_span!(&quot;request&quot;, %id, method = R::METHOD).entered();
-            let result = R::run_with_snapshot(&amp;db, snapshot, notifier, params);
+            let result = if snapshot.client_settings().is_language_services_disabled()
+                &amp;&amp; matches!(
+                    R::METHOD,
+                    request::GotoTypeDefinitionRequestHandler::METHOD
+                        | request::CompletionRequestHandler::METHOD
+                        | request::InlayHintRequestHandler::METHOD
+                        | request::HoverRequestHandler::METHOD
+                ) {
+                // Return an empty response here ...
+            } else {
+                R::run_with_snapshot(&amp;db, snapshot, notifier, params)
+            };
             respond::&lt;R&gt;(id, result, &amp;responder);
         })
     }))
</code></pre>
<p>But, then we'd need to somehow be able to get an &quot;empty&quot; response from those handlers which could be <code>None</code> or something else.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/codspeed-hq[bot]">@codspeed-hq[bot]</a> on 2025-06-16 09:36</div>
            <div class="timeline-body"><!-- __CODSPEED_PERFORMANCE_REPORT_COMMENT__ -->

<!-- __CODSPEED_INSTRUMENTATION_PERFORMANCE_REPORT_COMMENT__ -->

<h2><a href="https://codspeed.io/astral-sh/ruff/branches/dhruv%2Fdisable-language-services">CodSpeed Performance Report</a></h2>
<h3>Merging #18230 will <strong>not alter performance</strong></h3>
<p><sub>Comparing <code>dhruv/disable-language-services</code> (e6cca67) with <code>main</code> (c22f809)</sub></p>
<h3>Summary</h3>
<p><code>✅ 34</code> untouched benchmarks</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2025-06-16 09:36</div>
            <div class="timeline-body"><p>This PR is based on top of https://github.com/astral-sh/ruff/pull/18650 because it's just easier to not have to deal with the (now removed) experimental section.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @dhruvmanila on 2025-06-16 10:39</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @dhruvmanila on 2025-06-16 10:39</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @dhruvmanila on 2025-06-16 10:39</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @AlexWaygood by @dhruvmanila on 2025-06-16 10:39</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @sharkdp by @dhruvmanila on 2025-06-16 10:39</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @dcreager by @dhruvmanila on 2025-06-16 10:39</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for @AlexWaygood removed by @AlexWaygood on 2025-06-16 22:35</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for @carljm removed by @carljm on 2025-06-17 01:53</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_server/src/server/api/requests/completion.rs</code>:36 on 2025-06-17 05:55</div>
            <div class="timeline-body"><p>I prefer having this in the specific handlers. It's less surprising, and someone copying an existing handler (which I always do as a starting point) is then also more likely to think about checking this option.</p>
<p>I guess, it's somewhat wasteful to still have the client send us requests but I suspect that unregistering the providers is more complicated and not supported by all clients?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2025-06-17 05:56</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for @sharkdp removed by @sharkdp on 2025-06-17 06:38</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2025-06-17 06:55</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ty_server/src/server/api/requests/completion.rs</code>:36 on 2025-06-17 06:55</div>
            <div class="timeline-body"><blockquote>
<p>I guess, it's somewhat wasteful to still have the client send us requests but I suspect that unregistering the providers is more complicated and not supported by all clients?</p>
</blockquote>
<p>I think unregistering only works for capabilities that support dynamic registration and I'm not sure if all language capabilities supports that. And, this would also require that we go through the dynamic registration path (via registering each capabilities dynamically) to un-register the capability later as it requires the id that the server used to perform the registration.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @dhruvmanila on 2025-06-17 07:02</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Reopened by @dhruvmanila on 2025-06-17 07:02</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @dhruvmanila on 2025-06-17 08:20</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @dhruvmanila on 2025-06-17 08:20</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-06-17 08:20</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 18:39:35 UTC
    </footer>
</body>
</html>
