<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sync interpolated lexer state within `re_lex_logical_token` - astral-sh/ruff #21898</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Sync interpolated lexer state within <code>re_lex_logical_token</code></h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/pull/21898">#21898</a>
        opened by <a href="https://github.com/MichaReiser">@MichaReiser</a>
        on 2025-12-10 16:18
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a></div>
            <div class="timeline-body"><h2>Summary</h2>
<p>I don't think this is the proper fix but it seems more correct than what we have today?</p>
<p>This PR ensures that we also update the interpolated string state when decrementing the nesting level
to avoid that it has pending interpolations that are more deeply nested than the lexer itself.</p>
<p>I'm pretty neutral on whether we should land this change.</p>
<p>I wrote up a more detailed summary here https://github.com/astral-sh/ruff/issues/21896</p>
<h2>Test Plan</h2>
<p>Updated test</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @dhruvmanila by @MichaReiser on 2025-12-10 16:18</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">parser</span> added by @MichaReiser on 2025-12-10 16:18</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_parser/src/lexer.rs</code>:1547 on 2025-12-10 16:26</div>
            <div class="timeline-body"><pre><code class="language-suggestion"></code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-12-10 16:26</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/astral-sh-bot[bot]">@astral-sh-bot[bot]</a> on 2025-12-10 16:26</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Formatter (stable)</h3>
<p>✅ ecosystem check detected no format changes.</p>
<h3>Formatter (preview)</h3>
<p>✅ ecosystem check detected no format changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/codspeed-hq[bot]">@codspeed-hq[bot]</a> on 2025-12-10 16:45</div>
            <div class="timeline-body"><!-- __CODSPEED_PERFORMANCE_REPORT_COMMENT__ -->

<h2><a href="https://codspeed.io/astral-sh/ruff/branches/micha%2Frelex-interpolated-state?utm_source=github&amp;utm_medium=comment&amp;utm_content=header">CodSpeed Performance Report</a></h2>
<h3>Merging #21898 will <strong>improve performances by 11%</strong></h3>
<p><sub>Comparing <code>micha/relex-interpolated-state</code> (224d6df) with <code>micha/parser-trivia-relex</code> (7d47f71)</sub></p>
<h3>Summary</h3>
<p><code>⚡ 1</code> improvement<br />
<code>✅ 51</code> untouched</p>
<h3>Benchmarks breakdown</h3>
<p>|     | Mode | Benchmark | <code>BASE</code> | <code>HEAD</code> | Change |
| --- | ---- | --------- | ------ | ------ | ------ |
| ⚡ | WallTime | <a href="https://codspeed.io/astral-sh/ruff/branches/micha%2Frelex-interpolated-state?uri=crates%2Fruff_benchmark%2Fbenches%2Fty_walltime.rs%3A%3Amedium%5Bcolour-science%5D&amp;runnerMode=WallTime&amp;utm_source=github&amp;utm_medium=comment&amp;utm_content=benchmark"><code>medium[colour-science]</code></a> | 108.9 s | 98.1 s | +11% |</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_python_parser/src/lexer.rs</code>:1493 on 2025-12-11 06:03</div>
            <div class="timeline-body"><p>I'm a bit worried about whether we need to restore the interpolated string state in this branch based on some condition. I'm not sure, I haven't looked deep into it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> approved on 2025-12-11 06:03</div>
            <div class="timeline-body"><p>I only have one worry but otherwise this change makes sense.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @MichaReiser on 2025-12-26 11:49</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:17:58 UTC
    </footer>
</body>
</html>
