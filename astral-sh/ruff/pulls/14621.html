<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[red-knot] Fix merged type after if-else without explicit else branch - astral-sh/ruff #14621</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[red-knot] Fix merged type after if-else without explicit else branch</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/14621">#14621</a>
        opened by <a href="https://github.com/sransara">@sransara</a>
        on 2024-11-27 03:54
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sransara">@sransara</a></div>
            <div class="timeline-body"><h2>Summary</h2>
<p>Closes: https://github.com/astral-sh/ruff/issues/14593</p>
<p>The final type of a variable after if-statement without explicit else branch should  be similar to having an explicit else branch.</p>
<h2>Test Plan</h2>
<p>Originally failed test cases from the bug are added.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @sransara on 2024-11-27 03:54</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @sransara on 2024-11-27 03:54</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @AlexWaygood by @sransara on 2024-11-27 03:54</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @sharkdp by @sransara on 2024-11-27 03:54</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2024-11-27 04:01</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sransara">@sransara</a> reviewed on 2024-11-27 04:53</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sransara">@sransara</a> on <code>crates/red_knot_python_semantic/src/semantic_index/builder.rs</code>:795 on 2024-11-27 04:53</div>
            <div class="timeline-body"><p>Duplicated the logic in above <code>for</code> loop of <code>node.elif_else_clauses</code> in here. Another approach would be to have a dummy <code>else</code> clause. I wasn't sure if a dummy node with a made up range would cause issues down the line. But I can switch if that pattern is preferred than duplicating.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by @MichaReiser on 2024-11-27 06:19</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/penguinolog">@penguinolog</a> reviewed on 2024-11-27 08:10</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/penguinolog">@penguinolog</a> on <code>crates/red_knot_python_semantic/resources/mdtest/narrow/conditionals/elif_else.md</code>:59 on 2024-11-27 08:10</div>
            <div class="timeline-body"><p>IMHO, need also test for <code>x</code> is not changed in the <code>if</code> branch like:</p>
<pre><code class="language-python">def optional_int() -&gt; int | None: ...

x = optional_int()

if x is None: pass

reveal_type(x)  # revealed: int | None
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sransara">@sransara</a> reviewed on 2024-11-27 16:05</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sransara">@sransara</a> on <code>crates/red_knot_python_semantic/resources/mdtest/narrow/conditionals/elif_else.md</code>:59 on 2024-11-27 16:05</div>
            <div class="timeline-body"><p>Good idea. I didn't see it being tested else where. I added another variable in the same mdtest here. I wonder if a new mdtest file would be better to test <code>post if block</code> narrowing scenarios.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2024-11-27 16:34</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/red_knot_python_semantic/resources/mdtest/narrow/conditionals/elif_else.md</code>:59 on 2024-11-27 16:34</div>
            <div class="timeline-body"><blockquote>
<p>I wonder if a new mdtest file would be better to test <code>post if block</code> narrowing scenarios.</p>
</blockquote>
<p>I think that's a good idea. We should also add tests for scenarios with (multiple) <code>elif</code> branches, but no <code>else</code> branch.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sransara">@sransara</a> on <code>crates/red_knot_python_semantic/resources/mdtest/narrow/conditionals/elif_else.md</code>:59 on 2024-11-28 04:48</div>
            <div class="timeline-body"><p>I added a new test file and added couple of more tests.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sransara">@sransara</a> reviewed on 2024-11-28 04:48</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/resources/mdtest/narrow/post_if_statement.md</code>:24 on 2024-11-28 05:42</div>
            <div class="timeline-body"><p>It looks like <code>y</code> is not used in this test?</p>
<pre><code class="language-suggestion"></code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/resources/mdtest/narrow/post_if_statement.md</code>:18 on 2024-11-28 05:42</div>
            <div class="timeline-body"><pre><code class="language-suggestion">## Narrowing can have a persistent effect if the variable is mutated in one branch
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/resources/mdtest/narrow/post_if_statement.md</code>:3 on 2024-11-28 05:43</div>
            <div class="timeline-body"><pre><code class="language-suggestion">## After if-else statements, narrowing has no effect if the variable is not mutated in any branch
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/resources/mdtest/narrow/post_if_statement.md</code>:34 on 2024-11-28 05:43</div>
            <div class="timeline-body"><pre><code class="language-suggestion">## An if statement without an explicit `else` branch is equivalent to one with a no-op `else` branch
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/resources/mdtest/narrow/post_if_statement.md</code>:52 on 2024-11-28 05:44</div>
            <div class="timeline-body"><pre><code class="language-suggestion">## An if-elif without an explicit else branch is equivalent to one with an empty else branch
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/semantic_index/builder.rs</code>:795 on 2024-11-28 05:52</div>
            <div class="timeline-body"><p>Constructing an actual dummy node will cause issues, and I don't think it's necessary. But I do think we <em>could</em> remove the logic duplication here. Instead of iterating over clauses above, we could iterate over <code>(test, body)</code> pairs, where both elements of the pair are <code>Option</code>. For a normal <code>else</code> clause, <code>test</code> would be <code>None</code> but <code>body</code> would be <code>Some</code>; if there's no <code>else</code> clause, we'd insert a <code>(None, None)</code> at the end.</p>
<p>That said, without trying to write it, I'm not sure if the code necessary to do this might end up being larger / harder to understand than the duplication you currently have here. Open to whatever you think is best, having worked on this.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2024-11-28 05:53</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2024-11-28 06:05</div>
            <div class="timeline-body"><p>Thank you, this is great!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sransara">@sransara</a> on 2024-11-28 06:37</div>
            <div class="timeline-body"><blockquote>
<p>Constructing an actual dummy node will cause issues, and I don't think it's necessary. But I do think we could remove the logic duplication here. Instead of iterating over clauses above, we could iterate over (test, body) pairs, where both elements of the pair are Option. For a normal else clause, test would be None but body would be Some; if there's no else clause, we'd insert a (None, None) at the end.</p>
</blockquote>
<p>That's a neat idea. I think it will work. Let me try that.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/semantic_index/builder.rs</code>:787 on 2024-11-28 12:02</div>
            <div class="timeline-body"><p>nit</p>
<pre><code class="language-suggestion">                for (clause_test, clause_body) in elif_else_clauses {
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-11-28 12:04</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sransara">@sransara</a> reviewed on 2024-11-28 12:06</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sransara">@sransara</a> on <code>crates/red_knot_python_semantic/src/semantic_index/builder.rs</code>:795 on 2024-11-28 12:06</div>
            <div class="timeline-body"><p>Thank you for the suggestion. This is better. Slight change I did was with <code>body</code>. It is a vector/slice. So I opted to using empty slice instead if <code>Option</code>. I have updated the code now.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sransara">@sransara</a> reviewed on 2024-11-28 12:08</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sransara">@sransara</a> on <code>crates/red_knot_python_semantic/src/semantic_index/builder.rs</code>:787 on 2024-11-28 12:08</div>
            <div class="timeline-body"><p>Thank you!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/codspeed-hq[bot]">@codspeed-hq[bot]</a> on 2024-11-28 12:13</div>
            <div class="timeline-body"><h2><a href="https://codspeed.io/astral-sh/ruff/branches/sransara:gh-14593-inverse-narrowing-without-explicit-else-branches">CodSpeed Performance Report</a></h2>
<h3>Merging #14621 will <strong>not alter performance</strong></h3>
<p><sub>Comparing <code>sransara:gh-14593-inverse-narrowing-without-explicit-else-branches</code> (864acb6) with <code>main</code> (6f1cf5b)</sub></p>
<h3>Summary</h3>
<p><code>✅ 32</code> untouched benchmarks</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-11-28 12:18</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/semantic_index/builder.rs</code>:785 on 2024-11-28 12:18</div>
            <div class="timeline-body"><p>couple more code-style nits</p>
<pre><code class="language-suggestion">                    .map(|clause| (clause.test.as_ref(), clause.body.as_slice()));
                let has_else = node
                    .elif_else_clauses
                    .last()
                    .is_some_and(|clause| clause.test.is_none());
                let elif_else_clauses = elif_else_clauses.chain(if has_else {
                    // if there's an `else` clause already, we don't need to add another
                    None
                } else {
                    // if there's no `else` branch, we should add a no-op `else` branch
                    Some((None, [].as_slice()))
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-11-28 12:25</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_python_semantic/src/semantic_index/builder.rs</code>:787 on 2024-11-28 12:25</div>
            <div class="timeline-body"><pre><code class="language-suggestion">                let elif_else_clauses = node
                    .elif_else_clauses
                    .iter()
                    .map(|clause| (clause.test.as_ref(), &amp;clause.body[..]));
                let has_else = node
                    .elif_else_clauses
                    .last()
                    .is_some_and(|clause| clause.test.is_none());
                let elif_else_clauses = elif_else_clauses.chain(if has_else {
                    // if there's an `else` clause already, we don't need to add another
                    None
                } else {
                    // if there's no `else` branch, we should add a no-op `else` branch
                    Some((None, Default::default()))
                });
                for (clause_test, clause_body) in elif_else_clauses {
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-11-28 12:30</div>
            <div class="timeline-body"><p>There seems to be a somewhat significant performance regression. Could we avoid taking a post_clauses snapshot when e.g. the constraints are empty?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sransara">@sransara</a> on <code>crates/red_knot_python_semantic/src/semantic_index/builder.rs</code>:787 on 2024-11-28 12:32</div>
            <div class="timeline-body"><p>Thank you. Previous Updates from Github UI conflicted with this, preventing updating from the UI. So I made the change and committed locally.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sransara">@sransara</a> reviewed on 2024-11-28 12:32</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sransara">@sransara</a> on 2024-11-28 12:34</div>
            <div class="timeline-body"><blockquote>
<p>There seems to be a somewhat significant performance regression. Could we avoid taking a post_clauses snapshot when e.g. the constraints are empty?</p>
</blockquote>
<p>I'm taking a look. Actually my previous commit with collecting to vector <a href="https://github.com/astral-sh/ruff/pull/14621/commits/29014a874a6342db1cb5043c90ac9cab9693d8fb">29014a8</a> didn't complain about perf regression. I wonder being fancy with iter chains is actually slowing it down.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-11-28 12:36</div>
            <div class="timeline-body"><blockquote>
<p>Actually my previous commit with collecting to vector <a href="https://github.com/astral-sh/ruff/pull/14621/commits/29014a874a6342db1cb5043c90ac9cab9693d8fb">29014a8</a> didn't complain about perf regression. I wonder being fancy with iter chains is actually slowing it down.</p>
</blockquote>
<p>yeah, this is pretty surprising. I would expect collecting into a vector to be expensive, and using an iter chain to be relatively cheap. Not sure what's going on here.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-11-28 12:39</div>
            <div class="timeline-body"><p>I think what might be going on is that there was always a performance regression, but it was right on the borderline of the arbitrary 4% line that codspeed uses to determine whether or not to comment on the PR. So purely by chance, previous measurements on the PR &quot;got lucky&quot; due to random noise in the benchmarks, and codspeed never commented on the PR. But the penultimate measurement that codspeed made went <em>just</em> over the line, and cause it to comment and fail the check.</p>
<p>The check is now passing again, but you can see that there is still a perf regression in the benchmaks that's reasonably significant, it's just once again not <em>quite</em> big enough for codspeed to complain about it: https://codspeed.io/astral-sh/ruff/branches/sransara:gh-14593-inverse-narrowing-without-explicit-else-branches</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sransara">@sransara</a> on 2024-11-28 12:44</div>
            <div class="timeline-body"><p>That makes sense. Looking into @MichaReiser's suggestion.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> approved on 2024-11-28 14:17</div>
            <div class="timeline-body"><p>Very nice!!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2024-11-28 14:22</div>
            <div class="timeline-body"><p>I don't think Micha's suggestion to bring down the regression is possible. At this stage (semantic indexing) there is always at least one constraint; it's simply the test expression(s) of the <code>if</code> and each <code>elif</code>, stored for later analysis. We can't know until type inference whether those test expressions apply any actual narrowing constraints.</p>
<p>I think this falls into the general bucket we are already aware of that snapshots are expensive and we may need to improve perf of constructing the use def map. Short of tackling that larger project, I think we just have to accept this regression as the cost of correct semantics here.</p>
<p>So I will go ahead and merge this as is. Thank you for the PR!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @carljm on 2024-11-28 14:23</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @carljm on 2024-11-28 14:23</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sransara">@sransara</a> on 2024-11-28 20:11</div>
            <div class="timeline-body"><p>Thank you for the review and merge!</p>
<p>Looking at the restore and snapshot implementation, I can see how the <code>symbol_states</code> can keep growing to a point that <code>IndexVec.clone</code> become an expensive operation.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:08:02 UTC
    </footer>
</body>
</html>
