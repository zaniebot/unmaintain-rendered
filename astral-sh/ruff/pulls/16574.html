<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fix broken red-knot property tests - astral-sh/ruff #16574</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Fix broken red-knot property tests</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/16574">#16574</a>
        opened by <a href="https://github.com/AlexWaygood">@AlexWaygood</a>
        on 2025-03-09 10:35
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a></div>
            <div class="timeline-body"><h2>Summary</h2>
<p>Fixes #16566, fixes #16575</p>
<p>The semantics of <code>Type::class_member</code> changed in https://github.com/astral-sh/ruff/pull/16416, but the property-test infrastructure was not updated. That means that the property tests were panicking on the second <code>expect_type</code> call here:</p>
<p>https://github.com/astral-sh/ruff/blob/036102186392f1263774bfd42d78acc65c0641b8/crates/red_knot_python_semantic/src/types/property_tests.rs#L151-L158</p>
<p>With the somewhat unhelpful message:</p>
<pre><code>Expected a (possibly unbound) type, not an unbound symbol
</code></pre>
<p>Applying this patch, and then running <code>QUICKCHECK_TESTS=1000000 cargo test --release -p red_knot_python_semantic -- --ignored types::property_tests::stable::equivalent_to_is_reflexive</code> showed clearly that it was no longer able to find <em>any</em> methods on <em>any</em> classes due to the change in semantics of <code>Type::class_member</code>:</p>
<pre><code class="language-diff">--- a/crates/red_knot_python_semantic/src/types/property_tests.rs
+++ b/crates/red_knot_python_semantic/src/types/property_tests.rs
@@ -27,7 +27,7 @@
 use std::sync::{Arc, Mutex, MutexGuard, OnceLock};
 
 use crate::db::tests::{setup_db, TestDb};
-use crate::symbol::{builtins_symbol, known_module_symbol};
+use crate::symbol::{builtins_symbol, known_module_symbol, Symbol};
 use crate::types::{
     BoundMethodType, CallableType, IntersectionBuilder, KnownClass, KnownInstanceType,
     SubclassOfType, TupleType, Type, UnionType,
@@ -150,10 +150,11 @@ impl Ty {
             Ty::BuiltinsFunction(name) =&gt; builtins_symbol(db, name).symbol.expect_type(),
             Ty::BuiltinsBoundMethod { class, method } =&gt; {
                 let builtins_class = builtins_symbol(db, class).symbol.expect_type();
-                let function = builtins_class
-                    .class_member(db, method.into())
-                    .symbol
-                    .expect_type();
+                let Symbol::Type(function, ..) =
+                    builtins_class.class_member(db, method.into()).symbol
+                else {
+                    panic!(&quot;no method `{method}` on class `{class}`&quot;);
+                };
 
                 create_bound_method(db, function, builtins_class)
             }
</code></pre>
<p>This PR updates the property-test infrastructure to use <code>Type::member</code> rather than <code>Type::class_member</code>.</p>
<h2>Test Plan</h2>
<ul>
<li>Ran <code>QUICKCHECK_TESTS=1000000 cargo test --release -p red_knot_python_semantic -- --ignored types::property_tests::stable</code> successfully</li>
<li>Checked that there were no remaining uses of <code>Type::class_member</code> in <code>property_tests.rs</code></li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @AlexWaygood on 2025-03-09 10:35</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">testing</span> added by @AlexWaygood on 2025-03-09 10:35</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by @AlexWaygood on 2025-03-09 10:35</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @AlexWaygood on 2025-03-09 10:35</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @AlexWaygood on 2025-03-09 10:35</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @sharkdp by @AlexWaygood on 2025-03-09 10:35</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> approved on 2025-03-09 17:38</div>
            <div class="timeline-body"><p>Thank you @AlexWaygood</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @AlexWaygood on 2025-03-09 17:40</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @AlexWaygood on 2025-03-09 17:40</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-03-09 17:40</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:10:34 UTC
    </footer>
</body>
</html>
