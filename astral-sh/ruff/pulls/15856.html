<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[red-knot] ruff_db: make diagnostic rendering prettier - astral-sh/ruff #15856</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[red-knot] ruff_db: make diagnostic rendering prettier</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/15856">#15856</a>
        opened by <a href="https://github.com/BurntSushi">@BurntSushi</a>
        on 2025-01-31 16:49
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a></div>
            <div class="timeline-body"><p>This change does a simple swap of the existing renderer for one that
uses our vendored copy of <code>annotate-snippets</code>. We don't change anything
about the diagnostic data model, but this alone already makes
diagnostics look a lot nicer!</p>
<p>Here's an example of what it looks like now:</p>
<p><img src="https://github.com/user-attachments/assets/5c66779c-caeb-4254-bbd2-68fd2d76081c" alt="diag-example" /></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @BurntSushi on 2025-01-31 16:49</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @BurntSushi on 2025-01-31 16:49</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @AlexWaygood by @BurntSushi on 2025-01-31 16:49</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @sharkdp by @BurntSushi on 2025-01-31 16:49</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "ruff_db: make diagnostic rendering prettier" to "[red-knot] ruff_db: make diagnostic rendering prettier" by @BurntSushi on 2025-01-31 16:50</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by @AlexWaygood on 2025-01-31 16:50</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-01-31 16:59</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Formatter (stable)</h3>
<p>✅ ecosystem check detected no format changes.</p>
<h3>Formatter (preview)</h3>
<p>✅ ecosystem check detected no format changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> approved on 2025-01-31 17:12</div>
            <div class="timeline-body"><p>This looks fantastic to me!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot/tests/cli.rs</code>:241 on 2025-01-31 18:06</div>
            <div class="timeline-body"><p>Ok really dumb question, but why does annotate-snippets choose <code>^^^^</code> in some cases but <code>----</code> here?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> approved on 2025-01-31 18:08</div>
            <div class="timeline-body"><p>So good!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2025-01-31 18:22</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/red_knot/tests/cli.rs</code>:241 on 2025-01-31 18:22</div>
            <div class="timeline-body"><p>Good question actually! It chooses a different mark based on the severity level:</p>
<p>https://github.com/astral-sh/ruff/blob/b0b8b062410afdee0c9948a23fc99de8e5a406b6/crates/ruff_annotate_snippets/src/renderer/display_list.rs#L716-L723</p>
<p>Honestly kinda meh on this myself since it's somewhat non-obvious to me.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-01-31 18:32</div>
            <div class="timeline-body"><p>Oh, you're gonna need to update the output-validation in our benchmark somehow...</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2025-01-31 18:35</div>
            <div class="timeline-body"><p>Yeah working on that hah. Trying <code>insta</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/codspeed-hq[bot]">@codspeed-hq[bot]</a> on 2025-01-31 19:48</div>
            <div class="timeline-body"><!-- __CODSPEED_PERFORMANCE_REPORT_COMMENT__ -->

<!-- __CODSPEED_INSTRUMENTATION_PERFORMANCE_REPORT_COMMENT__ -->

<h2><a href="https://codspeed.io/astral-sh/ruff/branches/ag%2Fred-knot-prototype-diagnostics">CodSpeed Performance Report</a></h2>
<h3>Merging #15856 will <strong>not alter performance</strong></h3>
<p><sub>Comparing <code>ag/red-knot-prototype-diagnostics</code> (07c80e8) with <code>main</code> (fab86de)</sub></p>
<h3>Summary</h3>
<p><code>✅ 32</code> untouched benchmarks</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2025-01-31 20:07</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/ruff_benchmark/benches/red_knot.rs</code>:254 on 2025-01-31 20:07</div>
            <div class="timeline-body"><p>Given that we have the diagnostic data structures here, why should we render them using <code>display</code> at all, now that that representation is so inconvienent for comparison and update? (Not that it was ever convenient.) Couldn't we just compare against, like, a tuple of the key fields instead?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-01-31 20:11</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/red_knot/tests/cli.rs</code>:241 on 2025-01-31 20:11</div>
            <div class="timeline-body"><p>I think it makes more sense once you have e.g. (multiple) &quot;Info&quot; and &quot;Error&quot; annotations in a single diagnostic. Example from my own project (thinking about it, the function parameter annotation on top here should probably also be &quot;info&quot;, but anyway):</p>
<p><img src="https://github.com/user-attachments/assets/e538e634-c2f6-4c38-953a-cf9634e57a27" alt="image" /></p>
<p>I kind of like how the informational parts are just underlined with <code>---</code> and the actual error is underlined with <code>^^^</code> as if to say: look, this is what you need to change.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2025-01-31 20:17</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/ruff_benchmark/benches/red_knot.rs</code>:160 on 2025-01-31 20:17</div>
            <div class="timeline-body"><p>On second thought, I think the bogus codspeed numbers are telling us why we can't make this change. It turns the &quot;cold&quot; benchmark into a &quot;no-op incremental&quot; benchmark, which, not surprisingly, is very fast indeed. That's probably why the full diagnostics assertion was included in the benchmark. I think we either need to put it back the way it was, or do it as a totally separate prior step, not part of the per-iteration <code>setup_case</code> at all.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ruff_benchmark/benches/red_knot.rs</code>:160 on 2025-01-31 20:32</div>
            <div class="timeline-body"><p>Aye. I'll switch it back. I guess it should be fine now since I'm not using <code>insta</code> any more. Although I guess the diagnostic strings are now longer, so comparisons will be longer.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2025-01-31 20:32</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2025-01-31 20:33</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ruff_benchmark/benches/red_knot.rs</code>:254 on 2025-01-31 20:33</div>
            <div class="timeline-body"><p>Yeah I'll look into this. I was mostly just looking to do the most minimal thing possible, but yeah, if you're cool with switching this out to just doing a comparison of key fields (range and diagnostic id I guess) then that seems fine.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2025-01-31 20:35</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/ruff_benchmark/benches/red_knot.rs</code>:254 on 2025-01-31 20:35</div>
            <div class="timeline-body"><p>Yeah that seems definitely better to me -- the full diagnostic strings look like they'd be an absolute nightmare to update without help from <code>insta</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2025-01-31 20:36</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/ruff_benchmark/benches/red_knot.rs</code>:160 on 2025-01-31 20:36</div>
            <div class="timeline-body"><p>If we go with key fields instead of the full string, it should be pretty similar to before?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/ruff_benchmark/benches/red_knot.rs</code>:160 on 2025-01-31 20:39</div>
            <div class="timeline-body"><p>Though doing it as a separate step (not in <code>setup_case</code>) also seems pretty easy and fine.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2025-01-31 20:39</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2025-01-31 20:39</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ruff_benchmark/benches/red_knot.rs</code>:160 on 2025-01-31 20:39</div>
            <div class="timeline-body"><p>Yeah sorry I made that comment before the other one.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2025-01-31 21:10</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/red_knot/tests/cli.rs</code>:241 on 2025-01-31 21:10</div>
            <div class="timeline-body"><p>Ah yeah that's a good point to consider too. I'll leave it as-is for now. This was just meant to get some decent rendering in. We can absolutely iterate on the exact format and what not.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @BurntSushi on 2025-01-31 21:10</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/ruff_benchmark/benches/red_knot.rs</code>:35 on 2025-01-31 21:14</div>
            <div class="timeline-body"><p>I think we may want <code>.message()</code> string in here too, but I'm not sure how much difference it will make going forward, and we can always add it back in as a separate change.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> approved on 2025-01-31 21:14</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2025-01-31 21:21</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ruff_benchmark/benches/red_knot.rs</code>:35 on 2025-01-31 21:21</div>
            <div class="timeline-body"><p>Done!</p>
<p>Can you say more about why <code>.message()</code> is desirable here? Do you mean it's desirable to test and validate, or do you mean it's desirable from a measurement perspective?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @BurntSushi on 2025-01-31 21:37</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @BurntSushi on 2025-01-31 21:37</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-01-31 21:37</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2025-01-31 21:43</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/ruff_benchmark/benches/red_knot.rs</code>:35 on 2025-01-31 21:43</div>
            <div class="timeline-body"><p>It's desirable from a usability perspective of validating in PR review that the diagnostics removed from (or added to) this assertion list are sensibly related to the red-knot changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2025-02-01 00:39</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ruff_benchmark/benches/red_knot.rs</code>:35 on 2025-02-01 00:39</div>
            <div class="timeline-body"><p>Ah I think I understand now. Thank you for explaining!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-02-01 08:52</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot/tests/cli.rs</code>:109 on 2025-02-01 08:52</div>
            <div class="timeline-body"><p>This demonstrates that we should start capturing at least some full diagnostics in mdtests because highlighting the entire range here seems incorrect (compared to the <code>import utils</code> case below where it only highlights the name. I'll create an issue</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2025-02-01 14:13</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/red_knot/tests/cli.rs</code>:109 on 2025-02-01 14:13</div>
            <div class="timeline-body"><p>Yeah I agree. We need a fair bit of test coverage beyond what we have. I think a nice short-term target would be at least one test for every type of diagnostic.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-02-01 14:15</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot/tests/cli.rs</code>:109 on 2025-02-01 14:15</div>
            <div class="timeline-body"><p>I agree that we need a lot more tests that capture the full diagnostic output, but I'm not convinced this should necessarily be an mdtest feature (https://github.com/astral-sh/ruff/issues/15867#issuecomment-2628959022)</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:09:39 UTC
    </footer>
</body>
</html>
