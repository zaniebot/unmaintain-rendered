<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fix jemalloc page size on aarch64 - astral-sh/ruff #4247</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Fix jemalloc page size on aarch64</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/4247">#4247</a>
        opened by <a href="https://github.com/MichaReiser">@MichaReiser</a>
        on 2023-05-05 15:51
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a></div>
            <div class="timeline-body"><p>This pr sets the jemalloc large page size on aarch64 to fix a panic during start.</p>
<p>I changed the <code>Install wheel</code> step to a <code>Test wheel</code> step that installs the wheel and runs <code>ruff --help</code>. Just to make sure we never publish something that&#x27;s installable but doesn&#x27;t run at all.</p>
Test Plan
<ul>
<li>I triggered a <a href="https://github.com/charliermarsh/ruff/actions/runs/4895523055/jobs/8741206236">run</a> that uses a page size of three and verified that it fails (ensures that it uses the environment variable)</li>
<li>I triggered a <a href="https://github.com/charliermarsh/ruff/actions/runs/4895642681/jobs/8741465153">run</a> that uses the correct page size of 16</li>
</ul>
<p>@v1c77 Would you mind downloading the <a href="https://github.com/charliermarsh/ruff/suites/12705945862/artifacts/682048513">binaries</a> from the GitHub Action run, try to run the aarch64 (musl or non musl) binary, and let me know if it runs on your machine?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-05-05 15:51</div>
            <div class="timeline-body"><p>Current dependencies on/for this PR:</p>
<ul>
<li>main<ul>
<li><strong>PR #4247</strong> <a href="https://app.graphite.dev/github/pr/charliermarsh/ruff/4247"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite"></a>  ðŸ‘ˆ</li>
</ul>
</li>
</ul>
<p>This comment was auto-generated by <a href="https://app.graphite.dev/github/pr/charliermarsh/ruff/4247?utm_source=stack-comment">Graphite</a>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-05-05 15:51</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>.github/workflows/release.yaml</code>:353 on 2023-05-05 15:51</div>
            <div class="timeline-body"><p>Just for safety reasons :D</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2023-05-05 16:03</div>
            <div class="timeline-body">PR Check Results
Ecosystem
<p>âœ… ecosystem check detected no changes.</p>
Benchmark
Linux
<pre><code>group                                      main                                   pr
-----                                      ----                                   --
linter/all-rules/large/dataset.py          1.00     17.1Â±0.45ms     2.4 MB/sec    1.01     17.3Â±0.35ms     2.4 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      4.1Â±0.12ms     4.1 MB/sec    1.02      4.1Â±0.13ms     4.0 MB/sec
linter/all-rules/numpy/globals.py          1.00   519.4Â±14.94Âµs     5.7 MB/sec    1.02   530.2Â±21.94Âµs     5.6 MB/sec
linter/all-rules/pydantic/types.py         1.00      7.1Â±0.26ms     3.6 MB/sec    1.01      7.2Â±0.16ms     3.6 MB/sec
linter/default-rules/large/dataset.py      1.00      8.3Â±0.19ms     4.9 MB/sec    1.01      8.4Â±0.19ms     4.9 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00  1790.7Â±56.92Âµs     9.3 MB/sec    1.01  1803.4Â±49.25Âµs     9.2 MB/sec
linter/default-rules/numpy/globals.py      1.00    209.9Â±7.67Âµs    14.1 MB/sec    1.04    219.1Â±8.66Âµs    13.5 MB/sec
linter/default-rules/pydantic/types.py     1.00      3.7Â±0.09ms     6.8 MB/sec    1.01      3.8Â±0.11ms     6.8 MB/sec
parser/large/dataset.py                    1.00      6.6Â±0.15ms     6.2 MB/sec    1.02      6.7Â±0.22ms     6.0 MB/sec
parser/numpy/ctypeslib.py                  1.00  1295.0Â±55.75Âµs    12.9 MB/sec    1.01  1304.0Â±32.66Âµs    12.8 MB/sec
parser/numpy/globals.py                    1.00    129.6Â±4.17Âµs    22.8 MB/sec    1.03    133.4Â±5.31Âµs    22.1 MB/sec
parser/pydantic/types.py                   1.00      2.8Â±0.07ms     9.0 MB/sec    1.02      2.9Â±0.09ms     8.8 MB/sec
</code></pre>
Windows
<pre><code>group                                      main                                   pr
-----                                      ----                                   --
linter/all-rules/large/dataset.py          1.00     16.3Â±0.16ms     2.5 MB/sec    1.02     16.6Â±0.21ms     2.4 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.02      4.2Â±0.05ms     4.0 MB/sec    1.00      4.1Â±0.04ms     4.1 MB/sec
linter/all-rules/numpy/globals.py          1.02    490.8Â±6.28Âµs     6.0 MB/sec    1.00    483.3Â±6.79Âµs     6.1 MB/sec
linter/all-rules/pydantic/types.py         1.00      6.9Â±0.08ms     3.7 MB/sec    1.01      7.0Â±0.10ms     3.7 MB/sec
linter/default-rules/large/dataset.py      1.00      8.3Â±0.08ms     4.9 MB/sec    1.02      8.5Â±0.10ms     4.8 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00  1764.3Â±19.75Âµs     9.4 MB/sec    1.01  1780.5Â±20.47Âµs     9.4 MB/sec
linter/default-rules/numpy/globals.py      1.00    197.3Â±4.89Âµs    15.0 MB/sec    1.00    196.8Â±4.58Âµs    15.0 MB/sec
linter/default-rules/pydantic/types.py     1.00      3.7Â±0.04ms     6.8 MB/sec    1.00      3.7Â±0.06ms     6.8 MB/sec
parser/large/dataset.py                    1.00      6.7Â±0.04ms     6.0 MB/sec    1.01      6.8Â±0.07ms     6.0 MB/sec
parser/numpy/ctypeslib.py                  1.00  1286.9Â±15.83Âµs    12.9 MB/sec    1.01  1305.2Â±17.55Âµs    12.8 MB/sec
parser/numpy/globals.py                    1.00    131.8Â±2.12Âµs    22.4 MB/sec    1.01    132.5Â±1.88Âµs    22.3 MB/sec
parser/pydantic/types.py                   1.00      2.9Â±0.02ms     8.9 MB/sec    1.01      2.9Â±0.03ms     8.8 MB/sec
</code></pre>


</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-05-05 17:10</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/konstin">@konstin</a> by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-05-05 17:10</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/v1c77">@v1c77</a> on 2023-05-06 03:26</div>
            <div class="timeline-body"><p>â€‹Looks like the issue has been fixed and these bin files work fine in my aarch64 env with no matter inside or outside the container.â€‹</p>
<pre><code>[root@dev-aarch64 ruff]# tar -zxvf ruff-aarch64-unknown-linux-gnu.tar.gz
ruff
[root@dev-aarch64 ruff]# ./ruff --help
Ruff: An extremely fast Python linter.

Usage: ruff [OPTIONS] &lt;COMMAND&gt;

Commands:
  check   Run Ruff on the given files or directories (default)
  rule    Explain a rule
  config  List or describe the available configuration options
  linter  List all supported upstream linters
  clean   Clear any caches in the current directory and any subdirectories
  help    Print this message or the help of the given subcommand(s)

Options:
  -h, --help     Print help
  -V, --version  Print version

Log levels:
  -v, --verbose  Enable verbose logging
  -q, --quiet    Print lint violations, but nothing else
  -s, --silent   Disable all logging (but still exit with status code &quot;1&quot; upon detecting lint violations)

For help with a specific command, see: `ruff help &lt;command&gt;`.

[root@dev-aarch64 ruff]# ./ruff check ../
/root/proj/src/lib/zk.py:250:29: F841 [*] Local variable `e` is assigned to but never used
/root/proj/src/meta/mock_server.py:7:12: F401 [*] `proto.common_pb2.PExtent` imported but unused
/root/proj/tests/client/meta/mock_server.py:70:43: E712 [*] Comparison to `True` should be `cond is True` or `if cond:`
/root/proj/tests/client/meta/test_client.py:197:9: F841 [*] Local variable `ret3` is assigned to but never used
/root/proj/tests/common/events_test.py:5:8: F401 [*] `pytest` imported but unused

----
As well as the ruff-aarch64-unknown-linux-musl.tar.gz 
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-05-06 10:46</div>
            <div class="timeline-body"><blockquote>
<p>â€‹Looks like the issue has been fixed and these bin files work fine in my aarch64 env with no matter inside or outside the container.â€‹</p>
</blockquote>
<p>Awesome. Thank you for testing this so quickly and I&#x27;m sorry that I didn&#x27;t had the time to fix this sooner. I hope this will be part of our next release.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>.github/workflows/release.yaml</code>:196 on 2023-05-06 11:27</div>
            <div class="timeline-body"><pre><code>            # see <a href="https://github.com/charliermarsh/ruff/issues/3791">charliermarsh/ruff#3791</a>
            # and <a href="https://github.com/gnzlbg/jemallocator/issues/170">gnzlbg/jemallocator#170</a>#issuecomment-1503228963
            maturin_docker_options: -e JEMALLOC_SYS_WITH_LG_PAGE=16
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> approved on 2023-05-06 11:27</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> approved on 2023-05-06 18:12</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from &quot;Fix jemalloc page size on aarch64&quot; to &quot;Fix jemalloc page size on aarch64&quot; by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-05-08 06:10</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-05-08 06:10</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-05-08 06:10</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2023-05-08 06:10</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 18:53:31 UTC
    </footer>
</body>
</html>
