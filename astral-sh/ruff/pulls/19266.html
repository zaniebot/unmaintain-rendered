<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[ty] Add completions for submodules that aren't attributes of their parent - astral-sh/ruff #19266</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[ty] Add completions for submodules that aren't attributes of their parent</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/19266">#19266</a>
        opened by <a href="https://github.com/BurntSushi">@BurntSushi</a>
        on 2025-07-10 17:10
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a></div>
            <div class="timeline-body"><p>While we did previously support submodule completions via our
<code>all_members</code> API, that only works when submodules are attributes of
their parent module. For example, <code>os.path</code>. But that didn't work when
the submodule was not an attribute of its parent. For example,
<code>http.client</code>. To make the latter work, we read the directory of the
parent module to discover its submodules.</p>
<p>Kudos to @AlexWaygood who started this patch. :-)</p>
<p>Note that this doesn't currently do any caching.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @BurntSushi on 2025-07-10 17:10</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @AlexWaygood by @BurntSushi on 2025-07-10 17:10</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @sharkdp by @BurntSushi on 2025-07-10 17:10</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @dcreager by @BurntSushi on 2025-07-10 17:10</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @BurntSushi on 2025-07-10 17:10</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for @dcreager removed by @BurntSushi on 2025-07-10 17:10</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for @carljm removed by @BurntSushi on 2025-07-10 17:10</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for @sharkdp removed by @BurntSushi on 2025-07-10 17:10</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @dhruvmanila by @BurntSushi on 2025-07-10 17:10</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2025-07-10 17:10</div>
            <div class="timeline-body"><p>Demo:</p>
<p>https://github.com/user-attachments/assets/a21b1ba0-15f0-4eb8-86f0-0ef653c6caaf</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">server</span> added by @MichaReiser on 2025-07-10 17:12</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ty</span> added by @MichaReiser on 2025-07-10 17:12</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-07-10 17:13</div>
            <div class="timeline-body"><!-- generated-comment mypy_primer -->

<h2><code>mypy_primer</code> results</h2>
<p>No ecosystem changes detected âœ…
No memory usage changes detected âœ…</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_db/src/vendored.rs</code>:169 on 2025-07-10 19:24</div>
            <div class="timeline-body"><p>hmm... this comment seems semi-relevant here:</p>
<p>https://github.com/astral-sh/ruff/blob/965f415212f4f9f3ef855b647d53e892e6913828/crates/ty_vendored/build.rs#L93-L99</p>
<p>I think the assumptions we make elsewhere are probably okay, given that we in practice only care about the zip file that we create ourselves at build time in <code>crates/ty_vendored/build.rs</code>. But I can't really remember the details, and it's quite possible that this assumption should at least be documented better!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_python_semantic/src/module_resolver/module.rs</code>:148 on 2025-07-10 19:30</div>
            <div class="timeline-body"><p>is it worth emitting a log message saying that we couldn't provide completions because of error blah that meant we couldn't read the directory?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_db/src/vendored.rs</code>:334 on 2025-07-10 19:36</div>
            <div class="timeline-body"><p>heh, not sure how I feel about this crate having three different <code>DirectoryEntry</code> structs ðŸ˜† but I also don't have a suggestion for how to avoid that</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> approved on 2025-07-10 19:38</div>
            <div class="timeline-body"><p>Nice!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-07-11 11:07</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_python_semantic/src/semantic_model.rs</code>:87 on 2025-07-11 11:07</div>
            <div class="timeline-body"><p>I guess it does feel a bit silly that we have to do all this work to construct the absolute <code>ModuleName</code> and then resolve it. The only reason we need to resolve the module here is so that we can get a <code>Type</code> for the <code>Completion</code> -- but the only reason we need a <code>Type</code> for the <code>Completion</code> is so that we can figure out the <code>CompletionKind</code> later on. In this specific situation, we know what the <code>CompletionKind</code> will be here without having to resolve the module and then use that to construct a <code>Type</code>: it will always be a <code>CompletionKind::Module</code>. So it does feel like this is doing a lot more work than is really necessary. Should we do the <code>Type -&gt; CompletionKind</code> conversion at an earlier stage, so that <code>Completion</code> can just store the <code>CompletionKind</code> directly rather than storing a <code>Type</code>?</p>
<p>Similarly, we don't really need to call <code>literal.resolve_submodule</code> here either, which could also be pretty expensive in some situations -- we know that the kind of the all the completions in this <code>.extend()</code> call will always be <code>CompletionKind::Module</code>:</p>
<p>https://github.com/astral-sh/ruff/blob/25c429556421ddd6f715f5aaf906610e0c564606/crates/ty_python_semantic/src/types/ide_support.rs#L204-L209</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-07-11 11:26</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_python_semantic/src/semantic_model.rs</code>:87 on 2025-07-11 11:26</div>
            <div class="timeline-body"><p>Oh, unless the plan is to use the <code>Type</code> for more than just the <code>CompletionKind</code> at some point in the future?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2025-07-11 11:50</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ty_python_semantic/src/semantic_model.rs</code>:87 on 2025-07-11 11:50</div>
            <div class="timeline-body"><p>That occurred to me too. I do suspect that we'll want to head in this direction, but I'd rather leave that as an improvement for the future. I do expect we'll want to use the <code>Type</code> for other things like showing the type signature, but even for cases like that, we might want to elide the type signatue for certain things like modules where its kind is already descriptive enough. Or just write <code>module</code> as its type.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2025-07-11 11:52</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ruff_db/src/vendored.rs</code>:334 on 2025-07-11 11:52</div>
            <div class="timeline-body"><p>I noticed that too. I wondered why there wasn't an abstraction layer over both <code>db.system()</code> and <code>db.vendored()</code>. But there were already distinct types for <code>FileType</code> and <code>Metadata</code>. So instead of rethinking the whole setup here, I just followed the existing pattern in deference to Chesterton's fence. :-)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-07-11 11:53</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_python_semantic/src/semantic_model.rs</code>:87 on 2025-07-11 11:53</div>
            <div class="timeline-body"><p>Right -- in diagnostic messages in ty, we'd just display the type of a module-literal as <code>&lt;module 'json'&gt;</code> or similar. We should be able to render that just fine in autocomplete suggestions without having an actual <code>Type</code> to hand ðŸ˜„</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2025-07-11 13:26</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ruff_db/src/vendored.rs</code>:169 on 2025-07-11 13:26</div>
            <div class="timeline-body"><p>Aye. I've doubled down on <code>/</code> and added a comment on <code>VendoredFileSystem</code> noting this.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2025-07-11 13:36</div>
            <div class="timeline-body"><p>I'm going to work on caching this in follow-up work.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @BurntSushi on 2025-07-11 14:06</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @BurntSushi on 2025-07-11 14:06</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-07-11 14:06</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:14:08 UTC
    </footer>
</body>
</html>
