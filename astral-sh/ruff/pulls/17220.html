<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[`pyupgrade`] Preserve parenthesis when fixing native literals containing newlines (`UP018`) - astral-sh/ruff #17220</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[<code>pyupgrade</code>] Preserve parenthesis when fixing native literals containing newlines (<code>UP018</code>)</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/17220">#17220</a>
        opened by <a href="https://github.com/maxmynter">@maxmynter</a>
        on 2025-04-05 14:27
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/maxmynter">@maxmynter</a></div>
            <div class="timeline-body"><!--
Thank you for contributing to Ruff! To help us out with reviewing, please consider the following:

- Does this pull request include a summary of the change? (See below.)
- Does this pull request include a descriptive title?
- Does this pull request include references to any relevant issues?
-->

<p>Closes #17124</p>
<h2>Summary</h2>
<p>Add a check whether a native literal contains a newline (e.g. <code>int(+\n1)</code>) in which case we must preserve the parenthesis to not break syntax.</p>
<p>Note: An alternative could have been stripping the newline, but I think if it's there it's there for a reason; if not other formatting rules can take care of it.</p>
<h2>Test Plan</h2>
<p>Extended the existing snapshot test by the affected case.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-04-05 14:35</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @AlexWaygood on 2025-04-06 11:45</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">fixes</span> added by @AlexWaygood on 2025-04-06 11:45</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dscorbett">@dscorbett</a> on 2025-04-07 12:22</div>
            <div class="timeline-body"><p>Does <code>arg_code.contains('\n')</code> work when the newline is a carriage return? For example:</p>
<pre><code class="language-console">$ printf 'int(-\r1)\r' | ruff --isolated check - --select UP018 --diff 2&gt;&amp;1 | grep error:
error: Fix introduced a syntax error. Reverting all changes.
</code></pre>
<p>If not, see #15230 and #15703 for ways to detect all newlines.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2025-04-10 20:05</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_linter/resources/test/fixtures/ruff/RUF046.py</code>:165 on 2025-04-10 20:05</div>
            <div class="timeline-body"><p>This does not seem to have a carriage return character as newline. It might have been stripped by your either / git. You'd need to create a separate file for this test case and include it in https://github.com/astral-sh/ruff/blob/main/.gitattributes similar to how other files are included there.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "Preserve parenthesis when fixing native literals containing newlines" to "[`pyupgrade`] Preserve parenthesis when fixing native literals containing newlines (`UP018`)" by @dhruvmanila on 2025-04-10 20:06</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/maxmynter">@maxmynter</a> reviewed on 2025-04-11 09:16</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/maxmynter">@maxmynter</a> on <code>crates/ruff_linter/resources/test/fixtures/ruff/RUF046.py</code>:165 on 2025-04-11 09:16</div>
            <div class="timeline-body"><p>Dang. Mus've been git or pre-commit hooks because i was aware of editor autoformatting and checked it before committing.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/maxmynter">@maxmynter</a> on 2025-04-11 10:23</div>
            <div class="timeline-body"><p>I'm unsure how the testfiles will behave when running on different machines and I couldn't test as I have only access to windows machines. So let me know if my approach doesn't work.</p>
<p>For the rules <code>RUF046</code> and <code>UP018</code> i've added 2 test fixtures each; one with <code>cr</code> the other with <code>lr</code> newlines. All are persisted in <code>.gitattributes</code>.</p>
<p>Alternatively, we could merge those and use <code>test eol=keep</code> but that runs at the risk of devs running into formatting errors when they edit the fixtures.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-04-11 11:54</div>
            <div class="timeline-body"><blockquote>
<p>that runs at the risk of devs running into formatting errors when they edit the fixtures.</p>
</blockquote>
<p>That's a problem that exists anyway. Not when commiting, but it means they may accidentally change the line ending locally which might be confusing when debugging a test. You can create an <code>.editorconfig</code> file to disable formatting in editors that support and respect <code>.editorconfig</code></p>
<p>https://github.com/astral-sh/ruff/blob/46ab9dec181f7736a0d32be4bad59d00228c1819/crates/ruff_linter/resources/test/fixtures/pycodestyle/.editorconfig#L9-L8</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/maxmynter">@maxmynter</a> on 2025-04-12 11:28</div>
            <div class="timeline-body"><p>I added the <code>.editorconfig</code>s in <a href="https://github.com/astral-sh/ruff/pull/17220/commits/67348be1ca770d5158181769bf969b1302336f95">67348be</a>.</p>
<hr />
<p>I think it makes sense to keep the separate files for the <code>cr</code> and <code>lf</code> cases. That way we enforce the desired line endings via <code>.gitattributes</code>, revert any unwanted formatting changes and the tests fail if functionality breaks.</p>
<p>With <code>eol=keep</code> we would keep accidental changes to the file. If these changes slip in, they may easily happen with the snapshot, too.</p>
<p>I've had some issues getting the linebreak's to render in different editors.</p>
<p>What do you think?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @dhruvmanila by @maxmynter on 2025-04-16 15:40</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2025-04-21 19:07</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>.gitattributes</code>:16 on 2025-04-21 19:07</div>
            <div class="timeline-body"><p>Do we need to include the snapshot files in here? I don't think so considering that other snapshot files aren't included and there are <code>.editorconfig</code> files present in both <code>ruff</code> and <code>pyupgrade</code> snapshot directories.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/maxmynter">@maxmynter</a> reviewed on 2025-04-22 16:12</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/maxmynter">@maxmynter</a> on <code>.gitattributes</code>:16 on 2025-04-22 16:12</div>
            <div class="timeline-body"><p>I think we need them.</p>
<p>I added both mechanisms for specific reasons:</p>
<ul>
<li><code>.editorconfig</code> (added in <a href="https://github.com/astral-sh/ruff/pull/17220/commits/67348be1ca770d5158181769bf969b1302336f95">67348be</a>): Prevents editors from automatically reformatting the test fixtures when opened</li>
<li><code>.gitattributes</code>: Ensures Git maintains specific line endings (CR/LF) during checkout/staging irrespective of OS</li>
</ul>
<p>This way i want to avoid (1) tests from passing incorrectly (if both files get normalized) or (2) breaking unexpectedly (if only one gets normalized).</p>
<p>In <a href="https://github.com/astral-sh/ruff/pull/17220/commits/5edfdc8f8c6b61d376a687a08e8d9675f3001803">5edfdc8</a> I wanted to add tests for CR and LF lineendings but local normalization made tests passing as both were normalized thus not testing for CRs.</p>
<p>The other test cases don't seem to be sensitive to the specific line endings and should be fine as long as both fixture and snapshot are regularized on checkout by git. But fixing only the fixture, not the snapshot could make tests flaky.</p>
<p>Or am I missing something?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-04-23 06:38</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>.gitattributes</code>:16 on 2025-04-23 06:38</div>
            <div class="timeline-body"><p>Looking at the crates/ruff_linter/src/rules/ruff/snapshots/ruff_linter__rules__ruff__tests__RUF046_RUF046_CR.py.snap snapshot, it does seem to render the <code>\r</code> differently (<code>^M</code>). That's why I think adding the snapshot here isn't needed.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/maxmynter">@maxmynter</a> reviewed on 2025-04-23 22:20</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/maxmynter">@maxmynter</a> on <code>.gitattributes</code>:16 on 2025-04-23 22:20</div>
            <div class="timeline-body"><p>Allright, addressed in <a href="https://github.com/astral-sh/ruff/pull/17220/commits/005a5288cf8426765d8249eac0c22f5435eb38f9">005a528</a>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @dhruvmanila by @maxmynter on 2025-04-23 22:31</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @MichaReiser on 2025-04-24 06:48</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @MichaReiser on 2025-04-24 06:48</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:11:17 UTC
    </footer>
</body>
</html>
