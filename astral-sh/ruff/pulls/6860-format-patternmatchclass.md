```yaml
number: 6860
title: "Format `PatternMatchClass`"
type: pull_request
state: merged
author: LaBatata101
labels:
  - formatter
assignees: []
merged: true
base: main
head: format-pattern-match-class
created_at: 2023-08-24T20:28:08Z
updated_at: 2023-08-25T20:44:56Z
url: https://github.com/astral-sh/ruff/pull/6860
synced_at: 2026-01-12T15:55:22Z
```

# Format `PatternMatchClass`

---

_@LaBatata101_

## Summary
Closes #6642

## Test Plan

`cargo test`


---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/tests/snapshots/black_compatibility@py_310__pattern_matching_extras.py.snap`:212 on 2023-08-24 20:34_

You'll need to wrap the properties list in an extra group to get this formatting 

---

_Comment by @LaBatata101 on 2023-08-24 20:35_

I don't know how to solve the conflict for the `crates/ruff_python_formatter/tests/snapshots/black_compatibility@py_310__pattern_matching_extras.py.snap` file

---

_@MichaReiser reviewed on 2023-08-24 20:35_

So many removed lines ☺️

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/pattern/pattern_match_class.rs`:39 on 2023-08-24 20:36_

Try adding an extra group around items 

---

_@MichaReiser reviewed on 2023-08-24 20:36_

---

_@LaBatata101 reviewed on 2023-08-24 20:44_

---

_Review comment by @LaBatata101 on `crates/ruff_python_formatter/src/pattern/pattern_match_class.rs`:39 on 2023-08-24 20:44_

Would the function `group` work here?

---

_@MichaReiser reviewed on 2023-08-24 20:48_

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/pattern/pattern_match_class.rs`:39 on 2023-08-24 20:48_

Yes, group(&items) should do the trick if I'm not mistaken 

---

_@LaBatata101 reviewed on 2023-08-24 21:04_

---

_Review comment by @LaBatata101 on `crates/ruff_python_formatter/src/pattern/pattern_match_class.rs`:39 on 2023-08-24 21:04_

Nothing changed for this `crates/ruff_python_formatter/tests/snapshots/black_compatibility@py_310__pattern_matching_extras.py.snap` file when using `group`

---

_Renamed from "Format PatternMatchClass" to "Format `PatternMatchClass`" by @LaBatata101 on 2023-08-24 23:28_

---

_Label `formatter` added by @charliermarsh on 2023-08-25 04:00_

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/tests/snapshots/black_compatibility@py_310__pattern_matching_extras.py.snap`:213 on 2023-08-25 06:00_

Okay, the problem here is that `PatternMatchMapping` isn't yet implemented and the text emitted by the "fake" implementation is much longer than the expected string.

We can ignore this.

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/pattern/pattern_match_class.rs`:39 on 2023-08-25 06:01_

See my comment below. This is fine, assuming we're talking about the same mismatch.

---

_@MichaReiser reviewed on 2023-08-25 06:06_

This looks good to me. Thank you. 

Could you add one test case to 

https://github.com/astral-sh/ruff/blob/main/crates/ruff_python_formatter/resources/test/fixtures/ruff/statement/match.py#L285


that tests for the following weird comment placement

```python
match x:
	case (
		Point2D
		# awkward
		(x = 2)
	: ...
```
```


---

_Review requested from @charliermarsh by @MichaReiser on 2023-08-25 06:06_

---

_Review comment by @konstin on `crates/ruff_python_formatter/src/pattern/pattern_match_class.rs`:28 on 2023-08-25 07:44_

Do we need the `if !kwd_attrs.is_empty()`?

---

_Review comment by @konstin on `crates/ruff_python_formatter/resources/test/fixtures/ruff/statement/match.py`:452 on 2023-08-25 07:54_

Could you add something like
```python
match a:
    case A(
        b # b
        = # c
        2 # d
        # e
    ):
        pass
```
with the left hand side and the right hand side split of the assignment split by comment? I wanted to add an additional comment before the `b` but that's blocked by https://github.com/astral-sh/ruff/issues/6866

---

_@konstin approved on 2023-08-25 07:54_

---

_Comment by @konstin on 2023-08-25 07:57_

> I don't know how to solve the conflict for the crates/ruff_python_formatter/tests/snapshots/black_compatibility@py_310__pattern_matching_extras.py.snap file

Just pick anything (it's an autogenerated file) and recreate file, e.g. with `INSTA_UPDATE=always cargo test -p ruff_python_formatter`.

---

_Comment by @charliermarsh on 2023-08-25 13:52_

Will review and merge today. I can also follow-up with new tests once I fix https://github.com/astral-sh/ruff/issues/6866.

---

_Assigned to @charliermarsh by @charliermarsh on 2023-08-25 18:23_

---

_Comment by @charliermarsh on 2023-08-25 18:58_

Okay, I had to make some changes to the PR to adapt to our parenthesis handling for patterns that changed a bit upstream (mostly, to ensure we handle the single-argument case correctly, like we do for call expressions). We also now handle comments before the arguments, like we do for call expressions.

There are several comment cases that we're still getting wrong (valid syntax, but slightly incorrect placement), but that are really hard to fix without changing the AST. (Namely, we need an `Arguments` node, and we need a single node for `x=1` -- we have both of these things for call expressions so we should have them here too.)

I'm going to update the AST, then do another pass on this node.

---

_Review comment by @charliermarsh on `crates/ruff_python_formatter/tests/snapshots/format@statement__match.py.snap`:948 on 2023-08-25 19:00_

This is not quite right, but very tedious to fix without a node for the whole argument.

---

_@charliermarsh reviewed on 2023-08-25 19:00_

---

_@charliermarsh reviewed on 2023-08-25 19:01_

---

_Review comment by @charliermarsh on `crates/ruff_python_formatter/tests/snapshots/format@statement__match.py.snap`:907 on 2023-08-25 19:01_

This is not quite right (it should be immediately after the `(`), but very hard to fix without a node for the arguments.

---

_Merged by @charliermarsh on 2023-08-25 19:03_

---

_Closed by @charliermarsh on 2023-08-25 19:03_

---

_Comment by @charliermarsh on 2023-08-25 19:06_

Filed here: https://github.com/astral-sh/ruff/issues/6880. I'm on it.

---

_Comment by @github-actions[bot] on 2023-08-25 19:32_

## PR Check Results
### Benchmark
#### Linux
```
group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.00      5.3±0.04ms     7.7 MB/sec    1.00      5.3±0.04ms     7.7 MB/sec
formatter/numpy/ctypeslib.py               1.00   1047.0±4.58µs    15.9 MB/sec    1.00   1046.9±2.82µs    15.9 MB/sec
formatter/numpy/globals.py                 1.00     96.5±0.54µs    30.6 MB/sec    1.03     99.2±0.45µs    29.7 MB/sec
formatter/pydantic/types.py                1.00   1966.4±4.69µs    13.0 MB/sec    1.02  1999.7±11.74µs    12.8 MB/sec
linter/all-rules/large/dataset.py          1.00     12.1±0.09ms     3.4 MB/sec    1.00     12.1±0.06ms     3.4 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      3.2±0.01ms     5.2 MB/sec    1.00      3.2±0.02ms     5.1 MB/sec
linter/all-rules/numpy/globals.py          1.00    452.5±1.02µs     6.5 MB/sec    1.02    461.0±4.45µs     6.4 MB/sec
linter/all-rules/pydantic/types.py         1.00      6.3±0.03ms     4.1 MB/sec    1.00      6.3±0.05ms     4.0 MB/sec
linter/default-rules/large/dataset.py      1.00      6.4±0.02ms     6.4 MB/sec    1.00      6.3±0.03ms     6.4 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00   1401.3±3.38µs    11.9 MB/sec    1.00  1407.2±16.48µs    11.8 MB/sec
linter/default-rules/numpy/globals.py      1.00    162.3±1.29µs    18.2 MB/sec    1.03    167.2±3.38µs    17.7 MB/sec
linter/default-rules/pydantic/types.py     1.00      2.9±0.01ms     8.9 MB/sec    1.00      2.9±0.03ms     8.9 MB/sec
```

#### Windows
```
group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.00      5.7±0.37ms     7.1 MB/sec    1.03      5.9±0.29ms     6.9 MB/sec
formatter/numpy/ctypeslib.py               1.00  1122.3±64.82µs    14.8 MB/sec    1.01  1135.1±81.47µs    14.7 MB/sec
formatter/numpy/globals.py                 1.00    100.6±6.85µs    29.3 MB/sec    1.10    110.9±9.45µs    26.6 MB/sec
formatter/pydantic/types.py                1.00      2.1±0.13ms    11.9 MB/sec    1.11      2.4±0.11ms    10.8 MB/sec
linter/all-rules/large/dataset.py          1.00     14.1±0.62ms     2.9 MB/sec    1.05     14.7±0.83ms     2.8 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      3.8±0.18ms     4.4 MB/sec    1.02      3.9±0.24ms     4.3 MB/sec
linter/all-rules/numpy/globals.py          1.07   501.1±39.89µs     5.9 MB/sec    1.00   470.5±23.62µs     6.3 MB/sec
linter/all-rules/pydantic/types.py         1.02      7.4±0.23ms     3.4 MB/sec    1.00      7.3±0.50ms     3.5 MB/sec
linter/default-rules/large/dataset.py      1.01      7.8±0.33ms     5.2 MB/sec    1.00      7.7±0.42ms     5.3 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00  1658.6±90.66µs    10.0 MB/sec    1.06  1756.2±72.91µs     9.5 MB/sec
linter/default-rules/numpy/globals.py      1.02   190.0±12.97µs    15.5 MB/sec    1.00    185.7±9.52µs    15.9 MB/sec
linter/default-rules/pydantic/types.py     1.00      3.6±0.14ms     7.1 MB/sec    1.01      3.6±0.14ms     7.0 MB/sec
```
<!-- thollander/actions-comment-pull-request "PR Check Results" -->

---

_Branch deleted on 2023-08-25 20:44_

---
