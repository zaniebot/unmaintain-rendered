<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pre commit without cargo and other pre-PR improvements - astral-sh/ruff #5146</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Pre commit without cargo and other pre-PR improvements</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/5146">#5146</a>
        opened by <a href="https://github.com/konstin">@konstin</a>
        on 2023-06-16 12:39
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a></div>
            <div class="timeline-body"><p>This tackles three problems:</p>
<ul>
<li>pre-commit was slow because it ran cargo commands</li>
<li>Improve the clarity on what you need to run to get your PR pass on CI (and make those fast)</li>
<li>You had to compile and run <code>cargo dev generate-all</code> separately, which was slow</li>
</ul>
<p>The first change is to remove all cargo commands except running ruff itself from pre-commit. With <code>cargo run --bin ruff</code> already compiled it takes about 7s on my machine. It would make sense to also use the ruff pre-commit action here even if we're then lagging a release behind for checking ruff on ruff.</p>
<p>The contributing guide is now clear about what you need to run:</p>
<pre><code class="language-shell">cargo clippy --workspace --all-targets --all-features -- -D warnings  # Linting...
RUFF_UPDATE_SCHEMA=1 cargo test  # Testing and updating ruff.schema.json
pre-commit run --all-files  # rust and python formatting, markdown and python linting, etc.
</code></pre>
<p>Example timings from my machine:</p>
<p><code>cargo clippy --workspace --all-targets --all-features -- -D warnings</code>: 23s
<code>RUFF_UPDATE_SCHEMA=1 cargo test</code>: 2min (recompiling), 1min (no code changes, this is mainly doc tests)
<code>pre-commit run --all-files</code>: 7s</p>
<p>The exact numbers don't matter so much as the approximate experience (6s is easier to just wait than 1min, esp if you need to fix and rerun). The biggest remaining block seems to be doc tests, i'm surprised i didn't find any solution to speeding them up (nextest simply doesn't run them at all). Also note that the formatter has it's own tests which are much faster since they avoid linking ruff (<code>cargo test ruff_python_formatter</code>).</p>
<p>The third change is to enable <code>cargo test</code> to update the schema. Similar to <code>INSTA_UPDATE=always</code>, i've added <code>RUFF_UPDATE_SCHEMA=1</code> (name open to bikeshedding), so <code>RUFF_UPDATE_SCHEMA=1 cargo test</code> updates the schema, while <code>cargo test</code> still fails as expected if the repo isn't up-to-date.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2023-06-16 12:49</div>
            <div class="timeline-body"><h2>PR Check Results</h2>
<h3>Ecosystem</h3>
<p>✅ ecosystem check detected no changes.</p>
<h3>Benchmark</h3>
<h4>Linux</h4>
<pre><code>group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.06      8.6±0.29ms     4.7 MB/sec    1.00      8.1±0.31ms     5.0 MB/sec
formatter/numpy/ctypeslib.py               1.01  1701.7±68.84µs     9.8 MB/sec    1.00  1691.1±60.56µs     9.8 MB/sec
formatter/numpy/globals.py                 1.00   167.4±11.43µs    17.6 MB/sec    1.00   167.7±11.76µs    17.6 MB/sec
formatter/pydantic/types.py                1.00      3.3±0.12ms     7.7 MB/sec    1.01      3.4±0.16ms     7.6 MB/sec
linter/all-rules/large/dataset.py          1.00     18.2±0.69ms     2.2 MB/sec    1.04     19.0±0.60ms     2.1 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      4.2±0.12ms     4.0 MB/sec    1.03      4.3±0.15ms     3.9 MB/sec
linter/all-rules/numpy/globals.py          1.00   546.7±23.82µs     5.4 MB/sec    1.00   547.8±20.57µs     5.4 MB/sec
linter/all-rules/pydantic/types.py         1.00      7.5±0.25ms     3.4 MB/sec    1.05      7.9±0.27ms     3.2 MB/sec
linter/default-rules/large/dataset.py      1.00      8.6±0.22ms     4.7 MB/sec    1.06      9.1±0.44ms     4.5 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00  1833.0±63.74µs     9.1 MB/sec    1.00  1830.1±63.20µs     9.1 MB/sec
linter/default-rules/numpy/globals.py      1.01    218.7±7.87µs    13.5 MB/sec    1.00    217.6±9.84µs    13.6 MB/sec
linter/default-rules/pydantic/types.py     1.00      3.9±0.14ms     6.6 MB/sec    1.02      4.0±0.12ms     6.4 MB/sec
</code></pre>
<h4>Windows</h4>
<pre><code>group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.00      7.5±0.05ms     5.4 MB/sec    1.01      7.6±0.07ms     5.4 MB/sec
formatter/numpy/ctypeslib.py               1.00  1530.6±22.34µs    10.9 MB/sec    1.01  1540.5±20.60µs    10.8 MB/sec
formatter/numpy/globals.py                 1.00    146.2±2.29µs    20.2 MB/sec    1.02    149.2±5.59µs    19.8 MB/sec
formatter/pydantic/types.py                1.00      3.1±0.04ms     8.3 MB/sec    1.01      3.1±0.04ms     8.2 MB/sec
linter/all-rules/large/dataset.py          1.00     15.3±0.09ms     2.7 MB/sec    1.03     15.8±0.06ms     2.6 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      4.0±0.04ms     4.2 MB/sec    1.02      4.1±0.04ms     4.1 MB/sec
linter/all-rules/numpy/globals.py          1.00    480.9±6.80µs     6.1 MB/sec    1.01    486.5±5.96µs     6.1 MB/sec
linter/all-rules/pydantic/types.py         1.00      6.7±0.05ms     3.8 MB/sec    1.03      6.9±0.06ms     3.7 MB/sec
linter/default-rules/large/dataset.py      1.00      8.0±0.05ms     5.1 MB/sec    1.00      8.0±0.04ms     5.1 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00  1692.6±15.68µs     9.8 MB/sec    1.00  1692.9±18.87µs     9.8 MB/sec
linter/default-rules/numpy/globals.py      1.00    192.3±2.27µs    15.3 MB/sec    1.01    194.8±2.66µs    15.1 MB/sec
linter/default-rules/pydantic/types.py     1.00      3.6±0.03ms     7.1 MB/sec    1.01      3.6±0.04ms     7.0 MB/sec
</code></pre>
<!-- thollander/actions-comment-pull-request "PR Check Results" -->

</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "Pre commit with cargo" to "Pre commit without cargo and other pre-PR improvements" by @konstin on 2023-06-16 13:21</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2023-06-16 14:05</div>
            <div class="timeline-body"><p>the benchmarks are really noisy, there are no code changes in the linter or the formatter</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">internal</span> added by @konstin on 2023-06-16 14:05</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2023-06-17 06:59</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>CONTRIBUTING.md</code>:68 on 2023-06-17 06:59</div>
            <div class="timeline-body"><p>I always use this flag to see the actual changes made by the hooks. Do you think it's useful?</p>
<pre><code class="language-suggestion">pre-commit run --all-files --show-diff-on-failure  # rust and python formatting, markdown and python linting, etc.
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>CONTRIBUTING.md</code>:61 on 2023-06-17 16:07</div>
            <div class="timeline-body"><p>Why remove formatting and testing here?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_dev/src/generate_json_schema.rs</code>:66 on 2023-06-17 16:08</div>
            <div class="timeline-body"><p>Nit: <code>env::var(&quot;RUFF_UPDATE_SCHEMA&quot;).as_ref() == Ok(&quot;1&quot;)</code> (no need to allocate)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>CONTRIBUTING.md</code>:48 on 2023-06-17 16:09</div>
            <div class="timeline-body"><p>Maybe: &quot;And <a href="https://pre-commit.com/#installation"><code>pre-commit</code> </a>, to run some validation checks:&quot;</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> approved on 2023-06-17 16:09</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2023-06-17 19:01</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>CONTRIBUTING.md</code>:61 on 2023-06-17 19:01</div>
            <div class="timeline-body"><p>formatting is done by pre-commit, testing just moved below clippy</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2023-06-18 10:49</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>CONTRIBUTING.md</code>:68 on 2023-06-18 10:49</div>
            <div class="timeline-body"><p>this is neat, thanks</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @konstin on 2023-06-18 11:00</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @konstin on 2023-06-18 11:00</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2023-06-18 11:00</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 16:58:09 UTC
    </footer>
</body>
</html>
