<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[ty] Detect enums if metaclass is a subtype of EnumType/EnumMeta - astral-sh/ruff #19481</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[ty] Detect enums if metaclass is a subtype of EnumType/EnumMeta</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/19481">#19481</a>
        opened by <a href="https://github.com/sharkdp">@sharkdp</a>
        on 2025-07-22 09:08
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-07-22 09:08</div>
            <div class="timeline-body"><h2>Summary</h2>
<p>This PR implements the following section from the <a href="https://typing.python.org/en/latest/spec/enums.html#enum-definition">typing spec on enums</a>:</p>
<blockquote>
<p>Enum classes can also be defined using a subclass of <code>enum.Enum</code> <strong>or any class that uses <code>enum.EnumType</code> (or a subclass thereof) as a metaclass</strong>. Note that <code>enum.EnumType</code> was named <code>enum.EnumMeta</code> prior to Python 3.11.</p>
</blockquote>
<p>part of https://github.com/astral-sh/ty/issues/183</p>
<h2>Test Plan</h2>
<p>New Markdown tests</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ty</span> added by @sharkdp on 2025-07-22 09:08</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-07-22 09:12</div>
            <div class="timeline-body"><!-- generated-comment mypy_primer -->

<h2><code>mypy_primer</code> results</h2>
<p>No ecosystem changes detected ✅</p>
<details>
<summary>Memory usage changes were detected when running on open source projects</summary>

<pre><code class="language-diff">sphinx (https://github.com/sphinx-doc/sphinx)
-     memo metadata = ~36MB
+     memo metadata = ~38MB

</code></pre>
</details>

</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @sharkdp on 2025-07-22 10:00</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @sharkdp on 2025-07-22 10:00</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @AlexWaygood by @sharkdp on 2025-07-22 10:00</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @dcreager by @sharkdp on 2025-07-22 10:00</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-07-22 12:02</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_python_semantic/src/types/class.rs</code>:3470 on 2025-07-22 12:02</div>
            <div class="timeline-body"><p>it's still aliased as <code>EnumMeta</code> on later versions, too, for backwards compatibility -- this is Python 3.13:</p>
<pre><code class="language-pycon">&gt;&gt;&gt; import enum
&gt;&gt;&gt; enum.EnumMeta
&lt;class 'enum.EnumType'&gt;
</code></pre>
<p>and typeshed calls it <code>EnumMeta</code> on all Python versions: https://github.com/python/typeshed/blob/ddd8434a42b83923b770450386ee12672ab3c604/stdlib/enum.pyi#L92</p>
<pre><code class="language-suggestion">            &quot;EnumMeta&quot; =&gt; {
                Self::EnumType
            }
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-07-22 12:09</div>
            <div class="timeline-body"><blockquote>
<p>This PR implements the following section from the <a href="https://typing.python.org/en/latest/spec/enums.html#enum-definition">typing spec on enums</a>:</p>
<blockquote>
<p>Enum classes can also be defined using a subclass of <code>enum.Enum</code> <strong>or any class that uses <code>enum.EnumType</code> (or a subclass thereof) as a metaclass</strong>. Note that <code>enum.EnumType</code> was named <code>enum.EnumMeta</code> prior to Python 3.11.</p>
</blockquote>
</blockquote>
<p>I'm surprised the spec includes this language. It's somewhat imprecise.</p>
<p>It's true that any class that uses <code>EnumType</code> as its metaclass will have some enum-like properties:</p>
<pre><code class="language-pycon">&gt;&gt;&gt; from enum import EnumMeta
&gt;&gt;&gt; class CustomEnumType(EnumMeta): ...
...
&gt;&gt;&gt; class CustomEnumBase(metaclass=CustomEnumType): ...
... 
&gt;&gt;&gt; class Color(CustomEnumBase):
...     RED = 1
...     GREEN = 2
...     BLUE = 3
...     
&gt;&gt;&gt; list(Color)
[&lt;Color.RED: 1&gt;, &lt;Color.GREEN: 2&gt;, &lt;Color.BLUE: 3&gt;]
&gt;&gt;&gt; Color.__members__
mappingproxy({'RED': &lt;Color.RED: 1&gt;, 'GREEN': &lt;Color.GREEN: 2&gt;, 'BLUE': &lt;Color.BLUE: 3&gt;})
&gt;&gt;&gt; Color.RED
&lt;Color.RED: 1&gt;
&gt;&gt;&gt; Color(1)
&lt;Color.RED: 1&gt;
&gt;&gt;&gt; Color[&quot;RED&quot;]
&lt;Color.RED: 1&gt;
</code></pre>
<p>but they will also be unlike enum classes in many ways because of the fact that <code>Enum</code> is not present in their respective MROs:</p>
<pre><code class="language-pycon">&gt;&gt;&gt; Color.RED.name
Traceback (most recent call last):
  File &quot;&lt;python-input-14&gt;&quot;, line 1, in &lt;module&gt;
    Color.RED.name
AttributeError: 'Color' object has no attribute 'name'
&gt;&gt;&gt; Color.RED.value
Traceback (most recent call last):
  File &quot;&lt;python-input-15&gt;&quot;, line 1, in &lt;module&gt;
    Color.RED.value
AttributeError: 'Color' object has no attribute 'value'
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-07-22 12:16</div>
            <div class="timeline-body"><blockquote>
<p>I'm surprised the spec includes this language. It's somewhat imprecise.</p>
</blockquote>
<p>Ok, but do you think we are modeling things wrong here? We do not pretend that <code>.name</code> or <code>.value</code> exist on members of these classes (accessing them does lead to a <code>unresolved-attribute</code> diagnostic; I now added a test to show that).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-07-22 12:25</div>
            <div class="timeline-body"><blockquote>
<p>Ok, but do you think we are modeling things wrong here? We do not pretend that <code>.name</code> or <code>.value</code> exist on members of these classes (accessing them would lead to a <code>unresolved-attribute</code> diagnostic).</p>
</blockquote>
<p>I'm not sure... I can't immediately find any other behaviour differences between these &quot;enum-like&quot; classes and &quot;proper <code>Enum</code> subclasses&quot;, but there's a lot of complexity in <a href="https://github.com/python/cpython/blob/aafbdb5df5439adc1106ced068cf87683ae68b9e/Lib/enum.py#L1128-L1349">the definition</a> of <code>enum.Enum</code> at runtime, so I'd honestly be quite surprised if there weren't other subtle behaviour differences between these enum-like classes and <code>Enum</code> subclasses. What they are exactly, I'm not sure -- the <code>enum.py</code> source code is very complex -- but all that code in the <code>Enum</code> class definition has to exist for a reason...</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/erictraut">@erictraut</a> on 2025-07-22 15:39</div>
            <div class="timeline-body"><p>I agree with Alex that a class that uses the <code>EnumType</code> metaclass but does not derive from <code>Enum</code> is likely to be an odd duck — having some properties of an <code>Enum</code> but differing from a real <code>Enum</code> in subtle ways. More like a platypus.</p>
<p>Pyright's logic looks for a metaclass that derives from <code>EnumType</code>, but I don't think I've ever seen a custom enum-like class that uses the <code>EnumType</code> metaclass but doesn't derive from <code>Enum</code>, so it's probably fine to just look for <code>Enum</code> in the MRO.</p>
<p>I wrote the enum chapter in the typing spec, so the quote above comes from me. We could update the spec to eliminate the mention of EnumMeta and EnumType.</p>
<p>I did some spelunking to see who requested that pyright support <code>EnumType</code>, and it turns out that it was ... me. Here's the original <a href="https://github.com/microsoft/pyright/issues/7024">issue</a>. IIRC, I created this issue after running across some other forum post or issue tracker question, but I unfortunately can't find the source now.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-07-22 15:44</div>
            <div class="timeline-body"><blockquote>
<p>Pyright's logic looks for a metaclass that derives from <code>EnumType</code>, but I don't think I've ever seen a custom enum-like class that uses the <code>EnumType</code> metaclass but doesn't derive from <code>Enum</code>, so it's probably fine to just look for <code>Enum</code> in the MRO.</p>
</blockquote>
<p>FWIW, I found <a href="https://github.com/graphql-python/graphene/blob/82903263080b3b7f22c2ad84319584d7a3b1a1f6/graphene/types/enum.py#L76">this class</a> in the wild, which does not appear to have <code>enum.Enum</code> in its MRO. And here's a <a href="https://github.com/phasehq/console/blob/476e11b52948bc4ae5c8b86ec43bf4b01adac642/backend/ee/billing/graphene/types.py#L1-L6">usage site</a> of said <code>graphene.Enum</code> class.</p>
<p>Edit: Oh, that class doesn't actually have a metaclass that derives from <code>typing.EnumMeta</code>. <code>EnumMeta</code> references a custom class in that example.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-07-22 15:59</div>
            <div class="timeline-body"><p>yeah, that project looks like it's doing a <em>lot</em> of metaprogramming, and I think it's reasonable to declare it out of scope for ty (look at these customized class <code>__repr__</code>s in the MRO here!).</p>
<p>This session was run after cloning https://github.com/phasehq/console locally, <code>cd</code>-ing into the <code>backend</code> directory, creating a virtual environment, then running <code>uv pip install -r requirements.txt</code> and <code>uv pip install -r dev-requirements.txt</code>:</p>
<pre><code class="language-pycon">&gt;&gt;&gt; from ee.billing.graphene.types import PlanTypeEnum
&gt;&gt;&gt; PlanTypeEnum.__mro__
(&lt;PlanTypeEnum meta=&lt;EnumOptions name='PlanTypeEnum'&gt;&gt;, &lt;Enum meta=None&gt;, &lt;class 'graphene.types.unmountedtype.UnmountedType'&gt;, &lt;class 'graphene.utils.orderedtype.OrderedType'&gt;, &lt;BaseType meta=None&gt;, &lt;SubclassWithMeta meta=None&gt;, &lt;class 'object'&gt;)
&gt;&gt;&gt; type(PlanTypeEnum)
&lt;class 'graphene.types.enum.EnumMeta'&gt;
&gt;&gt;&gt; _.__mro__
(&lt;class 'graphene.types.enum.EnumMeta'&gt;, &lt;class 'graphene.utils.subclass_with_meta.SubclassWithMeta_Meta'&gt;, &lt;class 'type'&gt;, &lt;class 'object'&gt;)
</code></pre>
<p>My inclination would be to adjust the wording of the spec here, as @erictraut suggests, so that we do not have to provide support for enum-like classes that do not inherit from <code>Enum</code>. I think it's going to significantly complicate our ability to reason about what Python enums do if at every point where we add special behaviour for enum classes, we have to check whether the same behaviour applies for classes that have <code>EnumType</code> as their metaclass but do not inherit from <code>Enum</code>. As far as I know, this is not something the runtime <code>enum</code> module has ever deliberately supported (or documented support for).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-07-22 16:01</div>
            <div class="timeline-body"><p>(If we receive an actual request from a user asking for us to support this pattern, then that's a different question, of course. But until we get to that point, I'm inclined to stick to uses of the <code>enum</code> module that are documented and supported by the standard library.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-07-22 16:03</div>
            <div class="timeline-body"><p>As a final note here before I close this:</p>
<ol>
<li>It's currently part of the spec; but I understand that we're open to changing the spec</li>
<li>All other type checkers that I tested support this pattern (pyright, as you mentioned, but also mypy and pyrefly)</li>
<li>This seems to model well what happens at runtime (accessing members on these classes creates singleton objects)</li>
<li>We haven't seen any actual cases of where this leads to problems</li>
</ol>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-07-22 17:02</div>
            <div class="timeline-body"><p>This PR already exists and IMO does no harm. I think we should merge it and offer best-effort support that roughly matches what other type checkers offer and what the spec says, rather than letting the perfect be the enemy of the good and insisting that if we can't precisely model every detail of these &quot;platypus&quot; types correctly, we shouldn't support them at all.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> approved on 2025-07-22 17:05</div>
            <div class="timeline-body"><p>This looks good to me; the implementation is extremely simple and easy enough to modify later. When in doubt, I think we should prefer compatibility with the behavior of other type checkers.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-07-23 06:46</div>
            <div class="timeline-body"><p>Merging this for now. If someone has additional comments, let me know and I can adapt/revert.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @sharkdp on 2025-07-23 06:46</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @sharkdp on 2025-07-23 06:46</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-07-23 06:46</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 17:58:39 UTC
    </footer>
</body>
</html>
