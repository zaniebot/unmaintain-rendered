<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[ty] Respect notebook cell boundaries when adding an auto import - astral-sh/ruff #21322</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[ty] Respect notebook cell boundaries when adding an auto import</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/21322">#21322</a>
        opened by <a href="https://github.com/MichaReiser">@MichaReiser</a>
        on 2025-11-07 18:02
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a></div>
            <div class="timeline-body"><h2>Summary</h2>
<p>The text edits for auto-completion are constrained to within the same document (because there's only a range but no URI field). Given that the LSP represents each cell as a separate document, this means that auto import edits must be limited to the same cell (we can't change an import from another cell or add an import to the first cell).</p>
<p>This PR does just that.</p>
<h2>Test plan</h2>
<p>Added e2e tests</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @MichaReiser on 2025-11-07 18:02</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @sharkdp by @MichaReiser on 2025-11-07 18:02</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @dcreager by @MichaReiser on 2025-11-07 18:02</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @AlexWaygood by @MichaReiser on 2025-11-07 18:02</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Converted to draft by @MichaReiser on 2025-11-07 18:02</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">server</span> added by @MichaReiser on 2025-11-07 18:02</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ty</span> added by @MichaReiser on 2025-11-07 18:02</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-11-07 18:04</div>
            <div class="timeline-body"><!-- generated-comment typing_conformance_diagnostics_diff -->

<h2>Diagnostic diff on <a href="https://github.com/python/typing/tree/9f6d8ced7cd1c8d92687a4e9c96d7716452e471e/conformance">typing conformance tests</a></h2>
<p>No changes detected when running ty on typing conformance tests ✅</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-11-07 18:05</div>
            <div class="timeline-body"><!-- generated-comment mypy_primer -->

<h2><code>mypy_primer</code> results</h2>
<p>No ecosystem changes detected ✅</p>
<p>No memory usage changes detected ✅</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @MichaReiser on 2025-11-07 21:19</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @dhruvmanila by @MichaReiser on 2025-11-07 21:19</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for @dcreager removed by @MichaReiser on 2025-11-07 21:19</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for @carljm removed by @MichaReiser on 2025-11-07 21:19</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for @sharkdp removed by @MichaReiser on 2025-11-07 21:19</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for @AlexWaygood removed by @MichaReiser on 2025-11-07 21:19</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @BurntSushi by @MichaReiser on 2025-11-07 21:19</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-11-07 21:34</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Gankra">@Gankra</a> reviewed on 2025-11-08 00:35</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/Gankra">@Gankra</a> on <code>.config/nextest.toml</code>:13 on 2025-11-08 00:35</div>
            <div class="timeline-body"><p>Was this intended to be checked in?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Gankra">@Gankra</a> approved on 2025-11-08 00:37</div>
            <div class="timeline-body"><p>Interesting, when we were talking about it before I had convinced myself this would fall out more naturally from treating the cells as separate files, but I guess we're (reasonably) treating the notebooks as one file still.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ruff_python_importer/src/insertion.rs</code>:51 on 2025-11-10 14:08</div>
            <div class="timeline-body"><p>Could you add something to the docs here saying something about <code>within_range</code> and what it's for?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> approved on 2025-11-10 14:13</div>
            <div class="timeline-body"><p>Makes sense to me!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-11-11 11:15</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>.config/nextest.toml</code>:13 on 2025-11-11 11:15</div>
            <div class="timeline-body"><p>Sort of. My hope was that it makes the lsp <code>e2e</code> tests less flaky</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2025-11-12 06:56</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ty_ide/src/importer.rs</code>:156 on 2025-11-12 06:56</div>
            <div class="timeline-body"><p>Yes, this comment is correct. The <code>containing_range</code> will return the cell range that contains this offset.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2025-11-12 07:00</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_notebook/src/cell.rs</code>:317 on 2025-11-12 07:00</div>
            <div class="timeline-body"><p>I'm not exactly sure I follow this - are you saying that if the cell boundary is at <code>range.start</code>, then this method should return <code>false</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-11-13 17:21</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_notebook/src/cell.rs</code>:317 on 2025-11-13 17:21</div>
            <div class="timeline-body"><p>Yes. Otherwise, testing any range from the start of the cell always returns <code>true</code>.</p>
<p>Cell 1:</p>
<pre><code class="language-py">import c
</code></pre>
<p>Cell 2:</p>
<pre><code class="language-py">import os
</code></pre>
<p>When checking the range between <code>import c</code>..<code>import os</code>, then <code>start</code> is before the cell boundary but it ends at the cell boundary. That means, this range contains the cell boundary.</p>
<p>When checking the range <code>import os</code>, then this shouldn't contain the cell boundary because it starts at the cell boundary, but it never crosses the boundary</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @MichaReiser on 2025-11-13 17:58</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @MichaReiser on 2025-11-13 17:58</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-11-13 17:58</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">server</span> removed by @MichaReiser on 2025-11-13 17:58</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">internal</span> added by @MichaReiser on 2025-11-13 17:58</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-11-13 17:58</div>
            <div class="timeline-body"><p>I marked this as internal because notebook support hasn't shipped yet. So this isn't a user visible change</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:17:02 UTC
    </footer>
</body>
</html>
