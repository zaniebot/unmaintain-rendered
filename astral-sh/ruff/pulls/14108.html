<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[red-knot] Introduce a new `ClassLiteralType` struct - astral-sh/ruff #14108</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[red-knot] Introduce a new <code>ClassLiteralType</code> struct</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/14108">#14108</a>
        opened by <a href="https://github.com/AlexWaygood">@AlexWaygood</a>
        on 2024-11-05 13:43
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a></div>
            <div class="timeline-body">Summary
<p>The struct on <code>main</code> called <code>ClassType</code> does not actually represent a type. It represents inner data for a type -- but exactly how the data should be interpreted depends on what kind of type is wrapping the inner data. <code>Type::ClassLiteral()</code> and <code>Type::Instance()</code> both wrap the struct-currently-known-as-ClassType, but they&#x27;re very different kinds of types: the first is a singleton type representing a single class object at runtime, whereas the second represents a type of unknown size representing all (possible) instances of a single class object at runtime.</p>
<p>To clarify the situation here, this PR renames the class-currently-known-as-ClassType to <code>Class</code>. This reflects better the fact that it represents data representing a class object at runtime, but does not in itself represent a type. In the refactor that this PR proposes, we now have two <code>*Type</code> structs that wrap <code>Class</code>: <code>InstanceType</code> and <code>ClassLiteralType</code>. The <code>Type::ClassLiteral</code> enum variant wraps <code>ClassLiteralType</code> instead of wrapping <code>Class</code> directly.</p>
<p>This refactor allows us to pass around objects that unambiguously represent specific types without having to wrap the objects in variants the <code>Type</code> enum. In particular, the signatures of <code>perform_rich_comparison</code> and <code>perform_membership_test_comparison</code> become much more expressive and type-safe.</p>
Test Plan
<p><code>cargo test -p red_knot_python_semantic</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-11-05 13:43</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/carljm">@carljm</a> by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-11-05 13:43</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/MichaReiser">@MichaReiser</a> by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-11-05 13:43</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/sharkdp">@sharkdp</a> by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-11-05 13:43</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:2098 on 2024-11-05 13:46</div>
            <div class="timeline-body"><p>I&#x27;m glad I tried to writeup some docs here, as it made me realise that <code>InstanceType</code> types can now represent two pretty different things, depending on whether the <code>known</code> field is <code>Some()</code> or <code>None</code>. I&#x27;m not sure that&#x27;s really desirable; we might consider having a separate <code>Type::KnownInstance</code> variant on <code>Type</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:3779 on 2024-11-05 13:48</div>
            <div class="timeline-body"><p>I had to split up <code>infer_type_expression</code> into two methods, <code>infer_type_expression</code> and <code>infer_type_expression_impl</code>, or <code>cargo fmt</code> insisted on increasing the indentation of the huge <code>match</code> statement in <code>infer_type_expression</code> with my changes here. I didn&#x27;t want a huge diff in this PR, and I also didn&#x27;t think the extra indentation was desirable in and of itself, so I split the method into two.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-11-05 13:48</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-11-05 13:50</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:312 on 2024-11-05 13:50</div>
            <div class="timeline-body"><p>I moved this down a little bit so that the three dynamic variants (<code>Any</code>, <code>Unknown</code> and <code>Todo</code>) were together at the top.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-11-05 13:55</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:3779 on 2024-11-05 13:55</div>
            <div class="timeline-body"><p>Oh, and now I see @sharkdp does a very similar thing in <a href="https://github.com/astral-sh/ruff/pull/14106">astral-sh/ruff#14106</a>/files#r1829286623. Let&#x27;s merge his PR first; I can rebase this on top.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2024-11-05 13:57</div>
            <div class="timeline-body">

<code>ruff-ecosystem</code> results
Linter (stable)
<p>‚úÖ ecosystem check detected no linter changes.</p>
Linter (preview)
<p>‚úÖ ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2024-11-05 14:01</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:365 on 2024-11-05 14:01</div>
            <div class="timeline-body"><p>Maybe name this consistently (similar for module/function) to match the names of <code>expect_class_literal</code> and <code>is_class_literal</code>?</p>
<pre><code>    pub const fn into_class_literal(self) -&gt; Option&lt;ClassLiteralType&lt;&#x27;db&gt;&gt; {
</code></pre>
<p>Or the other way around (add <code>_type</code> suffix consistently)?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:2121 on 2024-11-05 14:07</div>
            <div class="timeline-body"><p>Minor: the name <code>to_‚Ä¶</code> might suggest that instance types are more or less equivalent to class literal types, since they can be converted so easily(?). Maybe something like</p>
<pre><code>    pub fn corresponding_class_literal_type(self) -&gt; ClassLiteralType&lt;&#x27;db&gt; {
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2024-11-05 14:07</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-11-05 14:10</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:365 on 2024-11-05 14:10</div>
            <div class="timeline-body"><p>Removed all <code>*_type</code> suffixes in <a href="https://github.com/astral-sh/ruff/pull/14108">astral-sh/ruff#14108</a>/commits/a97d183e7cb5a458f288e7ce53bd4b54e8ebb329 üëç</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> approved on 2024-11-05 14:16</div>
            <div class="timeline-body"><p>Thank you, this looks good to me. It&#x27;s slightly more verbose now in some places, but more consistent, safe and less verbose in places where it matters.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-11-05 14:17</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:2121 on 2024-11-05 14:17</div>
            <div class="timeline-body"><p>I was very unsure whether this method and <code>ClassLiteralType::to_instance_type</code> were more helpful than they were confusing. Your comment here convinces me that they&#x27;re on the &quot;more confusing&quot; side of the line üòÜ</p>
<p>I removed them in <a href="https://github.com/astral-sh/ruff/pull/14108">astral-sh/ruff#14108</a>/commits/22d7a3b0802f31f591fff52e31f7b9f44a3b2841, in favour of a <code>Type::anonymous_instance</code> helper function.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2024-11-05 16:59</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:1272 on 2024-11-05 17:18</div>
            <div class="timeline-body"><p>Just occurred to me that we should probably add a TODO comment here, because this is actually not quite right (predating this PR).</p>
<p>The correct meta type of an Instance type would be a <code>type[]</code> type that includes subclasses, not a class literal type.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:2090 on 2024-11-05 17:22</div>
            <div class="timeline-body"><p>nit: I don&#x27;t think &quot;compare and hash&quot; are really the behaviors that matter most here? I would write this in terms of type semantics.</p>
<pre><code>/// Some specific instances of some types need to be treated specially by the type system; for example, various special forms are instances of `typing._SpecialForm`, but need to be handled differently in annotations.
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:2098 on 2024-11-05 17:24</div>
            <div class="timeline-body"><p>I agree. I also realized that we are now handling known instances wrongly at least in <code>Type::is_equivalent_to</code> and likely in other <code>Type</code> methods as well.</p>
<p>Although it was convenient to be able to ignore the <code>known</code> field when unpacking a <code>Type::Instance</code>, I think it makes it too easy to do the wrong thing.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> approved on 2024-11-05 17:27</div>
            <div class="timeline-body"><p>Looks great, thank you!!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-11-05 17:32</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:2090 on 2024-11-05 17:32</div>
            <div class="timeline-body"><p>Yes, thank you! It was thinking through the &quot;oh wait... two <code>InstanceType</code>s with the same class now compare and hash differently if one is a known instance and the other is not?&quot; question that made me realise how uncomfortable I was with the new idiom. But that&#x27;s a facet of our implementation rather than an aspect of what the type <em>represents</em>, of course.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:1272 on 2024-11-05 17:41</div>
            <div class="timeline-body"><p>And worth noting that our choice to invest in improved naming of types is what brought this subtle issue to my attention!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2024-11-05 17:41</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2024-11-05 17:51</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:2098 on 2024-11-05 17:51</div>
            <div class="timeline-body"><p>https://github.com/astral-sh/ruff/issues/14114</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-11-05 22:16</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-11-05 22:16</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:08:07 UTC
    </footer>
</body>
</html>
