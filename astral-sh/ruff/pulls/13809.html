<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[red-knot] Autoformat `mdtest` Python snippets using `blacken-docs` - astral-sh/ruff #13809</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[red-knot] Autoformat <code>mdtest</code> Python snippets using <code>blacken-docs</code></h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/13809">#13809</a>
        opened by <a href="https://github.com/AlexWaygood">@AlexWaygood</a>
        on 2024-10-18 10:30
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a></div>
            <div class="timeline-body"><h2>Summary</h2>
<p>This PR adds a <code>blacken-docs</code> hook to our <code>.pre-commit-config.yaml</code> so that we can easily autoformat all Python code snippets in our <code>mdtest</code> Markdown files <em>en masse</em>. Since we run pre-commit in CI, this will also enforce a consistent style for these Python snippets in CI. The first commit adds the hook to the pre-commit config file; the second commit is the effect of running <code>pre-commit run -a</code> locally with this configuration.</p>
<p>Although Ruff is able to format Python code snippets in docstrings, it doesn't seem like it's yet capable of formatting Python code snippets in <em>Markdown files</em>, so it seems like blacken-docs is the best option here for now.</p>
<p>I went with <code>--line-length=1000</code>, because the assertion comments in our test files can get quite long, and it seems more annoying than helpful if autoformatting results in changes such as</p>
<pre><code class="language-diff">- x = a  # error: some verrrrrrrrrrrrrrrrrry verbosssssssssssse error messageeeeeeeeeeee
+ x = (
+     a # error: some verrrrrrrrrrrrrrrrrry verbosssssssssssse error messageeeeeeeeeeee
+ )
</code></pre>
<h2>Test Plan</h2>
<p><code>pre-commit run -a</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by @AlexWaygood on 2024-10-18 10:30</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @AlexWaygood on 2024-10-18 10:30</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @AlexWaygood on 2024-10-18 10:30</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-10-18 10:31</div>
            <div class="timeline-body"><p>Cc. @sharkdp as well, for interest :-)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-10-18 10:34</div>
            <div class="timeline-body"><p>Nice but.... that would force me to use pre-commit which I rather don't. But not sure how we can accomplish this today without pre-commit.</p>
<p>I also think that a line length of 1000 is too high. How about something more realistic like 120? What I remember is that
<code>revealed</code> and <code>expected</code> can be used as own line comments. I would argue that that's probably a better style for very long diagnostics.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-10-18 10:35</div>
            <div class="timeline-body"><p>A line length of 1000 is actually problematic because Black then collapses expressions onto a single line. E.g. long comprehensions or binary expressions would be printed on a single line.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-10-18 10:38</div>
            <div class="timeline-body"><p>I wonder if we should integrate this into the <code>mdtest</code> framework instead where setting an environment variable formats the snippets and files that are not correctly formatted fail otherwise (that seems somewhat annoying)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-10-18 10:39</div>
            <div class="timeline-body"><blockquote>
<p>Nice but.... that would force me to use pre-commit which I rather don't. But not sure how we can accomplish this today without pre-commit.</p>
</blockquote>
<p>You can also run blacken-docs manually. Pre-commit makes the experience much nicer IMO, but there's some docs <a href="https://github.com/adamchainz/blacken-docs?tab=readme-ov-file#usage">here</a> on how to manually run it.</p>
<p>We already do nearly all our other linting (typos-checking, Markdown checking, etc.) via pre-commit in this repo, so I'd personally prefer to stick to that here.</p>
<blockquote>
<p>I also think that a line length of 1000 is too high. How about something more realistic like 120? What I remember is that
<code>revealed</code> and <code>expected</code> can be used as own line comments. I would argue that that's probably a better style for very long diagnostics.</p>
</blockquote>
<p>Yeah, that's a fair point. I'll switch to 130, for no other reason than it's what typeshed uses, and I like the formatting of typeshed's stubs ðŸ˜„</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-10-18 10:40</div>
            <div class="timeline-body"><blockquote>
<p>I wonder if we should integrate this into the <code>mdtest</code> framework instead where setting an environment variable formats the snippets and files that are not correctly formatted fail otherwise (that seems somewhat annoying)</p>
</blockquote>
<p>I would <em>much</em> prefer to be able to easily autoformat all the files with a single command. And this also feels like a linting issue than something that should cause the <em>tests</em> to fail, to me</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2024-10-18 10:45</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>âœ… ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>âœ… ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-10-18 10:49</div>
            <div class="timeline-body"><p>(To elaborate on how <em>I</em> use pre-commit, in case it's helpful: I don't much like installing git hooks locally. I actually never set them up; I never run <code>pre-commit install</code> in a repo locally. I <em>only</em> ever use pre-commit as a command runner. But for the purpose of orchestrating various linting tools and running them over a codebase, it's pretty nice IMO. Just because it <em>can</em> be used as a way of coordinating git hooks that run on every commit, doesn't mean that that's the way you <em>have</em> to use it.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-10-18 10:58</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/resources/mdtest/literal/string.md</code>:16 on 2024-10-18 10:58</div>
            <div class="timeline-body"><p>here we're not testing what we wanted to test anymore</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/calumy">@calumy</a> on 2024-10-18 11:07</div>
            <div class="timeline-body"><p>Out of curiosity, is there any particular reason for using black to format rather than the ruff formatter, which is how the ruff docs are formatted (https://github.com/astral-sh/ruff/blob/main/scripts/check_docs_formatted.py#L147C1-L176C23)?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-10-18 11:09</div>
            <div class="timeline-body"><blockquote>
<p>Out of curiosity, is there any particular reason for using black to format rather than the ruff formatter, which is how the ruff docs are formatted (<a href="https://github.com/astral-sh/ruff/blob/main/scripts/check_docs_formatted.py?rgh-link-date=2024-10-18T11%3A07%3A08Z#L147C1-L176C23"><code>main</code>/scripts/check_docs_formatted.py#L147C1-L176C23</a>)?</p>
</blockquote>
<p>The <code>check_docs_formatted.py</code> script will <em>check</em> that the docs are formatted and complain if they aren't, but it won't actually format them for you. That feels like the opposite of what I want for mdtest :-)</p>
<p>I want something that's going to make my life easier (by making it easy to apply a consistent style across these Markdown files, using only a single CLI command). If <code>check_docs_formatted.py</code> complains at me about things being badly formatted but doesn't actually <em>fix</em> things for me, that feels like it makes my life harder, not easier.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-10-18 11:13</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/resources/mdtest/literal/string.md</code>:16 on 2024-10-18 11:13</div>
            <div class="timeline-body"><p>I fixed this with a judicious use of <code># fmt: skip</code>. Don't tell @JelleZijlstra.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-10-18 11:24</div>
            <div class="timeline-body"><blockquote>
<p>We already do nearly all our other linting (typos-checking, Markdown checking, etc.) via pre-commit in this repo, so I'd personally prefer to stick to that here.</p>
</blockquote>
<p>Yes, we use pre-commit to check consistent styling in CI. But it's not a tool required when developing locally (or only very rarely and I then often have to run it multiple times which I don't understand why).</p>
<blockquote>
<p>You can also run blacken-docs manually. Pre-commit makes the experience much nicer IMO, but there's some docs <a href="https://github.com/adamchainz/blacken-docs?tab=readme-ov-file#usage">here</a> on how to manually run it.</p>
</blockquote>
<p>What's nice about Rust is that you can check out any project and you know how to run, test, and format it. Requiring users to figure out how to install a python tool and figure out the right pattern seems too much to ask (yes, uvx makes that easier).</p>
<p>That's why I still think an integration into <code>mdtest</code> is the better solution because the framework can print a useful message telling you that there are incorrectly formatted tests at the end of the run (as the last check) and suggest the command how you can update it, without any extra dependencies. <code>mdtest</code> can also use ruff's formatter</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-10-18 11:34</div>
            <div class="timeline-body"><blockquote>
<p>Yes, we use pre-commit to check consistent styling in CI. But it's not a tool required when developing locally (or only very rarely</p>
</blockquote>
<p>Actually, I've found that our existing pre-commit hooks for Markdown linting have had complaints about the initial revision of nearly every red-knot PR I've submitted using mdtest ðŸ˜† So the situation you describe here has arguably already changed recently, whether for better or worse</p>
<blockquote>
<p>I then often have to run it multiple times which I don't understand why</p>
</blockquote>
<p>It generally stops after a single hook fails, so that you can then evaluate the changes that the hook might have made to your code before deciding whether you want to proceed. I agree that this is a bit annoying sometimes.</p>
<blockquote>
<p>What's nice about Rust is that you can check out any project and you know how to run, test, and format it. Requiring users to figure out how to install a python tool and figure out the right pattern seems too much to ask (yes, uvx makes that easier).</p>
</blockquote>
<p>I would say a common convention in a Python project is that you can run all the linting tools using <code>pre-commit run -a</code> ðŸ˜„</p>
<p>And again, this is an existing problem on <code>main</code>. We should re-evaluate our existing pre-commit hooks if you have this concern; they're already quite picky about Markdown styling, and we have many more Markdown files now than we used to.</p>
<blockquote>
<p>That's why I still think an integration into <code>mdtest</code> is the better solution because the framework can print a useful message telling you that there are incorrectly formatted tests at the end of the run (as the last check) and suggest the command how you can update it, without any extra dependencies. <code>mdtest</code> can also use ruff's formatter</p>
</blockquote>
<p>It still feels &quot;wrong&quot; to me for the test framework to fail because of a linting error. To use your analogy of how nice it is that Cargo can generally manage everything for you in a typical Rust project, the result of <code>cargo test</code> is wholly independent from whether or not <code>cargo fmt</code> is going to reformat your code or not. They're fully separate concerns.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-10-18 11:50</div>
            <div class="timeline-body"><blockquote>
<p>Actually, I've found that our existing pre-commit hooks for Markdown linting have had complaints about the initial revision of nearly every red-knot PR I've submitted using mdtest ðŸ˜† So the situation you describe here has arguably already changed recently, whether for better or worse</p>
</blockquote>
<p>Uhh true. I wasn't aware of this</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-10-18 12:25</div>
            <div class="timeline-body"><blockquote>
<blockquote>
<p>I then often have to run it multiple times which I don't understand why</p>
</blockquote>
<p>It generally stops after a single hook fails, so that you can then evaluate the changes that the hook might have made to your code before deciding whether you want to proceed. I agree that this is a bit annoying sometimes.</p>
</blockquote>
<p>I don't think I have this problem in other repos that use pre-commit. I think it's because of a specific setting in our pre-commit config. I filed https://github.com/astral-sh/ruff/pull/13811 to fix it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/calumy">@calumy</a> on 2024-10-18 12:52</div>
            <div class="timeline-body"><blockquote>
<blockquote>
<p>Out of curiosity, is there any particular reason for using black to format rather than the ruff formatter, which is how the ruff docs are formatted (<a href="https://github.com/astral-sh/ruff/blob/main/scripts/check_docs_formatted.py?rgh-link-date=2024-10-18T11%3A07%3A08Z#L147C1-L176C23"><code>main</code>/scripts/check_docs_formatted.py#L147C1-L176C23</a>)?</p>
</blockquote>
<p>The <code>check_docs_formatted.py</code> script will <em>check</em> that the docs are formatted and complain if they aren't, but it won't actually format them for you. That feels like the opposite of what I want for mdtest :-)</p>
<p>I want something that's going to make my life easier (by making it easy to apply a consistent style across these Markdown files, using only a single CLI command). If <code>check_docs_formatted.py</code> complains at me about things being badly formatted but doesn't actually <em>fix</em> things for me, that feels like it makes my life harder, not easier.</p>
</blockquote>
<p>Understood. So if there were &quot;ruffen-docs&quot;, it would be preferred, but as this doesn't exist (as far as I'm aware), then <code>blacken-docs</code> is a good substitute?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-10-18 12:53</div>
            <div class="timeline-body"><blockquote>
<p>Understood. So if there were &quot;ruffen-docs&quot;, it would be preferred, but as this doesn't exist (as far as I'm aware), then <code>blacken-docs</code> is a good substitute?</p>
</blockquote>
<p>Yup!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/JelleZijlstra">@JelleZijlstra</a> reviewed on 2024-10-18 14:03</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/JelleZijlstra">@JelleZijlstra</a> on <code>crates/red_knot_python_semantic/resources/mdtest/literal/string.md</code>:16 on 2024-10-18 14:03</div>
            <div class="timeline-body"><p>Then don't mention me :) If you're ever going to use <code>fmt: skip</code> this seems like the best reason.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-10-18 14:26</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/resources/mdtest/literal/string.md</code>:16 on 2024-10-18 14:26</div>
            <div class="timeline-body"><blockquote>
<p>Then don't mention me :)</p>
</blockquote>
<p>hehe, sorry, that was an attempt at a joke ðŸ˜„</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-10-18 14:58</div>
            <div class="timeline-body"><p>I'll submit to the pre-commit torture, considering that this PR doesn't make it worse. We can re-visit if we decide to use a different mechanism to format our markdown file.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-10-18 15:04</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>.pre-commit-config.yaml</code>:52 on 2024-10-18 15:04</div>
            <div class="timeline-body"><p>Can you put this config somewhere else so you can run the command outside pre-commit?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>.pre-commit-config.yaml</code>:52 on 2024-10-18 16:27</div>
            <div class="timeline-body"><p>I don't know if this is possible (and if not, it's not a blocker), but if it is, I like the idea.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/resources/mdtest/assignment/unbound.md</code>:17 on 2024-10-18 16:28</div>
            <div class="timeline-body"><p>I find the extra vertical spacing more of a negative than a positive in these tests, but it's not a big negative, and I'm OK with it for the sake of consistent formatting.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/resources/mdtest/shadowing/class.md</code>:6 on 2024-10-18 16:33</div>
            <div class="timeline-body"><p>I didn't realize Black preferred ellipsis over <code>pass</code>, even in non-stub files?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> approved on 2024-10-18 16:33</div>
            <div class="timeline-body"><p>My only real concern here is how often we'll run into cases where a particular unusual formatting actually matters for what we want to test. I'm thinking of e.g. testing multi-line diagnostic ranges.</p>
<p>But I think using <code># fmt: skip</code> for those cases is a reasonable option, and helps to signal to human readers/editors also that &quot;formatting matters here.&quot;</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-10-18 16:35</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/resources/mdtest/assignment/unbound.md</code>:17 on 2024-10-18 16:35</div>
            <div class="timeline-body"><p>Yeah, same. It would be nice if we could get blacken-docs to think of these as <code>pyi</code> stub files, but not sure if that's possible. I find having an autoformatter for local use and CI more important than the specific formatting decisions it makes ðŸ˜†</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-10-18 16:37</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/resources/mdtest/shadowing/class.md</code>:6 on 2024-10-18 16:37</div>
            <div class="timeline-body"><p>It does not! This change was made manually by me in commit 3 of this PR: &quot;<a href="https://github.com/astral-sh/ruff/pull/13809/commits/adafb79b5c46647e3092153feaa9e14e66dcd6bf">Manual cleanups following autoformatting</a>&quot;.</p>
<p>My motivation for changing the <code>pass</code> to <code>...</code> is that if you use <code>...</code>, Black figures that it's a stub-like class definition, so you probably want stub-like formatting.</p>
<p>(It lets you put the whole class definition on one line with <code>...</code>. If you use <code>pass</code>, it splits it over two lines.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-10-18 16:40</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>.pre-commit-config.yaml</code>:52 on 2024-10-18 16:40</div>
            <div class="timeline-body"><p>blacken-docs does not support persistent configuration, only a very small number of CLI flags that it just forwards on to Black. We could put this configuration in our repo-wide pyproject.toml's <code>tool.black</code> configuration -- but I don't feel like I have context on why we already <em>have</em> a pre-existing Black configuration. I think it's possibly not necessary after @calumy switched <code>check_docs_formatted.py</code> so that it uses Ruff rather than Black. (Thanks again for that PR @calumy!)</p>
<p>If that Black configuration section is now unnecessary, then I think I can just rework it to make it red-knot blacken-docs specific.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/JelleZijlstra">@JelleZijlstra</a> reviewed on 2024-10-18 17:06</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/JelleZijlstra">@JelleZijlstra</a> on <code>crates/red_knot_python_semantic/resources/mdtest/assignment/unbound.md</code>:17 on 2024-10-18 17:06</div>
            <div class="timeline-body"><p>Black does have an option for this (<code>--pyi</code>); not sure if it carries through to blacken-docs.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-10-18 17:34</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>.pre-commit-config.yaml</code>:52 on 2024-10-18 17:34</div>
            <div class="timeline-body"><p>Actually, it seems like even if you have a persistent black configuration in a pyproject.toml file, it's ignored by blacken-docs (because blacken-docs runs black &quot;as a library&quot; rather than running it as a subprocess). So it seems like there's no way to have a persistent configuration for blacken-docs at all.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-10-18 17:34</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/resources/mdtest/assignment/unbound.md</code>:17 on 2024-10-18 17:34</div>
            <div class="timeline-body"><p>Unfortunately it seems like that's not one of the flags supported by blacken-docs, and it seems like it ignores any black configuration files (https://github.com/astral-sh/ruff/pull/13809#discussion_r1806820453)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-10-19 14:56</div>
            <div class="timeline-body"><p>I'm going to land this as-is. The less-than-optimal parts of this are:</p>
<ul>
<li><p>We'd prefer to use our own formatter to format these Python snippets rather than Black. I agree this would be better (dogfooding is good!), but there currently isn't a <code>ruffen-docs</code> equivalent to <code>blacken-docs</code>. (<code>check_docs_formatted.py</code> will <em>check</em> formatting using our formatter, but won't do autofixes, and the capacity to do autofixes to me feels crucial for ease of development.)</p>
</li>
<li><p>We'd prefer for these snippets to be formatted concisely, as if they were stubs. Black has a <code>--pyi</code> flag but it's not possible to pass that flag to <code>blacken-docs</code>. To me, <em>having</em> an autoformatter feels much more important than the specific formatting choices it makes. Possibly we could file a feature request with <code>blacken-docs</code> asking them to add a <code>--pyi</code> flag.</p>
</li>
<li><p>We're not necessarily wild about doing all our linting via pre-commit for this repo: it's not such a popular tool in the Rust ecosystem as it is in the Python ecosystem, it can be slowish, and we don't want to require contributors to have to download another tool if they want to contribute. I agree that in a perfect world we'd use a faster tool that comes builtin with cargo to do our linting, but I'm not sure such a tool exists right now. We already do a bunch of our linting via pre-commit currently, and the existing hooks we have are already very picky about Markdown files, so this PR doesn't change much in this regard.</p>
<p>I'd be happy to review another PR that gets rid of our <code>.pre-commit-config.yaml</code> file in favour of a <code>justfile</code> to coordinate all our linting tools, but that's outside the scope of this PR. (Even if we switched to using <code>just</code> rather than pre-commit, that would also still be a separate tool that we'd require contributors to install, so this wouldn't fully solve the problem.)</p>
</li>
<li><p>We'd prefer for the <code>--line-length=130</code> flag to be set in some kind of persistent configuration outside of the pre-commit config file, so that it's easier for folks to run <code>blacken-docs</code> without having to install pre-commit if that's what they'd prefer. Unfortunately <code>blacken-docs</code> does not read any configuration files directly, and because of the way it runs Black, Black-as-invoked-by-blacken-docs also ignores all <code>[tool.black]</code> configuration files in any <code>pyproject.toml</code> files in the repo. This therefore does not seem possible for now.</p>
</li>
</ul>
<p>Overall, then, lots of issues here and potential for improvement, but I still think the benefits outweigh the costs here. Lots of these things could possibly be improved by us building our own <code>ruffen-docs</code> tool!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @AlexWaygood on 2024-10-19 14:57</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @AlexWaygood on 2024-10-19 14:57</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-10-19 14:57</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:07:04 UTC
    </footer>
</body>
</html>
