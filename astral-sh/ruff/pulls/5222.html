<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Format `StmtTry` - astral-sh/ruff #5222</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Format <code>StmtTry</code></h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/5222">#5222</a>
        opened by <a href="https://github.com/davidszotten">@davidszotten</a>
        on 2023-06-20 18:43
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/davidszotten">@davidszotten</a> on 2023-06-20 18:43</div>
            <div class="timeline-body"><p>Format <code>StmtTry</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">formatter</span> added by @konstin on 2023-06-21 09:05</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2023-06-21 15:17</div>
            <div class="timeline-body"><p>Personally, i find it easier to add fixtures first so i can directly see what my code currently does, with fixtures in the PR it is also easier to give guidance since i can directly see how it currently behaves (I usually run <code>cargo run --bin ruff_python_formatter -- --emit stdout --print-ir --print-comments scratch.py</code> for a specific problem, then copy it to the fixture, run <code>INSTA_UPDATE=always cargo test --package ruff_python_formatter</code> and look at git diff, others like <code>cargo insta review</code>, etc.).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2023-06-21 16:06</div>
            <div class="timeline-body"><h2>PR Check Results</h2>
<h3>Ecosystem</h3>
<p>✅ ecosystem check detected no changes.</p>
<h3>Benchmark</h3>
<h4>Linux</h4>
<pre><code>group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.00      7.8±0.18ms     5.2 MB/sec    1.00      7.8±0.13ms     5.2 MB/sec
formatter/numpy/ctypeslib.py               1.00  1831.3±26.59µs     9.1 MB/sec    1.01  1847.4±28.20µs     9.0 MB/sec
formatter/numpy/globals.py                 1.03    218.3±5.26µs    13.5 MB/sec    1.00    211.2±5.69µs    14.0 MB/sec
formatter/pydantic/types.py                1.04      4.1±0.05ms     6.2 MB/sec    1.00      4.0±0.07ms     6.4 MB/sec
linter/all-rules/large/dataset.py          1.04     16.2±0.32ms     2.5 MB/sec    1.00     15.6±0.28ms     2.6 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.03      4.0±0.05ms     4.1 MB/sec    1.00      3.9±0.07ms     4.3 MB/sec
linter/all-rules/numpy/globals.py          1.02    513.5±4.11µs     5.7 MB/sec    1.00    504.7±4.40µs     5.8 MB/sec
linter/all-rules/pydantic/types.py         1.05      7.2±0.06ms     3.5 MB/sec    1.00      6.9±0.11ms     3.7 MB/sec
linter/default-rules/large/dataset.py      1.10      8.5±0.09ms     4.8 MB/sec    1.00      7.7±0.17ms     5.3 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.08  1825.3±22.12µs     9.1 MB/sec    1.00  1690.6±33.14µs     9.8 MB/sec
linter/default-rules/numpy/globals.py      1.08    203.6±1.46µs    14.5 MB/sec    1.00    189.4±3.12µs    15.6 MB/sec
linter/default-rules/pydantic/types.py     1.09      3.8±0.06ms     6.7 MB/sec    1.00      3.5±0.04ms     7.3 MB/sec
</code></pre>
<h4>Windows</h4>
<pre><code>group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.00      8.1±0.10ms     5.0 MB/sec    1.19      9.6±0.11ms     4.2 MB/sec
formatter/numpy/ctypeslib.py               1.00  1817.4±33.40µs     9.2 MB/sec    1.14      2.1±0.02ms     8.0 MB/sec
formatter/numpy/globals.py                 1.00    211.1±4.34µs    14.0 MB/sec    1.09    230.9±7.00µs    12.8 MB/sec
formatter/pydantic/types.py                1.00      4.1±0.08ms     6.2 MB/sec    1.13      4.7±0.07ms     5.5 MB/sec
linter/all-rules/large/dataset.py          1.00     15.7±0.20ms     2.6 MB/sec    1.00     15.8±0.36ms     2.6 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.01      4.1±0.07ms     4.0 MB/sec    1.00      4.1±0.05ms     4.1 MB/sec
linter/all-rules/numpy/globals.py          1.00    498.8±7.67µs     5.9 MB/sec    1.00    499.2±7.48µs     5.9 MB/sec
linter/all-rules/pydantic/types.py         1.01      7.0±0.12ms     3.6 MB/sec    1.00      7.0±0.10ms     3.7 MB/sec
linter/default-rules/large/dataset.py      1.00      8.1±0.09ms     5.0 MB/sec    1.00      8.1±0.11ms     5.0 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00  1742.5±29.80µs     9.6 MB/sec    1.00  1746.1±21.72µs     9.5 MB/sec
linter/default-rules/numpy/globals.py      1.00    200.0±3.85µs    14.8 MB/sec    1.00    199.8±3.39µs    14.8 MB/sec
linter/default-rules/pydantic/types.py     1.00      3.7±0.07ms     6.9 MB/sec    1.02      3.7±0.05ms     6.8 MB/sec
</code></pre>
<!-- thollander/actions-comment-pull-request "PR Check Results" -->

</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2023-06-21 16:53</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff_python_formatter/src/snapshots/ruff_python_formatter__tests__ruff_test__statement__try_py.snap</code>:117 on 2023-06-21 16:53</div>
            <div class="timeline-body"><p>as far as i can see this is currently the only misplaced comment, right?</p>
<p>black also seems to remove the parentheses here even though it otherwise doesn't</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/davidszotten">@davidszotten</a> on 2023-06-21 18:16</div>
            <div class="timeline-body"><blockquote>
<p>add fixtures first</p>
</blockquote>
<p>just to clarify: did you look at the pr before i committed the fixtures (a bit late in the process) or are you suggesting committing them first (even before any code changes?) in a separate commit to then see changes as the impl is added?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/davidszotten">@davidszotten</a> reviewed on 2023-06-21 18:21</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/davidszotten">@davidszotten</a> on <code>crates/ruff_python_formatter/src/snapshots/ruff_python_formatter__tests__ruff_test__statement__try_py.snap</code>:117 on 2023-06-21 18:21</div>
            <div class="timeline-body"><p>comment placement looks ok to me here (<code>except line 2</code>)</p>
<p>but i don't understand what causes us to break the <code>(KeyError)</code> over multiple lines</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/davidszotten">@davidszotten</a> reviewed on 2023-06-21 18:22</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/davidszotten">@davidszotten</a> on <code>crates/ruff_python_formatter/src/snapshots/ruff_python_formatter__tests__ruff_test__statement__try_py.snap</code>:121 on 2023-06-21 18:22</div>
            <div class="timeline-body"><p>lots of blank lines before comments missing here. i don't recall handling that manually elsewhere but probably missing something. what's the best way to add those?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/davidszotten">@davidszotten</a> on <code>crates/ruff_python_formatter/src/statement/stmt_try.rs</code>:18 on 2023-06-21 18:24</div>
            <div class="timeline-body"><p>i couldn't figure out why i need to implement <code>FormatRule</code> rather than just <code>FormatNodeRule</code> for the excepthandler</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/davidszotten">@davidszotten</a> reviewed on 2023-06-21 18:24</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/davidszotten">@davidszotten</a> reviewed on 2023-06-21 18:26</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/davidszotten">@davidszotten</a> on <code>crates/ruff_python_formatter/src/snapshots/ruff_python_formatter__tests__ruff_test__statement__try_py.snap</code>:117 on 2023-06-21 18:26</div>
            <div class="timeline-body"><p>note that this is just a call to <code>.format()</code>, on a tuple of types, nothing manual here
https://github.com/astral-sh/ruff/pull/5222/files/ccd96e6ae3d7e38b833f530d99f5d0b9d46b35ef#diff-30bdf42955f6a58b1f41492d192056475d73d2d27906cb200ba4beba5d010d75R39</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/davidszotten">@davidszotten</a> on 2023-06-21 18:31</div>
            <div class="timeline-body"><p>til about <code> --print-ir</code> and <code>--print-comments</code></p>
<p>very helpful, have been doing lots of this manually with <code>dbg</code> statements, d'oh</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2023-06-21 18:42</div>
            <div class="timeline-body"><blockquote>
<p>just to clarify: did you look at the pr before i committed the fixtures (a bit late in the process) or are you suggesting committing them first (even before any code changes?) in a separate commit to then see changes as the impl is added?</p>
</blockquote>
<p>No my idea was just to put code you tested in the fixtures so other people can also see them when looking at your PR. We squash merge PRs, so commit order or structure is not important for ruff PRs. Personally, i try to skim external contributor draft PRs once they are created and comment if i see something, and add a thorough review once the PR is marked as ready. (You can of course always ping me or others on draft PRs if you have specific questions)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2023-06-21 18:49</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff_python_formatter/src/snapshots/ruff_python_formatter__tests__ruff_test__statement__try_py.snap</code>:121 on 2023-06-21 18:49</div>
            <div class="timeline-body"><p>You're already correctly using <code>empty_line()</code>, but i think you need to measure in front of the first leading comment instead of in front of the node (the tokenizer emits <code>TokenKind::Comment</code> otherwise)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2023-06-21 18:51</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff_python_formatter/src/snapshots/ruff_python_formatter__tests__ruff_test__statement__try_py.snap</code>:117 on 2023-06-21 18:51</div>
            <div class="timeline-body"><p>black format</p>
<pre><code class="language-python">try:
    ...
except (KeyError) as key:  # except line 2
    ...
</code></pre>
<p>as</p>
<pre><code class="language-python">try:
    ...
except KeyError as key:  # except line 2
    ...
</code></pre>
<p>which looks better to me. This is another one of the rare cases where black removes parentheses</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2023-06-21 18:54</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff_python_formatter/src/statement/stmt_try.rs</code>:18 on 2023-06-21 18:54</div>
            <div class="timeline-body"><p><code>FormatNodeRule</code> requires an <code>AstNode</code>, but <code>ExceptHandler</code> is only a <code>Node</code>. @MichaReiser Do you know why <code>ExceptHandler</code> is not <code>AstNode</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/davidszotten">@davidszotten</a> on 2023-06-21 18:58</div>
            <div class="timeline-body"><blockquote>
<blockquote>
<p>just to clarify: did you look at the pr before i committed the fixtures (a bit late in the process) or are you suggesting committing them first (even before any code changes?) in a separate commit to then see changes as the impl is added?</p>
</blockquote>
<p>No my idea was just to put code you tested in the fixtures so other people can also see them when looking at your PR. We squash merge PRs, so commit order or structure is not important for ruff PRs. Personally, i try to skim external contributor draft PRs once they are created and comment if i see something, and add a thorough review once the PR is marked as ready. (You can of course always ping me or others on draft PRs if you have specific questions)</p>
</blockquote>
<p>are you still missing something i've referenced but not included here (in <code>try.py</code>)?</p>
<p>if this is about timing, makes sense, i'll try to commit my scratch into a fixture sooner</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2023-06-21 19:08</div>
            <div class="timeline-body"><p>The <code>try.py</code> looks even better than what i had in mind, thanks for adding this! My second comment was meant to be about general ruff PR procedures, not about this PR specifically</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/davidszotten">@davidszotten</a> reviewed on 2023-06-21 20:04</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/davidszotten">@davidszotten</a> on <code>crates/ruff_python_formatter/src/snapshots/ruff_python_formatter__tests__ruff_test__statement__try_py.snap</code>:117 on 2023-06-21 20:04</div>
            <div class="timeline-body"><p>i agree that it's better to remove them. but i'm not sure what is preserving them (i was wrong above, here it isn't a tuple but just an <code>ExprName</code>)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "wip Format `StmtTry`" to "Format `StmtTry`" by @davidszotten on 2023-06-21 20:09</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @davidszotten on 2023-06-21 20:09</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff_python_formatter/src/statement/stmt_try.rs</code>:64 on 2023-06-21 21:07</div>
            <div class="timeline-body"><p>identifiers are now formattable on main, so you should be able to remove this workaround</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff_python_formatter/src/snapshots/ruff_python_formatter__tests__ruff_test__statement__try_py.snap</code>:117 on 2023-06-21 21:12</div>
            <div class="timeline-body"><p>You might need to change the attachment of <code># except line 2</code>  in placement.rs, either attach it trailing to a node that doesn't break the line if it doesn't need to or mark it as dangling and manually format after the colon. we're doing the latter (formatting after <code>:</code> manually) in some other nodes</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff_python_formatter/src/statement/stmt_try.rs</code>:38 on 2023-06-21 21:12</div>
            <div class="timeline-body"><p>nit: you can use <code>.first()</code> here</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff_python_formatter/src/statement/stmt_try.rs</code>:48 on 2023-06-21 21:14</div>
            <div class="timeline-body"><p>nit: can you merge those into the write call below?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff_python_formatter/src/statement/stmt_try.rs</code>:71 on 2023-06-21 21:15</div>
            <div class="timeline-body"><p>nit: similarly, can you merge those into the write call?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff_python_formatter/src/statement/stmt_try.rs</code>:70 on 2023-06-21 21:15</div>
            <div class="timeline-body"><p>nit: can you just directly reassign <code>dangling_comments</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff_python_formatter/src/statement/stmt_try.rs</code>:84 on 2023-06-21 21:16</div>
            <div class="timeline-body"><p>nit: use <code>.last()</code> here and below</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff_python_formatter/src/statement/stmt_try.rs</code>:103 on 2023-06-21 21:18</div>
            <div class="timeline-body"><p>is there a rest here?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2023-06-21 21:18</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/statement/stmt_try.rs</code>:18 on 2023-06-22 06:13</div>
            <div class="timeline-body"><p><code>ExceptHandler</code> is a union like <code>Stmt</code> and unions cannot implement <code>AstNodeRef</code> because it's impossible to convert a reference to a <code>Stmt</code> node (e.g. <code>&amp;IfStmt</code>) to a statement reference (<code>&amp;Stmt</code>) because all variants in <code>Stmt</code> take an <em>owned</em> value.</p>
<p>That said, there's a <code>ExceptHandlerExceptHandler</code> formatter in <code>other/except_handler_except_handler.rs</code> (this name ....)</p>
<p>We should move the formatting logic to the <code>except_handler_except_handler.rs</code> file and the union formatting here should simply dispatch to the item, the same as we do for <code>Stmt</code></p>
<p>https://github.com/astral-sh/ruff/blob/66fcb55f27abda52425ce0138775c2fd9ee30959/crates/ruff_python_formatter/src/statement/mod.rs#L37-L69</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/statement/stmt_try.rs</code>:48 on 2023-06-22 06:14</div>
            <div class="timeline-body"><p>Would <code>leading_alternate_branch_comments</code> work here? Could you also add a test with intentional newlines between the comments and the excepthandler to ensure we preserve the newlines correctly?</p>
<pre><code class="language-python">try:
	pass
	
	# comment
	
# comment
except ex:
	pass
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/statement/stmt_try.rs</code>:71 on 2023-06-22 06:16</div>
            <div class="timeline-body"><p>These should no longer be necessary after moving the formatting into <code>FormatExceptHandlerExceptHandler</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/statement/stmt_try.rs</code>:70 on 2023-06-22 06:17</div>
            <div class="timeline-body"><p>This may not work because <code>danglign_comments</code> isn't local to a single iteration of the for body. It must be reassigned for the next iteration.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/statement/stmt_try.rs</code>:127 on 2023-06-22 06:18</div>
            <div class="timeline-body"><p>Would <code>leading_alternate_branch_comments</code> work for you?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/statement/stmt_try.rs</code>:143 on 2023-06-22 06:19</div>
            <div class="timeline-body"><p>Would <code>leading_alternate_branch_comments</code> work here?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/statement/stmt_try.rs</code>:166 on 2023-06-22 06:19</div>
            <div class="timeline-body"><p>Would <code>leading_alternate_branch_comments</code> work hee?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/statement/stmt_try.rs</code>:99 on 2023-06-22 06:22</div>
            <div class="timeline-body"><p>Nit: The logic for formatting the handlers,finally, and orelse seem somewhat repetitive. Could we split some of it into a function <code>format_case(name: &amp;str, body: &amp;Suite, dangling_comments: &amp;[SourceComment]) -&gt; FormatResult&lt;&amp;[SourceComment]&gt;</code>?</p>
<p>Feel free to follow up on this in a separate PR or adding a todo (you can add my name). I'm more than happy merging this as it is</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/snapshots/ruff_python_formatter__tests__ruff_test__statement__try_py.snap</code>:117 on 2023-06-22 06:33</div>
            <div class="timeline-body"><p>Yeah... The fact that there's no explicit node for bodies really makes things annoying. The issue here is that the <code>except line 2</code> comment falls into the middle of the <code>ExceptHandlerExceptHandler</code> node (it is inside of that node's range). The last preceding node is the <code>KeyError</code> because <code>key</code> (<code>Identifier</code>) is not an AST node (it probably should, but it is not :cry:).</p>
<p>We probably need something similar to (or extend) https://github.com/astral-sh/ruff/blob/8a73a7b481b11d161a7ba2f1b56c59ca977f0848/crates/ruff_python_formatter/src/comments/placement.rs#L551-L554</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> requested changes on 2023-06-22 06:34</div>
            <div class="timeline-body"><p>This looks really good. I putting this back in your queue, mainly to move the <code>ExceptHandler</code> formatting to <code>FormatExceptHandlerExceptHandler</code>.</p>
<p>Feel free to ignore the incorrectly placed comment for now and instead add a TODO. We can tackle this as a separate pR</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/davidszotten">@davidszotten</a> reviewed on 2023-06-22 07:22</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/davidszotten">@davidszotten</a> on <code>crates/ruff_python_formatter/src/statement/stmt_try.rs</code>:18 on 2023-06-22 07:22</div>
            <div class="timeline-body"><p>ah thanks. though how come it's a union? there only seems to be a single member</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/davidszotten">@davidszotten</a> on 2023-06-22 07:32</div>
            <div class="timeline-body"><p>thanks for the comments, will see how i get on. while waiting for them, i also tried to see if i could re-use this code for <code>TryStar</code> but had one annoyance and one blocker</p>
<p>annoyance: since their contents is the same i tried destructing the item and then passing the components to a helper function to do the work, but when borrowing them across the function barrier i had e.g. <code> body: &amp;[Stmt&lt;TextRange&gt;]</code> instead of <code>body: Vec&lt;_&gt;</code> and i wasn't able to call <code>body.format()</code>.  i tried a few of the compiler suggestions but this was already at the limit of my rust knowledge. i worked around this by making an enum and passing the entire item</p>
<p>blocker: the <code>except</code> statement is emitted by the handler fmt, how do i pass context in there (or where can it look) so it knows if it's inside a try or a trystar?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/statement/stmt_try.rs</code>:18 on 2023-06-22 08:23</div>
            <div class="timeline-body"><p>RustPython uses Python's AST definition and it is defined as a union there. The same applies for TypeIgnore</p>
<pre><code>  excepthandler = ExceptHandler(expr? type, identifier? name, stmt* body)
                    attributes (int lineno, int col_offset, int? end_lineno, int? end_col_offset)
</code></pre>
<p>No idea why. We're leaning towards tailoring our own AST optimized for our use case (e.g. introducing a <code>Body</code> node) at some point in the future.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-06-22 08:23</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-06-22 08:25</div>
            <div class="timeline-body"><blockquote>
<p>thanks for the comments, will see how i get on. while waiting for them, i also tried to see if i could re-use this code for <code>TryStar</code> but had one annoyance and one blocker</p>
<p>annoyance: since their contents is the same i tried destructing the item and then passing the components to a helper function to do the work, but when borrowing them across the function barrier i had e.g. <code> body: &amp;[Stmt&lt;TextRange&gt;]</code> instead of <code>body: Vec&lt;_&gt;</code> and i wasn't able to call <code>body.format()</code>. i tried a few of the compiler suggestions but this was already at the limit of my rust knowledge. i worked around this by making an enum and passing the entire item</p>
</blockquote>
<p>One pattern that worked well in the past is to either:</p>
<ul>
<li>Implement an enum that is a union over both types. See <a href="https://github.com/astral-sh/ruff/blob/5acb7be8d638b1464a6911ed1612cc4e3992b711/crates/ruff_python_formatter/src/statement/stmt_function_def.rs#L30"><code>FormatAnyFunctionDef</code></a></li>
<li>Define a trait and implement it by your formatters. See <a href="https://github.com/astral-sh/ruff/blob/5acb7be8d638b1464a6911ed1612cc4e3992b711/crates/ruff_python_formatter/src/expression/binary_like.rs#L10"><code>FormatBinaryLike</code></a></li>
</ul>
<p>I don't have a strong preference for either.</p>
<blockquote>
<p>blocker: the <code>except</code> statement is emitted by the handler fmt, how do i pass context in there (or where can it look) so it knows if it's inside a try or a trystar?</p>
</blockquote>
<p>You can implement <code>FormatRuleWithOptions</code> and then call your formatting like this</p>
<pre><code>except_handler.format().with_options(Context::TryStar).fmt(f)
</code></pre>
<p>See <a href="https://github.com/astral-sh/ruff/blob/5acb7be8d638b1464a6911ed1612cc4e3992b711/crates/ruff_python_formatter/src/expression/mod.rs#L46-L53"><code>FormatExpr</code></a> as an example.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/davidszotten">@davidszotten</a> reviewed on 2023-06-22 12:28</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/davidszotten">@davidszotten</a> on <code>crates/ruff_python_formatter/src/statement/stmt_try.rs</code>:38 on 2023-06-22 12:28</div>
            <div class="timeline-body"><p>do you mean <code>if let Some(first_leading) = leading_comments.first()</code>? (is that better than what i have?) or something even better?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/davidszotten">@davidszotten</a> reviewed on 2023-06-22 12:32</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/davidszotten">@davidszotten</a> on <code>crates/ruff_python_formatter/src/statement/stmt_try.rs</code>:127 on 2023-06-22 12:32</div>
            <div class="timeline-body"><p>yes this is working well in almost all places, thanks!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/davidszotten">@davidszotten</a> reviewed on 2023-06-22 12:59</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/davidszotten">@davidszotten</a> on <code>crates/ruff_python_formatter/src/statement/stmt_try.rs</code>:48 on 2023-06-22 12:59</div>
            <div class="timeline-body"><p>well curiously your example formats correctly, but removing the blank line 3 causes the formatter to also remove the blank line 5 (i guess i'm somehow using the blank line after the. <code>pass</code> instead of the blank line after the comment. does that mean i can't use leading_alternate_branch_comments after all there? or am i doing something else wrong</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff_python_formatter/src/statement/stmt_try.rs</code>:38 on 2023-06-22 13:02</div>
            <div class="timeline-body"><p>yep i meant that</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2023-06-22 13:02</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/davidszotten">@davidszotten</a> reviewed on 2023-06-22 16:43</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/davidszotten">@davidszotten</a> on <code>crates/ruff_python_formatter/src/statement/stmt_try.rs</code>:99 on 2023-06-22 16:43</div>
            <div class="timeline-body"><p>i've got something working for this (separate pr coming). a bit messier than the above since we need different handling of the handlers compared to orelse/finally (i think)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/statement/stmt_try.rs</code>:48 on 2023-06-22 20:32</div>
            <div class="timeline-body"><p>Okay I tried this locally and the issue is that we need to pass the <em>leading</em> comments of the <em>except handler</em>.</p>
<pre><code class="language-rust">let handler_comments = comments_info.leading_comments(handler);
write!(
    f,
    [
        leading_alternate_branch_comments(handler_comments, last_node),
        &amp;handler.format()
    ]
)?;
</code></pre>
<p>Why not extract them from dangling comments? This is because except handlers are different from the <code>else</code> or <code>finally</code> because the except handler has a node to which we can attach the comments to. We only use dangling comments for the <code>else</code> and <code>finally</code> match cases.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-06-22 20:32</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/statement/stmt_try.rs</code>:82 on 2023-06-22 20:34</div>
            <div class="timeline-body"><p>GitHub doesn't allow me to comment on the right line. We can remove the TODo below and instead add a comment that the dangling comments are formatted as part of <code>fmt_fields</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-06-22 20:34</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/davidszotten">@davidszotten</a> reviewed on 2023-06-22 21:50</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/davidszotten">@davidszotten</a> on <code>crates/ruff_python_formatter/src/statement/stmt_try.rs</code>:48 on 2023-06-22 21:50</div>
            <div class="timeline-body"><p>sorry after the recent refactor into <code>except_handler_except_handler</code> i'm not sure where this patch should go</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/comments/placement.rs</code>:714 on 2023-06-23 06:01</div>
            <div class="timeline-body"><p>Can you add a test that has end of line comments that should belong to a statement in the except handler</p>
<pre><code class="language-python">try:
	...
except ex: 
	a = 10 # trailing comment
</code></pre>
<p>I believe this implementation will incorrectly attach all comments to the except handler</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/other/except_handler_except_handler.rs</code>:57 on 2023-06-23 06:01</div>
            <div class="timeline-body"><p>You can override <code>fmt_dangling_comments</code> with a stub implementation that always returns <code>Ok(())</code>, similar to what we do in <code>FormatTryStmt</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/statement/stmt_try.rs</code>:68 on 2023-06-23 06:04</div>
            <div class="timeline-body"><p>Related to <a href="https://github.com/astral-sh/ruff/pull/5222#discussion_r1238493849">the conversation about <code>leading_alternate_branch_comments</code></a>.</p>
<pre><code class="language-suggestion">           let handler_comments = comments_info.leading_comments(handler);
			write!(
			    f,
			    [
			        leading_alternate_branch_comments(handler_comments, last_node),
			        &amp;handler.format()
			    ]
			)?;
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-06-23 06:04</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/davidszotten">@davidszotten</a> reviewed on 2023-06-23 07:34</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/davidszotten">@davidszotten</a> on <code>crates/ruff_python_formatter/src/comments/placement.rs</code>:714 on 2023-06-23 07:34</div>
            <div class="timeline-body"><p>ah yes, of course. fixed</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/davidszotten">@davidszotten</a> reviewed on 2023-06-23 07:50</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/davidszotten">@davidszotten</a> on <code>crates/ruff_python_formatter/src/statement/stmt_try.rs</code>:68 on 2023-06-23 07:50</div>
            <div class="timeline-body"><p>i don't think this is quite right. the first except handler seems to be working differently to subsequent ones.</p>
<p>i'm still debugging but it seems the comments just above the first except handler and the finally clause are handled by <code>handle_in_between_bodies_own_line_comment</code> whereas the ones above except handlers 2-n are handled by <code>handle_in_between_except_handlers_or_except_handler_and_else_or_finally_comment</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/davidszotten">@davidszotten</a> reviewed on 2023-06-23 08:23</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/davidszotten">@davidszotten</a> on <code>crates/ruff_python_formatter/src/statement/stmt_try.rs</code>:68 on 2023-06-23 08:23</div>
            <div class="timeline-body"><p>ok. if i understand correctly i just need both, i.e. special handling of comments for the first except handler. <code>handle_in_between_except_handlers_or_except_handler_and_else_or_finally_comment</code> attaches as dangling to the <code>try</code>, whereas <code>handle_in_between_except_handlers_or_except_handler_and_else_or_finally_comment</code> attaches to the except handlers as leading</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/davidszotten">@davidszotten</a> reviewed on 2023-06-23 08:26</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/davidszotten">@davidszotten</a> on <code>crates/ruff_python_formatter/src/other/except_handler_except_handler.rs</code>:57 on 2023-06-23 08:26</div>
            <div class="timeline-body"><p>happy to, though i don't quite understand why that's needed</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-06-23 10:03</div>
            <div class="timeline-body"><p>I'm so impressed by how you tackle this. You're probably working on the most complicated statement!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-06-23 10:08</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/statement/stmt_try.rs</code>:68 on 2023-06-23 10:08</div>
            <div class="timeline-body"><p>Can you share an example? My understanding is that <code>handle_in_between_bodies_own_line_comment</code> should always attach the comment as leading comment and <code>handle_in_between_except_handlers_or_except_handler_and_else_or_finally_comment</code> should only attach <code>dangling_comments</code> for comments before the <code>finally</code> or <code>orelse</code> body.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/other/except_handler_except_handler.rs</code>:57 on 2023-06-23 10:09</div>
            <div class="timeline-body"><p>You do</p>
<pre><code class="language-rust">    fn fmt_dangling_comments(
        &amp;self,
        _node: &amp;ExprAttribute,
        _f: &amp;mut PyFormatter,
    ) -&gt; FormatResult&lt;()&gt; {
        // handle in `fmt_fields`
        Ok(())
    }
</code></pre>
<p>in the <code>FormatNodeRule</code> implementation of <code>FormatExceptHandlerExceptHandler</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-06-23 10:09</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/davidszotten">@davidszotten</a> reviewed on 2023-06-23 10:44</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/davidszotten">@davidszotten</a> on <code>crates/ruff_python_formatter/src/statement/stmt_try.rs</code>:68 on 2023-06-23 10:44</div>
            <div class="timeline-body"><pre><code>try:
    ...

except:
    ...

# before except 2
except:
    ...
</code></pre>
<p>this comment gets attached as dangling by <code>handle_in_between_except_handlers_or_except_handler_and_else_or_finally_comment</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/davidszotten">@davidszotten</a> on <code>crates/ruff_python_formatter/src/other/except_handler_except_handler.rs</code>:57 on 2023-06-23 10:47</div>
            <div class="timeline-body"><p>yes i understand _what you were asking for but not _why it's needed</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/davidszotten">@davidszotten</a> reviewed on 2023-06-23 10:47</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/statement/stmt_try.rs</code>:68 on 2023-06-23 11:12</div>
            <div class="timeline-body"><p>Okay. This is incorrect. This should become a leading comment. Feel free to leave a todo.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-06-23 11:12</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/davidszotten">@davidszotten</a> on 2023-06-23 11:30</div>
            <div class="timeline-body"><blockquote>
<p>I'm so impressed by how you tackle this. You're probably working on the most complicated statement!</p>
</blockquote>
<p>Thanks, and again, thanks for your patience and help!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/davidszotten">@davidszotten</a> reviewed on 2023-06-23 13:01</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/davidszotten">@davidszotten</a> on <code>crates/ruff_python_formatter/src/statement/stmt_try.rs</code>:68 on 2023-06-23 13:01</div>
            <div class="timeline-body"><p>ah, think i figured out how to fix it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/davidszotten">@davidszotten</a> reviewed on 2023-06-23 13:09</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/davidszotten">@davidszotten</a> on <code>crates/ruff_python_formatter/src/comments/placement.rs</code>:713 on 2023-06-23 13:09</div>
            <div class="timeline-body"><p>would probably be a good idea to have some tests for these functions. not sure what we have available to make tests ergonomic. will have a look around, but you might have good ideas already</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @davidszotten on 2023-06-23 17:45</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-06-24 20:25</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/comments/placement.rs</code>:713 on 2023-06-24 20:25</div>
            <div class="timeline-body"><p>We have some snapshot tests in the <code>comments/mod.rs</code> file, that test if the comments get associated with the right node. But they are quiet similar to the formatting snapshot tests.</p>
<p>https://github.com/astral-sh/ruff/blob/d3d69a031e3070a892e41b41bc191b6d0d11ea88/crates/ruff_python_formatter/src/comments/mod.rs#L587-L608</p>
<p>I plan to review your PR on Monday.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/davidszotten">@davidszotten</a> reviewed on 2023-06-24 20:34</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/davidszotten">@davidszotten</a> on <code>crates/ruff_python_formatter/src/comments/placement.rs</code>:713 on 2023-06-24 20:34</div>
            <div class="timeline-body"><p>yes i did find those and tried to (ab?)use them to generate input i could pass to the functions here like <code>handle_trailing_end_of_line_except_comment</code> but i failed.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/comments/placement.rs</code>:713 on 2023-06-26 06:34</div>
            <div class="timeline-body"><p>Yeah. It is testing the whole <code>place_comment</code> and not only <code>handle_treiling_end_of_line_except_comment</code>. This is intentional because the construction of the <code>DecoratedComment</code> is very specific and easy to get wrong when constructing by hand (and we want to make sure that changes the <code>DecoratedComment</code> construction resulting in a failure of the <code>except</code> comment placement are catched too). But you can tailor your source code so that it calls your function with the arguments that you want to test.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-06-26 06:34</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/comments/placement.rs</code>:207 on 2023-06-26 06:40</div>
            <div class="timeline-body"><p>I think this incorrectly attaches the following comment as leading comment rather than trailing <code>except</code> comment.</p>
<pre><code class="language-python">try:
	pass
except Exception:
	print(&quot;no-op&quot;)
	# trailing
finally:
	pass
</code></pre>
<p>I wonder if the correct fix is to change the condition on line 179 to delegate to <code>comment_indentation != except_indentation</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/comments/placement.rs</code>:708 on 2023-06-26 06:43</div>
            <div class="timeline-body"><p>I believe the logic here is incorrect. It will incorrectly attach comments after the <code>:</code> but before the first statement as dangling comments</p>
<pre><code class="language-python">try:
	pass
except:
	# leading comment but it becomes a trailing except comment
	pass
</code></pre>
<p>Would it be possible to change <code>handle_in_between_bodies_end_of_line_comment</code> to properly support except handlers (or fix the ordering of the placement handlers)?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/statement/stmt_try.rs</code>:61 on 2023-06-26 06:44</div>
            <div class="timeline-body"><p>The <code>hard_line_break</code> isn't necessary because <code>block_indent</code> already inserts <code>hard_line_break</code>s for you</p>
<pre><code class="language-suggestion"></code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-06-26 06:46</div>
            <div class="timeline-body"><p>This looks good to me except that I think that some comment placement is incorrect. I'll leave it up to you if you want to:</p>
<ul>
<li>Split the comment placement fixes into its own PR</li>
<li>Follow up as part of this PR</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/davidszotten">@davidszotten</a> on <code>crates/ruff_python_formatter/src/comments/placement.rs</code>:207 on 2023-06-26 09:52</div>
            <div class="timeline-body"><p>for your example above <code>--print-comments</code> prints</p>
<pre><code>{
    Node {
        kind: StmtExpr,
        range: 36..50,
        source: `print(&quot;no-op&quot;)`,
    }: {
        &quot;leading&quot;: [],
        &quot;dangling&quot;: [],
        &quot;trailing&quot;: [
            SourceComment {
                text: &quot;# trailing&quot;,
                position: OwnLine,
                formatted: true,
            },
        ],
    },
}
</code></pre>
<p>for me (which looks correct). or am i misunderstanding something?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/davidszotten">@davidszotten</a> reviewed on 2023-06-26 09:52</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/davidszotten">@davidszotten</a> reviewed on 2023-06-26 10:07</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/davidszotten">@davidszotten</a> on <code>crates/ruff_python_formatter/src/comments/placement.rs</code>:708 on 2023-06-26 10:07</div>
            <div class="timeline-body"><p>i can't repro this either</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-06-26 15:53</div>
            <div class="timeline-body"><p>@davidszotten is this PR ready for merging from your side(besides the merge conflicts?). I lost the overview.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/davidszotten">@davidszotten</a> on 2023-06-26 18:22</div>
            <div class="timeline-body"><blockquote>
<p>@davidszotten is this PR ready for merging from your side(besides the merge conflicts?). I lost the overview.</p>
</blockquote>
<p>https://github.com/astral-sh/ruff/pull/5222#discussion_r1241928787 and https://github.com/astral-sh/ruff/pull/5222#discussion_r1241947330 are waiting for your replies i think</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/comments/placement.rs</code>:207 on 2023-06-28 09:44</div>
            <div class="timeline-body"><p>Yeah sorry, my mistake. I mixed up the indentation levels. This is correctly handled by the</p>
<pre><code>    if comment_indentation &gt; except_indentation {
        // Delegate to `handle_trailing_body_comment`
        return CommentPlacement::Default(comment);
    }
</code></pre>
<p>check</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-06-28 09:44</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/comments/placement.rs</code>:708 on 2023-06-28 09:46</div>
            <div class="timeline-body"><p>Same. This is handled correctly by the</p>
<pre><code>if comment.line_position().is_own_line() {
    return CommentPlacement::Default(comment);
}
</code></pre>
<p>check</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-06-28 09:46</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2023-06-28 09:52</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-06-28 09:53</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/other/except_handler_except_handler.rs</code>:57 on 2023-06-28 09:53</div>
            <div class="timeline-body"><p>Technically it is not needed because <code>SourceComment</code>s track whether they have been formatted. It is mainly a perf improvement to avoid the additional <code>Comments</code> hashmap lookup when we already know that we've formatted all comments.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @MichaReiser on 2023-06-28 10:02</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @MichaReiser on 2023-06-28 10:02</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/davidszotten">@davidszotten</a> on 2023-06-28 10:04</div>
            <div class="timeline-body"><p>🎉  thanks</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-06-28 10:08</div>
            <div class="timeline-body"><p>Thank you!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2023-07-07 20:47</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 03:37:34 UTC
    </footer>
</body>
</html>
