```yaml
number: 3896
title: Cheap cloneable LineIndex 
type: pull_request
state: merged
author: MichaReiser
labels:
  - internal
assignees: []
merged: true
base: main
head: extract-line-index
created_at: 2023-04-06T09:23:06Z
updated_at: 2023-04-11T07:56:45Z
url: https://github.com/astral-sh/ruff/pull/3896
synced_at: 2026-01-12T04:28:19Z
```

# Cheap cloneable LineIndex 

---

_Pull request opened by @MichaReiser on 2023-04-06 09:23_

This PR extracts the `Index` type from `Locator`, changes it to use an `Arc` internally to make it cheaply cloneable, and makes it public. 

The motivation for this change is that I want to output an advice with the recommended fix in the `text` and `grouped` emitter if `--show-sources` is true. Doing so requires access to the source code and the `LineIndex` to apply the edits. 

 I used this chance to change the `Locator` and `LineIndex` to return `TextSize` rather than `usize`s for byte offsets.

---

_Comment by @MichaReiser on 2023-04-06 09:23_

Current dependencies on/for this PR:
* main
  * **PR #3895** <a href="https://app.graphite.dev/github/pr/charliermarsh/ruff/3895" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a> 
    * **PR #3896** <a href="https://app.graphite.dev/github/pr/charliermarsh/ruff/3896" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a>  ðŸ‘ˆ
      * **PR #3897** <a href="https://app.graphite.dev/github/pr/charliermarsh/ruff/3897" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a> 
        * **PR #3901** <a href="https://app.graphite.dev/github/pr/charliermarsh/ruff/3901" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a> 
          * **PR #3904** <a href="https://app.graphite.dev/github/pr/charliermarsh/ruff/3904" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a> 
            * **PR #3905** <a href="https://app.graphite.dev/github/pr/charliermarsh/ruff/3905" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a> 
              * **PR #3906** <a href="https://app.graphite.dev/github/pr/charliermarsh/ruff/3906" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a> 

This comment was auto-generated by [Graphite](https://app.graphite.dev/github/pr/charliermarsh/ruff/3896?utm_source=stack-comment).

---

_Comment by @github-actions[bot] on 2023-04-06 10:01_

## PR Check Results
### Ecosystem
âœ… ecosystem check detected no changes.

### Benchmark
#### Linux
```
group                                      main                                   pr
-----                                      ----                                   --
linter/all-rules/large/dataset.py          1.00     15.1Â±0.12ms     2.7 MB/sec    1.00     15.1Â±0.09ms     2.7 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.01      3.8Â±0.01ms     4.4 MB/sec    1.00      3.8Â±0.00ms     4.4 MB/sec
linter/all-rules/numpy/globals.py          1.00    416.8Â±1.91Âµs     7.1 MB/sec    1.00    415.2Â±1.26Âµs     7.1 MB/sec
linter/all-rules/pydantic/types.py         1.00      6.5Â±0.02ms     3.9 MB/sec    1.00      6.5Â±0.09ms     3.9 MB/sec
linter/default-rules/large/dataset.py      1.01      7.9Â±0.01ms     5.2 MB/sec    1.00      7.8Â±0.04ms     5.2 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00   1744.5Â±3.49Âµs     9.5 MB/sec    1.00   1741.8Â±1.84Âµs     9.6 MB/sec
linter/default-rules/numpy/globals.py      1.00    180.2Â±0.37Âµs    16.4 MB/sec    1.01    181.9Â±1.64Âµs    16.2 MB/sec
linter/default-rules/pydantic/types.py     1.00      3.6Â±0.01ms     7.0 MB/sec    1.00      3.6Â±0.00ms     7.1 MB/sec
```

#### Windows
```
group                                      main                                   pr
-----                                      ----                                   --
linter/all-rules/large/dataset.py          1.00     16.4Â±0.20ms     2.5 MB/sec    1.00     16.5Â±0.22ms     2.5 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      4.2Â±0.13ms     4.0 MB/sec    1.00      4.2Â±0.08ms     4.0 MB/sec
linter/all-rules/numpy/globals.py          1.00   499.8Â±14.60Âµs     5.9 MB/sec    1.00    497.9Â±8.88Âµs     5.9 MB/sec
linter/all-rules/pydantic/types.py         1.00      6.9Â±0.10ms     3.7 MB/sec    1.00      6.9Â±0.09ms     3.7 MB/sec
linter/default-rules/large/dataset.py      1.00      8.3Â±0.11ms     4.9 MB/sec    1.00      8.2Â±0.07ms     4.9 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00  1812.6Â±24.35Âµs     9.2 MB/sec    1.00  1804.9Â±22.26Âµs     9.2 MB/sec
linter/default-rules/numpy/globals.py      1.00    192.0Â±3.54Âµs    15.4 MB/sec    1.02    195.9Â±6.51Âµs    15.1 MB/sec
linter/default-rules/pydantic/types.py     1.00      3.8Â±0.06ms     6.7 MB/sec    1.00      3.8Â±0.06ms     6.7 MB/sec
```
<!-- thollander/actions-comment-pull-request "PR Check Results" -->

---

_Marked ready for review by @MichaReiser on 2023-04-06 10:10_

---

_@charliermarsh approved on 2023-04-06 21:45_

Looks great.

---

_@charliermarsh reviewed on 2023-04-06 21:55_

---

_Review comment by @charliermarsh on `crates/ruff_python_ast/src/source_code/line_index.rs`:154 on 2023-04-06 21:55_

I've never used `NonZeroUSize` so I'll just ask: why do we need `OneIndexed` at all? Can we not use that type directly?

---

_Review comment by @MichaReiser on `crates/ruff_python_ast/src/source_code/line_index.rs`:154 on 2023-04-07 10:22_

We could. But I prefer semantic wrapper types because they communicate intent and allow us to limit the API, add helper methods that are only meaningful in this context (e.g. `to_zero_indexed`) or use method names that are more adequate in this context. 

The use of wrapper types further allows us to replace the internal representation if we want (e.g. use a `NonZeroU32`) or to search for all usages of that concept (we may want to use `NonZeroUsize` in other places that are entirely unrelated).

---

_@MichaReiser reviewed on 2023-04-07 10:22_

---

_Merged by @MichaReiser on 2023-04-11 07:33_

---

_Closed by @MichaReiser on 2023-04-11 07:33_

---

_Branch deleted on 2023-04-11 07:33_

---

_Label `internal` added by @MichaReiser on 2023-04-11 07:56_

---
