<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fix zulip unstable formatting with end-of-line comments - astral-sh/ruff #6386</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Fix zulip unstable formatting with end-of-line comments</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/6386">#6386</a>
        opened by <a href="https://github.com/konstin">@konstin</a>
        on 2023-08-07 11:01
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a></div>
            <div class="timeline-body"><h2>Bug</h2>
<p>Given</p>
<pre><code class="language-python">x = () - (#
)
</code></pre>
<p>the comment is a dangling comment of the empty tuple. This is an end-of-line comment so it may move after the expression. It still expands the parent, so the operator breaks:</p>
<pre><code class="language-python">x = (
    ()
    - ()  #
)
</code></pre>
<p>In the next formatting pass, the comment is not a trailing tuple but a trailing bin op comment, so the bin op doesn't break anymore. The comment again expands the parent, so we still add the superfluous parentheses</p>
<pre><code class="language-python">x = (
    () - ()  #
)
</code></pre>
<h2>Fix</h2>
<p>The new formatting is to keep the comment on the empty tuple. This is a log uglier and again has additional outer parentheses, but it's stable:</p>
<pre><code class="language-python">x = (
    ()
    - (  #
    )
)
</code></pre>
<h2>Alternatives</h2>
<p>Black formats all the examples above as</p>
<pre><code class="language-python">x = () - ()  #
</code></pre>
<p>which i find better.</p>
<p>I would be happy about any suggestions for better solutions than the current one. I'd mainly need a workaround for expand parent having an effect on the bin op instead of first moving the comment to the end and then applying expand parent to the assign statement.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2023-08-07 11:01</div>
            <div class="timeline-body"><p>Current dependencies on/for this PR:</p>
<ul>
<li>main<ul>
<li><strong>PR #6386</strong> <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/6386" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a>  ðŸ‘ˆ</li>
</ul>
</li>
</ul>
<p>This comment was auto-generated by <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/6386?utm_source=stack-comment">Graphite</a>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">formatter</span> added by @konstin on 2023-08-07 11:04</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2023-08-07 11:28</div>
            <div class="timeline-body"><h2>PR Check Results</h2>
<h3>Benchmark</h3>
<h4>Linux</h4>
<pre><code>group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.00      8.1Â±0.02ms     5.0 MB/sec    1.04      8.5Â±0.07ms     4.8 MB/sec
formatter/numpy/ctypeslib.py               1.00   1612.1Â±9.05Âµs    10.3 MB/sec    1.04  1669.3Â±11.53Âµs    10.0 MB/sec
formatter/numpy/globals.py                 1.00    184.8Â±5.80Âµs    16.0 MB/sec    1.00    184.7Â±1.01Âµs    16.0 MB/sec
formatter/pydantic/types.py                1.00      3.4Â±0.04ms     7.4 MB/sec    1.04      3.6Â±0.05ms     7.1 MB/sec
linter/all-rules/large/dataset.py          1.00     10.2Â±0.25ms     4.0 MB/sec    1.01     10.2Â±0.37ms     4.0 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      2.7Â±0.06ms     6.2 MB/sec    1.00      2.7Â±0.00ms     6.2 MB/sec
linter/all-rules/numpy/globals.py          1.00    377.2Â±0.61Âµs     7.8 MB/sec    1.00    378.4Â±0.86Âµs     7.8 MB/sec
linter/all-rules/pydantic/types.py         1.00      4.6Â±0.01ms     5.5 MB/sec    1.00      4.6Â±0.04ms     5.5 MB/sec
linter/default-rules/large/dataset.py      1.00      5.2Â±0.02ms     7.8 MB/sec    1.00      5.3Â±0.02ms     7.7 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00   1129.1Â±6.93Âµs    14.7 MB/sec    1.01   1136.6Â±9.73Âµs    14.6 MB/sec
linter/default-rules/numpy/globals.py      1.00    127.8Â±0.88Âµs    23.1 MB/sec    1.00    128.2Â±0.31Âµs    23.0 MB/sec
linter/default-rules/pydantic/types.py     1.00      2.3Â±0.00ms    10.9 MB/sec    1.01      2.4Â±0.01ms    10.8 MB/sec
</code></pre>
<h4>Windows</h4>
<pre><code>group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.04     10.3Â±0.26ms     4.0 MB/sec    1.00      9.8Â±0.09ms     4.1 MB/sec
formatter/numpy/ctypeslib.py               1.00  1905.3Â±23.53Âµs     8.7 MB/sec    1.00  1897.2Â±30.10Âµs     8.8 MB/sec
formatter/numpy/globals.py                 1.00    210.8Â±4.89Âµs    14.0 MB/sec    1.00    209.8Â±7.93Âµs    14.1 MB/sec
formatter/pydantic/types.py                1.00      4.2Â±0.04ms     6.1 MB/sec    1.01      4.2Â±0.13ms     6.0 MB/sec
linter/all-rules/large/dataset.py          1.03     12.8Â±0.43ms     3.2 MB/sec    1.00     12.5Â±0.13ms     3.3 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      3.4Â±0.03ms     4.8 MB/sec    1.01      3.5Â±0.09ms     4.8 MB/sec
linter/all-rules/numpy/globals.py          1.00    422.0Â±5.58Âµs     7.0 MB/sec    1.00    423.3Â±8.92Âµs     7.0 MB/sec
linter/all-rules/pydantic/types.py         1.00      5.8Â±0.08ms     4.4 MB/sec    1.01      5.9Â±0.21ms     4.3 MB/sec
linter/default-rules/large/dataset.py      1.00      6.8Â±0.07ms     6.0 MB/sec    1.00      6.7Â±0.07ms     6.0 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00  1380.4Â±10.52Âµs    12.1 MB/sec    1.01  1387.9Â±21.57Âµs    12.0 MB/sec
linter/default-rules/numpy/globals.py      1.01    159.4Â±3.49Âµs    18.5 MB/sec    1.00    158.0Â±2.54Âµs    18.7 MB/sec
linter/default-rules/pydantic/types.py     1.00      3.0Â±0.04ms     8.5 MB/sec    1.00      3.0Â±0.04ms     8.5 MB/sec
</code></pre>
<!-- thollander/actions-comment-pull-request "PR Check Results" -->

</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-08-07 11:46</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/builders.rs</code>:265 on 2023-08-07 11:46</div>
            <div class="timeline-body"><p>What's our motivation to keep the trailing end of line comments on the same line as the opening parentheses?</p>
<p>I prefer</p>
<pre><code class="language-python">x = () - (
	# comment
)
</code></pre>
<p>over</p>
<pre><code class="language-python">x = () - ( # comment
)
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2023-08-07 11:51</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff_python_formatter/src/builders.rs</code>:265 on 2023-08-07 11:51</div>
            <div class="timeline-body"><p>Turning an end-of-line comment into an own line comment leads to unstable formatting by the two spaces we insert after the line, so we need turn one comment kind into the other atm.</p>
<p>From a style perspective i prefer black with <code>()  # comment</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-08-07 11:51</div>
            <div class="timeline-body"><blockquote>
<p>I would be happy about any suggestions for better solutions than the current one. I'd mainly need a workaround for expand parent having an effect on the bin op instead of first moving the comment to the end and then applying expand parent to the assign statement.</p>
</blockquote>
<p>This isn't possible without moving the comment inside of <code>placement.rs</code>. I personally prefer if the formatter doesn't move my comments out of the parenthesis, because it does change the semantics of the comment:</p>
<pre><code class="language-python">a = call([ 	# empty because of x
], b) + []
</code></pre>
<p>I prefer:</p>
<pre><code class="language-python">a = call(
	[ 	
		# empty because of x
	], 
	b
) 	+ []
</code></pre>
<p>Over</p>
<pre><code class="language-python">a = call([], b) + [] # empty because of x
</code></pre>
<p>Because it is now unclear what the comment refers to</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-08-07 12:39</div>
            <div class="timeline-body"><p>I havenâ€™t reviewed yet but just want to confirm - is this still necessary after my two PRs that get the stability checks passing?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2023-08-07 12:52</div>
            <div class="timeline-body"><p>I think so, this is a slightly different case (empty tuple vs. empty function) that the minimizer stumbled into because you can get to it by removing the function. I'll rebase and check again once the other PRs are merged</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-08-07 13:10</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/builders.rs</code>:265 on 2023-08-07 13:10</div>
            <div class="timeline-body"><blockquote>
<p>Turning an end-of-line comment into an own line comment leads to unstable formatting by the two spaces we insert after the line,</p>
</blockquote>
<p>We shouldn't insert the two empty spaces in that case. We just format them as own line comments.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2023-08-07 17:39</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-08-07 18:06</div>
            <div class="timeline-body"><p>Okay, should be all-clear to rebase.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-08-08 07:25</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/tests/snapshots/format@statement__delete.py.snap</code>:222 on 2023-08-08 07:25</div>
            <div class="timeline-body"><p>Can we add a test case of a empty parenthesized that has a trailing end of line and own line comments?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @konstin on 2023-08-08 09:15</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @konstin on 2023-08-08 09:15</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2023-08-08 09:15</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 16:59:22 UTC
    </footer>
</body>
</html>
