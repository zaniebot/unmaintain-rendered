<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[ty] Implement long-polling for workspace diagnsotics - astral-sh/ruff #19670</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[ty] Implement long-polling for workspace diagnsotics</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/19670">#19670</a>
        opened by <a href="https://github.com/MichaReiser">@MichaReiser</a>
        on 2025-07-31 19:10
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a></div>
            <div class="timeline-body"><h2>Summary</h2>
<p>This PR implements long-polling for workspace diagnostics (as described in the spec).</p>
<p>Without long polling, VS Code keeps sending workspace/diagnostic requests every 2 seconds, even if the user didn't make any changes. This can take up a fair amount of CPU usage, even if all diagnostics are cached, because we still need to iterate over all files.</p>
<p>This PR implements long polling which avoids this. The basic idea is that the server keeps the <code>workspace/diagnostic</code> open and only responds once there are changes (e.g. new or fixed diagnostics) or the server shuts down (or cancels the request).</p>
<p>Implementing this required adding a <code>process</code> method to the request handler in order that workspace diagnostics can omit the response when long polling.</p>
<p>This PR implements the last optimization mentioned in https://github.com/astral-sh/ty/issues/824</p>
<p>Closes https://github.com/astral-sh/ty/issues/824</p>
<p>I can no longer reproduce https://github.com/astral-sh/ty/issues/818 on this PR (closes https://github.com/astral-sh/ty/issues/818)</p>
<h2>Test Plan</h2>
<p>Added integration tests</p>
<p>https://github.com/user-attachments/assets/36c9d227-58c2-416b-9e29-a93a47c072b0</p>
<p>https://github.com/user-attachments/assets/18f03d21-8332-488d-ab34-dfc0f06e60aa</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">server</span> added by @MichaReiser on 2025-07-31 19:10</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ty</span> added by @MichaReiser on 2025-07-31 19:10</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-07-31 19:12</div>
            <div class="timeline-body"><!-- generated-comment typing_conformance_diagnostics_diff -->

<h2>Diagnostic diff on typing conformance tests</h2>
<p>No changes detected when running ty on typing conformance tests âœ…</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-08-01 08:59</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>âœ… ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>âœ… ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-08-01 11:09</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_server/src/server/main_loop.rs</code>:135 on 2025-08-01 11:09</div>
            <div class="timeline-body"><p>Whooops</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @dhruvmanila by @MichaReiser on 2025-08-01 15:44</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @MichaReiser on 2025-08-01 15:44</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @MichaReiser on 2025-08-01 15:44</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @AlexWaygood by @MichaReiser on 2025-08-01 15:44</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @sharkdp by @MichaReiser on 2025-08-01 15:44</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @dcreager by @MichaReiser on 2025-08-01 15:44</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-08-01 15:47</div>
            <div class="timeline-body"><!-- generated-comment mypy_primer -->

<h2><code>mypy_primer</code> results</h2>
<p>No ecosystem changes detected âœ…
No memory usage changes detected âœ…</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for @AlexWaygood removed by @AlexWaygood on 2025-08-01 16:11</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ty_server/src/server/api/traits.rs</code>:101 on 2025-08-04 06:07</div>
            <div class="timeline-body"><p>Can you please update the documentation for all the traits and the module level documentation as well? I think it'd be useful to specify the difference between &quot;run&quot; and &quot;process&quot;</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ty_server/src/server/api.rs</code>:350 on 2025-08-04 06:12</div>
            <div class="timeline-body"><pre><code class="language-suggestion">        // If there's any pending workspace diagnostic long-polling request,
        // resume it if the session revision changed (e.g. because some document changed).
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ty_server/src/server/api/requests/workspace_diagnostic.rs</code>:38 on 2025-08-04 06:18</div>
            <div class="timeline-body"><pre><code class="language-suggestion">/// to send multiple responses (in the form of `$/progress` notifications) for
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ty_server/src/server/api/requests/workspace_diagnostic.rs</code>:78 on 2025-08-04 06:19</div>
            <div class="timeline-body"><pre><code class="language-suggestion">/// or all diagnostics are unchanged. Instead, the server keeps the request open (it doesn't reply)
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ty_server/src/server/api/requests/workspace_diagnostic.rs</code>:83 on 2025-08-04 06:19</div>
            <div class="timeline-body"><pre><code class="language-suggestion">/// the background thread running because holding on to the [`ProjectDatabase`] references
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ty_server/src/server/api/requests/workspace_diagnostic.rs</code>:179 on 2025-08-04 06:21</div>
            <div class="timeline-body"><pre><code class="language-suggestion">                // Don't respond, keep the request open (long polling).
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ty_server/src/server/api/requests/workspace_diagnostic.rs</code>:154 on 2025-08-04 06:23</div>
            <div class="timeline-body"><p>What's a &quot;Bull response&quot; ?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ty_server/src/server/api/requests/workspace_diagnostic.rs</code>:146 on 2025-08-04 06:24</div>
            <div class="timeline-body"><p>This comment doesn't seem relevant to what's happening with the code which simply calls <code>run</code>, is this intended to be placed somewhere else?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ty_server/src/server/api/diagnostics.rs</code>:32 on 2025-08-04 06:26</div>
            <div class="timeline-body"><p>nit: It might be useful to document when the return type will be <code>None</code> and <code>Some</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ty_server/src/server/main_loop.rs</code>:135 on 2025-08-04 06:27</div>
            <div class="timeline-body"><p>Oh lol, is it that the request were never retried before this PR then?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ty_server/src/session.rs</code>:216 on 2025-08-04 06:28</div>
            <div class="timeline-body"><p>I think it'd be useful to document some example cases when this should be bumped.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ty_server/src/session.rs</code>:203 on 2025-08-04 06:31</div>
            <div class="timeline-body"><p>nit: it might be worth adding a debug log for this &quot;suspended request got cancelled&quot; scenario</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ty_server/src/session.rs</code>:586 on 2025-08-04 06:33</div>
            <div class="timeline-body"><p>Why do we need to bump the version when a file is closed? Workspace diagnostics shouldn't change when a file is closed as they would still be visible in the diagnostics panel in an editor.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ty_server/tests/e2e/pull_diagnostics.rs</code>:626 on 2025-08-04 06:38</div>
            <div class="timeline-body"><p>Can we update the <code>workspace_diagnostic_request</code> method on <code>TestServer</code> with more parameters like the progress params, partial result params, etc. instead of adding another function here?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> approved on 2025-08-04 06:42</div>
            <div class="timeline-body"><p>This is awesome! Thank you for taking on the entire performance improvement part of workspace diagnostics!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-08-04 06:44</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_server/src/server/main_loop.rs</code>:135 on 2025-08-04 06:44</div>
            <div class="timeline-body"><p>yes ðŸ˜…</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-08-04 06:48</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_server/tests/e2e/pull_diagnostics.rs</code>:626 on 2025-08-04 06:48</div>
            <div class="timeline-body"><p>I sort of prefer test-local helpers because the method on <code>TestServer</code> otherwise has to accept a <code>WorkspaceDiagnosticParams</code> to support all combinations, in which case it is about as verbose as calling the method directly. What I can do is to give this function a better name</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2025-08-04 06:52</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ty_server/tests/e2e/pull_diagnostics.rs</code>:626 on 2025-08-04 06:52</div>
            <div class="timeline-body"><p>We could update the parameters on the server method to accept the parts of <code>WorkspaceDiagnosticParams</code> instead but I'm fine either way.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_server/tests/e2e/pull_diagnostics.rs</code>:626 on 2025-08-04 10:01</div>
            <div class="timeline-body"><p>Oh, I now remember why it is necessary. The key difference is that this method doesn't await the response because we need to handle the response specially (it's long polling)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-08-04 10:01</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @MichaReiser on 2025-08-04 10:26</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @MichaReiser on 2025-08-04 10:26</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-08-04 10:26</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:14:43 UTC
    </footer>
</body>
</html>
