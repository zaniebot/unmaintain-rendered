<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pre-compute the module range for LALRPOP parser - astral-sh/ruff #10879</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Pre-compute the module range for LALRPOP parser</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/10879">#10879</a>
        opened by <a href="https://github.com/dhruvmanila">@dhruvmanila</a>
        on 2024-04-11 13:20
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a></div>
            <div class="timeline-body"><h2>Summary</h2>
<p>This PR updates the LALRPOP to use the complete source range for module by looking at the tokens before the parsing begins. This means the module range now corresponds to the actual source even if it only contains trivia tokens. This is mainly so that the fuzzer doesn't crash because the AST doesn't match.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">internal</span> added by @dhruvmanila on 2024-04-11 13:20</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @dhruvmanila on 2024-04-11 13:20</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2024-04-11 16:29</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-04-11 16:31</div>
            <div class="timeline-body"><p>Oh no, the formatter fails now. I think we need to fix</p>
<p>https://github.com/astral-sh/ruff/blob/e2ec42539bfedc13270a2164faebe61e3c2e51dd/crates/ruff_python_formatter/src/module/mod_module.rs#L19-L23</p>
<p>to count the lines after <code>range.start()</code> instead of after <code>range.end()</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-04-11 16:35</div>
            <div class="timeline-body"><p>I went ahead and pushed the fix. I hope that's okay with you</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-04-11 16:36</div>
            <div class="timeline-body"><p>Thank you!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @dhruvmanila on 2024-04-11 16:45</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @dhruvmanila on 2024-04-11 16:45</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-04-11 16:45</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/codspeed-hq[bot]">@codspeed-hq[bot]</a> on 2024-04-11 16:50</div>
            <div class="timeline-body"><h2><a href="https://codspeed.io/astral-sh/ruff/branches/dhruv/mod-range-lalrpop">CodSpeed Performance Report</a></h2>
<h3>Merging #10879 will <strong>degrade performances by 5.27%</strong></h3>
<p><sub>Comparing <code>dhruv/mod-range-lalrpop</code> (d2d4b3e) with <code>dhruv/parser</code> (b069358)</sub></p>
<h3>Summary</h3>
<p><code>⚡ 2</code> improvements
<code>❌ 1</code> regressions
<code>✅ 27</code> untouched benchmarks</p>
<blockquote>
<p>:warning: <em>Please fix the performance issues or <a href="https://codspeed.io/astral-sh/ruff/branches/dhruv/mod-range-lalrpop">acknowledge them on CodSpeed</a>.</em></p>
</blockquote>
<h3>Benchmarks breakdown</h3>
<p>|     | Benchmark | <code>dhruv/parser</code> | <code>dhruv/mod-range-lalrpop</code> | Change |
| --- | --------- | ----------------------- | ------------------- | ------ |
| ⚡ | <code>parser[large/dataset.py]</code> | 28.8 ms | 26.7 ms | +8.16% |
| ⚡ | <code>parser[pydantic/types.py]</code> | 11.8 ms | 10.9 ms | +8.77% |
| ❌ | <code>parser[unicode/pypinyin.py]</code> | 1.6 ms | 1.7 ms | -5.27% |</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-04-12 06:18</div>
            <div class="timeline-body"><p>Ugh, I force pushed the branch and removed your change, I'll fix this.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:03:42 UTC
    </footer>
</body>
</html>
