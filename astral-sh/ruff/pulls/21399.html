<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[ty] Improve semantic token classification for names - astral-sh/ruff #21399</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[ty] Improve semantic token classification for names</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/21399">#21399</a>
        opened by <a href="https://github.com/MichaReiser">@MichaReiser</a>
        on 2025-11-12 09:50
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-11-12 09:50</div>
            <div class="timeline-body"><h2>Summary</h2>
<p>This PR addresses the first TODO in https://github.com/astral-sh/ty/issues/791</p>
<blockquote>
<p>Improve classification for name tokens that are imported from other modules. Currently, these are classified based on their types, which often means they're classified as variables when they should be classes, etc.</p>
</blockquote>
<p>The semantic token provider was written before we added the more involved <code>definitions_for_name</code> that resolves definitions across modules. This PR changes the semantic token provider to use <code>definitions_for_name</code> instead of rolling its own, very limited definition lookup (that only performed a lookup in the same scope).</p>
<p>This should fix many miss classifications, like that <code>float</code> was classified as a <code>Variable</code> instead of a <code>Class</code>.</p>
<p>This PR further fixes some more misclasification:</p>
<ul>
<li>Classify <code>self</code> in <code>self.x</code> within a method as <code>SelfParamter</code></li>
<li>Set the <code>Definition</code> modifier for assignments: <code>x</code> in <code>x = 10</code> is a definition</li>
<li>Classify legacy type aliases as <code>Class</code>es</li>
<li>Classify names referencing a parameter as <code>Parameter</code></li>
</ul>
<h2>Test plan</h2>
<p>Added tests, I compared all classification changes with what Pylance does</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">server</span> added by @MichaReiser on 2025-11-12 09:50</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ty</span> added by @MichaReiser on 2025-11-12 09:50</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/astral-sh-bot[bot]">@astral-sh-bot[bot]</a> on 2025-11-12 09:52</div>
            <div class="timeline-body"><!-- generated-comment typing_conformance_diagnostics_diff -->

<h2>Diagnostic diff on <a href="https://github.com/python/typing/tree/9f6d8ced7cd1c8d92687a4e9c96d7716452e471e/conformance">typing conformance tests</a></h2>
<p>No changes detected when running ty on typing conformance tests ✅</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/astral-sh-bot[bot]">@astral-sh-bot[bot]</a> on 2025-11-12 09:53</div>
            <div class="timeline-body"><!-- generated-comment mypy_primer -->

<h2><code>mypy_primer</code> results</h2>
<p>No ecosystem changes detected ✅</p>
<p>No memory usage changes detected ✅</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-11-12 10:01</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_python_semantic/src/types/ide_support.rs</code>:640 on 2025-11-12 10:01</div>
            <div class="timeline-body"><p>I realized right after landing the <em>go to definition for float and complex</em> PR that using <code>FileWithRange</code> here is a stupid idea. I switched to using <code>FileWithRange</code> to suppress the docstring (we always pick the first docstring which ended up to be <code>int</code> which is rather confusing). However, returning <code>FileWithRange</code> here breaks semantic highlighting because a <code>FileWithRange</code> has no definition.</p>
<p>That's why I opted in this PR to keep using <code>Definition</code> but return the definition for <code>float</code> first (or <code>complex</code>) so that we show the docstring of <code>float</code>.</p>
<p>This is not 100% correct because <code>float</code> is a union in this position, but it also doesn't feel entirely wrong (and sort of what I'd expect as a user).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @MichaReiser on 2025-11-12 10:04</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @MichaReiser on 2025-11-12 10:04</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @AlexWaygood by @MichaReiser on 2025-11-12 10:04</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @sharkdp by @MichaReiser on 2025-11-12 10:04</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @dcreager by @MichaReiser on 2025-11-12 10:04</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for @AlexWaygood removed by @AlexWaygood on 2025-11-12 10:10</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Gankra">@Gankra</a> reviewed on 2025-11-12 14:54</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/Gankra">@Gankra</a> on <code>crates/ty_python_semantic/src/types/ide_support.rs</code>:640 on 2025-11-12 14:54</div>
            <div class="timeline-body"><p>Could you add a comment to the <code>.rev()</code> explaining that it makes <code>float</code> / <code>complex</code> come first in their own listings?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Gankra">@Gankra</a> approved on 2025-11-12 14:55</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @MichaReiser on 2025-11-12 16:34</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @MichaReiser on 2025-11-12 16:34</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-11-12 16:34</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 16:54:20 UTC
    </footer>
</body>
</html>
