<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Use `ExprFString` for `StringLike::FString` variant - astral-sh/ruff #10311</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Use <code>ExprFString</code> for <code>StringLike::FString</code> variant</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/10311">#10311</a>
        opened by <a href="https://github.com/dhruvmanila">@dhruvmanila</a>
        on 2024-03-09 11:29
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a></div>
            <div class="timeline-body"><h2>Summary</h2>
<p>This PR updates the <code>StringLike::FString</code> variant to use <code>ExprFString</code> instead of <code>FStringLiteralElement</code>.</p>
<p>For context, the reason it used <code>FStringLiteralElement</code> is that the node is actually the string part of an f-string (&quot;foo&quot; in <code>f&quot;foo{x}&quot;</code>). But, this is inconsistent with other variants where the captured value is the <em>entire</em> string.</p>
<p>This is also problematic w.r.t. implicitly concatenated strings. Any rules which work with <code>StringLike::FString</code> doesn't account for the string part in an implicitly concatenated f-strings. For example, we don't flag confusable character in the first part of <code>&quot;ùêÅad&quot; f&quot;ùêÅad string&quot;</code>, but only the second part (https://play.ruff.rs/16071c4c-a1dd-4920-b56f-e2ce2f69c843).</p>
<h3>Update <code>PYI053</code></h3>
<p><em>This is included in this PR because otherwise it requires a temporary workaround to be compatible with the old logic.</em></p>
<p>This PR also updates the <code>PYI053</code> (<code>string-or-bytes-too-long</code>) rule for f-string to consider <em>all</em> the visible characters in a f-string, including the ones which are implicitly concatenated. This is consistent with implicitly concatenated strings and bytes.</p>
<p>For example,</p>
<pre><code class="language-python">def foo(
	# We count all the characters here
    arg1: str = '51 character ' 'stringgggggggggggggggggggggggggggggggg',
	# But not here because of the `{x}` replacement field which _breaks_ them up into two chunks
    arg2: str = f'51 character {x} stringgggggggggggggggggggggggggggggggggggggggggggg',
) -&gt; None: ...
</code></pre>
<p>This PR fixes it to consider all <em>visible</em> characters inside an f-string which includes expressions as well.</p>
<p>fixes: #10310
fixes: #10307</p>
<h2>Test Plan</h2>
<p>Add new test cases and update the snapshots.</p>
<h2>Review</h2>
<p>To facilitate the review process, the change have been split into two commits: one which has the code change while the other has the test cases and updated snapshots.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @AlexWaygood by @dhruvmanila on 2024-03-09 11:29</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @charliermarsh by @dhruvmanila on 2024-03-09 11:29</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-03-09 11:42</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_linter/src/rules/flake8_pyi/rules/string_or_bytes_too_long.rs</code>:1 on 2024-03-09 11:42</div>
            <div class="timeline-body"><p>I don't <em>object</em> to the changes here, but I feel like they're more involved than they <em>need</em> to be. There's no reason to ever use f-strings in a <code>.pyi</code> file, so I think we could honestly just skip this rule for f-strings if we wanted to.</p>
<p>In the past I've floated lints to ban f-strings in stubs altogether (https://github.com/PyCQA/flake8-pyi/pull/288), but the idea was (very reasonably!) rejected on the grounds that it's not somebody anybody would ever really want to do anyway -- so the proposed lint wouldn't actually have been solving any real-world problem</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2024-03-09 11:47</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>‚úÖ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>‚úÖ ecosystem check detected no linter changes.</p>
<h3>Formatter (stable)</h3>
<p>‚úÖ ecosystem check detected no format changes.</p>
<h3>Formatter (preview)</h3>
<p>‚úÖ ecosystem check detected no format changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_linter/src/rules/flake8_pyi/rules/string_or_bytes_too_long.rs</code>:1 on 2024-03-13 08:40</div>
            <div class="timeline-body"><p>Yeah, I agree that skipping over f-strings would be ok but I think for now we can just improve the logic to take into account all the literal characters in a f-string.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2024-03-13 08:40</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_linter/resources/test/fixtures/flake8_bandit/S104.py</code>:24 on 2024-03-13 08:41</div>
            <div class="timeline-body"><p>This is not exactly correct (https://github.com/astral-sh/ruff/issues/10308) but for now it's fine.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_linter/src/rules/flake8_bandit/rules/hardcoded_bind_all_interfaces.rs</code>:71 on 2024-03-13 08:44</div>
            <div class="timeline-body"><p>This logic is being repeated for all three rules changed in this PR. The logic being:</p>
<ul>
<li>Loop over each f-string part<ul>
<li>If it's a string literal, then directly run the check on it</li>
<li>If it's an f-string, loop over each literal and expression element of it</li>
</ul>
</li>
</ul>
<p>I'm not exactly sure on how to avoid duplicating this logic or if it's possible without introducing additional complexity.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2024-03-13 08:44</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @dhruvmanila on 2024-03-13 08:46</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-03-13 08:52</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_linter/src/rules/flake8_pyi/rules/string_or_bytes_too_long.rs</code>:1 on 2024-03-13 08:52</div>
            <div class="timeline-body"><p>The more I think about this, the less I like it in the context of this rule :/</p>
<p>The rule here uses a really dumb heuristic, but one that works surprisingly well. It just says that if a default value in a stub is long enough to fill of most the page, it's probably an implementation detail or has been inserted by a codemod or something ‚Äî since you never <em>need</em> default values in stubs (they're nice for IDE users, but never essential), you should probably take it out.</p>
<p>50 characters is a fairly arbitrary cutoff here that we use for this rule, but for the purposes of this rule, I'm not sure see I why this string should be counted as 12 characters rather than 24:</p>
<pre><code class="language-python">x = &quot;one&quot; f&quot;one{expr}one&quot; f&quot;one&quot; f&quot;{expr}&quot;
#    ^^^    ^^^      ^^^    ^^^
</code></pre>
<p>For the purposes of this rule, I think the characters in the expression parts should count just as much towards the total length as the characters in the literal parts.</p>
<p>Or we could just skip over f-strings for this rule :-)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2024-03-13 09:09</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_linter/src/rules/flake8_pyi/rules/string_or_bytes_too_long.rs</code>:1 on 2024-03-13 09:09</div>
            <div class="timeline-body"><p>My main goal with this PR is to update the <code>StringLike::FString</code> variant to use <code>ExprFString</code> instead of <code>FStringLiteralElement</code> which unlocks the following PR (#10312). As a result of that change, I'm required to update the rules which uses this variant to make sure it takes the updated value into account.</p>
<p>Now, for the other two rules it was straightforward. But for this rule, I found out that the fix was incorrect and it was marked as safe. This is what prompt me to update it so that it considers all literal characters.</p>
<blockquote>
<p>For the purposes of this rule, I think the characters in the expression parts should count just as much towards the total length as the characters in the literal parts.</p>
</blockquote>
<p>I think the reason I excluded expressions is because they could evaluate to any arbitrary amount of characters but for literal parts we're sure of the number.</p>
<p>That said I don't really have any strong opinions regarding this rule as it's not the main purpose of this PR. Sorry if this wasn't clear.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-03-13 09:18</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_linter/src/rules/flake8_pyi/rules/string_or_bytes_too_long.rs</code>:1 on 2024-03-13 09:18</div>
            <div class="timeline-body"><blockquote>
<p>I think the reason I excluded expressions is because they could evaluate to any arbitrary amount of characters but for literal parts we're sure of the number.</p>
</blockquote>
<p>For this specific rule, I think we could just be dumb about it, and not worry about how many characters the expressions in the f-string would evaluate to at runtime. We can just count the literal characters as they appear on the page, since that's what the rule is really about anyway.</p>
<p>But I continue to think that the simplest way of fixing the incorrect behaviour you pointed out in https://github.com/astral-sh/ruff/issues/10307 would be to just skip over f-strings for this rule üòÑ</p>
<blockquote>
<p>That said I don't really have any strong opinions regarding this rule as it's not the main purpose of this PR. Sorry if this wasn't clear.</p>
</blockquote>
<p>Fully understood ‚Äî I can open a separate PR to skip over f-strings in this rule, if that's easier?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2024-03-13 09:30</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_linter/src/rules/flake8_pyi/rules/string_or_bytes_too_long.rs</code>:1 on 2024-03-13 09:30</div>
            <div class="timeline-body"><blockquote>
<p>But I continue to think that the simplest way of fixing the incorrect behaviour you pointed out in #10307 would be to just skip over f-strings for this rule üòÑ</p>
</blockquote>
<p>Maybe just skip if it contains expressions? So that for something like <code>f&quot;aaaaaaaa&quot;</code> we still raise the violation. This change will only be possible <em>after</em> this PR as it requires looking at the <code>ExprFString</code> instead of just the <code>FStringLiteralElement</code>. What do you think?</p>
<blockquote>
<p>Fully understood ‚Äî I can open a separate PR to skip over f-strings in this rule, if that's easier?</p>
</blockquote>
<p>I don't mind making the change in this PR itself.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-03-13 11:02</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_linter/src/rules/flake8_pyi/rules/string_or_bytes_too_long.rs</code>:1 on 2024-03-13 11:02</div>
            <div class="timeline-body"><blockquote>
<p>Maybe just skip if it contains expressions?</p>
</blockquote>
<p>Hmm, not really a fan... I think we should either <em>always</em> skip over f-strings for this rule, or count the characters according to how they literally appear on the page. I've never seen anybody use an f-string in a stub, but if they did, I think it would be really confusing for users if this triggered a violation:</p>
<pre><code class="language-py">x: str = f'xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx'
</code></pre>
<p>but this didn't:</p>
<pre><code class="language-py">x: str = f'xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx{}'
</code></pre>
<p>given that the latter obviously takes up more space on the page!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-03-14 04:10</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_linter/src/rules/flake8_pyi/rules/string_or_bytes_too_long.rs</code>:1 on 2024-03-14 04:10</div>
            <div class="timeline-body"><p>I agree that &quot;raw characters, including expressions&quot; makes more sense but I don't feel strongly. I think either approach is fine, and it's just very unlikely to make a difference in practice.</p>
<p>If it were me, I might do: if the f-string contains an expression, <em>always</em> flag it; if not, count the characters.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> approved on 2024-03-14 04:10</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> approved on 2024-03-14 07:57</div>
            <div class="timeline-body"><p>the flake8-pyi changes LGTM now, thanks!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">internal</span> added by @dhruvmanila on 2024-03-14 07:58</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @dhruvmanila on 2024-03-14 08:00</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @dhruvmanila on 2024-03-14 08:00</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-03-14 08:00</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:03:02 UTC
    </footer>
</body>
</html>
