<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Use strict sorted and union for NoQA mapping insertion - astral-sh/ruff #7531</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Use strict sorted and union for NoQA mapping insertion</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/7531">#7531</a>
        opened by <a href="https://github.com/dhruvmanila">@dhruvmanila</a>
        on 2023-09-20 05:40
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a></div>
            <div class="timeline-body"><h2>Summary</h2>
<p>This PR fixes the way NoQA range is inserted to the <code>NoqaMapping</code>.</p>
<p>Previously, the way the mapping insertion logic worked was as follows:</p>
<ol>
<li>If the range which is to be inserted <em>touched</em> the previous range, meaning
that the end of the previous range was the same as the start of the new
range, then the new range was added in addition to the previous range.</li>
<li>Else, if the new range intersected the previous range, then the previous
range was replaced with the new <em>intersection</em> of the two ranges.</li>
</ol>
<p>The problem with this logic is that it does not work for the following case:</p>
<pre><code class="language-python">assert foo, \
    &quot;&quot;&quot;multi-line
    string&quot;&quot;&quot;
</code></pre>
<p>Now, the comments cannot be added to the same line which ends with a continuation
character. So, the <code>NoQA</code> directive has to be added to the next line. But, the
next line is also a triple-quoted string, so the <code>NoQA</code> directive for that line
needs to be added to the next line. This creates a <strong>union</strong> pattern instead of an
<strong>intersection</strong> pattern.</p>
<p>But, only union doesn't suffice because (1) means that for the edge case where
the range touch only at the end, the union won't take place.</p>
<h3>Solution</h3>
<ol>
<li>Replace '&lt;=' with '&lt;' to have a <em>strict</em> insertion case</li>
<li>Use union instead of intersection</li>
</ol>
<h2>Test Plan</h2>
<p>Add a new test case. Run the test suite to ensure that nothing is broken.</p>
<h3>Integration</h3>
<ol>
<li><p>Make a <code>test.py</code> file with the following contents:</p>
<pre><code class="language-python">assert foo, \
    &quot;&quot;&quot;multi-line
    string&quot;&quot;&quot;
</code></pre>
</li>
<li><p>Run the following command:</p>
<pre><code class="language-console">$ cargo run --bin ruff -- check --isolated --no-cache --select=F821 test.py
/Users/dhruv/playground/ruff/fstring.py:1:8: F821 Undefined name `foo`
Found 1 error.
</code></pre>
</li>
<li><p>Use <code>--add-noqa</code>:</p>
<pre><code class="language-console">$ cargo run --bin ruff -- check --isolated --no-cache --select=F821 --add-noqa test.py
Added 1 noqa directive.
</code></pre>
</li>
<li><p>Check that the NoQA directive was added in the correct position:</p>
<pre><code class="language-python">assert foo, \
    &quot;&quot;&quot;multi-line
    string&quot;&quot;&quot;  # noqa: F821
</code></pre>
</li>
<li><p>Run the <code>check</code> command to ensure that the NoQA directive is respected:</p>
<pre><code class="language-console">$ cargo run --bin ruff -- check --isolated --no-cache --select=F821 test.py
</code></pre>
</li>
</ol>
<p>fixes: #7530</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2023-09-20 05:41</div>
            <div class="timeline-body"><p>Current dependencies on/for this PR:</p>
<ul>
<li>main<ul>
<li><strong>PR #7531</strong> <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7531" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a>  ðŸ‘ˆ</li>
</ul>
</li>
</ul>
<p>This comment was auto-generated by <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7531?utm_source=stack-comment">Graphite</a>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @dhruvmanila on 2023-09-20 05:55</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">noqa</span> added by @dhruvmanila on 2023-09-20 05:55</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @charliermarsh by @dhruvmanila on 2023-09-20 05:55</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2023-09-20 05:56</div>
            <div class="timeline-body"><h2>PR Check Results</h2>
<h3>Ecosystem</h3>
<p>âœ… ecosystem check detected no changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2023-09-20 06:25</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @dhruvmanila on 2023-09-20 11:07</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @dhruvmanila on 2023-09-20 11:07</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2023-09-20 11:07</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:00:24 UTC
    </footer>
</body>
</html>
