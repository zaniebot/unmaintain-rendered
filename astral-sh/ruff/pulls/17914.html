<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[ty] Improve UX for `[duplicate-base]` diagnostics - astral-sh/ruff #17914</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[ty] Improve UX for <code>[duplicate-base]</code> diagnostics</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/17914">#17914</a>
        opened by <a href="https://github.com/AlexWaygood">@AlexWaygood</a>
        on 2025-05-07 12:47
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a></div>
            <div class="timeline-body"><h2>Summary</h2>
<p>This PR improves the UX of our <code>duplicate-base</code> diagnostics so that we:</p>
<ul>
<li>Say explicitly what's wrong with including a duplicate base (it's going to raise <code>TypeError</code> at runtime)</li>
<li>Highlight the original occurence of the base in the bases list as well as its second occurence</li>
<li>If a base is duplicated multiple times, only report a single diagnostic for all occurences rather than multiple diagnostics</li>
</ul>
<details>
<summary>Screenshot of what the new diagnostics look like in the terminal</summary>

<p><img src="https://github.com/user-attachments/assets/6d8a7bd5-0e03-418a-8c82-8db5212aeabc" alt="image" /></p>
</details>

<h2>Test Plan</h2>
<p>Snapshots added</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @AlexWaygood on 2025-05-07 12:47</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @sharkdp by @AlexWaygood on 2025-05-07 12:47</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @dcreager by @AlexWaygood on 2025-05-07 12:47</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ty</span> added by @AlexWaygood on 2025-05-07 12:47</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-05-07 12:50</div>
            <div class="timeline-body"><!-- generated-comment mypy_primer -->

<h2><code>mypy_primer</code> results</h2>
<p>No ecosystem changes detected âœ…</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-05-07 12:53</div>
            <div class="timeline-body"><p>Nice.</p>
<p>I think this does have the downside that it's now only possible to suppress the error at the first or last line of the class declaration but not where the base class is repeated (because suppressions use the primary range).</p>
<p>Have you considered changing the primary range to the arguments range instead of the entire class header?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_python_semantic/src/types/mro.rs</code>:336 on 2025-05-07 12:56</div>
            <div class="timeline-body"><pre><code class="language-suggestion">    /// the second index is the base's invalid later occurrence.
</code></pre>
<p>There can be more than two occurences. Which I think also shows a shortcoming of this implementation because we would still emit three diagnostics for <code>class Bar(Foo, Foo, Foo, Foo)</code>.</p>
<p>Ideally, we would group all repetitive bases together</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-05-07 12:57</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_python_semantic/src/types/infer.rs</code>:781 on 2025-05-07 12:57</div>
            <div class="timeline-body"><p>Adding snapshots revealed that we weren't reporting all diagnostics in source order if there were multiple <code>[duplicate-base]</code> diagnostics in the same file. This fixes that.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-05-07 12:58</div>
            <div class="timeline-body"><blockquote>
<p>I think this does have the downside that it's now only possible to suppress the error at the first or last line of the class declaration but not where the base class is repeated (because suppressions use the primary range).</p>
</blockquote>
<p>Yeah. I think this is justifiable, though, given that it's the class definition as a whole that will fail and raise an exception at runtime, not any of the sub-expressions inside the argument list.</p>
<blockquote>
<p>Have you considered changing the primary range to the arguments range instead of the entire class header?</p>
</blockquote>
<p>I could do that, but again, it's the class definition as a whole that will fail; the name of the class feels like relevant information that's useful to have highlighted</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-05-07 12:58</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-05-07 13:00</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_python_semantic/src/types/mro.rs</code>:336 on 2025-05-07 13:00</div>
            <div class="timeline-body"><p>hmm, true</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-05-07 13:27</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_python_semantic/src/types/mro.rs</code>:336 on 2025-05-07 13:27</div>
            <div class="timeline-body"><p>working on this</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-05-07 13:45</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_python_semantic/src/types/mro.rs</code>:336 on 2025-05-07 13:45</div>
            <div class="timeline-body"><p>Fixed in https://github.com/astral-sh/ruff/pull/17914/commits/1ec9b0ee8588dbe7247177fefd41a8dfa5c9a9c1</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @AlexWaygood on 2025-05-07 13:46</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_python_semantic/resources/mdtest/mro.md</code>:316 on 2025-05-07 13:48</div>
            <div class="timeline-body"><p>Could you add an example where we suppress the diagnostic. Just to make sure it works as expected when suppressing it on line 309 or 316</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_python_semantic/src/types/infer.rs</code>:781 on 2025-05-07 13:49</div>
            <div class="timeline-body"><p>We should fix this in the mdtest framework. We already sort diagnostics in the CLI</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2025-05-07 13:50</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> approved on 2025-05-07 13:51</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_python_semantic/src/types/infer.rs</code>:781 on 2025-05-07 15:05</div>
            <div class="timeline-body"><p>I'll revert this for now and accept a snapshot with the diagnostics in an odd order. Will tackle the mdtest sorting in a followup.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-05-07 15:05</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-05-07 15:26</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_python_semantic/resources/mdtest/mro.md</code>:316 on 2025-05-07 15:26</div>
            <div class="timeline-body"><p>added in https://github.com/astral-sh/ruff/pull/17914/commits/e99571bfb2d4faa55322670d21644ed1ccd83a58</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @AlexWaygood on 2025-05-07 15:27</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @AlexWaygood on 2025-05-07 15:27</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-05-07 15:27</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:12:17 UTC
    </footer>
</body>
</html>
