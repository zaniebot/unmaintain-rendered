<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add `Locator::convert_row_and_column` to convert LSP utf-16 coordinates to byte offsets - astral-sh/ruff #7571</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Add <code>Locator::convert_row_and_column</code> to convert LSP utf-16 coordinates to byte offsets</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/pull/7571">#7571</a>
        opened by <a href="https://github.com/konstin">@konstin</a>
        on 2023-09-21 11:36
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/konstin">@konstin</a> on 2023-09-21 11:36</div>
            <div class="timeline-body"><p><strong>Summary</strong> Compute the byte offset from language server protocol zero-indexed row and column indices.</p>
<p>It's possible to negotiate the text encoding with the LSP client, but the default that must
always be supported and that we currently use is utf-16.</p>
<p>We get row and column from the LSP. E.g.</p>
<pre><code class="language-text">a=(1,2,)
b=(3,4,)
  ^
c=(5,6,)
</code></pre>
<p>has coordinates <code>1:2</code>. Note that indices are computed in utf-16, e.g.</p>
<pre><code class="language-text">&quot;ÏïàÎÖï&quot;
   ^
</code></pre>
<p>where the first syllable is a single character (two bytes), we get <code>0:2</code>, while for</p>
<pre><code class="language-text">&quot;·ÑÄ·Ö°·Ü∑·ÑÄ·Öµ&quot;
   ^
</code></pre>
<p>where the first syllable is three characters (three times two bytes), we get <code>0:4</code>. But for</p>
<pre><code class="language-text">Ë±ÜËÖê
  ^
</code></pre>
<p>we get <code>0:2</code> because <code>Ë±Ü</code> is two characters (4 bytes) in utf-16.</p>
<p><strong>Test Plan</strong> Doc tests</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2023-09-21 11:36</div>
            <div class="timeline-body"><p>Current dependencies on/for this PR:</p>
<ul>
<li>main<ul>
<li><strong>PR #7569</strong> <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7569" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a><ul>
<li><strong>PR #7571</strong> <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7571" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a>  üëà</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>This comment was auto-generated by <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7571?utm_source=stack-comment">Graphite</a>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">internal</span> added by @konstin on 2023-09-21 11:36</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">formatter</span> added by @konstin on 2023-09-21 11:36</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-09-21 11:41</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_source_file/src/locator.rs</code>:494 on 2023-09-21 11:41</div>
            <div class="timeline-body"><p>We may need to move this out of <code>Locator</code>. The goal is to remove all <code>Index</code> uses inside of <code>Locator</code> eventually.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff_source_file/src/locator.rs</code>:494 on 2023-09-21 11:56</div>
            <div class="timeline-body"><p>Should it live directly on Index instead?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2023-09-21 11:56</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2023-09-26 08:34</div>
            <div class="timeline-body"><h2>PR Check Results</h2>
<h3>Ecosystem</h3>
<p>‚úÖ ecosystem check detected no changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "Add `Locator::convert_row_and_column` to convert LSP coordinates to byte offsets" to "Add `Locator::convert_row_and_column` to convert LSP utf-16 coordinates to byte offsets" by @konstin on 2023-09-26 08:45</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2023-09-26 08:48</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff_source_file/src/locator.rs</code>:494 on 2023-09-26 08:48</div>
            <div class="timeline-body"><p>i think it needs to live in the locator because we need both fields</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @konstin on 2023-09-26 08:48</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @konstin on 2023-09-26 08:48</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_source_file/src/locator.rs</code>:506 on 2023-09-26 10:59</div>
            <div class="timeline-body"><p>I would prefer if we move the method to <code>LineIndex</code> directly</p>
<p>Can we use <code>OneIndexed</code> for <code>row</code> and <code>column</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_source_file/src/locator.rs</code>:513 on 2023-09-26 10:59</div>
            <div class="timeline-body"><pre><code class="language-suggestion">        let line_range = *self.to_index().line_range(row)
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_source_file/src/locator.rs</code>:522 on 2023-09-26 11:00</div>
            <div class="timeline-body"><p>This should not be necessary when you use <code>line_range</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_source_file/src/locator.rs</code>:523 on 2023-09-26 11:01</div>
            <div class="timeline-body"><p>The LSP specification mentions that the column should be clamped to the line length</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-09-26 11:01</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-09-26 11:38</div>
            <div class="timeline-body"><p>My main question is whether we should tie our CLI API to the LSP specification or not. I would expect that <code>ruff format --range-start 34:01 --range-end 35:30</code> (or similar) to use character indices rather than UTF-16 words as column offset.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2023-09-26 12:12</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff_source_file/src/locator.rs</code>:506 on 2023-09-26 12:12</div>
            <div class="timeline-body"><p>That doesn't work because we need the source</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2023-09-26 12:14</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff_source_file/src/locator.rs</code>:506 on 2023-09-26 12:14</div>
            <div class="timeline-body"><blockquote>
<p>Can we use OneIndexed for row and column?</p>
</blockquote>
<p>They aren't! The origin is (0,0)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2023-09-26 12:24</div>
            <div class="timeline-body"><p>I wouldn't do this conversion in python so we need to to it in rust. For me it would make most sense to have to have a <code>--offset-kind</code> flag and/or to have a separate <code>ruff format-lsp subcommand</code>, but i'd need this method either way</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/codspeed-hq[bot]">@codspeed-hq[bot]</a> on 2023-09-26 12:31</div>
            <div class="timeline-body"><h2><a href="https://codspeed.io/astral-sh/ruff/branches/col-row-coords-to-bytes-offsets">CodSpeed Performance Report</a></h2>
<h3>Merging #7571 will <strong>improve performances by 2.48%</strong></h3>
<p><sub>Comparing <code>col-row-coords-to-bytes-offsets</code> (5be2ec5) with <code>_formatter-and-parser-refactorings</code> (dd8b124)</sub></p>
<h3>Summary</h3>
<p><code>‚ö° 1</code> improvements
<code>‚úÖ 24</code> untouched benchmarks</p>
<h3>Benchmarks breakdown</h3>
<p>|     | Benchmark | <code>_formatter-and-parser-refactorings</code> | <code>col-row-coords-to-bytes-offsets</code> | Change |
| --- | --------- | ----------------------- | ------------------- | ------ |
| ‚ö° | <code>linter/all-rules[numpy/ctypeslib.py]</code> | 35 ms | 34.1 ms | +2.48% |</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-09-26 13:08</div>
            <div class="timeline-body"><blockquote>
<p>I wouldn't do this conversion in python so we need to to it in rust. For me it would make most sense to have to have a <code>--offset-kind</code> flag and/or to have a separate <code>ruff format-lsp subcommand</code>, but i'd need this method either way</p>
</blockquote>
<p>I think the UTF16 to characters conversion is an LSP concern and shouldn't influence how we represent offsets in our CLI. I would find it rather confusing as a user if I have to compute utf 16 word offsets to use the CLI.</p>
<p>I agree, that we'll need a <code>offset(row, column, text)</code> method.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff_source_file/src/locator.rs</code>:523 on 2023-09-26 13:31</div>
            <div class="timeline-body"><p>yep, but we can't guarantee what values we get passed in here</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2023-09-26 13:31</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2023-09-26 13:34</div>
            <div class="timeline-body"><p>I agree, but what alternative would you suggest? The CLI is currently our LSP interface, and even it weren't, we'd get <code>usize</code>/<code>u32</code> in we'd need to convert. I don't expect that people would actually range format by hand (just manually indent at that point), just hiding the option, either in <code>ruff format</code> or somewhere else seems the most reasonable to me.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-09-26 15:29</div>
            <div class="timeline-body"><blockquote>
<p>I agree, but what alternative would you suggest? The CLI is currently our LSP interface, and even it weren't, we'd get <code>usize</code>/<code>u32</code> in we'd need to convert. I don't expect that people would actually range format by hand (just manually indent at that point), just hiding the option, either in <code>ruff format</code> or somewhere else seems the most reasonable to me.</p>
</blockquote>
<p>I recommend converting the range to <code>line:character</code> in the LSP and adding an <code>offset(row: OneIndexed, column: OneIndexed) -&gt; TextSize</code> to <code>LineIndex</code> similar to how you did. That would match the conversion from <code>Fix::edits</code> to lsp <code>TextEdit</code> where we handle the offset conversion as well.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @konstin on 2023-10-30 13:09</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 02:13:13 UTC
    </footer>
</body>
</html>
