<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[`ruff`] Implement missing `await` for coroutine (`RUF066`) - astral-sh/ruff #9911</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[<code>ruff</code>] Implement missing <code>await</code> for coroutine (<code>RUF066</code>)</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/ruff/pull/9911">#9911</a>
        opened by <a href="https://github.com/mikeleppane">@mikeleppane</a>
        on 2024-02-09 13:15
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/mikeleppane">@mikeleppane</a> on 2024-02-09 13:15</div>
            <div class="timeline-body"><h2>Summary</h2>
<p>Detect never-awaited <a href="https://docs.python.org/3/library/asyncio-dev.html#detect-never-awaited-coroutines">coroutines</a></p>
<p>This rule only applies to simple scenarios. We need to be quite conservative on how to handle coroutines. Because there are many situations in which the programmer does not want to evaluate/await a coroutine but instead use the actual coroutine object.</p>
<p>Closes https://github.com/astral-sh/ruff/issues/9833</p>
<h2>Test Plan</h2>
<pre><code class="language-bash">cargo test
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2024-02-09 14:01</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/codspeed-hq[bot]">@codspeed-hq[bot]</a> on 2024-02-09 14:08</div>
            <div class="timeline-body"><!-- __CODSPEED_PERFORMANCE_REPORT_COMMENT__ -->

<h2><a href="https://codspeed.io/astral-sh/ruff/branches/mikeleppane%3Arule(RUF028">CodSpeed Performance Report</a>%2Fdetect-unused-await?utm_source=github&amp;utm_medium=comment&amp;utm_content=header)</h2>
<h3>Merging #9911 will <strong>not alter performance</strong></h3>
<p><sub>Comparing <code>mikeleppane:rule(RUF028)/detect-unused-await</code> (37bc212) with <code>main</code> (46decd4)</sub></p>
<h3>Summary</h3>
<p><code>✅ 30</code> untouched<br />
<code>⏩ 13</code> skipped[^skipped]</p>
<p>[^skipped]: 13 benchmarks were skipped, so the baseline results were used instead. If they were deleted from the codebase, <a href="https://codspeed.io/astral-sh/ruff/branches/mikeleppane%3Arule(RUF028">click here and archive them to remove them from the performance reports</a>%2Fdetect-unused-await?sectionId=benchmark-comparison-section-baseline-result-skipped&amp;utm_source=github&amp;utm_medium=comment&amp;utm_content=archive).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-02-09 23:45</div>
            <div class="timeline-body"><p>Thanks for contributing!</p>
<p>It looks like the ecosystem checks are showing some false positives e.g. https://github.com/apache/airflow/blob/48bfb1a970f5b47ba1b385ad809b8324923ddf3e/tests/providers/google/cloud/hooks/test_dataflow.py#L1956 — could you look into those?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/mikeleppane">@mikeleppane</a> on 2024-02-10 07:51</div>
            <div class="timeline-body"><blockquote>
<p>Thanks for contributing!</p>
<p>It looks like the ecosystem checks are showing some false positives e.g. https://github.com/apache/airflow/blob/48bfb1a970f5b47ba1b385ad809b8324923ddf3e/tests/providers/google/cloud/hooks/test_dataflow.py#L1956 — could you look into those?</p>
</blockquote>
<p>Thanks! Good catch.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @zanieb by @zanieb on 2024-02-12 21:10</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">accepted</span> added by @MichaReiser on 2024-04-05 10:27</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-04-05 10:28</div>
            <div class="timeline-body"><p>This rule fits into ruff as a suspicious rule. I think we should rename the rule to <code>never-awaited-coroutines</code> so that <code>allow(never-awaited-coroutines)</code> reads better.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/earonesty">@earonesty</a> reviewed on 2024-04-09 22:16</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/earonesty">@earonesty</a> on <code>crates/ruff_linter/resources/test/fixtures/ruff/RUF028.py</code>:110 on 2024-04-09 22:16</div>
            <div class="timeline-body"><p>is this ok?  another_coro is never awaited.   if you await coro() you will get an unevaluated coro.</p>
<p>this works tho:</p>
<pre><code>async def test_coroutine_with_sync_return():
    async def another_coro():
        pass
    def coro():
        return another_coro()
    await coro()  # OK
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/akselerando">@akselerando</a> on 2024-04-30 12:51</div>
            <div class="timeline-body"><p>Hi, any update on when this will be released?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_linter/src/rules/ruff/rules/missing_await_for_coroutine.rs</code>:135 on 2024-05-01 11:26</div>
            <div class="timeline-body"><p>The function docs doesn't match what it actually returns. I think we should either return the <code>Fix</code> as mentioned in the docs or update the name to something like <code>create_await_expr</code>. I would recommend to go with the former.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_linter/src/rules/ruff/rules/missing_await_for_coroutine.rs</code>:79 on 2024-05-01 11:32</div>
            <div class="timeline-body"><p>The curly braces aren't required for empty structs</p>
<pre><code class="language-suggestion">    let mut diagnostic = Diagnostic::new(MissingAwaitForCoroutine, call.range);
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_linter/src/rules/ruff/rules/missing_await_for_coroutine.rs</code>:67 on 2024-05-01 11:33</div>
            <div class="timeline-body"><p>I think it might be useful to move the comment as part of <code>possibly_missing_await</code>'s documentation.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_linter/src/rules/ruff/rules/missing_await_for_coroutine.rs</code>:84 on 2024-05-01 11:35</div>
            <div class="timeline-body"><p>nit: we could possibly just create an <code>Insertion</code> edit instead at the start of the call expression.</p>
<pre><code class="language-suggestion">    diagnostic.set_fix(Fix::unsafe_edit(Edit::insertion(
        &quot;await &quot;.to_string(),
        call.start(),
    )));
</code></pre>
<p>which is basically what the generator does as well ;)</p>
<p>https://github.com/astral-sh/ruff/blob/f76a3e850209977ec52ad48f01ff242d287406de/crates/ruff_python_codegen/src/generator.rs#L980-L985</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_linter/src/rules/ruff/rules/missing_await_for_coroutine.rs</code>:66 on 2024-05-01 11:39</div>
            <div class="timeline-body"><p>nit: Do you think it would be helpful for the user to know this limitation? If so, we could possibly provide a &quot;Limitations&quot; section in the rule documentation. For example, refer https://docs.astral.sh/ruff/rules/implicit-optional/#limitations.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> approved on 2024-05-01 11:41</div>
            <div class="timeline-body"><p>Thank you for implementing this rule!</p>
<p>Can either @zanieb or @AlexWaygood look at this? It's good to go from my side but I've mainly looked at the code part of the rule as I'm not an async expert :)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">rule</span> added by @dhruvmanila on 2024-05-01 11:42</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">preview</span> added by @dhruvmanila on 2024-05-01 11:42</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "rule(`RUF028`) Implement missing await for coroutine" to "[`ruff`] Implement missing `await` for coroutine (`RUF028`)" by @dhruvmanila on 2024-05-01 11:42</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/akselerando">@akselerando</a> on 2024-09-19 07:21</div>
            <div class="timeline-body"><p>Hi again, when can we expect this to be released?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @AlexWaygood by @MichaReiser on 2024-09-19 07:25</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for @AlexWaygood removed by @AlexWaygood on 2025-04-15 17:55</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/amyreese">@amyreese</a> on 2025-09-23 03:16</div>
            <div class="timeline-body"><p>Rebased onto latest main (now it's <code>RUF066</code>) and addressed most review comments.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "[`ruff`] Implement missing `await` for coroutine (`RUF028`)" to "[`ruff`] Implement missing `await` for coroutine (`RUF066`)" by @amyreese on 2025-09-23 03:16</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/amyreese">@amyreese</a> reviewed on 2025-09-23 03:18</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/amyreese">@amyreese</a> on <code>crates/ruff_linter/resources/test/fixtures/ruff/RUF028.py</code>:110 on 2025-09-23 03:18</div>
            <div class="timeline-body"><p>This looks like a legimitate miss. Will need to figure out how to catch that case (I'm not sure how it differs from other test cases that catch this).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @amyreese on 2025-09-23 03:18</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @ntBre by @amyreese on 2025-09-23 03:18</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-09-23 08:32</div>
            <div class="timeline-body"><p>@amyreese did you make any other changes besides rebasing/renaming the rule (trying to understand where I need to focus my review on :))? Reading your other comment, I assume you reviewed the rule's semantics already.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/amyreese">@amyreese</a> on 2025-09-23 15:10</div>
            <div class="timeline-body"><blockquote>
<p>@amyreese did you make any other changes besides rebasing/renaming the rule (trying to understand where I need to focus my review on :))? Reading your other comment, I assume you reviewed the rule's semantics already.</p>
</blockquote>
<p>I made changes to fix/address all of Dhruv's comments, and to update it where internal API's changed. I have no changed functionality though, and the name is the same as it was when it was last updated by the original author. The semantics generally look good to me, though I'm concerned about one of the test cases being &quot;clean&quot; when IMO it should be triggering a diagnostic.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/ruff/rules/missing_await_for_coroutine.rs</code>:47 on 2025-09-23 17:18</div>
            <div class="timeline-body"><p>I also think it's worth mentioning that this check only applies to functions defined in the same file as the caller. Calls to functions defined in other files will always be accepted because Ruff can't infer their types.</p>
<p>This is also my biggest hesitation with merging this rule as it can give users a false sense of safety where they think ruff would catch unawaited co-routines, but it only catches those that are between calls in the same file.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/ruff/rules/missing_await_for_coroutine.rs</code>:111 on 2025-09-23 17:19</div>
            <div class="timeline-body"><p>What are cases where the <code>name</code> wouldn't match the <code>id</code> after looking up the binding.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-09-23 17:24</div>
            <div class="timeline-body"><p>I still need to look at the test cases and the case we currently miss but I, unfortunately, ran out of time today so this has to wait for tomorrow.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-09-25 11:41</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/resources/test/fixtures/ruff/RUF028.py</code>:110 on 2025-09-25 11:41</div>
            <div class="timeline-body"><p>Yeah, I think we should catch this</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-09-25 11:43</div>
            <div class="timeline-body"><p>I think it'd be great if this rule could use Ruff's limited type checker functionality to infer what <code>Awaitable</code> bindings are. For example, it would be great if Ruff detects if a parameter annotated with <code>Awaitable</code> is never awaited.</p>
<p>I'm a bit surprised that there are zero ecosystem hits. It makes me wonder if it's because the rule's capabilities are too limited or if there are other reasons.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/amyreese">@amyreese</a> on 2025-09-30 18:05</div>
            <div class="timeline-body"><blockquote>
<p>I think it'd be great if this rule could use Ruff's limited type checker functionality to infer what <code>Awaitable</code> bindings are. For example, it would be great if Ruff detects if a parameter annotated with <code>Awaitable</code> is never awaited.</p>
</blockquote>
<p>Is that something that Ruff can do, or does that require getting type information from ty?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-10-01 06:48</div>
            <div class="timeline-body"><blockquote>
<p>Is that something that Ruff can do, or does that require getting type information from ty?</p>
</blockquote>
<p>That's something Ruff can &quot;do&quot; already today. It's a bit manual. See the <code>TypeChecker</code> trait and its implementations</p>
<p>https://github.com/astral-sh/ruff/blob/32be31d2f9dce7a5e23b406c5b8a338dc4d21755/crates/ruff_python_semantic/src/analyze/typing.rs#L582-L587</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 17:00:12 UTC
    </footer>
</body>
</html>
