<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>B901 catches yields in subexprs and more sensitive B901 - astral-sh/ruff #15101</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>B901 catches yields in subexprs and more sensitive B901</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/pull/15101">#15101</a>
        opened by <a href="https://github.com/guptaarnav">@guptaarnav</a>
        on 2024-12-22 20:37
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/guptaarnav">@guptaarnav</a> on 2024-12-22 20:37</div>
            <div class="timeline-body"><!--
Thank you for contributing to Ruff! To help us out with reviewing, please consider the following:

- Does this pull request include a summary of the change? (See below.)
- Does this pull request include a descriptive title?
- Does this pull request include references to any relevant issues?
-->

<h2>Summary</h2>
<p>Closes #14453 by updating the implementation of the B901 lint rule.  The changes ensure that:
1.	The visitor now traverses all expressions within statements, ensuring yield expressions embedded are correctly flagged even if they are not the expression of an <code>ExprStmt</code>.
2.     The rule now correctly identifies yield and yield from expressions when they appear as the right-hand side of assignment statements (e.g., x = yield or x = yield from []); this catches the case mentioned in the original issue by @AlexWaygood.
3.     We still do not recurse into lambda expressions or nested function defs as these are evaluated separately.</p>
<h2>Test Plan</h2>
<p>I added the tests mentioned by @MichaReiser and @AlexWaygood in the original issue into <code>test/fixtures/flake8_bugbear/B901.py</code> and updated the related snapshot.</p>
<!-- How was it tested? -->

</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2024-12-22 20:43</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>ℹ️ ecosystem check <strong>detected linter changes</strong>. (+32 -0 violations, +0 -0 fixes in 2 projects; 53 projects unchanged)</p>
<details><summary><a href="https://github.com/python-trio/trio">python-trio/trio</a> (+1 -0 violations, +0 -0 fixes)</summary>
<p>
<pre>ruff check --no-cache --exit-zero --ignore RUF9 --output-format concise --preview</pre>
</p>
<p>

<pre>
+ <a href='https://github.com/python-trio/trio/blob/a670d60c61b5d4e2b0506eb8b6c7b053ad26d409/src/trio/_core/_traps.py#L63'>src/trio/_core/_traps.py:63:5:</a> B901 Using `yield` and `return {value}` in a generator function can lead to confusing behavior
</pre>

</p>
</details>
<details><summary><a href="https://github.com/pytest-dev/pytest">pytest-dev/pytest</a> (+31 -0 violations, +0 -0 fixes)</summary>
<p>
<pre>ruff check --no-cache --exit-zero --ignore RUF9 --output-format concise --preview</pre>
</p>
<p>

<pre>
+ <a href='https://github.com/pytest-dev/pytest/blob/24e84f08f43216f95620135305cbebe9f646e433/src/_pytest/assertion/__init__.py#L188'>src/_pytest/assertion/__init__.py:188:9:</a> B901 Using `yield` and `return {value}` in a generator function can lead to confusing behavior
+ <a href='https://github.com/pytest-dev/pytest/blob/24e84f08f43216f95620135305cbebe9f646e433/src/_pytest/cacheprovider.py#L298'>src/_pytest/cacheprovider.py:298:9:</a> B901 Using `yield` and `return {value}` in a generator function can lead to confusing behavior
+ <a href='https://github.com/pytest-dev/pytest/blob/24e84f08f43216f95620135305cbebe9f646e433/src/_pytest/cacheprovider.py#L419'>src/_pytest/cacheprovider.py:419:9:</a> B901 Using `yield` and `return {value}` in a generator function can lead to confusing behavior
+ <a href='https://github.com/pytest-dev/pytest/blob/24e84f08f43216f95620135305cbebe9f646e433/src/_pytest/cacheprovider.py#L461'>src/_pytest/cacheprovider.py:461:9:</a> B901 Using `yield` and `return {value}` in a generator function can lead to confusing behavior
+ <a href='https://github.com/pytest-dev/pytest/blob/24e84f08f43216f95620135305cbebe9f646e433/src/_pytest/capture.py#L872'>src/_pytest/capture.py:872:9:</a> B901 Using `yield` and `return {value}` in a generator function can lead to confusing behavior
+ <a href='https://github.com/pytest-dev/pytest/blob/24e84f08f43216f95620135305cbebe9f646e433/src/_pytest/capture.py#L877'>src/_pytest/capture.py:877:13:</a> B901 Using `yield` and `return {value}` in a generator function can lead to confusing behavior
+ <a href='https://github.com/pytest-dev/pytest/blob/24e84f08f43216f95620135305cbebe9f646e433/src/_pytest/capture.py#L882'>src/_pytest/capture.py:882:13:</a> B901 Using `yield` and `return {value}` in a generator function can lead to confusing behavior
+ <a href='https://github.com/pytest-dev/pytest/blob/24e84f08f43216f95620135305cbebe9f646e433/src/_pytest/capture.py#L887'>src/_pytest/capture.py:887:13:</a> B901 Using `yield` and `return {value}` in a generator function can lead to confusing behavior
+ <a href='https://github.com/pytest-dev/pytest/blob/24e84f08f43216f95620135305cbebe9f646e433/src/_pytest/config/__init__.py#L1435'>src/_pytest/config/__init__.py:1435:13:</a> B901 Using `yield` and `return {value}` in a generator function can lead to confusing behavior
+ <a href='https://github.com/pytest-dev/pytest/blob/24e84f08f43216f95620135305cbebe9f646e433/src/_pytest/debugging.py#L303'>src/_pytest/debugging.py:303:9:</a> B901 Using `yield` and `return {value}` in a generator function can lead to confusing behavior
+ <a href='https://github.com/pytest-dev/pytest/blob/24e84f08f43216f95620135305cbebe9f646e433/src/_pytest/faulthandler.py#L88'>src/_pytest/faulthandler.py:88:9:</a> B901 Using `yield` and `return {value}` in a generator function can lead to confusing behavior
+ <a href='https://github.com/pytest-dev/pytest/blob/24e84f08f43216f95620135305cbebe9f646e433/src/_pytest/helpconfig.py#L133'>src/_pytest/helpconfig.py:133:5:</a> B901 Using `yield` and `return {value}` in a generator function can lead to confusing behavior
+ <a href='https://github.com/pytest-dev/pytest/blob/24e84f08f43216f95620135305cbebe9f646e433/src/_pytest/logging.py#L780'>src/_pytest/logging.py:780:17:</a> B901 Using `yield` and `return {value}` in a generator function can lead to confusing behavior
+ <a href='https://github.com/pytest-dev/pytest/blob/24e84f08f43216f95620135305cbebe9f646e433/src/_pytest/logging.py#L788'>src/_pytest/logging.py:788:17:</a> B901 Using `yield` and `return {value}` in a generator function can lead to confusing behavior
+ <a href='https://github.com/pytest-dev/pytest/blob/24e84f08f43216f95620135305cbebe9f646e433/src/_pytest/logging.py#L801'>src/_pytest/logging.py:801:17:</a> B901 Using `yield` and `return {value}` in a generator function can lead to confusing behavior
+ <a href='https://github.com/pytest-dev/pytest/blob/24e84f08f43216f95620135305cbebe9f646e433/src/_pytest/logging.py#L869'>src/_pytest/logging.py:869:17:</a> B901 Using `yield` and `return {value}` in a generator function can lead to confusing behavior
+ <a href='https://github.com/pytest-dev/pytest/blob/24e84f08f43216f95620135305cbebe9f646e433/src/_pytest/pytester.py#L171'>src/_pytest/pytester.py:171:13:</a> B901 Using `yield` and `return {value}` in a generator function can lead to confusing behavior
+ <a href='https://github.com/pytest-dev/pytest/blob/24e84f08f43216f95620135305cbebe9f646e433/src/_pytest/setuponly.py#L36'>src/_pytest/setuponly.py:36:9:</a> B901 Using `yield` and `return {value}` in a generator function can lead to confusing behavior
+ <a href='https://github.com/pytest-dev/pytest/blob/24e84f08f43216f95620135305cbebe9f646e433/src/_pytest/skipping.py#L257'>src/_pytest/skipping.py:257:9:</a> B901 Using `yield` and `return {value}` in a generator function can lead to confusing behavior
+ <a href='https://github.com/pytest-dev/pytest/blob/24e84f08f43216f95620135305cbebe9f646e433/src/_pytest/skipping.py#L292'>src/_pytest/skipping.py:292:5:</a> B901 Using `yield` and `return {value}` in a generator function can lead to confusing behavior
+ <a href='https://github.com/pytest-dev/pytest/blob/24e84f08f43216f95620135305cbebe9f646e433/src/_pytest/terminal.py#L683'>src/_pytest/terminal.py:683:9:</a> B901 Using `yield` and `return {value}` in a generator function can lead to confusing behavior
+ <a href='https://github.com/pytest-dev/pytest/blob/24e84f08f43216f95620135305cbebe9f646e433/src/_pytest/terminal.py#L914'>src/_pytest/terminal.py:914:9:</a> B901 Using `yield` and `return {value}` in a generator function can lead to confusing behavior
+ <a href='https://github.com/pytest-dev/pytest/blob/24e84f08f43216f95620135305cbebe9f646e433/src/_pytest/terminal.py#L925'>src/_pytest/terminal.py:925:13:</a> B901 Using `yield` and `return {value}` in a generator function can lead to confusing behavior
+ <a href='https://github.com/pytest-dev/pytest/blob/24e84f08f43216f95620135305cbebe9f646e433/src/_pytest/tmpdir.py#L313'>src/_pytest/tmpdir.py:313:5:</a> B901 Using `yield` and `return {value}` in a generator function can lead to confusing behavior
+ <a href='https://github.com/pytest-dev/pytest/blob/24e84f08f43216f95620135305cbebe9f646e433/src/_pytest/unittest.py#L428'>src/_pytest/unittest.py:428:5:</a> B901 Using `yield` and `return {value}` in a generator function can lead to confusing behavior
+ <a href='https://github.com/pytest-dev/pytest/blob/24e84f08f43216f95620135305cbebe9f646e433/src/_pytest/warnings.py#L110'>src/_pytest/warnings.py:110:9:</a> B901 Using `yield` and `return {value}` in a generator function can lead to confusing behavior
+ <a href='https://github.com/pytest-dev/pytest/blob/24e84f08f43216f95620135305cbebe9f646e433/src/_pytest/warnings.py#L119'>src/_pytest/warnings.py:119:9:</a> B901 Using `yield` and `return {value}` in a generator function can lead to confusing behavior
+ <a href='https://github.com/pytest-dev/pytest/blob/24e84f08f43216f95620135305cbebe9f646e433/src/_pytest/warnings.py#L129'>src/_pytest/warnings.py:129:9:</a> B901 Using `yield` and `return {value}` in a generator function can lead to confusing behavior
+ <a href='https://github.com/pytest-dev/pytest/blob/24e84f08f43216f95620135305cbebe9f646e433/src/_pytest/warnings.py#L90'>src/_pytest/warnings.py:90:9:</a> B901 Using `yield` and `return {value}` in a generator function can lead to confusing behavior
+ <a href='https://github.com/pytest-dev/pytest/blob/24e84f08f43216f95620135305cbebe9f646e433/src/_pytest/warnings.py#L99'>src/_pytest/warnings.py:99:9:</a> B901 Using `yield` and `return {value}` in a generator function can lead to confusing behavior
+ <a href='https://github.com/pytest-dev/pytest/blob/24e84f08f43216f95620135305cbebe9f646e433/testing/conftest.py#L89'>testing/conftest.py:89:5:</a> B901 Using `yield` and `return {value}` in a generator function can lead to confusing behavior
</pre>

</p>
</details>
<details><summary>Changes by rule (1 rules affected)</summary>
<p>

<p>| code | total | + violation | - violation | + fix | - fix |
| ---- | ------- | --------- | -------- | ----- | ---- |
| B901 | 32 | 32 | 0 | 0 | 0 |</p>
</p>
</details>

</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @guptaarnav on 2024-12-22 21:06</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/guptaarnav">@guptaarnav</a> on 2024-12-22 21:07</div>
            <div class="timeline-body"><p>Saw a large number of violations from the automated ruff-ecosystem check.  primarily seems to be from code that says <code>return (yield)</code> which is valid.  rethinking this PR, closing for now.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 20:42:57 UTC
    </footer>
</body>
</html>
