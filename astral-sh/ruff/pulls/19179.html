<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rename `Diagnostic::syntax_error` methods, separate `Ord` implementation - astral-sh/ruff #19179</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Rename <code>Diagnostic::syntax_error</code> methods, separate <code>Ord</code> implementation</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/19179">#19179</a>
        opened by <a href="https://github.com/ntBre">@ntBre</a>
        on 2025-07-07 14:24
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a></div>
            <div class="timeline-body">Summary
<p>This PR addresses some additional feedback on #19053:</p>
<ul>
<li>Renaming the <code>syntax_error</code> methods to <code>invalid_syntax</code> to match the lint id</li>
<li>Moving the standalone <code>diagnostic_from_violation</code> function to <code>Violation::into_diagnostic</code></li>
<li>Removing the <code>Ord</code> and <code>PartialOrd</code> implementations from <code>Diagnostic</code> in favor of <code>Diagnostic::start_ordering</code></li>
</ul>
Test Plan
<p>Existing tests</p>
Additional Follow-ups
<p>Besides these, I also put the following comments on my todo list, but they seemed like they might be big enough to have their own PRs:</p>
<ul>
<li><a href="https://github.com/astral-sh/ruff/pull/19053#discussion_r2189425922">Use <code>LintId::IOError</code> for IO errors</a></li>
<li><a href="https://github.com/astral-sh/ruff/pull/19053#discussion_r2189448647">Move <code>Fix</code> and <code>Edit</code></a></li>
<li><a href="https://github.com/astral-sh/ruff/pull/19053#discussion_r2189465980">Avoid so many unwraps</a></li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">internal</span> added by <a href="https://github.com/ntBre">@ntBre</a> on 2025-07-07 14:24</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-07-07 14:27</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff/src/commands/check_stdin.rs</code>:57 on 2025-07-07 14:27</div>
            <div class="timeline-body"><p>I mentioned this <a href="https://github.com/astral-sh/ruff/pull/19053#discussion_r2190110553">here</a>, but is  it okay to unwrap these, or should we fall back to <code>Ordering::Equal</code> just in case? It shouldn&#x27;t currently be possible for this to fail, but I&#x27;m afraid of introducing a panic.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-07-07 14:27</div>
            <div class="timeline-body">

<code>mypy_primer</code> results
<p>No ecosystem changes detected ✅
No memory usage changes detected ✅</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/violation.rs</code>:35 on 2025-07-07 14:28</div>
            <div class="timeline-body"><p>This is to pass <code>self</code> by value down below. I also have a branch converting all of the various <code>report_diagnostic</code> methods to take a reference, if we&#x27;d prefer that approach.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-07-07 14:28</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-07-07 14:35</div>
            <div class="timeline-body">

<code>ruff-ecosystem</code> results
Linter (stable)
<p>✅ ecosystem check detected no linter changes.</p>
Linter (preview)
<p>✅ ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by <a href="https://github.com/ntBre">@ntBre</a> on 2025-07-07 14:36</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/carljm">@carljm</a> by <a href="https://github.com/ntBre">@ntBre</a> on 2025-07-07 14:36</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/AlexWaygood">@AlexWaygood</a> by <a href="https://github.com/ntBre">@ntBre</a> on 2025-07-07 14:36</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/sharkdp">@sharkdp</a> by <a href="https://github.com/ntBre">@ntBre</a> on 2025-07-07 14:36</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/dcreager">@dcreager</a> by <a href="https://github.com/ntBre">@ntBre</a> on 2025-07-07 14:36</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/MichaReiser">@MichaReiser</a> by <a href="https://github.com/ntBre">@ntBre</a> on 2025-07-07 14:36</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for <a href="https://github.com/dcreager">@dcreager</a> removed by <a href="https://github.com/ntBre">@ntBre</a> on 2025-07-07 14:36</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for <a href="https://github.com/carljm">@carljm</a> removed by <a href="https://github.com/ntBre">@ntBre</a> on 2025-07-07 14:36</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for <a href="https://github.com/sharkdp">@sharkdp</a> removed by <a href="https://github.com/ntBre">@ntBre</a> on 2025-07-07 14:36</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for <a href="https://github.com/AlexWaygood">@AlexWaygood</a> removed by <a href="https://github.com/ntBre">@ntBre</a> on 2025-07-07 14:36</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-07-07 14:39</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff/src/commands/check_stdin.rs</code>:57 on 2025-07-07 14:39</div>
            <div class="timeline-body"><p>I think it&#x27;s fine but is probably something we have to look into once we start e.g. using an IO error without a text range.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_db/src/diagnostic/mod.rs</code>:994 on 2025-07-07 14:44</div>
            <div class="timeline-body"><p>Hmm. I guess this works and it was probably even me who added <code>PartialOrd</code> to <code>ruff_db::files::File</code>. But I&#x27;m not sure if it&#x27;s a good idea because the ordering can change between runs (and users would probably expect that the ordering is based on the path).</p>
<p>However, changing this either requires that <code>start_ordering</code> requires a <code>FileResolver</code> or we make the method specific to ruff (and expect a ruff file). I&#x27;d be fine with either.</p>
<p>The alternative is to at least add a note to <code>UnifiedFile</code> that the ordering of the <code>Ty</code> file&#x27;s are based on the salsa index and not on the path and that <code>Ty</code> files come before <code>Ruff</code> Files</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2025-07-07 14:45</div>
            <div class="timeline-body"><p>Thank you</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-07-07 14:58</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_db/src/diagnostic/mod.rs</code>:994 on 2025-07-07 14:58</div>
            <div class="timeline-body"><p>Ah, I see. Yeah, I was preparing to rename the method to <code>ruff_start_ordering</code> when I decided to try this instead. I might just go back to that approach for now. It would be surprising if this got used in ty and the ordering changed between runs.</p>
<p>I&#x27;m not sure if you saw my <a href="https://github.com/astral-sh/ruff/pull/19053#discussion_r2190110553">comment</a> on the other PR, but we could also use <code>RenderingSortKey</code> with a dummy <code>FileResolver</code>, if we don&#x27;t mind falling back to the <code>DiagnosticId</code> sort for diagnostics on the same line. That only changed 6 snapshots when I tested it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-07-07 15:36</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_db/src/diagnostic/mod.rs</code>:994 on 2025-07-07 15:36</div>
            <div class="timeline-body"><blockquote>
<p>if we don&#x27;t mind falling back to the DiagnosticId sort for diagnostics on the same line. That only changed 6 snapshots when I tested it.</p>
</blockquote>
<p>I think that should be fine. I don&#x27;t consider the sort order as something that&#x27;s part of our semver versioned CLI interface</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-07-07 15:52</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_db/src/diagnostic/mod.rs</code>:994 on 2025-07-07 15:52</div>
            <div class="timeline-body"><p>Okay, I&#x27;ll try that then. That will avoid the unwrap too.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-07-07 16:18</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_db/src/diagnostic/mod.rs</code>:994 on 2025-07-07 16:18</div>
            <div class="timeline-body"><p>It ended up being 10 snapshots. I guess I only replaced one of the two uses in my first test.</p>
<p>The one downside is that we might end up with two dummy resolvers in Ruff if we also implement <code>FileResolver</code> for <code>EmitterContext</code> as in my current draft of #19133. But we can&#x27;t really reuse <code>EmitterContext</code> in this case because it holds a <code>&amp;HashMap</code> and can&#x27;t implement <code>Default</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff/tests/integration_test.rs</code>:1137 on 2025-07-07 16:31</div>
            <div class="timeline-body"><p>Looking at this now. the sort order is sort of confusing</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-07-07 16:31</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-07-07 16:33</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_db/src/diagnostic/mod.rs</code>:988 on 2025-07-07 16:33</div>
            <div class="timeline-body"><pre><code>#[derive(Debug, Clone, PartialEq, Eq, get_size2::GetSize)]
</code></pre>
<p>Yeah, I think I&#x27;ve changed my opinion after looking through the snapshots. The new sort order is sort of confusing (Unless we make <code>RenderingSortKey</code> parametrizable on whether it should use the <code>secondary_code</code> first before using the <code>id</code>).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-07-07 16:34</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_db/src/diagnostic/mod.rs</code>:988 on 2025-07-07 16:34</div>
            <div class="timeline-body"><p>Sounds good, I&#x27;ll revert to <code>start_ordering</code> and make it Ruff-specific. Thanks for taking a look!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-07-07 18:49</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_db/src/diagnostic/mod.rs</code>:988 on 2025-07-07 18:49</div>
            <div class="timeline-body"><p>I tried parameterizing <code>RenderingSortKey</code> too, but it also caused some snapshot changes. I&#x27;ll just stick with <code>start_ordering</code> for now, if that&#x27;s okay with you.</p>
<p>I also went ahead and <code>expect</code>ed a range and returned an <code>Ordering</code> instead of an <code>Option</code> since the function could already panic.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2025-07-08 06:27</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/ntBre">@ntBre</a> on 2025-07-08 13:54</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/ntBre">@ntBre</a> on 2025-07-08 13:54</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-07-08 13:54</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:16:20 UTC
    </footer>
</body>
</html>
