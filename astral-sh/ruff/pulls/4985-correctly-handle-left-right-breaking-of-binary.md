```yaml
number: 4985
title: Correctly handle left/right breaking of binary expression
type: pull_request
state: merged
author: MichaReiser
labels:
  - internal
  - formatter
assignees: []
merged: true
base: main
head: more-bin-op-formatting
created_at: 2023-06-09T16:08:48Z
updated_at: 2023-06-21T08:00:26Z
url: https://github.com/astral-sh/ruff/pull/4985
synced_at: 2026-01-12T15:55:17Z
```

# Correctly handle left/right breaking of binary expression

---

_@MichaReiser_

<!--
Thank you for contributing to Ruff! To help us out with reviewing, please consider the following:

- Does this pull request include a summary of the change? (See below.)
- Does this pull request include a descriptive title?
- Does this pull request include references to any relevant issues?
-->

## Summary
Black supports for layouts when it comes to breaking binary expressions:

```rust
#[derive(Copy, Clone, Debug, Eq, PartialEq)]
enum BinaryLayout {
    /// Put each operand on their own line if either side expands
    Default,

    /// Try to expand the left to make it fit. Add parentheses if the left or right don't fit.
    ///
    ///```python
    /// [
    ///     a,
    ///     b
    /// ] & c
    ///```
    ExpandLeft,

    /// Try to expand the right to make it fix. Add parentheses if the left or right don't fit.
    ///
    /// ```python
    /// a & [
    ///     b,
    ///     c
    /// ]
    /// ```
    ExpandRight,

    /// Both the left and right side can be expanded. Try in the following order:
    /// * expand the right side
    /// * expand the left side
    /// * expand both sides
    ///
    /// to make the expression fit
    ///
    /// ```python
    /// [
    ///     a,
    ///     b
    /// ] & [
    ///     c,
    ///     d
    /// ]
    /// ```
    ExpandRightThenLeft,
}
```

Our current implementation only handles `ExpandRight` and `Default` correctly. This PR adds support for `ExpandRightThenLeft` and `ExpandLeft`. 

## Test Plan

I added tests that play through all 4 binary expression layouts.


---

_Comment by @MichaReiser on 2023-06-09 16:09_

Current dependencies on/for this PR:
* main
  * **PR #5184** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/5184" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a> 
    * **PR #5205** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/5205" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a> 
      * **PR #4985** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/4985" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a>  ðŸ‘ˆ
        * **PR #5207** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/5207" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a> 
          * **PR #4986** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/4986" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a> 

This comment was auto-generated by [Graphite](https://app.graphite.dev/github/pr/astral-sh/ruff/4985?utm_source=stack-comment).

---

_Renamed from "Fix more binop line break" to "Correctly handle left/right breaking of binary expression" by @MichaReiser on 2023-06-09 16:18_

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/expression/expr_bin_op.rs`:75 on 2023-06-09 16:20_

Unchanged, moved up

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/expression/expr_bin_op.rs`:141 on 2023-06-09 16:20_

Unchanged

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/expression/expr_bin_op.rs`:153 on 2023-06-09 16:21_

The formatter breaks group-sequences from right to left, so that works just fine

---

_Comment by @github-actions[bot] on 2023-06-09 16:41_

## PR Check Results
### Ecosystem
âœ… ecosystem check detected no changes.

### Benchmark
#### Linux
```
group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.00      6.5Â±0.02ms     6.3 MB/sec    1.00      6.4Â±0.01ms     6.3 MB/sec
formatter/numpy/ctypeslib.py               1.03   1362.0Â±2.58Âµs    12.2 MB/sec    1.00   1323.2Â±1.41Âµs    12.6 MB/sec
formatter/numpy/globals.py                 1.01    131.9Â±0.86Âµs    22.4 MB/sec    1.00    130.1Â±0.24Âµs    22.7 MB/sec
formatter/pydantic/types.py                1.02      2.7Â±0.01ms     9.5 MB/sec    1.00      2.6Â±0.02ms     9.7 MB/sec
linter/all-rules/large/dataset.py          1.00     13.1Â±0.04ms     3.1 MB/sec    1.00     13.1Â±0.04ms     3.1 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.01      3.3Â±0.00ms     5.0 MB/sec    1.00      3.3Â±0.00ms     5.0 MB/sec
linter/all-rules/numpy/globals.py          1.00    424.8Â±0.49Âµs     6.9 MB/sec    1.00    424.6Â±1.95Âµs     6.9 MB/sec
linter/all-rules/pydantic/types.py         1.00      5.8Â±0.01ms     4.4 MB/sec    1.00      5.8Â±0.01ms     4.4 MB/sec
linter/default-rules/large/dataset.py      1.01      6.7Â±0.02ms     6.1 MB/sec    1.00      6.6Â±0.01ms     6.2 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.01   1473.3Â±2.73Âµs    11.3 MB/sec    1.00   1463.3Â±2.23Âµs    11.4 MB/sec
linter/default-rules/numpy/globals.py      1.01    166.7Â±0.45Âµs    17.7 MB/sec    1.00    165.5Â±0.35Âµs    17.8 MB/sec
linter/default-rules/pydantic/types.py     1.01      3.1Â±0.01ms     8.3 MB/sec    1.00      3.0Â±0.01ms     8.4 MB/sec
```

#### Windows
```
group                                      main                                    pr
-----                                      ----                                    --
formatter/large/dataset.py                 1.00     11.1Â±0.85ms     3.7 MB/sec     1.03     11.3Â±0.54ms     3.6 MB/sec
formatter/numpy/ctypeslib.py               1.00  1938.6Â±224.37Âµs     8.6 MB/sec    1.09      2.1Â±0.05ms     7.9 MB/sec
formatter/numpy/globals.py                 1.00   177.0Â±11.00Âµs    16.7 MB/sec     1.30   229.6Â±29.17Âµs    12.9 MB/sec
formatter/pydantic/types.py                1.00      3.8Â±0.44ms     6.8 MB/sec     1.15      4.3Â±0.22ms     5.9 MB/sec
linter/all-rules/large/dataset.py          1.14     20.3Â±1.57ms     2.0 MB/sec     1.00     17.8Â±1.01ms     2.3 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.18      5.4Â±0.51ms     3.1 MB/sec     1.00      4.6Â±0.23ms     3.7 MB/sec
linter/all-rules/numpy/globals.py          1.00   654.3Â±38.63Âµs     4.5 MB/sec     1.03   677.1Â±27.34Âµs     4.4 MB/sec
linter/all-rules/pydantic/types.py         1.11      8.8Â±0.40ms     2.9 MB/sec     1.00      7.9Â±0.62ms     3.2 MB/sec
linter/default-rules/large/dataset.py      1.00     11.2Â±0.74ms     3.6 MB/sec     1.04     11.6Â±0.52ms     3.5 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.01      2.4Â±0.21ms     7.0 MB/sec     1.00      2.4Â±0.10ms     7.1 MB/sec
linter/default-rules/numpy/globals.py      1.02   290.7Â±24.63Âµs    10.1 MB/sec     1.00   285.0Â±17.19Âµs    10.4 MB/sec
linter/default-rules/pydantic/types.py     1.00      5.0Â±0.29ms     5.1 MB/sec     1.01      5.0Â±0.23ms     5.1 MB/sec
```
<!-- thollander/actions-comment-pull-request "PR Check Results" -->

---

_@MichaReiser reviewed on 2023-06-09 16:41_

---

_@MichaReiser reviewed on 2023-06-09 16:44_

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/expression/expr_bin_op.rs`:88 on 2023-06-09 16:44_

The problem is that this group may now be, incorrectly, printed in flat mode if it happens that the printer measures the most outer group and that happens to fit. This is because the printer only computes *fits* ones per line and, when true, assumes that all following groups up to the next line break fit. 

---

_Label `internal` added by @MichaReiser on 2023-06-19 15:32_

---

_Label `formatter` added by @MichaReiser on 2023-06-19 15:32_

---

_@MichaReiser reviewed on 2023-06-19 15:34_

---

_Review comment by @MichaReiser on `crates/ruff_formatter/src/format_element.rs`:331 on 2023-06-19 15:34_

I couldn't add `mode` here because it would increase the size of the struct to 24 bytes which, in turn, would increase the size of `FormatElement` from 24 to 32 bytes. Adding `mode` inline avoids the size increase

---

_@MichaReiser reviewed on 2023-06-19 15:35_

---

_Review comment by @MichaReiser on `crates/ruff_formatter/src/printer/mod.rs`:147 on 2023-06-19 15:35_

I struggled with the `!group.mode().is_flat` and decided to use `match` statements to make the branching more explicit.

---

_Review requested from @konstin by @MichaReiser on 2023-06-19 15:56_

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/comments/mod.rs`:274 on 2023-06-19 15:56_

These changes are unrelated but I got annoyed by calling `.into()`

---

_@MichaReiser reviewed on 2023-06-19 15:56_

---

_Marked ready for review by @MichaReiser on 2023-06-19 15:57_

---

_Review comment by @konstin on `crates/ruff_python_formatter/src/expression/expr_bin_op.rs`:322 on 2023-06-20 16:06_

Shouldn't this be `||`, e.g. we just need any kind of arguments to allow breaking?

---

_Review comment by @konstin on `crates/ruff_python_formatter/src/expression/expr_bin_op.rs`:98 on 2023-06-20 16:09_

This formatting always looks kinda odd to me but i guess python doesn't allow much better

---

_Review comment by @konstin on `crates/ruff_python_formatter/src/expression/expr_bin_op.rs`:119 on 2023-06-20 16:14_

i'm having trouble following this code, shouldn't right breaks and if right is expanded but this is insufficient the whole thing should be parenthesized and indented?

---

_Review comment by @konstin on `crates/ruff_python_formatter/src/expression/expr_bin_op.rs`:153 on 2023-06-20 16:47_

please add as a source code comment

---

_@konstin approved on 2023-06-20 16:48_

---

_@MichaReiser reviewed on 2023-06-21 07:04_

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/expression/expr_bin_op.rs`:322 on 2023-06-21 07:04_

Nice catch, thanks

---

_@MichaReiser reviewed on 2023-06-21 07:14_

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/expression/expr_bin_op.rs`:119 on 2023-06-21 07:14_

I'm not entirely sure if I understand this comment. 

The formatter measures the left group to see if it fits. It does that by measuring if all the content *up to* the first line break (soft or hard) in the right group (or whatever comes after) fits on a line. It doesn't expand the left group if that's the case. 

This is is the behavior that we want. We want to expand the right first and not add parentheses in that case. We only want to add parentheses and indent the code if the left expands. That's why `indent_if_group_breaks` and the `if_group_breaks` refer to the left group and not their enclosing group. 


---

_Merged by @MichaReiser on 2023-06-21 07:40_

---

_Closed by @MichaReiser on 2023-06-21 07:40_

---

_Branch deleted on 2023-06-21 07:40_

---

_Comment by @MichaReiser on 2023-06-21 07:40_

@MichaReiser merged this pull request with [Graphite](https://app.graphite.dev/github/pr/astral-sh/ruff/4985).

---
