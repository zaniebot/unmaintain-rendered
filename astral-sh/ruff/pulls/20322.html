<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Remove Diagnostic::expect_range and all consumers - astral-sh/ruff #20322</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Remove Diagnostic::expect_range and all consumers</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/20322">#20322</a>
        opened by <a href="https://github.com/amyreese">@amyreese</a>
        on 2025-09-09 22:51
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/amyreese">@amyreese</a> on 2025-09-09 22:51</div>
            <div class="timeline-body"><p>Replace usage with <code>range().unwrap_or_default()</code> or more appropriate
alternatives based on context.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @amyreese on 2025-09-09 22:51</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @amyreese on 2025-09-09 22:51</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @sharkdp by @amyreese on 2025-09-09 22:51</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @dcreager by @amyreese on 2025-09-09 22:51</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-09-09 23:04</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @ntBre by @amyreese on 2025-09-09 23:33</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for @carljm removed by @carljm on 2025-09-10 00:20</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/flake8_commas/rules/trailing_commas.rs</code>:370 on 2025-09-10 12:46</div>
            <div class="timeline-body"><p>I think in these rule cases we should try to use the range passed to <code>report_diagnostic</code> or <code>report_diagnostic_if_enabled</code>. We can just use <code>prev.range()</code> again or factor out a shared <code>range</code> variable in this instance.</p>
<p>It works either way since the range will always be <code>Some</code>, but it seems more clear to me.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/isort/mod.rs</code>:660 on 2025-09-10 12:53</div>
            <div class="timeline-body"><p>Just for fun, would you try deleting one of these sort calls entirely? I'm pretty sure the diagnostics from <code>test_path</code> should already be sorted, so we may be able to drop all of these <code>sort_by_key</code> and <code>unwrap_or_default</code> calls.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/pycodestyle/rules/logical_lines/extraneous_whitespace.rs</code>:175 on 2025-09-10 13:38</div>
            <div class="timeline-body"><p>Same as above, we can just use the <code>range</code> passed to <code>report_diagnostic_if_enabled</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/pyflakes/mod.rs</code>:791 on 2025-09-10 13:39</div>
            <div class="timeline-body"><p>Unlike isort, I think we actually do need this one since pyflakes uses a slightly different test runner. It might make sense to use <code>Diagnostic::ruff_sort_ordering</code> again if it doesn't change any snapshots, though. Hopefully we'll unify these with the other tests soon anyway (https://github.com/astral-sh/ruff/pull/19977).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/linter.rs</code>:518 on 2025-09-10 13:42</div>
            <div class="timeline-body"><p>I think I'd probably immediately if-let on the range itself, but what you have is fine too:</p>
<pre><code class="language-suggestion">            if let Some(range) = diagnostic.range() {
                let noqa_offset = directives.noqa_line_for.resolve(range.start());
                diagnostic.set_noqa_offset(noqa_offset);
            }
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/linter.rs</code>:988 on 2025-09-10 13:47</div>
            <div class="timeline-body"><p>Maybe another good use for <code>Diagnostic::ruff_sort_ordering</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/noqa.rs</code>:892 on 2025-09-10 13:50</div>
            <div class="timeline-body"><p>I'm actually not sure, but I think we don't want to unwrap this one. That would put a noqa offset at the start of a file for any diagnostic without a range, if I understand correctly. I think we should just put the references to <code>noqa_offset</code> in an if-let here.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_server/src/lint.rs</code>:237 on 2025-09-10 13:57</div>
            <div class="timeline-body"><p>I double checked what ty does for this, and it looks like ranges are required for <code>lsp_types::Diagnostic</code>. We fall back to the default range in ty too:</p>
<p>https://github.com/astral-sh/ruff/blob/7a75702237e6f0bc605d3d8e9470c4ca9f37c69e/crates/ty_server/src/server/api/diagnostics.rs#L300-L302</p>
<p>so this looks good!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_wasm/src/lib.rs</code>:239 on 2025-09-10 14:07</div>
            <div class="timeline-body"><p>This also seems right to me. In ty, it looks like we preserve the optionality on the Rust side but unwrap to a default value in TypeScript:</p>
<p>https://github.com/astral-sh/ruff/blob/7a75702237e6f0bc605d3d8e9470c4ca9f37c69e/playground/ty/src/Editor/Diagnostics.tsx#L74-L75</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-09-10 14:10</div>
            <div class="timeline-body"><p>Thanks! Just a few minor suggestions, but this looks good overall</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/amyreese">@amyreese</a> reviewed on 2025-09-10 17:10</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/amyreese">@amyreese</a> on <code>crates/ruff_linter/src/rules/isort/mod.rs</code>:660 on 2025-09-10 17:10</div>
            <div class="timeline-body"><p>Yep, removing these did not break tests.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/amyreese">@amyreese</a> on <code>crates/ruff_linter/src/noqa.rs</code>:892 on 2025-09-10 18:03</div>
            <div class="timeline-body"><p>This one was tricky to try and unravel what's going on, and I <em>think</em> this is actually correct as-is:</p>
<p>It's using the range to look for an associated noqa directive (<code>find_lines_with_directive</code> takes the range and does a binary search against noqa directives that it knows about). With a default range, IIUC it should never find a directive, and therefore fall through to the following code at line 915, which reports a <code>None</code> directive using the line from the default range.</p>
<p>With an if-let defining <code>noqa_offset</code> guarding the use of <code>find_line_with_directive</code>, then <code>noqa_offset</code> is no longer defined and usable by the block at line 915.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/amyreese">@amyreese</a> reviewed on 2025-09-10 18:03</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-09-10 19:12</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/noqa.rs</code>:892 on 2025-09-10 19:12</div>
            <div class="timeline-body"><p>Hmm, maybe you're right. I'm honestly not that familiar with this part of the code. I was just afraid that you'd be able to put a noqa comment at the start of a file for a diagnostic without a range. But maybe that's even correct?</p>
<p>Anyway, this is actually unreachable until we add any diagnostics without ranges, so this seems fine. Even the panics shouldn't hit this path because they don't have rule/noqa codes anyway.</p>
<p>Thanks for looking into it!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/pycodestyle/rules/logical_lines/extraneous_whitespace.rs</code>:175 on 2025-09-10 19:16</div>
            <div class="timeline-body"><p>Sorry I stopped marking these, but I was hoping we could do a fix similar to <code>crates/ruff_linter/src/rules/flake8_commas/rules/trailing_commas.rs</code> for each of the <code>diagnostic.range()</code> calls immediately after constructing a diagnostic. In this case it would look something like:</p>
<pre><code class="language-suggestion">                        let range = TextRange::at(token.end(), trailing_len);
                        if let Some(mut diagnostic) = ... {
                            diagnostic.set_fix(Fix::safe_edit(Edit::range_deletion(range)));
                        }
</code></pre>
<p>(with some of the context from above added to the suggestion since github won't let me select it all)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/pycodestyle/rules/logical_lines/extraneous_whitespace.rs</code>:194 on 2025-09-10 19:17</div>
            <div class="timeline-body"><p>Same as above:</p>
<pre><code class="language-rust">let range = TextRange::at(token.start() - offset, offset);
...
diagnostic.set_fix(Fix::safe_edit(Edit::range_deletion(range)));
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/pycodestyle/rules/logical_lines/extraneous_whitespace.rs</code>:221 on 2025-09-10 19:17</div>
            <div class="timeline-body"><p>Same as above</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/pycodestyle/rules/logical_lines/extraneous_whitespace.rs</code>:240 on 2025-09-10 19:17</div>
            <div class="timeline-body"><p>Same as above</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/pycodestyle/rules/logical_lines/extraneous_whitespace.rs</code>:269 on 2025-09-10 19:17</div>
            <div class="timeline-body"><p>Same as above</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/pycodestyle/rules/logical_lines/extraneous_whitespace.rs</code>:293 on 2025-09-10 19:18</div>
            <div class="timeline-body"><p>Same as above</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/test.rs</code>:386 on 2025-09-10 19:31</div>
            <div class="timeline-body"><p>This one could probably be an if-let too. I <em>think</em> we could hit this one with the panics, depending on how we end up testing them (or if a rule panics in a future test, but you'd probably only hit that while trying to fix a bug).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-09-10 19:32</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/amyreese">@amyreese</a> on <code>crates/ruff_linter/src/test.rs</code>:386 on 2025-09-10 21:26</div>
            <div class="timeline-body"><p>I also added if lets guarding the other use of <code>range.unwrap()</code> here, since those are also likely to cause issues in the same way.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/amyreese">@amyreese</a> reviewed on 2025-09-10 21:26</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-09-10 23:03</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/test.rs</code>:386 on 2025-09-10 23:03</div>
            <div class="timeline-body"><p>Good call!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> approved on 2025-09-10 23:03</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">internal</span> added by @ntBre on 2025-09-10 23:03</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">diagnostics</span> added by @ntBre on 2025-09-10 23:03</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @amyreese on 2025-09-11 00:19</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @amyreese on 2025-09-11 00:19</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-09-11 00:19</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 17:40:53 UTC
    </footer>
</body>
</html>
