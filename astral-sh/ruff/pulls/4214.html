<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[`flake8-pyi`] Implement `PYI042` and `PYI043` - astral-sh/ruff #4214</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[<code>flake8-pyi</code>] Implement <code>PYI042</code> and <code>PYI043</code></h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/4214">#4214</a>
        opened by <a href="https://github.com/arya-k">@arya-k</a>
        on 2023-05-03 20:55
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/arya-k">@arya-k</a></div>
            <div class="timeline-body"><p>PYI042 Type alias names should use CamelCase rather than snake_case
PYI043 Do not use names ending in &quot;T&quot; for private type aliases. (The &quot;T&quot; suffix implies that an object is a TypeVar.)</p>
<p>rel: <a href="https://github.com/charliermarsh/ruff/issues/848">charliermarsh/ruff#848</a></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Converted to draft by <a href="https://github.com/arya-k">@arya-k</a> on 2023-05-03 21:26</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2023-05-03 21:28</div>
            <div class="timeline-body">PR Check Results
Ecosystem
<p>ℹ️ ecosystem check <strong>detected changes</strong>. (+12, -0, 0 error(s))</p>
typeshed (+12, -0)
<p>

<pre><code>+ stdlib/typing.pyi:735:1: PYI042 Type alias `_get_type_hints_obj_allowed_types` should be CamelCase
+ stubs/cffi/_cffi_backend.pyi:113:5: PYI042 Type alias `buffer` should be CamelCase
+ stubs/cffi/cffi/api.pyi:13:1: PYI042 Type alias `basestring` should be CamelCase
+ stubs/cffi/cffi/api.pyi:18:5: PYI042 Type alias `buffer` should be CamelCase
+ stubs/pika/pika/spec.pyi:9:1: PYI042 Type alias `_str` should be CamelCase
+ stubs/pywin32/pythoncom.pyi:10:1: PYI042 Type alias `error` should be CamelCase
+ stubs/pywin32/win32/odbc.pyi:9:1: PYI042 Type alias `_odbcError` should be CamelCase
+ stubs/pywin32/win32comext/adsi/adsi.pyi:7:1: PYI042 Type alias `error` should be CamelCase
+ stubs/pywin32/win32comext/propsys/propsys.pyi:6:1: PYI042 Type alias `error` should be CamelCase
+ stubs/pywin32/win32comext/shell/shell.pyi:7:1: PYI042 Type alias `error` should be CamelCase
+ stubs/redis/redis/typing.pyi:17:1: PYI043 Private type alias `_StringLikeT` should not be suffixed with `T` (the `T` suffix implies that an object is a `TypeVar`)
+ stubs/requests/requests/compat.pyi:22:1: PYI042 Type alias `builtin_str` should be CamelCase
</code></pre>
</p>


Benchmark
Linux
<pre><code>group                                      main                                   pr
-----                                      ----                                   --
linter/all-rules/large/dataset.py          1.01     17.1±0.09ms     2.4 MB/sec    1.00     16.9±0.06ms     2.4 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      4.1±0.01ms     4.1 MB/sec    1.00      4.1±0.01ms     4.1 MB/sec
linter/all-rules/numpy/globals.py          1.01    508.4±5.35µs     5.8 MB/sec    1.00    503.9±1.15µs     5.9 MB/sec
linter/all-rules/pydantic/types.py         1.00      7.0±0.03ms     3.6 MB/sec    1.00      7.0±0.04ms     3.6 MB/sec
linter/default-rules/large/dataset.py      1.00      8.3±0.02ms     4.9 MB/sec    1.01      8.4±0.02ms     4.9 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00   1778.6±6.09µs     9.4 MB/sec    1.01   1797.0±4.76µs     9.3 MB/sec
linter/default-rules/numpy/globals.py      1.00    199.2±2.15µs    14.8 MB/sec    1.02    202.3±4.97µs    14.6 MB/sec
linter/default-rules/pydantic/types.py     1.00      3.7±0.01ms     6.9 MB/sec    1.01      3.7±0.06ms     6.8 MB/sec
parser/large/dataset.py                    1.00      6.6±0.02ms     6.2 MB/sec    1.00      6.6±0.01ms     6.2 MB/sec
parser/numpy/ctypeslib.py                  1.00   1275.4±1.81µs    13.1 MB/sec    1.00   1276.2±1.57µs    13.0 MB/sec
parser/numpy/globals.py                    1.00    129.8±0.50µs    22.7 MB/sec    1.00    130.1±0.33µs    22.7 MB/sec
parser/pydantic/types.py                   1.00      2.8±0.01ms     9.2 MB/sec    1.00      2.8±0.00ms     9.1 MB/sec
</code></pre>
Windows
<pre><code>group                                      main                                   pr
-----                                      ----                                   --
linter/all-rules/large/dataset.py          1.02     17.0±0.20ms     2.4 MB/sec    1.00     16.6±0.07ms     2.5 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.02      4.3±0.04ms     3.8 MB/sec    1.00      4.2±0.02ms     3.9 MB/sec
linter/all-rules/numpy/globals.py          1.01    437.8±5.24µs     6.7 MB/sec    1.00    434.6±5.04µs     6.8 MB/sec
linter/all-rules/pydantic/types.py         1.01      7.2±0.04ms     3.5 MB/sec    1.00      7.1±0.04ms     3.6 MB/sec
linter/default-rules/large/dataset.py      1.02      8.7±0.03ms     4.7 MB/sec    1.00      8.5±0.04ms     4.8 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.02  1844.1±27.13µs     9.0 MB/sec    1.00  1803.8±13.18µs     9.2 MB/sec
linter/default-rules/numpy/globals.py      1.01    197.1±5.68µs    15.0 MB/sec    1.00    195.4±4.30µs    15.1 MB/sec
linter/default-rules/pydantic/types.py     1.01      3.9±0.03ms     6.5 MB/sec    1.00      3.9±0.04ms     6.5 MB/sec
parser/large/dataset.py                    1.00      6.8±0.03ms     6.0 MB/sec    1.00      6.8±0.02ms     6.0 MB/sec
parser/numpy/ctypeslib.py                  1.00   1295.2±7.08µs    12.9 MB/sec    1.00   1292.1±6.03µs    12.9 MB/sec
parser/numpy/globals.py                    1.01    134.9±1.42µs    21.9 MB/sec    1.00    133.6±1.01µs    22.1 MB/sec
parser/pydantic/types.py                   1.01      2.9±0.03ms     8.8 MB/sec    1.00      2.9±0.02ms     8.9 MB/sec
</code></pre>


</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/arya-k">@arya-k</a> on 2023-05-04 02:53</div>
            <div class="timeline-body"><p>Hmm I&#x27;m not able to repro this test failure locally (macOS), when I run <code>cargo test -p ruff_cli --test integration_test</code>. I&#x27;m not quite sure what to make of this, and the CLI tests seem unrelated to my changes– do you have any tips @charliermarsh?</p>
<p>p.s. I&#x27;m pretty new to the ruff community: is it bad form to tag you like this?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-05-04 03:04</div>
            <div class="timeline-body"><p>@arya-k - Not sure why I can&#x27;t repro locally either, but I have a suspicion that we just hit a factor-of-two boundary and need to increase the <code>RuleSet</code> bit vector size. In short, we have a vector that needs to be long enough to match the number of total rules, and we may have just exceeded the previous limit. I tried pushing a fix, lets see what happens.</p>
<p>Also: totally fine to tag me or other maintainers.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff/src/registry/rule_set.rs</code>:13 on 2023-05-04 03:08</div>
            <div class="timeline-body"><p>@arya-k - Here&#x27;s the change I was referring to (very unclear from the trace, but I saw the out-of-bounds with index 9 and thought of the 9 here).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-05-04 03:08</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by <a href="https://github.com/arya-k">@arya-k</a> on 2023-05-04 04:14</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/arya-k">@arya-k</a> reviewed on 2023-05-04 04:15</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/arya-k">@arya-k</a> on <code>crates/ruff/src/registry/rule_set.rs</code>:13 on 2023-05-04 04:15</div>
            <div class="timeline-body"><p>Thank you! This is helpful, and I appreciate the fix.</p>
<p>I wonder why this didn’t come up locally!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff/src/rules/flake8_pyi/snapshots/ruff__rules__flake8_pyi__tests__PYI042_PYI042.py.snap</code>:2 on 2023-05-04 06:55</div>
            <div class="timeline-body"><p>Is it intentionally that this test case has no expected diagnostics?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff/src/rules/flake8_pyi/rules/type_alias_naming.rs</code>:10 on 2023-05-04 07:03</div>
            <div class="timeline-body"><p>Is my understanding correct that this regex e.g. wouldn&#x27;t match <code>Snake_camel_case</code>? Should we detect this pattern too?</p>
<p>I think we should be able to implement this search without the need for a Regex.</p>
<pre><code>
let Some(first_character) = id.chars().next() else { return; }

let mut camel_case_name = String::new();
let mut last_index = 0

if first_character.is_lowercase() {
	camel_case_name.push(first_character.to_uppercase();
	last_index = 1;
}

for (index, _) in id.match_indices(&#x27;_&#x27;) {
	if let Some(next) = id.get(index + 1) {
		if next.is_ascii_alphabetic() {
			camel_case_name.push_str(&amp;id[..last_index];
			camel_case_name.push(next.to_uppercase());
			last_index = index + 1;
		}
	}
}

if !camel_case_name.is_empty() {
	camel_case_name.push_str(&amp;id[last_index..]);
	// create diagnostic
}
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff/src/rules/flake8_pyi/rules/type_alias_naming.rs</code>:17 on 2023-05-04 07:15</div>
            <div class="timeline-body"><p>I also think that we can implement this with plain string operations rather than using a Regex here (a regex has the added cost that it needs to be compiled once and is quiet a heavy machinery)</p>
<pre><code>if !name.starts_with(&#x27;_&#x27;) {
	return;
}

let mut chars = id.chars();

let Some(mut last) = chars.next_back() else { return; }

// Skip over the trailing digit
if last.is_ascii_digit() {
	if let Some(second_last) = chars.next_back() {
		last = second_last;
	} else {
		return;
	}
}

if last == &#x27;T&#x27; {
	// error 
}
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-05-04 07:17</div>
            <div class="timeline-body"><p>Thank you for your contribution.</p>
<p>I think we should try to implement these rules without having to rely on regular expressions. Regular expressions are great but can be overkill when matching on simple patterns and using plain string methods can then be better for performance</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Converted to draft by <a href="https://github.com/arya-k">@arya-k</a> on 2023-05-04 14:57</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/arya-k">@arya-k</a> reviewed on 2023-05-04 14:58</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/arya-k">@arya-k</a> on <code>crates/ruff/src/rules/flake8_pyi/snapshots/ruff__rules__flake8_pyi__tests__PYI042_PYI042.py.snap</code>:2 on 2023-05-04 14:58</div>
            <div class="timeline-body"><p>Yes- this tool only operates on stub files for now. I&#x27;ll change the comments in the test to make this clearer</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/arya-k">@arya-k</a> reviewed on 2023-05-04 15:49</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/arya-k">@arya-k</a> on <code>crates/ruff/src/rules/flake8_pyi/rules/type_alias_naming.rs</code>:10 on 2023-05-04 15:49</div>
            <div class="timeline-body"><p>We should match that pattern!</p>
<p>I also realize that the regex should have been named <code>SNAKE_CASE_REGEX</code>, which may have caused some confusion.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by <a href="https://github.com/arya-k">@arya-k</a> on 2023-05-04 16:35</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-05-04 17:00</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff/src/rules/flake8_pyi/rules/type_alias_naming.rs</code>:63 on 2023-05-04 17:00</div>
            <div class="timeline-body"><p>I did some testing against <code>typeshed</code>, and I think this matches their current behavior:</p>
<pre><code>/// Return `true` if the given name is a snake_case type alias. In this context, we match against
/// any name that begins with an optional underscore, followed by at least one lowercase letter.
fn is_snake_case_type_alias(name: &amp;str) -&gt; bool {
    let mut chars = name.chars();
    match (chars.next(), chars.next()) {
        (Some(&#x27;_&#x27;), Some(c)) | (Some(c), ..) =&gt; c.is_ascii_alphabetic() &amp;&amp; c.is_ascii_lowercase(),
        _ =&gt; false,
    }
}
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff/src/rules/flake8_pyi/rules/type_alias_naming.rs</code>:63 on 2023-05-04 17:01</div>
            <div class="timeline-body"><p>The current version seems to have some false positives, e.g., it flags this, which <code>flake8-pyi</code> allows:</p>
<pre><code>_TYPE_FIELDS: TypeAlias = _TYPE_FIELDS_SEQUENCE | Mapping[str, fields._FieldValueTuple]
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-05-04 17:01</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from &quot;[flake8-pyi] PYI042, PYI043&quot; to &quot;[`flake8-pyi`] Implement `PYI042` and `PYI043`&quot; by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-05-04 17:38</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">rule</span> added by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-05-04 17:38</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-05-04 18:35</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-05-04 18:35</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/arya-k">@arya-k</a> reviewed on 2023-05-04 20:02</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/arya-k">@arya-k</a> on <code>crates/ruff/src/rules/flake8_pyi/rules/type_alias_naming.rs</code>:63 on 2023-05-04 20:02</div>
            <div class="timeline-body"><p>That makes sense- and is the original behavior the regex supported (<code>^_?[a-z]</code>).</p>
<p>I changed it to support <code>Snake_case</code>- is it more important to maintain parity with the original plug-in?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/arya-k">@arya-k</a> on 2023-05-04 20:03</div>
            <div class="timeline-body"><p>Thank you for pushing this over the finish line- for my understanding, how did you format the python files? My installation of <code>black</code> produced a much larger diff so I ignored it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff/src/rules/flake8_pyi/rules/type_alias_naming.rs</code>:63 on 2023-05-04 20:07</div>
            <div class="timeline-body"><p>Ah yeah, I prefer to maintain parity with upstream plugins unless we have a good reason to deviate (examples: there&#x27;s a clear bug that we can fix, diagnostic messages are confusing or inconsistent with our own conventions). It makes migrations easier for users, and reduces confusion.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-05-04 20:07</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-05-04 20:08</div>
            <div class="timeline-body"><p>@arya-k - Oh interesting, I just ran Black from my own editor.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-05-04 20:08</div>
            <div class="timeline-body"><p>I should correct that: we probably haven&#x27;t run Black over all of our Python fixtures, so running <code>black</code> from root could produce a large diff. I just ran Black over the new fixtures in this PR.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/arya-k">@arya-k</a> on 2023-05-04 20:17</div>
            <div class="timeline-body"><blockquote>
<p>I should correct that: we probably haven&#x27;t run Black over all of our Python fixtures, so running <code>black</code> from root could produce a large diff. I just ran Black over the new fixtures in this PR.</p>
</blockquote>
<p>Ah got it. I ran it on all fixtures, then figured it wasn’t the way we were formatting python. Thanks for the clarification!</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 18:53:30 UTC
    </footer>
</body>
</html>
