<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[ty] Don't use implicit superclass annotation when converting a class constructor into a `Callable` - astral-sh/ruff #22011</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[ty] Don't use implicit superclass annotation when converting a class constructor into a <code>Callable</code></h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/22011">#22011</a>
        opened by <a href="https://github.com/dcreager">@dcreager</a>
        on 2025-12-16 18:14
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/dcreager">@dcreager</a> on 2025-12-16 18:14</div>
            <div class="timeline-body"><p>This fixes a bug @zsol found running ty against pyx. His original repro is:</p>
<pre><code class="language-py">class Base:
    def __init__(self) -&gt; None: pass

class A(Base):
    pass

def foo[T](callable: Callable[..., T]) -&gt; T:
    return callable()

a: A = foo(A)
</code></pre>
<p>The call at the bottom would fail, since we would infer <code>() -&gt; Base</code> as the callable type of <code>A</code>, when it should be <code>() -&gt; A</code>.</p>
<p>The issue was how we add implicit annotations to <code>self</code> parameters. Typically, we turn it into <code>self: Self</code>. But in cases where we don't need to introduce a full typevar, we turn it into <code>self: [the class itself]</code> — in this case, <code>self: Base</code>. Then, when turning the class constructor into a callable, we would see this non-<code>Self</code> annotation and think that it was important and load-bearing.</p>
<p>The fix is that we skip all implicit annotations when determining whether the <code>self</code> annotation should take precedence in the callable's return type.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @dcreager on 2025-12-16 18:14</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @AlexWaygood by @dcreager on 2025-12-16 18:14</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ty</span> added by @dcreager on 2025-12-16 18:14</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @sharkdp by @dcreager on 2025-12-16 18:14</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ecosystem-analyzer</span> added by @dcreager on 2025-12-16 18:14</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/astral-sh-bot[bot]">@astral-sh-bot[bot]</a> on 2025-12-16 18:16</div>
            <div class="timeline-body"><!-- generated-comment typing_conformance_diagnostics_diff -->

<h2>Diagnostic diff on <a href="https://github.com/python/typing/tree/9f6d8ced7cd1c8d92687a4e9c96d7716452e471e/conformance">typing conformance tests</a></h2>
<p>No changes detected when running ty on typing conformance tests ✅</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> approved on 2025-12-16 18:16</div>
            <div class="timeline-body"><p>Looks good!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/astral-sh-bot[bot]">@astral-sh-bot[bot]</a> on 2025-12-16 18:21</div>
            <div class="timeline-body"><!-- generated-comment mypy_primer -->

<h2><code>mypy_primer</code> results</h2>
<details>
<summary>Changes were detected when running on open source projects</summary>

<pre><code class="language-diff">artigraph (https://github.com/artigraph/artigraph)
- tests/arti/graphs/test_graph.py:450:20: error[unresolved-attribute] Object of type `CallableMixin` has no attribute `called`
- tests/arti/graphs/test_graph.py:452:16: error[unresolved-attribute] Object of type `CallableMixin` has no attribute `called`
- Found 151 diagnostics
+ Found 149 diagnostics

optuna (https://github.com/optuna/optuna)
- tests/samplers_tests/tpe_tests/test_multi_objective_sampler.py:44:9: error[unresolved-attribute] Unresolved attribute `return_value` on type `CallableMixin`.
- tests/samplers_tests/tpe_tests/test_multi_objective_sampler.py:45:9: error[unresolved-attribute] Unresolved attribute `return_value` on type `CallableMixin`.
- tests/samplers_tests/tpe_tests/test_multi_objective_sampler.py:113:13: error[unresolved-attribute] Unresolved attribute `return_value` on type `CallableMixin`.
- tests/samplers_tests/tpe_tests/test_multi_objective_sampler.py:114:13: error[unresolved-attribute] Unresolved attribute `return_value` on type `CallableMixin`.
- Found 552 diagnostics
+ Found 548 diagnostics

xarray (https://github.com/pydata/xarray)
- xarray/coding/cftime_offsets.py:687:54: error[invalid-assignment] Object of type `dict[Unknown | str, Unknown | type[BaseCFTimeOffset] | partial[QuarterOffset]]` is not assignable to `Mapping[str, type[BaseCFTimeOffset]]`
+ xarray/coding/cftime_offsets.py:687:54: error[invalid-assignment] Object of type `dict[Unknown | str, Unknown | type[BaseCFTimeOffset] | partial[QuarterBegin] | partial[QuarterEnd]]` is not assignable to `Mapping[str, type[BaseCFTimeOffset]]`
- xarray/core/dataarray.py:5737:16: error[invalid-return-type] Return type does not match returned value: expected `T_Xarray@map_blocks`, found `DataArray | Dataset`
+ xarray/core/dataarray.py:5737:16: error[invalid-return-type] Return type does not match returned value: expected `T_Xarray@map_blocks`, found `T_Xarray@map_blocks | DataArray | Dataset`
- xarray/core/dataset.py:8875:16: error[invalid-return-type] Return type does not match returned value: expected `T_Xarray@map_blocks`, found `DataArray | Dataset`
+ xarray/core/dataset.py:8875:16: error[invalid-return-type] Return type does not match returned value: expected `T_Xarray@map_blocks`, found `T_Xarray@map_blocks | DataArray | Dataset`

openlibrary (https://github.com/internetarchive/openlibrary)
- openlibrary/i18n/__init__.py:188:12: error[unresolved-attribute] Object of type `PurePath` has no attribute `is_file`
- Found 1142 diagnostics
+ Found 1141 diagnostics

static-frame (https://github.com/static-frame/static-frame)
- static_frame/core/bus.py:671:16: error[invalid-return-type] Return type does not match returned value: expected `InterGetItemLocReduces[Bus[Any], object_]`, found `InterGetItemLocReduces[Bus[Any] | Top[Series[Any, Any]] | TypeBlocks | ... omitted 7 union elements, object_]`
- static_frame/core/bus.py:675:16: error[invalid-return-type] Return type does not match returned value: expected `InterGetItemILocReduces[Bus[Any], object_]`, found `InterGetItemILocReduces[Bus[Any] | TypeBlocks | Batch | ... omitted 7 union elements, generic[object]]`
+ static_frame/core/bus.py:671:16: error[invalid-return-type] Return type does not match returned value: expected `InterGetItemLocReduces[Bus[Any], object_]`, found `InterGetItemLocReduces[Bus[Any] | TypeBlocks | Batch | ... omitted 7 union elements, object_]`
+ static_frame/core/bus.py:675:16: error[invalid-return-type] Return type does not match returned value: expected `InterGetItemILocReduces[Bus[Any], object_]`, found `InterGetItemILocReduces[Bus[Any] | TypeBlocks | Batch | ... omitted 7 union elements, object_ | Self@iloc]`
- static_frame/core/series.py:772:16: error[invalid-return-type] Return type does not match returned value: expected `InterGetItemILocReduces[Series[Any, Any], TVDtype@Series]`, found `InterGetItemILocReduces[Series[Any, Any], generic[object]]`
+ static_frame/core/series.py:772:16: error[invalid-return-type] Return type does not match returned value: expected `InterGetItemILocReduces[Series[Any, Any], TVDtype@Series]`, found `InterGetItemILocReduces[Series[Any, Any] | TypeBlocks | Batch | ... omitted 6 union elements, generic[object]]`

jax (https://github.com/google/jax)
+ jax/_src/tree_util.py:295:31: error[invalid-argument-type] Argument to bound method `register_node` is incorrect: Expected `(Hashable, Iterable[object], /) -&gt; T@register_pytree_node`, found `(_AuxData@register_pytree_node, _Children@register_pytree_node, /) -&gt; T@register_pytree_node`
+ jax/_src/tree_util.py:298:31: error[invalid-argument-type] Argument to bound method `register_node` is incorrect: Expected `(Hashable, Iterable[object], /) -&gt; T@register_pytree_node`, found `(_AuxData@register_pytree_node, _Children@register_pytree_node, /) -&gt; T@register_pytree_node`
+ jax/_src/tree_util.py:301:31: error[invalid-argument-type] Argument to bound method `register_node` is incorrect: Expected `(Hashable, Iterable[object], /) -&gt; T@register_pytree_node`, found `(_AuxData@register_pytree_node, _Children@register_pytree_node, /) -&gt; T@register_pytree_node`
- Found 2797 diagnostics
+ Found 2800 diagnostics

zulip (https://github.com/zulip/zulip)
- zerver/tests/test_external.py:260:13: error[unresolved-attribute] Unresolved attribute `return_value` on type `CallableMixin`.
- Found 3669 diagnostics
+ Found 3668 diagnostics

pandas-stubs (https://github.com/pandas-dev/pandas-stubs)
- tests/test_groupby.py:439:11: error[type-assertion-failure] Type `Series[Any]` does not match asserted type `Series[(str &amp; Any) | (bytes &amp; Any) | (int &amp; Any) | ... omitted 12 union elements]`
+ tests/test_groupby.py:439:11: error[type-assertion-failure] Type `Series[Any]` does not match asserted type `Series[(Any &amp; str) | (Any &amp; bytes) | (Any &amp; int) | ... omitted 12 union elements]`
- tests/test_resampler.py:402:11: error[type-assertion-failure] Type `Series[Any]` does not match asserted type `Series[(str &amp; Any) | (bytes &amp; Any) | (int &amp; Any) | ... omitted 12 union elements]`
+ tests/test_resampler.py:402:11: error[type-assertion-failure] Type `Series[Any]` does not match asserted type `Series[(Any &amp; str) | (Any &amp; bytes) | (Any &amp; int) | ... omitted 12 union elements]`

core (https://github.com/home-assistant/core)
+ homeassistant/util/variance.py:47:12: error[invalid-return-type] Return type does not match returned value: expected `(**_P@ignore_variance) -&gt; _R@ignore_variance`, found `_Wrapped[_P@ignore_variance, _R@ignore_variance | int | float | datetime, _P@ignore_variance, _R@ignore_variance | int | float | datetime]`
- Found 14401 diagnostics
+ Found 14402 diagnostics


</code></pre>
</details>

<p>No memory usage changes detected ✅</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/astral-sh-bot[bot]">@astral-sh-bot[bot]</a> on 2025-12-16 18:23</div>
            <div class="timeline-body"><!-- generated-comment ty ecosystem-analyzer -->

<h2><code>ecosystem-analyzer</code> results</h2>
<p>| Lint rule | Added | Removed | Changed |
|-----------|------:|--------:|--------:|
| <code>unresolved-attribute</code> | 0 | 8 | 0 |
| <code>invalid-return-type</code> | 1 | 0 | 6 |
| <code>invalid-assignment</code> | 0 | 0 | 6 |
| <code>invalid-argument-type</code> | 0 | 0 | 3 |
| <strong>Total</strong> | <strong>1</strong> | <strong>8</strong> | <strong>15</strong> |</p>
<p><strong><a href="https://dcreager-fix-class-callable.ecosystem-663.pages.dev/diff">Full report with detailed diff</a></strong> (<a href="https://dcreager-fix-class-callable.ecosystem-663.pages.dev/timing">timing results</a>)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @dcreager on 2025-12-16 18:37</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @dcreager on 2025-12-16 18:37</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-12-16 18:37</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 16:42:36 UTC
    </footer>
</body>
</html>
