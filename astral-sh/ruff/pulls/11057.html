<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[`flake8-pyi`] Allow overloaded `__exit__` and `__aexit__` definitions (`PYI036`) - astral-sh/ruff #11057</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[<code>flake8-pyi</code>] Allow overloaded <code>__exit__</code> and <code>__aexit__</code> definitions (<code>PYI036</code>)</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/11057">#11057</a>
        opened by <a href="https://github.com/AlexWaygood">@AlexWaygood</a>
        on 2024-04-20 13:55
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a></div>
            <div class="timeline-body"><h2>Summary</h2>
<p>Fixes #11044</p>
<p>We should definitely allow overloaded definitions for <code>__exit__</code> and <code>__aexit__</code>. Nonetheless, <em>validating</em> overloads is pretty tricky without the full machinery of a type checker, so this PR deliberately takes a pretty conservative approach. If there are exactly two overloads, both overloads have exactly three annotated non-self non-keyword-only arguments each, and both overloads have no keyword-only arguments or variadic arguments -- then, for both overloads, we check to see if the overload matches one of two recognised overload variants (permitting small variations such as if one parameter is hinted with <code>object</code> or <code>_typeshed.Unused</code>). If there's an unexpected number of arguments, however, we just don't check the overload.</p>
<h2>Test plan</h2>
<p><code>cargo test</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @AlexWaygood on 2024-04-20 13:55</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">rule</span> added by @AlexWaygood on 2024-04-20 13:55</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2024-04-20 14:09</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>‚úÖ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>‚úÖ ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Converted to draft by @AlexWaygood on 2024-04-20 14:12</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/johnslavik">@johnslavik</a> on 2024-04-20 15:20</div>
            <div class="timeline-body"><p>Oh, good to see it! I've been having an issue with this recently. üëçüëçüëç</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-04-20 21:24</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_linter/src/rules/flake8_pyi/rules/exit_annotations.rs</code>:147 on 2024-04-20 21:24</div>
            <div class="timeline-body"><p>I think the logic here has been wrong for a while. It should have always been <code>parameters.posonlyargs.iter().chain(parameters.args.iter())</code>, not <code>parameters.args.iter().chain(parameters.posonlyargs.iter())</code>. I think it didn't come up because it the bug lead to false negatives rather than false positives, so nobody noticed!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @AlexWaygood on 2024-04-20 21:24</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-04-23 00:37</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_linter/src/rules/flake8_pyi/rules/exit_annotations.rs</code>:310 on 2024-04-23 00:37</div>
            <div class="timeline-body"><p>I would just use a normal <code>Vec</code> here personally. It's not a very hot path, right? This is <em>exactly</em> if you're defining one of a small set of methods, and it has an overload?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> approved on 2024-04-23 00:42</div>
            <div class="timeline-body"><p>I think if it were me making this decision on a desert island, I'd probably just skip overloads since I wouldn't find the complexity-to-value tradeoff to be good enough (we're trading ~400 lines of code for a scenario that seems somewhat rare). But I defer to you as the owner of the rule, and it looks like you have intuition that this is worth supporting.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-04-24 13:52</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_linter/src/rules/flake8_pyi/rules/exit_annotations.rs</code>:310 on 2024-04-24 13:52</div>
            <div class="timeline-body"><p>It shouldn't be very hot, no. I mainly used a <code>SmallVec</code> because it was already being used elsewhere in this file, and it <em>is</em> exceedingly unlikely that anybody <em>would</em> use more than two overloads for <code>__exit__</code> or <code>__aexit__</code>. Is there a disadvantage to using a SmallVec here?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-04-24 14:37</div>
            <div class="timeline-body"><blockquote>
<p>I think if it were me making this decision on a desert island, I'd probably just skip overloads since I wouldn't find the complexity-to-value tradeoff to be good enough</p>
</blockquote>
<p>Yeah I know what you mean. My initial thought when I saw the issue was &quot;well, that's going to add extra complexity to the check, and it's a less common case, so we may as well skip it&quot;. But (although we rarely bother with it in typeshed, it seems like extra complexity for little gain), Adam's <a href="https://adamj.eu/tech/2021/07/04/python-type-hints-how-to-type-a-context-manager/">recent blog post</a> <em>is</em> strictly-speaking correct that it's more accurate to use overloads for this case, and that blog seems to be making the rounds at the moment. And if you <em>are</em> going to use overloads, then I think it's really easy to get it subtly wrong by e.g. using <code>Exception</code> instead of <code>BaseException</code>, the same as if you don't use overloads. So I do think there <em>is</em> value to checking overloads.</p>
<p>This <em>may</em> be partly sunk-cost fallacy on my part though, given that I've gone ahead an implemented it now...</p>
<p>I think I'll add a few more test cases to make sure that every conceivable scenario is covered, then go ahead with this.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @AlexWaygood on 2024-04-24 15:48</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @AlexWaygood on 2024-04-24 15:48</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-04-24 15:48</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:03:54 UTC
    </footer>
</body>
</html>
