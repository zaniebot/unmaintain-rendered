<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[ruff]: add flake8-annotation-complexity - astral-sh/ruff #22427</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[ruff]: add flake8-annotation-complexity</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/ruff/pull/22427">#22427</a>
        opened by <a href="https://github.com/danjones1618">@danjones1618</a>
        on 2026-01-06 22:57
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/danjones1618">@danjones1618</a></div>
            <div class="timeline-body"><!--
Thank you for contributing to Ruff/ty! To help us out with reviewing, please consider the following:

- Does this pull request include a summary of the change? (See below.)
- Does this pull request include a descriptive title? (Please prefix with `[ty]` for ty pull
  requests.)
- Does this pull request include references to any relevant issues?
-->

<h2>Summary</h2>
<!-- What's the purpose of the change? What does it do, and why? -->

<p>Adds support for <a href="https://github.com/best-doctor/flake8-annotations-complexity">flake8-annotation-complexity</a> as requested by https://github.com/astral-sh/ruff/issues/2323.</p>
<p>As per the disucssion in #2323 the following has been implemented:</p>
<ul>
<li>Adds TAE002 to mirror <code>flake8-annotations-complexity</code></li>
<li>Ignores <code>typing.Annotated</code> for the purpose of annotation complexity</li>
<li>Considers PEP-604 union syntax as complex as <code>Union</code> (+1)</li>
</ul>
<p>Before merging, we should round-off any discussion over the formatting of the rules and associated codes. Currently it's adhering to the upstream however we may wish to split this into multiple rules like: <code>complex-argument-type-annotation</code>, <code>complex-return-type-annotation</code>, <code>complex-variable-annotation</code>, and so forth. In this case, we should move these to be under the <code>RUF</code> group instead of adding the <code>TAE</code> group.</p>
<h2>Test Plan</h2>
<!-- How was it tested? -->

<ul>
<li>Added unit tests</li>
<li>Added integration snapshot tests</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "feat: implement initial complexity calculation" to "[ruff]: add flake8-annotation-complexity" by @danjones1618 on 2026-01-06 22:58</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @danjones1618 on 2026-01-15 23:35</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">rule</span> added by @amyreese on 2026-01-16 02:04</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/amyreese">@amyreese</a> on <code>crates/ruff_linter/src/rules/flake8_annotation_complexity/rules/complex_annotation.rs</code>:36 on 2026-01-16 02:10</div>
            <div class="timeline-body"><p>Will need to update this once ready to land.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/amyreese">@amyreese</a> on <code>crates/ruff_linter/src/rules/flake8_annotation_complexity/rules/complex_annotation.rs</code>:10 on 2026-01-16 02:10</div>
            <div class="timeline-body"><pre><code class="language-suggestion">/// Checks for type annotation which are too complex.
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/amyreese">@amyreese</a> on <code>crates/ruff_linter/src/rules/flake8_annotation_complexity/rules/complex_annotation.rs</code>:13 on 2026-01-16 02:11</div>
            <div class="timeline-body"><pre><code class="language-suggestion">/// Annotation complexity is a symptom of using generic types for complex, nested data structures.
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/amyreese">@amyreese</a> on <code>crates/ruff_linter/src/rules/flake8_annotation_complexity/rules/complex_annotation.rs</code>:78 on 2026-01-16 02:13</div>
            <div class="timeline-body"><pre><code class="language-suggestion">struct CheckerAnnotationResolver&lt;'a, 'b&gt;
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/amyreese">@amyreese</a> on <code>crates/ruff_linter/src/rules/flake8_annotation_complexity/rules/complex_annotation.rs</code>:58 on 2026-01-16 02:13</div>
            <div class="timeline-body"><pre><code class="language-suggestion">    fn resolve_annotation_qualified_name&lt;'a, 'expr&gt;(
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/amyreese">@amyreese</a> on <code>crates/ruff_linter/src/rules/flake8_annotation_complexity/rules/complex_annotation.rs</code>:67 on 2026-01-16 02:15</div>
            <div class="timeline-body"><pre><code class="language-suggestion">    fn is_annotated_type(&amp;self, expr: &amp;Expr) -&gt; bool {
</code></pre>
<p>We might already have a helper for this related to the annotated type handling in fastapi/etc.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/amyreese">@amyreese</a> on <code>crates/ruff_linter/src/rules/flake8_annotation_complexity/rules/complex_annotation.rs</code>:121 on 2026-01-16 02:17</div>
            <div class="timeline-body"><pre><code class="language-suggestion">    if let Some(expr) = expr.as_string_literal_expr()
    &amp;&amp; let Some(literal_value) = expr.as_single_part_string()
    &amp;&amp; let Ok(inner_expr) = parse_expression(&amp;literal_value.value) {
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/amyreese">@amyreese</a> on <code>crates/ruff_linter/src/rules/flake8_annotation_complexity/rules/complex_annotation.rs</code>:121 on 2026-01-16 02:17</div>
            <div class="timeline-body"><p>Prefer let chains rather than nested forms.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/amyreese">@amyreese</a> on <code>crates/ruff_linter/src/rules/flake8_annotation_complexity/rules/complex_annotation.rs</code>:171 on 2026-01-16 02:19</div>
            <div class="timeline-body"><pre><code class="language-suggestion">            let annotation_complexity =
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/amyreese">@amyreese</a> on <code>crates/ruff_linter/src/rules/flake8_annotation_complexity/rules/complex_annotation.rs</code>:211 on 2026-01-16 02:20</div>
            <div class="timeline-body"><pre><code class="language-suggestion">    let annotation_resolver = CheckerAnnoationResolver { checker };

    let annotation_complexity =
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/amyreese">@amyreese</a> on <code>crates/ruff_linter/src/rules/flake8_annotation_complexity/rules/complex_annotation.rs</code>:239 on 2026-01-16 02:21</div>
            <div class="timeline-body"><pre><code class="language-suggestion">        fn resolve_annotation_qualified_name&lt;'a, 'expr&gt;(
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/amyreese">@amyreese</a> on <code>crates/ruff_linter/src/rules/flake8_annotation_complexity/rules/complex_annotation.rs</code>:271 on 2026-01-16 02:21</div>
            <div class="timeline-body"><pre><code class="language-suggestion">    fn test_get_annotation_complexity_yields_expected_value(
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/amyreese">@amyreese</a> on <code>crates/ruff_linter/src/rules/flake8_annotation_complexity/snapshots/ruff_linter__rules__flake8_annotation_complexity__tests__TAE002_yields_errors_TAE002.py.snap</code>:29 on 2026-01-16 02:22</div>
            <div class="timeline-body"><p>Limit the range to just the annotation to match the diagnostics for parameters and return types?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/amyreese">@amyreese</a> requested changes on 2026-01-16 02:24</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @ntBre by @amyreese on 2026-01-16 02:25</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/resources/test/fixtures/flake8_annotation_complexity/TAE002_quoted.py</code>:1 on 2026-01-16 21:42</div>
            <div class="timeline-body"><p>This is a small nit, but I would probably just include ~1 test case with a quoted annotation and keep it in the same file as the other tests. I think that should be enough to demonstrate that the rule applies to quoted annotations, otherwise I wouldn't expect there to be any differences in behavior.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/flake8_annotation_complexity/rules/complex_annotation.rs</code>:36 on 2026-01-16 21:44</div>
            <div class="timeline-body"><p>0.14.14 would be the current version to include here, assuming it lands before next Thursday.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/flake8_annotation_complexity/rules/complex_annotation.rs</code>:28 on 2026-01-16 21:45</div>
            <div class="timeline-body"><p>I think it might be worth suggesting a type alias too, that's what clippy does for its similar lint: https://rust-lang.github.io/rust-clippy/master/index.html?search=type_#type_complexity.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/flake8_annotation_complexity/snapshots/ruff_linter__rules__flake8_annotation_complexity__tests__TAE002_yields_errors_TAE002.py.snap</code>:29 on 2026-01-16 21:48</div>
            <div class="timeline-body"><p>Agreed, I think this would look better as:</p>
<pre><code class="language-suggestion">21 | variable_with_complex_ann: dict[str, dict[str, dict[str, dict[str, str]]]] = {}
   |                            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_workspace/src/options.rs</code>:1023 on 2026-01-16 21:53</div>
            <div class="timeline-body"><p>I think this should just be <code>int</code> in this attribute, at least that's what we have for another complexity metric:</p>
<p>https://github.com/astral-sh/ruff/blob/5c97b6ef40cd7fb34c2c69619657ef150d6031f4/crates/ruff_workspace/src/options.rs#L2907-L2915</p>
<pre><code class="language-suggestion">        value_type = &quot;int&quot;,
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/flake8_annotation_complexity/rules/complex_annotation.rs</code>:40 on 2026-01-16 21:54</div>
            <div class="timeline-body"><p>Can these ever be negative? If not, I would usually default to a <code>usize</code>, like the other complexity metric I linked to below.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/flake8_annotation_complexity/rules/complex_annotation.rs</code>:161 on 2026-01-16 21:55</div>
            <div class="timeline-body"><p>Let's move this function and the assignment version closer to the top of the file, just below the <code>Violation</code> struct and implementation.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/flake8_annotation_complexity/rules/complex_annotation.rs</code>:63 on 2026-01-16 21:57</div>
            <div class="timeline-body"><p>I think it would make sense to implement a <code>fix_title</code> function too (even if we can't provide an actual fix). That will attach a <code>help</code> sub-diagnostic to the end of the main diagnostic, where we could put a message like <code>consider using a type alias</code> or something. Just an idea.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/flake8_annotation_complexity/rules/complex_annotation.rs</code>:170 on 2026-01-16 21:59</div>
            <div class="timeline-body"><p>I haven't really looked closely enough to see if this is a drop-in replacement, but this function reminds me of an existing helper:</p>
<p>https://github.com/astral-sh/ruff/blob/5c97b6ef40cd7fb34c2c69619657ef150d6031f4/crates/ruff_python_ast/src/helpers.rs#L131-L134</p>
<p>We also have a more specific helper for traversing unions that may be helpful here:</p>
<p>https://github.com/astral-sh/ruff/blob/5c97b6ef40cd7fb34c2c69619657ef150d6031f4/crates/ruff_python_semantic/src/analyze/typing.rs#L453-L459</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/flake8_annotation_complexity/rules/complex_annotation.rs</code>:119 on 2026-01-16 22:03</div>
            <div class="timeline-body"><p>I could definitely be wrong, but I'm not sure we need to manually visit strings. String type annotations should already be classified as such and visited as type definitions:</p>
<p>https://github.com/astral-sh/ruff/blob/5c97b6ef40cd7fb34c2c69619657ef150d6031f4/crates/ruff_linter/src/checkers/ast/mod.rs#L2936</p>
<p>but we may need to adjust where the rule is applied. I.e. we may need to invoke <code>complex_annotation_function</code> not in <code>analyze::statement</code> but somewhere around here:</p>
<p>https://github.com/astral-sh/ruff/blob/5c97b6ef40cd7fb34c2c69619657ef150d6031f4/crates/ruff_linter/src/checkers/ast/analyze/expression.rs#L49-L62</p>
<p>I think these rules are somewhat similar to yours.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/flake8_annotation_complexity/rules/complex_annotation.rs</code>:192 on 2026-01-16 22:09</div>
            <div class="timeline-body"><p>If these are always static, we can use a <code>&amp;'static str</code> in the rule struct, or even define an enum if there are a fixed number of options.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/flake8_annotation_complexity/rules/complex_annotation.rs</code>:57 on 2026-01-16 22:10</div>
            <div class="timeline-body"><p>Could you say what this trait is for? It's not really clear to me how useful it is, at least on a first pass through the code.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/flake8_annotation_complexity/rules/complex_annotation.rs</code>:283 on 2026-01-16 23:58</div>
            <div class="timeline-body"><pre><code class="language-suggestion">        let flattened: Vec&lt;_&gt; = flatten_bin_op_expr(&amp;expr.expr().as_bin_op_expr().unwrap())
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2026-01-17 00:01</div>
            <div class="timeline-body"><p>Thanks for working on this! I had a few comments in addition to Amy's.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">preview</span> added by @ntBre on 2026-01-17 00:01</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/danjones1618">@danjones1618</a> reviewed on 2026-01-18 21:13</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/danjones1618">@danjones1618</a> on <code>crates/ruff_linter/src/rules/flake8_annotation_complexity/rules/complex_annotation.rs</code>:40 on 2026-01-18 21:13</div>
            <div class="timeline-body"><p>Indeed, changing</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/danjones1618">@danjones1618</a> reviewed on 2026-01-18 21:43</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/danjones1618">@danjones1618</a> on <code>crates/ruff_linter/src/rules/flake8_annotation_complexity/rules/complex_annotation.rs</code>:67 on 2026-01-18 21:43</div>
            <div class="timeline-body"><p>Found <code>match_typing_qualified_name</code> which allows me to simplify this section of the code! Thanks</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/danjones1618">@danjones1618</a> reviewed on 2026-01-18 21:51</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/danjones1618">@danjones1618</a> on <code>crates/ruff_linter/src/rules/flake8_annotation_complexity/rules/complex_annotation.rs</code>:57 on 2026-01-18 21:51</div>
            <div class="timeline-body"><p>This is a small indirection to <code>sematnic.resolve_qualified_name</code> to allow for unit testing of <code>get_annotation_complexity</code> of individual annotation expressions without the need to build a checker over an entire python module.</p>
<p>I've refactored this trait to be simpler as I was originally expecting to need to handle <code>Union</code>s too and I've also found a helper function that already handles the  <code>typing</code> vs <code>typing_extensions</code> resolution.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/danjones1618">@danjones1618</a> reviewed on 2026-01-18 21:56</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/danjones1618">@danjones1618</a> on <code>crates/ruff_linter/src/rules/flake8_annotation_complexity/rules/complex_annotation.rs</code>:63 on 2026-01-18 21:56</div>
            <div class="timeline-body"><p>Nice idea!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/danjones1618">@danjones1618</a> reviewed on 2026-01-18 23:00</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/danjones1618">@danjones1618</a> on <code>crates/ruff_linter/src/rules/flake8_annotation_complexity/rules/complex_annotation.rs</code>:119 on 2026-01-18 23:00</div>
            <div class="timeline-body"><p>From a quick check, commenting out the <code>expr.as_string_literal_expr</code> results in tests failing.</p>
<p>Looking around in the code for expression, we could move the calls to calculate the annotation complexity into this function under a <code>checker.semantic.in_annotation()</code> guard.</p>
<p>Regarding the self visiting of deferred string type definitions, this might work if we add the check function inside the aforementioned visitor function. Do you know if this will consider the entire annotation as deferred if a nested item is deferred such as <code>list[dict[str, &quot;DeferredDefinition&quot;]]</code>. Will this call at the <code>list</code> node or only from the string node?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/danjones1618">@danjones1618</a> reviewed on 2026-01-18 23:02</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/danjones1618">@danjones1618</a> on <code>crates/ruff_linter/src/rules/flake8_annotation_complexity/rules/complex_annotation.rs</code>:192 on 2026-01-18 23:02</div>
            <div class="timeline-body"><p>Unfortunately, this is the only location it's static as there's no argument name here. We could do a format string for it to become <code>&lt;function_name&gt;'s return type</code> if you think that's nicer?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/danjones1618">@danjones1618</a> reviewed on 2026-01-18 23:05</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/danjones1618">@danjones1618</a> on <code>crates/ruff_linter/src/rules/flake8_annotation_complexity/rules/complex_annotation.rs</code>:170 on 2026-01-18 23:05</div>
            <div class="timeline-body"><p>Looks like the <code>traverse_union</code> could be a viable alternative - I can try refactor it later in the week</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/danjones1618">@danjones1618</a> on 2026-01-18 23:07</div>
            <div class="timeline-body"><p>Thanks both @amyreese and @ntBre for the reviews. I've resolved your comments or responded to them.</p>
<p>I can refactor to use the <code>traverse_union</code> and adjust the call sites of entering the check later in the week if they're still desired.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-18 23:24:31 UTC
    </footer>
</body>
</html>
