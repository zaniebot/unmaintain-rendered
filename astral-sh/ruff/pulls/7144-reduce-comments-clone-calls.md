```yaml
number: 7144
title: "Reduce `comments.clone` calls"
type: pull_request
state: merged
author: MichaReiser
labels:
  - performance
  - formatter
assignees: []
merged: true
base: main
head: fewer-comments-clone
created_at: 2023-09-05T08:30:51Z
updated_at: 2023-09-05T09:32:57Z
url: https://github.com/astral-sh/ruff/pull/7144
synced_at: 2026-01-12T02:45:38Z
```

# Reduce `comments.clone` calls

---

_Pull request opened by @MichaReiser on 2023-09-05 08:30_

<!--
Thank you for contributing to Ruff! To help us out with reviewing, please consider the following:

- Does this pull request include a summary of the change? (See below.)
- Does this pull request include a descriptive title?
- Does this pull request include references to any relevant issues?
-->

## Summary

This PR improves the formatter performance by about 1% by avoiding cloning `comments` in the leading and trailing comment formatters if they are already provided. The cost of cloning comments itself isn't expensive (they're backed by an `Rc`) but it adds up because the leading and trailing comments formatting is called for every node.

## Test Plan

`cargo test`


---

_Comment by @MichaReiser on 2023-09-05 08:31_

Current dependencies on/for this PR:
* main
  * **PR #7144** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7144" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a>  ðŸ‘ˆ

This comment was auto-generated by [Graphite](https://app.graphite.dev/github/pr/astral-sh/ruff/7144?utm_source=stack-comment).

---

_Label `performance` added by @MichaReiser on 2023-09-05 08:50_

---

_Label `formatter` added by @MichaReiser on 2023-09-05 08:50_

---

_Marked ready for review by @MichaReiser on 2023-09-05 08:52_

---

_@MichaReiser reviewed on 2023-09-05 08:53_

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/comments/format.rs`:35 on 2023-09-05 08:53_

The entire change is that I introduced a `write` function that is called inside of the match arms. The formatting logic itself remains unchanged.

---

_@charliermarsh approved on 2023-09-05 09:05_

---

_Merged by @MichaReiser on 2023-09-05 09:32_

---

_Closed by @MichaReiser on 2023-09-05 09:32_

---

_Branch deleted on 2023-09-05 09:32_

---
