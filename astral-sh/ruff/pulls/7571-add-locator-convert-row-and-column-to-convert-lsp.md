```yaml
number: 7571
title: "Add `Locator::convert_row_and_column` to convert LSP utf-16 coordinates to byte offsets"
type: pull_request
state: closed
author: konstin
labels:
  - internal
  - formatter
assignees: []
base: main
head: col-row-coords-to-bytes-offsets
created_at: 2023-09-21T11:36:08Z
updated_at: 2023-10-30T13:09:47Z
url: https://github.com/astral-sh/ruff/pull/7571
synced_at: 2026-01-10T23:40:55Z
```

# Add `Locator::convert_row_and_column` to convert LSP utf-16 coordinates to byte offsets

---

_Pull request opened by @konstin on 2023-09-21 11:36_

**Summary** Compute the byte offset from language server protocol zero-indexed row and column indices.

It's possible to negotiate the text encoding with the LSP client, but the default that must
always be supported and that we currently use is utf-16.

We get row and column from the LSP. E.g.
```text
a=(1,2,)
b=(3,4,)
  ^
c=(5,6,)
```
has coordinates `1:2`. Note that indices are computed in utf-16, e.g.
```text
"ÏïàÎÖï"
   ^
```
where the first syllable is a single character (two bytes), we get `0:2`, while for
```text
"·ÑÄ·Ö°·Ü∑·ÑÄ·Öµ"
   ^
```
where the first syllable is three characters (three times two bytes), we get `0:4`. But for
```text
Ë±ÜËÖê
  ^
```
we get `0:2` because `Ë±Ü` is two characters (4 bytes) in utf-16.

**Test Plan** Doc tests


---

_Comment by @konstin on 2023-09-21 11:36_

Current dependencies on/for this PR:
* main
  * **PR #7569** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7569" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a> 
    * **PR #7571** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7571" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a>  üëà

This comment was auto-generated by [Graphite](https://app.graphite.dev/github/pr/astral-sh/ruff/7571?utm_source=stack-comment).

---

_Label `internal` added by @konstin on 2023-09-21 11:36_

---

_Label `formatter` added by @konstin on 2023-09-21 11:36_

---

_@MichaReiser reviewed on 2023-09-21 11:41_

---

_Review comment by @MichaReiser on `crates/ruff_source_file/src/locator.rs`:494 on 2023-09-21 11:41_

We may need to move this out of `Locator`. The goal is to remove all `Index` uses inside of `Locator` eventually. 

---

_Review comment by @konstin on `crates/ruff_source_file/src/locator.rs`:494 on 2023-09-21 11:56_

Should it live directly on Index instead?

---

_@konstin reviewed on 2023-09-21 11:56_

---

_Comment by @github-actions[bot] on 2023-09-26 08:34_

## PR Check Results
### Ecosystem
‚úÖ ecosystem check detected no changes.



---

_Renamed from "Add `Locator::convert_row_and_column` to convert LSP coordinates to byte offsets" to "Add `Locator::convert_row_and_column` to convert LSP utf-16 coordinates to byte offsets" by @konstin on 2023-09-26 08:45_

---

_@konstin reviewed on 2023-09-26 08:48_

---

_Review comment by @konstin on `crates/ruff_source_file/src/locator.rs`:494 on 2023-09-26 08:48_

i think it needs to live in the locator because we need both fields

---

_Marked ready for review by @konstin on 2023-09-26 08:48_

---

_Review requested from @MichaReiser by @konstin on 2023-09-26 08:48_

---

_Review comment by @MichaReiser on `crates/ruff_source_file/src/locator.rs`:506 on 2023-09-26 10:59_

I would prefer if we move the method to `LineIndex` directly

Can we use `OneIndexed` for `row` and `column`?

---

_Review comment by @MichaReiser on `crates/ruff_source_file/src/locator.rs`:513 on 2023-09-26 10:59_

```suggestion
        let line_range = *self.to_index().line_range(row)
```

---

_Review comment by @MichaReiser on `crates/ruff_source_file/src/locator.rs`:522 on 2023-09-26 11:00_

This should not be necessary when you use `line_range`

---

_Review comment by @MichaReiser on `crates/ruff_source_file/src/locator.rs`:523 on 2023-09-26 11:01_

The LSP specification mentions that the column should be clamped to the line length

---

_@MichaReiser reviewed on 2023-09-26 11:01_

---

_Comment by @MichaReiser on 2023-09-26 11:38_

My main question is whether we should tie our CLI API to the LSP specification or not. I would expect that `ruff format --range-start 34:01 --range-end 35:30` (or similar) to use character indices rather than UTF-16 words as column offset.

---

_@konstin reviewed on 2023-09-26 12:12_

---

_Review comment by @konstin on `crates/ruff_source_file/src/locator.rs`:506 on 2023-09-26 12:12_

That doesn't work because we need the source

---

_@konstin reviewed on 2023-09-26 12:14_

---

_Review comment by @konstin on `crates/ruff_source_file/src/locator.rs`:506 on 2023-09-26 12:14_

> Can we use OneIndexed for row and column?

They aren't! The origin is (0,0)

---

_Comment by @konstin on 2023-09-26 12:24_

I wouldn't do this conversion in python so we need to to it in rust. For me it would make most sense to have to have a `--offset-kind` flag and/or to have a separate `ruff format-lsp subcommand`, but i'd need this method either way

---

_Comment by @codspeed-hq[bot] on 2023-09-26 12:31_

## [CodSpeed Performance Report](https://codspeed.io/astral-sh/ruff/branches/col-row-coords-to-bytes-offsets)

### Merging #7571 will **improve performances by 2.48%**

<sub>Comparing <code>col-row-coords-to-bytes-offsets</code> (5be2ec5) with <code>_formatter-and-parser-refactorings</code> (dd8b124)</sub>



### Summary

`‚ö° 1` improvements
`‚úÖ 24` untouched benchmarks




### Benchmarks breakdown

|     | Benchmark | `_formatter-and-parser-refactorings` | `col-row-coords-to-bytes-offsets` | Change |
| --- | --------- | ----------------------- | ------------------- | ------ |
| ‚ö° | `linter/all-rules[numpy/ctypeslib.py]` | 35 ms | 34.1 ms | +2.48% |


---

_Comment by @MichaReiser on 2023-09-26 13:08_

> I wouldn't do this conversion in python so we need to to it in rust. For me it would make most sense to have to have a `--offset-kind` flag and/or to have a separate `ruff format-lsp subcommand`, but i'd need this method either way

I think the UTF16 to characters conversion is an LSP concern and shouldn't influence how we represent offsets in our CLI. I would find it rather confusing as a user if I have to compute utf 16 word offsets to use the CLI.

I agree, that we'll need a `offset(row, column, text)` method.

---

_Review comment by @konstin on `crates/ruff_source_file/src/locator.rs`:523 on 2023-09-26 13:31_

yep, but we can't guarantee what values we get passed in here

---

_@konstin reviewed on 2023-09-26 13:31_

---

_Comment by @konstin on 2023-09-26 13:34_

I agree, but what alternative would you suggest? The CLI is currently our LSP interface, and even it weren't, we'd get `usize`/`u32` in we'd need to convert. I don't expect that people would actually range format by hand (just manually indent at that point), just hiding the option, either in `ruff format` or somewhere else seems the most reasonable to me.

---

_Comment by @MichaReiser on 2023-09-26 15:29_

> I agree, but what alternative would you suggest? The CLI is currently our LSP interface, and even it weren't, we'd get `usize`/`u32` in we'd need to convert. I don't expect that people would actually range format by hand (just manually indent at that point), just hiding the option, either in `ruff format` or somewhere else seems the most reasonable to me.

I recommend converting the range to `line:character` in the LSP and adding an `offset(row: OneIndexed, column: OneIndexed) -> TextSize` to `LineIndex` similar to how you did. That would match the conversion from `Fix::edits` to lsp `TextEdit` where we handle the offset conversion as well.

---

_Closed by @konstin on 2023-10-30 13:09_

---
