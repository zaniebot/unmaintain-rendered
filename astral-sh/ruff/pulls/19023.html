<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[`flake8-pyi`] Fix `PYI041` not resolving string annotations - astral-sh/ruff #19023</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[<code>flake8-pyi</code>] Fix <code>PYI041</code> not resolving string annotations</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/ruff/pull/19023">#19023</a>
        opened by <a href="https://github.com/robsdedude">@robsdedude</a>
        on 2025-06-29 10:37
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/robsdedude">@robsdedude</a> on 2025-06-29 10:37</div>
            <div class="timeline-body"><!--
Thank you for contributing to Ruff/ty! To help us out with reviewing, please consider the following:

- Does this pull request include a summary of the change? (See below.)
- Does this pull request include a descriptive title? (Please prefix with `[ty]` for ty pull
  requests.)
- Does this pull request include references to any relevant issues?
-->

<h2>Summary</h2>
<p>While working on https://github.com/astral-sh/ruff/pull/18637, I <a href="https://github.com/astral-sh/ruff/pull/18637#discussion_r2142594045">noticed</a> that PYI041 does not properly resolve string annotations. This PR fixes that.</p>
<h2>Test Plan</h2>
<p>A whole new file with tests has been added.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-06-29 10:54</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @robsdedude on 2025-06-29 13:37</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @AlexWaygood by @robsdedude on 2025-06-29 13:37</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @ntBre by @MichaReiser on 2025-07-07 12:51</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/resources/test/fixtures/flake8_pyi/PYI041_3.py</code>:16 on 2025-07-07 12:54</div>
            <div class="timeline-body"><p>Can you add a test for a type annotation consisting of a concatenated string literal:</p>
<pre><code class="language-suggestion">def good1(arg: &quot;int&quot;) -&gt; &quot;int&quot; &quot;| bool&quot;:
    ...
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-07-07 12:55</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/robsdedude">@robsdedude</a> reviewed on 2025-07-07 13:31</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/robsdedude">@robsdedude</a> on <code>crates/ruff_linter/resources/test/fixtures/flake8_pyi/PYI041_3.py</code>:16 on 2025-07-07 13:31</div>
            <div class="timeline-body"><p>Good catch! While detection works, the fix did indeed drop the quotation marks.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/robsdedude">@robsdedude</a> reviewed on 2025-07-07 15:14</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/robsdedude">@robsdedude</a> on <code>crates/ruff_linter/resources/test/fixtures/flake8_pyi/PYI041_3.py</code>:16 on 2025-07-07 15:14</div>
            <div class="timeline-body"><p>This is non-trivial to fix. I'll have to go on a side-mission fixing https://github.com/astral-sh/ruff/issues/19184 first.</p>
<p>My approach was to alter <code>parse_simple_type_annotation</code> (just like <code>parse_complex_type_annotation</code> already does) such that the resulting resolved virtual expression spans that whole string. That way, the rule can just replace the whole string and wrap it in quotes if the original annotation was a forward reference.</p>
<p>But alas, that change to <code>parse_simple_type_annotation</code> amplifies the linked bug to also affect non-concatenated forward refs.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-07-07 16:02</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/resources/test/fixtures/flake8_pyi/PYI041_3.py</code>:16 on 2025-07-07 16:02</div>
            <div class="timeline-body"><p>I believe this was part of the reason why we decided not to support string annotations in the initial implementation as they aren't as common anymore and we didn't felt like they're worth all the complexity they add.</p>
<p>Could we disable the fix for problematic stringified annotations (I think you can also use triple quoted strings or put them across multiple lines). We should try to add tests for all of those if we decide that supporting them is worth the complexity</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/robsdedude">@robsdedude</a> reviewed on 2025-07-07 16:06</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/robsdedude">@robsdedude</a> on <code>crates/ruff_linter/resources/test/fixtures/flake8_pyi/PYI041_3.py</code>:16 on 2025-07-07 16:06</div>
            <div class="timeline-body"><p>Tripple quoted type annotations actually work fine. There are some in the test set.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/checkers/ast/mod.rs</code>:552 on 2025-08-07 13:42</div>
            <div class="timeline-body"><p>Do we need to call <code>.ok()</code> here or can we just do</p>
<pre><code class="language-suggestion">            let Ok(parsed_annotation) = self.parse_type_annotation(string_annotation) else {
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/checkers/ast/mod.rs</code>:552 on 2025-08-07 14:38</div>
            <div class="timeline-body"><p>Hmm, maybe it makes sense to use <code>if-let</code> instead since both of the <code>else</code>s are the same:</p>
<pre><code class="language-rust">if let ast::Expr::StringLiteral(string_annotation) = expr {
    if let Ok(parsed_annotation) = self.parse_type_annotation(string_annotation) {
        return map_fn(parsed_annotation.expression());
    }
}

map_fn(expr)
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/flake8_pyi/rules/redundant_numeric_union.rs</code>:85 on 2025-08-07 14:43</div>
            <div class="timeline-body"><p>Is it possible just to return an <code>Expr</code> from the <code>map_maybe_stringized_annotation</code>? I think it would simplify things a bit if so. We could avoid passing a closure and just do something like:</p>
<pre><code class="language-rust">check_annotation(checker, map_string_annotation(annotation), annotation)
</code></pre>
<p>That seems closer to another API I've seen in <code>map_callable</code>:</p>
<p>https://github.com/astral-sh/ruff/blob/96ffd8a134d62f5426c9d94d15adb21100d90f01/crates/ruff_python_ast/src/helpers.rs#L724-L727</p>
<p>Maybe it doesn't work here, though.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-08-07 14:55</div>
            <div class="timeline-body"><p>Thanks and sorry for the delay. This looks good to me, but I think we may need to gate this behind preview since it's a pretty big change to a stable rule.</p>
<p>Otherwise I just had some small ideas/suggestions, assuming @MichaReiser's concerns are resolved.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "[`flake8_pyi`] Fix `PYI041` not resolving string annotations" to "[`flake8-pyi`] Fix `PYI041` not resolving string annotations" by @ntBre on 2025-08-07 14:55</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">rule</span> added by @ntBre on 2025-08-07 14:55</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/robsdedude">@robsdedude</a> reviewed on 2025-10-11 08:18</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/robsdedude">@robsdedude</a> on <code>crates/ruff_linter/src/rules/flake8_pyi/rules/redundant_numeric_union.rs</code>:85 on 2025-10-11 08:18</div>
            <div class="timeline-body"><p>Ah yes, it just requires a fair bit of lifetime juggling :D</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/robsdedude">@robsdedude</a> reviewed on 2025-10-11 08:39</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/robsdedude">@robsdedude</a> on <code>crates/ruff_linter/resources/test/fixtures/flake8_pyi/PYI041_3.py</code>:16 on 2025-10-11 08:39</div>
            <div class="timeline-body"><p>I ended up addressing this in a similar way as RUF013 handles is:</p>
<ul>
<li>analysis on stringized annotations: will do</li>
<li>suggesting fixes on stringized annotations: only if simple sting (i.e., non-concatendated) and always mark as unsafe.</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @ntBre by @robsdedude on 2025-10-11 08:40</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/robsdedude">@robsdedude</a> on 2025-10-11 08:47</div>
            <div class="timeline-body"><p>@ntBre @MichaReiser Could you have another look. I think I addressed all comments.</p>
<p>Note to myself: when this is merged, take another look at https://github.com/astral-sh/ruff/issues/19184 to see if the same approach (https://github.com/astral-sh/ruff/pull/19023#discussion_r2422617499) could be applied.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 17:34:59 UTC
    </footer>
</body>
</html>
