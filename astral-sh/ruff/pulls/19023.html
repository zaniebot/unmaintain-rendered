<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[`flake8-pyi`] Fix `PYI041` not resolving string annotations - astral-sh/ruff #19023</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[<code>flake8-pyi</code>] Fix <code>PYI041</code> not resolving string annotations</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/ruff/pull/19023">#19023</a>
        opened by <a href="https://github.com/robsdedude">@robsdedude</a>
        on 2025-06-29 10:37
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/robsdedude">@robsdedude</a></div>
            <div class="timeline-body">

Summary
<p>While working on <a href="https://github.com/astral-sh/ruff/pull/18637">astral-sh/ruff#18637</a>, I <a href="https://github.com/astral-sh/ruff/pull/18637#discussion_r2142594045">noticed</a> that PYI041 does not properly resolve string annotations. This PR fixes that.</p>
Test Plan
<p>A whole new file with tests has been added.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-06-29 10:54</div>
            <div class="timeline-body">

<code>ruff-ecosystem</code> results
Linter (stable)
<p>✅ ecosystem check detected no linter changes.</p>
Linter (preview)
<p>✅ ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by <a href="https://github.com/robsdedude">@robsdedude</a> on 2025-06-29 13:37</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/AlexWaygood">@AlexWaygood</a> by <a href="https://github.com/robsdedude">@robsdedude</a> on 2025-06-29 13:37</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/ntBre">@ntBre</a> by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-07-07 12:51</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/resources/test/fixtures/flake8_pyi/PYI041_3.py</code>:16 on 2025-07-07 12:54</div>
            <div class="timeline-body"><p>Can you add a test for a type annotation consisting of a concatenated string literal:</p>
<pre><code>def good1(arg: &quot;int&quot;) -&gt; &quot;int&quot; &quot;| bool&quot;:
    ...
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-07-07 12:55</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/robsdedude">@robsdedude</a> reviewed on 2025-07-07 13:31</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/robsdedude">@robsdedude</a> on <code>crates/ruff_linter/resources/test/fixtures/flake8_pyi/PYI041_3.py</code>:16 on 2025-07-07 13:31</div>
            <div class="timeline-body"><p>Good catch! While detection works, the fix did indeed drop the quotation marks.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/robsdedude">@robsdedude</a> reviewed on 2025-07-07 15:14</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/robsdedude">@robsdedude</a> on <code>crates/ruff_linter/resources/test/fixtures/flake8_pyi/PYI041_3.py</code>:16 on 2025-07-07 15:14</div>
            <div class="timeline-body"><p>This is non-trivial to fix. I&#x27;ll have to go on a side-mission fixing <a href="https://github.com/astral-sh/ruff/issues/19184">astral-sh/ruff#19184</a> first.</p>
<p>My approach was to alter <code>parse_simple_type_annotation</code> (just like <code>parse_complex_type_annotation</code> already does) such that the resulting resolved virtual expression spans that whole string. That way, the rule can just replace the whole string and wrap it in quotes if the original annotation was a forward reference.</p>
<p>But alas, that change to <code>parse_simple_type_annotation</code> amplifies the linked bug to also affect non-concatenated forward refs.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-07-07 16:02</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/resources/test/fixtures/flake8_pyi/PYI041_3.py</code>:16 on 2025-07-07 16:02</div>
            <div class="timeline-body"><p>I believe this was part of the reason why we decided not to support string annotations in the initial implementation as they aren&#x27;t as common anymore and we didn&#x27;t felt like they&#x27;re worth all the complexity they add.</p>
<p>Could we disable the fix for problematic stringified annotations (I think you can also use triple quoted strings or put them across multiple lines). We should try to add tests for all of those if we decide that supporting them is worth the complexity</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/robsdedude">@robsdedude</a> reviewed on 2025-07-07 16:06</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/robsdedude">@robsdedude</a> on <code>crates/ruff_linter/resources/test/fixtures/flake8_pyi/PYI041_3.py</code>:16 on 2025-07-07 16:06</div>
            <div class="timeline-body"><p>Tripple quoted type annotations actually work fine. There are some in the test set.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/checkers/ast/mod.rs</code>:552 on 2025-08-07 13:42</div>
            <div class="timeline-body"><p>Do we need to call <code>.ok()</code> here or can we just do</p>
<pre><code>            let Ok(parsed_annotation) = self.parse_type_annotation(string_annotation) else {
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/checkers/ast/mod.rs</code>:552 on 2025-08-07 14:38</div>
            <div class="timeline-body"><p>Hmm, maybe it makes sense to use <code>if-let</code> instead since both of the <code>else</code>s are the same:</p>
<pre><code>if let ast::Expr::StringLiteral(string_annotation) = expr {
    if let Ok(parsed_annotation) = self.parse_type_annotation(string_annotation) {
        return map_fn(parsed_annotation.expression());
    }
}

map_fn(expr)
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/flake8_pyi/rules/redundant_numeric_union.rs</code>:85 on 2025-08-07 14:43</div>
            <div class="timeline-body"><p>Is it possible just to return an <code>Expr</code> from the <code>map_maybe_stringized_annotation</code>? I think it would simplify things a bit if so. We could avoid passing a closure and just do something like:</p>
<pre><code>check_annotation(checker, map_string_annotation(annotation), annotation)
</code></pre>
<p>That seems closer to another API I&#x27;ve seen in <code>map_callable</code>:</p>
<p>https://github.com/astral-sh/ruff/blob/96ffd8a134d62f5426c9d94d15adb21100d90f01/crates/ruff_python_ast/src/helpers.rs#L724-L727</p>
<p>Maybe it doesn&#x27;t work here, though.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-08-07 14:55</div>
            <div class="timeline-body"><p>Thanks and sorry for the delay. This looks good to me, but I think we may need to gate this behind preview since it&#x27;s a pretty big change to a stable rule.</p>
<p>Otherwise I just had some small ideas/suggestions, assuming @MichaReiser&#x27;s concerns are resolved.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from &quot;[`flake8_pyi`] Fix `PYI041` not resolving string annotations&quot; to &quot;[`flake8-pyi`] Fix `PYI041` not resolving string annotations&quot; by <a href="https://github.com/ntBre">@ntBre</a> on 2025-08-07 14:55</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">rule</span> added by <a href="https://github.com/ntBre">@ntBre</a> on 2025-08-07 14:55</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/robsdedude">@robsdedude</a> reviewed on 2025-10-11 08:18</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/robsdedude">@robsdedude</a> on <code>crates/ruff_linter/src/rules/flake8_pyi/rules/redundant_numeric_union.rs</code>:85 on 2025-10-11 08:18</div>
            <div class="timeline-body"><p>Ah yes, it just requires a fair bit of lifetime juggling :D</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/robsdedude">@robsdedude</a> reviewed on 2025-10-11 08:39</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/robsdedude">@robsdedude</a> on <code>crates/ruff_linter/resources/test/fixtures/flake8_pyi/PYI041_3.py</code>:16 on 2025-10-11 08:39</div>
            <div class="timeline-body"><p>I ended up addressing this in a similar way as RUF013 handles is:</p>
<ul>
<li>analysis on stringized annotations: will do</li>
<li>suggesting fixes on stringized annotations: only if simple sting (i.e., non-concatendated) and always mark as unsafe.</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/ntBre">@ntBre</a> by <a href="https://github.com/robsdedude">@robsdedude</a> on 2025-10-11 08:40</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/robsdedude">@robsdedude</a> on 2025-10-11 08:47</div>
            <div class="timeline-body"><p>@ntBre @MichaReiser Could you have another look. I think I addressed all comments.</p>
<p>Note to myself: when this is merged, take another look at <a href="https://github.com/astral-sh/ruff/issues/19184">astral-sh/ruff#19184</a> to see if the same approach (<a href="https://github.com/astral-sh/ruff/pull/19023">astral-sh/ruff#19023</a>#discussion_r2422617499) could be applied.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:16:02 UTC
    </footer>
</body>
</html>
