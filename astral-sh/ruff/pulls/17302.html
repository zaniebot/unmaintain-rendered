<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[red-knot] more type-narrowing in match statements - astral-sh/ruff #17302</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[red-knot] more type-narrowing in match statements</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/17302">#17302</a>
        opened by <a href="https://github.com/ericmarkmartin">@ericmarkmartin</a>
        on 2025-04-08 21:36
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ericmarkmartin">@ericmarkmartin</a></div>
            <div class="timeline-body">

Summary
<p>Add more narrowing analysis for match statements:</p>
<ul>
<li>add narrowing constraints from guard expressions</li>
<li>add negated constraints from previous predicates and guards to subsequent cases</li>
</ul>
<p>This PR doesn&#x27;t address that guards can mutate your subject, and so theoretically invalidate some of these narrowing constraints that you&#x27;ve previously accumulated. Some prior art on this issue <a href="https://www.irif.fr/~scherer/research/mutable-patterns/mutable-patterns-mlworkshop2024-abstract.pdf">here</a>.</p>
Test Plan
<p>Add some new tests, and update some existing ones</p>


</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/carljm">@carljm</a> by <a href="https://github.com/ericmarkmartin">@ericmarkmartin</a> on 2025-04-08 21:36</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/AlexWaygood">@AlexWaygood</a> by <a href="https://github.com/ericmarkmartin">@ericmarkmartin</a> on 2025-04-08 21:36</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/sharkdp">@sharkdp</a> by <a href="https://github.com/ericmarkmartin">@ericmarkmartin</a> on 2025-04-08 21:36</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/dcreager">@dcreager</a> by <a href="https://github.com/ericmarkmartin">@ericmarkmartin</a> on 2025-04-08 21:36</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from &quot;More match narrowing&quot; to &quot;[red-knot] more type-narrowing in match statements&quot; by <a href="https://github.com/ericmarkmartin">@ericmarkmartin</a> on 2025-04-08 21:36</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-04-08 21:38</div>
            <div class="timeline-body">

<code>mypy_primer</code> results
<p>No ecosystem changes detected âœ…</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-04-08 21:43</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/semantic_index/builder.rs</code>:1542 on 2025-04-09 04:16</div>
            <div class="timeline-body"><p>This comment doesn&#x27;t address why we have the <code>|| !hash_catchall</code> clause above</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> approved on 2025-04-09 04:19</div>
            <div class="timeline-body"><p>Thank you, looks good!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for <a href="https://github.com/AlexWaygood">@AlexWaygood</a> removed by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-04-09 07:43</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-04-09 15:33</div>
            <div class="timeline-body"><p>Going to go ahead and rebase this, expand the one comment slightly, and land it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-04-09 15:47</div>
            <div class="timeline-body"><p>Oops, never mind, after the rebase there&#x27;s a recently-added test that fails with this PR, and it looks like the test is correct? With this PR, we seem to no longer realize that in</p>
<pre><code>match 42:
    case {&quot;something&quot;: M}: ...
</code></pre>
<p>that <code>M</code> may not be bound afterward.</p>
<p>We should add a test for this that&#x27;s not part of the star-import tests, and figure out what we need to adjust in this PR in order to avoid regressing it.</p>
<p>I pushed my rebase and one slightly expanded comment, but I need to move on to other things for now, so I&#x27;ll consider this PR back in your court.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ericmarkmartin">@ericmarkmartin</a> on 2025-04-10 05:43</div>
            <div class="timeline-body"><blockquote>
<p>Oops, never mind, after the rebase there&#x27;s a recently-added test that fails with this PR, and it looks like the test is correct? With this PR, we seem to no longer realize that in</p>
<pre><code>match 42:
    case {&quot;something&quot;: M}: ...
</code></pre>
<p>that <code>M</code> may not be bound afterward.</p>
</blockquote>
<p>it turns out it was just that I had copied the Stmt::If branch too closely: in the case of If, you must visit the test expression in the &quot;no branch taken&quot; flow because we need to evaluate the test before we can know it&#x27;s False(y)</p>
<p>In the case of match statements, however, visiting the pattern implies undertaking symbol bindings, which we definitely don&#x27;t want to track on the &quot;no case matched&quot; flow.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-04-10 13:29</div>
            <div class="timeline-body"><p>Thanks for revisiting this!</p>
<p>Looks like we are now seeing a panic in one of the corpus tests, where we enter what should be an unreachable code path. We seem to simultaneously think there is a binding visible for a symbol, while the &quot;unbound&quot; initial state for that symbol is also definitely-visible -- that combination shouldn&#x27;t be possible.</p>
<p>I took a quick glance at the code changes and nothing jumped out at me; let me know if you aren&#x27;t able to figure out the reason and I can take a closer look.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> approved on 2025-04-18 01:13</div>
            <div class="timeline-body"><p>Looks great! Thank you for persisting with this. I pushed a couple minor simplifications I noticed, will merge once signal is green.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/carljm">@carljm</a> on 2025-04-18 01:18</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/carljm">@carljm</a> on 2025-04-18 01:18</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:13:09 UTC
    </footer>
</body>
</html>
