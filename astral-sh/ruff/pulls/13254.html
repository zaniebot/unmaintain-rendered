<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[red-knot] resolve source/stubs over namespace packages - astral-sh/ruff #13254</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[red-knot] resolve source/stubs over namespace packages</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/13254">#13254</a>
        opened by <a href="https://github.com/Slyces">@Slyces</a>
        on 2024-09-05 15:58
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Slyces">@Slyces</a></div>
            <div class="timeline-body">

<p>This PR tries to fix #12278. That issue doesn&#x27;t have the tag <code>help-wanted</code>, so I&#x27;m not sure if I can contribute a fix</p>
Summary
Expected Behaviour
<p>In python, a <code>module</code> can actually be 3 things:</p>
<ul>
<li>Regular file</li>
<li>Package (directory with <code>__init__.py</code>)</li>
<li>Namespace package (directory without <code>__init__.py</code>)</li>
</ul>
<p>In the import logic, when resolving <code>foo.bar.baz</code>, we should have the following priority:</p>
<pre><code>└─ foo
   └─ bar
      ├─ baz           &lt;-- regular package over module
      │  └─ __init__.py
      └─ baz.py
</code></pre>
<p><strong>works</strong></p>
<pre><code>└─ foo
   └─ bar
      ├─ baz.py        &lt;-- module over namespace package
      └─ baz           &lt;-- namespace package invisible (because of module)
         └─ ...
</code></pre>
<p><strong>doesn&#x27;t work</strong></p>
Current Implementation
<p>Currently, the code properly imports regular packages over modules, but when a namespace package is here, it makes a module with the same name invisible, which is the opposite of what we want.</p>
<p>We want to guarantee 3 things:</p>
<ul>
<li>Regular package has priority over module (covered in existing test)</li>
<li>Module has priority over namespace package (new test)</li>
<li>A namespace package is made invisible by a module of the same name (new test)</li>
</ul>
Fixes
<p>We have 2 core problems in our logic:</p>
<ul>
<li>We properly resolve a namespace package when a module of the same name exists</li>
<li>When a package (root, regular, namespace) is located and we try to resolve the last component <code>foo</code><ul>
<li>If <code>foo</code> is a directory, we consider it&#x27;s a regular package<ul>
<li>If the <code>foo</code> directory was a namespace package, it fails and we don&#x27;t test <code>foo</code> as a module</li>
</ul>
</li>
<li>If <code>foo</code> is not a directory, we try to resolve it as a module</li>
</ul>
</li>
</ul>
<p>This is fixed by:</p>
<ul>
<li>Adding a check in package resolution to skip shadowed namespace packages</li>
<li>Changing the way we resolve modules to not rely on <code>foo</code> being a directory<ul>
<li>We directly check <code>foo/__init__</code></li>
<li>If that doesn&#x27;t work, we fallback to <code>foo</code></li>
</ul>
</li>
</ul>
Test Plan
<p>The issue #12278 introduces a unit test that should pass after the issue is fixed.
This test is included in the PR.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/carljm">@carljm</a> by <a href="https://github.com/Slyces">@Slyces</a> on 2024-09-05 15:58</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/MichaReiser">@MichaReiser</a> by <a href="https://github.com/Slyces">@Slyces</a> on 2024-09-05 15:58</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/AlexWaygood">@AlexWaygood</a> by <a href="https://github.com/Slyces">@Slyces</a> on 2024-09-05 15:58</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-09-05 16:00</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">great writeup</span> added by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-09-05 16:01</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2024-09-05 16:02</div>
            <div class="timeline-body"><blockquote>
<p>That issue doesn&#x27;t have the tag <code>help-wanted</code>, so I&#x27;m not sure if I can contribute a fix</p>
</blockquote>
<p>There&#x27;s no problem working on an issue that doesn&#x27;t have the <code>help-wanted</code> tag, it just slightly increases the risk that there are unexplored complexities or we aren&#x27;t sure how we want to address it yet :) It might be a good idea to comment on the issue before you start work, to reduce the chance of wasted work because two people work on an issue at once, or because the issue is stale, or whatever.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-09-05 16:03</div>
            <div class="timeline-body"><p>And in this particular case, the contribution is very welcome!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2024-09-05 16:24</div>
            <div class="timeline-body">

<code>ruff-ecosystem</code> results
Linter (stable)
<p>✅ ecosystem check detected no linter changes.</p>
Linter (preview)
<p>✅ ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2024-09-05 20:12</div>
            <div class="timeline-body"><p>Going to leave review on this one to Alex and Micha, who are more familiar with the module resolver implementation.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for <a href="https://github.com/carljm">@carljm</a> removed by <a href="https://github.com/carljm">@carljm</a> on 2024-09-05 20:12</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_python_semantic/src/module_resolver/path.rs</code>:72 on 2024-09-06 06:32</div>
            <div class="timeline-body"><p>It seems to me that we can push <code>kind</code> out of this function. As far as I can tell, the kind is always <code>Module</code> for line 573 and <code>Package</code> for line 578</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_python_semantic/src/module_resolver/path.rs</code>:68 on 2024-09-06 06:42</div>
            <div class="timeline-body"><p>Nit: I&#x27;m inclined to move this method out of <code>path</code> because <code>path</code> currently has no <em>resolution</em> mehtods. It only has methods to probe the structure.</p>
<p>I do find the word <em>pure</em> unclear in this context. I think I know what you wanted to express with it. Maybe <code>resolve_file_module</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2024-09-06 06:42</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-09-06 06:43</div>
            <div class="timeline-body"><p>Overall looks great. Thank you. I&#x27;ve a few small nit comments and I&#x27;d like Alex to take a look as well</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Slyces">@Slyces</a> reviewed on 2024-09-06 07:20</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/Slyces">@Slyces</a> on <code>crates/red_knot_python_semantic/src/module_resolver/path.rs</code>:68 on 2024-09-06 07:20</div>
            <div class="timeline-body"><p>The intention was to differentiate from <code>packages</code> which are also technically modules.
But I also think <code>resolve_file_module</code> is better (and achieves the same thing), thanks for the suggestion!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Slyces">@Slyces</a> reviewed on 2024-09-06 09:10</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/Slyces">@Slyces</a> on <code>crates/red_knot_python_semantic/src/module_resolver/path.rs</code>:68 on 2024-09-06 09:10</div>
            <div class="timeline-body"><p>Hi @MichaReiser, I&#x27;ve applied your comments:</p>
<ul>
<li>I keep a method is_file_module in the ModulePath to use in the resolve_package method
(I think this fits the pattern of available methods)</li>
<li>I moved the method resolve_file_module to resolve.rs</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from &quot;[red-knot] resolve source/stubs over namespace packages, fixes #12278&quot; to &quot;[red-knot] resolve source/stubs over namespace packages&quot; by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-09-06 09:14</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_python_semantic/src/module_resolver/resolver.rs</code>:645 on 2024-09-06 09:16</div>
            <div class="timeline-body"><p>I would remove <code>is_file_module</code> because <code>is_file_module</code> and <code>resolve_file_module</code> are now the same code except for the return type</p>
<pre><code>            &amp;&amp; resolve_file_mdoule(package_path, resolver_state).is_none()
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-09-06 09:17</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-09-06 09:22</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/module_resolver/path.rs</code>:69 on 2024-09-06 09:22</div>
            <div class="timeline-body"><p>I think I would call this method something like <code>with_any_python_extension()</code>, and have it return <code>Option&lt;File&gt;</code>. Callers of the method from <code>resolver.rs</code> that just need to know whether the path exists on disk with a Python extension can then just do <code>path.with_any_python_extensions(resolver).is_some()</code>, and we&#x27;ll be able to remove the <code>resolve_file_module()</code> function from <code>resolver.rs</code> (because this will then do the same thing as that function):</p>
<pre><code>    /// If `self` exists on disk with either a `.pyi` or `.py` extension,
    /// return the [`File`] corresponding to that path.
    ///
    /// `.pyi` files take priority, as they always have priority when
    /// resolving modules.
    #[must_use]
    pub(super) fn with_any_python_extension(&amp;self, resolver: &amp;ResolverContext) -&gt; Option&lt;File&gt; {
        self.with_pyi_extension().to_file(resolver).or_else(|| {
            self
                .with_py_extension()
                .and_then(|path| path.to_file(resolver))
            })
    }
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-09-06 09:23</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/module_resolver/path.rs</code>:69 on 2024-09-06 09:23</div>
            <div class="timeline-body"><p>oh, I think you addressed this moments before I commented :-)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Slyces">@Slyces</a> reviewed on 2024-09-06 09:25</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/Slyces">@Slyces</a> on <code>crates/red_knot_python_semantic/src/module_resolver/path.rs</code>:69 on 2024-09-06 09:25</div>
            <div class="timeline-body"><p>So I think the method exists, right now it&#x27;s named <code>is_file_module</code>, but I can agree on any name :)
It&#x27;s also been moved to <code>resolve.rs</code> under MichaReiser&#x27;s comments that it didn&#x27;t really match existing methods in <code>ModulePath</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-09-06 09:26</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/module_resolver/path.rs</code>:69 on 2024-09-06 09:26</div>
            <div class="timeline-body"><p>Yup, I agree that it doesn&#x27;t really belong in <code>path.rs</code>, <code>resolver.rs</code> is better!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Slyces">@Slyces</a> reviewed on 2024-09-06 09:28</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/Slyces">@Slyces</a> on <code>crates/red_knot_python_semantic/src/module_resolver/path.rs</code>:69 on 2024-09-06 09:28</div>
            <div class="timeline-body"><p>I&#x27;ll add the docstring though, I think it helps :)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-09-06 09:35</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/module_resolver/resolver.rs</code>:584 on 2024-09-06 09:35</div>
            <div class="timeline-body"><p>This logic can be simplified slightly if we make the <code>ModulePath::join()</code> function in <code>path.rs</code> public (it already exists, but it&#x27;s currently a test-only private function). Something like this should work (the diff is relative to your PR branch):</p>
<pre><code>diff --git a/crates/red_knot_python_semantic/src/module_resolver/path.rs b/crates/red_knot_python_semantic/src/module_resolver/path.rs
index a49d1dc20..76c00b1c2 100644
--- a/crates/red_knot_python_semantic/src/module_resolver/path.rs
+++ b/crates/red_knot_python_semantic/src/module_resolver/path.rs
@@ -59,6 +59,13 @@ impl ModulePath {
         self.relative_path.push(component);
     }
 
+    #[must_use]
+    pub(crate) fn join(&amp;self, component: &amp;str) -&gt; ModulePath {
+        let mut result = self.clone();
+        result.push(component);
+        result
+    }
+
     #[must_use]
     pub(super) fn is_directory(&amp;self, resolver: &amp;ResolverContext) -&gt; bool {
         let ModulePath {
@@ -634,15 +641,6 @@ mod tests {
 
     use super::*;
 
-    impl ModulePath {
-        #[must_use]
-        fn join(&amp;self, component: &amp;str) -&gt; ModulePath {
-            let mut result = self.clone();
-            result.push(component);
-            result
-        }
-    }
-
     impl SearchPath {
         fn join(&amp;self, component: &amp;str) -&gt; ModulePath {
             self.to_module_path().join(component)
diff --git a/crates/red_knot_python_semantic/src/module_resolver/resolver.rs b/crates/red_knot_python_semantic/src/module_resolver/resolver.rs
index 50aaf9dbd..294ad477d 100644
--- a/crates/red_knot_python_semantic/src/module_resolver/resolver.rs
+++ b/crates/red_knot_python_semantic/src/module_resolver/resolver.rs
@@ -569,18 +569,13 @@ fn resolve_name(db: &amp;dyn Db, name: &amp;ModuleName) -&gt; Option&lt;(SearchPath, File, Mod
 
                 package_path.push(module_name);
 
-                // Try to resolve a stub/module with the current name
-                let file_module = resolve_file_module(&amp;package_path, &amp;resolver_state);
-
-                // Then check if a regular package exists with the same name (it takes
-                // precedence)
-                package_path.push(&quot;__init__&quot;);
-                if let Some(regular_package) = resolve_file_module(&amp;package_path, &amp;resolver_state) {
+                // Regular packages take first priority:
+                if let Some(regular_package) = resolve_file_module(&amp;package_path.join(&quot;__init__&quot;), &amp;resolver_state) {
                     return Some((search_path.clone(), regular_package, ModuleKind::Package));
                 }
 
-                // If we found a module (but no package), return it
-                if let Some(module) = file_module {
+                // If there&#x27;s a single-file module (but no package), return it
+                if let Some(module) = resolve_file_module(&amp;package_path, &amp;resolver_state) {
                     return Some((search_path.clone(), module, ModuleKind::Module));
                 }
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-09-06 09:44</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_python_semantic/src/module_resolver/resolver.rs</code>:584 on 2024-09-06 09:44</div>
            <div class="timeline-body"><p>The reason for using <code>push</code> is because it avoids allocating a new path.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-09-06 09:50</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/module_resolver/resolver.rs</code>:584 on 2024-09-06 09:50</div>
            <div class="timeline-body"><p>My main point is that if the path resolves to a regular package, we&#x27;re doing an unnecessary <code>resolve_file_module()</code> call. I doubt it matters much in terms of performance but I think it could be written slightly more clearly. If we want to avoid allocating, we could add a <code>.pop()</code> method:</p>
<pre><code>--- a/crates/red_knot_python_semantic/src/module_resolver/path.rs
+++ b/crates/red_knot_python_semantic/src/module_resolver/path.rs
@@ -59,6 +59,10 @@ impl ModulePath {
         self.relative_path.push(component);
     }
 
+    pub(crate) fn pop(&amp;mut self) -&gt; bool {
+        self.relative_path.pop()
+    }
+
     #[must_use]
     pub(super) fn is_directory(&amp;self, resolver: &amp;ResolverContext) -&gt; bool {
         let ModulePath {
diff --git a/crates/red_knot_python_semantic/src/module_resolver/resolver.rs b/crates/red_knot_python_semantic/src/module_resolver/resolver.rs
index 68f08118e..c563d0b80 100644
--- a/crates/red_knot_python_semantic/src/module_resolver/resolver.rs
+++ b/crates/red_knot_python_semantic/src/module_resolver/resolver.rs
@@ -569,9 +569,6 @@ fn resolve_name(db: &amp;dyn Db, name: &amp;ModuleName) -&gt; Option&lt;(SearchPath, File, Mod
 
                 package_path.push(module_name);
 
-                // Try to resolve a stub/module with the current name
-                let file_module = resolve_file_module(&amp;package_path, &amp;resolver_state);
-
                 // Then check if a regular package exists with the same name (it takes
                 // precedence)
                 package_path.push(&quot;__init__&quot;);
@@ -579,8 +576,9 @@ fn resolve_name(db: &amp;dyn Db, name: &amp;ModuleName) -&gt; Option&lt;(SearchPath, File, Mod
                     return Some((search_path.clone(), regular_package, ModuleKind::Package));
                 }
 
-                // If we found a module (but no package), return it
-                if let Some(module) = file_module {
+                // If we can find a module (but no package), return it
+                package_path.pop();
+                if let Some(module) = resolve_file_module(&amp;package_path, &amp;resolver_state) {
                     return Some((search_path.clone(), module, ModuleKind::Module));
                 }
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Slyces">@Slyces</a> reviewed on 2024-09-06 10:10</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/Slyces">@Slyces</a> on <code>crates/red_knot_python_semantic/src/module_resolver/resolver.rs</code>:584 on 2024-09-06 10:10</div>
            <div class="timeline-body"><p>I think I find either options (<code>join</code> or <code>pop</code>) clearer than the existing implementation</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> approved on 2024-09-06 10:40</div>
            <div class="timeline-body"><p>Looks great. Thanks, this was an excellent contribution @Slyces! :D</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-09-06 11:14</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-09-06 11:14</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:06:36 UTC
    </footer>
</body>
</html>
