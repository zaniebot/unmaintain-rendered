<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pyupgrade: Format specifiers - astral-sh/ruff #1594</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Pyupgrade: Format specifiers</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/1594">#1594</a>
        opened by <a href="https://github.com/colin99d">@colin99d</a>
        on 2023-01-03 12:09
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/colin99d">@colin99d</a> on 2023-01-03 12:09</div>
            <div class="timeline-body"><p>A part of #827. Posting this for visibility. Still has some work to do to be done.</p>
<p>Things that still need done before this is ready:</p>
<ul>
<li>[x] Does not work when the item is being assigned to a variable</li>
<li>[x] Does not work if being used in a function call</li>
<li>[x] Fix incorrectly removed calls in the function</li>
<li>[x] Has not been tested with pyupgrade negative test cases</li>
</ul>
<p>Tests from pyupgrade can be seen here: https://github.com/asottile/pyupgrade/blob/main/tests/features/format_literals_test.py</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/colin99d">@colin99d</a> on 2023-01-04 12:47</div>
            <div class="timeline-body"><p>I will try to have this done by Sunday night.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-01-05 02:10</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>src/pyupgrade/plugins/format_specififiers.rs</code>:17 on 2023-01-05 02:10</div>
            <div class="timeline-body"><p>We use <code>Lazy</code> for this, you can grep for some other usages of <code>Regex</code> to see an example :)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/colin99d">@colin99d</a> reviewed on 2023-01-05 02:11</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/colin99d">@colin99d</a> on <code>src/pyupgrade/plugins/format_specififiers.rs</code>:17 on 2023-01-05 02:11</div>
            <div class="timeline-body"><p>That was FAST. But thanks.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/colin99d">@colin99d</a> on 2023-01-06 22:19</div>
            <div class="timeline-body"><p>@charliermarsh I have the following function to detect expressions:</p>
<pre><code>pub fn match_expression(expression_text: &amp;str) -&gt; Result&lt;Expression&gt; {
    match libcst_native::parse_expression(expression_text) {
        Ok(expression) =&gt; Ok(expression),
        Err(_) =&gt; bail!(&quot;Failed to extract CST from source&quot;),
    }
}
</code></pre>
<p>It works fine for an expression like this:</p>
<pre><code>    'foo{0}' 'bar{1}'.format(1, 2)
</code></pre>
<p>But the second you make it multi-line like so:</p>
<pre><code>    'foo{0}'\n    'bar{1}'.format(1, 2)
</code></pre>
<p>The whole thing fails. Is this an error with my coding, or an error with libcst_native?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-01-06 22:39</div>
            <div class="timeline-body"><p>I'm wondering if you need to dedent the code. You might be passing <code>LibCST</code> the indented expression, which would cause an error.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/colin99d">@colin99d</a> on 2023-01-06 22:50</div>
            <div class="timeline-body"><p>It looks like the issue still happens with the de-indented code: 'foo{0}'\n'bar{1}'.format(1, 2).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/colin99d">@colin99d</a> on 2023-01-07 03:58</div>
            <div class="timeline-body"><p>thread 'main' panicked at 'called <code>Result::unwrap()</code> on an <code>Err</code> value: ParserError(ParseError { location: ParseLoc { start_pos: LineCol { line: 2, column: 4, offset: 13 }, end_pos: LineCol { line: 2, column: 12, offset: 21 } }, expected: ExpectedSet { expected: {&quot;EOF&quot;} } }, &quot;'foo{0}'\n    'bar{1}'.format(1, 2)&quot;)', src/pyupgrade/plugins/format_specififiers.rs:57:57</p>
<p>Looks like this is a parse error from the <code>parse_expression</code> function in libcst_native. My thoughts are we either:</p>
<ol>
<li>Make a custom patch in your fork</li>
<li>Find a way to modify the string to add a <code>\</code> at the end of each line so the parser can understand it, and then remove it once we are done</li>
<li>Don't use libcst_native ( I dont like this one because I like libcst now)</li>
</ol>
<p>Just let me know which you would like for me to pursue.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-01-07 23:11</div>
            <div class="timeline-body"><p>Would you be open to filing an issue on the LibCST repo? In the meantime, we could just skip those cases. (Are they needed for detection, or just autofixing?)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/colin99d">@colin99d</a> on 2023-01-08 23:54</div>
            <div class="timeline-body"><p>Here is the issue:
https://github.com/Instagram/LibCST/issues/846
I will just make it a check for now!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>src/pyupgrade/plugins/format_specififiers.rs</code>:159 on 2023-01-09 01:04</div>
            <div class="timeline-body"><p>Thank you and sorry that this all churned mid-PR for you.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-01-09 01:05</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/colin99d">@colin99d</a> reviewed on 2023-01-09 01:32</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/colin99d">@colin99d</a> on <code>src/pyupgrade/plugins/format_specififiers.rs</code>:159 on 2023-01-09 01:32</div>
            <div class="timeline-body"><p>Im never going to complain about you making this project easier to contribute to.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/colin99d">@colin99d</a> on 2023-01-09 03:07</div>
            <div class="timeline-body"><p>Hey @charliermarsh I got all the positive test cases working (except for the one edge case we talked about), and all the negative cases working except one. I wanted to get your feedback before I implemented it.
The following edge case is what causes issues:</p>
<pre><code>'{' '0}'.format(1)
</code></pre>
<p>Since the format specifier is split into two different strings, it is NOT supposed to be formatted. However, both the Expr
struct, and the tokens automatically combine this into one string. What would be the best way of detecting that this edge case is preset? Or do we want to ignore it? Since the refactoring would produce changes that could be seen as desirable:
<img width="530" alt="Screenshot 2023-01-08 at 10 07 52 PM" src="https://user-images.githubusercontent.com/72827203/211235188-239290c0-2283-40cb-80fb-9aab0eabdcc3.png"></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-01-09 06:13</div>
            <div class="timeline-body"><p>I think it's best just to ignore it (i.e., treat it as if there is no space). It strikes me as exceptionally rare, to the point that it's likely either a mistake <em>or</em> that it's not worth adding more complexity to our own implementation to handle it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-01-09 06:13</div>
            <div class="timeline-body"><p>We could <em>probably</em> detect it by tokenizing... but it doesn't seem worth it to me.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/colin99d">@colin99d</a> on 2023-01-09 12:14</div>
            <div class="timeline-body"><blockquote>
<p>I think it's best just to ignore it (i.e., treat it as if there is no space). It strikes me as exceptionally rare, to the point that it's likely either a mistake <em>or</em> that it's not worth adding more complexity to our own implementation to handle it.</p>
</blockquote>
<p>100% agree, especially since the python code will still work.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/colin99d">@colin99d</a> on 2023-01-09 12:25</div>
            <div class="timeline-body"><p>I just need to fix one bug with this edge case, and then I should be able to take this PR out of draft.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @colin99d on 2023-01-09 15:59</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/colin99d">@colin99d</a> on 2023-01-10 21:35</div>
            <div class="timeline-body"><p>@charliermarsh anything else you want to see from this for merge?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-01-10 21:50</div>
            <div class="timeline-body"><p>@colin99d - Will review this tonight!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-01-11 00:18</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>src/pyupgrade/rules/format_specifiers.rs</code>:97 on 2023-01-11 00:18</div>
            <div class="timeline-body"><p>When does this happen?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-01-11 00:35</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>src/pyupgrade/rules/format_specifiers.rs</code>:97 on 2023-01-11 00:35</div>
            <div class="timeline-body"><p>Ah nevermind.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-01-11 01:18</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>src/pyupgrade/rules/format_literals.rs</code>:85 on 2023-01-11 01:18</div>
            <div class="timeline-body"><p>@colin99d - It turns out that we already had a utility for extracting the format positions, which uses the RustPython string parser underneath and so is very robust. Sorry that I didn't flag this earlier -- I didn't realize it could even be reused here, but it should make things more efficient too since we can do one string parse and share that &quot;summary&quot; amongst a bunch of checks.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>src/pyupgrade/rules/format_literals.rs</code>:114 on 2023-01-11 01:19</div>
            <div class="timeline-body"><p>I feel like one strategy that could work here would be...</p>
<ul>
<li>Take the entire text.</li>
<li>Replace the string part via the regex above.</li>
<li>Replace the arguments via LibCST.</li>
</ul>
<p>Kinda tough, hacky, etc... but would solve the missing cases.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-01-11 01:19</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-01-11 01:20</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>src/pyupgrade/rules/format_literals.rs</code>:114 on 2023-01-11 01:20</div>
            <div class="timeline-body"><p>Actually, I guess that wouldn't solve the <code>'{' '0}'.format(1)</code> case.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @charliermarsh on 2023-01-11 01:21</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2023-01-11 01:21</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/colin99d">@colin99d</a> on 2023-01-11 01:50</div>
            <div class="timeline-body"><p>Thanks for the review!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2023-01-11 01:50</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 05:38:31 UTC
    </footer>
</body>
</html>
