<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[WIP] Editing around comments - astral-sh/ruff #14886</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[WIP] Editing around comments</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/pull/14886">#14886</a>
        opened by <a href="https://github.com/dylwil3">@dylwil3</a>
        on 2024-12-10 04:38
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/dylwil3">@dylwil3</a> on 2024-12-10 04:38</div>
            <div class="timeline-body"><p>This is an attempt to introduce some helper functions for making edits without removing comments. The plan is to implement the new helper functions in a number of different rules, and see if the ecosystem check raises any alarms. If the approach starts to look reasonable, I will break this into separate PRs.</p>
<hr />
<p>In case anyone is interested, the rough idea is as follows:</p>
<ol>
<li>First, handle deletions. If you are making a deletion edit in some range <code>[s0, e0]</code> and there are comment ranges in this interval, say <code>[s1,e1], [s2,e2], ..., [sn,en]</code>, then you could instead just delete each of the ranges <code>[s0,s1], [e1,s2], ..., [en,e0]</code>. There is some bookkeeping that needs to be done, however, around newlines and indentation (and probably more things I haven't thought of!), but that is the general idea.</li>
<li>Insertions are already okay.</li>
<li>Any range replacement can be written as a deletion following by an insertion. So use (1) and then insert. The downside of this approach is that it pushes all the comments to the top of the replacement. But it seems like this may be slightly better than deleting them.</li>
</ol>
<p>I think a more sophisticated approach can be developed on top of the above by first creating a diff that breaks up the range replacement into several replacements, and then applies (3) to each piece. But one thing at a time...</p>
<p>Finally, you probably shouldn't look at the implementation details at the moment - the code itself is ugly and probably not performant or memory-conscious, I'm just trying to get something logically correct first and then I'll try to make it pretty.</p>
<p>This may all be terribly misguided... we'll see...</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">do-not-merge</span> added by @dylwil3 on 2024-12-10 04:38</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2024-12-10 04:50</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">fixes</span> added by @AlexWaygood on 2024-12-10 11:02</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-12-10 13:14</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_linter/src/rules/pyupgrade/snapshots/ruff_linter__rules__pyupgrade__tests__UP013.py.snap</code>:279 on 2024-12-10 13:14</div>
            <div class="timeline-body"><p>This is a fantastic improvement, and we shouldn't let the perfect be the enemy of the good, so I'd happily merge a change to our fix infrastructure that preserved comments like this. However... I'd still mark this fix as unsafe if it moved comments like this. It would be very annoying if you e.g. had a TypedDict like this:</p>
<pre><code class="language-py">Config = TypedDict(&quot;Config&quot;, {
    &quot;x&quot;: int,  # this is the x field. It's an int because numbers are great.
    &quot;y&quot;: str,  # this is the y field. It's a string because some things are string.
    &quot;z&quot;: bytes,  # this is the z field. TODO: why is it bytes??
})
</code></pre>
<p>And Ruff then autofixed it to this:</p>
<pre><code class="language-py"># this is the x field. It's an int because numbers are great.
# this is the y field. It's a string because some things are string.
# this is the z field. TODO: why is it bytes??
class Config(TypedDict):
    x: int
    y: str
    z: bytes
</code></pre>
<p>One way to think about it is: would you be happy for Ruff to automatically apply these fixes every time you pressed save in an editor, like you might with an autoformatter?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @dylwil3 on 2025-12-10 18:01</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 16:42:34 UTC
    </footer>
</body>
</html>
