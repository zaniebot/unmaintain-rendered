<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add `B012` and `PYI057` as default rules - astral-sh/ruff #20681</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Add <code>B012</code> and <code>PYI057</code> as default rules</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/pull/20681">#20681</a>
        opened by <a href="https://github.com/ntBre">@ntBre</a>
        on 2025-10-02 14:58
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a></div>
            <div class="timeline-body"><h2>Summary</h2>
<p>@AlexWaygood and I discussed this a bit on <a href="https://discord.com/channels/1039017663004942429/1343691651243315312/1422892554868756552">Discord</a>, and it seemed relevant for the Python 3.14 release next week, so I figured I'd put up a PR.</p>
<p>This adds <a href="https://docs.astral.sh/ruff/rules/jump-statement-in-finally/#jump-statement-in-finally-b012">jump-statement-in-finally (B012)</a> and <a href="https://docs.astral.sh/ruff/rules/byte-string-usage/#byte-string-usage-pyi057">byte-string-usage (PYI057)</a> to the default rule set. <code>B012</code> is especially relevant for Python 3.14 because it will become a <code>SyntaxWarning</code> and may be upgraded to a <code>SyntaxError</code> in the future. <code>PYI057</code>, on the other hand, covers APIs that now won't be removed until 3.17, but Ruff could help to make this more visible to avoid it being pushed back again.</p>
<p>I'm realizing now that I didn't attempt to gate the new defaults based on the target Python version as Alex suggested, but I can look into that if we want. It doesn't immediately seem straightforward to do, based on our current usage of <code>DEFAULT_SELECTORS</code>, though. <code>B012</code> seems serious enough to me always to be enabled, but the nice stdlib replacement for <code>PYI057</code> was only added in Python 3.12.</p>
<h2>Test Plan</h2>
<p>Existing tests, plus a new CLI test with the new rules</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone "v0.14" by @ntBre on 2025-10-02 14:58</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">breaking</span> added by @ntBre on 2025-10-02 14:58</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">rule-selection</span> added by @ntBre on 2025-10-02 14:58</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-10-02 15:05</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>ℹ️ ecosystem check <strong>detected linter changes</strong>. (+1 -0 violations, +0 -0 fixes in 1 projects; 54 projects unchanged)</p>
<details><summary><a href="https://github.com/prefecthq/prefect">prefecthq/prefect</a> (+1 -0 violations, +0 -0 fixes)</summary>
<p>

<pre>
+ <a href='https://github.com/prefecthq/prefect/blob/54d62e660d90f556e7b0f204f15b3b61c8f8cd21/src/integrations/prefect-snowflake/prefect_snowflake/database.py#L799'>src/integrations/prefect-snowflake/prefect_snowflake/database.py:799:17:</a> B012 `return` inside `finally` blocks cause exceptions to be silenced
</pre>

</p>
</details>
<details><summary>Changes by rule (1 rules affected)</summary>
<p>

<p>| code | total | + violation | - violation | + fix | - fix |
| ---- | ------- | --------- | -------- | ----- | ---- |
| B012 | 1 | 1 | 0 | 0 | 0 |</p>
</p>
</details>

<h3>Linter (preview)</h3>
<p>ℹ️ ecosystem check <strong>detected linter changes</strong>. (+1 -0 violations, +0 -0 fixes in 1 projects; 54 projects unchanged)</p>
<details><summary><a href="https://github.com/prefecthq/prefect">prefecthq/prefect</a> (+1 -0 violations, +0 -0 fixes)</summary>
<p>
<pre>ruff check --no-cache --exit-zero --ignore RUF9 --no-fix --output-format concise --preview</pre>
</p>
<p>

<pre>
+ <a href='https://github.com/prefecthq/prefect/blob/54d62e660d90f556e7b0f204f15b3b61c8f8cd21/src/integrations/prefect-snowflake/prefect_snowflake/database.py#L799'>src/integrations/prefect-snowflake/prefect_snowflake/database.py:799:17:</a> B012 `return` inside `finally` blocks cause exceptions to be silenced
</pre>

</p>
</details>
<details><summary>Changes by rule (1 rules affected)</summary>
<p>

<p>| code | total | + violation | - violation | + fix | - fix |
| ---- | ------- | --------- | -------- | ----- | ---- |
| B012 | 1 | 1 | 0 | 0 | 0 |</p>
</p>
</details>

</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-10-02 15:29</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>docs/configuration.md</code>:56 on 2025-10-02 15:29</div>
            <div class="timeline-body"><p>(Use spaces rather than tabs ;)</p>
<pre><code class="language-suggestion">    # Enable Pyflakes (`F`), a subset of the pycodestyle (`E`) codes,
    # and a couple of other codes corresponding to CPython deprecations
    # and syntax warnings by default.
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-10-02 15:33</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>docs/configuration.md</code>:56 on 2025-10-02 15:33</div>
            <div class="timeline-body"><p>Wow how did you see the tabs instead of spaces?? I thought for sure GitHub's suggestion rendering was failing me until I checked locally. Thanks!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-10-02 15:36</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>docs/configuration.md</code>:56 on 2025-10-02 15:36</div>
            <div class="timeline-body"><blockquote>
<p>Wow how did you see the tabs instead of spaces??</p>
</blockquote>
<p>I'll never reveal my secrets ;)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-10-02 15:42</div>
            <div class="timeline-body"><blockquote>
<p><code>B012</code> seems serious enough to me always to be enabled</p>
</blockquote>
<p>agreed; I think this is almost always a mistake, whatever Python version you're using</p>
<blockquote>
<p>but the nice stdlib replacement for <code>PYI057</code> was only added in Python 3.12.</p>
</blockquote>
<p>Hmm, yeah. <em>Ideally</em> I think this would only be enabled by default if your code targets Python 3.12+. But most users can probably use a <code>bytes | bytearray</code> union on lower Python versions instead of an ABC. And if they have typing_extensions as a dependency, they can use the backport of <code>collections.abc.Buffer</code> in typing_extensions too. So I think it <em>should</em> be okay if it's made the default regardless of target Python version.</p>
<p>It might be worth adding some more examples to https://docs.astral.sh/ruff/rules/byte-string-usage/#example for what you can do if you support Python &lt;3.12? (It also seems like there's a typo in https://docs.astral.sh/ruff/rules/byte-string-usage/#why-is-this-bad -- it says <code>Python \&lt;3.12</code> rather than <code>Python &lt;3.12</code>.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-10-02 15:47</div>
            <div class="timeline-body"><p>I'm a bit worried about making our default rules more complicated, especially if the selection becomes dynamic</p>
<blockquote>
<p>I'm realizing now that I didn't attempt to gate the new defaults based on the target Python version as Alex suggested, but I can look into that if we want.</p>
</blockquote>
<p>Could <code>B012</code> become a syntax rule? I guess the main reason why it shouldn't is because there are reasons why someone would want to disable it (on a per-file or per-line basis).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntBre">@ntBre</a> on 2025-10-02 16:01</div>
            <div class="timeline-body"><p>I can definitely expand the examples, I think I already caught the typo but I'll double check that too.</p>
<blockquote>
<p>Could B012 become a syntax rule? I guess the main reason why it shouldn't is because there are reasons why someone would want to disable it (on a per-file or per-line basis).</p>
</blockquote>
<p>It's tempting to make it a semantic syntax error, but it would be a bit more aggressive than CPython itself. The <a href="https://peps.python.org/pep-0765/#emit-syntaxerror-in-cpython">PEP</a> explicitly rejected or at least deferred plans to upgrade the warning to an error.</p>
<p>I know what you mean about expanding the defaults. I'm also happy to split the two rules into separate PRs and/or defer both until a later release after more discussion. I just wanted to have it ready in case we wanted to include these in the 3.14 release next week.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-10-03 09:30</div>
            <div class="timeline-body"><blockquote>
<p>I'm a bit worried about making our default rules more complicated, especially if the selection becomes dynamic</p>
</blockquote>
<p>Yeah, I can see that making the default selection dynamic might be pretty confusing to users. As I said above, I think it's probably okay if PYI057 is enabled by default regardless of Python version. Of the two, I also think there's an even stronger case for enabling B012 by default, as well, so considering the two rules separately might indeed make sense here.</p>
<blockquote>
<p>Could <code>B012</code> become a syntax rule? I guess the main reason why it shouldn't is because there are reasons why someone would want to disable it (on a per-file or per-line basis).</p>
</blockquote>
<p>Yeah, I think it's pretty important that B012 should be suppressible:</p>
<ul>
<li>CPython will still parse and execute the code at runtime (albeit with a warning)</li>
<li>The vast majority of the time, code that uses this pattern isn't working as intended, and there's always a way to rewrite the code in a clearer, more explicit way. But not <em>every</em> instance of this pattern is <em>necessarily</em> a bug; sometimes it might actually be working in the desired way! Even in these instances, I think the lint is beneficial, since you could rewrite the code in a clearer way, but that doesn't mean that it should be unsuppressible.</li>
<li>What if your code has lots of instances of this pattern? I think it would be reasonable to add <code>noqa</code> comments to all occurences (using <code>--add-noqa</code>) as part of the initial PR upgrading your Ruff version, and then slowly remove the <code>noqa</code> comments in followup PRs.</li>
<li>There's no particular reason to make B012 non-suppressible while other rules that cover <code>SyntaxWarning</code>s at runtime (such as <a href="https://docs.astral.sh/ruff/rules/is-literal/">F632</a>) are still suppressible.</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-10-03 10:23</div>
            <div class="timeline-body"><p>It makes me wonder if we should have a single rule that flags any syntax warnings in your code (maybe dependent on python version).</p>
<p>But that is a separate discussion</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-10-03 10:31</div>
            <div class="timeline-body"><p>yeah, I do agree that we should try to ensure that we catch all pattenrs that CPython flags at compile-time with <code>SyntaxWarning</code>s, that rules which flag syntax warnings such as <code>B012</code> and <code>F632</code> should probably all be enabled by default, and that these rules should probably all be in a common category. It's definitely a similar problem to the syntax-errors project, and I've chatted with @ntBre about it before. But, I also agree that this is a separate, broader discussion.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dylwil3">@dylwil3</a> on 2025-10-03 12:48</div>
            <div class="timeline-body"><blockquote>
<p>It makes me wonder if we should have a single rule that flags any syntax warnings in your code (maybe dependent on python version).</p>
</blockquote>
<p>see https://github.com/astral-sh/ruff/issues/20196</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntBre">@ntBre</a> on 2025-10-03 18:19</div>
            <div class="timeline-body"><p>It sounds like we may want to hold off on this for now and take a more general approach to syntax warnings, which sounds good to me. I think we can still call out these rules in the release post without enabling them by default and hopefully still help with the deprecation.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @ntBre on 2025-10-07 16:23</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:16:10 UTC
    </footer>
</body>
</html>
