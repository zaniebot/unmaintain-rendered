<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Use accumulator for diagnostics - astral-sh/ruff #14116</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Use accumulator for diagnostics</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/pull/14116">#14116</a>
        opened by <a href="https://github.com/MichaReiser">@MichaReiser</a>
        on 2024-11-05 19:31
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a></div>
            <div class="timeline-body"><h2>Summary</h2>
<p>Use a Salsa accumulator for diagnostics to avoid double-emitting diagnostics for unpack assignments.</p>
<p>We now use a single <code>CompileDiagnostic</code> accumulator that stores all diagnostics. That includes IO errors, parse errors, and type check errors. I decided that we're beyond where <code>String</code> annotations are fun. That's why I introduced a <code>Diagnostic</code> trait with 5 implementations:</p>
<ul>
<li><code>ParseDiagnostic</code> for parse errors</li>
<li><code>SourceTextDiagnostic</code> for IO errors</li>
<li><code>TypeCheckDiagnostic</code> for type inference errors</li>
<li><code>RevealedTypeDiagnostic</code> for <code>reveal_type</code> (info severity)</li>
<li><code>CompileDiagnostic</code> which is a cheap cloneable <em>any</em> diagnostic wrapper that implements salsa accumulator.</li>
</ul>
<p>Using a structured diagnostic has the advantage of no longer needing manual parsing in the LSP.</p>
<p>A nice side effect of this is that mdtests now support tests with syntax errors because parse-errors are just another diagnostic :)</p>
<h2>Performance regression</h2>
<p>I expect this to hit performance pretty bad, especially the incremental benchmark. The problem is that there's currently no way to run an accumulator concurrently. That's why I had to resort to a hack where we run type checking in parallel, and then collect the diagnostics. This has the downside that Salsa first runs all queries (in parallel) but then has to iterate over all of them again to collect the diagnostics (even if there are none!). The queries are all cached, but it is still expensive because the query dependency tree is somewhat large.</p>
<p>This overhead is especially noticeable in the cache case. We'll need https://github.com/salsa-rs/salsa/pull/568 to do the accumulation and checking in one go.</p>
<h2>Test Plan</h2>
<p><code>cargo test</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-11-05 19:32</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:40 on 2024-11-05 19:32</div>
            <div class="timeline-body"><p>This has to be a salsa query so that the mdtest framework can get the diagnostics (accumulator require a query)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-11-05 19:34</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_server/src/edit/range.rs</code>:1 on 2024-11-05 19:34</div>
            <div class="timeline-body"><p>All the code here is copied over from <code>ruff_server</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-11-05 19:36</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_db/src/parsed.rs</code>:45 on 2024-11-05 19:36</div>
            <div class="timeline-body"><p>TODO</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/codspeed-hq[bot]">@codspeed-hq[bot]</a> on 2024-11-05 19:37</div>
            <div class="timeline-body"><h2><a href="https://codspeed.io/astral-sh/ruff/branches/micha/accumulator-diagnostics">CodSpeed Performance Report</a></h2>
<h3>Merging #14116 will <strong>degrade performances by 32.2%</strong></h3>
<p><sub>Comparing <code>micha/accumulator-diagnostics</code> (371e5fc) with <code>main</code> (4ece8e5)</sub></p>
<h3>Summary</h3>
<p><code>❌ 1</code> regressions
<code>✅ 31</code> untouched benchmarks</p>
<blockquote>
<p>:warning: <em>Please fix the performance issues or <a href="https://codspeed.io/astral-sh/ruff/branches/micha/accumulator-diagnostics">acknowledge them on CodSpeed</a>.</em></p>
</blockquote>
<h3>Benchmarks breakdown</h3>
<p>|     | Benchmark | <code>main</code> | <code>micha/accumulator-diagnostics</code> | Change |
| --- | --------- | ----------------------- | ------------------- | ------ |
| ❌ | <code>red_knot_check_file[incremental]</code> | 4.2 ms | 6.3 ms | -32.2% |</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @MichaReiser on 2024-11-05 19:51</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @MichaReiser on 2024-11-05 19:51</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @AlexWaygood by @MichaReiser on 2024-11-05 19:51</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @sharkdp by @MichaReiser on 2024-11-05 19:51</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by @MichaReiser on 2024-11-05 19:52</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2024-11-05 20:10</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Formatter (stable)</h3>
<p>✅ ecosystem check detected no format changes.</p>
<h3>Formatter (preview)</h3>
<p>✅ ecosystem check detected no format changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/ruff_db/src/diagnostic.rs</code>:2 on 2024-11-05 22:26</div>
            <div class="timeline-body"><p>What is the benefit of the <code>as _</code> here? It seems to be just as happy for me locally without it.</p>
<pre><code class="language-suggestion">use salsa::Accumulator;
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:5457 on 2024-11-05 22:36</div>
            <div class="timeline-body"><p>oh, great catch! I think now that the accidental syntax error is fixed here, it would now be trivial to port this to an mdtest.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_test/src/lib.rs</code>:89 on 2024-11-05 22:38</div>
            <div class="timeline-body"><pre><code class="language-suggestion">                // The accumulator returns all diagnostics from all files. We're only interested in
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_db/src/diagnostic.rs</code>:57 on 2024-11-05 22:52</div>
            <div class="timeline-body"><p>What's the benefit of implementing these methods in the <code>impl</code> block here, and then again in the trait <code>impl</code> directly below? Couldn't we just inline these definitions in the trait <code>impl</code>? I remember you telling me off for doing something like this back in https://github.com/astral-sh/ruff/pull/11564#discussion_r1615996481 ;)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_workspace/src/workspace.rs</code>:232 on 2024-11-05 22:56</div>
            <div class="timeline-body"><p>I find the formatting here makes it quite hard to read. Just importing <code>TextRange</code> into the namespace would make it much more readable, in my opinion:</p>
<pre><code class="language-diff">--- a/crates/red_knot_workspace/src/workspace.rs
+++ b/crates/red_knot_workspace/src/workspace.rs
@@ -14,6 +14,7 @@ use ruff_db::{
     system::{walk_directory::WalkState, SystemPath, SystemPathBuf},
 };
 use ruff_python_ast::{name::Name, PySourceType};
+use ruff_text_size::TextRange;
 
 use crate::db::Db;
 use crate::db::RootDatabase;
@@ -215,11 +216,8 @@ impl Workspace {
         workspace_diagnostics.sort_unstable_by(|a, b| {
             a.file().cmp(&amp;b.file()).then_with(|| {
                 a.range()
-                    .map_or(TextSize::default(), ruff_text_size::TextRange::start)
-                    .cmp(
-                        &amp;b.range()
-                            .map_or(TextSize::default(), ruff_text_size::TextRange::start),
-                    )
+                    .map_or(TextSize::default(), TextRange::start)
+                    .cmp(&amp;b.range().map_or(TextSize::default(), TextRange::start))
             })
         });
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_benchmark/benches/red_knot.rs</code>:29 on 2024-11-05 22:58</div>
            <div class="timeline-body"><p>nit: could we have a space in between &quot;error&quot; and the code in square brackets? e.g.</p>
<pre><code class="language-suggestion">    &quot;error [possibly-unresolved-reference] /src/tomllib/_parser.py:66:18 Name `s` used when possibly not defined&quot;,
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-11-05 22:59</div>
            <div class="timeline-body"><p>Just a few comments from skimming. I'll try to look at this more in-depth tomorrow!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_test/src/lib.rs</code>:90 on 2024-11-05 23:21</div>
            <div class="timeline-body"><p>Should we be doing a workspace check once and then splitting the diagnostics by file, instead of re-doing the check for each file and filtering the diagnostics?</p>
<p>Doesn't need to be done in this PR, regardless. And maybe tests are small enough that it really doesn't matter.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_test/src/diagnostic.rs</code>:6 on 2024-11-05 23:25</div>
            <div class="timeline-body"><p>It's not a problem, but I'm curious why we stopped using the <code>Ranged</code> trait here; the reason isn't obvious to me.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> approved on 2024-11-05 23:39</div>
            <div class="timeline-body"><p>Looks great to me, thank you! I think this is definitely an improvement in terms of reliable handling of diagnostics (to avoid duplicating or accidentally missing them); hopefully parallel-db brings back most of the regression.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-11-06 07:06</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_db/src/diagnostic.rs</code>:2 on 2024-11-06 07:06</div>
            <div class="timeline-body"><p>Both work, for as long as there's no other type named <code>Accumulator</code>. Using <code>as _</code> imports that type &quot;unnamed&quot;. You can't reference the type itself. That's often sufficient for traits because all that is needed is to bring the trait into the scope to call that trait's functions.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-11-06 07:06</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_benchmark/benches/red_knot.rs</code>:29 on 2024-11-06 07:06</div>
            <div class="timeline-body"><p>I prefer the non-space version. Otherwise there are too many free-floating parts</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-11-06 07:18</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_test/src/diagnostic.rs</code>:6 on 2024-11-06 07:18</div>
            <div class="timeline-body"><p>Oh, I should have reverted that change. It's because <code>Diagnostic</code> returns <code>Option&lt;TextRange&gt;</code> which wasn't compatible. Anyway, I went ahead and deleted the <code>mdtest</code> Diagnostic and replaced it with <code>Diagnostic</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-11-06 07:21</div>
            <div class="timeline-body"><p>I just noticed that we can now support invalid-syntax in mdtests. I ported the exception handler with invalid syntax test case to demonstrate it</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_test/src/lib.rs</code>:90 on 2024-11-06 07:25</div>
            <div class="timeline-body"><p>The method to check all files is defined in <code>red_knot_workspace</code> on which this crate doesn't depend. It also requires creating a workspace, which is currently somewhat awkward and it does concurrent checking, which we don't want. That's why I think the current approach is still the right approach for testing</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-11-06 07:25</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-11-06 07:38</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_db/src/diagnostic.rs</code>:57 on 2024-11-06 07:38</div>
            <div class="timeline-body"><p>I've to be careful with you. You never forget lol....</p>
<p>I don't have a good answer. I was mainly annoyed that I had to bring the <code>Diagnostic</code> trait into scope everywhere were I sued the <code>CompileDiagnostic</code>. Looking at it now, it's exactly two places where this avoids importing the trait. I think it's fine to remove this for now</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-11-06 09:04</div>
            <div class="timeline-body"><p>I don't think this is the way to go. The problem is that salsa's accumulator are <code>O(tree)</code> and not <code>O(changes)</code> which introduces a significant cost. They are very convenient but I'm concerned about the incremental performance in very large mono repository...</p>
<p>I have a fix specific for unpacking and I'll look into extracting some of the improvements I made in this PR but I'm more convinced now that accumulators, as they are today, are not a good fit with our very deeply nested queries.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @MichaReiser on 2024-11-06 09:04</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:07:29 UTC
    </footer>
</body>
</html>
