<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[`pyupgrade`] Handle multiple base classes for PEP 695 generics (`UP046`) - astral-sh/ruff #15659</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[<code>pyupgrade</code>] Handle multiple base classes for PEP 695 generics (<code>UP046</code>)</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/15659">#15659</a>
        opened by <a href="https://github.com/ntBre">@ntBre</a>
        on 2025-01-21 23:17
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/ntBre">@ntBre</a> on 2025-01-21 23:17</div>
            <div class="timeline-body"><h2>Summary</h2>
<p>Addresses the second follow up to #15565 in #15642. This was easier than expected by using this cool destructuring syntax I hadn't used before, and by assuming <a href="https://docs.astral.sh/ruff/rules/generic-not-last-base-class/">PYI059</a> (<code>generic-not-last-base-class</code>).</p>
<h2>Test Plan</h2>
<p>Using an existing test, plus two new tests combining multiple base classes and multiple generics. It looks like I deleted a relevant test, which I did, but I meant to rename this in #15565. It looks like instead I copied it and renamed the copy.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">rule</span> added by @ntBre on 2025-01-21 23:19</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-01-21 23:26</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>âœ… ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>âœ… ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">preview</span> added by @AlexWaygood on 2025-01-22 18:04</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @ntBre on 2025-01-22 18:38</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-01-22 18:42</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/pyupgrade/rules/pep695/non_pep695_generic_class.rs</code>:208 on 2025-01-22 18:42</div>
            <div class="timeline-body"><p>I guess this could also be a single <code>Edit::replacement</code> if we concatenate <code>type_params.to_string()</code> and <code>base_classes</code> first. Would that be preferable?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @AlexWaygood by @ntBre on 2025-01-22 18:42</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_linter/resources/test/fixtures/pyupgrade/UP046_0.py</code>:1 on 2025-01-22 18:46</div>
            <div class="timeline-body"><p>A couple more tests you could add:</p>
<pre><code class="language-py">from typing import TypeVar, Generic

T = TypeVar(&quot;T&quot;)
S = TypeVar(&quot;S&quot;)

class A(Generic[T]): ...
class B(A[S], Generic[S]): ...
class C(A[S], Generic[S, T]): ...
class D(A[int], Generic[T]): ...
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_linter/src/rules/pyupgrade/rules/pep695/non_pep695_generic_class.rs</code>:125 on 2025-01-22 18:50</div>
            <div class="timeline-body"><pre><code class="language-suggestion">    // (generic-not-last-base-class). If it comes elsewhere, it results in a runtime error.
    // In stubs it's not *strictly* necessary for `Generic` to come last in the bases tuple,
    // but it would cause more complication for us to handle stubs specially,
    // and probably isn't worth the bother.
</code></pre>
<p>Could we also add a test for the case where <code>Generic</code> isn't last in the bases tuple? I'm particularly interested in whether we issue a diagnostic for classes where <code>Generic</code> is not last in the bases tuple. For classes like that, I think we should probably issue a diagnostic, but not a fix...?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_linter/src/rules/pyupgrade/rules/pep695/non_pep695_generic_class.rs</code>:185 on 2025-01-22 18:50</div>
            <div class="timeline-body"><pre><code class="language-suggestion">        if base_classes.is_empty() {
            // this means that `Generic[]` was the only base class;
            // we just replace the whole bases tuple with the type parameters
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_linter/src/rules/pyupgrade/rules/pep695/non_pep695_generic_class.rs</code>:210 on 2025-01-22 18:53</div>
            <div class="timeline-body"><p>hmm... could this be simplified if we used this helper? https://github.com/astral-sh/ruff/blob/d981bf5f4bec7e78cf8ff6efd749ac9dfb4eb0a0/crates/ruff_linter/src/fix/edits.rs#L201-L257 ?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> approved on 2025-01-22 18:53</div>
            <div class="timeline-body"><p>Nice!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/resources/test/fixtures/pyupgrade/UP046_0.py</code>:1 on 2025-01-22 19:03</div>
            <div class="timeline-body"><p>Oh interesting, I thought these would be invalid for inheriting from <code>Generic</code> multiple times, but they seem to work fine. They all move the <code>Generic</code>s to type parameters and keep the other base class. Is that right?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-01-22 19:03</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-01-22 19:04</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_linter/resources/test/fixtures/pyupgrade/UP046_0.py</code>:1 on 2025-01-22 19:04</div>
            <div class="timeline-body"><blockquote>
<p>They all move the <code>Generic</code>s to type parameters and keep the other base class. Is that right?</p>
</blockquote>
<p>yup, that's the correct behaviour!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_linter/resources/test/fixtures/pyupgrade/UP046_0.py</code>:1 on 2025-01-22 19:09</div>
            <div class="timeline-body"><blockquote>
<p>Oh interesting, I thought these would be invalid for inheriting from <code>Generic</code> multiple times, but they seem to work fine.</p>
</blockquote>
<p>yeah, this is fine. It's a mechanism you can use to partially specialize a base class, or to add more type parameters on top of those that exist on a base class, or do both at once!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-01-22 19:09</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/pyupgrade/rules/pep695/non_pep695_generic_class.rs</code>:125 on 2025-01-22 19:23</div>
            <div class="timeline-body"><p>Ah, I was hoping we could add something like <code>tail_classes @ ..</code> to the end of the slice and magically handle <code>Generic</code> not being at the end, but you can only do <code>..</code> once in a slice pattern. We currently bail out too early to give a diagnostic here, but I'll try to fix that!</p>
<p>Would it be bad to offer a fix anyway? I think most of the effort will go into finding <code>Generic</code>; the fix logic should be mostly the same, if not identical.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-01-22 19:23</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-01-22 19:26</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_linter/src/rules/pyupgrade/rules/pep695/non_pep695_generic_class.rs</code>:125 on 2025-01-22 19:26</div>
            <div class="timeline-body"><blockquote>
<p>Would it be bad to offer a fix anyway?</p>
</blockquote>
<p>I think so, because this is a stylistic rule, but if we offered a fix when <code>Generic</code> is in the middle of the bases list we'd be changing the behaviour of the program :/ we'd be turning broken code into code that would no longer raise an exception.</p>
<p>Now, that might be something that users would thank us for, of course ðŸ˜„ but it still doesn't feel like something a <em>stylistic</em> rule should be doing. If this rule's primary purpose was to complain about <em>possibly incorrect</em> code, that would be a different question.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-01-22 20:12</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/pyupgrade/rules/pep695/non_pep695_generic_class.rs</code>:210 on 2025-01-22 20:12</div>
            <div class="timeline-body"><p>Nice, very helpful!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-01-22 20:22</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/pyupgrade/rules/pep695/non_pep695_generic_class.rs</code>:216 on 2025-01-22 20:22</div>
            <div class="timeline-body"><p>I just realized that neither this nor the destructuring version account for the possibility of multiple <code>Generic</code> arguments. They either grab the first (in this case) or last (when destructuring). Do we need to <code>filter_map</code> here and <code>collect</code> to check that the length is 1? Or is it safe to assume there's only one?</p>
<p>Before this PR there had to be a single <code>Generic</code> because there had to be a single base class total.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-01-22 20:42</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_linter/src/rules/pyupgrade/rules/pep695/non_pep695_generic_class.rs</code>:216 on 2025-01-22 20:42</div>
            <div class="timeline-body"><p>Oh, great catch! You're quite right -- this is another case where we should probably issue a diagnostic but not attempt a fix, since a class with multiple <code>Generic[]</code>s in the bases tuple will fail at runtime.</p>
<p>I think it should be possible to detect that without <code>collect</code>ing though -- collecting can be surprisingly expensive, as it involves allocating memory on the heap. Something like this?</p>
<pre><code class="language-rs">let mut generic_bases_iter = &lt;something involving filter_map&gt;;

let Some(first_generic) = generic_bases_iter.next() else {
    return;
}

if generic_bases_iter.is_some() {
    // multiple `Generic[]`s in the bases tuple -- invalid!
    return;
}
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-01-22 21:00</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/pyupgrade/rules/pep695/non_pep695_generic_class.rs</code>:216 on 2025-01-22 21:00</div>
            <div class="timeline-body"><p>I think I had a second realization in the meantime :laughing: Since we're now <code>find</code>ing the first one, there will be more base classes after it, causing us to bail out with a diagnostic at the index check! So I don't think we need any more code, but I will add a test confirming this.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_linter/src/rules/pyupgrade/rules/pep695/non_pep695_generic_class.rs</code>:227 on 2025-01-22 21:35</div>
            <div class="timeline-body"><p>A few nitpicks here, but none of these are major:</p>
<ul>
<li>The <code>as_ref()</code> call isn't necessary -- you can call <code>.iter()</code> on a <code>&amp;Box&lt;[Expr]&gt;</code> expression just like a <code>&amp;[Expr]</code> expression (<code>&amp;Box&lt;[Expr]&gt;</code> dereferences to <code>&amp;[Expr]</code>)</li>
<li>I would just have the function take an argument of type <code>&amp;SemanticModel</code> rather than <code>&amp;mut Checker</code> -- we only need the semantic model here, and it's a much less &quot;heavy&quot; dependency for this helper function than the <code>Checker</code></li>
<li>I'd call the first parameter to the function <code>class_bases</code> or <code>bases_tuple</code> rather than <code>arguments</code> -- it has type <code>&amp;Arguments</code>, but what the parameter <em>represents</em> is the class's bases tuple</li>
</ul>
<p>Put together, that implies the following changes:</p>
<details>
<summary>Suggested patch</summary>

<pre><code class="language-diff">--- a/crates/ruff_linter/src/rules/pyupgrade/rules/pep695/non_pep695_generic_class.rs
+++ b/crates/ruff_linter/src/rules/pyupgrade/rules/pep695/non_pep695_generic_class.rs
@@ -3,6 +3,7 @@ use ruff_macros::{derive_message_formats, ViolationMetadata};
 use ruff_python_ast::visitor::Visitor;
 use ruff_python_ast::ExprSubscript;
 use ruff_python_ast::{Arguments, StmtClassDef};
+use ruff_python_semantic::SemanticModel;
 use ruff_text_size::Ranged;
 
 use crate::checkers::ast::Checker;
@@ -124,7 +125,7 @@ pub(crate) fn non_pep695_generic_class(checker: &amp;mut Checker, class_def: &amp;StmtCl
     };
 
     let Some((generic_idx, generic_expr @ ExprSubscript { slice, range, .. })) =
-        find_generic(arguments, checker)
+        find_generic(arguments, checker.semantic())
     else {
         return;
     };
@@ -206,22 +207,16 @@ pub(crate) fn non_pep695_generic_class(checker: &amp;mut Checker, class_def: &amp;StmtCl
 }
 
 /// Search `arguments` for a `typing.Generic` base class. Returns the `Generic` expression (if any),
-/// along with its index in `arguments`.
+/// along with its index in the class's bases tuple.
 fn find_generic&lt;'a&gt;(
-    arguments: &amp;'a Arguments,
-    checker: &amp;mut Checker,
+    class_bases: &amp;'a Arguments,
+    semantic: &amp;SemanticModel,
 ) -&gt; Option&lt;(usize, &amp;'a ExprSubscript)&gt; {
-    arguments
-        .args
-        .as_ref()
-        .iter()
-        .enumerate()
-        .find_map(|(idx, expr)| {
-            expr.as_subscript_expr().and_then(|sub_expr| {
-                checker
-                    .semantic()
-                    .match_typing_expr(&amp;sub_expr.value, &quot;Generic&quot;)
-                    .then_some((idx, sub_expr))
-            })
+    class_bases.args.iter().enumerate().find_map(|(idx, expr)| {
+        expr.as_subscript_expr().and_then(|sub_expr| {
+            semantic
+                .match_typing_expr(&amp;sub_expr.value, &quot;Generic&quot;)
+                .then_some((idx, sub_expr))
         })
+    })
 }
</code></pre>
</details>

</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_linter/src/rules/pyupgrade/rules/pep695/non_pep695_generic_class.rs</code>:202 on 2025-01-22 21:39</div>
            <div class="timeline-body"><p>We have a <code>try_set_fix()</code> method that's handy for cases like this!</p>
<pre><code class="language-suggestion">        diagnostic.try_set_fix(|| {
            let removal_edit = remove_argument(
                generic_expr,
                arguments,
                Parentheses::Remove,
                checker.source(),
            )?;
            Ok(Fix::unsafe_edits(
                Edit::insertion(type_params.to_string(), name.end()),
                [removal_edit],
            ))
        });
</code></pre>
<p>The advantage is that if you run Ruff with enough <code>-v</code> flags, it prints a useful error message to the terminal explaining why it was unable to provide a fix for the specific case where <code>remove_argument()</code> returned an error</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> approved on 2025-01-22 21:39</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-01-22 22:55</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/pyupgrade/rules/pep695/non_pep695_generic_class.rs</code>:227 on 2025-01-22 22:55</div>
            <div class="timeline-body"><p>Ah thanks, this looks a lot better!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-01-22 23:02</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/pyupgrade/rules/pep695/non_pep695_generic_class.rs</code>:202 on 2025-01-22 23:02</div>
            <div class="timeline-body"><p>That is very handy! I was wondering how <code>remove_argument</code> could fail at all, so I'll be glad to see those messages if it does!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_linter/src/rules/pyupgrade/rules/pep695/non_pep695_generic_class.rs</code>:5 on 2025-01-22 23:04</div>
            <div class="timeline-body"><pre><code class="language-suggestion">use ruff_python_ast::{Arguments, ExprSubscript, StmtClassDef};
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> approved on 2025-01-22 23:05</div>
            <div class="timeline-body"><p>ðŸš¢ it!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @ntBre on 2025-01-23 01:19</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @ntBre on 2025-01-23 01:19</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-01-23 01:19</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 20:06:11 UTC
    </footer>
</body>
</html>
