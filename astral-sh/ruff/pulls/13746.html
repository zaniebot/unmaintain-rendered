<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[red-knot] feat: Inference for `BytesLiteral` comparisons - astral-sh/ruff #13746</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[red-knot] feat: Inference for <code>BytesLiteral</code> comparisons</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/13746">#13746</a>
        opened by <a href="https://github.com/sharkdp">@sharkdp</a>
        on 2024-10-14 10:23
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a></div>
            <div class="timeline-body">

Summary
<p>Implements inference for <code>BytesLiteral</code> comparisons along the lines of <a href="https://github.com/astral-sh/ruff/pull/13634">astral-sh/ruff#13634</a>. A refactoring that unifies some code with what we do for <code>StringLiteral</code> (and possibly other cases, see also #13712) is planned for a later PR.</p>
<p>closes #13687</p>
Test Plan
<p>Added tests using the new Markdown framework. I added the tests in <code>mdtest/comparison/byte_literals.md</code>, following the convention proposed in <a href="https://github.com/astral-sh/ruff/pull/13712#discussion_r1797197213">this comment</a>. This is somewhat in conflict with the proposed structure in #13719 which puts the <code>StringLiteral</code> tests under <code>mdtest/boolean.md</code>, so this will have to be sorted out after we agreed on a naming/grouping convention for these tests.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by <a href="https://github.com/sharkdp">@sharkdp</a> on 2024-10-14 10:23</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/carljm">@carljm</a> by <a href="https://github.com/sharkdp">@sharkdp</a> on 2024-10-14 10:23</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/MichaReiser">@MichaReiser</a> by <a href="https://github.com/sharkdp">@sharkdp</a> on 2024-10-14 10:23</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/AlexWaygood">@AlexWaygood</a> by <a href="https://github.com/sharkdp">@sharkdp</a> on 2024-10-14 10:23</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2024-10-14 10:36</div>
            <div class="timeline-body">

<code>ruff-ecosystem</code> results
Linter (stable)
<p>‚úÖ ecosystem check detected no linter changes.</p>
Linter (preview)
<p>‚úÖ ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/resources/mdtest/comparison/byte_literals.md</code>:1 on 2024-10-14 10:39</div>
            <div class="timeline-body"><p>nit: it would be nice to have maybe a sentence of documentation here that explains what the purpose of theses tests is. Even though for this file in particular it&#x27;s kind of self-evident, I think it&#x27;s useful to establish a convention here:</p>
<pre><code>### Comparison: Byte literals

These tests assert that we infer precise `Literal` types for comparisons between objects
inferred as having `Literal` bytes types:
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> approved on 2024-10-14 10:39</div>
            <div class="timeline-body"><p>Nice!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-10-14 10:40</div>
            <div class="timeline-body"><blockquote>
<p>‚ÑπÔ∏è ecosystem check <strong>detected linter changes</strong>. (+0 -1693 violations, +0 -0 fixes in 5 projects; 49 projects unchanged)</p>
</blockquote>
<p>Um, you can ignore that. It reports some spurious results sometimes when a PR branch is a bit behind <code>main</code> (we should probably fix it at some point üòÑ)</p>
<p>There&#x27;s no way this PR could have caused any of those changes, so it can be safely disregarded here!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/T-256">@T-256</a> reviewed on 2024-10-14 11:15</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/T-256">@T-256</a> on <code>crates/red_knot_python_semantic/resources/mdtest/comparison/byte_literals.md</code>:8 on 2024-10-14 11:15</div>
            <div class="timeline-body"><p>Does it work without <code>reveal_type</code>?</p>
<pre><code>b&quot;abc&quot; == b&quot;abc&quot;  # revealed: Literal[True]
b&quot;abc&quot; == b&quot;ab&quot;   # revealed: Literal[False]
</code></pre>
<p>Is comment aligning part of mdtest&#x27;s design guide? (is it allowed or preferred?)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-10-14 11:19</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/resources/mdtest/comparison/byte_literals.md</code>:8 on 2024-10-14 11:19</div>
            <div class="timeline-body"><blockquote>
<p>Does it work without <code>reveal_type</code>?</p>
</blockquote>
<p>no, the <code>reveal_type</code> call is necessary to trigger a &quot;Revealed&quot; assertion when using <code>mdtest</code>-based tests. This is documented <a href="https://github.com/astral-sh/ruff/tree/main/crates/red_knot_test#assertions">here</a>.</p>
<blockquote>
<p>Is comment aligning part of mdtest&#x27;s design guide? (is it allowed or preferred?)</p>
</blockquote>
<p>The comment alignment seems fine to me. At some point maybe we might start running our <code>scripts/check_docs_formatted.py</code> CI script on our <code>mdtest</code> test files. But until we do that, or introduce autoformatting of these Python snippets some other way, I don&#x27;t think we should be too picky about the formatting of the Python snippets in our test files.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/sharkdp">@sharkdp</a> on 2024-10-14 12:01</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/sharkdp">@sharkdp</a> on 2024-10-14 12:01</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-10-14 12:01</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_python_semantic/resources/mdtest/comparison/byte_literals.md</code>:8 on 2024-10-14 12:12</div>
            <div class="timeline-body"><p>This is probably something we have to align on. I recommend to not rely on comment alignment because it&#x27;s something that will break if we ever decide to format our example code using ruff (which I think would be a nice addition).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-10-14 12:12</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:2675 on 2024-10-14 12:14</div>
            <div class="timeline-body"><p>Nit: You could have used <code>&amp;**salsa_b1.value(self.db)</code> to aovid the <code>as_ref</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:2664 on 2024-10-14 12:18</div>
            <div class="timeline-body"><p>Nit: We could consider using https://docs.rs/memchr/latest/memchr/memmem/fn.find.html</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-10-14 12:18</div>
            <div class="timeline-body"><p>This is great! I&#x27;ve only two nits. Up to you if you want to follow up on them or not.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2024-10-14 12:44</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:2664 on 2024-10-14 12:44</div>
            <div class="timeline-body"><p>Yes, thanks. Did a grep for <code>memmem</code> , didn&#x27;t find anything, and wasn&#x27;t sure if it warranted adding a new dependency. Should have looked for <code>memchr</code>.</p>
<p>==&gt; #13750</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2024-10-14 18:26</div>
            <div class="timeline-body"><p>This is excellent, thank you!!</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:07:25 UTC
    </footer>
</body>
</html>
