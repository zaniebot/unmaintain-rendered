<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add BestFittingMode - astral-sh/ruff #5184</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Add BestFittingMode</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/5184">#5184</a>
        opened by <a href="https://github.com/MichaReiser">@MichaReiser</a>
        on 2023-06-19 15:52
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a></div>
            <div class="timeline-body">Summary
<p>Black supports for layouts when it comes to breaking binary expressions:</p>
<pre><code>#[derive(Copy, Clone, Debug, Eq, PartialEq)]
enum BinaryLayout {
    /// Put each operand on their own line if either side expands
    Default,

    /// Try to expand the left to make it fit. Add parentheses if the left or right don&#x27;t fit.
    ///
    ///```python
    /// [
    ///     a,
    ///     b
    /// ] &amp; c
    ///```
    ExpandLeft,

    /// Try to expand the right to make it fix. Add parentheses if the left or right don&#x27;t fit.
    ///
    /// ```python
    /// a &amp; [
    ///     b,
    ///     c
    /// ]
    /// ```
    ExpandRight,

    /// Both the left and right side can be expanded. Try in the following order:
    /// * expand the right side
    /// * expand the left side
    /// * expand both sides
    ///
    /// to make the expression fit
    ///
    /// ```python
    /// [
    ///     a,
    ///     b
    /// ] &amp; [
    ///     c,
    ///     d
    /// ]
    /// ```
    ExpandRightThenLeft,
}
</code></pre>
<p>Our current implementation only handles <code>ExpandRight</code> and <code>Default</code> correctly. <code>ExpandLeft</code> turns out to be surprisingly hard. This PR adds a new <code>BestFittingMode</code> parameter to <code>BestFitting</code> to support <code>ExpandLeft</code>.</p>
<p>There are 3 variants that <code>ExpandLeft</code> must support:</p>
<p><strong>Variant 1</strong>: Everything fits on the line (easy)</p>
<pre><code>[a, b] + c
</code></pre>
<p><strong>Variant 2</strong>: Left breaks, but right fits on the line. Doesn&#x27;t need parentheses</p>
<pre><code>[
	a,
	b
] + c
</code></pre>
<p><strong>Variant 3</strong>: The left breaks, but there&#x27;s still not enough space for the right hand side. Parenthesize the whole expression:</p>
<pre><code>(
	[
		a, 
		b
	]
	+ ccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccc
)
</code></pre>
<p>Solving Variant 1 and 2 on their own is straightforward The printer gives us this behavior by nesting right inside of the group of left:</p>
<pre><code>group(&amp;format_args![
	if_group_breaks(&amp;text(&quot;(&quot;)),
	soft_block_indent(&amp;group(&amp;format_args![
		left, 
		soft_line_break_or_space(), 
		op, 
		space(), 
		group(&amp;right)
	])),
	if_group_breaks(&amp;text(&quot;)&quot;))
])
</code></pre>
<p>The fundamental problem is that the outer group, which adds the parentheses, always breaks if the left side breaks. That means, we end up with</p>
<pre><code>(
	[
		a,
		b
	] + c
)
</code></pre>
<p>which is not what we want (we only want parentheses if the right side doesn&#x27;t fit).</p>
<p>Okay, so nesting groups don&#x27;t work because of the outer parentheses. Sequencing groups doesn&#x27;t work because it results in a right-to-left breaking which is the opposite of what we want.</p>
<p>Could we use best fitting? Almost!</p>
<pre><code>best_fitting![
	// All flat
	format_args![left, space(), op, space(), right],
	// Break left
	format_args!(group(&amp;left).should_expand(true), space(), op, space(), right],
	// Break all
	format_args![
		text(&quot;(&quot;), 
		block_indent!(&amp;format_args![
			left, 
			hard_line_break(), 
			op,
			space()
			right
		])
	]
]
</code></pre>
<p>I hope I managed to write this up correctly. The problem is that the printer never reaches the 3rd variant because the second variant always fits:</p>
<ul>
<li>The <code>group(&amp;left).should_expand(true)</code> changes the group so that all <code>soft_line_breaks</code> are turned into hard line breaks. This is necessary because we want to test if the content fits if we break after the <code>[</code>.</li>
<li>Now, the whole idea of <code>best_fitting</code> is that you can pretend that some content fits on the line when it actually does not. The way this works is that the printer <strong>only</strong> tests if all the content of the variant <strong>up to</strong> the first line break fits on the line (we insert that line break by using <code>should_expand(true))</code>. The printer doesn&#x27;t care whether the rest <code>a\n, b\n ] + c</code> all fits on (multiple?) lines.</li>
</ul>
<p>Why does breaking right work but not breaking the left? The difference is that we can make the decision whether to parenthesis the expression based on the left expression. We can&#x27;t do this for breaking left because the decision whether to insert parentheses or not would depend on a lookahead: will the right side break. We simply don&#x27;t know this yet when printing the parentheses (it would work for the right parentheses but not for the left and indent).</p>
<p>What we kind of want here is to tell the printer: Look, what comes here may or may not fit on a single line but we don&#x27;t care. Simply test that what comes <strong>after</strong> fits on a line.</p>
<p>This PR adds a new <code>BestFittingMode</code> that has a new <code>AllLines</code> option that gives us the desired behavior of testing all content and not just up to the first line break.</p>
Test Plan
<p>I added a new example to  <code>BestFitting::with_mode</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-06-19 15:52</div>
            <div class="timeline-body"><p>Current dependencies on/for this PR:</p>
<ul>
<li>main<ul>
<li><strong>PR #5184</strong> <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/5184"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite"></a>  ðŸ‘ˆ<ul>
<li><strong>PR #5205</strong> <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/5205"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite"></a><ul>
<li><strong>PR #4985</strong> <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/4985"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite"></a><ul>
<li><strong>PR #5207</strong> <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/5207"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite"></a><ul>
<li><strong>PR #4986</strong> <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/4986"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite"></a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>This comment was auto-generated by <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/5184?utm_source=stack-comment">Graphite</a>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/konstin">@konstin</a> by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-06-19 15:53</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">formatter</span> added by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-06-19 15:53</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from &quot;Add BeestFittingMode&quot; to &quot;Add BestFittingMode&quot; by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-06-19 15:56</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2023-06-19 16:04</div>
            <div class="timeline-body">PR Check Results
Ecosystem
<p>âœ… ecosystem check detected no changes.</p>
Benchmark
Linux
<pre><code>group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.00      7.6Â±0.01ms     5.3 MB/sec    1.00      7.6Â±0.01ms     5.4 MB/sec
formatter/numpy/ctypeslib.py               1.00   1586.0Â±1.64Âµs    10.5 MB/sec    1.00   1587.6Â±4.07Âµs    10.5 MB/sec
formatter/numpy/globals.py                 1.01    152.9Â±0.28Âµs    19.3 MB/sec    1.00    152.0Â±1.21Âµs    19.4 MB/sec
formatter/pydantic/types.py                1.01      3.1Â±0.01ms     8.2 MB/sec    1.00      3.1Â±0.01ms     8.2 MB/sec
linter/all-rules/large/dataset.py          1.00     15.8Â±0.07ms     2.6 MB/sec    1.04     16.5Â±0.06ms     2.5 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      3.9Â±0.01ms     4.2 MB/sec    1.02      4.0Â±0.01ms     4.2 MB/sec
linter/all-rules/numpy/globals.py          1.01    513.9Â±0.96Âµs     5.7 MB/sec    1.00    507.5Â±1.10Âµs     5.8 MB/sec
linter/all-rules/pydantic/types.py         1.01      7.0Â±0.04ms     3.6 MB/sec    1.00      7.0Â±0.02ms     3.6 MB/sec
linter/default-rules/large/dataset.py      1.00      7.9Â±0.02ms     5.1 MB/sec    1.07      8.5Â±0.37ms     4.8 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00   1747.5Â±6.62Âµs     9.5 MB/sec    1.04   1814.8Â±5.56Âµs     9.2 MB/sec
linter/default-rules/numpy/globals.py      1.00    199.8Â±0.47Âµs    14.8 MB/sec    1.02    204.7Â±6.16Âµs    14.4 MB/sec
linter/default-rules/pydantic/types.py     1.00      3.7Â±0.01ms     7.0 MB/sec    1.03      3.8Â±0.01ms     6.8 MB/sec
</code></pre>
Windows
<pre><code>group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.00      7.7Â±0.12ms     5.3 MB/sec    1.05      8.1Â±0.07ms     5.0 MB/sec
formatter/numpy/ctypeslib.py               1.00  1570.8Â±29.13Âµs    10.6 MB/sec    1.04  1634.8Â±31.98Âµs    10.2 MB/sec
formatter/numpy/globals.py                 1.00    155.0Â±3.34Âµs    19.0 MB/sec    1.02    157.8Â±5.36Âµs    18.7 MB/sec
formatter/pydantic/types.py                1.00      3.1Â±0.05ms     8.2 MB/sec    1.06      3.3Â±0.04ms     7.8 MB/sec
linter/all-rules/large/dataset.py          1.01     16.3Â±0.25ms     2.5 MB/sec    1.00     16.2Â±0.19ms     2.5 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      4.1Â±0.05ms     4.1 MB/sec    1.01      4.1Â±0.05ms     4.1 MB/sec
linter/all-rules/numpy/globals.py          1.00    503.7Â±6.96Âµs     5.9 MB/sec    1.00   501.6Â±14.14Âµs     5.9 MB/sec
linter/all-rules/pydantic/types.py         1.00      7.0Â±0.10ms     3.7 MB/sec    1.01      7.0Â±0.10ms     3.6 MB/sec
linter/default-rules/large/dataset.py      1.00      8.1Â±0.11ms     5.0 MB/sec    1.07      8.6Â±0.08ms     4.7 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00  1746.5Â±34.44Âµs     9.5 MB/sec    1.02  1789.8Â±25.17Âµs     9.3 MB/sec
linter/default-rules/numpy/globals.py      1.00    202.4Â±4.58Âµs    14.6 MB/sec    1.00    202.0Â±5.22Âµs    14.6 MB/sec
linter/default-rules/pydantic/types.py     1.00      3.7Â±0.04ms     6.9 MB/sec    1.04      3.8Â±0.06ms     6.6 MB/sec
</code></pre>


</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-06-19 16:06</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> approved on 2023-06-20 15:58</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-06-20 16:15</div>
            <div class="timeline-body"><p>@MichaReiser started a stack merge that includes this pull request via <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/5184">Graphite</a>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-06-20 16:16</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-06-20 16:16</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2023-06-20 16:16</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-06-20 16:16</div>
            <div class="timeline-body"><p>@MichaReiser merged this pull request with <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/5184">Graphite</a>.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 18:54:38 UTC
    </footer>
</body>
</html>
