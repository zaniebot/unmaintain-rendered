<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[red-knot] Pure instance variables declared in class body - astral-sh/ruff #15515</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[red-knot] Pure instance variables declared in class body</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/15515">#15515</a>
        opened by <a href="https://github.com/sharkdp">@sharkdp</a>
        on 2025-01-15 21:48
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-01-15 21:48</div>
            <div class="timeline-body"><h2>Summary</h2>
<p>This is a small, tentative step towards the bigger goal of understanding instance attributes. I could imagine that this might <em>not</em> be desirable as a (mergeable) first iteration, as it could potentially turn some <code>@Todo(instance attributes)</code> types into concrete types that are not correct. For example, we currently turn the <em>instance</em> attribute access to a <code>variable: ClassVar[str]</code> into <code>str</code> without raising any diagnostic (though I'm not sure if <code>Unknown</code> would be better here than <code>str</code>). So I'm also fine with keeping this open until <code>ClassVar</code> support is also implemented.</p>
<p>What the PR currently does is the following:</p>
<ul>
<li>Adds partial support for pure instance variables declared in the class body, i.e. this case:<pre><code class="language-py">class C:
    variable1: str = &quot;a&quot;
    variable2 = &quot;b&quot;

reveal_type(C().variable1)  # str
reveal_type(C().variable2)  # Unknown | Literal[&quot;b&quot;]
</code></pre>
</li>
<li>Adds <code>property</code> as a known class to query for <code>@property</code> decorators</li>
<li>Splits up various <code>@Todo(instance attributes)</code> cases into sub-categories.</li>
</ul>
<h2>Test Plan</h2>
<p>Modified existing MD tests.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by @sharkdp on 2025-01-15 21:48</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-01-15 21:57</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @sharkdp on 2025-01-16 21:51</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @sharkdp on 2025-01-16 21:51</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @sharkdp on 2025-01-16 21:51</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @AlexWaygood by @sharkdp on 2025-01-16 21:51</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-01-16 21:53</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/red_knot_python_semantic/resources/mdtest/attributes.md</code>:175 on 2025-01-16 21:53</div>
            <div class="timeline-body"><p>This is another case that was arguably better before with the <code>@Todo</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-01-16 21:53</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/red_knot_python_semantic/resources/mdtest/attributes.md</code>:257 on 2025-01-16 21:53</div>
            <div class="timeline-body"><p>Is it correct that we want <code>Unknown | Literal[1]</code> for the instance attribute access, but `Literal[1] for the class variable access? (above)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-01-16 21:56</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/red_knot_python_semantic/resources/mdtest/attributes.md</code>:465 on 2025-01-16 21:56</div>
            <div class="timeline-body"><p>https://github.com/python/typeshed/blob/2a461a2f7931dd58df8346aca626f5bc048e8455/stdlib/builtins.pyi#L243-L246</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/resources/mdtest/attributes.md</code>:257 on 2025-01-16 23:18</div>
            <div class="timeline-body"><p>No, I think we should probably add the union with <code>Unknown</code> for class attributes also; the same principles apply. (Though perhaps less strongly in practice, since mutation of class attributes is much less common -- but pyright and mypy both allow it, and we should too since it's allowed at runtime.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/resources/mdtest/attributes.md</code>:175 on 2025-01-16 23:21</div>
            <div class="timeline-body"><p>This is just because we don't yet support inferring the type when we encounter a bare-ClassVar annotation? That seems pretty easy to fix, so I'm not worried about this.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:2308 on 2025-01-16 23:23</div>
            <div class="timeline-body"><p>This should be a TODO, no?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> approved on 2025-01-16 23:29</div>
            <div class="timeline-body"><p>Looks good! I don't see a problem with landing this as-is.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2025-01-17 08:03</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-01-17 09:26</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/red_knot_python_semantic/resources/mdtest/attributes.md</code>:257 on 2025-01-17 09:26</div>
            <div class="timeline-body"><p>Ok, I added an additional test with a TODO for this case.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:2308 on 2025-01-17 09:27</div>
            <div class="timeline-body"><p>Not exactly sure what you meant by that comment, but I added the following TODO comment:</p>
<pre><code class="language-rs">// TODO: A bare `ClassVar` should rather be treated as if the symbol was not
// declared at all.
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-01-17 09:27</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @sharkdp on 2025-01-17 09:48</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @sharkdp on 2025-01-17 09:48</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-01-17 09:48</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:4028 on 2025-01-17 12:21</div>
            <div class="timeline-body"><p>I'm really hopeful that we can keep our special-casing of properties to a minimum if we have a solid implementation of the descriptor protocol, since they really are just descriptor instances at the end of the day. But this seems fine for now, since properties are by far the most common descriptors around, and this improves our TODO messages, making it clear why we infer bad types for various <code>@property</code> attributes for the time being</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-01-17 12:22</div>
            <div class="timeline-body"><p>Very nice!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2025-01-17 18:00</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:2308 on 2025-01-17 18:00</div>
            <div class="timeline-body"><p>Sorry, I should have spelled out what (in my mind) the TODO is. I don't think the added comment is quite right, because a bare <code>ClassVar</code> is not equivalent to &quot;not annotated&quot;. It means &quot;this attribute is a pure ClassVar (that is, not settable on instances) but its declared type must be inferred from the RHS and unioned with Unknown.&quot; The latter part of this is equivalent to &quot;not annotated&quot; but the former part is not.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 20:34:30 UTC
    </footer>
</body>
</html>
