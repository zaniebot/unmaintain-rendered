<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add new rule to check for useless quote escapes - astral-sh/ruff #8630</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Add new rule to check for useless quote escapes</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/8630">#8630</a>
        opened by <a href="https://github.com/ThiefMaster">@ThiefMaster</a>
        on 2023-11-12 16:48
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ThiefMaster">@ThiefMaster</a></div>
            <div class="timeline-body"><p>When using the autofixer for <code>Q000</code> it does not remove the backslashes from quotes that no longer need escaping.
This new rule checks for such backslashes (regardless whether they come from the autofixer or not) and can remove them.</p>
<p>I used <code>Q100</code> to avoid ocnflicts with <code>Q00x</code> rules <code>flake8-quotes</code> might add (even though it&#x27;s not very actively maintained)</p>
<p>fixes #8617</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ThiefMaster">@ThiefMaster</a> on <code>crates/ruff_linter/src/rules/flake8_quotes/rules/avoidable_escaped_quote.rs</code>:81 on 2023-11-12 16:48</div>
            <div class="timeline-body"><p>If you can some up with a better text please change it. As usual, naming is hard...</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ThiefMaster">@ThiefMaster</a> on <code>crates/ruff_linter/src/rules/flake8_quotes/rules/avoidable_escaped_quote.rs</code>:394 on 2023-11-12 16:50</div>
            <div class="timeline-body"><p>Is there a nicer way to pass this list of edits without having to manually consume the first item and pass it separately?</p>
<p>Not sure if Rust has something like Python&#x27;s <code>*args</code> that could be used in <code>Fix::safe_exits(...)</code>...</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ThiefMaster">@ThiefMaster</a> reviewed on 2023-11-12 16:50</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ThiefMaster">@ThiefMaster</a> reviewed on 2023-11-12 17:12</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ThiefMaster">@ThiefMaster</a> on <code>crates/ruff_linter/src/codes.rs</code>:406 on 2023-11-12 17:12</div>
            <div class="timeline-body"><p>Should this rule go into <code>RuleGroup::Preview</code>? One on hand it&#x27;s a new rule, but on the other hand its purpose is fixing a bug in another rule...</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2023-11-12 17:28</div>
            <div class="timeline-body">

<code>ruff-ecosystem</code> results
Linter (stable)
<p>✅ ecosystem check detected no linter changes.</p>
Linter (preview)
<p>ℹ️ ecosystem check <strong>detected linter changes</strong>. (+1 -0 violations, +0 -0 fixes in 41 projects)</p>
<a href="https://github.com/sphinx-doc/sphinx">sphinx-doc/sphinx</a> (+1 -0 violations, +0 -0 fixes)
<p>
<pre>ruff check --no-cache --exit-zero --preview</pre>
</p>
<p>

<pre>
+ <a href="https://github.com/sphinx-doc/sphinx/blob/bb74aec2b6aa1179868d83134013450c9ff9d4d6/tests/test_ext_inheritance_diagram.py#L219">tests/test_ext_inheritance_diagram.py:219:16:</a> Q004 [*] Unnecessary escape on inner quote character
</pre>

</p>

Changes by rule (1 rules affected)
<p>

<p>| code | total | + violation | - violation | + fix | - fix |
| ---- | ------- | --------- | -------- | ----- | ---- |
| Q004 | 1 | 1 | 0 | 0 | 0 |</p>
</p>


Formatter (stable)
<p>✅ ecosystem check detected no format changes.</p>
Formatter (preview)
<p>✅ ecosystem check detected no format changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-11-12 17:44</div>
            <div class="timeline-body"><p>Haven&#x27;t reviewed the code yet, but the ecosystem check seems to be flagging some cases like <code>&quot;\\&#x27;&quot;</code>, in which the backslash escapes <em>are</em> necessary (I think?) to add a backslash literal.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ThiefMaster">@ThiefMaster</a> on 2023-11-12 17:45</div>
            <div class="timeline-body"><p>Yeah, just noticed that I&#x27;m not checking for escaped backslashes - already on it</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-11-12 17:48</div>
            <div class="timeline-body"><p>Awesome, thanks @ThiefMaster!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-11-12 17:49</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_linter/src/codes.rs</code>:406 on 2023-11-12 17:49</div>
            <div class="timeline-body"><p>Yeah, it does need to go in preview -- as part of our <a href="https://docs.astral.sh/ruff/versioning/">versioning policy</a>, we only add new stable rules in minor (not patch) releases.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-11-12 17:50</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_linter/src/codes.rs</code>:406 on 2023-11-12 17:50</div>
            <div class="timeline-body"><p>I know it&#x27;s a bit awkward, but basically, if we implemented this as an improvement in the <code>Q001</code> fix, it would be fine to ship as part of stable. But if we&#x27;re adding a new rule, which can raise new violations, we want to avoid promoting it outside of a minor release.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ThiefMaster">@ThiefMaster</a> reviewed on 2023-11-12 19:11</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ThiefMaster">@ThiefMaster</a> on <code>crates/ruff_linter/src/rules/flake8_quotes/rules/avoidable_escaped_quote.rs</code>:404 on 2023-11-12 19:11</div>
            <div class="timeline-body"><p>This is awfully similar to <code>unescape_string</code>. Probably we could literally call this and check if the strings are identical, instead of having the same logic twice...</p>
<p>The performance here is probably slightly better since it avoids building a new string and bails out as soon as it found an escaped quote, but I&#x27;d be surprised if there was any noticeable difference even on a large project...</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ThiefMaster">@ThiefMaster</a> on 2023-11-12 19:36</div>
            <div class="timeline-body"><p>Ecosystems looks much better now. The one new violation is actually correct since those quotes there should <em>not</em> be escaped.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ThiefMaster">@ThiefMaster</a> on 2023-11-13 13:48</div>
            <div class="timeline-body"><p>The mkdocs CI failure seems unrelated (it didn&#x27;t fail until I rebased to the latest master).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ThiefMaster">@ThiefMaster</a> reviewed on 2023-11-13 21:32</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ThiefMaster">@ThiefMaster</a> on <code>crates/ruff_linter/resources/test/fixtures/flake8_quotes/doubles_escaped_unnecessary.py</code>:1 on 2023-11-13 21:32</div>
            <div class="timeline-body"><p>@charliermarsh you may want to rename the <code>Q100</code> references to <code>Q004</code> in these two files as well ;)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_linter/resources/test/fixtures/flake8_quotes/doubles_escaped_unnecessary.py</code>:1 on 2023-11-13 21:38</div>
            <div class="timeline-body"><p>Thank you!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-11-13 21:38</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-11-13 21:38</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_linter/src/rules/flake8_quotes/rules/avoidable_escaped_quote.rs</code>:394 on 2023-11-13 21:38</div>
            <div class="timeline-body"><p>I did it slightly more manually, but in a way that combines it with the validation condition above (to ensure that we <em>must</em> have at least one edit, and avoid runtime panics).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">rule</span> added by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-11-13 21:39</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> approved on 2023-11-13 21:42</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> approved on 2023-11-13 21:43</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-11-13 21:59</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-11-13 21:59</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2023-11-13 22:02</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 18:59:17 UTC
    </footer>
</body>
</html>
