<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>`ruff server`: Important errors are now shown as popups - astral-sh/ruff #10951</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1><code>ruff server</code>: Important errors are now shown as popups</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/10951">#10951</a>
        opened by <a href="https://github.com/snowsignal">@snowsignal</a>
        on 2024-04-15 10:10
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/snowsignal">@snowsignal</a></div>
            <div class="timeline-body">Summary
<p>Fixes #10866.</p>
<p>Introduces the <code>show_err_msg!</code> macro which will send a message to be shown as a popup to the client via the <code>window/showMessage</code> LSP method.</p>
Test Plan
<p>Insert various <code>show_err_msg!</code> calls in common code paths (for example, at the beginning of <code>event_loop</code>) and confirm that these messages appear in your editor.</p>
<p>To test that panicking works correctly, add this to the top of the <code>fn run</code> definition in <code>crates/ruff_server/src/server/api/requests/execute_command.rs</code>:</p>
<pre><code>panic!(&quot;This should appear&quot;);
</code></pre>
<p>Then, try running a command like <code>Ruff: Format document</code> from the command palette (<code>Ctrl/Cmd+Shift+P</code>). You should see the following messages appear:</p>
<p><img src="https://github.com/astral-sh/ruff/assets/19577865/ae430da6-82c3-4841-a419-664ff34034e8" alt="Screenshot 2024-04-16 at 11 20 57â€¯AM"></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">server</span> added by <a href="https://github.com/snowsignal">@snowsignal</a> on 2024-04-15 10:10</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/MichaReiser">@MichaReiser</a> by <a href="https://github.com/snowsignal">@snowsignal</a> on 2024-04-15 10:11</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-04-15 10:25</div>
            <div class="timeline-body"><p>Having to call both <code>tracing::error</code> and <code>show_err_msg!</code> is a bit verbose but I could see why it is needed. I think my main challenge as a developer would be is to know where I need to use what (not all tracing sides have a <code>show_err_msg</code> call but all <code>show_err_msg</code> calls have a <code>tracing::error</code> call).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2024-04-15 10:25</div>
            <div class="timeline-body">

<code>ruff-ecosystem</code> results
Linter (stable)
<p>âœ… ecosystem check detected no linter changes.</p>
Linter (preview)
<p>âœ… ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-04-15 10:26</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_server/src/message.rs</code>:62 on 2024-04-15 10:26</div>
            <div class="timeline-body"><p>I think it would be valuable to document the macro with when and how to use it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-04-15 10:27</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_server/src/message.rs</code>:7 on 2024-04-15 10:27</div>
            <div class="timeline-body"><p>The once lock is clever. The only downside is that once locks can be tricky when writing tests. Is it difficult to get access to the <code>ClientSender</code>? If not, what do you think of mirroring the <code>write!</code> macro where the first argument is the output stream:</p>
<pre><code>show_message_err!(sender, &quot;My message {var}&quot;)
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_server/src/message.rs</code>:32 on 2024-04-15 10:28</div>
            <div class="timeline-body"><p>Could you extend your test plan to cover the panic hook? Just to make sure that it works.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-04-15 10:28</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_server/src/server/api.rs</code>:58 on 2024-04-15 17:03</div>
            <div class="timeline-body"><p>nit: I&#x27;d remove the &quot;error&quot; part</p>
<pre><code>        show_err_msg!(&quot;Ruff failed to handle a request from the editor. Check the logs for more details.&quot;);
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_server/src/message.rs</code>:58 on 2024-04-15 17:07</div>
            <div class="timeline-body"><p>nit: I&#x27;d probably just use a function instead, I find macros a bit confusing ðŸ˜…</p>
<pre><code>#[inline]
pub(crate) fn show_error_message(message: String) {
	show_message(message, lsp_types::MessageType::ERROR);
}
</code></pre>
<p>Or, does the macro do more than what I&#x27;ve coded above?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2024-04-15 17:08</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-04-15 17:28</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_server/src/message.rs</code>:58 on 2024-04-15 17:28</div>
            <div class="timeline-body"><p>I think the reason for a macro here is because it supports <code>format_args</code> style formatting. The alternative is to use <code>show_error_mesage(format_args!(&quot;my error {error}&quot;))</code> but that&#x27;s a bit verbose.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/snowsignal">@snowsignal</a> reviewed on 2024-04-16 02:10</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/snowsignal">@snowsignal</a> on <code>crates/ruff_server/src/message.rs</code>:7 on 2024-04-16 02:10</div>
            <div class="timeline-body"><p>I don&#x27;t think it&#x27;s worthwhile to make the API more involved just for the purposes of testing. If we do add tests in the future, we can rework <code>show_message</code> to take a reference to a client sender and then test <code>show_message</code> directly with a mock sender.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/snowsignal">@snowsignal</a> reviewed on 2024-04-16 02:12</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/snowsignal">@snowsignal</a> on <code>crates/ruff_server/src/message.rs</code>:58 on 2024-04-16 02:12</div>
            <div class="timeline-body"><p>Right, the goal of the macro was to support formatting like <code>tracing::error!</code> does.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/snowsignal">@snowsignal</a> reviewed on 2024-04-16 02:29</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/snowsignal">@snowsignal</a> on <code>crates/ruff_server/src/message.rs</code>:32 on 2024-04-16 02:29</div>
            <div class="timeline-body"><p>Done!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/MichaReiser">@MichaReiser</a> by <a href="https://github.com/snowsignal">@snowsignal</a> on 2024-04-16 02:29</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/dhruvmanila">@dhruvmanila</a> by <a href="https://github.com/snowsignal">@snowsignal</a> on 2024-04-16 02:29</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> approved on 2024-04-16 05:00</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_server/src/message.rs</code>:26 on 2024-04-16 07:25</div>
            <div class="timeline-body"><p>Nit: I think I would write the panic info to the tracing output from where a user can easily copy the output (and it doesn&#x27;t get truncated). The message here can direct the user to the log and ask them to open an issue on Ruff&#x27;s repository</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_server/src/message.rs</code>:37 on 2024-04-16 07:25</div>
            <div class="timeline-body"><p>Should this use <code>tracing</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2024-04-16 07:27</div>
            <div class="timeline-body"><p>The code looks good.</p>
<p>To me it&#x27;s still unclear when to use <code>show_err_msg</code> and tracing:error and why/when I need to use both</p>
<blockquote>
<p>Having to call both tracing::error and show_err_msg! is a bit verbose but I could see why it is needed. I think my main challenge as a developer would be is to know where I need to use what (not all tracing sides have a show_err_msg call but all show_err_msg calls have a tracing::error call).</p>
</blockquote>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/snowsignal">@snowsignal</a> on 2024-04-16 18:24</div>
            <div class="timeline-body"><blockquote>
<p>To me it&#x27;s still unclear when to use show_err_msg and tracing:error and why/when I need to use both</p>
</blockquote>
<p><code>show_err_msg</code> shows a visible popup in the editor, with a user-friendly message. <code>tracing::error</code> is for logging errors in the <code>Output</code> window, usually in a more verbose and technical message.</p>
<p>Not all errors need to be surfaced to the user as visibly as a popup, which is why only some of the error logs also show a message to the user.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/snowsignal">@snowsignal</a> on 2024-04-16 18:32</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/snowsignal">@snowsignal</a> on 2024-04-16 18:32</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-04-16 18:32</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone &quot;Ruff Server: Beta&quot; by <a href="https://github.com/snowsignal">@snowsignal</a> on 2024-04-16 21:39</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:03:27 UTC
    </footer>
</body>
</html>
