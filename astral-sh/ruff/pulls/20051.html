<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[syntax-errors] Detect `yield from` inside async function - astral-sh/ruff #20051</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[syntax-errors] Detect <code>yield from</code> inside async function</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/20051">#20051</a>
        opened by <a href="https://github.com/11happy">@11happy</a>
        on 2025-08-22 19:39
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/11happy">@11happy</a> on 2025-08-22 19:39</div>
            <div class="timeline-body"><!--
Thank you for contributing to Ruff/ty! To help us out with reviewing, please consider the following:

- Does this pull request include a summary of the change? (See below.)
- Does this pull request include a descriptive title? (Please prefix with `[ty]` for ty pull
  requests.)
- Does this pull request include references to any relevant issues?
-->

<h2>Summary</h2>
<p>This PR implements https://docs.astral.sh/ruff/rules/yield-from-in-async-function/  as a syntax semantic error</p>
<h2>Test Plan</h2>
<!-- How was it tested? -->

<p>I have written a simple inline test as directed in <a href="https://github.com/astral-sh/ruff/issues/17412">https://github.com/astral-sh/ruff/issues/17412</a></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @11happy on 2025-08-22 19:39</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @dhruvmanila by @11happy on 2025-08-22 19:39</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @ntBre by @ntBre on 2025-08-22 19:55</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntBre">@ntBre</a> on 2025-08-22 21:13</div>
            <div class="timeline-body"><p>Thanks for working on this! It looks like there are a few unrelated test failures in the CI results. The inline tests also produce a couple of files that have to be checked in. Let me know if you need help resolving either of those issues!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ty</span> added by @ntBre on 2025-08-22 21:14</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntBre">@ntBre</a> on 2025-08-22 21:15</div>
            <div class="timeline-body"><p>(labeling this as <code>ty</code> since it shouldn't cause any external behavior to change in Ruff but will be a new syntax error detected in ty)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @11happy on 2025-08-23 12:36</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @AlexWaygood by @11happy on 2025-08-23 12:36</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @sharkdp by @11happy on 2025-08-23 12:36</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @dcreager by @11happy on 2025-08-23 12:36</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/11happy">@11happy</a> on 2025-08-23 12:49</div>
            <div class="timeline-body"><p>Have updates to fix the CI, however this test is failing</p>
<pre><code>thread 'valid_syntax' panicked at crates/ruff_python_parser/tests/fixtures.rs:119:9:
&quot;/home/happy/ruff/crates/ruff_python_parser/resources/valid/expressions/arguments.py&quot;: Expected no semantic syntax errors for a valid program:
   |
29 | # Yield expression
30 | call((yield x))
31 | call((yield from x))
   |       ^^^^^^^^^^^^ Syntax Error: `yield from` statement in async function; use `async for` instead
32 |
33 | # Named expression
</code></pre>
<p>file https://github.com/astral-sh/ruff/blob/main/crates/ruff_python_parser/resources/valid/expressions/arguments.py</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> had review dismissed on 2025-08-23 18:04</div>
            <div class="timeline-body"><p>Thanks for the PR!</p>
<p>I fixed the issue in ty's tests (just a pre-existing bug in the test that your PR exposed!), and checked in the snapshot for your new test.</p>
<p>It looks like there are a bunch of changes to existing ruff_python_parser snapshots too, though, and I'm not sure if they're correct. Could you take a look? You can review the changes to the snapshots locally by running <code>cargo test -p ruff_python_parser</code> and then running <code>cargo insta review</code>. <code>cargo insta review</code> will prompt you to take a look at each snapshot change and see whether it looks good or not -- if it does, you can accept the change; if it doesn't, you know you have some more work to do on the PR to fixup the logic somewhere :-)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/11happy">@11happy</a> on 2025-08-24 17:27</div>
            <div class="timeline-body"><p>I have a couple of doubts :</p>
<p>first: while reviewing snapshots I found this</p>
<pre><code>        241 │+1 | x: *int = 1
        242 │+2 | x: yield a = 1
        243 │+3 | x: yield from b = 1
        244 │+  |    ^^^^^^^^^^^^ Syntax Error: `yield from` statement in async function; use `async for` instead
        245 │+4 | x: y := int = 1
</code></pre>
<p>Here this <code>yield from</code>  syntax error should not be there as its not in a async scope its a module level scope ?
for this I looked at the implementation of <code>in_async_context</code>  &amp; I am not perfectly sure how's here the <code>in_async_context</code> is returning true, Am I missing something here?</p>
<pre><code>fn in_async_context(&amp;self) -&gt; bool {
        for scope_info in self.scope_stack.iter().rev() {
            let scope = &amp;self.scopes[scope_info.file_scope_id];
            match scope.kind() {
                ScopeKind::Class | ScopeKind::Lambda =&gt; return false,
                ScopeKind::Function =&gt; {
                    return scope.node().expect_function(self.module).is_async;
                }
                ScopeKind::Comprehension
                | ScopeKind::Module
                | ScopeKind::TypeAlias
                | ScopeKind::TypeParams =&gt; {}
            }
        }
        false
    }
</code></pre>
<p>second: should I commit all the updated snapshots ?</p>
<p>Thank you</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/11happy">@11happy</a> on 2025-08-26 06:47</div>
            <div class="timeline-body"><p>Hii @ntBre,
I’d really appreciate your help in moving this PR forward when you get a chance.
Thank you : )</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntBre">@ntBre</a> on 2025-08-26 12:55</div>
            <div class="timeline-body"><p>I think the test failures are running into a limitation of our inline parser error test suite:</p>
<p>https://github.com/astral-sh/ruff/blob/32cb86351bfadda29a335d6d3aa6bc52585f4bdf/crates/ruff_python_parser/tests/fixtures.rs#L530-L532</p>
<p>You can see there that we've hard-coded <code>true</code> in <code>in_async_context</code>. We do have some handling for scopes, as you can see in the function just above:</p>
<p>https://github.com/astral-sh/ruff/blob/32cb86351bfadda29a335d6d3aa6bc52585f4bdf/crates/ruff_python_parser/tests/fixtures.rs#L534-L541</p>
<p>So I think you'll also need to add a real implementation of <code>in_async_context</code> to avoid the  unrelated test failures. Sorry about that, I guess this is the first rule that needs it. I'm happy to help with this if you run into trouble.</p>
<p>Along these lines, we usually add two other kinds of tests for these errors since they depend on ruff's and ty's implementations of <code>SemanticSyntaxContext</code>. You can see an example in  Ruff:</p>
<p>https://github.com/astral-sh/ruff/blob/32cb86351bfadda29a335d6d3aa6bc52585f4bdf/crates/ruff_linter/src/linter.rs#L1185-L1190</p>
<p>and in ty:</p>
<p>https://github.com/astral-sh/ruff/blob/32cb86351bfadda29a335d6d3aa6bc52585f4bdf/crates/ty_python_semantic/resources/mdtest/diagnostics/semantic_syntax_errors.md?plain=1#L17-L24</p>
<blockquote>
<p>second: should I commit all the updated snapshots ?</p>
</blockquote>
<p>Yes, once you get a set of snapshot failures that look correct, you'll need to commit the updated snapshots to pass the tests in CI.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/11happy">@11happy</a> on 2025-08-28 17:48</div>
            <div class="timeline-body"><p>@ntBre thank you for guiding this PR!</p>
<p>I have updated it accordingly , could you please take a look.
Thank you</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntBre">@ntBre</a> on 2025-08-28 18:14</div>
            <div class="timeline-body"><p>I'll try to take a look soon! It looks like the representation of  AST nodes changed slightly last week (#20028), you might need to rebase/merge main and update your snapshots once more to get CI passing. There's also one small clippy suggestion.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/11happy">@11happy</a> on 2025-08-29 15:43</div>
            <div class="timeline-body"><p>have rebased it, CI should pass now</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/11happy">@11happy</a> on 2025-08-29 16:04</div>
            <div class="timeline-body"><p>Updated the snapshot &amp; fixed the clippy suggestion as per new CI results.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-08-29 16:20</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Formatter (stable)</h3>
<p>✅ ecosystem check detected no format changes.</p>
<h3>Formatter (preview)</h3>
<p>✅ ecosystem check detected no format changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/snapshots/ruff_linter__linter__tests__yield_from_in_async_function.py.snap</code>:1 on 2025-08-29 17:59</div>
            <div class="timeline-body"><p>It looks like we're getting duplicate diagnostics. I think there should be some existing PLE1700 code that we need to delete now that it's being detected and reported as a syntax error:</p>
<p>https://github.com/astral-sh/ruff/blob/9b1b58a4513eae2c3cf206eb5fc3aea19380883c/crates/ruff_linter/src/rules/pylint/rules/yield_from_in_async_function.rs#L40-L42</p>
<p>We should be able to delete this function and any callers.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-08-29 17:59</div>
            <div class="timeline-body"><p>Thanks! This looks great overall, we just need to delete the old rule implementation to avoid duplicate diagnostics.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/11happy">@11happy</a> reviewed on 2025-08-30 06:49</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/11happy">@11happy</a> on <code>crates/ruff_linter/src/snapshots/ruff_linter__linter__tests__yield_from_in_async_function.py.snap</code>:1 on 2025-08-30 06:49</div>
            <div class="timeline-body"><p>done</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @ntBre by @11happy on 2025-09-01 15:26</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/11happy">@11happy</a> on 2025-09-02 15:33</div>
            <div class="timeline-body"><p>Hi maintainers, please let me know if any further input or changes are required from my end for this PR.</p>
<p>Thank you</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> approved on 2025-09-03 13:58</div>
            <div class="timeline-body"><p>Thank you!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "[syntax-errors] yield from inside async function" to "[syntax-errors] Detect `yield from` inside async function" by @ntBre on 2025-09-03 14:00</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @ntBre on 2025-09-03 14:13</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @ntBre on 2025-09-03 14:13</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 17:46:48 UTC
    </footer>
</body>
</html>
