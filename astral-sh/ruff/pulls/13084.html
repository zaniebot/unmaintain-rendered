<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[red-knot] Resolve function annotations before adding function symbol - astral-sh/ruff #13084</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[red-knot] Resolve function annotations before adding function symbol</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/13084">#13084</a>
        opened by <a href="https://github.com/dylwil3">@dylwil3</a>
        on 2024-08-23 19:10
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/dylwil3">@dylwil3</a> on 2024-08-23 19:10</div>
            <div class="timeline-body"><p>This PR has the <code>SemanticIndexBuilder</code> visit function definition annotations before adding the function symbol/name to the builder.</p>
<p>For example, the following snippet no longer causes a panic:</p>
<pre><code class="language-python">def bool(x) -&gt; bool:
    Return True
</code></pre>
<p>Note: This fix changes the ordering of the global symbol table.</p>
<p>Closes #13069</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @dylwil3 on 2024-08-23 19:10</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @dylwil3 on 2024-08-23 19:10</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @AlexWaygood by @dylwil3 on 2024-08-23 19:10</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dylwil3">@dylwil3</a> on 2024-08-23 19:12</div>
            <div class="timeline-body"><p>I also changed the order that the <code>TypeInferenceBuilder</code> resolves function definitions in the same way, but I'm not sure if that was relevant.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/codspeed-hq[bot]">@codspeed-hq[bot]</a> on 2024-08-23 19:16</div>
            <div class="timeline-body"><h2><a href="https://codspeed.io/astral-sh/ruff/branches/dylwil3:red-knot-fn-type-same">CodSpeed Performance Report</a></h2>
<h3>Merging #13084 will <strong>not alter performance</strong></h3>
<p><sub>Comparing <code>dylwil3:red-knot-fn-type-same</code> (2c5b453) with <code>main</code> (d19fd1b)</sub></p>
<h3>Summary</h3>
<p><code>✅ 32</code> untouched benchmarks</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-08-23 19:22</div>
            <div class="timeline-body"><p>I believe this means that we'd understand the return annotation as referring to <code>builtins.bool</code> rather than referring to the first-party function <code>bool</code>. That mimics the evaluation order at runtime:</p>
<pre><code class="language-pycon">&gt;&gt;&gt; def bool() -&gt; bool:
...   ...
...   
&gt;&gt;&gt; bool.__annotations__
{'return': &lt;class 'bool'&gt;}
&gt;&gt;&gt; bool.__annotations__['return'] is bool
False
</code></pre>
<p>And it also seems to be what pyright does: https://pyright-play.net/?code=CYUwZgBARg9jA2AKAlBAtAPmneAuAUBEQHSn74BOIAbiAIbwD6ALgJ4AOIisCylN9Jm07ccKPvgAeEALwQAKhQCuIKbOwIU-WgxYcuk5EA</p>
<p>But interestingly, mypy just understands the return annotation as being a forward reference to the function that the return annotation is part of: https://mypy-play.net/?mypy=latest&amp;python=3.12&amp;gist=6dd88ac3463dc662ab1a50ed0456685c</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2024-08-23 19:24</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dylwil3">@dylwil3</a> on 2024-08-23 19:43</div>
            <div class="timeline-body"><blockquote>
<p>I believe this means that we'd understand the return annotation as referring to <code>builtins.bool</code> rather than referring to the first-party function <code>bool</code>. That mimics the evaluation order at runtime</p>
</blockquote>
<p>That feels right to me - it was the same experiment as yours that motivated the reordering.</p>
<p>P.S. Not sure what the deal is with CodSpeed? I don't think I touched anything linter-related... I hope!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-08-23 20:14</div>
            <div class="timeline-body"><p>Nah, codspeed has been very unreliable recently :(</p>
<p>Best not to worry about it — sorry for the bother!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-08-23 20:24</div>
            <div class="timeline-body"><p>Wow nice, thank you. Could we add a test where the function and the return type name aren't a built in (e.g x as in the linked issue). Just to make sure the fix doesn't rely on any built in behavior</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dylwil3">@dylwil3</a> on 2024-08-23 20:39</div>
            <div class="timeline-body"><blockquote>
<p>Wow nice, thank you. Could we add a test where the function and the return type name aren't a built in (e.g x as in the linked issue). Just to make sure the fix doesn't rely on any built in behavior</p>
</blockquote>
<p>Done!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/semantic_index/builder.rs</code>:423 on 2024-08-23 22:34</div>
            <div class="timeline-body"><p>While we're fixing the order of things here, I think this also belongs above the definition of the function name:</p>
<pre><code>&gt;&gt;&gt; def bool(x = bool):
...     return x
...
&gt;&gt;&gt; bool()
&lt;class 'bool'&gt;
</code></pre>
<p>Would you be open to also adding a test for this and fixing the ordering?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_workspace/resources/test/corpus/25_func_annotations_same_name.py</code>:11 on 2024-08-23 22:49</div>
            <div class="timeline-body"><p>In an ideal world, I'd prefer to have inference tests that validate we get the semantics right, rather than just corpus tests that validate we don't panic.</p>
<p>But at the moment it'd be a pain to write those inference tests; we don't have <code>Call</code> support yet, so you can't easily get access to the return type of a function by e.g. doing <code>y = x()</code> and then checking the type of the <code>y</code> symbol, you'd have to instead scrabble through the AST to find the return annotation expression node, and then assert on its type. So this is more just a note for future, not something that needs to be changed in this PR.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> approved on 2024-08-23 22:50</div>
            <div class="timeline-body"><p>This looks like a clear improvement as-is, though if you're willing to also fix up the default-value issue as well, that'd be great!</p>
<p>Thank you!!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dylwil3">@dylwil3</a> reviewed on 2024-08-24 01:13</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dylwil3">@dylwil3</a> on <code>crates/red_knot_python_semantic/src/semantic_index/builder.rs</code>:423 on 2024-08-24 01:13</div>
            <div class="timeline-body"><p>Done! Added another &quot;no panic&quot; test and then a mostly copy-pasted unit test that doesn't really check for much but is a baby step towards the sort of thing you mentioned in your other comment.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/semantic_index.rs</code>:620 on 2024-08-24 01:52</div>
            <div class="timeline-body"><p>Does this test fail before this PR? Just looking at the test, it doesn't seem to me that this test would be impacted by the bug we are fixing in this PR.</p>
<p>The test I was thinking of would go in <code>types/infer.rs</code>, not here, and would assert on the inferred type for the return (or default) expression. The test <code>local_inference</code> in that file is an example of an existing test that finds an AST node and then asserts on its type. But like I said, I wasn't necessarily expecting we'd add such a test in this PR.</p>
<p>Unless I'm missing something and this test does actually check for this bug, I would say let's remove this test. If you want to try your hand at adding the above style of test, that's great but not required!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2024-08-24 01:52</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2024-08-24 02:04</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/semantic_index/builder.rs</code>:423 on 2024-08-24 02:04</div>
            <div class="timeline-body"><p>Thank you! As I mentioned in my other comment, I think the new copy-pasted test doesn't add enough value to be worth adding right now, so we can remove it. The inference test we eventually want would be at the type-inference level, not the semantic level. Everything else looks great!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2024-08-24 02:31</div>
            <div class="timeline-body"><p>Awesome work, thank you!!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @carljm on 2024-08-24 02:31</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @carljm on 2024-08-24 02:31</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-08-24 03:23</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by @carljm on 2024-08-27 23:45</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 21:39:02 UTC
    </footer>
</body>
</html>
