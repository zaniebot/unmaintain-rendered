<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>`ruff server` refreshes diagnostics for open files when file configuration is changed - astral-sh/ruff #10988</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1><code>ruff server</code> refreshes diagnostics for open files when file configuration is changed</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/10988">#10988</a>
        opened by <a href="https://github.com/snowsignal">@snowsignal</a>
        on 2024-04-17 01:15
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/snowsignal">@snowsignal</a></div>
            <div class="timeline-body">Summary
<p>The server now requests a <a href="https://microsoft.github.io/language-server-protocol/specifications/lsp/3.17/specification/#diagnostic_refresh">workspace diagnostic refresh</a> when a configuration file gets changed. This means that diagnostics for all open files will be automatically re-requested by the client on a config change.</p>
Test Plan
<p>You can test this by opening several files in VS Code, setting <code>select</code> in your file configuration to <code>[]</code>, and observing that the diagnostics go away once the file is saved (besides any <code>Pylance</code> diagnostics). Restore it to what it was before, and you should see the diagnostics automatically return once a save happens.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">server</span> added by <a href="https://github.com/snowsignal">@snowsignal</a> on 2024-04-17 01:15</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone &quot;Ruff Server: Beta&quot; by <a href="https://github.com/snowsignal">@snowsignal</a> on 2024-04-17 01:15</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2024-04-17 01:44</div>
            <div class="timeline-body">

<code>ruff-ecosystem</code> results
Linter (stable)
<p>✅ ecosystem check detected no linter changes.</p>
Linter (preview)
<p>✅ ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_server/src/server/api/notifications/did_change_watched_files.rs</code>:32 on 2024-04-17 07:06</div>
            <div class="timeline-body"><p>I think we should show a warning to users if the <code>workspace_refresh</code> capapbiltiy is not supported, telling them that they might see stale diagnostics and should restart the server. Or is there another way for us to push diagnostics (or clear them)?</p>
<p>Related to my question on the show error message PR. Why don&#x27;t we show an error message here if senting the refresh request failed?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2024-04-17 07:06</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2024-04-17 12:41</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_server/src/server/api/notifications/did_change_watched_files.rs</code>:32 on 2024-04-17 12:41</div>
            <div class="timeline-body"><p>Neovim doesn&#x27;t support this capability and I don&#x27;t know of any server which would send a message to the client so I&#x27;m not sure if it&#x27;s ok to do so. Rust analyzer does refresh the workspace when any of the <code>Cargo.toml</code> file changes but that&#x27;s probably something else.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-04-17 13:08</div>
            <div class="timeline-body"><p>It would be nice to have integration tests for this :P</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-04-17 13:31</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_server/src/server/api/notifications/did_change_watched_files.rs</code>:32 on 2024-04-17 13:31</div>
            <div class="timeline-body"><p>What do you mean by refreshing the workspace? Is this another LSP command that we could use as fallback?</p>
<p>My main concern is that we&#x27;ll get user reports that diagnostics are stale if we don&#x27;t indicate in anyway that we weren&#x27;t able to nuke them.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/snowsignal">@snowsignal</a> reviewed on 2024-04-17 16:13</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/snowsignal">@snowsignal</a> on <code>crates/ruff_server/src/server/api/notifications/did_change_watched_files.rs</code>:32 on 2024-04-17 16:13</div>
            <div class="timeline-body"><p>@MichaReiser At the moment we can&#x27;t even check whether or not the capability is supported due to a <a href="https://github.com/gluon-lang/lsp-types/pull/281">bug in <code>lsp-types</code></a>. I recommend we do this in a follow-up issue.</p>
<blockquote>
<p>Why don&#x27;t we show an error message here if senting the refresh request failed?</p>
</blockquote>
<p>The callback only runs if the request succeeds. Any erroneous response is <a href="https://github.com/astral-sh/ruff/blob/518b29a9efaa7c7a269c91d484806dff97f8a041/crates/ruff_server/src/server/client.rs#L165-L168">handled internally</a>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/snowsignal">@snowsignal</a> on 2024-04-17 16:14</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/snowsignal">@snowsignal</a> on 2024-04-17 16:14</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-04-17 16:14</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2024-04-18 02:54</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_server/src/server/api/notifications/did_change_watched_files.rs</code>:32 on 2024-04-18 02:54</div>
            <div class="timeline-body"><blockquote>
<p>What do you mean by refreshing the workspace? Is this another LSP command that we could use as fallback?</p>
</blockquote>
<p>I&#x27;d need to look into it but whenever I change any <code>Cargo.toml</code> files, the server starts indexing the project again. Maybe the server is watching over those files and starting to refresh all the relevant things like semantic tokens, inlay hints and possibly diagnostics.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:03:29 UTC
    </footer>
</body>
</html>
