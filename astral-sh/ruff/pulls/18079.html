<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Use static diagnostic names and cache `Rule`s - astral-sh/ruff #18079</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Use static diagnostic names and cache <code>Rule</code>s</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/18079">#18079</a>
        opened by <a href="https://github.com/ntBre">@ntBre</a>
        on 2025-05-13 21:05
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/ntBre">@ntBre</a> on 2025-05-13 21:05</div>
            <div class="timeline-body"><p>This PR is stacked on https://github.com/astral-sh/ruff/pull/18074 and uses the
separation between <code>CacheMessage</code> and the other diagnostic types added there to
store a <code>Rule</code> directly on <code>CacheMessage</code> and convert it back to a <code>&amp;'static str</code> for use by <code>Diagnostic</code> and <code>DiagnosticMessage</code>.</p>
<p>In the first commit, I added a generated <code>Rule::pascal_name</code> method for converting
back to the Pascal-case name currently used by <code>Diagnostic</code> and <code>DiagnosticMessage</code>,
but in the second commit I used the <code>heck</code> crate to generalize our existing <code>kebab_case</code>
macro to convert the <code>ViolationMetadata::rule_name</code> output to kebab-case and use
kebab-case everywhere. <code>heck</code> was already in our dependency graph because it's what
<code>strum</code> uses internally for case conversions.</p>
<p>I think that's probably preferable long-term, but it might be a breaking change in
the LSP because the lint name is used as the title for a quick fix, if a <code>suggestion</code> is
unavailable. Otherwise <code>Diagnostic::name</code> is only used for <code>debug!</code> logging.</p>
<h2>Test Plan</h2>
<p>Existing tests</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">diagnostics</span> added by @ntBre on 2025-05-13 21:05</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-05-13 21:14</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Formatter (stable)</h3>
<p>ℹ️ ecosystem check <strong>encountered format errors</strong>. (no format changes; 1 project error)</p>
<details><summary><a href="https://github.com/openai/openai-cookbook">openai/openai-cookbook</a> (error)</summary>
<p>

<pre><code>warning: Detected debug build without --no-cache.
error: Failed to read examples/gpt4-1_prompting_guide.ipynb: Expected a Jupyter Notebook, which must be internally stored as JSON, but this file isn't valid JSON: expected `,` or `]` at line 580 column 29
</code></pre>
</p>
</details>

<h3>Formatter (preview)</h3>
<p>ℹ️ ecosystem check <strong>encountered format errors</strong>. (no format changes; 1 project error)</p>
<details><summary><a href="https://github.com/openai/openai-cookbook">openai/openai-cookbook</a> (error)</summary>
<p>
<pre>ruff format --preview</pre>
</p>
<p>

<pre><code>warning: Detected debug build without --no-cache.
error: Failed to read examples/gpt4-1_prompting_guide.ipynb: Expected a Jupyter Notebook, which must be internally stored as JSON, but this file isn't valid JSON: expected `,` or `]` at line 580 column 29
</code></pre>
</p>
</details>

</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @ntBre on 2025-05-13 21:26</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @ntBre on 2025-05-13 21:26</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_macros/Cargo.toml</code>:20 on 2025-05-14 06:10</div>
            <div class="timeline-body"><p>It's not clear to me why we need to introduce the <code>heck</code> dependency here, considering that we already had an implementation that does the kebab case conversion</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_macros/src/map_codes.rs</code>:425 on 2025-05-14 06:11</div>
            <div class="timeline-body"><p>More for your other PR, but this still mentions <code>DiagnosticKind</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2025-05-14 06:18</div>
            <div class="timeline-body"><p>Nice speed up.</p>
<p>This is great. I would probably remove the heck dependency again, given that we already had an implementation of kebab_case (also reduces the size of your PR).</p>
<p>My only concern is that name is also used in the GitLab reporter to compute a fingerprint</p>
<p>https://github.com/astral-sh/ruff/blob/981bd70d393fe29324c07c3ffce5ecddd40e6bd6/crates/ruff_linter/src/message/gitlab.rs#L126-L134</p>
<p>This means, all diagnostics will be changed for gitlab users.</p>
<p>I don't think I'm too concerned by this because the implementation already uses <code>std::hash::DefaultHasher</code> which isn't guaranteed to be stable across rustc versions (or even platforms! we should probably fix this).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">internal</span> added by @MichaReiser on 2025-05-14 06:19</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-05-14 12:41</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_macros/Cargo.toml</code>:20 on 2025-05-14 12:41</div>
            <div class="timeline-body"><p>It looked like our old implementation of <code>kebab_case</code> could only handle <code>SCREAMING_SNAKE_CASE</code> names, but for this purpose I also needed it to  handle <code>PascalCase</code> names. That seemed like a harder case to roll our own version of, but admittedly I didn't try.</p>
<p>Usually I wouldn't reach for a dependency so lightly,  but it's already pulled in for strum, clap, salsa, and is-macro and doesn't have any additional dependencies of its own.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-05-14 12:46</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_macros/src/map_codes.rs</code>:425 on 2025-05-14 12:46</div>
            <div class="timeline-body"><p>Good catch, thank you! I'll resolve this in the other one.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntBre">@ntBre</a> on 2025-05-14 12:56</div>
            <div class="timeline-body"><p>Oh interesting about the gitlab diagnostic. As soon as I saw it was being hashed, I assumed it was okay. From the gitlab <a href="https://docs.gitlab.com/ci/testing/code_quality/#merge-request-widget">docs</a>, it sounds like they shouldn't be too user-facing and only used to deduplicate entries in the merge request widget, so hopefully it's okay.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntBre">@ntBre</a> on 2025-05-14 13:18</div>
            <div class="timeline-body"><p>Hm, it does look like we marked a previous change to the hash as breaking: https://github.com/astral-sh/ruff/issues/7159. One other benefit of keeping <code>heck</code> is that we could potentially go the other way back to pascal-case and (temporarily) use that for the gitlab emitter, if we want to avoid a breaking change.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @ntBre on 2025-05-14 20:26</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @ntBre on 2025-05-14 20:26</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-05-14 20:26</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 18:51:28 UTC
    </footer>
</body>
</html>
