<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Support `typing.NoReturn` and `typing.Never` - astral-sh/ruff #14559</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Support <code>typing.NoReturn</code> and <code>typing.Never</code></h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/14559">#14559</a>
        opened by <a href="https://github.com/Glyphack">@Glyphack</a>
        on 2024-11-23 17:07
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Glyphack">@Glyphack</a></div>
            <div class="timeline-body"><p>Fix #14558</p>
Summary
<ul>
<li>Add <code>typing.NoReturn</code> and <code>typing.Never</code> to known instances and infer them as <code>Type::Never</code></li>
<li>Add <code>is_assignable_to</code> cases for <code>Type::Never</code></li>
</ul>
<p>I skipped emitting diagnostic for when a function is annotated as <code>NoReturn</code> but it actually returns.</p>
Test Plan
<p>Added tests from
https://github.com/python/typing/blob/main/conformance/tests/specialtypes_never.py
except from generics and checking if the return value of the function and the annotations match.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2024-11-23 17:14</div>
            <div class="timeline-body">

<code>ruff-ecosystem</code> results
Linter (stable)
<p>✅ ecosystem check detected no linter changes.</p>
Linter (preview)
<p>✅ ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-11-23 18:10</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Glyphack">@Glyphack</a> reviewed on 2024-11-24 13:50</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/Glyphack">@Glyphack</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:403 on 2024-11-24 13:50</div>
            <div class="timeline-body"><p>I&#x27;m not sure if this will be useful for anything other than showing the type correctly to the user on hover. Without adding this field we show both <code>NoReturn</code> and <code>Never</code> as <code>Never</code>.
But this makes you type few more characters on pattern matching and when creating the type(The type creation can be simplified by making a function that would return the <code>Type::Never(NeverType::Never)</code>.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by <a href="https://github.com/Glyphack">@Glyphack</a> on 2024-11-24 13:54</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/carljm">@carljm</a> by <a href="https://github.com/Glyphack">@Glyphack</a> on 2024-11-24 13:54</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/MichaReiser">@MichaReiser</a> by <a href="https://github.com/Glyphack">@Glyphack</a> on 2024-11-24 13:54</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/AlexWaygood">@AlexWaygood</a> by <a href="https://github.com/Glyphack">@Glyphack</a> on 2024-11-24 13:54</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/sharkdp">@sharkdp</a> by <a href="https://github.com/Glyphack">@Glyphack</a> on 2024-11-24 13:54</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:4643 on 2024-11-24 19:33</div>
            <div class="timeline-body"><p>This means that we panic if a user writes something like this and then asks red-knot to check their code:</p>
<pre><code>import typing

x: typing.Never[int]
</code></pre>
<p>Backtrace:</p>
<pre><code>thread &#x27;&lt;unnamed&gt;&#x27; panicked at crates/red_knot_python_semantic/src/types/infer.rs:4635:17:
internal error: entered unreachable code: These types cannot be parametrized and have their own case
note: run with `RUST_BACKTRACE=1` environment variable to display a backtrace
Rayon: detected unexpected panic; aborting
zsh: abort      cargo run -p red_knot -- --current-directory ../experiment
</code></pre>
<p>The annotation <code>typing.Never</code> is invalid but we shouldn&#x27;t panic if the user writes something like this. Instead, we should emit a diagnostic and infer <code>Unknown</code>.</p>
<p>So it seems like this branch is pretty reachable ;)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> had review dismissed on 2024-11-24 19:34</div>
            <div class="timeline-body"><p>Thanks! Not a full review yet, but one important thing I noticed:</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Glyphack">@Glyphack</a> reviewed on 2024-11-24 20:22</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/Glyphack">@Glyphack</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:4643 on 2024-11-24 20:22</div>
            <div class="timeline-body"><p>Thanks! I don&#x27;t know why at the time I thought no branches go to this. Added
<code>error: [invalid-type-parameter] &quot;Type `typing.Never` expected no type parameter&quot;</code>
diagnostic and added a test for this case.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-11-24 20:24</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:4643 on 2024-11-24 20:24</div>
            <div class="timeline-body"><p>Great, thank you!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/resources/mdtest/annotations/never.md</code>:33 on 2024-11-24 20:26</div>
            <div class="timeline-body"><p>Let&#x27;s use the specified language of &quot;assignable to&quot;, not the unspecified and informal &quot;compatible with&quot;.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:403 on 2024-11-24 20:30</div>
            <div class="timeline-body"><p>My feeling is that we do not need to maintain an internal distinction between <code>Never</code> and <code>NoReturn</code>, as types. (We should distinguish between them as known instances in the <code>typing</code> module, as you do.) They are the same type, and it&#x27;s not even clear to me that it results in better UX to distinguish them. <code>NoReturn</code> is just an alternate form for function return annotations. The inferred type from calling a function annotated to return <code>NoReturn</code> is IMO actually better revealed as <code>Never</code> than <code>NoReturn</code>, because the term <code>NoReturn</code> makes no sense outside the immediate return annotation context.</p>
<p>(Let&#x27;s make sure @AlexWaygood doesnt have a strong feeling otherwise, before you go through the work of removing this enum.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2024-11-24 20:30</div>
            <div class="timeline-body"><p>Also not a full review yet, just a couple things I noticed in passing.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-11-24 20:35</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:403 on 2024-11-24 20:35</div>
            <div class="timeline-body"><blockquote>
<p>Let&#x27;s make sure @AlexWaygood doesnt have a strong feeling otherwise, before you go through the work of removing this enum.</p>
</blockquote>
<p>I agree! I had thoughts along the same lines, though I hadn&#x27;t written them up yet. Mypy and pyright do the same, IIRC</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2024-11-25 04:08</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:4579 on 2024-11-25 04:08</div>
            <div class="timeline-body"><p>nit: I think we can skip passing the <code>slice</code> if we pass the <code>subscript</code> as it can be fetched from the subscript directly</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/red_knot_python_semantic/resources/mdtest/annotations/never.md</code>:16 on 2024-11-25 08:15</div>
            <div class="timeline-body"><p>I think this should be a separate test that ends here. If you were to actually run this code, the program would never return from the <code>stop()</code> call.</p>
<p>Everything after this line can be considered unreachable code from the perspective of static analysis. Which also means we might not (should not) emit any diagnostics, including <code>reveal_type</code>-information. I guess it&#x27;s even questionable as to whether or not the <code>reveal_type</code> in this line should emit a diagnostic. You would not see any result at runtime. Existing type checkers still reveal the type for the <code>stop()</code> call, but nothing beyond.</p>
<p>Similar reasoning applies to some of the tests below, I think.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2024-11-25 08:15</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Glyphack">@Glyphack</a> reviewed on 2024-11-25 08:40</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/Glyphack">@Glyphack</a> on <code>crates/red_knot_python_semantic/resources/mdtest/annotations/never.md</code>:16 on 2024-11-25 08:40</div>
            <div class="timeline-body"><p>My intention was to test the revealed type only. You&#x27;re right this test will break when the behavior for Never is added.
I will move this call and other <code>reveal_types</code> that can stop the type checking to a function.</p>
<blockquote>
<p>I think this should be a separate test that ends here.</p>
</blockquote>
<p>Are you suggesting to implement this behavior in this PR? Otherwise I can add a todo comment here and work on it in a follow up PR.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2024-11-25 09:28</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/red_knot_python_semantic/resources/mdtest/annotations/never.md</code>:16 on 2024-11-25 09:28</div>
            <div class="timeline-body"><blockquote>
<p>Are you suggesting to implement this behavior in this PR?</p>
</blockquote>
<p>Ah, no — sorry. I was merely suggesting that we split this large test into multiple smaller tests. And take care not to have any test assertions (<code># revealed: </code> / <code># error: </code>) in lines following a call to a function that returns <code>Never</code>/<code>NoReturn</code>. To make sure this test will work in the future once we add unreachable-code analysis.</p>
<p>Writing smaller self-consistent tests would also be beneficial if we ever need to debug an assertion failure in this file.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2024-11-25 16:01</div>
            <div class="timeline-body"><blockquote>
<p>I skipped emitting diagnostic for when a function is annotated as <code>NoReturn</code> but it actually returns.</p>
</blockquote>
<p>This is correct to skip in this PR; there shouldn&#x27;t be any special-casing of such a check, it will just fall out naturally from checking return type assignability in general, since nothing (except for <code>Never</code>) is assignable to <code>Never</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:4589 on 2024-11-25 18:23</div>
            <div class="timeline-body"><p>if you do this then you can avoid the <code>.as_ref()</code> call on line 4611:</p>
<pre><code>        let parameters = &amp;*subscript.slice;
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-11-25 18:23</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Glyphack">@Glyphack</a> reviewed on 2024-11-25 18:25</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/Glyphack">@Glyphack</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:403 on 2024-11-25 18:25</div>
            <div class="timeline-body"><p>Thank you both. I reverted this one.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Glyphack">@Glyphack</a> reviewed on 2024-11-25 18:26</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/Glyphack">@Glyphack</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:4589 on 2024-11-25 18:26</div>
            <div class="timeline-body"><p>Great I did not know about this.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/resources/mdtest/annotations/never.md</code>:5 on 2024-11-25 18:39</div>
            <div class="timeline-body"><pre><code>`NoReturn` is used to annotate functions that never return (they always raise an exception or exit the process).
`Never` is the bottom type, and represents the empty set of Python objects. These two annotations can be used
interchangeably.
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:759 on 2024-11-25 21:22</div>
            <div class="timeline-body"><p>I think this case is a) wrong (because <code>Never</code> should be assignable to <code>Never</code>) and b) never reached, due to the <code>is_equivalent_to</code> check that takes precedence above.</p>
<p>There is a test verifying that <code>Never</code> is actually assignable to <code>Never</code>.</p>
<pre><code></code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:760 on 2024-11-25 21:24</div>
            <div class="timeline-body"><p>And I think this case should also not be necessary, because we fallback to <code>is_subtype_of</code>, which already contains this same case for <code>Never</code>. Removing this line and the previous one, all tests still pass.</p>
<pre><code></code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> approved on 2024-11-25 21:26</div>
            <div class="timeline-body"><p>Looks great, thank you! Just a few small tweaks which I&#x27;ll push, and then merge.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/carljm">@carljm</a> on 2024-11-25 21:37</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/carljm">@carljm</a> on 2024-11-25 21:37</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-11-26 09:49</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:08:46 UTC
    </footer>
</body>
</html>
