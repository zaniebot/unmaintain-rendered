<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sync vendored typeshed stubs - astral-sh/ruff #17402</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Sync vendored typeshed stubs</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/17402">#17402</a>
        opened by <a href="https://github.com/github-actions">@github-actions</a>
        on 2025-04-15 00:29
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/github-actions">@github-actions</a> on 2025-04-15 00:29</div>
            <div class="timeline-body"><p>Close and reopen this PR to trigger CI</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @github-actions[bot] on 2025-04-15 00:30</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @github-actions[bot] on 2025-04-15 00:30</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @AlexWaygood by @github-actions[bot] on 2025-04-15 00:30</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @sharkdp by @github-actions[bot] on 2025-04-15 00:30</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">internal</span> added by @github-actions[bot] on 2025-04-15 00:30</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @dcreager by @github-actions[bot] on 2025-04-15 00:30</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @carljm on 2025-04-15 01:07</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Reopened by @carljm on 2025-04-15 01:07</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-04-15 01:09</div>
            <div class="timeline-body"><!-- generated-comment mypy_primer -->

<h2><code>mypy_primer</code> results</h2>
<details>
<summary>Changes were detected when running on open source projects</summary>

<pre><code class="language-diff">packaging (https://github.com/pypa/packaging)
+ error[lint:unsupported-operator] /tmp/mypy_primer/projects/packaging/src/packaging/_tokenizer.py:39:26: Operator `|` is unsupported between objects of type `Literal[str]` and `GenericAlias`
+ error[lint:unsupported-operator] /tmp/mypy_primer/projects/packaging/src/packaging/_tokenizer.py:101:26: Operator `|` is unsupported between objects of type `Literal[str]` and `GenericAlias`
- error[lint:too-many-positional-arguments] /tmp/mypy_primer/projects/packaging/tests/test_musllinux.py:38:38: Too many positional arguments to function `__new__`: expected 1, got 2
- error[lint:too-many-positional-arguments] /tmp/mypy_primer/projects/packaging/tests/test_musllinux.py:39:37: Too many positional arguments to function `__new__`: expected 1, got 2
- error[lint:too-many-positional-arguments] /tmp/mypy_primer/projects/packaging/tests/test_musllinux.py:40:40: Too many positional arguments to function `__new__`: expected 1, got 2
- error[lint:too-many-positional-arguments] /tmp/mypy_primer/projects/packaging/tests/test_musllinux.py:55:55: Too many positional arguments to function `__new__`: expected 1, got 2
- error[lint:too-many-positional-arguments] /tmp/mypy_primer/projects/packaging/tests/test_musllinux.py:56:52: Too many positional arguments to function `__new__`: expected 1, got 2
- error[lint:too-many-positional-arguments] /tmp/mypy_primer/projects/packaging/tests/test_musllinux.py:57:58: Too many positional arguments to function `__new__`: expected 1, got 2
- error[lint:unknown-argument] /tmp/mypy_primer/projects/packaging/src/packaging/_musllinux.py:30:25: Argument `major` does not match any known parameter of function `__new__`
- error[lint:unknown-argument] /tmp/mypy_primer/projects/packaging/src/packaging/_musllinux.py:30:48: Argument `minor` does not match any known parameter of function `__new__`
- error[lint:too-many-positional-arguments] /tmp/mypy_primer/projects/packaging/src/packaging/_parser.py:83:36: Too many positional arguments to function `__new__`: expected 1, got 5
- error[lint:non-subscriptable] /tmp/mypy_primer/projects/packaging/src/packaging/metadata.py:286:68: Cannot subscript object of type `Literal[list]` with no `__class_getitem__` method
- error[lint:unsupported-operator] /tmp/mypy_primer/projects/packaging/src/packaging/metadata.py:302:20: Operator `|` is unsupported between objects of type `Literal[str]` and `Literal[list]`
- error[lint:non-subscriptable] /tmp/mypy_primer/projects/packaging/src/packaging/metadata.py:302:26: Cannot subscript object of type `Literal[list]` with no `__class_getitem__` method
- error[lint:non-subscriptable] /tmp/mypy_primer/projects/packaging/src/packaging/metadata.py:303:25: Cannot subscript object of type `Literal[list]` with no `__class_getitem__` method
- error[lint:unknown-argument] /tmp/mypy_primer/projects/packaging/src/packaging/version.py:206:13: Argument `epoch` does not match any known parameter of function `__new__`
- error[lint:unknown-argument] /tmp/mypy_primer/projects/packaging/src/packaging/version.py:207:13: Argument `release` does not match any known parameter of function `__new__`
- error[lint:unknown-argument] /tmp/mypy_primer/projects/packaging/src/packaging/version.py:208:13: Argument `pre` does not match any known parameter of function `__new__`
- error[lint:unknown-argument] /tmp/mypy_primer/projects/packaging/src/packaging/version.py:209:13: Argument `post` does not match any known parameter of function `__new__`
- error[lint:unknown-argument] /tmp/mypy_primer/projects/packaging/src/packaging/version.py:212:13: Argument `dev` does not match any known parameter of function `__new__`
- error[lint:unknown-argument] /tmp/mypy_primer/projects/packaging/src/packaging/version.py:213:13: Argument `local` does not match any known parameter of function `__new__`
- error[lint:too-many-positional-arguments] /tmp/mypy_primer/projects/packaging/src/packaging/_manylinux.py:195:36: Too many positional arguments to function `__new__`: expected 1, got 2
- error[lint:too-many-positional-arguments] /tmp/mypy_primer/projects/packaging/src/packaging/_manylinux.py:198:36: Too many positional arguments to function `__new__`: expected 1, got 2
- error[lint:too-many-positional-arguments] /tmp/mypy_primer/projects/packaging/src/packaging/_manylinux.py:201:36: Too many positional arguments to function `__new__`: expected 1, got 2
- error[lint:too-many-positional-arguments] /tmp/mypy_primer/projects/packaging/src/packaging/_manylinux.py:231:39: Too many positional arguments to function `__new__`: expected 1, got 2
- error[lint:too-many-positional-arguments] /tmp/mypy_primer/projects/packaging/src/packaging/_manylinux.py:234:43: Too many positional arguments to function `__new__`: expected 1, got 2
- error[lint:too-many-positional-arguments] /tmp/mypy_primer/projects/packaging/src/packaging/_manylinux.py:245:58: Too many positional arguments to function `__new__`: expected 1, got 2
- error[lint:too-many-positional-arguments] /tmp/mypy_primer/projects/packaging/src/packaging/_manylinux.py:254:64: Too many positional arguments to function `__new__`: expected 1, got 2
+ error[lint:unsupported-operator] /tmp/mypy_primer/projects/packaging/src/packaging/metadata.py:302:20: Operator `|` is unsupported between objects of type `Literal[str]` and `GenericAlias`
- error[lint:too-many-positional-arguments] /tmp/mypy_primer/projects/packaging/tests/test_tags.py:493:72: Too many positional arguments to function `__new__`: expected 1, got 2
- error[lint:too-many-positional-arguments] /tmp/mypy_primer/projects/packaging/tests/test_tags.py:563:72: Too many positional arguments to function `__new__`: expected 1, got 2
- error[lint:too-many-positional-arguments] /tmp/mypy_primer/projects/packaging/tests/test_tags.py:642:50: Too many positional arguments to function `__new__`: expected 1, got 2
- error[lint:too-many-positional-arguments] /tmp/mypy_primer/projects/packaging/tests/test_tags.py:643:51: Too many positional arguments to function `__new__`: expected 1, got 2
- error[lint:too-many-positional-arguments] /tmp/mypy_primer/projects/packaging/tests/test_tags.py:644:46: Too many positional arguments to function `__new__`: expected 1, got 2
- error[lint:too-many-positional-arguments] /tmp/mypy_primer/projects/packaging/tests/test_tags.py:645:48: Too many positional arguments to function `__new__`: expected 1, got 2
- error[lint:too-many-positional-arguments] /tmp/mypy_primer/projects/packaging/tests/test_tags.py:682:72: Too many positional arguments to function `__new__`: expected 1, got 2
- Found 348 diagnostics
+ Found 318 diagnostics

</code></pre>
</details>

</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-04-15 06:28</div>
            <div class="timeline-body"><p>The tests are failing because line numbers in typeshed have changed, and so we need to update some diagnostics snapshots that show code snippets from typeshed (referencing the function that was called). I guess we could look into ignoring linenumber-only changes automatically somehow via insta redactions, if it turns out to be annoying.</p>
<p>Or we could auto-update snapshots in the typeshed CI workflow, but the we would need to carefully review the diffs (outside the vendored typeshed folder).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-04-15 07:16</div>
            <div class="timeline-body"><p>The ecosystem changes are somewhat obscure. We now emit fewer false positives on <code>NamedTuple</code> construction, but for the wrong reasons.</p>
<ul>
<li><p>In https://github.com/python/typeshed/pull/13762, Python 3.8 support was dropped.</p>
</li>
<li><p>This included a change in <code>class tuple</code>, which previously had a <code>sys.version_info</code>-guarded <code>__class_getitem__</code> method:</p>
<pre><code class="language-py">if sys.version_info &gt;= (3, 9):
        def __class_getitem__(cls, item: Any, /) -&gt; GenericAlias: ...
</code></pre>
<p>that was now changed to be unconditionally available:</p>
<pre><code class="language-py">def __class_getitem__(cls, item: Any, /) -&gt; GenericAlias: ...
</code></pre>
</li>
<li><p>It took me a while to understand why this had any effect, since I was sure we used 3.9 by default. And we do, in MDtests. And we also use 3.9 in the CLI by default. ~~But in mypy_primer, we run Red Knot from inside the ruff repository. Which means that we pick up the <code>requires-python</code> bound here: https://github.com/astral-sh/ruff/blob/3b24fe5c07a2d337ba34a4c175b8a1dcccdb919b/pyproject.toml#L11~~ (Edit: that is not true. This is just something that confused me locally, when I was running Red Knot via <code>cargo run --bin red_knot</code> from the ruff repository). But if the project has a <code>requires-python</code> bound that is set to a lower version, we will use 3.7 or 3.8.</p>
</li>
</ul>
<p>I will merge this PR, as it is not the source of the problem. But I think that we need to change something here. We should probably drop support for 3.7 and 3.8? And maybe we should also change the <code>requires-python</code> discovery in such a way that it doesn't pick up a <code>pyproject.toml</code> from CWD if explicit paths <em>outside the CWD</em> are specified?! Not sure. (CC @MichaReiser)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @sharkdp on 2025-04-15 07:16</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @sharkdp on 2025-04-15 07:16</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-04-15 07:16</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-04-15 11:39</div>
            <div class="timeline-body"><p>Apparently this typeshed update sped up the cold benchmark by 3%, and the micro benchmark by 2%: https://codspeed.io/astral-sh/ruff/branches/typeshedbot%2Fsync-typeshed. I guess that's because we create fewer visibility-constraint predicates in <code>builtins</code> and other modules heavily used by tomllib, now that typeshed's dropped support for Python 3.8?</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 19:33:28 UTC
    </footer>
</body>
</html>
