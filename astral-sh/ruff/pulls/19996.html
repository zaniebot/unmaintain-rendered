<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[ty] Experimental persistent caching - astral-sh/ruff #19996</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[ty] Experimental persistent caching</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/ruff/pull/19996">#19996</a>
        opened by <a href="https://github.com/ibraheemdev">@ibraheemdev</a>
        on 2025-08-19 21:57
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ibraheemdev">@ibraheemdev</a></div>
            <div class="timeline-body"><h2>Summary</h2>
<p>Adds persistent caching experimentally under the <code>TY_PERSIST={path_to_cache_file}</code> environment variable. This currently has many limitations and is not ready for public usage:</p>
<ul>
<li>Performance is quite bad and significantly slower than a cold run.</li>
<li>The size of the file grows unbounded across runs, because we persist stale values.</li>
<li>The cache file is determined by the environment variable instead of using a <code>.ty</code> director with a key for the given project configuration. I intentionally avoided this for now.</li>
</ul>
<p>Limitations aside, I still want to land this to make it easier to iterate on in-tree.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ty</span> added by @ibraheemdev on 2025-08-19 21:57</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @ibraheemdev on 2025-08-19 21:57</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @AlexWaygood by @ibraheemdev on 2025-08-19 21:57</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @sharkdp by @ibraheemdev on 2025-08-19 21:57</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @dcreager by @ibraheemdev on 2025-08-19 21:57</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @ibraheemdev on 2025-08-19 21:57</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ibraheemdev">@ibraheemdev</a> reviewed on 2025-08-19 21:59</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ibraheemdev">@ibraheemdev</a> on <code>crates/ty_project/src/db.rs</code>:74 on 2025-08-19 21:59</div>
            <div class="timeline-body"><p>@MichaReiser I'm not actually sure if we need a cache key, because the <code>Program</code> input is persisted, and its fields are updated (bumping the revision) if the settings have changed? A local <code>.ty_cache</code> file/directory might be enough.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ibraheemdev">@ibraheemdev</a> reviewed on 2025-08-19 21:59</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ibraheemdev">@ibraheemdev</a> on <code>crates/ty_project/src/metadata.rs</code>:38 on 2025-08-19 21:59</div>
            <div class="timeline-body"><p><code>bincode</code> doesn't support the <code>serde(skip_serializing_if)</code> or <code>serde(untagged)</code> attributes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ibraheemdev">@ibraheemdev</a> reviewed on 2025-08-19 22:01</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ibraheemdev">@ibraheemdev</a> on <code>crates/ty_python_semantic/src/semantic_index/scope.rs</code>:23 on 2025-08-19 22:01</div>
            <div class="timeline-body"><p>This is a notable change, and might have an impact on performance.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ibraheemdev">@ibraheemdev</a> reviewed on 2025-08-19 22:01</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ibraheemdev">@ibraheemdev</a> on <code>crates/ty_python_semantic/src/types.rs</code>:338 on 2025-08-19 22:01</div>
            <div class="timeline-body"><p>I'm not sure exactly what to do about this, we can't deserialize into a <code>&amp;'static str</code> (without leaking). Making this store a <code>String</code>/<code>Cow</code> is really hard because <code>Type</code> is <code>Copy</code>. Could we use an enum here?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ibraheemdev">@ibraheemdev</a> reviewed on 2025-08-19 22:02</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ibraheemdev">@ibraheemdev</a> on <code>crates/ty_python_semantic/src/types.rs</code>:427 on 2025-08-19 22:02</div>
            <div class="timeline-body"><p>I disabled garbage collection for all interned values because it significantly reduces the amount of data we need to persist, but I'm not sure if that change should be made in this PR.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-08-19 22:10</div>
            <div class="timeline-body"><!-- generated-comment typing_conformance_diagnostics_diff -->

<h2>Diagnostic diff on <a href="https://github.com/python/typing/tree/d4f39b27a4a47aac8b6d4019e1b0b5b3156fabdc/conformance">typing conformance tests</a></h2>
<details>
<summary>Changes were detected when running ty on typing conformance tests</summary>

<pre><code class="language-diff">--- old-output.txt	2025-08-22 23:38:30.325218289 +0000
+++ new-output.txt	2025-08-22 23:38:32.929235818 +0000
@@ -1,5 +1,5 @@
 WARN ty is pre-release software and not ready for production use. Expect to encounter bugs, missing features, and fatal errors.
-fatal[panic] Panicked at /home/runner/.cargo/git/checkouts/salsa-e6f3bb7c2a062968/a3ffa22/src/function/execute.rs:228:25 when checking `/home/runner/work/ruff/ruff/typing/conformance/tests/aliases_typealiastype.py`: `infer_definition_types(Id(bcb1)): execute: too many cycle iterations`
+fatal[panic] Panicked at /home/runner/.cargo/git/checkouts/salsa-e6f3bb7c2a062968/a0e7a06/src/function/execute.rs:228:25 when checking `/home/runner/work/ruff/ruff/typing/conformance/tests/aliases_typealiastype.py`: `infer_definition_types(Id(bcb1)): execute: too many cycle iterations`
 _directives_deprecated_library.py:15:31: error[invalid-return-type] Function always implicitly returns `None`, which is not assignable to return type `int`
 _directives_deprecated_library.py:30:26: error[invalid-return-type] Function always implicitly returns `None`, which is not assignable to return type `str`
 _directives_deprecated_library.py:36:41: error[invalid-return-type] Function always implicitly returns `None`, which is not assignable to return type `Self@__add__`
</code></pre>
</details>

</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-08-19 22:12</div>
            <div class="timeline-body"><!-- generated-comment mypy_primer -->

<h2><code>mypy_primer</code> results</h2>
<p>No ecosystem changes detected ✅</p>
<details>
<summary>Memory usage changes were detected when running on open source projects</summary>

<pre><code class="language-diff">flake8 (https://github.com/pycqa/flake8)
-     struct metadata = ~2MB
+     struct metadata = ~3MB

trio (https://github.com/python-trio/trio)
-     memo metadata = ~22MB
+     memo metadata = ~21MB

prefect (https://github.com/PrefectHQ/prefect)
-     struct metadata = ~26MB
+     struct metadata = ~27MB

</code></pre>
</details>

</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2025-08-19 22:21</div>
            <div class="timeline-body"><p>This looks generally fine to me, assuming CI is cleared up and there are no observed regressions. Ideally I'd prefer @MichaReiser to take a look, if he has time.</p>
<p>If there is a noticeable performance regression for non-persisting cases, I'd be hesitant to pay that cost to land an experimental feature that we haven't even confirmed can be a net win, and I'd hope we can find a way to eliminate that regression, even if it's via conditional compilation.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-08-20 07:05</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_project/src/db.rs</code>:74 on 2025-08-20 07:05</div>
            <div class="timeline-body"><p>A not uncommon use case is to check a project with different Python versions: Each run then uses a different <code>ProgramSettings</code>. Ideally, the caches would be separate</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_db/src/diagnostic/mod.rs</code>:872 on 2025-08-20 07:13</div>
            <div class="timeline-body"><p>It's not the end of the world but it seems unfortunate if we have to change such fundamental types for an experimental feature.</p>
<p>The alternative here would be to retrieve the lint registry from the database (or a thread local) during deserialization and to use it to resolve the lint metadata.</p>
<p>https://github.com/astral-sh/ruff/blob/99d0ac60b417ee623bb9257a6502a7c21c444b28/crates/ty_python_semantic/src/db.rs#L14</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_source_file/src/lib.rs</code>:168 on 2025-08-20 07:18</div>
            <div class="timeline-body"><p>I'd prefer if we don't add serialize implementation for those types. We could simply panic in the <code>UnifiedFile</code> implementation whenever we encounter a ruff file.</p>
<p>The reason is that it seems unnecessary to maintain this complexity when Ruff doesn't even use salsa's caching and serializing the line index is a little useles (it's very cheap to build it from the source)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_project/src/db.rs</code>:150 on 2025-08-20 07:22</div>
            <div class="timeline-body"><p>Does this mean that all deserialized options now have a source CLI even if they were originally loaded from a settings file?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_project/src/db.rs</code>:187 on 2025-08-20 07:23</div>
            <div class="timeline-body"><p>What happens if the user moved the <code>metadata</code> file (e.g. if they moved it a directory up)? Do we replace the metadata somewhere (by calling update project), or do we use a stale configuration?</p>
<p>I think what would be ideal is if we wouldn't serialize the project settings at all and always load them instead. But that would require some form of hashing to know when they've changed (including which fields) which is out of scope for now</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_project/src/lib.rs</code>:87 on 2025-08-20 07:25</div>
            <div class="timeline-body"><p>and the reason for the <code>OnceLock</code> is so that we can change the field without bumping the salsa revision?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_python_semantic/src/python_platform.rs</code>:19 on 2025-08-20 07:31</div>
            <div class="timeline-body"><p><code>PythonPlatform</code> is used in the user-facing options struct: I don't see any schema changes, but we can't remove it here if it does change the schema (or we have to use another type in the user-facing options)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_python_semantic/src/semantic_index/place.rs</code>:146 on 2025-08-20 07:31</div>
            <div class="timeline-body"><p>Do all the <code>serialize</code> / <code>deserialize</code> impls notably impact the build time?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_python_semantic/src/semantic_index/scope.rs</code>:23 on 2025-08-20 07:34</div>
            <div class="timeline-body"><p>Hmm, this seems very unfortunate as it now introduces a global lock into semantic index building (which I think is the first?).</p>
<p>Can you run some benchmarks on large projects to see how it impacts performance? It seems a very unfortunate change for an experimental feature where it isn't even clear if we'll use it long term.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_python_semantic/src/types.rs</code>:338 on 2025-08-20 07:37</div>
            <div class="timeline-body"><p>We could do the same as what you did with <code>AstNodeRef</code> where we use an <code>Option&lt;&amp;'static str&gt;</code> and set it to <code>None</code> when deserializing. This could lead to issues downstream because types now suddenly compare equal that didn't before but I wonder if that should even be the case, given that the release implementation's equal implementation never compares the string.</p>
<p>An enum is an option too</p>
<p>I don't think we should spend too much time working around this because the ultimate goal is to remove this type entirely</p>
<p>CC: @sharkdp</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_python_semantic/src/types.rs</code>:427 on 2025-08-20 07:38</div>
            <div class="timeline-body"><p>I think this should be a separate PR and requires some reasoning why it's fine to do this</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-08-20 07:42</div>
            <div class="timeline-body"><p>Thank you.</p>
<p>I need to take a closer look at the project serialization/deserialization. It's not entirely clear to me how that works.</p>
<p>Overall, I'd prefer if this PR made fewer changes to the overall code base, given that this is an experimental feature that we might decide not to ship. This is mainly about changing <code>LintName</code> to use a <code>Cow</code> and disabling interning. For the latter, I think the solution is to gate the more questionable changes behind a feature flag. This allows us to pull this change in without regressing the production experience and gives us some more time to a) figure out a solution for those problem b) decide that its what we want, given that it enables persistent caching.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-08-20 07:55</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/ty_python_semantic/src/types.rs</code>:338 on 2025-08-20 07:55</div>
            <div class="timeline-body"><blockquote>
<p>We could do the same as what you did with <code>AstNodeRef</code> where we use an <code>Option&lt;&amp;'static str&gt;</code> and set it to <code>None</code> when deserializing. This could lead to issues downstream because types now suddenly compare equal that didn't before but I wonder if that should even be the case, given that the release implementation's equal implementation never compares the string.</p>
</blockquote>
<p>Hmm.. yes. I think we should be fine if all <code>TodoType</code>s compare equal. Maybe that will lead to some observable differences (different todo messages showing up in <code>reveal_type</code> assertions?), but those differences should never be behavioral. All of these types are completely dynamic types and should behave the same way. And if it's not consistent between debug and release right now, maybe that's something we should fix anyway (always have them compare equal, because there's no other way in release mode).</p>
<p>Instead of <code>Option&lt;&amp;'static str&gt;</code> you could maybe also deserialize these messages as <code>&quot;&lt;deserialized&gt;&quot;</code>, making it clear that the todo-messages are not persisted?</p>
<blockquote>
<p>I don't think we should spend too much time working around this because the ultimate goal is to remove this type entirely</p>
</blockquote>
<p>I agree.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for @AlexWaygood removed by @AlexWaygood on 2025-08-20 10:17</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ibraheemdev">@ibraheemdev</a> reviewed on 2025-08-20 18:05</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ibraheemdev">@ibraheemdev</a> on <code>crates/ty_project/src/db.rs</code>:150 on 2025-08-20 18:05</div>
            <div class="timeline-body"><p>The only place I see the options being created is <a href="https://github.com/astral-sh/ruff/blob/main/crates/ty/src/args.rs#L184">with <code>ValueSource::Cli</code> here</a>. Are they created elsewhere with a different source?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ibraheemdev">@ibraheemdev</a> reviewed on 2025-08-20 18:06</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ibraheemdev">@ibraheemdev</a> on <code>crates/ty_project/src/db.rs</code>:187 on 2025-08-20 18:06</div>
            <div class="timeline-body"><p>This was incorrect, I updated the check to be <code>project.metadata(db) == metadata</code>. If the metadata has changed, i.e. there is no project with matching metadata, a new <code>Project</code> input will be created.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ibraheemdev">@ibraheemdev</a> reviewed on 2025-08-20 18:07</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ibraheemdev">@ibraheemdev</a> on <code>crates/ty_project/src/lib.rs</code>:87 on 2025-08-20 18:07</div>
            <div class="timeline-body"><p>Yes, the settings should not change if the metadata has not changed.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ibraheemdev">@ibraheemdev</a> reviewed on 2025-08-20 18:10</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ibraheemdev">@ibraheemdev</a> on <code>crates/ty_python_semantic/src/python_platform.rs</code>:19 on 2025-08-20 18:10</div>
            <div class="timeline-body"><p>Should there be failing tests if the schema changes? This does change the representation.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-08-20 18:13</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_python_semantic/src/python_platform.rs</code>:19 on 2025-08-20 18:13</div>
            <div class="timeline-body"><p>Yes, there should be a failing test</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-08-20 18:14</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_project/src/db.rs</code>:150 on 2025-08-20 18:14</div>
            <div class="timeline-body"><p>https://github.com/astral-sh/ruff/blob/f34b65b7a00dfc61c5a54e4280b421c94151e677/crates/ty_project/src/metadata.rs#L166-L177</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ibraheemdev">@ibraheemdev</a> reviewed on 2025-08-20 18:16</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ibraheemdev">@ibraheemdev</a> on <code>crates/ty_project/src/db.rs</code>:150 on 2025-08-20 18:16</div>
            <div class="timeline-body"><p>Right, should we serialize the source at the top-level (in <code>Options</code>)?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ibraheemdev">@ibraheemdev</a> reviewed on 2025-08-20 18:31</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ibraheemdev">@ibraheemdev</a> on <code>crates/ty_python_semantic/src/python_platform.rs</code>:19 on 2025-08-20 18:31</div>
            <div class="timeline-body"><p>I rewrote the serde implementations in a way that bincode accepts, but there should be no change in behavior.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ibraheemdev">@ibraheemdev</a> reviewed on 2025-08-20 18:32</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ibraheemdev">@ibraheemdev</a> on <code>crates/ty_project/src/metadata.rs</code>:38 on 2025-08-20 18:32</div>
            <div class="timeline-body"><p>@MichaReiser is this one public facing?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-08-20 19:11</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_project/src/db.rs</code>:150 on 2025-08-20 19:11</div>
            <div class="timeline-body"><p>We can't. The options are merged together from multiple sources. We'd need to preserve them per value, which might be tricky</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ibraheemdev">@ibraheemdev</a> reviewed on 2025-08-20 19:17</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ibraheemdev">@ibraheemdev</a> on <code>crates/ty_project/src/db.rs</code>:150 on 2025-08-20 19:17</div>
            <div class="timeline-body"><p>Is there a reason that <code>RangedValue</code> ignores the source when serializing/deserializing in the first place?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-08-20 19:42</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Formatter (stable)</h3>
<p>✅ ecosystem check detected no format changes.</p>
<h3>Formatter (preview)</h3>
<p>✅ ecosystem check detected no format changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ibraheemdev">@ibraheemdev</a> reviewed on 2025-08-20 20:11</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ibraheemdev">@ibraheemdev</a> on <code>crates/ty_python_semantic/src/semantic_index/scope.rs</code>:23 on 2025-08-20 20:11</div>
            <div class="timeline-body"><p>I'm actually seeing a 7% speedup locally?</p>
<pre><code class="language-bash">$ hyperfine &quot;./target/release/ty-new check --quiet --python ./prefect/.venv&quot; &quot;./target/release/ty-old check --quiet --python ./prefect/.venv&quot; --ignore-failure --warmup 10
Benchmark 1: ./target/release/ty-new check --quiet --python ./prefect/.venv
  Time (mean ± σ):     674.4 ms ±  21.7 ms    [User: 7657.4 ms, System: 1588.2 ms]
  Range (min … max):   644.4 ms … 721.5 ms    10 runs
 
Benchmark 2: ./target/release/ty-old check --quiet --python ./prefect/.venv
  Time (mean ± σ):     722.3 ms ±  13.0 ms    [User: 7699.8 ms, System: 1694.5 ms]
  Range (min … max):   703.2 ms … 744.5 ms    10 runs
 
Summary
  ./target/release/ty-new check --quiet --python ./prefect/.venv ran
    1.07 ± 0.04 times faster than ./target/release/ty-old check --quiet --python ./prefect/.venv
</code></pre>
<p>Codspeed <a href="https://codspeed.io/astral-sh/ruff/runs/compare/68a622dc2992c5c139cf3e1e..68a6249e7162a5372439a629">reports a similar speedup on the multithreaded benchmark</a>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_project/src/db.rs</code>:150 on 2025-08-21 08:56</div>
            <div class="timeline-body"><p>It only ignores it when serializing. The deserialization uses the serde_toml's spanned feature to get the span and we get the source from the thread local:</p>
<p>https://github.com/astral-sh/ruff/blob/f34b65b7a00dfc61c5a54e4280b421c94151e677/crates/ty_project/src/metadata/value.rs#L281-L308</p>
<p>We don't serialize the span and source because the range is only for better diagnostics. It isn't actually part of the data itself. Now, the good news is that we only use serialization for tests. So we would consider serializing the ranges (or only if a specific thread local is set) and deserialize the ranges from the data if present (over using the thread local). I guess, we could always serialize/deserialize the source if the thread local isn't set</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-08-21 08:56</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ibraheemdev">@ibraheemdev</a> reviewed on 2025-08-21 17:30</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ibraheemdev">@ibraheemdev</a> on <code>crates/ty_project/src/db.rs</code>:150 on 2025-08-21 17:30</div>
            <div class="timeline-body"><p>I updated the code to use the new <code>ProjectMetadata</code> when resolving the settings (and program settings), so the new value sources are propagated.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_db/src/diagnostic/mod.rs</code>:943 on 2025-08-22 08:37</div>
            <div class="timeline-body"><p>Should we include the name in the error message or does serde do this for us?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_db/src/files/file_root.rs</code>:46 on 2025-08-22 08:38</div>
            <div class="timeline-body"><p>We'll want to have some form of garbage collection here to aovid creating file roots for paths that no longer exists but we can defer that to later.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_db/src/files.rs</code>:273 on 2025-08-22 08:40</div>
            <div class="timeline-body"><p>It might be worth asserting here that no such file existed and panic otherwise</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_db/src/files.rs</code>:450 on 2025-08-22 08:42</div>
            <div class="timeline-body"><p>The <code>key.key_index</code> feels a bit magical and we shouldn't have to use an API from <code>salsa::plumbing</code>. Could <code>entries</code> return a struct that provides an <code>as_struct()</code> method (or similar) to encapsulate this logic (I'm fine if this is done as a follow up, it just feels a bit off)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_project/src/metadata/value.rs</code>:62 on 2025-08-22 08:43</div>
            <div class="timeline-body"><p>Can we leave this <code>pub(super)</code>, now that we load the settings from the &quot;fresh&quot; metadata?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_project/src/db.rs</code>:149 on 2025-08-22 08:44</div>
            <div class="timeline-body"><p>Can we add a comment explaining why it's okay to use <code>ValueSource::Cli</code> here</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_project/src/db.rs</code>:155 on 2025-08-22 08:47</div>
            <div class="timeline-body"><p>Can we use <code>DEFAULT_LINT_REGISTRY</code> instead?  It avoids building the lint registry everytime we lookup a rule.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_project/src/db.rs</code>:177 on 2025-08-22 08:49</div>
            <div class="timeline-body"><p>It may help if we run this multi threaded, but that's something we can leave for a separate PR</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_project/src/db.rs</code>:207 on 2025-08-22 08:50</div>
            <div class="timeline-body"><p>Nit: Maybe use <code>encode_into_std_write</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_project/src/db.rs</code>:166 on 2025-08-22 08:50</div>
            <div class="timeline-body"><p>Nit: Maybe use <code>decode_from_std_read</code></p>
<p>Edit: Actually, we can't do that. We need to use <code>system.read_to_string</code> and use <code>system.as_writeable().write_file</code> to write the changes back</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_project/src/files.rs</code>:23 on 2025-08-22 08:52</div>
            <div class="timeline-body"><p>I think we should skip serializing <code>IndexedFiles</code> because we need to reload all files anyway. Unless that isn't easily possible because it then always results in a change?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_project/src/lib.rs</code>:87 on 2025-08-22 08:52</div>
            <div class="timeline-body"><p>Let's extend this documentation to also mention why it uses a <code>OnceLock</code> instead of an <code>Option</code>. Same for the other fields</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_project/src/db.rs</code>:75 on 2025-08-22 08:57</div>
            <div class="timeline-body"><pre><code class="language-suggestion">        if let Ok(path) = system.env_var(EnvVars::TY_PERSIST) {
</code></pre>
<p>To avoid your local <code>TY_PERSIST</code> environment variable leaking into tests</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_project/src/db.rs</code>:141 on 2025-08-22 08:58</div>
            <div class="timeline-body"><pre><code class="language-suggestion">    fn deserialize(&amp;mut self, path: &amp;str, metadata: &amp;ProjectMetadata) -&gt; anyhow::Result&lt;()&gt; {
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_project/src/db.rs</code>:177 on 2025-08-22 09:01</div>
            <div class="timeline-body"><p>Nit: <code>resolve_settings</code> seems to be only used by deserialization but its name doesn't suggest that. Maybe <code>init_after_deserialization</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_project/src/metadata.rs</code>:38 on 2025-08-22 09:02</div>
            <div class="timeline-body"><p>No, not yet :) We only use serialization in tests (that's why <code>cfg_attr(test)</code>)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_python_semantic/src/semantic_index/scope.rs</code>:22 on 2025-08-22 09:05</div>
            <div class="timeline-body"><p>Let's add a <code>TODO</code> to consider reverting to a tracked struct once supported by the persistent caching backend.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_static/src/env_vars.rs</code>:45 on 2025-08-22 09:08</div>
            <div class="timeline-body"><p>Let's add a note that this is highly experimental and currently makes ty slower.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2025-08-22 09:11</div>
            <div class="timeline-body"><p>Thank you. This looks great. I've a few smaller comments that would be great to address before landing but nothing major.</p>
<p>The only thing we should do before landing is to add a CLI test that exercises the <code>persist</code>, <code>load</code> to prevent us from accidentially breaking this feature. It would be nice to have more extensive tests that verify that e.g. changes to the files that need checking or settings propagate as expected but this is something we can add when we fully commit to persistent caching.</p>
<p>See the <code>cli</code> module for how to add CLI tests</p>
<p>https://github.com/astral-sh/ruff/blob/4daf59e5e7f4613eeb5b16616d6f1021297fc12e/crates/ty/tests/cli/main.rs#L18</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-08-22 09:30</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_python_semantic/src/semantic_index/scope.rs</code>:23 on 2025-08-22 09:30</div>
            <div class="timeline-body"><p>It's funny that this is the case and i don't fully understand it. Especially considering that it doubles the metadata size for <code>ScopeId</code></p>
<p>main:</p>
<p><code>ScopeId</code>                                          metadata=27.84MB  fields=11.93MB  count=994370</p>
<p>this branch:</p>
<p><code>ScopeId</code>                                          metadata=51.71MB  fields=11.93MB  count=994346</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ibraheemdev">@ibraheemdev</a> on <code>crates/ty_project/src/db.rs</code>:166 on 2025-08-22 23:03</div>
            <div class="timeline-body"><p>I'm also not sure if it would be faster to deserialize streaming. serde_json at least has performance issues with this and recommends reading into a temporary buffer first.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ibraheemdev">@ibraheemdev</a> reviewed on 2025-08-22 23:03</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ibraheemdev">@ibraheemdev</a> reviewed on 2025-08-22 23:04</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ibraheemdev">@ibraheemdev</a> on <code>crates/ty_project/src/metadata/value.rs</code>:62 on 2025-08-22 23:04</div>
            <div class="timeline-body"><p>We still need it to set the dummy <code>ValueSource::Cli</code> values.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ibraheemdev">@ibraheemdev</a> reviewed on 2025-08-22 23:05</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ibraheemdev">@ibraheemdev</a> on <code>crates/ty_python_semantic/src/semantic_index/scope.rs</code>:22 on 2025-08-22 23:05</div>
            <div class="timeline-body"><p>Hmm, I'm not sure how this would work without persisting the <code>semantic_index</code> query.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ibraheemdev">@ibraheemdev</a> reviewed on 2025-08-22 23:34</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ibraheemdev">@ibraheemdev</a> on <code>crates/ty_project/src/files.rs</code>:23 on 2025-08-22 23:34</div>
            <div class="timeline-body"><p>Hmm.. updating the <code>file_set</code> field is problematic. The <code>semantic_index</code> query has a dependency on <code>file_set</code> (for example, <code>report_semantic_error</code> checks if the file is in the set), and so <code>file_set</code> ends up in the flattened dependencies of <code>infer_scope_types</code>.</p>
<p>I think we need to make  <code>should_check_file</code> a tracked function so that the <code>infer_scope_types</code> queries have finer-grained dependencies on specific files instead of the entire set. I'm going to leave this as a TODO for now as it also requires Salsa changes (to avoid flattening transitive queries if they're marked as persistable).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ibraheemdev">@ibraheemdev</a> on 2025-08-22 23:37</div>
            <div class="timeline-body"><p>I think I've addressed most of the comments, but this still needs tests. I also want to do some benchmark to see why making <code>ScopeId</code> an interned struct is a performance improvement.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:15:10 UTC
    </footer>
</body>
</html>
