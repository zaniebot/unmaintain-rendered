<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RFC [ruff][ext-lint] 2: external lint rule selection - astral-sh/ruff #21413</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>RFC [ruff][ext-lint] 2: external lint rule selection</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/ruff/pull/21413">#21413</a>
        opened by <a href="https://github.com/pieterh-oai">@pieterh-oai</a>
        on 2025-11-12 20:54
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/pieterh-oai">@pieterh-oai</a></div>
            <div class="timeline-body">Summary
<blockquote>
<p>[!Note]
This PR 2 in  a stack of 3. This PR contains 2 commits; the base commit is PR&#x27;ed in  #21412 . The follow-on PR is #21415  . The <code>[ruff][ext-lint] external lint rule selection</code> commit is the actual delta for this PR.</p>
</blockquote>
<p>This PR implements external lint rule selection in both config and from the CLI, supporting the usual <code>select</code>, <code>ignore</code>, <code>extend-select</code>, and <code>extend-ignore</code>.</p>
<p>To ensure that internal rules are selected and ignored exactly as before, the flags for external rules are separate (<code>select-external</code>, <code>ignore-external</code>, etc.). In addition to avoiding weird corner cases, having separate flags means the use of external linters is always visible/explicit.</p>
<p>Based on the configuration and flags, we trim an <code>ExternalLintRegistry</code> (introduced in #21412) to contain the correct rules for each configuration scope. The assumption is that building registries will be relatively infrequent, while quickly finding and executing the correct rules is common and more performance sensitive.</p>
<p>Based on how we’ve set up the config (in #21412), the available set of external lint rules is not constant across the workspace. Any non-root <code>ruff.toml</code> that we encounter could define new linters+rules that don’t exist in other parts of the same codebase. In addition, linter .toml files can flag a linter as enabled/disabled.</p>
<p>I’d say this is fairly gnarly, but I’m not sure there is a great way to better share code with the internal linter selection path.</p>
Test Plan
<pre><code>cargo clippy --workspace --all-targets --all-features -- -D warnings
RUFF_UPDATE_SCHEMA=1 cargo test --workspace --exclude ty
uvx pre-commit run --all-files --show-diff-on-failure
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/astral-sh-bot[bot]">@astral-sh-bot[bot]</a> on 2025-11-12 21:04</div>
            <div class="timeline-body">

<code>ruff-ecosystem</code> results
Linter (stable)
<p>✅ ecosystem check detected no linter changes.</p>
Linter (preview)
<p>✅ ecosystem check detected no linter changes.</p>
Formatter (stable)
<p>✅ ecosystem check detected no format changes.</p>
Formatter (preview)
<p>✅ ecosystem check detected no format changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/amyreese">@amyreese</a> by <a href="https://github.com/amyreese">@amyreese</a> on 2025-11-12 22:43</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/MichaReiser">@MichaReiser</a> by <a href="https://github.com/amyreese">@amyreese</a> on 2025-11-12 22:43</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/ntBre">@ntBre</a> by <a href="https://github.com/amyreese">@amyreese</a> on 2025-11-12 22:43</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-11-13 08:47</div>
            <div class="timeline-body"><p>Hmm, this is a bit painful to review because I can&#x27;t change the baseline to your first PR.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-11-13 08:56</div>
            <div class="timeline-body"><blockquote>
<p>To ensure that internal rules are selected and ignored exactly as before, the flags for external rules are separate (select-external, ignore-external, etc.). In addition to avoiding weird corner cases, having separate flags means the use of external linters is always visible/explicit.</p>
</blockquote>
<p>Can you say more about the decision to use separate configuration options? The part that I&#x27;m worried about is that this wont&#x27; scale well. We&#x27;ll need an <code>external</code> variant anywhere where we accept rule codes (fixable, unfixable, and possibly other places in the future)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/pieterh-oai">@pieterh-oai</a> on 2025-11-13 17:11</div>
            <div class="timeline-body"><blockquote>
<p>Hmm, this is a bit painful to review because I can&#x27;t change the baseline to your first PR.</p>
</blockquote>
<p>Sorry about that. I&#x27;m used to stacking and I had no idea while setting this up that I&#x27;d have to base each PR off of <code>main</code>. I use this to look at these, fwiw:
<img alt="Screenshot 2025-11-13 at 8 59 31 AM" src="https://github.com/user-attachments/assets/73306381-9452-46b7-862c-14c3f5dcb992">
<img alt="Screenshot 2025-11-13 at 8 59 54 AM" src="https://github.com/user-attachments/assets/0a0b7371-4e5a-4b41-bcad-05b6d62d4091"></p>
<p>I&#x27;m not sure that fits into how you do reviews generally, but hopefully it&#x27;s helpful.</p>
<blockquote>
<p>Can you say more about the decision to use separate configuration options?</p>
</blockquote>
<p>My main concern, at least when I started out, was around overlapping rule names. Suppose someone writes RLI001 as an external linter somewhere in a private repo. Later, someone coincidentally writes a built-in rule with the same code. That sort of thing.</p>
<p>I think it depends a little on the &#x27;policies&#x27; we want to set around external linters:</p>
<ul>
<li>Should it be possible to define new external linters in nested TOML config files?</li>
<li>If a nested TOML file defines an external linter, should I be able to enable it / disable it from a &#x27;parent&#x27; TOML?</li>
</ul>
<p>On the plus side, I think most alternatives are probably simpler than this current implementation, so in some sense this PR represents the worst case scenario for external rule selection :)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/pieterh-oai">@pieterh-oai</a> on 2025-11-19 20:04</div>
            <div class="timeline-body"><p>(rebase)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/pieterh-oai">@pieterh-oai</a> on 2025-11-21 04:09</div>
            <div class="timeline-body"><p>(rebase)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/astral-sh-bot[bot]">@astral-sh-bot[bot]</a> on 2026-01-07 01:38</div>
            <div class="timeline-body">

Diagnostic diff on <a href="https://github.com/python/typing/tree/9f6d8ced7cd1c8d92687a4e9c96d7716452e471e/conformance">typing conformance tests</a>
<p>No changes detected when running ty on typing conformance tests ✅</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/astral-sh-bot[bot]">@astral-sh-bot[bot]</a> on 2026-01-07 01:39</div>
            <div class="timeline-body">

<code>mypy_primer</code> results

Changes were detected when running on open source projects

<pre><code>prefect (https://github.com/PrefectHQ/prefect)
- src/integrations/prefect-dbt/prefect_dbt/core/settings.py:94:28: error[invalid-assignment] Object of type `T@resolve_block_document_references | dict[str, Any]` is not assignable to `dict[str, Any]`
+ src/integrations/prefect-dbt/prefect_dbt/core/settings.py:94:28: error[invalid-assignment] Object of type `T@resolve_block_document_references | dict[str, Any] | str | ... omitted 4 union elements` is not assignable to `dict[str, Any]`
- src/integrations/prefect-dbt/prefect_dbt/core/settings.py:99:28: error[invalid-assignment] Object of type `T@resolve_variables | dict[str, Any]` is not assignable to `dict[str, Any]`
+ src/integrations/prefect-dbt/prefect_dbt/core/settings.py:99:28: error[invalid-assignment] Object of type `T@resolve_variables | str | int | ... omitted 4 union elements` is not assignable to `dict[str, Any]`
- src/prefect/cli/deploy/_core.py:86:21: error[invalid-assignment] Object of type `T@resolve_block_document_references | dict[str, Any]` is not assignable to `dict[str, Any]`
+ src/prefect/cli/deploy/_core.py:86:21: error[invalid-assignment] Object of type `T@resolve_block_document_references | dict[str, Any] | str | ... omitted 4 union elements` is not assignable to `dict[str, Any]`
- src/prefect/cli/deploy/_core.py:87:21: error[invalid-assignment] Object of type `T@resolve_variables` is not assignable to `dict[str, Any]`
+ src/prefect/cli/deploy/_core.py:87:21: error[invalid-assignment] Object of type `T@resolve_variables | str | int | ... omitted 4 union elements` is not assignable to `dict[str, Any]`
- src/prefect/deployments/steps/core.py:137:38: error[invalid-argument-type] Argument is incorrect: Expected `T@resolve_variables`, found `T@resolve_block_document_references | dict[str, Any]`
+ src/prefect/deployments/steps/core.py:137:38: error[invalid-argument-type] Argument is incorrect: Expected `T@resolve_variables`, found `T@resolve_block_document_references | dict[str, Any] | str | ... omitted 4 union elements`
- src/prefect/utilities/templating.py:320:13: error[invalid-assignment] Invalid subscript assignment with key of type `object` and value of type `T@resolve_block_document_references | dict[str, Any]` on object of type `dict[str, Any]`
+ src/prefect/utilities/templating.py:320:13: error[invalid-assignment] Invalid subscript assignment with key of type `object` and value of type `T@resolve_block_document_references | dict[str, Any] | str | ... omitted 4 union elements` on object of type `dict[str, Any]`
- src/prefect/utilities/templating.py:323:16: error[invalid-return-type] Return type does not match returned value: expected `T@resolve_block_document_references | dict[str, Any]`, found `list[T@resolve_block_document_references | dict[str, Any] | Unknown]`
+ src/prefect/utilities/templating.py:323:16: error[invalid-return-type] Return type does not match returned value: expected `T@resolve_block_document_references | dict[str, Any]`, found `list[T@resolve_block_document_references | dict[str, Any] | str | ... omitted 5 union elements]`
- src/prefect/utilities/templating.py:437:16: error[invalid-return-type] Return type does not match returned value: expected `T@resolve_variables`, found `dict[object, T@resolve_variables | Unknown]`
+ src/prefect/utilities/templating.py:437:16: error[invalid-return-type] Return type does not match returned value: expected `T@resolve_variables`, found `dict[object, T@resolve_variables | str | int | ... omitted 5 union elements]`
- src/prefect/utilities/templating.py:442:16: error[invalid-return-type] Return type does not match returned value: expected `T@resolve_variables`, found `list[T@resolve_variables | Unknown]`
+ src/prefect/utilities/templating.py:442:16: error[invalid-return-type] Return type does not match returned value: expected `T@resolve_variables`, found `list[T@resolve_variables | str | int | ... omitted 5 union elements]`
- src/prefect/workers/base.py:232:13: error[invalid-argument-type] Argument is incorrect: Expected `T@resolve_variables`, found `T@resolve_block_document_references | dict[str, Any]`
+ src/prefect/workers/base.py:232:13: error[invalid-argument-type] Argument is incorrect: Expected `T@resolve_variables`, found `T@resolve_block_document_references | dict[str, Any] | str | ... omitted 4 union elements`
- src/prefect/workers/base.py:234:20: error[invalid-argument-type] Argument expression after ** must be a mapping type: Found `T@resolve_variables`
+ src/prefect/workers/base.py:234:20: error[invalid-argument-type] Argument expression after ** must be a mapping type: Found `T@resolve_variables | str | int | ... omitted 4 union elements`

scikit-build-core (https://github.com/scikit-build/scikit-build-core)
- src/scikit_build_core/build/wheel.py:98:20: error[no-matching-overload] No overload of bound method `__init__` matches arguments
- Found 48 diagnostics
+ Found 47 diagnostics

static-frame (https://github.com/static-frame/static-frame)
- static_frame/core/node_selector.py:526:16: error[invalid-return-type] Return type does not match returned value: expected `InterGetItemLocReduces[TVContainer_co@InterfaceSelectQuartet, Any]`, found `InterGetItemLocReduces[Unknown | Bottom[Series[Any, Any]], Any]`
+ static_frame/core/node_selector.py:526:16: error[invalid-return-type] Return type does not match returned value: expected `InterGetItemLocReduces[TVContainer_co@InterfaceSelectQuartet, Any]`, found `InterGetItemLocReduces[Bottom[Series[Any, Any]] | Unknown, Any]`

pandas-stubs (https://github.com/pandas-dev/pandas-stubs)
- pandas-stubs/_typing.pyi:1232:16: warning[unused-ignore-comment] Unused blanket `type: ignore` directive
- Found 5134 diagnostics
+ Found 5133 diagnostics


</code></pre>


<p>No memory usage changes detected ✅</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:20:32 UTC
    </footer>
</body>
</html>
