<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[Python Formatter] Preserve empty lines - astral-sh/ruff #10639</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[Python Formatter] Preserve empty lines</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/pull/10639">#10639</a>
        opened by <a href="https://github.com/robincaloudis">@robincaloudis</a>
        on 2024-03-27 22:15
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/robincaloudis">@robincaloudis</a></div>
            <div class="timeline-body"><h2>Summary</h2>
<p>https://github.com/astral-sh/ruff/issues/9958 reported that code like</p>
<pre><code class="language-python">b = &quot;&quot;&quot;
    This looks like a docstring but is not in a notebook because notebooks can't be imported as a module.
    Ruff should leave it as is
&quot;&quot;&quot;;


a = &quot;another normal string&quot;
</code></pre>
<p>gets formatted as</p>
<pre><code class="language-python">b = &quot;&quot;&quot;
    This looks like a docstring but is not in a notebook because notebooks can't be imported as a module.
    Ruff should leave it as is
&quot;&quot;&quot;;
a = &quot;another normal string&quot;
</code></pre>
<p>This is unexpected and the expected behaviour of the formatter should preserve the empty lines between b and a.</p>
<h2>What</h2>
<ul>
<li>Modified <code>lines_after</code> such that it respects the semicolon. In my opinion, the extension makes a lot of sense in this function as it should not break counting of lines due to a semicolon</li>
<li>Test call sides</li>
<li>I intentionally did not modify <code>lines_before</code> as alone standing <code>;</code>'s are not allowed by the Python syntax anyway, e.g.<pre><code class="language-python">b = &quot;&quot;&quot;
    This looks like a docstring but is not in a notebook because notebooks can't be imported as a module.
    Ruff should leave it as is
&quot;&quot;&quot;;

;
a = &quot;another normal string&quot;
</code></pre>
</li>
</ul>
<h2>Test Plan</h2>
<ul>
<li>Correct tests</li>
<li>Add tests</li>
</ul>
<p>Closes https://github.com/astral-sh/ruff/issues/9958.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @robincaloudis on 2024-03-27 22:15</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/robincaloudis">@robincaloudis</a> reviewed on 2024-03-27 22:21</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/robincaloudis">@robincaloudis</a> on <code>crates/ruff_python_formatter/tests/snapshots/format@notebook_docstring.py.snap</code>:45 on 2024-03-27 22:21</div>
            <div class="timeline-body"><p>Interestingly, this empty like break was previously checked in.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "Formatter: Preserve empty lines" to "[Pyton Formatter] Preserve empty lines" by @robincaloudis on 2024-03-27 22:28</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2024-03-27 22:42</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Formatter (stable)</h3>
<p>✅ ecosystem check detected no format changes.</p>
<h3>Formatter (preview)</h3>
<p>✅ ecosystem check detected no format changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">formatter</span> added by @charliermarsh on 2024-03-28 01:24</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/robincaloudis">@robincaloudis</a> on 2024-03-28 08:31</div>
            <div class="timeline-body"><p>Some formatting has changed in the ruff-ecosystem. Seems like the backslash(&quot;\&quot;) is not recognized correctly with this change. Probably <code>lines_after_ignoring_end_of_line_trivia</code> needs to be adapted such that it interprets <a href="https://github.com/robincaloudis/ruff/blob/40186a26ef388ee12de38b514460dce9fd6ad1f3/crates/ruff_python_trivia/src/tokenizer.rs#L219">SimpleTokenKind::Continuation</a> correctly. I will look into that.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/statement/suite.rs</code>:363 on 2024-03-28 09:12</div>
            <div class="timeline-body"><p>I'm a bit worried about changing this to <code>lines_after_ignoring_end_of_line_trivia</code>. I haven't been able to come up with an example where it is causing troubles but my worry is about that this now counts the empty lines after a trailing comment, but <code>FormatTrailingComments</code> sometimes counts the lines up to the previous comment... where it could be possible that we duplicate the empty lines.</p>
<p>There are also many existing call sites to <code>lines_after</code> that I think would need to be changed to. For example here</p>
<p>https://github.com/astral-sh/ruff/blob/7b6d7abc3fa81d912a07311257d8b8950692dd14/crates/ruff_python_formatter/src/statement/suite.rs#L263-L284</p>
<p>We need to have a closer look how the two play together.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_trivia/src/tokenizer.rs</code>:124 on 2024-03-28 09:15</div>
            <div class="timeline-body"><p>Nit</p>
<pre><code class="language-suggestion">            matches!(token.kind, SimpleTokenKind::Newline | SimpleTokenKind::Whitespace | SimpleTokenKind::Semi)
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_trivia/src/tokenizer.rs</code>:122 on 2024-03-28 09:16</div>
            <div class="timeline-body"><p>Did you verify that all call sites require the &quot;skipping over semicolons&quot; behavior? I recommend adding tests that exercise each possible call site.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> requested changes on 2024-03-28 09:18</div>
            <div class="timeline-body"><p>Thanks for looking into this.</p>
<p>I'm a bit afraid of merging this without more extensive test coverage because the empty lines logic is complicated and using the right combinations of <code>lines_after</code> and <code>lines_before</code> variants is essential to avoid instabilities.</p>
<p>I recommend you to add more tests that also include comments, as well as tests that cover suppressed statements with trailing semicolons</p>
<p>For example, the following comment is misplaced:</p>
<pre><code class="language-python">if True:
	a = test; # comment

	# trailing end of block comment

c
</code></pre>
<p>Get's reformated to</p>
<pre><code class="language-python">if True:
    a = test  # comment

# trailing end of block comment

c

</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-03-28 09:37</div>
            <div class="timeline-body"><p>Thank you for working on this! I agree with Micha that blank lines are hard to get right even if it seems to be working. Even if the implementation work in isolation, it breaks when mixed with other things (speaking from personal experience ;)). As suggested, testing this out thoroughly would be really helpful for us to evaluate the change.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-03-29 03:35</div>
            <div class="timeline-body"><p>I'm surprised this <em>never</em> occurs in the current ecosystem checks. Is there a project that uses this syntax that we could test on for a real world case?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "[Pyton Formatter] Preserve empty lines" to "[Pyhton Formatter] Preserve empty lines" by @zanieb on 2024-03-29 03:36</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "[Pyhton Formatter] Preserve empty lines" to "[Python Formatter] Preserve empty lines" by @zanieb on 2024-03-29 03:36</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2024-03-29 11:05</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_python_formatter/tests/snapshots/format@notebook_docstring.py.snap</code>:45 on 2024-03-29 11:05</div>
            <div class="timeline-body"><p>I think the existing behavior correct because the source type is a Jupyter Notebook which doesn't have a concept of module-level docstring. So, it's just a string followed by another string.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/robincaloudis">@robincaloudis</a> reviewed on 2024-04-04 19:17</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/robincaloudis">@robincaloudis</a> on <code>crates/ruff_python_formatter/tests/snapshots/format@notebook_docstring.py.snap</code>:45 on 2024-04-04 19:17</div>
            <div class="timeline-body"><p>Hello @dhruvmanila, thanks for the review! Shouldn't the formatter keep the two empty lines between the two strings even though the concept of module-level docstring is missing? From what I understood so far, the existing behavior is not correct and should respect the empty lines as is.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/robincaloudis">@robincaloudis</a> on 2024-04-04 19:42</div>
            <div class="timeline-body"><p>Hi @dhruvmanila and @MichaReiser, thank you both for your review. I agree. I rethought my current approach of extending <code>lines_after_ignoring_end_of_line_trivia </code> and decided to extend <code>lines_after</code> instead. Note that I intentionally did not extend <code>lines_before</code>. Find details in the PR description. This new approach should not mess up any corner cases, as it does not touches the current combination of <code>lines_after</code> and <code>lines_before</code>. @MichaReiser, do you mind to re-review? Thank you.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @robincaloudis on 2024-04-05 12:38</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @dhruvmanila by @robincaloudis on 2024-04-05 12:38</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_trivia/src/tokenizer.rs</code>:79 on 2024-04-08 13:19</div>
            <div class="timeline-body"><p>The function comment is outdated.</p>
<p>The <code>lines_after_ignoring_trivia</code> is now no longer a more specific version of <code>lines_after</code> because it doesn't implement the &quot;skip over commas&quot;. I think we should keep the two in sync. This possibly also applies to <code>lines_after_ignoring_end_of_line_trivia</code> but I would need to dig deeper into the actual usage.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-04-08 13:20</div>
            <div class="timeline-body"><p>Thanks for following up on this PR.</p>
<p>Would you mind taking a look at why</p>
<pre><code>if True:
	a = test; # comment

	# trailing end of block comment

c
</code></pre>
<p>gets formatted differently when the semicolon is present? We don't need to fix it as part of this PR but I would like to understand the reason for it (to know if it makes sense to address it in a separate PR).</p>
<p>Is there any github project that has some usage of semicolons in Python? I would feel more comfortable when we could test the impact of this change on a larger code base.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @MichaReiser on 2024-04-08 13:21</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-09-08 18:36</div>
            <div class="timeline-body"><p>I'm going to close this PR as it has become stale. Please feel free to re-open if you plan to keep working on it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @MichaReiser on 2024-09-08 18:36</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:03:23 UTC
    </footer>
</body>
</html>
