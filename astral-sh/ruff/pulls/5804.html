<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Format expr generator exp - astral-sh/ruff #5804</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Format expr generator exp</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/5804">#5804</a>
        opened by <a href="https://github.com/davidszotten">@davidszotten</a>
        on 2023-07-16 12:53
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/davidszotten">@davidszotten</a></div>
            <div class="timeline-body"><h2>Summary</h2>
<p>Format <code>GeneratorExp</code></p>
<p>note: I manually edited <code>generated.rs</code> since <code>FormatExprGeneratorExp</code> now has a value and needs to be instantiated. it looks like a few others might also be in the same boat (they also break if i re-geneate)</p>
<p>Similarity index for django:  0.978 -&gt;  0.981</p>
<p>Fixes #5676</p>
<h2>Test Plan</h2>
<p>snapshots</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2023-07-16 13:03</div>
            <div class="timeline-body"><h2>PR Check Results</h2>
<h3>Ecosystem</h3>
<p>✅ ecosystem check detected no changes.</p>
<h3>Benchmark</h3>
<h4>Linux</h4>
<pre><code>group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.00      9.4±0.02ms     4.3 MB/sec    1.00      9.4±0.02ms     4.3 MB/sec
formatter/numpy/ctypeslib.py               1.00   1868.5±1.49µs     8.9 MB/sec    1.01   1882.8±4.23µs     8.8 MB/sec
formatter/numpy/globals.py                 1.00    209.3±1.43µs    14.1 MB/sec    1.00    209.4±1.08µs    14.1 MB/sec
formatter/pydantic/types.py                1.00      4.0±0.01ms     6.3 MB/sec    1.00      4.0±0.01ms     6.3 MB/sec
linter/all-rules/large/dataset.py          1.01     12.9±0.11ms     3.1 MB/sec    1.00     12.8±0.02ms     3.2 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      3.3±0.00ms     5.1 MB/sec    1.00      3.3±0.01ms     5.0 MB/sec
linter/all-rules/numpy/globals.py          1.00    432.5±0.74µs     6.8 MB/sec    1.00    433.8±1.66µs     6.8 MB/sec
linter/all-rules/pydantic/types.py         1.00      5.9±0.01ms     4.3 MB/sec    1.00      5.9±0.01ms     4.4 MB/sec
linter/default-rules/large/dataset.py      1.01      6.6±0.01ms     6.2 MB/sec    1.00      6.5±0.04ms     6.2 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.01   1414.4±3.20µs    11.8 MB/sec    1.00   1405.3±1.61µs    11.8 MB/sec
linter/default-rules/numpy/globals.py      1.01    156.8±1.35µs    18.8 MB/sec    1.00    155.3±0.28µs    19.0 MB/sec
linter/default-rules/pydantic/types.py     1.00      3.0±0.01ms     8.6 MB/sec    1.00      3.0±0.02ms     8.6 MB/sec
</code></pre>
<h4>Windows</h4>
<pre><code>group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.00     11.1±0.16ms     3.7 MB/sec    1.13     12.6±0.12ms     3.2 MB/sec
formatter/numpy/ctypeslib.py               1.00      2.2±0.04ms     7.7 MB/sec    1.12      2.4±0.04ms     6.9 MB/sec
formatter/numpy/globals.py                 1.00    245.0±5.10µs    12.0 MB/sec    1.09    267.1±9.16µs    11.0 MB/sec
formatter/pydantic/types.py                1.00      4.8±0.20ms     5.3 MB/sec    1.12      5.3±0.08ms     4.8 MB/sec
linter/all-rules/large/dataset.py          1.00     15.7±0.16ms     2.6 MB/sec    1.00     15.7±0.18ms     2.6 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      4.1±0.05ms     4.1 MB/sec    1.00      4.1±0.06ms     4.1 MB/sec
linter/all-rules/numpy/globals.py          1.01    494.0±9.04µs     6.0 MB/sec    1.00    490.1±8.51µs     6.0 MB/sec
linter/all-rules/pydantic/types.py         1.00      7.1±0.11ms     3.6 MB/sec    1.00      7.1±0.13ms     3.6 MB/sec
linter/default-rules/large/dataset.py      1.00      8.1±0.09ms     5.0 MB/sec    1.00      8.1±0.15ms     5.0 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00  1690.5±28.26µs     9.8 MB/sec    1.00  1692.8±20.06µs     9.8 MB/sec
linter/default-rules/numpy/globals.py      1.00    192.1±4.22µs    15.4 MB/sec    1.00    192.7±3.60µs    15.3 MB/sec
linter/default-rules/pydantic/types.py     1.00      3.6±0.04ms     7.0 MB/sec    1.01      3.6±0.04ms     7.0 MB/sec
</code></pre>
<!-- thollander/actions-comment-pull-request "PR Check Results" -->

</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-07-17 10:07</div>
            <div class="timeline-body"><p>#5829 fixes the <code>generate.py</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/expression/expr_call.rs</code>:70 on 2023-07-17 10:10</div>
            <div class="timeline-body"><p>Interesting, that Black has a custom logic especially for generators.</p>
<p>Can you add an example with a <code>GeneratorExpr</code> that also has comments?</p>
<pre><code class="language-python">len(
	( # leading
	a for b in c
	 # trailing
	)
)
</code></pre>
<p>Nit: Let's move the <code>parentheses</code> check from line 53..59 into the <code>other =&gt; </code> branch. We don't need to test if the argument is parenthesized if we're going to remove the parentheses anyway</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2023-07-17 10:11</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/davidszotten">@davidszotten</a> reviewed on 2023-07-17 12:06</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/davidszotten">@davidszotten</a> on <code>crates/ruff_python_formatter/src/expression/expr_call.rs</code>:70 on 2023-07-17 12:06</div>
            <div class="timeline-body"><p>this isn't based on black but rather the rules for generator expressions. see e.g. &quot;details, §2b&quot; in the pep https://peps.python.org/pep-0289/#the-details</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/davidszotten">@davidszotten</a> reviewed on 2023-07-17 12:09</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/davidszotten">@davidszotten</a> on <code>crates/ruff_python_formatter/src/expression/expr_call.rs</code>:70 on 2023-07-17 12:09</div>
            <div class="timeline-body"><p>note that your example will differ to black, in my understanding due to the same black bug that keeps _existing parens</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/expression/expr_call.rs</code>:70 on 2023-07-17 12:25</div>
            <div class="timeline-body"><blockquote>
<p>note that your example will differ to black, in my understanding due to the same black bug that keeps _existing parens</p>
</blockquote>
<p>Black's behavior is to always preserve parentheses in nested expressions and I think we should do the same for generators, except if we have very good reasons not to (for consistency).</p>
<p>I think the idiomatic way to implement this then is to change the generator's <code>NeedsParentheses</code> implementation to return <code>Never</code> if it is the only argument, and <code>Always</code> otherwise (except there are other places where the parentheses should be omitted).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-07-17 12:25</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/davidszotten">@davidszotten</a> reviewed on 2023-07-17 12:31</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/davidszotten">@davidszotten</a> on <code>crates/ruff_python_formatter/src/expression/expr_call.rs</code>:70 on 2023-07-17 12:31</div>
            <div class="timeline-body"><blockquote>
<blockquote>
<p>note that your example will differ to black, in my understanding due to the same black bug that keeps _existing parens</p>
</blockquote>
<p>Black's behavior is to always preserve parentheses in nested expressions and I think we should do the same for generators, except if we have very good reasons not to (for consistency).</p>
</blockquote>
<p>is this a reference to https://github.com/astral-sh/ruff/pull/5804/files#diff-dba753754ca8da36599acf528a6bfe006404be2c4cd9d00f18db1a3cf1a7ec21R9
or https://github.com/astral-sh/ruff/pull/5804/files#diff-dba753754ca8da36599acf528a6bfe006404be2c4cd9d00f18db1a3cf1a7ec21R19
?</p>
<blockquote>
<p>I think the idiomatic way to implement this then is to change the generator's <code>NeedsParentheses</code> implementation to return <code>Never</code> if it is the only argument, and <code>Always</code> otherwise (except there are other places where the parentheses should be omitted).</p>
</blockquote>
<p>how does <code>NeedsParentheses</code> figure out if it's a no-sibling function argument?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/expression/expr_call.rs</code>:70 on 2023-07-17 12:36</div>
            <div class="timeline-body"><blockquote>
<p>is this a reference to <a href="https://github.com/astral-sh/ruff/pull/5804/files#diff-dba753754ca8da36599acf528a6bfe006404be2c4cd9d00f18db1a3cf1a7ec21R9">#5804 (files)</a></p>
</blockquote>
<p>Mainly to <a href="https://github.com/astral-sh/ruff/pull/5804/files#diff-dba753754ca8da36599acf528a6bfe006404be2c4cd9d00f18db1a3cf1a7ec21R9">#5804 (files)</a>. Black keeps parentheses around all expressions (and only removes them in specific places like if/for/... headers)</p>
<blockquote>
<p>how does NeedsParentheses figure out if it's a no-sibling function argument?</p>
</blockquote>
<p>You get the parent node, which should be an <code>Arguments</code> node. You can test if it is the only argument.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-07-17 12:36</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/davidszotten">@davidszotten</a> on <code>crates/ruff_python_formatter/src/expression/expr_call.rs</code>:70 on 2023-07-17 12:40</div>
            <div class="timeline-body"><blockquote>
<blockquote>
<p>is this a reference to <a href="https://github.com/astral-sh/ruff/pull/5804/files#diff-dba753754ca8da36599acf528a6bfe006404be2c4cd9d00f18db1a3cf1a7ec21R9">#5804 (files)</a></p>
</blockquote>
<p>Mainly to <a href="https://github.com/astral-sh/ruff/pull/5804/files#diff-dba753754ca8da36599acf528a6bfe006404be2c4cd9d00f18db1a3cf1a7ec21R9">#5804 (files)</a>. Black keeps parentheses around all expressions (and only removes them in specific places like if/for/... headers)</p>
</blockquote>
<p>oh did i misremember that it was ok to diverge from black if it has known/accepted bug reports? (like the one i link to)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/davidszotten">@davidszotten</a> reviewed on 2023-07-17 12:40</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-07-18 09:07</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/expression/expr_call.rs</code>:70 on 2023-07-18 09:07</div>
            <div class="timeline-body"><p>I think it is okay if it is a functional bug of Black. This seems like a formatting change that has been accepted but will probably not be rolled out before the next black styleguide version.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/davidszotten">@davidszotten</a> reviewed on 2023-07-18 09:24</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/davidszotten">@davidszotten</a> on <code>crates/ruff_python_formatter/src/expression/expr_call.rs</code>:70 on 2023-07-18 09:24</div>
            <div class="timeline-body"><p>ok. i'm afraid i don't quite understand your fix suggestion. atm <code>NeedsParentheses</code> (afict) is only called if there is a <code>maybe_parenthesize_expression</code> wrapper. is that right? if so, where are you suggesting that should go? apologies if i'm missing something obvious here</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">formatter</span> added by @konstin on 2023-07-18 11:08</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff_python_formatter/resources/test/fixtures/ruff/expression/generator_exp.py</code>:9 on 2023-07-18 16:34</div>
            <div class="timeline-body"><pre><code class="language-suggestion"># black keeps these atm, but intends to remove them in the future: https://github.com/psf/black/issues/2943
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> approved on 2023-07-18 16:35</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/expression/expr_call.rs</code>:70 on 2023-07-19 06:08</div>
            <div class="timeline-body"><p>The proposal with <code>NeedsParentheses</code> is mainly if we want to match Black's behavior:</p>
<ul>
<li>Because, by default, expressions preserve their parentheses. Meaning the generators would have needed parentheses already before. Or are you aware of situations where a generator is not parenthesized in the source, but would need to be parenthesized after formatting (e.g. because we insert a trailing comma)?</li>
<li>Overriding <code>NeedsParentheses</code> and returning <code>Always</code> will add/preserve parentheses in the places where we, otherwise would omit them (e.g. in an if header).</li>
</ul>
<p>The reason why I think that <code>NeedsParentheses</code> would be a good fit is, because it should inform the formatted when it is necessary to parenthesize an expression. Tuples are different, because they have their own parentheses (you can have a parenthesized tuple expression <code>((a, b))</code>, but <code>(a, b)</code> is a tuple expression with parentheses. Okay this sounds confusing. One is about it is a parenthesized expression, the other is that tuples have their own parentheses)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-07-19 06:08</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/davidszotten">@davidszotten</a> reviewed on 2023-07-19 08:23</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/davidszotten">@davidszotten</a> on <code>crates/ruff_python_formatter/src/expression/expr_call.rs</code>:70 on 2023-07-19 08:23</div>
            <div class="timeline-body"><p>maybe i'm misunderstanding you, but in my understanding of generator expressions, they do have their &quot;own parentheses&quot; just like tuples do (but they can be omitted in some contexts. (fewer contexts than for tuples, only if they are a sole call argument))</p>
<p>maybe we merge this without preserving &quot;double wrapped&quot; generators and see how common when we compare ourselves against black on the various code bases we test. in general i'm in favour of matching black closer if that helps adoption</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/expression/expr_call.rs</code>:70 on 2023-07-19 11:00</div>
            <div class="timeline-body"><p>Oh I'm sorry. That's my bad. I assumed that parenthesizing the generator is optional. But from Python's full grammar:</p>
<pre><code>genexp:
    | '(' ( assignment_expression | expression !':=') for_if_clauses ')'
</code></pre>
<blockquote>
<p>https://docs.python.org/3/reference/grammar.html</p>
</blockquote>
<p>(Oddly, the parens are not optional)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-07-19 11:00</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2023-07-19 11:01</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @MichaReiser on 2023-07-19 11:01</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @MichaReiser on 2023-07-19 11:01</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/davidszotten">@davidszotten</a> reviewed on 2023-07-19 18:42</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/davidszotten">@davidszotten</a> on <code>crates/ruff_python_formatter/src/expression/expr_call.rs</code>:70 on 2023-07-19 18:42</div>
            <div class="timeline-body"><p>i wonder if the function call case is covered here</p>
<pre><code>primary:
    | primary '.' NAME 
    | primary genexp                     &lt;--  generator expr instead of brackets and arguments
    | primary '(' [arguments] ')'      &lt;-- (regular function call)
</code></pre>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 16:58:47 UTC
    </footer>
</body>
</html>
