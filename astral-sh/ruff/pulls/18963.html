<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[`pandas`] Avoid flagging `PD002` if `pandas` is not imported - astral-sh/ruff #18963</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[<code>pandas</code>] Avoid flagging <code>PD002</code> if <code>pandas</code> is not imported</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/18963">#18963</a>
        opened by <a href="https://github.com/jordyjwilliams">@jordyjwilliams</a>
        on 2025-06-26 15:13
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/jordyjwilliams">@jordyjwilliams</a> on 2025-06-26 15:13</div>
            <div class="timeline-body"><!--
Thank you for contributing to Ruff/ty! To help us out with reviewing, please consider the following:

- Does this pull request include a summary of the change? (See below.)
- Does this pull request include a descriptive title? (Please prefix with `[ty]` for ty pull
  requests.)
- Does this pull request include references to any relevant issues?
-->

<h2>Summary</h2>
<ul>
<li>As per <a href="https://docs.astral.sh/ruff/rules/pandas-use-of-inplace-argument/#pandas-use-of-inplace-argument-pd002">the docs on PD002</a><ul>
<li>Should only apply to <code>pandas</code> dataframes.</li>
<li>As <a href="https://github.com/astral-sh/ruff/issues/6432#issuecomment-2986380797">noted here</a> by @MeGaGiGaGon <code>PD002</code>  is still triggering.</li>
<li>Missed <a href="https://github.com/astral-sh/ruff/pull/14671">in this PR</a></li>
<li>This leverages <code>seen_module</code> that was introduced there.</li>
</ul>
</li>
</ul>
<!-- What's the purpose of the change? What does it do, and why? -->

<h2>Test Plan</h2>
<ul>
<li>Added new test cases to reproduce the issue of a <code>non pandas</code> import throwing.</li>
</ul>
<h3>Current <code>main</code></h3>
<ul>
<li>Fails added tests.</li>
</ul>
<h3>With new changes</h3>
<ul>
<li>Tests pass.</li>
</ul>
<h1>Appendix</h1>
<details>
<summary>Added negative case tests failing on `main`</summary>

<pre><code class="language-rs">failures:

---- rules::pandas_vet::tests::contents::r_import_polars_as_pl_x_pl_dataframe_x_drop_a_inplace_true_pd002_pass_polars_expects stdout ----
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ Snapshot Summary ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
Snapshot file: crates/ruff_linter/src/rules/pandas_vet/snapshots/ruff_linter__rules__pandas_vet__tests__PD002_pass_polars.snap
Snapshot: PD002_pass_polars
Source: crates/ruff_linter/src/rules/pandas_vet/mod.rs:373
────────────────────────────────────────────────────────────────────────────────
-old snapshot
+new results
────────────┬───────────────────────────────────────────────────────────────────
          0 │+&lt;filename&gt;:4:15: PD002 [*] `inplace=True` should be avoided; it has inconsistent behavior
          1 │+  |
          2 │+2 | import polars as pl
          3 │+3 | x = pl.DataFrame()
          4 │+4 | x.drop(['a'], inplace=True)
          5 │+  |               ^^^^^^^^^^^^ PD002
          6 │+  |
          7 │+  = help: Assign to variable; remove `inplace` arg
          8 │+
          9 │+ℹ Unsafe fix
         10 │+1 1 |
         11 │+2 2 | import polars as pl
         12 │+3 3 | x = pl.DataFrame()
         13 │+4   |-x.drop(['a'], inplace=True)
         14 │+  4 |+x = x.drop(['a'])
────────────┴───────────────────────────────────────────────────────────────────
To update snapshots run `cargo insta review`
Stopped on the first failure. Run `cargo insta test` to run all snapshots.

thread 'rules::pandas_vet::tests::contents::r_import_polars_as_pl_x_pl_dataframe_x_drop_a_inplace_true_pd002_pass_polars_expects' panicked at /Users/jordywilliams/.cargo/registry/src/index.crates.io-1949cf8c6b5b557f/insta-1.43.1/src/runtime.rs:679:13:
snapshot assertion for 'PD002_pass_polars' failed in line 373
note: run with `RUST_BACKTRACE=1` environment variable to display a backtrace

---- rules::pandas_vet::tests::contents::r_x_dataframe_x_drop_a_inplace_true_pd002_pass_no_import_expects stdout ----
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ Snapshot Summary ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
Snapshot file: crates/ruff_linter/src/rules/pandas_vet/snapshots/ruff_linter__rules__pandas_vet__tests__PD002_pass_no_import.snap
Snapshot: PD002_pass_no_import
Source: crates/ruff_linter/src/rules/pandas_vet/mod.rs:373
────────────────────────────────────────────────────────────────────────────────
-old snapshot
+new results
────────────┬───────────────────────────────────────────────────────────────────
          0 │+&lt;filename&gt;:3:15: PD002 [*] `inplace=True` should be avoided; it has inconsistent behavior
          1 │+  |
          2 │+2 | x = DataFrame()
          3 │+3 | x.drop(['a'], inplace=True)
          4 │+  |               ^^^^^^^^^^^^ PD002
          5 │+  |
          6 │+  = help: Assign to variable; remove `inplace` arg
          7 │+
          8 │+ℹ Unsafe fix
          9 │+1 1 |
         10 │+2 2 | x = DataFrame()
         11 │+3   |-x.drop(['a'], inplace=True)
         12 │+  3 |+x = x.drop(['a'])
────────────┴───────────────────────────────────────────────────────────────────
To update snapshots run `cargo insta review`
Stopped on the first failure. Run `cargo insta test` to run all snapshots.

thread 'rules::pandas_vet::tests::contents::r_x_dataframe_x_drop_a_inplace_true_pd002_pass_no_import_expects' panicked at /Users/jordywilliams/.cargo/registry/src/index.crates.io-1949cf8c6b5b557f/insta-1.43.1/src/runtime.rs:679:13:
snapshot assertion for 'PD002_pass_no_import' failed in line 373


failures:
    rules::pandas_vet::tests::contents::r_import_polars_as_pl_x_pl_dataframe_x_drop_a_inplace_true_pd002_pass_polars_expects
    rules::pandas_vet::tests::contents::r_x_dataframe_x_drop_a_inplace_true_pd002_pass_no_import_expects

test result: FAILED. 2442 passed; 2 failed; 4 ignored; 0 measured; 0 filtered out; finished in 0.93s

error: test failed, to rerun pass `-p ruff_linter --lib`
</code></pre>
</details>

<!-- How was it tested? -->

</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/pandas_vet/rules/inplace_argument.rs</code>:56 on 2025-06-26 19:04</div>
            <div class="timeline-body"><p>The comment is now outdated.</p>
<p>Can you tell me more why we remove this check entirely?</p>
<p>CC: @dhruvmanila</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-06-26 19:05</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-06-26 19:13</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>ℹ️ ecosystem check <strong>detected linter changes</strong>. (+1 -1 violations, +0 -0 fixes in 1 projects; 54 projects unchanged)</p>
<details><summary><a href="https://github.com/apache/superset">apache/superset</a> (+1 -1 violations, +0 -0 fixes)</summary>
<p>
<pre>ruff check --no-cache --exit-zero --ignore RUF9 --no-fix --output-format concise --no-preview --select ALL</pre>
</p>
<p>

<pre>
- <a href='https://github.com/apache/superset/blob/ede3de0ca0addde195199be332d6e4dd454955ef/tests/integration_tests/model_tests.py#L491'>tests/integration_tests/model_tests.py:491:29:</a> PD002 `inplace=True` should be avoided; it has inconsistent behavior
+ <a href='https://github.com/apache/superset/blob/ede3de0ca0addde195199be332d6e4dd454955ef/tests/unit_tests/pandas_postprocessing/test_rename.py#L65'>tests/unit_tests/pandas_postprocessing/test_rename.py:65:9:</a> PD002 `inplace=True` should be avoided; it has inconsistent behavior
</pre>

</p>
</details>
<details><summary>Changes by rule (1 rules affected)</summary>
<p>

<p>| code | total | + violation | - violation | + fix | - fix |
| ---- | ------- | --------- | -------- | ----- | ---- |
| PD002 | 2 | 1 | 1 | 0 | 0 |</p>
</p>
</details>

<h3>Linter (preview)</h3>
<p>ℹ️ ecosystem check <strong>detected linter changes</strong>. (+1 -1 violations, +0 -0 fixes in 1 projects; 54 projects unchanged)</p>
<details><summary><a href="https://github.com/apache/superset">apache/superset</a> (+1 -1 violations, +0 -0 fixes)</summary>
<p>
<pre>ruff check --no-cache --exit-zero --ignore RUF9 --no-fix --output-format concise --preview --select ALL</pre>
</p>
<p>

<pre>
- <a href='https://github.com/apache/superset/blob/ede3de0ca0addde195199be332d6e4dd454955ef/tests/integration_tests/model_tests.py#L491'>tests/integration_tests/model_tests.py:491:29:</a> PD002 `inplace=True` should be avoided; it has inconsistent behavior
+ <a href='https://github.com/apache/superset/blob/ede3de0ca0addde195199be332d6e4dd454955ef/tests/unit_tests/pandas_postprocessing/test_rename.py#L65'>tests/unit_tests/pandas_postprocessing/test_rename.py:65:9:</a> PD002 `inplace=True` should be avoided; it has inconsistent behavior
</pre>

</p>
</details>
<details><summary>Changes by rule (1 rules affected)</summary>
<p>

<p>| code | total | + violation | - violation | + fix | - fix |
| ---- | ------- | --------- | -------- | ----- | ---- |
| PD002 | 2 | 1 | 1 | 0 | 0 |</p>
</p>
</details>

</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> approved on 2025-06-26 19:19</div>
            <div class="timeline-body"><p>Looks good, thanks!</p>
<p>Edit: I didn't see Micha's review, I'll defer to him and Dhruv.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/jordyjwilliams">@jordyjwilliams</a> reviewed on 2025-06-26 22:50</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/jordyjwilliams">@jordyjwilliams</a> on <code>crates/ruff_linter/src/rules/pandas_vet/rules/inplace_argument.rs</code>:56 on 2025-06-26 22:50</div>
            <div class="timeline-body"><blockquote>
<p>The comment is now outdated.</p>
<p>Can you tell me more why we remove this check entirely?</p>
<p>CC: @dhruvmanila</p>
</blockquote>
<p>Fair call, I will remove the comment (https://github.com/astral-sh/ruff/pull/18963/commits/7348b1caefa5b2a0903c4d2f8703a782ae29e458). I removed the check for the following reasons:</p>
<ul>
<li>To align better with the code styling and implementation from: https://github.com/astral-sh/ruff/pull/14671</li>
<li>As noted in that PR yes this may give false negatives. But this is preferred to false positives (less end-user gripe)</li>
<li>I believe the check is now unnecessary given the additional tests added<ul>
<li>On current <code>main</code> these would fail, eg they would trigger the <code>pandas linter</code> issue.</li>
<li>With these changes, they now pass.</li>
<li>All existing tests pass, thus no existing functionality (that I'm aware of) will change.</li>
</ul>
</li>
</ul>
<p>If there's something I'm missing here please let me know. Happy to add back in the check.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/jordyjwilliams">@jordyjwilliams</a> on 2025-06-26 22:51</div>
            <div class="timeline-body"><blockquote>
<p>Looks good, thanks!</p>
<p>Edit: I didn't see Micha's review, I'll defer to him and Dhruv.</p>
</blockquote>
<p>Noted. Will wait until Micha approves or has concerns addressed.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/jordyjwilliams">@jordyjwilliams</a> reviewed on 2025-06-26 23:20</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/jordyjwilliams">@jordyjwilliams</a> on <code>crates/ruff_linter/src/rules/pandas_vet/rules/inplace_argument.rs</code>:56 on 2025-06-26 23:20</div>
            <div class="timeline-body"><p>EG with these changes we are using the <code>cheker</code> however in a different way (as introduced in #14671.</p>
<p><code>!checker.semantic().seen_module(Modules::PANDAS)</code> we will now <code>skip the check</code> <code>pandas</code> has not been seen (used) within the offending code.</p>
<p>Thus; this will allow for less false positives with similar codes on <code>in-place</code> operations. eg <code>pl.dataframe</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2025-06-27 06:00</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_linter/src/rules/pandas_vet/rules/inplace_argument.rs</code>:56 on 2025-06-27 06:00</div>
            <div class="timeline-body"><p>@MichaReiser Isn't this change in line with what you did in https://github.com/astral-sh/ruff/pull/14671? In other words, why wasn't that change applied to this rule?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2025-06-27 06:03</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_linter/src/rules/pandas_vet/rules/inplace_argument.rs</code>:56 on 2025-06-27 06:03</div>
            <div class="timeline-body"><p>The existing check would only work when the method is used directly like <code>pandas.DataFrame.sort_values</code> and not when used as <code>df = pandas.DataFrame(); df.sort_values</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-06-27 06:53</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/pandas_vet/rules/inplace_argument.rs</code>:56 on 2025-06-27 06:53</div>
            <div class="timeline-body"><blockquote>
<p>The existing check would only work when the method is used directly like pandas.DataFrame.sort_values and not when used as df = pandas.DataFrame(); df.sort_values.</p>
</blockquote>
<p>Yeah, I think that's the main difference. This PR removes some false positives (when panda isn't enabled at all) but introduces some new false positives (when using panda but the method doesn't come from pandas). This is different from my PRs where I only added the check.</p>
<p>However, I think this is still fine because it is in line with all other pandas rules.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">rule</span> added by @MichaReiser on 2025-06-27 06:53</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @MichaReiser on 2025-06-27 06:56</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @MichaReiser on 2025-06-27 06:56</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/jordyjwilliams">@jordyjwilliams</a> reviewed on 2025-06-27 06:58</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/jordyjwilliams">@jordyjwilliams</a> on <code>crates/ruff_linter/src/rules/pandas_vet/rules/inplace_argument.rs</code>:56 on 2025-06-27 06:58</div>
            <div class="timeline-body"><p>@MichaReiser good to merge from your point of view here? What I guess I was going for here was standardization.</p>
<p>And also basically looking to commit to this repo for the first time. @dhruvmanila's suggestion is what I was implementing here for robustness, completeness and to close out https://github.com/astral-sh/ruff/issues/6432#issuecomment-2986380797</p>
<p>In my experience people who would use <code>pandas.DataFrame</code> would typically have these as variables and run <code>my_df.sort_values(in_place=True)</code> or so... Thus I figured it's better to pick up on these cases (when we know <code>pandas</code> has been seen)... And rather have all <code>pd</code> methods work the same.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-06-27 06:58</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-06-27 06:59</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/pandas_vet/rules/inplace_argument.rs</code>:56 on 2025-06-27 06:59</div>
            <div class="timeline-body"><p>Yeah, I think it's fine. Thank you for working on this!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/jordyjwilliams">@jordyjwilliams</a> on <code>crates/ruff_linter/src/rules/pandas_vet/rules/inplace_argument.rs</code>:56 on 2025-06-27 07:01</div>
            <div class="timeline-body"><p>Nws, thanks for the approval and merge.</p>
<p>Anything further required from my side after merge?</p>
<p>I have read <a href="https://github.com/astral-sh/ruff/blob/main/CONTRIBUTING.md">the contributing guide</a> just trying to make sure there's nothing I've missed here?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/jordyjwilliams">@jordyjwilliams</a> reviewed on 2025-06-27 07:01</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-06-27 07:02</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/pandas_vet/rules/inplace_argument.rs</code>:56 on 2025-06-27 07:02</div>
            <div class="timeline-body"><p>No, all good from your side. This will go out in the next release</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "[pandas]: Fix issue on `non pandas` dataframe `in-place` usage (PD002)" to "[`pandas`] Avoid flagging `PD002` if `pandas` is not imported" by @dhruvmanila on 2025-06-27 10:31</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 18:39:36 UTC
    </footer>
</body>
</html>
