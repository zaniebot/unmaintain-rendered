<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Improve internal documentation for the semantic model - astral-sh/ruff #10788</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Improve internal documentation for the semantic model</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/10788">#10788</a>
        opened by <a href="https://github.com/AlexWaygood">@AlexWaygood</a>
        on 2024-04-05 11:11
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a></div>
            <div class="timeline-body">Summary
<p>This PR improves internal documentation around several parts of the semantic model. The clarifications here come from reading @charliermarsh&#x27;s helpful summary document he recently sent round internally, and work done with @carljm yesterday trying to figure out how to solve <a href="https://github.com/astral-sh/ruff/issues/3011">astral-sh/ruff#3011</a>.</p>
<p>Changes made:</p>
<ol>
<li><p>Clarifications are made to <code>SemanticModelFlags::FUTURE_ANNOTATIONS</code>:</p>
<p>a). This flag is no longer set in all stub files, as was previously the case. Setting this flag in stub files was somewhat confusing as, although stub files have PEP-563 semantics at all times, they very rarely actually have <code>from __future__ import annotations</code> at the top of the module.</p>
<p>b). <code>SemanticModel::future_annotations()</code> is renamed to <code>SemanticModel::future_annotations_or_stub()</code>, and now checks whether <em>either</em> <code>SemanticModelFlags::FUTURE_ANNOTATIONS</code> is set <em>or</em> <code>SemanticModelFlags::STUB_FILE</code> is set. This more accurately reflects what this function has always done (return <code>true</code> if the model was <em>either</em> visiting a stub <em>or</em> visiting a runtime module with <code>from __future__ import annotations</code>) since previously <code>SemanticModelFlags::FUTURE_ANNOTATIONS</code> was set in all stub files.</p>
</li>
<li><p>Several doc-comments are added, corrected, or expanded upon</p>
</li>
<li><p>A debug assertion is added to <code>Checker::visit_deferred_future_type_definitions()</code>, to ensure that no type definitions have been invalidly marked as &quot;deferred future type definitions&quot;.</p>
</li>
</ol>
Test Plan
<p><code>cargo test</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">internal</span> added by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-04-05 11:11</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/charliermarsh">@charliermarsh</a> by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-04-05 11:11</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-04-05 11:25</div>
            <div class="timeline-body"><blockquote>
Test Plan
<p><code>cargo test</code></p>
</blockquote>
<p>I also ran this PR branch locally on typeshed, since we don&#x27;t have as much test coverage for stub files, and there were no changes in the lints Ruff emitted</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2024-04-05 11:27</div>
            <div class="timeline-body">

<code>ruff-ecosystem</code> results
Linter (stable)
<p>✅ ecosystem check detected no linter changes.</p>
Linter (preview)
<p>✅ ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> approved on 2024-04-06 16:11</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">documentation</span> added by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-04-06 16:11</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_linter/src/checkers/ast/mod.rs</code>:939 on 2024-04-06 16:17</div>
            <div class="timeline-body"><pre><code>            // `in_deferred_type_definition()` will only be `true` if we&#x27;re now visiting the deferred nodes
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-04-06 16:20</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-04-06 16:28</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-04-06 16:28</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-07-01 10:29</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:03:07 UTC
    </footer>
</body>
</html>
