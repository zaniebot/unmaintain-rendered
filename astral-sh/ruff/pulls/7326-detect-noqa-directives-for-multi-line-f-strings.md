```yaml
number: 7326
title: "Detect `noqa` directives for multi-line f-strings"
type: pull_request
state: merged
author: dhruvmanila
labels:
  - suppression
  - python312
assignees: []
merged: true
base: dhruv/pep-701
head: dhruv/issue-7291
created_at: 2023-09-13T04:41:49Z
updated_at: 2023-09-28T03:58:51Z
url: https://github.com/astral-sh/ruff/pull/7326
synced_at: 2026-01-12T02:39:09Z
```

# Detect `noqa` directives for multi-line f-strings

---

_Pull request opened by @dhruvmanila on 2023-09-13 04:41_

## Summary

This PR updates the NoQA directive detection to consider the new f-string tokens.

The reason being that now there can be multi-line f-strings without triple-quotes:

```python
f"{
x
	*
		y
}"
```

Here, the `noqa` directive should go at the end of the last line.

## Test Plan

* Add new test cases for f-strings
* Tested with `--add-noqa` using the following command with the above code snippet:
	```console
	$ cargo run --bin ruff -- check --select=F821 --no-cache --isolated ~/playground/ruff/fstring.py --add-noqa
	Added 1 noqa directive.
	```

	Output:
	```python
	f"{
	x
    	*
        	y
	}"  # noqa: F821
	```
	Running the same command again doesn't add `noqa` directive and without the `--add-noqa` flag, the violation isn't reported.

fixes: #7291


---

_Comment by @dhruvmanila on 2023-09-13 04:41_

Current dependencies on/for this PR:
* main
  * **PR #7376** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7376" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a> 
    * **PR #7690** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7690" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a> 
    * **PR #7667** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7667" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a> 
    * **PR #7597** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7597" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a> 
    * **PR #7588** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7588" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a> 
      * **PR #7589** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7589" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a> 
    * **PR #7586** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7586" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a> 
    * **PR #7515** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7515" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a> 
    * **PR #7477** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7477" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a> 
    * **PR #7387** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7387" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a> 
    * **PR #7378** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7378" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a> 
    * **PR #7329** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7329" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a> 
    * **PR #7328** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7328" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a> 
    * **PR #7327** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7327" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a> 
    * **PR #7326** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7326" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a>  üëà
    * **PR #7325** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7325" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a> 

This comment was auto-generated by [Graphite](https://app.graphite.dev/github/pr/astral-sh/ruff/7326?utm_source=stack-comment).

---

_Label `python312` added by @dhruvmanila on 2023-09-13 05:12_

---

_Label `noqa` added by @dhruvmanila on 2023-09-13 05:13_

---

_Review comment by @dhruvmanila on `crates/ruff/src/directives.rs`:112 on 2023-09-14 03:06_

There's a slight performance penalty here as not many single quoted f-strings are going to be multi-line but we can't really know that until we get the entire f-string range.

---

_@dhruvmanila reviewed on 2023-09-14 03:06_

---

_Marked ready for review by @dhruvmanila on 2023-09-14 03:14_

---

_Review requested from @charliermarsh by @dhruvmanila on 2023-09-14 03:14_

---

_Review requested from @MichaReiser by @dhruvmanila on 2023-09-14 03:14_

---

_@MichaReiser reviewed on 2023-09-14 06:55_

---

_Review comment by @MichaReiser on `crates/ruff/src/directives.rs`:108 on 2023-09-14 06:55_

I would expect the noqa directive to be added on the line of `x` if x has a violation 

---

_@MichaReiser requested changes on 2023-09-14 06:56_

Please add a few tests for nested f-strings. We may also need to align on where the noqa directive should be added for expressions inside of f-strings (inside the string or outside the strings)

---

_@dhruvmanila reviewed on 2023-09-15 05:30_

---

_Review comment by @dhruvmanila on `crates/ruff/src/directives.rs`:108 on 2023-09-15 05:30_

But then it doesn't align with how it gets added with triple-quoted f-strings. In that the directive gets added on the last line of the string:

```python
f"""test{
    a
        *
            b
}test"""  # noqa: F821
```

---

_@MichaReiser reviewed on 2023-09-15 06:20_

---

_Review comment by @MichaReiser on `crates/ruff/src/directives.rs`:108 on 2023-09-15 06:20_

I would also expect this noqa to be added to the expression because it is a multiline string. 

I think there are multiple questions here that we haven't talked about

1. How should noqa comments in fstrings work in Python 3.12 forward, now that comments are allowed inside f-strings
2. Whether we want to implement the new layout now or defer to later
3. How to implement the change



---

_Comment by @codspeed-hq[bot] on 2023-09-18 17:20_

## [CodSpeed Performance Report](https://codspeed.io/astral-sh/ruff/branches/dhruv/issue-7291)

### Merging #7326 will **degrade performances by 2.57%**

<sub>Comparing <code>dhruv/issue-7291</code> (cd374e8) with <code>dhruv/pep-701</code> (1aa2390)</sub>



### Summary

`‚ö° 1` improvements
`‚ùå 1` regressions
`‚úÖ 23` untouched benchmarks



> :warning: _Please fix the performance issues or [acknowledge them on CodSpeed](https://codspeed.io/astral-sh/ruff/branches/dhruv/issue-7291)._

### Benchmarks breakdown

|     | Benchmark | `dhruv/pep-701` | `dhruv/issue-7291` | Change |
| --- | --------- | ----------------------- | ------------------- | ------ |
| ‚ùå | `linter/default-rules[pydantic/types.py]` | 38.2 ms | 39.2 ms | -2.57% |
| ‚ö° | `linter/default-rules[numpy/ctypeslib.py]` | 19.1 ms | 18.5 ms | +3.11% |


---

_Closed by @MichaReiser on 2023-09-18 19:08_

---

_Reopened by @MichaReiser on 2023-09-18 19:08_

---

_Review comment by @MichaReiser on `crates/ruff/src/directives.rs`:121 on 2023-09-18 19:13_

I wonder if we could build the fstring ranges directly from using the `fstring_ranges` instead by e.g. using `values` and filtering out overlapping ranges (should be adjacent)

---

_Review comment by @MichaReiser on `crates/ruff/src/directives.rs`:492 on 2023-09-18 19:13_

Can you add an example for nested f-strings

---

_@MichaReiser approved on 2023-09-18 19:13_

---

_@dhruvmanila reviewed on 2023-09-20 03:09_

---

_Review comment by @dhruvmanila on `crates/ruff/src/directives.rs`:121 on 2023-09-20 03:09_

Good point. This is actually how it should be done as otherwise the nested f-strings weren't handled properly.

---

_@dhruvmanila reviewed on 2023-09-20 03:10_

---

_Review comment by @dhruvmanila on `crates/ruff/src/directives.rs`:492 on 2023-09-20 03:10_

Added a test case.

---

_Merged by @dhruvmanila on 2023-09-21 02:21_

---

_Closed by @dhruvmanila on 2023-09-21 02:21_

---

_Branch deleted on 2023-09-21 02:21_

---
