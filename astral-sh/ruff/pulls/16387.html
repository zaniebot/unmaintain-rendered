<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[red-knot] fix non-callable reporting for unions - astral-sh/ruff #16387</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[red-knot] fix non-callable reporting for unions</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/16387">#16387</a>
        opened by <a href="https://github.com/carljm">@carljm</a>
        on 2025-02-26 00:48
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a></div>
            <div class="timeline-body"><p>Minor follow-up to https://github.com/astral-sh/ruff/pull/16161</p>
<p>This <code>not_callable</code> flag wasn't functional, because it could never be <code>false</code>. It was initialized to <code>true</code> and then only ever updated with <code>|=</code>, which can never make it <code>false</code>.</p>
<p>Add a test that exercises the case where it <em>should</em> be <code>false</code> (all of the union elements are callable) but <code>bindings</code> is also empty (all union elements have binding errors). Before this PR, the added test wrongly emits a diagnostic that the union <code>Literal[f1] | Literal[f2]</code> is not callable.</p>
<p>And add a test where a union call results in one binding error and one not-callable error, where we currently give the wrong result (we show only the binding error), with a TODO.</p>
<p>Also add TODO comments in a couple other tests where ideally we'd report more than just one error out of a union call.</p>
<p>Also update the flag name to <code>all_errors_not_callable</code> to more clearly indicate the semantics of the flag.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @carljm on 2025-02-26 00:48</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @AlexWaygood by @carljm on 2025-02-26 00:48</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @sharkdp by @carljm on 2025-02-26 00:48</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> approved on 2025-02-26 03:36</div>
            <div class="timeline-body"><p>Nice catch!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by @dhruvmanila on 2025-02-26 03:36</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_python_semantic/src/types/call.rs</code>:38 on 2025-02-26 07:22</div>
            <div class="timeline-body"><p>I think this is now wrong but in different ways then before?</p>
<p>If I understand this correctly, it will now return <code>not_callable</code> if one variant is not callable and the other has binding errors. What I think we want is to only return <code>not_callable</code> if all errors are not_callable.</p>
<p>So the fix might be to keep initializing the variable to <code>true</code> but change the error case to <code>not_callable &amp;= error.is_not_callable()</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-02-26 07:22</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2025-02-26 13:19</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/types/call.rs</code>:38 on 2025-02-26 13:19</div>
            <div class="timeline-body"><p>I don't think that behavior would be correct. A union with at least one not-callable element is not callable.</p>
<p>In general for any type it is always true that some inhabitants of the type may permit some behavior that the overall type does not permit. The definition of a type supporting an operation is that all inhabitants support it.</p>
<p>I would like us to offer more detailed diagnostics for not-callable unions, where we would clarify which member(s) are not callable. In that world, I do think we might want to return <code>CallError::Union</code> in more cases. But with the behavior today, where <code>CallError::Union</code> only reports one of its errors, I think it would be wrong if we ignored a not-callable error from one element and just reported a binding error from some other type in the union. So I think we need to return NotCallable if any element is not callable.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-02-26 13:58</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_python_semantic/src/types/call.rs</code>:38 on 2025-02-26 13:58</div>
            <div class="timeline-body"><p>I suspect that this will lead to worse diagnostics overall because we then end up saying that the type isn't callable instead of saying which variant isn't callable.</p>
<p>I can't argue on what this means on the type inference level but your original implementation only returned <code>NotCallable</code> if all variants weren't callable, unless I'm misreading the implementation:</p>
<p>https://github.com/astral-sh/ruff/blob/792f9e357ee21a23113aba75e36c8e1ca47fa386/crates/red_knot_python_semantic/src/types/call.rs#L240-L282</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/types/call.rs</code>:38 on 2025-02-26 14:22</div>
            <div class="timeline-body"><blockquote>
<p>your original implementation only returned <code>NotCallable</code> if all variants weren't callable, unless I'm misreading the implementation</p>
</blockquote>
<p>Both branches in the linked original implementation return <code>NotCallableError</code>, whether some or all elements are not callable. The only difference is whether we return a &quot;simple&quot; <code>NotCallableError</code> (because if all elements are not callable, we don't really need to give more details) or a &quot;union&quot; <code>NotCallableError</code> (because we want to clarify which elements are not callable.)</p>
<blockquote>
<p>we then end up saying that the type isn't callable instead of saying which variant isn't callable.</p>
</blockquote>
<p>I agree. The core problem here is the current handling of <code>CallError::Union</code> only reporting one of its errors. This means that in a case where we have one binding error and one not-callable in a union, might decide to just report the binding error and ignore the not-callable error. That's the wrong result I aimed to avoid with this change. In that case I would much rather see a not-callable error on the entire union, than a wrong-arguments error for the one callable element.</p>
<p>We can go ahead and return <code>CallError::Union</code> for that case. It will just increase the priority of better diagnostics for <code>CallError::Union</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2025-02-26 14:22</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-02-26 14:27</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_python_semantic/src/types/call.rs</code>:38 on 2025-02-26 14:27</div>
            <div class="timeline-body"><p>I'd prefer keeping returning <code>Union</code> because it already forces the right handling in all upstream code.</p>
<p>Fixing the diagnostic is an issue on its own where we may want to be more clever about how we handle different errors (I don't think rendering all errors is a good idea but we could sort the errors and e.g. report not callable first)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-02-26 14:30</div>
            <div class="timeline-body"><p>I'm not sure whether it counts as an alternative solution or a workaround, but did you see what I did with this in my <code>Type::try_iterate()</code> PR the other day? I added this method:</p>
<p>https://github.com/astral-sh/ruff/blob/dd6f6233bd469ddc9296c1ebd7cdb845233c93b1/crates/red_knot_python_semantic/src/types/call.rs#L175-L195</p>
<p>And then emitted different diagnostics for the <code>CallError::Union()</code> branch depending on whether it returned <code>true</code> or <code>false</code>:</p>
<p>https://github.com/astral-sh/ruff/blob/dd6f6233bd469ddc9296c1ebd7cdb845233c93b1/crates/red_knot_python_semantic/src/types.rs#L3032-L3071</p>
<p>It's finicky, but it seems to work pretty well</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-02-26 14:34</div>
            <div class="timeline-body"><p>@AlexWaygood Yes, we could do that here as well. But I think it's also sub-optimal that given multiple binding errors from a union, we only report one of them. So I think I'd rather just wait for a more full-fledged diagnostic system that allows sub-diagnostics, and then update the <code>CallError::Union</code> handling more comprehensively.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2025-02-26 14:43</div>
            <div class="timeline-body"><p>Thank you</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @carljm on 2025-02-26 15:06</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @carljm on 2025-02-26 15:06</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-02-26 15:06</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:10:21 UTC
    </footer>
</body>
</html>
