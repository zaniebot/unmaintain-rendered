<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[`pyupgrade`] Handle comments and multiline expressions correctly (`UP037`) - astral-sh/ruff #15337</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[<code>pyupgrade</code>] Handle comments and multiline expressions correctly (<code>UP037</code>)</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/15337">#15337</a>
        opened by <a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a>
        on 2025-01-08 07:30
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a></div>
            <div class="timeline-body">Summary
<p>Resolves #7102.</p>
Test Plan
<p><code>cargo nextest run</code> and <code>cargo insta test</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-01-08 07:36</div>
            <div class="timeline-body">

<code>ruff-ecosystem</code> results
Linter (stable)
<p>✅ ecosystem check detected no linter changes.</p>
Linter (preview)
<p>✅ ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/pyupgrade/rules/quoted_annotation.rs</code>:80 on 2025-01-08 14:18</div>
            <div class="timeline-body"><pre><code>    let placeholder_range = TextRange::up_to(annotation.text_len());
    let spans_multiple_lines = annotation.count_lines(placeholder_range) &gt; 1;
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/pyupgrade/snapshots/ruff_linter__rules__pyupgrade__tests__UP037_2.pyi.snap</code>:87 on 2025-01-08 14:36</div>
            <div class="timeline-body"><p>Are we adding the parentheses in case the quoted annotation is in an unquoted context (e.g. annotated assignment)? Would it be possible to reduce the cases in which we add the parentheses?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/pyupgrade/rules/quoted_annotation.rs</code>:81 on 2025-01-08 14:36</div>
            <div class="timeline-body"><pre><code>    let spans_multiple_lines = annotation.contains_line_break(placeholder_range);
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-01-08 14:36</div>
            <div class="timeline-body"><p>Sweet</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">fixes</span> added by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-01-08 14:37</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a> reviewed on 2025-01-08 15:09</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a> on <code>crates/ruff_linter/src/rules/pyupgrade/snapshots/ruff_linter__rules__pyupgrade__tests__UP037_2.pyi.snap</code>:87 on 2025-01-08 15:09</div>
            <div class="timeline-body"><p>Here&#x27;s an(other) edge case where parentheses are necessary:</p>
<pre><code>def f(a: &#x27;&#x27;&#x27;
	list[int]
&#x27;&#x27;&#x27; = []): ...
</code></pre>
<p>As for reducing, that would require some complex parsing logic. For example, here are two valid annotations that cannot simply be unquoted:</p>
<pre><code>a: &#x27;&#x27;&#x27;list
[int]&#x27;&#x27;&#x27; = [42]

a: &#x27;&#x27;&#x27;\\
list[int]&#x27;&#x27;&#x27; = [42]
</code></pre>
<p>All of these have been added as testcases.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-01-08 16:58</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/pyupgrade/snapshots/ruff_linter__rules__pyupgrade__tests__UP037_2.pyi.snap</code>:87 on 2025-01-08 16:58</div>
            <div class="timeline-body"><p>That makes sense. I&#x27;m suggesting adding a simple check that detects if we&#x27;re currently in a parenthesized context (e.g., is this an annotation for a parameter, is the parent a subscript, ...) and, if so, avoid adding the parentheses.</p>
<p>Because this</p>
<pre><code>def f(a: &#x27;&#x27;&#x27; 
	list[int]
	 &#x27;&#x27;&#x27; = []): ...
</code></pre>
<p>can be safely rewritten to, without the need for extra parentheses:</p>
<pre><code>def f(a: 
	list[int]
	 = []): ...
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-01-10 07:46</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-01-10 07:46</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-01-10 09:39</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:10:06 UTC
    </footer>
</body>
</html>
