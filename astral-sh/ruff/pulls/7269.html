<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bool expression comment placement - astral-sh/ruff #7269</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Bool expression comment placement</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/7269">#7269</a>
        opened by <a href="https://github.com/MichaReiser">@MichaReiser</a>
        on 2023-09-11 13:31
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-09-11 13:31</div>
            <div class="timeline-body"><h2>Summary</h2>
<p>This PR fixes all comment placement issues for boolean expression (<code>and</code>, <code>or</code>) for the django project by</p>
<p>a) Rewriting the boolean expression formatting to use the BinaryLike formatting to get consistent formatting for all binary like expressions
b) Making <code>a\n # comment\n and b</code> a trailing comment of <code>a</code> the same as for binary expressions
c) Respecting whether a comment was inside or outside of the parentheses when formatting a parenthesized expression.</p>
<p>Closes #7004
Closes #6062</p>
<h2>Test Plan</h2>
<p>Added tests</p>
<p><strong>this PR</strong></p>
<p>| project      | similarity index  | total files       | changed files     |
|--------------|------------------:|------------------:|------------------:|
| <strong>cpython</strong>      |           0.76084 |              1789 |              1632 | :)
| <strong>django</strong>       |           0.99979 |              2760 |                45 | :)
| <strong>transformers</strong> |           0.99944 |              2587 |               413 | :)
| twine        |           1.00000 |                33 |                 0 | -
| typeshed     |           0.99978 |              3496 |              2173 |
| <strong>warehouse</strong>    |           0.99834 |               648 |                20 | :)
| <strong>zulip</strong>        |           0.99956 |              1437 |                23 | :)</p>
<p><strong>main</strong>
| project      | similarity index  | total files       | changed files     |
|--------------|------------------:|------------------:|------------------:|
| cpython      |           0.76083 |              1789 |              1632 |
| django       |           0.99966 |              2760 |                58 |
| transformers |           0.99930 |              2587 |               447 |
| twine        |           1.00000 |                33 |                 0 |
| typeshed     |           0.99978 |              3496 |              2173 |
| warehouse    |           0.99825 |               648 |                22 |
| zulip        |           0.99950 |              1437 |                27 |</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-09-11 13:31</div>
            <div class="timeline-body"><p>Current dependencies on/for this PR:</p>
<ul>
<li>main<ul>
<li><strong>PR #7269</strong> <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7269" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a>  üëà</li>
</ul>
</li>
</ul>
<p>This comment was auto-generated by <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7269?utm_source=stack-comment">Graphite</a>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">formatter</span> added by @MichaReiser on 2023-09-11 13:33</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @konstin by @MichaReiser on 2023-09-11 13:37</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @MichaReiser on 2023-09-11 13:38</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff_python_formatter/resources/test/fixtures/ruff/expression/boolean_operation.py</code>:123 on 2023-09-11 13:41</div>
            <div class="timeline-body"><p>can you shrink those examples a bit?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff_python_formatter/src/comments/placement.rs</code>:843 on 2023-09-11 14:18</div>
            <div class="timeline-body"><pre><code class="language-suggestion">/// Attach own line comments before an `and` or `or` in a binary expression to the preceding operand.
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff_python_formatter/src/expression/binary_like.rs</code>:635 on 2023-09-11 14:19</div>
            <div class="timeline-body"><p>nit: consider moving this case into its own function</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff_python_formatter/src/expression/binary_like.rs</code>:642 on 2023-09-11 14:43</div>
            <div class="timeline-body"><p>Does rposition still do the right thing with multiple parentheses?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff_python_formatter/src/expression/binary_like.rs</code>:644 on 2023-09-11 14:44</div>
            <div class="timeline-body"><p>this logic is hard to follow, could you add comment(s)? i think is works like below</p>
<pre><code>z = (
# a
(
# b: this is the comment we extract
(
# c
x and y
))))
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> approved on 2023-09-11 14:47</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2023-09-11 14:48</div>
            <div class="timeline-body"><p>nice work on the compatibility!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-09-12 06:04</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/expression/binary_like.rs</code>:642 on 2023-09-12 06:04</div>
            <div class="timeline-body"><p>I added a new test to <code>binary.py</code>. Whether it is subjective:</p>
<pre><code>(
               # comment
               (1 &lt;&lt; (n + i-j + n-1))) # NW-SE ordinal
</code></pre>
<p>The <code># comment</code> gets moved out of the parentheses because the formatter removes the unnecessary outer most parentheses.</p>
<pre><code class="language-python">    # comment
    (1 &lt;&lt; (n + i - j + n - 1))  # NW-SE ordinal
</code></pre>
<p>I think that's fine and the result is stable.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/codspeed-hq[bot]">@codspeed-hq[bot]</a> on 2023-09-12 06:32</div>
            <div class="timeline-body"><h2><a href="https://codspeed.io/astral-sh/ruff/branches/bool-op-binary-like">CodSpeed Performance Report</a></h2>
<h3>Merging #7269 will <strong>degrade performances by 3.73%</strong></h3>
<p><sub>Comparing <code>bool-op-binary-like</code> (6ffae39) with <code>main</code> (babf8d7)</sub></p>
<h3>Summary</h3>
<p><code>‚ùå 5 (üëÅ 5)</code> regressions
<code>‚úÖ 20</code> untouched benchmarks</p>
<h3>Benchmarks breakdown</h3>
<p>|     | Benchmark | <code>main</code> | <code>bool-op-binary-like</code> | Change |
| --- | --------- | ----------------------- | ------------------- | ------ |
| üëÅ | <code>linter/all-rules[numpy/ctypeslib.py]</code> | 33.5 ms | 34.5 ms | -3.01% |
| üëÅ | <code>linter/all-rules[unicode/pypinyin.py]</code> | 15.2 ms | 15.7 ms | -2.89% |
| üëÅ | <code>linter/all-rules[pydantic/types.py]</code> | 70 ms | 72.3 ms | -3.14% |
| üëÅ | <code>linter/all-rules[large/dataset.py]</code> | 156.9 ms | 162.9 ms | -3.73% |
| üëÅ | <code>linter/all-rules[numpy/globals.py]</code> | 4 ms | 4.1 ms | -2.6% |</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @MichaReiser on 2023-09-12 06:39</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @MichaReiser on 2023-09-12 06:39</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2023-09-12 06:39</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2023-09-12 07:06</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff_python_formatter/src/expression/binary_like.rs</code>:838 on 2023-09-12 07:06</div>
            <div class="timeline-body"><p>thanks! :100:</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 02:46:16 UTC
    </footer>
</body>
</html>
