<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[`ruff`] Fix false positive on global keyword (`RUF052`) - astral-sh/ruff #15235</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[<code>ruff</code>] Fix false positive on global keyword (<code>RUF052</code>)</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/15235">#15235</a>
        opened by <a href="https://github.com/Garrett-R">@Garrett-R</a>
        on 2025-01-03 05:08
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Garrett-R">@Garrett-R</a></div>
            <div class="timeline-body">Summary
<p>Fixes #14996.</p>
<p>BTW, the issue correctly reports a false positive given that <a href="https://docs.astral.sh/ruff/rules/used-dummy-variable/#why-is-this-bad">the docs</a> say &quot;Only local variables in function scopes are flagged by the rule&quot;.</p>
Test Plan
<p>I added the false positive to the fixture and verified it indeed caused a false positive before my fix was done.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Garrett-R">@Garrett-R</a> reviewed on 2025-01-03 05:10</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/Garrett-R">@Garrett-R</a> on <code>crates/ruff_linter/resources/test/fixtures/ruff/RUF052.py</code>:1 on 2025-01-03 05:10</div>
            <div class="timeline-body"><p>This might be just personal taste, so happy to remove!</p>
<p>But when I saw just <code># Correct</code>, I wasn&#x27;t sure if that was demarcating a section of code.  I personally find this more clear.</p>
<p>EDIT: should probably use blocker header format (otherwise conflicts with <a href="https://docs.astral.sh/ruff/rules/multiple-leading-hashes-for-block-comment/">E266</a>).</p>
<p>EDIT 2: updated to block header format, resolving</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Garrett-R">@Garrett-R</a> reviewed on 2025-01-03 05:15</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/Garrett-R">@Garrett-R</a> on <code>crates/ruff_linter/resources/test/fixtures/ruff/RUF052.py</code>:50 on 2025-01-03 05:15</div>
            <div class="timeline-body"><p>Note: I inserted the test here into the <code># Correct</code> section, seemed right thing to do.</p>
<p>But given it&#x27;s not being at the end of this file, it means I got some large diffs in the fixture files.  I reviewed the diffs and there&#x27;s no &quot;real&quot; changes to them, as expected.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Garrett-R">@Garrett-R</a> reviewed on 2025-01-03 05:17</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/Garrett-R">@Garrett-R</a> on <code>crates/ruff_linter/resources/test/fixtures/ruff/RUF052.py</code>:42 on 2025-01-03 05:17</div>
            <div class="timeline-body"><p>(am I overcommenting? I was just worried that it might not be clear that this is a single &quot;test&quot; spread across 2 functions, but happy to remove)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-01-03 05:18</div>
            <div class="timeline-body">

<code>ruff-ecosystem</code> results
Linter (stable)
<p>✅ ecosystem check detected no linter changes.</p>
Linter (preview)
<p>✅ ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by <a href="https://github.com/Garrett-R">@Garrett-R</a> on 2025-01-03 05:20</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_semantic/src/model.rs</code>:1501 on 2025-01-03 09:03</div>
            <div class="timeline-body"><p>I don&#x27;t think this is the right fix. The binding pushed here is for the variable <code>_x</code> in the global scope. But <code>_x</code> isn&#x27;t considered a global-binding in the global scope. It is only when used in a nested scope. For example, the checker explicitly skips over the global handling when in the global scope here</p>
<p>https://github.com/astral-sh/ruff/blob/d4ee6abf4aef3615540a4a84f16edf5e05541622/crates/ruff_linter/src/checkers/ast/mod.rs#L657-L677</p>
<p>But I think you&#x27;re on the right track. What I find suspicious (and changing it fixes the bug as well) is that <code>scope</code> is <code>self.scope_id</code> but we add the binding to <code>self.global_scope_mut</code>. That&#x27;s why I think it should actually be <code>ScopeId::global()</code> instead. But I&#x27;d like a confirmation from @charliermarsh  on this change</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-01-03 09:03</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/charliermarsh">@charliermarsh</a> by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-01-03 09:04</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-01-10 14:51</div>
            <div class="timeline-body"><p>@charliermarsh would you mind taking a look at my comment so that we can move forward with this PR?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2025-01-13 01:54</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_python_semantic/src/model.rs</code>:1501 on 2025-01-13 01:54</div>
            <div class="timeline-body"><p>(Yes, sorry, will take a look.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2025-01-13 02:07</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_python_semantic/src/model.rs</code>:1501 on 2025-01-13 02:07</div>
            <div class="timeline-body"><p>Hmm... I guess <code>ScopeId::global()</code> seems right? We should have decent test coverage here, so if we change that and it passes tests, I&#x27;d assume it&#x27;s correct.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-01-13 07:56</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_semantic/src/model.rs</code>:1501 on 2025-01-13 07:56</div>
            <div class="timeline-body"><p>Thank you. @Garrett-R do you mind changing your PR accordingly?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Garrett-R">@Garrett-R</a> reviewed on 2025-01-14 05:33</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/Garrett-R">@Garrett-R</a> on <code>crates/ruff_linter/src/rules/ruff/snapshots/ruff_linter__rules__ruff__tests__RUF052_RUF052.py.snap</code>:1 on 2025-01-14 05:33</div>
            <div class="timeline-body"><p>Note: I&#x27;ve reviewed the 3 snapshot files.  As expected they have no &quot;real&quot; changes, just line numbers changing.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Garrett-R">@Garrett-R</a> reviewed on 2025-01-14 05:35</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/Garrett-R">@Garrett-R</a> on <code>crates/ruff_python_semantic/src/model.rs</code>:1501 on 2025-01-14 05:35</div>
            <div class="timeline-body"><p>@MichaReiser thank you for that explanation, super helpful!</p>
<p>Ok, I&#x27;ve updated the PR.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/MichaReiser">@MichaReiser</a> by <a href="https://github.com/Garrett-R">@Garrett-R</a> on 2025-01-14 05:35</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2025-01-14 07:36</div>
            <div class="timeline-body"><p>Thanks</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-01-14 07:36</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-01-14 07:36</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-01-14 07:36</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-01-14 16:03</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:09:56 UTC
    </footer>
</body>
</html>
