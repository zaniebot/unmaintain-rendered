<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[airflow]: Import modules that has been moved to airflow providers (AIR303) - astral-sh/ruff #14764</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[airflow]: Import modules that has been moved to airflow providers (AIR303)</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/14764">#14764</a>
        opened by <a href="https://github.com/Lee-W">@Lee-W</a>
        on 2024-12-04 05:00
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Lee-W">@Lee-W</a></div>
            <div class="timeline-body">

Summary


<p>Many core Airflow features have been deprecated and moved to Airflow Providers since users might need to install an additional package (e.g., <code>apache-airflow-provider-fab==1.0.0</code>); a separate rule (AIR303) is created for this.</p>
<p>As some of the changes only relate to the module/package moved, instead of listing out all the functions, variables, and classes in a module or a package, it warns the user to import from the new path instead of the specific name.</p>
<p>The following is the ones that has been moved to <code>apache-airflow-provider-fab==1.0.0</code></p>
<ul>
<li>module moved<ul>
<li><code>airflow.api.auth.backend.basic_auth</code> ‚Üí <code>airflow.providers.fab.auth_manager.api.auth.backend.basic_auth</code></li>
<li><code>airflow.api.auth.backend.kerberos_auth</code> ‚Üí <code>airflow.providers.fab.auth_manager.api.auth.backend.kerberos_auth</code></li>
<li><code>airflow.auth.managers.fab.api.auth.backend.kerberos_auth</code> ‚Üí <code>airflow.providers.fab.auth_manager.api.auth.backend.kerberos_auth</code></li>
<li><code>airflow.auth.managers.fab.security_manager.override</code> ‚Üí <code>airflow.providers.fab.auth_manager.security_manager.override</code></li>
</ul>
</li>
<li>classes (e.g., functions, classes) moved<ul>
<li><code>airflow.www.security.FabAirflowSecurityManagerOverride</code> ‚Üí <code>airflow.providers.fab.auth_manager.security_manager.override.FabAirflowSecurityManagerOverride</code></li>
<li><code>airflow.auth.managers.fab.fab_auth_manager.FabAuthManager</code> ‚Üí <code>airflow.providers.fab.auth_manager.security_manager.FabAuthManager</code></li>
</ul>
</li>
</ul>
<p>https://github.com/astral-sh/ruff/pull/14764</p>

    How to contribute to AIR303

Browse the airflow / ruff migration guideline
<p><a href="https://hackmd.io/@uranusjr/ByyCA_-m1l">How to create a Ruff lint rule for Airflow 2-to-3 migrations</a></p>
Setup local development environment
<pre><code>cargo install cargo-insta

uv tool install pre-commit
pre-commit install

cargo install cargo-nextest --locked
</code></pre>
<p><a href="https://docs.astral.sh/ruff/contributing/">Contributing to Ruff</a></p>
Check the existing rules from airflow issue
<p>All the ruff rules are listed down in <a href="https://github.com/apache/airflow/issues/44556">Airflow 2 to 3 auto migration rules - ruff #44556</a></p>
<p>Go to <code>AIR303: moved to provider</code> in the issue description and you&#x27;ll find rules like</p>
<pre><code>* `airflow.www.security.FabAirflowSecurityManagerOverride` ‚Üí `airflow.providers.fab.auth_manager.security_manager.override.FabAirflowSecurityManagerOverride` (from <a href="https://github.com/apache/airflow/pull/41758">apache/airflow#41758</a>)
</code></pre>
<p>It means <code>airflow.www.security.FabAirflowSecurityManagerOverride</code> has been moved to airflow provider and the import should be changed to <code>airflow.providers.fab.auth_manager.security_manager.override.FabAirflowSecurityManagerOverride</code>. This changed is made in <a href="https://github.com/apache/airflow/pull/41758">apache/airflow#41758</a></p>
<p>Some of the rules might not be correct, so checking the pull request again is suggested.</p>
Add a new rule
<p>Go to <code>crates/ruff_linter/src/rules/airflow/rules/moved_to_provider_in_3.rs</code></p>
<p>In function <code>moved_to_provider</code>, add code section like the following</p>
<pre><code>                [&quot;airflow&quot;, &quot;www&quot;, &quot;security&quot;, &quot;FabAirflowSecurityManagerOverride&quot;] =&gt; Some((
                    qualname.to_string(),
                    Replacement::ProviderName {
                        name: &quot;airflow.providers.fab.auth_manager.security_manager.override.FabAirflowSecurityManagerOverride&quot;,
                        provider: &quot;fab&quot;,
                        version: &quot;1.0.0&quot;
                    },
                )),
</code></pre>
<ul>
<li><code>&quot;airflow&quot;, &quot;www&quot;, &quot;security&quot;, &quot;FabAirflowSecurityManagerOverride&quot;</code>: the deprecated import path</li>
<li><code>name</code> is the new name that should be used.</li>
<li><code>provider</code> is which provider this name has been moved to.</li>
<li><code>version</code> is the first version of the provider that has been moved to.</li>
</ul>
<p>For rules like</p>
<pre><code>* [ ] `airflow.api.auth.backend.basic_auth` ‚Üí `airflow.providers.fab.auth_manager.api.auth.backend.basic_auth` (from <a href="https://github.com/apache/airflow/pull/41663">apache/airflow#41663</a>)
</code></pre>
<p>The whole module/pacakge has been moved to the provider. Thus, we&#x27;ll need to warn the users when something is imported from the old path instead.</p>
<pre><code>                [&quot;airflow&quot;, &quot;api&quot;, &quot;auth&quot;, &quot;backend&quot;, &quot;basic_auth&quot;, ..] =&gt; Some((
                    qualname.to_string(),
                    Replacement::ImportPathMoved{
                        original_path: &quot;airflow.api.auth.backend.basic_auth&quot;,
                        new_path: &quot;airflow.providers.fab.auth_manager.api.auth.backend.basic_auth&quot;,
                        provider:&quot;fab&quot;,
                        version: &quot;1.0.0&quot;
                },
                )),
</code></pre>
<ul>
<li><code>&quot;airflow&quot;, &quot;api&quot;, &quot;auth&quot;, &quot;backend&quot;, &quot;basic_auth&quot;, ..</code>: anything under this import path</li>
<li><code>original path</code></li>
<li><code>new path</code>: new import path in the provider</li>
<li><code>provider</code> is which provider this name has been moved to.</li>
<li><code>version</code> is the first version of the provider that has been moved to.</li>
</ul>
Add test case
<p>Add a case that violate this rule to <code>crates/ruff_linter/resources/test/fixtures/airflow/AIR303.py</code></p>
Test and generate snapshop to review
<pre><code>cargo insta test
cargo insta review
</code></pre>
Now you&#x27;re ready to create a pull request


Test Plan


<p>A test fixture has been included for the rule.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from &quot;feat(AIR303): initial air303&quot; to &quot;[airflow]: Import modules that has been moved to airflow providers (AIR303)&quot; by <a href="https://github.com/Lee-W">@Lee-W</a> on 2024-12-04 05:00</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2024-12-09 03:06</div>
            <div class="timeline-body">

<code>ruff-ecosystem</code> results
Linter (stable)
<p>‚úÖ ecosystem check detected no linter changes.</p>
Linter (preview)
<p>‚úÖ ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by <a href="https://github.com/Lee-W">@Lee-W</a> on 2024-12-10 11:05</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Lee-W">@Lee-W</a> on 2024-12-11 05:11</div>
            <div class="timeline-body"><p>@MichaReiser would love to know whether the overall idea of this PR makes sense if you have some time. I plan on writing a guideline for folks from the airflow community to contribute to AIR303 more easily. üôÇ</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2024-12-11 06:47</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_linter/src/rules/airflow/snapshots/ruff_linter__rules__airflow__tests__AIR303_AIR303.py.snap</code>:13 on 2024-12-11 06:47</div>
            <div class="timeline-body"><p>I think this is a pretty long message, it might be useful to break it down into two parts - the description and the suggestion. For the description we can avoid the entire import path and just provide the symbol name itself while for the help text we can guide the user to install the provider and use the provider namespace for the symbol. For example:</p>
<pre><code>AIR303.py:10:1: AIR303 `basic_auth` will be moved into `fab` provider in Airflow 3.0
   |
 8 | from airflow.www.security import FabAirflowSecurityManagerOverride
 9 | 
10 | basic_auth, kerberos_auth
   | ^^^^^^^^^^ AIR303
11 | auth_current_user
12 | backend_kerberos_auth
   |
   = help: Install `apache-airflow-provider-fab` and import from `airflow.providers.fab` instead
</code></pre>
<p>The help text is rendered using the <code>fix_title</code> method: https://github.com/astral-sh/ruff/blob/a3bb0cd5ec4d4dffea5d42d184e8c4a062976663/crates/ruff_linter/src/rules/airflow/rules/removal_in_3.rs#L65-L72</p>
<p>I&#x27;m also a bit worried about the version number for the package, I&#x27;d prefer to omit them as it can get outdated pretty quickly.</p>
<p>Curious to know your thoughts on this :)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-12-11 06:51</div>
            <div class="timeline-body"><p>Is it correct that the entire module itself has been moved to being used as a provider without changing any of the public symbols available in that module? i.e., are the symbols that were available in the old module the same as that in the provider module? If so, we could consider the rule to work on the module instead of individual symbols from the module and suggest to use the provider instead. That way we&#x27;ll only emit a single diagnostic for the entire module which will be the import statement.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">rule</span> added by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-12-11 06:51</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">preview</span> added by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-12-11 06:51</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Lee-W">@Lee-W</a> on 2024-12-11 06:57</div>
            <div class="timeline-body"><blockquote>
<p>Is it correct that the entire module itself has been moved to being used as a provider without changing any of the public symbols available in that module? i.e., are the symbols that were available in the old module the same as that in the provider module?</p>
</blockquote>
<p>Yep, that&#x27;s what I think for some of the modules, but I&#x27;ll confirm it again.</p>
<blockquote>
<p>If so, we could consider the rule to work on the module instead of individual symbols from the module and suggest to use the provider instead. That way we&#x27;ll only emit a single diagnostic for the entire module which will be the import statement.</p>
</blockquote>
<p>Yep, some of the modules can be done this way, but others might not, so that why I&#x27;d like to keep the individual symbols check as well</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Lee-W">@Lee-W</a> reviewed on 2024-12-11 07:00</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/Lee-W">@Lee-W</a> on <code>crates/ruff_linter/src/rules/airflow/snapshots/ruff_linter__rules__airflow__tests__AIR303_AIR303.py.snap</code>:13 on 2024-12-11 07:00</div>
            <div class="timeline-body"><blockquote>
<p>I&#x27;m also a bit worried about the version number for the package, I&#x27;d prefer to omit them as it can get outdated pretty quickly.</p>
</blockquote>
<p>One of my worries is that it might be removed in the future ü§î (unlikely, but still possible I think)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-12-11 07:01</div>
            <div class="timeline-body"><blockquote>
<p>Yep, some of the modules can be done this way, but others might not, so that why I&#x27;d like to keep the individual symbols check as well</p>
</blockquote>
<p>That&#x27;s sounds reasonable.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/airflow/rules/moved_to_provider_in_3.rs</code>:22 on 2024-12-11 07:28</div>
            <div class="timeline-body"><p>Do you for see cases where any of the strings are dynamic (contain e.g. an expression)? I&#x27;d otherwise suggest to use <code>&amp;&#x27;static str</code> here to avoid the annoying <code>to_string</code> calls and reduce the amount of allocations</p>
<pre><code>enum Replacement {
    ProviderName(&amp;&#x27;static str, &amp;&#x27;static str &amp;&#x27;static str),
    ImportPathMoved(&amp;&#x27;static str, &amp;&#x27;static str, &amp;&#x27;static str, &amp;&#x27;static str),
}
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/airflow/rules/moved_to_provider_in_3.rs</code>:22 on 2024-12-11 07:29</div>
            <div class="timeline-body"><p>I&#x27;d prefer if we use variants with named fields. It&#x27;s kind of hard to guess what the 4 Strings in <code>ImportPathMoved</code> mean</p>
<pre><code>enum Replacement {
    ProviderName { name: String, provider_name: String, version: String},
    ImportPathMoved { original_path: String, new_path: String, provider_name: String, provider_version: String },
}
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/airflow/snapshots/ruff_linter__rules__airflow__tests__AIR303_AIR303.py.snap</code>:13 on 2024-12-11 07:31</div>
            <div class="timeline-body"><blockquote>
<p>I&#x27;m also a bit worried about the version number for the package, I&#x27;d prefer to omit them as it can get outdated pretty quickly.</p>
</blockquote>
<p>Agree. What&#x27;s the motivation for including the version? Is it because they need a specific minimal version?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2024-12-11 07:34</div>
            <div class="timeline-body"><blockquote>
<p>writing a guideline for folks from the airflow community to contribute to AIR303 more easily.</p>
</blockquote>
<p>This sounds great. I&#x27;d appreciate your with reviewing and coordinating the PRs as you have the most knowledge about what the rules should cover.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Lee-W">@Lee-W</a> reviewed on 2024-12-11 07:36</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/Lee-W">@Lee-W</a> on <code>crates/ruff_linter/src/rules/airflow/snapshots/ruff_linter__rules__airflow__tests__AIR303_AIR303.py.snap</code>:13 on 2024-12-11 07:36</div>
            <div class="timeline-body"><blockquote>
<p>Agree. What&#x27;s the motivation for including the version? Is it because they need a specific minimal version?</p>
</blockquote>
<p>Yep, some module moves might not happen in the <code>1.0.0</code> version of that provider.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Lee-W">@Lee-W</a> reviewed on 2024-12-11 07:37</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/Lee-W">@Lee-W</a> on <code>crates/ruff_linter/src/rules/airflow/rules/moved_to_provider_in_3.rs</code>:22 on 2024-12-11 07:37</div>
            <div class="timeline-body"><p>I guess not ü§î  Thanks for your suggestion! I&#x27;ll change it this way. we can change it back if we really need to do that.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Lee-W">@Lee-W</a> reviewed on 2024-12-11 07:39</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/Lee-W">@Lee-W</a> on <code>crates/ruff_linter/src/rules/airflow/rules/moved_to_provider_in_3.rs</code>:22 on 2024-12-11 07:39</div>
            <div class="timeline-body"><p>Sure! can&#x27;t believe I missed it ü§¶‚Äç‚ôÇÔ∏è Thanks for your suggestion! Will update it</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Lee-W">@Lee-W</a> on 2024-12-11 07:39</div>
            <div class="timeline-body"><blockquote>
<blockquote>
<p>writing a guideline for folks from the airflow community to contribute to AIR303 more easily.</p>
</blockquote>
<p>This sounds great. I&#x27;d appreciate your with reviewing and coordinating the PRs as you have the most knowledge about what the rules should cover.</p>
</blockquote>
<p>Will do üëç</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2024-12-11 08:19</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_linter/src/rules/airflow/snapshots/ruff_linter__rules__airflow__tests__AIR303_AIR303.py.snap</code>:13 on 2024-12-11 08:19</div>
            <div class="timeline-body"><p>We could potentially use <code>&gt;=1.0.0,&lt;2</code> presuming that the changes follow semantic versioning. The <code>1.0.0</code> can be updated to the provider version in which the change takes place.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Lee-W">@Lee-W</a> reviewed on 2024-12-11 08:20</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/Lee-W">@Lee-W</a> on <code>crates/ruff_linter/src/rules/airflow/snapshots/ruff_linter__rules__airflow__tests__AIR303_AIR303.py.snap</code>:13 on 2024-12-11 08:20</div>
            <div class="timeline-body"><p>sounds good! this is a great suggestion!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-12-11 08:24</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/airflow/snapshots/ruff_linter__rules__airflow__tests__AIR303_AIR303.py.snap</code>:13 on 2024-12-11 08:24</div>
            <div class="timeline-body"><p>I&#x27;m not sure about the upper bound. It would require us to update the rule if a new provider version gets released. Maybe just mention <em>newer than x.x.x</em></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Lee-W">@Lee-W</a> reviewed on 2024-12-11 08:26</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/Lee-W">@Lee-W</a> on <code>crates/ruff_linter/src/rules/airflow/snapshots/ruff_linter__rules__airflow__tests__AIR303_AIR303.py.snap</code>:13 on 2024-12-11 08:26</div>
            <div class="timeline-body"><p>After a second thought, yep, it would make things easier, <code>&gt;=1.0.0</code> sounds like a good enough solution ü§î</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Lee-W">@Lee-W</a> reviewed on 2024-12-13 09:18</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/Lee-W">@Lee-W</a> on <code>crates/ruff_linter/src/rules/airflow/snapshots/ruff_linter__rules__airflow__tests__AIR303_AIR303.py.snap</code>:13 on 2024-12-13 09:18</div>
            <div class="timeline-body"><p>Updated!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Lee-W">@Lee-W</a> reviewed on 2024-12-13 09:18</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/Lee-W">@Lee-W</a> on <code>crates/ruff_linter/src/rules/airflow/rules/moved_to_provider_in_3.rs</code>:22 on 2024-12-13 09:18</div>
            <div class="timeline-body"><p>fixed. Thanks!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Lee-W">@Lee-W</a> reviewed on 2024-12-13 09:19</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/Lee-W">@Lee-W</a> on <code>crates/ruff_linter/src/rules/airflow/rules/moved_to_provider_in_3.rs</code>:22 on 2024-12-13 09:19</div>
            <div class="timeline-body"><p>fixed. Thanks!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2024-12-13 09:37</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-12-13 09:38</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-12-13 09:38</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-12-18 00:07</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:09:10 UTC
    </footer>
</body>
</html>
