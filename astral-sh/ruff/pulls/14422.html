<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[red-knot] Refactoring the inference logic of lexicographic comparisons - astral-sh/ruff #14422</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[red-knot] Refactoring the inference logic of lexicographic comparisons</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/14422">#14422</a>
        opened by <a href="https://github.com/cake-monotone">@cake-monotone</a>
        on 2024-11-18 03:25
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/cake-monotone">@cake-monotone</a></div>
            <div class="timeline-body">

Summary
<p>closes #14279</p>
Limitations of the Current Implementation
Incorrect Error Propagation
<p>In the current implementation of lexicographic comparisons, if the result of an Eq operation is Ambiguous, the comparison stops immediately, returning a bool instance. While this may yield correct inferences, it fails to capture unsupported-operation errors that might occur in subsequent comparisons.</p>
<pre><code>class A: ...

(int_instance(), A()) &lt; (int_instance(), A())  # should error
</code></pre>
Weak Inference in Specific Cases
<blockquote>
<p>Example: <code>(int_instance(), &quot;foo&quot;) == (int_instance(), &quot;bar&quot;)</code>
Current result: <code>bool</code>
Expected result: <code>Literal[False]</code></p>
</blockquote>
<p><code>Eq</code> and <code>NotEq</code> have unique behavior in lexicographic comparisons compared to other operators. Specifically:</p>
<ul>
<li>For <code>Eq</code>, if any non-equal pair exists within the tuples being compared, we can immediately conclude that the tuples are not equal.</li>
<li>For <code>NotEq</code>, if any equal pair exists, we can conclude that the tuples are unequal.</li>
</ul>
<pre><code>a = (str_instance(), int_instance(), &quot;foo&quot;)

reveal_type(a == a)  # revealed: bool
reveal_type(a != a)  # revealed: bool

b = (str_instance(), int_instance(), &quot;bar&quot;)

reveal_type(a == b)  # revealed: bool  # should be Literal[False]
reveal_type(a != b)  # revealed: bool  # should be Literal[True]
</code></pre>
Incorrect Support for Non-Boolean Rich Comparisons
<p>In CPython, aside from <code>==</code> and <code>!=</code>, tuple comparisons return a non-boolean result as-is. Tuples do not convert the value into <code>bool</code>.</p>
<p>Note: If all pairwise <code>==</code> comparisons between elements in the tuples return Truthy, the comparison then considers the tuples&#x27; lengths. Regardless of the return type of the dunder methods, the final result can still be a boolean.</p>
<pre><code>from __future__ import annotations

class A:
    def __eq__(self, o: object) -&gt; str:
        return &quot;hello&quot;

    def __ne__(self, o: object) -&gt; bytes:
        return b&quot;world&quot;

    def __lt__(self, o: A) -&gt; float:
        return 3.14

a = (A(), A())

reveal_type(a == a)  # revealed: bool
reveal_type(a != a)  # revealed: bool
reveal_type(a &lt; a)  # revealed: bool # should be: `float | Literal[False]`

</code></pre>
Key Changes
<p>One of the major changes is that comparisons no longer end with a <code>bool</code> result when a pairwise <code>Eq</code> result is <code>Ambiguous</code>. Instead, the function attempts to infer all possible cases and unions the results. This improvement allows for more robust type inference and better error detection.</p>
<p>Additionally, as the function is now optimized for tuple comparisons, the name has been changed from the more general <code>infer_lexicographic_comparison</code> to <code>infer_tuple_rich_comparison</code>.</p>
Test Plan
<p>mdtest included</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/carljm">@carljm</a> by <a href="https://github.com/cake-monotone">@cake-monotone</a> on 2024-11-18 03:25</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/MichaReiser">@MichaReiser</a> by <a href="https://github.com/cake-monotone">@cake-monotone</a> on 2024-11-18 03:25</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/AlexWaygood">@AlexWaygood</a> by <a href="https://github.com/cake-monotone">@cake-monotone</a> on 2024-11-18 03:25</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/sharkdp">@sharkdp</a> by <a href="https://github.com/cake-monotone">@cake-monotone</a> on 2024-11-18 03:25</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2024-11-18 03:40</div>
            <div class="timeline-body">

<code>ruff-ecosystem</code> results
Linter (stable)
<p>âœ… ecosystem check detected no linter changes.</p>
Linter (preview)
<p>âœ… ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-11-18 04:53</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">great writeup</span> added by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-11-18 07:45</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/resources/mdtest/comparison/tuples.md</code>:204 on 2024-11-18 18:24</div>
            <div class="timeline-body"><p>Is this supposed to say &quot;if any non-equal pair exists&quot;?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/resources/mdtest/comparison/tuples.md</code>:213 on 2024-11-18 18:25</div>
            <div class="timeline-body"><p>I don&#x27;t think these paragraphs add value to the tests.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> approved on 2024-11-18 18:30</div>
            <div class="timeline-body"><p>Excellent! Very clear write-up and fix, thank you!!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/cake-monotone">@cake-monotone</a> reviewed on 2024-11-19 03:10</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/cake-monotone">@cake-monotone</a> on <code>crates/red_knot_python_semantic/resources/mdtest/comparison/tuples.md</code>:204 on 2024-11-19 03:10</div>
            <div class="timeline-body"><p>You&#x27;re right, my mistake! ðŸ˜… Thanks for catching that.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2024-11-20 01:32</div>
            <div class="timeline-body"><p>Thank you!! So great.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/carljm">@carljm</a> on 2024-11-20 01:32</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/carljm">@carljm</a> on 2024-11-20 01:32</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:08:35 UTC
    </footer>
</body>
</html>
