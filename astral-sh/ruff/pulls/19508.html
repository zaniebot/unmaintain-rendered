<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[ty] Exhaustiveness checking &amp; reachability for `match` statements - astral-sh/ruff #19508</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[ty] Exhaustiveness checking &amp; reachability for <code>match</code> statements</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/19508">#19508</a>
        opened by <a href="https://github.com/sharkdp">@sharkdp</a>
        on 2025-07-23 13:00
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a></div>
            <div class="timeline-body"><h2>Summary</h2>
<p>Implements proper reachability analysis and — in effect — exhaustiveness checking for <code>match</code> statements. This allows us to check the following code without any errors (leads to <em>&quot;can implicitly return <code>None</code>&quot;</em> on <code>main</code>):</p>
<pre><code class="language-py">from enum import Enum, auto

class Color(Enum):
    RED = auto()
    GREEN = auto()
    BLUE = auto()

def hex(color: Color) -&gt; str:
    match color:
        case Color.RED:
            return &quot;#ff0000&quot;
        case Color.GREEN:
            return &quot;#00ff00&quot;
        case Color.BLUE:
            return &quot;#0000ff&quot;
</code></pre>
<p>Note that code like this already worked fine if there was a <code>assert_never(color)</code> statement in a catch-all case, because we would then consider that <code>assert_never</code> call terminal. But now this also works without the wildcard case. Adding a member to the enum would still lead to an error here, if that case would not be handled in <code>hex</code>.</p>
<p>What needed to happen to support this is a new way of evaluating match pattern constraints. Previously, we would simply compare the type of the subject expression against the patterns. For the last case here, the subject type would still be <code>Color</code> and the value type would be <code>Literal[Color.BLUE]</code>, so we would infer an ambiguous truthiness.</p>
<p>Now, before we compare the subject type against the pattern, we first generate a union type that corresponds to the set of all values that would have <em>definitely been matched</em> by previous patterns. Then, we build a &quot;narrowed&quot; subject type by computing <code>subject_type &amp; ~already_matched_type</code>, and compare <em>that</em> against the pattern type. For the example here, <code>already_matched_type = Literal[Color.RED] | Literal[Color.GREEN]</code>, and so we have a narrowed subject type of <code>Color &amp; ~(Literal[Color.RED] | Literal[Color.GREEN]) = Literal[Color.BLUE]</code>, which allows us to infer a reachability of <code>AlwaysTrue</code>.</p>
<details>

<summary>A note on negated reachability constraints</summary>

<p>It might seem that we now perform duplicate work, because we also record <em>negated</em> reachability constraints. But that is still important for cases like the following (and possibly also for more realistic scenarios):</p>
<pre><code class="language-py">from typing import Literal

def _(x: int | str):
    match x:
        case None:
            pass # never reachable
        case _:
            y = 1

    y
</code></pre>
</details>

<p>closes https://github.com/astral-sh/ty/issues/99</p>
<h2>Test Plan</h2>
<ul>
<li>I verified that this solves all examples from the linked ticket (the first example needs a PEP 695 type alias, because we don't support legacy type aliases yet)</li>
<li>Verified that the ecosystem changes are all because of removed false positives</li>
<li>Updated tests</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ty</span> added by @sharkdp on 2025-07-23 13:00</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ecosystem-analyzer</span> added by @sharkdp on 2025-07-23 13:00</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "[ty] Exhaustiveness checking / reachability modeling for `match` statements" to "[ty] Exhaustiveness checking & reachability for `match` statements" by @sharkdp on 2025-07-23 13:00</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-07-23 13:04</div>
            <div class="timeline-body"><!-- generated-comment mypy_primer -->

<h2><code>mypy_primer</code> results</h2>
<details>
<summary>Changes were detected when running on open source projects</summary>

<pre><code class="language-diff">pwndbg (https://github.com/pwndbg/pwndbg)
- pwndbg/commands/mallocng.py:345:55: error[invalid-return-type] Function can implicitly return `None`, which is not assignable to return type `str`
- Found 2246 diagnostics
+ Found 2245 diagnostics

mitmproxy (https://github.com/mitmproxy/mitmproxy)
- mitmproxy/contentviews/_utils.py:50:13: error[type-assertion-failure] Argument does not have asserted type `Never`
- Found 1816 diagnostics
+ Found 1815 diagnostics

rotki (https://github.com/rotki/rotki)
- rotkehlchen/externalapis/cryptocompare.py:400:19: warning[possibly-unresolved-reference] Name `method` used when possibly not defined
- rotkehlchen/externalapis/cryptocompare.py:406:19: warning[possibly-unresolved-reference] Name `method` used when possibly not defined
- Found 1571 diagnostics
+ Found 1569 diagnostics

</code></pre>
</details>
No memory usage changes detected ✅

</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-07-23 13:09</div>
            <div class="timeline-body"><!-- generated-comment ty ecosystem-analyzer -->

<h2><code>ecosystem-analyzer</code> results</h2>
<p>| Lint rule | Added | Removed | Changed |
|-----------|------:|--------:|--------:|
| <code>possibly-unresolved-reference</code> | 0 | 2 | 0 |
| <code>invalid-return-type</code> | 0 | 1 | 0 |
| <code>type-assertion-failure</code> | 0 | 1 | 0 |
| <strong>Total</strong> | <strong>0</strong> | <strong>4</strong> | <strong>0</strong> |</p>
<p><strong><a href="https://david-match-exhaustiveness.ecosystem-663.pages.dev/diff">Full report with detailed diff</a></strong></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ecosystem-analyzer</span> removed by @sharkdp on 2025-07-23 14:22</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ecosystem-analyzer</span> added by @sharkdp on 2025-07-23 14:22</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-07-23 16:55</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/ty_python_semantic/src/semantic_index/predicate.rs</code>:155 on 2025-07-23 16:55</div>
            <div class="timeline-body"><p>So there are probably more efficient ways to implement this, but this linked-list approach was so unintrusive..</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @sharkdp on 2025-07-23 17:15</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @sharkdp on 2025-07-23 17:15</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @AlexWaygood by @sharkdp on 2025-07-23 17:15</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @dcreager by @sharkdp on 2025-07-23 17:15</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> approved on 2025-07-23 20:37</div>
            <div class="timeline-body"><p>This is awesome!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @sharkdp on 2025-07-23 20:45</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @sharkdp on 2025-07-23 20:45</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-07-23 20:45</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-07-23 20:48</div>
            <div class="timeline-body"><p>Pumped for this!</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:14:29 UTC
    </footer>
</body>
</html>
