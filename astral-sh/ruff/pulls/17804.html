<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[syntax-errors] detect duplicate keyword arguments - astral-sh/ruff #17804</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[syntax-errors] detect duplicate keyword arguments</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/ruff/pull/17804">#17804</a>
        opened by <a href="https://github.com/eduardorittner">@eduardorittner</a>
        on 2025-05-03 01:28
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/eduardorittner">@eduardorittner</a> on 2025-05-03 01:28</div>
            <div class="timeline-body"><h2>Summary</h2>
<p>Part of https://github.com/astral-sh/ruff/issues/17412</p>
<p>Detects duplicate keyword arguments in function call.</p>
<h2>Test Plan</h2>
<p>Added inline tests to validate intended behavior</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @eduardorittner on 2025-05-03 01:28</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @dhruvmanila by @eduardorittner on 2025-05-03 01:28</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @ntBre by @MichaReiser on 2025-05-03 14:20</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_parser/src/semantic_errors.rs</code>:563 on 2025-05-03 14:26</div>
            <div class="timeline-body"><p>Nit: it would be nice if we can avoid allocating a hash set if we know that there are fewer than 2 keyword arguments.</p>
<pre><code class="language-rust">let mut keyword_arguments = args.keywords.iter().filter_map(|key| &amp;key.arg).peekable();

let Some(first) = keyword_arguments.next() else {
	return;
};


if keyword_arguments.peek().is_none() {
	return;
}

let mut unique_args = FxHashSet::default();
unique_args.insert(first);

for arg in keyword_arguments {
	if !unique_keyword_args.insert(ident) {
	  let range = ident.range();
	  // test_err duplicate_keyword_args
	  // def foo(x): ...
	  // foo(x=1, x=2)
	  // def baz(x, y, z): ...
	  // baz(x, y=1, z=3, y=4)
	
	  // test_ok non_duplicate_keyword_args
	  // def foo(x): ...
	  // foo(x=1)
	  // def bar(x, y, z): ...
	  // foo(x=&quot;a&quot;, y=1, z=True)
	  Self::add_error(
	      ctx,
	      SemanticSyntaxErrorKind::DuplicateKeywordArgs(ident.to_string()),
	      range,
	  );
	}
}
</code></pre>
<p>Another alternative would be that we make the <code>FxHashSet</code> a field on the visitor and reuse it (we'd have to make sure that we always call <code>clear()</code>). This would ensure that we only allocate at most one hash set.  I think I'd prefer that (because we could use it for other checks too)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2025-05-03 14:26</div>
            <div class="timeline-body"><p>I've a small perf comment but this otherwise looks good to me. I'll leave it to @ntBre to approve</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @MichaReiser on 2025-05-03 14:26</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-05-03 14:35</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Formatter (stable)</h3>
<p>ℹ️ ecosystem check <strong>encountered format errors</strong>. (no format changes; 1 project error)</p>
<details><summary><a href="https://github.com/mesonbuild/meson-python">mesonbuild/meson-python</a> (error)</summary>
<p>

<pre><code>warning: Detected debug build without --no-cache.
error: Failed to read tests/packages/symlinks/baz.py: No such file or directory (os error 2)
error: Failed to read tests/packages/symlinks/qux.py: No such file or directory (os error 2)
</code></pre>
</p>
</details>

<h3>Formatter (preview)</h3>
<p>ℹ️ ecosystem check <strong>encountered format errors</strong>. (no format changes; 1 project error)</p>
<details><summary><a href="https://github.com/mesonbuild/meson-python">mesonbuild/meson-python</a> (error)</summary>
<p>
<pre>ruff format --preview</pre>
</p>
<p>

<pre><code>warning: Detected debug build without --no-cache.
error: Failed to read tests/packages/symlinks/baz.py: No such file or directory (os error 2)
error: Failed to read tests/packages/symlinks/qux.py: No such file or directory (os error 2)
</code></pre>
</p>
</details>

</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/eduardorittner">@eduardorittner</a> reviewed on 2025-05-03 20:31</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/eduardorittner">@eduardorittner</a> on <code>crates/ruff_python_parser/src/semantic_errors.rs</code>:563 on 2025-05-03 20:31</div>
            <div class="timeline-body"><p>yeah that makes sense! By visitor do you mean <code>SemanticSyntaxChecker</code> or one of <code>InvalidExpressionVisitor</code>, <code>ReboundComprehensionVisitor</code> or <code>MatchPatternVisitor</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/eduardorittner">@eduardorittner</a> on 2025-05-04 13:31</div>
            <div class="timeline-body"><p>It looks like there already is an error type for duplicate keyword arguments in red_knot. I ran into this when adding integration tests into <code>semantic_syntax_errors.md</code> following https://github.com/astral-sh/ruff/issues/17526. The tests trigger the <code>ParameterAlreadyAssigned</code> error instead of the new <code>DuplicateKeywordArgs</code>.</p>
<p>https://github.com/astral-sh/ruff/blob/fe4051b2e6bf74a33f67f60fdbd775a6568e96a3/crates/ty_python_semantic/src/types/call/bind.rs#L1480-L1484</p>
<p>How should we proceed?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-05-05 14:25</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_python_parser/src/semantic_errors.rs</code>:563 on 2025-05-05 14:25</div>
            <div class="timeline-body"><p>I think Micha means <code>SemanticSyntaxChecker</code>, which would also require passing a <code>&amp;mut self</code> parameter to this function.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> approved on 2025-05-05 14:43</div>
            <div class="timeline-body"><p>Thanks, this looks good to me!</p>
<blockquote>
<p>It looks like there already is an error type for duplicate keyword arguments in red_knot. I ran into this when adding integration tests into semantic_syntax_errors.md following https://github.com/astral-sh/ruff/issues/17526. The tests trigger the ParameterAlreadyAssigned error instead of the new DuplicateKeywordArgs.</p>
</blockquote>
<p>I think we may want to remove the other check and emit this as a syntax error. What do you think, @MichaReiser?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-05-05 16:10</div>
            <div class="timeline-body"><p>I don't think we can simply replace them because ty checks more. For example:</p>
<pre><code class="language-py"># error: 13 [missing-argument] &quot;No argument provided for required parameter `x` of function `f`&quot;
# error: 18 [parameter-already-assigned] &quot;Multiple values provided for parameter `x` of function `f`&quot;
reveal_type(f(1, x=2))  # revealed: int
</code></pre>
<p>I think we have two options here:</p>
<ul>
<li>We skip this check for ty</li>
<li>We change the check in ty to not emit a diagnostic for the simple case where <code>x</code> is repeated on the call site</li>
</ul>
<p>@dcreager what's your take on this. You probably know the call checking in ty the best</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntBre">@ntBre</a> on 2025-05-05 16:23</div>
            <div class="timeline-body"><p>Ah I see, and that case (<code>f(1, x=2)</code>) is not actually a syntax error, so we can't just extend the semantic error check either. I'm happy with either of those options, whichever the ty team prefers!</p>
<p>We could just add a filter here, if that's the approach we want to take:</p>
<p>https://github.com/astral-sh/ruff/blob/ea62fc9baf2178deb0e761da11d64e7dff9c7c72/crates/ty_python_semantic/src/types.rs#L97-L102</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-05-05 16:43</div>
            <div class="timeline-body"><p>My preference (because of consistency) would be to change the check during type inference to skip over errors that are known syntax errors. Unless this is hard for some reason</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/eduardorittner">@eduardorittner</a> reviewed on 2025-05-05 22:56</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/eduardorittner">@eduardorittner</a> on <code>crates/ruff_python_parser/src/semantic_errors.rs</code>:563 on 2025-05-05 22:56</div>
            <div class="timeline-body"><p>Yeah that's what I was wondering, in this case if we wanted to avoid <code>clone</code>, we'd have a <code>HashSet&lt;&amp;Identifier&gt;</code> which means adding a lifetime to <code>SemanticSyntaxChecker</code> and most of the places it's used. The borrow checker was giving me some trouble but I'll take another shot at it</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/eduardorittner">@eduardorittner</a> reviewed on 2025-05-07 12:26</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/eduardorittner">@eduardorittner</a> on <code>crates/ruff_python_parser/src/semantic_errors.rs</code>:563 on 2025-05-07 12:26</div>
            <div class="timeline-body"><p>I got it to compile using unsafe like this</p>
<pre><code class="language-rust">    fn duplicate_keyword_args&lt;Ctx: SemanticSyntaxContext&gt;(
        &amp;'a mut self,
        args: &amp;ast::Arguments,
        ctx: &amp;Ctx,
    ) {
        let args: &amp;'a ast::Arguments = unsafe { std::mem::transmute(args) };

        for key in &amp;args.keywords {
            if let Some(ident) = &amp;key.arg {
                if !self.keyword_args.insert(ident) {
                    let range = ident.range();

                    Self::add_error(
                        ctx,
                        SemanticSyntaxErrorKind::DuplicateKeywordArgs(ident.to_string()),
                        range,
                    );
                }
            }
        }

        self.keyword_args.clear();
    }
</code></pre>
<p>The problem is that the borrow checker doesn't understand that calling <code>clear()</code> at the end of the function invalidates the references to <code>&amp;Arguments</code> stored in the HashSet, and since mutable references are invariant this leads it to believe that <code>&amp;Arguments</code> must outlive <code>&amp;mut self</code>. We know that isn't necessary since any reference to <code>&amp;Arguments</code> will always be cleared at the end of the function, so I used unsafe to coerce the <code>&amp;Arguments</code> lifetime into the same as <code>&amp;mut self</code>.</p>
<p>The problem with this approach is that</p>
<ol>
<li>We are using unsafe, even though it seems pretty &quot;safe&quot; here, I'm not sure what ruff's stance to using unsafe is.</li>
<li>This raises lifetime errors in <code>tests/fixtures.rs</code>, these can probably be solved but would still require some work.</li>
</ol>
<p>The other options I can think of are:</p>
<ol>
<li>Leaving it as is, allocating and deallocating a hashset on every function call</li>
<li>Reuse the hashset, but make it a <code>FxHashSet&lt;ast::Identifier&gt;</code> and call <code>clone()</code> on every argument</li>
</ol>
<p>Both of these options allocate more memory than necessary, though I'm not sure which is costlier (though I think <code>clone</code>ing would most times be cheaper I haven't actually tested it).</p>
<p>Let me know what your thoughts are.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-05-07 12:36</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_parser/src/semantic_errors.rs</code>:563 on 2025-05-07 12:36</div>
            <div class="timeline-body"><p>The idea is to use something along these lines</p>
<pre><code class="language-rust">let mut hash_set = std::mem::take(&amp;mut self.shared_hash_set);

for key in &amp;args.keywords {
	...
}

hash_set.clear();
self.shared_hash_set = hash_set;
</code></pre>
<p>but I wouldn't try to hard if the borrow checker is giving you a hard time.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/eduardorittner">@eduardorittner</a> reviewed on 2025-05-09 01:12</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/eduardorittner">@eduardorittner</a> on <code>crates/ruff_python_parser/src/semantic_errors.rs</code>:563 on 2025-05-09 01:12</div>
            <div class="timeline-body"><p>Funny enough I did try something similar to this but couldn't get it to work, but now it worked, thanks! Now I should just need to add some lifetime annotations where <code>SemanticSyntaxChecker</code> is used elsewhere in the code base</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/eduardorittner">@eduardorittner</a> reviewed on 2025-05-09 21:04</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/eduardorittner">@eduardorittner</a> on <code>crates/ruff_python_parser/src/semantic_errors.rs</code>:563 on 2025-05-09 21:04</div>
            <div class="timeline-body"><p>Yeah I mean I can't do it, changing this lifetime raised a bunch of lifetime errors (close to 80) on other parts of the codebase, mostly the <code>Visitor</code> implementations on <code>with_semantic_checker</code> calls. Maybe there's a way to fix them using some specific annotations, but I couldn't figure it out. So I'll leave it like this for now.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-05-12 20:22</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_python_parser/src/semantic_errors.rs</code>:563 on 2025-05-12 20:22</div>
            <div class="timeline-body"><p>Thanks for trying. I think this is okay. <a href="https://codspeed.io/astral-sh/ruff/branches/eduardorittner%3Adup-keyargs">codspeed</a> is only showing a few ~1% performance regressions, which I think is pretty typical for any new rule. I think we just need to resolve the question about the duplicate diagnostic (and the clippy errors) and then we can land this.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-05-12 20:26</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_python_parser/src/semantic_errors.rs</code>:563 on 2025-05-12 20:26</div>
            <div class="timeline-body"><p>It may not overlap 100%, but there is an open issue in ty (https://github.com/astral-sh/ty/issues/119) to avoid emitting type inference diagnostics in the presence of syntax errors, which might be enough to ignore the duplication issue for the sake of this PR.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_parser/src/semantic_errors.rs</code>:563 on 2025-05-13 06:33</div>
            <div class="timeline-body"><p>I think this goes somewhat beyond #119. At least, what I had in mind for it. The goal for #119 is to avoid type checker errors for nodes that have non semantic or version related syntax errors.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-05-13 06:33</div>
            <div class="timeline-body"></div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 18:51:28 UTC
    </footer>
</body>
</html>
