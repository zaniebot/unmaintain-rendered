<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[ty] Prefer declared type of generic classes - astral-sh/ruff #21070</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[ty] Prefer declared type of generic classes</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/pull/21070">#21070</a>
        opened by <a href="https://github.com/ibraheemdev">@ibraheemdev</a>
        on 2025-10-25 02:50
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ibraheemdev">@ibraheemdev</a></div>
            <div class="timeline-body">Summary
<p>Extends <a href="https://github.com/astral-sh/ruff/pull/20927">astral-sh/ruff#20927</a> to generic call inference, preferring the declared type of generic classes:</p>
<pre><code>def f[T](x: T) -&gt; list[T]:
    return [x]

x: list[Any] = f(1)
reveal_type(x)  # before: list[Literal[1]], after: list[Any]
</code></pre>
<p>Part of <a href="https://github.com/astral-sh/ty/issues/136">astral-sh/ty#136</a>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/carljm">@carljm</a> by <a href="https://github.com/ibraheemdev">@ibraheemdev</a> on 2025-10-25 02:50</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/AlexWaygood">@AlexWaygood</a> by <a href="https://github.com/ibraheemdev">@ibraheemdev</a> on 2025-10-25 02:50</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/sharkdp">@sharkdp</a> by <a href="https://github.com/ibraheemdev">@ibraheemdev</a> on 2025-10-25 02:50</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/dcreager">@dcreager</a> by <a href="https://github.com/ibraheemdev">@ibraheemdev</a> on 2025-10-25 02:50</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ty</span> added by <a href="https://github.com/ibraheemdev">@ibraheemdev</a> on 2025-10-25 02:50</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ecosystem-analyzer</span> added by <a href="https://github.com/ibraheemdev">@ibraheemdev</a> on 2025-10-25 02:55</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-10-25 02:56</div>
            <div class="timeline-body">

Diagnostic diff on <a href="https://github.com/python/typing/tree/d4f39b27a4a47aac8b6d4019e1b0b5b3156fabdc/conformance">typing conformance tests</a>
<p>No changes detected when running ty on typing conformance tests ✅</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ecosystem-analyzer</span> removed by <a href="https://github.com/ibraheemdev">@ibraheemdev</a> on 2025-10-25 02:58</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-10-25 03:01</div>
            <div class="timeline-body">

<code>mypy_primer</code> results

Changes were detected when running on open source projects

<pre><code>dulwich (https://github.com/dulwich/dulwich)
- dulwich/pack.py:1703:83: warning[unused-ignore-comment] Unused blanket `type: ignore` directive
- Found 172 diagnostics
+ Found 171 diagnostics

pydantic (https://github.com/pydantic/pydantic)
- pydantic/_internal/_validators.py:161:16: error[invalid-return-type] Return type does not match returned value: expected `Pattern[bytes]`, found `Pattern[str | bytes]`
+ pydantic/_internal/_validators.py:161:16: error[invalid-return-type] Return type does not match returned value: expected `Pattern[bytes]`, found `Pattern[bytes | str]`

Expression (https://github.com/cognitedata/Expression)
- tests/test_result.py:491:21: error[invalid-argument-type] Argument to bound method `or_else` is incorrect: Expected `Result[Literal[42], Any]`, found `Result[Literal[0], Any]`
- tests/test_result.py:509:21: error[invalid-argument-type] Argument to bound method `or_else` is incorrect: Expected `Result[Any, Literal[&quot;original error&quot;]]`, found `Result[Any, Literal[&quot;new error&quot;]]`
- Found 201 diagnostics
+ Found 199 diagnostics

sphinx (https://github.com/sphinx-doc/sphinx)
- sphinx/domains/python/__init__.py:672:42: error[index-out-of-bounds] Index 0 is out of bounds for string `Literal[&quot;&quot;]` with length 0
- Found 530 diagnostics
+ Found 529 diagnostics

jax (https://github.com/google/jax)
- jax/_src/interpreters/mlir.py:1484:5: error[invalid-assignment] Object of type `OrderedDict[str, Unknown]` is not assignable to attribute `_tokens` of type `OrderedDict[Effect, Unknown]`
- Found 2544 diagnostics
+ Found 2543 diagnostics

rotki (https://github.com/rotki/rotki)
+ rotkehlchen/exchanges/coinbase.py:524:20: error[invalid-assignment] Object of type `dict[Unknown, Unknown]` is not assignable to `defaultdict[str, list[dict[Unknown, Unknown]]]`
- Found 1684 diagnostics
+ Found 1685 diagnostics

core (https://github.com/home-assistant/core)
+ homeassistant/helpers/service.py:913:9: error[invalid-assignment] Object of type `object` is not assignable to `ServiceResponse`
- Found 14272 diagnostics
+ Found 14273 diagnostics

</code></pre>


Memory usage changes were detected when running on open source projects

<pre><code>prefect (https://github.com/PrefectHQ/prefect)
-     struct metadata = ~33MB
+     struct metadata = ~35MB

</code></pre>


</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ecosystem-analyzer</span> added by <a href="https://github.com/ibraheemdev">@ibraheemdev</a> on 2025-10-25 03:05</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-10-25 03:11</div>
            <div class="timeline-body">

<code>ecosystem-analyzer</code> results
<p>| Lint rule | Added | Removed | Changed |
|-----------|------:|--------:|--------:|
| <code>invalid-assignment</code> | 2 | 1 | 0 |
| <code>invalid-argument-type</code> | 0 | 2 | 0 |
| <code>index-out-of-bounds</code> | 0 | 1 | 0 |
| <code>invalid-return-type</code> | 0 | 0 | 1 |
| <code>unused-ignore-comment</code> | 0 | 1 | 0 |
| <strong>Total</strong> | <strong>2</strong> | <strong>5</strong> | <strong>1</strong> |</p>
<p><strong><a href="https://ibraheem-declared-generic-ty.ecosystem-663.pages.dev/diff">Full report with detailed diff</a></strong> (<a href="https://ibraheem-declared-generic-ty.ecosystem-663.pages.dev/timing">timing results</a>)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ibraheemdev">@ibraheemdev</a> on 2025-10-25 03:48</div>
            <div class="timeline-body"><p>I&#x27;m not sure if we should restrict this change to invariant generics. It seems reasonable to use <code>frozendict[str, Any]</code> as an implicit typed dict, so preferring the <code>Any</code> there might still be meaningful (even thought it feels strictly worse).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Converted to draft by <a href="https://github.com/ibraheemdev">@ibraheemdev</a> on 2025-10-25 03:49</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-10-30 16:06</div>
            <div class="timeline-body"><p>@ibraheemdev Is this blocked? What&#x27;s keeping it in draft?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/codspeed-hq[bot]">@codspeed-hq[bot]</a> on 2025-10-30 21:32</div>
            <div class="timeline-body">

<a href="https://codspeed.io/astral-sh/ruff/branches/ibraheem%2Fdeclared-generic-type?utm_source=github&amp;utm_medium=comment&amp;utm_content=header">CodSpeed Performance Report</a>
Merging #21070 will <strong>not alter performance</strong>
<p>Comparing <code>ibraheem/declared-generic-type</code> (2f4dcbf) with <code>main</code> (1d111c8)</p>
Summary
<p><code>✅ 22</code> untouched<br>
<code>⏩ 30</code> skipped[^skipped]</p>
<p>[^skipped]: 30 benchmarks were skipped, so the baseline results were used instead. If they were deleted from the codebase, <a href="https://codspeed.io/astral-sh/ruff/branches/ibraheem%2Fdeclared-generic-type?sectionId=benchmark-comparison-section-baseline-result-skipped&amp;utm_source=github&amp;utm_medium=comment&amp;utm_content=archive">click here and archive them to remove them from the performance reports</a>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by <a href="https://github.com/ibraheemdev">@ibraheemdev</a> on 2025-10-30 21:44</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ecosystem-analyzer</span> removed by <a href="https://github.com/ibraheemdev">@ibraheemdev</a> on 2025-10-31 15:21</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ecosystem-analyzer</span> added by <a href="https://github.com/ibraheemdev">@ibraheemdev</a> on 2025-10-31 15:21</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ibraheemdev">@ibraheemdev</a> on 2025-10-31 15:38</div>
            <div class="timeline-body"><p>The ecosystem changes all seem correct.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ibraheemdev">@ibraheemdev</a> on 2025-11-03 00:32</div>
            <div class="timeline-body"><p>Superceded by <a href="https://github.com/astral-sh/ruff/pull/21210">astral-sh/ruff#21210</a>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/ibraheemdev">@ibraheemdev</a> on 2025-11-03 00:32</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:19:52 UTC
    </footer>
</body>
</html>
