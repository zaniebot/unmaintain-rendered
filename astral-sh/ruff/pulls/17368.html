<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[`ruff`] Check for non-context-manager use of `pytest.raises`, `pytest.warns`, and `pytest.deprecated_call` (`RUF061`) - astral-sh/ruff #17368</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[<code>ruff</code>] Check for non-context-manager use of <code>pytest.raises</code>, <code>pytest.warns</code>, and <code>pytest.deprecated_call</code> (<code>RUF061</code>)</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/17368">#17368</a>
        opened by <a href="https://github.com/twentyone212121">@twentyone212121</a>
        on 2025-04-12 14:07
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/twentyone212121">@twentyone212121</a> on 2025-04-12 14:07</div>
            <div class="timeline-body"><!--
Thank you for contributing to Ruff! To help us out with reviewing, please consider the following:

- Does this pull request include a summary of the change? (See below.)
- Does this pull request include a descriptive title?
- Does this pull request include references to any relevant issues?
-->

<p>This PR aims to close #16605.</p>
<h2>Summary</h2>
<p>This PR introduces a new rule (<code>RUF061</code>) that detects non-contextmanager usage of <code>pytest.raises</code>, <code>pytest.warns</code>, and <code>pytest.deprecated_call</code>. This pattern is discouraged and <a href="https://github.com/m-burst/flake8-pytest-style/pull/332">was proposed in flake8-pytest-style</a>, but the corresponding PR has been open for over a month without activity.</p>
<p>Additionally, this PR provides an unsafe fix for simple cases where the non-contextmanager form can be transformed into the context manager form. Examples of supported patterns are listed in <code>RUF061_raises.py</code>, <code>RUF061_warns.py</code>, and <code>RUF061_deprecated_call.py</code> test files.</p>
<p>The more complex case from the original issue (involving two separate statements):</p>
<pre><code class="language-python">excinfo = pytest.raises(ValueError, int, &quot;hello&quot;)
assert excinfo.match(&quot;^invalid literal&quot;)
</code></pre>
<p>is getting fixed like this:</p>
<pre><code class="language-python">with pytest.raises(ValueError) as excinfo:
    int(&quot;hello&quot;)
assert excinfo.match(&quot;^invalid literal&quot;)
</code></pre>
<p>Putting match in the raises call requires multi-statement transformation, which I am not sure how to implement.</p>
<h2>Test Plan</h2>
<!-- How was it tested? -->

<p>New test files were added to cover various usages of the non-contextmanager form of pytest.raises, warns, and deprecated_call.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Converted to draft by @twentyone212121 on 2025-04-12 14:08</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "[`flake8-pytest-style`] Deprecated `pytest.raises` callable form rule…" to "[`flake8-pytest-style`] Deprecated `pytest.raises` callable form rule + fix (`PT032`)" by @twentyone212121 on 2025-04-12 14:21</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-04-12 14:32</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>ℹ️ ecosystem check <strong>detected linter changes</strong>. (+231 -0 violations, +0 -0 fixes in 4 projects; 51 projects unchanged)</p>
<details><summary><a href="https://github.com/apache/superset">apache/superset</a> (+3 -0 violations, +0 -0 fixes)</summary>
<p>
<pre>ruff check --no-cache --exit-zero --ignore RUF9 --no-fix --output-format concise --preview --select ALL</pre>
</p>
<p>

<pre>
+ <a href='https://github.com/apache/superset/blob/9df990c2d1847b174dff550617dc28761a1a1b79/tests/integration_tests/datasource_tests.py#L349'>tests/integration_tests/datasource_tests.py:349:9:</a> RUF061 Use context-manager form of `pytest.raises()`
+ <a href='https://github.com/apache/superset/blob/9df990c2d1847b174dff550617dc28761a1a1b79/tests/integration_tests/datasource_tests.py#L497'>tests/integration_tests/datasource_tests.py:497:9:</a> RUF061 Use context-manager form of `pytest.raises()`
+ <a href='https://github.com/apache/superset/blob/9df990c2d1847b174dff550617dc28761a1a1b79/tests/integration_tests/datasource_tests.py#L509'>tests/integration_tests/datasource_tests.py:509:9:</a> RUF061 Use context-manager form of `pytest.raises()`
</pre>

</p>
</details>
<details><summary><a href="https://github.com/indico/indico">indico/indico</a> (+21 -0 violations, +0 -0 fixes)</summary>
<p>
<pre>ruff check --no-cache --exit-zero --ignore RUF9 --no-fix --output-format concise --preview</pre>
</p>
<p>

<pre>
+ <a href='https://github.com/indico/indico/blob/e2f23c95902289f35874150b686f0fd36c3c2cec/indico/core/settings/proxy_test.py#L114'>indico/core/settings/proxy_test.py:114:5:</a> RUF061 Use context-manager form of `pytest.raises()`
+ <a href='https://github.com/indico/indico/blob/e2f23c95902289f35874150b686f0fd36c3c2cec/indico/core/settings/proxy_test.py#L115'>indico/core/settings/proxy_test.py:115:5:</a> RUF061 Use context-manager form of `pytest.raises()`
+ <a href='https://github.com/indico/indico/blob/e2f23c95902289f35874150b686f0fd36c3c2cec/indico/core/settings/proxy_test.py#L116'>indico/core/settings/proxy_test.py:116:5:</a> RUF061 Use context-manager form of `pytest.raises()`
+ <a href='https://github.com/indico/indico/blob/e2f23c95902289f35874150b686f0fd36c3c2cec/indico/core/settings/proxy_test.py#L117'>indico/core/settings/proxy_test.py:117:5:</a> RUF061 Use context-manager form of `pytest.raises()`
+ <a href='https://github.com/indico/indico/blob/e2f23c95902289f35874150b686f0fd36c3c2cec/indico/core/settings/proxy_test.py#L118'>indico/core/settings/proxy_test.py:118:5:</a> RUF061 Use context-manager form of `pytest.raises()`
+ <a href='https://github.com/indico/indico/blob/e2f23c95902289f35874150b686f0fd36c3c2cec/indico/core/settings/proxy_test.py#L119'>indico/core/settings/proxy_test.py:119:5:</a> RUF061 Use context-manager form of `pytest.raises()`
+ <a href='https://github.com/indico/indico/blob/e2f23c95902289f35874150b686f0fd36c3c2cec/indico/core/settings/proxy_test.py#L120'>indico/core/settings/proxy_test.py:120:5:</a> RUF061 Use context-manager form of `pytest.raises()`
+ <a href='https://github.com/indico/indico/blob/e2f23c95902289f35874150b686f0fd36c3c2cec/indico/core/settings/proxy_test.py#L170'>indico/core/settings/proxy_test.py:170:5:</a> RUF061 Use context-manager form of `pytest.raises()`
+ <a href='https://github.com/indico/indico/blob/e2f23c95902289f35874150b686f0fd36c3c2cec/indico/core/settings/proxy_test.py#L171'>indico/core/settings/proxy_test.py:171:5:</a> RUF061 Use context-manager form of `pytest.raises()`
+ <a href='https://github.com/indico/indico/blob/e2f23c95902289f35874150b686f0fd36c3c2cec/indico/core/settings/proxy_test.py#L172'>indico/core/settings/proxy_test.py:172:5:</a> RUF061 Use context-manager form of `pytest.raises()`
... 11 additional changes omitted for project
</pre>

</p>
</details>
<details><summary><a href="https://github.com/pytest-dev/pytest">pytest-dev/pytest</a> (+134 -0 violations, +0 -0 fixes)</summary>
<p>
<pre>ruff check --no-cache --exit-zero --ignore RUF9 --no-fix --output-format concise --preview</pre>
</p>
<p>

<pre>
+ <a href='https://github.com/pytest-dev/pytest/blob/336cb917f7175ccc5a699f81b58f3587c5a7dcca/doc/en/example/assertion/failure_demo.py#L168'>doc/en/example/assertion/failure_demo.py:168:9:</a> RUF061 Use context-manager form of `pytest.raises()`
+ <a href='https://github.com/pytest-dev/pytest/blob/336cb917f7175ccc5a699f81b58f3587c5a7dcca/doc/en/example/assertion/failure_demo.py#L171'>doc/en/example/assertion/failure_demo.py:171:9:</a> RUF061 Use context-manager form of `pytest.raises()`
+ <a href='https://github.com/pytest-dev/pytest/blob/336cb917f7175ccc5a699f81b58f3587c5a7dcca/testing/_py/test_local.py#L1001'>testing/_py/test_local.py:1001:9:</a> RUF061 Use context-manager form of `pytest.raises()`
+ <a href='https://github.com/pytest-dev/pytest/blob/336cb917f7175ccc5a699f81b58f3587c5a7dcca/testing/_py/test_local.py#L1002'>testing/_py/test_local.py:1002:9:</a> RUF061 Use context-manager form of `pytest.raises()`
+ <a href='https://github.com/pytest-dev/pytest/blob/336cb917f7175ccc5a699f81b58f3587c5a7dcca/testing/_py/test_local.py#L1102'>testing/_py/test_local.py:1102:19:</a> RUF061 Use context-manager form of `pytest.raises()`
+ <a href='https://github.com/pytest-dev/pytest/blob/336cb917f7175ccc5a699f81b58f3587c5a7dcca/testing/_py/test_local.py#L1400'>testing/_py/test_local.py:1400:9:</a> RUF061 Use context-manager form of `pytest.raises()`
+ <a href='https://github.com/pytest-dev/pytest/blob/336cb917f7175ccc5a699f81b58f3587c5a7dcca/testing/_py/test_local.py#L628'>testing/_py/test_local.py:628:9:</a> RUF061 Use context-manager form of `pytest.raises()`
+ <a href='https://github.com/pytest-dev/pytest/blob/336cb917f7175ccc5a699f81b58f3587c5a7dcca/testing/code/test_code.py#L91'>testing/code/test_code.py:91:15:</a> RUF061 Use context-manager form of `pytest.raises()`
+ <a href='https://github.com/pytest-dev/pytest/blob/336cb917f7175ccc5a699f81b58f3587c5a7dcca/testing/code/test_excinfo.py#L1019'>testing/code/test_excinfo.py:1019:19:</a> RUF061 Use context-manager form of `pytest.raises()`
+ <a href='https://github.com/pytest-dev/pytest/blob/336cb917f7175ccc5a699f81b58f3587c5a7dcca/testing/code/test_excinfo.py#L1068'>testing/code/test_excinfo.py:1068:19:</a> RUF061 Use context-manager form of `pytest.raises()`
+ <a href='https://github.com/pytest-dev/pytest/blob/336cb917f7175ccc5a699f81b58f3587c5a7dcca/testing/code/test_excinfo.py#L1082'>testing/code/test_excinfo.py:1082:19:</a> RUF061 Use context-manager form of `pytest.raises()`
+ <a href='https://github.com/pytest-dev/pytest/blob/336cb917f7175ccc5a699f81b58f3587c5a7dcca/testing/code/test_excinfo.py#L1101'>testing/code/test_excinfo.py:1101:19:</a> RUF061 Use context-manager form of `pytest.raises()`
+ <a href='https://github.com/pytest-dev/pytest/blob/336cb917f7175ccc5a699f81b58f3587c5a7dcca/testing/code/test_excinfo.py#L1118'>testing/code/test_excinfo.py:1118:19:</a> RUF061 Use context-manager form of `pytest.raises()`
+ <a href='https://github.com/pytest-dev/pytest/blob/336cb917f7175ccc5a699f81b58f3587c5a7dcca/testing/code/test_excinfo.py#L1149'>testing/code/test_excinfo.py:1149:19:</a> RUF061 Use context-manager form of `pytest.raises()`
+ <a href='https://github.com/pytest-dev/pytest/blob/336cb917f7175ccc5a699f81b58f3587c5a7dcca/testing/code/test_excinfo.py#L1182'>testing/code/test_excinfo.py:1182:19:</a> RUF061 Use context-manager form of `pytest.raises()`
+ <a href='https://github.com/pytest-dev/pytest/blob/336cb917f7175ccc5a699f81b58f3587c5a7dcca/testing/code/test_excinfo.py#L1214'>testing/code/test_excinfo.py:1214:19:</a> RUF061 Use context-manager form of `pytest.raises()`
+ <a href='https://github.com/pytest-dev/pytest/blob/336cb917f7175ccc5a699f81b58f3587c5a7dcca/testing/code/test_excinfo.py#L1244'>testing/code/test_excinfo.py:1244:19:</a> RUF061 Use context-manager form of `pytest.raises()`
+ <a href='https://github.com/pytest-dev/pytest/blob/336cb917f7175ccc5a699f81b58f3587c5a7dcca/testing/code/test_excinfo.py#L1271'>testing/code/test_excinfo.py:1271:19:</a> RUF061 Use context-manager form of `pytest.raises()`
+ <a href='https://github.com/pytest-dev/pytest/blob/336cb917f7175ccc5a699f81b58f3587c5a7dcca/testing/code/test_excinfo.py#L1327'>testing/code/test_excinfo.py:1327:19:</a> RUF061 Use context-manager form of `pytest.raises()`
+ <a href='https://github.com/pytest-dev/pytest/blob/336cb917f7175ccc5a699f81b58f3587c5a7dcca/testing/code/test_excinfo.py#L1380'>testing/code/test_excinfo.py:1380:19:</a> RUF061 Use context-manager form of `pytest.raises()`
+ <a href='https://github.com/pytest-dev/pytest/blob/336cb917f7175ccc5a699f81b58f3587c5a7dcca/testing/code/test_excinfo.py#L1473'>testing/code/test_excinfo.py:1473:19:</a> RUF061 Use context-manager form of `pytest.raises()`
+ <a href='https://github.com/pytest-dev/pytest/blob/336cb917f7175ccc5a699f81b58f3587c5a7dcca/testing/code/test_excinfo.py#L1568'>testing/code/test_excinfo.py:1568:19:</a> RUF061 Use context-manager form of `pytest.raises()`
+ <a href='https://github.com/pytest-dev/pytest/blob/336cb917f7175ccc5a699f81b58f3587c5a7dcca/testing/code/test_excinfo.py#L225'>testing/code/test_excinfo.py:225:19:</a> RUF061 Use context-manager form of `pytest.raises()`
+ <a href='https://github.com/pytest-dev/pytest/blob/336cb917f7175ccc5a699f81b58f3587c5a7dcca/testing/code/test_excinfo.py#L243'>testing/code/test_excinfo.py:243:19:</a> RUF061 Use context-manager form of `pytest.raises()`
+ <a href='https://github.com/pytest-dev/pytest/blob/336cb917f7175ccc5a699f81b58f3587c5a7dcca/testing/code/test_excinfo.py#L254'>testing/code/test_excinfo.py:254:19:</a> RUF061 Use context-manager form of `pytest.raises()`
+ <a href='https://github.com/pytest-dev/pytest/blob/336cb917f7175ccc5a699f81b58f3587c5a7dcca/testing/code/test_excinfo.py#L276'>testing/code/test_excinfo.py:276:19:</a> RUF061 Use context-manager form of `pytest.raises()`
+ <a href='https://github.com/pytest-dev/pytest/blob/336cb917f7175ccc5a699f81b58f3587c5a7dcca/testing/code/test_excinfo.py#L297'>testing/code/test_excinfo.py:297:19:</a> RUF061 Use context-manager form of `pytest.raises()`
+ <a href='https://github.com/pytest-dev/pytest/blob/336cb917f7175ccc5a699f81b58f3587c5a7dcca/testing/code/test_excinfo.py#L315'>testing/code/test_excinfo.py:315:19:</a> RUF061 Use context-manager form of `pytest.raises()`
+ <a href='https://github.com/pytest-dev/pytest/blob/336cb917f7175ccc5a699f81b58f3587c5a7dcca/testing/code/test_excinfo.py#L331'>testing/code/test_excinfo.py:331:19:</a> RUF061 Use context-manager form of `pytest.raises()`
... 105 additional changes omitted for project
</pre>

</p>
</details>
<details><summary><a href="https://github.com/astropy/astropy">astropy/astropy</a> (+73 -0 violations, +0 -0 fixes)</summary>
<p>
<pre>ruff check --no-cache --exit-zero --ignore RUF9 --no-fix --output-format concise --preview</pre>
</p>
<p>

<pre>
+ <a href='https://github.com/astropy/astropy/blob/3a070e29f1ea0cf6a7e186477a11190d35f42913/astropy/constants/tests/test_constant.py#L51'>astropy/constants/tests/test_constant.py:51:5:</a> RUF061 Use context-manager form of `pytest.raises()`
+ <a href='https://github.com/astropy/astropy/blob/3a070e29f1ea0cf6a7e186477a11190d35f42913/astropy/constants/tests/test_constant.py#L55'>astropy/constants/tests/test_constant.py:55:5:</a> RUF061 Use context-manager form of `pytest.raises()`
+ <a href='https://github.com/astropy/astropy/blob/3a070e29f1ea0cf6a7e186477a11190d35f42913/astropy/constants/tests/test_constant.py#L58'>astropy/constants/tests/test_constant.py:58:5:</a> RUF061 Use context-manager form of `pytest.raises()`
+ <a href='https://github.com/astropy/astropy/blob/3a070e29f1ea0cf6a7e186477a11190d35f42913/astropy/io/fits/hdu/compressed/tests/test_compressed.py#L137'>astropy/io/fits/hdu/compressed/tests/test_compressed.py:137:9:</a> RUF061 Use context-manager form of `pytest.raises()`
+ <a href='https://github.com/astropy/astropy/blob/3a070e29f1ea0cf6a7e186477a11190d35f42913/astropy/io/fits/tests/test_core.py#L1015'>astropy/io/fits/tests/test_core.py:1015:9:</a> RUF061 Use context-manager form of `pytest.raises()`
+ <a href='https://github.com/astropy/astropy/blob/3a070e29f1ea0cf6a7e186477a11190d35f42913/astropy/io/fits/tests/test_core.py#L1016'>astropy/io/fits/tests/test_core.py:1016:9:</a> RUF061 Use context-manager form of `pytest.raises()`
+ <a href='https://github.com/astropy/astropy/blob/3a070e29f1ea0cf6a7e186477a11190d35f42913/astropy/io/fits/tests/test_core.py#L1019'>astropy/io/fits/tests/test_core.py:1019:9:</a> RUF061 Use context-manager form of `pytest.raises()`
+ <a href='https://github.com/astropy/astropy/blob/3a070e29f1ea0cf6a7e186477a11190d35f42913/astropy/io/fits/tests/test_core.py#L1020'>astropy/io/fits/tests/test_core.py:1020:9:</a> RUF061 Use context-manager form of `pytest.raises()`
+ <a href='https://github.com/astropy/astropy/blob/3a070e29f1ea0cf6a7e186477a11190d35f42913/astropy/io/fits/tests/test_core.py#L1158'>astropy/io/fits/tests/test_core.py:1158:17:</a> RUF061 Use context-manager form of `pytest.raises()`
+ <a href='https://github.com/astropy/astropy/blob/3a070e29f1ea0cf6a7e186477a11190d35f42913/astropy/io/fits/tests/test_core.py#L336'>astropy/io/fits/tests/test_core.py:336:9:</a> RUF061 Use context-manager form of `pytest.raises()`
+ <a href='https://github.com/astropy/astropy/blob/3a070e29f1ea0cf6a7e186477a11190d35f42913/astropy/io/fits/tests/test_core.py#L337'>astropy/io/fits/tests/test_core.py:337:9:</a> RUF061 Use context-manager form of `pytest.raises()`
+ <a href='https://github.com/astropy/astropy/blob/3a070e29f1ea0cf6a7e186477a11190d35f42913/astropy/io/fits/tests/test_core.py#L338'>astropy/io/fits/tests/test_core.py:338:9:</a> RUF061 Use context-manager form of `pytest.raises()`
+ <a href='https://github.com/astropy/astropy/blob/3a070e29f1ea0cf6a7e186477a11190d35f42913/astropy/io/fits/tests/test_core.py#L339'>astropy/io/fits/tests/test_core.py:339:9:</a> RUF061 Use context-manager form of `pytest.raises()`
+ <a href='https://github.com/astropy/astropy/blob/3a070e29f1ea0cf6a7e186477a11190d35f42913/astropy/io/fits/tests/test_core.py#L349'>astropy/io/fits/tests/test_core.py:349:9:</a> RUF061 Use context-manager form of `pytest.raises()`
+ <a href='https://github.com/astropy/astropy/blob/3a070e29f1ea0cf6a7e186477a11190d35f42913/astropy/io/fits/tests/test_core.py#L352'>astropy/io/fits/tests/test_core.py:352:9:</a> RUF061 Use context-manager form of `pytest.raises()`
... 58 additional changes omitted for project
</pre>

</p>
</details>
<details><summary>Changes by rule (1 rules affected)</summary>
<p>

<p>| code | total | + violation | - violation | + fix | - fix |
| ---- | ------- | --------- | -------- | ----- | ---- |
| RUF061 | 231 | 231 | 0 | 0 | 0 |</p>
</p>
</details>

</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @twentyone212121 on 2025-04-12 14:36</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">rule</span> added by @ntBre on 2025-04-18 18:54</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/flake8_pytest_style/rules/raises.rs</code>:200 on 2025-04-18 18:58</div>
            <div class="timeline-body"><p>nit: maybe something like this:</p>
<pre><code class="language-suggestion">        Some(&quot;Use `pytest.raises()` as a context-manager&quot;.to_string())
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/flake8_pytest_style/rules/raises.rs</code>:188 on 2025-04-18 19:03</div>
            <div class="timeline-body"><p>We might want to leave the <code>Deprecated</code> part out of this name since it's not actually deprecated yet, and my quick skim of the open PR making it deprecated made it sound a bit contentious to deprecate it at all. I think this can still be a useful stylistic rule even if it's not formally deprecated.</p>
<p>As more of a nit, I find the rest of the name a bit awkward, but I can't think of anything better that still fits within our naming conventions.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/flake8_pytest_style/rules/raises.rs</code>:191 on 2025-04-18 19:03</div>
            <div class="timeline-body"><p>nit: I'd just import this so it fits on one line.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/flake8_pytest_style/rules/raises.rs</code>:188 on 2025-04-18 19:06</div>
            <div class="timeline-body"><p>To be fair, it is called the <code>legacy</code> form in the <a href="https://docs.pytest.org/en/stable/how-to/assert.html#alternate-form-legacy">docs</a>, but they also include this statement:</p>
<blockquote>
<p>Nonetheless, this form is fully supported and not deprecated in any way.</p>
</blockquote>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/flake8_pytest_style/rules/raises.rs</code>:355 on 2025-04-18 19:14</div>
            <div class="timeline-body"><p>Does anything here actually return a <code>Result</code> naturally? I might be missing something, but everything looks like it returns an <code>Option</code>, so we could just return an <code>Option</code> from the function and still use <code>?</code> everywhere. I don't think the additional messages from <code>bail</code> and <code>context</code> justify using a <code>Result</code> here.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/flake8_pytest_style/rules/raises.rs</code>:401 on 2025-04-18 19:15</div>
            <div class="timeline-body"><p>Same comment as above, I'd return an <code>Option</code> here if possible.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/flake8_pytest_style/rules/raises.rs</code>:404 on 2025-04-18 19:15</div>
            <div class="timeline-body"><p>If you want the value, I think you can use <code>find_argument_value</code> instead of having to <code>match</code> manually.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/flake8_pytest_style/rules/raises.rs</code>:413 on 2025-04-18 19:16</div>
            <div class="timeline-body"><p>Same as above, <code>find_argument_value</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/flake8_pytest_style/rules/raises.rs</code>:453 on 2025-04-18 19:21</div>
            <div class="timeline-body"><p>I'm not sure there's anything inherently wrong with this, but it feels weird to be comparing the actual <code>Expr</code> values for equality here. Can we just use <code>arguments_source_order</code> and skip the first two elements of the iterator?</p>
<p>https://github.com/astral-sh/ruff/blob/1108f662e47e8ff5456f00e5a0742f1cd9e95852/crates/ruff_python_ast/src/nodes.rs#L2904-L2908</p>
<p>We should have already bailed out if we didn't find the <code>func</code> or <code>expected_exception</code> arguments, I think.</p>
<p>You'll still have to partition these into <code>args</code> and <code>keywords</code> to put into <code>func_call</code> below, but I think it will read a bit more nicely. You can also use <code>.cloned()</code> on the iterator to avoid needing to map separate <code>clone</code> calls.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/flake8_pytest_style/rules/raises.rs</code>:244 on 2025-04-18 19:26</div>
            <div class="timeline-body"><p>This may not be helpful because I'm not that familiar with this part of the API, but we do have an <code>adjust_indentation</code> function in the <code>edits</code> module:</p>
<p>https://github.com/astral-sh/ruff/blob/1108f662e47e8ff5456f00e5a0742f1cd9e95852/crates/ruff_linter/src/fix/edits.rs#L348-L354</p>
<p>It might be worth giving it a try to avoid having to manually handle it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/codes.rs</code>:842 on 2025-04-18 19:28</div>
            <div class="timeline-body"><p>As you said in the PR description, this may end up needing to be a ruff rule instead, but we can delay changing that until right before landing.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-04-18 19:40</div>
            <div class="timeline-body"><p>Thanks for working on this!</p>
<p>I had some code style suggestions, but the overall approach looks good to me.</p>
<p>With regard to the multi-statement case, I think your example in the PR summary <em>is</em> actually ideal, based on my reading of the pytest docs. See the first <code>Note</code> box in <a href="https://docs.pytest.org/en/stable/reference/reference.html#pytest-raises">this section</a>:</p>
<blockquote>
<p>When using pytest.raises as a context manager, it’s worthwhile to note that normal context manager rules apply and that the exception raised must be the final line in the scope of the context manager. Lines of code after that, within the scope of the context manager will not be executed. For example:</p>
</blockquote>
<p>However, to be safe, we may want to avoid offering a fix if the value returned by <code>raises</code> is assigned to a variable, or at least if we can see that variable being used later.
On the other hand, it's already an unsafe fix, so if my reading of the pytest docs is correct, the behavior here might be right in most cases.</p>
<p>Either way, we should add some test cases demonstrating whatever the behavior ends up being.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/webknjaz">@webknjaz</a> reviewed on 2025-04-18 20:19</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/webknjaz">@webknjaz</a> on <code>crates/ruff_linter/src/rules/flake8_pytest_style/rules/raises.rs</code>:188 on 2025-04-18 20:19</div>
            <div class="timeline-body"><p>Yeah, we've been debating the deprecation and mostly settled on “let's try soft-deprecating and see if people complain, but meanwhile let the formatters/linters catch this”: https://github.com/pytest-dev/pytest/pull/13241#issuecomment-2694138535. The PR currently uses a <code>PendingDeprecationWarning</code> FWIW.</p>
<p>That “legacy” form is the stdlib unittest baggage, I think. It's probably mostly met in ancient code bases. I'd call it “discouraged” instead of “deprecated”. Or, perhaps, “unintuitive” or “callback-style”.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/twentyone212121">@twentyone212121</a> reviewed on 2025-04-19 13:54</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/twentyone212121">@twentyone212121</a> on <code>crates/ruff_linter/src/rules/flake8_pytest_style/rules/raises.rs</code>:355 on 2025-04-19 13:54</div>
            <div class="timeline-body"><p>I agree, I replaced <code>Result</code> with <code>Option</code>. The additional messages were helpful for debugging earlier, but using <code>Option</code> makes things clearer now.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/twentyone212121">@twentyone212121</a> reviewed on 2025-04-19 13:54</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/twentyone212121">@twentyone212121</a> on <code>crates/ruff_linter/src/rules/flake8_pytest_style/rules/raises.rs</code>:404 on 2025-04-19 13:54</div>
            <div class="timeline-body"><p>Thanks! That’s definitely cleaner</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/twentyone212121">@twentyone212121</a> reviewed on 2025-04-19 13:55</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/twentyone212121">@twentyone212121</a> on <code>crates/ruff_linter/src/rules/flake8_pytest_style/rules/raises.rs</code>:453 on 2025-04-19 13:55</div>
            <div class="timeline-body"><p>Yeah, I agree it felt awkward. I initially thought we couldn’t just skip the first two arguments since they aren't positional-only, but I also couldn’t come up with a <code>pytest.raises</code> call where <code>expected_exception</code> and <code>func</code> aren’t the first two.</p>
<p>I refactored it in the latest commit to use <code>arguments_source_order</code> and <code>partition_map</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/twentyone212121">@twentyone212121</a> reviewed on 2025-04-19 13:57</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/twentyone212121">@twentyone212121</a> on <code>crates/ruff_linter/src/rules/flake8_pytest_style/rules/raises.rs</code>:244 on 2025-04-19 13:57</div>
            <div class="timeline-body"><p>From what I could tell, <code>adjust_indentation</code> seems to be mostly used for dedenting code that already exists in the source.</p>
<p>When I was looking into similar fixes that turn a single statement into an indented block, I found the <a href="https://docs.astral.sh/ruff/rules/lambda-assignment/">lambda-assignment rule</a>, and borrowed the indentation logic from there:
https://github.com/astral-sh/ruff/blob/1108f662e47e8ff5456f00e5a0742f1cd9e95852/crates/ruff_linter/src/rules/pycodestyle/rules/lambda_assignment.rs#L80-L97</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/twentyone212121">@twentyone212121</a> reviewed on 2025-04-19 14:04</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/twentyone212121">@twentyone212121</a> on <code>crates/ruff_linter/src/rules/flake8_pytest_style/rules/raises.rs</code>:188 on 2025-04-19 14:04</div>
            <div class="timeline-body"><p>Should I rename it to <code>LegacyPytestRaises</code> or maybe <code>CallablePytestRaises</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/twentyone212121">@twentyone212121</a> on 2025-04-19 14:24</div>
            <div class="timeline-body"><p>Thanks for the review!</p>
<p>About the multi-statement case — I initially thought it wasn’t ideal, since in the context manager form, <code>pytest.raises</code> accepts the match argument directly, so there's no need for a separate assertion. That said, I’m not sure whether this rule should be responsible for transforming that pattern.</p>
<p>Regarding the tests, I’ve added a multi-statement case, as well as a case where <code>func</code> is a lambda.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/webknjaz">@webknjaz</a> reviewed on 2025-04-19 17:21</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/webknjaz">@webknjaz</a> on <code>crates/ruff_linter/src/rules/flake8_pytest_style/rules/raises.rs</code>:188 on 2025-04-19 17:21</div>
            <div class="timeline-body"><p>Callable seems off. Callback would be more accurate.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/flake8_pytest_style/rules/raises.rs</code>:453 on 2025-04-23 15:27</div>
            <div class="timeline-body"><p>The docs don't seem quite as clear for the legacy form as for the context manager version, but it at least looks like you need them both, and any following args are passed to <code>func</code>, so it should be safe (I hope), as long as we already checked explicitly for the first two arguments.</p>
<p>I'll give this another review today!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-04-23 15:27</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-04-24 06:21</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/flake8_pytest_style/rules/raises.rs</code>:188 on 2025-04-24 06:21</div>
            <div class="timeline-body"><p>How about <code>LegacyFormPytestRaises</code> or <code>PytestRaisesAsFunction</code>?</p>
<p>It would match the terminolgoy used in the documentation. Other options are <code>pytest-raises-with-func</code> because that's really what we detect. What I find interesting is that this form is listed in context manager form in the pytest documentation (but what I understand is that it isn't supposed to be used in a context manager position)</p>
<p>with raises(expected_exception: <a href="https://docs.python.org/3/library/functions.html#type">type</a>[E] | <a href="https://docs.python.org/3/library/stdtypes.html#tuple">tuple</a>[<a href="https://docs.python.org/3/library/functions.html#type">type</a>[E], ...], func: <a href="https://docs.python.org/3/library/typing.html#typing.Callable">Callable</a>[[...], <a href="https://docs.python.org/3/library/typing.html#typing.Any">Any</a>], *args: <a href="https://docs.python.org/3/library/typing.html#typing.Any">Any</a>, **kwargs: <a href="https://docs.python.org/3/library/typing.html#typing.Any">Any</a>) → <a href="https://docs.pytest.org/en/stable/reference/reference.html#pytest.ExceptionInfo">ExceptionInfo</a>[E] as excinfo</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-04-24 06:24</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/flake8_pytest_style/rules/raises.rs</code>:247 on 2025-04-24 06:24</div>
            <div class="timeline-body"><p>Is it guaranteed that the generator always fits the with-context on a single line?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-04-24 18:31</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/flake8_pytest_style/rules/raises.rs</code>:188 on 2025-04-24 18:31</div>
            <div class="timeline-body"><p>I like <code>LegacyFormPytestRaises</code> or maybe <code>PytestRaisesLegacyForm</code>, but these all sound good to me.</p>
<p>Ahh, that does explain why I didn't see a signature under the <code>Legacy</code> heading. I think you're right that that is the legacy form signature but with <code>with</code> in front of it.</p>
<p>What do you think about the rule category? <code>RUF</code> might make more sense just to be safe. The upstream PR still hasn't had any updates, but new rules were added in January, so it's still active.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-04-24 18:42</div>
            <div class="timeline-body"><p>Thanks, this looks great. I think now we just need to:</p>
<ul>
<li>decide on a name</li>
<li>decide on a rule category</li>
<li>address Micha's comment about the single line</li>
</ul>
<p>I made some suggestions about the first two <a href="https://github.com/astral-sh/ruff/pull/17368#discussion_r2059015744">here</a>, but I'm definitely interested in other thoughts.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-04-24 20:27</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/flake8_pytest_style/rules/raises.rs</code>:188 on 2025-04-24 20:27</div>
            <div class="timeline-body"><p>We should add the rule to the Ruff group.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/twentyone212121">@twentyone212121</a> reviewed on 2025-04-29 07:46</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/twentyone212121">@twentyone212121</a> on <code>crates/ruff_linter/src/rules/flake8_pytest_style/rules/raises.rs</code>:247 on 2025-04-29 07:46</div>
            <div class="timeline-body"><p>From my testing, the generator always produces a single-line <code>with</code> statement, even if the original <code>pytest.raises</code> call was split across multiple lines. I tried two cases:</p>
<ol>
<li><p>A very long <code>expected_exception</code>:</p>
<pre><code class="language-python">def test():
    pytest.raises(
        VeryLongExceptionThatExceeds80CharactersToTestWhetherGeneratedWithStatementIsOneLineOrNot,
        test_func,
    )
</code></pre>
<p>After applying the rule, it’s fixed to:</p>
<pre><code class="language-python">def test():
    with pytest.raises(VeryLongExceptionThatExceeds80CharactersToTestWhetherGeneratedWithStatementIsOneLineOrNot):
        test_func()
</code></pre>
<p>Although the resulting line is not formatted according to ruff, it is still generated as a single line.</p>
</li>
<li><p>A multiline <code>match</code> string:</p>
<pre><code class="language-python">def test():
    pytest.raises(ValueError, test_func).match(
        &quot;&quot;&quot;a
        b&quot;&quot;&quot;
    )
</code></pre>
<p>After applying the rule:</p>
<pre><code class="language-python">def test():
    with pytest.raises(ValueError, match=&quot;&quot;&quot;a\n           b&quot;&quot;&quot;):
        test_func()
</code></pre>
<p>The <code>with</code> statement is produced on a single line.</p>
</li>
</ol>
<p>I don't know if it's okay to generate potentially unformatted code, but it seems like the generator doesn't format its output.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/twentyone212121">@twentyone212121</a> reviewed on 2025-04-29 07:50</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/twentyone212121">@twentyone212121</a> on <code>crates/ruff_linter/src/rules/flake8_pytest_style/rules/raises.rs</code>:188 on 2025-04-29 07:50</div>
            <div class="timeline-body"><p>I also like <code>LegacyFormPytestRaises</code>, so if everyone agrees, I'll rename the rule</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/twentyone212121">@twentyone212121</a> reviewed on 2025-04-29 07:54</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/twentyone212121">@twentyone212121</a> on <code>crates/ruff_linter/src/codes.rs</code>:842 on 2025-04-29 07:54</div>
            <div class="timeline-body"><p>Should I assign <code>RUF103</code> code to the rule? Also, if the rule is renamed, is it okay for the checking code to be in <code>flake8_pytest_style</code> folder?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/twentyone212121">@twentyone212121</a> on 2025-04-29 08:02</div>
            <div class="timeline-body"><p>Should we also handle legacy forms of <code>pytest.warns</code> and <code>pytest.deprecated_call</code>? They are mentioned in the <a href="https://github.com/pytest-dev/pytest/pull/13241">PR to pytest</a>. These functions are slightly different from <code>pytest.raises</code>, so I’ll need to think about how best to integrate them into the current code to avoid code duplication.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-04-29 22:00</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/codes.rs</code>:842 on 2025-04-29 22:00</div>
            <div class="timeline-body"><p>It looks like <code>RUF60</code> would be the lowest unused code, but we need to double-check that there aren't any other open PRs using it.</p>
<p>I think we'd also want to move the implementation, tests, and snapshots to the <code>rules/ruff</code> directory. It's always a bit tedious to move these around, sorry!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntBre">@ntBre</a> on 2025-04-29 22:05</div>
            <div class="timeline-body"><blockquote>
<p>Should we also handle legacy forms of <code>pytest.warns</code> and <code>pytest.deprecated_call</code>? They are mentioned in the <a href="https://github.com/pytest-dev/pytest/pull/13241">PR to pytest</a>. These functions are slightly different from <code>pytest.raises</code>, so I’ll need to think about how best to integrate them into the current code to avoid code duplication.</p>
</blockquote>
<p>I think it's okay to handle these separately in follow-up PRs, or even as different rules, if that sounds good to @MichaReiser.</p>
<p>If we want to include them in this rule, it could possibly affect our name choice too.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-04-29 22:07</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/codes.rs</code>:842 on 2025-04-29 22:07</div>
            <div class="timeline-body"><p>It looks like there are two open PRs for rules using RUF060 (and an additional closed one), so let's go for <code>RUF061</code>, which I didn't see any results for.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-04-30 06:40</div>
            <div class="timeline-body"><p>We should figure out the scope of this rule before landing this PR because renaming is somewhat annoying (we need to setup redirects for documentation).</p>
<p>Whether it should be one or multiple rules normally comes down to whether there are cases where a user might only want to be warned about <code>pytest.warns</code> but not about <code>pytest.deprecated_call</code> or <code>pytest.raises</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntBre">@ntBre</a> on 2025-04-30 13:22</div>
            <div class="timeline-body"><blockquote>
<p>Whether it should be one or multiple rules normally comes down to whether there are cases where a user might only want to be warned about <code>pytest.warns</code> but not about <code>pytest.deprecated_call</code> or <code>pytest.raises</code>.</p>
</blockquote>
<p>From that perspective, I'd probably lean towards one rule because it seems more consistent stylistically to move them all at once. But I'm definitely open to other ideas. I've only personally used the context manager forms of these.</p>
<p>We can still add support for the other functions in follow-up PRs (unless they're easy to add here), but we should definitely decide on the scope and name here to avoid future churn with the name, as Micha said.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/twentyone212121">@twentyone212121</a> on 2025-05-02 01:47</div>
            <div class="timeline-body"><p>I agree with Brent that it makes sense to combine all of these into 1 rule. I've made the following changes to the PR:</p>
<ul>
<li>In the first commit, I renamed the rule and moved it to the <code>RUF</code> category.</li>
<li>In the second one, I've expanded the rule to cover <code>pytest.warns</code> and <code>pytest.deprecated_call</code>. Also, renamed it to <code>LegacyFormPytestRaisesWarnsDeprecatedCall</code> (I'm open to suggestions about the name).</li>
</ul>
<p>Note that unlike <code>pytest.raises</code>, both <code>pytest.warns</code> and <code>pytest.deprecated_call</code> return the result of the <code>func</code> they execute, not a context. Therefore, if these functions' results are assigned to a target, we treat it as an assign target in the body rather than an optional var. I tried to minimize code duplication by handling all variants in the same functions, which may make the code appear somewhat complex.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/ruff/rules/legacy_form_pytest_raises.rs</code>:131 on 2025-05-12 18:29</div>
            <div class="timeline-body"><pre><code class="language-suggestion">    let stmt = semantic.current_statement();
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/ruff/rules/legacy_form_pytest_raises.rs</code>:135 on 2025-05-12 18:30</div>
            <div class="timeline-body"><pre><code class="language-suggestion">        if let Some(with_stmt) = try_fix_legacy_call(context_type, stmt, semantic) {
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/ruff/rules/legacy_form_pytest_raises.rs</code>:181 on 2025-05-12 18:37</div>
            <div class="timeline-body"><p>I think some example Python code in a comment might help me here. It seems like this is doing something important, but all I can think is &quot;didn't we already call <code>PytestContextType::from_expr_name</code> above?&quot; What kind of code will lead to the different branches here?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/ruff/rules/legacy_form_pytest_raises.rs</code>:230 on 2025-05-12 18:43</div>
            <div class="timeline-body"><p>I think we could use <code>and_then</code> here (but haven't tested it):</p>
<pre><code class="language-suggestion">    let expected = context_type.expected_arg().and_then(|(name, position)| legacy_call.arguments.find_argument_value(name, position));
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/ruff/snapshots/ruff_linter__rules__ruff__tests__RUF061_RUF061_deprecated_call.py.snap</code>:57 on 2025-05-12 18:47</div>
            <div class="timeline-body"><p>Hmm, it would be kind of nice if we could unwrap the <code>lambda</code> since this looks a bit awkward, but I'm not sure how tricky that would be.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/ruff/rules/legacy_form_pytest_raises.rs</code>:106 on 2025-05-12 18:49</div>
            <div class="timeline-body"><p>Could we do a <code>Display</code> impl here? Then we could possibly store a <code>PytestContextType</code> on the <code>Violation</code> struct and just pass it directly to the <code>format!</code> calls above.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/ruff/rules/legacy_form_pytest_raises.rs</code>:46 on 2025-05-12 18:57</div>
            <div class="timeline-body"><p>This name seems a bit unwieldy, but I'm not really coming up with something better. Is there some kind of catch-all term that covers all three?</p>
<p>The pytest docs for <code>warns</code> actually say:</p>
<blockquote>
<p>Assert that code <strong>raises</strong> a particular class of warning.</p>
</blockquote>
<p>So I think it would be fairly reasonable just to call it <code>LegacyFormPytestRaises</code> still. Not to say it's an ideal practice, but we do have some other rules with names that are more specific than the actual implementation, like <a href="https://docs.astral.sh/ruff/rules/yield-outside-function/#yield-outside-function-f704">yield-outside-function (F704)</a>, which actually covers <code>yield</code>, <code>yield from</code>, and even <code>await</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-05-12 18:58</div>
            <div class="timeline-body"><p>Thanks! This is looking great. Just a few minor nits/suggestions/questions.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/twentyone212121">@twentyone212121</a> reviewed on 2025-05-18 11:22</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/twentyone212121">@twentyone212121</a> on <code>crates/ruff_linter/src/rules/ruff/rules/legacy_form_pytest_raises.rs</code>:181 on 2025-05-18 11:22</div>
            <div class="timeline-body"><p>This handles two cases for legacy calls:</p>
<ol>
<li>Direct usage: <code>pytest.raises(ZeroDivisionError, func, 1, b=0)</code></li>
<li>With match method: <code>pytest.raises(ZeroDivisionError, func, 1, b=0).match(&quot;division by zero&quot;)</code></li>
</ol>
<p>The second branch specifically looks for <code>raises().match()</code> pattern which only exists for <code>raises</code> (not <code>warns</code>/<code>deprecated_call</code>) since only <code>raises</code> returns an <code>ExceptionInfo</code> object with a <code>.match()</code> method. We need to preserve this match condition when converting.</p>
<p>I have modified the comment to explain it better. There is also a test case for this in <code>RUF061_raises.py</code>:</p>
<pre><code class="language-Python">def test_error_match():
    pytest.raises(ZeroDivisionError, func, 1, b=0).match(&quot;division by zero&quot;)
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/twentyone212121">@twentyone212121</a> reviewed on 2025-05-18 11:22</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/twentyone212121">@twentyone212121</a> on <code>crates/ruff_linter/src/rules/ruff/rules/legacy_form_pytest_raises.rs</code>:230 on 2025-05-18 11:22</div>
            <div class="timeline-body"><p>I think we can't use <code>and_then</code> here because we need different behavior:
For <code>raises</code>/<code>warns</code>, the <code>?</code> operator returns early if the argument isn't found.
For <code>deprecated_call</code>, we expect <code>None</code> and continue.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/twentyone212121">@twentyone212121</a> reviewed on 2025-05-18 11:22</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/twentyone212121">@twentyone212121</a> on <code>crates/ruff_linter/src/rules/ruff/snapshots/ruff_linter__rules__ruff__tests__RUF061_RUF061_deprecated_call.py.snap</code>:57 on 2025-05-18 11:22</div>
            <div class="timeline-body"><p>Yes, unwrapping the lambda would be cleaner output. For simple cases like this with no arguments, we could extract the lambda body and use it directly.</p>
<p>However, I am not sure if it's within the scope of the current rule. If you think it's worth addressing now though, I can expand the implementation.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/twentyone212121">@twentyone212121</a> reviewed on 2025-05-18 11:22</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/twentyone212121">@twentyone212121</a> on <code>crates/ruff_linter/src/rules/ruff/rules/legacy_form_pytest_raises.rs</code>:46 on 2025-05-18 11:22</div>
            <div class="timeline-body"><p>Yes, it's quite long. I agree that <code>LegacyFormPytestRaises</code> will be cleaner. I renamed it in the latest commit.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/jakkdl">@jakkdl</a> on 2025-05-26 10:09</div>
            <div class="timeline-body"><p>Oh I'd completely missed this PR, happy to see progress despite my PR to <code>flake8-pytest-style</code> going stale. :rocket:</p>
<p>I suppose I can see the logic that transforming</p>
<pre><code class="language-python">with pytest.raises(ValueError) as excinfo:
    ...
assert excinfo.match(&quot;bar&quot;)
</code></pre>
<p>into</p>
<pre><code class="language-python">with pytest.raises(ValueError, match=&quot;bar&quot;):
    ...
</code></pre>
<p>might not be the primary responsibility of this rule, but I do think it's a shame as the latter is <em>much</em> cleaner.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> approved on 2025-06-16 14:38</div>
            <div class="timeline-body"><p>Thanks and sorry for the delay here. I think all of my questions have been resolved.</p>
<p>Could you merge <code>main</code> and update the title/description? GitHub isn't showing any conflicts, but I've made some changes to our diagnostic reporting that I think will actually cause problems if we don't merge first. Basically instead of <code>Diagnostic::new</code> and a later <code>checker.report_diagnostic</code>, you'll just need to call <code>checker.report_diagnostic</code> with whatever you previously passed to <code>Diagnostic::new</code>. I'm happy to help with that or take care of it if you prefer.</p>
<p>Other than that I think this is good to go.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">preview</span> added by @ntBre on 2025-06-16 14:38</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">preview</span> added by @ntBre on 2025-06-16 14:38</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/twentyone212121">@twentyone212121</a> on 2025-06-16 16:21</div>
            <div class="timeline-body"><p>Thanks! I’ve merged <code>main</code> and fixed the build errors from the diagnostic changes. Also updated the title earlier. It’s now <code>LegacyFormPytestRaises</code> as you suggested earlier. Or did you mean the PR title/description?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "[`flake8-pytest-style`] Deprecated `pytest.raises` callable form rule + fix (`PT032`)" to "[`ruff`] Check for non-contextmanager use of `pytest.raises` & friends (`RUF061`)" by @twentyone212121 on 2025-06-16 16:23</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> approved on 2025-06-16 17:00</div>
            <div class="timeline-body"><p>Thanks! And nice work on the <code>AtomicNodeIndex</code> changes, I hadn't even seen those myself yet.</p>
<blockquote>
<p>Thanks! I’ve merged main and fixed the build errors from the diagnostic changes. Also updated the title earlier. It’s now LegacyFormPytestRaises as you suggested earlier. Or did you mean the PR title/description?</p>
</blockquote>
<p>Yeah I meant the PR title and description, but I see you got those too. Thanks again!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "[`ruff`] Check for non-contextmanager use of `pytest.raises` & friends (`RUF061`)" to "[`ruff`] Check for non-context-manager use of `pytest.raises`, `pytest.warns`, and `pytest.deprecated_call` (`RUF061`)" by @ntBre on 2025-06-16 17:03</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntBre">@ntBre</a> on 2025-06-16 17:03</div>
            <div class="timeline-body"><p>(Just made the title a bit more verbose for inclusion directly into the release notes!)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @ntBre on 2025-06-16 17:03</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @ntBre on 2025-06-16 17:03</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 18:39:35 UTC
    </footer>
</body>
</html>
