<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[red-knot] More comprehensive `is_assignable_to` tests - astral-sh/ruff #15353</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[red-knot] More comprehensive <code>is_assignable_to</code> tests</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/15353">#15353</a>
        opened by <a href="https://github.com/sharkdp">@sharkdp</a>
        on 2025-01-08 13:52
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-01-08 13:52</div>
            <div class="timeline-body"><h2>Summary</h2>
<p>This changeset migrates all existing <code>is_assignable_to</code> tests to a Markdown-based test. It also increases our test coverage in a hopefully meaningful way (not claiming to be complete in any sense). But at least I found and fixed one bug while doing so.</p>
<h2>Test Plan</h2>
<p>Ran property tests to make sure the new test succeeds after fixing it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by @sharkdp on 2025-01-08 13:52</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @sharkdp on 2025-01-08 13:52</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @sharkdp on 2025-01-08 13:52</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @AlexWaygood by @sharkdp on 2025-01-08 13:52</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:4105 on 2025-01-08 13:54</div>
            <div class="timeline-body"><p>These two tests have no equivalent right now, but we have a <code>todo_types</code> Rust unit test that makes sure <code>int</code> is assignable to <code>@Todo</code> and vice versa.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-01-08 13:54</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-01-08 13:56</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/red_knot_python_semantic/resources/mdtest/type_properties/is_assignable_to.md</code>:84 on 2025-01-08 13:56</div>
            <div class="timeline-body"><p>We could also remove/reduce these tests as they are covered by property tests, but I guess they don't really hurt? (and as we have learned yesterday and with the new bug uncovered here, it's easy to get some of them wrong)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-01-08 13:58</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>âœ… ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>âœ… ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/red_knot_python_semantic/resources/mdtest/type_properties/is_assignable_to.md</code>:15 on 2025-01-08 13:58</div>
            <div class="timeline-body"><p>I thought about splitting this into multiple Markdown sections, but it didn't feel like this would improve the structure a lot, and I would have to repeat these imports multiple times.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-01-08 13:58</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-01-08 14:02</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/red_knot_python_semantic/resources/mdtest/type_properties/is_assignable_to.md</code>:84 on 2025-01-08 14:02</div>
            <div class="timeline-body"><p>The last of these tests here (<code>is_assignable_to(Never, type[Any])</code>) is what's failing on main.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/resources/mdtest/type_properties/is_assignable_to.md</code>:153 on 2025-01-08 14:04</div>
            <div class="timeline-body"><p>the reason I used <code>ABCMeta</code> for these tests when they were a unit test was that it was an easily accessible stdlib metaclass. But now that we're rewriting these tests as mdtests, we can create our own custom metaclass as part of the test. This would make it easier for a casual reader to understand the purpose of the test, and would make the test more robust (it means the test won't break if typeshed unexpectedly changes the definition of <code>ABCMeta</code> -- I don't know <em>why</em> we'd do that in typeshed, but it still seems best to keep our tests isolated from typeshed where possible).</p>
<p>The metaclass could just be as simple as:</p>
<pre><code class="language-py">class Meta(type): ...
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/resources/mdtest/type_properties/is_assignable_to.md</code>:15 on 2025-01-08 14:06</div>
            <div class="timeline-body"><p>hmm, I do think splitting it into different Markdown sections would make the mdtest report easier to understand if the test failed. The nearest subheading is printed to the terminal when an mdtest fails, but in this file, it's just one huge test under the heading <code># Assignable-to relation</code>, so it might be harder to figure out quickly exactly what about the assignable-to relation has gone wrong when a test fails</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/types/property_tests.rs</code>:307 on 2025-01-08 14:07</div>
            <div class="timeline-body"><p>Should we also have a subtyping version of this for fully static types?</p>
<pre><code class="language-suggestion">    // Never should be assignable to every type
    type_property_test!(
        never_assignable_to_every_type, db,
        forall types t. Type::Never.is_assignable_to(db, t)
    );
    
    // and it should be a subtype of all fully static types
    type_property_test!(
        never_subtype_of_every_fully_static_type, db,
        forall types t. t.is_fully_static(db) =&gt; Type::Never.is_subtype_of(db, t)
    );
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-01-08 14:08</div>
            <div class="timeline-body"><p>Fantastic!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-01-08 14:11</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/red_knot_python_semantic/resources/mdtest/type_properties/is_assignable_to.md</code>:15 on 2025-01-08 14:11</div>
            <div class="timeline-body"><p>I did have quite a few failing assertions while writing those tests, and since we report proper spans for those static assertion failures, it's actually quite easy to jump to the exact line that is failing. If you still think it makes sense to split them anyway, I'm happy to do that. I agree that it would probably look nicer (in rendered form).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-01-08 14:13</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/red_knot_python_semantic/resources/mdtest/type_properties/is_assignable_to.md</code>:153 on 2025-01-08 14:13</div>
            <div class="timeline-body"><blockquote>
<p>This would make it easier for a casual reader to understand the purpose of the test</p>
</blockquote>
<p>Indeed! I was actually wondering what was special about <code>ABCMeta</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-01-08 14:14</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/resources/mdtest/type_properties/is_assignable_to.md</code>:15 on 2025-01-08 14:14</div>
            <div class="timeline-body"><p>Good point about the spans... but yeah, I still think I'd weakly prefer to have it split up, for improved readability when rendered :-)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-01-08 14:17</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/resources/mdtest/type_properties/is_assignable_to.md</code>:84 on 2025-01-08 14:17</div>
            <div class="timeline-body"><p>The unit tests generally use simpler types than what the property tests come up with, so I do like having both, for ease of debugging test failures ðŸ˜„ though maybe that's improved now that https://github.com/astral-sh/ruff/pull/15297 has landed, and we have more shrinking -- I haven't experienced any property test failures in the last day, so I don't know what the new experience is like!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">testing</span> added by @AlexWaygood on 2025-01-08 14:21</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-01-08 14:34</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/red_knot_python_semantic/resources/mdtest/type_properties/is_assignable_to.md</code>:84 on 2025-01-08 14:34</div>
            <div class="timeline-body"><p><img src="https://github.com/user-attachments/assets/04afaa91-fbb4-45fd-9b56-7f9154b8d229" alt="image" /></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-01-08 14:59</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/red_knot_python_semantic/resources/mdtest/type_properties/is_assignable_to.md</code>:15 on 2025-01-08 14:59</div>
            <div class="timeline-body"><p>Done. You may now print your personal hardcover version.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> approved on 2025-01-08 17:33</div>
            <div class="timeline-body"><p>Love it, thank you!!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/resources/mdtest/type_properties/is_assignable_to.md</code>:10 on 2025-01-08 17:40</div>
            <div class="timeline-body"><pre><code class="language-suggestion">### Fully static

Fully static types participate in subtyping. If a type `S` is a subtype of `T`,
`S` will also be assignable to `T`. Two equivalent types are subtypes of each other:
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/resources/mdtest/type_properties/is_assignable_to.md</code>:37 on 2025-01-08 17:41</div>
            <div class="timeline-body"><pre><code class="language-suggestion">### Gradual types

Gradual types do not participate in subtyping, but can still be assignable to other 
types (and static types can be assignable to gradual types):
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/resources/mdtest/type_properties/is_assignable_to.md</code>:54 on 2025-01-08 17:41</div>
            <div class="timeline-body"><pre><code class="language-suggestion">### Boolean literals

`Literal[True]` and `Literal[False]` are both subtypes of (and therefore
assignable to) `bool`, which is in turn a subtype of `int`:
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/resources/mdtest/type_properties/is_assignable_to.md</code>:85 on 2025-01-08 17:44</div>
            <div class="timeline-body"><pre><code class="language-suggestion">### String literals and `LiteralString`

All string-literal types are subtypes of (and therefore assignable to) `LiteralString`,
which is in turn a subtype of `str`:
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/resources/mdtest/type_properties/is_assignable_to.md</code>:178 on 2025-01-08 17:45</div>
            <div class="timeline-body"><p>We could also add</p>
<pre><code class="language-suggestion">static_assert(is_assignable_to(type[Any], Meta))
static_assert(is_assignable_to(type[Unknown], Meta))
static_assert(is_assignable_to(Meta, type[Any]))
static_assert(is_assignable_to(Meta, type[Unknown]))
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/resources/mdtest/type_properties/is_assignable_to.md</code>:183 on 2025-01-08 17:46</div>
            <div class="timeline-body"><p>we don't have any gradual tuples in this seciton, and I wonder if we should (e.g. <code>tuple[Any, Literal[2]]</code> should be assignable to <code>tuple[int, int]</code> but not to <code>tuple[int, str]</code>). Doesn't <em>need</em> to be done in this PR, though</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/resources/mdtest/type_properties/is_assignable_to.md</code>:283 on 2025-01-08 17:48</div>
            <div class="timeline-body"><pre><code class="language-suggestion">### Everything is assignable to `object`

`object` is Python's top type; the set of all possible objects at runtime:
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/resources/mdtest/type_properties/is_assignable_to.md</code>:302 on 2025-01-08 17:49</div>
            <div class="timeline-body"><pre><code class="language-suggestion">### Every type is assignable to `Any` / `Unknown`

`Any` and `Unknown` are gradual types. They could materialize to any given type at
runtime, and so any type is assignable to them:
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/resources/mdtest/type_properties/is_assignable_to.md</code>:332 on 2025-01-08 17:49</div>
            <div class="timeline-body"><pre><code class="language-suggestion">### `Never` is assignable to every type

`Never` is Python's bottom type: the empty set, a type with no inhabitants.
It is therefore assignable to any arbitrary type.
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/resources/mdtest/type_properties/is_assignable_to.md</code>:123 on 2025-01-08 17:54</div>
            <div class="timeline-body"><pre><code class="language-suggestion">In the following tests, `TypeOf[str]` is a singleton type with a single inhabitant, the class `str`.
This contrasts with `type[str]`, which represents &quot;all possible subclasses of `str`&quot;.

Both `TypeOf[str]` and `type[str]` are subtypes of `type` and `type[object`], which both 
represents &quot;all possible instances of `type`&quot;; therefore both `type[str]` and 
`TypeOf[str]` are assignable to `type`. `type[Any]`, on the other hand, represents a
type of unknown size or inhabitants, but which is known to be no larger than the set of
possible objects represented by `type`.
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> approved on 2025-01-08 17:55</div>
            <div class="timeline-body"><p>Some suggested commentary. But I don't mind if you want to leave it to a followup! (And I'm happy to do the followup.) Feel free to merge!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-01-08 18:37</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/resources/mdtest/type_properties/is_assignable_to.md</code>:126 on 2025-01-08 18:37</div>
            <div class="timeline-body"><pre><code class="language-suggestion">Both `TypeOf[str]` and `type[str]` are subtypes of `type` and `type[object]`, which both represent
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-01-08 19:19</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/red_knot_python_semantic/resources/mdtest/type_properties/is_assignable_to.md</code>:183 on 2025-01-08 19:19</div>
            <div class="timeline-body"><p>I did that now, and also added tests with gradual types in the union and intersection types sections.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @sharkdp on 2025-01-08 19:25</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @sharkdp on 2025-01-08 19:25</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-01-08 19:25</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 20:34:29 UTC
    </footer>
</body>
</html>
