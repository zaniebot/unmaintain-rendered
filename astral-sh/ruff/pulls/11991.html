<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Improve normalization of `VendoredPath`s - astral-sh/ruff #11991</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Improve normalization of <code>VendoredPath</code>s</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/pull/11991">#11991</a>
        opened by <a href="https://github.com/AlexWaygood">@AlexWaygood</a>
        on 2024-06-23 18:21
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a></div>
            <div class="timeline-body">Summary
<p>This is a competing PR to #11989. Instead of making <code>VendoredPath</code> normalization eager, it makes the lazy normalization that we currently do more principled:</p>
<ul>
<li>the normalization function checks for <code>..</code> path components that attempt to &quot;escape&quot; from the zip archive altogether (e.g. <code>VendoredPath(&quot;..&quot;)</code> should be rejected)</li>
<li>the normalization function returns a <code>Result</code> instead of panicking if the <code>VendoredPath</code> is invalid.</li>
</ul>
Test Plan
<p><code>cargo test -p ruff_db</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/MichaReiser">@MichaReiser</a> by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-06-23 18:21</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/codspeed-hq[bot]">@codspeed-hq[bot]</a> on 2024-06-23 18:26</div>
            <div class="timeline-body"><a href="https://codspeed.io/astral-sh/ruff/branches/vendored-parts-parent-part">CodSpeed Performance Report</a>
Merging #11991 will <strong>improve performances by 4.89%</strong>
<p>Comparing <code>vendored-parts-parent-part</code> (5a18ac8) with <code>main</code> (068b75c)</p>
Summary
<p><code>⚡ 1</code> improvements
<code>✅ 29</code> untouched benchmarks</p>
Benchmarks breakdown
<p>|     | Benchmark | <code>main</code> | <code>vendored-parts-parent-part</code> | Change |
| --- | --------- | ----------------------- | ------------------- | ------ |
| ⚡ | <code>linter/default-rules[pydantic/types.py]</code> | 1.9 ms | 1.8 ms | +4.89% |</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2024-06-23 18:41</div>
            <div class="timeline-body">

<code>ruff-ecosystem</code> results
Linter (stable)
<p>✅ ecosystem check detected no linter changes.</p>
Linter (preview)
<p>✅ ecosystem check detected no linter changes.</p>
Formatter (stable)
<p>✅ ecosystem check detected no format changes.</p>
Formatter (preview)
<p>✅ ecosystem check detected no format changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_db/src/vendored.rs</code>:131 on 2024-06-23 18:57</div>
            <div class="timeline-body"><p>Dealing with different errors can often times be more difficult than just having one error, even if it contains more variant than are actually possible.</p>
<p>For example, someone calling <code>metdata</code> and <code>read</code> now needs to handle both <code>MetadataLookupError</code> and <code>ZipFileReadError</code> but there&#x27;s no way to convert one error to the other. It forces the caller to define its own error type that is a union over the two.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_db/src/vendored.rs</code>:304 on 2024-06-23 19:01</div>
            <div class="timeline-body"><p>I quickly checked what the normal FS operations return when you navigate outside the <code>cwd</code>. They just return a <code>NotFound</code> error, which is probably also enough for us.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_db/src/vendored.rs</code>:309 on 2024-06-23 19:05</div>
            <div class="timeline-body"><p>Am I correct that this is only to handle prefixes? I guess the problem we run into here is that <code>camino::Utf8Path</code> path parsing is platform-dependent. I&#x27;m not sure how to solve this best but I&#x27;m also not sure if this special case is worth returning an <code>Error</code> (we control the path creation, it&#x27;s not that they&#x27;re provided from externally)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-06-23 19:10</div>
            <div class="timeline-body"><p>I&#x27;m not sure if the many extra error types are worth the complexity, especially considering that vendored paths isn&#x27;t something that comes from externally.</p>
<p>I generally like narrow error types, but they can be challenging to work with. <code>metadata</code> and <code>read</code> now return two different, disjoint errors. This can be frustrating because a function that calls both <code>read</code> and <code>metadata</code> now must define its own error type (or use <code>anyhow</code>) to propagate both errors, but that&#x27;s as good as just using <code>io::Error</code>.</p>
<p>The other question is. Is it useful to know that reading a file failed because the path was invalid or because there&#x27;s an other IO error? Would a caller handle these two cases differently? I would say probably not? I would probably call <code>unwrap</code> for invalid paths because I know they are well formed (we control the construction) and there&#x27;s nothing I can do about IO errors other than propagating them.</p>
<p>I&#x27;m leaning towards returning <code>NotFound</code> if a path has too many <code>../</code> components. Prefixes are a bit more awkward. I&#x27;m leaning toward just panicking, because this is a dev error.</p>
<p>The alternative is to handle prefixes similar to <code>root</code> where you take the starting prefix (win only) and concatenate it with the next component to get &quot;UNIX&quot; like semantics.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-06-23 19:26</div>
            <div class="timeline-body"><p>TIL: This is what <code>std::path::absolute</code> does</p>
<pre><code>if path.as_os_str().is_empty() {
        Err(io::const_io_error!(io::ErrorKind::InvalidInput, &quot;cannot make an empty path absolute&quot;,))
    }
</code></pre>
<p>Uh, this is funny. Too many <code>../</code> hasn&#x27;t any meaning. It just means the path starts at <code>/</code>.</p>
<pre><code>assert_eq!(
            std::path::Path::new(&quot;a&quot;),
            std::path::Path::new(
                &quot;../../../../../../../../../../../../../../../../../../../../../../home&quot;
            )
            .canonicalize()
            .unwrap()
        );
</code></pre>
<p>Fails, and the path resolves to <code>&quot;/System/Volumes/Data/home&quot;</code>. I can add as many <code>../</code> as I want and the path keeps resolving to <code>/home</code>. So I think you&#x27;re implementation was actually correct.</p>
<p>Taking all this into consideration. I would return <code>io::ErrorKind::InvalidInput</code> when seeing a <code>Prefix</code> component</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-06-23 20:31</div>
            <div class="timeline-body"><blockquote>
<p>Uh, this is funny. Too many <code>../</code> hasn&#x27;t any meaning. It just means the path starts at <code>/</code>.</p>
</blockquote>
<p>Huh. Right, yeah, that makes sense. We&#x27;re not trying to &quot;escape from the zip archive&quot;; we&#x27;ve just reached the root of the zip archive, and we can&#x27;t go any further.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-06-23 20:35</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_db/src/vendored.rs</code>:309 on 2024-06-23 20:35</div>
            <div class="timeline-body"><p>Or a <code>camino::Utf8Component::RootDir</code>... which I don&#x27;t think is possible in the middle of a file, but that can&#x27;t be validated using the type system</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-06-23 20:39</div>
            <div class="timeline-body"><p>I think the conclusion here is that none of the changes here are needed:</p>
<ul>
<li>Panicking is the correct thing to do if we encounter prefixes in the normalization routine. We control the inputs, so that just indicates a dev error on our part if we come across them, and the correct response to that is to panic rather than return an error</li>
<li><code>..</code> parts should be treated the same way as in OS paths, and for OS paths Rust allows you to apply an arbitrary number and doesn&#x27;t error out (they&#x27;re just treated as no-ops if you hit the root dir)</li>
</ul>
<p>Thanks for talking this through with me, I appreciate it!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-06-23 20:39</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-06-23 20:39</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:04:49 UTC
    </footer>
</body>
</html>
