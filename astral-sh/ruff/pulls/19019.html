<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[ty] Remove `ScopedExpressionId` - astral-sh/ruff #19019</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[ty] Remove <code>ScopedExpressionId</code></h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/19019">#19019</a>
        opened by <a href="https://github.com/MichaReiser">@MichaReiser</a>
        on 2025-06-28 19:37
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a></div>
            <div class="timeline-body">Summary
<p>The motivation of <code>ScopedExpressionId</code> was that we have an expression identifier that&#x27;s local to a scope and, therefore, unlikely to change if a user makes changes in another scope. A local identifier like this has the advantage that query results may remain unchanged even if other parts of the file change, which in turn allows Salsa to short-circuit dependent queries.</p>
<p>However, I noticed that we aren&#x27;t using <code>ScopedExpressionId</code> in a place where it&#x27;s important that the identifier is local. It&#x27;s main use is inside <code>infer</code> which we always run for the entire file. The one exception to this is <code>Unpack</code> but unpack runs as part of <code>infer</code>.</p>
<p>Edit: The above isn&#x27;t entirely correct. We used ScopedExpressionId in TypeInference which is a query result. Now using ExpressionNodeKey does mean that a change to the AST invalidates most if not all TypeInference results of a single file. Salsa then has to run all dependent queries to see if they&#x27;re affected by this change even if the change was local to another scope.</p>
<p>If this locality proves to be important I suggest that we create two queries on top of TypeInference: one that returns the expression map which is mainly used in the linter and type inference and a second that returns all remaining fields. This should give us a similar optimization at a much lower cost</p>
<p>I also considered remove <code>ScopedUseId</code> but I believe that one is still useful because using <code>ExpressionNodeKey</code> for it instead would mean that all <code>UseDefMap</code> change when a single AST node changes. Whether this is important is something difficult to assess. I&#x27;m simply not familiar enough with the <code>UseDefMap</code>. If the locality doesn&#x27;t matter for the <code>UseDefMap</code>, then a similar change could be made and <code>bindings_by_use</code> could be changed to an <code>FxHashMap&lt;UseId, Bindings&gt;</code> where <code>UseId</code> is a thin wrapper around <code>NodeKey</code>.</p>
<p>Closes <a href="https://github.com/astral-sh/ty/issues/721">astral-sh/ty#721</a></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">internal</span> added by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-06-28 19:37</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ty</span> added by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-06-28 19:37</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-06-28 19:41</div>
            <div class="timeline-body">

<code>mypy_primer</code> results

Changes were detected when running on open source projects

<pre><code>bidict (https://github.com/jab/bidict)
-     memo fields = ~17MB
+     memo fields = ~15MB

janus (https://github.com/aio-libs/janus)
- TOTAL MEMORY USAGE: ~28MB
+ TOTAL MEMORY USAGE: ~25MB

com2ann (https://github.com/ilevkivskyi/com2ann)
- TOTAL MEMORY USAGE: ~41MB
+ TOTAL MEMORY USAGE: ~37MB

pyp (https://github.com/hauntsaninja/pyp)
-     memo fields = ~41MB
+     memo fields = ~37MB

zipp (https://github.com/jaraco/zipp)
- TOTAL MEMORY USAGE: ~30MB
+ TOTAL MEMORY USAGE: ~28MB

pegen (https://github.com/we-like-parsers/pegen)
- TOTAL MEMORY USAGE: ~45MB
+ TOTAL MEMORY USAGE: ~41MB

beartype (https://github.com/beartype/beartype)
- TOTAL MEMORY USAGE: ~97MB
+ TOTAL MEMORY USAGE: ~88MB

attrs (https://github.com/python-attrs/attrs)
- TOTAL MEMORY USAGE: ~80MB
+ TOTAL MEMORY USAGE: ~72MB

aiortc (https://github.com/aiortc/aiortc)
- TOTAL MEMORY USAGE: ~97MB
+ TOTAL MEMORY USAGE: ~88MB

dedupe (https://github.com/dedupeio/dedupe)
-     memo fields = ~72MB
+     memo fields = ~66MB

graphql-core (https://github.com/graphql-python/graphql-core)
-     memo fields = ~129MB
+     memo fields = ~117MB

svcs (https://github.com/hynek/svcs)
- TOTAL MEMORY USAGE: ~80MB
+ TOTAL MEMORY USAGE: ~72MB

black (https://github.com/psf/black)
- TOTAL MEMORY USAGE: ~142MB
+ TOTAL MEMORY USAGE: ~129MB

alerta (https://github.com/alerta/alerta)
-     memo fields = ~97MB
+     memo fields = ~88MB

downforeveryone (https://github.com/rpdelaney/downforeveryone)
-     memo fields = ~34MB
+     memo fields = ~30MB

rich (https://github.com/Textualize/rich)
- TOTAL MEMORY USAGE: ~142MB
+ TOTAL MEMORY USAGE: ~129MB

PyGithub (https://github.com/PyGithub/PyGithub)
-     memo metadata = ~17MB
+     memo metadata = ~15MB

pydantic (https://github.com/pydantic/pydantic)
- TOTAL MEMORY USAGE: ~156MB
+ TOTAL MEMORY USAGE: ~142MB

mkosi (https://github.com/systemd/mkosi)
- TOTAL MEMORY USAGE: ~129MB
+ TOTAL MEMORY USAGE: ~117MB

imagehash (https://github.com/JohannesBuchner/imagehash)
- TOTAL MEMORY USAGE: ~49MB
+ TOTAL MEMORY USAGE: ~45MB

flake8 (https://github.com/pycqa/flake8)
-     memo fields = ~66MB
+     memo fields = ~60MB

pylox (https://github.com/sco1/pylox)
-     memo fields = ~54MB
+     memo fields = ~49MB

apprise (https://github.com/caronc/apprise)
-     memo fields = ~251MB
+     memo fields = ~228MB

typeshed-stats (https://github.com/AlexWaygood/typeshed-stats)
- TOTAL MEMORY USAGE: ~117MB
+ TOTAL MEMORY USAGE: ~106MB

alectryon (https://github.com/cpitclaudel/alectryon)
-     memo fields = ~13MB
+     memo fields = ~11MB

poetry (https://github.com/python-poetry/poetry)
-     memo metadata = ~23MB
+     memo metadata = ~21MB

bandersnatch (https://github.com/pypa/bandersnatch)
- TOTAL MEMORY USAGE: ~88MB
+ TOTAL MEMORY USAGE: ~80MB

python-sop (https://gitlab.com/dkg/python-sop)
-     memo fields = ~25MB
+     memo fields = ~23MB

boostedblob (https://github.com/hauntsaninja/boostedblob)
- TOTAL MEMORY USAGE: ~106MB
+ TOTAL MEMORY USAGE: ~97MB

freqtrade (https://github.com/freqtrade/freqtrade)
-     memo fields = ~304MB
+     memo fields = ~276MB

AutoSplit (https://github.com/Toufool/AutoSplit)
- TOTAL MEMORY USAGE: ~228MB
+ TOTAL MEMORY USAGE: ~207MB

pywin32 (https://github.com/mhammond/pywin32)
-     memo fields = ~368MB
+     memo fields = ~334MB

altair (https://github.com/vega/altair)
-     memo fields = ~251MB
+     memo fields = ~228MB

mitmproxy (https://github.com/mitmproxy/mitmproxy)
- TOTAL MEMORY USAGE: ~304MB
+ TOTAL MEMORY USAGE: ~276MB

pycryptodome (https://github.com/Legrandin/pycryptodome)
- TOTAL MEMORY USAGE: ~142MB
+ TOTAL MEMORY USAGE: ~129MB
-     memo metadata = ~17MB
+     memo metadata = ~15MB

openlibrary (https://github.com/internetarchive/openlibrary)
-     memo fields = ~189MB
+     memo fields = ~171MB

manticore (https://github.com/trailofbits/manticore)
-     memo fields = ~539MB
+     memo fields = ~490MB

meson (https://github.com/mesonbuild/meson)
-     memo metadata = ~54MB
+     memo metadata = ~49MB
-     memo fields = ~334MB
+     memo fields = ~304MB

zulip (https://github.com/zulip/zulip)
-     memo fields = ~652MB
+     memo fields = ~593MB

scipy (https://github.com/scipy/scipy)
- TOTAL MEMORY USAGE: ~1271MB
+ TOTAL MEMORY USAGE: ~1156MB

sympy (https://github.com/sympy/sympy)
-     memo fields = ~1538MB
+     memo fields = ~1399MB

</code></pre>


</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-06-28 19:42</div>
            <div class="timeline-body"><p>Woah those report diffs are amazing.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-06-28 19:44</div>
            <div class="timeline-body"><blockquote>
<p>Woah those report diffs are amazing.</p>
</blockquote>
<p>That&#x27;s @ibraheemdev&#x27;s work. He deserves a shoutout in tomorrow&#x27;s meeting but Notion is having a bad day :(</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/codspeed-hq[bot]">@codspeed-hq[bot]</a> on 2025-06-28 19:47</div>
            <div class="timeline-body">



<a href="https://codspeed.io/astral-sh/ruff/branches/micha%2Fast-ids?runnerMode=Instrumentation">CodSpeed Instrumentation Performance Report</a>
Merging #19019 will <strong>improve performances by 4.59%</strong>
<p>Comparing <code>micha/ast-ids</code> (d078951) with <code>main</code> (9218bf7)</p>
Summary
<p><code>⚡ 4</code> improvements<br>
<code>✅ 35</code> untouched benchmarks</p>
Benchmarks breakdown
<p>|     | Benchmark | <code>BASE</code> | <code>HEAD</code> | Change |
| --- | --------- | ----------------------- | ------------------- | ------ |
| ⚡ | <code>ty_check_file[cold]</code> | 124.1 ms | 119 ms | +4.29% |
| ⚡ | <code>ty_micro[complex_constrained_attributes_2]</code> | 651.1 ms | 624.9 ms | +4.2% |
| ⚡ | <code>anyio</code> | 899.3 ms | 864.6 ms | +4% |
| ⚡ | <code>attrs</code> | 375.7 ms | 359.2 ms | +4.59% |</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/codspeed-hq[bot]">@codspeed-hq[bot]</a> on 2025-06-28 19:49</div>
            <div class="timeline-body">



<a href="https://codspeed.io/astral-sh/ruff/branches/micha%2Fast-ids?runnerMode=WallTime">CodSpeed WallTime Performance Report</a>
Merging #19019 will <strong>improve performances by 7.79%</strong>
<p>Comparing <code>micha/ast-ids</code> (d078951) with <code>main</code> (9218bf7)</p>
Summary
<p><code>⚡ 7</code> improvements<br>
<code>✅ 1</code> untouched benchmarks</p>
Benchmarks breakdown
<p>|     | Benchmark | <code>BASE</code> | <code>HEAD</code> | Change |
| --- | --------- | ----------------------- | ------------------- | ------ |
| ⚡ | <code>large[sympy]</code> | 53.5 s | 50.9 s | +5.2% |
| ⚡ | <code>medium[colour-science]</code> | 8.7 s | 8.3 s | +5.21% |
| ⚡ | <code>medium[pandas]</code> | 34.1 s | 32.5 s | +4.89% |
| ⚡ | <code>multithreaded[pydantic]</code> | 8.6 s | 8 s | +7.79% |
| ⚡ | <code>small[altair]</code> | 6.1 s | 5.8 s | +5.23% |
| ⚡ | <code>small[freqtrade]</code> | 9.2 s | 8.8 s | +4.43% |
| ⚡ | <code>small[tanjun]</code> | 4 s | 3.9 s | +4.12% |</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from &quot;[ty] Delete `AstIds`&quot; to &quot;[ty] Remove `HasScopedExpressionId`&quot; by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-06-28 19:57</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from &quot;[ty] Remove `HasScopedExpressionId`&quot; to &quot;[ty] Remove `ScopedExpressionId`&quot; by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-06-28 19:57</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-06-28 20:09</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/carljm">@carljm</a> by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-06-28 20:09</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/AlexWaygood">@AlexWaygood</a> by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-06-28 20:09</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/sharkdp">@sharkdp</a> by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-06-28 20:09</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/dcreager">@dcreager</a> by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-06-28 20:09</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">internal</span> removed by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-06-28 20:09</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">performance</span> added by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-06-28 20:10</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-06-28 20:33</div>
            <div class="timeline-body"><p>This PR makes me wonder if we should try to split our semantic index incrementally (scope by scope). This won&#x27;t help much for first party modules where we need all scopes but it can reduce the amount of data that we collect for third party modules AND it could maybe even replaces <code>exported_names</code> because other files would then only depend on the index of the global scope</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for <a href="https://github.com/AlexWaygood">@AlexWaygood</a> removed by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-06-29 17:13</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> approved on 2025-07-02 15:57</div>
            <div class="timeline-body"><p>This is great — less code and a clear performance win!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-07-02 15:57</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-07-02 15:57</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-07-02 15:57</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:16:01 UTC
    </footer>
</body>
</html>
