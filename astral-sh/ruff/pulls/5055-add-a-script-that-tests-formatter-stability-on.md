```yaml
number: 5055
title: Add a script that tests formatter stability on repositories
type: pull_request
state: merged
author: konstin
labels:
  - internal
assignees: []
merged: true
base: main
head: formatter-stability-repo-check
created_at: 2023-06-13T16:29:48Z
updated_at: 2023-06-19T14:35:08Z
url: https://github.com/astral-sh/ruff/pull/5055
synced_at: 2026-01-12T03:43:30Z
```

# Add a script that tests formatter stability on repositories

---

_Pull request opened by @konstin on 2023-06-13 16:29_

## Summary

 We want to ensure that once formatted content stays the same when formatted again, which is known as formatter stability or formatter idempotency, and that the formatter prints syntactically valid code. As our test cases cover only a limited amount of code, this allows checking entire repositories.

 This adds a new subcommand to `ruff_dev` which can be invoked as `cargo run --bin ruff_dev -- check-formatter-stability <repo>`. While initially only intended to check stability, it has also found cases where the formatter printed invalid syntax or panicked.

 ## Test Plan

 Running this on cpython is already identifying bugs (https://github.com/astral-sh/ruff/pull/5089)

---

_Comment by @konstin on 2023-06-13 16:30_

Current dependencies on/for this PR:
* main
  * **PR #5055** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/5055" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a>  ðŸ‘ˆ

This comment was auto-generated by [Graphite](https://app.graphite.dev/github/pr/astral-sh/ruff/5055?utm_source=stack-comment).

---

_Comment by @github-actions[bot] on 2023-06-13 16:44_

## PR Check Results
### Ecosystem
âœ… ecosystem check detected no changes.

### Benchmark
#### Linux
```
group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.00      6.2Â±0.01ms     6.5 MB/sec    1.00      6.2Â±0.02ms     6.5 MB/sec
formatter/numpy/ctypeslib.py               1.01   1322.5Â±7.76Âµs    12.6 MB/sec    1.00   1311.8Â±4.48Âµs    12.7 MB/sec
formatter/numpy/globals.py                 1.01    127.6Â±1.55Âµs    23.1 MB/sec    1.00    126.7Â±0.12Âµs    23.3 MB/sec
formatter/pydantic/types.py                1.00      2.6Â±0.01ms     9.9 MB/sec    1.00      2.6Â±0.01ms    10.0 MB/sec
linter/all-rules/large/dataset.py          1.00     13.3Â±0.06ms     3.1 MB/sec    1.00     13.4Â±0.15ms     3.0 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      3.3Â±0.00ms     5.1 MB/sec    1.00      3.3Â±0.01ms     5.1 MB/sec
linter/all-rules/numpy/globals.py          1.00    414.9Â±0.50Âµs     7.1 MB/sec    1.00    415.2Â±0.41Âµs     7.1 MB/sec
linter/all-rules/pydantic/types.py         1.00      5.7Â±0.02ms     4.4 MB/sec    1.00      5.7Â±0.01ms     4.4 MB/sec
linter/default-rules/large/dataset.py      1.00      6.7Â±0.01ms     6.1 MB/sec    1.00      6.7Â±0.02ms     6.1 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00   1434.3Â±2.76Âµs    11.6 MB/sec    1.01   1455.6Â±3.19Âµs    11.4 MB/sec
linter/default-rules/numpy/globals.py      1.00    158.9Â±0.32Âµs    18.6 MB/sec    1.00    159.3Â±0.74Âµs    18.5 MB/sec
linter/default-rules/pydantic/types.py     1.00      3.0Â±0.01ms     8.4 MB/sec    1.00      3.0Â±0.01ms     8.4 MB/sec
```

#### Windows
```
group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.00      7.9Â±0.04ms     5.1 MB/sec    1.00      8.0Â±0.07ms     5.1 MB/sec
formatter/numpy/ctypeslib.py               1.00  1596.9Â±12.50Âµs    10.4 MB/sec    1.00  1599.0Â±10.91Âµs    10.4 MB/sec
formatter/numpy/globals.py                 1.00    155.9Â±1.62Âµs    18.9 MB/sec    1.01    157.7Â±4.12Âµs    18.7 MB/sec
formatter/pydantic/types.py                1.00      3.2Â±0.04ms     7.9 MB/sec    1.01      3.3Â±0.08ms     7.8 MB/sec
linter/all-rules/large/dataset.py          1.00     15.9Â±0.19ms     2.6 MB/sec    1.04     16.6Â±0.19ms     2.5 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      4.2Â±0.03ms     4.0 MB/sec    1.04      4.3Â±0.06ms     3.9 MB/sec
linter/all-rules/numpy/globals.py          1.00    429.2Â±5.64Âµs     6.9 MB/sec    1.02    437.7Â±7.55Âµs     6.7 MB/sec
linter/all-rules/pydantic/types.py         1.00      7.1Â±0.09ms     3.6 MB/sec    1.02      7.2Â±0.09ms     3.5 MB/sec
linter/default-rules/large/dataset.py      1.00      8.4Â±0.06ms     4.9 MB/sec    1.03      8.6Â±0.09ms     4.7 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00  1750.6Â±11.18Âµs     9.5 MB/sec    1.03  1806.4Â±15.23Âµs     9.2 MB/sec
linter/default-rules/numpy/globals.py      1.00    185.9Â±1.63Âµs    15.9 MB/sec    1.02    189.3Â±4.35Âµs    15.6 MB/sec
linter/default-rules/pydantic/types.py     1.00      3.8Â±0.02ms     6.7 MB/sec    1.02      3.9Â±0.02ms     6.6 MB/sec
```
<!-- thollander/actions-comment-pull-request "PR Check Results" -->

---

_Comment by @addisoncrump on 2023-06-14 15:24_

Potentially would also be interesting to integrate this with the fuzzer for generating that initial corpus. The corpus I used is from a somewhat outdated python3 dataset currently, so it might not be representative of all modern features.

---

_Marked ready for review by @konstin on 2023-06-14 15:59_

---

_Label `internal` added by @konstin on 2023-06-14 19:40_

---

_Comment by @konstin on 2023-06-14 19:41_

As someone who has little experience with fuzzer, what would it mean to use cpython for the initial corpus?

---

_Comment by @addisoncrump on 2023-06-15 12:04_

The corpus is the set of inputs on which the fuzzer tries to modify such that it triggers new code paths. If the fuzzer is provided with a corpus containing representative samples of inputs that can be handled by the program being tested, then it is more likely to mutate into an input that triggers unexpected behaviour. This is because the parser is less likely to outright reject the input and the fuzzer more likely to introduce new data to the input that triggers unexpected behaviour while processing the parsed input. Also, it means the fuzzer has less work to do to "discover" new functionality or features.

---

_Comment by @konstin on 2023-06-15 12:15_

Thanks for the explanation! In this case cpython plus our own test fixture should be a great start

---

_Comment by @addisoncrump on 2023-06-15 15:02_

In that case, once this lands, I'll update the (re)init-fuzzer script to use cpython source as part of the corpus init.

---

_Comment by @charliermarsh on 2023-06-15 16:23_

@konstin - Is this ready for review? Tag me when ready :)

---

_Review requested from @charliermarsh by @konstin on 2023-06-15 19:02_

---

_Comment by @konstin on 2023-06-15 19:02_

it is :)

---

_@konstin reviewed on 2023-06-15 19:08_

---

_Review comment by @konstin on `crates/ruff_dev/src/main.rs`:74 on 2023-06-15 19:08_

i've changed this back and forth like three times :sweat_smile: i can also roll this back once again

---

_Review requested from @MichaReiser by @konstin on 2023-06-19 11:21_

---

_Review comment by @charliermarsh on `crates/ruff_dev/src/check_formatter_stability.rs`:26 on 2023-06-19 13:38_

These appear in the Clap output, right? Can we make them actual rustdocs?

---

_@charliermarsh approved on 2023-06-19 13:39_

---

_Review comment by @konstin on `crates/ruff_dev/src/check_formatter_stability.rs`:26 on 2023-06-19 14:05_

thanks i missed that

---

_@konstin reviewed on 2023-06-19 14:05_

---

_Merged by @konstin on 2023-06-19 14:13_

---

_Closed by @konstin on 2023-06-19 14:13_

---

_Branch deleted on 2023-06-19 14:13_

---
