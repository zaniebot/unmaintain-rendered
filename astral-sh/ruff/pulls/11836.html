<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[red-knot] Add a parser for typeshed's VERSIONS file - astral-sh/ruff #11836</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[red-knot] Add a parser for typeshed's VERSIONS file</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/11836">#11836</a>
        opened by <a href="https://github.com/AlexWaygood">@AlexWaygood</a>
        on 2024-06-11 14:06
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a></div>
            <div class="timeline-body"><p>Work towards https://github.com/astral-sh/ruff/issues/11653. This will be necessary for resolving standard-library modules.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @AlexWaygood on 2024-06-11 14:06</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @AlexWaygood on 2024-06-11 14:06</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-06-11 14:08</div>
            <div class="timeline-body"><p>I'm not wedded to this being merged now, FWIW: I'm happy to wait until we've sorted out the vendored filesystem stuff first. In some ways, it would make more sense to wait until that's all sorted out, and then integrate this properly; as it is, this is all basically unused right now. I'm mainly filing the PR now to show progress, and I did it now because it was nice and small and self-contained.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by @MichaReiser on 2024-06-11 14:09</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot/src/module.rs</code>:877 on 2024-06-11 14:12</div>
            <div class="timeline-body"><p>I think I would create a custom error here instead of just using <code>anyhow</code>. Especially considering that the errors are know ahead of time.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot/src/module.rs</code>:887 on 2024-06-11 14:13</div>
            <div class="timeline-body"><p>It would be nice if we could avoid collecting the items here. You could use <code>split_once('-')</code> and then do a <code>!contains('-')</code> on the second part to ensure it doesn't contain any other <code>-</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot/src/module.rs</code>:915 on 2024-06-11 14:15</div>
            <div class="timeline-body"><p>Same here, Consider using <code>split_once</code> or taking the parts one by one from the iterator over collecting.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot/src/module.rs</code>:786 on 2024-06-11 14:15</div>
            <div class="timeline-body"><p>I'll leave it to you to port this later because it won't be part of my module resolver refactor.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot/src/module.rs</code>:814 on 2024-06-11 14:17</div>
            <div class="timeline-body"><p>Is it more common that the top module is limited to a version or that it is a submodule (or, can't say because it is a mixture of both)? I'm asking because it could allow us to start iterating from the more common path.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot/src/module.rs</code>:823 on 2024-06-11 14:17</div>
            <div class="timeline-body"><pre><code class="language-suggestion">        let mut map = FxHashMap::default();
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot/src/module.rs</code>:826 on 2024-06-11 14:18</div>
            <div class="timeline-body"><p>Nit:</p>
<pre><code class="language-suggestion">            let line_number = OneIndexed::from_zero_indexed(line_number);
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot/src/module.rs</code>:833 on 2024-06-11 14:19</div>
            <div class="timeline-body"><p>Same here. Can we avoid allocating here by using <code>split_once</code> or consuming the iterator part by part.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-06-11 14:20</div>
            <div class="timeline-body"><p>Nice. I thikn we shoud try to reduce the number of <code>collect</code> calls (we now have multiple collects per line and I don't think they're necessary). Other than that, I think that's good to go.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2024-06-11 14:25</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>âœ… ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>âœ… ecosystem check detected no linter changes.</p>
<h3>Formatter (stable)</h3>
<p>âœ… ecosystem check detected no format changes.</p>
<h3>Formatter (preview)</h3>
<p>âœ… ecosystem check detected no format changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-06-11 15:48</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot/src/module.rs</code>:826 on 2024-06-11 15:48</div>
            <div class="timeline-body"><p>where do I need to import this from?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-06-11 15:49</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot/src/module.rs</code>:823 on 2024-06-11 15:49</div>
            <div class="timeline-body"><p>Argh, I'm sure I tried this and for some reason it didn't work... but it does now ðŸ™ƒ</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/codspeed-hq[bot]">@codspeed-hq[bot]</a> on 2024-06-11 15:55</div>
            <div class="timeline-body"><h2><a href="https://codspeed.io/astral-sh/ruff/branches/typeshed-versions">CodSpeed Performance Report</a></h2>
<h3>Merging #11836 will <strong>not alter performance</strong></h3>
<p><sub>Comparing <code>typeshed-versions</code> (84dc926) with <code>main</code> (60ea72a)</sub></p>
<h3>Summary</h3>
<p><code>âœ… 30</code> untouched benchmarks</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-06-11 15:59</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot/src/module.rs</code>:826 on 2024-06-11 15:59</div>
            <div class="timeline-body"><p>Ah, It's in <code>ruff_source_file</code>. That might not be available and maybe the dependency isn't worth it, considering that the index use is so local here (I'm kind of strict on using it when passing around column and line numbers across modules).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-06-11 16:06</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot/src/module.rs</code>:826 on 2024-06-11 16:06</div>
            <div class="timeline-body"><p>Ah I see. I think probably not worth the inter-crate dependency just for this. Though that may change when I port this over to <code>ruff_python_semantic</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-06-11 16:08</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot/src/module.rs</code>:814 on 2024-06-11 16:08</div>
            <div class="timeline-body"><p>The most common situation is that there's an exact match in <code>VERSIONS</code> -- you're looking to find out the versions <code>pathlib</code> exists on, and <code>VERSIONS</code> has an entry called <code>pathlib</code> in it.</p>
<p>The second most common situation is probably that you're looking up a submodule and the submodule itself doesn't exist in <code>VERSIONS</code> but its parent package does -- e.g. you're looking up <code>email.utils</code>, which doesn't exist in <code>VERSIONS</code>, but <code>email</code> does. But I'm not sure we can optimize that, because if <code>email.utils</code> <em>also</em> exists in <code>VERSIONS</code> as <em>well</em> as <code>email</code>, we <em>have</em> to give that entry precedence over the entry for <code>email</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-06-11 17:17</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot/src/module.rs</code>:877 on 2024-06-11 17:17</div>
            <div class="timeline-body"><p>Done in https://github.com/astral-sh/ruff/pull/11836/commits/f7c32383a8b22ff28acf21b9a2e6c0eeb7f8ef9d. Oof, that's a lot more code!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @AlexWaygood on 2024-06-11 18:02</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-06-11 19:51</div>
            <div class="timeline-body"><p>Wondering if this should be a separate module that <code>module.rs</code> depends on... it currently uses <code>ModuleName</code>, but it should be pretty simple to get rid of that, in which case it wouldn't have dependencies on any of the rest of <code>red_knot</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> approved on 2024-06-11 23:23</div>
            <div class="timeline-body"><p>Looks reasonable to me!</p>
<p>This does seem pretty self-contained from the rest of the module resolver, so I'd probably be inclined to put it into its own (sub-)module.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot/src/module.rs</code>:893 on 2024-06-12 06:15</div>
            <div class="timeline-body"><p>I would use <code>new().unwrap()</code> here. I'm pretty sure the compiler is able to to figure out that this is never 0</p>
<pre><code class="language-suggestion">            let line_number = NonZeroUsize::new(line_number.saturating_add(1)).unwrap();
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot/src/module.rs</code>:890 on 2024-06-12 06:15</div>
            <div class="timeline-body"><p>Nit: Maybe name this <code>line_index</code> to make it clear that it is 0 based</p>
<pre><code class="language-suggestion">        for (line_index, line) in s.lines().enumerate() {
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot/src/module.rs</code>:1268 on 2024-06-12 06:19</div>
            <div class="timeline-body"><p>I recommend copying over the current VERSIONS file specifically for the test and use that instead. That also allows you to explicitly assert the len.</p>
<p>You could then change your test and simply compare if <code>display(parsed) == input</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2024-06-12 06:19</div>
            <div class="timeline-body"><blockquote>
<p>Wondering if this should be a separate module that module.rs depends on... it currently uses ModuleName, but it should be pretty simple to get rid of that, in which case it wouldn't have dependencies on any of the rest of red_knot.</p>
</blockquote>
<p>I would probably split it into its own submodule but we can also do this when porting it to <code>ruff_python_semantic</code> (or <code>red_knot_python_semantic</code>)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-06-12 08:12</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot/src/module.rs</code>:1268 on 2024-06-12 08:12</div>
            <div class="timeline-body"><p>I think it's important that we do have some tests that check we're able to parse the actual VERSIONS file we have checked in, that we'll be using as a source of truth at runtime. But agreed that it doesn't make for a great unit test; I'll rework this</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @AlexWaygood on 2024-06-12 11:44</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @AlexWaygood on 2024-06-12 11:44</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-06-12 11:44</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:04:48 UTC
    </footer>
</body>
</html>
