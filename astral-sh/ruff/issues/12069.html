<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PLW1514: extend or change autofix with `encoding=&quot;utf-8&quot;` - astral-sh/ruff #12069</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>PLW1514: extend or change autofix with <code>encoding=&quot;utf-8&quot;</code></h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/issues/12069">#12069</a>
        opened by <a href="https://github.com/xmo-odoo">@xmo-odoo</a>
        on 2024-06-27 12:11
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/xmo-odoo">@xmo-odoo</a> on 2024-06-27 12:11</div>
            <div class="timeline-body"><p>#8883 requested that the <code>open</code>/<code>read</code> calls without an explicit encoding be autofixed to use the locale, however <em>the use of the locale is exactly why PEP 597 / EncodingWarning was implemented</em>: in this day and age, and especially when interacting with internal data or software-created files, following the possibly wonky and misconfigured locale of the host machine is actively detrimental. Even more so when accounting for Windows where the locale is essentially always useless (it generally defaults to a single-byte windows codepage, changing the locale to UTF8 -- codepage 65001 -- is possible but uncommon).</p>
<p>At https://docs.astral.sh/ruff/rules/unspecified-encoding/ it is claimed that this is the PEP 597 recommendation, but it is the opposite of reality:</p>
<blockquote>
<p><a href="https://peps.python.org/pep-0597/#how-to-teach-this">How to Teach This</a></p>
<p><a href="https://peps.python.org/pep-0597/#for-new-users">For new users</a></p>
<p>Since EncodingWarning is used to write cross-platform code, there is no need to teach it to new users.</p>
<p>We can just recommend using UTF-8 for text files and using encoding=&quot;utf-8&quot; when opening them.</p>
</blockquote>
<p>Using <code>encoding=locale.getpreferredencoding(False)</code> is a <em>forward-compatibility</em> measure, and the new <code>encoding=&quot;locale&quot;</code> is a shorter and less error prone to specify that, but <em>using the locale is not the expected default</em>.</p>
<p>As a result, the autofixer for PLW1514 should either:</p>
<ul>
<li>autofix to <code>encoding-&quot;utf-8&quot;</code> by default, that is more likely to be correct, expected, and desired than not</li>
<li>if supported, provide a second(ary) autofix to use the locale instead</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">rule</span> added by @AlexWaygood on 2024-06-27 17:12</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">fixes</span> added by @AlexWaygood on 2024-06-27 17:12</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Avasam">@Avasam</a> on 2024-07-02 03:12</div>
            <div class="timeline-body"><p>I thought I raised something about this already somewhere, but I can't find it anymore.
Even though I originally suggested the autofix for this rule (https://github.com/astral-sh/ruff/issues/8883) based on official doc. After trying it out in setuptools, I noticed that this autofix doesn't help, because <code>locale.getpreferredencoding(False)</code> will itself lead to a warning !</p>
<p>A better autofix imo is <code>encoding=&quot;locale&quot; if sys.version_info &gt;= (3, 10) else None</code> which does successfully keep the same behaviour, removes the runtime warnings <em>and</em> is easy to search7replace to &quot;utf-8&quot; in a manual pass.</p>
<p>As bonus, the preferred encoding could be configurable, so that &quot;locale&quot;, &quot;utf-8&quot;, or a project's custom needs is used for autofixing.</p>
<p>As a sidenote, whilst I agree a move to utf-8 is preferred, that would be an unsafe fix atm as it would change the behaviour and <em>can definitely</em> break code in real-world scenario.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/xmo-odoo">@xmo-odoo</a> on 2024-07-02 06:03</div>
            <div class="timeline-body"><blockquote>
<p>A better autofix imo is encoding=&quot;locale&quot; if sys.version_info &gt;= (3, 10) else None which does successfully keep the same behaviour</p>
</blockquote>
<p>The <em>entire point</em> of PEP 597 is that &quot;the same behaviour&quot; is garbage.</p>
<blockquote>
<p>As a sidenote, whilst I agree a move to utf-8 is preferred, that would be an unsafe fix atm as it would change the behaviour and can definitely break code in real-world scenario.</p>
</blockquote>
<p>The problem is that using the locale is generally broken and only sometimes correct, but can be very hard to discover (for western devs anyway), as developers tend to have non-misconfigured system, limit themselves to ASCII data, and have extended-ASCII-codepage systems (e.g. CP437).</p>
<p>So while the current fixer &quot;preserves the current behaviour&quot; that doesn't mean it's not broken, the developer might just have not thought about the issue, ran the fixer, and now the broken behaviour gets embedded into the source as if it had been an actual decision rather than something that was not considered. That is exactly what happened to a colleague and why I opened this issue in the first place.</p>
<p>As things are, I consider the fixer to be actively detrimental because the only thing it fixes is the warning, not the underlying issue. If &quot;unsafe fixers&quot; are not allowed I do consider this one to be that in both cases, and would vote to see it removed entirely. IO encoding is very much in the realm of developer decision, and the tool pretending it can know that will always fail in some way.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-07-17 02:17</div>
            <div class="timeline-body"><p>Unsafe fixes are allowed -- we have a separate opt-in level for them. It seems reasonable to change the fix to <code>encoding-&quot;utf-8&quot;</code> as you suggested above.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Avasam">@Avasam</a> on 2024-07-17 02:24</div>
            <div class="timeline-body"><p>This rule is worth requiring human intervention anyway, fixing to <code>encoding-&quot;utf-8&quot;</code> would end up simplifying the fixer too (no version check, conditionals, or imports)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">good first issue</span> added by @charliermarsh on 2024-07-17 02:25</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">help wanted</span> added by @charliermarsh on 2024-07-17 02:25</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @charliermarsh by @charliermarsh on 2024-07-17 16:35</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2024-07-17 16:57</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 11:34:15 UTC
    </footer>
</body>
</html>
