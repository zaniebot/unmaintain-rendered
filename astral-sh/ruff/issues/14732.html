<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gitlab code quality fingerprint limitation: multiple errors with identical message - astral-sh/ruff #14732</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Gitlab code quality fingerprint limitation: multiple errors with identical message</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/ruff/issues/14732">#14732</a>
        opened by <a href="https://github.com/fin-gal">@fin-gal</a>
        on 2024-12-02 14:18
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/fin-gal">@fin-gal</a> on 2024-12-02 14:18</div>
            <div class="timeline-body"><h2>Context</h2>
<p>I'm implementing the use of code quality in Gitlab for the company I work at.
Code quality relies on json reports generated with a specific format, with each error having some metadata and a fingerprint.
My understanding is that in ruff, the fingerprint is a hash generated from:</p>
<ul>
<li>The relative file path</li>
<li>The error message</li>
<li>A salt value</li>
</ul>
<p><a href="https://github.com/astral-sh/ruff/blob/6dfe125f44352f5fdff19f6d47fc33ac7a6e86ad/crates/ruff_linter/src/message/gitlab.rs#L89">Relevant code  is here.</a></p>
<p>The finger print is:</p>
<ul>
<li><a href="https://github.com/astral-sh/ruff/blob/6dfe125f44352f5fdff19f6d47fc33ac7a6e86ad/crates/ruff_linter/src/message/gitlab.rs#L84">Generated</a></li>
<li><a href="https://github.com/astral-sh/ruff/blob/6dfe125f44352f5fdff19f6d47fc33ac7a6e86ad/crates/ruff_linter/src/message/gitlab.rs#L88">Checked for an identical finger print</a> in the already generated ones</li>
<li>If the finger print already exists: <a href="https://github.com/astral-sh/ruff/blob/6dfe125f44352f5fdff19f6d47fc33ac7a6e86ad/crates/ruff_linter/src/message/gitlab.rs#L89">regenerated by feeding the path,</a> message and current fingerprint as a salt.</li>
</ul>
<h2>Past changes</h2>
<p>In the past, the  line number at which the error is picked up used to be included in the hash, but thankfully was removed. If someone added code before an issue the file had, it would generate a new finger print and the code quality widget in Gitlab would show all the issues as fixed and also new, duplicating everything and making the tool unusable.
Reelvant issues/discussions on this subject:
https://github.com/astral-sh/ruff/discussions/3996 : initial discussion
https://github.com/astral-sh/ruff/pull/7203 : issue solving the above problem
https://github.com/astral-sh/ruff/issues/7159</p>
<h2>Current problem</h2>
<p>This is all positive and a clear welcomed improvement. However I see a shortcoming with this approach, <a href="https://github.com/astral-sh/ruff/pull/7203#discussion_r1318263447">that is actually mentioned</a> in the issue referenced above.</p>
<p>Let's assume we have a bunch of errors in a file that all have the same error message, I'll blatantly reuse the example by @MichaReiser in the above linked thread:</p>
<p>Let's say we have two unused variable diagnostics in a file:</p>
<pre><code>x = 1
y = 2
</code></pre>
<p>There's a hash collision for x and y, so y performs a second hashing round and we now fix the first violation</p>
<pre><code>x = 1
y = 2
print(x)
</code></pre>
<p>There's no longer a hash collision for y, meaning that the diagnostic for y now gets the hash (fingerprint) of the violation that used to be for x.</p>
<p>If I do this in gitlab's code quality, assuming I had a report generated on my target merge branch generated with these two errors, I might end up with a case where:</p>
<ul>
<li>y's unused error is now marked fixed even though it isn't</li>
<li>x's unused error is still present and not marked as fixed even though it is.</li>
</ul>
<p>You can also imagine plenty of other scenarios, where I fix a bunch of errors like the one above, but I introduce other identical errors later in the code, following the same logic, the fixed ones will not be marked as fixed and the new ones won't even be picked up and displayed as a new error.</p>
<h2>Specific scenario</h2>
<p>To bring this back to my specific scenario, I noticed problems while doing some various tests of the feature where I would add docstrings to functions missing them but then implement new functions without a docstring and would end up with the same error as above. Why is that? Because the missing docstring rule for a public function (D103) doesn't mention the name of the function for example and therefore all missing docstring errors are the same.</p>
<p>I understand the current implementation is still functional and the above examples are maybe fringe for most people but I still wanted to log it as it represents a limitation in our project.
I also wanted to know if anyone has any idea of how this could be improved without re-adding the line number which creates much more problems than the above.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">great writeup</span> added by @MichaReiser on 2024-12-02 14:26</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-12-02 14:29</div>
            <div class="timeline-body"><p>Thanks for the great write up.</p>
<p>We're interested in anyone's ideas on approaching this that doesn't rely on line numbers and isn't prone to the above problem. I tried to find some guidance or best practices from git lab but couldn't find any.</p>
<p>Do you use any other linters in your project that doesn't have the limitation you outlined above?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/mathieugouin">@mathieugouin</a> on 2025-09-03 20:28</div>
            <div class="timeline-body"><p>If it can help:</p>
<p>I manually implemented a similar fix for a custom gitlab code quality generator I wrote.</p>
<p>The trick I used (and I think this would solve the example above), is to <strong>also</strong> include the line content (but <strong>not</strong> the line number) in the input for generating the hash.</p>
<p>This way, it much less need to use the &quot;salt&quot;.</p>
<p>This logic was also included in Robocop linter for the Robot Framework testing languate, ref: https://github.com/MarketSquare/robotframework-robocop/issues/1116 and https://github.com/MarketSquare/robotframework-robocop/pull/1318</p>
<p>EDIT: Added &quot;(but <strong>not</strong> the line number)&quot;</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/bhirsz">@bhirsz</a> on 2025-09-03 20:54</div>
            <div class="timeline-body"><p>Yes, we did it in Robocop here:</p>
<p>https://github.com/MarketSquare/robotframework-robocop/blob/e55f3df6ad3b5b8d11ef34dadf2d0344f3aeea99/src/robocop/linter/reports/gitlab.py#L107</p>
<p>However since line content can be duplicated we also keep generating hash with added iterator index until unique hash is generated.</p>
<p>Moving the code doesnt affect it so its upside. Downside is that fixing only some of the exact issues (ie you have 10 unused 'x' variables, and you fix 5) may lead to marking incorrect line as fixed. Unrelated changes in the same line may also lead to changing hash and marking line as both fixed and having new issue. But it still worked a lot better than using line numbers approach</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/mathieugouin">@mathieugouin</a> on 2025-09-05 16:22</div>
            <div class="timeline-body"><p>If I can add also: I noticed that if <code>ruff check</code> is run on a windows host, the file path will have backslashes in the gitlab json output file.</p>
<p>From my tests, gitlab does not accepts backslashes in file paths.  I had to post process the gitlab file to convert to forward slashes and now it works.</p>
<p>Let me know if you think this should be in a separate issue.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntBre">@ntBre</a> on 2025-09-05 17:59</div>
            <div class="timeline-body"><p>That does sound like something we could resolve separately if you want to open a new issue, thanks for letting us know!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/20305.html">astral-sh/ruff#20305</a> on 2025-09-08 14:27</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 01:30:15 UTC
    </footer>
</body>
</html>
