<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PTH fixes should be unsafe when they change return types - astral-sh/ruff #21431</title>
    <link rel="stylesheet" href="../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../index.html">Back to index</a>
    </div>

    <h1>PTH fixes should be unsafe when they change return types</h1>

    <div class="meta">
        <span class="state state-closed">Closed</span>
        <a href="https://github.com/astral-sh/ruff/issues/21431">#21431</a>
        opened by <a href="https://github.com/dscorbett">@dscorbett</a>
        on 2025-11-13 16:05
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/dscorbett">@dscorbett</a> on 2025-11-13 16:05</div>
            <div class="timeline-body"><h3>Summary</h3>
<p>The fixes for <a href="https://docs.astral.sh/ruff/rules/os-rename/"><code>os-rename</code> (PTH104)</a>, <a href="https://docs.astral.sh/ruff/rules/os-replace/"><code>os-replace</code> (PTH105)</a>, <a href="https://docs.astral.sh/ruff/rules/os-getcwd/"><code>os-getcwd</code> (PTH109)</a>, and <a href="https://docs.astral.sh/ruff/rules/os-readlink/"><code>os-readlink</code> (PTH115)</a> should generally be marked unsafe because the replacements have different return types. <a href="https://play.ruff.rs/7e724491-845c-4667-bda4-cb66fd4e6783">Example</a>:</p>
<pre><code class="language-console">$ cat &gt;pth1.py &lt;&lt;'# EOF'
import os
import sys

# code   name               original return type -&gt; replacement

# PTH104 os-rename          None -&gt; Path
print(os.rename(&quot;pth1.py&quot;, &quot;pth1.py.bak&quot;))

# PTH105 os-replace         None -&gt; Path
print(os.replace(&quot;pth1.py.bak&quot;, &quot;pth1.py&quot;))

# PTH109 os-getcwd          str -&gt; Path
#        os-getcwdb         bytes -&gt; Path
try: print(os.getcwd().upper())
except AttributeError as e: print(e)
try: print(os.getcwdb().upper())
except AttributeError as e: print(e)

# PTH115 os-readlink        str -&gt; Path
try: print(os.readlink(sys.executable).upper())
except AttributeError as e: print(e)
# EOF

$ ruff --isolated check pth1.py --select PTH --preview --unsafe-fixes --fix
Found 5 errors (5 fixed, 0 remaining).

$ python pth1.py
pth1.py.bak
pth1.py
'PosixPath' object has no attribute 'upper'
'PosixPath' object has no attribute 'upper'
'PosixPath' object has no attribute 'upper'
</code></pre>
<p>The fixes are still safe in two cases. When the function call is the top-level expression in its statement, the return value is not used, so the return type does not matter, so the fix is safe. This case is common enough and easy enough to detect that I think it is worth supporting. When the original function returns a <code>str</code> or <code>bytes</code> and the replacement returns a <code>Path</code> and the function call is an argument to a function that interprets that argument as a <a href="https://docs.python.org/3/glossary.html#term-path-like-object">path-like object</a> and whose return value doesn’t expose the difference, then the difference in return type doesn’t matter, so the fix is safe. This case is harder to support because it requires reviewing each such function carefully, but if the ecosystem report reveals a common function that could be safe, it might be worth supporting it.</p>
<p>This all applies to <a href="https://docs.astral.sh/ruff/rules/os-path-abspath/"><code>os-path-abspath</code> (PTH100)</a>, <a href="https://docs.astral.sh/ruff/rules/os-path-expanduser/"><code>os-path-expanduser</code> (PTH111)</a>, and <a href="https://docs.astral.sh/ruff/rules/os-path-dirname/"><code>os-path-dirname</code> (PTH120)</a> too. Their fixes are already marked unsafe, but their documentation should explain this additional reason for unsafety.</p>
<h3>Version</h3>
<p>ruff 0.14.4 (c7ff9826d 2025-11-06)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">fixes</span> added by @ntBre on 2025-11-13 20:40</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">preview</span> added by @ntBre on 2025-11-13 20:40</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/21440.html">astral-sh/ruff#21440</a> on 2025-11-13 22:20</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @ntBre on 2025-12-01 20:26</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:28:17 UTC
    </footer>
</body>
</html>
