<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[red-knot] model that class/comprehension bodies run immediately - astral-sh/ruff #13933</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[red-knot] model that class/comprehension bodies run immediately</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/issues/13933">#13933</a>
        opened by <a href="https://github.com/carljm">@carljm</a>
        on 2024-10-25 22:08
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a></div>
            <div class="timeline-body"><p>Currently, we have a general strategy for name lookups in enclosing scopes: they use the type as seen from end of the scope where it's defined. For example:</p>
<pre><code>x = 1

def f():
    # This is correct for any call to `f` that would happen after this module has
    # fully executed. It could be wrong if `f` is called during execution of the
    # module body.
    reveal_type(x)  # revealed: Literal[&quot;foo&quot;]

x = &quot;foo&quot;
</code></pre>
<p>For nested functions, this is a pretty reasonable default behavior.  Another option would be to consider <em>all</em> definitions of <code>x</code> (or at least all definitions of <code>x</code> visible from the point where <code>f</code> is defined, forwards). This would result in revealing <code>Literal[1] | Literal[&quot;foo&quot;]</code> for <code>x</code> in the inner scope of <code>f</code>, instead. This would be safer, but also more annoying for the more common case where <code>f</code> is not called from the module body. It would also mean we would always consider <code>x</code> possibly-undefined inside <code>f</code>, if <code>f</code> is defined before <code>x</code>, which could be really annoying.</p>
<p>We could try to be smarter by detecting, for example, that the function <code>f</code> is (or might be) called from module level, and only consider earlier definitions if we observe this possibility. But this will always be best-effort, since reliably detecting all possible paths (other functions, even possibly in other modules) through which <code>f</code> could be called from module level isn't feasible.</p>
<p>But there are cases where we can be quite sure that the nested scope will run before the end of the outer scope. For example, class definitions:</p>
<pre><code>x = 1
class C:
    y = x
x = &quot;foo&quot;

# This is currently what we reveal, but it's clearly wrong: should be `Literal[1]`
reveal_type(C.y)  # revealed: Literal[&quot;foo&quot;]
</code></pre>
<p>The class body always runs immediately, so it should resolve types in the enclosing scope from the class definition's point in control flow, not from end-of-scope.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by @carljm on 2024-10-25 22:08</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-10-26 18:39</div>
            <div class="timeline-body"><p>Should we do the same for list/dict/set comprehensions? (Generators expressions obviously do not run immediately, unlike list/dict/set comprehensions.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2024-10-26 18:45</div>
            <div class="timeline-body"><p>Yes!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "[red-knot] model that class bodies run immediately" to "[red-knot] model that class/comprehension bodies run immediately" by @carljm on 2024-10-26 18:55</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone "Red Knot 2024" by @carljm on 2024-11-07 15:21</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @AlexWaygood by @carljm on 2024-11-14 17:37</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Removed from milestone "Red Knot 2024" by @carljm on 2025-01-09 17:43</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone "Red Knot Q1 2025" by @carljm on 2025-01-09 17:43</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-01-09 17:51</div>
            <div class="timeline-body"><p>See https://github.com/astral-sh/ruff/issues/13879 for discussion of generator expressions as it relates to this task.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @dcreager by @dcreager on 2025-02-10 22:55</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dcreager">@dcreager</a> on 2025-02-10 22:56</div>
            <div class="timeline-body"><p>https://github.com/astral-sh/ruff/pull/16079</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-02-19 20:34</div>
            <div class="timeline-body"><p>@dcreager is this complete now?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-02-19 20:37</div>
            <div class="timeline-body"><p>I think it is.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @carljm on 2025-02-19 20:37</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dcreager">@dcreager</a> on 2025-02-19 22:58</div>
            <div class="timeline-body"><p>I'm looking at how we're representing the bindings snapshots next, to see if there's any performance we can squeeze out of it.  But I'm :+1: to closing this since the functionality is there and working.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 16:51:22 UTC
    </footer>
</body>
</html>
