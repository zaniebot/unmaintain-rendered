<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Possible error when trying to fix with ICN001 - astral-sh/ruff #14439</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Possible error when trying to fix with ICN001</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/issues/14439">#14439</a>
        opened by <a href="https://github.com/tpgillam">@tpgillam</a>
        on 2024-11-18 17:45
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/tpgillam">@tpgillam</a> on 2024-11-18 17:45</div>
            <div class="timeline-body"><p>I obtain errors with <a href="https://docs.astral.sh/ruff/rules/unconventional-import-alias/">ICN001</a> when trying to apply autofix (in 'unsafe' mode) that should ideally convert the import from <code>from A1.A2.AN import B</code> to <code>import A1.A2.AN</code>.</p>
<p>For example, consider the following simple source file <code>moo.py</code>:</p>
<pre><code class="language-python">from math import sin

sin(42)
</code></pre>
<p>And then the following configuration for ruff  in <code>pyproject.toml</code></p>
<pre><code class="language-toml">[project]
name = &quot;moo&quot;
version = &quot;0.1.0&quot;
readme = &quot;README.md&quot;
requires-python = &quot;&gt;=3.13&quot;
dependencies = [
    &quot;ruff&gt;=0.7.4&quot;,
]

[tool.ruff.lint]
select = [&quot;ICN001&quot;]

[tool.ruff.lint.flake8-import-conventions.aliases]
&quot;math.sin&quot; = &quot;math.sin&quot;
</code></pre>
<p>I get the following error:</p>
<pre><code class="language-console">&gt; uv run ruff check --fix --unsafe-fixes moo.py
error: Fix introduced a syntax error. Reverting all changes.

This indicates a bug in Ruff. If you could open an issue at:

    https://github.com/astral-sh/ruff/issues/new?title=%5BFix%20error%5D

...quoting the contents of `moo.py`, the rule codes ICN001, along with the `pyproject.toml` settings and executed command, we'd be very appreciative!

moo.py:1:18: ICN001 `math.sin` should be imported as `math.sin`
  |
1 | from math import sin
  |                  ^^^ ICN001
2 |
3 | sin(42)
  |
  = help: Alias `math.sin` to `math.sin`

Found 1 error.
[*] 1 fixable with the --fix option.
</code></pre>
<p>I'm not 100% sure that I'm not abusing the intention of this rule, since here I'm trying to use the rule to enforce the <em>absence</em> of an alias, rather than a conventional alias :)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dylwil3">@dylwil3</a> on 2024-11-18 18:00</div>
            <div class="timeline-body"><p>Interesting... I think this is not quite what ICN001 was designed for. It's not possible to import (and then alias) a function like <code>import mymodule.myfunction</code>, which is what your user configuration is asking ICN001 to do.</p>
<p>Were you maybe looking for something like <a href="https://docs.astral.sh/ruff/rules/banned-import-from/"><code>ICN003</code></a>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dylwil3">@dylwil3</a> on 2024-11-18 22:46</div>
            <div class="timeline-body"><p>I'm also not super sold on whether to count this as a bug, since the user has required Ruff to insert the syntax error. It would be like writing a required import in the required imports linter setting that had a syntax error in it.</p>
<p>This is especially difficult to detect in advance because one has to resolve the module you're trying to import in order to tell whether you're attempting to alias a submodule or a function.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dscorbett">@dscorbett</a> on 2024-11-18 23:52</div>
            <div class="timeline-body"><p>This should count as a bug because something of the form <code>from x import y as x.y</code> is a syntax error regardless of whether <code>x.y</code> is a submodule or a function, so it can be detected in advance. Here is an example with a submodule:</p>
<pre><code class="language-console">$ echo 'from collections import abc' | ruff check --config 'lint.flake8-import-conventions.aliases = {&quot;collections.abc&quot; = &quot;collections.abc&quot;}' --select ICN001 - --unsafe-fixes --fix --isolated

error: Fix introduced a syntax error. Reverting all changes.

This indicates a bug in Ruff. If you could open an issue at:

    https://github.com/astral-sh/ruff/issues/new?title=%5BFix%20error%5D

...quoting the contents of `-`, the rule codes ICN001, along with the `pyproject.toml` settings and executed command, we'd be very appreciative!

from collections import abc
-:1:25: ICN001 `collections.abc` should be imported as `collections.abc`
  |
1 | from collections import abc
  |                         ^^^ ICN001
  |
  = help: Alias `collections.abc` to `collections.abc`

Found 1 error.
[*] 1 fixable with the --fix option.
</code></pre>
<p>Compare I002: if the user configures it to insert a syntax error, Ruff reports it as a user error instead of a generic ‚ÄúThis indicates a bug in Ruff‚Äù error:</p>
<pre><code class="language-console">$ echo 1 | ruff check --config 'lint.isort.required-imports = [&quot;from math import sin as math.sin&quot;]' --select I002 - --fix --isolated
error: invalid value 'lint.isort.required-imports = [&quot;from math import sin as math.sin&quot;]' for '--config &lt;CONFIG_OPTION&gt;'

  tip: A `--config` flag must either be a path to a `.toml` configuration file
       or a TOML `&lt;KEY&gt; = &lt;VALUE&gt;` pair overriding a specific configuration
       option

Could not parse the supplied argument as a `ruff.toml` configuration option:

Expected ',', found '.' at byte range 28..29
in `lint`

For more information, try '--help'.
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dylwil3">@dylwil3</a> on 2024-11-19 00:25</div>
            <div class="timeline-body"><p>Ah thanks for the investigation! I was mistakenly assuming that we were trying to do <code>import a.b as ...</code> and that's where the trouble originated.</p>
<p>We should certainly correct this!</p>
<p>As for detecting syntax errors like <code>import math.sin</code>: what I was trying to say is that while Ruff can detect the syntax error at the point of configuration in the example you give because it is detectable at the level of the grammar, I don't think it can detect <code>import math.sin</code> since it would have to know that <code>sin</code> was a function and not a submodule.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @dylwil3 by @dylwil3 on 2024-11-19 03:04</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @dhruvmanila on 2024-11-19 03:13</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">fixes</span> added by @dylwil3 on 2024-11-19 06:07</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">configuration</span> added by @dylwil3 on 2024-11-19 06:07</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/tpgillam">@tpgillam</a> on 2024-11-19 10:29</div>
            <div class="timeline-body"><p>Just a little additional context about our objective:</p>
<p>We have internal modules such that there exists a function <code>a.b.c.moo_func</code>. And there is also <code>d.moo_func</code>. So we want to enforce our convention that, at all sites, we always write:</p>
<pre><code class="language-python">import a.b.c
import d

a.b.c.moo_func(42)
d.moo_func(42)
</code></pre>
<p>But there might exist <code>a.b.c.Something</code> that we are happy to let people import as <code>Something</code> due to less ambiguity, so ICN003 would be a little too restrictive in this case.</p>
<p>We use the ICN001 rule to enforce this -- and it does seem (perhaps coincidentally!) to do a good job of detecting what we want. It's just that the autofix doesn't work :)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dylwil3">@dylwil3</a> on 2024-11-20 05:09</div>
            <div class="timeline-body"><p>The good news is that I can resolve the panic by surfacing an error to the user upon loading the configuration.</p>
<p>The bad news is that this breaks @tpgillam 's &quot;hack&quot; üòû . Unfortunately I think I do have to prefer fixing the panic over preserving the hack, because the latter is truly not how the rule was intended to work.</p>
<p>If ICN003 does not help, perhaps you can open another issue describing a lint rule or configuration option that would make sense for your use case and we can consider it there? Apologies.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/tpgillam">@tpgillam</a> on 2024-11-20 09:37</div>
            <div class="timeline-body"><p>No apologies required! Correctness is clearly preferable, I agree.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @MichaReiser on 2024-11-21 15:54</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 11:35:47 UTC
    </footer>
</body>
</html>
