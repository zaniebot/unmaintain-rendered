<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ANN401 doesn't work in overloads - astral-sh/ruff #5803</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>ANN401 doesn&#x27;t work in overloads</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/ruff/issues/5803">#5803</a>
        opened by <a href="https://github.com/ItsDrike">@ItsDrike</a>
        on 2023-07-16 12:43
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ItsDrike">@ItsDrike</a></div>
            <div class="timeline-body"><p>Note that some of the points I made here were moved to be addressed from another issue: #5871, as requested. These points were not actually bugs, and this behavior was intentionally not a part of ANN401, as these weren&#x27;t a part of this rule in the original <code>flake8-annotations</code> extension. The new issue is a feature request, asking for these to be added, leaving this issue purely as a bug report from one of the points I listed, which was indeed a valid bug. I&#x27;ve marked the points that were moved as strikethrough and you can ignore those when reading the issue description. If you&#x27;re interested in those, check out the linked issue instead.</p>
<hr>
<p>It seems that Ruff&#x27;s implementation of ANN401 is very permissive, and probably unintentionally incomplete.</p>
<ul>
<li>~~Unlike the <code>flake8-annotation</code> extension, ruff doesn&#x27;t seem to consider <code>Any</code> being used as a generic argument an issue.~~</li>
<li>~~Regular variable annotations (including class variables) don&#x27;t trigger ANN401~~</li>
<li>The concrete implementation of an overloaded function can contain <code>Any</code> (might be intentional though)</li>
</ul>
<p>I ran ruff with <code>ruff check --isolated --fix --show-source --show-fixes --select ANN401 test.py</code>, on version 0.0.278.</p>
~~Any in generic arguments~~


<pre><code>from typing import Any

def foo(x: dict[str, Any]) -&gt; None:
    ...
</code></pre>


<p>~~This should be considered as an issue, but isn&#x27;t. In case you&#x27;d feel like this would be too strict, there should at least be a new rule capable of enforcing this. However <code>flake8-annotations</code> would consider this as an issue.~~</p>
~~Any in variable annotations~~


<pre><code>from typing import Any, ClassVar

a: Any = 5

class Foo:
    X: ClassVar[Any] = 10
    Y: Any = 50
</code></pre>


<p>~~None of these are currently marked as violations, even though it&#x27;s a clear use of the Any type as an annotation. It seems that ANN401 only triggers when used in a function annotation, variables are not checked.~~</p>
Any in concrete overload
<p>I assume that this is intentional, but I didn&#x27;t find any docs to support that (I looked <a href="https://beta.ruff.rs/docs/rules/any-type/">here</a>).</p>
<pre><code>from typing import overload

@overload
def foobar(x: str) -&gt; str:
    ...

@overload
def foobar(x: int) -&gt; int:
    ...

def foobar(x: Any) -&gt; Any:  # no violation
    ...
</code></pre>
<p>If it is indeed intentional, it should maybe be mentioned somewhere? As someone moving from <code>flake8-annotations</code>, suddenly seeing ruff report an unnecessary noqa: ANN401 there is surprising, and even though I think it makes sense here, it could be worth documenting that this is a special case, exempt from ANN401.</p>
<p>Edit note: This behavior actually does NOT make sense, and is indeed a bug see  <a href="https://github.com/astral-sh/ruff/issues/5803">astral-sh/ruff#5803</a>#issuecomment-1640567168:</p>
<blockquote>
<p>As for the overload, after thinking on it for a bit, yeah, it should probably not behave like this, even though to the outside user of that function, the <code>Any</code> type there would not be visible, it should still absolutely be a union of those types, or a supertype shared by all types in the overloads, to allow the type-checker to properly check the code of the actual implementation of that function. So that is a bug which should get fixed.</p>
</blockquote>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from &quot;ANN401 doesn&#x27;t trigger for generic arguments&quot; to &quot;ANN401 doesn&#x27;t trigger for variables, nor generic attributes&quot; by <a href="https://github.com/ItsDrike">@ItsDrike</a> on 2023-07-16 13:03</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2023-07-18 10:37</div>
            <div class="timeline-body"><p>Hey, thanks for using Ruff and opening this issue.</p>
<blockquote>
<p>Any in generic arguments</p>
</blockquote>
<p>You&#x27;ve mentioned here that <code>flake8-annotations</code> raises a violation for the provided example  in this section but I&#x27;m unable to reproduce this. Can you provide the command you used to run <code>flake8</code> on the example? I&#x27;ve used the following command:</p>
<pre><code>flake8 --extend-select=ANN401 test.py
</code></pre>
<p>It&#x27;s also mentioned in the plugin README that this rule isn&#x27;t supported for nested dynamic types (https://github.com/sco1/flake8-annotations#dynamic-typing-caveats):</p>
<blockquote>
<p>Nested dynamic types (e.g. <code>typing.Tuple[typing.Any]</code>) and redefinition (e.g. <code>from typing import Any as Foo</code>) will not be identified.</p>
</blockquote>
<p><em>Ruff identifies redefinition</em></p>
<hr>
<blockquote>
<p>It seems that ANN401 only triggers when used in a function annotation, variables are not checked.</p>
</blockquote>
<p>Yes, this is true as is the case for <code>flake8-annotations</code>:</p>
<blockquote>
<p>Only function declarations are considered by this plugin; type annotations in function/module bodies are not checked</p>
</blockquote>
<hr>
<blockquote>
<p>Any in concrete overload</p>
</blockquote>
<p>This seems like a bug as it should be raising violations similar to the plugin. Thanks for noticing this!</p>
<hr>
<p>Overall, I think we should improve the documentation to be clear on where this rule will be checked and enable it on <code>@overload</code> implementation function.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2023-07-18 10:40</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">documentation</span> added by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2023-07-18 10:40</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-07-18 11:55</div>
            <div class="timeline-body"><p>(Omitting Any in a concrete overload might be desirable, is that not a common pattern?)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2023-07-18 12:53</div>
            <div class="timeline-body"><p>I&#x27;m not sure if it&#x27;s a common pattern as the concrete annotation would probably be a union of all possible types. Although, <code>flake8-annotations</code> does raise violation in this case.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ItsDrike">@ItsDrike</a> on 2023-07-18 16:39</div>
            <div class="timeline-body"><p>Oh, you&#x27;re actually right, it seems that <code>flake8-annotations</code> also doesn&#x27;t check this, huh, I&#x27;ve only noticed this when moving our code-base to ruff, as Ruff has reported unused noqa comments. Apparently this was never an issue, and those comments were just added because someone assumed it would be.</p>
<p>That&#x27;s pretty interesting, so in that case, I&#x27;d like to make this a feature request, as I think there is value in having a linter rule capable of finding use of <code>Any</code> in those nested type definitions, and it would be really nice if we were able to detect variable annotations containing <code>Any</code> too.</p>
<p>I&#x27;m not sure if the <code>flake8-annotations</code>&#x27;s ANN401 rule should be modified to include this, as that would not be compatible with the original extension then, so new rules would probably be needed here.</p>
<p>As for the overload, after thinking on it for a bit, yeah, it should probably not behave like this, even though to the outside user of that function, the <code>Any</code> type there would not be visible, it should still absolutely be a union of those types, or a supertype shared by all types in the overloads, to allow the type-checker to properly check the code of the actual implementation of that function. So that is a bug which should get fixed.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2023-07-18 17:47</div>
            <div class="timeline-body"><blockquote>
<p>That&#x27;s pretty interesting, so in that case, I&#x27;d like to make this a feature request, as I think there is value in having a linter rule capable of finding use of <code>Any</code> in those nested type definitions, and it would be really nice if we were able to detect variable annotations containing <code>Any</code> too.</p>
</blockquote>
<p>If possible can you open a new issue for this (better for tracking)? Otherwise I can open it later as well :)</p>
<blockquote>
<p>As for the overload, after thinking on it for a bit, yeah, it should probably not behave like this, even though to the outside user of that function, the <code>Any</code> type there would not be visible, it should still absolutely be a union of those types, or a supertype shared by all types in the overloads, to allow the type-checker to properly check the code of the actual implementation of that function. So that is a bug which should get fixed.</p>
</blockquote>
<p>I agree. Any thoughts here? /cc @charliermarsh @zanieb</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2023-07-18 19:05</div>
            <div class="timeline-body"><p>Regarding generic arguments, <code>dict[str, Any]</code> is fairly common in my experience. Anytime you&#x27;re working with <code>kwargs</code> (outside of the definition itself) e.g.</p>
<pre><code>from typing import reveal_type

def foo(**kwargs):
    reveal_type(kwargs)  # dict[str, Any]
</code></pre>
<p>It seems better to use a generic that&#x27;s partially complete than not at all. It would probably be reasonable to allow people to opt-in to enforcing narrower types though. I see a less controversial diagnostic for cases like <code>list[Any]</code> (either write <code>list</code> or narrow the generic) where <em>all</em> of the generic arguments are <code>Any</code>.</p>
<p>Variable annotations seem totally reasonable to address.</p>
<p>I agree best practice for the overloaded function is a union of all overload types. I think we should raise a violation here and consider implementing an autofix. Type checkers will not detect issues within the function body otherwise.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ItsDrike">@ItsDrike</a> on 2023-07-18 20:42</div>
            <div class="timeline-body"><p>Alright, I&#x27;ve opened a separate issue for the feature request, leaving this one just as a bug report.</p>
<p>By the way, I&#x27;ve also noticed another behavior that Ruff doesn&#x27;t pick up on, this one might be harder to address though, and perhaps something that should be left for a type checker to identify like with <a href="https://mypy.readthedocs.io/en/stable/command_line.html#disallow-dynamic-typing">mypy&#x27;s dynamic typing disallowing options</a> , and I would understand if it was not something you&#x27;ll want to fix:</p>
<pre><code>from typing import TypeAlias, Any

MyAny: TypeAlias = Any

def foo(x: MyAny) -&gt; None:
    ...
</code></pre>
<p>In this code, Ruff doesn&#x27;t report any annotation issues, even though <code>x</code> is actually annotated with the <code>Any</code> type, it&#x27;s just hidden behind a type alias.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2023-07-19 01:04</div>
            <div class="timeline-body"><blockquote>
<p>Alright, I&#x27;ve opened a separate issue for the feature request, leaving this one just as a bug report.</p>
</blockquote>
<p>Thanks!</p>
<blockquote>
<p>In this code, Ruff doesn&#x27;t report any annotation issues, even though <code>x</code> is actually annotated with the <code>Any</code> type, it&#x27;s just hidden behind a type alias.</p>
</blockquote>
<p>Yes, type aliases are a known issue across multiple rules as they&#x27;re difficult to detect reliably.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ItsDrike">@ItsDrike</a> on 2023-07-22 18:28</div>
            <div class="timeline-body"><blockquote>
<p>Yes, type aliases are a known issue across multiple rules as they&#x27;re difficult to detect reliably.</p>
</blockquote>
<p>That&#x27;s totally fair, though it should probably be mentioned in the rule&#x27;s docs, to make this clear.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from &quot;ANN401 doesn&#x27;t trigger for variables, nor generic attributes&quot; to &quot;ANN401 doesn&#x27;t work in overloads&quot; by <a href="https://github.com/ItsDrike">@ItsDrike</a> on 2023-07-31 09:39</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 18:48:39 UTC
    </footer>
</body>
</html>
