<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[red-knot] Module resolver has incorrect behaviour if a single-file module and potential namespace package coexist - astral-sh/ruff #12278</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[red-knot] Module resolver has incorrect behaviour if a single-file module and potential namespace package coexist</h1>

    <div class="meta">
        <span class="state state-closed">Closed</span>
        <a href="https://github.com/astral-sh/ruff/issues/12278">#12278</a>
        opened by <a href="https://github.com/AlexWaygood">@AlexWaygood</a>
        on 2024-07-10 15:44
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-07-10 15:44</div>
            <div class="timeline-body"><p>The following test should pass, but fails:</p>
<pre><code class="language-diff">diff --git a/crates/red_knot_module_resolver/src/resolver.rs b/crates/red_knot_module_resolver/src/resolver.rs
index 71b807871..5decee0c6 100644
--- a/crates/red_knot_module_resolver/src/resolver.rs
+++ b/crates/red_knot_module_resolver/src/resolver.rs
@@ -1140,4 +1140,21 @@ mod tests {
             system_path_to_file(&amp;db, stdlib.join(&quot;functools.pyi&quot;))
         );
     }
+
+    #[test]
+    fn single_file_takes_priority_over_namespace_package() {
+        const SRC: &amp;[FileSpec] = &amp;[(&quot;foo.py&quot;, &quot;x = 1&quot;), (&quot;foo/bar.py&quot;, &quot;x = 2&quot;)];
+
+        let TestCase { db, src, .. } = TestCaseBuilder::new().with_src_files(SRC).build();
+
+        let foo_module_name = ModuleName::new_static(&quot;foo&quot;).unwrap();
+        let foo_bar_module_name = ModuleName::new_static(&quot;foo.bar&quot;).unwrap();
+
+        // `foo.py` takes priority over the `foo` directory;
+        // `foo.bar` isn't recognised as a module:
+        let foo_module = resolve_module(&amp;db, foo_module_name.clone()).unwrap();
+        let foo_path = src.join(&quot;foo.py&quot;);
+        assert_eq!(&amp;foo_path, foo_module.file().path(&amp;db));
+        assert_eq!(resolve_module(&amp;db, foo_bar_module_name.clone()), None);
+    }
 }
</code></pre>
<p>At runtime, Python considers that a <code>foo</code> module exists and considers that a <code>foo.bar</code> module does not exist (it does not view the <code>foo</code> module as a package, as the <code>foo.py</code> file takes priority over the <code>foo</code> directory). The red-knot module resolver currently has the opposite understanding: it believes that there is no module <code>foo</code>, and that there <em>is</em> a module <code>foo.bar</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @AlexWaygood on 2024-07-10 15:44</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by @AlexWaygood on 2024-07-10 15:44</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @AlexWaygood by @AlexWaygood on 2024-07-10 15:44</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/11653.html">astral-sh/ruff#11653</a> on 2024-07-10 15:44</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/13254.html">astral-sh/ruff#13254</a> on 2024-09-05 15:58</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @AlexWaygood on 2024-09-06 11:14</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:34:53 UTC
    </footer>
</body>
</html>
