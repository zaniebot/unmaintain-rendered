<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RUF010 auto-fix only once per line - astral-sh/ruff #4567</title>
    <link rel="stylesheet" href="../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../index.html">Back to index</a>
    </div>

    <h1>RUF010 auto-fix only once per line</h1>

    <div class="meta">
        <span class="state state-closed">Closed</span>
        <a href="https://github.com/astral-sh/ruff/issues/4567">#4567</a>
        opened by <a href="https://github.com/LotemAm">@LotemAm</a>
        on 2023-05-21 21:10
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/LotemAm">@LotemAm</a> on 2023-05-21 21:10</div>
            <div class="timeline-body"><p>With 6db05d8cc6c1b065cb3a0c3bab00b546d5c8982a, output of <code>--show-fixes</code>:</p>
<details><summary>cargo run -p ruff_cli -- check crates/ruff/resources/test/fixtures/ruff/RUF010.py --no-cache --select RUF010 --show-source --show-fixes</summary>
<p>

<pre><code>crates/ruff/resources/test/fixtures/ruff/RUF010.py:9:4: RUF010 [*] Use conversion in f-string
   |
 9 | f&quot;{str(bla)}, {repr(bla)}, {ascii(bla)}&quot;  # RUF010
   |    ^^^^^^^^ RUF010
10 | 
11 | f&quot;{str(d['a'])}, {repr(d['b'])}, {ascii(d['c'])}&quot;  # RUF010
   |
   = help: Replace f-string function call with conversion

crates/ruff/resources/test/fixtures/ruff/RUF010.py:9:16: RUF010 [*] Use conversion in f-string
   |
 9 | f&quot;{str(bla)}, {repr(bla)}, {ascii(bla)}&quot;  # RUF010
   |                ^^^^^^^^^ RUF010
10 | 
11 | f&quot;{str(d['a'])}, {repr(d['b'])}, {ascii(d['c'])}&quot;  # RUF010
   |
   = help: Replace f-string function call with conversion

crates/ruff/resources/test/fixtures/ruff/RUF010.py:9:29: RUF010 [*] Use conversion in f-string
   |
 9 | f&quot;{str(bla)}, {repr(bla)}, {ascii(bla)}&quot;  # RUF010
   |                             ^^^^^^^^^^ RUF010
10 | 
11 | f&quot;{str(d['a'])}, {repr(d['b'])}, {ascii(d['c'])}&quot;  # RUF010
   |
   = help: Replace f-string function call with conversion

crates/ruff/resources/test/fixtures/ruff/RUF010.py:11:4: RUF010 [*] Use conversion in f-string
   |
11 | f&quot;{str(bla)}, {repr(bla)}, {ascii(bla)}&quot;  # RUF010
12 | 
13 | f&quot;{str(d['a'])}, {repr(d['b'])}, {ascii(d['c'])}&quot;  # RUF010
   |    ^^^^^^^^^^^ RUF010
14 | 
15 | f&quot;{(str(bla))}, {(repr(bla))}, {(ascii(bla))}&quot;  # RUF010
   |
   = help: Replace f-string function call with conversion

crates/ruff/resources/test/fixtures/ruff/RUF010.py:11:19: RUF010 [*] Use conversion in f-string
   |
11 | f&quot;{str(bla)}, {repr(bla)}, {ascii(bla)}&quot;  # RUF010
12 | 
13 | f&quot;{str(d['a'])}, {repr(d['b'])}, {ascii(d['c'])}&quot;  # RUF010
   |                   ^^^^^^^^^^^^ RUF010
14 | 
15 | f&quot;{(str(bla))}, {(repr(bla))}, {(ascii(bla))}&quot;  # RUF010
   |
   = help: Replace f-string function call with conversion

crates/ruff/resources/test/fixtures/ruff/RUF010.py:11:35: RUF010 [*] Use conversion in f-string
   |
11 | f&quot;{str(bla)}, {repr(bla)}, {ascii(bla)}&quot;  # RUF010
12 | 
13 | f&quot;{str(d['a'])}, {repr(d['b'])}, {ascii(d['c'])}&quot;  # RUF010
   |                                   ^^^^^^^^^^^^^ RUF010
14 | 
15 | f&quot;{(str(bla))}, {(repr(bla))}, {(ascii(bla))}&quot;  # RUF010
   |
   = help: Replace f-string function call with conversion

crates/ruff/resources/test/fixtures/ruff/RUF010.py:13:5: RUF010 [*] Use conversion in f-string
   |
13 | f&quot;{str(d['a'])}, {repr(d['b'])}, {ascii(d['c'])}&quot;  # RUF010
14 | 
15 | f&quot;{(str(bla))}, {(repr(bla))}, {(ascii(bla))}&quot;  # RUF010
   |     ^^^^^^^^ RUF010
16 | 
17 | f&quot;{foo(bla)}&quot;  # OK
   |
   = help: Replace f-string function call with conversion

crates/ruff/resources/test/fixtures/ruff/RUF010.py:13:19: RUF010 [*] Use conversion in f-string
   |
13 | f&quot;{str(d['a'])}, {repr(d['b'])}, {ascii(d['c'])}&quot;  # RUF010
14 | 
15 | f&quot;{(str(bla))}, {(repr(bla))}, {(ascii(bla))}&quot;  # RUF010
   |                   ^^^^^^^^^ RUF010
16 | 
17 | f&quot;{foo(bla)}&quot;  # OK
   |
   = help: Replace f-string function call with conversion

crates/ruff/resources/test/fixtures/ruff/RUF010.py:13:34: RUF010 [*] Use conversion in f-string
   |
13 | f&quot;{str(d['a'])}, {repr(d['b'])}, {ascii(d['c'])}&quot;  # RUF010
14 | 
15 | f&quot;{(str(bla))}, {(repr(bla))}, {(ascii(bla))}&quot;  # RUF010
   |                                  ^^^^^^^^^^ RUF010
16 | 
17 | f&quot;{foo(bla)}&quot;  # OK
   |
   = help: Replace f-string function call with conversion

Found 9 errors.
[*] 9 potentially fixable with the --fix option.
</code></pre>
</p>
</details> 

<p>But, actual fixes are only one per line, this is the output of <code>--diff</code>:</p>
<details><summary>cargo run -p ruff_cli -- check crates/ruff/resources/test/fixtures/ruff/RUF010.py --no-cache --select RUF010 --diff</summary>
<p>

<pre><code>--- crates/ruff/resources/test/fixtures/ruff/RUF010.py
+++ crates/ruff/resources/test/fixtures/ruff/RUF010.py
@@ -6,11 +6,11 @@
     pass
 
 
-f&quot;{str(bla)}, {repr(bla)}, {ascii(bla)}&quot;  # RUF010
+f&quot;{bla!s}, {repr(bla)}, {ascii(bla)}&quot;  # RUF010
 
-f&quot;{str(d['a'])}, {repr(d['b'])}, {ascii(d['c'])}&quot;  # RUF010
+f&quot;{d['a']!s}, {repr(d['b'])}, {ascii(d['c'])}&quot;  # RUF010
 
-f&quot;{(str(bla))}, {(repr(bla))}, {(ascii(bla))}&quot;  # RUF010
+f&quot;{bla!s}, {(repr(bla))}, {(ascii(bla))}&quot;  # RUF010
 
 f&quot;{foo(bla)}&quot;  # OK
 

Would fix 3 errors
</code></pre>
</p>
</details> 

<p>Note that reverting #4524 seems to fix the issue.</p>
<p>I'm guessing the issue is that these fixes are now considered overlapping in <code>crates/ruff/src/autofix/mod.rs:53,60</code> though I'm not sure how to fix this. Best idea I could think of is moving the next fixes range by the difference of char count from the last fix (as long as they don't overlap in the first place)</p>
<p>Maybe it would be good to add snapshot tests for <code>--diff</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-05-21 23:42</div>
            <div class="timeline-body"><p>Iâ€™m wondering if we should allow overlapping fixes to be output in diff mode.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">question</span> added by @charliermarsh on 2023-05-22 14:33</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/LotemAm">@LotemAm</a> on 2023-05-22 16:21</div>
            <div class="timeline-body"><p>I think that, as a user, something seems wrong when running without <code>--fix</code> shows there are 9 fixes available, but with <code>--fix</code> only 3 were fixed and there are no error/warnings to indicate why.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/JonathanPlasse">@JonathanPlasse</a> on 2023-05-23 18:30</div>
            <div class="timeline-body"><p>It would be possible fix this if the range for <code>ExprFormattedValue</code> was not the all f-string.</p>
<pre><code class="language-python">f&quot;{str(bla)}, {repr(bla)}, {ascii(bla)}&quot;
</code></pre>
<pre><code class="language-text">[
    Expr(
        StmtExpr {
            range: 0..40,
            value: JoinedStr(
                ExprJoinedStr {
                    range: 0..40,
                    values: [
                        FormattedValue(
                            ExprFormattedValue {
                                range: 0..40,
                                value: Call(
                                    ExprCall {
                                        range: 3..11,
                                        func: Name(
                                            ExprName {
                                                range: 3..6,
                                                id: Identifier(
                                                    &quot;str&quot;,
                                                ),
                                                ctx: Load,
                                            },
                                        ),
                                        args: [
                                            Name(
                                                ExprName {
                                                    range: 7..10,
                                                    id: Identifier(
                                                        &quot;bla&quot;,
                                                    ),
                                                    ctx: Load,
                                                },
                                            ),
                                        ],
                                        keywords: [],
                                    },
                                ),
                                conversion: None,
                                format_spec: None,
                            },
                        ),
                        Constant(
                            ExprConstant {
                                range: 0..40,
                                value: Str(
                                    &quot;, &quot;,
                                ),
                                kind: None,
                            },
                        ),
                        FormattedValue(
                            ExprFormattedValue {
                                range: 0..40,
                                value: Call(
                                    ExprCall {
                                        range: 15..24,
                                        func: Name(
                                            ExprName {
                                                range: 15..19,
                                                id: Identifier(
                                                    &quot;repr&quot;,
                                                ),
                                                ctx: Load,
                                            },
                                        ),
                                        args: [
                                            Name(
                                                ExprName {
                                                    range: 20..23,
                                                    id: Identifier(
                                                        &quot;bla&quot;,
                                                    ),
                                                    ctx: Load,
                                                },
                                            ),
                                        ],
                                        keywords: [],
                                    },
                                ),
                                conversion: None,
                                format_spec: None,
                            },
                        ),
                        Constant(
                            ExprConstant {
                                range: 0..40,
                                value: Str(
                                    &quot;, &quot;,
                                ),
                                kind: None,
                            },
                        ),
                        FormattedValue(
                            ExprFormattedValue {
                                range: 0..40,
                                value: Call(
                                    ExprCall {
                                        range: 28..38,
                                        func: Name(
                                            ExprName {
                                                range: 28..33,
                                                id: Identifier(
                                                    &quot;ascii&quot;,
                                                ),
                                                ctx: Load,
                                            },
                                        ),
                                        args: [
                                            Name(
                                                ExprName {
                                                    range: 34..37,
                                                    id: Identifier(
                                                        &quot;bla&quot;,
                                                    ),
                                                    ctx: Load,
                                                },
                                            ),
                                        ],
                                        keywords: [],
                                    },
                                ),
                                conversion: None,
                                format_spec: None,
                            },
                        ),
                    ],
                },
            ),
        },
    ),
]
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">question</span> removed by @charliermarsh on 2023-05-24 01:52</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @charliermarsh on 2023-05-24 01:52</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-05-24 01:53</div>
            <div class="timeline-body"><p>Yeah, I looked at this briefly, but there isn't really a straightforward way to fix this right now.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/JonathanPlasse">@JonathanPlasse</a> on 2023-05-24 10:31</div>
            <div class="timeline-body"><p>Could you explain why the range is incorrect?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-05-24 10:47</div>
            <div class="timeline-body"><p>A node's range should enclose all its content but not more. E.g. it should be impossible for siblings to have an overlapping range as it is the case here for the <code>Constant</code> and the <code>ExprFormattedValue</code> that both have the <code>0..40</code> range.</p>
<pre><code>Constant(
                            ExprConstant {
                                range: 0..40,
                                value: Str(
                                    &quot;, &quot;,
                                ),
                                kind: None,
                            },
                        ),
                        FormattedValue(
                            ExprFormattedValue {
                                range: 0..40,
</code></pre>
<p>I have to take a look at RustPython on why it ends up with these ranges but this might be a problem for the formatter too.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @charliermarsh by @charliermarsh on 2023-06-06 00:43</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-06-06 00:43</div>
            <div class="timeline-body"><p>This was actually just a bug in the rule.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/4886.html">astral-sh/ruff#4886</a> on 2023-06-06 00:45</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2023-06-06 00:52</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:28:09 UTC
    </footer>
</body>
</html>
