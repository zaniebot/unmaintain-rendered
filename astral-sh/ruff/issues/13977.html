<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IPython mode: load cell magics from configuration - astral-sh/ruff #13977</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>IPython mode: load cell magics from configuration</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/ruff/issues/13977">#13977</a>
        opened by <a href="https://github.com/minrk">@minrk</a>
        on 2024-10-29 10:09
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/minrk">@minrk</a> on 2024-10-29 10:09</div>
            <div class="timeline-body"><ul>
<li>Searched for: cell magics, Jupyter, IPython, configuration, pyproject.toml</li>
<li>ruff version: 0.7.1</li>
</ul>
<p>In handling IPython magics, the list of magics that contain Python code to be checked/formatted is currently <a href="https://github.com/astral-sh/ruff/blob/56c796acee6feaa3bd27b43c7ccca33b08f25d4c/crates/ruff_notebook/src/cell.rs#L243-L254">hard-coded</a>.</p>
<p>Since loads of extensions (especially profiling, etc.) and even users can define these magics interactively, it seems like the list of cell magics that should be treated as containing Python code should be loaded from configuration, so users can lint their notebooks without a patch to ruff itself.</p>
<p>nbqa <a href="https://nbqa.readthedocs.io/en/latest/configuration.html#cell-magics">has this feature</a> and can be used to run ruff on the contents of <em>arbitrary</em> cell magics, with the same default of assuming unrecognized cell magics don't contain Python code. A similar feature in ruff itself would be great!</p>
<p><a href="https://gist.github.com/minrk/1db663c2b4ae42e731a626865fd91ccf">Example notebook</a> with the cells:</p>
<pre><code class="language-python">from IPython import get_ipython


def decorate_cell(line, cell):
    print(&quot;before&quot;)
    get_ipython().run_cell(cell)
    print(&quot;after&quot;)

get_ipython().register_magic_function(decorate_cell, &quot;cell&quot;)
</code></pre>
<pre><code class="language-python">%%decorate_cell
x = 5
</code></pre>
<pre><code class="language-python">print(x) # &lt;- F821 false positive
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">configuration</span> added by @dhruvmanila on 2024-10-29 10:19</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">notebook</span> added by @dhruvmanila on 2024-10-29 10:19</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-10-29 10:32</div>
            <div class="timeline-body"><p>This seems like a reasonable request to me.</p>
<p>Unlike <code>nbqa</code>, Ruff is able to differentiate between line magics and cell magics. Ruff is able to parse out the line magics and continue parsing any other lines surrounding these line magics. The hard coded values are specific to cell magics and Ruff ignores them because they're applied on the entire cell. I'm sure you're aware of this but just re-iterating for context.</p>
<p>I'd prefer to have an alternate option name like <code>allowed_cell_magics</code> / <code>cell_magics</code> along with the <code>extend_*</code> version to make it clear that this is related to the &quot;cell magics&quot;. This option should be at the top level <code>[tool.ruff]</code> because both the linter and the formatter will consider them as is done so today. The non-extend option would have the default value that is hard coded today.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/minrk">@minrk</a> on 2024-10-30 11:05</div>
            <div class="timeline-body"><p>I'm also not sure if ruff handles it, but cell magics can be arbitrarily nested because the code-running cell magics (many of them anyway) call run_cell, which in turn may call cell magics, etc.. This is a valid cell containing Python code that should be recognized as a candidate for Python formatting assuming <code>prun</code>, <code>time</code>, and <code>timeit</code> are understood to be cell magic functions that accept code:</p>
<pre><code>%%prun
%%time
%%timeit
for i in range(5):
    _env = %env
</code></pre>
<p>whereas this one should not format the contents, since <code>sql</code> is not a Python-code cell magic:</p>
<pre><code>%%prun
%%sql
SELECT * FROM TABLE
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-10-30 11:23</div>
            <div class="timeline-body"><p>I think we <em>should</em> handle it correctly because we check if <em>any</em> of the lines contains a cell magic which might not have valid Python code:</p>
<p>https://github.com/astral-sh/ruff/blob/bd0d782b76d75c02668741c64303f6164910f8f2/crates/ruff_notebook/src/cell.rs#L206-L207</p>
<p>So, the two cells that you've provided works fine.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 11:35:33 UTC
    </footer>
</body>
</html>
