<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Proposed check: reuse of loop variable in nested loop - astral-sh/ruff #2972</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Proposed check: reuse of loop variable in nested loop</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/issues/2972">#2972</a>
        opened by <a href="https://github.com/matthewlloyd">@matthewlloyd</a>
        on 2023-02-16 20:49
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/matthewlloyd">@matthewlloyd</a> on 2023-02-16 20:49</div>
            <div class="timeline-body"><p>I was just bitten by a bug in production where I accidentally reused an outer loop variable in a nested loop. Example:</p>
<pre><code class="language-python"># Outer loop.
for i in range(10):
    # Enough code here to hide the outermost loop off screen.
    # ...

    # Developer does not notice &quot;i&quot; is already being used as a loop variable
    # and accidentally overwrites it here. The type is the same, so type checkers
    # don't complain.
    for i in range(10):
        print(f&quot;inner loop {i=}&quot;)

    # Enough code here to hide the innermost loop off screen.
    # ...

    # Developer expects &quot;i&quot; to still hold the value of the outer loop.
    # Instead, the value is always 9.
    print(f&quot;outer loop {i=}&quot;)
</code></pre>
<p>Proposed warning: <code>R???: &quot;Variable 'i' is already declared in 'for' loop or 'with' statement above&quot;</code></p>
<p>Credit for the wording: this is one of PyCharm's built-in inspections.</p>
<p>Note that although I am personally using only Ruff, I have opened a similar enhancement request in the <code>flake8-bugbear</code> repo here: https://github.com/PyCQA/flake8-bugbear/issues/360.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">rule</span> added by @charliermarsh on 2023-02-17 13:33</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/matthewlloyd">@matthewlloyd</a> on 2023-02-18 02:31</div>
            <div class="timeline-body"><p>I have a working draft of this and will submit a PR in the next few days...</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-02-18 02:33</div>
            <div class="timeline-body"><p>Sounds good. This looks reasonable to me, especially if it mirrors an existing PyCharm inspection. If bugbear adds it, we can use their rule code; otherwise, we can put it in RUF.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/matthewlloyd">@matthewlloyd</a> on 2023-02-18 03:13</div>
            <div class="timeline-body"><p>Great!</p>
<p>We may even want to create a new category for PyCharm inspections - I looked through them all, filtered them by suitability for implementation in a linter with no type awareness, then filtered out those for which Ruff already had counterparts, and was left with no fewer than 19 total including this one:</p>
<ul>
<li>Assignments to 'for' loop or 'with' statement parameter (this)</li>
<li>Assignment can be replaced with augmented assignment (a = a + b becomes a += b; arguably less useful)</li>
<li>Class-specific decorator is used outside the class (@classmethod or @staticmethod)</li>
<li>Dictionary contains duplicate keys ({'a': 1, 'a': 2})</li>
<li>First argument of the method is reassigned (e.g. reassignment to self)</li>
<li>Incorrect property definition (e.g. getter that does not return or yield a value)</li>
<li>__init__ method that returns a value</li>
<li>Invalid definition of 'typing.NamedTuple' (field with default followed by one or more fields without)</li>
<li>Method is not declared static (but does not use self)</li>
<li>Missed call to '__init__' of the super class</li>
<li>Non-optimal list declaration (l = [1], l.append(2) becomes l = [1, 2]; arguably less useful)</li>
<li>Old-style class contains new-style class features (__slots__, __getattribute__, super)</li>
<li>Redeclared names without usages (def x(): pass, followed later by x = 2, no uses in between)</li>
<li>Redundant boolean variable check (if b == True)</li>
<li>Redundant parentheses</li>
<li>Shadowing names from outer scopes</li>
<li>Statement has no effect (e.g. comprises solely a variable name)</li>
<li>Too complex chained comparisons ((x &gt;= 0 and x &lt;= 1) becomes (0 &lt;= x &lt;= 1)).</li>
<li>Unnecessary backslash - backslashes in places where line continuation is implicit inside (), [], and {}.</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/matthewlloyd">@matthewlloyd</a> on 2023-02-18 03:47</div>
            <div class="timeline-body"><p>I have this tested, with snapshots, and ready to review (thanks to your excellent contribution documentation!). Just need a decision from you on whether to put this under RUF or a create new category for PyCharm (PC? PYC? CH? CHA? CHM?).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sbrugman">@sbrugman</a> on 2023-02-18 12:21</div>
            <div class="timeline-body"><p>Great work @matthewlloyd! <code>ruff</code> should definitely incorporate the PyCharm inspections (which I suspect are inspired by pylint).</p>
<p>Regarding to where they should be placed, it depends on the rule.
Some of the checks are already there (e.g. Statement has no effect =&gt; B018) or are part of pylint but not yet implemented (could be a reason to prioritize implementing them, PyCharm has autofix for many of them). Any remaining could probably be placed under <code>RUF</code>.</p>
<p>See also: https://github.com/PyCQA/pylint/issues/5608</p>
<p>Pylint</p>
<ul>
<li><a href="https://pylint.readthedocs.io/en/latest/user_guide/messages/warning/redefined-outer-name.html#redefined-outer-name-w0621">redefined-outer-name / W0621</a> (this)</li>
<li>Assignment can be replaced with augmented assignment =&gt; <strong>init</strong> method that returns a value =&gt; <a href="https://vald-phoenix.github.io/pylint-errors/plerr/errors/basic/E0101.html">return-in-init</a>, PLE0101)</li>
<li><a href="https://pylint.readthedocs.io/en/latest/user_guide/messages/refactor/consider-using-augmented-assign.html">consider-using-augmented-assignment</a> PLR6104</li>
<li><a href="https://pylint.readthedocs.io/en/latest/user_guide/messages/warning/duplicate-key.html">Duplicate dictionary key</a>: PLW0109</li>
<li><a href="https://pylint.readthedocs.io/en/latest/user_guide/messages/warning/bad-staticmethod-argument.html#bad-staticmethod-argument-w0211">bad-staticmethod-argument / W0211</a>: Method is not declared static (but does not use self)</li>
</ul>
<p>Let's see if we can find corresponding rules to the remaining ones in the  overview of <a href="https://pylint.readthedocs.io/en/latest/user_guide/messages/messages_overview.html">rules</a> in pylint.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/matthewlloyd">@matthewlloyd</a> on 2023-02-18 19:05</div>
            <div class="timeline-body"><p>Sounds reasonable to me! I wasn't aware of #970, and agree there is a lot of overlap. I went through all the PyCharm inspections in my list above and categorized them by whether they have PyLint counterparts, mostly by running PyLint directly on the examples provided in the PyCharm Settings panel.</p>
<p>The inspection in this issue is indeed partially covered by PyLint's new PLW2901 redefined-loop-name inspection, though it does not seem to be detected at all by PLW0621 redefined-outer-name. However, the semantics are slightly different between the PyCharm and PyLint versions:</p>
<ul>
<li>PyLint's is more general in detecting <em>any</em> nested assignment to a loop variable, not just as the target of another loop statement.</li>
<li>PyLint's is slightly more specific in working only for <em>loop</em> variables, whereas PyCharm's also examines <em>with</em> statements.</li>
</ul>
<p>Given that, it might make sense to add this as PLW2901, and either roll in <em>with</em> statements (my vote), or pull out the <em>with</em> variant into a separate RUF. I'll need to extend my code a little to detect all nested assignments.</p>
<h3>Already covered by PyLint</h3>
<ul>
<li>Assignments to 'for' loop or 'with' statement parameter (see above)<ul>
<li>PLW2901 redefined-loop-name</li>
</ul>
</li>
<li>Assignment can be replaced with augmented assignment (a = a + b becomes a += b; arguably less useful)<ul>
<li>PLR6104 consider-using-augmented-assign</li>
</ul>
</li>
<li>Dictionary contains duplicate keys ({'a': 1, 'a': 2})<ul>
<li>PLW0109 duplicate-key</li>
</ul>
</li>
<li>First argument of the method is reassigned (e.g. reassignment to self)<ul>
<li>PLW0642 self-cls-assignment</li>
</ul>
</li>
<li><strong>init</strong> method that returns a value<ul>
<li>PLE101 return-in-init</li>
</ul>
</li>
<li>Method is not declared static (but does not use self)<ul>
<li>PLR6301 no-self-use</li>
<li>PLW0211 bad-staticmethod-argument (not quite the same thing)</li>
</ul>
</li>
<li>Missed call to '<strong>init</strong>' of the super class<ul>
<li>PLW0231 super-init-not-called</li>
</ul>
</li>
<li>Redundant boolean variable check (if b == True)<ul>
<li>PLC0121 singleton-comparison</li>
</ul>
</li>
<li>Statement has no effect (e.g. comprises solely a variable name)<ul>
<li>PLW0104 pointless-statement</li>
<li>also B018 as above</li>
</ul>
</li>
<li>Too complex chained comparisons ((x &gt;= 0 and x &lt;= 1) becomes (0 &lt;= x &lt;= 1)).<ul>
<li>PLR1716 chained-comparison</li>
</ul>
</li>
<li>Unnecessary backslash - backslashes in places where line continuation is implicit inside (), [], and {}.<ul>
<li>PyLint does not detect this, but pycodestyle has E502: &quot;The backslash is redundant between brackets&quot; (not yet implemented in Ruff)</li>
</ul>
</li>
</ul>
<h3>PyCharm inspections not covered by PyLint in my tests</h3>
<p>(note: this list includes only those I deemed implementable in a non-type-aware linter)</p>
<ul>
<li>Class-specific decorator is used outside the class (@classmethod or @staticmethod)<pre><code class="language-python">@staticmethod
def a(): pass
</code></pre>
</li>
<li>Incorrect property definition (e.g. getter that does not return or yield a value)<pre><code class="language-python">class A:
    @property
    def field(): pass
</code></pre>
</li>
<li>Invalid definition of 'typing.NamedTuple' (field with default followed by one or more fields without)<pre><code class="language-python">import typing

class FullName(typing.NamedTuple):
    first: str
    last: str = &quot;&quot;
    middle: str
</code></pre>
</li>
<li>Non-optimal list declaration (l = [1], l.append(2) becomes l = [1, 2]; arguably less useful)<pre><code class="language-python">l = [1]
l.append(2)
</code></pre>
</li>
<li>Redeclared names without usages (def x(): pass, followed later by x = 2, no uses in between)<pre><code class="language-python">def x(): pass
x = 2
</code></pre>
</li>
<li>Redundant parentheses<pre><code class="language-python">a = (((3)))
</code></pre>
</li>
<li>Shadowing names from outer scopes<pre><code class="language-python">def outer(p):
  def inner(p):
      pass
</code></pre>
</li>
</ul>
<p>The rule &quot;Old-style class contains new-style class features (<strong>slots</strong>, <strong>getattribute</strong>, super)&quot; is no longer relevant since Python 3.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2023-02-22 03:23</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 11:29:23 UTC
    </footer>
</body>
</html>
