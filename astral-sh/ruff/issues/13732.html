<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[red-knot] `mdtest` doesn't spot a new Markdown test file has been added until you force a rebuild of the crate being tested - astral-sh/ruff #13732</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[red-knot] <code>mdtest</code> doesn't spot a new Markdown test file has been added until you force a rebuild of the crate being tested</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/issues/13732">#13732</a>
        opened by <a href="https://github.com/AlexWaygood">@AlexWaygood</a>
        on 2024-10-13 22:35
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a></div>
            <div class="timeline-body"><p>I just did the following:</p>
<ul>
<li>Wrote some new red-knot code in a new PR branch</li>
<li>Added a new Markdown test for the code that I was sure was going to fail</li>
<li>Ran <code>cargo test -p red_knot_python_semantic</code>, was mystified at the lack of failures</li>
<li>After a little bit, figured out that the test wasn't being run at all</li>
<li>As soon as I added a random newline to <code>red_knot_python_semantic</code>, it triggered a rebuild of the crate and the new Markdown test file was picked up by <code>mdtest</code>, as expected.</li>
</ul>
<p>I think this has actually happened to me a few times over the last few days, but this is the first time I realised exactly what was going on...</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @AlexWaygood on 2024-10-13 22:35</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">testing</span> added by @AlexWaygood on 2024-10-13 22:35</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by @AlexWaygood on 2024-10-13 22:35</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-10-13 22:50</div>
            <div class="timeline-body"><p>I suppose this is because <code>rstest</code> generates the tests (one test per Markdown file, at least from <code>rstest</code>'s perspective) at build time rather than at runtime here: https://github.com/astral-sh/ruff/blob/defdc4dd8e88b881f113a9d7fb5cc4e8ef22ac35/crates/red_knot_python_semantic/tests/mdtest.rs#L5-L14</p>
<p>And it doesn't know to rebuild the tests when a Markdown file is added, because a Markdown file isn't a Rust source file.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-10-13 23:00</div>
            <div class="timeline-body"><p>The <a href="https://docs.rs/rstest/0.23.0/rstest/attr.rstest.html#files-path-as-input-arguments"><code>rstest</code> docs</a> say:</p>
<blockquote>
<p>Finally, often you would to recompile tests sources when file the folders or the environment variables changed. In this case you should provide a build.rs script file that tell to the compiler what to look in order to recompile the tests. For instance follow a simple example:
<a href="https://docs.rs/rstest/0.23.0/rstest/attr.rstest.html#">â“˜</a></p>
<pre><code class="language-rs">pub fn main() {
    println!(&quot;cargo::rerun-if-changed=tests/resources&quot;);
    println!(&quot;cargo::rerun-if-env-changed=BASE_TEST_DIR&quot;);
}
</code></pre>
</blockquote>
<p>Which seems okay... though it's a bit of a pain if we have to add a <code>build.rs</code> script to every crate that uses <code>mdtest</code>-based tests. But maybe we won't actually end up adding many outside of <code>red_knot_python_semantic</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-10-14 07:33</div>
            <div class="timeline-body"><p>(Cc. @carljm)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-10-14 07:43</div>
            <div class="timeline-body"><p>Yeah. We discussed this in the notion design document. The only other alternative is to discover the tests in the test function itself but that has the downside that all markdown tests run sequentially (and one failing test prevents other markdown tests from running).</p>
<p>We should add a <code>build.rs</code> because not seeing your test after adding a file is very confusing.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> removed by @MichaReiser on 2024-10-14 07:44</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Lexxxzy">@Lexxxzy</a> on 2024-10-14 09:27</div>
            <div class="timeline-body"><blockquote>
<p>We should add a build.rs because not seeing your test after adding a file is very confusing.</p>
</blockquote>
<p>+1, experienced the same problem while porting whole infer tests set on #13719.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @AlexWaygood by @AlexWaygood on 2024-10-14 09:38</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @AlexWaygood on 2024-10-14 12:02</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 16:51:16 UTC
    </footer>
</body>
</html>
