<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>`RUF011` possible false positive for optional unwrapping in dict comprehension - astral-sh/ruff #9548</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1><code>RUF011</code> possible false positive for optional unwrapping in dict comprehension</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/issues/9548">#9548</a>
        opened by <a href="https://github.com/farmio">@farmio</a>
        on 2024-01-16 08:31
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/farmio">@farmio</a></div>
            <div class="timeline-body">

<p>Hi ðŸ‘‹!</p>
<p>I have a piece of code raising</p>
<pre><code>RUF011 Dictionary comprehension uses static key: `attr`
</code></pre>
<p>from <code>ruff check .</code> since the update from ruff 0.1.11 to 0.1.13.</p>
<p>This is the piece of code in question:
https://github.com/XKNX/xknxproject/blob/73088e13bfcd11f4dc03963bf2c8ef4776972e68/xknxproject/loader/knx_master_loader.py#L70-L75
A short version of it:</p>
<pre><code>from xml.etree.ElementTree import Element
translation_element: Element

translations = {
    attr: text
    for item in translation_element.findall(&quot;{*}Translation&quot;)  # `Element.findall() -&gt; list[Element]`
    if (attr := item.get(&quot;AttributeName&quot;)) is not None  # unwrap since `Element.get() -&gt; str | None`
    and (text := item.get(&quot;Text&quot;)) is not None
}
</code></pre>
<p>I would expect <code>attr</code> not to be treated as static key here since it should (depending on the xml source) be different for every iteration of the comprehension.</p>
<p>Here is my ruff section from pyproject.toml:</p>
<pre><code>[tool.ruff]
target-version = &quot;py39&quot;
select = [
  &quot;C4&quot;,  # comprehensions
  &quot;D&quot;,   # pydocstyle
  &quot;E&quot;,   # pycodestyle
  &quot;F&quot;,   # pyflakes
  &quot;I&quot;,   # isort
  &quot;RUF&quot;, # ruff specific
  &quot;T20&quot;, # print
  &quot;UP&quot;,  # pyupgrade
  &quot;W&quot;,   # pydocstyle warning
]
ignore = [
  &quot;D202&quot;,
  &quot;D203&quot;,
  &quot;D212&quot;,
  &quot;E501&quot;, # line too long
]
extend-exclude = [
  &quot;script&quot;,
]

[tool.ruff.isort]
force-sort-within-sections = true
combine-as-imports = true
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to <a href="https://github.com/charliermarsh">@charliermarsh</a> by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-01-16 19:38</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-01-16 19:38</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-01-16 19:38</div>
            <div class="timeline-body"><p>Thanks! Looks like a bug.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-01-16 19:55</div>
            <div class="timeline-body"><p>I&#x27;ll fix this today.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-01-16 20:02</div>
            <div class="timeline-body"><p>Oh sorry, I can confirm that this was already fixed on <code>main</code> but hasn&#x27;t been released yet: <a href="https://github.com/astral-sh/ruff/pull/9494">astral-sh/ruff#9494</a></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-01-16 20:02</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 18:48:49 UTC
    </footer>
</body>
</html>
