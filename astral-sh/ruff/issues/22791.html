<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Adding a new setting for rule E501 (`ignore-all-comments`) - astral-sh/ruff #22791</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Adding a new setting for rule E501 (<code>ignore-all-comments</code>)</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/ruff/issues/22791">#22791</a>
        opened by <a href="https://github.com/chirizxc">@chirizxc</a>
        on 2026-01-21 19:28
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/chirizxc">@chirizxc</a></div>
            <div class="timeline-body">Summary
<p>Example:</p>
<p><code>main.py</code>:</p>
<pre><code>x = 1  # type: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
y = 2  # text text text text text
k = 3  # noqa
</code></pre>
<p><code>ruff.toml</code>:</p>
<pre><code>line-length = 5

[lint]
select = [&quot;E501&quot;]
task-tags = [
    &quot;type&quot;,
]

[lint.pycodestyle]
ignore-overlong-task-comments = false
</code></pre>
<pre><code>‚ùØ ruff check main.py                                                                                                                           
E501 Line too long (33 &gt; 5)                                                                                                                    
 --&gt; main.py:2:6
  |
1 | x = 1  # type: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
2 | y = 2  # text text text text text
  |      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
3 | k = 3  # noqa
  |

Found 1 error.
</code></pre>
<p>I think it would be reasonable to make a non-default setting that can be enabled via</p>
<pre><code>[lint.pycodestyle]
ignore-all-comments = true
</code></pre>
<p>That is, in this case, all of these cases would be reported, as in the original flake8.</p>
<p>I mean that with the settings we could completely disable https://github.com/astral-sh/ruff/blob/main/crates/ruff_python_trivia/src/pragmas.rs</p>
<p>This question arose during a comparison of flake8 and ruff in a conversation about dishka on Telegram, screenshot example from @Tishka17:</p>
<p><img alt="Image" src="https://github.com/user-attachments/assets/ddc19008-c330-4bd6-b10e-25823dcdd363"></p>
<p>As you can see in the photo, the comments are not legible, i.e., they are simply not visible.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from &quot;Adding a new setting for rule E501&quot; to &quot;Adding a new setting for rule E501 (`ignore-all-comments`)&quot; by <a href="https://github.com/chirizxc">@chirizxc</a> on 2026-01-21 19:29</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/amyreese">@amyreese</a> on 2026-01-21 19:54</div>
            <div class="timeline-body"><p>why not just disable E501 and rely on a formatter to enforce line length?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/chirizxc">@chirizxc</a> on 2026-01-21 19:56</div>
            <div class="timeline-body"><blockquote>
<p>why not just disable E501 and rely on a formatter to enforce line length?</p>
</blockquote>
<p>The formatter is not entirely suitable, at least in that it violates PEP8.</p>
<p>See: <a href="https://github.com/astral-sh/ruff/issues/20454">astral-sh/ruff#20454</a>#issuecomment-3304157224</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/chirizxc">@chirizxc</a> on 2026-01-21 20:01</div>
            <div class="timeline-body"><p>For me, <code>black</code> (and its implementation within <code>ruff</code>) is a very strange formatter, at least the style that was used before literally bloated the code and made it less readable (in my opinion).</p>
<p>I can give you an example of the <a href="https://black.readthedocs.io/en/stable/the_black_code_style/future_style.html#improved-multiline-dictionary-and-list-indentation-for-sole-function-parameter">old format</a> that black used to have:</p>
<p><img alt="Image" src="https://github.com/user-attachments/assets/01f5c743-043c-496f-bb3d-7ebe162005c5"></p>
<p>It is unclear why this was not done earlier, but remained unchanged for many years.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntBre">@ntBre</a> on 2026-01-21 21:48</div>
            <div class="timeline-body"><p>I guess I can see why you would want a mechanism for finding these lines, but there&#x27;s often not much you can do to fix it, which I think is why these are skipped in the current implementation (<a href="https://github.com/astral-sh/ruff/pull/7692">astral-sh/ruff#7692</a>). For example, our <code>noqa</code> comments (and ty&#x27;s) need to be at the end of the line and can&#x27;t really be moved, unless you somehow restructure the code itself.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">configuration</span> added by <a href="https://github.com/ntBre">@ntBre</a> on 2026-01-21 21:48</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">needs-decision</span> added by <a href="https://github.com/ntBre">@ntBre</a> on 2026-01-21 21:48</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/chirizxc">@chirizxc</a> on 2026-01-21 21:51</div>
            <div class="timeline-body"><blockquote>
<p>I guess I can see why you would want a mechanism for finding these lines, but there&#x27;s often not much you can do to fix it, which I think is why these are skipped in the current implementation (<a href="https://github.com/astral-sh/ruff/pull/7692">#7692</a>). For example, our <code>noqa</code> comments (and ty&#x27;s) need to be at the end of the line and can&#x27;t really be moved, unless you somehow restructure the code itself.</p>
</blockquote>
<p>This setting will be optional, and most likely only those who need it will use it. This setting will not conflict with others:</p>
<p><img alt="Image" src="https://github.com/user-attachments/assets/8fde5cd5-01d2-436b-ab5d-befb5b08f1e4"></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/chirizxc">@chirizxc</a> on 2026-01-21 21:54</div>
            <div class="timeline-body"><p>The value <code>line-length = 5</code> is just an example. In real projects, such as the screenshot above from dishka, you can shift the code slightly so that it fits on the screen and you don&#x27;t have to scroll</p>
<p><img alt="Image" src="https://github.com/user-attachments/assets/1d20e585-4083-4fbc-99e7-0f6176495a33"></p>
<p>vvv</p>
<p><img alt="Image" src="https://github.com/user-attachments/assets/ffd67001-317e-4dec-b973-6f7070e004dd"></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/chirizxc">@chirizxc</a> on 2026-01-21 21:56</div>
            <div class="timeline-body"><p>The same flake8 complains about this, we must take this setting into account for commands that have switched to ruff:</p>
<p><img alt="Image" src="https://github.com/user-attachments/assets/30d25538-ccf5-4576-9edd-7e304e78da93"></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/chirizxc">@chirizxc</a> on 2026-01-21 22:05</div>
            <div class="timeline-body"><p>Diff looks pretty small without tests for such a &quot;useful&quot; setting:</p>
<pre><code>diff --git a/crates/ruff_linter/src/rules/pycodestyle/overlong.rs b/crates/ruff_linter/src/rules/pycodestyle/overlong.rs                       
index 56cfb25df9..b4b20a1a5e 100644
--- a/crates/ruff_linter/src/rules/pycodestyle/overlong.rs
+++ b/crates/ruff_linter/src/rules/pycodestyle/overlong.rs
@@ -21,6 +21,7 @@ impl Overlong {
         limit: LineLength,
         task_tags: &amp;[String],
         tab_size: IndentWidth,
+        ignore_all_comments: bool,
     ) -&gt; Option&lt;Self&gt; {
         // The maximum width of the line is the number of bytes multiplied by the tab size (the
         // worst-case scenario is that the line is all tabs). If the maximum width is less than the
@@ -37,7 +38,7 @@ impl Overlong {
         }
 
         // Strip trailing comments and re-measure the line, if needed.
-        let line = StrippedLine::from_line(line, comment_ranges, task_tags);
+        let line = StrippedLine::from_line(line, comment_ranges, task_tags, ignore_all_comments);
         let width = match &amp;line {
             StrippedLine::WithoutPragma(line) =&gt; {
                 let width = measure(line.as_str(), tab_size);
@@ -116,7 +117,12 @@ enum StrippedLine&lt;&#x27;a&gt; {
 impl&lt;&#x27;a&gt; StrippedLine&lt;&#x27;a&gt; {
     /// Strip trailing comments from a [`Line`], if the line ends with a pragma comment (like
     /// `# type: ignore`) or, if necessary, a task comment (like `# TODO`).
-    fn from_line(line: &amp;&#x27;a Line&lt;&#x27;a&gt;, comment_ranges: &amp;CommentRanges, task_tags: &amp;[String]) -&gt; Self {
+    fn from_line(
+        line: &amp;&#x27;a Line&lt;&#x27;a&gt;,
+        comment_ranges: &amp;CommentRanges,
+        task_tags: &amp;[String],
+        ignore_all_comments: bool,
+    ) -&gt; Self {
         let [comment_range] = comment_ranges.comments_in_range(line.range()) else {
             return Self::Unchanged(line);
         };
@@ -126,7 +132,7 @@ impl&lt;&#x27;a&gt; StrippedLine&lt;&#x27;a&gt; {
         let comment = &amp;line.as_str()[comment_range];
 
         // Ex) `# type: ignore`
-        if is_pragma_comment(comment) {
+        if !ignore_all_comments &amp;&amp; is_pragma_comment(comment) {
             // Remove the pragma from the line.
             let prefix = &amp;line.as_str()[..usize::from(comment_range.start())].trim_end();
             return Self::WithoutPragma(Line::new(prefix, line.start()));
diff --git a/crates/ruff_linter/src/rules/pycodestyle/rules/doc_line_too_long.rs b/crates/ruff_linter/src/rules/pycodestyle/rules/doc_line_too_long.rs
index 9e59ce5a79..f0d7b4856f 100644
--- a/crates/ruff_linter/src/rules/pycodestyle/rules/doc_line_too_long.rs
+++ b/crates/ruff_linter/src/rules/pycodestyle/rules/doc_line_too_long.rs
@@ -104,6 +104,7 @@ pub(crate) fn doc_line_too_long(
             &amp;[]
         },
         settings.tab_size,
+        settings.pycodestyle.ignore_all_comments,
     ) {
         context.report_diagnostic(
             DocLineTooLong(overlong.width(), limit.value() as usize),
diff --git a/crates/ruff_linter/src/rules/pycodestyle/rules/line_too_long.rs b/crates/ruff_linter/src/rules/pycodestyle/rules/line_too_long.rs
index b81cbdf7b1..cdc4a19b6c 100644
--- a/crates/ruff_linter/src/rules/pycodestyle/rules/line_too_long.rs
+++ b/crates/ruff_linter/src/rules/pycodestyle/rules/line_too_long.rs
@@ -100,6 +100,7 @@ pub(crate) fn line_too_long(
             &amp;[]
         },
         settings.tab_size,
+        settings.pycodestyle.ignore_all_comments,
     ) {
         context.report_diagnostic(
             LineTooLong(overlong.width(), limit.value() as usize),
diff --git a/crates/ruff_linter/src/rules/pycodestyle/settings.rs b/crates/ruff_linter/src/rules/pycodestyle/settings.rs
index b034a77874..df7f146d66 100644
--- a/crates/ruff_linter/src/rules/pycodestyle/settings.rs
+++ b/crates/ruff_linter/src/rules/pycodestyle/settings.rs
@@ -11,6 +11,7 @@ pub struct Settings {
     pub max_line_length: LineLength,
     pub max_doc_length: Option&lt;LineLength&gt;,
     pub ignore_overlong_task_comments: bool,
+    pub ignore_all_comments: bool,
 }
 
 impl fmt::Display for Settings {
@@ -22,6 +23,7 @@ impl fmt::Display for Settings {
                 self.max_line_length,
                 self.max_doc_length | optional,
                 self.ignore_overlong_task_comments,
+                self.ignore_all_comments,
             ]
         }
         Ok(())
diff --git a/crates/ruff_workspace/src/options.rs b/crates/ruff_workspace/src/options.rs
index f2c15755c1..158f3a992d 100644
--- a/crates/ruff_workspace/src/options.rs
+++ b/crates/ruff_workspace/src/options.rs
@@ -560,7 +560,7 @@ pub struct LintOptions {
     pub future_annotations: Option&lt;bool&gt;,
 }
 
-pub fn validate_required_version(required_version: &amp;RequiredVersion) -&gt; anyhow::Result&lt;()&gt; {
+pub fn validate_required_version(required_version: &amp;RequiredVersion) -&gt; Result&lt;()&gt; {
     let ruff_pkg_version = pep440_rs::Version::from_str(RUFF_PKG_VERSION)
         .expect(&quot;RUFF_PKG_VERSION is not a valid PEP 440 version specifier&quot;);
     if !required_version.contains(&amp;ruff_pkg_version) {
@@ -3081,6 +3081,16 @@ pub struct PycodestyleOptions {
         &quot;#
     )]
     pub ignore_overlong_task_comments: Option&lt;bool&gt;,
+
+    /// Whether to ignore all comments when checking line length.
+    #[option(
+        default = &quot;false&quot;,
+        value_type = &quot;bool&quot;,
+        example = r#&quot;
+            ignore-all-comments = true
+        &quot;#
+    )]
+    pub ignore_all_comments: Option&lt;bool&gt;,
 }
 
 impl PycodestyleOptions {
@@ -3089,6 +3099,7 @@ impl PycodestyleOptions {
             max_doc_length: self.max_doc_length,
             max_line_length: self.max_line_length.unwrap_or(global_line_length),
             ignore_overlong_task_comments: self.ignore_overlong_task_comments.unwrap_or_default(),
+            ignore_all_comments: self.ignore_all_comments.unwrap_or_default(),
         }
     }
 }
</code></pre>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-21 23:09:53 UTC
    </footer>
</body>
</html>
