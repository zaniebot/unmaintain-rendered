<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formatter: method call chain with comment, differs from black output - astral-sh/ruff #8330</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Formatter: method call chain with comment, differs from black output</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/issues/8330">#8330</a>
        opened by <a href="https://github.com/robmoss">@robmoss</a>
        on 2023-10-29 23:23
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/robmoss">@robmoss</a></div>
            <div class="timeline-body"><p>Black 23.10.1 and Ruff 0.1.3 produced slightly different outputs for a method call chain that includes a comment, and I couldn&#x27;t find a relevant issue in the issue tracker. I&#x27;ve reduced to it to a much simpler example where both tools produce identical formatting for <code>x = ...</code> but different formatting for <code>y = ...</code> â€” black doesn&#x27;t insert a newline before the closing <code>)</code> and <code>.f()</code>.</p>
<p>It isn&#x27;t clear to me which tool is producing the &quot;best&quot; result. I find black&#x27;s decision here slightly odd, and if I add a second method call after the <code># Comment goes here: black and ruff differ</code> line, black <strong>does</strong> insert a newline before <code>.f()</code>. So perhaps I should file this is an issue with black?</p>
<pre><code>x = (
    very_long_function_name_with_many_arguments(100, 200, 300, 400, 500, 600, 700, 800, 900, 1000).f().g()
    # Comment goes here: no difference
    .h()
)

y = (
    very_long_function_name_with_many_arguments(100, 200, 300, 400, 500, 600, 700, 800, 900, 1000).f()
    # Comment goes here: black and ruff differ
    .h()
)
</code></pre>
Black output
<pre><code>x = (
    very_long_function_name_with_many_arguments(
        100, 200, 300, 400, 500, 600, 700, 800, 900, 1000
    )
    .f()
    .g()
    # Comment goes here: no difference
    .h()
)

y = (
    very_long_function_name_with_many_arguments(
        100, 200, 300, 400, 500, 600, 700, 800, 900, 1000
    ).f()
    # Comment goes here: black and ruff differ
    .h()
)
</code></pre>
Ruff output
<pre><code>x = (
    very_long_function_name_with_many_arguments(
        100, 200, 300, 400, 500, 600, 700, 800, 900, 1000
    )
    .f()
    .g()
    # Comment goes here: no difference
    .h()
)

y = (
    very_long_function_name_with_many_arguments(
        100, 200, 300, 400, 500, 600, 700, 800, 900, 1000
    )
    .f()
    # Comment goes here: black and ruff differ
    .h()
)
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">formatter</span> added by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-10-30 00:16</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone &quot;Formatter: Stable&quot; by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-10-30 00:16</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-10-30 00:17</div>
            <div class="timeline-body"><p>Interesting, thank&#x27;s for reporting.</p>
<p>To me, ruff&#x27;s formatting seems more consistent and produces fewer changes when inserting/removing <code>.g()</code> (a method call) from the call chain, which is what both Black and Ruff optimize for.</p>
<p>I&#x27;m not quite sure why black avoids inserting the newline when omitting <code>g</code>, and it could be a bug on their side. But it&#x27;s also likely that there is reason for the deviation that just isn&#x27;t obvious from this example.  It might be worth filing an issue on their side.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/robmoss">@robmoss</a> on 2023-11-15 22:29</div>
            <div class="timeline-body"><p>There have been quite a few similar issues filed with Black recently, and they&#x27;ve all been given the label <code>T:bug</code>. So I think it&#x27;s fair to say that ruff&#x27;s formatting isn&#x27;t an issue here.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/robmoss">@robmoss</a> on 2023-11-15 22:29</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-11-15 23:17</div>
            <div class="timeline-body"><p>@robmoss - Thanks for following up!</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 18:48:44 UTC
    </footer>
</body>
</html>
