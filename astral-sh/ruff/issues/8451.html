<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Implement flake8-async rules - astral-sh/ruff #8451</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Implement flake8-async rules</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/ruff/issues/8451">#8451</a>
        opened by <a href="https://github.com/charliermarsh">@charliermarsh</a>
        on 2023-11-03 00:55
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-11-03 00:55</div>
            <div class="timeline-body"><h2>General Rules</h2>
<ul>
<li>[x] <code>ASYNC100</code>: <code>A with trio.fail_after(...): or with trio.move_on_after(...): context does not contain any await statements. This makes it pointless, as the timeout can only be triggered by a checkpoint.</code></li>
<li>[ ] <code>ASYNC101</code>: <code>yield inside a nursery or cancel scope is only safe when implementing a context manager - otherwise, it breaks exception handling.</code></li>
<li>[ ] <code>ASYNC102</code>: <code>It's unsafe to await inside finally: or except BaseException/trio.Cancelled unless you use a shielded cancel scope with a timeout.</code></li>
<li>[ ] <code>ASYNC103</code>: <code>except BaseException, except trio.Cancelled or a bare except: with a code path that doesn't re-raise. If you don't want to re-raise BaseException, add a separate handler for trio.Cancelled before.</code></li>
<li>[ ] <code>ASYNC104</code>: <code>Cancelled and BaseException must be re-raised - when a user tries to return or raise a different exception.</code></li>
<li>[x] <code>ASYNC105</code>: <code>Calling a trio async function without immediately awaiting it.</code></li>
<li>[ ] <code>ASYNC106</code>: <code>trio must be imported with import trio for the linter to work.</code></li>
<li>[x] <code>ASYNC109</code>: <code>Async function definition with a timeout parameter - use trio.[fail/move_on]_[after/at] instead</code></li>
<li>[x] <code>ASYNC110</code>: <code>while &lt;condition&gt;: await trio.sleep() should be replaced by a trio.Event.</code></li>
<li>[ ] <code>ASYNC111</code>: <code>Variable, from context manager opened inside nursery, passed to start[_soon] might be invalidly accessed while in use, due to context manager closing before the nursery. This is usually a bug, and nurseries should generally be the inner-most context manager.</code></li>
<li>[ ] <code>ASYNC112</code>: <code>Nursery body with only a call to nursery.start[_soon] and not passing itself as a parameter can be replaced with a regular function call.</code></li>
<li>[ ] <code>ASYNC113</code>: <code>Using nursery.start_soon in __aenter__ doesn't wait for the task to begin. Consider replacing with nursery.start.</code></li>
<li>[ ] <code>ASYNC114</code>: <code>Startable function (i.e. has a task_status keyword parameter) not in --startable-in-context-manager parameter list, please add it so TRIO113 can catch errors when using it.</code></li>
<li>[x] <code>ASYNC115</code>: <code>Replace trio.sleep(0) with the more suggestive trio.lowlevel.checkpoint().</code></li>
<li>[x] <code>ASYNC116</code>: <code>trio.sleep() with &gt;24 hour interval should usually be trio.sleep_forever().</code></li>
<li>[ ] <code>ASYNC118</code>: <code>Don't assign the value of anyio.get_cancelled_exc_class() to a variable, since that breaks linter checks and multi-backend programs.</code></li>
<li>[ ] <code>ASYNC119</code>: yield in context manager in async generator is unsafe, the cleanup may be delayed until await is no longer allowed. We strongly encourage you to read <a href="https://peps.python.org/pep-0533/">PEP 533</a> and use <a href="https://docs.python.org/3/library/contextlib.html#contextlib.aclosing">async with aclosing(â€¦)</a>, or better yet avoid async generators entirely (see <a href="https://flake8-async.readthedocs.io/en/latest/rules.html#async900">ASYNC900</a> ) in favor of context managers which return an iterable <a href="https://flake8-async.readthedocs.io/en/latest/glossary.html#channel-stream-queue">channel/stream/queue</a>.</li>
<li>[ ] <code>ASYNC120</code>: Dangerous <a href="https://flake8-async.readthedocs.io/en/latest/glossary.html#checkpoint">Checkpoint</a> inside an except block. If this checkpoint is cancelled, the current active exception will be replaced by the Cancelled exception, and cannot be reraised later. This will not trigger when <a href="https://flake8-async.readthedocs.io/en/latest/rules.html#async102">ASYNC102</a> does, and if you donâ€™t care about losing non-cancelled exceptions you could disable this rule. This is currently not able to detect asyncio shields.</li>
</ul>
<h2>Blocking sync calls in async functions</h2>
<ul>
<li>[ ] <code>ASYNC200</code>: <code>User-configured error for blocking sync calls in async functions. Does nothing by default, see trio200-blocking-calls for how to configure it.</code></li>
<li>[x] <code>ASYNC210</code>: <code>Sync HTTP call in async function, use httpx.AsyncClient.</code></li>
<li>[ ] <code>ASYNC211</code>: <code>Likely sync HTTP call in async function, use httpx.AsyncClient. Looks for urllib3 method calls on pool objects, but only matching on the method signature and not the object.</code></li>
<li>[x] <code>ASYNC212</code>: <code>Blocking sync HTTP call on httpx object, use httpx.AsyncClient.</code></li>
<li>[x] <code>ASYNC220</code>: <code>Sync process call in async function, use await nursery.start(trio.run_process, ...).</code></li>
<li>[x] <code>ASYNC221</code>: <code>Sync process call in async function, use await trio.run_process(...).</code></li>
<li>[x] <code>ASYNC222</code>: <code>Sync os.* call in async function, wrap in await trio.to_thread.run_sync().</code></li>
<li>[x] <code>ASYNC230</code>: <code>Sync IO call in async function, use trio.open_file(...).</code></li>
<li>[ ] <code>ASYNC231</code>: <code>Sync IO call in async function, use trio.wrap_file(...).</code></li>
<li>[ ] <code>ASYNC232</code>: <code>Blocking sync call on file object, wrap the file object in trio.wrap_file() to get an async file object.</code></li>
<li>[ ] <code>ASYNC240</code>: <code>Avoid using os.path in async functions, prefer using trio.Path objects.</code></li>
<li>[ ] <code>ASYNC250</code>: Builtin <a href="https://docs.python.org/3/library/functions.html#input">input()</a> should not be called from async function. Wrap in <a href="https://trio.readthedocs.io/en/latest/reference-core.html#trio.to_thread.run_sync">trio.to_thread.run_sync()</a>/<a href="https://anyio.readthedocs.io/en/latest/api.html#anyio.to_thread.run_sync">anyio.to_thread.run_sync()</a> or <a href="https://docs.python.org/3/library/asyncio-eventloop.html#asyncio.loop.run_in_executor">asyncio.loop.run_in_executor()</a>.</li>
<li>[x] <code>ASYNC251</code>: <a href="https://docs.python.org/3/library/time.html#time.sleep">time.sleep()</a> should not be called from async function. Use <a href="https://trio.readthedocs.io/en/latest/reference-core.html#trio.sleep">trio.sleep()</a>/<a href="https://anyio.readthedocs.io/en/latest/api.html#anyio.sleep">anyio.sleep()</a>/<a href="https://docs.python.org/3/library/asyncio-task.html#asyncio.sleep">asyncio.sleep()</a>.</li>
</ul>
<h2>Asyncio-specific rules</h2>
<ul>
<li>[ ] <code>ASYNC300</code>: Calling <a href="https://docs.python.org/3/library/asyncio-task.html#asyncio.create_task">asyncio.create_task()</a> without saving the result. A task that isnâ€™t referenced elsewhere may get garbage collected at any time, even before itâ€™s done. Note that this rule wonâ€™t check whether the variable the result is saved in is susceptible to being garbage-collected itself. See the asyncio documentation for best practices. You might consider instead using a <a href="https://flake8-async.readthedocs.io/en/latest/glossary.html#taskgroup-nursery">TaskGroup</a> and calling <a href="https://docs.python.org/3/library/asyncio-task.html#asyncio.TaskGroup.create_task">asyncio.TaskGroup.create_task()</a> to avoid this problem, and gain the advantages of structured concurrency with e.g. better cancellation semantics.</li>
</ul>
<h2>Optional rules disabled by default</h2>
<ul>
<li>[ ] <code>ASYNC900</code>: <code>Async generator without @asynccontextmanager not allowed.</code></li>
<li>[ ] <code>ASYNC910</code>: <code>Exit or return from async function with no guaranteed checkpoint or exception since function definition.</code></li>
<li>[ ] <code>ASYNC911</code>: <code>Exit, yield or return from async iterable with no guaranteed checkpoint since possible function entry (yield or function definition) Checkpoints are await, async for, and async with (on one of enter/exit).</code></li>
<li>[ ] <code>ASYNC912</code>: A timeout/cancelscope has <a href="https://flake8-async.readthedocs.io/en/latest/glossary.html#checkpoint">checkpoints</a>, but theyâ€™re not guaranteed to run. Similar to <a href="https://flake8-async.readthedocs.io/en/latest/rules.html#async100">ASYNC100</a>, but it does not warn on trivial cases where there is no checkpoint at all. It instead shares logic with <a href="https://flake8-async.readthedocs.io/en/latest/rules.html#async910">ASYNC910</a> and <a href="https://flake8-async.readthedocs.io/en/latest/rules.html#async911">ASYNC911</a> for parsing conditionals and branches.</li>
<li>[ ] <code>ASYNC913</code>: An indefinite loop (e.g. while True) has no guaranteed <a href="https://flake8-async.readthedocs.io/en/latest/glossary.html#checkpoint">checkpoint</a>. This could potentially cause a deadlock.</li>
</ul>
<h2>Resources</h2>
<ul>
<li><a href="https://flake8-async.readthedocs.io/en/latest/rules.html">flake8-async Rules</a></li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/8439.html">astral-sh/ruff#8439</a> on 2023-11-03 00:57</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">plugin</span> added by @charliermarsh on 2023-11-03 01:19</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/8468.html">astral-sh/ruff#8468</a> on 2023-11-03 12:49</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/8486.html">astral-sh/ruff#8486</a> on 2023-11-04 12:32</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/qdegraaf">@qdegraaf</a> on 2023-11-04 14:17</div>
            <div class="timeline-body"><p><code>TRIO118</code> sounds like it is not needed in Ruff, similar to <code>TRIO106</code></p>
<p>The <code>TRIO2XX</code> rules are partially covered by the port of <a href="https://github.com/astral-sh/ruff/tree/75c9be099f878c381c8734ecd7c1217c44d2b612/crates/ruff_linter/src/rules/flake8_async/rules">flake8_async</a>.</p>
<p>The recommended fixes in <code>flake8-trio</code> are TRIO specific though. How do we want to combine those two?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/8490.html">astral-sh/ruff#8490</a> on 2023-11-04 16:33</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/8534.html">astral-sh/ruff#8534</a> on 2023-11-07 06:59</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/8537.html">astral-sh/ruff#8537</a> on 2023-11-07 12:23</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/8578.html">astral-sh/ruff#8578</a> on 2023-11-09 09:23</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/jakkdl">@jakkdl</a> on 2023-11-10 16:00</div>
            <div class="timeline-body"><p>whoa, this is super cool!! As the primary author of flake8-trio I'm super honored to be included in ruff :heart:
Feel free to ping me about any questions of functionality or implementation details
@Zac-HD might also have opinions or suggestions about stuff</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/jakkdl">@jakkdl</a> on 2023-11-10 16:05</div>
            <div class="timeline-body"><blockquote>
<p>The recommended fixes in <code>flake8-trio</code> are TRIO specific though. How do we want to combine those two?</p>
</blockquote>
<p>There's some <code>anyio</code> support as well in flake8-trio and for a while we considered renaming the library. If <code>flake8-trio</code> sees <code>import anyio</code> and no <code>import trio</code> in the code, or <a href="https://github.com/Zac-HD/flake8-trio#--anyio">--anyio</a> is passed it will suggest autofixes from the anyio library instead of trio.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/jakkdl">@jakkdl</a> on 2023-11-10 16:37</div>
            <div class="timeline-body"><blockquote>
<p>TRIO118 sounds like it is not needed in Ruff, similar to TRIO106</p>
</blockquote>
<p>TRIO106 definitely isn't needed by itself, and solely a consequence of implementation at the time. TRIO118 is only partially a weakness in implementation, the part about multi-backend programs still holds though.</p>
<blockquote>
<p>The TRIO2XX rules are partially covered by the port of <a href="https://github.com/astral-sh/ruff/tree/75c9be099f878c381c8734ecd7c1217c44d2b612/crates/ruff_linter/src/rules/flake8_async/rules">flake8_async</a>.</p>
</blockquote>
<p>Yeah there's overlap there, though I gave the implementation in flake8-trio quite a bit more love and the suggestions/error messages are more detailed/specific since it can know what the backend is.</p>
<p>TRIO105 is mostly redundant as of the recently released trio 0.23 which included types into the main package, and type checkers will complain about async functions not being awaited. I suppose it could be useful for somebody not using type-checking, but enabling this check, but I think that's a pretty slim proportion and the rule requires constantly keeping up with the API of anyio/trio.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Zac-HD">@Zac-HD</a> on 2023-11-12 23:05</div>
            <div class="timeline-body"><p>ðŸ¥³ I'm delighted to see this going into <code>ruff</code>!</p>
<p><code>TRIO105</code> doesn't seem redundant to me - many people aren't using type annotations (everywhere), and typecheckers also don't offer autofixers the way that <code>ruff</code> can.  Those fixers would mostly be unsafe, but still remarkably useful IMO!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-11-12 23:08</div>
            <div class="timeline-body"><p>Thank you both so much for chiming in here, for all the helpful commentary, and for all your work on flake8-trio (among so much else)!</p>
<p>I already gated one rule behind &quot;require an <code>import trio</code> to be present before firing&quot; so we now have some precedent and infrastructure for that, which will likely be helpful with a few of the other rules and their associated fixes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/alex007sirois">@alex007sirois</a> on 2023-11-21 21:34</div>
            <div class="timeline-body"><blockquote>
<p>I already gated one rule behind &quot;require an import trio to be present before firing&quot;</p>
</blockquote>
<p>Most of the rules for trio would apply for anyio too:</p>
<blockquote>
<blockquote>
<p>The recommended fixes in <code>flake8-trio</code> are TRIO specific though. How do we want to combine those two?</p>
</blockquote>
<p>There's some <code>anyio</code> support as well in flake8-trio and for a while we considered renaming the library. If <code>flake8-trio</code> sees <code>import anyio</code> and no <code>import trio</code> in the code, or <a href="https://github.com/Zac-HD/flake8-trio#--anyio">--anyio</a> is passed it will suggest autofixes from the anyio library instead of trio.</p>
</blockquote>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/jakkdl">@jakkdl</a> on 2024-04-12 13:50</div>
            <div class="timeline-body"><p>This issue should be renamed and all the rules in the checklist renamed to match upstream merging with flake8-async. See #10303</p>
<p>Also TRIO117 is removed (because <code>trio.MultiError</code> is removed), and there's two new rules ASYNC250 and ASYNC251</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/11498.html">astral-sh/ruff#11498</a> on 2024-05-22 20:49</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/10416.html">astral-sh/ruff#10416</a> on 2024-06-25 21:22</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "Implement flake8-trio rules" to "Implement flake8-async rules" by @MichaReiser on 2024-06-26 07:51</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-06-26 07:59</div>
            <div class="timeline-body"><p>I updated the issue to reflect the <code>flake8-trio</code> to <code>flake8-async</code> rename, crossed of the new rules implemented in #10416, and added new rules to the list to match <code>flake8-async</code>'s documentation</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/12873.html">astral-sh/ruff#12873</a> on 2024-08-14 01:25</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Zac-HD">@Zac-HD</a> on 2024-08-15 03:02</div>
            <div class="timeline-body"><p>Hey all - I just tried moving some code from <code>flake8-async</code> to <code>ruff check</code> for that delicious massive speedup, and ended up back on this issue ðŸ™‚</p>
<p>The good news: https://github.com/astral-sh/ruff/pull/10416 also implemented <code>ASYNC251</code>!</p>
<p>The sad-for-me news: lots of other rules still to implement.  If you feel inspired but not <em>so</em> inspired as to finish closing out this issue, <code>ASYNC900</code> and <code>ASYNC200</code> seem pretty simple to implement, and would be <em>really</em> nice to have...</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/13341.html">astral-sh/ruff#13341</a> on 2024-09-12 23:38</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Zac-HD">@Zac-HD</a> on 2024-09-18 22:42</div>
            <div class="timeline-body"><p>Prompted by a conversation elsewhere: if <code>ruff</code> starts to handle cross-file analyses, you could avoid <code>ASYNC114</code> entirely (ie check whether there's a <code>task_status=</code> argument instead of configuring a list) which would be quite nice ðŸ™‚</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-09-19 18:49</div>
            <div class="timeline-body"><p>Also prompted by a conversation elsewhere: I'd love to see implementations for <code>ASYNC900</code>, <code>ASYNC910</code>, and <code>ASYNC911</code> in particular.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/jakkdl">@jakkdl</a> on 2024-10-22 14:05</div>
            <div class="timeline-body"><p>New rules in upstream https://flake8-async.readthedocs.io/en/latest/rules.html#async121</p>
<ul>
<li><code>ASYNC121</code> control-flow-in-taskgroup</li>
<li><code>ASYNC122</code> delayed-entry-of-relative-cancelscope</li>
<li><code>ASYNC123</code> bad-exception-group-flattening<ul>
<li>this one isn't specific to async, and affects anybody trying to extract and reraise an exception contained inside an exception group. Upstream implementation is fairly crude</li>
</ul>
</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/19619.html">astral-sh/ruff#19619</a> on 2025-08-04 20:19</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/20091.html">astral-sh/ruff#20091</a> on 2025-08-26 00:18</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/20122.html">astral-sh/ruff#20122</a> on 2025-08-28 00:20</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/20264.html">astral-sh/ruff#20264</a> on 2025-09-05 10:08</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/PieterCK">@PieterCK</a> on 2025-09-05 10:33</div>
            <div class="timeline-body"><p>Hello folks! Not, sure if this is the best place to ask for reviews, but I've opened #20264 for <code>ASYNC240</code>. I'd appreciate it if someone could drop a quick review ðŸ™‚</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 01:30:10 UTC
    </footer>
</body>
</html>
