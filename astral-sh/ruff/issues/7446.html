<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PERF403 potential false positive - astral-sh/ruff #7446</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>PERF403 potential false positive</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/issues/7446">#7446</a>
        opened by <a href="https://github.com/LefterisJP">@LefterisJP</a>
        on 2023-09-16 20:32
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/LefterisJP">@LefterisJP</a></div>
            <div class="timeline-body"><p>I enabled <code>--preview</code> with version <code>0.0.290</code> and got an interesting hit for <code>PERF403</code>.</p>
<p>Code looks kind of like this:</p>
<pre><code class="language-python">mapping = {}

animals = ['dog', 'cat', 'bird', 'elephant']
other_mapping = {'snake': 69, 'owl': 42}

for idx, animal in enumerate(animals):
    if animal == 'elephant':
        continue
    mapping[animal] = idx

for animal, idx in other_mapping.items():
    mapping[animal] = idx

print(mapping)
</code></pre>
<p>And this will hit <code>PERF403</code> asking to use dict comprehension where we do</p>
<pre><code class="language-python">for animal, idx in other_mapping.items():
    mapping[animal] = idx
</code></pre>
<p>The only dict comprehension I can imagine is</p>
<pre><code class="language-python">mapping = {animal: idx for animal, idx in other_mapping.items()}
</code></pre>
<p>Which will not do what we want.</p>
<p>Using</p>
<pre><code class="language-python">mapping.update(other_mapping)
</code></pre>
<p>Will work instead. But then in this case isn't the <code>PERF403</code> hit here a false positive?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-09-16 20:50</div>
            <div class="timeline-body"><p>I think the rule generally wants you to do <code>mapping.update({animal: idx for animal, idx in other_mapping.items()})</code> here. We should probably have a separate rule that detects that <code>{animal: idx for animal, idx in other_mapping.items()}</code> is an unnecessary comprehension though, and then further corrects to <code>mapping.update(other_mapping)</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-09-16 20:57</div>
            <div class="timeline-body"><p>It looks like C416 will further correct that to:</p>
<pre><code class="language-python">mapping.update(dict(other_mapping.items()))
</code></pre>
<p>Which is close...</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-09-19 03:18</div>
            <div class="timeline-body"><p>Closing for now as I think <code>mapping.update</code> is the intended solution.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2023-09-19 03:18</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 16:48:23 UTC
    </footer>
</body>
</html>
