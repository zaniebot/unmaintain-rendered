<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RET504 breaks code when value is used in finally - astral-sh/ruff #17292</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>RET504 breaks code when value is used in finally</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/ruff/issues/17292">#17292</a>
        opened by <a href="https://github.com/wikti">@wikti</a>
        on 2025-04-08 10:28
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/wikti">@wikti</a> on 2025-04-08 10:28</div>
            <div class="timeline-body"><h3>Summary</h3>
<p>Had problem with rule RET504. Autofix broke code.</p>
<pre><code>def log_out():
    out = &quot;&quot;
    try:
        out = foo()
        return out
    except Exception as e:
        out = str(e)
    finally:
        log(out)
</code></pre>
<p>Fix made <code>return foo()</code>, which broke <code>log(out)</code>.</p>
<p>Tested on version <code>0.11.4</code>.</p>
<p>Thanks for great project.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @dylwil3 on 2025-04-08 10:58</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">fixes</span> added by @dylwil3 on 2025-04-08 10:58</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> removed by @dylwil3 on 2025-04-08 11:12</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dylwil3">@dylwil3</a> on 2025-04-08 11:19</div>
            <div class="timeline-body"><p>Good catch! I was going to suggest that we make the fix unsafe if we detect this lint in a <code>try</code> block or in an <code>except</code> block for a try statement that also has a <code>finally</code> clause (e.g. by modifying the <a href="https://github.com/astral-sh/ruff/blob/b662c3ff7ea7ccf9bb8bd4d0814a20c082c7c244/crates/ruff_linter/src/rules/flake8_return/visitor.rs#L40"><code>ReturnVisitor</code></a> to collect this information). But it turns out the fix is <em>always</em> marked as unsafe, it's just not documented (an instance of #15584).</p>
<p>So I think first of all we should document the fix safety.</p>
<p>But then I'm a bit conflicted about resolving it further. We could:</p>
<ol>
<li>Offer the lint but not the fix if we are in this situation described above</li>
<li>Try to do a finer analysis where we check for uses of the binding in later blocks</li>
<li>Do nothing aside from adding documentation</li>
<li>Something else</li>
</ol>
<p>(1) has the downside that there may be lots of situations with a <code>try</code> statement where the fix does not break the code, and where now no quick fix is offered. (2) stretches the limit of Ruff's current control flow abilities (hopefully not for long #17065
), and may lead to further bugs or edge cases. (3) perhaps feels unsatisfying.</p>
<p>Let's get the documentation sorted and I'll leave this here for further discussion.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">documentation</span> added by @dylwil3 on 2025-04-08 11:19</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-04-08 11:25</div>
            <div class="timeline-body"><p>I think this is simply a false positive because the assignment isn't unnecessary. One possibility is to make the rule a deferred rule and use the semantic model to verify that the return is the only read. Another alternative is to extend the <code>ReturnsVisitor</code> to possibly track the symbols used inside of <code>except</code> or <code>finally</code> blocks.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @dylwil3 on 2025-04-08 11:42</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dylwil3">@dylwil3</a> on 2025-04-08 11:54</div>
            <div class="timeline-body"><p>You're right, I got mixed up thinking about handling the general situation of safely spotting <code>RET504</code> in try statements: of course here there should be no lint at all.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">documentation</span> removed by @dhruvmanila on 2025-04-14 14:07</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/joaoe">@joaoe</a> on 2025-05-23 08:43</div>
            <div class="timeline-body"><p>+1 I was just about to report this.</p>
<p>My case</p>
<pre><code>def execute_something()
    result, err, start = (), None, time.monotonic()
    try:
        logging.info(&quot;Starting...&quot;)
        result = do_some_long_operation()
        return result ## &lt;- RET504 HERE
    except Exception as e:
        err = repr(e)
        raise
    finally:
        end = time.monotonic()
        logging.log(logging.ERROR if err else logging.INFO, &quot;Result %s, elapsed %.3f secs&quot;, err if err else f&quot;{len(result)} rows&quot;, end - start)
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/mxmlnkn">@mxmlnkn</a> on 2025-07-05 15:57</div>
            <div class="timeline-body"><p>I have a encountered this problem in <a href="https://github.com/fusepy/fusepy/blob/5d997d6706cc0204e1b3ca679651485a7e7dda49/fuse.py#L1251">fusepy</a>.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 01:30:17 UTC
    </footer>
</body>
</html>
