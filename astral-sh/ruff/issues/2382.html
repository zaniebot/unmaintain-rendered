<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Union is upgraded to &quot;|&quot; pipe character even though target version is Python 3.9 - astral-sh/ruff #2382</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Union is upgraded to &quot;|&quot; pipe character even though target version is Python 3.9</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/issues/2382">#2382</a>
        opened by <a href="https://github.com/KelSolaar">@KelSolaar</a>
        on 2023-01-31 07:51
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/KelSolaar">@KelSolaar</a></div>
            <div class="timeline-body"><!--
Thank you for taking the time to report an issue! We're glad to have you involved with Ruff.

If you're filing a bug report, please consider including the following information:

- A minimal code snippet that reproduces the bug.
- The command you invoked (e.g., `ruff /path/to/file.py --fix`), ideally including the `--isolated` flag.
- The current Ruff settings (any relevant sections from your `pyproject.toml`).
- The current Ruff version (`ruff --version`).
-->

<p>Hi,</p>
<p>This only happens when <code>from __future__ import annotations</code> is used:</p>
<p>Given <code>target-version = &quot;py39&quot;</code> and the following snippet:</p>
<pre><code class="language-python">from __future__ import annotations

from typing import Literal, Union


def foo(bar: Union[Literal[&quot;John&quot;, &quot;Wayne&quot;], str] = &quot;John&quot;):
    ...
</code></pre>
<p>The snippet is upgraded:</p>
<pre><code class="language-python">from __future__ import annotations

from typing import Literal


def foo(bar: Literal[&quot;John&quot;, &quot;Wayne&quot;] | str = &quot;John&quot;):
    ...
</code></pre>
<ul>
<li>Ruff 0.0.237</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/burgholzer">@burgholzer</a> on 2023-01-31 08:14</div>
            <div class="timeline-body"><p>Could it be that you copied the same snippet twice by accident?</p>
<p>The rewrite is perfectly valid for Python 3.7+ whenever <code>from __future__ import annotations</code> is present due to postponed evaluation of annotations (see https://peps.python.org/pep-0563/).</p>
<p>See also the original <code>pyupgrade</code> implementation: https://github.com/asottile/pyupgrade/blob/97ed6fb3cf2e650d4f762ba231c3f04c41797710/pyupgrade/_plugins/typing_pep604.py#L118-L126</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/tmke8">@tmke8</a> on 2023-01-31 10:51</div>
            <div class="timeline-body"><p>You can turn this behavior off with</p>
<pre><code class="language-toml">[tool.ruff.pyupgrade]
# Preserve types, even if a file imports `from __future__ import annotations`.
keep-runtime-typing = true
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">question</span> added by @charliermarsh on 2023-01-31 12:30</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/KelSolaar">@KelSolaar</a> on 2023-01-31 17:57</div>
            <div class="timeline-body"><blockquote>
<p>Could it be that you copied the same snippet twice by accident?</p>
</blockquote>
<p>Yes! Copy-paste fail, just fixed.</p>
<blockquote>
<p>See also the original pyupgrade implementation: https://github.com/asottile/pyupgrade/blob/97ed6fb3cf2e650d4f762ba231c3f04c41797710/pyupgrade/_plugins/typing_pep604.py#L118-L126</p>
</blockquote>
<p>So this is interesting because I'm using <code>pyupgrade</code> and it does not update them which is why I was surprised that they were in the first place. Looking <code>pyupgrade</code>, <code>keep_runtime_typing</code> attribute is off by default: https://github.com/asottile/pyupgrade/blob/97ed6fb3cf2e650d4f762ba231c3f04c41797710/pyupgrade/_data.py#L31 which evaluates to <code>True</code> in the code that uses it, i.e. <code>not state.settings.keep_runtime_typing</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-01-31 20:16</div>
            <div class="timeline-body"><p>@KelSolaar - Just trying to keep up -- does this seem to be working as intended, or na?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/KelSolaar">@KelSolaar</a> on 2023-01-31 20:17</div>
            <div class="timeline-body"><p>Sorry, yes it does perfectly, the default behaviour is different compared to <code>pyupgrade</code>, unsure if it needs to be the same or documented or both.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-01-31 21:22</div>
            <div class="timeline-body"><p>I think the default behavior is maybe the same? If I run <code>pyupgrade foo.py --py39</code> over that code, it does upgrade it. I have to run <code>pyupgrade foo.py --py39 --keep-runtime-typing</code> to avoid the upgrade.</p>
<p>With Ruff, if I run <code>ruff --fix</code> over that file with <code>target-version = &quot;py39&quot;</code>, it also fixes it. If I add this to my <code>pyproject.toml</code>, it doesn't:</p>
<pre><code class="language-toml">[tool.ruff.pyupgrade]
keep-runtime-typing = true
</code></pre>
<p>So I think in either case, you have to enable that setting? But maybe I'm just misunderstanding :) Going to close for now though!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2023-01-31 21:22</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/KelSolaar">@KelSolaar</a> on 2023-02-01 06:24</div>
            <div class="timeline-body"><p>Thanks, maybe it is a default when used with the precommit hooks but we never specified this parameter and it never upgraded for us. It does not really matter anyway as we will be using Ruff from now on! :D</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 16:46:18 UTC
    </footer>
</body>
</html>
