<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[Linter panic] SIM105 with cpython\Lib\http\server.py - astral-sh/ruff #4374</title>
    <link rel="stylesheet" href="../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../index.html">Back to index</a>
    </div>

    <h1>[Linter panic] SIM105 with cpython\Lib\http\server.py</h1>

    <div class="meta">
        <span class="state state-closed">Closed</span>
        <a href="https://github.com/astral-sh/ruff/issues/4374">#4374</a>
        opened by <a href="https://github.com/FishAlchemist">@FishAlchemist</a>
        on 2023-05-11 13:19
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/FishAlchemist">@FishAlchemist</a> on 2023-05-11 13:19</div>
            <div class="timeline-body"><h2>Ruff Version</h2>
<p>https://github.com/charliermarsh/ruff/tree/be6e00ef6e5efea68a8a1a0093611b26142b753d</p>
<h2>Command(Powershell)</h2>
<pre><code class="language-powershell"> cargo run -p ruff_cli -- check --select=ALL --no-cache --fix --isolated .\server.py
</code></pre>
<h2>Terminal Content</h2>
<pre><code class="language-powershell">warning: `one-blank-line-before-class` (D203) and `no-blank-line-before-class` (D211) are incompatible. Ignoring `one-blank-line-before-class`.
warning: `multi-line-summary-first-line` (D212) and `multi-line-summary-second-line` (D213) are incompatible. Ignoring `multi-line-summary-second-line`.
warning: Linting panicked server.py: This indicates a bug in `ruff`. If you could open an issue at:

https://github.com/charliermarsh/ruff/issues/new?title=%5BLinter%20panic%5D

with the relevant file contents, the `pyproject.toml` settings, and the following stack trace, we'd be very appreciative!

panicked at 'assertion failed: start.raw &lt;= end.raw', C:\Users\fish\.cargo\git\checkouts\parser-aad50aa3362d3a85\2af9805\ruff_text_size\src\range.rs:48:9
Backtrace:    0: std::backtrace_rs::backtrace::dbghelp::trace
             at /rustc/84c898d65adf2f39a5a98507f1fe0ce10a2b8dbc/library\std\src\..\..\backtrace\src\backtrace\dbghelp.rs:98
   1: std::backtrace_rs::backtrace::trace_unsynchronized
             at /rustc/84c898d65adf2f39a5a98507f1fe0ce10a2b8dbc/library\std\src\..\..\backtrace\src\backtrace\mod.rs:66
   2: std::backtrace::Backtrace::create
             at /rustc/84c898d65adf2f39a5a98507f1fe0ce10a2b8dbc/library\std\src\backtrace.rs:332
   3: std::backtrace::Backtrace::force_capture
             at /rustc/84c898d65adf2f39a5a98507f1fe0ce10a2b8dbc/library\std\src\backtrace.rs:314
   4: ruff_cli::panic::catch_unwind::closure$0&lt;ruff_cli::commands::run::lint_path::closure_env$0,enum2$&lt;core::result::Result&lt;ruff_cli::diagnostics::Diagnostics,anyhow::Error&gt; &gt; &gt;
             at C:\Users\fish\source\ruff\crates\ruff_cli\src\panic.rs:31
   5: alloc::boxed::impl$47::call
             at /rustc/84c898d65adf2f39a5a98507f1fe0ce10a2b8dbc/library\alloc\src\boxed.rs:2001
   6: std::panicking::rust_panic_with_hook
             at /rustc/84c898d65adf2f39a5a98507f1fe0ce10a2b8dbc/library\std\src\panicking.rs:696
   7: std::panicking::begin_panic_handler::closure$0
             at /rustc/84c898d65adf2f39a5a98507f1fe0ce10a2b8dbc/library\std\src\panicking.rs:581
   8: std::sys_common::backtrace::__rust_end_short_backtrace&lt;std::panicking::begin_panic_handler::closure_env$0,never$&gt;
             at /rustc/84c898d65adf2f39a5a98507f1fe0ce10a2b8dbc/library\std\src\sys_common\backtrace.rs:150
   9: std::panicking::begin_panic_handler
             at /rustc/84c898d65adf2f39a5a98507f1fe0ce10a2b8dbc/library\std\src\panicking.rs:579
  10: core::panicking::panic_fmt
             at /rustc/84c898d65adf2f39a5a98507f1fe0ce10a2b8dbc/library\core\src\panicking.rs:64
  11: core::panicking::panic
             at /rustc/84c898d65adf2f39a5a98507f1fe0ce10a2b8dbc/library\core\src\panicking.rs:114
  12: ruff_text_size::range::TextRange::new
             at C:\Users\fish\.cargo\git\checkouts\parser-aad50aa3362d3a85\2af9805\ruff_text_size\src\range.rs:48
  13: ruff::autofix::apply_fixes&lt;core::iter::adapters::peekable::Peekable&lt;core::iter::adapters::filter::Filter&lt;core::slice::iter::Iter&lt;ruff_diagnostics::diagnostic::Diagnostic&gt;,ruff::autofix::fix_file::closure_env$0&gt; &gt; &gt;
             at C:\Users\fish\source\ruff\crates\ruff\src\autofix\mod.rs:66
  14: ruff::autofix::fix_file
             at C:\Users\fish\source\ruff\crates\ruff\src\autofix\mod.rs:25
  15: ruff::linter::lint_fix
             at C:\Users\fish\source\ruff\crates\ruff\src\linter.rs:456
  16: ruff_cli::diagnostics::lint_path
             at C:\Users\fish\source\ruff\crates\ruff_cli\src\diagnostics.rs:155
  17: ruff_cli::commands::run::lint_path::closure$0
             at C:\Users\fish\source\ruff\crates\ruff_cli\src\commands\run.rs:164
  18: std::panicking::try::do_call&lt;ruff_cli::commands::run::lint_path::closure_env$0,enum2$&lt;core::result::Result&lt;ruff_cli::diagnostics::Diagnostics,anyhow::Error&gt; &gt; &gt;
             at /rustc/84c898d65adf2f39a5a98507f1fe0ce10a2b8dbc\library\std\src\panicking.rs:487
  19: std::panicking::try::do_catch&lt;core::panic::unwind_safe::AssertUnwindSafe&lt;rayon_core::job::impl$9::call::closure_env$0&lt;tuple$&lt;usize,usize&gt;,rayon_core::registry::impl$6::in_worker_cold::closure$0::closure_env$0&lt;rayon_core::join::join_context::closure_env$0&lt;
  20: std::panicking::try&lt;enum2$&lt;core::result::Result&lt;ruff_cli::diagnostics::Diagnostics,anyhow::Error&gt; &gt;,ruff_cli::commands::run::lint_path::closure_env$0&gt;
             at /rustc/84c898d65adf2f39a5a98507f1fe0ce10a2b8dbc\library\std\src\panicking.rs:451
  21: std::panic::catch_unwind&lt;ruff_cli::commands::run::lint_path::closure_env$0,enum2$&lt;core::result::Result&lt;ruff_cli::diagnostics::Diagnostics,anyhow::Error&gt; &gt; &gt;
             at /rustc/84c898d65adf2f39a5a98507f1fe0ce10a2b8dbc\library\std\src\panic.rs:140
  22: ruff_cli::panic::catch_unwind&lt;ruff_cli::commands::run::lint_path::closure_env$0,enum2$&lt;core::result::Result&lt;ruff_cli::diagnostics::Diagnostics,anyhow::Error&gt; &gt; &gt;
             at C:\Users\fish\source\ruff\crates\ruff_cli\src\panic.rs:40
  23: ruff_cli::commands::run::lint_path
             at C:\Users\fish\source\ruff\crates\ruff_cli\src\commands\run.rs:163
  24: ruff_cli::commands::run::run::closure$0
             at C:\Users\fish\source\ruff\crates\ruff_cli\src\commands\run.rs:91
  25: core::ops::function::impls::impl$1::call_mut&lt;tuple$&lt;ref$&lt;enum2$&lt;core::result::Result&lt;ignore::walk::DirEntry,enum2$&lt;ignore::Error&gt; &gt; &gt; &gt; &gt;,ruff_cli::commands::run::run::closure_env$0&gt;
             at /rustc/84c898d65adf2f39a5a98507f1fe0ce10a2b8dbc\library\core\src\ops\function.rs:274
  26: core::iter::adapters::map::map_fold::closure$0&lt;ref$&lt;enum2$&lt;core::result::Result&lt;ignore::walk::DirEntry,enum2$&lt;ignore::Error&gt; &gt; &gt; &gt;,ruff_cli::diagnostics::Diagnostics,ruff_cli::diagnostics::Diagnostics,ref$&lt;ruff_cli::commands::run::run::closure_env$0&gt;,ref$
             at /rustc/84c898d65adf2f39a5a98507f1fe0ce10a2b8dbc\library\core\src\iter\adapters\map.rs:84
  27: core::iter::traits::iterator::Iterator::fold&lt;core::slice::iter::Iter&lt;enum2$&lt;core::result::Result&lt;ignore::walk::DirEntry,enum2$&lt;ignore::Error&gt; &gt; &gt; &gt;,ruff_cli::diagnostics::Diagnostics,core::iter::adapters::map::map_fold::closure_env$0&lt;ref$&lt;enum2$&lt;core::res
             at /rustc/84c898d65adf2f39a5a98507f1fe0ce10a2b8dbc\library\core\src\iter\traits\iterator.rs:2477
  28: core::iter::adapters::map::impl$2::fold&lt;ruff_cli::diagnostics::Diagnostics,core::slice::iter::Iter&lt;enum2$&lt;core::result::Result&lt;ignore::walk::DirEntry,enum2$&lt;ignore::Error&gt; &gt; &gt; &gt;,ref$&lt;ruff_cli::commands::run::run::closure_env$0&gt;,ruff_cli::diagnostics::Diag
             at /rustc/84c898d65adf2f39a5a98507f1fe0ce10a2b8dbc\library\core\src\iter\adapters\map.rs:124
  29: rayon::iter::reduce::impl$5::consume_iter&lt;ruff_cli::commands::run::run::closure_env$1,ruff_cli::diagnostics::Diagnostics,core::iter::adapters::map::Map&lt;core::slice::iter::Iter&lt;enum2$&lt;core::result::Result&lt;ignore::walk::DirEntry,enum2$&lt;ignore::Error&gt; &gt; &gt; &gt;,
             at C:\Users\fish\.cargo\registry\src\github.com-1ecc6299db9ec823\rayon-1.7.0\src\iter\reduce.rs:105
  30: rayon::iter::map::impl$8::consume_iter&lt;ref$&lt;enum2$&lt;core::result::Result&lt;ignore::walk::DirEntry,enum2$&lt;ignore::Error&gt; &gt; &gt; &gt;,ruff_cli::diagnostics::Diagnostics,rayon::iter::reduce::ReduceFolder&lt;ruff_cli::commands::run::run::closure_env$1,ruff_cli::diagnosti
             at C:\Users\fish\.cargo\registry\src\github.com-1ecc6299db9ec823\rayon-1.7.0\src\iter\map.rs:248
  31: rayon::iter::plumbing::Producer::fold_with&lt;rayon::slice::IterProducer&lt;enum2$&lt;core::result::Result&lt;ignore::walk::DirEntry,enum2$&lt;ignore::Error&gt; &gt; &gt; &gt;,rayon::iter::map::MapFolder&lt;rayon::iter::reduce::ReduceFolder&lt;ruff_cli::commands::run::run::closure_env$1,
             at C:\Users\fish\.cargo\registry\src\github.com-1ecc6299db9ec823\rayon-1.7.0\src\iter\plumbing\mod.rs:110
  32: rayon::iter::plumbing::bridge_producer_consumer::helper&lt;rayon::slice::IterProducer&lt;enum2$&lt;core::result::Result&lt;ignore::walk::DirEntry,enum2$&lt;ignore::Error&gt; &gt; &gt; &gt;,rayon::iter::map::MapConsumer&lt;rayon::iter::reduce::ReduceConsumer&lt;ruff_cli::commands::run::ru
             at C:\Users\fish\.cargo\registry\src\github.com-1ecc6299db9ec823\rayon-1.7.0\src\iter\plumbing\mod.rs:438
  33: rayon::iter::plumbing::bridge_producer_consumer&lt;rayon::slice::IterProducer&lt;enum2$&lt;core::result::Result&lt;ignore::walk::DirEntry,enum2$&lt;ignore::Error&gt; &gt; &gt; &gt;,rayon::iter::map::MapConsumer&lt;rayon::iter::reduce::ReduceConsumer&lt;ruff_cli::commands::run::run::closu
             at C:\Users\fish\.cargo\registry\src\github.com-1ecc6299db9ec823\rayon-1.7.0\src\iter\plumbing\mod.rs:397
  34: rayon::iter::plumbing::bridge::impl$0::callback&lt;rayon::iter::map::MapConsumer&lt;rayon::iter::reduce::ReduceConsumer&lt;ruff_cli::commands::run::run::closure_env$1,ruff_cli::diagnostics::Diagnostics (*)()&gt;,ruff_cli::commands::run::run::closure_env$0&gt;,ref$&lt;enum2
             at C:\Users\fish\.cargo\registry\src\github.com-1ecc6299db9ec823\rayon-1.7.0\src\iter\plumbing\mod.rs:373
  35: rayon::slice::impl$6::with_producer&lt;enum2$&lt;core::result::Result&lt;ignore::walk::DirEntry,enum2$&lt;ignore::Error&gt; &gt; &gt;,rayon::iter::plumbing::bridge::Callback&lt;rayon::iter::map::MapConsumer&lt;rayon::iter::reduce::ReduceConsumer&lt;ruff_cli::commands::run::run::closur
             at C:\Users\fish\.cargo\registry\src\github.com-1ecc6299db9ec823\rayon-1.7.0\src\slice\mod.rs:732
  36: rayon::iter::plumbing::bridge&lt;rayon::slice::Iter&lt;enum2$&lt;core::result::Result&lt;ignore::walk::DirEntry,enum2$&lt;ignore::Error&gt; &gt; &gt; &gt;,rayon::iter::map::MapConsumer&lt;rayon::iter::reduce::ReduceConsumer&lt;ruff_cli::commands::run::run::closure_env$1,ruff_cli::diagnos
             at C:\Users\fish\.cargo\registry\src\github.com-1ecc6299db9ec823\rayon-1.7.0\src\iter\plumbing\mod.rs:357
  37: rayon::slice::impl$5::drive_unindexed&lt;enum2$&lt;core::result::Result&lt;ignore::walk::DirEntry,enum2$&lt;ignore::Error&gt; &gt; &gt;,rayon::iter::map::MapConsumer&lt;rayon::iter::reduce::ReduceConsumer&lt;ruff_cli::commands::run::run::closure_env$1,ruff_cli::diagnostics::Diagnos
             at C:\Users\fish\.cargo\registry\src\github.com-1ecc6299db9ec823\rayon-1.7.0\src\slice\mod.rs:708
  38: rayon::iter::map::impl$2::drive_unindexed&lt;rayon::slice::Iter&lt;enum2$&lt;core::result::Result&lt;ignore::walk::DirEntry,enum2$&lt;ignore::Error&gt; &gt; &gt; &gt;,ruff_cli::commands::run::run::closure_env$0,ruff_cli::diagnostics::Diagnostics,rayon::iter::reduce::ReduceConsumer&lt;
             at C:\Users\fish\.cargo\registry\src\github.com-1ecc6299db9ec823\rayon-1.7.0\src\iter\map.rs:49
  39: rayon::iter::reduce::reduce&lt;rayon::iter::map::Map&lt;rayon::slice::Iter&lt;enum2$&lt;core::result::Result&lt;ignore::walk::DirEntry,enum2$&lt;ignore::Error&gt; &gt; &gt; &gt;,ruff_cli::commands::run::run::closure_env$0&gt;,ruff_cli::commands::run::run::closure_env$1,ruff_cli::diagnost
             at C:\Users\fish\.cargo\registry\src\github.com-1ecc6299db9ec823\rayon-1.7.0\src\iter\reduce.rs:15
  40: rayon::iter::ParallelIterator::reduce&lt;rayon::iter::map::Map&lt;rayon::slice::Iter&lt;enum2$&lt;core::result::Result&lt;ignore::walk::DirEntry,enum2$&lt;ignore::Error&gt; &gt; &gt; &gt;,ruff_cli::commands::run::run::closure_env$0&gt;,ruff_cli::commands::run::run::closure_env$1,ruff_cli
             at C:\Users\fish\.cargo\registry\src\github.com-1ecc6299db9ec823\rayon-1.7.0\src\iter\mod.rs:991
  41: ruff_cli::commands::run::run
             at C:\Users\fish\source\ruff\crates\ruff_cli\src\commands\run.rs:79
  42: ruff_cli::check
             at C:\Users\fish\source\ruff\crates\ruff_cli\src\lib.rs:300
  43: ruff_cli::run
             at C:\Users\fish\source\ruff\crates\ruff_cli\src\lib.rs:119
  44: ruff::main
             at C:\Users\fish\source\ruff\crates\ruff_cli\src\bin\ruff.rs:48
  45: core::ops::function::FnOnce::call_once&lt;std::process::ExitCode (*)(),tuple$&lt;&gt; &gt;
             at /rustc/84c898d65adf2f39a5a98507f1fe0ce10a2b8dbc\library\core\src\ops\function.rs:250
  46: std::sys_common::backtrace::__rust_begin_short_backtrace&lt;std::process::ExitCode (*)(),std::process::ExitCode&gt;
             at /rustc/84c898d65adf2f39a5a98507f1fe0ce10a2b8dbc\library\std\src\sys_common\backtrace.rs:134
  47: std::rt::lang_start::closure$0&lt;std::process::ExitCode&gt;
             at /rustc/84c898d65adf2f39a5a98507f1fe0ce10a2b8dbc\library\std\src\rt.rs:166
  48: core::ops::function::impls::impl$2::call_once
             at /rustc/84c898d65adf2f39a5a98507f1fe0ce10a2b8dbc/library\core\src\ops\function.rs:287
  49: std::panicking::try::do_call
             at /rustc/84c898d65adf2f39a5a98507f1fe0ce10a2b8dbc/library\std\src\panicking.rs:487
  50: std::panicking::try
             at /rustc/84c898d65adf2f39a5a98507f1fe0ce10a2b8dbc/library\std\src\panicking.rs:451
  51: std::panic::catch_unwind
             at /rustc/84c898d65adf2f39a5a98507f1fe0ce10a2b8dbc/library\std\src\panic.rs:140
  52: std::rt::lang_start_internal::closure$2
             at /rustc/84c898d65adf2f39a5a98507f1fe0ce10a2b8dbc/library\std\src\rt.rs:148
  53: std::panicking::try::do_call
             at /rustc/84c898d65adf2f39a5a98507f1fe0ce10a2b8dbc/library\std\src\panicking.rs:487
  54: std::panicking::try
             at /rustc/84c898d65adf2f39a5a98507f1fe0ce10a2b8dbc/library\std\src\panicking.rs:451
  55: std::panic::catch_unwind
             at /rustc/84c898d65adf2f39a5a98507f1fe0ce10a2b8dbc/library\std\src\panic.rs:140
  56: std::rt::lang_start_internal
             at /rustc/84c898d65adf2f39a5a98507f1fe0ce10a2b8dbc/library\std\src\rt.rs:148
  57: std::rt::lang_start&lt;std::process::ExitCode&gt;
             at /rustc/84c898d65adf2f39a5a98507f1fe0ce10a2b8dbc\library\std\src\rt.rs:165
  58: main
  59: invoke_main
             at D:\a\_work\1\s\src\vctools\crt\vcstartup\src\startup\exe_common.inl:78
  60: __scrt_common_main_seh
             at D:\a\_work\1\s\src\vctools\crt\vcstartup\src\startup\exe_common.inl:288
  61: BaseThreadInitThunk
  62: RtlUserThreadStart
</code></pre>
<h2>Python File</h2>
<p>Source https://github.com/python/cpython/tree/167072938342981b96d06d739cd97185207b64dd
<strong>Please change the file extension from txt to py</strong>
<a href="https://github.com/charliermarsh/ruff/files/11452592/server.txt">server.txt</a></p>
<h2>Ruff settings</h2>
<p>Nothing</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @charliermarsh on 2023-05-11 15:53</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @charliermarsh by @charliermarsh on 2023-05-11 15:53</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2023-05-11 15:53</div>
            <div class="timeline-body"><p>The failing autofix is SIM105 &quot;Use <code>contextlib.suppress(OSError)</code> instead of <code>try</code>-<code>except</code>-<code>pass</code>&quot;.</p>
<p>Command:</p>
<pre><code>ruff check --select=SIM105 --no-cache --fix --isolated code.py
</code></pre>
<p>Minimized example:</p>
<pre><code class="language-python">def a():
    try:
        pass
    except OSError:
        pass


import contextlib
</code></pre>
<p>The problem occurs because the autofix can't deal with the import being behind the function scope</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "[Linter panic] cpython\Lib\http\server.py" to "[Linter panic] SIM105 with cpython\Lib\http\server.py" by @konstin on 2023-05-11 15:53</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-05-11 15:54</div>
            <div class="timeline-body"><p>I thought we had fixed this? I'll take a look.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-05-11 15:56</div>
            <div class="timeline-body"><p>Unless you're already on it @konstin :)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2023-05-11 15:59</div>
            <div class="timeline-body"><p>no i just wanted to write up the minimization, please continue on this</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-05-11 16:44</div>
            <div class="timeline-body"><p>I think #4373 is the same issue.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-05-11 16:46</div>
            <div class="timeline-body"><p>Ah okay, I see. The issue is that we use the import from the surrounding scope, but we allow that to come <em>after</em> right now.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/4373.html">astral-sh/ruff#4373</a> on 2023-05-11 17:03</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/4378.html">astral-sh/ruff#4378</a> on 2023-05-11 17:59</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2023-05-11 18:47</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:28:09 UTC
    </footer>
</body>
</html>
