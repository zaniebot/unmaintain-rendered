<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RET505 doesn't work with mixed space and tabs - astral-sh/ruff #12707</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>RET505 doesn't work with mixed space and tabs</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/issues/12707">#12707</a>
        opened by <a href="https://github.com/qarmin">@qarmin</a>
        on 2024-08-06 05:04
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/qarmin">@qarmin</a> on 2024-08-06 05:04</div>
            <div class="timeline-body"><p>ruff 0.5.6+419 (0b4d3ce39 2024-08-05)</p>
<pre><code>ruff check *.py --select RET505 --no-cache --fix --preview --output-format concise --isolated
</code></pre>
<p>file content(at the bottom should be attached raw, not formatted file - github removes some non-printable characters, so copying from here may not work):</p>
<pre><code>def f():
	if true:
	 return true
	else:
	 return false
</code></pre>
<p>error</p>
<pre><code>python_data:4:2: RET505 Unnecessary `else` after `return` statement
Found 1 error.
[*] 1 fixable with the --fix option.

error: Fix introduced a syntax error in `crash` with rule codes RET505: unindent does not match any outer indentation level at byte range 33..34
---
 return falsern true
---

</code></pre>
<p><a href="https://github.com/user-attachments/files/16505463/python_code.py.zip">python_code.py.zip</a></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @dhruvmanila on 2024-08-06 05:51</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">fixes</span> added by @dhruvmanila on 2024-08-06 05:51</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">fuzzer</span> added by @dhruvmanila on 2024-08-06 05:51</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">help wanted</span> added by @MichaReiser on 2024-08-06 06:13</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/diceroll123">@diceroll123</a> on 2024-08-06 06:36</div>
            <div class="timeline-body"><p>This <em>may</em> be an upstream issue somehow. Uncertain, and can't look too much more into this until later.</p>
<p><code>desired_indentation</code> for the <code>else</code> line is a tab, I checked by converting it to unicode -- which is <code>0x9</code>, as opposed to <code>0x20</code> for a space (32 in decimal)</p>
<p>But it seems to resolve into a space when the fix is applied, somehow.</p>
<p>Notes:</p>
<ul>
<li>I don't even see the same error, but I do still get an error (see code block below)</li>
<li>It is 2:30 in the morning so take anything I say with a grain of salt ðŸ¤£</li>
</ul>
<pre><code class="language-python">def f():
        if True:
         return True
 return False
</code></pre>
<p>As you can see, the existing tabs resolve into 8 spaces.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-08-06 06:44</div>
            <div class="timeline-body"><blockquote>
<p>This may be an upstream issue somehow. Uncertain, and can't look too much more into this until later.</p>
</blockquote>
<p>What do you mean by an upstream issue? Do you mean an issue with the fix infrastructure (or anything that isn't the rule itself?)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/diceroll123">@diceroll123</a> on 2024-08-06 06:45</div>
            <div class="timeline-body"><p>Yep! I'm hoping I'm wrong, but definitely something weird going on.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-08-06 08:10</div>
            <div class="timeline-body"><p>I haven't looked to deep but the result of <code>indented</code> looks of:</p>
<ul>
<li><code>desired_indentation = &quot;\t&quot;</code></li>
<li><code>&amp;indented = &quot; return false&quot;</code></li>
</ul>
<p>https://github.com/astral-sh/ruff/blob/83b1c48a935f17869b9ee618faadc99213f83d95/crates/ruff_linter/src/rules/flake8_return/rules/function.rs#L878-L884</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/diceroll123">@diceroll123</a> on 2024-08-07 02:51</div>
            <div class="timeline-body"><p>I've narrowed it down to the <code>ruff_python_trivia::textwrap::dedent_to</code>, invoked here https://github.com/astral-sh/ruff/blob/90e5bc2bd95e15086a3af81589cc2a1af298b6b2/crates/ruff_linter/src/fix/edits.rs#L324-L326</p>
<p>I've added these lines into that block,</p>
<pre><code class="language-rust">println!(&quot;contents: {:?}&quot;, contents);
println!(&quot;indentation: {:?}&quot;, indentation.chars().next().unwrap() as u32);
println!(&quot;dedented to: {:?}&quot;, dedent_to(contents, indentation));
</code></pre>
<p>and the output is:</p>
<pre><code>contents: &quot;\t return False&quot;
indentation: 9
dedented to: &quot; return False&quot;
</code></pre>
<p>So, the issue is upstream but not within the autofixing mechanisms, but in the <code>dedent_to</code> function.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/12740.html">astral-sh/ruff#12740</a> on 2024-08-08 06:26</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @MichaReiser on 2024-08-08 08:49</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/diceroll123">@diceroll123</a> on 2024-08-08 08:53</div>
            <div class="timeline-body"><p>Looking forward to future fuzzer issues!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/qarmin">@qarmin</a> on 2024-08-08 10:27</div>
            <div class="timeline-body"><p>Well, now I only create issues when code that cause problems that can be found in real projects.
If you want to check/fix some of not reported issues, you can check at this list(16280 broken files with info about exact rules that causes problems):</p>
<p><a href="https://github.com/user-attachments/files/16541656/a.7z.zip">a.7z.zip</a> (this is 7z file and needs to be renamed, because zip produced 30MB archive, that I couldn't attach here)</p>
<p>This files are broken with the latest ruff - <code>ruff 0.5.6+449 (6d9205e34 2024-08-08)</code></p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 01:30:14 UTC
    </footer>
</body>
</html>
