<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Unable to build ruff on aarch64 alpine docker - astral-sh/ruff #10159</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Unable to build ruff on aarch64 alpine docker</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/issues/10159">#10159</a>
        opened by <a href="https://github.com/matejsp">@matejsp</a>
        on 2024-02-29 06:03
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/matejsp">@matejsp</a></div>
            <div class="timeline-body"><p>I am getting undefined reference to `getauxval' using ruff 0.2.2 and rust 1.75.0</p>
<p>I saw mentioning this issue very often and in https://github.com/rust-lang/rust/issues/89626 there is potencial workaround:
CFLAGS=-mno-outline-atomics but I don't know if same solution applies to ruff and where to put it.</p>
<pre><code>d5eeb851975c9e9d.yansi_term.b1b943cb7c038b2f-cgu.0.rcgu.o.rcgu.o&quot; &quot;/tmp/pip-req-build-g44dfv8y/target/release/deps/ruff-40440a78eac19877.yansi_term-d5eeb851975c9e9d.yansi_term.b1b943cb7c038b2f-cgu.1.rcgu.o.rcgu.o&quot; &quot;-Wl,--as-needed&quot; &quot;-L&quot; &quot;/tmp/pip-req-build-g44dfv8y/target/release/deps&quot; &quot;-L&quot; &quot;/tmp/pip-req-build-g44dfv8y/target/release/build/tikv-jemalloc-sys-c62787d9c96f094e/out/build/lib&quot; &quot;-L&quot; &quot;/usr/local/lib/rustlib/aarch64-unknown-linux-musl/lib&quot; &quot;-Wl,-Bstatic&quot; &quot;/tmp/rustc4x3SZs/libtikv_jemalloc_sys-a7374e6d0308fde8.rlib&quot; &quot;-lunwind&quot; &quot;-lc&quot; &quot;/usr/local/lib/rustlib/aarch64-unknown-linux-musl/lib/libcompiler_builtins-38b80b5b9028b8db.rlib&quot; &quot;-Wl,-Bdynamic&quot; &quot;-Wl,--eh-frame-hdr&quot; &quot;-Wl,-z,noexecstack&quot; &quot;-nostartfiles&quot; &quot;-L&quot; &quot;/usr/local/lib/rustlib/aarch64-unknown-linux-musl/lib&quot; &quot;-L&quot; &quot;/usr/local/lib/rustlib/aarch64-unknown-linux-musl/lib/self-contained&quot; &quot;-o&quot; &quot;/tmp/pip-req-build-g44dfv8y/target/release/deps/ruff-40440a78eac19877&quot; &quot;-Wl,--gc-sections&quot; &quot;-static&quot; &quot;-no-pie&quot; &quot;-Wl,-z,relro,-z,now&quot; &quot;-Wl,-O1&quot; &quot;-nodefaultlibs&quot; &quot;-s&quot; &quot;/usr/local/lib/rustlib/aarch64-unknown-linux-musl/lib/self-contained/crtend.o&quot; &quot;/usr/local/lib/rustlib/aarch64-unknown-linux-musl/lib/self-contained/crtn.o&quot;
        = note: /usr/lib/gcc/aarch64-alpine-linux-musl/12.2.1/../../../../aarch64-alpine-linux-musl/bin/ld: /usr/local/lib/rustlib/aarch64-unknown-linux-musl/lib/libcompiler_builtins-38b80b5b9028b8db.rlib(45c91108d938afe8-cpu_model.o): in function `init_have_lse_atomics':
                /cargo/registry/src/index.crates.io-6f17d22bba15001f/compiler_builtins-0.1.103/./lib/builtins/cpu_model.c:1075: undefined reference to `getauxval'
                /usr/lib/gcc/aarch64-alpine-linux-musl/12.2.1/../../../../aarch64-alpine-linux-musl/bin/ld: /usr/local/lib/rustlib/aarch64-unknown-linux-musl/lib/libcompiler_builtins-38b80b5b9028b8db.rlib(45c91108d938afe8-cpu_model.o): in function `init_cpu_features':
                /cargo/registry/src/index.crates.io-6f17d22bba15001f/compiler_builtins-0.1.103/./lib/builtins/cpu_model.c:1373: undefined reference to `getauxval'
                /usr/lib/gcc/aarch64-alpine-linux-musl/12.2.1/../../../../aarch64-alpine-linux-musl/bin/ld: /cargo/registry/src/index.crates.io-6f17d22bba15001f/compiler_builtins-0.1.103/./lib/builtins/cpu_model.c:1374: undefined reference to `getauxval'
                collect2: error: ld returned 1 exit status
        = note: some `extern` functions couldn't be found; some native libraries may need to be installed or have their path specified
        = note: use the `-l` flag to specify native libraries to link
        = note: use the `cargo:rustc-link-lib` directive to specify the native libraries to link with Cargo (see https://doc.rust-lang.org/cargo/reference/build-scripts.html#cargorustc-link-libkindname)
      error: aborting due to previous error
      Error: command ['maturin', 'pep517', 'build-wheel', '-i', '/source/python311/bin/python3.11', '--compatibility', 'off'] returned non-zero exit status 1
      [end of output]
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">question</span> added by @MichaReiser on 2024-02-29 08:46</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-02-29 08:48</div>
            <div class="timeline-body"><p>That's interesting. It's not clear to me why you run into this. We do create musl builds in CI and that works fine, strange.</p>
<p>Could you share some more details about your setup? That would help us to reproduce the issue.
What's your docker image? What commands are you running?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/matejsp">@matejsp</a> on 2024-02-29 09:25</div>
            <div class="timeline-body"><p>I made it working by adding: export CFLAGS=-mno-outline-atomics before calling wheel</p>
<p>will try to reproduce it at home after work because our corpo firewall is messing with ssl certificate ...</p>
<pre><code>docker run -it alpine bash
apk add python3-dev py3-pip bash maturin
wget https://files.pythonhosted.org/packages/70/06/b2e9ee5f17dab59476fcb6cc6fdd268e8340d95b7dfc760ed93f4243f16f/ruff-0.2.2.tar.gz
wget --no-check-certificate https://static.rust-lang.org/dist/rust-1.75.0-$(uname -m)-unknown-linux-musl.tar.gz
tar -xzf rust-1.75.0-$(uname -m)-unknown-linux-musl.tar.gz

export CFLAGS=-mno-outline-atomics
pip install wheel --break-system-packages
pip wheel ruff-0.2.2.tar.gz
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-03-11 17:35</div>
            <div class="timeline-body"><p>@matejsp did you figure more out here / is there anything actionable for us to do?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-04-12 01:47</div>
            <div class="timeline-body"><p>Closing for now...</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2024-04-12 01:47</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 16:49:43 UTC
    </footer>
</body>
</html>
