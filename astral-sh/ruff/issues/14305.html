<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[red-knot] Asserts on invalid match pattern - astral-sh/ruff #14305</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[red-knot] Asserts on invalid match pattern</h1>

    <div class="meta">
        <span class="state state-closed">Closed</span>
        <a href="https://github.com/astral-sh/ruff/issues/14305">#14305</a>
        opened by <a href="https://github.com/sharkdp">@sharkdp</a>
        on 2024-11-13 08:08
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/sharkdp">@sharkdp</a> on 2024-11-13 08:08</div>
            <div class="timeline-body"><p>Red knot currently runs into a failing debug assertion on the following invalid match pattern:</p>
<pre><code class="language-py">match some_int:
    case x:=2:
        pass
</code></pre>
<p>The <a href="https://play.ruff.rs/cc7622ca-7608-4112-b92e-15628c397c1a">way this is parsed</a> is interesting. The first part</p>
<pre><code class="language-py">match some_int:
    case x:
</code></pre>
<p>is parsed as a <code>Match</code>. So far, so good. But then the next part (<code>=2:</code>) is parsed as an assignment statement with a type annotation (<code>AnnAssign</code>). Strangely, it contains <code>2</code> as the <em>target</em> of the assignment. And an empty <code>Name</code> for the annotation (with <code>ExprContext::Invalid</code>, which is what triggers the assertion). It's unclear to me if this could be improved in the parser, but it should definitely be fixed in red knot.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by @sharkdp on 2024-11-13 08:08</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @sharkdp by @sharkdp on 2024-11-13 08:08</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/14306.html">astral-sh/ruff#14306</a> on 2024-11-13 08:12</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-11-13 08:32</div>
            <div class="timeline-body"><p>Just for context</p>
<p>For recovery, there are two important constraints:</p>
<ol>
<li>The parser must generate a valid AST. Meaning, recovery is constraint by whatever can be represented in the AST (and adding more constraints to the AST adds more constraints to how well the parser can recover)</li>
<li>The parser should not discard any tokens, or worse,  nodes, or even entire subtrees. This can help with round-tripping to avoid accidentally deleting code. It also allows downstream tools to make some more assumptions about how the code looks (there's no surprise that the case contains a <code>=2</code> between the colon</li>
</ol>
<p>I suspect that these two constraints are the reason why the parser recovers somewhat awkwardly for this given example.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @sharkdp on 2024-11-13 09:07</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:34:54 UTC
    </footer>
</body>
</html>
