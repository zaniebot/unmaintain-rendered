<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Unexpected token '&gt;&gt;' when linting Jupyter notebook with doctest/interpreter snippet - astral-sh/ruff #9189</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Unexpected token '&gt;&gt;' when linting Jupyter notebook with doctest/interpreter snippet</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/ruff/issues/9189">#9189</a>
        opened by <a href="https://github.com/mattharrison">@mattharrison</a>
        on 2023-12-18 16:37
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/mattharrison">@mattharrison</a> on 2023-12-18 16:37</div>
            <div class="timeline-body"><p>I'm trying to lint notebooks that have interactive snippets in the cells.</p>
<p>To recreate, simple make a notebook with something like this in the cell</p>
<pre><code class="language-pycon">&gt;&gt;&gt; def function(a,b):
...    return a+b
&gt;&gt;&gt; function(1,2)
</code></pre>
<p>Ruff (v 0.1.8) fails with this error:</p>
<pre><code>% ruff foo.ipynb
error: Failed to parse foo.ipynb:cell 1:1:1: Unexpected token '&gt;&gt;'
foo.ipynb:cell 1:1:1: E999 SyntaxError: Unexpected token '&gt;&gt;'
Found 1 error.
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2023-12-18 16:51</div>
            <div class="timeline-body"><p>Can you expand on what does &quot;interactive snippets&quot; mean? Is the code snippet you've mentioned to be pasted as it is including the prompt <code>&gt;&gt;&gt;</code> and <code>...</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/mattharrison">@mattharrison</a> on 2023-12-18 16:58</div>
            <div class="timeline-body"><p>Yes, it means writing code in a doctest style. Jupyter supports this style of code and I would love to be able to format it. Here's a screenshot of my notebook, it is literally a cell with the code I pasted above.</p>
<img width="497" alt="Screen Shot 2023-12-18 at 9 56 19 AM" src="https://github.com/astral-sh/ruff/assets/119405/968837ef-abfa-41f9-9518-1d323c26c280">

</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2023-12-19 16:55</div>
            <div class="timeline-body"><p>TIL, thanks for providing the context. Can you further expand on your use-case for this? I might be misunderstanding you or missing some context but wouldn't using the interactive cells of the notebook itself be better instead? So, what I mean is the following:</p>
<img width="478" alt="Screenshot 2023-12-19 at 10 54 35" src="https://github.com/astral-sh/ruff/assets/67177269/b69b9464-e416-4fe9-970c-bcebb4d81c8b">

</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/mattharrison">@mattharrison</a> on 2023-12-19 20:43</div>
            <div class="timeline-body"><p>My use case is I write books in Jupyter and want to format the code. As to
why I use interpreter snippets? So the reader can distinguish between code
and output. (And so I can test the code in my book.)</p>
<p>On Tue, Dec 19, 2023, 9:55 AM Dhruv Manilawala <em><strong>@</strong></em>.***&gt;
wrote:</p>
<blockquote>
<p>TIL, thanks for providing the context. Can you further expand on your
use-case for this? I might be misunderstanding you or missing some context
but wouldn't using the interactive cells of the notebook itself be better
instead? So, what I mean is the following:
Screenshot.2023-12-19.at.10.54.35.png (view on web)
<a href="https://github.com/astral-sh/ruff/assets/67177269/b69b9464-e416-4fe9-970c-bcebb4d81c8b">https://github.com/astral-sh/ruff/assets/67177269/b69b9464-e416-4fe9-970c-bcebb4d81c8b</a></p>
<p>—
Reply to this email directly, view it on GitHub
<a href="https://github.com/astral-sh/ruff/issues/9189#issuecomment-1863136231">https://github.com/astral-sh/ruff/issues/9189#issuecomment-1863136231</a>,
or unsubscribe
<a href="https://github.com/notifications/unsubscribe-auth/AAA5E3K2DTEOAAATAQMPW4TYKHBIFAVCNFSM6AAAAABAZZ3QSKVHI2DSMVQWIX3LMV43OSLTON2WKQ3PNVWWK3TUHMYTQNRTGEZTMMRTGE">https://github.com/notifications/unsubscribe-auth/AAA5E3K2DTEOAAATAQMPW4TYKHBIFAVCNFSM6AAAAABAZZ3QSKVHI2DSMVQWIX3LMV43OSLTON2WKQ3PNVWWK3TUHMYTQNRTGEZTMMRTGE</a>
.
You are receiving this because you authored the thread.Message ID:
<em><strong>@</strong></em>.***&gt;</p>
</blockquote>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2023-12-20 00:01</div>
            <div class="timeline-body"><p>Thanks for providing this information! I think it can be compared to the way Python's official tutorials are written (for example https://docs.python.org/3/tutorial/controlflow.html#if-statements) where the text would be a markdown block while the code snippets would be a code block.</p>
<p>As for the implementation side, maybe we could utilize some parts of the new docstring formatter to get the code part from the interactive snippets (cc @BurntSushi). We could check if the first line begins with the <code>&gt;&gt;&gt;</code> prompt and use an intermediary step to extract the code parts. I can look into it sometime next year (after my Christmas / New Year break) ;)</p>
<p>And, this would work for both the linter and the formatter once implemented.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">linter</span> added by @dhruvmanila on 2023-12-20 00:02</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">formatter</span> added by @dhruvmanila on 2023-12-20 00:02</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">notebook</span> added by @dhruvmanila on 2024-02-06 12:23</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/SergejsKims">@SergejsKims</a> on 2024-05-28 10:50</div>
            <div class="timeline-body"><p>I have similar behavior with Databricks Notebooks. In Databricks it is normal to define <code>%pip install ...</code>, but in this case Ruff fails with <code>Unexpected token '%'</code>, At least, would be good to Skip such line.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-05-28 11:59</div>
            <div class="timeline-body"><p>What's the difference between a Databricks Notebook and a Jupyter Notebook? Do they have different file extension? If it's <code>.ipynb</code>, then Ruff does support parsing those magic commands (<code>%pip install ...</code>).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/SergejsKims">@SergejsKims</a> on 2024-05-28 13:24</div>
            <div class="timeline-body"><p>Databricks Notebook has &quot;*.py&quot; extension.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-06-03 11:26</div>
            <div class="timeline-body"><p>Ruff uses the file extension to determine the expected syntax. If it's a <code>.py</code> file, it'll expect a Python source code and similarly, if it's <code>.ipynb</code> it expects a JSON encoded Notebook source. I'm not sure why does it uses <code>.py</code> extension because any Python parser would fail to parse such files.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/bthorsted">@bthorsted</a> on 2025-04-23 10:35</div>
            <div class="timeline-body"><p>@dhruvmanila Databricks use <code>.py</code> because the contents are not JSON encoded, but rather plain text python code with some magic comments to escape features like <code>%pip install</code> and to mark cell boundaries.</p>
<p>I assume they made that design choice to make it more git-friendly while still having the benefits of a notebook-style interface.</p>
<p>The magic comments are parsed and rendered by the databricks web interface, so the user won't see that cells are defined by a header-style magic comment: <code># COMMAND ----------</code>.
Lines beginning with <code>%</code> in the web editor will be stored as <code># MAGIC %</code> in the raw <code>.py</code> file.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2025-04-23 15:28</div>
            <div class="timeline-body"><p>Thanks for the context!</p>
<blockquote>
<p>Lines beginning with <code>%</code> in the web editor will be stored as <code># MAGIC %</code> in the raw <code>.py</code> file.</p>
</blockquote>
<p>If this is the case, then it shouldn't create an issue with Ruff as it's just a Python comment. As such, this is different than what the author of this issue is facing.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 11:32:15 UTC
    </footer>
</body>
</html>
