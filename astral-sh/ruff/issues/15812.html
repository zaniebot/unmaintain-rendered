<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>`F401` false positive with `TypeAliasType` and forward annotation - astral-sh/ruff #15812</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>`F401` false positive with `TypeAliasType` and forward annotation</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/issues/15812">#15812</a>
        opened by <a href="https://github.com/Viicos">@Viicos</a>
        on 2025-01-29 16:14
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/Viicos">@Viicos</a> on 2025-01-29 16:14</div>
            <div class="timeline-body"><h3>Description</h3>
<p>search keywords: F401 Typealiastype</p>
<pre><code class="language-python">from typing import Union

from typing_extensions import TypeAliasType


Json = TypeAliasType(
    'Json',
    'Union[dict[str, Json], list[Json], str, int, float, bool, None]',
)
</code></pre>
<pre><code class="language-sh">repro4.py:1:20: F401 [*] `typing.Union` imported but unused
  |
1 | from typing import Union
  |                    ^^^^^ F401
2 |
3 | from typing import TypeAliasType
  |
  = help: Remove unused import: `typing.Union`

</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntBre">@ntBre</a> on 2025-01-29 16:59</div>
            <div class="timeline-body"><p>I'm not a typing expert, but I think this is a true positive. From my understanding, one reason for using forward annotations in general is to avoid imports. Another fix in this case would be to update the second argument to <code>TypeAliasType</code> to unquote the <code>Union</code> and restrict the quotes to the <code>Json</code> parts:</p>
<pre><code class="language-python">from typing import Union

from typing_extensions import TypeAliasType


Json = TypeAliasType(
    'Json',
    Union[dict[str, 'Json'], list['Json'], str, int, float, bool, None],
)
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">question</span> added by @ntBre on 2025-01-29 16:59</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Viicos">@Viicos</a> on 2025-01-29 17:11</div>
            <div class="timeline-body"><blockquote>
<p>forward annotations in general is to avoid imports</p>
</blockquote>
<p>Indeed, but also in this case to avoid <code>NameError</code>s for forward references.</p>
<blockquote>
<p>Another fix in this case would be to update the second argument to <code>TypeAliasType</code> to unquote the <code>Union</code> and restrict the quotes to the <code>Json</code> parts:</p>
</blockquote>
<p>While this indeed works, I tend to avoid quoting parts of the annotation, as it doesn't play well with runtime tools. For instance, up until 3.10, a bug is present in <code>typing.get_type_hints()</code>:</p>
<pre><code class="language-python">Test = int

class T:
    t: list['Test']

get_type_hints(T)
#&gt; {'t': list['Test']}  not evaluted!
</code></pre>
<p>Other issues happened with the deprecated typing aliases (now out of scope because 3.8 is EOL), as for instance <code>List['Forward']</code> is implicitly <code>List[ForwardRef('Forward')]</code> at runtime, and this caused nasty issues in Pydantic.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntBre">@ntBre</a> on 2025-01-29 17:27</div>
            <div class="timeline-body"><p>Ah okay, thanks for the additional context! I might let someone else (maybe @AlexWaygood) weigh in on whether this is the intended behavior then.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-01-29 19:34</div>
            <div class="timeline-body"><p>hmm, we probably need to visit the second argument to <code>TypeAliasType</code> as a type expression rather than a value expression, similar to what we do with the <code>bound=</code> and <code>default=</code> keyword arguments to the <code>TypeVar</code> constructor (see <a href="https://github.com/astral-sh/ruff/blob/15d886a50213dcd4013db028eeef15a60d182f98/crates/ruff_linter/src/checkers/ast/mod.rs#L1348-L1354">https://github.com/astral-sh/ruff/blob/15d886a50213dcd4013db028eeef15a60d182f98/crates/ruff_linter/src/checkers/ast/mod.rs#L1348-L1354</a>). If we do so, I think we'll probably correctly identify that this should be interpreted as a quoted forward reference rather than just any string being passed to a call expression.</p>
<p>@ntBre would you like to take a look? Shouldn't be too hard I don't think, and might be a good way to learn a little more about Ruff's semantic model :-)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntBre">@ntBre</a> on 2025-01-29 19:38</div>
            <div class="timeline-body"><p>Sure, happy to take a look!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @ntBre by @ntBre on 2025-01-29 21:11</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/15829.html">astral-sh/ruff#15829</a> on 2025-01-30 15:17</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">question</span> removed by @AlexWaygood on 2025-01-30 15:23</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @AlexWaygood on 2025-01-30 15:23</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @ntBre on 2025-01-30 23:06</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @ntBre on 2025-01-30 23:06</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/15860.html">astral-sh/ruff#15860</a> on 2025-01-31 22:16</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 01:30:16 UTC
    </footer>
</body>
</html>
