<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Investigate slow formatting - astral-sh/ruff #6016</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Investigate slow formatting</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/issues/6016">#6016</a>
        opened by <a href="https://github.com/konstin">@konstin</a>
        on 2023-07-23 13:06
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/konstin">@konstin</a> on 2023-07-23 13:06</div>
            <div class="timeline-body"><p>Some files are much slower to format than others, i've posted the top 20 below (for context: i can format 294k files in 290s on my 8 threads laptop, so roughly an average of 8ms per file, the real median is likely a good bit lower). The exact timings and order are inaccurate since we they come from the ecosystem check which runs in parallel, but no files should be that slow, especially since the files aren't that large. We need to format these files with a profiler attached (see CONTRIBUTING.md for instructions), find the bottleneck and optimize the relevant function.</p>
<pre><code>$ cat target/formatter-ecosystem-errors.txt | grep &quot;Slow formatting&quot; | sd &quot;Slow formatting .*/checkouts/(.*): Formatting the file took (.*)&quot; '$2 $1' | sort -h -r | head -n 20
2157ms angr:angr/angr/procedures/definitions/win32_fwpuclnt.py
1430ms angr:angr/angr/procedures/definitions/win32_rpcrt4.py
1052ms kevoreilly:CAPEv2/tests/utils_pretty_print_funcs_data.py
965ms angr:angr/angr/procedures/definitions/win32_propsys.py
614ms angr:angr/angr/procedures/definitions/win32_dnsapi.py
553ms angr:angr/angr/procedures/definitions/win32_crypt32.py
531ms angr:angr/angr/procedures/definitions/win32_kernel32.py
491ms sympy:sympy/sympy/physics/quantum/tests/test_spin.py
446ms debian-calibre:calibre/src/calibre/ebooks/unihandecode/jacodepoints.py
435ms debian-calibre:calibre/src/calibre/ebooks/unihandecode/zhcodepoints.py
435ms debian-calibre:calibre/src/calibre/ebooks/unihandecode/krcodepoints.py
431ms pwndbg:pwndbg/pwndbg/lib/functions.py
378ms angr:angr/angr/procedures/definitions/win32_icu.py
368ms angr:angr/angr/procedures/definitions/win32_oleaut32.py
365ms angr:angr/angr/procedures/definitions/win32_wldap32.py
353ms angr:angr/angr/procedures/definitions/win32_advapi32.py
339ms kovidgoyal:calibre/src/calibre/ebooks/unihandecode/vncodepoints.py
335ms kovidgoyal:calibre/src/calibre/ebooks/unihandecode/jacodepoints.py
324ms angr:angr/angr/procedures/definitions/win32_user32.py
322ms kovidgoyal:calibre/src/calibre/ebooks/unihandecode/krcodepoints.py
</code></pre>
<p>| Path                                                                          | Source file size   | Formatted file size  |
|-------------------------------------------------------------------------------|-------------------:|---------------------:|
| <code>angr:angr/angr/procedures/definitions/win32_fwpuclnt.py</code>                     | 			    4.1M |                  35M |
| <code>angr:angr/angr/procedures/definitions/win32_rpcrt4.py</code>                       | 	            2.0M |                 8.5M |
| <code>kevoreilly:CAPEv2/tests/utils_pretty_print_funcs_data.py</code>                    |               8.9M |                 11M  |
| <code>angr:angr/angr/procedures/definitions/win32_propsys.py</code>                      |               1.2M |                 5.4M |
| <code>angr:angr/angr/procedures/definitions/win32_dnsapi.py</code> 	                    |              833KB |                 3.2M |
| <code>angr:angr/angr/procedures/definitions/win32_crypt32.py</code> 	                    |               794K |                 4.0M |
| <code>angr:angr/angr/procedures/definitions/win32_kernel32.py</code> 	                |               727K |                 1.3M |
| <code>sympy:sympy/sympy/physics/quantum/tests/test_spin.py</code> 	                    |               337K |                 453K |
| <code>debian-calibre:calibre/src/calibre/ebooks/unihandecode/jacodepoints.py</code> 	    |               397K |                1010K |
| <code>debian-calibre:calibre/src/calibre/ebooks/unihandecode/zhcodepoints.py</code>      |               397K |                1010K |
| <code>debian-calibre:calibre/src/calibre/ebooks/unihandecode/krcodepoints.py</code>      |               397K |                1010K |
| <code>pwndbg:pwndbg/pwndbg/lib/functions.py</code>                                       |               ???? |                 ???? |
| <code>angr:angr/angr/procedures/definitions/win32_icu.py</code>                          |               641K |                 1.5M |
| <code>angr:angr/angr/procedures/definitions/win32_oleaut32.py</code>                     |               566K |                 2.2M |
| <code>angr:angr/angr/procedures/definitions/win32_wldap32.py</code>                      |               496K |                 1.1M |
| <code>angr:angr/angr/procedures/definitions/win32_advapi32.py</code>                     |               556K |                 1.2M |
| <code>kovidgoyal:calibre/src/calibre/ebooks/unihandecode/vncodepoints.py</code>          |               397K |                1010K |
| <code>kovidgoyal:calibre/src/calibre/ebooks/unihandecode/jacodepoints.py</code>          |               397K |                1010K |
| <code>angr:angr/angr/procedures/definitions/win32_user32.py</code>                       |               397K |                 726K |
| <code>kovidgoyal:calibre/src/calibre/ebooks/unihandecode/krcodepoints.py</code>          |               397K |                1010K |</p>
<pre><code></code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">performance</span> added by @konstin on 2023-07-23 13:06</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">formatter</span> added by @konstin on 2023-07-23 13:06</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-07-25 17:38</div>
            <div class="timeline-body"><p>We may need to take the line count after formatting. <code>angr:angr/angr/procedures/definitions/win32_fwpuclnt.py</code> has 334'645 after formatting... 35% of the time is spent inside the parser (after lexer refactor), another 30% is spent inside printing (yeah, printing 35mb takes a while). <a href="https://share.firefox.dev/3rEWUYN">Profile</a></p>
<p>The same is probably true for most other files in the <code>angr</code> repository (<code>win32_rpcrt4</code> has 129'402 lines after formatting) but also seems true for other files (<code>utils_pretty_print_funcs_data</code> has 216'887 after formatting). It is probably still worth to investigate file by file to make sure there are no <em>real</em> slow files.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2023-07-25 20:27</div>
            <div class="timeline-body"><p>good point, do you want to edit the OP with counts or should i change the script to sort differently? we could also use a file size filter  or a millisecond per kilobyte formatted score.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-07-28 17:51</div>
            <div class="timeline-body"><blockquote>
<p>good point, do you want to edit the OP with counts or should i change the script to sort differently? we could also use a file size filter or a millisecond per kilobyte formatted score.</p>
</blockquote>
<p>Sorry for the late reply. I think including the file size would be a good metric. Ideally, we would use the file size after formatting because it makes the file easier to compare. But that's probably somewhat hard.</p>
<p>Edit: I started updating a few</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-07-29 07:43</div>
            <div class="timeline-body"><p>I updated the table with the original and formatted file size. I'm not too concerned about the many MB files. But we may want to take a look why some of the &lt;= 4MB file take so long to format.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone "Formatter: Beta" by @MichaReiser on 2023-07-31 16:25</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/6203.html">astral-sh/ruff#6203</a> on 2023-07-31 17:25</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Removed from milestone "Formatter: Beta" by @MichaReiser on 2023-08-22 14:34</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-09-08 08:04</div>
            <div class="timeline-body"><p>@konstin I remember that you changed the diffing algorithm. Do you know if this is still a problem or if we can close the issue?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2023-09-08 08:18</div>
            <div class="timeline-body"><p>Let's close this. A pass over the slowest files would be nice but not pressing given the current performance on the test projects</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @konstin on 2023-09-08 08:18</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 01:30:08 UTC
    </footer>
</body>
</html>
