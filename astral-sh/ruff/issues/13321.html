<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>find_ruff_bin does not work as a build dependency with pip - astral-sh/ruff #13321</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>find_ruff_bin does not work as a build dependency with pip</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/issues/13321">#13321</a>
        opened by <a href="https://github.com/gaborbernat">@gaborbernat</a>
        on 2024-09-10 23:33
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/gaborbernat">@gaborbernat</a></div>
            <div class="timeline-body"><p>See reproducible at https://github.com/gaborbernat/ruff-find-bin-during-pip-build/actions/runs/10802198412/job/29963805989</p>
<p>With code https://github.com/gaborbernat/ruff-find-bin-during-pip-build/commit/fd532e8eff45ce7c416d0563a52871ed7a0208e7</p>
<p>In this case, the host Python is the installer Python, but the expectation is to find it in the pip isolated environment</p>
<p>cc @pradyunsg I am not sure if this is a pip bug or a uv bug... but the binary gets discovered correctly when installing with uv, but discovers in host Python when using pip.</p>
<p>cc @charliermarsh I believe this is also a bug for uv itself for find_uv_bin...</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-09-11 20:47</div>
            <div class="timeline-body"><p>This doesn&#x27;t seem like a Ruff bug? It looks like pip isn&#x27;t installing the build requirement (<code>ruff</code>) before calling the hook. In uv, we install the build requirement into the isolated build environment. I&#x27;m not sure what pip is doing here or if it&#x27;s intentional. I also tried enabling PEP 517 with the same result:</p>
<p>https://github.com/zanieb/ruff-find-bin-during-pip-build/commit/2cd719e36be250a82b9b670f63f585b89aceaccb
https://github.com/zanieb/ruff-find-bin-during-pip-build/actions/runs/10819384824/job/30017135074</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">question</span> added by <a href="https://github.com/zanieb">@zanieb</a> on 2024-09-11 20:47</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/gaborbernat">@gaborbernat</a> on 2024-09-11 22:02</div>
            <div class="timeline-body"><p>I do not believe what you say is correct. If you check the logs, you can see that Pip actually is installing the package:</p>
<blockquote>
<p>Processing /home/runner/work/ruff-find-bin-during-pip-build/ruff-find-bin-during-pip-build
Installing build dependencies: started
Installing build dependencies: finished with status &#x27;done&#x27;</p>
</blockquote>
<p>And actually the stack trace confirms this:</p>
<pre><code>         File &quot;/home/runner/work/ruff-find-bin-during-pip-build/ruff-find-bin-during-pip-build/build.py&quot;, line 7, in prepare_metadata_for_build_wheel
          raise RuntimeError(find_ruff_bin())
                             ^^^^^^^^^^^^^^^
        File &quot;/tmp/pip-build-env-dkih1szy/overlay/lib/python3.12/site-packages/ruff/__main__.py&quot;, line 36, in find_ruff_bin
          raise FileNotFoundError(scripts_path)
</code></pre>
<p>See ruff is installed into <code>/tmp/pip-build-env-dkih1szy/overlay/</code>.</p>
<p>The problem is that Pip does not use virtual environments for building packages, but rather isolated environments. And the discovery mechanism here assumes this is going to be a virtual environment.</p>
<p>I will leave it to you to argue with the PIP maintainers if PEP 517 requires a virtual environment or an isolated environment should suffice. Actually, the PEP explicitly calls it out that virtual environments not required: https://peps.python.org/pep-0517/#build-environment</p>
<blockquote>
<p>We do not require that any particular ‚Äúvirtual environment‚Äù mechanism be used; a build frontend might use virtualenv, or venv, or no special mechanism at all.</p>
</blockquote>
<p>Which then makes it a ruff bug. <code>find_ruff_bin</code> must handle pips isolated environment.</p>
<p>You enabling PEP-517 is a no op because PEP-517 is enabled by default in pip.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-09-12 01:07</div>
            <div class="timeline-body"><p>What is the isolated environment you refer to? How are they creating it? Does it follow a specification somewhere? Can its root be discovered using <code>sysconfig</code>?</p>
<blockquote>
<p>You enabling PEP-517 is a no op because PEP-517 is enabled by default in pip.</p>
</blockquote>
<p>Is this true? I think it&#x27;s enabled by default sometimes, but not always? We get issues every day of people reporting different uv vs pip behavior because pip isn&#x27;t using build isolation on their system.</p>
<p>Just wondering, why are you using Ruff as a build dependency?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-09-12 01:10</div>
            <div class="timeline-body"><blockquote>
<p>You enabling PEP-517 is a no op because PEP-517 is enabled by default in pip.</p>
</blockquote>
<p>(In general, I don&#x27;t believe this is true. It&#x27;s enabled by default for <code>pyproject.toml</code>-based projects. It is not enabled by default for projects that only contain a <code>setup.py</code>. See <a href="https://github.com/pypa/pip/issues/9175">pypa/pip#9175</a>. But this is a <code>pyproject.toml</code>, so yes, shouldn&#x27;t be affected by the flag.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/gaborbernat">@gaborbernat</a> on 2024-09-12 01:14</div>
            <div class="timeline-body"><blockquote>
<p>Is this true? I think it&#x27;s enabled by default sometimes, but not always? We get issues every day of people reporting different uv vs pip behavior because pip isn&#x27;t using build isolation on their system.</p>
</blockquote>
<p>I think for all modern packages. Which is the case here too.</p>
<blockquote>
<p>Just wondering, why are you using Ruff as a build dependency?</p>
</blockquote>
<p>Have an app that generates during build some code from a JSON schema, and the library uses ruff afterward to format the generated code.</p>
<blockquote>
<p>What is the isolated environment you refer to?</p>
</blockquote>
<p>From the above stack trace:</p>
<pre><code>/tmp/pip-build-env-dkih1szy/overlay/
</code></pre>
<blockquote>
<p>How are they creating it? Does it follow a specification somewhere? Can its root be discovered using <code>sysconfig</code>?</p>
</blockquote>
<p>A pip maintainer would be able to answer these questions better than me. Note, that PEP-517 never requires the isolated environment to be sysconfig discoverable and I assume is not.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/gaborbernat">@gaborbernat</a> on 2024-09-12 01:23</div>
            <div class="timeline-body"><p>https://github.com/pypa/pip/blob/main/src/pip/_internal/build_env.py#L81-L139 I believe contains the implementation detail answers... perhaps a cheap solution would be to look for <code>ruff</code> binary on the last entry of <code>PATH</code>... FWIW.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-09-12 01:28</div>
            <div class="timeline-body"><p>Thanks for pulling that up. I think we&#x27;ve explicitly avoided finding the Ruff binary on the PATH because we can&#x27;t really know that it&#x27;s the correct Ruff executable associated with the module. I&#x27;m looking at the <code>site</code> code trying to figure out if there&#x27;s a clear way to guarantee that.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/gaborbernat">@gaborbernat</a> on 2024-09-12 01:32</div>
            <div class="timeline-body"><p>FWIW using uv over pip fixes the issue, but some of our internal systems are not uv ready yet...</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-09-12 02:21</div>
            <div class="timeline-body"><p>I guess I&#x27;d just recommend using a different strategy to find the Ruff binary in the meantime, like <code>shutil.which</code> ‚Äî since you know in this situation it will be at the front of the path. I&#x27;m not sure this is an intended use-case for <code>find_ruff_bin</code>. If there was an obvious fix that retained the existing semantics I&#x27;d accept it though.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/gaborbernat">@gaborbernat</a> on 2024-09-12 02:31</div>
            <div class="timeline-body"><p>I don&#x27;t control the package doing the generation and this method is name for solving this problem, needing another solution doesn&#x27;t feels right...</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/pradyunsg">@pradyunsg</a> on 2024-09-12 14:20</div>
            <div class="timeline-body"><p>Yea, pip&#x27;s isolation is a weird setup that&#x27;s not quite a virtual environment for $legacy reasons around how things worked with Python 2 and all that IIRC. I&#x27;ve wanted to clean that up for a while but haven&#x27;t come around to it due to a lack of time.</p>
<p>I don&#x27;t think you can get the information about the isolated environment&#x27;s paths from <code>sysconfig</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/gaborbernat">@gaborbernat</a> on 2024-09-20 15:09</div>
            <div class="timeline-body"><p>So @zanieb what is the action plan here?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/gaborbernat">@gaborbernat</a> on 2024-09-24 16:40</div>
            <div class="timeline-body"><p>@zanieb ping üòä</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-09-24 16:44</div>
            <div class="timeline-body"><p>Please don&#x27;t ping us repeatedly ‚Äî it&#x27;s bad form.</p>
<p>I don&#x27;t have an action plan here ‚Äî it&#x27;s a weird use case and there&#x27;s not a clear solution. The upstream package should probably switch from using <code>find_ruff_bin</code> to read the <code>PATH</code> directly.</p>
<p>If there&#x27;s a heuristic we can use to understand we&#x27;re in a bespoke pip build environment, I&#x27;m all ears.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/gaborbernat">@gaborbernat</a> on 2024-09-26 16:51</div>
            <div class="timeline-body"><p>How about this close-enough approximation:</p>
<ul>
<li>when all other discovery fails,</li>
<li>if the first entry on the <code>PATH</code> contains a folder named <code>pip-build-env-</code> (starting with) and within <code>overlay</code></li>
<li>a ruff executable is present on the first entry of <code>PATH</code></li>
</ul>
<p>We take a ruff from the first entry of <code>PATH</code>. If you agree with this I can create a PR.</p>
<p>If we really want to be safe, we can also check the presence of the <code>overlay</code> and <code>normal</code> entries at the end of <code>sys.path</code>.</p>
<p>Thanks!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-09-26 16:56</div>
            <div class="timeline-body"><p>It seems reasonable from a correctness perspective, but a bit dubious for long-term maintenance. I&#x27;m not sure. Let me see what other people on the team think.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/gaborbernat">@gaborbernat</a> on 2024-09-26 16:59</div>
            <div class="timeline-body"><p>FWIW <code>pip</code> at some point will switch over to using virtual environments, at which point we can remove it. (or pip will die and be replaced by <code>uv</code> at which point again we can remove it). So either way is a temporary heuristic to make it work in the current (inperfect) world.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-09-26 18:42</div>
            <div class="timeline-body"><p>I suppose I&#x27;m alright with it. (Is that a reliable heuristic on all platforms?)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/gaborbernat">@gaborbernat</a> on 2024-09-26 19:34</div>
            <div class="timeline-body"><p>Yes, following their implementation of the isolated build environment, this should work reliably on all platforms.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-10-03 17:38</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-10-03 17:38</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 18:48:57 UTC
    </footer>
</body>
</html>
