<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Incorrect character counting for non-ASCII characters - astral-sh/ruff #11396</title>
    <link rel="stylesheet" href="../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../index.html">Back to index</a>
    </div>

    <h1>Incorrect character counting for non-ASCII characters</h1>

    <div class="meta">
        <span class="state state-closed">Closed</span>
        <a href="https://github.com/astral-sh/ruff/issues/11396">#11396</a>
        opened by <a href="https://github.com/kotet">@kotet</a>
        on 2024-05-13 02:47
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/kotet">@kotet</a> on 2024-05-13 02:47</div>
            <div class="timeline-body"><p>I am a Japanese speaker and am working on a project where Japanese is used as part of the code.
I have gotten different output from black and ruff for the line length.</p>
<p>black:</p>
<pre><code class="language-python">s = &quot;ãƒ†ã‚¹ãƒˆç”¨ã‚³ãƒ¼ãƒ‰ã§ã™ã€‚æ”¹è¡Œã‚’é™¤ã„ã¦87æ–‡å­—ã§ã™&quot; + &quot; (This is a test code. 87 characters w/o line breaks)&quot;

t = &quot;this is a test code. 87 characters&quot; + &quot; w/o line breaks and non-ascii characters&quot;

</code></pre>
<p>ruff:</p>
<pre><code class="language-bash">$ ruff format test.py
</code></pre>
<pre><code class="language-python">s = (
    &quot;ãƒ†ã‚¹ãƒˆç”¨ã‚³ãƒ¼ãƒ‰ã§ã™ã€‚æ”¹è¡Œã‚’é™¤ã„ã¦87æ–‡å­—ã§ã™&quot;
    + &quot; (This is a test code. 87 characters w/o line breaks)&quot;
)

t = &quot;this is a test code. 87 characters&quot; + &quot; w/o line breaks and non-ascii characters&quot;

</code></pre>
<p>ruff version: <code>ruff 0.4.4</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-05-13 02:50</div>
            <div class="timeline-body"><p>Hi! I believe this is a <a href="https://docs.astral.sh/ruff/formatter/black/#line-width-vs-line-length">known deviation</a> from Black.</p>
<blockquote>
<p>Ruff uses the Unicode width of a line to determine if a line fits. Black uses Unicode width for strings, and character width for all other tokens. Ruff also uses Unicode width for identifiers and comments.</p>
</blockquote>
<p>Related https://github.com/astral-sh/ruff/pull/3714 and https://github.com/psf/black/pull/3445</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/kotet">@kotet</a> on 2024-05-13 03:00</div>
            <div class="timeline-body"><p>If all tokens are counted in unicode width, line splitting should not occur since <code>s = &quot;ãƒ†ã‚¹ãƒˆç”¨ã‚³ãƒ¼ãƒ‰ã§ã™ã€‚æ”¹è¡Œã‚’é™¤ã„ã¦87æ–‡å­—ã§ã™&quot; + &quot; (This is a test code. 87 characters w/o line breaks)&quot;</code> is ~87~86 characters long.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/kotet">@kotet</a> on 2024-05-13 03:22</div>
            <div class="timeline-body"><p>These two lines have the same number of characters (88 + newline):</p>
<pre><code class="language-python">u = &quot;this is test&quot;  # comment ğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸ

u = &quot;this is test&quot; + &quot;ğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸ&quot;
</code></pre>
<p>However, the formatting results are different:</p>
<pre><code class="language-python">u = &quot;this is test&quot;  # comment ğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸ

u = (
    &quot;this is test&quot;
    + &quot;ğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸ&quot;
)
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/kotet">@kotet</a> on 2024-05-13 04:11</div>
            <div class="timeline-body"><p><code>ruff check</code>result:</p>
<pre><code class="language-bash">$ ruff check test.py 
test.py:1:60: E501 Line too long (146 &gt; 88)
test.py:3:56: E501 Line too long (153 &gt; 88)
Found 2 errors.
</code></pre>
<p>It seems that the character count will not work correctly in some situations.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/153957">@153957</a> on 2024-05-13 05:27</div>
            <div class="timeline-body"><p>I believe ruff does not format (wrap) long trailing comments if associated with code on the same line. Probably because in this case it does not know if the comment is about the variable name or the value. Using ASCII characters in your example also does not cause ruff formatting to rewrap:</p>
<pre><code>u = 'this is test'  # comment comment commentcommentcomment commentcommentcomment commentcommentcommentcommentcommentcommentcommentcommentcommentcommentcommentcommentcomment
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/kotet">@kotet</a> on 2024-05-13 06:52</div>
            <div class="timeline-body"><p>Sorry, my example are misguided! I created a more appropriate reproduction code.
All four lines below have the same number of characters (48).</p>
<pre><code class="language-python">&quot;ğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸ! + !ğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸ&quot;
&quot;ğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸ&quot; + &quot;ğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸ&quot;
&quot;aaaaaaaaaaaaaaaaaaaaaaaaaaaaaa! + !aaaaaaaaaaa&quot;
&quot;aaaaaaaaaaaaaaaaaaaaaaaaaaaaaa&quot; + &quot;aaaaaaaaaaa&quot;
</code></pre>
<p>pyproject.toml:</p>
<pre><code class="language-toml">[tool.ruff]
[tool.ruff.lint]
select = [
    &quot;E&quot;,
    &quot;F&quot;,
    &quot;W&quot;,
]
</code></pre>
<p>lint result:</p>
<pre><code class="language-bash">$ ruff check test.py 
test.py:1:48: E501 Line too long (89 &gt; 88)
test.py:2:48: E501 Line too long (89 &gt; 88)
Found 2 errors.
</code></pre>
<p>format result:</p>
<pre><code class="language-python">&quot;ğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸ! + !ğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸ&quot;

(
    &quot;ğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸ&quot;
    + &quot;ğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸ&quot;
)
&quot;aaaaaaaaaaaaaaaaaaaaaaaaaaaaaa! + !aaaaaaaaaaa&quot;
&quot;aaaaaaaaaaaaaaaaaaaaaaaaaaaaaa&quot; + &quot;aaaaaaaaaaa&quot;
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-05-13 17:04</div>
            <div class="timeline-body"><p>To be clear, we do <em>not</em> use character count. We use character <em>width</em>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/kotet">@kotet</a> on 2024-05-14 02:42</div>
            <div class="timeline-body"><p>Oh, I see! I misunderstood &quot;character width&quot; to mean the number of bytes. I understand this works as intended.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @kotet on 2024-05-14 02:42</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">question</span> added by @dhruvmanila on 2024-05-14 07:58</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:28:12 UTC
    </footer>
</body>
</html>
