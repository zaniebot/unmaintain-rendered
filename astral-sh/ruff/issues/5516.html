<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>False Positive `DTZ005`: When using `datetime.datetime.now().astimezone()` - astral-sh/ruff #5516</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>False Positive <code>DTZ005</code>: When using <code>datetime.datetime.now().astimezone()</code></h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/issues/5516">#5516</a>
        opened by <a href="https://github.com/LawrenceJGD">@LawrenceJGD</a>
        on 2023-07-04 21:47
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/LawrenceJGD">@LawrenceJGD</a></div>
            <div class="timeline-body"><!--
Thank you for taking the time to report an issue! We're glad to have you involved with Ruff.

If you're filing a bug report, please consider including the following information:

* A minimal code snippet that reproduces the bug.
* The command you invoked (e.g., `ruff /path/to/file.py --fix`), ideally including the `--isolated` flag.
* The current Ruff settings (any relevant sections from your `pyproject.toml`).
* The current Ruff version (`ruff --version`).
-->

<p>The DTZ005 rule of flake8-datetimez throws an error when using the <code>datetime.datetime.now()</code> class method without the <code>tz</code> argument in <code>now()</code> or when the argument is <code>None</code>, it does this to avoid problems with <code>datetime.datetime</code> objects without a timezone, but there is a way to get the local time and date using <code>datetime. datetime.now().astimezone()</code>, when astimezone() detects that the object does not have a timezone then it assigns the local one, but still flake8-datetimez detects this as an error, so it would be better to fix it, since in the end the object ends up having a timezone.</p>
<p>This is referenced by pjknkda/flake8-datetimez#9 and #1249.</p>
<p>The command I use is <code>ruff check test.py</code> and the example source code is this:</p>
<pre><code class="language-python3">import datetime

datetime.datetime.now().astimezone()
</code></pre>
<p>I'm using ruff 0.0.269 and my <code>pyproject.toml</code>:</p>
<pre><code class="language-toml">[tool.ruff]
select = [
    &quot;W&quot;, &quot;C90&quot;, &quot;I&quot;, &quot;N&quot;, &quot;D&quot;, &quot;UP&quot;, &quot;YTT&quot;, &quot;ANN&quot;, &quot;S&quot;, &quot;BLE&quot;, &quot;FBT&quot;, &quot;B&quot;, &quot;A&quot;,
    &quot;COM&quot;, &quot;C4&quot;, &quot;DTZ&quot;, &quot;ICN&quot;, &quot;PIE&quot;, &quot;RSE&quot;, &quot;RET&quot;, &quot;SLF&quot;, &quot;SIM&quot;, &quot;TCH&quot;, &quot;RUF&quot;,
    &quot;INT&quot;, &quot;ARG&quot;, &quot;TD&quot;, &quot;EM&quot;, &quot;PLC&quot;, &quot;PLE&quot;, &quot;PLR&quot;, &quot;PLW&quot;, &quot;TRY&quot;, &quot;FLY&quot;, &quot;E&quot;,
    &quot;F&quot;
]
line-length = 88
target-version = &quot;py38&quot;
ignore = [&quot;COM812&quot;]

[tool.ruff.pydocstyle]
convention = &quot;google&quot;

[tool.black]
line-length = 88
target-version = [&quot;py38&quot;, &quot;py39&quot;, &quot;py310&quot;, &quot;py311&quot;]
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "False Positive when using .astimezone()" to "False Positive `DTZ005`: When using .astimezone()" by @LawrenceJGD on 2023-07-04 21:48</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "False Positive `DTZ005`: When using .astimezone()" to "False Positive `DTZ005`: When using `datetime.datetime.now().astimezone()`" by @LawrenceJGD on 2023-07-04 21:49</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @charliermarsh on 2023-07-04 21:53</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-07-04 21:53</div>
            <div class="timeline-body"><p>Seems reasonable to me!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">good first issue</span> added by @charliermarsh on 2023-07-05 02:11</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">help wanted</span> added by @charliermarsh on 2023-07-05 02:11</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @dhruvmanila by @dhruvmanila on 2023-07-05 02:35</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2023-07-05 04:19</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/bluetech">@bluetech</a> on 2023-07-05 15:23</div>
            <div class="timeline-body"><p>I'm not quite sure from reading pr #5524 if it explicitly checks for <code>astimezone()</code> with no arguments, or if it also allows with arguments. I think allowing the no-arguments case is OK, because <code>datetime</code> doesn't provide an easy way to refer to the local tzinfo (though I wouldn't recommend it either way, better to specify the timezone directly). But something like <code>datetime.datetime.now().astimezone(mytz)</code> shouldn't be allowed IMO, this usage is most likely bad and I've seen this mistake quite a lot.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2023-07-05 17:20</div>
            <div class="timeline-body"><p>Current implementation doesn't check if <code>astimezone</code> is called with or without any arguments i.e., it allows either of them.</p>
<p>Could you provide an example of why <code>datetime.datetime.now().astimezone(mytz)</code> usage is considered bad?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/LawrenceJGD">@LawrenceJGD</a> on 2023-07-05 20:59</div>
            <div class="timeline-body"><p>I think that if you want to create a <code>datetime.datetime</code> object with the current time using another time zone than the local one, it would be better to use <code>datetime.datetime.now(mytz)</code>, but is seems that this and <code>datetime.datetime.now().astimezone(mytz)</code> are both valid ways for achieving the same thing.</p>
<p>BTW, thanks for being so fast solving this!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/bluetech">@bluetech</a> on 2023-07-05 23:36</div>
            <div class="timeline-body"><p>You're right, <code>datetime.datetime.now().astimezone(mytz)</code> ends up being OK as well, because <code>now()</code> is naive local, and <code>astimezone</code> assumes naive is local.</p>
<p>Here's my analysis on the yes-argument case:</p>
<ul>
<li><p>:x: DTZ001 call-datetime-without-tzinfo, I've seen people do <code>datetime.datetime(2023, 7, 6, 2, 5).astimezone(mytz)</code> when they intended to do <code>datetime.datetime(2023, 7, 6, 2, 5, tzinfo=mytz)</code> (or <code>replace(tzinfo=mytz)</code>). IMO there is no good reason to use <code>astimezone(mytz)</code> here.</p>
</li>
<li><p>:heavy_check_mark: DTZ002 call-datetime-today, local time so OK.</p>
</li>
<li><p>:x: DTZ003 call-datetime-utcnow, using <code>astimezone()</code> is going to be wrong always I believe (unless you live in Greenwich). <code>utcnow()</code> itself is deprecated now for being a footgun.</p>
</li>
<li><p>:x: DTZ004 call-datetime-utcfromtimestamp, same as DTZ003.</p>
</li>
<li><p>:heavy_check_mark: DTZ005 call-datetime-now-without-tzinfo, local time so OK.</p>
</li>
<li><p>:question: DTZ006 call-datetime-fromtimestamp, never used this function, not sure</p>
</li>
<li><p>‚çª DTZ007 call-datetime-strptime-without-zone, depends on the input string. If it's in local time, usage is OK. If not, it's a bug. I suppose in such cases ruff should allow. From the rule description I think it's already allowed so OK.</p>
</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2023-07-06 04:03</div>
            <div class="timeline-body"><p>You're correct in your analysis but I think the diagnostics are correct, it's the <em>usage</em> which might be incorrect from the user side. I don't think we can assume anything about the usage. Correct me if I'm wrong but I think the goal for this rule is to detect if the initialized <code>datetime.datetime</code> object is timezone aware which will be the case if <code>astimezone</code> was called or if it was provided during initialization.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 16:47:36 UTC
    </footer>
</body>
</html>
