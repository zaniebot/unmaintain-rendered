<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PERF401 new preview fixes invalidly hoists extend to list compre - astral-sh/ruff #14362</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>PERF401 new preview fixes invalidly hoists extend to list compre</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/issues/14362">#14362</a>
        opened by <a href="https://github.com/Skylion007">@Skylion007</a>
        on 2024-11-15 14:41
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Skylion007">@Skylion007</a></div>
            <div class="timeline-body"><!--
Thank you for taking the time to report an issue! We're glad to have you involved with Ruff.

If you're filing a bug report, please consider including the following information:

* List of keywords you searched for before creating this issue. Write them down here so that others can find this issue more easily and help provide feedback.
  e.g. "RUF001", "unused variable", "Jupyter notebook"
* A minimal code snippet that reproduces the bug.
* The command you invoked (e.g., `ruff /path/to/file.py --fix`), ideally including the `--isolated` flag.
* The current Ruff settings (any relevant sections from your `pyproject.toml`).
* The current Ruff version (`ruff --version`).
-->

<p>I tried running the new autofixes on the PyTorch codebase and was mostly impressed, but found one really annoying (and handable edge case).</p>
<p>Here is an example bad fix</p>
<pre><code class="language-diff">     @dist_init
     def test_wait_all_with_exception(self):
-        futs = []
+        futs = [rpc.rpc_async(dst, raise_func) for _ in range(10)]
         dst = worker_name((self.rank + 1) % self.world_size)
-        for _ in range(10):
-            futs.append(rpc.rpc_async(dst, raise_func))

         with self.assertRaisesRegex(ValueError, &quot;Expected error&quot;):
             torch.futures.wait_all(futs)
</code></pre>
<p>Here is an example diff generated by ruff. Note that list comprehensions uses <code>dst</code> even though dst is first defined on the line underneath the list comprehension. Ruff can already detect this because it immeaditely created a bunch of ruff F821 errors as soon as the fixes were applied. It would be good not to hoist the forloop from an extend to a list comprehensions if there are any variables needed for the list comprehension defined or mutated in anyway. I was kind of surprised given that it did properly not hoist the function if there were any comments in between the list definition and the loop.</p>
<p><code>ruff 0.7.4</code>
<code>ruff check --select=PERF401 --fix --unsafe-fixes --preview</code></p>
<p>FYI @w0nder1ng</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "PERF401 new fixes generates invalid code" to "PERF401 new preview fixes invalidly hoists extend to list compre" by @Skylion007 on 2024-11-15 14:42</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/w0nder1ng">@w0nder1ng</a> on 2024-11-15 15:29</div>
            <div class="timeline-body"><p>I didn't consider that when I was writing the fix, and I guess the question now is how this case should be handled. I guess a possible fix could look like:</p>
<pre><code class="language-python">     @dist_init
     def test_wait_all_with_exception(self):
-        futs = []
         dst = worker_name((self.rank + 1) % self.world_size)
-        for _ in range(10):
-            futs.append(rpc.rpc_async(dst, raise_func))
+        futs = [rpc.rpc_async(dst, raise_func) for _ in range(10)]
         with self.assertRaisesRegex(ValueError, &quot;Expected error&quot;):
             torch.futures.wait_all(futs)
</code></pre>
<p>As long as we check that the <code>futs</code> variable isn't used between <code>futs = []</code> and the for loop, it should be fine.</p>
<blockquote>
<p>I was kind of surprised given that it did properly not hoist the function if there were any comments in between the list definition and the loop.</p>
</blockquote>
<p>If you have an example of this, I'd be happy to take a look.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @dylwil3 on 2024-11-15 15:53</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">fixes</span> added by @dylwil3 on 2024-11-15 15:53</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Skylion007">@Skylion007</a> on 2024-11-15 16:38</div>
            <div class="timeline-body"><p>Sorry typo, it properly did NOT hoist the function if there were comments (to preserve the comments). As it did not hoist the list comprehension if there was a comment there. It did do if there was code in the way, which was surprising.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Skylion007">@Skylion007</a> on 2024-11-17 17:32</div>
            <div class="timeline-body"><p>Also, FYI once these fixes are landed. We should look into PERF403, as the fixes will share a lot of similar logic. :)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @MichaReiser on 2024-12-12 08:11</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 16:51:32 UTC
    </footer>
</body>
</html>
