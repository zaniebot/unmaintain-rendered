```yaml
number: 2154
title: "Significant performance overhead when passing files and using multiple `per-file-ignores`"
type: issue
state: closed
author: mkniewallner
labels:
  - performance
assignees: []
created_at: 2023-01-25T14:00:38Z
updated_at: 2023-01-26T07:35:49Z
url: https://github.com/astral-sh/ruff/issues/2154
synced_at: 2026-01-10T01:56:45Z
```

# Significant performance overhead when passing files and using multiple `per-file-ignores`

---

_Issue opened by @mkniewallner on 2023-01-25 14:00_

When defining multiple `per-file-ignores` while explicitly passing files for `ruff` to run on (which is most commonly done when using `ruff` through `pre-commit`), this creates a significant performance overhead.

This is reproducible on this commit: https://github.com/mkniewallner/django/commit/41602b53ea3a18ad8f27fc7ab8019af7e2f27d5f that forks [django](https://github.com/django/django) project.

For posterity, here's the relevant `[tool.ruff]` section in `pyproject.toml`:

```toml
[tool.ruff.per-file-ignores]
"django/contrib/admin/*" = ["W505"]
"django/contrib/admindocs/*" = ["W505"]
"django/contrib/auth/*" = ["W505"]
"django/contrib/contenttypes/*" = ["W505"]
"django/contrib/flatpages/*" = ["W505"]
"django/contrib/gis/*" = ["W505"]
"django/contrib/humanize/*" = ["W505"]
"django/contrib/messages/*" = ["W505"]
"django/contrib/postgres/*" = ["W505"]
"django/contrib/redirects/*" = ["W505"]
"django/contrib/sessions/*" = ["W505"]
"django/contrib/sitemaps/*" = ["W505"]
"django/contrib/sites/*" = ["W505"]
"django/contrib/staticfiles/*" = ["W505"]
"django/contrib/syndication/*" = ["W505"]
"django/core/cache/*" = ["W505"]
"django/core/checks/*" = ["W505"]
"django/core/files/*" = ["W505"]
"django/core/handlers/*" = ["W505"]
"django/core/mail/*" = ["W505"]
"django/core/serializers/*" = ["W505"]
"django/core/servers/*" = ["W505"]
```

Without any `per-file-ignores`:

```console
$ time pre-commit run ruff -a

ruff.....................................................................Failed
- hook id: ruff
- exit code: 1

django/core/files/locks.py:9:89: E501 Line too long (98 > 88 characters)
Found 1 error(s).


________________________________________________________
Executed in  565.17 millis    fish           external
   usr time  214.06 millis    0.07 millis  213.99 millis
   sys time  627.89 millis    1.39 millis  626.50 millis
```

With the `per-file-ignores` above:

```console
$ time pre-commit run ruff -a

ruff.....................................................................Failed
- hook id: ruff
- exit code: 1

django/core/files/locks.py:9:89: E501 Line too long (98 > 88 characters)
Found 1 error(s).


________________________________________________________
Executed in    3.86 secs    fish           external
   usr time    3.44 secs    0.07 millis    3.44 secs
   sys time    0.73 secs    1.15 millis    0.73 secs
```

Note that:

- It is also reproducible outside of `pre-commit`, by for instance running `ruff $(find . -type f -name '*.py')`
- The performance overhead does NOT happen if not passing files one by one, by for instance simply running `ruff .`

Output of `ruff --version`:

```console
ruff 0.0.231
```

---

_Comment by @charliermarsh on 2023-01-25 14:03_

Thanks for filing -- super interesting :) I'd be very surprised if we can't improve this significantly. I'll try to take a look today to at least diagnose the issues.

---

_Label `performance` added by @charliermarsh on 2023-01-25 14:03_

---

_Assigned to @charliermarsh by @charliermarsh on 2023-01-25 18:27_

---

_Comment by @charliermarsh on 2023-01-25 18:32_

It looks like we're loading and parsing the configuration file a zillion times here.

---

_Referenced in [astral-sh/ruff#2165](../../astral-sh/ruff/pulls/2165.md) on 2023-01-25 18:34_

---

_Closed by @charliermarsh on 2023-01-25 18:38_

---
