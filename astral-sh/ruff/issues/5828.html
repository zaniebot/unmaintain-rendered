<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ðŸ“‹ Formatter black compatibility tracking issue - astral-sh/ruff #5828</title>
    <link rel="stylesheet" href="../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../index.html">Back to index</a>
    </div>

    <h1>ðŸ“‹ Formatter black compatibility tracking issue</h1>

    <div class="meta">
        <span class="state state-closed">Closed</span>
        <a href="https://github.com/astral-sh/ruff/issues/5828">#5828</a>
        opened by <a href="https://github.com/konstin">@konstin</a>
        on 2023-07-17 09:32
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/konstin">@konstin</a> on 2023-07-17 09:32</div>
            <div class="timeline-body"><p>We will continuously update this issue with compatibility measure between our formatter and black and the general status of the formatter.</p>
<h3>Not Implemented</h3>
<p><code>not_yet_implemented</code> usages: 0
<code>not_yet_implemented_custom_text</code> usages: 0</p>
<h3>Select Projects / Small ecosystem check</h3>
<p>To condense the compatibility over an entire repository, we use the similarity index. It is defined as the percentage of lines that remains unchanged between black's formatting and our formatting. You could compute it as the number of neutral lines in a diff divided by the neutral plus the removed lines.</p>
<p>I chose 6 different projects to check for now, we may update this list in the future.
To reproduce these numbers or to check your own changes, you can run <code>scripts/formatter_progress.sh</code>:</p>
<p><strong>django</strong> (web framework): 2752 files, similarity index 0.99805:</p>
<ul>
<li>Tracked in https://github.com/astral-sh/ruff/issues/6069</li>
</ul>
<p><strong>transformers</strong> (ML framework): 2527 files, similarity index 0.99620</p>
<ul>
<li>https://github.com/astral-sh/ruff/issues/5824 (The project doesnâ€™t use <code>black .</code> but <code>black examples tests src utils</code> , same thing for ruff)</li>
</ul>
<p><strong>twine</strong> (small util library): 32 files, similarity index 0.99876</p>
<p><strong>typeshed</strong> (stub files): 3627 files, similarity index 0.99953</p>
<ul>
<li>https://github.com/astral-sh/ruff/issues/5821</li>
<li>https://github.com/astral-sh/ruff/issues/5822</li>
<li>We're missing black's exact empty line rules: https://github.com/astral-sh/ruff/issues/6723</li>
</ul>
<p><strong>warehouse</strong> (pypi backend): 641 files, similarity index 0.99601</p>
<p><strong>zulip</strong> (a django user): 1424 files, similarity index 0.99727</p>
<h3>Large ecosystem check</h3>
<p>There is a number of formatter bugs showing up in the ecosystem checks, a list from 2023-08-21 is in https://gist.github.com/konstin/c7183dda99e65c7a1acbd970d2f44b42. Implicit string concatenation and fluent style seem to be the two common causes. Gist created by:</p>
<pre><code class="language-shell">target/release/ruff_dev format-dev --stability-check --error-file target/errors-$(date --iso-8601).txt --multi-project target/checkouts &gt; target/stability-check-release-$(date --iso-8601).txt
</code></pre>
<p>and manually removing e.g. slow formatting.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">formatter</span> added by @konstin on 2023-07-17 09:32</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/cnpryer">@cnpryer</a> on 2023-07-17 13:28</div>
            <div class="timeline-body"><p>I know it's comment placement, but is #5630 related to black compatibility?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2023-07-18 17:30</div>
            <div class="timeline-body"><blockquote>
<p>I know it's comment placement, but is https://github.com/astral-sh/ruff/issues/5630 related to black compatibility?</p>
</blockquote>
<p>i'd expect fixing this would be a minor improvement in the compatibility score, but it's unfortunately hard to tell beforehand</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/5355.html">astral-sh/ruff#5355</a> on 2023-07-18 17:32</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "Formatter black compatibility tracking issue" to ":clipboard: Formatter black compatibility tracking issue" by @konstin on 2023-07-19 13:20</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from ":clipboard: Formatter black compatibility tracking issue" to "ðŸ“‹ Formatter black compatibility tracking issue" by @konstin on 2023-07-19 13:20</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2023-07-19 13:24</div>
            <div class="timeline-body"><p>Old numbers:</p>
<p>build: similarity index 0.738
django: similarity index 0.978
transformers: similarity index 0.972
typeshed: similarity index 0.827
zulip: similarity index 0.970</p>
<p>New numbers:</p>
<p>build: 40 files, similarity index 0.740
django: 2752 files, similarity index 0.983
transformers: 2527 files, similarity index 0.976
typeshed: 3627 files, similarity index 0.766
zulip: 1424 files, similarity index 0.975</p>
<p>I'm unsure what happened with typeshed</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2023-07-19 14:32</div>
            <div class="timeline-body"><p>https://github.com/astral-sh/ruff/pull/5882 fixes the transformers bugs, after that all test projects pass without errors (except for those files that already have syntax errors in the input)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2023-07-19 19:45</div>
            <div class="timeline-body"><p>Updated the gist to today (https://gist.github.com/konstin/edd2a914fdf4196020d9efa3f2c7e6ff) and filed issues for recurring themes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2023-07-20 09:51</div>
            <div class="timeline-body"><p>I minimized all cases of unstable formatting from the ecosystem checks: https://gist.github.com/konstin/61adab19d5615160750171944653673d . This gives us a single file that checks for all known cases of unstable formatting</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/5915.html">astral-sh/ruff#5915</a> on 2023-07-20 10:52</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/5943.html">astral-sh/ruff#5943</a> on 2023-07-21 08:24</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2023-07-24 17:44</div>
            <div class="timeline-body"><p>#6035 documents how to run the formatter progress tracking script yourself, and it's also part of CI now</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2023-07-25 11:26</div>
            <div class="timeline-body"><p>Tracking issue specifically for django: https://github.com/astral-sh/ruff/issues/6069</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone "Formatter: Stable" by @MichaReiser on 2023-07-31 16:16</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2023-08-21 13:49</div>
            <div class="timeline-body"><p>Updated the original post</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../shap/shap/pulls/3111.html">shap/shap#3111</a> on 2023-08-22 01:19</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/cnpryer">@cnpryer</a> on 2023-08-28 16:30</div>
            <div class="timeline-body"><blockquote>
<p>not_yet_implemented_custom_text usages: 8</p>
</blockquote>
<p>Was browsing. Figured I could cc https://github.com/astral-sh/ruff/pull/6905#issuecomment-1694508204. Looks to be no longer used :)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2023-09-04 13:28</div>
            <div class="timeline-body"><p>| project      | similarity index  | total files       | changed files     |
|--------------|------------------:|------------------:|------------------:|
| django       |           0.99957 |              2760 |                67 |
| transformers |           0.99928 |              2587 |               456 |
| twine        |           0.99982 |                33 |                 1 |
| typeshed     |           0.99978 |              3496 |              2173 |
| warehouse    |           0.99818 |               648 |                24 |
| zulip        |           0.99942 |              1437 |                32 |</p>
<p>We've reached &gt;99.9% in 5 out of 6 projects! There's still some differences remaining, but all nodes are implemented and all the big recurring themes are fixed, so i'm closing this issue.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @konstin on 2023-09-04 13:28</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:28:09 UTC
    </footer>
</body>
</html>
