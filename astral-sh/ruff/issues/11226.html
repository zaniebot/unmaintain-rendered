<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>☂️ Remove `SoftKeywordTransformer` - astral-sh/ruff #11226</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>☂️ Remove `SoftKeywordTransformer`</h1>

    <div class="meta">
        <span class="state state-closed">Closed</span>
        <a href="https://github.com/astral-sh/ruff/issues/11226">#11226</a>
        opened by <a href="https://github.com/dhruvmanila">@dhruvmanila</a>
        on 2024-05-01 02:37
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-05-01 02:37</div>
            <div class="timeline-body"><p>This issue is to keep track of the tasks required to remove the <code>SoftKeywordTransformer</code>.</p>
<p>The main reason to remove this is to improve error recovery because it can't classify the soft keywords between a keyword and an identifier correctly in cases which has syntax errors. This would mean that the lexer and the parser are out of sync. For example:</p>
<pre><code class="language-py">match foo
    case &quot;bar&quot;
        ...
</code></pre>
<p>Here, both <code>match</code> and <code>case</code> are keywords but the current logic marks them as identifier leading to bad error recovery.</p>
<h2>Work items</h2>
<h3>Add the checkpoint - rewind infrastructure in the parser</h3>
<ul>
<li><p>Update <code>TokenSource</code></p>
<ul>
<li>Update <code>tokens: IntoIter&lt;LexResult&gt;</code> to <code>tokens: Vec&lt;LexResult&gt;</code></li>
<li>Add a <code>position: TextSize</code> field</li>
<li>Add a <code>checkpoint</code> method which creates a <code>TokenSourceCheckpoint</code></li>
<li>Add a <code>rewind</code> method which resets the token source to the given <code>TokenSourceCheckpoint</code></li>
<li>Add a <code>peek2</code> method which returns the second <code>TokenKind</code> without consuming any tokens</li>
</ul>
</li>
<li><p>Implement <code>TokenSourceCheckpoint</code> with the following fields:</p>
<pre><code class="language-rust">struct TokenSourceCheckpoint {
    position: TextSize,
    errors_pos: usize
}
</code></pre>
</li>
<li><p>Update <code>Parser</code></p>
<ul>
<li>Add a <code>checkpoint</code> method which creates a <code>ParserCheckpoint</code></li>
<li>Add a <code>rewind</code> method which resets the parser to the given <code>ParserCheckpoint</code></li>
<li>Add a <code>peek2</code> method which returns the second <code>TokenKind</code> without consuming any tokens</li>
</ul>
</li>
<li><p>Implement <code>ParserCheckpoint</code> with the following fields:</p>
<pre><code class="language-rust">struct ParserCheckpoint {
    tokens: TokenSourceCheckpoint,
    errors_pos: usize,
    current: Spanned,
    current_token_id: TokenId,
    last_token_end: TextSize,
    recovery_context: RecoveryContext
}
</code></pre>
</li>
</ul>
<h3>Update statement parsing which uses soft keywords</h3>
<ul>
<li>Update <code>match</code> statement parsing<ul>
<li>Fast path: Use two token lookahead to determine if <code>match</code> is a keyword or not</li>
<li>Slow path: If the fast path fails, use the checkpoint - rewind infrastructure to parse the subject expression and consider it as a keyword if:<ul>
<li>Current token is <code>:</code>, peek is <code>Newline</code>, peek2 is <code>Indent</code></li>
<li>Or, current token is <code>Newline</code>, peek is <code>Indent</code>, peek2 is <code>case</code></li>
</ul>
</li>
</ul>
</li>
<li>Update <code>type</code> alias statement parsing<ul>
<li>Use two token lookahead to determine if <code>type</code> is a keyword or an not</li>
</ul>
</li>
<li>Update <code>parse_identifier</code> to not raise “Expected an identifier” error if the current token is a soft keyword</li>
</ul>
<h3>Update <code>with</code> item parsing to use checkpoint - rewind infrastructure</h3>
<p>This might get a bit involved to transfer the logic to make sure it’s correct but I think we can utilize Pyright’s implementation as a reference</p>
<p>Internal document: https://www.notion.so/astral-sh/Soft-keywords-4f132faea4134d9facad3fed155dc3c4?pvs=4</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">parser</span> added by @dhruvmanila on 2024-05-01 02:37</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @dhruvmanila by @dhruvmanila on 2024-05-01 02:37</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-05-02 05:03</div>
            <div class="timeline-body"><p>This needs to be re-worked because of the way the tasks are dependent on other tasks.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @dhruvmanila on 2024-05-02 05:03</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:34:52 UTC
    </footer>
</body>
</html>
