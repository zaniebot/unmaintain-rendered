<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>mutable-dataclass-default (RUF008) not detecting mutable_default field - astral-sh/ruff #16539</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>mutable-dataclass-default (RUF008) not detecting mutable_default field</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/ruff/issues/16539">#16539</a>
        opened by <a href="https://github.com/neilmacintyre">@neilmacintyre</a>
        on 2025-03-06 17:40
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/neilmacintyre">@neilmacintyre</a></div>
            <div class="timeline-body">Summary
<p>In the below example I would expect <code>RUF008</code> to be diagnosed for the field <code>B.mutable_default</code>; however running <code>ruff check --select RUF008 sample.py</code> returns &quot;All checks passed!&quot;  Likewise the ruff playground for this example also does not diagnose an RUF008: https://play.ruff.rs/e43262be-cf32-4348-9617-fed0e7303d9d</p>
<hr>
<p>sample.py:</p>
<pre><code>from dataclasses import dataclass

@dataclass
class A:
    x = 1


@dataclass
class B:
    mutable_default: A = A()

</code></pre>
<p>In python 3.11 if I run this code it raises <code>ValueError: mutable default &lt;class &#x27;__main__.A&#x27;&gt; for field mutable_default is not allowed: use default_factory</code></p>
<pre><code>&gt; python sample.py
Traceback (most recent call last):
  File &quot;/home/user/sample.py&quot;, line 11, in &lt;module&gt;
    @dataclass
     ^^^^^^^^^
  File &quot;/usr/lib/python3.11/dataclasses.py&quot;, line 1232, in dataclass
    return wrap(cls)
           ^^^^^^^^^
  File &quot;/usr/lib/python3.11/dataclasses.py&quot;, line 1222, in wrap
    return _process_class(cls, init, repr, eq, order, unsafe_hash,
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File &quot;/usr/lib/python3.11/dataclasses.py&quot;, line 958, in _process_class
    cls_fields.append(_get_field(cls, name, type, kw_only))
                      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File &quot;/usr/lib/python3.11/dataclasses.py&quot;, line 815, in _get_field
    raise ValueError(f&#x27;mutable default {type(f.default)} for field &#x27;
ValueError: mutable default &lt;class &#x27;__main__.A&#x27;&gt; for field mutable_default is not allowed: use default_factory
</code></pre>
<hr>
<p>Python 3.11 &quot;Use unhashable as a proxy indicator for mutability.&quot;</p>
<p><a href="https://github.com/python/cpython/blob/3.13/Lib/dataclasses.py#L856-L862">python3.11/dataclasses.py:811-815</a></p>
<pre><code>    # For real fields, disallow mutable defaults.  Use unhashable as a proxy
    # indicator for mutability.  Read the __hash__ attribute from the class,
    # not the instance.
    if f._field_type is _FIELD and f.default.__class__.__hash__ is None:
        raise ValueError(f&#x27;mutable default {type(f.default)} for field &#x27;
                         f&#x27;{f.name} is not allowed: use default_factory&#x27;)
</code></pre>
<p>It might be that is_mutable in <a href="https://github.com/InSyncWithFoo/ruff/blob/main/crates/ruff_linter/src/rules/ruff/rules/mutable_dataclass_default.rs#L89-L92">this file</a> does not use the same proxy</p>
<pre><code>        if is_mutable_expr(value, checker.semantic())
            &amp;&amp; !is_class_var_annotation(annotation, checker.semantic())
            &amp;&amp; !is_immutable_annotation(annotation, checker.semantic(), &amp;[])
        {
            let diagnostic = Diagnostic::new(MutableDataclassDefault, value.range());

            checker.diagnostics.push(diagnostic);
        }
</code></pre>
Version
<p>ruff 0.9.9</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-03-06 17:47</div>
            <div class="timeline-body"><p>Thanks for the detailed write up.</p>
<p>The rule currently favors fewer false-negatives over finding every possible violation. In fact, the check is fairly limited, Ruff only recognises the following types:</p>
<p>https://github.com/astral-sh/ruff/blob/e4d9fe036ade3ee6c912fb0bb94c3886c695e736/crates/ruff_python_stdlib/src/typing.rs#L302-L311</p>
<p>Doing any better than this would require better type inference which Ruff currently lacks but we&#x27;re working on.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">rule</span> added by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-03-06 17:47</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">wish</span> added by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-03-06 17:47</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">type-inference</span> added by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-03-06 17:47</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Renkai">@Renkai</a> on 2025-09-15 02:46</div>
            <div class="timeline-body"><p>Also encountered this, hope it can be put in the road map.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 18:49:37 UTC
    </footer>
</body>
</html>
