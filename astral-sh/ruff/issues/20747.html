<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fix several rules to handle deferred annotations - astral-sh/ruff #20747</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Fix several rules to handle deferred annotations</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/ruff/issues/20747">#20747</a>
        opened by <a href="https://github.com/ntBre">@ntBre</a>
        on 2025-10-07 15:17
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a></div>
            <div class="timeline-body"><p>Several rules exhibit very different behavior in the presence of deferred annotations, whether from an explicit <code>from __future__ import annotations</code> or on Python 3.14. These include:</p>
<ul>
<li>FAST001</li>
<li>FAST003</li>
<li>A003</li>
<li>PTH210</li>
<li>RUF001</li>
</ul>
<p>You can see the effect of switching the Python version from 3.13 to 3.14 in this <a href="https://github.com/astral-sh/ruff/pull/20725/commits/095acaff3356c9941262b72d4e911514d6dd28bb">commit</a> from #20725.</p>
<p>In addition to the tests modified in the commit above, each of these rules also has a new <code>assert_diagnostics_diff</code> test:</p>
<ul>
<li><a href="https://github.com/astral-sh/ruff/blob/a658f4181d4e3ee85815e9f84c88d77c51160186/crates/ruff_linter/src/rules/fastapi/mod.rs#L34">FAST001 and FAST003</a></li>
<li><a href="https://github.com/astral-sh/ruff/blob/a658f4181d4e3ee85815e9f84c88d77c51160186/crates/ruff_linter/src/rules/flake8_builtins/mod.rs#L68">A003</a></li>
<li><a href="https://github.com/astral-sh/ruff/blob/a658f4181d4e3ee85815e9f84c88d77c51160186/crates/ruff_linter/src/rules/flake8_use_pathlib/mod.rs#L87">PTH210</a></li>
<li><a href="https://github.com/astral-sh/ruff/blob/a658f4181d4e3ee85815e9f84c88d77c51160186/crates/ruff_linter/src/rules/ruff/mod.rs#L249">RUF001</a></li>
</ul>
<p>To fix this issue, we should remove all of these diffs.</p>
<p>Micha and Dylan observed that <code>semantic.resolve_name</code> seems to be returning the wrong results now (https://github.com/astral-sh/ruff/pull/20725#issuecomment-3376143411), and I think they suggested possibly making these checks deferred so that we can resolve these lookups differently.</p>
<p>Unless the changes end up being quite small, I think it could make sense to tackle these with one PR per rule.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "Fix several rules to handle typing-only annotations" to "Fix several rules to handle deferred annotations" by @ntBre on 2025-10-07 15:18</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @ntBre on 2025-10-07 15:30</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @dylwil3 by @ntBre on 2025-10-07 15:30</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/11happy">@11happy</a> on 2025-10-12 12:51</div>
            <div class="timeline-body"><p>Hello @ntBre , I am interested to work on this , Can I work on <code>A003</code> ?
Thank you</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-10-13 06:30</div>
            <div class="timeline-body"><p>We have to check with @dylwil3, as he's currenlty working on this</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dylwil3">@dylwil3</a> on 2025-10-13 17:55</div>
            <div class="timeline-body"><p>The more the merrier - feel free to work on <code>A003</code> @11happy !</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/11happy">@11happy</a> on 2025-10-21 18:16</div>
            <div class="timeline-body"><p>While Debugging for <code>A003</code> I noticed that for this case</p>
<pre><code>def str(self):
        pass

    def method_usage(self) -&gt; str:
        pass
</code></pre>
<p>in python 3.14 zero references were there you see can the debug prints below</p>
<pre><code>binding: str
Binding ID: BindingId(173)
Binding kind: FunctionDefinition(ScopeId(11))
Binding start: 206
Binding type: Method
'str' shadows a builtin
Number of references: 0
</code></pre>
<p>&amp; similary for 3.13</p>
<pre><code>binding: str
Binding ID: BindingId(172)
Binding kind: FunctionDefinition(ScopeId(11))
Binding start: 206
Binding type: Method
'str' shadows a builtin
Number of references: 1
</code></pre>
<p>now to solve this issue I was thinking can we walk the AST to to find shadowed names in annotations, instead of relying on semantic references ? Please let me know if this is the expected approach ? Would appreciate any pointers here.</p>
<p>Thank you : )</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntBre">@ntBre</a> on 2025-10-23 20:37</div>
            <div class="timeline-body"><p>I haven't really looked closely enough to give a definitive answer, and Dylan might have a better idea, but the nice thing about fixing the semantic model in principle is that it will &quot;automatically&quot; fix all of the affected rules. And walking the AST repeatedly can also be expensive, but sometimes there's no other choice.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 16:53:25 UTC
    </footer>
</body>
</html>
