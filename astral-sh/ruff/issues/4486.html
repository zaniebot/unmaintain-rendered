<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ruff picks wrong scope for variable - astral-sh/ruff #4486</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Ruff picks wrong scope for variable</h1>

    <div class="meta">
        <span class="state state-closed">Closed</span>
        <a href="https://github.com/astral-sh/ruff/issues/4486">#4486</a>
        opened by <a href="https://github.com/notatallshaw">@notatallshaw</a>
        on 2023-05-18 02:04
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/notatallshaw">@notatallshaw</a> on 2023-05-18 02:04</div>
            <div class="timeline-body"><p>Specifically, Ruff incorrectly identifies the scope a variable is chosen from when it's inside a comprehension inside a class inside a function and a variable with the same name exists inside the class scope.</p>
<p>Here is shortest code to reproduce this example, I named it <code>scopetest.py</code>:</p>
<pre><code class="language-python">def f():
    b = 'Function Scope'
    class C:
        b = 'Class Scope'
        d = [b for _ in range(1)]
    return C

print(f().d[0])  # Prints &quot;Function Scope&quot;
</code></pre>
<p>Running Ruff:</p>
<pre><code class="language-bash">&gt; ruff --version
ruff 0.0.267
&gt; ruff scopetest.py
scopetest.py:2:5: F841 [*] Local variable `b` is assigned to but never used
Found 1 error.
</code></pre>
<p>If I run <code>ruff</code> with <code>--fix</code> it deletes the line that b is sourced from causing the code to now throw an exception.</p>
<p>The reason b is scoping from the function scope and not the class scope is that generators / comprehensions implicitly create an anonymous function and source their scope from locals, non-locals, globals, and builtins and skip the class scope as all other functions do.</p>
<p>I came across this testing different versions of code <a href="https://discuss.python.org/t/pep-709-one-behavior-change-that-was-missed-in-the-pep/26691">posted here</a> where the Steering Council has decided to keep the behavior as-is for at least Python 3.12.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @charliermarsh on 2023-05-18 02:09</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-05-18 02:10</div>
            <div class="timeline-body"><p>Interesting, thank you for filing.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @charliermarsh by @charliermarsh on 2023-05-18 03:04</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-05-18 03:08</div>
            <div class="timeline-body"><p>Do you understand why this runs without error?</p>
<pre><code class="language-py">class A:
    T = range(10)

    Z = (x for x in T)
    L = [x for x in T]
    B = dict((i, str(i)) for i in T)
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-05-18 03:18</div>
            <div class="timeline-body"><p>Ah, so this scoping only applies to the generator body, and not the iterable.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/notatallshaw">@notatallshaw</a> on 2023-05-18 03:20</div>
            <div class="timeline-body"><blockquote>
<p>Ah, so this scoping only applies to the generator body, and not the iterable.</p>
</blockquote>
<p>Yes, your example initially threw me off, but I think in this case the iterable can be thought of like the function signature (e.g. the defaults of the arguments), it's scope is in the outer area and the body is like a function body.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-05-18 03:23</div>
            <div class="timeline-body"><p>Here's another interesting wrinkle -- this does <em>not</em> work:</p>
<pre><code class="language-py">class A:
    T = range(10)

    L = [x for x in T for y in T]
</code></pre>
<p>I noticed this via the comment in Carl Meyer's <a href="https://github.com/carljm/compfinder/blob/8dabc1d256431b1b2bd4c578a28d38f4ccad0ea0/finder.py#L207">finder tool</a>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-05-18 03:23</div>
            <div class="timeline-body"><p>So it's only the first generator (?) that's evaluated in the parent scope.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/notatallshaw">@notatallshaw</a> on 2023-05-18 03:30</div>
            <div class="timeline-body"><blockquote>
<p>So it's only the first generator (?) that's evaluated in the parent scope.</p>
</blockquote>
<p>Right, expanding my analogy same how the signature of bar fails here:</p>
<pre><code class="language-python">class A:
    T = range(10)

    def foo(x=T):
        def bar(y=T):
            pass
        return bar()
    foo()
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-05-18 03:31</div>
            <div class="timeline-body"><p>Thank you, that's a really helpful model.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/4494.html">astral-sh/ruff#4494</a> on 2023-05-18 14:13</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2023-05-18 14:30</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:34:50 UTC
    </footer>
</body>
</html>
