<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TRY400 flags log.error() + raise/sys.exit() - astral-sh/ruff #4136</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>TRY400 flags log.error() + raise/sys.exit()</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/ruff/issues/4136">#4136</a>
        opened by <a href="https://github.com/jankatins">@jankatins</a>
        on 2023-04-27 19:11
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/jankatins">@jankatins</a></div>
            <div class="timeline-body"><p>In the following code snippet, a TRY400 violation is raised because I use log.error() and not log.exception() in an exception handler. In this case it's by design as I immediately re-raise the exception, I just want to add some message to the exception and I don't want the stacktrace shown twice.</p>
<pre><code>import logging
log = logging.get_logger(__name__)
# The outer app loop...
try:
    # actually some function call which can't handle the error but wants to abort...
    try:
        raise Exception(&quot;bad&quot;)
    except Exception:
        # to get some info into the log to &quot;enrich&quot; it...
        # and I don't want to see the exception stacktrace twice
        log.error(&quot;That might mean ...&quot; ) # noqa: TRY400: use log.exception()
        raise
except Exception:
    log.exception(&quot;Caught unhandled exception in outer context&quot;)
</code></pre>
<p>In my opinion the pattern &quot;in except block, with a log.something + 'raise' in all cases` should be something TRY400 should ignore/be ok with.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "TRY400 is too eager to flag something" to "TRY400 flags log.error() + raise" by @jankatins on 2023-04-27 19:11</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/tjkuson">@tjkuson</a> on 2023-04-27 20:38</div>
            <div class="timeline-body"><p>Is there a reason why you couldn't pass <code>exc_info=False</code> into the <code>log.exception</code> method to suppress the stacktrace?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/jankatins">@jankatins</a> on 2023-04-27 21:27</div>
            <div class="timeline-body"><p>Mostly because I didn't know of it :-) but also because I wanted a different log level than EXCEPTION.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2023-04-28 05:12</div>
            <div class="timeline-body"><p>If you're using Python 3.11, then you should use the new <a href="https://docs.python.org/3/whatsnew/3.11.html#pep-678-exceptions-can-be-enriched-with-notes"><code>add_notes</code> feature</a> to enhance the message.</p>
<blockquote>
<p>I wanted a different log level than EXCEPTION.</p>
</blockquote>
<p>Is this a custom defined log level as it doesn't exists in the <a href="https://docs.python.org/3/library/logging.html?highlight=logging#logging-levels"><code>logging</code> module</a>?</p>
<p>Correct me if I'm wrong as I might not be aware of the context, but I think you could get away with just using <code>logging.exception</code>. Whatever message you pass in <code>logging.exception</code> is logged at <code>ERROR</code> level and in addition to that the traceback is printed as well. You could provide the additional message and have the traceback message in the logs as well. Example:</p>
<pre><code class="language-python">def foo():
	def bar():
		try:
			raise Exception(&quot;exception message&quot;)
		except:
			logging.exception(&quot;additional message&quot;)
	bar()


foo()
# ERROR:root:additional message
# Traceback (most recent call last):
#   File &quot;&lt;ipython-input-7-78c777a5f655&gt;&quot;, line 4, in bar
#     raise Exception(&quot;exception message&quot;)
# Exception: exception message
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/jankatins">@jankatins</a> on 2023-04-28 12:17</div>
            <div class="timeline-body"><blockquote>
<p>Whatever message you pass in logging.exception is logged at ERROR level</p>
</blockquote>
<p>Wow, thanks, I didn't know that. Always though that exception is it's own level.</p>
<p>re add_notes: Yes, I think that would be nice, but I haven't checked how this is then displayed in the logs. It's really nice that one has a extra log line with just the extra info instead of the &quot;log lines explosion&quot; of the stacktrace...</p>
<p>Anyway: I still think this pattern should be not flagged: it's perfectly good code to use e.g. <code>log.info(&quot;message&quot;)</code> or whatever else is printed...</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">question</span> added by @charliermarsh on 2023-04-29 19:07</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/saippuakauppias">@saippuakauppias</a> on 2023-06-15 12:29</div>
            <div class="timeline-body"><p>If you disable the sending of information about the exception with <code>exc_info=False</code> - there is another error: <code>TRY401 Redundant exception object included in logging.exception call</code>:</p>
<pre><code class="language-python">import logging


logger = logging.getLogger('stream.logger')


def foo():
    try:
        raise ValueError('error message')
    except Exception as e:
        logger.error('Found handled error: %s', e)
        logger.error('Found handled error: %s', e, exc_info=False)
        logger.exception('Found handled error: %s', e, exc_info=False)
        logger.exception('Found handled error: %s', str(e), exc_info=False)
</code></pre>
<pre><code>$ ruff &quot;ruff_errors/TRY400.py&quot; --select=TRY400,TRY401
ruff_errors/TRY400.py:11:9: TRY400 Use `logging.exception` instead of `logging.error`
ruff_errors/TRY400.py:12:9: TRY400 Use `logging.exception` instead of `logging.error`
ruff_errors/TRY400.py:13:53: TRY401 Redundant exception object included in `logging.exception` call
ruff_errors/TRY400.py:14:57: TRY401 Redundant exception object included in `logging.exception` call
Found 4 errors.
</code></pre>
<p>I agree that it is often necessary to log only text without traceback using the <code>.error()</code> method</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/saippuakauppias">@saippuakauppias</a> on 2023-06-15 13:39</div>
            <div class="timeline-body"><p>But in this case the log will also be traceback, and I do not need it</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-06-15 13:43</div>
            <div class="timeline-body"><p>Hm, I guess if <code>exc_info</code> is set to <code>False</code>, we shouldn't raise &quot;Redundant exception object included in call&quot;.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-06-15 13:45</div>
            <div class="timeline-body"><p>Similarly, &quot;Redundant exception object included in call&quot; should be enforced when we log <code>error</code> with <code>exc_info=True</code> (right now, it only logs on <code>exception</code>).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2023-06-15 13:57</div>
            <div class="timeline-body"><blockquote>
<p>Similarly, &quot;Redundant exception object included in call&quot; should be enforced when we log <code>error</code> with <code>exc_info=True</code> (right now, it only logs on <code>exception</code>).</p>
</blockquote>
<p>I believe this should be true for all other log levels as the <code>exc_info</code> parameter is common to all function calls. Additionally, the parameter can also accept exception instances along with a tuple returned by <code>sys.exc_info</code>:</p>
<pre><code>In [4]: try:
   ...:     raise ValueError(&quot;some error&quot;)
   ...: except ValueError as exc:
   ...:     logging.warning(&quot;Error raised: %s&quot;, exc, exc_info=exc)
   ...: 
WARNING:root:Error raised: some error
Traceback (most recent call last):
  File &quot;&lt;ipython-input-4-1428f1d5d721&gt;&quot;, line 2, in &lt;module&gt;
    raise ValueError(&quot;some error&quot;)
ValueError: some error

In [5]: try:
   ...:     raise ValueError(&quot;some error&quot;)
   ...: except ValueError as exc:
   ...:     logging.warning(&quot;Error raised: %s&quot;, exc, exc_info=True)
   ...: 
WARNING:root:Error raised: some error
Traceback (most recent call last):
  File &quot;&lt;ipython-input-5-998582a3cfed&gt;&quot;, line 2, in &lt;module&gt;
    raise ValueError(&quot;some error&quot;)
ValueError: some error

In [7]: try:
   ...:     raise ValueError(&quot;some error&quot;)
   ...: except ValueError as exc:
   ...:     import sys
   ...:     logging.warning(&quot;Error raised: %s&quot;, exc, exc_info=sys.exc_info())
   ...: 
WARNING:root:Error raised: some error
Traceback (most recent call last):
  File &quot;&lt;ipython-input-7-7998fc845097&gt;&quot;, line 2, in &lt;module&gt;
    raise ValueError(&quot;some error&quot;)
ValueError: some error
</code></pre>
<p>Reference: https://docs.python.org/3/library/logging.html?highlight=logging#logging.Logger.debug</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2023-06-15 14:55</div>
            <div class="timeline-body"><p>For what it's worth, I agree <code>logger.exception</code> is not correct to suggest if you are going to raise the exception after and do not want to log the stack trace. In the same way that we suggest you should use <code>logger.exception</code> to set <code>exc_info=True</code>, you should use <code>logger.error</code> to set <code>exc_info=False</code>. Using <code>logger.exception</code> then opting back out of <code>exc_info</code> is weird.</p>
<p>In part, I may have qualms with <code>TRY400</code> itself. If I do <code>logger.error(&quot;foo&quot;, exc_info=True)</code> it should be corrected to <code>logger.exception(&quot;foo&quot;)</code> but it is pretty common to want to write error logs in an exception handler without including the stack trace. Is there another rule that just covers that narrower conversion?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">needs-decision</span> added by @charliermarsh on 2023-07-10 01:15</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">question</span> removed by @charliermarsh on 2023-07-10 01:15</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">rule</span> added by @charliermarsh on 2023-07-10 01:15</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/jankatins">@jankatins</a> on 2023-12-18 11:14</div>
            <div class="timeline-body"><p>Another bad case: when the log is followed by a <code>sys.exit()</code>:</p>
<pre><code class="language-py"># In an optional script
try:
    import ....
except ImportError:
    msg = &quot;Dependencies are missing: run `poetry install --with &lt;dependency group&gt; --sync`&quot;
    logger.error(msg) # noqa: TRY400
    sys.exit(1)
</code></pre>
<p>I specifically do NOT want the whole stacktrace here because it makes figuring out what to do harder than just seeing the specific instruction here.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "TRY400 flags log.error() + raise" to "TRY400 flags log.error() + raise/sys.exit()" by @jankatins on 2023-12-18 11:16</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/bcyran">@bcyran</a> on 2024-10-17 13:15</div>
            <div class="timeline-body"><p>I just want to say that I wholeheartedly agree with @zanieb's stance on this. <code>TRY400</code> should not be reported for exceptions which are immediately re-raised. It would be very nice to see this issue picked up again.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/woutervh">@woutervh</a> on 2025-01-13 10:19</div>
            <div class="timeline-body"><p>Personally I find this a weird rule that I strongly disagree with.</p>
<p>I always avoid <code>logger.exception</code>, as it is not a loglevel <code>logger.&lt;loglevel&gt;</code></p>
<p>My best practice is to use <code>logger.error(..., exc_info=True|False)</code>.
It's more consistent, more explicit.
You can even use different loglevels .
And you can easily make showing the traceback conditional.</p>
<p>Most people use logger.exception because they don't know about <code>exc_info=True|False</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/thisisarko">@thisisarko</a> on 2025-12-22 21:04</div>
            <div class="timeline-body"><p>Noting this has been quiet for a while, but I think this rule could still be valuable for some users. The key divergence from the upstream tryceratops rule that would make it especially useful is adding a few more contextual checks when enforcing it. A custom rule could also work. From what I could gather, these should be good.</p>
<ol>
<li>If the exception block contains a <code>raise</code>, pass the rule.</li>
<li>If the exception block contains a <code>return</code>?</li>
<li>If it calls <code>sys.exit()</code> or otherwise terminates the program: debatable. I understand @jankatins's point, but I’d still prefer a failure in this case. Opting out is always possible via <code># noqa</code>, so I don’t think this should be a default exclusion.</li>
<li>Per https://github.com/astral-sh/ruff/issues/18070, allow the rule to pass if there is at least one <code>logger.exception()</code> call within the exception context.</li>
</ol>
<p>All these could also possibly be made configurable in a <code>lint.try</code> section.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 16:47:05 UTC
    </footer>
</body>
</html>
