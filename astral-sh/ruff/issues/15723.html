<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[`flake8-type-checking`] False positives/negatives for TC001-004 for overlapping module imports - astral-sh/ruff #15723</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[`flake8-type-checking`] False positives/negatives for TC001-004 for overlapping module imports</h1>

    <div class="meta">
        <span class="state state-open">Open</span>
        <a href="https://github.com/astral-sh/ruff/issues/15723">#15723</a>
        opened by <a href="https://github.com/Daverball">@Daverball</a>
        on 2025-01-24 16:13
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/Daverball">@Daverball</a> on 2025-01-24 16:13</div>
            <div class="timeline-body"><h3>Description</h3>
<p>This bug was discovered in #15719</p>
<p>Given something like:</p>
<pre><code class="language-python">from __future__ import annotations

import importlib.abc
from typing import TYPE_CHECKING

if TYPE_CHECKING:
    import importlib.machinery

class Foo(importlib.abc.MetaPathFinder):
    def bar(self) -&gt; importlib.machinery.ModuleSpec: ...
</code></pre>
<p><code>importlib.machinery</code> will incorrectly be flagged with <code>TC004</code>, since <code>importlib.abc.MetaPathFinder</code> binds to the same binding as <code>importlib.machinery.ModuleSpec</code>, so since the former is used at runtime, it thinks that <code>importlib.machinery</code> needs to be moved outside the <code>TYPE_CHECKING</code> block.</p>
<p>Combining the two imports into a shared binding makes sense, since what will be looked up is <code>importlib</code> and not <code>importlib.machinery</code> or <code>importlib.abc</code>.</p>
<p>This means that when we're checking the import bindings we need to expand the single <code>importlib</code> binding to its two import statements <code>importlib.abc</code> and <code>importlib.machinery</code> and for each reference check which of the two imports will actually be relevant.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @MichaReiser on 2025-01-24 17:34</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/16186.html">astral-sh/ruff#16186</a> on 2025-02-16 15:25</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/13965.html">astral-sh/ruff#13965</a> on 2025-04-10 09:16</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/coredumperror">@coredumperror</a> on 2025-12-04 00:13</div>
            <div class="timeline-body"><p>Could this possibly be why I'm getting <code>TC004</code> from the following code?</p>
<pre><code class="language-python">from typing import TYPE_CHECKING
from django.urls import reverse_lazy

if TYPE_CHECKING:
    from django_stubs_ext import StrOrPromise


class ApplicationTable:

    #: The URL to submit form actions to
    form_url: StrOrPromise = reverse_lazy(&quot;operations:applications--actions&quot;)
</code></pre>
<p>https://play.ruff.rs/d3e8ee0f-a7ba-477c-964c-d59bda9c396d</p>
<p>It doesn't seem to make any sense that this would be triggering TC004.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../snok/flake8-type-checking/issues/205.html">snok/flake8-type-checking#205</a> on 2025-12-04 00:23</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Daverball">@Daverball</a> on 2025-12-04 06:59</div>
            <div class="timeline-body"><p>No, it makes perfect sense that this would emit <code>TC004</code>.</p>
<p>It's because your target version is Python 3.9 and you're not using <code>from __future__ import annotations</code>, so all annotations are evaluated at runtime, so this code will fail with a <code>NameError</code> at runtime if you run it with Python 3.9 - 3.13, it only works like this on Python 3.14.</p>
<p>Overlapping imports are only a concern if you import entire submodules from the same parent package.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:34:54 UTC
    </footer>
</body>
</html>
