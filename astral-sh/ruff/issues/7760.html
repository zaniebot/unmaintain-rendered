<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AST Improvement: Store dotted name parts - astral-sh/ruff #7760</title>
    <link rel="stylesheet" href="../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../index.html">Back to index</a>
    </div>

    <h1>AST Improvement: Store dotted name parts</h1>

    <div class="meta">
        <span class="state state-open">Open</span>
        <a href="https://github.com/astral-sh/ruff/issues/7760">#7760</a>
        opened by <a href="https://github.com/konstin">@konstin</a>
        on 2023-10-02 09:50
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/konstin">@konstin</a> on 2023-10-02 09:50</div>
            <div class="timeline-body"><p>Currently, the path of imports is not formatted, e.g.</p>
<pre><code class="language-python">import a . b
</code></pre>
<p>remains as-is. This is due to a bug in our AST:</p>
<p>https://github.com/astral-sh/ruff/blob/6824b67f44d8d462f83a727ed8caf100d10c22a6/crates/ruff_python_ast/src/imports.rs#L6-L31</p>
<p>The entire path is represented as a single string, even though it should be dot-separated identifier (the parser calls it <code>DottedName</code>, but then emits an identifier), especially since identifier can not contain dots.</p>
<ul>
<li>[ ] Fix the AST so the import path is a <code>Vec&lt;Identifier&gt;</code> or something similar</li>
<li>[x] Format import paths by removing whitespace (we can't insert parentheses like we do for dotted expressions)</li>
<li>[ ] Check that <code>Identifier</code> is only used for strings matching the rules</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">formatter</span> added by @konstin on 2023-10-02 09:50</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/7744.html">astral-sh/ruff#7744</a> on 2023-10-02 09:51</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">formatter</span> removed by @charliermarsh on 2023-10-02 13:51</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">parser</span> added by @charliermarsh on 2023-10-02 13:51</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-10-02 13:52</div>
            <div class="timeline-body"><p>I think the counterargument is that CPython uses this representation:</p>
<pre><code class="language-python">&gt;&gt;&gt; print(ast.dump(ast.parse(s)))
Module(body=[Import(names=[alias(name='foo.bar')])], type_ignores=[])
</code></pre>
<p>And the ASDL uses the same <code>identifier</code> symbol as in other nodes: https://docs.python.org/3/library/ast.html.</p>
<p>But I care more about the ergonomics and performance than I do exact compatibility with CPython on these decisions. Would need to see what this makes easier or harder.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/7859.html">astral-sh/ruff#7859</a> on 2023-10-09 08:18</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-10-16 07:44</div>
            <div class="timeline-body"><p>@charliermarsh Is my understanding correct that CPython normalizes the identifier name (removes the whitespace)?</p>
<p>I was a bit surprised when I saw this representation first because it's somewhat uncommon (at least in the languages that I have used thus far)â€”especially considering that it re-joins the identifier tokens that the lexer identified.</p>
<p>Are there any upsides in the semantic model to have a single string? I would expect it to be easier to have the individual parts when e.g. resolving imports. The alternative is that we implement a <code>components</code> method similar to Rust's <code>Path::components</code> that returns the individual parts (splitting by string).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone "Formatter: Stable" by @MichaReiser on 2023-10-16 07:44</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-10-16 13:35</div>
            <div class="timeline-body"><p>Yeah it's probably an improvement to store a list of dot-separated segments. There is likely no upside in the semantic model since we always decompose into segments.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "Fix the AST representation of import paths and format imports" to "Format import paths" by @MichaReiser on 2023-10-27 02:11</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">parser</span> removed by @MichaReiser on 2023-10-27 02:11</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">formatter</span> added by @MichaReiser on 2023-10-27 02:11</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-10-27 02:12</div>
            <div class="timeline-body"><p>Let us fix this, regardless of how it gets implemented. Splitting the names in the formatter would be silly, but something we could do.</p>
<p>I think we're at least lucky that the following is not valid</p>
<pre><code class="language-python">import (a # comment
   .b)
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-10-27 02:17</div>
            <div class="timeline-body"><p>I think this actually was fixed, we format it correctly: https://play.ruff.rs/86d1a181-4d27-4bbe-ad13-0c425e1976c0. I think this issue was about changing the AST to better reflect the real structure.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "Format import paths" to "AST Improvement: Store dotted name parts" by @MichaReiser on 2023-10-27 02:28</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">formatter</span> removed by @MichaReiser on 2023-10-27 02:28</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">formatter</span> added by @MichaReiser on 2023-10-27 02:28</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">parser</span> added by @MichaReiser on 2023-10-27 02:28</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Removed from milestone "Formatter: Stable" by @MichaReiser on 2023-10-27 02:28</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">formatter</span> removed by @MichaReiser on 2023-10-27 02:54</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:28:10 UTC
    </footer>
</body>
</html>
