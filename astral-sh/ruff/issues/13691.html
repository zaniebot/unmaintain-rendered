<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audit how we determine whether a file is a &quot;Python source file&quot; - astral-sh/ruff #13691</title>
    <link rel="stylesheet" href="../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../index.html">Back to index</a>
    </div>

    <h1>Audit how we determine whether a file is a &quot;Python source file&quot;</h1>

    <div class="meta">
        <span class="state state-open">Open</span>
        <a href="https://github.com/astral-sh/ruff/issues/13691">#13691</a>
        opened by <a href="https://github.com/AlexWaygood">@AlexWaygood</a>
        on 2024-10-09 13:29
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-10-09 13:29</div>
            <div class="timeline-body"><p>I noticed in #13682 that there's some inconsistency regarding how we determine whether a file is a &quot;Python source file&quot; currently. In the code for <code>ruff server</code> (and the red-knot port of the server), we take care to do case-insensitive matching when figuring out whether something is a notebook file or not:</p>
<p>https://github.com/astral-sh/ruff/blob/5b4afd30caebd6e2c5c27bbf5debc1663cbb28a2/crates/ruff_server/src/session/index.rs#L124-L126</p>
<p>https://github.com/astral-sh/ruff/blob/5b4afd30caebd6e2c5c27bbf5debc1663cbb28a2/crates/red_knot_server/src/session/index.rs#L75-L79</p>
<p>Elsewhere, however, we mostly use case-sensitive matching:</p>
<p>https://github.com/astral-sh/ruff/blob/5b4afd30caebd6e2c5c27bbf5debc1663cbb28a2/crates/ruff_python_ast/src/lib.rs#L91-L101</p>
<p>https://github.com/astral-sh/ruff/blob/5b4afd30caebd6e2c5c27bbf5debc1663cbb28a2/crates/red_knot_python_semantic/src/module_resolver/path.rs#L41-L60</p>
<p>For places like the red-knot module resolver, it's likely correct to do case-sensitive matching (Python recognises <code>foo.py</code> as an importable module, but not <code>foo.PY</code>), but in other places it may not be. We should audit the code to make sure we're using case-sensitive matching and case-insensitive matching for file extensions in the correct places. We should also add comments to the places where there might be a subtle reason why case-(in)sensitive matching is required, rather than vice versa.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone "v0.8" by @AlexWaygood on 2024-10-09 13:29</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/13682.html">astral-sh/ruff#13682</a> on 2024-10-09 13:29</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-10-09 13:38</div>
            <div class="timeline-body"><blockquote>
<p>For places like the red-knot module resolver, it's likely correct to do case-sensitive matching (Python recognises foo.py as an importable module, but not foo.PY</p>
</blockquote>
<p>Note: I think that depends on the file system's case sensitivity.</p>
<p>Other than that. I think we should ignore casing when matching files because that's what most desktop environments to. They use the same application to open a <code>test.jpg</code> or <code>test.JPG</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">cli</span> added by @MichaReiser on 2024-10-09 13:38</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-10-09 13:44</div>
            <div class="timeline-body"><p>Here, for example, we might want to continue to do case-sensitive matching, since the rule only applies to the names of Python modules that are intended to be importable by other Python modules: https://github.com/astral-sh/ruff/blob/5b4afd30caebd6e2c5c27bbf5debc1663cbb28a2/crates/ruff_linter/src/rules/pep8_naming/rules/invalid_module_name.rs#L51-L59</p>
<p>If a <code>FOO.PY</code> module can't be imported due to the fact that it uses a <code>.PY</code> extension on a case-sensitive file system, then the name of the file isn't really relevant to any PEP-8 concerns, as it's not a module (even if it might be a Python file). The rule is <code>invalid-module-name</code>, not <code>invalid-python-file-name</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-10-10 05:09</div>
            <div class="timeline-body"><p>There's also this issue https://github.com/astral-sh/ruff-vscode/issues/574 related to the server although not sure if this affects that.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/hauntsaninja">@hauntsaninja</a> on 2024-10-20 05:11</div>
            <div class="timeline-body"><p>Fwiw mypy has some special handling in a few places to be case sensitive even on case insensitive file systems</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Removed from milestone "v0.8" by @AlexWaygood on 2024-11-18 11:37</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone "v0.9" by @AlexWaygood on 2024-11-18 11:37</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Removed from milestone "v0.9" by @MichaReiser on 2025-01-08 13:35</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone "v.0.10" by @MichaReiser on 2025-01-08 13:35</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../astral-sh/ty/issues/189.html">astral-sh/ty#189</a> on 2025-02-28 13:22</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-02-28 13:31</div>
            <div class="timeline-body"><p>I think this is the relevant code in mypy:</p>
<p>https://github.com/python/mypy/blob/c32d11e60f04a0798292c438186199ccdec0db61/mypy/fscache.py#L185-L243</p>
<p>Both methods are called from within module resolution. @AlexWaygood and @carljm any chance you know how Python detects the real casing of a file in its module resolver?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-02-28 13:40</div>
            <div class="timeline-body"><p>I think I found it:</p>
<p>https://github.com/python/cpython/blob/9f0879baf15fdcf89f1b85cc244d596d4d0f4e47/Lib/importlib/_bootstrap_external.py#L1411-L1440</p>
<p>It seems Python indexes module on a per directory basis and uses <code>listdir</code> to get the real casing of files.</p>
<p>It does seem that the extension casing is ignored, at least on windows</p>
<p>https://github.com/python/cpython/blob/9f0879baf15fdcf89f1b85cc244d596d4d0f4e47/Lib/importlib/_bootstrap_external.py#L1425-L1438</p>
<p>Python assumes entire platforms as case sensitive or insensitive even though a mounted FAT partition on linux is case sensitive and macOs and both NTFS and macos can be configured to be case sensitive</p>
<p>https://github.com/python/cpython/blob/9f0879baf15fdcf89f1b85cc244d596d4d0f4e47/Lib/importlib/_bootstrap_external.py#L54-L76</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-02-28 13:58</div>
            <div class="timeline-body"><blockquote>
<p>Python assumes entire platforms as case sensitive or insensitive</p>
</blockquote>
<p>I don't think this is really true, or it's only sort of true. The platform checking code you linked does not automatically determine any default case handling. It is purely for determining whether the legacy <code>PYTHONCASEOK</code> environment variable (which makes imports  case insensitive) is available or not. Historically this was platform specific and there's no desire to make it more broadly available, because it's discouraged to use it. So some platforms just don't support that option.</p>
<p>The case insensitive suffix handling on Windows is a similar story. It was a legacy feature added on windows a long time ago and it is preserved on windows to avoid breakage there, but there is no desire to ever expand it to any other platform.</p>
<p>So in both these cases, there aren't assumptions about case sensitivity made that would cause a bug if there's a case sensitive file systems on Windows or non case sensitive file systems on Linux. There are just certain case-related legacy features that are documented as only available on certain platform(s).</p>
<p>I think if you ignore these two legacy features, the story for Python imports is pretty simple: imports are always case sensitive, based on needing to match what <code>listdir</code> returns.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-02-28 14:04</div>
            <div class="timeline-body"><p>Oh right, there's an <code>os.environ</code> check when building the <code>relaxed</code> thingy.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Removed from milestone "v0.10" by @MichaReiser on 2025-03-10 13:58</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone "v0.11" by @MichaReiser on 2025-03-10 13:58</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Removed from milestone "v0.12" by @ntBre on 2025-06-10 20:38</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone "v0.13" by @ntBre on 2025-06-10 20:38</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Removed from milestone "v0.13" by @ntBre on 2025-09-05 13:06</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone "v0.14" by @ntBre on 2025-09-05 13:06</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/20458.html">astral-sh/ruff#20458</a> on 2025-09-18 07:36</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Removed from milestone "v0.14" by @ntBre on 2025-10-02 12:39</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone "v0.15" by @ntBre on 2025-10-02 12:39</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:28:14 UTC
    </footer>
</body>
</html>
