<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Strange fix behavior for UP006/NonPEP585Annotation fixer since ruff 0.8.5 - astral-sh/ruff #15245</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Strange fix behavior for UP006/NonPEP585Annotation fixer since ruff 0.8.5</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/ruff/issues/15245">#15245</a>
        opened by <a href="https://github.com/oprypin">@oprypin</a>
        on 2025-01-03 23:38
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/oprypin">@oprypin</a></div>
            <div class="timeline-body"><p>I am reporting strange behaviors since ruff 0.8.5. I have not tried ruff from master branch.</p>
Example 1
<p>Example file <code>test.py</code>:</p>
<pre><code>import collections
import collections.abc
from typing import Callable, Iterable


def test(a: Iterable[str], b: Callable[[str], None]):
    return collections.ChainMap()
</code></pre>
<p>Command:</p>
<pre><code>ruff --isolated check --target-version=py39 --select=UP006,UP035 --preview --fix --unsafe-fixes test.py
</code></pre>
<ul>
<li><p>File content after ruff 0.8.4 applied:
(doesn&#x27;t fix <code>Callable</code> because it&#x27;s <a href="https://github.com/astral-sh/ruff/issues/15246#issuecomment-2569970746">marked as py310+</a>)</p>
<pre><code>import collections
import collections.abc
from typing import Callable
from collections.abc import Iterable


def test(a: Iterable[str], b: Callable[[str], None]):
    return collections.ChainMap()
</code></pre>
</li>
<li><p>File content after ruff 0.8.5 applied:
(weird!! explicit reference to <code>collections.abc.Callable</code>)</p>
<pre><code>import collections
import collections.abc
from typing import Callable
from collections.abc import Iterable


def test(a: Iterable[str], b: collections.abc.Callable[[str], None]):
    return collections.ChainMap()
</code></pre>
</li>
</ul>
<hr>
Example 2
<p>Example file <code>test.py</code>:</p>
<pre><code>from typing import Callable, Iterable


def test(a: Iterable[str], b: Callable[[str], None]):
    pass
</code></pre>
<p>Command:</p>
<pre><code>ruff --isolated check --target-version=py39 --select=UP006,UP035 --preview --fix --unsafe-fixes test.py
</code></pre>
<ul>
<li><p>File content after ruff 0.8.4 applied:</p>
<pre><code>from typing import Callable
from collections.abc import Iterable


def test(a: Iterable[str], b: Callable[[str], None]):
    pass
</code></pre>
</li>
<li><p>File content after ruff 0.8.5 applied:</p>
<p>Same, but with this additional output:</p>
<pre><code>error: Failed to create fix for NonPEP585Annotation: Unable to insert `Iterable` into scope due to name conflict
error: Failed to create fix for NonPEP585Annotation: Unable to insert `Callable` into scope due to name conflict
error: Failed to create fix for NonPEP585Annotation: Unable to insert `Callable` into scope due to name conflict
test.py:5:31: UP006 Use `collections.abc.Callable` instead of `Callable` for type annotation
  |
5 | def test(a: Iterable[str], b: Callable[[str], None]):
  |                               ^^^^^^^^ UP006
6 |     pass
  |
  = help: Replace with `collections.abc.Callable`

Found 2 errors (1 fixed, 1 remaining).
</code></pre>
<p>This was referenced in #15229
but the description of the &quot;fix&quot; for that issue seems to imply that the error messages themselves are the only problem, which I think is not right.
Ruff should be able to replace <code>from typing import Callable</code>.</p>
</li>
</ul>
<hr>
Example 3
<p>Example file <code>test.py</code>:</p>
<pre><code>from __future__ import annotations

from typing import Callable, Iterable


def test(a: Iterable[str], b: Callable[[str], None]):
    pass
</code></pre>
<p>Command: (note <code>py38</code> here, unlike all other examples)</p>
<pre><code>ruff --isolated check --target-version=py38 --select=UP006,UP035 --preview --fix --unsafe-fixes test.py
</code></pre>
<ul>
<li><p>File content after ruff 0.8.4 applied:</p>
<p>No change, no errors</p>
</li>
<li><p>File content after ruff 0.8.5 applied:</p>
<p>No change, but with this additional output (why does it fail to perform the fixes here??):</p>
<pre><code>error: Failed to create fix for NonPEP585Annotation: Unable to insert `Iterable` into scope due to name conflict
error: Failed to create fix for NonPEP585Annotation: Unable to insert `Callable` into scope due to name conflict
test.py:6:13: UP006 Use `collections.abc.Iterable` instead of `Iterable` for type annotation
  |
6 | def test(a: Iterable[str], b: Callable[[str], None]):
  |             ^^^^^^^^ UP006
7 |     return collections.ChainMap()
  |
  = help: Replace with `collections.abc.Iterable`

test.py:6:31: UP006 Use `collections.abc.Callable` instead of `Callable` for type annotation
  |
6 | def test(a: Iterable[str], b: Callable[[str], None]):
  |                               ^^^^^^^^ UP006
7 |     return collections.ChainMap()
  |
  = help: Replace with `collections.abc.Callable`

Found 2 errors.
</code></pre>
</li>
</ul>
Example 4
<p>Example file <code>test.py</code>:</p>
<pre><code>from __future__ import annotations

import collections
import collections.abc
from typing import Callable, Iterable


def test(a: Iterable[str], b: Callable[[str], None]):
    return collections.ChainMap()
</code></pre>
<p>Command:</p>
<pre><code>ruff --isolated check --target-version=py39 --select=UP006,UP035 --preview --fix --unsafe-fixes test.py
</code></pre>
<ul>
<li><p>File content after ruff 0.8.4 applied:</p>
<pre><code>from __future__ import annotations

import collections
import collections.abc
from typing import Callable
from collections.abc import Iterable


def test(a: Iterable[str], b: Callable[[str], None]):
    return collections.ChainMap()
</code></pre>
</li>
<li><p>File content after ruff 0.8.5 applied:
(weirdest one yet!!! changes only one of the two imports, and then proceeds to not even use the imports!!)</p>
<pre><code>from __future__ import annotations

import collections
import collections.abc
from typing import Callable
from collections.abc import Iterable


def test(a: collections.abc.Iterable[str], b: collections.abc.Callable[[str], None]):
    return collections.ChainMap()
</code></pre>
</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-01-04 02:53</div>
            <div class="timeline-body"><p>Thanks for these. At least for Example 1, I think Ruff is avoiding introducing a new import since <code>collections.abc</code> is already in the namespace. I think that one at least is... arguably correct?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dylwil3">@dylwil3</a> on 2025-01-04 03:11</div>
            <div class="timeline-body"><p>This is super helpful, thank you! And apologies for the strange behavior here.</p>
<p>I think the two main things going on are:</p>
<p>First, I wonder if the autofix should first try to remove the bad import so that there&#x27;s less likely to be a name collision when adding the new one.</p>
<p>Second, we can probably be cleverer in the implementation of the helper function that gets imports, and try to search for the most concise import to use if we have both, say, <code>import collections.abc</code> and <code>from collections.abc import ...</code> present.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">fixes</span> added by <a href="https://github.com/dylwil3">@dylwil3</a> on 2025-01-04 03:12</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/oprypin">@oprypin</a> on 2025-01-04 11:08</div>
            <div class="timeline-body"><p>For Example 1, Ruff 0.8.4 is doing what I would expect, and 0.8.5 does not.
Let&#x27;s switch to <code>py310</code> for posterity:</p>
<pre><code>$ ruff --isolated check --target-version=py310 --select=UP006,UP035,F401 --preview --fix --unsafe-fixes test.py
</code></pre>
<ul>
<li>File content after ruff 0.8.4 applied:<pre><code>import collections
import collections.abc
from typing import Callable, Iterable


def test(a: Iterable[str], b: Callable[[str], None]):
    return collections.ChainMap()
</code></pre>
</li>
<li>File content after ruff 0.8.5 applied:<pre><code>import collections
import collections.abc


def test(a: collections.abc.Iterable[str], b: collections.abc.Callable[[str], None]):
  return collections.ChainMap()
</code></pre>
</li>
</ul>
<p>Well, in <strong>all</strong> of the above cases, Ruff 0.8.4 is doing what I would expect, I just didn&#x27;t realize why there was a difference with <code>Callable</code> at first, but now it makes sense, and at <code>py310</code> everything looks perfect to me.</p>
<hr>
<p>I think the fixer should not care whatsoever about an existing import of <code>collections.abc</code> and simply use a direct import.</p>
<p>Consider this related example:</p>
<pre><code>import typing

from typing_extensions import Final

a: Final[str] = typing.cast(str, 123)
</code></pre>
<p>It simply replaces <code>from typing_extensions import Final</code> with <code>from typing import Final</code>, it doesn&#x27;t care that there&#x27;s a <code>typing</code> import. (and I guess this works correctly because it&#x27;s the  <code>UP035</code> fixer kicking in, not <code>UP006</code>, as it&#x27;s not covered.)</p>
<p>It is my opinion that the fixer should treat additions of <code>from collections.abc</code> imports exactly the same as the additions of <code>from typing</code> imports are treated.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-01-04 12:20</div>
            <div class="timeline-body"><p>Thanks. I reverted the change and published a bugfix release 0.8.6</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/oprypin">@oprypin</a> on 2025-01-04 12:36</div>
            <div class="timeline-body"><p>Thanks a lot!!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dangotbanned">@dangotbanned</a> on 2025-01-04 15:53</div>
            <div class="timeline-body"><p>Thanks for the fix in #15250 @MichaReiser</p>
<p>I resolved these already, but linking the relevant PRs from <code>altair</code> in case they&#x27;re helpful</p>
<ul>
<li>https://github.com/vega/altair/pull/3736</li>
<li>https://github.com/vega/altair/pull/3746</li>
</ul>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 18:49:14 UTC
    </footer>
</body>
</html>
