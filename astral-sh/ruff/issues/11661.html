<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[red-knot] O(1) AST node reference lookup - astral-sh/ruff #11661</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[red-knot] O(1) AST node reference lookup</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/issues/11661">#11661</a>
        opened by <a href="https://github.com/carljm">@carljm</a>
        on 2024-05-31 22:10
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a></div>
            <div class="timeline-body"><p>Definitions need to reference AST nodes, but actual references would require dealing with lifetimes, which is awkward given our database structure. Arc would be another option, but our AST doesn't use it internally, so that doesn't work either.</p>
<p>Currently we use <code>NodeKey</code>, which is just a node kind and text range, and requires binary search (at best) to find the node again. This is too slow.</p>
<p>We could use a struct that wraps an Arc to the root node of the AST and a raw pointer to the exact node. Since the whole AST is transitively owned by the root node, and ASTs are immutable, this can allow us to safely de-reference the raw pointer.</p>
<p>Or another solution might turn up as part of the salsa transition (e.g. we might decide to transform the AST into our own representation, which could use Arc internally?)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by @carljm on 2024-05-31 22:10</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @carljm by @carljm on 2024-05-31 22:10</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-07-17 06:55</div>
            <div class="timeline-body"><p>I did this as part of the salsa refactor</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @MichaReiser on 2024-07-17 06:55</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 16:50:21 UTC
    </footer>
</body>
</html>
