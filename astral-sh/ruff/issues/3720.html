<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>`I001` conflict with autopep8 / pycodestyle's `E302` - astral-sh/ruff #3720</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1><code>I001</code> conflict with autopep8 / pycodestyle&#x27;s <code>E302</code></h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/issues/3720">#3720</a>
        opened by <a href="https://github.com/Avasam">@Avasam</a>
        on 2023-03-24 19:07
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Avasam">@Avasam</a></div>
            <div class="timeline-body"><p>See this minimal reproduction:</p>
<pre><code>from typing import TypedDict, type_check_only


@type_check_only
class GCInputs(TypedDict):
  pass
</code></pre>
<p>Ref: https://peps.python.org/pep-0008/#blank-lines and https://pycodestyle.pycqa.org/en/latest/intro.html?highlight=E302#error-codes</p>
<p><code>I001</code> wants 1 line, <code>E302</code> wants 2.</p>
<p>I use the default <a href="https://beta.ruff.rs/docs/settings/#lines-after-imports">lines-after-imports</a> (so it should be -1)
Is there a way to ignore just <code>lines-after-imports</code> without ignoring the entirety of <a href="https://beta.ruff.rs/docs/rules/unsorted-imports/">I001</a> ?</p>
<p>I&#x27;d like to either let the non-ruff formatter take care of it. Or have Ruff implement <code>E302</code> (<a href="https://github.com/charliermarsh/ruff/issues/2402">charliermarsh/ruff#2402</a>) so it&#x27;s aware of it when linting imports.</p>
<p>Temporary workaround, add a dangling <code>#</code>. May as well link to this issue while I&#x27;m at it:</p>
<pre><code>from typing import TypedDict, type_check_only

# <a href="https://github.com/charliermarsh/ruff/issues/3720">charliermarsh/ruff#3720</a>


@type_check_only
class GCInputs(TypedDict):
  pass
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-03-24 21:04</div>
            <div class="timeline-body"><p>Just trying to make sure I understand -- if I run Ruff over that file, it leaves the import as it is, and <code>pycodestyle</code> doesn&#x27;t complain about it either. Is that not two lines, between the import and the function definition? What am I overlooking? :)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">question</span> added by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-03-24 21:04</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Avasam">@Avasam</a> on 2023-03-24 21:24</div>
            <div class="timeline-body"><p>For me, ruff (0.0.259) formats</p>
<pre><code>from typing import TypedDict, type_check_only  # Import block is un-sorted or un-formatted Ruff(I001)


@type_check_only
class GCInputs(TypedDict):
  pass
</code></pre>
<p>to</p>
<pre><code>from typing import TypedDict, type_check_only

@type_check_only
class GCInputs(TypedDict):
  pass
</code></pre>
<p>Oh, you know what, it&#x27;s a <code>.pyi</code> file, indeed it doesn&#x27;t seem to happen in a <code>.py</code> file.</p>
<p>Also, here&#x27;s my complete ruff config <code>pyproject.toml</code>:</p>
<pre><code># https://beta.ruff.rs/docs/configuration
[tool.ruff]
line-length = 120
select = [&quot;ALL&quot;]
target-version = &quot;py38&quot;
# https://beta.ruff.rs/docs/rules
ignore = [
  ###
  # Not needed or wanted
  ###
  &quot;D1&quot;, # pydocstyle Missing doctring
  &quot;D401&quot;, # pydocstyle: non-imperative-mood
  &quot;EM&quot;, # flake8-errmsg
  &quot;FBT&quot;, # flake8-boolean-trap
  &quot;INP&quot;, # flake8-no-pep420
  &quot;ISC003&quot;, # flake8-implicit-str-concat: explicit-string-concatenation
  &quot;TCH002&quot;, # flake8-type-checking: typing-only-third-party-import
  # Short messages are still considered &quot;long&quot; messages
  &quot;TRY003&quot;, # tryceratops : raise-vanilla-args
  # Don&#x27;t remove commented code, also too inconsistant
  &quot;ERA001&quot;, # eradicate: commented-out-code
  # contextlib.suppress is roughly 3x slower than try/except
  &quot;SIM105&quot;, # flake8-simplify: use-contextlib-suppress
  # Checked by type-checker (pyright)
  &quot;ANN&quot;, # flake-annotations
  &quot;TCH003&quot;, # flake8-type-checking: typing-only-standard-library-import
  # We want D213: multi-line-summary-second-line and D211: no-blank-line-before-class
  &quot;D203&quot;, # pydocstyle: one-blank-line-before-class
  &quot;D212&quot;, # pydocstyle: multi-line-summary-first-line
]

# https://beta.ruff.rs/docs/settings/#flake8-implicit-str-concat
[tool.ruff.flake8-implicit-str-concat]
allow-multiline = false

# https://beta.ruff.rs/docs/settings/#isort
[tool.ruff.isort]
combine-as-imports = true
required-imports = [&quot;from __future__ import annotations&quot;] # Safer with Python 3.8 and 3.9
split-on-trailing-comma = false

# https://beta.ruff.rs/docs/settings/#mccabe
[tool.ruff.mccabe]
# Hard limit, arbitrary to 4 bytes
max-complexity = 31
# Arbitrary to 2 bytes, same as SonarLint
# max-complexity = 15

[tool.ruff.pylint]
# Arbitrary to 1 byte, same as SonarLint
max-args = 7
# At least same as max-complexity
max-branches = 15

# https://github.com/hhatto/autopep8#usage
# https://github.com/hhatto/autopep8#more-advanced-usage
[tool.autopep8]
aggressive = 3
ignore = [
  # TODO Suggest &quot;multi-line method invocation style&quot; to Ruff.
  # <a href="https://github.com/charliermarsh/ruff/issues/3713">charliermarsh/ruff#3713</a>
  &quot;E124&quot;, # Closing bracket may not match multi-line method invocation style (enforced by add-trailing-comma)
  &quot;E402&quot;, # Allow imports at the bottom of file
  &quot;E70&quot;, # Allow ... on same line as def
  &quot;W503&quot;, # Linebreak before binary operator
]
max_line_length = 120
recursive = true
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-03-24 21:25</div>
            <div class="timeline-body"><p>Ahhh yes the rules are slightly different for <code>.pyi</code> files -- but I think we changed that to match Black&#x27;s behavior...</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-03-24 21:50</div>
            <div class="timeline-body"><p>Yeah not sure what we can do here. Black reformats <code>.pyi</code> files this way, so using any other logic here would make Ruff incompatible with Black.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Avasam">@Avasam</a> on 2023-03-24 23:51</div>
            <div class="timeline-body"><p>Not sure either (other than allowing to disable <code>lines-after-imports</code>, since the non-Ruff formatter already takes care of it anyway, which you may or may not want to do). This was already an issue with AutoPep8 and isort anyway, so nothing new for me, but I figured since Ruff has full control over its own rules and checks, maybe something could be done.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/JonathanPlasse">@JonathanPlasse</a> on 2023-03-24 23:54</div>
            <div class="timeline-body"><p>That is the standard for <code>.pyi</code> files, that is what <code>typeshed</code> use.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-03-25 15:43</div>
            <div class="timeline-body"><p>Yeah unfortunately I think this has to be marked as wontfix. I understand the inconvenience but it&#x27;s tough to retain compatibility when the tools conflict.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-03-25 15:43</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Avasam">@Avasam</a> on 2023-03-25 16:14</div>
            <div class="timeline-body"><p>I understand, thanks for considering!</p>
<p>Black is great for stub files, because they don&#x27;t have any logic. But I don&#x27;t like it for regular python code because it too often makes some code (especially functional / method-chaining style) less consistent and less readable without any control. (personal preference y&#x27;know, that&#x27;s why there&#x27;s less opinionated options ðŸ˜›)</p>
<p>Granted I also don&#x27;t particularly care about <code>E302</code> either, disabling it could lead to inconsistent 1 vs 2 lines above classes, but it still removes extra lines (3+, 2+ above non-classes).</p>
<p>Since this conflict only affects <code>.pyi</code> files starting with both imports and classes, and that adding stubs to a non-stub, non-library project is pretty rare (either I&#x27;m patching a stub until it&#x27;s fixed/published upstream, or I&#x27;m vendoring something really niche). The dangling comment after imports is a perfectly acceptable solution for me ðŸ˜„
<img src="https://user-images.githubusercontent.com/1350584/227728950-89aab228-4f10-41d4-a6ab-5715d055bebe.png" alt="image"></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-03-25 16:15</div>
            <div class="timeline-body"><p>Thanks for your understanding and for bearing with me as we talked through this :)</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 18:48:34 UTC
    </footer>
</body>
</html>
