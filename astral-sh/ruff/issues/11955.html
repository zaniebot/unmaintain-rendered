<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ruff with `--diff` exits 0 on errors with no diffs - astral-sh/ruff #11955</title>
    <link rel="stylesheet" href="../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../index.html">Back to index</a>
    </div>

    <h1>ruff with `--diff` exits 0 on errors with no diffs</h1>

    <div class="meta">
        <span class="state state-open">Open</span>
        <a href="https://github.com/astral-sh/ruff/issues/11955">#11955</a>
        opened by <a href="https://github.com/wyardley">@wyardley</a>
        on 2024-06-20 20:42
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/wyardley">@wyardley</a> on 2024-06-20 20:42</div>
            <div class="timeline-body"><p>Using <code>--diff</code> flag with no possible changes seems to result in a 0 exit code and no message (or error), regardless of whether there are errors, formatting changes, and whether or not those are fixable. While these may not be intended to be used together (and while it is noted that <code>--diff</code> implies <code>--fix-only</code>, it wasn't immediately obvious that this behavior would happen since the docs mention reporting, but not exit status), I came across a situation where someone had used <code>--diff</code> and <code>--fix</code> together -- see https://github.com/python-semantic-release/python-semantic-release/pull/961 and https://github.com/python-semantic-release/python-semantic-release/pull/957</p>
<p>To me, the expected behavior would be to have a way for the tool to still exit non-0 if any findings are present. If the flags are not expected to be used together, an error to that effect (and non-0 exit) would also be fine.</p>
<p>Note that <code>--diff</code> on its own <em>does</em> have the expected behavior</p>
<p>I think maybe part of the issue is that <code>ruff --diff</code> is only exiting 1 if there is a diff, which is maybe sensible, just confusing in this case. Maybe we need a <code>--exit-non-zero-on-error</code> as well as the existing <code>--exit-non-zero-on-fix</code> flag and / or a clarification on this point in the docs for <code>--diff</code>?</p>
<p>I'm not sure what the person who set this [the pipeline above] up originally thought / wanted, but presumably they wanted to both print the changes, if any, that would be made by <code>ruff --fix</code> <em>and</em> track whether any findings came up.</p>
<ul>
<li>List of keywords you searched for before creating this issue. Write them down here so that others can find this issue more easily and help provide feedback.</li>
</ul>
<ul>
<li>&quot;diff&quot;</li>
<li>&quot;diff fix&quot;</li>
</ul>
<ul>
<li>A minimal code snippet that reproduces the bug.</li>
</ul>
<pre><code class="language-python">import os.path as OSPATH

is_path = OSPATH.isdir(&quot;/tmp&quot;)
print(f&quot;Hello world {is_path}&quot;)
</code></pre>
<ul>
<li>The command you invoked (e.g., <code>ruff /path/to/file.py --fix</code>), ideally including the <code>--isolated</code> flag.</li>
</ul>
<pre><code class="language-shell">$ ruff check test_ruff.py --diff --fix --output-format=full --exit-non-zero-on-fix
$ echo $?
0
$ ruff check test_ruff.py --diff --fix
$ echo $?
0
</code></pre>
<ul>
<li>The current Ruff settings (any relevant sections from your <code>pyproject.toml</code>)
Not sure if it's strictly necessary, but for the above to work, a rule that will trip and won't trigger any diff (e.g., <code>N812</code>) has to be enabled.</li>
</ul>
<pre><code class="language-toml">[lint]
select = [&quot;N812&quot;]
</code></pre>
<ul>
<li>The current Ruff version (<code>ruff --version</code>).
<code>ruff 0.4.9</code></li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "Conflict between --diff and --fix flags" to "Ruff --diff exits 0 on errors" by @wyardley on 2024-06-20 22:10</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "Ruff --diff exits 0 on errors" to "ruff with `--diff` exits 0 on errors" by @wyardley on 2024-06-20 22:10</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "ruff with `--diff` exits 0 on errors" to "ruff with `--diff` exits 0 on errors with no diffs" by @wyardley on 2024-06-20 22:17</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/11959.html">astral-sh/ruff#11959</a> on 2024-06-21 05:47</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @MichaReiser on 2024-06-21 06:13</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Reopened by @MichaReiser on 2024-06-21 06:14</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">cli</span> added by @MichaReiser on 2024-06-21 06:14</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-06-21 06:18</div>
            <div class="timeline-body"><p>Thanks for opening this issue and also creating a PR to improve the documentation.</p>
<p>We share your sentiment that <code>--diff</code> is confusing and we have a few ideas on how to improve the usability but haven't had time to implement it:</p>
<ul>
<li>Change the default output format to show fixes.</li>
<li>Introduce a new <code>ruff fix</code> command that only applies fixes. Remove the <code>--diff</code> option from <code>ruff --check</code>. I think this should remove the confusion that you're experiencing because it's then more clear that <code>fix</code> should only fail if fixing failed, not if there are any other unfixed violations.</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/wyardley">@wyardley</a> on 2024-06-21 06:27</div>
            <div class="timeline-body"><p>That makes sense, thanks! It took a few passes for me to untangle the layers here, hence all the edits. The behavior wasn’t quite what I originally would have expected, but it all makes sense to me now.</p>
<p>I agree that a separate subcommand could work, though the feature of being able to check and fix in one pass is convenient for things like pre-commit hooks, even if ruff is fast enough that running twice in and of itself shouldn’t normally matter.</p>
<p>Happy to either keep this open or close it as you like.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-06-21 08:31</div>
            <div class="timeline-body"><blockquote>
<p>I agree that a separate subcommand could work, though the feature of being able to check and fix in one pass is convenient for things like pre-commit hooks, even if ruff is fast enough that running twice in and of itself shouldn’t normally matter.</p>
</blockquote>
<p>We consider to keep <code>ruff check --fix</code> but without the <code>--diff</code> option and the default <code>output-format</code> would show the fixes (at least for the diagnostics for which no fixes exist)</p>
<p>I'll keep it open because it helps us prioritize (knowing that this is something user actually ran into)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Hoolean">@Hoolean</a> on 2025-12-16 16:24</div>
            <div class="timeline-body"><p>Hello all! Thanks for the explanations above : )</p>
<p>We encountered this in the wild too: the ideal we were aiming towards was to have <strong>all</strong> issues be reported, but with those that were auto-fixable furnished with their diffs in the CI log too.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:28:13 UTC
    </footer>
</body>
</html>
