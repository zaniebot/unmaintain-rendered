<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ruff check --fix changes Jupyter notebook output data - astral-sh/ruff #10380</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>ruff check --fix changes Jupyter notebook output data</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/ruff/issues/10380">#10380</a>
        opened by <a href="https://github.com/dionhaefner">@dionhaefner</a>
        on 2024-03-13 10:39
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/dionhaefner">@dionhaefner</a> on 2024-03-13 10:39</div>
            <div class="timeline-body"><p>Notebook to reproduce:</p>
<p><a href="https://github.com/astral-sh/ruff/files/14586302/ruff-bug.ipynb.json">ruff-bug.ipynb.json</a></p>
<p>Script demonstrating the bug:</p>
<pre><code class="language-bash">$ cp ruff-bug.ipynb ruff-bug-reformatted.ipynb
$ ruff check --isolated --fix ruff-bug-reformatted.ipynb
$ diff ruff-bug.ipynb ruff-bug-reformatted.ipynb
</code></pre>
<p>Output:</p>
<pre><code class="language-diff">Found 1 error (1 fixed, 0 remaining).
9,10c9
&lt;     &quot;# unusued import, to give ruff something to fix\n&quot;,
&lt;     &quot;import os&quot;
---
&gt;     &quot;# unusued import, to give ruff something to fix&quot;
72c71
&lt;           0.022936753928661346,
---
&gt;           0.022936753928661343,
98c97
&lt;           0.16423597931861877
---
&gt;           0.16423597931861875
147c146
&lt;           0.022936753928661346,
---
&gt;           0.022936753928661343,
173c172
&lt;           0.16423597931861877
---
&gt;           0.16423597931861875
223c222
&lt;           0.022936753928661346,
---
&gt;           0.022936753928661343,
249c248
&lt;           0.16423597931861877
---
&gt;           0.16423597931861875
</code></pre>
<p>All fixes except the unused import are applied to cell <em>output</em> which should never be reformatted.</p>
<p>Tested with ruff 0.3.2.</p>
<!--
Thank you for taking the time to report an issue! We're glad to have you involved with Ruff.

If you're filing a bug report, please consider including the following information:

* List of keywords you searched for before creating this issue. Write them down here so that others can find this issue more easily and help provide feedback.
  e.g. "RUF001", "unused variable", "Jupyter notebook"
* A minimal code snippet that reproduces the bug.
* The command you invoked (e.g., `ruff /path/to/file.py --fix`), ideally including the `--isolated` flag.
* The current Ruff settings (any relevant sections from your `pyproject.toml`).
* The current Ruff version (`ruff --version`).
-->

</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-03-13 11:31</div>
            <div class="timeline-body"><p>Thanks for the report. Ruff does't look at the <code>outputs</code> field, it only updates the <code>source</code> field which is where the source code is which makes this bug a bit weird. It could be that the deserialization is causing this change. I'll need to look into it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @dhruvmanila on 2024-03-13 11:31</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">notebook</span> added by @dhruvmanila on 2024-03-13 11:31</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-03-13 11:38</div>
            <div class="timeline-body"><p>Yeah, it's while deserializing the JSON string when the number is being updated. It can be reproduced using the given notebook with the following patch:</p>
<pre><code class="language-diff">diff --git a/crates/ruff_notebook/src/notebook.rs b/crates/ruff_notebook/src/notebook.rs
index fef73cd85..1bdc9209d 100644
--- a/crates/ruff_notebook/src/notebook.rs
+++ b/crates/ruff_notebook/src/notebook.rs
@@ -186,7 +186,7 @@ impl Notebook {
         }
 
         Ok(Self {
-            raw: raw_notebook,
+            raw: dbg!(raw_notebook),
             index: OnceCell::new(),
             // The additional newline at the end is to maintain consistency for
             // all cells. These newlines will be removed before updating the
</code></pre>
<p>And running:</p>
<pre><code class="language-console">cargo dev round-trip /path/to/notebook.ipynb
</code></pre>
<p>It's the same two numbers which are getting updated:</p>
<ol>
<li><code>0.022936753928661346</code> to <code>0.022936753928661343</code></li>
<li><code>0.16423597931861877</code> to <code>0.16423597931861875</code></li>
</ol>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/apaleyes">@apaleyes</a> on 2024-03-18 11:41</div>
            <div class="timeline-body"><p>Hi @dhruvmanila , and thanks for looking into this. Is this something that can/will be fixed on the Ruff side? Maybe there is some workaround to prevent this behaviour from happening while the fix hasn't arrived?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-03-21 02:38</div>
            <div class="timeline-body"><p>I'm not sure. I need to look at it in a bit more detail. I plan to do so this week.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 11:33:07 UTC
    </footer>
</body>
</html>
