<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Update line break heuristic when f-string has conversion flag - astral-sh/ruff #10042</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Update line break heuristic when f-string has conversion flag</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/issues/10042">#10042</a>
        opened by <a href="https://github.com/dhruvmanila">@dhruvmanila</a>
        on 2024-02-19 07:43
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a></div>
            <div class="timeline-body"><p>It seems that the following is an invalid syntax for pre 3.12 even for triple-quoted f-strings:</p>
<pre><code>f&quot;&quot;&quot;fooooooooooooooooooooooooo barrrrrrrrrrrrrrrrrrrrrrrrrr {
    xxxxxxx!s
} aaaaaaaaaaaaaaaaaaaaaa&quot;&quot;&quot;
</code></pre>
<pre><code>$ python3.11 -m ast main.py
Traceback (most recent call last):
  File &quot;&lt;frozen runpy&gt;&quot;, line 198, in _run_module_as_main
  File &quot;&lt;frozen runpy&gt;&quot;, line 88, in _run_code
  File &quot;/Users/dhruv/.pyenv/versions/3.11.7/lib/python3.11/ast.py&quot;, line 1752, in &lt;module&gt;
    main()
  File &quot;/Users/dhruv/.pyenv/versions/3.11.7/lib/python3.11/ast.py&quot;, line 1748, in main
    tree = parse(source, args.infile.name, args.mode, type_comments=args.no_type_comments)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File &quot;/Users/dhruv/.pyenv/versions/3.11.7/lib/python3.11/ast.py&quot;, line 50, in parse
    return compile(source, filename, mode, flags,
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File &quot;main.py&quot;, line 5
    } aaaaaaaaaaaaaaaaaaaaaa&quot;&quot;&quot;
                               ^
SyntaxError: f-string: expecting &#x27;}&#x27;
</code></pre>
<p>But, it&#x27;s fine without the conversion flag:</p>
<pre><code>f&quot;&quot;&quot;fooooooooooooooooooooooooo barrrrrrrrrrrrrrrrrrrrrrrrrr {
    xxxxxxx
} aaaaaaaaaaaaaaaaaaaaaa&quot;&quot;&quot;
</code></pre>
<p>The heuristic needs to be updated such that if a conversion flag is present, then we can add line breaks only if it&#x27;s Python 3.12 or later. Care needs to be taken with the fact that in certain scenarios we assume that the target version is 3.12 even if it&#x27;s not provided. This is when there&#x27;s a multiline expression in a single-quoted f-string or a comment.</p>
<p>The same question applies here as mentioned in <a href="https://github.com/astral-sh/ruff/issues/10040">astral-sh/ruff#10040</a> (refer to &quot;Local or Global?&quot; section).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-02-19 07:43</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">formatter</span> added by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-02-19 07:43</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">preview</span> added by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-02-19 07:43</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-04-24 10:42</div>
            <div class="timeline-body"><p>Actually, I don&#x27;t think this is an issue. So, if there&#x27;s already a line break in an expression element of an f-string, the formatter assumes that the user is running it under 3.12 or later which is the reason to add line breaks. And in those versions, this is a valid code.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-04-25 10:16</div>
            <div class="timeline-body"><p>I&#x27;m going to close this issue based on my reasoning above.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-04-25 10:16</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 18:48:50 UTC
    </footer>
</body>
</html>
