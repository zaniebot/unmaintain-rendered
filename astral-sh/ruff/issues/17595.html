<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[red-knot] Failed to narrow in nested function - astral-sh/ruff #17595</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[red-knot] Failed to narrow in nested function</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/issues/17595">#17595</a>
        opened by <a href="https://github.com/dhruvmanila">@dhruvmanila</a>
        on 2025-04-23 22:11
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2025-04-23 22:11</div>
            <div class="timeline-body"><h3>Summary</h3>
<p>Red knot fails to narrow in the following code:</p>
<pre><code class="language-py">def foo(x: str | None):
    def inner():
        if x is not None:
            # Red knot is not narrowing here
            reveal_type(x)  # revealed: str | None

    return inner
</code></pre>
<h3>Version</h3>
<p>00e73dc33</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @dhruvmanila on 2025-04-23 22:11</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by @dhruvmanila on 2025-04-23 22:11</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone "Red Knot Beta" by @carljm on 2025-04-23 22:22</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/mtshiba">@mtshiba</a> on 2025-04-24 10:50</div>
            <div class="timeline-body"><p>The current implementation of narrowing only covers cases where the predicate scope and the definition scope are the same. We need to be able to use predicates of different scopes.</p>
<p>This seems to duplicate some of the work I am doing in astral-sh/ty#164. Because when we want to do instance attribute narrowing, we use instance attribute definition and predicate of attribute access to the variable to which the instance is assigned, but the scopes of the two are generally different.</p>
<pre><code class="language-python">class C:
    def __init__(self):
        # definition
        self.x: int | None = None

c = C()
# predicate
if c.x is not None:
    reveal_type(c.x)  # int
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @carljm on 2025-05-05 23:28</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @carljm on 2025-05-05 23:28</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 11:37:19 UTC
    </footer>
</body>
</html>
