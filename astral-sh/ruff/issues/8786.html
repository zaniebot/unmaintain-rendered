<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PERF102 does not trigger when the loop var is used in a previous loop - astral-sh/ruff #8786</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>PERF102 does not trigger when the loop var is used in a previous loop</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/ruff/issues/8786">#8786</a>
        opened by <a href="https://github.com/ThiefMaster">@ThiefMaster</a>
        on 2023-11-20 13:45
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ThiefMaster">@ThiefMaster</a></div>
            <div class="timeline-body"><pre><code class="language-py">dict_a = {}
dict_b = {}

for loopvar in {}:
    print(dict_a[loopvar])

for loopvar, val in dict_b.items():
    print(val)

for newloopvar, val in dict_b.items():
    print(val)
</code></pre>
<pre><code>$ ruff --isolated --select B007,PERF102 --no-cache rufftest/ruff_sample.py
rufftest/ruff_sample.py:7:5: B007 Loop control variable `loopvar` not used within loop body
rufftest/ruff_sample.py:10:5: B007 Loop control variable `newloopvar` not used within loop body
rufftest/ruff_sample.py:10:24: PERF102 When using only the values of a dict use the `values()` method
Found 3 errors.
No fixes available (2 hidden fixes can be enabled with the `--unsafe-fixes` option).
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "PERF102 does not trigger when the loop var is used previously" to "PERF102 does not trigger when the loop var is used in a previous loop" by @ThiefMaster on 2023-11-20 13:46</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2023-11-20 15:46</div>
            <div class="timeline-body"><p>Hm this seems to be a detail of the <code>SemanticModel::is_unused</code> implementation which will say a variable is used if it is shadowed. For example, this reproduces with the simpler:</p>
<pre><code class="language-python">key = 1
print(key)

for key, val in {}.items():
    print(val)
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2023-11-20 15:49</div>
            <div class="timeline-body"><p>And.. I think we can maybe be considered correct here although it is confusing because <code>key</code> is mutated:</p>
<pre><code class="language-python">key = 1
print(key)

for key, val in {&quot;x&quot;: 1, &quot;y&quot;: 2}.items():
    print(val)

print(key)
</code></pre>
<pre><code>1
1
2
y
</code></pre>
<p>I guess we could check if it's used <em>after</em> the loop but that feels like a separate rule?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ThiefMaster">@ThiefMaster</a> on 2023-11-20 15:52</div>
            <div class="timeline-body"><p>Which, to be fair, is behavior nobody should ever rely upon ;)</p>
<p>TBH, maybe there should be a new rule that warns if you rely on the loop variable leaking outside the loop...</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/T-256">@T-256</a> on 2023-11-20 15:56</div>
            <div class="timeline-body"><blockquote>
<p>I guess we could check if it's used <em>after</em> the loop</p>
</blockquote>
<p>With given example above, PERF102 didn't get line 7. I think that's the expected behavior.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @charliermarsh on 2024-01-05 04:41</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/mikeleppane">@mikeleppane</a> on 2024-02-13 12:52</div>
            <div class="timeline-body"><p>I am working on this.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @mikeleppane by @dhruvmanila on 2024-02-13 13:09</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-02-13 13:12</div>
            <div class="timeline-body"><blockquote>
<p>With given example above, PERF102 didn't get line 7. I think that's the expected behavior.</p>
</blockquote>
<p>Can you explain why? <code>PERF102</code> isn't triggered for the second loop even though the <code>loopvar</code> variable remains unused within the body of that for loop.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/mikeleppane">@mikeleppane</a> on 2024-02-13 14:24</div>
            <div class="timeline-body"><blockquote>
<p>And.. I think we can maybe be considered correct here although it is confusing because <code>key</code> is mutated:</p>
<pre><code class="language-python">key = 1
print(key)

for key, val in {&quot;x&quot;: 1, &quot;y&quot;: 2}.items():
    print(val)

print(key)
</code></pre>
<pre><code>1
1
2
y
</code></pre>
<p>I guess we could check if it's used <em>after</em> the loop but that feels like a separate rule?</p>
</blockquote>
<p>Yep, perhaps the only way to solve this is to ignore possible bindings/references before the <code>for statement</code>. However, I'm not sure whether that requires a new rule? I'm fixing this to the current rule but if you disagree then I guess we can think about a new approach.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 16:49:04 UTC
    </footer>
</body>
</html>
