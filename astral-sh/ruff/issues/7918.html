<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Avoid raising S310 if user explicitly checks for URL scheme - astral-sh/ruff #7918</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Avoid raising S310 if user explicitly checks for URL scheme</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/ruff/issues/7918">#7918</a>
        opened by <a href="https://github.com/93578237">@93578237</a>
        on 2023-10-11 13:59
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/93578237">@93578237</a> on 2023-10-11 13:59</div>
            <div class="timeline-body"><ul>
<li>A minimal code snippet that reproduces the bug.</li>
</ul>
<pre><code class="language-python">import urllib.request


def foo(url: str) -&gt; None:
    if not url.startswith((&quot;https://&quot;, &quot;http://&quot;)):
        raise ValueError
    req = urllib.request.Request(
        url,
        headers=headers,
        data=data,
        method=method,
    )
    resp = urllib.request.urlopen(req)
</code></pre>
<p>Also it would be great if ruff could recognize asserts (like <code>assert url.startswith((&quot;https://&quot;, &quot;http://&quot;))</code>)</p>
<ul>
<li>The command you invoked (e.g., <code>ruff /path/to/file.py --fix</code>), ideally including the <code>--isolated</code> flag.</li>
</ul>
<p>ruff --isolated --select S t.py</p>
<ul>
<li>The current Ruff settings (any relevant sections from your <code>pyproject.toml</code>).</li>
</ul>
<p>No pyproject.toml</p>
<ul>
<li>The current Ruff version (<code>ruff --version</code>).</li>
</ul>
<p>ruff 0.0.292</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/qdegraaf">@qdegraaf</a> on 2023-10-12 12:17</div>
            <div class="timeline-body"><p>Could you clarify why <code>urllib.request.Request</code> should be flagged under S310? <a href="https://bandit.readthedocs.io/en/latest/blacklists/blacklist_calls.html#b310-urllib-urlopen">Bandit's blacklist</a> for the relevant rule does not include it as an issue.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/93578237">@93578237</a> on 2023-10-12 13:26</div>
            <div class="timeline-body"><p>I think s310 should not be triggered because I check the URL in the first lines.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/qdegraaf">@qdegraaf</a> on 2023-10-12 14:01</div>
            <div class="timeline-body"><p>Ah I misunderstood. I thought from your description that the rule was not triggering and it should. But if I understand you correctly now, it is being flagged, and you want to change rule S310 to not flag if the URL passed to it has been checked to start with <code>https://</code> or <code>http://</code> and not say <code>file://</code>. This would not be specific to just <code>urllib.request.Request</code> I take it but all <code>urlopen</code> calls flagged by S310.</p>
<p>@charliermarsh is that something that is desirable to implement or is this something that should be manually marked as a check skip by the dev in question. Docs just suggest:</p>
<pre><code>/// To mitigate this risk, audit all uses of URL open functions and ensure that
/// only permitted schemes are used (e.g., allowing `http:` and `https:` and
/// disallowing `file:` and `ftp:`).
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-10-13 00:52</div>
            <div class="timeline-body"><p>I think this will be hard to get right with absolute certainty and so I'm somewhat hesitant to invest in it given that it's a security-related rule. If someone wants to try, though, I am happy to review it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">wish</span> added by @charliermarsh on 2023-10-13 00:52</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "S310 does not handle urllib.request.Request " to "Avoid raising S310 if user explicitly checks for URL scheme" by @charliermarsh on 2023-10-13 00:52</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-10-18 22:54</div>
            <div class="timeline-body"><p>We now no longer flag this if you use a string literal, which is at least an improvement.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/henryiii">@henryiii</a> on 2023-10-23 22:06</div>
            <div class="timeline-body"><p>What about string literal but not in place? This is currently triggering the warning:</p>
<pre><code class="language-python">url = &quot;https://pypi.org/pypi?:action=list_classifiers&quot;
context = ssl.create_default_context()
with urlopen(url, context=context) as response:
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../zulip/python-zulip-api/pulls/824.html">zulip/python-zulip-api#824</a> on 2024-04-02 12:50</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Hawk777">@Hawk777</a> on 2024-04-15 19:34</div>
            <div class="timeline-body"><p>A string literal passed through <code>Request</code> is also flagged when it ideally shouldn’t be:</p>
<pre><code class="language-python">import urllib

urllib.request.urlopen(urllib.request.Request(&quot;https://example.com/&quot;))
</code></pre>
<p>(obviously in this case I could just pass the string literal directly; in reality, I’m constructing the <code>Request</code> because I have extra headers to add)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-04-16 01:23</div>
            <div class="timeline-body"><p>I can fix a few of these.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @charliermarsh by @charliermarsh on 2024-04-16 01:23</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/10964.html">astral-sh/ruff#10964</a> on 2024-04-16 02:06</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/retu2libc">@retu2libc</a> on 2024-05-29 17:08</div>
            <div class="timeline-body"><p>It would be cool if stuff like</p>
<pre><code class="language-Python">url = f&quot;https://{self.target_url}{self.path}&quot;
</code></pre>
<p>didn't trigger this.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Unassigned @charliermarsh by @charliermarsh on 2024-08-01 00:22</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ViniGodoy">@ViniGodoy</a> on 2024-10-14 13:17</div>
            <div class="timeline-body"><p>I'll upvote this one. I also had to add the noqa, even implementing the same correction described in the <a href="https://docs.astral.sh/ruff/rules/suspicious-url-open-usage/">S310 &quot;use instead&quot; documentation</a>:</p>
<pre><code class="language-python">def fetch(url: str, data=None, headers=None, method=None) -&gt; HTTPResponse | HTTPError:
    headers = headers or {}
    if not url.startswith((&quot;http:&quot;, &quot;https:&quot;)):
        raise ValueError(&quot;URL must start with 'http:' or 'https:'&quot;)
    req = Request(url=url, data=data, headers=headers or {}, method=method)  # noqa: S310
    try:
        return urllib.request.urlopen(req)  # noqa: S310
    except HTTPError as e:
        return e
</code></pre>
<p>Otherwise the linter kept failing asking this same check to be added.</p>
<p>I understand it could not understand some url concatenations, or if this check was done in a separate function. But at least he same use case described in the documentation should ideally be covered.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../digitalfabrik/integreat-cms/pulls/3333.html">digitalfabrik/integreat-cms#3333</a> on 2025-01-22 12:27</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dimaqq">@dimaqq</a> on 2025-02-22 14:33</div>
            <div class="timeline-body"><p>This one's a bit of a nit.</p>
<p>Folks who get the url from settings somewhere must slap <code>#noqa</code> on the call.</p>
<p>That's fine at that point, surely a reasonable developer also added some url schema validation.</p>
<p>But what happens in a year or two? Since <code>#noqa</code> is there and cannot be removed, any refactoring may break or what the validation and none would notice.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-02-23 09:53</div>
            <div class="timeline-body"><p>Yeah, I think we could do better here. E.g. I find it surprising that the rule still raises an error even for the <em>Use instead</em> example in the documentation.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">rule</span> added by @MichaReiser on 2025-02-23 09:53</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">help wanted</span> added by @MichaReiser on 2025-02-23 09:53</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">wish</span> removed by @MichaReiser on 2025-02-23 09:53</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/hunterhogan">@hunterhogan</a> on 2025-08-24 05:37</div>
            <div class="timeline-body"><p>So, here's the deal:</p>
<ol>
<li>I don't have training or experience as a professional programmer.</li>
<li>I very much trust Ruff. I have been blown away by the quality of the linting and by the quality of explanatory documentation.</li>
</ol>
<p>It naturally follows: I defer to Ruff's technical explanations.</p>
<p><a href="https://github.com/hunterhogan/mapFolding/issues/13">Bandit first flagged this</a> issue five months ago. I started using Ruff at least 10 weeks ago. Since I started using Ruff, I have read the <a href="https://docs.astral.sh/ruff/rules/suspicious-url-open-usage/">S310 documentation page</a> at least 10 times. It is the only diagnostic error in that package that I can't fix. I've spent many hours trying to fix it. I literally copied and pasted the &quot;Use instead&quot; from the website and put it in my code.</p>
<p>I kept looking for what I was doing wrong. Today, however, after a few hours and at least three copy-paste attempts, I decided to create an &quot;Issue&quot; and ask what I was doing wrong. I searched the open Issues and found this one.</p>
<p>Y'all don't need to improve the code. I like the linting rule, and I have not disabled it because I want to ensure I catch this issue. Please add to the documentation, however, that the diagnostic is a permanent warning.</p>
<p>I greatly appreciate your hard work, and I do not think you need to put hard work into this issue.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 01:30:09 UTC
    </footer>
</body>
</html>
