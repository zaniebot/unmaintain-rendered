```yaml
number: 7530
title: Incorrect NoQA placement for continuation with multi-line string
type: issue
state: closed
author: dhruvmanila
labels:
  - bug
  - suppression
assignees: []
created_at: 2023-09-20T04:58:43Z
updated_at: 2023-09-20T11:07:21Z
url: https://github.com/astral-sh/ruff/issues/7530
synced_at: 2026-01-10T01:56:49Z
```

# Incorrect NoQA placement for continuation with multi-line string

---

_Issue opened by @dhruvmanila on 2023-09-20 04:58_

Take the following code snippet:

```python
assert foo, \
    """triple-quoted
    string"""
```

Running the following command repeatedly:
```console
$ ruff check --no-cache --isolated --select=F821 fstring.py --add-noqa
Added 1 noqa directive.

$ ruff check --no-cache --isolated --select=F821 fstring.py --add-noqa
Added 1 noqa directive.

...
```

It keeps on adding the `noqa` directive inside the first line of the string:
```python
assert foo, \
    """triple-quoted  # noqa: F821  # noqa: F821
    string"""
```

I think the problem is in the way the range is being pushed onto the NoQA mapping in the following code:

https://github.com/astral-sh/ruff/blob/dcbd8eacd8aa1a6fffb77cb76a3e7e7ea670d009/crates/ruff/src/noqa.rs#L764-L777

1. The `<=` doesn't make it strict
2. We should use the union range instead of intersected range

So,

```rust
    pub(crate) fn push_mapping(&mut self, range: TextRange) {
        if let Some(last_range) = self.ranges.last_mut() {
            // Strictly sorted insertion
            if last_range.end() < range.start() {
                // OK
            } else if range.end() < last_range.start() {
                panic!("Ranges must be inserted in sorted order")
            } else {
                *last_range = last_range.cover(range);
                return;
            }
        }

        self.ranges.push(range);
    }
```

---

_Label `bug` added by @dhruvmanila on 2023-09-20 04:58_

---

_Label `noqa` added by @dhruvmanila on 2023-09-20 04:58_

---

_Referenced in [astral-sh/ruff#7531](../../astral-sh/ruff/pulls/7531.md) on 2023-09-20 05:41_

---

_Closed by @dhruvmanila on 2023-09-20 11:07_

---
