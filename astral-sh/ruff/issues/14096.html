<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[red-knot] Support metaclasses - astral-sh/ruff #14096</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[red-knot] Support metaclasses</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/issues/14096">#14096</a>
        opened by <a href="https://github.com/AlexWaygood">@AlexWaygood</a>
        on 2024-11-04 17:49
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a></div>
            <div class="timeline-body"><p>Currently we infer that all class objects are instances of <code>builtins.type</code>:</p>
<p>https://github.com/astral-sh/ruff/blob/b7e32b0a18487e8c9813e0d189d7a5d625ff5c3f/crates/red_knot_python_semantic/src/types.rs#L1211-L1212</p>
<p>Contrary to the TODO comment there (<a href="https://github.com/astral-sh/ruff/commit/46a457318d8d259376a2b458b3f814b9b795fe69">not sure who wrote that</a>), this <em>is</em> accurate -- all classes are indeed instances of <code>builtins.type</code>. However, it could be a lot more precise, since some classes have a custom metaclass!</p>
<pre><code>&gt;&gt;&gt; class Meta(type): pass
... 
&gt;&gt;&gt; class Foo(metaclass=Meta): pass
... 
&gt;&gt;&gt; type(Foo)
&lt;class &#x27;__main__.Meta&#x27;&gt;
&gt;&gt;&gt; isinstance(Foo, Meta)
True
</code></pre>
<p>For the <code>Foo</code> class here, <code>Type::to_meta_type</code> should return a type representing the class object <code>Meta</code> rather than a type representing the class object <code>builtins.type</code>.</p>
<hr>
Miscellaneous details on semantics
<p>If a class is a subclass of a class with a custom metaclass, then the subclass will also have that metaclass:</p>
<pre><code>&gt;&gt;&gt; class Bar(Foo): pass
... 
&gt;&gt;&gt; type(Bar)
&lt;class &#x27;__main__.Meta&#x27;&gt;
</code></pre>
<p>And if the metaclasses of the bases conflict, then this can happen (we&#x27;ll need to detect this and emit a diagnostic):</p>
<pre><code>&gt;&gt;&gt; class A(type): ...
... 
&gt;&gt;&gt; class B(type): ...
... 
&gt;&gt;&gt; class C(metaclass=A): ...
... 
&gt;&gt;&gt; class D(metaclass=B): ...
... 
&gt;&gt;&gt; class E(C, D): ...
... 
Traceback (most recent call last):
  File &quot;&lt;python-input-4&gt;&quot;, line 1, in &lt;module&gt;
    class E(C, D): ...
TypeError: metaclass conflict: the metaclass of a derived class must be a (non-strict) subclass of the metaclasses of all its bases
</code></pre>
<p>We&#x27;ll probably need to add a method to <code>ClassType</code> to retrieve the type of the metaclass. It will probably be best to wait until <a href="https://github.com/astral-sh/ruff/pull/14087">astral-sh/ruff#14087</a> has landed before working on this.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-11-04 17:49</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-11-05 16:17</div>
            <div class="timeline-body"><p>Could be a good @charliermarsh -sized task!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to <a href="https://github.com/charliermarsh">@charliermarsh</a> by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-11-05 16:18</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-11-06 20:41</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 18:48:59 UTC
    </footer>
</body>
</html>
