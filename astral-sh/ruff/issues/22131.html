<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TC006 fix creates quoted type expressions with escape sequences - astral-sh/ruff #22131</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>TC006 fix creates quoted type expressions with escape sequences</h1>

    <div class="meta">
        <span class="state state-open">Open</span>
        <a href="https://github.com/astral-sh/ruff/issues/22131">#22131</a>
        opened by <a href="https://github.com/dscorbett">@dscorbett</a>
        on 2025-12-21 20:44
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/dscorbett">@dscorbett</a> on 2025-12-21 20:44</div>
            <div class="timeline-body"><h3>Summary</h3>
<p>The fix for <a href="https://docs.astral.sh/ruff/rules/runtime-cast-value/"><code>runtime-cast-value</code> (TC006)</a> can introduce an escape sequence into a quoted type expression, which ty rejects. The typing spec is not clear whether this is allowed but I’d expect Ruff to agree with ty. Example (<a href="https://play.ruff.rs/4107d241-3517-46ad-b20d-1b22b7614c89">Ruff</a>, <a href="https://play.ty.dev/c953c3d8-2132-4ac3-82e9-1a21a6aa3f0c">ty</a>):</p>
<pre><code class="language-console">$ cat &gt;tc006_fp.py &lt;&lt;'# EOF'
from typing import Literal, cast
cast(Literal[&quot;'&quot;], &quot;'&quot;)
# EOF

$ ruff --isolated check tc006_fp.py --select TC006 --fix
Found 1 error (1 fixed, 0 remaining).

$ cat tc006_fp.py
from typing import Literal, cast
cast(&quot;Literal[\&quot;'\&quot;]&quot;, &quot;'&quot;)

$ ty check --output-format concise tc006_fp.py
tc006_fp.py:2:6: error[escape-character-in-forward-annotation] Type expressions cannot contain escape characters
Found 1 diagnostic
</code></pre>
<p>Note that the problem is only with escape sequences in the fix’s <em>output</em>. Escape sequences are fine in the fix’s <em>input</em>, as long as the fix resolves them. Example (<a href="https://play.ruff.rs/ec95404a-3d18-4e51-a8ea-29ec4da4153c">Ruff</a>, <a href="https://play.ty.dev/a63403b5-58d1-4cb8-833d-eba22e712500">ty</a>):</p>
<pre><code class="language-console">$ cat &gt;tc006_tp.py &lt;&lt;'# EOF'
from typing import Literal, cast
cast(Literal[&quot;\x3F&quot;] | None, &quot;?&quot;)
# EOF

$ ruff --isolated check tc006_tp.py --select TC006 --fix
Found 1 error (1 fixed, 0 remaining).

$ cat tc006_tp.py
from typing import Literal, cast
cast(&quot;Literal['?'] | None&quot;, &quot;?&quot;)

$ ty check --output-format concise tc006_tp.py
All checks passed!
</code></pre>
<h3>Version</h3>
<p>ruff 0.14.10 (45bbb4cbf 2025-12-18)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-12-21 21:01</div>
            <div class="timeline-body"><p>https://discuss.python.org/t/exotic-kinds-of-string-annotations/50527 is some relevant context here, but I can't remember exactly what the resolution of that was or how much of the original proposal ever made it into the spec in the end (@JelleZijlstra might remember more?)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">rule</span> added by @ntBre on 2025-12-22 14:18</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">needs-decision</span> added by @ntBre on 2025-12-22 14:18</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/JelleZijlstra">@JelleZijlstra</a> on 2025-12-22 18:38</div>
            <div class="timeline-body"><p>Yes, I think we never resolved the issue there. For Ruff, I'd recommend writing out the string in such a way to avoid escape sequences, like <code>cast(&quot;&quot;&quot;Literal[&quot;'&quot;]&quot;&quot;&quot;, ...)</code>. Another option could be to make Ruff's fix unsafe if there are escape sequences involved. The linked thread discusses some other edge cases that might cause trouble.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-12-22 18:41</div>
            <div class="timeline-body"><p>Yeah, I think whatever the case with the spec, it's definitely unfortunate for one of Astral's tools to autofix something in a way that causes another of Astral's tools to start complaining</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntBre">@ntBre</a> on 2025-12-22 18:46</div>
            <div class="timeline-body"><p>Glancing quickly at the rule's implementation, this might be tricky to fix, but it definitely sounds like this is a bug for the fix output to disagree with ty. I think we should try harder not to escape nested quotes and then avoid a fix or at least make it unsafe if we can't avoid it.</p>
<p>Thank you all!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">rule</span> removed by @ntBre on 2025-12-22 18:46</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">needs-decision</span> removed by @ntBre on 2025-12-22 18:46</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @ntBre on 2025-12-22 18:46</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:34:56 UTC
    </footer>
</body>
</html>
