<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[Autofix error] My File: test/distributed/elastic/rendezvous/etcd_rendezvous_backend_test.py - astral-sh/ruff #4203</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[Autofix error] My File: test/distributed/elastic/rendezvous/etcd_rendezvous_backend_test.py</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/issues/4203">#4203</a>
        opened by <a href="https://github.com/FishAlchemist">@FishAlchemist</a>
        on 2023-05-03 13:06
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/FishAlchemist">@FishAlchemist</a></div>
            <div class="timeline-body"><p><strong>ruff version 0.0.264 (ruff --version)</strong></p>
<h2>command(Powershell)</h2>
<pre><code class="language-powershell">ruff check --select=ALL --fix --isolated .\etcd_rendezvous_backend_test.py
</code></pre>
<hr />
<p>The source is a Python file from PyTorch, but it is not the original file (with a different hash value).
The original file can be found at https://github.com/pytorch/pytorch/blob/8b64dee5d2e0e61c3c37a222c43b636d20cc58b7/test/distributed/elastic/rendezvous/etcd_rendezvous_backend_test.py.
OS: Windows 11 22H2</p>
<h2>Terminal Content:</h2>
<pre><code class="language-powershell">warning: `one-blank-line-before-class` (D203) and `no-blank-line-before-class` (D211) are incompatible. Ignoring `one-blank-line-before-class`.
warning: `multi-line-summary-first-line` (D212) and `multi-line-summary-second-line` (D213) are incompatible. Ignoring `multi-line-summary-second-line`.

error: Autofix introduced a syntax error. Reverting all changes.

This indicates a bug in `ruff`. If you could open an issue at:

    https://github.com/charliermarsh/ruff/issues/new?title=%5BAutofix%20error%5D

...quoting the contents of `etcd_rendezvous_backend_test.py`, along with the `pyproject.toml` settings and executed command, we'd be very appreciative!

etcd_rendezvous_backend_test.py:1:1: D100 Missing docstring in public module
etcd_rendezvous_backend_test.py:7:1: I001 Import block is un-sorted or un-formatted
etcd_rendezvous_backend_test.py:15:89: E501 Line too long (96 &gt; 88 characters)
etcd_rendezvous_backend_test.py:24:7: D101 Missing docstring in public class
etcd_rendezvous_backend_test.py:28:9: D102 Missing docstring in public method
etcd_rendezvous_backend_test.py:28:20: ANN102 Missing type annotation for `cls` in classmethod
etcd_rendezvous_backend_test.py:33:9: D102 Missing docstring in public method
etcd_rendezvous_backend_test.py:33:23: ANN102 Missing type annotation for `cls` in classmethod
etcd_rendezvous_backend_test.py:36:9: D102 Missing docstring in public method
etcd_rendezvous_backend_test.py:36:15: ANN101 Missing type annotation for `self` in method
etcd_rendezvous_backend_test.py:40:9: SIM105 Use `contextlib.suppress(EtcdKeyNotFound)` instead of `try`-`except`-`pass`
etcd_rendezvous_backend_test.py:45:89: E501 Line too long (92 &gt; 88 characters)
etcd_rendezvous_backend_test.py:47:24: ANN101 Missing type annotation for `self` in method
etcd_rendezvous_backend_test.py:51:7: D101 Missing docstring in public class
etcd_rendezvous_backend_test.py:55:9: D102 Missing docstring in public method
etcd_rendezvous_backend_test.py:55:20: ANN102 Missing type annotation for `cls` in classmethod
etcd_rendezvous_backend_test.py:60:9: D102 Missing docstring in public method
etcd_rendezvous_backend_test.py:60:23: ANN102 Missing type annotation for `cls` in classmethod
etcd_rendezvous_backend_test.py:63:9: D102 Missing docstring in public method
etcd_rendezvous_backend_test.py:63:15: ANN101 Missing type annotation for `self` in method
etcd_rendezvous_backend_test.py:76:9: D102 Missing docstring in public method
etcd_rendezvous_backend_test.py:76:45: ANN101 Missing type annotation for `self` in method
etcd_rendezvous_backend_test.py:79:9: S101 Use of `assert` detected
etcd_rendezvous_backend_test.py:81:9: S101 Use of `assert` detected
etcd_rendezvous_backend_test.py:85:9: S101 Use of `assert` detected
etcd_rendezvous_backend_test.py:85:89: E501 Line too long (106 &gt; 88 characters)
etcd_rendezvous_backend_test.py:93:9: S101 Use of `assert` detected
etcd_rendezvous_backend_test.py:94:9: S101 Use of `assert` detected
etcd_rendezvous_backend_test.py:94:30: PLR2004 Magic value used in comparison, consider replacing 7200 with a constant variable
etcd_rendezvous_backend_test.py:100:9: S101 Use of `assert` detected
etcd_rendezvous_backend_test.py:102:9: D102 Missing docstring in public method
etcd_rendezvous_backend_test.py:102:74: ANN101 Missing type annotation for `self` in method
etcd_rendezvous_backend_test.py:107:9: D102 Missing docstring in public method
etcd_rendezvous_backend_test.py:107:78: ANN101 Missing type annotation for `self` in method
etcd_rendezvous_backend_test.py:107:89: E501 Line too long (91 &gt; 88 characters)
etcd_rendezvous_backend_test.py:114:9: D102 Missing docstring in public method
etcd_rendezvous_backend_test.py:114:65: ANN101 Missing type annotation for `self` in method
etcd_rendezvous_backend_test.py:123:9: D102 Missing docstring in public method
etcd_rendezvous_backend_test.py:123:65: ANN101 Missing type annotation for `self` in method
etcd_rendezvous_backend_test.py:126:89: E501 Line too long (90 &gt; 88 characters)
etcd_rendezvous_backend_test.py:129:9: D102 Missing docstring in public method
etcd_rendezvous_backend_test.py:129:69: ANN101 Missing type annotation for `self` in method
Found 42 errors.
</code></pre>
<h2>File Content:</h2>
<pre><code class="language-py">
# Copyright (c) Facebook, Inc. and its affiliates.
# All rights reserved.
#
# This source code is licensed under the BSD-style license found in the
# LICENSE file in the root directory of this source tree.

import subprocess
from base64 import b64encode
from typing import ClassVar, cast
from unittest import TestCase

from etcd import EtcdKeyNotFound  # type: ignore[import]
from rendezvous_backend_test import RendezvousBackendTestMixin

from torch.distributed.elastic.rendezvous import RendezvousConnectionError, RendezvousParameters
from torch.distributed.elastic.rendezvous.etcd_rendezvous_backend import (
    EtcdRendezvousBackend,
    create_backend,
)
from torch.distributed.elastic.rendezvous.etcd_server import EtcdServer
from torch.distributed.elastic.rendezvous.etcd_store import EtcdStore


class EtcdRendezvousBackendTest(TestCase, RendezvousBackendTestMixin):
    _server: ClassVar[EtcdServer]

    @classmethod
    def setUpClass(cls) -&gt; None:
        cls._server = EtcdServer()
        cls._server.start(stderr=subprocess.DEVNULL)

    @classmethod
    def tearDownClass(cls) -&gt; None:
        cls._server.stop()

    def setUp(self) -&gt; None:
        self._client = self._server.get_client()

        # Make sure we have a clean slate.
        try:
            self._client.delete(&quot;/dummy_prefix&quot;, recursive=True, dir=True)
        except EtcdKeyNotFound:
            pass

        self._backend = EtcdRendezvousBackend(self._client, &quot;dummy_run_id&quot;, &quot;/dummy_prefix&quot;)

    def _corrupt_state(self) -&gt; None:
        self._client.write(&quot;/dummy_prefix/dummy_run_id&quot;, &quot;non_base64&quot;)


class CreateBackendTest(TestCase):
    _server: ClassVar[EtcdServer]

    @classmethod
    def setUpClass(cls) -&gt; None:
        cls._server = EtcdServer()
        cls._server.start(stderr=subprocess.DEVNULL)

    @classmethod
    def tearDownClass(cls) -&gt; None:
        cls._server.stop()

    def setUp(self) -&gt; None:
        self._params = RendezvousParameters(
            backend=&quot;dummy_backend&quot;,
            endpoint=self._server.get_endpoint(),
            run_id=&quot;dummy_run_id&quot;,
            min_nodes=1,
            max_nodes=1,
            protocol=&quot;hTTp&quot;,
            read_timeout=&quot;10&quot;,
        )

        self._expected_read_timeout = 10

    def test_create_backend_returns_backend(self) -&gt; None:
        backend, store = create_backend(self._params)

        assert backend.name == &quot;etcd-v2&quot;

        assert isinstance(store, EtcdStore)

        etcd_store = cast(EtcdStore, store)

        assert etcd_store.client.read_timeout == self._expected_read_timeout  # type: ignore[attr-defined]

        client = self._server.get_client()

        backend.set_state(b&quot;dummy_state&quot;)

        result = client.get(&quot;/torch/elastic/rendezvous/&quot; + self._params.run_id)

        assert result.value == b64encode(b&quot;dummy_state&quot;).decode()
        assert result.ttl &lt;= 7200

        store.set(&quot;dummy_key&quot;, &quot;dummy_value&quot;)

        result = client.get(&quot;/torch/elastic/store/&quot; + b64encode(b&quot;dummy_key&quot;).decode())

        assert result.value == b64encode(b&quot;dummy_value&quot;).decode()

    def test_create_backend_returns_backend_if_protocol_is_not_specified(self) -&gt; None:
        del self._params.config[&quot;protocol&quot;]

        self.test_create_backend_returns_backend()

    def test_create_backend_returns_backend_if_read_timeout_is_not_specified(self) -&gt; None:
        del self._params.config[&quot;read_timeout&quot;]

        self._expected_read_timeout = 60

        self.test_create_backend_returns_backend()

    def test_create_backend_raises_error_if_etcd_is_unreachable(self) -&gt; None:
        self._params.endpoint = &quot;dummy:1234&quot;

        with self.assertRaisesRegex(
            RendezvousConnectionError,
            r&quot;^The connection to etcd has failed. See inner exception for details.$&quot;,
        ):
            create_backend(self._params)

    def test_create_backend_raises_error_if_protocol_is_invalid(self) -&gt; None:
        self._params.config[&quot;protocol&quot;] = &quot;dummy&quot;

        with self.assertRaisesRegex(ValueError, r&quot;^The protocol must be HTTP or HTTPS.$&quot;):
            create_backend(self._params)

    def test_create_backend_raises_error_if_read_timeout_is_invalid(self) -&gt; None:
        for read_timeout in [&quot;0&quot;, &quot;-10&quot;]:
            with self.subTest(read_timeout=read_timeout):
                self._params.config[&quot;read_timeout&quot;] = read_timeout

                with self.assertRaisesRegex(
                    ValueError, r&quot;^The read timeout must be a positive integer.$&quot;,
                ):
                    create_backend(self._params)

</code></pre>
<h2>pyproject.toml</h2>
<pre><code class="language-toml">[build-system]
requires = [
    &quot;setuptools&quot;,
    &quot;wheel&quot;,
    &quot;astunparse&quot;,
    &quot;numpy&quot;,
    &quot;ninja&quot;,
    &quot;pyyaml&quot;,
    &quot;setuptools&quot;,
    &quot;cmake&quot;,
    &quot;typing-extensions&quot;,
    &quot;requests&quot;,
]
# Use legacy backend to import local packages in setup.py
build-backend = &quot;setuptools.build_meta:__legacy__&quot;


[tool.black]
# Uncomment if pyproject.toml worked fine to ensure consistency with flake8
# line-length = 120
target-version = [&quot;py38&quot;, &quot;py39&quot;, &quot;py310&quot;, &quot;py311&quot;]


[tool.ruff]
target-version = &quot;py38&quot;

# NOTE: Synchoronize the ignores with .flake8
ignore = [
    # these ignores are from flake8-bugbear; please fix!
    &quot;B007&quot;, &quot;B008&quot;, &quot;B017&quot;,
    &quot;B018&quot;, # Useless expression
    &quot;B019&quot;, &quot;B020&quot;,
    &quot;B023&quot;, &quot;B024&quot;, &quot;B026&quot;,
    &quot;B028&quot;, # No explicit `stacklevel` keyword argument found
    &quot;B027&quot;, &quot;B904&quot;, &quot;B905&quot;,
    &quot;E402&quot;,
    &quot;C408&quot;, # C408 ignored because we like the dict keyword argument syntax
    &quot;E501&quot;, # E501 is not flexible enough, we're using B950 instead
    &quot;E721&quot;,
    &quot;E731&quot;, # Assign lambda expression
    &quot;E741&quot;,
    &quot;EXE001&quot;,
    &quot;F405&quot;,
    &quot;F821&quot;,
    &quot;F841&quot;,
    # these ignores are from flake8-logging-format; please fix!
    &quot;G101&quot;, &quot;G201&quot;, &quot;G202&quot;,
    &quot;SIM102&quot;, &quot;SIM103&quot;, &quot;SIM112&quot;, # flake8-simplify code styles
    &quot;SIM105&quot;, # these ignores are from flake8-simplify. please fix or ignore with commented reason
    &quot;SIM108&quot;,
    &quot;SIM110&quot;,
    &quot;SIM114&quot;, # Combine `if` branches using logical `or` operator
    &quot;SIM115&quot;,
    &quot;SIM116&quot;, # Disable Use a dictionary instead of consecutive `if` statements
    &quot;SIM117&quot;,
    &quot;SIM118&quot;,
]
line-length = 120
select = [
    &quot;B&quot;,
    &quot;C4&quot;,
    &quot;G&quot;,
    &quot;E&quot;,
    &quot;F&quot;,
    &quot;SIM1&quot;,
    &quot;W&quot;,
]

[tool.ruff.per-file-ignores]
&quot;__init__.py&quot; = [&quot;F401&quot;]
&quot;torchgen/api/types/__init__.py&quot; = [
    &quot;F401&quot;,
    &quot;F403&quot;,
]
&quot;torchgen/executorch/api/types/__init__.py&quot; = [
    &quot;F401&quot;,
    &quot;F403&quot;,
]
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "[Autofix error]" to "[Autofix error] My File: test/distributed/elastic/rendezvous/etcd_rendezvous_backend_test.py" by @FishAlchemist on 2023-05-03 13:26</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2023-05-03 18:10</div>
            <div class="timeline-body"><p>It's coming from <code>SIM105</code>. A minimal repro:</p>
<p>If you remove the import, then it'll work. Somehow the import is causing this issue. It works on <code>0.0.263</code>.</p>
<pre><code class="language-python">import math

try:
    int('ab')
except ValueError:
    pass
</code></pre>
<p>Command to run: <code>ruff check --select=SIM105 --fix --diff --isolated src/SIM105.py</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @charliermarsh on 2023-05-04 02:47</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @MichaReiser on 2023-05-04 14:17</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 16:47:06 UTC
    </footer>
</body>
</html>
