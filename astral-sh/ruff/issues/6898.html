<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>formatter panic with comment between joined f-strings - astral-sh/ruff #6898</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>formatter panic with comment between joined f-strings</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/issues/6898">#6898</a>
        opened by <a href="https://github.com/davidszotten">@davidszotten</a>
        on 2023-08-26 13:56
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/davidszotten">@davidszotten</a> on 2023-08-26 13:56</div>
            <div class="timeline-body"><p>a3d4f08f moved the f-string comment handling added in f091b46 (which unfortunately didn't add enough test cases)</p>
<pre><code>(
    f'{1}' # comment
    f'{2}'
)
</code></pre>
<p>panics with</p>
<pre><code>Unexpected token between nodes: `&quot;' &quot;`', crates/ruff_python_formatter/src/comments/placement.rs:122:17
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @MichaReiser on 2023-08-26 14:10</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">formatter</span> added by @MichaReiser on 2023-08-26 14:10</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone "Formatter: Alpha" by @MichaReiser on 2023-08-26 14:10</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/cnpryer">@cnpryer</a> on 2023-09-01 15:09</div>
            <div class="timeline-body"><p>What's the correct way to read</p>
<pre><code>`&quot;' &quot;`'
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/cnpryer">@cnpryer</a> on 2023-09-01 15:51</div>
            <div class="timeline-body"><p>I imagine the <code>&quot;</code>s are just lexing noise?</p>
<p>https://github.com/astral-sh/ruff/blob/fbc9b5a604c98ab0e676a576a6e26be275efc364/crates/ruff_python_formatter/src/comments/placement.rs#L122-L126</p>
<p>Edit: <em>noise</em> probably isn't a good way to describe it. I mean it's lexed as <code>&quot;</code> tokens or something?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-09-01 15:58</div>
            <div class="timeline-body"><p>I think the <code>SimpleTokenizer</code> intentionally doesn't support lexing strings, so it hits the first quote and then lexes any subsequent characters as bogus. I'm not quite familiar enough with the f-string comment handling to be sure how to solve this, but I can play around with it for a sec to get an idea.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/davidszotten">@davidszotten</a> on 2023-09-01 15:58</div>
            <div class="timeline-body"><p>i believe the issue is that the preceding node is the <code>FormattedValue</code> _inside the f-string</p>
<p>the printed slice is</p>
<pre><code> f'{1}' # comment
      ^^
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/davidszotten">@davidszotten</a> on 2023-09-01 16:00</div>
            <div class="timeline-body"><p>the previous solution was re-assigning the comment from the <code>FormattedValue</code> to the surrounding f-string</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-09-01 16:00</div>
            <div class="timeline-body"><p>Yeah, makes sense. I can probably restore it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/davidszotten">@davidszotten</a> on 2023-09-01 16:03</div>
            <div class="timeline-body"><p>i found this when trying to test #6365 after rebasing on top of the refactor in the pr description.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @charliermarsh by @charliermarsh on 2023-09-01 16:06</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/7047.html">astral-sh/ruff#7047</a> on 2023-09-01 16:12</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2023-09-01 16:27</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/20580.html">astral-sh/ruff#20580</a> on 2025-09-25 18:30</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 01:30:08 UTC
    </footer>
</body>
</html>
