<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[red-knot] Make `Type::in_type_expression()` exhaustive - astral-sh/ruff #15048</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[red-knot] Make <code>Type::in_type_expression()</code> exhaustive</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/issues/15048">#15048</a>
        opened by <a href="https://github.com/AlexWaygood">@AlexWaygood</a>
        on 2024-12-18 19:09
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a></div>
            <div class="timeline-body"><p><code>Type::in_type_expression()</code> already  errors for some types that are invalid in type expression contexts:
https://github.com/astral-sh/ruff/blob/ed2bce6ebb56c84c5ecd22cbe8aac4a887c403ca/crates/red_knot_python_semantic/src/types.rs#L2031-L2043</p>
<p>However, there are many other types that are invalid in type expression contexts. We should remove the final fallback branch from this <code>match</code> statement and make it exhaustive so that all typing errors are correctly reported.</p>
<p>I expect that many invalid types can be covered by a single branch. Doing so might require changing this method so that its return type is <code>std::fmt::Arguments</code> rather than <code>&amp;'static str</code>:</p>
<p>https://github.com/astral-sh/ruff/blob/ed2bce6ebb56c84c5ecd22cbe8aac4a887c403ca/crates/red_knot_python_semantic/src/types.rs#L2208-L2215</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">help wanted</span> added by @AlexWaygood on 2024-12-18 19:09</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by @AlexWaygood on 2024-12-18 19:09</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/brandonsorensen">@brandonsorensen</a> on 2025-02-12 10:59</div>
            <div class="timeline-body"><p>Hi. I'm interested in contributing to red_knot. I'm happy to give this issue a go.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-02-12 11:12</div>
            <div class="timeline-body"><blockquote>
<p>Hi. I'm interested in contributing to red_knot. I'm happy to give this issue a go.</p>
</blockquote>
<p>Fantastic! Feel free to give me a ping if you need any help on how to tackle it :-D</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @brandonsorensen by @AlexWaygood on 2025-02-12 11:12</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-03-15 16:25</div>
            <div class="timeline-body"><p>It looks like this match is now exhaustive, but some branches still return Todo types, which could be addressed.</p>
<p>@brandonsorensen are you still taking a look at this, or should I un-assign for now?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-03-15 16:44</div>
            <div class="timeline-body"><blockquote>
<p>It looks like this match is now exhaustive</p>
</blockquote>
<p>Yes, sorry! I should have updated the status of this issue following https://github.com/astral-sh/ruff/pull/16427.</p>
<blockquote>
<p>but some branches still return Todo types, which could be addressed.</p>
</blockquote>
<p>I think this Todo is somewhat hard to address without an understanding of generics (we'd start erroring on &quot;instances of <code>typing.TypeVar</code> being used in type expressions&quot;):</p>
<p>https://github.com/astral-sh/ruff/blob/2de8455e43efc55b2ed302c0bdf4e59744338504/crates/red_knot_python_semantic/src/types.rs#L3282-L3284</p>
<p>But I think this one is doable right now, and would be a great contributor task -- we just need to expand the <code>match</code> so that it is exhaustive over all <code>KnownInstanceType</code> variants:</p>
<p>https://github.com/astral-sh/ruff/blob/2de8455e43efc55b2ed302c0bdf4e59744338504/crates/red_knot_python_semantic/src/types.rs#L3279-L3281</p>
<p>This one is also possibly doable, but might be trickier for a contributor to take on:</p>
<p>https://github.com/astral-sh/ruff/blob/2de8455e43efc55b2ed302c0bdf4e59744338504/crates/red_knot_python_semantic/src/types.rs#L3285</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MatthewMckee4">@MatthewMckee4</a> on 2025-03-16 22:46</div>
            <div class="timeline-body"><blockquote>
<p>But I think this one is doable right now, and would be a great contributor task -- we just need to expand the <code>match</code> so that it is exhaustive over all <code>KnownInstanceType</code> variants:</p>
<p><a href="https://github.com/astral-sh/ruff/blob/2de8455e43efc55b2ed302c0bdf4e59744338504/crates/red_knot_python_semantic/src/types.rs#L3279-L3281">ruff/crates/red_knot_python_semantic/src/types.rs</a></p>
<p>Lines 3279 to 3281 in <a href="/astral-sh/ruff/commit/2de8455e43efc55b2ed302c0bdf4e59744338504">2de8455</a>
Type::KnownInstance(_) =&gt; Ok(todo_type!(
&quot;Invalid or unsupported <code>KnownInstanceType</code> in <code>Type::to_type_expression</code>&quot;
)),</p>
</blockquote>
<p>@AlexWaygood do you think this is something i could take a look into?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-03-17 16:17</div>
            <div class="timeline-body"><blockquote>
<p><a href="https://github.com/AlexWaygood?rgh-link-date=2025-03-16T22%3A46%3A47.000Z">@AlexWaygood</a> do you think this is something i could take a look into?</p>
</blockquote>
<p>@MatthewMckee4 yes absolutely! To make the <code>match</code> exhaustive, for each <code>KnownInstanceType</code> variant you'll need to either:</p>
<ul>
<li>emit an appropriate error message (if the <code>KnownInstanceType</code> variant is only valid in a type expression when it's parameterized with a type argument), OR</li>
<li>return <code>Ok(todo_type!())</code> with a precise TODO error message that states exactly what the missing feature is</li>
</ul>
<p>You may find the &quot;type expression grammar&quot; in the typing spec helpful for this task: https://typing.python.org/en/latest/spec/annotations.html#type-and-annotation-expressions</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-03-17 16:18</div>
            <div class="timeline-body"><p>@brandonsorensen, I'll unassign you for now so that others can work on this :-) but feel free to work on any of our other &quot;help wanted&quot; tasks!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Unassigned @brandonsorensen by @AlexWaygood on 2025-03-17 16:18</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MatthewMckee4">@MatthewMckee4</a> on 2025-03-18 17:35</div>
            <div class="timeline-body"><p>For example, something like</p>
<pre><code class="language-py">from typing import Optional

def f(x: Optional) -&gt; None:
    reveal_type(x)  # revealed: Unknown
</code></pre>
<p>I could catch this and say &quot;Variable of type <code>typing.Optional</code> is not allowed in a type expression&quot;, with InvalidTypeExpression::InvalidType. But this is not a great message, so should i create a new enum type &quot;BareOptional&quot;?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MatthewMckee4">@MatthewMckee4</a> on 2025-03-18 17:43</div>
            <div class="timeline-body"><p>Or would it be better to make a enum type like InvalidBareType, so we're not duplicating tons of code. This type should take the known instance type too I think</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-03-18 18:48</div>
            <div class="timeline-body"><p>It looks to me like <code>InvalidTypeExpression</code> enum already has <code>BareAnnotated</code> and <code>BareLiteral</code> variants; I think adding <code>BareOptional</code> makes sense there.</p>
<p>If the list of <code>Bare*</code> variants grows very large, we could consider the commonality between their error messages and see if they are similar enough that we can reasonably share a single <code>BareSpecialForm</code> variant, but I think it would be premature to do that now.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MatthewMckee4">@MatthewMckee4</a> on 2025-03-18 19:51</div>
            <div class="timeline-body"><p>This is what i have right now</p>
<pre><code class="language-rust">            Type::KnownInstance(
                KnownInstanceType::Literal
                | KnownInstanceType::Optional
                | KnownInstanceType::Union
                | KnownInstanceType::Protocol
                | KnownInstanceType::Not
                | KnownInstanceType::Intersection
                | KnownInstanceType::TypeOf
                | KnownInstanceType::CallableTypeFromFunction,
            ) =&gt; Err(InvalidTypeExpressionError {
                invalid_expressions: smallvec::smallvec![InvalidTypeExpression::InvalidBareType(
                    *self
                )],
                fallback_type: Type::unknown(),
            }),
            Type::KnownInstance(
                KnownInstanceType::TypingSelf
                | KnownInstanceType::ReadOnly
                | KnownInstanceType::TypeAlias
                | KnownInstanceType::NotRequired
                | KnownInstanceType::Concatenate
                | KnownInstanceType::TypeIs
                | KnownInstanceType::TypeGuard
                | KnownInstanceType::Unpack
                | KnownInstanceType::Required,
            ) =&gt; Ok(todo_type!(
                &quot;Invalid or unsupported `KnownInstanceType` in `Type::to_type_expression`&quot;
            )),
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-03-18 22:41</div>
            <div class="timeline-body"><p>Commented on the pull request. Looking at the complete list, it does look like there are quite a few that could share the same error message, so what you've done looks good! Just <code>Protocol</code> needs to be handled differently.</p>
<p>(<code>Union</code> and <code>Intersection</code> are odd, as they are only <em>meaningful</em> with 2+ arguments, but we currently allow them with one argument, and it seems harmless to allow, so I think we can also just say &quot;requires at least one argument&quot; for them.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @carljm on 2025-03-19 14:36</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @carljm on 2025-03-19 14:36</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 16:51:50 UTC
    </footer>
</body>
</html>
