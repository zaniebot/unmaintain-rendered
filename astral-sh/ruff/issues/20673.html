<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>New first-party import detection feature breaks documented behavior of `detect-same-package` config - astral-sh/ruff #20673</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>New first-party import detection feature breaks documented behavior of <code>detect-same-package</code> config</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/issues/20673">#20673</a>
        opened by <a href="https://github.com/bkurtz">@bkurtz</a>
        on 2025-10-01 19:30
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/bkurtz">@bkurtz</a></div>
            <div class="timeline-body">Summary
<p>Ruff 0.13 <a href="https://github.com/astral-sh/ruff/releases/tag/0.13.0">changed behavior</a> to do full path verification for first-party module detection.</p>
<p>This new behavior appears to conflict with the documented behavior of the <a href="https://docs.astral.sh/ruff/settings/#lint_isort_detect-same-package"><code>detect-same-package</code></a> option, which states that it &quot;automatically mark[s] imports from within the same package as first-party&quot;, and that it is enabled by default.</p>
<p>My reading of the documentation is that, if <code>mypackage/x.py</code> exists and <code>mypackage/y.py</code> doe not, that:</p>
<ul>
<li><a href="https://docs.astral.sh/ruff/faq/#how-does-ruff-determine-which-of-my-imports-are-first-party-third-party-etc">Documentation for the new first-party module detection feature</a> says that <code>mypackage.x</code> should be treated as a first-party import and <code>mypackage.y</code> should be treated as third-party</li>
<li>Documentation for <a href="https://docs.astral.sh/ruff/settings/#lint_isort_detect-same-package"><code>detect-same-package</code></a> implies that if <code>mypackage.x</code> is first party that <code>mypackage</code> and <code>mypackage.y</code> should also be treated as first party.</li>
</ul>
<p>I&#x27;m unclear exactly whether this is a bug in the behavior of ruff (and, e.g. <code>detect-same-package</code> should override the new logic that requires full file paths to exist), or just in the documentation (e.g. <code>detect-same-package</code> should have a different documented behavior or be marked as deprecated).</p>
<p>(I found the <code>detect-same-package</code> flag when looking to see if there was a reasonable option to disable the new first-party detection logic; it feels to me like if <code>detect-same-package</code> were off-by-default and were able to override the new logic that that could be a clean way to give folks who don&#x27;t like the new behavior an out.)</p>
<p>Reasons it might be interesting to continue to support <code>detect-same-package</code>:</p>
<ol>
<li>We keep a folder in our repo for &quot;analysis archives&quot;.  We want to enable strict code checks on new code checked in here (to ensure high quality with minimal toil), but also want not to invest effort in maintaining old code in this folder - it&#x27;s primarily intended as documentation for past decisions - if imports etc go out of date.  The new behavior for verifying first-party imports is obviously not desirable in this case, and something like <code>detect-same-package</code> would solve most of our use cases without further interventions.</li>
<li>Namespace packages? Some potentially-related discussion in <a href="https://github.com/astral-sh/ruff/issues/20453">astral-sh/ruff#20453</a> which I haven&#x27;t read closely.</li>
</ol>
Version
<p>0.13.2</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">documentation</span> added by <a href="https://github.com/amyreese">@amyreese</a> on 2025-10-01 23:45</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">configuration</span> added by <a href="https://github.com/amyreese">@amyreese</a> on 2025-10-01 23:45</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">needs-decision</span> added by <a href="https://github.com/amyreese">@amyreese</a> on 2025-10-01 23:45</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">isort</span> added by <a href="https://github.com/amyreese">@amyreese</a> on 2025-10-01 23:49</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">documentation</span> removed by <a href="https://github.com/amyreese">@amyreese</a> on 2025-10-01 23:49</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-10-02 06:27</div>
            <div class="timeline-body"><p>CC: @dylwil3</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dylwil3">@dylwil3</a> on 2025-10-03 19:03</div>
            <div class="timeline-body"><p>Thanks for submitting this! I agree that the documentation needs to be improved here.</p>
<p>It&#x27;s true that <code>detect-same-package</code> can override some of the new first-party module detection. Since the default is for this flag to be on, the main place where the new first-party module detection is visible is in the case of namespace packages (which was also the motivation for adding this detection in the first place).</p>
<p>Would you be able to provide a minimal reproduction of your directory layout, your Ruff config, and an import that&#x27;s behaving differently before and after Ruff 0.13? I can try to see if there is a config option that would restore behavior for your case.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">documentation</span> added by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-10-04 11:41</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">needs-info</span> added by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-10-04 11:41</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">needs-decision</span> removed by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-10-04 11:41</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/bkurtz">@bkurtz</a> on 2025-10-06 05:34</div>
            <div class="timeline-body"><p>Sure, here&#x27;s a (pretty) minimal repro:</p>
<pre><code>$ tree .
.
├── pyproject.toml
└── src
    ├── mymodule
    │   ├── __init__.py
    │   └── new_package.py
    └── scripts
        └── a_script.py
</code></pre>
<p><code>pyproject.toml</code>:</p>
<pre><code>[tool.ruff.lint]
select = [
	&quot;I&quot;
]
</code></pre>
<p><code>src/scripts/a_script.py</code>:</p>
<pre><code>import os

import mymodule.new_package
import mymodule.old_package

print(&quot;this used to run&quot;)
</code></pre>
<p>the other two python files are empty.</p>
<p>With an older ruff:</p>
<pre><code>$ ../ruff_venv/bin/ruff version
ruff 0.12.12 (c6516e9b6 2025-09-04)
$ ../ruff_venv/bin/ruff check .
All checks passed!
</code></pre>
<p>And with latest:</p>
<pre><code>$ ../ruff_venv_new/bin/ruff version
ruff 0.13.3 (188c0dce2 2025-10-02)
$ ../ruff_venv_new/bin/ruff check .
I001 [*] Import block is un-sorted or un-formatted
 --&gt; src/scripts/a_script.py:1:1
  |
1 | / import os
2 | |
3 | | import mymodule.new_package
4 | | import mymodule.old_package
  | |___________________________^
5 |
6 |   print(&quot;this used to run&quot;)
  |
help: Organize imports

Found 1 error.
[*] 1 fixable with the `--fix` option.
</code></pre>
<p>Letting it fix the error obviously gives</p>
<pre><code>import os

import mymodule.old_package

import mymodule.new_package

print(&quot;this used to run&quot;)
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dylwil3">@dylwil3</a> on 2025-10-06 14:59</div>
            <div class="timeline-body"><p>Got it, thank you! Yes, this is expected behavior. Moreover, <code>detect-same-package</code> isn&#x27;t actually being triggered at all here inside <code>scripts</code>. That is possibly because your project layout is neither a flat layout nor a <code>src</code> layout but something nonstandard (i.e. one expects <code>src</code> to contain the top-level import packages, but I don&#x27;t think <code>scripts</code> is a package here. Moreover, if it were, it would be a <strong>different</strong> package than <code>mymodule</code> so <code>detect-same-package</code> would not apply).</p>
<p>In any event, I think the way to get the desired behavior in your case is to use <a href="https://docs.astral.sh/ruff/settings/#lint_isort_known-first-party">known-first-party</a></p>
<pre><code>[tool.ruff.lint.isort]
known-first-party = [&quot;mymodule&quot;]
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/bkurtz">@bkurtz</a> on 2025-10-07 17:03</div>
            <div class="timeline-body"><p>Ah, I missed the first part of &quot;<strong>when analyzing files within the foo package</strong>, any imports from within the foo package will be considered first-party&quot; when reading the docs.  Okay, yeah, that seems like it works as documented then.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/bkurtz">@bkurtz</a> on 2025-10-07 17:03</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 18:50:28 UTC
    </footer>
</body>
</html>
