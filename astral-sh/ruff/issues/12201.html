<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Server doesn't sync cell content if copy-pasted directly - astral-sh/ruff #12201</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Server doesn't sync cell content if copy-pasted directly</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/issues/12201">#12201</a>
        opened by <a href="https://github.com/matrs">@matrs</a>
        on 2024-07-03 16:41
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/matrs">@matrs</a> on 2024-07-03 16:41</div>
            <div class="timeline-body"><p>I've been using the ruff server the last days without problems (for linting and formatting), and suddenly this message appeared in <code>vscode</code>:</p>
<blockquote>
<p>The Ruff language server exited with a panic. See the logs for more details.</p>
</blockquote>
<p>I'm not aware of doing any different when it happened, just  editing code, notebooks and scripts (ruff is configured to recognize <code>.ipynb</code> too).
I'm using <code>ruff 0.5.0</code> ,  <code>vscode 1.90.2</code> and extension <code>ruff-2024.30</code>. My Linux is <code>6.6.32-1-MANJARO</code>.</p>
<pre><code>2024-07-02 16:06:46.430 [info] Server: Start requested.
2024-07-02 16:07:23.830 [info] Name: Ruff
2024-07-02 16:07:23.830 [info] Module: ruff
2024-07-02 16:07:23.830 [info] Python extension loading
2024-07-02 16:07:23.830 [info] Waiting for interpreter from python extension.
2024-07-02 16:07:23.830 [info] Python extension loaded
2024-07-02 16:07:23.830 [info] Server run command: ~/.vscode/extensions/charliermarsh.ruff-2024.30.0-linux-x64/bundled/tool/ruff_server.py server --preview
2024-07-02 16:07:23.830 [info] Server: Start requested.
2024-07-03 12:20:55.252 [info] panicked at crates/ruff_source_file/src/line_index.rs:176:13:
index out of bounds: the len is 1 but the index is 2

2024-07-03 12:20:55.253 [info]    0: &lt;unknown&gt;
   1: &lt;unknown&gt;
   2: &lt;unknown&gt;
   3: &lt;unknown&gt;
   4: &lt;unknown&gt;
   5: &lt;unknown&gt;
   6: &lt;unknown&gt;
   7: &lt;unknown&gt;
   8: &lt;unknown&gt;
   9: &lt;unknown&gt;
  10: &lt;unknown&gt;
  11: &lt;unknown&gt;
  12: &lt;unknown&gt;
  13: &lt;unknown&gt;
  14: &lt;unknown&gt;

2024-07-03 12:22:55.296 [info] panicked at crates/ruff_source_file/src/line_index.rs:176:13:
index out of bounds: the len is 1 but the index is 2
   0: &lt;unknown&gt;
   1: &lt;unknown&gt;
   2: &lt;unknown&gt;
   
2024-07-03 12:22:55.297 [info] 3: &lt;unknown&gt;
   4: &lt;unknown&gt;
   5: &lt;unknown&gt;
   6: &lt;unknown&gt;
   7: &lt;unknown&gt;
   8: &lt;unknown&gt;
   9: &lt;unknown&gt;
  10: &lt;unknown&gt;
  11: &lt;unknown&gt;
  12: &lt;unknown&gt;
  13: &lt;unknown&gt;
  14: &lt;unknown&gt;
</code></pre>
<p>Then  I tried to restart the server from the command palette, which worked after the second time:</p>
<pre><code>2024-07-03 12:31:16.160 [info] Server: Stop requested
2024-07-03 12:31:16.178 [info] Server run command: /home/mibu/miniconda3/envs/scrapped/bin/python /home/mibu/.vscode/extensions/charliermarsh.ruff-2024.30.0-linux-x64/bundled/tool/ruff_server.py server --preview
2024-07-03 12:31:16.180 [info] Server: Start requested.
2024-07-03 12:31:16.211 [info] panicked at /home/conda/feedstock_root/build_artifacts/ruff_1719517977307/_build_env/.cargo/registry/src/index.crates.io-6f17d22bba15001f/jod-thread-0.1.2/src/lib.rs:21:21:
called `Result::unwrap()` on an `Err` value: Any { .. }
   0: &lt;unknown&gt;
   1: &lt;unknown&gt;
   2: &lt;unknown&gt;
   3: &lt;unknown&gt;
   4: &lt;unknown&gt;
   5: &lt;unknown&gt;
   6: &lt;unknown&gt;
   7: &lt;unknown&gt;
   8: &lt;unknown&gt;
   9: &lt;unknown&gt;
  10: &lt;unknown&gt;
  11: &lt;unknown&gt;
  12: &lt;unknown&gt;
  13: &lt;unknown&gt;
  14: &lt;unknown&gt;

panicked at /home/conda/feedstock_root/build_artifacts/ruff_1719517977307/_build_env/.cargo/registry/src/index.crates.io-6f17d22bba15001f/jod-thread-0.1.2/src/lib.rs:33:22:
called `Result::unwrap()` on an `Err` value: Any { .. }
   0: &lt;unknown&gt;
   1: &lt;unknown&gt;
   2: &lt;unknown&gt;
   3: &lt;unknown&gt;
   4: &lt;unknown&gt;
   5: &lt;unknown&gt;
   6: &lt;unknown&gt;
   7: &lt;unknown&gt;
   8: &lt;unknown&gt;
   9: &lt;unknown&gt;
  10: &lt;unknown&gt;
  11: &lt;unknown&gt;
  12: &lt;unknown&gt;
  13: &lt;unknown&gt;
  14: &lt;unknown&gt;
  15: &lt;unknown&gt;
  16: &lt;unknown&gt;
  17: __libc_start_main
  18: &lt;unknown&gt;


2024-07-03 12:31:47.637 [info] Server: Stop requested
2024-07-03 12:31:47.657 [info] Server run command: /home/mibu/miniconda3/envs/scrapped/bin/python /home/mibu/.vscode/extensions/charliermarsh.ruff-2024.30.0-linux-x64/bundled/tool/ruff_server.py server --preview
2024-07-03 12:31:47.658 [info] Server: Start requested.
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-07-04 05:38</div>
            <div class="timeline-body"><p>That's unfortunate. Are you able to reproduce this reliably? If so, will you be able to share the source code on which this panic occurs? Is it occurring in Python file or Jupyter Notebook or either? I suspect it might be occurring in the <code>offset_to_source_location</code> function (https://github.com/astral-sh/ruff/blob/e6e09ea93a382d86e4dac5e86a030729184c2de8/crates/ruff_server/src/edit/range.rs#L174-L179) although not sure.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">server</span> added by @MichaReiser on 2024-07-04 06:20</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/matrs">@matrs</a> on 2024-07-04 17:39</div>
            <div class="timeline-body"><p>i cannot reproduce it consistently, but sometimes, when i copy (<code>c</code>) and paste a cell (<code>v</code> ) with a ruff warning it it, this happens immediately . What is  consistent, it that when  I copy a cell that have a  ruff warning in it (e.g: line too long), this warning isn't  present in the copied cell, and i think this may  be related to this error.  From a fresh start of the server, this copied cell does have the same warning as the source cell, but it never has it if i don't restart the notebook/
ruff server.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/matrs">@matrs</a> on 2024-07-04 17:54</div>
            <div class="timeline-body"><p>So, i think this may be reproducible. If ones copies this  text  into a new cell in a new notebook,  then copy that cell (copy the whole cell with c, not only copy the text),  the new pasted cell won't have the ruff warning in it, and once one hover over that line (or maybe other lines of the copied cell), the server crushes.</p>
<pre><code class="language-py">qidxs = [9926, 8184, 12563, 6998]
for brand, stores_vcomps_d in all_brand_stores_vcomps.items():
    for store, vcomps_dict in stores_vcomps_d.items():
        for qidx, vcomps in vcomps_dict.items():
            if qidx in qidxs:
                print(f&quot;{brand=}, {store=}, {qidx=}&quot;)
                plot_vcomps_dict(vcomps_dict, qidx, embs_all, w_h=(2, 3)) # long line so ruff complains
</code></pre>
<p>so when i do the same copy-paste cell with  a cell like this , crushes:</p>
<pre><code class="language-py">var = 33
var2 = 55
long_string = 'ASADAADDAASADAADDAASADAADDAASADAADDAASADAADDAASADAADDAASADAADDAASADAADDAASADAADDAASADAADDA'
</code></pre>
<p>but with a cell like this , it doesn't seem to crush:</p>
<pre><code class="language-py">long_string = 'ASADAADDAASADAADDAASADAADDAASADAADDAASADAADDAASADAADDAASADAADDAASADAADDAASADAADDAASADAADDA'
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-07-05 09:16</div>
            <div class="timeline-body"><p>Thank you for providing the details. I can reproduce this.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @dhruvmanila on 2024-07-05 09:24</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-07-05 09:37</div>
            <div class="timeline-body"><p>Ok, I think I found the root cause. It's definitely a bug. Thank you for raising this issue!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @dhruvmanila by @dhruvmanila on 2024-07-05 09:37</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "The Ruff language server exited with a panic" to "Server doesn't sync cell content if copy-pasted directly" by @dhruvmanila on 2024-07-05 09:39</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone "Ruff Server: Stable" by @dhruvmanila on 2024-07-05 09:39</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @dhruvmanila on 2024-07-05 11:40</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @dhruvmanila on 2024-07-05 11:40</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 11:34:18 UTC
    </footer>
</body>
</html>
