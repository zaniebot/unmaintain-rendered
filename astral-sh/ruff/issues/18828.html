<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Use the `LinterSettings` on `LintContext` instead of `Checker` - astral-sh/ruff #18828</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Use the <code>LinterSettings</code> on <code>LintContext</code> instead of <code>Checker</code></h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/issues/18828">#18828</a>
        opened by <a href="https://github.com/ntBre">@ntBre</a>
        on 2025-06-20 18:10
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a></div>
            <div class="timeline-body"><p>There is currently a <code>&amp;&#x27;a LinterSettings</code> field on both <code>Checker</code> and <code>LintContext</code>, which is redundant because <code>Checker</code> also holds a <code>LintContext</code>. To remove the redundancy, we should replace uses of <code>Checker::settings</code> with <code>Checker::context.settings</code>, or, more likely, a <code>Checker::settings</code> method since the <code>context</code> field is private.</p>
<p>This is a conceptually simple refactor, but when I started it briefly, I ran into some lifetime issues that might make this fairly tedious. For the most part, the compiler seemed to want me to add some explicit lifetimes to <code>Checker</code> in more places (e.g. <code>&amp;&#x27;a Checker&lt;&#x27;a&gt;</code> instead of just <code>&amp;Checker</code>), but it may also help to add a whole new lifetime parameter to <code>Checker</code> so that its <code>context</code> field can be <code>&amp;&#x27;a LintContext&lt;&#x27;b&gt;</code>.</p>
<p>Ref. <a href="https://github.com/astral-sh/ruff/pull/18801">astral-sh/ruff#18801</a>#discussion_r2158266779</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">internal</span> added by <a href="https://github.com/ntBre">@ntBre</a> on 2025-06-20 18:10</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">help wanted</span> added by <a href="https://github.com/ntBre">@ntBre</a> on 2025-06-20 18:10</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/LaBatata101">@LaBatata101</a> on 2025-06-20 21:18</div>
            <div class="timeline-body"><p>I can work on this one</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to <a href="https://github.com/LaBatata101">@LaBatata101</a> by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-06-20 21:37</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/LaBatata101">@LaBatata101</a> on 2025-06-20 22:24</div>
            <div class="timeline-body"><p>I&#x27;ve followed your suggestion of adding a new lifetime to <code>Checker</code>, but I&#x27;m getting this lifetime error that I don&#x27;t know how to solve.</p>
<pre><code>error: lifetime may not live long enough
    --&gt; crates/ruff_linter/src/checkers/ast/mod.rs:2067:9
     |
760  | impl&lt;&#x27;a&gt; Visitor&lt;&#x27;a&gt; for Checker&lt;&#x27;a, &#x27;_&gt; {
     |      -- lifetime `&#x27;a` defined here
...
2058 |     fn visit_parameters(&amp;mut self, parameters: &amp;&#x27;a Parameters) {
     |                         - let&#x27;s call the lifetime of this reference `&#x27;1`
...
2067 |         analyze::parameters(parameters, self);
     |         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ argument requires that `&#x27;1` must outlive `&#x27;a`
     |
     = note: requirement occurs because of the type `Checker&lt;&#x27;_, &#x27;_&gt;`, which makes the generic argument `&#x27;_` invariant
     = note: the struct `Checker&lt;&#x27;a, &#x27;b&gt;` is invariant over the parameter `&#x27;a`
     = help: see &lt;https://doc.rust-lang.org/nomicon/subtyping.html&gt; for more information about variance

For more information about this error, try `rustc --explain E0107`.
</code></pre>
<p>It happens here:
https://github.com/LaBatata101/ruff/blob/530db0d0e826c4e9de998738bd263b895549a6f0/crates/ruff_linter/src/checkers/ast/mod.rs#L2066-L2067</p>
<p>The error shows up after I add the lifetime annotation to these two functions:
https://github.com/LaBatata101/ruff/blob/530db0d0e826c4e9de998738bd263b895549a6f0/crates/ruff_linter/src/rules/flake8_bugbear/rules/function_call_in_argument_default.rs#L132-L135</p>
<p>https://github.com/LaBatata101/ruff/blob/530db0d0e826c4e9de998738bd263b895549a6f0/crates/ruff_linter/src/checkers/ast/analyze/parameters.rs#L8</p>
<p>I&#x27;ve also tested without adding the new lifetime to <code>Checker</code> and I get this error too.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntBre">@ntBre</a> on 2025-06-21 01:31</div>
            <div class="timeline-body"><p>Could you open a draft PR? I usually have to play with these lifetime errors to figure them out ðŸ˜…</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/LaBatata101">@LaBatata101</a> on 2025-06-21 02:21</div>
            <div class="timeline-body"><blockquote>
<p>Could you open a draft PR? I usually have to play with these lifetime errors to figure them out ðŸ˜…</p>
</blockquote>
<p>Here it is <a href="https://github.com/astral-sh/ruff/pull/18845">astral-sh/ruff#18845</a></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-06-23 09:06</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 18:50:07 UTC
    </footer>
</body>
</html>
