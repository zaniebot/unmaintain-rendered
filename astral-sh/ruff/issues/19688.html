<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Set `Annotation::is_file_level` in affected lint rules - astral-sh/ruff #19688</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Set <code>Annotation::is_file_level</code> in affected lint rules</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/ruff/issues/19688">#19688</a>
        opened by <a href="https://github.com/ntBre">@ntBre</a>
        on 2025-08-01 14:57
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a></div>
            <div class="timeline-body"><p>The below is in reference to this check added in #19653:</p>
<p>https://github.com/astral-sh/ruff/blob/138188cd4fe0a39975896f8592efbb0dc73ce938/crates/ruff_linter/src/message/mod.rs#L80-L83</p>
<p>But this depends on the ability to cache <code>Diagnostic</code>s more fully than we currently do in <a href="https://github.com/astral-sh/ruff/blob/main/crates/ruff/src/cache.rs#L454"><code>CacheMessage</code></a>. The current caching scheme would lose the <code>is_file_level</code> flag on any <code>Annotation</code>s.</p>
<blockquote>
<p>Would it be much more work to instead change the rules that add file level diagnostics rather than doing this &quot;global&quot; override?</p>
<p>(the rule would have to mutate the <code>Diagnostic</code> after reporting it with <code>report_diagnostic</code>).</p>
<p>The reason I'd prefer this is that it makes it more apparent where we rely on this behavior and it doesn't prevent other rules to use an empty range (e.g. what if we had a rule that enforces module level docstrings. That rule would probably ask you to insert the docstring at 0:0.</p>
</blockquote>
<p><em>Originally posted by @MichaReiser in https://github.com/astral-sh/ruff/pull/19653#discussion_r2247314964</em></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @ntBre by @ntBre on 2025-08-01 14:57</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">internal</span> added by @ntBre on 2025-08-01 14:58</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">diagnostics</span> added by @ntBre on 2025-08-01 14:58</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntBre">@ntBre</a> on 2025-08-04 18:34</div>
            <div class="timeline-body"><p>I dug into this a bit more today, and I think this is very closely tied to removing <code>is_file_level</code> entirely. These are my somewhat rambly notes that I was considering making into a separate issue, but recording them here seems fine for now.</p>
<hr>

<p>Ruff currently uses <code>TextRange::default</code> as a signal for file-level diagnostics that apply to an entire file rather than a specific range within the fiile:</p>
<p>https://github.com/astral-sh/ruff/blob/af8587eabf83fa38fad153bfe25f714524542c07/crates/ruff_linter/src/message/text.rs#L100-L102</p>
<p>We're carrying this behavior forward in https://github.com/astral-sh/ruff/pull/19653 to maintain backwards compatibility for now:</p>
<p>https://github.com/astral-sh/ruff/blob/138188cd4fe0a39975896f8592efbb0dc73ce938/crates/ruff_linter/src/message/mod.rs#L49-L52</p>
<p>In both cases, this suppresses the display of the associated code snippet.</p>
<p>Ruff currently uses this for three distinct cases:</p>
<ul>
<li>the file doesn't exist or is otherwise inaccessible (e.g. <code>io-error</code>)</li>
<li>the file exists but the diagnostic applies to the entire file (e.g. <a href="https://docs.astral.sh/ruff/rules/stdlib-module-shadowing/#stdlib-module-shadowing-a005">stdlib-module-shadowing (A005)</a>)</li>
<li>a normal diagnostic that happens to be at the start of a file (many lint rules, especially in tests)</li>
</ul>
<p>In the new diagnostic model, we can differentiate these. For <code>io-error</code>s and other diagnostics without a file, we should omit an <code>Annotation</code> entirely. In this case, we'll need to include the filename in the message itself, as ty and rustc do:</p>
<pre><code>$ ty check nonexistent.py
error[io]: `/tmp/tmp.gqRJ0jMRZ9/nonexistent.py`: No such file or directory (os error 2)
$ rustc nonexistent.py
error: couldn't read `nonexistent.py`: No such file or directory (os error 2)
</code></pre>
<p>In cases where the diagnostic truly applies to the whole file, we can omit the <code>Span::range</code>:</p>
<p>https://github.com/astral-sh/ruff/blob/dbd067c8698837044f505e7b12e1f733dedec46d/crates/ruff_db/src/diagnostic/mod.rs#L1108-L1112</p>
<p>This renders without a range in our <code>concise</code> output, which is the main reason that this is a breaking change:</p>
<pre><code>example.py: error[test-diagnostic] main diagnostic message
</code></pre>
<p>We may also want to revisit the <code>full</code> rendering here because it still points to the beginning of the file, as Ruff does today:</p>
<pre><code>error[test-diagnostic]: main diagnostic message
 --&gt; example.py:1:1
  |                
1 | hello          
  | ^              
2 | world          
3 | 3              
  |                
</code></pre>
<p>Finally, for ranges that happen to point to the start of the file, we can continue using <code>Some(TextRange::default())</code> and render the snippet at the beginning of the file, just like the example above.</p>
<hr>

<p>After writing that, I think the first and second cases should probably be the same. As shown, we currently render case (2) with a snippet from the file, which doesn't really make sense either. The diagnostic for <code>A005</code>, to reuse that example, applies to the module/file name, so we should just omit an annotation entirely, just like an <code>io-error</code>.</p>
<p>I'm not quite sure what the use-case for an intentional <code>None</code> range on <code>Some(span)</code> would be.</p>
<p>In any case, I think we'll need to assess this for each lint rule, which is the main connection to this issue.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 16:53:09 UTC
    </footer>
</body>
</html>
