<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>B901: Misses `yield` sub-expresisons - astral-sh/ruff #14453</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>B901: Misses <code>yield</code> sub-expresisons</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/issues/14453">#14453</a>
        opened by <a href="https://github.com/MichaReiser">@MichaReiser</a>
        on 2024-11-19 13:37
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a></div>
            <div class="timeline-body"><p>A very contrived example but <code>B901</code> misses yield expressions where they're not the expression of a <code>ExprStmt</code>.</p>
<pre><code class="language-py">def get_file_paths(file_types: Iterable[str] | None = None) -&gt; Iterable[Path]:
    dir_path = Path(&quot;.&quot;)
    if file_types is None:
        return dir_path.glob(&quot;*&quot;)

    for file_type in file_types:
        (yield a for a in dir_path.glob(f&quot;*.{file_type}&quot;))
</code></pre>
<p>Note: we should make sure that we don't traverse into any lambda expressions...</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @MichaReiser on 2024-11-19 13:37</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">good first issue</span> added by @MichaReiser on 2024-11-19 13:37</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-11-19 13:41</div>
            <div class="timeline-body"><blockquote>
<pre><code class="language-python">def get_file_paths(file_types: Iterable[str] | None = None) -&gt; Iterable[Path]:
    dir_path = Path(&quot;.&quot;)
    if file_types is None:
        return dir_path.glob(&quot;*&quot;)

    for file_type in file_types:
        (yield a for a in dir_path.glob(f&quot;*.{file_type}&quot;))
</code></pre>
</blockquote>
<p>hmm, this isn't valid syntax:</p>
<pre><code class="language-pycon">&gt;&gt;&gt; from typing import *
&gt;&gt;&gt; from pathlib import Path
&gt;&gt;&gt; def get_file_paths(file_types: Iterable[str] | None = None) -&gt; Iterable[Path]:
...     dir_path = Path(&quot;.&quot;)
...     if file_types is None:
...         return dir_path.glob(&quot;*&quot;)
... 
...     for file_type in file_types:
...         (yield a for a in dir_path.glob(f&quot;*.{file_type}&quot;))
...         
  File &quot;&lt;python-input-2&gt;&quot;, line 7
    (yield a for a in dir_path.glob(f&quot;*.{file_type}&quot;))
             ^^^
SyntaxError: invalid syntax
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-11-19 13:49</div>
            <div class="timeline-body"><p>hmm, I only tested with our parser. nested yield expressions are definitely valid :)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-11-19 13:53</div>
            <div class="timeline-body"><p>Okay, found one</p>
<pre><code>async def main():
    await (yield x)
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-11-19 13:53</div>
            <div class="timeline-body"><p>Here's another function that is a generator function with a <code>return</code> statement and is not flagged by B901:</p>
<pre><code class="language-py">def f():
    x = yield
    print(x)
    return 42
</code></pre>
<p>This is a generator function that you can <code>send</code> values into:</p>
<pre><code class="language-pycon">&gt;&gt;&gt; def f():
...     x = yield
...     print(x)
...     return 42
...     
&gt;&gt;&gt; y = f()
&gt;&gt;&gt; next(y)
&gt;&gt;&gt; y.send('foo')
foo
Traceback (most recent call last):
  File &quot;&lt;python-input-13&gt;&quot;, line 1, in &lt;module&gt;
    y.send('foo')
    ~~~~~~^^^^^^^
StopIteration: 42
</code></pre>
<p><code>Send</code>ing valued <em>into</em> a generator is, like <code>return</code>ing values from a generator, quite an advanced feature. So if I saw a function like this in code review, I would assume the user knew what they were doing. That doesn't feel like a very principled reason not to emit B901 on it, though; maybe we should. Not sure.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/rabelmervin">@rabelmervin</a> on 2024-11-19 14:18</div>
            <div class="timeline-body"><p>Hi @MichaReiser @AlexWaygood  can I help you fix this issue ?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-11-19 15:10</div>
            <div class="timeline-body"><p>Sure. You can find the code for this rule in this file</p>
<p>https://github.com/astral-sh/ruff/blob/b7e32b0a18487e8c9813e0d189d7a5d625ff5c3f/crates/ruff_linter/src/rules/flake8_bugbear/rules/return_in_generator.rs</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @rabelmervin by @MichaReiser on 2024-11-19 15:10</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/rabelmervin">@rabelmervin</a> on 2024-11-19 15:49</div>
            <div class="timeline-body"><p>Thanks @MichaReiser excited to work on this !</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-01-21 07:35</div>
            <div class="timeline-body"><p>We decided to leave this as is for now because there are some valid patterns that would be flagged if we change the rule to detect all yield usages. See the linked PR</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> removed by @MichaReiser on 2025-01-21 07:35</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">good first issue</span> removed by @MichaReiser on 2025-01-21 07:35</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">rule</span> added by @MichaReiser on 2025-01-21 07:35</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">needs-design</span> added by @MichaReiser on 2025-01-21 07:35</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntBre">@ntBre</a> on 2025-12-29 20:18</div>
            <div class="timeline-body"><p>I left a longer comment on the PR (https://github.com/astral-sh/ruff/pull/21200#issuecomment-3609003602), but I ended up changing this in #21200 before I found this issue.</p>
<p>I'm happy to revert that if needed, but I'll close this as resolved for now.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @ntBre on 2025-12-29 20:18</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 16:51:34 UTC
    </footer>
</body>
</html>
