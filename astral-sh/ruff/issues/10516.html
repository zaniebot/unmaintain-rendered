<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mypy (type) directives no longer relevant after running isort check - astral-sh/ruff #10516</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Mypy (type) directives no longer relevant after running isort check</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/ruff/issues/10516">#10516</a>
        opened by <a href="https://github.com/jaraco">@jaraco</a>
        on 2024-03-21 20:56
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/jaraco">@jaraco</a></div>
            <div class="timeline-body"><p>I'm struggling to create a minimal example, so bear with this more complicated one:</p>
<p>In the <a href="/jaraco/keyring">keyring</a> project, I'm exploring introducing the isort (&quot;I&quot;) linter. When I add it and invoke it on the project, it produces a diff in the <code>keyring/_compat.py</code> module:</p>
<pre><code class="language-shell"> keyring main @ ruff check --select I --fix keyring/_compat.py
Found 1 error (1 fixed, 0 remaining).
</code></pre>
<pre><code class="language-diff"> keyring main @ git diff
diff --git a/keyring/_compat.py b/keyring/_compat.py
index 46868a8..7d7c8fa 100644
--- a/keyring/_compat.py
+++ b/keyring/_compat.py
@@ -4,4 +4,6 @@ __all__ = ['properties']
 try:
     from jaraco.classes import properties  # pragma: no-cover
 except ImportError:
-    from . import _properties_compat as properties  # type: ignore[no-redef] # pragma: no-cover
+    from . import (
+        _properties_compat as properties,  # type: ignore[no-redef] # pragma: no-cover
+    )
</code></pre>
<p>After making that change, the mypy tests start failing:</p>
<pre><code> keyring main @ tox -qq --notest
 keyring main @ .tox/py/bin/mypy keyring/_compat.py
keyring/_compat.py:7: error: Name &quot;properties&quot; already defined (by an import)  [no-redef]
Found 1 error in 1 file (checked 1 source file)
</code></pre>
<p>Note that running mypy from another environment will not suffice - you need mypy in the environment where keyring was installed in order to get the right dependencies and stubs.</p>
<p>Moving the <code># type: ignore[no-redef]</code> directive to the line above fixes the issue:</p>
<pre><code class="language-diff"> keyring main @ git diff
diff --git a/keyring/_compat.py b/keyring/_compat.py
index 46868a8..c06f247 100644
--- a/keyring/_compat.py
+++ b/keyring/_compat.py
@@ -4,4 +4,6 @@ __all__ = ['properties']
 try:
     from jaraco.classes import properties  # pragma: no-cover
 except ImportError:
-    from . import _properties_compat as properties  # type: ignore[no-redef] # pragma: no-cover
+    from . import (  # type: ignore[no-redef]
+        _properties_compat as properties,  # pragma: no-cover
+    )
</code></pre>
<pre><code class="language-shell"> keyring main @ .tox/py/bin/mypy keyring/_compat.py
Success: no issues found in 1 source file
</code></pre>
<p>Relatedly, note also that the coverage directive, which was previously not well placed, also now misses line 7 where it previously exempted it.</p>
<p>What I expect is that an isort <code>--fix</code> should retain the semantic meaning of directives in comments, or at least protect the rewrite in an &quot;unsafe&quot; fixer.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-03-21 21:59</div>
            <div class="timeline-body"><p>Thanks for the clear write-up.</p>
<p>I worry about the behavior of <code>mypy</code> here, the required placement of the suppression comment seems bizarre and inconsistent with suppression comments in other tools. I would be curious to see if they are receptive to supporting a suppression comment in either position (the earlier position applying to the full <code>import</code> expression and the latter to the single line).</p>
<p>Regardless I agree we should not be breaking this. Without further investigation, I think it would be reasonable to mark the fix as unsafe if we detect suppression comments.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @zanieb on 2024-03-21 21:59</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">fixes</span> added by @zanieb on 2024-03-21 21:59</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-03-22 07:54</div>
            <div class="timeline-body"><p>@zanieb I think we shouldn't look at this issue in isolation of <code>isort</code> because the same happens if you format the above code (<a href="https://play.ruff.rs/6dff7d71-2b28-4a6d-9703-20b6dbc76125">Playground</a>). Adding special handling for isort only would limit our options when it comes to integrating <code>isort</code> into the formatter.</p>
<p>For the formatter, pragma comments are handled differently in that they are excluded from the line-width computation. However, we decided not to implement any special placement logic for pragma comments (or suppress formatting) because a) the correct placement depends on the specific pragma comment, e.g. <code>type: ignore</code> and a <code>noqa</code> comment might both need a different placement, and b) disabling formatting for lines ending with pragma comments no longer delivers on the key value proposition, consistent formatting of your code (see https://github.com/astral-sh/ruff/discussions/6670).</p>
<p>I'm open to suggestions for improving pragma comment placement, but I fear moving some pragma comments manually might be necessary. This is inherent to the design decision to encode semantic meaning into comments with no grammar rules.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-03-22 09:47</div>
            <div class="timeline-body"><p>Possibly mypy requires the <code>type: ignore</code> comment to be on the first line of the whole import statement due to the fact that <code>ast.alias</code> nodes in Python's AST (as provided by the stdlib <code>ast</code> module) only have <code>lineno</code> and <code>col_offset</code> attributes on 3.10+. So on older Python versions, mypy likely knows the lineno of the <code>type: ignore</code>, and it knows the lineno of the start of the import statement as a whole, but it doesn't actually know the lineno of the specific import in the multiline import statement that it deems as problematic</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dpoznik">@dpoznik</a> on 2024-05-08 17:39</div>
            <div class="timeline-body"><p>I've run into this issue as well and figured I'd post my example in case helpful:</p>
<pre><code>$ cat foo.py 
from metaflow import batch  # type: ignore
from metaflow import environment  # type: ignore
from metaflow import resources  # type: ignore
from metaflow import Flow, Run, S3, Step, Task, step
$ isort foo.py 
$ python foo.py 
$ mypy foo.py 
Success: no issues found in 1 source file

$ ruff check --select I --fix foo.py
Found 1 error (1 fixed, 0 remaining).
$ cat foo.py
from metaflow import (
    Flow,
    Run,
    S3,
    Step,
    Task,
    batch,  # type: ignore
    environment,  # type: ignore
    resources,  # type: ignore
    step,
)
$ mypy foo.py
foo.py:1: error: Module &quot;metaflow&quot; has no attribute &quot;batch&quot;  [attr-defined]
foo.py:1: error: Module &quot;metaflow&quot; has no attribute &quot;environment&quot;  [attr-defined]
foo.py:1: error: Module &quot;metaflow&quot; has no attribute &quot;resources&quot;  [attr-defined]
Found 3 errors in 1 file (checked 1 source file)
</code></pre>
<p>As indicated in the Issue description, removing the three specific <code># type: ignore</code> directives and adding one to the first line resolves the issue, albeit with slightly altered <code>mypy</code> inspection.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/QuLogic">@QuLogic</a> on 2025-07-05 00:34</div>
            <div class="timeline-body"><p>I'm not sure if it's exactly the same issue, but one I've run into is:</p>
<pre><code>from matplotlib.backends.qt_compat import QT_API
from matplotlib.backends.qt_compat import QtCore, QtGui  # type: ignore[attr-defined]
</code></pre>
<p>Since <code>qt_compat</code> imports any of PyQt/PySide 5/6, there are no type hints for it. There is, however, a type hint for <code>QT_API</code>. So I do want those to be separate, but <code>ruff</code> combines them into:</p>
<pre><code>from matplotlib.backends.qt_compat import (  # type: ignore[attr-defined]
    QT_API,
    QtCore,
    QtGui,
)
</code></pre>
<p>which does not appear problematic at first glance.</p>
<p>However, it is technically different, since now <code>mypy</code> will not try to verify the <code>QT_API</code> attribute. And <code>pyright</code> no longer sees the comment and errors out on the &quot;unknown&quot; symbols.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 16:49:54 UTC
    </footer>
</body>
</html>
