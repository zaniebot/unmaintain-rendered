<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>F821 (undefined imports) false positives (?) in notebooks when using the %run magic - astral-sh/ruff #9644</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>F821 (undefined imports) false positives (?) in notebooks when using the %run magic</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/ruff/issues/9644">#9644</a>
        opened by <a href="https://github.com/tvatter">@tvatter</a>
        on 2024-01-26 09:01
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/tvatter">@tvatter</a></div>
            <div class="timeline-body">Context
<p>I have a setup file  (e.g., IPython magic, display options for pandas, Seaborn visualization settings, etc) which I then import with the <code>%run</code> magic to avoid copy-pasting and making sure my settings are consistent between the different notebooks. Unfortunately, it leads to F821 (undefined imports) in the notebooks, which kinda defeats the purpose.</p>
Question
<p>Is it a false positive? And if not, what is the proper way of achieving this sort of setup across a collection of notebooks while avoiding lintter/formatter errors?</p>
MWE
<p>Let&#x27;s say I have a file called <code>mwe_setup.py</code> that contains:</p>
<pre><code>import matplotlib.pyplot as plt
</code></pre>
<p>And then a file called <code>mwe.ipynb</code> that contains a single code cell</p>
<pre><code>%run mwe_setup.py
fig, ax = plt.subplots()
</code></pre>
<p>Then running <code>ruff check mwe.ipynb</code> results in<code>F821 Undefined name `plt`</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">wish</span> added by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-01-26 09:15</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">linter</span> added by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-01-26 09:15</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/tvatter">@tvatter</a> on 2024-01-30 07:45</div>
            <div class="timeline-body"><p>@charliermarsh Is the fix you wrote for #9648 also supposed to deal with my issue? I still see the false positives unfortunately.</p>
<p>Or had @MichaReiser labelled this as &quot;wish&quot; because imports through the <code>%run</code> magic are known to not be supported by ruff? In which case, what would be a good workaround?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">notebook</span> added by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-01-30 08:20</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-01-30 08:23</div>
            <div class="timeline-body"><p>The challenge is that it requires multi file analysis that ruff doesn&#x27;t support yet. The analyzer needs to stop when seeing <code>%run mwe_setup.py</code>, analyze the file (if it hasn&#x27;t done so already) and merge the scope of the current file with the scope of <code>mwe_setup.py</code>. We aren&#x27;t there yet.</p>
<p>For now, you can try to use https://docs.astral.sh/ruff/settings/#builtins and define <code>plt</code> as a builtin. This has the downside that ruff will never warn about <code>plt</code> not being defined, even if the <code>%run mwe_setup.py</code> is missing.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/tvatter">@tvatter</a> on 2024-01-30 08:47</div>
            <div class="timeline-body"><p>I&#x27;m guessing that my issue is similar to star imports (#8569) as I had also tried this. Looking forward to see the multi file analysis in ruff, this tool is awesome!</p>
<p>Anyway, for my set of notebooks, I use a <code>ruff.toml</code> file containing e.g.</p>
<pre><code>[lint.per-file-ignores]
&quot;mwe_setup.py&quot; = [&quot;F401&quot;]
</code></pre>
<p>to avoid having ruff erase the imports I make in the setup file. Thus, your solution seems like OK as a temporary workaround. I just have to make sure my <code>mwe_setup.py</code> and <code>ruff.toml</code> are &quot;synced&quot;, but it&#x27;s less work than updating every notebook in a collection.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">multifile-analysis</span> added by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-01-30 10:05</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">type-inference</span> added by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-10-24 14:33</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">multifile-analysis</span> removed by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-10-24 14:33</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 18:48:49 UTC
    </footer>
</body>
</html>
