<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>module-import-not-at-top-of-file (E402) - missing support for site.addsitedir() - astral-sh/ruff #16247</title>
    <link rel="stylesheet" href="../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../index.html">Back to index</a>
    </div>

    <h1>module-import-not-at-top-of-file (E402) - missing support for site.addsitedir()</h1>

    <div class="meta">
        <span class="state state-closed">Closed</span>
        <a href="https://github.com/astral-sh/ruff/issues/16247">#16247</a>
        opened by <a href="https://github.com/Sarcasm">@Sarcasm</a>
        on 2025-02-19 09:13
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/Sarcasm">@Sarcasm</a> on 2025-02-19 09:13</div>
            <div class="timeline-body"><h3>Description</h3>
<p>Failing file <code>ruff-E402-addsitedir.py</code>:</p>
<pre><code class="language-python">#!/usr/bin/env python

import os
import site
import sys
import sysconfig

site.addsitedir(
    os.path.join(
        os.path.dirname(os.path.dirname(__file__)),
        sysconfig.get_path(&quot;purelib&quot;, vars={&quot;base&quot;: &quot;.&quot;}),
    )
)

from mypkg.__main__ import main

if __name__ == &quot;__main__&quot;:
    sys.argv[0] = sys.argv[0].removesuffix(&quot;.py&quot;)
    sys.exit(main())
</code></pre>
<p>Ruff check complains:</p>
<pre><code class="language-console">$ ruff check --select E402 ruff-E402-addsitedir.py
ruff-E402-addsitedir.py:15:1: E402 Module level import not at top of file
   |
13 | )
14 | 
15 | from mypkg.__main__ import main
   | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ E402
16 | 
17 | if __name__ == &quot;__main__&quot;:
   |

Found 1 error.
</code></pre>
<p>Looking at the code, <code>sys.path</code> and some others cases are handled</p>
<p>https://github.com/astral-sh/ruff/blob/0.9.6/crates/ruff_linter/src/checkers/ast/mod.rs#L552-L562
https://github.com/astral-sh/ruff/blob/524cf6e5155066132da772b9f84e2e6695f241b8/crates/ruff_linter/src/checkers/ast/mod.rs#L552-L562</p>
<p>but <code>site.addsitedir</code> seems missing, although it appends to <code>sys.path</code> internally:</p>
<p>https://github.com/python/cpython/blob/3.13/Lib/site.py#L238</p>
<p>BTW, thanks for Ruff, it's a great piece of software!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">rule</span> added by @MichaReiser on 2025-02-19 09:44</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">help wanted</span> added by @MichaReiser on 2025-02-19 09:44</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/VascoSch92">@VascoSch92</a> on 2025-02-19 10:00</div>
            <div class="timeline-body"><p>I can do the fix to handle this case if needed ;-)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @VascoSch92 by @MichaReiser on 2025-02-19 10:03</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/16251.html">astral-sh/ruff#16251</a> on 2025-02-19 12:31</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/VascoSch92">@VascoSch92</a> on 2025-02-21 13:17</div>
            <div class="timeline-body"><p>I think this can be closed ;-)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Sarcasm">@Sarcasm</a> on 2025-02-21 13:24</div>
            <div class="timeline-body"><p>Indeed, Github did not notified me automatically of the Pull Request.</p>
<p>Thank you for fixing this so quickly!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @Sarcasm on 2025-02-21 13:24</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:28:15 UTC
    </footer>
</body>
</html>
