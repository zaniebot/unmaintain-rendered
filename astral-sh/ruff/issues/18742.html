<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fixing some rules with debug f-strings introduces a syntax error - astral-sh/ruff #18742</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Fixing some rules with debug f-strings introduces a syntax error</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/issues/18742">#18742</a>
        opened by <a href="https://github.com/MeGaGiGaGon">@MeGaGiGaGon</a>
        on 2025-06-18 03:17
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MeGaGiGaGon">@MeGaGiGaGon</a></div>
            <div class="timeline-body">Summary
<p>I discovered this while messing around with <code>B013</code>, but fixing some rules that contain debug f-strings will break the code:</p>
<pre><code>f&quot;{1=
}&quot;
</code></pre>
<p>Gets turned into</p>
<pre><code>f&quot;{1=\r\n}&quot;
</code></pre>
<p>Which is invalid code.</p>
<p><a href="https://play.ruff.rs/7aaa414b-84ce-4ba2-8b54-1c398680a3b2">playground example using <code>B013</code></a>
<a href="https://play.ruff.rs/ad9ff4d1-6f44-451c-b366-d9954490ff6b">playground example using <code>RUF030</code></a></p>
<p>There are some rules that don&#x27;t break the f-string, for example <code>E713</code> <a href="https://play.ruff.rs/4290bc70-9ac4-46a1-bee6-724f46b13e88">playground</a> or <code>PERF401</code> <a href="https://play.ruff.rs/96b137d2-f28c-4e6e-b8d2-07ff8ac1f546">playground</a> or <code>PLC1802</code> <a href="https://play.ruff.rs/05d46da0-21d3-40af-9cb9-057a2ff9efda">playground</a>. I&#x27;m not sure why these are different.</p>
<p>I did not extensively test every single fixable rule / every single rule category to see which ones have this bug.</p>
Version
<p>playground</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">fixes</span> added by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-06-18 07:59</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-06-18 08:00</div>
            <div class="timeline-body"><p>Yeah, I think almost every fix could potentially break a debug f-string. It would be nice if we could prevent that somehow but I don&#x27;t think it&#x27;s worth the effort, especially considering that debug expressions are mainly intended for debugging.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MeGaGiGaGon">@MeGaGiGaGon</a> on 2025-06-18 15:37</div>
            <div class="timeline-body"><p>I did a bunch more tests and found one that could more conceivably pop up in real code, <code>PLR1714</code> <a href="https://play.ruff.rs/2be939d6-ffb2-4ce3-ad9e-eaf18d2b431d">playground</a>. The issue here isn&#x27;t that these change the behavior, I actually haven&#x27;t found a fix that does that so far. The issue is that they make the code invalid/non-functional due to a syntax error:</p>
<pre><code>PS D:\python_projects&gt; Get-Content issue.py
</code></pre>
<pre><code>foo = &quot;1&quot;
if foo == &quot;1&quot; or foo == f&quot;{1=
}&quot;:
    print(1)
</code></pre>
<pre><code>PS D:\python_projects&gt; py issue.py
</code></pre>
<pre><code>1
</code></pre>
<pre><code>PS D:\python_projects&gt; uvx ruff check issue.py --select PLR --fix --unsafe-fixes
</code></pre>
<pre><code>error: Fix introduced a syntax error. Reverting all changes.

This indicates a bug in Ruff. If you could open an issue at:

    https://github.com/astral-sh/ruff/issues/new?title=%5BFix%20error%5D

...quoting the contents of `issue.py`, the rule codes PLR1714, along with the `pyproject.toml` settings and executed command, we&#x27;d be very appreciative!

issue.py:2:4: PLR1714 Consider merging multiple comparisons. Use a `set` if the elements are hashable.
  |
1 |   foo = &quot;1&quot;
2 |   if foo == &quot;1&quot; or foo == f&quot;{1=
  |  ____^
3 | | }&quot;:
  | |__^ PLR1714
4 |       print(1)
  |
  = help: Merge multiple comparisons

Found 1 error.
[*] 1 fixable with the --fix option.
</code></pre>
<p>And given that these all break the same way, my suspicion is that these rules all share the same code bug, and there is a chance it would be findable/fixable globally.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MeGaGiGaGon">@MeGaGiGaGon</a> on 2025-06-18 19:34</div>
            <div class="timeline-body"><p>Found another one, <code>PIE810</code> <a href="https://play.ruff.rs/c3286971-7c13-4231-b0d8-a55ad24eeae0">playground</a></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from &quot;Fixing B/RUF rules breaks debug f-strings&quot; to &quot;Fixing some rules with debug f-strings introduces a syntax error&quot; by <a href="https://github.com/MeGaGiGaGon">@MeGaGiGaGon</a> on 2025-06-18 19:36</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MeGaGiGaGon">@MeGaGiGaGon</a> on 2025-06-19 01:23</div>
            <div class="timeline-body"><p>I found a bunch more rules from <code>SIM</code> that do this: <code>SIM101</code>, <code>SIM103</code>, <code>SIM108</code>, <code>SIM110</code>, <code>SIM201</code>, <code>SIM202</code>, <code>SIM208</code>, <code>SIM210</code>, <code>SIM211</code>, <code>SIM212</code>, <code>SIM222</code>, <code>SIM401</code> <a href="https://play.ruff.rs/85dc2cc7-fc11-40c5-94b9-c003523620d8">playground</a></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MeGaGiGaGon">@MeGaGiGaGon</a> on 2025-06-19 01:44</div>
            <div class="timeline-body"><p>Looking through some of the <code>SIM</code> fixes that both do and don&#x27;t trigger the bug, I think I found the common thread: They all use <code>Edit::range_replacement</code>. I&#x27;m not sure beyond that why this happens, but in all the broken fixes they seem to use <code>Edit::range_replacement</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-06-25 08:04</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 18:50:05 UTC
    </footer>
</body>
</html>
