<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Disable B018 rule for Marimo notebooks? - astral-sh/ruff #21301</title>
    <link rel="stylesheet" href="../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../index.html">Back to index</a>
    </div>

    <h1>Disable B018 rule for Marimo notebooks?</h1>

    <div class="meta">
        <span class="state state-open">Open</span>
        <a href="https://github.com/astral-sh/ruff/issues/21301">#21301</a>
        opened by <a href="https://github.com/wlach">@wlach</a>
        on 2025-11-06 17:45
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/wlach">@wlach</a> on 2025-11-06 17:45</div>
            <div class="timeline-body"><h3>Summary</h3>
<p>Would it be possible to have the same behaviour for <a href="https://docs.astral.sh/ruff/rules/useless-expression/">B018</a> as we do with ipynb cells for marimo notebooks? Adding a variable to display is pretty common at the end of a cell. As we've been using marimo more and more, this increasingly has become annoying. Obviously you can ignore it on a per-file/directory basis, but that's a tedious process that has to be done over and over as new directories or projects are added to our monorepo.</p>
<p>Marimo notebooks have a fairly deterministic structure that is relatively easy to detect:</p>
<pre><code class="language-py">import marimo

__generated_with = &quot;0.17.6&quot;
app = marimo.App(width=&quot;medium&quot;)


@app.cell
def _():
    # This cell just for imports
    import pandas as pd
    return pd,


@app.cell
def _(pd):
    # 1. Create a silly pandas DataFrame
    data = {&quot;col1&quot;: [1, 2], &quot;col2&quot;: [3, 4]}
    df = pd.DataFrame(data)

    # 2. Display the DataFrame
    # This is the standard notebook pattern for cell output.
    # A linter will incorrectly flag this line as a &quot;useless statement&quot; (B018).
    df
    return


if __name__ == &quot;__main__&quot;:
    app.run()
</code></pre>
<h3>Version</h3>
<p><em>No response</em></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">rule</span> added by @dylwil3 on 2025-11-06 19:29</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dylwil3">@dylwil3</a> on 2025-11-06 19:40</div>
            <div class="timeline-body"><p>Interesting! Can you say a bit more about the precise situation we would ignore here?</p>
<p>Is it something like, all of the following hold for a given expression statement X?</p>
<ol>
<li>X is the last top-level statement in the body of a function <code>f</code> excluding <code>return</code> statements</li>
<li>X is a &quot;useless&quot; expression (as in the usual rule logic)</li>
<li>The function <code>f</code> is decorated with <code>foo.cell</code></li>
<li><code>foo</code> is an instance of the class with qualified name <code>marimo.App</code></li>
</ol>
<p>In particular for (1), does the <code>return</code> statement have to be empty or should the lint rule fire if you're returning something and the preceding statement is a &quot;useless expression&quot;?</p>
<p>(I'm not immediately sold on implementing this, but I want to make sure I understand what it would look like)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntBre">@ntBre</a> on 2025-11-06 19:50</div>
            <div class="timeline-body"><p>I think to some extent this is a request for Marimo notebook support. I searched a bit earlier and surprisingly didn't find an existing issue for the broader support.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/wlach">@wlach</a> on 2025-11-06 19:51</div>
            <div class="timeline-body"><p>For (1) and (2) I'd just use the exact same logic currently in use for ipynb (jupyter) notebooks, which AFAICT is this:</p>
<p>https://github.com/astral-sh/ruff/blob/cb2e277482f30c7b45dd3c5a163fef952d66281a/crates/ruff_linter/src/rules/flake8_bugbear/helpers.rs#L12</p>
<p>(3) and (4) are how I'd envision this working (as an enthusiastic user but non-developer of Marimo). Maybe I'll mention this on the Marimo discord and see if any of the devs there have thoughts.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dylwil3">@dylwil3</a> on 2025-11-06 20:01</div>
            <div class="timeline-body"><blockquote>
<p>For (1) and (2) I'd just use the exact same logic currently in use for ipynb (jupyter) notebooks, which AFAICT is this:</p>
</blockquote>
<p>I guess my question was more about how to translate that logic to Marimo, since I'm not super familiar with it. We can't literally apply that function, since as far as I understand a Marimo notebook is an ordinary Python file - we have no a priori notion of &quot;cell&quot; or cell offsets, etc. So I guess my main question is how to understand the notion of a &quot;cell&quot; in this setup. I can see that one part involves the decorator <code>@app.cell</code>, but I'm mainly confused about how to interpret returned values (does returning a value suppress displaying the last expression?), or whether there are any other differences that may be relevant here.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/wlach">@wlach</a> on 2025-11-07 14:05</div>
            <div class="timeline-body"><blockquote>
<p>I guess my question was more about how to translate that logic to Marimo, since I'm not super familiar with it. We can't literally apply that function, since as far as I understand a Marimo notebook is an ordinary Python file - we have no a priori notion of &quot;cell&quot; or cell offsets, etc. So I guess my main question is how to understand the notion of a &quot;cell&quot; in this setup. I can see that one part involves the decorator <code>@app.cell</code>, but I'm mainly confused about how to interpret returned values (does returning a value suppress displaying the last expression?), or whether there are any other differences that may be relevant here.</p>
</blockquote>
<p>The return values (and function parameters) are hidden from the notebook view, so you're just left with the part of the function before the return statement in the notebook view. E.g. the notebook above translates to:</p>
<p><img width="1436" height="897" alt="Image" src="https://github.com/user-attachments/assets/5d9193ea-5584-48fe-8a08-b88e8c37d995" /></p>
<p>https://molab.marimo.io/notebooks/nb_9zjTe3V6nrjb4F7TshETGk</p>
<p>So to answer your question, no, returning a value doesn't suppress the last expression. The rule is that marimo will always show the expression <em>before</em> the return statement (mimicking the behaviour of jupyter, because the return values are abstracted away from the user when running inside the notebook view). See: https://docs.marimo.io/guides/outputs/</p>
<p>In reply to @ntBre, I personally don't really have any other feature requests for <em>ruff</em> wrt marimo other than this one. Mostly it just works, and catches real problems before they land.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:28:17 UTC
    </footer>
</body>
</html>
