<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>B018 false positive for notebooks - astral-sh/ruff #6586</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>B018 false positive for notebooks</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/issues/6586">#6586</a>
        opened by <a href="https://github.com/david-waterworth">@david-waterworth</a>
        on 2023-08-15 04:34
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/david-waterworth">@david-waterworth</a></div>
            <div class="timeline-body"><p>Commonly with notebooks the <code>result</code> of a calculation is often implicitly printed, i.e.</p>
<pre><code>x = 1 + 2
x
</code></pre>
<p>I believe x.__repl__() is called.</p>
<p><code>ruff</code> reports <code>B018: useless-expression</code>. I'm not sure this is easy to detect as it doesn't have to be the last statement of a cell - i.e. the output of the following is to print x and ignore y.</p>
<pre><code>x = 1 + 2
x
y = x + 2
y
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-08-15 13:02</div>
            <div class="timeline-body"><p>I think this is a case where I'd likely recommend disabling the rule for notebooks. @dhruvmanila, any idea if we could detect whether the expression is the last line in a cell? I know we have the splits for import sorting, but not sure how accessible they are...</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2023-08-15 13:12</div>
            <div class="timeline-body"><p>I would recommend disabling as well. Otherwise, what could be done is using the <a href="https://github.com/astral-sh/ruff/blob/81b1176f9928ca146f4f6a3ab32804e5fcc00c75/crates/ruff/src/jupyter/notebook.rs#L403-L406"><code>cell_offsets</code></a> (aka the cell boundaries) which can be used to detect the last non-empty line of the cell. This would be limited as pointed out by @david-waterworth in the second example where these expressions are present in the middle of the cell.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-08-16 03:48</div>
            <div class="timeline-body"><p>Given:</p>
<pre><code class="language-python">x = 1 + 2
x
y = x + 2
y
</code></pre>
<p>I would assume we want to flag <code>x</code> (second line) as useless but not <code>y</code> (fourth line), but it sounds like neither should be flagged. Why is that?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2023-08-16 03:57</div>
            <div class="timeline-body"><p>Oh yes, you're correct. I just verified that the value of <code>x</code> won't be printed. So, I think it's safe to avoid checking for unused expressions for the last non-empty line i.e., basically if there's an expression before the cell boundary avoid flagging <code>B018</code> for it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-08-16 03:58</div>
            <div class="timeline-body"><p>@david-waterworth - Does that make sense to you? Your initial message said &quot;it doesn't have to be the last statement of a cell&quot;.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">waiting-on-author</span> added by @charliermarsh on 2023-08-16 03:59</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/david-waterworth">@david-waterworth</a> on 2023-08-16 04:23</div>
            <div class="timeline-body"><p>@charliermarsh yes you're correct - I thought it printed the first statement but I checked and it prints the last.</p>
<p>Also</p>
<pre><code>x = 1
x

for i in range(10):
    i
</code></pre>
<p>Doesn't print anything so not really sure how exactly it works and I've not been able to find a definitive description. But it seems to print the value of the last statement but only if it's not indented.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2023-08-16 04:59</div>
            <div class="timeline-body"><blockquote>
<p>Doesn't print anything so not really sure how exactly it works and I've not been able to find a definitive description. But it seems to print the value of the last statement but only if it's not indented.</p>
</blockquote>
<p>I think it's because the entire <code>for</code> loop is a single statement in the AST. The <code>i</code> expression is part of the top level <code>for</code> loop (child node):</p>
<pre><code class="language-python">for i in range(10):
    i
</code></pre>
<p>while in the previous example, the last node is an expression:</p>
<pre><code class="language-python">x
</code></pre>
<p>Expressions evaluate to a value while statements do not and that's why the second example prints the value of <code>x</code> while the first example (<code>for</code> loop) doesn't.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2023-08-16 05:09</div>
            <div class="timeline-body"><p>We might want to ignore <code>B015</code> (useless-comparison) as well.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">waiting-on-author</span> removed by @charliermarsh on 2023-08-23 03:40</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">accepted</span> added by @charliermarsh on 2023-08-23 03:40</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @charliermarsh on 2023-08-23 03:40</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2023-11-14 04:37</div>
            <div class="timeline-body"><p>(Merging this with a general tracking issue: https://github.com/astral-sh/ruff/issues/8669)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @dhruvmanila on 2023-11-14 04:37</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 16:47:59 UTC
    </footer>
</body>
</html>
