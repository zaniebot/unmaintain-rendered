<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formatter: Unicode width is too high - astral-sh/ruff #6499</title>
    <link rel="stylesheet" href="../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../index.html">Back to index</a>
    </div>

    <h1>Formatter: Unicode width is too high</h1>

    <div class="meta">
        <span class="state state-closed">Closed</span>
        <a href="https://github.com/astral-sh/ruff/issues/6499">#6499</a>
        opened by <a href="https://github.com/konstin">@konstin</a>
        on 2023-08-11 11:45
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/konstin">@konstin</a> on 2023-08-11 11:45</div>
            <div class="timeline-body"><p>The following snippet fits visually in pycharm and is kept in this layout by black</p>
<pre><code class="language-python">function_call(
    &quot;aaaaaaaaaaaaaaaaaaaa&quot;, &quot;我隻氣墊船裝滿晒鱔.txt&quot;, &quot;मेरी मँडराने वाली नाव सर्पमीनों से भरी ह&quot;
)
</code></pre>
<p>ruff formats it as</p>
<pre><code class="language-python">function_call(
    &quot;aaaaaaaaaaaaaaaaaaaa&quot;,
    &quot;我隻氣墊船裝滿晒鱔.txt&quot;,
    &quot;मेरी मँडराने वाली नाव सर्पमीनों से भरी ह&quot;,
)
</code></pre>
<p>We likely compute the unicode width of the string too high so that we assume the line is too long</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @konstin on 2023-08-11 11:45</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">formatter</span> added by @konstin on 2023-08-11 11:45</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/6069.html">astral-sh/ruff#6069</a> on 2023-08-11 11:45</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-08-11 12:09</div>
            <div class="timeline-body"><p>How did you measure the width in Pycharm? I understand that Pycharms cursor position (row:column) is character based and not width based.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2023-08-11 13:47</div>
            <div class="timeline-body"><p>Really just visually:</p>
<p><img src="https://github.com/astral-sh/ruff/assets/6826232/9fc1626f-b581-400f-9d03-83a87c4052e9" alt="Untitled" /></p>
<p>The chinese characters line up with two latin characters, the hindi doesn't.</p>
<p>I don't know by which rules which tool measures, but we should try to match what black does</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-08-11 14:03</div>
            <div class="timeline-body"><p>Black migrates to use unicode-width in preview style, but only for strings (not identifiers).</p>
<p>Edit: But we should look into this.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2023-08-11 15:25</div>
            <div class="timeline-body"><p>black does also break in preview mode! I guess it makes more sense by the unicode text width algorithm but it's also odd because it's different from the actual text rendering</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone "Formatter: Alpha" by @MichaReiser on 2023-08-17 09:43</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> removed by @konstin on 2023-08-21 05:58</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">needs-decision</span> added by @konstin on 2023-08-21 05:58</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @konstin by @MichaReiser on 2023-08-22 14:44</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @MichaReiser by @konstin on 2023-08-22 14:45</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Unassigned @konstin by @konstin on 2023-08-22 14:45</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-08-22 14:52</div>
            <div class="timeline-body"><p>@konstin and I talked about this and we must admit, we're confused. I will close this issue because I believe we're doing the right thing. Please open a new issue and link this issue if you're more familiar with CJK characters and/or have reasons to believe that the implementation is incorrect. We'll hopefully be able to figure out the correct behavior together. Reasons for closing:</p>
<ul>
<li>According to @konstin. Our implementation matches black preview style, which is good</li>
<li>The <a href="http://www.unicode.org/reports/tr11/#Recommendations">Unicode spec recommends</a> to tread the ambiguous characters as half-width when displaying but the context cannot be inferred (e.g. by the used font).<blockquote>
<p>Ambiguous characters behave like wide or narrow characters depending on the context (language tag, script identification, associated font, source of data, or explicit markup; all can provide the context). If the context cannot be established reliably, they should be treated as narrow characters by default.</p>
</blockquote>
</li>
<li>The formatter uses <a href="https://docs.rs/unicode-width/latest/unicode_width/trait.UnicodeWidthChar.html#tymethod.width"><code>width</code></a> which treads ambiguous characters as half-width.</li>
</ul>
<p>I also went ahead and pasted the example into my IDE and it seems it exceeds the column width for my configuration (the <code>xx...</code> is exactly 88 characters wide)
<img src="https://github.com/astral-sh/ruff/assets/1203881/9ef32f89-68a5-4cbc-bfc9-e68cb8a7cdd4" alt="image" /></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @MichaReiser on 2023-08-22 14:52</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:28:10 UTC
    </footer>
</body>
</html>
