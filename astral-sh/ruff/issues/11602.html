<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>false positive for PERF203 with try-except-continue-else - astral-sh/ruff #11602</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>false positive for PERF203 with try-except-continue-else</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/issues/11602">#11602</a>
        opened by <a href="https://github.com/trim21">@trim21</a>
        on 2024-05-29 17:41
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/trim21">@trim21</a></div>
            <div class="timeline-body">

<p>ruff 0.6.5 raise false positive for try-except in a look with <code>else</code></p>
<pre><code>import io
import unicodedata


def __clean_rss_invalid_char(s: str):
    with io.StringIO() as f:
        for c in s:
            try:
                unicodedata.name(c)
            except ValueError:
                continue
            else:
                f.write(c)

        return f.getvalue()
</code></pre>
<p>previous issue: <a href="https://github.com/astral-sh/ruff/issues/6535">astral-sh/ruff#6535</a></p>
<p>this looks like <a href="https://github.com/astral-sh/ruff/issues/6535">astral-sh/ruff#6535</a> but it still exists then targeting py38</p>
<p>https://play.ruff.rs/eadb6e43-5f78-4bcd-93f3-2d409bdbf4c8</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from &quot;false positive for PERF203 &quot; to &quot;false positive for PERF203 with try-except-else&quot; by <a href="https://github.com/trim21">@trim21</a> on 2024-05-29 17:41</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/trim21">@trim21</a> on 2024-05-29 17:45</div>
            <div class="timeline-body"><p>Oh, sorry. looks like I&#x27;m actually using ruff 0.4.5.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/trim21">@trim21</a> on 2024-05-29 17:45</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Reopened by <a href="https://github.com/trim21">@trim21</a> on 2024-09-16 01:39</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from &quot;false positive for PERF203 with try-except-else&quot; to &quot;false positive for PERF203 with try-except-continue-else&quot; by <a href="https://github.com/trim21">@trim21</a> on 2024-09-16 04:20</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-09-16 08:50</div>
            <div class="timeline-body"><p>Looking at the code, the reason why the above is flagged and wasn&#x27;t addressed by #6535 is that the rule only checks for <code>continue</code> and <code>break</code> statements inside the <code>try</code> body but not in the except handlers</p>
<p>https://github.com/astral-sh/ruff/blob/f9d818967075df1a1f4d15760c0244f941d77e53/crates/ruff_linter/src/rules/perflint/rules/try_except_in_loop.rs#L106-L108</p>
<p>The rule only applies to Python 310 or older because</p>
<p>https://github.com/astral-sh/ruff/blob/f9d818967075df1a1f4d15760c0244f941d77e53/crates/ruff_linter/src/rules/perflint/rules/try_except_in_loop.rs#L25-L30</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-09-16 09:00</div>
            <div class="timeline-body"><p>I still think the rule should flag the above pattern because whether there&#x27;s a better way to write the above loop depends on the <code>unicodedata</code> API. For example, I think the following could work:</p>
<pre><code>for c in s:
      name = unicodedata.name(&quot;a&quot;, None)

      if name is None:
          continue
      else:
          f.write(c)
</code></pre>
<p>which eliminates the need for try</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">rule</span> added by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-09-16 09:01</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/trim21">@trim21</a> on 2024-09-16 15:13</div>
            <div class="timeline-body"><blockquote>
<p>I still think the rule should flag the above pattern because whether there&#x27;s a better way to write the above loop depends on the <code>unicodedata</code> API. For example, I think the following could work:</p>
<pre><code>for c in s:
      name = unicodedata.name(&quot;a&quot;, None)

      if name is None:
          continue
      else:
          f.write(c)
</code></pre>
<p>which eliminates the need for try</p>
</blockquote>
<p>I don&#x27;t think ruff understand <code>unicodedata.name</code>, it flag this didn&#x27;t base on &quot;whether there&#x27;s a better way&quot;.</p>
<p>because ruff still flag this, and I don&#x27;t think there is a better way to write this:</p>
<pre><code>import requests


def check_url_live(urls: str):
    for url in urls:
        try:
            requests.get(url, timeout=5)
        except ConnectionRefusedError:
            continue
        else:
            print(url)

</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/trim21">@trim21</a> on 2024-09-16 15:28</div>
            <div class="timeline-body"><p>if you think it should flag this, then there is another problem: it doesn&#x27;t flag this:</p>
<pre><code>import unicodedata


def check_url_live(s: str):
    for c in s:
        try:
            unicodedata.name(c)
        except ValueError:
            continue

        print(c)
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-09-16 15:47</div>
            <div class="timeline-body"><blockquote>
<p>because ruff still flag this, and I don&#x27;t think there is a better way to write this:</p>
</blockquote>
<p>Yeah, there&#x27;s probably not a better way to write this and using a noqa comment here seems appropriate.</p>
<blockquote>
<p>if you think it should flag this, then there is another problem: it doesn&#x27;t flag this:</p>
</blockquote>
<p>I would have to double check the upstream rule to understand if this is a bug but the rule currently only flags cases where the <code>try</code> statement is the only statement in the loop body.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-09-16 15:50</div>
            <div class="timeline-body"><p>Going through the history. Ignoring multi-statement loops is intentional, see <a href="https://github.com/astral-sh/ruff/pull/6145">astral-sh/ruff#6145</a></p>
<p>Using noqa comment seems the right solution to deal with cases where using <code>try...except</code> is the only solution because the API doesn&#x27;t provide an alternative way of testing the input. Making this decision isn&#x27;t something that ruff can do (even with better inference).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-09-16 15:50</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/trim21">@trim21</a> on 2024-09-16 23:36</div>
            <div class="timeline-body"><blockquote>
<p>Going through the history. Ignoring multi-statement loops is intentional, see #6145</p>
<p>Using noqa comment seems the right solution to deal with cases where using <code>try...except</code> is the only solution because the API doesn&#x27;t provide an alternative way of testing the input. Making this decision isn&#x27;t something that ruff can do (even with better inference).</p>
</blockquote>
<p>I think we are actully talking about 2 topics here...</p>
<p>Ignoring multi-statement loops is fine to me, and this issue is not about it should or should not ignore multi-statement loops. the &quot;false positive&quot;  is, it didn&#x27;t ignore single <code>try-except(continue)-else</code> statments like multi-statement loops</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 18:48:53 UTC
    </footer>
</body>
</html>
