<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>false positive for PERF203 with try-except-continue-else - astral-sh/ruff #11602</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>false positive for PERF203 with try-except-continue-else</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/issues/11602">#11602</a>
        opened by <a href="https://github.com/trim21">@trim21</a>
        on 2024-05-29 17:41
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/trim21">@trim21</a></div>
            <div class="timeline-body"><!--
Thank you for taking the time to report an issue! We're glad to have you involved with Ruff.

If you're filing a bug report, please consider including the following information:

* List of keywords you searched for before creating this issue. Write them down here so that others can find this issue more easily and help provide feedback.
  e.g. "RUF001", "unused variable", "Jupyter notebook"
* A minimal code snippet that reproduces the bug.
* The command you invoked (e.g., `ruff /path/to/file.py --fix`), ideally including the `--isolated` flag.
* The current Ruff settings (any relevant sections from your `pyproject.toml`).
* The current Ruff version (`ruff --version`).
-->

<p>ruff 0.6.5 raise false positive for try-except in a look with <code>else</code></p>
<pre><code class="language-python">import io
import unicodedata


def __clean_rss_invalid_char(s: str):
    with io.StringIO() as f:
        for c in s:
            try:
                unicodedata.name(c)
            except ValueError:
                continue
            else:
                f.write(c)

        return f.getvalue()
</code></pre>
<p>previous issue: https://github.com/astral-sh/ruff/issues/6535</p>
<p>this looks like https://github.com/astral-sh/ruff/issues/6535 but it still exists then targeting py38</p>
<p>https://play.ruff.rs/eadb6e43-5f78-4bcd-93f3-2d409bdbf4c8</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "false positive for PERF203 " to "false positive for PERF203 with try-except-else" by @trim21 on 2024-05-29 17:41</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/trim21">@trim21</a> on 2024-05-29 17:45</div>
            <div class="timeline-body"><p>Oh, sorry. looks like I'm actually using ruff 0.4.5.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @trim21 on 2024-05-29 17:45</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Reopened by @trim21 on 2024-09-16 01:39</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "false positive for PERF203 with try-except-else" to "false positive for PERF203 with try-except-continue-else" by @trim21 on 2024-09-16 04:20</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-09-16 08:50</div>
            <div class="timeline-body"><p>Looking at the code, the reason why the above is flagged and wasn't addressed by #6535 is that the rule only checks for <code>continue</code> and <code>break</code> statements inside the <code>try</code> body but not in the except handlers</p>
<p>https://github.com/astral-sh/ruff/blob/f9d818967075df1a1f4d15760c0244f941d77e53/crates/ruff_linter/src/rules/perflint/rules/try_except_in_loop.rs#L106-L108</p>
<p>The rule only applies to Python 310 or older because</p>
<p>https://github.com/astral-sh/ruff/blob/f9d818967075df1a1f4d15760c0244f941d77e53/crates/ruff_linter/src/rules/perflint/rules/try_except_in_loop.rs#L25-L30</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-09-16 09:00</div>
            <div class="timeline-body"><p>I still think the rule should flag the above pattern because whether there's a better way to write the above loop depends on the <code>unicodedata</code> API. For example, I think the following could work:</p>
<pre><code class="language-python">for c in s:
      name = unicodedata.name(&quot;a&quot;, None)

      if name is None:
          continue
      else:
          f.write(c)
</code></pre>
<p>which eliminates the need for try</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">rule</span> added by @MichaReiser on 2024-09-16 09:01</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/trim21">@trim21</a> on 2024-09-16 15:13</div>
            <div class="timeline-body"><blockquote>
<p>I still think the rule should flag the above pattern because whether there's a better way to write the above loop depends on the <code>unicodedata</code> API. For example, I think the following could work:</p>
<pre><code class="language-python">for c in s:
      name = unicodedata.name(&quot;a&quot;, None)

      if name is None:
          continue
      else:
          f.write(c)
</code></pre>
<p>which eliminates the need for try</p>
</blockquote>
<p>I don't think ruff understand <code>unicodedata.name</code>, it flag this didn't base on &quot;whether there's a better way&quot;.</p>
<p>because ruff still flag this, and I don't think there is a better way to write this:</p>
<pre><code class="language-python">import requests


def check_url_live(urls: str):
    for url in urls:
        try:
            requests.get(url, timeout=5)
        except ConnectionRefusedError:
            continue
        else:
            print(url)

</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/trim21">@trim21</a> on 2024-09-16 15:28</div>
            <div class="timeline-body"><p>if you think it should flag this, then there is another problem: it doesn't flag this:</p>
<pre><code class="language-python">import unicodedata


def check_url_live(s: str):
    for c in s:
        try:
            unicodedata.name(c)
        except ValueError:
            continue

        print(c)
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-09-16 15:47</div>
            <div class="timeline-body"><blockquote>
<p>because ruff still flag this, and I don't think there is a better way to write this:</p>
</blockquote>
<p>Yeah, there's probably not a better way to write this and using a noqa comment here seems appropriate.</p>
<blockquote>
<p>if you think it should flag this, then there is another problem: it doesn't flag this:</p>
</blockquote>
<p>I would have to double check the upstream rule to understand if this is a bug but the rule currently only flags cases where the <code>try</code> statement is the only statement in the loop body.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-09-16 15:50</div>
            <div class="timeline-body"><p>Going through the history. Ignoring multi-statement loops is intentional, see https://github.com/astral-sh/ruff/pull/6145</p>
<p>Using noqa comment seems the right solution to deal with cases where using <code>try...except</code> is the only solution because the API doesn't provide an alternative way of testing the input. Making this decision isn't something that ruff can do (even with better inference).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @MichaReiser on 2024-09-16 15:50</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/trim21">@trim21</a> on 2024-09-16 23:36</div>
            <div class="timeline-body"><blockquote>
<p>Going through the history. Ignoring multi-statement loops is intentional, see #6145</p>
<p>Using noqa comment seems the right solution to deal with cases where using <code>try...except</code> is the only solution because the API doesn't provide an alternative way of testing the input. Making this decision isn't something that ruff can do (even with better inference).</p>
</blockquote>
<p>I think we are actully talking about 2 topics here...</p>
<p>Ignoring multi-statement loops is fine to me, and this issue is not about it should or should not ignore multi-statement loops. the &quot;false positive&quot;  is, it didn't ignore single <code>try-except(continue)-else</code> statments like multi-statement loops</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 16:50:20 UTC
    </footer>
</body>
</html>
