<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TCH002 false alarm when importing submodule with import..as - astral-sh/ruff #4667</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>TCH002 false alarm when importing submodule with import..as</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/issues/4667">#4667</a>
        opened by <a href="https://github.com/jakkdl">@jakkdl</a>
        on 2023-05-26 09:23
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/jakkdl">@jakkdl</a></div>
            <div class="timeline-body">

not using import..as
<pre><code>from __future__ import annotations

import libcst
import libcst.matchers

my_list: list[libcst.With] = []
dir(libcst.matchers)
</code></pre>
<pre><code>$ ruff --select --isolated TCH002 foo.py
</code></pre>
<p>no errors, working as expected.</p>
using import..as
<pre><code>from __future__ import annotations

import libcst
import libcst.matchers as m

my_list: list[libcst.With] = []
dir(m)
</code></pre>
<pre><code>$ ruff --select --isolated TCH002 foo.py
foo.py:3:8: TCH002 Move third-party import `libcst` into a type-checking block
Found 1 error.
</code></pre>
version
<pre><code>$ ruff --version
ruff 0.0.269
$ python --version
Python 3.11.3
</code></pre>
<p><code>flake8-type-checking</code> handles both cases, so this is solely a bug in ruff.
Popped up in <a href="https://github.com/Zac-HD/flake8-trio/pull/196">Zac-HD/flake8-trio#196</a>#discussion_r1200414885</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2023-05-26 12:02</div>
            <div class="timeline-body"><p>This seems to be similar to the problem faced in <a href="https://github.com/charliermarsh/ruff/issues/4655">charliermarsh/ruff#4655</a>. I&#x27;m guessing the submodule import (<code>import libcst.matchers</code>) is increasing the usage count of <code>libcst</code> import, thus not flagging for your first example. But, in your second example, the aliased import is not increasing the usage.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/jakkdl">@jakkdl</a> on 2023-05-26 12:12</div>
            <div class="timeline-body"><p>Oh interesting, it&#x27;s related but also the reverse. So maybe there&#x27;s two bugs here that cancel out in the first example, where I don&#x27;t care to create a dedicated <code>TYPE_CHECKING</code> block with no performance improvement (since importing <code>libcst.matchers</code> will also import <code>libcst</code>)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-05-26 12:16</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-05-26 12:57</div>
            <div class="timeline-body"><p>Guessing this is a bug in the &quot;strictness&quot; check, whereby we determine whether an import has some other runtime-required import of the same module.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-05-26 13:35</div>
            <div class="timeline-body"><p>@dhruvmanila - Do you wanna take a look? I&#x27;d start by looking at <code>is_implicit_import</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2023-05-26 13:52</div>
            <div class="timeline-body"><p>Yeah, sure!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-05-28 03:58</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/jakkdl">@jakkdl</a> on 2023-05-30 11:52</div>
            <div class="timeline-body"><p>Thanks for the quick fix! :rocket:</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 18:48:36 UTC
    </footer>
</body>
</html>
