<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Build fails - astral-sh/ruff #16910</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Build fails</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/issues/16910">#16910</a>
        opened by <a href="https://github.com/blackteahamburger">@blackteahamburger</a>
        on 2025-03-22 08:47
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/blackteahamburger">@blackteahamburger</a></div>
            <div class="timeline-body"><p><a href="https://github.com/user-attachments/files/19402037/build.log">build.log</a></p>
<pre><code>Compiling lock_api v0.4.12
     Running `/usr/lib/rust/1.85.1/bin/rustc --crate-name build_script_build --edition=2021 /var/tmp/portage/dev-util/ruff-0.11.1/work/cargo_home/gentoo/lock_api-0.4.12/build.rs --error-format=json --json=diagnostic-rendered-ansi,artifacts,future-incompat --crate-type bin --emit=dep-info,link -C embed-bitcode=no -C debug-assertions=off --cfg &#x27;feature=&quot;atomic_usize&quot;&#x27; --cfg &#x27;feature=&quot;default&quot;&#x27; --check-cfg &#x27;cfg(docsrs,test)&#x27; --check-cfg &#x27;cfg(feature, values(&quot;arc_lock&quot;, &quot;atomic_usize&quot;, &quot;default&quot;, &quot;nightly&quot;, &quot;owning_ref&quot;, &quot;serde&quot;))&#x27; -C metadata=a5275b14721d0308 -C extra-filename=-0152df609ee76a87 --out-dir /var/tmp/portage/dev-util/ruff-0.11.1/work/ruff-0.11.1/target/release/build/lock_api-0152df609ee76a87 -C strip=symbols -L dependency=/var/tmp/portage/dev-util/ruff-0.11.1/work/ruff-0.11.1/target/release/deps --extern autocfg=/var/tmp/portage/dev-util/ruff-0.11.1/work/ruff-0.11.1/target/release/deps/libautocfg-918a7c8fc0d04dc5.rlib --cap-lints allow`
error: linking with `x86_64-pc-linux-gnu-cc` failed: exit status: 1
  |
  = note: LC_ALL=&quot;C&quot; PATH=&quot;/usr/lib/rust/1.85.1/lib/rustlib/x86_64-unknown-linux-gnu/bin:/usr/lib/rust/1.85.1//bin:/usr/lib/portage/python3.13/ebuild-helpers:/usr/local/sbin:/usr/local/bin:/usr/bin:/opt/bin:/usr/lib/llvm/20/bin:/usr/lib/llvm/19/bin&quot; VSLANG=&quot;1033&quot; &quot;x86_64-pc-linux-gnu-cc&quot; &quot;-Wl,--version-script=/var/tmp/portage/dev-util/ruff-0.11.1/temp/rustcUEHOr3/list&quot; &quot;-Wl,--no-undefined-version&quot; &quot;-m64&quot; &quot;/var/tmp/portage/dev-util/ruff-0.11.1/temp/rustcUEHOr3/symbols.o&quot; &quot;&lt;6 object files omitted&gt;&quot; &quot;/var/tmp/portage/dev-util/ruff-0.11.1/work/ruff-0.11.1/target/release/deps/rustversion-a353941e08709f1f.9byjbmp4x45ny4hum21o5ebgh.rcgu.rmeta&quot; &quot;&lt;1 object files omitted&gt;&quot; &quot;-Wl,--as-needed&quot; &quot;-Wl,-Bstatic&quot; &quot;/usr/lib/rust/1.85.1/lib/rustlib/x86_64-unknown-linux-gnu/lib/{libproc_macro-0514004aa1b0cb31.rlib,libstd-84c7a1eb39d9ed43.rlib,libpanic_unwind-2a4bea3dd9092b55.rlib,libobject-9fa1daac8e28075c.rlib,libmemchr-0f67e0a54fdb3146.rlib,libaddr2line-c69b02636b537eac.rlib,libgimli-13476498b30919ec.rlib,librustc_demangle-40ea4f0e0a5a8c33.rlib,libstd_detect-86d235630fd6d790.rlib,libhashbrown-3b266cb3836dd4ab.rlib,librustc_std_workspace_alloc-aaf0adf5f39434c4.rlib,libminiz_oxide-9b967d7732995119.rlib,libadler-20c7674da250ed97.rlib,libunwind-800ff58afbb65aaf.rlib,libcfg_if-57097b7212af5a97.rlib,liblibc-7f0d1c037fbc6d8c.rlib,liballoc-546012a4cbec46e2.rlib,librustc_std_workspace_core-f527798b0205c1ed.rlib,libcore-e98755926f458daf.rlib,libcompiler_builtins-d1294607a3d0c268.rlib}&quot; &quot;-Wl,-Bdynamic&quot; &quot;-lgcc_s&quot; &quot;-lutil&quot; &quot;-lrt&quot; &quot;-lpthread&quot; &quot;-lm&quot; &quot;-ldl&quot; &quot;-lc&quot; &quot;-Wl,--eh-frame-hdr&quot; &quot;-Wl,-z,noexecstack&quot; &quot;-L&quot; &quot;/usr/lib/rust/1.85.1/lib/rustlib/x86_64-unknown-linux-gnu/lib&quot; &quot;-o&quot; &quot;/var/tmp/portage/dev-util/ruff-0.11.1/work/ruff-0.11.1/target/release/deps/librustversion-a353941e08709f1f.so&quot; &quot;-Wl,--gc-sections&quot; &quot;-shared&quot; &quot;-Wl,-z,relro,-z,now&quot; &quot;-Wl,--strip-all&quot; &quot;-nodefaultlibs&quot;
  = note: some arguments are omitted. use `--verbose` to show all linker arguments
  = note: /usr/lib/gcc/x86_64-pc-linux-gnu/14/../../../../x86_64-pc-linux-gnu/bin/ld: /usr/lib/rust/1.85.1/lib/rustlib/x86_64-unknown-linux-gnu/lib/libproc_macro-0514004aa1b0cb31.rlib: error adding symbols: file format not recognized
          collect2: error: ld returned 1 exit status
          

error: could not compile `rustversion` (lib) due to 1 previous error

Caused by:
  process didn&#x27;t exit successfully: `/usr/lib/rust/1.85.1/bin/rustc --crate-name rustversion --edition=2018 /var/tmp/portage/dev-util/ruff-0.11.1/work/cargo_home/gentoo/rustversion-1.0.20/src/lib.rs --error-format=json --json=diagnostic-rendered-ansi,artifacts,future-incompat --crate-type proc-macro --emit=dep-info,link -C prefer-dynamic -C embed-bitcode=no -C debug-assertions=off --check-cfg &#x27;cfg(docsrs,test)&#x27; --check-cfg &#x27;cfg(feature, values())&#x27; -C metadata=e99b1634dc3ffa03 -C extra-filename=-a353941e08709f1f --out-dir /var/tmp/portage/dev-util/ruff-0.11.1/work/ruff-0.11.1/target/release/deps -C strip=symbols -L dependency=/var/tmp/portage/dev-util/ruff-0.11.1/work/ruff-0.11.1/target/release/deps --extern proc_macro --cap-lints allow --check-cfg &#x27;cfg(cfg_macro_not_allowed)&#x27; --check-cfg &#x27;cfg(host_os, values(&quot;windows&quot;))&#x27;` (exit status: 1)
warning: build failed, waiting for other jobs to finish...
</code></pre>
<p>Using Gentoo. ruff-0.11.1 build succeed with rust 1.84.1. With <code>RUSTFLAGS=&quot;-Zlinker-features=+lld&quot;</code> and</p>
<pre><code>CC=&quot;clang&quot;
CXX=&quot;clang++&quot;
CPP=&quot;clang-cpp&quot;
AR=&quot;llvm-ar&quot;
NM=&quot;llvm-nm&quot;
RANLIB=&quot;llvm-ranlib&quot;
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-03-22 09:44</div>
            <div class="timeline-body"><p>Can you try running <code>cargo clean</code> and then rebuild?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/blackteahamburger">@blackteahamburger</a> on 2025-03-22 10:36</div>
            <div class="timeline-body"><p>Hmm... I&#x27;m using emerge to build ruff, the build process is in the <a href="https://github.com/gentoo/gentoo/blob/master/dev-util/ruff/ruff-0.11.1.ebuild">ebuild</a>. Anyway, I add <code>cargo clean</code> and there&#x27;s no effect.</p>
<p>I&#x27;m unsure why it invokes gcc. And rust 1.85.1 is OK with all other rust packages in my system.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-03-22 10:52</div>
            <div class="timeline-body"><p>Can you try with removing the <code>RUSTFLAGS</code>.</p>
<p>What I read from the message is that <code>/usr/lib/gcc/x86_64-pc-linux-gnu/14/../../../../x86_64-pc-linux-gnu/bin/ld: /usr/lib/rust/1.85.1/lib/rustlib/x86_64-unknown-linux-gnu/lib/libproc_macro-0514004aa1b0cb31.rlib</code> has an incorrect format. Maybe because it was built using a different format (gcc instead of clang or a different linker or something else).</p>
<p>I just tried locally and Ruff builds fine with 1.85.1</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">question</span> added by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-03-22 10:52</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/blackteahamburger">@blackteahamburger</a> on 2025-03-22 11:12</div>
            <div class="timeline-body"><blockquote>
<p>Can you try with removing the <code>RUSTFLAGS</code>.</p>
</blockquote>
<p>The error remains.</p>
<blockquote>
<p>What I read from the message is that <code>/usr/lib/gcc/x86_64-pc-linux-gnu/14/../../../../x86_64-pc-linux-gnu/bin/ld: /usr/lib/rust/1.85.1/lib/rustlib/x86_64-unknown-linux-gnu/lib/libproc_macro-0514004aa1b0cb31.rlib</code> has an incorrect format. Maybe because it was built using a different format (gcc instead of clang or a different linker or something else).</p>
</blockquote>
<p>It is basically certain that https://github.com/gentoo/gentoo/commit/f65ef3fddd9ef9cc3d2d172f6da9a39231b1e2d1 is the cause. I&#x27;ll file a bug report.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from &quot;Build fails with rust 1.85.1&quot; to &quot;Build fails&quot; by <a href="https://github.com/blackteahamburger">@blackteahamburger</a> on 2025-03-23 04:48</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/blackteahamburger">@blackteahamburger</a> on 2025-03-23 05:06</div>
            <div class="timeline-body"><p>Then there&#x27;s nothing to do with ruff, see https://bugs.gentoo.org/951740. Thank you for the support!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/blackteahamburger">@blackteahamburger</a> on 2025-03-23 05:06</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 18:49:43 UTC
    </footer>
</body>
</html>
