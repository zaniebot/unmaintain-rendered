<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Introduce a Rust module for all lint implementations - astral-sh/ruff #1547</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Introduce a Rust module for all lint implementations</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/issues/1547">#1547</a>
        opened by <a href="https://github.com/not-my-profile">@not-my-profile</a>
        on 2023-01-02 07:41
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/not-my-profile">@not-my-profile</a> on 2023-01-02 07:41</div>
            <div class="timeline-body"><p>The code is currently split up across the following Rust modules:</p>
<ul>
<li>ast</li>
<li>autofix</li>
<li>cache</li>
<li>checkers</li>
<li>checks</li>
<li>checks_gen</li>
<li>cli</li>
<li>commands</li>
<li>cst</li>
<li>directives</li>
<li>docstrings</li>
<li>eradicate</li>
<li>flake8_2020</li>
<li>flake8_annotations</li>
<li>flake8_bandit</li>
<li>flake8_blind_except</li>
<li>flake8_boolean_trap</li>
<li>flake8_bugbear</li>
<li>flake8_builtins</li>
<li>flake8_comprehensions</li>
<li>flake8_datetimez</li>
<li>flake8_debugger</li>
<li>flake8_errmsg</li>
<li>flake8_implicit_str_concat</li>
<li>flake8_import_conventions</li>
<li>flake8_print</li>
<li>flake8_quotes</li>
<li>flake8_return</li>
<li>flake8_simplify</li>
<li>flake8_tidy_imports</li>
<li>flake8_unused_arguments</li>
<li>fs</li>
<li>isort</li>
<li>iterators</li>
<li>lex</li>
<li>lib_native</li>
<li>linter</li>
<li>logging</li>
<li>mccabe</li>
<li>message</li>
<li>noqa</li>
<li>packages</li>
<li>pandas_vet</li>
<li>pep8_naming</li>
<li>printer</li>
<li>pycodestyle</li>
<li>pydocstyle</li>
<li>pyflakes</li>
<li>pygrep_hooks</li>
<li>pylint</li>
<li>python</li>
<li>pyupgrade</li>
<li>resolver</li>
<li>ruff</li>
<li>rustpython_helpers</li>
<li>settings</li>
<li>source_code_generator</li>
<li>source_code_locator</li>
<li>source_code_style</li>
<li>updates</li>
<li>vendor</li>
<li>visibility</li>
</ul>
<p>62 top-level modules is a lot and makes the codebase hard to grasp and navigate, so I recommend moving all modules that implement specific rules/checks/lints (<a href="https://github.com/charliermarsh/ruff/issues/1546">whatever we call  them</a>) under a common  module, so for example:</p>
<ul>
<li>lints<ul>
<li>eradicate</li>
<li>flake8_2020</li>
<li>flake8_annotations</li>
<li>flake8_bandit</li>
<li>flake8_blind_except</li>
<li>flake8_boolean_trap</li>
<li>flake8_bugbear</li>
<li>flake8_builtins</li>
<li>flake8_comprehensions</li>
<li>flake8_datetimez</li>
<li>flake8_debugger</li>
<li>flake8_errmsg</li>
<li>flake8_implicit_str_concat</li>
<li>flake8_import_conventions</li>
<li>flake8_print</li>
<li>flake8_quotes</li>
<li>flake8_return</li>
<li>flake8_simplify</li>
<li>flake8_tidy_imports</li>
<li>flake8_unused_arguments</li>
<li>isort</li>
<li>mccabe</li>
<li>pandas_vet</li>
<li>pep8_naming</li>
<li>pycodestyle</li>
<li>pydocstyle</li>
<li>pyflakes</li>
<li>pygrep_hooks</li>
<li>pylint</li>
<li>pyupgrade</li>
<li>ruff</li>
</ul>
</li>
</ul>
<p>So e.g. <code>ruff:flake8_builtins</code> would become <code>ruff:rules:flake8_builtins</code>, <code>ruff:ruff</code> would become <code>ruff:rules:ruff</code>, etc.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-01-02 17:07</div>
            <div class="timeline-body"><p>This seems reasonable to me.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">internal</span> added by @charliermarsh on 2023-01-02 17:07</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/squiddy">@squiddy</a> on 2023-01-02 17:54</div>
            <div class="timeline-body"><p>Slightly related: Any thoughts on splitting up the code into multiple crates? From my limited understanding this is one way to go for faster compiles. Multiple crates can be compiled in parallel. I did some profiling the other day and a release build takes quite some time because everything is one crate currently.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-01-02 18:34</div>
            <div class="timeline-body"><p>Agreed. Are you interested in exploring that? I'd be happy to review a proposal.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/colin99d">@colin99d</a> on 2023-01-02 22:05</div>
            <div class="timeline-body"><p>I have another question here. I am not aware of a specific example of this happening, but if two lints do the exact same thing, are we ever going to track that and only run it once (or at least have a flag to do this)?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/colin99d">@colin99d</a> on 2023-01-02 22:05</div>
            <div class="timeline-body"><p>For example, I believe pylint and flake8 both have a line length checker.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-01-02 22:18</div>
            <div class="timeline-body"><p>This problem exists today. The way I view it is that we may want a one-to-many mapping between <code>CheckKind</code> and <code>CheckCode</code> -- so we'd only have one implementation of the check, but it could map to multiple valid codes. I'm not sure it's really worth the complexity though.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/squiddy">@squiddy</a> on 2023-01-03 06:01</div>
            <div class="timeline-body"><blockquote>
<p>Agreed. Are you interested in exploring that? I'd be happy to review a proposal.</p>
</blockquote>
<p>Certainly, but with vacations over this will happen on the weekend the earliest. :)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-01-03 12:23</div>
            <div class="timeline-body"><p>Take your time of course, and thank you as always :)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/kaos">@kaos</a> on 2023-01-08 13:15</div>
            <div class="timeline-body"><blockquote>
<p>Slightly related: Any thoughts on splitting up the code into multiple crates? From my limited understanding this is one way to go for faster compiles. Multiple crates can be compiled in parallel. I did some profiling the other day and a release build takes quite some time because everything is one crate currently.</p>
</blockquote>
<p>I'm here hoping to find a crate I could use in a rust project to re-use the AST logic to do some custom node visiting. Perhaps the core AST related parts could be in a published crate? :)
I'm rather new to Rust but happy to assist if this makes sense to y'all..</p>
<p>Edit: Found #1407 which I think could work for my use case as well.
Edit2: Ah, unless it's very high level API only..
Edit3: Or, I see most parsing comes from the <code>rustpython_parser</code> crate, so I might just as well try using that one directly.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/not-my-profile">@not-my-profile</a> on 2023-01-08 14:45</div>
            <div class="timeline-body"><p>@kaos ruff uses the parser from <a href="https://github.com/RustPython/RustPython">RustPython</a>, which unfortunately <a href="https://crates.io/search?q=%22rustpython%22">has not been published to crates.io in over 2 years</a> for some reason. The relevant issue for that is https://github.com/RustPython/RustPython/issues/4179.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-01-08 20:41</div>
            <div class="timeline-body"><p>@kaos - Yeah my suggestion would be to use the RustPython parser. You have to depend on the Git hash directly for now, unfortunately.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/kaos">@kaos</a> on 2023-01-09 00:45</div>
            <div class="timeline-body"><p>I think I can work with that. Thanks for the quick responses. üôèüèΩ</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-01-11 16:35</div>
            <div class="timeline-body"><p>I'd also like to adopt a more typical project structure. E.g., we could follow <code>ripgrep</code>, and have a top-level <code>crates</code> directory,  with a single library facade (<code>crates/grep</code>), and the binary distributed as the top-level <code>Cargo.toml</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/not-my-profile">@not-my-profile</a> on 2023-01-11 16:46</div>
            <div class="timeline-body"><p>I think I'd rather have the crates in the top-level directory, which is also quite common (e.g. <a href="https://github.com/rust-lang/rust-clippy/">clippy has this structure</a>).</p>
<p>However I don't really think it's that important. What I do dislike is the top-level <code>ruff</code> directory since it's non-descriptive ... I think it would make sense to move all the Python-distribution-specific stuff (pyproject.toml etc.)  to <code>ruff_python/</code> or something like that.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-01-11 16:56</div>
            <div class="timeline-body"><p>Happy to review a PR for that if anyone gets around to it, probably requires a bunch of Maturin reconfiguration.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-01-12 00:54</div>
            <div class="timeline-body"><p>A distinction that does seem potentially useful, from <code>ripgrep</code>, is that the library crate is published separately from the binary.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-01-12 03:47</div>
            <div class="timeline-body"><p>Or maybe @messense knows how to rename the top-level <code>ruff</code> dir.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/messense">@messense</a> on 2023-01-12 03:49</div>
            <div class="timeline-body"><p>You could move <code>ruff</code> to <code>python/ruff</code> and set <code>python-source</code> in pyproject.toml</p>
<pre><code class="language-toml">[tool.maturin]
python-source = &quot;python&quot;
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-01-12 03:49</div>
            <div class="timeline-body"><p>Oh nice, thank you very much.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/not-my-profile">@not-my-profile</a> on 2023-01-12 16:14</div>
            <div class="timeline-body"><blockquote>
<p>Slightly related: Any thoughts on splitting up the code into multiple crates? From my limited understanding this is one way to go for faster compiles. Multiple crates can be compiled in parallel. I did some profiling the other day and a release build takes quite some time because everything is one crate currently.</p>
</blockquote>
<p>I opened a dedicated issue for that (#1820) to keep this issue on topic :)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2023-01-14 16:48</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 11:28:44 UTC
    </footer>
</body>
</html>
