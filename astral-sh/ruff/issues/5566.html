<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>`ruff` and `libcst` - astral-sh/ruff #5566</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1><code>ruff</code> and <code>libcst</code></h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/issues/5566">#5566</a>
        opened by <a href="https://github.com/kloczek">@kloczek</a>
        on 2023-07-06 16:34
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/kloczek">@kloczek</a></div>
            <div class="timeline-body"><p>On building <code>ruff</code> I found that it want submodule with libcst</p>
<pre><code>+ /usr/bin/python3 -sBm build -w --no-isolation
* Getting build dependencies for wheel...
* Building wheel...
Running `maturin pep517 build-wheel -i /usr/bin/python3 --compatibility off`
    Updating crates.io index
    Updating git repository `https://github.com/charliermarsh/LibCST`
warning: spurious network error (3 tries remaining): error reading from the zlib stream; class=Zlib (5)
warning: spurious network error (2 tries remaining): error reading from the zlib stream; class=Zlib (5)
warning: spurious network error (1 tries remaining): error reading from the zlib stream; class=Zlib (5)
error: failed to get `libcst` as a dependency of package `ruff v0.0.277 (/home/tkloczko/rpmbuild/BUILD/ruff-0.0.277/crates/ruff)`

Caused by:
  failed to load source for dependency `libcst`

Caused by:
  Unable to update https://github.com/charliermarsh/LibCST?rev=80e4c1399f95e5beb532fdd1e209ad2dbb470438#80e4c139

Caused by:
  failed to fetch into: /home/tkloczko/.cargo/git/db/libcst-50aa4195e5d57b22

Caused by:
  error reading from the zlib stream; class=Zlib (5)
ðŸ’¥ maturin failed
  Caused by: Cargo metadata failed. Does your crate compile with `cargo build`?
  Caused by: `cargo metadata` exited with an error:
Error: command [&#x27;maturin&#x27;, &#x27;pep517&#x27;, &#x27;build-wheel&#x27;, &#x27;-i&#x27;, &#x27;/usr/bin/python3&#x27;, &#x27;--compatibility&#x27;, &#x27;off&#x27;] returned non-zero exit status 1
</code></pre>
<p>However looks like it is not the same libcst which is listed on pypi (https://github.com/Instagram/LibCST/)</p>
<p>Q: why it is not possible to use <code>libcst</code> as installed module and why here is used probably some fork of https://github.com/Instagram/LibCST/? ðŸ¤”</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-07-06 16:40</div>
            <div class="timeline-body"><p>That looks like a spurious network failure. Are you seeing it repeatedly?</p>
<p>(We have to use a Git dependency as LibCST doesn&#x27;t publish to crates.io (this is a Rust dependency actually, not a Python dependency), and we fork as their version has some tooling to enable calling LibCST from Python that we don&#x27;t need for our purposes.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">question</span> added by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-07-06 17:12</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/kloczek">@kloczek</a> on 2023-07-06 19:45</div>
            <div class="timeline-body"><blockquote>
<p>That looks like a spurious network failure. Are you seeing it repeatedly?</p>
</blockquote>
<p>Nope. I&#x27;ve used just tar ball autogenerated from girt tag which by default is generated out of single repo without submodules.</p>
<p>Disclaimer: I don&#x27;t know to much about building/maintaining/packaging rust stuff ..</p>
<p>Moment so it is not possible to write <code>ruff</code> on top of <code>libcst</code> python module? ðŸ¤”
And/or does it mean that if cargo builds exact project it cannot use DSOs generated out of other rust projects and everything is linked statically? ðŸ˜¨
If that is true it may explain why few python modules which are using <code>maturin</code> as pep517 backed produces really huge DSO out of 2-3 KB rust source code ðŸ¤” (sometimes +2MB text code section looking on <code>size</code> command output)  -&gt; if it is true it means that rust really .. really sucks ðŸ˜ž</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-07-06 19:50</div>
            <div class="timeline-body"><p>Nope, you can&#x27;t write <code>ruff</code> on top of the <code>libcst</code> Python module, although I&#x27;m not 100% sure that I understand the question and what that would mean. What are you trying to do exactly? Ruff only ships as a binary, not a library.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/kloczek">@kloczek</a> on 2023-07-07 07:27</div>
            <div class="timeline-body"><blockquote>
<p>Nope, you can&#x27;t write ruff on top of the libcst Python module</p>
</blockquote>
<p>OK so ..</p>
<blockquote>
<p>(We have to use a Git dependency as LibCST doesn&#x27;t publish to crates.io (this is a Rust dependency actually, not a Python dependency), and we fork as their version has some tooling to enable calling LibCST from Python that we don&#x27;t need for our purposes.)</p>
</blockquote>
<p>Did you try to talk with LibCST  maintainer about publishing on crates.io? ðŸ¤”</p>
<p>Nevertheless official LibCST last version is 1.0.1 and that one on https://github.com/charliermarsh/LibCST is 0.0.1 (looks like typo and probably it should be 1.0.1 as well).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/kloczek">@kloczek</a> on 2023-07-07 11:32</div>
            <div class="timeline-body"><p>Nevertheless still cannot build <code>ruff</code> and <code>build</code> with the same errors ..</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-07-07 13:35</div>
            <div class="timeline-body"><p>Yeah, there&#x27;s a note in their README that they want to do it, pull requests are welcome, etc.: https://github.com/Instagram/LibCST/blob/a3f5bf97d631e79c3395a249e15645cfbc225a4d/native/libcst/README.md?plain=1#L10C1-L10C1. It&#x27;s low enough priority for us that I&#x27;m unlikely to do the work required to support it right now, but I will file an issue to make them aware that we would consume it.</p>
<blockquote>
<p>Nevertheless official LibCST last version is 1.0.1 and that one on https://github.com/charliermarsh/LibCST is 0.0.1 (looks like typo and probably it should be 1.0.1 as well).</p>
</blockquote>
<p>I think you&#x27;re confusing the Python library version with the Rust crate which follows different versioning: https://github.com/Instagram/LibCST/blob/main/native/libcst/Cargo.toml.</p>
<p>I&#x27;m happy to help with your build issue if you&#x27;re able to explain what you&#x27;re trying to do (i.e., why you&#x27;re trying to build Ruff from source) and the error you&#x27;re running into (the above looks like a spurious network failure from a Git clone and not related to Ruff, are you seeing it repeatedly?) but right now it&#x27;s hard to help here based on the info above.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-07-07 13:35</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/kloczek">@kloczek</a> on 2023-08-31 17:42</div>
            <div class="timeline-body"><p>I&#x27;m still struggling with complete proper build procedure using isolated from the internet build env.
I&#x27; trying to use ruff and https://github.com/Instagram/LibCST/ (1.0.1) tar balls downloaded from git tags.</p>
<p>My understanding is that LibCST tar ball or its part needs to be placed somewhere in ruff source tree.
May I ask for some hints about how to complete source tree assembly procedure using above resources? ðŸ¤”</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2023-08-31 17:46</div>
            <div class="timeline-body"><p>Perhaps https://github.com/astral-sh/ruff/discussions/6680 is a good place for discussion.</p>
<p>I&#x27;d recommend looking into <code>cargo vendor</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/kloczek">@kloczek</a> on 2023-08-31 17:51</div>
            <div class="timeline-body"><p>@wuch-g2v is my coworker ðŸ˜‹
We&#x27;ve been trying to complete build procedure however soe far no success ðŸ˜ž</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/kloczek">@kloczek</a> on 2023-08-31 17:53</div>
            <div class="timeline-body"><p>I&#x27;ve been trying to use <code>cargo vendor</code> ..</p>
<pre><code>[tkloczko@pers-jacek ruff-0.0.286]$ cargo vendor
    Updating crates.io index
    Updating git repository `https://github.com/Instagram/LibCST.git`
warning: spurious network error (3 tries remaining): error reading from the zlib stream; class=Zlib (5)
warning: spurious network error (2 tries remaining): error reading from the zlib stream; class=Zlib (5)
warning: spurious network error (1 tries remaining): error reading from the zlib stream; class=Zlib (5)
error: failed to sync

Caused by:
  failed to load pkg lockfile

Caused by:
  failed to get `libcst` as a dependency of package `ruff v0.0.286 (/home/tkloczko/rpmbuild/BUILD/ruff-0.0.286/crates/ruff)`

Caused by:
  failed to load source for dependency `libcst`

Caused by:
  Unable to update https://github.com/Instagram/LibCST.git?rev=3cacca1a1029f05707e50703b49fe3dd860aa839#3cacca1a

Caused by:
  failed to fetch into: /home/tkloczko/.cargo/git/db/libcst-b143b6626bde5d59

Caused by:
  error reading from the zlib stream; class=Zlib (5)
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2023-08-31 18:04</div>
            <div class="timeline-body"><p>@kloczek you&#x27;ll need to vendor the dependencies <em>with</em> internet then take the repository w/ the bundled dependencies and build from that on your offline machine.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/kloczek">@kloczek</a> on 2023-08-31 18:53</div>
            <div class="timeline-body"><p>Above was executed on system with access to public network.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2023-08-31 19:07</div>
            <div class="timeline-body"><p>Hm. Sorry, it runs fine on my machine so unfortunately I cannot provide more guidance. The message sure makes it look like a networking issue though.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 18:48:38 UTC
    </footer>
</body>
</html>
