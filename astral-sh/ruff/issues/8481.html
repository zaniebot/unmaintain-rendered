<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formatter: Bug with Pragma Comment for pyright being moved to invalid position - astral-sh/ruff #8481</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Formatter: Bug with Pragma Comment for pyright being moved to invalid position</h1>

    <div class="meta">
        <span class="state state-closed">Closed</span>
        <a href="https://github.com/astral-sh/ruff/issues/8481">#8481</a>
        opened by <a href="https://github.com/roshanjrajan-zip">@roshanjrajan-zip</a>
        on 2023-11-03 21:58
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/roshanjrajan-zip">@roshanjrajan-zip</a> on 2023-11-03 21:58</div>
            <div class="timeline-body"><!--
Thank you for taking the time to report an issue! We're glad to have you involved with Ruff.

If you're filing a bug report, please consider including the following information:


* A minimal code snippet that reproduces the bug.
* The command you invoked (e.g., `ruff /path/to/file.py --fix`), ideally including the `--isolated` flag.
* The current Ruff settings (any relevant sections from your `pyproject.toml`).
* The current Ruff version (`ruff --version`).
-->

<p>Trying to enable ruff formatter on my repo and am getting an error when using in conjunction with a #pyright pragma comment. Its a bit convoluted of an example but this does error out. The <code># pyright: ignore[reportUnknownVariableType]</code> should apply to the <code>for a in</code> line however keeps getting moved to where the parentheses is. If I try and move the parentheses or comment to the same line, it moves it back to what it looks like below. Interesting enough, in VsCode it moves the parentheses on the first save and then moves parentheses and comment later again on subsequent saves/running from terminal.</p>
<p>Code example:</p>
<pre><code class="language-python">def test_function(
    very_long_dictionary: dict,  # pyright:ignore
):
    something = [
        a[&quot;foo&quot;]
        for a in
        (  # pyright: ignore[reportUnknownVariableType]
            very_long_dictionary.get(
                &quot;longer_key_name&quot;  # pyright: ignore
            )
            or []
        )
    ]
</code></pre>
<p>Running on ruff v0.1.3. Edit: Error still shows up on v0.1.4.</p>
<p>No specific rules for ruff format and config looks like this</p>
<pre><code class="language-toml">select = [
  &quot;F&quot;,      
  &quot;I&quot;,     
  &quot;RUF100&quot;, 
  &quot;UP004&quot;,  
  &quot;UP005&quot;,  
  &quot;UP006&quot;, 
  &quot;UP007&quot;,  
  &quot;UP010&quot;, 
  &quot;UP011&quot;, 
  &quot;UP012&quot;, 
  &quot;UP013&quot;, 
  &quot;UP015&quot;, 
  &quot;UP017&quot;,
  &quot;UP018&quot;,
  &quot;UP024&quot;, 
  &quot;UP027&quot;, 
  &quot;UP034&quot;, 
  &quot;UP037&quot;, 

]
exclude = [&quot;.git&quot;, &quot;__pycache__&quot;]
extend-safe-fixes = [&quot;UP006&quot;, &quot;UP007&quot;]
line-length = 88
target-version = &quot;py311&quot;

[isort]
required-imports = [&quot;from __future__ import annotations&quot;]

</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">formatter</span> added by @charliermarsh on 2023-11-04 13:38</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/roshanjrajan-zip">@roshanjrajan-zip</a> on 2023-11-07 02:04</div>
            <div class="timeline-body"><p>Any help would be greatly appreciated! I hoped it would be fixed here - https://github.com/astral-sh/ruff/pull/8431? But it does seem to be along the same avenue.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2023-11-07 03:23</div>
            <div class="timeline-body"><p>Can you provide the original source code? The way you're describing the comment place, is it like this:</p>
<pre><code class="language-python">		# pyright: ignore[reportUnknownVariableType]
        for a in
        (
</code></pre>
<p>Or,</p>
<pre><code class="language-python">        for a in  # pyright: ignore[reportUnknownVariableType]
        (
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/roshanjrajan-zip">@roshanjrajan-zip</a> on 2023-11-07 17:44</div>
            <div class="timeline-body"><p>It should be the second one. The code that I shared should show the same result that I am describing. Are you not able to reproduce it?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/roshanjrajan-zip">@roshanjrajan-zip</a> on 2023-11-11 04:00</div>
            <div class="timeline-body"><p>Unfortunately I can't even use <code># fmt:skip</code> on the same line as the #pyright pragma comment to skip this change. The only way to get past this is to add the <code># fmt:skip</code> on the line with just the parentheses.</p>
<pre><code class="language-python">def test_function(
    very_long_dictionary: dict,  # pyright:ignore
):
    something = [
        a[&quot;foo&quot;]
        for a in  # pyright: ignore[reportUnknownVariableType]
        (  # fmt:skip &lt;- Needed to add this here
            very_long_dictionary.get(
                &quot;longer_key_name&quot;  # pyright: ignore
            )
            or []
        )
    ]
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/roshanjrajan-zip">@roshanjrajan-zip</a> on 2023-11-11 08:59</div>
            <div class="timeline-body"><p>Okay I got a way to reproduce this on terminal as it happens consistently in VSCode but not in terminal...
I suspect I see this in VSCode consistently because its probably run without cache across runs since it only formats the file on save.</p>
<p>Context: The most important line is where the <code># pyright: ignore[reportUnknownVariableType]</code> is placed. It is supposed to be applied to the variable <code>a</code> and putting it on a different line invalidates its application when using pyright.</p>
<p>Code is in file test.py
Step 1. Copy code snippet to test.py</p>
<pre><code class="language-python"># test.py
def test_function(
    very_long_dictionary: dict,  # pyright:ignore
):
    something = [
        a[&quot;foo&quot;]
        for a in  # pyright: ignore[reportUnknownVariableType]
        ( 
            very_long_dictionary.get(
                &quot;longer_key_name&quot;  # pyright: ignore
            )
            or []
        )
    ]
</code></pre>
<p>Step 2. Run <code>ruff format --no-cache test.py</code>.
It should look like this. This is a valid case and is a perfectly valid solution.</p>
<pre><code class="language-python"># test.py
def test_function(
    very_long_dictionary: dict,  # pyright:ignore
):
    something = [
        a[&quot;foo&quot;]
        for a in (  # pyright: ignore[reportUnknownVariableType]
            very_long_dictionary.get(
                &quot;longer_key_name&quot;  # pyright: ignore
            )
            or []
        )
    ]
</code></pre>
<p>Step 3. Run <code>ruff format --no-cache test.py</code>.
It should now look like this which is incorrect. The comment isn't on the correct line and any further <code>ruff format --no-cache test.py</code> will keep the code as is.</p>
<pre><code class="language-python"># test.py
def test_function(
    very_long_dictionary: dict,  # pyright:ignore
):
    something = [
        a[&quot;foo&quot;]
        for a in 
        (  # pyright: ignore[reportUnknownVariableType]
            very_long_dictionary.get(
                &quot;longer_key_name&quot;  # pyright: ignore
            )
            or []
        )
    ]
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/roshanjrajan-zip">@roshanjrajan-zip</a> on 2023-11-13 05:04</div>
            <div class="timeline-body"><p>I think this maybe be related to this other<a href="https://github.com/astral-sh/ruff/issues/8644"> issue that I am creating to take about differences in no_cache</a>.
Uncertain whether it is the no_cache causing the problem or the way that the pragma comment is formatted.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/roshanjrajan-zip">@roshanjrajan-zip</a> on 2023-11-15 21:21</div>
            <div class="timeline-body"><p>@MichaReiser Do you have any code pointers of why there might be instability here? I'm trying to look at https://github.com/astral-sh/ruff/pull/8431 to see if there is anything there but uncertain.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @zanieb on 2023-11-16 03:01</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-11-27 06:37</div>
            <div class="timeline-body"><p>This isn't related to caching but is an instability bug where the formatter requires two passes to reach the ultimate formatting (unfortunately, the worse). You can see this in the <a href="https://play.ruff.rs/e285517c-1b83-40a9-9729-f7986b021c66">Playground</a> where I copied the formatted code of the input as the second example.</p>
<p>The issue comes from that the comment is a dangling comment of the comprehension when formatting the input source, but becomes a leading comment of <code>b.get</code> when formatting it the second time.</p>
<p>A workaround to unblock you is to suppress formatting of the entire statement:</p>
<pre><code class="language-python">something = [
    a
    for a in # pyright: ignore[reportUnknownVariableType]
    (  
        b.get(
            &quot;longer_key_name&quot;,
        )
    )
] # fmt: skip
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone "Formatter: Stable" by @MichaReiser on 2023-11-27 06:37</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-09-16 16:09</div>
            <div class="timeline-body"><p>This has been fixed by https://github.com/astral-sh/ruff/pull/12282 (preview only)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @MichaReiser on 2024-09-16 16:09</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/roshanjrajan">@roshanjrajan</a> on 2024-10-31 23:00</div>
            <div class="timeline-body"><p>Thank you so much! ❤️</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:34:51 UTC
    </footer>
</body>
</html>
