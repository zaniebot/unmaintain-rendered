<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Update `Indexer` to use new tokens to compute the ranges - astral-sh/ruff #7290</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Update `Indexer` to use new tokens to compute the ranges</h1>

    <div class="meta">
        <span class="state state-closed">Closed</span>
        <a href="https://github.com/astral-sh/ruff/issues/7290">#7290</a>
        opened by <a href="https://github.com/dhruvmanila">@dhruvmanila</a>
        on 2023-09-12 09:42
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2023-09-12 09:42</div>
            <div class="timeline-body"><p>The <code>Indexer</code> needs to be updated to use the new f-string tokens to compute the following ranges:</p>
<ol>
<li>F-string ranges</li>
<li>Triple-quoted string ranges</li>
</ol>
<p>The f-string ranges (1) can be computed using the start range of a <code>FStringStart</code> token to the end range of a <code>FStringEnd</code> token. Here, a stack would probably be required as f-strings can be nested and we need to pick up the correct start value for the current end value. It would be similar to computing the ranges of parentheses pair in <code>(foo, (bar, baz), another, (start, (nested, done), nope), last)</code>.</p>
<p>A <code>FStringStart</code>/<code>FStringEnd</code> token consists of prefixes (<code>f</code>, <code>fr</code>, etc.) and quotes. Using this information we can detect if a f-string is tripled-quoted or not using either of the following proposed solutions:</p>
<ol>
<li>Using the <code>Locator</code>, we can extract out the source for the <code>FStringStart</code> token using the token range, extract the quotes using <a href="https://github.com/astral-sh/ruff/blob/a4a4616f0a49c6b1ff7da93a71308d897d27d21f/crates/ruff_python_ast/src/str.rs#L158-L172"><code>leading_quote</code></a> and use the <code>.text_len</code> method to check the number of quotes.</li>
<li>We can store additional information in the <code>FStringStart</code> token itself in the form of <a href="https://github.com/astral-sh/ruff/blob/a4a4616f0a49c6b1ff7da93a71308d897d27d21f/crates/ruff_python_parser/src/lexer/fstring.rs#L5-L21">bitflags</a> or boolean values similar to <code>FStringMiddle</code>. This can then be used to check if it's a tripled-quoted f-string or not.</li>
</ol>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/7299.html">astral-sh/ruff#7299</a> on 2023-09-12 09:45</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">rule</span> added by @dhruvmanila on 2023-09-12 09:45</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">python312</span> added by @dhruvmanila on 2023-09-12 09:45</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">rule</span> removed by @dhruvmanila on 2023-09-12 09:47</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">core</span> added by @dhruvmanila on 2023-09-12 09:47</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @dhruvmanila by @dhruvmanila on 2023-09-13 02:31</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/7325.html">astral-sh/ruff#7325</a> on 2023-09-13 04:41</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @dhruvmanila on 2023-09-19 06:26</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:34:51 UTC
    </footer>
</body>
</html>
