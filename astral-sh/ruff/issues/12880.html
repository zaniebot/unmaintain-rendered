<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>&quot;Fix all&quot; code action on notebook causes panic with multi-byte character - astral-sh/ruff #12880</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>&quot;Fix all&quot; code action on notebook causes panic with multi-byte character</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/issues/12880">#12880</a>
        opened by <a href="https://github.com/sato1214syun">@sato1214syun</a>
        on 2024-08-14 06:33
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sato1214syun">@sato1214syun</a></div>
            <div class="timeline-body"><ul>
<li><p>List of keywords you searched for before creating this issue. Write them down here so that others can find this issue more easily and help provide feedback.
keywords: panic, Q000</p>
</li>
<li><p>A minimal code snippet that reproduces the bug.
<a href="https://github.com/user-attachments/files/16608365/test.zip">test.zip</a></p>
</li>
<li><p>The command you invoked (e.g., <code>ruff /path/to/file.py --fix</code>), ideally including the <code>--isolated</code> flag.
Implemented formatOnSave of VSCode for notebook</p>
</li>
<li><p>The current Ruff settings (any relevant sections from your <code>pyproject.toml</code>).
<a href="https://github.com/user-attachments/files/16608416/ruff.toml.zip">ruff.toml.zip</a></p>
</li>
<li><p>The current Ruff version (<code>ruff --version</code>).
ruff 0.5.7
ruff vscode extension v2024.40.0</p>
</li>
</ul>
<p>Eror message</p>
<pre><code>2024-08-14 15:23:07.676 [info] panicked at crates/ruff_server/src/edit/range.rs:196:39:
byte index 161 is not a char boundary; it is inside 'あ' (bytes 159..162) of `&quot;&quot;&quot;aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa.&quot;&quot;&quot;
'あaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa`[...]

2024-08-14 15:23:07.678 [info]    0: std::backtrace::Backtrace::force_capture
   1: ruff_server::server::Server::
2024-08-14 15:23:07.678 [info] run
   2: std::panicking::rust_panic_with_hook
   3: &lt;std::panicking::begin_panic_handler::StaticStrPayload as core::panic::PanicPayload&gt;::take_box
   4: &lt;std::sys_common::backtrace::_print::DisplayBacktrace as core::fmt::Display&gt;::fmt
   5: _rust_begin_unwind
   6: core::panicking::panic_fmt
   7: core::str::slice_error_fail_rt
   8: core::str::slice_error_fail
   9: &lt;ruff_server::server::api::Error as core::fmt::Display&gt;::fmt
  10: 
2024-08-14 15:23:07.678 [info] &lt;ruff_text_size::range::TextRange as ruff_server::edit::range::ToRangeExt&gt;::to_range
  11: ruff_server::edit::text_document::TextDocument::apply_changes
  12: &lt;ruff_server::server::api::requests::code_action_resolve::CodeActionResolve as ruff_server::server::api::traits::BackgroundDocumentRequestHandler&gt;::run_with_snapshot
  13: &lt;ruff_server::server::api::requests::code_action_resolve::CodeActionResolve as ruff_server
2024-08-14 15:23:07.678 [info] ::server::api::traits::BackgroundDocumentRequestHandler&gt;::run_with_snapshot
  14: &lt;ruff_server::session::capabilities::ResolvedClientCapabilities as core::fmt::Display&gt;::fmt
  15: &lt;ruff_server::server::api::requests::diagnostic::DocumentDiagnostic as ruff_server::server::api::traits::BackgroundDocumentRequestHandler&gt;::run_with_snapshot
  16: &lt;ruff_server::server::api::requests::diagnostic::DocumentDiagnostic as ruff_server::server::api::traits::BackgroundDocumentRequestHandler&gt;::run_with_snapshot
  17: &lt;ruff_server::server::api
2024-08-14 15:23:07.679 [info] ::requests::diagnostic::DocumentDiagnostic as ruff_server::server::api::traits::BackgroundDocumentRequestHandler&gt;::run_with_snapshot
  18: std::sys::pal::unix::thread::Thread::new
  19: __pthread_joiner_wake
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-08-14 07:08</div>
            <div class="timeline-body"><p>(I'll look into this in some time.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @MichaReiser on 2024-08-14 07:11</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">server</span> added by @MichaReiser on 2024-08-14 07:11</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-08-14 12:57</div>
            <div class="timeline-body"><p>Thank you for providing all the details. Although, I'm unable to reproduce this panic. Can you provide your VS Code settings? By &quot;formatOnSave&quot;, do you mean <code>notebook.formatOnSave.enabled</code> setting?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sato1214syun">@sato1214syun</a> on 2024-08-14 18:59</div>
            <div class="timeline-body"><p>Thank you @dhruvmanila for investigating. It happens when I press &quot;command + s&quot; or implement &quot;Ruff: fix all auto-fixable problems&quot; in command palette.</p>
<p>Environment:
M1 mac
MacOS 14.5
vscode version 1.92.1</p>
<p>My vscode profile for python is below.</p>
<pre><code>{
  // python
  &quot;python.analysis.autoFormatStrings&quot;: true,
  &quot;python.analysis.gotoDefinitionInStringLiteral&quot;: true,
  &quot;python.analysis.inlayHints.callArgumentNames&quot;: &quot;partial&quot;,
  &quot;python.analysis.inlayHints.functionReturnTypes&quot;: true,
  &quot;python.analysis.inlayHints.pytestParameters&quot;: true,
  &quot;python.analysis.inlayHints.variableTypes&quot;: true,
  &quot;python.languageServer&quot;: &quot;Pylance&quot;,
  // ruff
  &quot;[python]&quot;: {
    &quot;editor.formatOnSave&quot;: true,
    &quot;editor.defaultFormatter&quot;: &quot;charliermarsh.ruff&quot;,
    &quot;editor.codeActionsOnSave&quot;: {
      &quot;source.fixAll&quot;: &quot;explicit&quot;,
      &quot;source.organizeImports.&quot;: &quot;explicit&quot;,
    },
  },
  &quot;notebook.formatOnCellExecution&quot;: true,
  &quot;notebook.formatOnSave.enabled&quot;: true,
  &quot;notebook.codeActionsOnSave&quot;: {
    &quot;notebook.source.fixAll&quot;: &quot;explicit&quot;,
    &quot;notebook.source.organizeImports&quot;: &quot;explicit&quot;,
  },
  // jupyter
  &quot;jupyter.askForKernelRestart&quot;: false,
  &quot;jupyter.interactiveWindow.creationMode&quot;: &quot;perFile&quot;,
  // other extension
  &quot;markdown.extension.math.enabled&quot;: false,
  &quot;git.suggestSmartCommit&quot;: false,
  &quot;workbench.colorTheme&quot;: &quot;Default Dark+&quot;,
  &quot;github.copilot.editor.enableAutoCompletions&quot;: true,
  &quot;editor.fontFamily&quot;: &quot;\&quot;Bizin Gothic Discord NF\&quot;, Menlo, Monaco, 'Courier New', monospace&quot;,
  &quot;workbench.editorAssociations&quot;: {
    &quot;{git,gitlens}:/**/*.{md,csv,svg}&quot;: &quot;default&quot;
  },
  &quot;autoDocstring.docstringFormat&quot;: &quot;numpy&quot;,
  &quot;dataWrangler.enabledFileTypes&quot;: {
    &quot;csv&quot;: false,
    &quot;tsv&quot;: false
  },
}
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-08-16 04:01</div>
            <div class="timeline-body"><p>Thanks for providing the details. I can reproduce it using the &quot;Fix all&quot; code action.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "formatOnSave on notebook causes panic with code including multi-byte character, specific code length and Q000 " to ""Fix all" code action on notebook causes panic with code including multi-byte character" by @dhruvmanila on 2024-08-16 04:02</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from ""Fix all" code action on notebook causes panic with code including multi-byte character" to ""Fix all" code action on notebook causes panic with multi-byte character" by @dhruvmanila on 2024-08-16 04:02</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-08-16 04:03</div>
            <div class="timeline-body"><p>It doesn't occur when performing the action via the command-line (<code>ruff check --fix</code>) so it must be in this function (<code>&lt;ruff_text_size::range::TextRange as ruff_server::edit::range::ToRangeExt&gt;::to_range</code>)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @dhruvmanila by @dhruvmanila on 2024-08-16 13:44</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @dhruvmanila on 2024-08-16 14:20</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @dhruvmanila on 2024-08-16 14:20</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 16:50:52 UTC
    </footer>
</body>
</html>
