<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[red-knot] PEP 561 compliant module resolver - astral-sh/ruff #11653</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[red-knot] PEP 561 compliant module resolver</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/issues/11653">#11653</a>
        opened by <a href="https://github.com/carljm">@carljm</a>
        on 2024-05-31 21:48
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a></div>
            <div class="timeline-body"><p>(Or intentional choices to diverge from PEP 561 compliance.)</p>
<p>Subtasks:</p>
<ul>
<li>[x] Vendor typeshed&#x27;s stubs: <a href="https://github.com/astral-sh/ruff/pull/11340">astral-sh/ruff#11340</a></li>
<li>[x] Add automation for keeping typeshed&#x27;s stubs up to date: <a href="https://github.com/astral-sh/ruff/pull/11427">astral-sh/ruff#11427</a></li>
<li>[x] Implement <code>--custom-typeshed-dir</code> internally: <a href="https://github.com/astral-sh/ruff/pull/11767">astral-sh/ruff#11767</a></li>
<li>[x] Implement the typing spec&#x27;s <a href="https://typing.readthedocs.io/en/latest/spec/distributing.html#import-resolution-ordering">module resolution order</a>:<ul>
<li>https://github.com/astral-sh/ruff/pull/11767</li>
<li>Proposal for tweaking the spec posted at https://discuss.python.org/t/pep-561-s-module-resolution-order-seems-incorrect/55048/1</li>
</ul>
</li>
<li>[x] Make vendored typeshed stubs available from the built Ruff binary: <a href="https://github.com/astral-sh/ruff/pull/11779">astral-sh/ruff#11779</a></li>
<li>[x] Use vendored typeshed stubs at runtime to resolve symbols to stdlib definitions if <code>--custom-typeshed-dir</code> is not passed<ul>
<li>[x] Add a <code>VendoredFileSystem</code> implementation: <a href="https://github.com/astral-sh/ruff/pull/11863">astral-sh/ruff#11863</a></li>
<li>[x] Use the <code>VendoredFileSystem</code> implementation to resolve stdlib stubs: astral-sh/ruff#12224</li>
</ul>
</li>
<li>[ ] Add support for stubs packages suffixed with <code>-stubs</code> installed into <code>site-packages</code> (must take priority over other packages installed into <code>site-packages</code>)</li>
<li>[x] Add support for typeshed&#x27;s <code>VERSIONS</code> file: we shouldn&#x27;t fallback to a typeshed module if the <code>VERSIONS</code> file specifies it does not exist with the <code>--target-version</code> the user passes.<ul>
<li>[x] Add a parser for <code>VERSIONS</code>: <a href="https://github.com/astral-sh/ruff/pull/11836">astral-sh/ruff#11836</a></li>
<li>[x] Use the <code>VERSIONS</code> file when resolving stdlib modules: <a href="https://github.com/astral-sh/ruff/pull/12141">astral-sh/ruff#12141</a></li>
</ul>
</li>
<li>[x] Add support for editable installs that use static <code>._pth</code> files:<ul>
<li>[x] <a href="https://github.com/astral-sh/ruff/pull/12289">astral-sh/ruff#12289</a></li>
<li>[x] <a href="https://github.com/astral-sh/ruff/pull/12307">astral-sh/ruff#12307</a></li>
</ul>
</li>
<li>[x] Fix astral-sh/ruff#12278</li>
<li>[ ] Add understanding of <code>py.typed</code> files with <code>partial</code> in them, which are used to explicitly mark a package&#x27;s annotations as partially complete</li>
<li>[ ] Audit mypy&#x27;s and pyright&#x27;s module resolvers to see if there&#x27;s anything that&#x27;s not in the spec that still needs to be implemented</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by <a href="https://github.com/carljm">@carljm</a> on 2024-05-31 21:48</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to <a href="https://github.com/AlexWaygood">@AlexWaygood</a> by <a href="https://github.com/carljm">@carljm</a> on 2024-05-31 21:48</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from &quot;PEP 561 compliant module resolver&quot; to &quot;[red-knot] PEP 561 compliant module resolver&quot; by <a href="https://github.com/carljm">@carljm</a> on 2024-05-31 21:56</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-06-08 15:28</div>
            <div class="timeline-body"><p>One thing that we need to implement as part of this is a vendored filesystem. It&#x27;s not a functionality but a task to complete on our way to get there.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-06-08 15:36</div>
            <div class="timeline-body"><blockquote>
<p>One thing that we need to implement as part of this is a vendored filesystem. It&#x27;s not a functionality but a task to complete on our way to get there.</p>
</blockquote>
<p>Right. I was considering that part of</p>
<blockquote>
<p>Use vendored typeshed stubs at runtime to resolve symbols to stdlib definitions if --custom-typeshed-dir is not passed</p>
</blockquote>
<p>since, as you say, it&#x27;s necessary to implement a vendored filesystem in order to be able to do that</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-10-30 08:26</div>
            <div class="timeline-body"><p>@AlexWaygood is there more work that needs doing or can we consider this done?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-10-30 08:35</div>
            <div class="timeline-body"><p>We can&#x27;t call ourself PEP-561-compliant until we do this, which is still outstanding, and important. It&#x27;s not huge, but also not trivial:</p>
<blockquote>
<pre><code>* [ ]  Add support for stubs packages suffixed with `-stubs` installed into `site-packages</code></pre>
</blockquote>
<p>But we decided to defer work on it for now because the type-inference work is more important.</p>
<p>We should also add support for <code>py.typed</code> files that explicitly mark type annotations as <code>partial</code>, which is specified by the PEP but not listed in the tasks above; I&#x27;ll add that now.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-03-10 23:18</div>
            <div class="timeline-body"><p>Finer-grained issues are easier to manage for prioritizing and tracking work to be done, so I&#x27;ve created <a href="https://github.com/astral-sh/ruff/issues/16612">astral-sh/ruff#16612</a> and <a href="https://github.com/astral-sh/ty/issues/184">astral-sh/ty#184</a> for the last two items here.</p>
<p>I don&#x27;t think &quot;audit mypy and pyright resolvers&quot; is likely worth the trouble, it will be more efficient to discover issues from encountering them in the wild. If someone disagrees, feel free to create an issue for it! (Or just do it and create issues for anything observed.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/carljm">@carljm</a> on 2025-03-10 23:18</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 18:48:54 UTC
    </footer>
</body>
</html>
