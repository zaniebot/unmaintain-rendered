<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>F401 + F811 - auto-fix removes both top the level import and any inside-function import - astral-sh/ruff #10905</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>F401 + F811 - auto-fix removes both top the level import and any inside-function import</h1>

    <div class="meta">
        <span class="state state-closed">Closed</span>
        <a href="https://github.com/astral-sh/ruff/issues/10905">#10905</a>
        opened by <a href="https://github.com/Adamasterr">@Adamasterr</a>
        on 2024-04-12 12:27
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/Adamasterr">@Adamasterr</a> on 2024-04-12 12:27</div>
            <div class="timeline-body"><p>Hello!</p>
<p>Here's a minimal example, applying auto-fix to the following:</p>
<pre><code class="language-py">import os  # F401


def function():
    import os  # F811

    print(os.name)
</code></pre>
<p>Results in the following:</p>
<pre><code class="language-py">def function():

    print(os.name)  # F821, here, &quot;os&quot; is not defined
</code></pre>
<p>This makes for a fix that breaks the code.</p>
<!--
Thank you for taking the time to report an issue! We're glad to have you involved with Ruff.

If you're filing a bug report, please consider including the following information:

* List of keywords you searched for before creating this issue. Write them down here so that others can find this issue more easily and help provide feedback.
  e.g. "RUF001", "unused variable", "Jupyter notebook"
* A minimal code snippet that reproduces the bug.
* The command you invoked (e.g., `ruff /path/to/file.py --fix`), ideally including the `--isolated` flag.
* The current Ruff settings (any relevant sections from your `pyproject.toml`).
* The current Ruff version (`ruff --version`).
-->

</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @MichaReiser on 2024-04-12 12:32</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">fixes</span> added by @MichaReiser on 2024-04-12 12:32</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-04-12 14:05</div>
            <div class="timeline-body"><p>Thanks, that makes sense.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @charliermarsh by @charliermarsh on 2024-04-12 14:32</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-04-14 11:04</div>
            <div class="timeline-body"><p>This patch fixes things, in that the two fixes don't end up creating invalid code at the end of the day when they're combined:</p>
<pre><code class="language-diff">--- a/crates/ruff_linter/src/checkers/ast/analyze/deferred_scopes.rs
+++ b/crates/ruff_linter/src/checkers/ast/analyze/deferred_scopes.rs
@@ -1,4 +1,4 @@
-use ruff_diagnostics::{Diagnostic, Fix};
+use ruff_diagnostics::{Diagnostic, Edit, Fix};
 use ruff_python_semantic::analyze::visibility;
 use ruff_python_semantic::{Binding, BindingKind, Imported, ResolvedReference, ScopeKind};
 use ruff_text_size::Ranged;
@@ -294,9 +294,33 @@ pub(crate) fn deferred_scopes(checker: &amp;mut Checker) {
                                             checker.stylist(),
                                             checker.indexer(),
                                         )?;
-                                        Ok(Fix::safe_edit(edit).isolate(Checker::isolation(
-                                            checker.semantic().parent_statement_id(source),
-                                        )))
+                                        // We also add a no-op edit to force conflicts with the fix for `unused-imports`.
+                                        // Consider:
+                                        // ```python
+                                        // import sys
+                                        //
+                                        // def foo():
+                                        //     import sys
+                                        //     return sys.version_info
+                                        // ```
+                                        //
+                                        // Assume you omit this no-op edit. If you run Ruff with `unused-imports` and
+                                        // `redefined-while-unused` over this snippet, it will generate two fixes:
+                                        // (1) remove the unused `sys` import; and
+                                        // (2) remove the &quot;redundant redefinition&quot; of `sys`, under the assumption that
+                                        //     `sys` is already imported and available.
+                                        //
+                                        // By adding this no-op edit, we force the `unused-imports` fix to conflict
+                                        // with the `redefined-while-unused` fix, and thus will avoid applying both
+                                        // fixes in the same pass.
+                                        let noop_edit = Edit::range_replacement(
+                                            checker.locator().slice(shadowed).to_string(),
+                                            shadowed.range(),
+                                        );
+                                        Ok(Fix::safe_edits(edit, std::iter::once(noop_edit))
+                                            .isolate(Checker::isolation(
+                                                checker.semantic().parent_statement_id(source),
+                                            )))
                                     });
</code></pre>
<p>(Logic inspired by https://github.com/astral-sh/ruff/blob/812b0976a9e04c6bc5256911419daf4f82de404b/crates/ruff_linter/src/importer/mod.rs#L277-L296)</p>
<p>It's still not ideal, though, as it ends up applying this fix:</p>
<pre><code class="language-diff">--- foo.py
+++ foo.py
@@ -1,4 +1,3 @@
-import os  # F401
 
 
 def function():
</code></pre>
<p>when ideally it would remove the local import rather than the top-level import</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-04-14 11:53</div>
            <div class="timeline-body"><p>Maybe we should change F811 to only remove the &quot;shadowed&quot; import if they're in the same scope? I need to look back at why we changed that in the first place.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/11173.html">astral-sh/ruff#11173</a> on 2024-04-27 12:50</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2024-04-27 15:44</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:34:52 UTC
    </footer>
</body>
</html>
