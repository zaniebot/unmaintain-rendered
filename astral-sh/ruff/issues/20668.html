<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>`per-file-target-version` override ignored when combined with a broader pattern - astral-sh/ruff #20668</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1><code>per-file-target-version</code> override ignored when combined with a broader pattern</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/ruff/issues/20668">#20668</a>
        opened by <a href="https://github.com/mgaitan">@mgaitan</a>
        on 2025-10-01 12:38
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/mgaitan">@mgaitan</a></div>
            <div class="timeline-body">Summary
<p>When using <code>per-file-target-version</code> with both a broad pattern (e.g., <code>*.py</code>) and a specific file override, Ruff appears to always apply the broad pattern, ignoring the more specific one.</p>
Minimal reproducible example
<p>Repo: https://github.com/mgaitan/demo_ruff_bug_per_file_ignore</p>
<p><strong>src/demo/example.py</strong></p>
<pre><code>from typing import List

def example_function() -&gt; List[str]:
    return [&quot;Hello&quot;, &quot;World&quot;]
</code></pre>
<p>with   <code>pyproject.toml</code></p>
<pre><code>[tool.ruff.lint]
select = [
    &quot;UP&quot;,     # https://docs.astral.sh/ruff/rules/#pyupgrade-up
]

[tool.ruff.per-file-target-version]
&quot;src/demo/*.py&quot; = &quot;py38&quot;
&quot;src/demo/example.py&quot; = &quot;py312&quot;
</code></pre>
<pre><code>$ uvx ruff@latest check --verbose src/ --no-cache
Installed 1 package in 6ms
[2025-10-01][09:25:29][ruff::resolve][DEBUG] Using configuration file (via parent) at: /home/tin/lab/demo/pyproject.toml
[2025-10-01][09:25:29][ruff_workspace::pyproject][DEBUG] Detected minimum supported `requires-python` version: 3.8
[2025-10-01][09:25:29][ignore::gitignore][DEBUG] opened gitignore file: /home/tin/lab/demo/.gitignore
[2025-10-01][09:25:29][ignore::gitignore][DEBUG] opened gitignore file: /home/tin/lab/demo/.git/info/exclude
[2025-10-01][09:25:29][ruff_workspace::resolver][DEBUG] Included path via `include`: &quot;/home/tin/lab/demo/src/demo/example.py&quot;
[2025-10-01][09:25:29][ruff_workspace::resolver][DEBUG] Included path via `include`: &quot;/home/tin/lab/demo/src/demo/__init__.py&quot;
[2025-10-01][09:25:29][ruff::commands::check][DEBUG] Identified files to lint in: 3.841828ms
[2025-10-01][09:25:29][ruff::diagnostics][DEBUG] Checking: /home/tin/lab/demo/src/demo/example.py
[2025-10-01][09:25:29][ruff::diagnostics][DEBUG] Checking: /home/tin/lab/demo/src/demo/__init__.py
[2025-10-01][09:25:29][ruff_linter::settings::types][DEBUG] Setting Python version for &quot;/home/tin/lab/demo/src/demo/example.py&quot; due to absolute match on &quot;(?-u)^/home/tin/lab/demo/src/demo/.*\\.py$&quot;: PythonVersion { major: 3, minor: 8 }
[2025-10-01][09:25:29][ruff_linter::settings::types][DEBUG] Setting Python version for &quot;/home/tin/lab/demo/src/demo/__init__.py&quot; due to absolute match on &quot;(?-u)^/home/tin/lab/demo/src/demo/.*\\.py$&quot;: PythonVersion { major: 3, minor: 8 }
[2025-10-01][09:25:29][ruff::commands::check][DEBUG] Checked 2 files in: 4.023072ms
All checks passed!
</code></pre>
<p>No <code>UP</code> warnings are raised, even though <code>example.py</code> should be treated as <code>py312</code>.</p>
<p>Or course, if I change the config to:</p>
<pre><code>[tool.ruff.per-file-target-version]
&quot;src/demo/*.py&quot; = &quot;py312&quot;
</code></pre>
<p>then Ruff behaves as expected:</p>
<pre><code>$ uvx ruff@latest check --verbose src/ --no-cache
Installed 1 package in 3ms
[2025-10-01][09:26:32][ruff::resolve][DEBUG] Using configuration file (via parent) at: /home/tin/lab/demo/pyproject.toml
[2025-10-01][09:26:32][ruff_workspace::pyproject][DEBUG] Detected minimum supported `requires-python` version: 3.8
[2025-10-01][09:26:32][ignore::gitignore][DEBUG] opened gitignore file: /home/tin/lab/demo/.gitignore
[2025-10-01][09:26:32][ignore::gitignore][DEBUG] opened gitignore file: /home/tin/lab/demo/.git/info/exclude
[2025-10-01][09:26:32][ruff_workspace::resolver][DEBUG] Included path via `include`: &quot;/home/tin/lab/demo/src/demo/example.py&quot;
[2025-10-01][09:26:32][ruff_workspace::resolver][DEBUG] Included path via `include`: &quot;/home/tin/lab/demo/src/demo/__init__.py&quot;
[2025-10-01][09:26:32][ruff::commands::check][DEBUG] Identified files to lint in: 2.363499ms
[2025-10-01][09:26:32][ruff::diagnostics][DEBUG] Checking: /home/tin/lab/demo/src/demo/example.py
[2025-10-01][09:26:32][ruff::diagnostics][DEBUG] Checking: /home/tin/lab/demo/src/demo/__init__.py
[2025-10-01][09:26:32][ruff_linter::settings::types][DEBUG] Setting Python version for &quot;/home/tin/lab/demo/src/demo/example.py&quot; due to absolute match on &quot;(?-u)^/home/tin/lab/demo/src/demo/.*\\.py$&quot;: PythonVersion { major: 3, minor: 12 }
[2025-10-01][09:26:32][ruff_linter::settings::types][DEBUG] Setting Python version for &quot;/home/tin/lab/demo/src/demo/__init__.py&quot; due to absolute match on &quot;(?-u)^/home/tin/lab/demo/src/demo/.*\\.py$&quot;: PythonVersion { major: 3, minor: 12 }
[2025-10-01][09:26:32][ruff::commands::check][DEBUG] Checked 2 files in: 900.833Âµs
UP035 `typing.List` is deprecated, use `list` instead
 --&gt; src/demo/example.py:1:1
  |
1 | from typing import List
  | ^^^^^^^^^^^^^^^^^^^^^^^
2 |
3 | def example_function() -&gt; List[str]:
  |

UP006 [*] Use `list` instead of `List` for type annotation
 --&gt; src/demo/example.py:3:27
  |
1 | from typing import List
2 |
3 | def example_function() -&gt; List[str]:
  |                           ^^^^
4 |     return [&quot;Hello&quot;, &quot;World&quot;]
  |
help: Replace with `list`

Found 2 errors.
[*] 1 fixable with the `--fix` option.
</code></pre>
<hr>
Conclusion
<p>It seems that when multiple overlapping <code>per-file-target-version</code> rules exist, Ruff applies the broader one instead of the more specific one. The expected behavior would be for the more specific match (<code>src/demo/example.py = py312</code>) to take precedence.</p>
Version
<p>ruff 0.13.2</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntBre">@ntBre</a> on 2025-10-01 12:41</div>
            <div class="timeline-body"><p>Have you tried swapping the order of the two patterns? I need to double check, but I think we maintain the order of the list and return when the first matching pattern is found. This might be worth documenting too, if it works.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">question</span> added by <a href="https://github.com/ntBre">@ntBre</a> on 2025-10-01 12:41</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntBre">@ntBre</a> on 2025-10-01 12:43</div>
            <div class="timeline-body"><p>Ah sorry, I should have just tried the example repo (thanks for that!). It looks like swapping the order doesn&#x27;t help.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">question</span> removed by <a href="https://github.com/ntBre">@ntBre</a> on 2025-10-01 12:51</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">configuration</span> added by <a href="https://github.com/ntBre">@ntBre</a> on 2025-10-01 12:51</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntBre">@ntBre</a> on 2025-10-01 12:57</div>
            <div class="timeline-body"><p>We do end up saving the resolved patterns in an ordered <a href="https://github.com/astral-sh/ruff/blob/main/crates/ruff_linter/src/settings/types.rs#L835">collection</a>, which is what I was thinking of, but we deserialize them from the config file into an unordered <a href="https://github.com/astral-sh/ruff/blob/main/crates/ruff_workspace/src/options.rs#L360">hash map</a>. One potential fix here could be sorting the patterns by descending length before collecting them into the settings.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-10-01 13:53</div>
            <div class="timeline-body"><p>Could we use an <code>IndexMap</code> instead?</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 18:50:28 UTC
    </footer>
</body>
</html>
