<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[red-knot] add `Type::SubclassOf` support to `Type::try_call` - astral-sh/ruff #15948</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[red-knot] add <code>Type::SubclassOf</code> support to <code>Type::try_call</code></h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/issues/15948">#15948</a>
        opened by <a href="https://github.com/carljm">@carljm</a>
        on 2025-02-04 20:35
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a></div>
            <div class="timeline-body"><h3>Description</h3>
<p>Existing type checkers (and the typing spec) allow calling an object of type <code>type[C]</code> (in red-knot, <code>Type::SubclassOf(&lt;Class C&gt;)</code>), with the result of the call being an object of type <code>C</code> (in red-knot, <code>Type::Instance(&lt;Class C&gt;)</code>).</p>
<p>This is not actually sound, because Liskov compatibility is not enforced on type constructor methods (<code>__init__</code> and <code>__new__</code>) when subclassing, so you can't be sure that a constructor call that works for a class <code>C</code> will actually work for a subclass of <code>C</code>. But it's widely relied on, and we will have to support it.</p>
<p>I would like to have an opt-in diagnostic emitted whenever you call an object of <code>type[C]</code>, so users who want to avoid this unsoundness have that option.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by @carljm on 2025-02-04 20:35</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">help wanted</span> added by @carljm on 2025-02-04 20:35</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-02-04 20:47</div>
            <div class="timeline-body"><p>On second thought, it may be best to hold off on this issue (or at least the new-diagnostic part of it) until after @AlexWaygood completes an in-progress refactor of <code>CallOutcome</code>, since this diagnostic would likely imply adding a new outcome variant to <code>CallOutcome</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/mishamsk">@mishamsk</a> on 2025-02-04 23:14</div>
            <div class="timeline-body"><p>I can take it whenever @AlexWaygood is ready since I've triggered the issue in the first place. Not sure how you manage blocked issues, but feel free to assign this one to me and I'll monitor the comments</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @mishamsk by @carljm on 2025-02-04 23:15</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/mishamsk">@mishamsk</a> on 2025-02-28 19:55</div>
            <div class="timeline-body"><p>@AlexWaygood I believe this one is unblocked now? Also see another comment related to analyzing <code>__init__</code> signatures for class literals:</p>
<pre><code>// TODO annotated return type on `__new__` or metaclass `__call__`
            // TODO check call vs signatures of `__new__` and/or `__init__`
</code></pre>
<p>which may or may not be tackled together...</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-02-28 19:57</div>
            <div class="timeline-body"><blockquote>
<p><a href="https://github.com/AlexWaygood">@AlexWaygood</a> I believe this one is unblocked now?</p>
</blockquote>
<p>Should be, yup!</p>
<p>Those other todos should be tackled in separate PRs, I think; they're pretty separate issues</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "[red-knot] add Type::SubclassOf support to Type::call and Type::call_unbound" to "[red-knot] add `Type::SubclassOf` support to `Type::try_call`" by @sharkdp on 2025-03-10 10:45</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-03-10 12:25</div>
            <div class="timeline-body"><p>The core functionality was added in astral-sh/ruff#16597, but the diagnostic has not been implemented. Also, those calls will really only be properly checked when astral-sh/ty#186 is also implemented.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/mishamsk">@mishamsk</a> on 2025-03-10 13:18</div>
            <div class="timeline-body"><p>I think the full implementation of the <code>Subclass</code> arm will be pretty involved, but may be out of scope here. I was going to ask related question this week.</p>
<p>What I was thinking about is <code>Self</code>. When we handle plain class literals (#16511 case) we can avoid properly handling <code>Self</code> since <code>class.to_instance()</code> will return the correct type in all realistic scenarios. But with <code>type[C]</code>, in ideal world we would record a stronger typing relationship - due to the free type variable... so fully model this:</p>
<pre><code class="language-py">T = TypeVar(&quot;T&quot;, bound=&quot;Base&quot;)

class Base:
    pass

class Sub(Base):
    pass

def get_instance(clz: type[T]) -&gt; T:
    return clz()

instance = get_instance(Sub)
reveal_type(instance) # Sub, not Base
</code></pre>
<p>but for constructors.</p>
<p>and AFAIK there is no machinery for that currently.</p>
<p>Anyways, that's for the future. I hope I'll close astral-sh/ty#186 this week, and we can decide whether it makes sense to do a small PR to add the diagnostic here or dive into <code>Self</code> support</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-03-10 13:23</div>
            <div class="timeline-body"><blockquote>
<p>But with <code>type[C]</code>, in ideal world we would record a stronger typing relationship - due to the free type variable... so fully model this:</p>
<p>T = TypeVar(&quot;T&quot;, bound=&quot;Base&quot;)</p>
<p>class Base:
pass</p>
<p>class Sub(Base):
pass</p>
<p>def get_instance(clz: type[T]) -&gt; T:
return clz()</p>
<p>instance = get_instance(Sub)
reveal_type(instance) # Sub, not Base</p>
<p>but for constructors.</p>
<p>and AFAIK there is no machinery for that currently.</p>
</blockquote>
<p>This example involves generic functions, which aren't yet modeled by red-knot at all -- @dcreager is currently working on that. It's quite a large topic, and I'd definitely consider it out of scope for this issue! :-)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/mishamsk">@mishamsk</a> on 2025-03-10 14:02</div>
            <div class="timeline-body"><p>yeah, I thought so. Is there an issue I could track to see the progress related to type variables / generics?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-03-10 14:28</div>
            <div class="timeline-body"><blockquote>
<p>yeah, I thought so. Is there an issue I could track to see the progress related to type variables / generics?</p>
</blockquote>
<p>(Sent you an invite to our internal design doc around this!)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/mishamsk">@mishamsk</a> on 2025-03-10 15:12</div>
            <div class="timeline-body"><p>thanks a lot! fascinating read. I'll keep an eye on the roadmap, maybe I'll find a non-impending way to positively slot in a PR or smth. somewhere along the way!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone "Red Knot Q1 2025" by @carljm on 2025-03-27 18:33</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Removed from milestone "Red Knot Q1 2025" by @carljm on 2025-03-27 18:33</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone "Red Knot Alpha" by @carljm on 2025-03-27 18:33</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-03-31 11:26</div>
            <div class="timeline-body"><p>I'm going to close this now, since the core functionality was implemented in https://github.com/astral-sh/ruff/pull/16597. Diagnostics for invalid calls are not yet implemented, and are very important, but should be naturally solved at the same time as https://github.com/astral-sh/ty/issues/186 due to the fact that our implementation of <code>Type::call()</code> for <code>Type::SubclassOf</code> variants just delegates to our <code>Type::call()</code> implementation for <code>Type::ClassLiteral</code> variants. Implementing diagnostics for invalid calls to <code>type[]</code> types is also not <em>so</em> critical that it needs to be prioritised before the planned alpha release.</p>
<p>As @mishamsk points out, we do not yet handle generic arguments to <code>type[]</code>, but this is a much bigger issue that will be tackled as part of our upcoming work on generics.</p>
<blockquote>
<p>I would like to have an opt-in diagnostic emitted whenever you call an object of type[C], so users who want to avoid this unsoundness have that option.</p>
</blockquote>
<p>I think this comment by @carljm is the only part of this issue that is not yet covered by things already implemented or things tracked by other issues. I'll open a followup issue to track this specifically.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @AlexWaygood on 2025-03-31 11:26</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-03-31 11:39</div>
            <div class="timeline-body"><blockquote>
<blockquote>
<p>I would like to have an opt-in diagnostic emitted whenever you call an object of type[C], so users who want to avoid this unsoundness have that option.</p>
</blockquote>
<p>I think this comment by <a href="https://github.com/carljm?rgh-link-date=2025-03-31T11%3A26%3A03.000Z">@carljm</a> is the only part of this issue that is not yet covered by things already implemented or things tracked by other issues. I'll open a followup issue to track this specifically.</p>
</blockquote>
<p>I wroteup https://github.com/astral-sh/ty/issues/145 for this feature</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 16:52:08 UTC
    </footer>
</body>
</html>
