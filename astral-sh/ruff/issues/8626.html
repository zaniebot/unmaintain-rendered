<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Extreme performance penalty when using `--extend-per-file-ignores` and leading recursive glob patterns - astral-sh/ruff #8626</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Extreme performance penalty when using `--extend-per-file-ignores` and leading recursive glob patterns</h1>

    <div class="meta">
        <span class="state state-open">Open</span>
        <a href="https://github.com/astral-sh/ruff/issues/8626">#8626</a>
        opened by <a href="https://github.com/ofek">@ofek</a>
        on 2023-11-12 02:42
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/ofek">@ofek</a> on 2023-11-12 02:42</div>
            <div class="timeline-body"><pre><code>git clone https://github.com/pypa/hatch
cd hatch
ruff check --isolated --select INP001 .
</code></pre>
<p>notice it runs fast and there are many errors, then run</p>
<pre><code>ruff check --isolated --select INP001 --extend-per-file-ignores &quot;scripts/*:INP001&quot; .
</code></pre>
<p>notice it runs fast (I think no slow down) and there are fewer errors, then run</p>
<pre><code>ruff check --isolated --select INP001 --extend-per-file-ignores &quot;**/scripts/*:INP001&quot; .
</code></pre>
<p>notice it takes about two seconds. Interestingly, when configured there is no slowdown:</p>
<pre><code class="language-toml">[tool.ruff.per-file-ignores]
&quot;**/scripts/*&quot; = [&quot;INP001&quot;]
</code></pre>
<p>You might think, then, that perhaps the shells are globbing themselves but I've tried in <code>bash</code> and <code>nushell</code> with the proper single quotes/escaping mechanisms to no avail. Also interesting and inexplicable, the slowdown is not happening on Windows' <code>cmd</code> shell.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ofek">@ofek</a> on 2023-11-12 02:52</div>
            <div class="timeline-body"><p>I cannot reproduce this in Docker, looks like this is only a bug on Windows</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ofek">@ofek</a> on 2023-11-12 03:02</div>
            <div class="timeline-body"><p>I suspect the bug is that the double leading asterisks somehow cause traversal to start at the root. Running the following (notice the leading forward slash) on Windows straight up hangs:</p>
<pre><code>ruff check --select INP001 --extend-per-file-ignores &quot;/**/scripts/*:INP001&quot; .
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ofek">@ofek</a> on 2023-11-12 03:05</div>
            <div class="timeline-body"><p>Actually, it's possible this bug is not just on Windows but rather the file system in the <code>python</code> Docker image was too small to tell. Then again, that doesn't explain the lack of the slowdown in command prompt. Anyway… this is all the information I have</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-11-12 04:11</div>
            <div class="timeline-body"><p>\cc @BurntSushi who will have better instincts on what the possible set of issues is here.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ofek">@ofek</a> on 2023-11-12 04:26</div>
            <div class="timeline-body"><p>Timing:</p>
<pre><code>❯ ruff check -v --select INP001 --extend-per-file-ignores &quot;**/scripts/*:INP001&quot; .
...
[2023-11-11][23:23:37][ruff_cli::commands::check][DEBUG] Identified files to lint in: 2.3416198s
[2023-11-11][23:23:37][ruff_cli::diagnostics][DEBUG] Checking: C:\Users\ofek\Desktop\code\hatch\pyproject.toml
[2023-11-11][23:23:37][ruff_cli::diagnostics][DEBUG] Checking: C:\Users\ofek\Desktop\code\hatch\backend\pyproject.toml
[2023-11-11][23:23:37][ruff_cli::diagnostics][DEBUG] Checking: C:\Users\ofek\Desktop\code\hatch\backend\tests\downstream\datadogpy\pyproject.toml
[2023-11-11][23:23:37][ruff_cli::commands::check][DEBUG] Checked 329 files in: 3.5788ms
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">performance</span> added by @charliermarsh on 2023-11-12 20:30</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2023-11-13 13:17</div>
            <div class="timeline-body"><p>I can't reproduce this on my Linux machine. Nothing really stands out to me as a possible culprit. Some ideas:</p>
<ul>
<li>Can you say more precisely in what environment (or environments) you're seeing a slow-down? Are you in a cygwin or MSYS environment for example?</li>
<li>Failing all else, some printf debugging might help here. I'm still getting familiar with the Ruff code, but printing out all of the files that it's traversing might reveal something.</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ofek">@ofek</a> on 2023-11-13 17:28</div>
            <div class="timeline-body"><p>I am on Windows 11 Pro with no emulation and no antivirus software running. I am more than happy to test any binary you can send me a link to!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2023-11-13 17:33</div>
            <div class="timeline-body"><p>Which shell are you using where you observed the problem? Are you in PowerShell?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ofek">@ofek</a> on 2023-11-13 17:38</div>
            <div class="timeline-body"><p>Affected: nushell, powershell, Git Bash, xonsh
Unaffected: cmd</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ofek">@ofek</a> on 2023-11-14 18:20</div>
            <div class="timeline-body"><p>Update: a Windows expert from work inspected traces from my machine and figured out the issue. It spends a significant amount of time in <code>.ruff_cache</code>.</p>
<p><img src="https://github.com/astral-sh/ruff/assets/9677399/165ce33e-c308-4456-b20e-5149842fde60" alt="image" /></p>
<p>The <code>--no-cache</code> flag had no effect, only wiping that directory of &gt;30k files worked. We both don't know why this issue did not present for me in command prompt but if this is accurate then somehow caching is not working when running in command prompt.</p>
<p>Do either of you know of a situation in the code where the flag would trigger cache reads whereas file-based config does not? I think that should be explored since there seems to be a real issue.</p>
<p>Edit: or more likely, perhaps there is logic that differs based on the process shell name and globbing somehow triggers different logic in command prompt</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-11-14 18:22</div>
            <div class="timeline-body"><p>Is it that it's <em>indexing</em> and traversing the cache to find Python files, instead of ignoring it? Or it's actually reading the cache contents?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ofek">@ofek</a> on 2023-11-14 18:26</div>
            <div class="timeline-body"><p>We don't know.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-11-14 18:30</div>
            <div class="timeline-body"><p>Fair enough :joy:</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ofek">@ofek</a> on 2023-11-14 18:33</div>
            <div class="timeline-body"><p>Actually I discovered something else looking at the traces myself:</p>
<p><img src="https://github.com/astral-sh/ruff/assets/9677399/ca89d883-8c60-4858-9a05-1110efc18a15" alt="image" /></p>
<p>The beginning <code>**/</code> completely destroys what should be ignored and even <code>.git</code> is being entered. This is the fundamental issue.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ofek">@ofek</a> on 2023-11-14 18:38</div>
            <div class="timeline-body"><p>So to recap, this is definitely a bug but there are two caveats:</p>
<ol>
<li>when configured via the file rather than command line this does not happen</li>
<li>on command line this does not happen in cmd/command prompt which indicates that some conditional logic is happening based on the process name</li>
</ol>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2023-11-14 18:57</div>
            <div class="timeline-body"><blockquote>
<p>on command line this does not happen in cmd/command prompt which indicates that some conditional logic is happening based on the process name</p>
</blockquote>
<p>It could also be that <code>cmd.exe</code> is mangling the glob somehow such that it isn't applied.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ofek">@ofek</a> on 2023-11-16 23:54</div>
            <div class="timeline-body"><p>Have you been able to find out where in the code this is happening? I want to provide default ignores for the new <code>hatch fmt</code> command but I don't want to release until this is fixed because one of the patterns uses a leading <code>**/</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2023-11-17 01:11</div>
            <div class="timeline-body"><p>I'm not personally investigating this, no. I can't reproduce the problem on my end unfortunately. I'm somewhat new to Ruff myself and don't understand its filtering logic yet, but I would wonder whether the leading <code>**/</code> is correct here. To me, that is explicitly telling Ruff to descend into every directory. But my mental model of what ought to happen here isn't completely clear.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-11-17 01:13</div>
            <div class="timeline-body"><p>I can spend a little time investing this tonight.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-11-17 01:20</div>
            <div class="timeline-body"><p>Separately, are you just using this for <code>scripts</code>, with <code>INP001</code> specifically?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-11-17 01:20</div>
            <div class="timeline-body"><p>Or are there more of these patterns?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ofek">@ofek</a> on 2023-11-17 02:04</div>
            <div class="timeline-body"><p>Thanks! Another one is <code>**/tests/**/*</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-11-17 02:06</div>
            <div class="timeline-body"><p>I'm wondering if we should just allow <code>per-file-ignores</code> to function like <code>excludes</code>, whereby we match individual basenames against the entire path (so the stars could just be omitted).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ofek">@ofek</a> on 2023-11-17 02:13</div>
            <div class="timeline-body"><p>Up to you. That would solve my particular use case but I don't think it's a great idea to reduce functionality just to fix a bug.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:34:51 UTC
    </footer>
</body>
</html>
