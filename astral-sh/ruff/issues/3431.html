<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ruff makes triple sure the user is aware an error code has been remapped when it has explictly been ignored - astral-sh/ruff #3431</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Ruff makes triple sure the user is aware an error code has been remapped when it has explictly been ignored</h1>

    <div class="meta">
        <span class="state state-closed">Closed</span>
        <a href="https://github.com/astral-sh/ruff/issues/3431">#3431</a>
        opened by <a href="https://github.com/onerandomusername">@onerandomusername</a>
        on 2023-03-10 05:13
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/onerandomusername">@onerandomusername</a> on 2023-03-10 05:13</div>
            <div class="timeline-body"><h3>Summary</h3>
<p>When ignoring a remapped error code, ruff is <em>very</em> insistent in error logs that the error code has been remapped.</p>
<h3>Steps to reproduce</h3>
<p>pyproject.toml:</p>
<pre><code class="language-toml">[tool.ruff]
select = [&quot;RUF&quot;]
ignore = [&quot;RUF004&quot;]
</code></pre>
<p>command: <code>ruff .</code>
There does not need to be any python files in the current directory.</p>
<h3>Screenshots</h3>
<p><img src="https://user-images.githubusercontent.com/71233171/224229246-28d0a0b1-1081-4c2f-8700-b5ac9e97e9f6.png" alt="image" /></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @charliermarsh on 2023-03-10 05:29</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">cli</span> added by @charliermarsh on 2023-03-10 05:29</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-03-10 05:30</div>
            <div class="timeline-body"><p>I think we <em>used</em> to show this once, but a refactor made it more difficult to enforce that it appears &quot;exactly once&quot;.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/onerandomusername">@onerandomusername</a> on 2023-03-10 05:38</div>
            <div class="timeline-body"><p>IMO it would be better at the end of cli output rather than the beginning</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MithicSpirit">@MithicSpirit</a> on 2023-03-10 05:59</div>
            <div class="timeline-body"><p>It seems that this warning is coming from https://github.com/charliermarsh/ruff/blob/bb3bb24b59d8f0da5c42972b177cd29db9390d6f/crates/ruff/src/settings/mod.rs#L362-L369
Is the issue that the function (<code>RuleTable::from</code>) is being called multiple times or is it just that there are multiple instances of the value in <code>redirects</code>? If it's the latter it shouldn't be hard to deduplicate, although the fact that it seems to be iterating over a hashmap makes me doubtful that this is the case.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-03-10 23:25</div>
            <div class="timeline-body"><p>I think it's that we may call <code>RuleTable::from</code> multiple times. We actually <em>do</em> have a mechanism to show a warning &quot;exactly once&quot;, but it doesn't work with dynamic warnings (i.e., warnings like this that depend on data), since it basically inlines a one-time static boolean into the code via a macro.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MithicSpirit">@MithicSpirit</a> on 2023-03-10 23:57</div>
            <div class="timeline-body"><p>Yeah I looked into that macro but realized that it wouldn't fix it. I think that it could be adapted for dynamic warnings like these by using a static hashmap with the appropriate locks, but I'm not sure if the overhead from that is worth it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-03-11 00:00</div>
            <div class="timeline-body"><p>I think it's probably worth it, since this isn't a high-performance codepath. Are you interested in giving that a try?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-03-11 00:01</div>
            <div class="timeline-body"><p>I started on a kind of ridiculous change to use macros in <code>rule_redirects.rs</code>, like:</p>
<pre><code class="language-rust">/// Returns the redirect target for the given code.
pub(crate) fn get_redirect_target(code: &amp;str) -&gt; Option&lt;&amp;'static str&gt; {
    redirect(code).map(|(_, target)| target)
}

/// Returns the code and the redirect target if the given code is a redirect.
/// (The same code is returned to obtain it with a static lifetime).
pub(crate) fn get_redirect(code: &amp;str) -&gt; Option&lt;(&amp;'static str, &amp;'static str)&gt; {
    redirect(code)
}

fn redirect(code: &amp;str) -&gt; Option&lt;(&amp;'static str, &amp;'static str)&gt; {
    macro_rules! redirect {
        ($src:expr, $dst:expr) =&gt; {{
            if code == $src {
                crate::warn_user_once!(&quot;`{}` has been remapped to `{}`.&quot;, $src, $dst);
                return Some(($src, $dst));
            }
        }};
    }

    redirect!(&quot;SIM111&quot;, &quot;SIM110&quot;);

    return None;
}
</code></pre>
<p>That actually <em>does</em> work, but the issue is that the redirect itself is done <em>before</em> we set up the logger (e.g., if the codes are provided as command-line arguments), so the warning doesn't show up in all cases because it's &quot;too soon&quot;.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MithicSpirit">@MithicSpirit</a> on 2023-03-11 02:14</div>
            <div class="timeline-body"><blockquote>
<p>I think it's probably worth it, since this isn't a high-performance codepath. Are you interested in giving that a try?</p>
</blockquote>
<p>I can give it a shot, but I should say I'm not too familiar with atomics (might be a good opportunity to learn, though).</p>
<p>Since this function is not async, things like <code>Mutex</code> and <code>RwLock</code> are out. I'm thinking that the best option would be to use a static <code>FxHashSet</code> to keep track of which redirects have already been printed and a static <code>AtomicBool</code> to act as a lock on the hashset. From there I believe that it would be necessary to use a spinlock (again, because this function is not async); while this isn't great, the lock will be held only briefly, so there shouldn't be much time wasted spinlocking. What do you think about this solution?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/onerandomusername">@onerandomusername</a> on 2023-03-11 02:24</div>
            <div class="timeline-body"><blockquote>
<p>That actually does work, but the issue is that the redirect itself is done before we set up the logger (e.g., if the codes are provided as command-line arguments), so the warning doesn't show up in all cases because it's &quot;too soon&quot;.</p>
</blockquote>
<p>If a refactor is necessary than I also think it might be better to show warnings like this near the end of the output.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MithicSpirit">@MithicSpirit</a> on 2023-03-11 02:29</div>
            <div class="timeline-body"><p>We could make the redirects <code>FxHashMap</code> static (and do the whole spinlocking thing while writing to it), then wait until all of the linting is done to print it out. This would require more refactoring than my solution, but probably less than @charliermarsh's current solution.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @charliermarsh by @charliermarsh on 2023-03-13 23:33</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-03-13 23:33</div>
            <div class="timeline-body"><p>I can help with this one.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/3500.html">astral-sh/ruff#3500</a> on 2023-03-14 03:28</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2023-03-14 15:22</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:34:49 UTC
    </footer>
</body>
</html>
