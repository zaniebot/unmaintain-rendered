<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Field `requires-python` is disregarded when config lives outside `pyproject.toml` - astral-sh/ruff #16662</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Field <code>requires-python</code> is disregarded when config lives outside <code>pyproject.toml</code></h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/issues/16662">#16662</a>
        opened by <a href="https://github.com/ofek">@ofek</a>
        on 2025-03-12 05:01
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/ofek">@ofek</a> on 2025-03-12 05:01</div>
            <div class="timeline-body"><h3>Summary</h3>
<p>Create a directory with the following files:</p>
<table>
<tr><th><code>pyproject.toml</code></th><th><code>ruff.toml</code></th><th><code>test.py</code></th></tr>
<tr>
<td>

<pre><code class="language-toml">[build-system]
requires = [&quot;hatchling&quot;]
build-backend = &quot;hatchling.build&quot;

[project]
name = &quot;dda&quot;
version = &quot;0.0.1&quot;
requires-python = &quot;&gt;=3.12&quot;

# Comment this out
[tool.ruff.lint]
select = [&quot;I001&quot;]
ignore = [&quot;T201&quot;]
</code></pre>
</td>
<td>

<pre><code class="language-toml"># Uncomment
# [lint]
# select = [&quot;I001&quot;]
# ignore = [&quot;T201&quot;]
</code></pre>
</td>
<td>

<pre><code class="language-python">from __future__ import annotations

import tomllib

import requests


def main():
    print(tomllib)
    print(requests)


if __name__ == &quot;__main__&quot;:
    main()
</code></pre>
</td>
</tr>
</table>

<p>Then run <code>ruff check .</code> and notice success. Then use the dedicated <code>ruff.toml</code> config file instead and notice that it tries to re-sort the imports because it did not properly read the version from <code>pyproject.toml</code>.</p>
<h3>Version</h3>
<p>0.9.9</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2025-03-12 05:11</div>
            <div class="timeline-body"><p>This is a duplicate of https://github.com/astral-sh/ruff/issues/14813, here's the PR that should fix this https://github.com/astral-sh/ruff/pull/16319.</p>
<p>In the interim, you can include an empty <code>[tool.ruff]</code> heading in the <code>pyproject.toml</code> file which will prompt Ruff to read the <code>requires-python</code> field.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @dhruvmanila on 2025-03-12 05:11</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">question</span> added by @dhruvmanila on 2025-03-12 05:11</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ofek">@ofek</a> on 2025-03-12 05:17</div>
            <div class="timeline-body"><p>That does not work.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Reopened by @dhruvmanila on 2025-03-12 05:21</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2025-03-12 05:44</div>
            <div class="timeline-body"><p>Sorry, that workaround would not work in this case because you're using both <code>pyproject.toml</code> and <code>ruff.toml</code>. You can see this in the debug logs:</p>
<pre><code class="language-sh"># ruff check -v
[2025-03-12][11:08:22][ruff_workspace::pyproject][DEBUG] `project.requires_python` in `pyproject.toml` will not be used to set `target_version` when using `ruff.toml`.
</code></pre>
<p>I think the linked PR should fix this issue but in my testing it doesn't seem to be:</p>
<pre><code class="language-console">$ ~/work/astral/ruff/target/debug/ruff check -v --no-cache .
[2025-03-12][11:12:07][ruff::resolve][DEBUG] Using configuration file (via parent) at: /private/tmp/ruff-test/ruff.toml
[2025-03-12][11:12:07][ruff_workspace::pyproject][DEBUG] No `target-version` found in `ruff.toml`
[2025-03-12][11:12:07][ruff_workspace::pyproject][DEBUG] Detected minimum supported `requires-python` version: 3.12
[2025-03-12][11:12:07][ruff_workspace::pyproject][DEBUG] Derived `target-version` from `requires-python` in `pyproject.toml`: Py312
[2025-03-12][11:12:07][ignore::gitignore][DEBUG] opened gitignore file: /Users/dhruv/.ignore
[2025-03-12][11:12:07][ruff_workspace::pyproject][DEBUG] No `target-version` found in `ruff.toml`
[2025-03-12][11:12:07][ignore::gitignore][DEBUG] opened gitignore file: /private/tmp/ruff-test/.venv/.gitignore
[2025-03-12][11:12:07][ruff_workspace::resolver][DEBUG] Ignored path via `exclude`: &quot;/private/tmp/ruff-test/.venv&quot;
[2025-03-12][11:12:07][ruff_workspace::resolver][DEBUG] Included path via `include`: &quot;/private/tmp/ruff-test/test.py&quot;
[2025-03-12][11:12:07][ruff_workspace::resolver][DEBUG] Included path via `include`: &quot;/private/tmp/ruff-test/pyproject.toml&quot;
[2025-03-12][11:12:07][ignore::gitignore][DEBUG] opened gitignore file: /private/tmp/ruff-test/.ruff_cache/.gitignore
[2025-03-12][11:12:07][ruff_workspace::resolver][DEBUG] Ignored path via `exclude`: &quot;/private/tmp/ruff-test/.ruff_cache&quot;
[2025-03-12][11:12:07][ruff::commands::check][DEBUG] Identified files to lint in: 9.338125ms
[2025-03-12][11:12:07][ruff::diagnostics][DEBUG] Checking: /private/tmp/ruff-test/test.py
[2025-03-12][11:12:07][ruff::diagnostics][DEBUG] Checking: /private/tmp/ruff-test/pyproject.toml
[2025-03-12][11:12:07][ruff_linter::rules::isort::categorize][DEBUG] Categorized 'requests' as Known(ThirdParty) (NoMatch)
[2025-03-12][11:12:07][ruff_linter::rules::isort::categorize][DEBUG] Categorized 'tomllib' as Known(ThirdParty) (NoMatch)
[2025-03-12][11:12:07][ruff_linter::rules::isort::categorize][DEBUG] Categorized '__future__' as Known(Future) (Future)
[2025-03-12][11:12:07][ruff::commands::check][DEBUG] Checked 2 files in: 837.5µs
test.py:1:1: I001 [*] Import block is un-sorted or un-formatted
  |
1 | / from __future__ import annotations
2 | |
3 | | import tomllib
4 | |
5 | | import requests
  | |_______________^ I001
  |
  = help: Organize imports
Found 1 error.
[*] 1 fixable with the `--fix` option.
</code></pre>
<p>cc @dylwil3</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2025-03-12 05:48</div>
            <div class="timeline-body"><p>The actual workaround would be to use the <a href="https://docs.astral.sh/ruff/settings/#target-version"><code>target-version</code></a> config which does mean that the information is duplicated but we're working towards a fix for it.</p>
<pre><code class="language-toml">target-version = &quot;py312&quot;

[lint]
select = [&quot;I001&quot;]
ignore = [&quot;T201&quot;]
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">question</span> removed by @dhruvmanila on 2025-03-12 05:48</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">configuration</span> added by @dhruvmanila on 2025-03-12 05:48</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dylwil3">@dylwil3</a> on 2025-03-12 10:32</div>
            <div class="timeline-body"><p>Investigating the issue at the linked PR now. Something must be <em>resetting</em> the <code>target-version</code> based on those logs - very glad you caught this! Even more unsettling: if you directly pass the file path in then you get the expected behavior:</p>
<pre><code class="language-console">❯ ../target/debug/ruff check --no-cache -v test.py
[2025-03-12][05:29:39][ruff::resolve][DEBUG] Using configuration file (via parent) at: /Users/dmbp/Documents/dev/contrib/ruff/tmp/ruff.toml
[2025-03-12][05:29:39][ruff_workspace::pyproject][DEBUG] No `target-version` found in `ruff.toml`
[2025-03-12][05:29:39][ruff_workspace::pyproject][DEBUG] Detected minimum supported `requires-python` version: 3.12
[2025-03-12][05:29:39][ruff_workspace::pyproject][DEBUG] Derived `target-version` from `requires-python` in `pyproject.toml`: Py312
[2025-03-12][05:29:39][ruff::commands::check][DEBUG] Identified files to lint in: 6.826875ms
[2025-03-12][05:29:39][ruff::diagnostics][DEBUG] Checking: /Users/dmbp/Documents/dev/contrib/ruff/tmp/test.py
[2025-03-12][05:29:39][ruff_linter::rules::isort::categorize][DEBUG] Categorized 'requests' as Known(ThirdParty) (NoMatch)
[2025-03-12][05:29:39][ruff_linter::rules::isort::categorize][DEBUG] Categorized 'tomllib' as Known(StandardLibrary) (KnownStandardLibrary)
[2025-03-12][05:29:39][ruff_linter::rules::isort::categorize][DEBUG] Categorized '__future__' as Known(Future) (Future)
[2025-03-12][05:29:39][ruff::commands::check][DEBUG] Checked 1 files in: 1.247917ms
All checks passed!
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @MichaReiser on 2025-03-13 11:51</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/amoralesc">@amoralesc</a> on 2025-03-13 17:01</div>
            <div class="timeline-body"><p>Hey @dylwil3. Since you seem to be working on this issue, and seeing your <a href="https://github.com/astral-sh/ruff/commit/15c05356f4631fbc739cbfa552e22a34ef1766cc">commit</a>, I would like to ask about how would the Python version be resolved for Ruff in this situation.</p>
<p>I have a <code>pyproject.toml</code> file with the <code>requires-python</code> property defined at the root of the project. I then have a <code>.ruff.toml</code> configuration file <strong>without</strong> the <code>target-version</code> property under a <code>.config</code> directory. So essentially:</p>
<pre><code class="language-plaintext">.
├── .config/
│   └── .ruff.toml
└── pyproject.toml
</code></pre>
<p>I then run Ruff like this (from the project root):</p>
<pre><code class="language-bash">ruff --config .config/.ruff.toml check .
</code></pre>
<p>Your commit suggests that if I specify that the config file is under <code>.config</code>, it means that it will look for the <code>pyproject.toml</code> under the same directory. However, in this situation, I don't have my custom configuration file under the project root (to not clutter it).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dylwil3">@dylwil3</a> on 2025-03-13 17:13</div>
            <div class="timeline-body"><p>Hi @amoralesc that's a good question!</p>
<p>If you pass a config file in directly via <code>--config</code> then none of the new behavior is triggered, so <code>ruff</code> would use the default <code>target-version</code> (which is currently 3.9) in this case. This is meant to be more consistent with the current behavior: if a user passes in a config file directly, then we don't do any further config file discovery or hierarchical resolution, we just use the config file passed in and use the current working directory as the &quot;root&quot; of the project.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/amoralesc">@amoralesc</a> on 2025-03-13 17:24</div>
            <div class="timeline-body"><p>I know this is probably too much too ask, and perhaps out of scope for Ruff, but could it ever support this behavior where the <code>requires-python</code> version lives on the <code>pyproject.toml</code>, but the config file is specified by command line AND they don't share the same directory?</p>
<p>And to not break current behavior, perhaps with a command line flag like <code>--python-version-file</code> or something of that line?</p>
<p>Of course I would understand if this is out of scope for the project because it is a very specific use-case of having different paths for Python config files.</p>
<p><strong>EDIT:</strong> My specific use-case is to reduce the places where I have to remember to change the Python version when it is upgraded on a project. It's not a project-ending problem, but it is quite a headache to remember all the places where the Python version gets pinned on a project (config files, version files, Dockerfiles, etc.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dylwil3">@dylwil3</a> on 2025-03-13 17:34</div>
            <div class="timeline-body"><p>It's an interesting idea, and I don't know offhand if users would find it more or less confusing to use the behavior you describe.</p>
<p>Could you help me understand a bit more about your situation? In particular, I'm curious why you wouldn't want to put your configuration in the <code>[tool.ruff]</code> section of the <code>pyproject.toml</code>. That wouldn't clutter your directory. Is the issue that you want to have a local configuration that differs from a shared configuration?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/amoralesc">@amoralesc</a> on 2025-03-13 19:50</div>
            <div class="timeline-body"><p>I don't love placing the Ruff configuration in the <code>[tool.ruff]</code> section mostly because I like to have separate configuration files for each of the tools that I'm using on my development environment (and if possible and the tool supports it, under a <code>.config</code> directory).</p>
<p>Most of the Python tools that I run on a Python project (<code>uv</code>, <code>ruff</code>, <code>mypy</code>) will indeed allow me to configure them directly on the <code>pyproject.toml</code>. However, I may use other tools on my env (specially on monorepos), like Prettier, ESLint, ShellCheck, hadolint, just to name a few. All of those tools do use their own configuration file, and they also allow me the flexibility of placing them under a <code>.config</code> a directory, just like Ruff also does.</p>
<p>So this is mostly a preference thing. I like having all my development tools configured by their own standalone configuration files. This also makes it easier to document the development tools at the README or wherever I'm documenting the project. For example:</p>
<pre><code class="language-markdown">- Hey, look at `.config/.ruff.toml` to change how Ruff works!
- You can also change Prettier's behavior at `.config/.prettierrc.yml`!
- `uv` manages Ruff's versioning at `pyproject.toml`, and NPM manages Prettier's versioning at `package.json`.
</code></pre>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 11:36:54 UTC
    </footer>
</body>
</html>
