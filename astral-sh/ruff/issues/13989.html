<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[red-knot] Improve `not-iterable` diagnostic - astral-sh/ruff #13989</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[red-knot] Improve `not-iterable` diagnostic</h1>

    <div class="meta">
        <span class="state state-closed">Closed</span>
        <a href="https://github.com/astral-sh/ruff/issues/13989">#13989</a>
        opened by <a href="https://github.com/MichaReiser">@MichaReiser</a>
        on 2024-10-30 09:50
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-10-30 09:50</div>
            <div class="timeline-body"><p>It's hard to debug why a type isn't considered iterable by red knot:</p>
<p>For example:</p>
<pre><code class="language-py">from typing import reveal_type


class TestIter:
    def __next__(self) -&gt; str: ...


class Test:
    def __iter__(self) -&gt; TestIter: ...


def bool_instance() -&gt; bool:
    return True


flag = bool_instance()

if flag:
    a = &quot;123&quot;
else:
    a = Test()

for x in a:
    ...
reveal_type(x)
</code></pre>
<p>Reports</p>
<pre><code>ERROR /home/micha/astral/test/src/test.py:23:10: Object of type `Literal[&quot;123&quot;] | Test` is not iterable
ERROR /home/micha/astral/test/src/test.py:25:13: Name `x` used when possibly not defined
ERROR /home/micha/astral/test/src/test.py:25:1: Revealed type is `Unbound | Unknown`
</code></pre>
<p>And it's not clear to me why <code>Test</code> the type isn't iterable (pyright is fine with it).</p>
<p>Changing <code>__next__</code> on <code>TestIter</code> to a non-callable gives the exact same error message (expect) but the error message isn't helpful because it isn't telling you what's off.</p>
<pre><code class="language-py">class TestIter:
    __next__ = 10
</code></pre>
<p>I'm not sure if it's worth investing time into improving the diagnostics know or if we should wait for proper <code>Protocols</code> support but I thought it worth noting it down because I just had a very bad time debugging the error message myself</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by @MichaReiser on 2024-10-30 09:50</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-10-30 12:01</div>
            <div class="timeline-body"><p>I agree that this is bad and that we need to improve it before a release, but I'm not sure I want to invest time in improving it until we have more structured diagnostics. Having all the context and rationale on the same line as the diagnostic message itself would create unreadably long diagnostic messages right now, I think</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/16161.html">astral-sh/ruff#16161</a> on 2025-02-14 15:13</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/16321.html">astral-sh/ruff#16321</a> on 2025-02-22 22:05</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-04-29 14:27</div>
            <div class="timeline-body"><p>Fixed in https://github.com/astral-sh/ruff/pull/16321 and https://github.com/astral-sh/ruff/pull/16321 (thanks @BurntSushi!)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @AlexWaygood on 2025-04-29 14:27</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:34:53 UTC
    </footer>
</body>
</html>
