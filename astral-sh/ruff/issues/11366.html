<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Native server indexes the entire project when no local config found - astral-sh/ruff #11366</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Native server indexes the entire project when no local config found</h1>

    <div class="meta">
        <span class="state state-closed">Closed</span>
        <a href="https://github.com/astral-sh/ruff/issues/11366">#11366</a>
        opened by <a href="https://github.com/akthe-at">@akthe-at</a>
        on 2024-05-11 02:48
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/akthe-at">@akthe-at</a> on 2024-05-11 02:48</div>
            <div class="timeline-body"><p>I initially posted this in #11258 as an issue I noticed but I figured it was going to be fixed with the associated PR(#11266).  However with ruff 0.4.4 I noticed that the problem described below still persists. I am going to attach the LSP error from neovim, it appears to have a lot of repeating messages so I apologize.</p>
<pre><code>[ERROR][2024-05-10 21:40:46] .../vim/lsp/rpc.lua:770	&quot;rpc&quot;	&quot;C:\\Users\\ARK010\\AppData\\Local\\nvim-data\\mason\\bin\\ruff.CMD&quot;	&quot;stderr&quot;	&quot;┐ruff_server::server::api::notifications::did_open::run{file=file:///C:/Users/ARK010/test.py}\n┘\n  39.925874s INFO ruff_server::session::workspace::ruff_settings No Ruff settings file found for C:\\Users\\ARK010\\test.py; falling back to default configuration\n&quot;
[ERROR][2024-05-10 21:40:46] .../vim/lsp/rpc.lua:770	&quot;rpc&quot;	&quot;C:\\Users\\ARK010\\AppData\\Local\\nvim-data\\mason\\bin\\ruff.CMD&quot;	&quot;stderr&quot;	&quot;┐ruff_server::server::api::notifications::did_change::run{file=file:///C:/Users/ARK010/test.py}\n┘\n  39.926023s INFO ruff_server::session::workspace::ruff_settings No Ruff settings file found for C:\\Users\\ARK010\\test.py; falling back to default configuration\n┐ruff_server::server::api::notifications::did_change::run{file=file:///C:/Users/ARK010/test.py}\n┘\n  39.926098s INFO ruff_server::session::workspace::ruff_settings No Ruff settings file found for C:\\Users\\ARK010\\test.py; falling back to default configuration\n┐ruff_server::server::api::notifications::did_change::run{file=file:///C:/Users/ARK010/test.py}\n┘\n  39.926179s INFO ruff_server::session::workspace::ruff_settings No Ruff settings file found for C:\\Users\\ARK010\\test.py; falling back to default configuration\n┐ruff_server::server::api::notifications::did_change::run{file=file:///C:/Users/ARK010/test.py}\n┘\n  39.926229s INFO ruff_server::session::workspace::ruff_settings No Ruff settings file found for C:\\Users\\ARK010\\test.py; falling back to default configuration\n┐ruff_server::server::api::notifications::did_change::run{file=file:///C:/Users/ARK010/test.py}\n┘\n┐ruff_server::server::api::notifications::did_change::run{file=file:///C:/Users/ARK010/test.py}\n┘\n  39.926298s INFO ruff_server::session::workspace::ruff_settings No Ruff settings file found for C:\\Users\\ARK010\\test.py; falling back to default configuration\n  39.926323s INFO ruff_server::session::workspace::ruff_settings No Ruff settings file found for C:\\Users\\ARK010\\test.py; falling back to default configuration\n  39.926377s INFO ruff_server::session::workspace::ruff_settings No Ruff settings file found for C:\\Users\\ARK010\\test.py; falling back to default configuration\n┐ruff_server::server::api::notifications::cancel::run{}\n┘\n  39.926542s INFO ruff_server::session::workspace::ruff_settings No Ruff settings file found for C:\\Users\\ARK010\\test.py; falling back to default configuration\n┐ruff_server::server::api::notifications::cancel::run{}\n┘\n┐ruff_formatter::printer::Printer::print{}\n┘\n&quot;
[ERROR][2024-05-10 21:40:46] .../vim/lsp/rpc.lua:770	&quot;rpc&quot;	&quot;C:\\Users\\ARK010\\AppData\\Local\\nvim-data\\mason\\bin\\ruff.CMD&quot;	&quot;stderr&quot;	&quot;  39.927576s INFO ruff_server::server Configuration file watcher successfully registered\n┐ruff_formatter::printer::Printer::print{}\n┘\n&quot;
</code></pre>
<p>I am also going to copy and paste the lsp log from ~2 minutes later when I tried again in the same file (without closing it, just waiting ~ 2 minutes, and it successfully formatted.</p>
<pre><code>[ERROR][2024-05-10 21:43:23] .../vim/lsp/rpc.lua:770	&quot;rpc&quot;	&quot;C:\\Users\\ARK010\\AppData\\Local\\nvim-data\\mason\\bin\\ruff.CMD&quot;	&quot;stderr&quot;	&quot; 196.088724s INFO ruff_server::session::workspace::ruff_settings No Ruff settings file found for C:\\Users\\ARK010\\test.py; falling back to default configuration\n┐ruff_formatter::printer::Printer::print{}\n┘\n&quot;
[ERROR][2024-05-10 21:43:23] .../vim/lsp/rpc.lua:770	&quot;rpc&quot;	&quot;C:\\Users\\ARK010\\AppData\\Local\\nvim-data\\mason\\bin\\ruff.CMD&quot;	&quot;stderr&quot;	&quot;┐ruff_server::server::api::notifications::did_change::run{file=file:///C:/Users/ARK010/test.py}\n┘\n&quot;
[ERROR][2024-05-10 21:43:23] .../vim/lsp/rpc.lua:770	&quot;rpc&quot;	&quot;C:\\Users\\ARK010\\AppData\\Local\\nvim-data\\mason\\bin\\ruff.CMD&quot;	&quot;stderr&quot;	&quot;┐ruff_server::server::api::notifications::did_change::run{file=file:///C:/Users/ARK010/test.py}\n┘\n&quot;
[ERROR][2024-05-10 21:43:23] .../vim/lsp/rpc.lua:770	&quot;rpc&quot;	&quot;C:\\Users\\ARK010\\AppData\\Local\\nvim-data\\mason\\bin\\ruff.CMD&quot;	&quot;stderr&quot;	&quot; 196.157007s INFO ruff_server::session::workspace::ruff_settings No Ruff settings file found for C:\\Users\\ARK010\\test.py; falling back to default configuration\n&quot;
[ERROR][2024-05-10 21:43:23] .../vim/lsp/rpc.lua:770	&quot;rpc&quot;	&quot;C:\\Users\\ARK010\\AppData\\Local\\nvim-data\\mason\\bin\\ruff.CMD&quot;	&quot;stderr&quot;	&quot; 196.160130s INFO ruff_server::session::workspace::ruff_settings No Ruff settings file found for C:\\Users\\ARK010\\test.py; falling back to default configuration\n&quot;
</code></pre>
<blockquote>
<p>@snowsignal Does this PR solve this scenario:
Windows 10
Neovim Nightly Latest
Ruff 0.4.3
Python 3.12.3</p>
<ul>
<li>Have global config in ~/.config/ruff/pyproject.toml</li>
<li>Create &quot;test.py&quot; in  ~/ (not a project/workspace and there is no present .toml config)</li>
<li>Create a test function</li>
</ul>
<pre><code class="language-python">def this_function(y: int, x: int) -&gt; int:


    &quot;&quot;&quot; This is an example function &quot;&quot;&quot;


    word_fx: int = 0
    return y + x + word_fx
</code></pre>
<ul>
<li>Notice the excessive space between function definition and doc strings...</li>
<li>Attempt to save (my neovim config would use conform.nvim to call ruff to format on save)</li>
<li>2-4 second hang...ruff errors and times out (   Warn  8:53:50 PM notify.warn [LSP][ruff] timeout)</li>
<li>Curve ball...wait a minute or two to type this example/report up...go to save and it formats successfully this time.</li>
<li>This does not occur in projects with a local .toml file...</li>
<li>I am assuming this is because it takes time to look for the global config and it doesn't merge with the editor config without the local config?</li>
</ul>
<p><em>Originally posted by @akthe-at in https://github.com/astral-sh/ruff/issues/11258#issuecomment-2093954838</em></p>
</blockquote>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">server</span> added by @AlexWaygood on 2024-05-11 09:24</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @snowsignal by @snowsignal on 2024-05-13 01:53</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/akthe-at">@akthe-at</a> on 2024-05-29 03:12</div>
            <div class="timeline-body"><p>@snowsignal I have more information, I think this revelation might make you want to close this issue?</p>
<p>I had a hunch and moved the simple .py featured above from the location of <code>&quot;~&quot;</code> or <code>C:/Users/FooBar/ </code>to a much more nested directory like <code>~/config/test/</code> and this problem no longer persisted.</p>
<p>It appears the issue is that formatting with ruff times out when the file is in the ~/ directory because it is busy parsing all of the sub-directories?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/danielhollas">@danielhollas</a> on 2024-06-03 13:01</div>
            <div class="timeline-body"><p>I've ran into this as well, it's very confusing. The ruff Lsp would be delayed on startup if a modified python file is in a top level folder without a config file (i.e. outside of project directory). I noticed in Lsp logs that ruff is walking all subdirectories looking for a config file.</p>
<p>I don't understand why ruff should be looking for a config file in subdirectories? Shouldn't it be the other way around i.e it should walk the parent directories to look for the config. This seems like a bug to me.</p>
<p>Cc @dhruvmanila</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-06-03 13:12</div>
            <div class="timeline-body"><p>I think it has to scan sub folders in case you have a configuration e.g. only in the <code>src</code> directory. We then want to apply that configuration to <code>src</code> only, but fall back to the default configuration for everything else.</p>
<p>I wonder if we ignore directories like <code>.git</code> etc when walking. If not, then that could add a significant overhead.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-06-03 13:19</div>
            <div class="timeline-body"><p>@MichaReiser - We ignore them now. We didn't in the initial beta release.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/danielhollas">@danielhollas</a> on 2024-06-03 14:21</div>
            <div class="timeline-body"><blockquote>
<p>I think it has to scan sub folders in case you have a configuration e.g. only in the <code>src</code> directory. We then want to apply that configuration to <code>src</code> only, but fall back to the default configuration for everything else.</p>
<p>I wonder if we ignore directories like <code>.git</code> etc when walking. If not, then that could add a significant overhead.</p>
</blockquote>
<p>I am confused. Surely if I am editing a file from outside the src/ directory, then even if you find a config there it shouldn't apply to the file I am editing, right?</p>
<p>Right now if I am editing a python file in me $HOME, it seems to walk the entirety of my HOME which seems suboptimal:-)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone "Ruff Server: Stable" by @snowsignal on 2024-06-17 16:28</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-07-02 06:18</div>
            <div class="timeline-body"><p>I'm looking into this. The <code>ruff check t.py</code> command where <code>t.py</code> file is in the home directory is instantaneous. So, I'm guessing we're doing extra work in the server compared to what's being done on the command-line.</p>
<p>Looking at the following logs, it does seem like we're traversing the entire home directory to build up the index which I think was intentional in https://github.com/astral-sh/ruff/pull/10950.</p>
<pre><code>[START][2024-07-02 11:17:44] LSP logging initiated
[ERROR][2024-07-02 11:17:44] .../vim/lsp/rpc.lua:770	&quot;rpc&quot;	&quot;/Users/dhruv/.local/bin/ruff&quot;	&quot;stderr&quot;	&quot;warning: The top-level linter settings are deprecated in favour of their counterparts in the `lint` section. Please update the following options in `projects/algorithms_keeper/pyproject.toml`:\n  - 'ignore' -&gt; 'lint.ignore'\n  - 'select' -&gt; 'lint.select'\n  - 'mccabe' -&gt; 'lint.mccabe'\n  - 'pylint' -&gt; 'lint.pylint'\n  - 'per-file-ignores' -&gt; 'lint.per-file-ignores'\n&quot;
[ERROR][2024-07-02 11:18:10] .../vim/lsp/rpc.lua:770	&quot;rpc&quot;	&quot;/Users/dhruv/.local/bin/ruff&quot;	&quot;stderr&quot;	&quot;warning: The top-level linter settings are deprecated in favour of their counterparts in the `lint` section. Please update the following options in `Library/Caches/uv/archive-v0/iWen-UJ1Onc60Mw9JA5ey/pandas/pyproject.toml`:\n  - 'ignore' -&gt; 'lint.ignore'\n  - 'select' -&gt; 'lint.select'\n  - 'typing-modules' -&gt; 'lint.typing-modules'\n  - 'unfixable' -&gt; 'lint.unfixable'\n  - 'per-file-ignores' -&gt; 'lint.per-file-ignores'\n&quot;
[ERROR][2024-07-02 11:18:11] .../vim/lsp/rpc.lua:770	&quot;rpc&quot;	&quot;/Users/dhruv/.local/bin/ruff&quot;	&quot;stderr&quot;	&quot;warning: The top-level linter settings are deprecated in favour of their counterparts in the `lint` section. Please update the following options in `.cargo/registry/src/index.crates.io-6f17d22bba15001f/pep440_rs-0.3.12/pyproject.toml`:\n  - 'per-file-ignores' -&gt; 'lint.per-file-ignores'\n&quot;
[ERROR][2024-07-02 11:18:17] .../vim/lsp/rpc.lua:770	&quot;rpc&quot;	&quot;/Users/dhruv/.local/bin/ruff&quot;	&quot;stderr&quot;	&quot;warning: The top-level linter settings are deprecated in favour of their counterparts in the `lint` section. Please update the following options in `work/astral/parser-checkouts/openai-python/pyproject.toml`:\n  - 'ignore' -&gt; 'lint.ignore'\n  - 'ignore-init-module-imports' -&gt; 'lint.ignore-init-module-imports'\n  - 'select' -&gt; 'lint.select'\n  - 'unfixable' -&gt; 'lint.unfixable'\n  - 'per-file-ignores' -&gt; 'lint.per-file-ignores'\n&quot;
[ERROR][2024-07-02 11:18:17] .../vim/lsp/rpc.lua:770	&quot;rpc&quot;	&quot;/Users/dhruv/.local/bin/ruff&quot;	&quot;stderr&quot;	&quot;warning: The top-level linter settings are deprecated in favour of their counterparts in the `lint` section. Please update the following options in `work/astral/parser-checkouts/matplotlib/pyproject.toml`:\n  - 'external' -&gt; 'lint.external'\n  - 'ignore' -&gt; 'lint.ignore'\n  - 'select' -&gt; 'lint.select'\n  - 'pydocstyle' -&gt; 'lint.pydocstyle'\n  - 'per-file-ignores' -&gt; 'lint.per-file-ignores'\n&quot;
...
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-07-02 06:28</div>
            <div class="timeline-body"><blockquote>
<p>We ignore them now. We didn't in the initial beta release.</p>
</blockquote>
<p>I don't think we're ignoring them. I just logged the directories that we're visiting and it is visiting the <code>.git</code> directory:</p>
<pre><code>  [..]
  47.573640042s  INFO main ruff_server::session::index::ruff_settings: Visiting &quot;/Users/dhruv/git/pyright/.git&quot;
  47.966425417s  INFO main ruff_server::session::index::ruff_settings: Visiting &quot;/Users/dhruv/git/vscode/.git&quot;
  48.093653667s  INFO main ruff_server::session::index::ruff_settings: Visiting &quot;/Users/dhruv/git/black/.git&quot;
  48.093867208s  INFO main ruff_server::session::index::ruff_settings: Visiting &quot;/Users/dhruv/git/black/.git/objects&quot;
  48.093895917s  INFO main ruff_server::session::index::ruff_settings: Visiting &quot;/Users/dhruv/git/black/.git/objects/pack&quot;
  48.093932625s  INFO main ruff_server::session::index::ruff_settings: Visiting &quot;/Users/dhruv/git/black/.git/objects/info&quot;
  [..]
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-07-02 06:57</div>
            <div class="timeline-body"><p>Ok, we are ignoring the <code>.git</code> directory but not all of them:</p>
<pre><code>   0.155401750s  INFO main ruff_server::session::index::ruff_settings: Visiting &quot;/Users/dhruv/work/astral/parser-checkouts/home-assistant-core/.git&quot;
   0.155417292s DEBUG main ruff_server::session::index::ruff_settings: Ignored path via `exclude`: /Users/dhruv/work/astral/parser-checkouts/home-assistant-core/.git
</code></pre>
<p>And via a Python file in home directory:</p>
<pre><code>  51.116335792s  INFO main ruff_server::session::index::ruff_settings: Visiting &quot;/Users/dhruv/git/oxc/.git&quot;
  51.116371750s  INFO main ruff_server::session::index::ruff_settings: Visiting &quot;/Users/dhruv/git/oxc/.git/objects&quot;
  51.116647917s  INFO main ruff_server::session::index::ruff_settings: Visiting &quot;/Users/dhruv/git/oxc/.git/objects/pack&quot;

  [..]

  51.168634667s  INFO main ruff_server::session::index::ruff_settings: Visiting &quot;/Users/dhruv/git/kitty/.git&quot;
  51.168642167s DEBUG main ruff_server::session::index::ruff_settings: Ignored path via `exclude`: /Users/dhruv/git/kitty/.git
</code></pre>
<p>I think what is happening is that the exclusion is using the existing index which is currently being built:
https://github.com/astral-sh/ruff/blob/25080acb7ad899f1e0ed933582662d9699ef5424/crates/ruff_server/src/session/index/ruff_settings.rs#L145-L147</p>
<p>But, it doesn't contain the resolved settings until it encounters a configuration file and only then it'll start excluding any relevant directories for the matching paths. I think this is an expected behavior.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @dhruvmanila by @dhruvmanila on 2024-07-10 03:01</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Unassigned @snowsignal by @dhruvmanila on 2024-07-10 03:01</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/12299.html">astral-sh/ruff#12299</a> on 2024-07-12 12:11</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-07-15 09:54</div>
            <div class="timeline-body"><p>There are two more options that could be implemented here:</p>
<ol>
<li>Not indexing the project if there's no root configuration file present</li>
<li>Or, use a fallback settings (default) if there's no root configuration file present</li>
</ol>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/12362.html">astral-sh/ruff#12362</a> on 2024-07-17 12:51</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "ruff server has delay when no local config." to "Native server indexes the entire project when no local config found" by @dhruvmanila on 2024-07-22 10:05</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Removed from milestone "Ruff Server: Stable" by @dhruvmanila on 2024-07-22 10:05</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone "Ruff Server: Post-Stable" by @dhruvmanila on 2024-07-22 10:05</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../astral-sh/ruff-vscode/issues/549.html">astral-sh/ruff-vscode#549</a> on 2024-08-07 02:38</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/akthe-at">@akthe-at</a> on 2024-08-08 20:02</div>
            <div class="timeline-body"><p>Just wanted to say great job on improving this over the last few releases. This only takes ~10 seconds to successfully format compared to the ~2 minutes before...Same file, same directory, same repeated format &quot;issues&quot; and a vastly improved user experience now.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../astral-sh/ruff-vscode/issues/606.html">astral-sh/ruff-vscode#606</a> on 2024-09-07 23:44</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../astral-sh/ruff-vscode/issues/627.html">astral-sh/ruff-vscode#627</a> on 2024-10-09 06:40</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-10-10 15:22</div>
            <div class="timeline-body"><p>There seems to be one more case when this occurs - when a user opens a random file on their system directly in VS Code. In this case, the client doesn't send the workspace path and the current working directory for the editor is <code>/</code>. This means the server will try to index the entire system which is not ideal.</p>
<p>One solution is mentioned in https://github.com/astral-sh/ruff-vscode/issues/627#issuecomment-2405420427:</p>
<blockquote>
<p>We would avoid traversing into the current working directory if the server is running in single-file mode. A single-file mode is basically when there's no workspace provided by the client. So, the indexer would still climb up as well as look into the current working directory for any config but it won't traverse it.</p>
</blockquote>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/13770.html">astral-sh/ruff#13770</a> on 2024-10-16 09:11</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @dhruvmanila on 2024-10-18 05:21</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @dhruvmanila on 2024-10-18 05:21</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../astral-sh/ruff-vscode/issues/637.html">astral-sh/ruff-vscode#637</a> on 2024-10-29 10:03</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:34:52 UTC
    </footer>
</body>
</html>
