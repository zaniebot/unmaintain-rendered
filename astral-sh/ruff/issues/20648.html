<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Move diff rendering into `annotate-snippets` - astral-sh/ruff #20648</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Move diff rendering into `annotate-snippets`</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/ruff/issues/20648">#20648</a>
        opened by <a href="https://github.com/ntBre">@ntBre</a>
        on 2025-09-30 15:32
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/ntBre">@ntBre</a> on 2025-09-30 15:32</div>
            <div class="timeline-body"><p>Following https://github.com/astral-sh/ruff/pull/19919 and https://github.com/astral-sh/ruff/pull/20443, we now render fix diffs in the default output format for both the linter and formatter (in preview). For the snippet attached to the diagnostic, we use our fork of <code>annotate-snippets</code> to render the code but separate code for rendering the fix diff. We did our best to get the two to align well, and I think most cases are covered, but there are a few examples where it breaks down. For example, we render more context lines in the diff than in the snippet, so changes near a line width boundary (e.g. 9 -&gt; 10, 99 -&gt; 100) can result in a shift of the line number separator before and after the <code>help</code> message:</p>
<p>https://github.com/astral-sh/ruff/blob/b483d3b0b90aefed29a078630f7791a166a64159/crates/ruff_db/src/diagnostic/render/full.rs#L944-L963</p>
<p>This is somewhat more of an issue in the formatter because we don't want to render a snippet at all. We thus added a manual <code>header_offset</code> field in #20443, but it would be nice to reuse the same line width calculation in both steps.</p>
<p>A more robust approach to diff rendering would be to incorporate it into <code>annotate-snippets</code> directly. The line number width is computed here:</p>
<p>https://github.com/astral-sh/ruff/blob/bedfc6fd063e08f4d1e76ae8a780162404079298/crates/ruff_annotate_snippets/src/renderer/display_list.rs#L79-L84</p>
<p>based on the maximum line number in the <code>DisplayLine::Source</code> variants. Without looking into it <em>too</em> deeply, I think the ideal solution would be to add a new <code>DisplayLine::Diff</code> variant and incorporate our current <a href="https://github.com/astral-sh/ruff/blob/bedfc6fd063e08f4d1e76ae8a780162404079298/crates/ruff_db/src/diagnostic/render/full.rs#L83"><code>Diff</code></a> type's rendering code into <code>annotate-snippets</code>.</p>
<p>I think this would probably rule out https://github.com/astral-sh/ruff/issues/20411, so we'd also need to commit to staying on our fork.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">wish</span> added by @ntBre on 2025-09-30 15:32</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">needs-design</span> added by @ntBre on 2025-09-30 15:32</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">diagnostics</span> added by @ntBre on 2025-09-30 15:32</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/20649.html">astral-sh/ruff#20649</a> on 2025-09-30 15:58</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 01:30:18 UTC
    </footer>
</body>
</html>
