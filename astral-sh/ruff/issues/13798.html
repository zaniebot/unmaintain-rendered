<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[red-knot] Report line numbers in mdtest relative to the markdown file, not the test snippet - astral-sh/ruff #13798</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[red-knot] Report line numbers in mdtest relative to the markdown file, not the test snippet</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/issues/13798">#13798</a>
        opened by <a href="https://github.com/AlexWaygood">@AlexWaygood</a>
        on 2024-10-17 17:06
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a></div>
            <div class="timeline-body"><p>Currently if an assertion in <code>mdtest</code> fails, it gives you a message as follows:</p>
<pre><code>---- mdtest::path_06_resources_mdtest_binary_integers_md stdout ----

binary/integers.md - Division by Zero

/src/test.py
    line 13: unexpected error: [division-by-zero] &quot;Cannot divide object of type `int` by zero&quot;

--------------------------------------------------
</code></pre>
<p>The line number here isn&#x27;t particularly helpful if it&#x27;s the third or fourth snippet in a Markdown test suite, because it gives you the line number relative to the specific test snippet rather than the Markdown file. Nobody wants to manually count thirteen lines in a Python code block to figure out where the assertion failed!</p>
<p>It would be great if these line numbers could be reported relative to the enclosing Markdown file rather than just the specific code block that contained the failing assertion.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">testing</span> added by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-10-17 17:06</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-10-17 17:06</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">help wanted</span> added by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-10-17 17:06</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-10-17 19:37</div>
            <div class="timeline-body"><p>I prefer the way it is. It&#x27;s closer to the cli behavior and the diagnostic contains the file name</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-10-17 19:41</div>
            <div class="timeline-body"><p>This would also lead to fragile tests where changing a test description can change the asserted line numbers. Keeping the line numbers relative to the file ensures that only local changes affect the diagnostic line numbers</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-10-17 19:43</div>
            <div class="timeline-body"><p>@carljm and I were finding it <em>extremely</em> difficult to debug failing tests in #13800 just now with the current behaviour :/</p>
<blockquote>
<p>It&#x27;s closer to the cli behavior</p>
</blockquote>
<p>I&#x27;m not sure I understand or agree. The CLI never runs on Markdown files; it runs on Python files. If you run the CLI on a file <code>foo.py</code> and it reports there&#x27;s an error on line 14 of <code>foo.py</code>, you&#x27;ll be able to open up that file in an editor and jump straight to line 14. That&#x27;s the ability I want for mdtest: to have the reported line numbers correspond exactly to &quot;real&quot; line numbers on a file, so that I can jump to the line immediately and see which assertion is failing.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2024-10-17 20:18</div>
            <div class="timeline-body"><p>I think it&#x27;s important to clarify here that we are not talking about line numbers in <strong>Red Knot</strong> diagnostics; we are only talking about line numbers in <strong>mdtest</strong> error messages when a test fails. I definitely don&#x27;t think mdtest should ever modify line numbers as they appear in a Red Knot diagnostic.</p>
<blockquote>
<p>This would also lead to fragile tests where changing a test description can change the asserted line numbers. Keeping the line numbers relative to the file ensures that only local changes affect the diagnostic line numbers</p>
</blockquote>
<p>This is not an issue, we never assert in tests based on line numbers (instead we just put the assertion on or above the relevant line). And this seems to be based on a misunderstanding that we are talking about line numbers in red-knot diagnostics, rather than line numbers in mdtest failure messages.</p>
<p>The <em>only</em> use for a line number in an mdtest failure message is to help you quickly find where in your Markdown test file the error occurred. So the only relevant question here is what makes that fast and easy. I think it&#x27;s 100% clear that jumping to line X in your editor in the Markdown file is easier than first finding the right test header, then finding the right embedded file, then manually counting lines from the top of the code block.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-10-17 20:24</div>
            <div class="timeline-body"><p>I can see the pain point that but improving the rendering of diagnostics might help to make this more obvious.</p>
<p>I kind of agree that it&#x27;s different from the CLI and possibly closer to how diagnostics in embedded files should work. But the fact that it makes tests more fragile (changing a single description can break many assertions) is a no go for me unless we make those line numbers relative (which is also annoying because you then need to count the lines manually).</p>
<p>That&#x27;s why I would keep it as is. Adjusting the line numbers would also complicate the diagnostic rendering (not how it is done today but when we have a proper diagnostic system)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-10-17 20:26</div>
            <div class="timeline-body"><p>I&#x27;m not sure what&#x27;s unclear about the error messages in the linked test. Some markdown editors support showing line numbers for code blocks. That might help https://stackoverflow.com/a/65579102</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2024-10-17 20:26</div>
            <div class="timeline-body"><blockquote>
<p>the fact that it makes tests more fragile</p>
</blockquote>
<p>but it doesn&#x27;t</p>
<blockquote>
<p>would also complicate the diagnostic rendering</p>
</blockquote>
<p>I assume you&#x27;re talking about Red Knot diagnostic rendering? The change proposed here has nothing to do with Red Knot diagnostics at all.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2024-10-17 20:53</div>
            <div class="timeline-body"><p>To clarify the point I made above, let&#x27;s say that in future we have (and match on) red-knot diagnostics that include a line number, and we are asserting against a full diagnostic message, including the line number (which would usually be a bad idea because it&#x27;s fragile to changes in the test, but maybe sometime we want to do it.) So today in that case, if your test fails because of a line number mismatch, mdtest might tell you something like this:</p>
<pre><code>failures:

---- mdtest::path_06_resources_mdtest_directory_file_md stdout ----

directory/file.md - Some Test

/src/test.py
    line 9: unmatched assertion: error: [some-code] &quot;line 8 -- some error&quot;
    line 9: unexpected error: 1 [some-code] &quot;line 9 - some error&quot;
</code></pre>
<p>Oops, we asserted a red-knot diagnostic including the text &quot;line 8&quot; but we actually got one including the text &quot;line 9&quot;. And mdtest helpfully tells us this problem occurs on line 9 of the embedded <code>/src/test.py</code> in the test &quot;Some Test&quot; in <code>directory/file.md</code>.</p>
<p>So to debug this, we have to open <code>directory/file.md</code>, search for &quot;Some Test&quot;, find the embedded file <code>/src/test.py</code>, and then count nine lines down from the start of the code block. (If you have lots of lines with very similar revealed-type assertions on every line, which is the situation we were in earlier today, this kind of counting is the <em>only</em> way to find the right line, and sometimes you have to count 20+ lines, or do some quick mental addition and hope you don&#x27;t have an off-by-one error depending whether line 1 is the line with the backticks-fence or the line after that...)</p>
<p>The proposed change here is that mdtest would instead output something like this:</p>
<pre><code>failures:

---- mdtest::path_06_resources_mdtest_directory_file_md stdout ----

directory/file.md - Some Test

line 36: unmatched assertion: error: [some-code] &quot;line 8 -- some error&quot;
line 36: unexpected error: 1 [some-code] &quot;line 9 - some error&quot;
</code></pre>
<p>Line numbers in red-knot diagnostics are untouched; you still see that from the perspective of the embedded file that red-knot sees, the discrepancy in red-knot diagnostic is line 8 vs 9. But now you also can find the problematic assertion in your test by going directly to line 36 of <code>directory/file.md</code> in your editor.</p>
<p>Given my experience working with mdtest today, I think this change (or something providing equivalent information) is a requirement for usability of mdtest. I don&#x27;t know which editors show line numbers inside markdown code blocks; I don&#x27;t think I&#x27;ve used one, and I don&#x27;t think that&#x27;s a reasonable editor requirement to make mdtest usable.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-10-17 21:06</div>
            <div class="timeline-body"><p>That makes sense. Thanks for explaining and sorry for the confusion on my side.</p>
<p>We may want to use a format that many editors recognize in the shell. E.g path/test.md:line Error so that you can directly jump to the relevant line</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2024-10-17 21:09</div>
            <div class="timeline-body"><blockquote>
<p>We may want to use a format that many editors recognize in the shell. E.g path/test.md:line Error so that you can directly jump to the relevant line</p>
</blockquote>
<p>Yes, good idea!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-10-22 07:42</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 18:48:59 UTC
    </footer>
</body>
</html>
