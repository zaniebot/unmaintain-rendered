<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FA100 issue: Ruff doesnt suggest adding `from __future__ import annotations` - astral-sh/ruff #13273</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>FA100 issue: Ruff doesnt suggest adding `from __future__ import annotations`</h1>

    <div class="meta">
        <span class="state state-closed">Closed</span>
        <a href="https://github.com/astral-sh/ruff/issues/13273">#13273</a>
        opened by <a href="https://github.com/HappyCthulhu">@HappyCthulhu</a>
        on 2024-09-06 23:06
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/HappyCthulhu">@HappyCthulhu</a> on 2024-09-06 23:06</div>
            <div class="timeline-body"><h3>Search keywords</h3>
<p>&quot;TCH rules&quot;, &quot;move under TYPE_CHECKING&quot;, &quot;FA100&quot;</p>
<h3>Ruff Version</h3>
<p>0.5.7</p>
<h3>Config</h3>
<details>
    <summary> Part of pyproject.toml</summary>

<pre><code>[tool.poetry.group.dev.dependencies]
ruff = &quot;0.5.7&quot;

[tool.ruff]
line-length = 120
extend-exclude = [&quot;venv&quot;, &quot;stubs&quot;]

[tool.ruff.lint]
select = [&quot;ALL&quot;]
unfixable = [&quot;ERA001&quot;, &quot;COM819&quot;] # remove comment out code lines
# COM819 prohibited-trailing-comma. –≠—Ç–æ —Ñ–∏–∫—Å–∏—Ç—å –¥–æ–ª–∂–Ω–∞ format –∫–æ–º–∞–Ω–¥–∞, —á—Ç–æ–± –∫–∞–∫ –≤ black –±—ã–ª–æ
# –µ—Å–ª–∏ –µ—Å—Ç—å –∑–∞–ø—è—Ç–∞—è –≤ –∫–æ–Ω—Ü–µ - —Ä–∞—Å–∫—Ä—ã–≤–∞–µ—Ç –Ω–∞ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å—Ç—Ä–æ–∫. –ï—Å–ª–∏ –Ω–µ—Ç - –æ—Å—Ç–∞–≤–ª—è–µ—Ç –≤ –æ–¥–Ω–æ–π
ignore = [
    &quot;Q&quot;, # flake8-quotes
    &quot;D100&quot;,	# undocumented-public-module	Missing docstring in public module
    &quot;D101&quot;,	# undocumented-public-class	&quot;Missing&quot; # docstring in public class
    &quot;D102&quot;,	# undocumented-public-method	Missing docstring &quot;in&quot; # public method
    &quot;D103&quot;,	# undocumented-public-function	Missing docstring in &quot;public&quot; # function
    &quot;D104&quot;,	# undocumented-public-package	Missing docstring in public package	&quot;üõ†&quot;
    &quot;D105&quot;,	# undocumented-magic-method	Missing docstring in magic method
    &quot;D106&quot;,	# # undocumented-public-nested-class	Missing docstring in public nested class
    &quot;D107&quot;,	# # undocumented-public-init	Missing docstring in __init__
    &quot;ANN101&quot;, # missing-type-self
    &quot;TD003&quot;, # missing-todo-link missing issue link on the line following this TODO
    &quot;TD002&quot;, # missing-todo-author  missing author in TODO; try: `# TODO(&lt;author_name&gt;): ...` or `# TODO @&lt;author_name&gt;: ...`Ruff
    &quot;S101&quot;, # assert Use of assert detected	
    &quot;ANN002&quot;, #	missing-type-args	Missing type annotation for *{name}
    &quot;ANN003&quot;, #	missing-type-kwargs	Missing type annotation for **{name}
    &quot;RUF001&quot;, #	ambiguous-unicode-character-string	String contains ambiguous {}. Did you mean {}? –ú–æ–∂–µ—Ç –Ω–∞ —Ä—É—Å—Å–∫—É—é &quot;—Å&quot; –≤ –∫–æ–º–º–µ–Ω—Ç–µ —Ä—É–≥–∞—Ç—å—Å—è 
    &quot;RUF003&quot;, #	ambiguous-unicode-character-comment
    &quot;SLF001&quot;, # private-member-access	Private member accessed: {access} | —É—á–∏—Ç—ã–≤–∞—è, —á—Ç–æ –≤ Django –ø–æ—Å—Ç–æ—è–Ω–Ω–æ –¥–µ—Ä–≥–∞–µ–º _Meta –º–æ–¥–µ–ª–µ–π –∏ –ø–æ–ª—è –≤ –¥—É—Ö–µ _prefetched_objects_cache –∏ —Ç.–¥.
    # &quot;FA100&quot;, # future-rewritable-type-annotation	Missing from __future__ import annotations, but uses {name}	
    # &quot;FA102&quot;, # future-required-type-annotation	Missing from __future__ import annotations, but uses
    &quot;DJ001&quot;, # django-nullable-model-string-field	Avoid using null=True on string-based fields such as	
    &quot;PGH004&quot;, # Use specific rule codes when using `noqa`
    &quot;TRY003&quot;, # Avoid specifying long messages outside the exception class
    &quot;EM102&quot;, # Exception must not use an f-string literal, assign to variable first
    &quot;RUF002&quot;, # Docstring contains ambiguous `—É` (CYRILLIC SMALL LETTER U). Did you mean `y` (LATIN SMALL LETTER Y)?
    &quot;FBT001&quot;, # Boolean-typed positional argument in function definition
    &quot;FBT002&quot;, # Boolean default positional argument in function definition
    &quot;ANN204&quot;, # Missing return type annotation for special method `__init__`
]

[tool.ruff.lint.flake8-annotations]
mypy-init-return = true # ANN204 | checkers often allow you to omit the return type annotation for __init__ methods, as long as at least one argument has a type annotation

[tool.ruff.lint.isort]
force-wrap-aliases = true
combine-as-imports = true
</code></pre>
</details>

<h3>Bug Report</h3>
<p>My request:</p>
<p>I would like all imports that are used only for type hints to be placed under a TYPE_CHECKING block. If you have not yet implemented this function, please consider this issue as a feature request.</p>
<p>Sometimes ruff doesn't detect imports, that are used only for type-hints without <code>from __future__ import anotations</code>. I know, that existing of <code>from __future__ import anotations</code> is one of requirements for ruff to make give <code>TCH</code>-warnings. But sometimes <code>FA100</code> rules doesnt detect cases, when import is used only for type-hints. I will make an example for django-migration:</p>
<pre><code># Generated by Django 4.0.2 on 2022-09-19 12:51


from django.db import migrations
from django.db.backends.base.schema import BaseDatabaseSchemaEditor
from django.db.migrations.state import StateApps


def migrate(apps: StateApps, _schema: BaseDatabaseSchemaEditor) -&gt; None:
    apps.get_model(&quot;app_name&quot;, &quot;ModelName&quot;).objects.all().delete()


class Migration(migrations.Migration):
    dependencies = []  # noqa: RUF012

    operations = [  # noqa: RUF012
        migrations.RunPython(
            code=migrate,
            reverse_code=migrations.RunPython.noop,
        ),
    ]


</code></pre>
<p><img src="https://github.com/user-attachments/assets/8748a0b7-3e4f-489d-832d-43479816043f" alt="image" /></p>
<p>No ruff-warnings are shown in this code.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "FA100 issue: Roof doesnt suggest adding `from __future__ import annotations`" to "FA100 issue: Ruff doesnt suggest adding `from __future__ import annotations`" by @MichaReiser on 2024-09-07 12:06</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-09-07 12:19</div>
            <div class="timeline-body"><p>I think there are multiple things at play here.</p>
<ol>
<li>Ruff doesn't emit any TCH error for the provided example even if the <code>__future__ import</code> annotations is present. It has to do with the <code>migrations.RunPython</code> call but I'm not sure why. See <a href="https://play.ruff.rs/2914db75-c2fe-4c3f-bee5-3ddbed557bb3">Playground</a> Maybe @charliermarsh knows why?</li>
<li>Whether Ruff should add <code>from __future__ import annotations</code> I'm not so sure about. It could be a configuration option but the general idea is that these comments are explicit opt ins by the user.</li>
</ol>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-09-07 12:28</div>
            <div class="timeline-body"><p>If you know you want <code>from __future__ import annotations</code> added to all your Python files, you can use Ruff's <a href="https://docs.astral.sh/ruff/rules/missing-required-import/">I002 rule</a> in combination with this setting: https://docs.astral.sh/ruff/settings/#lint_isort_required-imports</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/HappyCthulhu">@HappyCthulhu</a> on 2024-09-07 12:34</div>
            <div class="timeline-body"><blockquote>
<p>I think there are multiple things at play here.</p>
<ol>
<li>Ruff doesn't emit any TCH error for the provided example even if the <code>__future__ import</code> annotations is present. It has to do with the <code>migrations.RunPython</code> call but I'm not sure why. See <a href="https://play.ruff.rs/2914db75-c2fe-4c3f-bee5-3ddbed557bb3">Playground</a> Maybe @charliermarsh knows why?</li>
</ol>
</blockquote>
<p>I dont think, thats true:</p>
<p>https://github.com/user-attachments/assets/4bc6bc04-712c-41e6-8baf-a10d0927fcab</p>
<p>As you can see, error appears after adding <code>from __future__ import annotations</code></p>
<blockquote>
<ol start="2">
<li>Whether Ruff should add <code>from __future__ import annotations</code> I'm not so sure about. It could be a configuration option but the general idea is that these comments are explicit opt ins by the user.</li>
</ol>
</blockquote>
<p>Im not talking about autofixing this rule (ruff have autofix option). Im talking, that i want ruff to tell me every time when some import is used only for type hint</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/HappyCthulhu">@HappyCthulhu</a> on 2024-09-07 12:36</div>
            <div class="timeline-body"><blockquote>
<p>If you know you want <code>from __future__ import annotations</code> added to all your Python files, you can use Ruff's <a href="https://docs.astral.sh/ruff/rules/missing-required-import/">I002 rule</a> in combination with this setting: https://docs.astral.sh/ruff/settings/#lint_isort_required-imports</p>
</blockquote>
<p>I dont rly want <code>from __future__ import annotations</code> present in my files. But, if that is the only way to force ruff tell me, if some import is used only for type-hint, i will apply this rule. So... This way is the only one, right?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-09-07 12:44</div>
            <div class="timeline-body"><blockquote>
<p>I dont think, thats true:</p>
</blockquote>
<p>You're right. The problem was that the original code snipped contained a syntax error. It works as expected if I fix the syntax error <a href="https://play.ruff.rs/657bba85-d290-43a1-8c12-fcf7e780076c">playground</a></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/eli-schwartz">@eli-schwartz</a> on 2024-09-08 05:10</div>
            <div class="timeline-body"><p>The same file with flake8 and flake8-type-checking emits the necessary error codes:</p>
<pre><code>$ flake8 test.py
test.py:5:1: TC002 Move third-party import 'django.db.backends.base.schema.BaseDatabaseSchemaEditor' into a type-checking block
test.py:6:1: TC002 Move third-party import 'django.db.migrations.state.StateApps' into a type-checking block

$ ruff check --select TCH test.py
All checks passed!
</code></pre>
<p>flake8-type-checking doesn't care whether you have imported future annotations yet. If you fix the imports by moving them into T.TYPE_CHECKING, it will still emit an error telling you how to fix your use of annotations that are evaluated at runtime and aren't available, via the &quot;how to handle forward references&quot; (there's an option to have it always advise you to use quoted strings instead):</p>
<pre><code>TC100 Add 'from __future__ import annotations' import
</code></pre>
<p>It might be nice for flake8-type-checking to warn you about both at the same time. I just recently opened https://github.com/snok/flake8-type-checking/issues/190 which is related to this but not exactly the same thing.</p>
<p>In the same situation, by the way, ruff reports:</p>
<pre><code>test.py:8:44: TCH004 Move import `django.db.migrations.state.StateApps` out of type-checking block. Import is used for more than type hinting.
test.py:9:48: TCH004 Move import `django.db.backends.base.schema.BaseDatabaseSchemaEditor` out of type-checking block. Import is used for more than type hinting.
Found 2 errors.
</code></pre>
<p>It's not used for more than type hinting, but whatever. ;)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/eli-schwartz">@eli-schwartz</a> on 2024-09-08 05:14</div>
            <div class="timeline-body"><p>By the way my reading of FA100 is that it is specifically applicable to cases where an annotation could be rewritten in a manner that ordinarily requires a new version of CPython, but where <code>__future__.annotations</code> would allow &quot;backporting&quot; support to an earlier version of python, i.e. PEP 585 / 604.</p>
<p>It is not about unlocking additional ways to discover TCH001-TCH003 &quot;move import into a type-checking block&quot; issues.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/HappyCthulhu">@HappyCthulhu</a> on 2024-09-12 15:39</div>
            <div class="timeline-body"><blockquote>
<p>It is not about unlocking additional ways to discover TCH001-TCH003 &quot;move import into a type-checking block&quot; issues.</p>
</blockquote>
<p>So, can we treat this issue as feature request or should i create another one?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/HappyCthulhu">@HappyCthulhu</a> on 2024-09-12 15:44</div>
            <div class="timeline-body"><p>BTW, ruff has a feature that automatically moves imports under the TYPE_CHECKING block, but this can cause issues with tools like <code>drf-spectacular</code>, which rely on type hints for certain classes (e.g., <code>Serializers</code>). When Ruff moves these type hints to the TYPE_CHECKING block, it causes <code>Swagger</code> to crash.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/eli-schwartz">@eli-schwartz</a> on 2024-09-12 16:01</div>
            <div class="timeline-body"><p>Please take a look at:</p>
<ul>
<li>https://docs.astral.sh/ruff/settings/#lint_flake8-type-checking_runtime-evaluated-base-classes</li>
<li>https://docs.astral.sh/ruff/settings/#lint_flake8-type-checking_runtime-evaluated-decorators</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/17763.html">astral-sh/ruff#17763</a> on 2025-05-04 19:33</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">rule</span> added by @MichaReiser on 2025-05-05 05:54</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/18502.html">astral-sh/ruff#18502</a> on 2025-06-06 16:35</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-06-06 17:15</div>
            <div class="timeline-body"><p>I'm closing this in favour of https://github.com/astral-sh/ruff/issues/18502, because I've tried to do a more comprehensive writeup in that issue of what's missing here, and I've tried to give some suggestions in that issue about how we might move forward</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @AlexWaygood on 2025-06-06 17:15</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/18919.html">astral-sh/ruff#18919</a> on 2025-06-25 08:59</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:34:53 UTC
    </footer>
</body>
</html>
