<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>`lint.per-file-ignores` option is ignored by native server in `ruff.toml` - astral-sh/ruff #14282</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>`lint.per-file-ignores` option is ignored by native server in `ruff.toml`</h1>

    <div class="meta">
        <span class="state state-closed">Closed</span>
        <a href="https://github.com/astral-sh/ruff/issues/14282">#14282</a>
        opened by <a href="https://github.com/SXHRYU">@SXHRYU</a>
        on 2024-11-11 14:45
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/SXHRYU">@SXHRYU</a> on 2024-11-11 14:45</div>
            <div class="timeline-body"><p>Basically it's the same issue as https://github.com/astral-sh/ruff/issues/11751 but the problem still occurs when using <code>ruff.toml</code> as config file.</p>
<p>jic: this happens in VS Code, when <code>ruff check</code>ing via console everything's okay.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">configuration</span> added by @AlexWaygood on 2024-11-11 17:43</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">server</span> added by @AlexWaygood on 2024-11-11 17:43</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">configuration</span> removed by @MichaReiser on 2024-11-12 08:25</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">needs-mre</span> added by @MichaReiser on 2024-11-12 08:25</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-11-12 08:27</div>
            <div class="timeline-body"><p>Could you share a small reproduction? How does the directory layout look like? What files do you open in VS code.</p>
<p>I'm asking because I just tried what you described and VS Code correctly shows or doesn't show diagnostic based on the <code>per-file-ignores</code> in the <code>ruff.toml</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/amoralesc">@amoralesc</a> on 2024-11-14 03:15</div>
            <div class="timeline-body"><p>@MichaReiser I'm experiencing the same problem. I might add that I'm using a custom location for my Ruff config file, setting it under <code>.config/.ruff.toml</code>. Also working on Dev Containers.</p>
<p>I want to ignore the pydocstyle linter on all files under <code>src/migrations/versions</code>. Here's my environment (simplified) and steps to reproduce:</p>
<p><strong>Versions</strong></p>
<ul>
<li><code>ruff</code>: 0.7.3</li>
<li><code>charliermarsh.ruff</code> extension: latest</li>
<li>VSCode: 1.95.2</li>
</ul>
<p><strong>Project structure:</strong></p>
<pre><code>.
├─ .config
│  └─ .ruff.toml
├─ .venv
└─ src
   └─ migrations
      └─ versions
         └─ 1e8f6175aeef_a.py # &lt;- file with errors
</code></pre>
<p><strong>VSCode settings:</strong></p>
<pre><code class="language-json">{
  &quot;python.defaultInterpreterPath&quot;: &quot;${workspaceFolder}/.venv/bin/python&quot;,
  &quot;[python]&quot;: {
    &quot;editor.defaultFormatter&quot;: &quot;charliermarsh.ruff&quot;,
    &quot;editor.formatOnSave&quot;: true,
    &quot;editor.codeActionsOnSave&quot;: {
      &quot;source.organizeImports&quot;: &quot;explicit&quot;
    }
  },
  &quot;ruff.importStrategy&quot;: &quot;fromEnvironment&quot;,
  &quot;ruff.interpreter&quot;: [&quot;${workspaceFolder}/.venv/bin/python&quot;],
  &quot;ruff.fixAll&quot;: true,
  &quot;ruff.organizeImports&quot;: true,
  &quot;ruff.configuration&quot;: &quot;${workspaceFolder}/.config/.ruff.toml&quot;,
}
</code></pre>
<p><strong>Ruff config file:</strong></p>
<pre><code class="language-toml">target-version = &quot;py312&quot;
line-length    = 80
indent-width   = 4

[lint]
select = [
  &quot;D&quot;
]

[lint.per-file-ignores]
&quot;**/versions/*.py&quot; = [
  &quot;D&quot;,
]

[lint.pydocstyle]
convention = &quot;numpy&quot;
</code></pre>
<p>The problematic file in question:</p>
<pre><code class="language-python">&quot;&quot;&quot;Test

Revision ID: 1e8f6175aeef
Revises:
Create Date: 2024-11-14 02:42:01.465193

&quot;&quot;&quot;

from collections.abc import Sequence

# revision identifiers, used by Alembic.
revision: str = &quot;1e8f6175aeef&quot;
down_revision: str | None = None
branch_labels: str | Sequence[str] | None = None
depends_on: str | Sequence[str] | None = None


def upgrade() -&gt; None:
    # ### commands auto generated by Alembic - please adjust! ###
    pass
    # ### end Alembic commands ###


def downgrade() -&gt; None:
    # ### commands auto generated by Alembic - please adjust! ###
    pass
    # ### end Alembic commands ###

</code></pre>
<p>When the file is on focus:</p>
<p><img src="https://github.com/user-attachments/assets/8a94be05-40ff-4e44-9122-61696602f116" alt="image" /></p>
<p>Running ruff check from the project root:</p>
<pre><code class="language-bash">ruff check --config .config/.ruff.toml .
</code></pre>
<pre><code>All checks passed!
</code></pre>
<p>For good measure, commenting out the <code>[lint.per-file-ignores]</code> section and running ruff again returns:</p>
<pre><code>src/migrations/versions/1e8f6175aeef_a.py:1:1: D400 First line should end with a period
  |
1 | / &quot;&quot;&quot;Test
2 | | 
3 | | Revision ID: 1e8f6175aeef
4 | | Revises:
5 | | Create Date: 2024-11-14 02:42:01.465193
6 | | 
7 | | &quot;&quot;&quot;
  | |___^ D400
8 |   
9 |   from collections.abc import Sequence
  |
  = help: Add period

src/migrations/versions/1e8f6175aeef_a.py:18:5: D103 Missing docstring in public function
   |
18 | def upgrade() -&gt; None:
   |     ^^^^^^^ D103
19 |     # ### commands auto generated by Alembic - please adjust! ###
20 |     pass
   |

src/migrations/versions/1e8f6175aeef_a.py:24:5: D103 Missing docstring in public function
   |
24 | def downgrade() -&gt; None:
   |     ^^^^^^^^^ D103
25 |     # ### commands auto generated by Alembic - please adjust! ###
26 |     pass
   |

Found 3 errors.
No fixes available (1 hidden fix can be enabled with the `--unsafe-fixes` option).
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/amoralesc">@amoralesc</a> on 2024-11-14 04:17</div>
            <div class="timeline-body"><p>Same behavior with <code>exclude = []</code> on the Ruff config file.</p>
<p>Temporary workaround: use <code>ruff.exclude</code> in the VSCode <code>settings.json</code>. From the <a href="https://docs.astral.sh/ruff/editors/settings/#exclude">docs</a>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-11-14 04:22</div>
            <div class="timeline-body"><p>@amoralesc Do you mind trying it outside the Dev Container? There have been a couple of issues when working inside a dev container and I want to find some time to look into those soon.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/amoralesc">@amoralesc</a> on 2024-11-14 04:53</div>
            <div class="timeline-body"><p>@dhruvmanila I can indeed reproduce this error outside of the dev container. Tested with <code>extend-exclude</code> and <code>[lint.per-file-ignores]</code>.</p>
<p>My local environment is WSL. Worth noting that VSCode through WSL is still a remote server.</p>
<p>@SXHRYU Can you confirm how does your environment look like?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-11-14 04:54</div>
            <div class="timeline-body"><p>Ok, thanks for confirming. Although I don't have a Windows machine I can try reproducing on a Mac.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-11-14 06:51</div>
            <div class="timeline-body"><p>@amoralesc I'm looking at this now but just want to point out a couple of things:</p>
<pre><code class="language-json">  &quot;ruff.interpreter&quot;: [&quot;./.venv/bin/python&quot;],
</code></pre>
<p>I don't think this will work (https://github.com/astral-sh/ruff-vscode/pull/553), you'll need to update it to:</p>
<pre><code class="language-json">  &quot;ruff.interpreter&quot;: [&quot;${workspaceFolder}/.venv/bin/python&quot;],
</code></pre>
<p>But, otherwise I can reproduce this on my end although I'm not sure why this is happening.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/amoralesc">@amoralesc</a> on 2024-11-14 15:30</div>
            <div class="timeline-body"><p>@dhruvmanila Yes, my bad there. I wanted to generalize the reproducible environment and totally forgot that dot access doesn't work in <code>ruff.interpreter</code>. I'm actually using <code>${containerWorkspaceFolder}</code> there as well as in <code>ruff.configuration</code>. I'm gonna update the original snippet.</p>
<p>I may also add that the behavior is rather strange. Let's call the the problematic file <code>file.py</code>, deeply nested at <code>/path/to/file.py</code>. If I exclude the file like this:</p>
<pre><code class="language-toml"># .config/.ruff.toml

# either like:
exclude = [&quot;**/file.py&quot;]
# or:
[lint.per-file-ignores]
&quot;**/file.py&quot; = [&quot;D&quot;]
</code></pre>
<p>That actually works correctly! This is not the ideal solution though, because I'd want to ignore everything under <code>path/to</code>. So when the pattern matching is changed to <code>./path/to/*.py</code>, <code>**/path/to/*.py</code> or <code>**/to/*.py</code>, it fails.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-11-14 15:33</div>
            <div class="timeline-body"><p>@dhruvmanila and I narrowed the problem down to that patterns in <code>.config/ruff.toml</code> are resolved relative to the configuration directory, which I think is surprising. So changing <code>per-file-ignores</code> to <code>../**/file.py</code> should work. We'll look into if it makes sense to change the behavior</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">needs-mre</span> removed by @MichaReiser on 2024-11-14 15:34</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/amoralesc">@amoralesc</a> on 2024-11-14 15:51</div>
            <div class="timeline-body"><p>I can confirm the fix on https://github.com/astral-sh/ruff/issues/14282#issuecomment-2476724202 works on my environment.</p>
<p>I can't comment on this being the intended behavior, but it is still different from calling ruff from the project's root with:</p>
<pre><code class="language-bash">ruff check --config .config/.ruff.toml
</code></pre>
<p>Thankfully, adding the <code>..</code> does work on both calls (VSCode extension and ruff).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @MichaReiser on 2024-11-14 15:51</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/14352.html">astral-sh/ruff#14352</a> on 2024-11-15 05:12</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-11-15 05:15</div>
            <div class="timeline-body"><p>@amoralesc I'd also recommend to use absolute path for <code>ruff.configuration</code> because this setting is applied for every workspaces that you open in VS Code. So, it could be that in a workspace there isn't a <code>.config/ruff.toml</code> file. Using absolute path is more useful in this context, we also support expanding tilde (<code>~</code>) here. I don't know your setup so I leave this up to you.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/amoralesc">@amoralesc</a> on 2024-11-15 07:27</div>
            <div class="timeline-body"><p>Since my environment is a Dev Container, I choose to use <code>${containerWorkspaceFolder}</code>. I can confirm this resolves to an absolute path to the config file inside the container in the extension logs.</p>
<p>Thanks for the heads up though!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @dhruvmanila on 2024-11-15 08:15</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:34:54 UTC
    </footer>
</body>
</html>
