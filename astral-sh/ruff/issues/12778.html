<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Unable to set lineLength from nvim lua config - astral-sh/ruff #12778</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Unable to set lineLength from nvim lua config</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/issues/12778">#12778</a>
        opened by <a href="https://github.com/SafetyMary">@SafetyMary</a>
        on 2024-08-09 10:01
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/SafetyMary">@SafetyMary</a> on 2024-08-09 10:01</div>
            <div class="timeline-body"><p>Not sure if I did this correctly but i couldnt set --line-length arg in my neovim config (setting it to 1 just for testing). I am using kickstart vim.</p>
<p>Inside my neovim/nvim-lspconfig
<img src="https://github.com/user-attachments/assets/d2a56d19-0d1b-48f2-ac07-e93e46de722b" alt="image" /></p>
<p>The formatting runs fine on &quot;:Format&quot; command but ignores my line length setting. The only way I could get it work is to run &quot;!ruff format --line-length 1&quot; manually.</p>
<p>Version:
ruff 0.5.7
NVIM v0.10.1</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-08-09 11:03</div>
            <div class="timeline-body"><p>What does the <code>:Format</code> command do? Is it something that you've defined in your own config or is it coming from an external plugin? If the latter, which plugin is it coming from?</p>
<p>The language server settings will only be accounted for when running the formatter via the server aka <code>vim.lsp.buf.format()</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">needs-info</span> added by @dhruvmanila on 2024-08-09 11:03</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/SafetyMary">@SafetyMary</a> on 2024-08-09 15:37</div>
            <div class="timeline-body"><p>I have set a nvim user command triggering the formater. Mostly copied from conform.nvim recipy.</p>
<pre><code class="language-lua">-- Add format command
vim.api.nvim_create_user_command('Format', function(args)
  local range = nil
  if args.count ~= -1 then
    local end_line = vim.api.nvim_buf_get_lines(0, args.line2 - 1, args.line2, true)[1]
    range = {
      start = { args.line1, 0 },
      ['end'] = { args.line2, end_line:len() },
    }
  end
  require('conform').format { async = true, lsp_format = 'fallback', range = range }
end, { range = true })
</code></pre>
<p>Below is my conform formatter set up, mostly copied from kickstart vim</p>
<pre><code class="language-lua">-- kickstart config
return {
  { -- Autoformat
    'stevearc/conform.nvim',
    event = { 'BufWritePre' },
    cmd = { 'ConformInfo' },
    keys = {
      {
        '&lt;leader&gt;f',
        function()
          require('conform').format { async = true, lsp_fallback = true }
        end,
        mode = '',
        desc = '[F]ormat buffer',
      },
    },
    opts = {
      notify_on_error = false,
      format_on_save = function(bufnr)
        -- Define default behaviour here (default disable autoformat)
        if (vim.g.disable_autoformat == nil) or (vim.b[bufnr].disable_autoformat == nil) then
          return
        end
        -- Disable autoformat with a global or buffer-local variable
        if vim.g.disable_autoformat or vim.b[bufnr].disable_autoformat then
          return
        end
        -- Disable &quot;format_on_save lsp_fallback&quot; for languages that don't
        -- have a well standardized coding style. You can add additional
        -- languages here or re-enable it for the disabled ones.
        local disable_filetypes = { c = true, cpp = true }
        return {
          timeout_ms = 500,
          lsp_fallback = not disable_filetypes[vim.bo[bufnr].filetype],
        }
      end,
      formatters_by_ft = {
        lua = { 'stylua' },
        python = { 'ruff_fix', 'ruff_organize_imports', 'ruff_format' },
        sql = { 'sqlfluff' },
        markdown = { 'prettier', 'markdown-toc', 'markdownlint-cli2' },
        -- Conform can also run multiple formatters sequentially
        -- python = { &quot;isort&quot;, &quot;black&quot; },
        --
        -- You can use 'stop_after_first' to run the first available formatter from the list
        -- javascript = { &quot;prettierd&quot;, &quot;prettier&quot;, stop_after_first = true },
      },
    },
  },
}

</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-08-09 17:35</div>
            <div class="timeline-body"><p>There's some context here: https://github.com/astral-sh/ruff/issues/12514#issuecomment-2252147682 (and following replies) but the gist is that <code>conform.nvim</code> (specifically the <code>ruff_organize_imports</code> and <code>ruff_format</code> values) uses the <code>ruff</code> binary to perform the actions. The <code>lineLength</code> setting is specific to the server, so it will only work if you run the formatting via the language server (<code>vim.lsp.buf.format()</code>).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-08-09 17:37</div>
            <div class="timeline-body"><p>Note that <code>conform.nvim</code> is a formatter plugin which can use various ways of running a specific formatter. It could use the executable or the language server although you can configure it to either always use the language server or prefer it first.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @dhruvmanila on 2024-08-09 17:37</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">needs-info</span> removed by @dhruvmanila on 2024-08-09 17:37</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">question</span> added by @dhruvmanila on 2024-08-09 17:37</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-08-10 05:24</div>
            <div class="timeline-body"><p>You can configure <code>conform.nvim</code> to run the formatting via the language server:</p>
<pre><code class="language-lua">require('conform').setup {
  formatters_by_ft = {
    python = { 'ruff_fix', 'ruff_organize_imports', lsp_format = 'first' },
  }
}
</code></pre>
<p>This way the server settings will be considered during formatting via the Ruff language server. You can verify whether <code>conform.nvim</code> is going to use Ruff LSP via <code>:ConformInfo</code> which should show:</p>
<pre><code>Formatters for this buffer:
LSP: ruff
ruff_fix ready (python) /Users/dhruv/.local/bin/ruff
ruff_organize_imports ready (python) /Users/dhruv/.local/bin/ruff
</code></pre>
<blockquote>
<p>[!NOTE]</p>
<p>The <code>ruff_fix</code> and <code>ruff_organize_imports</code> will still use the <code>ruff</code> binary and the server settings will not be considered for those runs</p>
</blockquote>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/12795.html">astral-sh/ruff#12795</a> on 2024-08-10 15:20</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/SafetyMary">@SafetyMary</a> on 2024-08-12 02:15</div>
            <div class="timeline-body"><p>Thanks for the help @dhruvmanila
I have tried using your suggested snipet but it seems the line length setting only works when calling</p>
<pre><code class="language-lua">require('conform').setup {
  formatters_by_ft = {
    python = { lsp_format = 'first' },
  }
}
</code></pre>
<p>*without ruff_fix and ruff_organize_imports</p>
<p>I tried to change the sequence but couldnt solve the issue. For now i couldnt find a way getting both &quot;line length&quot; and &quot;ruff_fix + ruff_ogranize_import&quot; to work together.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/SafetyMary">@SafetyMary</a> on 2024-08-12 02:48</div>
            <div class="timeline-body"><p>~~I have got organize imports working by setting &quot;organizeImports = true&quot; and removing &quot;ruff_organize_import&quot; from the list.~~</p>
<pre><code class="language-lua">-- in my lspconfig.lua
ruff = {
  init_options = {
    settings = {
      lineLength = 1,
      organizeImports = true,
    }
  }
},
</code></pre>
<pre><code class="language-lua">-- in my conform.lua
require('conform').setup {
  formatters_by_ft = {
    python = { lsp_format = 'first' },
  }
}
</code></pre>
<p>I still quite new to neovim/lua/ruff and not quite sure what ruff_fix does. Will check on the &quot;fixAll&quot; option in ruff config.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-08-12 03:53</div>
            <div class="timeline-body"><blockquote>
<p>I have got organize imports working by setting &quot;organizeImports = true&quot; and removing &quot;ruff_organize_import&quot; from the list.</p>
</blockquote>
<p>Huh, that's interesting. What do you mean by &quot;have got organize imports working&quot;? I'm asking because the default value for that setting <em>is</em> <code>true</code>.</p>
<p>As noted above, the <code>ruff_*</code> values in <code>conform.nvim</code> will use the <code>ruff</code> executable to perform the actions. For example, you can see that <code>ruff_format</code> just calls the <code>ruff format</code> command: https://github.com/stevearc/conform.nvim/blob/667102f26106709cddd2dff1f699610df5b94d7f/lua/conform/formatters/ruff_format.lua#L7-L14. This means that the <a href="https://docs.astral.sh/ruff/editors/settings/"><strong>server settings</strong></a> won't be considered there. Server settings are only considered when running the Ruff language server.</p>
<p><code>ruff_fix</code> basically calls the <code>ruff check --fix</code> command as seen in https://github.com/stevearc/conform.nvim/blob/667102f26106709cddd2dff1f699610df5b94d7f/lua/conform/formatters/ruff_fix.lua#L7-L17 which is auto-fixing the rules that are fixable.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/SafetyMary">@SafetyMary</a> on 2024-08-14 09:20</div>
            <div class="timeline-body"><p>Sorry my bad. Upon futher inspection, it seems ruff organize imports is not working despite explisitly setting organizeImports = true, lineLength setting works fine though. I have also tried added select = {'I'} but it still doesnt work</p>
<pre><code class="language-lua">        ruff = {
          init_options = {
            settings = {
              lineLength = 120,
              organizeImports = true,
              fixAll = true,
              lint = {
                select = { 'I' },
              },
            },
          },
        },
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/12806.html">astral-sh/ruff#12806</a> on 2024-08-14 09:38</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/SafetyMary">@SafetyMary</a> on 2024-08-15 02:59</div>
            <div class="timeline-body"><p>I have fixed the issue by falling back to using ruff CLI args as i could not get it working via language server.</p>
<pre><code class="language-lua">-- Add this line to conform.lua
 require('conform').formatters.ruff_format = { append_args = { '--line-length', '120' } }

-- python formaters in conform.lua
python = { 'ruff_fix', 'ruff_organize_imports', 'ruff_format' },

</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-08-16 03:56</div>
            <div class="timeline-body"><p>As mentioned before, all these formatter configuration (<code>ruff_fix</code>, <code>ruff_organize_imports</code>, <code>ruff_format</code>) uses the Ruff executable i.e., they basically call the <code>ruff</code> executable to do the job. To use the server settings, you'd need to perform all three actions by asking the language server instead.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">server</span> added by @dhruvmanila on 2025-01-07 05:17</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 01:30:14 UTC
    </footer>
</body>
</html>
