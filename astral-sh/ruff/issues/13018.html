<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UP031 does not detect cases where percent operator is used on an f-string - astral-sh/ruff #13018</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>UP031 does not detect cases where percent operator is used on an f-string</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/ruff/issues/13018">#13018</a>
        opened by <a href="https://github.com/richardxia">@richardxia</a>
        on 2024-08-20 22:18
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/richardxia">@richardxia</a></div>
            <div class="timeline-body"><!--
Thank you for taking the time to report an issue! We're glad to have you involved with Ruff.

If you're filing a bug report, please consider including the following information:

* List of keywords you searched for before creating this issue. Write them down here so that others can find this issue more easily and help provide feedback.
  e.g. "RUF001", "unused variable", "Jupyter notebook"
* A minimal code snippet that reproduces the bug.
* The command you invoked (e.g., `ruff /path/to/file.py --fix`), ideally including the `--isolated` flag.
* The current Ruff settings (any relevant sections from your `pyproject.toml`).
* The current Ruff version (`ruff --version`).
-->

<p>This is admittedly a bit of a weird case, but I saw it in the wild and was surprised that Ruff wasn't flagging it as a lint error. With the <code>UP</code> ruleset enabled, Ruff isn't detecting the case where the <code>%</code> formatting operator is used on an f-string. Here's an example:</p>
<pre><code class="language-python">def percent_formatting(x: str) -&gt; str:
    return &quot;%s&quot; % x


def percent_formatting_and_f_string(x: str, y: str) -&gt; str:
    return f&quot;{x} %s&quot; % y
</code></pre>
<p>Ruff will correctly flag the first function as having an issue, but the second one it silently ignores. I've created a playground link for this: https://play.ruff.rs/d0eec036-39bb-4db1-b55c-2dde7babaf7d</p>
<p>What I'd ideally expect is for Ruff to flag the second case as an issue and to suggest that the argument to the <code>%</code> be folded into the f-string, as <code>f&quot;{x} {y}&quot;</code>. Even if it can't suggest that specific fix, I think it would good to at least report that there is an error and that the author shouldn't be mixing formatting types like that.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">needs-triage</span> added by @MichaReiser on 2024-08-22 13:18</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">needs-triage</span> removed by @MichaReiser on 2024-11-26 06:57</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-11-26 06:57</div>
            <div class="timeline-body"><p>That makes sense. Thanks for reporting this</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @MichaReiser on 2024-11-26 06:57</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-11-27 10:53</div>
            <div class="timeline-body"><p>I don't think I would consider this as a bug because we need to expand the scope of the rule to cover f-strings as currently it only checks for string literals.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-11-27 11:52</div>
            <div class="timeline-body"><p>I'm not very opinionated whether it's a bug or not. My take here is that, as a user, I would find it surprising that UP031 doesn't flag f-strings. But I could also see an argument that this could be its own rule (although that's another case where I think we're leaning too much towards fine granular rules)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Avasam">@Avasam</a> on 2025-04-28 21:51</div>
            <div class="timeline-body"><p>Whether a different rule or an expansion of the existing one, I'm +1 on wanting this. There's an argument to be made that splitting this off into its own rule allows for more granularity for the users. (<code>UP031</code> is already very hard to add to existing projects)</p>
<p>Regarding autofixes, I think the same as current <code>UP031</code> autofixes rules apply? Where Ruff needs to know the exact number of params to pass to the string (whether it's a tuple, a literal tuple, a single item, ...)</p>
<p>In OP's <code>percent_formatting_and_f_string</code> example, if  <code>x = &quot;%s&quot;</code> then it would already be failing.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MeGaGiGaGon">@MeGaGiGaGon</a> on 2025-07-10 00:08</div>
            <div class="timeline-body"><p>One additional wrinkle with this is that f-strings are evaluated before the <code>%</code> formatting, so you could have a situation where an f-string replacement is inserted to add percent formats, ie</p>
<pre><code class="language-py">def example(insert, value):
    print(f&quot;{insert}&quot; % value)
example(&quot;%s&quot;, 1)
example(&quot;%s %s&quot;, (1, 2))
</code></pre>
<p>I'm not sure where you would run into this in normal code, but the fact it can happen makes it hard to say any f-string with a replacement isn't going to add/remove formats. This sounds to me like it's the same reason why <code>UP031</code> doesn't lint on complex expressions like concatenations, ie <code>(&quot;%s&quot; + x) % y</code> https://play.ruff.rs/af9fdd40-679d-4844-b68a-21edd5562689</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 16:50:56 UTC
    </footer>
</body>
</html>
