<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UP034 autofix makes generator code broken - astral-sh/ruff #3234</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>UP034 autofix makes generator code broken</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/issues/3234">#3234</a>
        opened by <a href="https://github.com/Olegt0rr">@Olegt0rr</a>
        on 2023-02-26 09:00
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Olegt0rr">@Olegt0rr</a></div>
            <div class="timeline-body">1. Let&#x27;s take an example:
Code:
<pre><code>the_first_one = next(
    (some_integer for some_integer in range(1000) if some_integer // 2 == 0)
)
</code></pre>
Result:
<pre><code>0
</code></pre>
<p>It works.</p>
2. Let&#x27;s make ruff check
Result:
<pre><code>UP034 [*] Avoid extraneous parentheses
COM812 [*] Trailing comma missing
</code></pre>
3. Let&#x27;s apply ruff check with the --fix option
Result code:
<pre><code>the_first_one = next(
    some_integer for some_integer in range(1000) if some_integer // 2 == 0,
)
</code></pre>
Run code result:
<pre><code>  File &quot;draft.py&quot;, line 2
    some_integer for some_integer in range(1000) if some_integer // 2 == 0,
    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
SyntaxError: Generator expression must be parenthesized
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-02-26 15:50</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-02-26 19:12</div>
            <div class="timeline-body"><p>I think this is a rare case in which applying two independent edits is causing a syntax error. It&#x27;s fine to add the trailing comma as long as the parentheses are present, and it&#x27;s fine to remove the parentheses as long as there&#x27;s no trailing comma, but adding the trailing comma <em>and</em> removing the parentheses is invalid.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/matthewlloyd">@matthewlloyd</a> on 2023-02-26 19:40</div>
            <div class="timeline-body"><p>I tried switching the order of the checks but that doesn&#x27;t help either. The second check doesn&#x27;t see the edits made by the first.</p>
<p>This does seem kind of important - as a user I would want autofixes to never break code. Since I thought about it a bit I&#x27;ll share some possible solutions, though some are obvious I guess:</p>
<ul>
<li>Define a list of groups of mutually incompatible autofixes, to e.g. always disable the UP034 autofix when the COM812 autofix is enabled (not just when it has actually been applied, to preserve idempotence across Ruff runs).</li>
<li>Divide the autofixable checks into passes (where each pass contains no mutually incompatible autofixes) and rerun the lexer in between each pass if autofixes have been applied.</li>
<li>Have autofixes mark tokens as being removed, then ignore those tokens in the checkers.</li>
<li>Have autofixes return a modified LexResult (or modify a mutable one) at the time the diagnostic is created.</li>
<li>Teach UP034 to ignore situations where COM812 would apply when it&#x27;s enabled, or vice versa.</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-02-26 19:49</div>
            <div class="timeline-body"><p>Without addressing the broader issue, one hack we&#x27;ve used in the past is to expand the range of the autofix in some way, such that the fixes have conflicting edit ranges. If the edit ranges conflict, we&#x27;ll only apply the first of the two fixes in the initial pass. Then, in the second pass, we wouldn&#x27;t raise the second violation at all (hopefully) and would thus avoid the fix.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/matthewlloyd">@matthewlloyd</a> on 2023-02-26 20:05</div>
            <div class="timeline-body"><p>Ah OK, nice - I didn&#x27;t see that the linter already runs multiple passes :). That&#x27;s easy then, and I have a working fix for this. Will submit a PR when I get back to my computer later today.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-02-26 20:06</div>
            <div class="timeline-body"><p>Yeah, I don&#x27;t consider it a &quot;good&quot; solution but it does work.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-02-27 03:47</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 18:48:33 UTC
    </footer>
</body>
</html>
