```yaml
number: 11029
title: "0.4.0: pytest fails with errors in 3 units"
type: issue
state: closed
author: wuch-g2v
labels:
  - needs-info
assignees: []
created_at: 2024-04-19T07:20:44Z
updated_at: 2024-04-19T14:05:17Z
url: https://github.com/astral-sh/ruff/issues/11029
synced_at: 2026-01-10T01:56:52Z
```

# 0.4.0: pytest fails with errors in 3 units

---

_Issue opened by @wuch-g2v on 2024-04-19 07:20_

Python 3.10.14 and pytest 8.1.1.
Looks like something is wrong with latest 0.4.0 because pytest fails
<details>
<summary>Here is pytest output:</summary>

```console
+ PYTHONPATH=/home/builder/rpmbuild/BUILDROOT/python-ruff-0.4.0-2.fc37.x86_64/usr/lib64/python3.10/site-packages:/home/builder/rpmbuild/BUILDROOT/python-ruff-0.4.0-2.fc37.x86_64/usr/lib/python3.10/site-packages
+ /usr/bin/pytest -ra -m 'not network' --exit-0-if-no-units
============================= test session starts ==============================
platform linux -- Python 3.10.14, pytest-8.1.1, pluggy-1.4.0
rootdir: /home/builder/rpmbuild/BUILD/ruff-0.4.0
configfile: pyproject.toml
collected 0 items / 3 errors

==================================== ERRORS ====================================
_ ERROR collecting crates/ruff_python_parser/resources/inline/err/assert_empty_test.py _
/usr/lib/python3.10/site-packages/_pytest/python.py:525: in importtestmodule
    mod = import_path(
/usr/lib/python3.10/site-packages/_pytest/pathlib.py:584: in import_path
    importlib.import_module(module_name)
/usr/lib64/python3.10/importlib/__init__.py:126: in import_module
    return _bootstrap._gcd_import(name[level:], package, level)
<frozen importlib._bootstrap>:1050: in _gcd_import
    ???
<frozen importlib._bootstrap>:1027: in _find_and_load
    ???
<frozen importlib._bootstrap>:1006: in _find_and_load_unlocked
    ???
<frozen importlib._bootstrap>:688: in _load_unlocked
    ???
/usr/lib/python3.10/site-packages/_pytest/assertion/rewrite.py:169: in exec_module
    source_stat, co = _rewrite_test(fn, self.config)
/usr/lib/python3.10/site-packages/_pytest/assertion/rewrite.py:351: in _rewrite_test
    tree = ast.parse(source, filename=strfn)
/usr/lib64/python3.10/ast.py:50: in parse
    return compile(source, filename, mode, flags,
E     File "/home/builder/rpmbuild/BUILD/ruff-0.4.0/crates/ruff_python_parser/resources/inline/err/assert_empty_test.py", line 1
E       assert
E             ^
E   SyntaxError: invalid syntax
_ ERROR collecting crates/ruff_python_parser/resources/inline/err/if_stmt_missing_test.py _
/usr/lib/python3.10/site-packages/_pytest/python.py:525: in importtestmodule
    mod = import_path(
/usr/lib/python3.10/site-packages/_pytest/pathlib.py:584: in import_path
    importlib.import_module(module_name)
/usr/lib64/python3.10/importlib/__init__.py:126: in import_module
    return _bootstrap._gcd_import(name[level:], package, level)
<frozen importlib._bootstrap>:1050: in _gcd_import
    ???
<frozen importlib._bootstrap>:1027: in _find_and_load
    ???
<frozen importlib._bootstrap>:1006: in _find_and_load_unlocked
    ???
<frozen importlib._bootstrap>:688: in _load_unlocked
    ???
/usr/lib/python3.10/site-packages/_pytest/assertion/rewrite.py:169: in exec_module
    source_stat, co = _rewrite_test(fn, self.config)
/usr/lib/python3.10/site-packages/_pytest/assertion/rewrite.py:351: in _rewrite_test
    tree = ast.parse(source, filename=strfn)
/usr/lib64/python3.10/ast.py:50: in parse
    return compile(source, filename, mode, flags,
E     File "/home/builder/rpmbuild/BUILD/ruff-0.4.0/crates/ruff_python_parser/resources/inline/err/if_stmt_missing_test.py", line 1
E       if : ...
E          ^
E   SyntaxError: invalid syntax
_ ERROR collecting crates/ruff_python_parser/resources/inline/err/while_stmt_missing_test.py _
/usr/lib/python3.10/site-packages/_pytest/python.py:525: in importtestmodule
    mod = import_path(
/usr/lib/python3.10/site-packages/_pytest/pathlib.py:584: in import_path
    importlib.import_module(module_name)
/usr/lib64/python3.10/importlib/__init__.py:126: in import_module
    return _bootstrap._gcd_import(name[level:], package, level)
<frozen importlib._bootstrap>:1050: in _gcd_import
    ???
<frozen importlib._bootstrap>:1027: in _find_and_load
    ???
<frozen importlib._bootstrap>:1006: in _find_and_load_unlocked
    ???
<frozen importlib._bootstrap>:688: in _load_unlocked
    ???
/usr/lib/python3.10/site-packages/_pytest/assertion/rewrite.py:169: in exec_module
    source_stat, co = _rewrite_test(fn, self.config)
/usr/lib/python3.10/site-packages/_pytest/assertion/rewrite.py:351: in _rewrite_test
    tree = ast.parse(source, filename=strfn)
/usr/lib64/python3.10/ast.py:50: in parse
    return compile(source, filename, mode, flags,
E     File "/home/builder/rpmbuild/BUILD/ruff-0.4.0/crates/ruff_python_parser/resources/inline/err/while_stmt_missing_test.py", line 1
E       while : ...
E             ^
E   SyntaxError: invalid syntax
=========================== short test summary info ============================
ERROR crates/ruff_python_parser/resources/inline/err/assert_empty_test.py
ERROR crates/ruff_python_parser/resources/inline/err/if_stmt_missing_test.py
ERROR crates/ruff_python_parser/resources/inline/err/while_stmt_missing_test.py
!!!!!!!!!!!!!!!!!!! Interrupted: 3 errors during collection !!!!!!!!!!!!!!!!!!!!
============================== 3 errors in 1.50s ===============================
```
</details>


---

_Label `needs-info` added by @MichaReiser on 2024-04-19 07:31_

---

_Comment by @MichaReiser on 2024-04-19 07:32_

hi @wuch-g2v 

It seems that pytest picks up our parser tests and some of those tests intentionally contain invalid syntax. 

Can you tell us more about what command you're running and how you installed ruff?

---

_Comment by @VascoSch92 on 2024-04-19 08:05_

Why are you using `pytest`?

Pytest is picking the three files

```text
ERROR crates/ruff_python_parser/resources/inline/err/assert_empty_test.py
ERROR crates/ruff_python_parser/resources/inline/err/if_stmt_missing_test.py
ERROR crates/ruff_python_parser/resources/inline/err/while_stmt_missing_test.py
```
because:
1. they are python script
2. there is the word `test` in the script name

Perhaps there is a little bit of confusion, `Ruff` is a `Rust` package which format/lint `Python` code. Therefore, it is written in `Rust` and you should use `Rust` tools to test it. I don't think there are Python tests in the package (or I'm wrong?). 

Or I'm misunderstanding your question? :-) 

---

_Comment by @charliermarsh on 2024-04-19 13:52_

üëç I think there's a small misunderstanding here. We don't run pytest in Ruff, but we do have some files checked-in that make it look like we use pytest, since we lint against pytest features.

---

_Closed by @charliermarsh on 2024-04-19 13:52_

---

_Comment by @wuch-g2v on 2024-04-19 14:01_

I'm using `installer` module.
Q: what it has to do it install pytest is failing on files test suite in source tree? ü§î 
Content of the .whl archive.
```console
Archive:  ruff-0.4.0-py3-none-linux_x86_64.whl
  Length      Date    Time    Name
---------  ---------- -----   ----
    24039  04-18-2024 20:43   ruff-0.4.0.dist-info/METADATA
       96  04-18-2024 20:43   ruff-0.4.0.dist-info/WHEEL
    68613  04-18-2024 20:43   ruff-0.4.0.dist-info/license_files/LICENSE
        0  04-18-2024 20:43   ruff/__init__.py
     1045  04-18-2024 20:43   ruff/__main__.py
 21206976  04-18-2024 20:43   ruff-0.4.0.data/scripts/ruff
      530  04-18-2024 20:44   ruff-0.4.0.dist-info/RECORD
---------                     -------
 21301299                     7 files
```



---

_Comment by @wuch-g2v on 2024-04-19 14:05_

BTW .. why in LICENSE file are included licenses of many other modules?
`ruff` is written from scratch in rust so it does not inherit any code from those modules.
Idea of performing exact filtering and AFAIK is is not licensedü§î

---
