<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Unexpected space in docstring near escaped quote - astral-sh/ruff #16640</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Unexpected space in docstring near escaped quote</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/issues/16640">#16640</a>
        opened by <a href="https://github.com/vincent0426">@vincent0426</a>
        on 2025-03-11 18:01
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/vincent0426">@vincent0426</a></div>
            <div class="timeline-body">Summary
Description
<p>Ruff formatter modifies the spacing in a string within a docstring when the string contains an escaped quote. Specifically, it adds an unwanted space between the escaped quote and the closing triple quotes of the docstring.</p>
Steps to Reproduce
<ol>
<li><p>Create a Python class with the following content:</p>
<pre><code>class Sample:
    &quot;&quot;&quot;Hello &quot;World\&quot;&quot;&quot;&quot;

    def __init__(self, name):
        self.name = name
</code></pre>
</li>
<li><p>Run <code>ruff format</code> on the file</p>
</li>
<li><p>Observe that the formatter modifies the docstring to:</p>
<pre><code>class Sample:
    &quot;&quot;&quot;Hello &quot;World\&quot; &quot;&quot;&quot;

    def __init__(self, name):
        self.name = name
</code></pre>
</li>
</ol>
Expected Behavior
<p>Docstring remain unchanged after formatting as its escaped already</p>
<p><code>&quot;&quot;&quot;Hello &quot;World\&quot;&quot;&quot;&quot;</code></p>
Version
<p>ruff 0.9.10 (0dfa810e9 2025-03-07)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">formatter</span> added by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-03-11 18:09</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-03-11 18:12</div>
            <div class="timeline-body"><p>Our formatting matches black&#x27;s and the extra space is required for non-escaped quotes at the end of a docstring. But this does seem to be unintentional in the escaped case and is, arguably, a bug because it changes the docstring.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-03-11 18:13</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/vincent0426">@vincent0426</a> on 2025-03-11 22:08</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a> on 2025-03-12 00:39</div>
            <div class="timeline-body"><p>@vincent0426 This seems to have been incorrectly closed. Was it?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Reopened by <a href="https://github.com/vincent0426">@vincent0426</a> on 2025-03-12 00:40</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/vincent0426">@vincent0426</a> on 2025-03-12 00:41</div>
            <div class="timeline-body"><p>@InSyncWithFoo ah yeah, I reopened it!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/maxmynter">@maxmynter</a> on 2025-04-04 22:26</div>
            <div class="timeline-body"><p>I think the culprit is around this function in <code>crates/ruff_python_formatter/src/string/docstring.rs:1599</code>ff.</p>
<pre><code>/// If the last line of the docstring is `content&quot; &quot;&quot;&quot;` or `content\ &quot;&quot;&quot;`, we need a chaperone space
/// that avoids `content&quot;&quot;&quot;&quot;` and `content\&quot;&quot;&quot;`. This does only applies to un-escaped backslashes,
/// so `content\\ &quot;&quot;&quot;` doesn&#x27;t need a space while `content\\\ &quot;&quot;&quot;` does.
pub(super) fn needs_chaperone_space(flags: AnyStringFlags, trim_end: &amp;str) -&gt; bool {
    if trim_end.chars().rev().take_while(|c| *c == &#x27;\\&#x27;).count() % 2 == 1 {
        true
    } else {
        flags.is_triple_quoted() &amp;&amp; trim_end.ends_with(flags.quote_style().as_char())
    }
}
</code></pre>
<p>I&#x27;ll tinker around to see if I can come up for a fix + tests.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-04-11 08:21</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 18:49:39 UTC
    </footer>
</body>
</html>
