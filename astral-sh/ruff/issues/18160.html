<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ruff re-orders Jupyter notebook file's (*.ipynb) JSON representation - astral-sh/ruff #18160</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>ruff re-orders Jupyter notebook file's (*.ipynb) JSON representation</h1>

    <div class="meta">
        <span class="state state-open">Open</span>
        <a href="https://github.com/astral-sh/ruff/issues/18160">#18160</a>
        opened by <a href="https://github.com/keen85">@keen85</a>
        on 2025-05-18 12:39
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/keen85">@keen85</a> on 2025-05-18 12:39</div>
            <div class="timeline-body"><h3>Summary</h3>
<h1>Background</h1>
<p>The content of Jupyter notebooks files (*.ipynb) are stored as JSON. Actual content of notebook's code cells are some levels down in the object tree (<code>$.cells[].source</code>).</p>
<h1>Situation / Problem</h1>
<p>I ran <code>ruff format some_notebook.ipynb</code>. I noticed that when ruff finds some code cells that need fixing, apart form the code cells, the whole JSON is reordered. To me it seems as if all keys are ordered <strong>alphabetically</strong>.
In general I like this Idea since it enforces a deterministic JSON representation.</p>
<p>However, I use Azure Synapse to create/edit Jupyter notebooks - and it seems that this &quot;editor&quot; has it's own preference when it comes to the order of the keys in the notebook's JSON representation.</p>
<p>So when using Azure Synapse and ruff, this will lead to a flip-flop behavior where the JSON is reordered constantly making the code diff harder to read.</p>
<h1>Minimal example</h1>
<h2><code>some_notebook.ipynb</code> before formatting</h2>
<pre><code class="language-json">{
    &quot;metadata&quot;: {
        &quot;kernelspec&quot;: {
            &quot;name&quot;: &quot;synapse_pyspark&quot;,
            &quot;display_name&quot;: &quot;python&quot;
        },
        &quot;language_info&quot;: {
            &quot;name&quot;: &quot;python&quot;
        }
    },
    &quot;cells&quot;: [
        {
            &quot;cell_type&quot;: &quot;code&quot;,
            &quot;metadata&quot;: {},
            &quot;outputs&quot;: [],
            &quot;source&quot;: [
                &quot;# this cell will be fixed by ruff\n&quot;,
                &quot;result = 1 +     15\n&quot;
            ],
            &quot;execution_count&quot;: null
        }
    ],
    &quot;nbformat_minor&quot;: 2,
    &quot;nbformat&quot;: 4
}
</code></pre>
<h2><code>some_notebook.ipynb</code> after formatting</h2>
<p>exemplary differences:</p>
<ul>
<li><code>cell</code> now comes before <code>metadata</code></li>
<li><code>nbformat_minor</code> and <code>nbformat_minor</code> have switched positions</li>
<li><code>execution_count</code> moved up</li>
</ul>
<pre><code class="language-json">{
    &quot;cells&quot;: [
        {
            &quot;cell_type&quot;: &quot;code&quot;,
            &quot;execution_count&quot;: null,
            &quot;metadata&quot;: {},
            &quot;outputs&quot;: [],
            &quot;source&quot;: [
                &quot;# this cell will be fixed by ruff\n&quot;,
                &quot;result = 1 + 15&quot;
            ]
        }
    ],
    &quot;metadata&quot;: {
        &quot;kernelspec&quot;: {
            &quot;display_name&quot;: &quot;python&quot;,
            &quot;name&quot;: &quot;synapse_pyspark&quot;
        },
        &quot;language_info&quot;: {
            &quot;name&quot;: &quot;python&quot;
        }
    },
    &quot;nbformat&quot;: 4,
    &quot;nbformat_minor&quot;: 2
}
</code></pre>
<p>Note: If ruff does not detect that at least one code cell requires fixing, no re-ordering is carried out and the original JSON order is left as-is.</p>
<h1>Feature request</h1>
<p>It would be great if there was some configuration that would let users decide if they want a <em>deterministic</em> ipynb file (and re-order it) or if ruff should only alter <code>$.cells[].source</code> elements within the ipynb and maintain the original order.</p>
<h3>Version</h3>
<p>ruff 0.11.10 (b35bf8ae0 2025-05-15)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/keen85">@keen85</a> on 2025-05-18 12:40</div>
            <div class="timeline-body"><p>likely related to https://github.com/astral-sh/ruff/issues/10380</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-05-18 16:06</div>
            <div class="timeline-body"><p>Yes, Ruff sorts the fields alphabetically. This was added in https://github.com/astral-sh/ruff/pull/5114 I do think it could make sense to try to preserve the field ordering. Although I'm not sure how hard that would be. @dhruvmanila do you remember why we use alphabetic sorting here?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">wish</span> added by @MichaReiser on 2025-05-18 16:06</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">notebook</span> added by @MichaReiser on 2025-05-18 16:06</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2025-05-18 16:59</div>
            <div class="timeline-body"><p>Yeah, IIRC this was because the <code>jupyter</code> command that one would use to open notebook / lab would also do the same and we wanted to avoid large diffs when auto-fixing. Clearly, that isn't the case for other clients. https://github.com/astral-sh/ruff/issues/8370 is related as well.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-08-11 14:28</div>
            <div class="timeline-body"><p>The easiest here might be to store <code>RawNotebookMetadata</code> or even the entire <code>RawNotebook</code> as a <code>serde_json::Value</code> and <code>RawNotebook</code>(<code>Metadata</code>) provides getters to pull individual fields.</p>
<p>The main challenge here is <code>cells</code> which we update. It might be worth taking a look at schemars, which is now also a thin wrapper around <code>Value</code> https://graham.cool/schemars/migrating/</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:34:55 UTC
    </footer>
</body>
</html>
