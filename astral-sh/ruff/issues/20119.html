<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Drop `pathdiff` dependency for GitLab output - astral-sh/ruff #20119</title>
    <link rel="stylesheet" href="../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../index.html">Back to index</a>
    </div>

    <h1>Drop `pathdiff` dependency for GitLab output</h1>

    <div class="meta">
        <span class="state state-open">Open</span>
        <a href="https://github.com/astral-sh/ruff/issues/20119">#20119</a>
        opened by <a href="https://github.com/ntBre">@ntBre</a>
        on 2025-08-27 20:46
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/ntBre">@ntBre</a> on 2025-08-27 20:46</div>
            <div class="timeline-body"><p>As noted in #20117, we only use <code>pathdiff</code> for one <code>relativize_path_to</code> call in our GitLab output format. This was added in #3475 to make the GitLab output relative to the <code>CI_PROJECT_DIR</code> environment variable. According to the <a href="https://docs.gitlab.com/ci/variables/predefined_variables/">docs</a>, this is a pre-defined variable with this description:</p>
<blockquote>
<p>The full path the repository is cloned to, and where the job runs from. If the GitLab Runner <code>builds_dir</code> parameter is set, this variable is set relative to the value of <code>builds_dir</code>. For more information, see the Advanced GitLab Runner configuration.</p>
</blockquote>
<p>In my simple test <a href="https://gitlab.com/nothanks3/test-gitlab-output-format/-/merge_requests/1">repo</a>, echoing <code>$CI_PROJECT_DIR</code> and <code>pwd</code> shows that the job starts out in this directory, as stated above:</p>
<pre><code>$ echo $CI_PROJECT_DIR
/builds/nothanks3/test-gitlab-output-format
$ pwd
/builds/nothanks3/test-gitlab-output-format
$ ruff --version
ruff 0.12.8
$ ruff check --output-format=gitlab &gt; code-quality-report.json
</code></pre>
<p>For basic usage like this, it seems fine then to drop <code>relativize_path_to</code> and <code>pathdiff</code> in favor of the fallback handling that makes the path relative to the CWD. In fact, this was the behavior before https://github.com/astral-sh/ruff/pull/1837, which made GitLab paths absolute. I'm just slightly concerned that this could break users with more adventurous directory changes in their CI jobs.</p>
<p>We could also use our own <code>relativize_path</code> function in <code>render.rs</code>, but the behavior seems to be a bit different from <a href="https://docs.rs/pathdiff/0.2.3/src/pathdiff/lib.rs.html#43-86"><code>pathdiff::diff_paths</code></a> if the base directory isn't a prefix of the path. <code>diff_paths</code> will add <code>..</code> components in this case.</p>
<p>This is the only function we use from <code>pathdiff</code>, so yet another option is vendoring just that.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">needs-decision</span> added by @ntBre on 2025-08-27 20:54</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../astral-sh/ty/issues/1242.html">astral-sh/ty#1242</a> on 2025-09-23 19:43</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:28:16 UTC
    </footer>
</body>
</html>
