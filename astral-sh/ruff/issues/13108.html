<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>`ruff rule` should include a property that indicates the fix is unsafe or not - astral-sh/ruff #13108</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1><code>ruff rule</code> should include a property that indicates the fix is unsafe or not</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/issues/13108">#13108</a>
        opened by <a href="https://github.com/zender-vivodyne">@zender-vivodyne</a>
        on 2024-08-26 12:50
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zender-vivodyne">@zender-vivodyne</a></div>
            <div class="timeline-body">

Usecase
<p>We have a legacy python project that we want to ease into using ruff and would like to start with just formatting and any linting that  can be automatically fixed. Using the <code>ruff rule --all --output-format json</code> we should be able to build a command that allows for that.</p>
<p>Command we are using to build the list (tested only on MacOS)</p>
<pre><code>ruff rule --all --output-format json | jq -r &#x27;.[] | select(.fix == &quot;Fix is always available.&quot; and .preview == false and .code ) | .code&#x27; | sort | paste -sd, - | sed &#x27;s/[^,]*/&quot;&amp;&quot;/g&#x27;
</code></pre>
<p>We can then just take this and put it into the <code>select</code> section of the config.</p>
<p>Since there is no flag it requires us to copy and paste the above, then run <code>ruff check --fix --statistics</code> and copy all the values that are reported after not being fixed into the <code>ignore</code> list.</p>
Current state
<p><code>ruff rule --all --output-format json</code></p>
<p>Example output:</p>
<pre><code>[
...
{
    &quot;name&quot;: &quot;verbose-raise&quot;,
    &quot;code&quot;: &quot;TRY201&quot;,
    &quot;linter&quot;: &quot;tryceratops&quot;,
    &quot;summary&quot;: &quot;Use `raise` without specifying exception name&quot;,
    &quot;message_formats&quot;: [
      &quot;Use `raise` without specifying exception name&quot;
    ],
    &quot;fix&quot;: &quot;Fix is always available.&quot;,
    &quot;explanation&quot;: &quot;## What it does\nChecks for needless exception names in `raise` statements.\n\n## Why is this bad?\nIt&#x27;s redundant to specify the exception name in a `raise` statement if the\nexception is being re-raised.\n\n## Example\n```python\ndef foo():\n    try:\n        ...\n    except ValueError as exc:\n        raise exc\n```\n\nUse instead:\n```python\ndef foo():\n    try:\n        ...\n    except ValueError:\n        raise\n```\n\n## Fix safety\nThis rule&#x27;s fix is marked as unsafe, as it doesn&#x27;t properly handle bound\nexceptions that are shadowed between the `except` and `raise` statements.\n&quot;,
    &quot;preview&quot;: false
  },
...
]
</code></pre>
<p><code>fix</code> will only be one of 3 values today. https://github.com/astral-sh/ruff/blob/f8f2e2a442aae2c1dfb4949e5ce99dc7a9d3e902/crates/ruff_diagnostics/src/violation.rs#L10-L18</p>
Possible options
<ul>
<li>Update the <code>fix</code> property to add some sort of indicator on if the fix will be unsafe or not.</li>
<li>Add a new property that indicates unsafe is <code>true</code> or <code>false</code>. Similar to how <code>preview</code> is done.</li>
<li>Maybe its a new flag on the cli that <code>--fixable</code> that can be used alongside or instead of <code>--all</code></li>
</ul>
Keywords
<p>unsafe fix rule property cli flag</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-08-26 13:17</div>
            <div class="timeline-body"><p>Thanks for providing all the details!</p>
<blockquote>
<p>We have a legacy python project that we want to ease into using ruff and would like to start with just formatting and any linting that can be automatically fixed. Using the <code>ruff rule --all --output-format json</code> we should be able to build a command that allows for that.</p>
<p>Command we are using to build the list (tested only on MacOS)</p>
<pre><code>ruff rule --all --output-format json | jq -r &#x27;.[] | select(.fix == &quot;Fix is always available.&quot; and .preview == false and .code ) | .code&#x27; | sort | paste -sd, - | sed &#x27;s/[^,]*/&quot;&amp;&quot;/g&#x27;
</code></pre>
<p>We can then just take this and put it into the <code>select</code> section of the config.</p>
</blockquote>
<p>I believe this can be achieved using the following command ðŸ˜…:</p>
<pre><code>ruff check --select=ALL --fix
</code></pre>
<p>Or, am I misunderstanding what you&#x27;re trying to achieve?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">question</span> added by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-08-26 13:17</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">great writeup</span> added by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-08-26 13:17</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zender-vivodyne">@zender-vivodyne</a> on 2024-08-26 14:58</div>
            <div class="timeline-body"><p>@dhruvmanila so running that presented me with the below output ðŸ˜“ which we want to get to 0 eventually and tune it to how we setup our other projects over time. So this command you provided i think will just fix all the things but what i want is for all the fixable rules to be configured and the exit status to be 0 and not spew into the console.</p>
<p>Little more details i that we plan on wiring this up via pre-commit and CI to check so that we can keep adding more rules slowly and fix things in chunks. The fixable list just gives us a workable base and some small wins in that it&#x27;ll just clean them all up for us. I know <code>--exit-zero</code> also exists but that doesn&#x27;t give us any confidence when we do add an unfixable rule in the future that we wont have regressions and have more code written that violate it.</p>
<pre><code>Found 17176 errors (226 fixed, 16950 remaining).
No fixes available (2684 hidden fixes can be enabled with the `--unsafe-fixes` option).

$ echo $?
1
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-08-30 09:10</div>
            <div class="timeline-body"><p>I see, thanks for providing the details. I think you already know this but not all rules provide a fix, and the <code>--fix</code> flag will apply the fix for all the selected rules that provides an autofix. You can learn more about fixes at https://docs.astral.sh/ruff/linter/#fixes.</p>
<p>Regardless, I don&#x27;t think this is possible as fix applicability depends on the generated fix itself and is <strong>dynamic</strong> in a way that it could be &quot;safe&quot; or &quot;unsafe&quot; to fix the <em>same</em> rule depending on the source code. And, the <code>ruff rule</code> command is meant to provide information about a rule irrespective of the source code. Does that make sense?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-09-09 12:01</div>
            <div class="timeline-body"><p>Yes, we can&#x27;t support this because the fix safety isn&#x27;t static metadata. It depends on case per case, and the only way to make it static metadata would be to offer fewer fixes, which I don&#x27;t think is a good outcome.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-09-09 12:01</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 18:48:57 UTC
    </footer>
</body>
</html>
