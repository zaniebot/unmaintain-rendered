<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formatter --preview add trailing comma - astral-sh/ruff #9029</title>
    <link rel="stylesheet" href="../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../index.html">Back to index</a>
    </div>

    <h1>Formatter --preview add trailing comma</h1>

    <div class="meta">
        <span class="state state-open">Open</span>
        <a href="https://github.com/astral-sh/ruff/issues/9029">#9029</a>
        opened by <a href="https://github.com/hoxbro">@hoxbro</a>
        on 2023-12-06 20:53
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/hoxbro">@hoxbro</a> on 2023-12-06 20:53</div>
            <div class="timeline-body"><!--
Thank you for taking the time to report an issue! We're glad to have you involved with Ruff.

If you're filing a bug report, please consider including the following information:

* A minimal code snippet that reproduces the bug.
* The command you invoked (e.g., `ruff /path/to/file.py --fix`), ideally including the `--isolated` flag.
* The current Ruff settings (any relevant sections from your `pyproject.toml`).
* The current Ruff version (`ruff --version`).
-->

<p>I have the following code:</p>
<pre><code class="language-python">self._edits.append(
    {&quot;operation&quot;: &quot;update&quot;, &quot;id&quot;: index, &quot;fields&quot;: list(fields), &quot;region_fields&quot;: []}
)
</code></pre>
<p>Which I run with <code>ruff format --preview</code> and gets</p>
<pre><code class="language-python">self._edits.append({
    &quot;operation&quot;: &quot;update&quot;,
    &quot;id&quot;: index,
    &quot;fields&quot;: list(fields),
    &quot;region_fields&quot;: [],
})
</code></pre>
<p>I would expect it to behave like this based on the new rule <code>hug_parens_with_braces_and_square_brackets</code></p>
<pre><code class="language-python">self._edits.append({
    &quot;operation&quot;: &quot;update&quot;, &quot;id&quot;: index, &quot;fields&quot;: list(fields), &quot;region_fields&quot;: []
})
</code></pre>
<p>Playground example: https://play.ruff.rs/6d3bf559-edf0-47f9-b1fd-1fc3418d7a46</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-12-06 20:53</div>
            <div class="timeline-body"><p>Black seems to leave this code unmodified in preview.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @charliermarsh on 2023-12-06 20:53</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">formatter</span> added by @charliermarsh on 2023-12-06 20:53</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-12-07 02:03</div>
            <div class="timeline-body"><blockquote>
<p>Black seems to leave this code unmodified in preview.</p>
</blockquote>
<p>Not entirely. Black hugs the parentheses, but formats all entries on a single line</p>
<pre><code class="language-python">self._edits.append({
    &quot;operation&quot;: &quot;update&quot;, &quot;id&quot;: index, &quot;fields&quot;: list(fields), &quot;region_fields&quot;: []
})
</code></pre>
<p>The fix here should be simple, similar to what we do in <code>FormatArgs</code>: Wrap the content (the entries) in a group. This gives us a two-staged formatting: Try to fit the entire dictionary on a line, try to fit the entries on a single line but break the <code>{</code>, <code>}</code>, and last, split each entry on a single line</p>
<pre><code class="language-dif">--- a/crates/ruff_python_formatter/src/expression/expr_dict.rs	(revision Staged)
+++ b/crates/ruff_python_formatter/src/expression/expr_dict.rs	(date 1701914528224)
@@ -60,7 +60,7 @@
             joiner.finish()
         });
 
-        parenthesized(&quot;{&quot;, &amp;format_pairs, &quot;}&quot;)
+        parenthesized(&quot;{&quot;, &amp;group(&amp;format_pairs), &quot;}&quot;)
             .with_dangling_comments(open_parenthesis_comments)
             .fmt(f)
     }
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-12-07 02:05</div>
            <div class="timeline-body"><p>I don't see that behavior in the playground (https://black.vercel.app/?version=main&amp;state=_Td6WFoAAATm1rRGAgAhARYAAAB0L-Wj4ADbAJNdAD2IimZxl1OAqkg9-7Mdp6WkAR2uY3jqi33CoVxaYgt_dqJQeRWYh2AUUVPYgfmUe5ec4ZcHkdVoq5sOpB1ReRTlQOrJGhEZF9IQqwqtTN2ew7VbGZJ7Tok5yApL_OQ8pjc2rk02ensMLtudWiG0va-XmA-ONGFqx6jYSP7KVMP-bLXSdrnjVEvSF7jcGNtsCCv5gAAASCWI0OPsLj4AAa8B3AEAAEAyP3uxxGf7AgAAAAAEWVo=):</p>
<img width="1792" alt="Screen Shot 2023-12-06 at 9 06 03 PM" src="https://github.com/astral-sh/ruff/assets/1309177/aff1ce50-9cbb-4561-ab8f-a3c22218c1c8">

<p>Maybe I'm doing something wrong.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-12-07 02:07</div>
            <div class="timeline-body"><p>It seems they changed this between Stable and Main. Stable gives you the formatting I shared. Main leaves it as is. I don't like the change. Makes it rather magic and doesn't save on vertical space.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone "Formatter: Stable" by @MichaReiser on 2023-12-22 06:16</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-02-12 11:22</div>
            <div class="timeline-body"><p>Note: The pattern where the &quot;huggable&quot; fully fits on its own line seems somewhat common in Airflow's codebase https://github.com/apache/airflow/pull/37355</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../apache/airflow/pulls/37355.html">apache/airflow#37355</a> on 2024-02-12 12:13</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-02-13 12:43</div>
            <div class="timeline-body"><p>Related black issue https://github.com/psf/black/issues/4099</p>
<p>There's the option to format this as:</p>
<pre><code class="language-python">self._edits.append(
    {&quot;operation&quot;: &quot;update&quot;, &quot;id&quot;: index, &quot;fields&quot;: list(fields), &quot;region_fields&quot;: []}
)
</code></pre>
<p>or</p>
<pre><code class="language-python">self._edits.append({
    &quot;operation&quot;: &quot;update&quot;, &quot;id&quot;: index, &quot;fields&quot;: list(fields), &quot;region_fields&quot;: []
})
</code></pre>
<p>The former probably requires the use of <code>best_fitting![expression.format(), block_indent(&amp;expression.format()), expression.format()]</code> where it should be sufficient to <code>group</code> the <code>pairs</code> for the second one.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-02-14 16:29</div>
            <div class="timeline-body"><p>I remove this from the stable formatter milestone because we decided not to ship the hugging preview style</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Removed from milestone "Formatter: Stable" by @MichaReiser on 2024-02-14 16:29</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">preview</span> added by @MichaReiser on 2024-02-14 16:29</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> removed by @MichaReiser on 2024-02-14 16:30</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">style</span> added by @MichaReiser on 2024-02-14 16:30</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:28:11 UTC
    </footer>
</body>
</html>
