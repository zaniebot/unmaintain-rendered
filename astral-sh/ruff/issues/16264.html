<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[red-knot] annotated assignments without RHS in stubs should still be bindings - astral-sh/ruff #16264</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[red-knot] annotated assignments without RHS in stubs should still be bindings</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/issues/16264">#16264</a>
        opened by <a href="https://github.com/carljm">@carljm</a>
        on 2025-02-19 20:30
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a></div>
            <div class="timeline-body"><h3>Description</h3>
<p>Otherwise, we get into trouble when a special form (say <code>Protocol</code>) is used within the global scope of the same stub file where it is defined, because that's just a local use, which only respects bindings.</p>
<p>This doesn't affect special forms that are used in annotation position (e.g. <code>ClassVar</code>) because all annotation expressions are lazy in stub files, meaning they use the public type.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by @carljm on 2025-02-19 20:30</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone "Red Knot Q1 2025" by @carljm on 2025-02-19 20:30</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-02-21 19:01</div>
            <div class="timeline-body"><p>We probably also want to do this generally in stubs, including in class body scopes, because people often omit right-hand-sides from annotated assignments in stubs, so we can't assume that <code>x: int</code> in a class body in a stub is an instance-only attribute.</p>
<p>Perhaps in an ideal world, the recommended approach in stubs would be to include class-level defaults (or at least <code>...</code> as RHS) so that type checkers can distinguish pure-instance variables from instance-or-class variables. But since this isn't the current practice, we probably need to adapt.</p>
<p>This cropped up as causing a false positive in tomllib, see https://github.com/astral-sh/ruff/pull/16036#discussion_r1966011718</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/mishamsk">@mishamsk</a> on 2025-02-21 19:37</div>
            <div class="timeline-body"><p>btw. in one of the early versions of #16036 I actually had logic that special cased stubs &amp; ABC's, but @sharkdp asked to remove it here https://github.com/astral-sh/ruff/pull/16036#discussion_r1950851155 - I have the code stashed, including the ABC wiring - so again, just saying, I'd be happy to re-wire the boundness/declaredness.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-02-21 20:23</div>
            <div class="timeline-body"><p>I think @sharkdp was right that we should handle <code>ClassVar</code> specially (which the PR now does). And I think we will probably want to implement the special case for stubs at a deeper layer, since it should impact both our interpretation of class vs instance attributes in class bodies, and also our interpretation of RHS-less annotated assignments at module level (as discussed in the OP here.)</p>
<p>By &quot;a deeper layer&quot; I mean that already when we create the initial Definitions in building the semantic index, we should always consider an annotated assignment in a stub with no RHS to be both a binding and a declaration, rather than just a declaration. And then in type inference we should record it as both a binding and a declaration of the annotated type. This reflects the fact that in general, in a stub file, <code>x: int</code> is used to imply <code>x: int = ...</code> where <code>...</code> is something of type <code>int</code>.</p>
<p>I think implementing this generalized approach will also help with resolution of the symbol boundness-vs-declaredness issue. There's a TODO comment in <code>symbol_by_id</code> that says this needs design work, and stubs might need to behave differently, but I think this issue captures the precise way in which stubs should behave differently -- if we special-case stubs in Definition creation in the way described above, we shouldn't need to special-case them in how we resolve symbols.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/mishamsk">@mishamsk</a> on 2025-02-21 21:24</div>
            <div class="timeline-body"><blockquote>
<p>By &quot;a deeper layer&quot; I mean that already when we create the initial Definitions in building the semantic index</p>
</blockquote>
<p>Oh, I'd love to implement this way. I haven't touched semantic index so far, so will be a great opportunity to take my relationship  with it to the next level!</p>
<blockquote>
<p>There's a TODO comment</p>
</blockquote>
<p>Yeah, I've seen that from the very beginning ;-)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/mishamsk">@mishamsk</a> on 2025-02-24 17:37</div>
            <div class="timeline-body"><p>Now that #16036 is merged, shall I take a stab at this one per @carljm suggested approach?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-02-24 17:38</div>
            <div class="timeline-body"><blockquote>
<p>Now that <a href="https://github.com/astral-sh/ruff/pull/16036">#16036</a> is merged, shall I take a stab at this one per <a href="https://github.com/carljm">@carljm</a> suggested approach?</p>
</blockquote>
<p>That would be great!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/mishamsk">@mishamsk</a> on 2025-02-26 03:05</div>
            <div class="timeline-body"><p>@carljm just FYI, as this is not formally assigned to me - I started working on this, but not ready for review yet. I can push a draft PR so it will be visible here, if this helps. Or just wait until it is ready for review</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @mishamsk by @carljm on 2025-02-26 03:25</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-02-26 03:26</div>
            <div class="timeline-body"><p>Now it's official! Feel free to push a draft PR whenever you want CI feedback.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @AlexWaygood on 2025-02-28 16:45</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 16:52:14 UTC
    </footer>
</body>
</html>
