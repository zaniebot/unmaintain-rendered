<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Autofix for UP032 swallows comment - astral-sh/ruff #6336</title>
    <link rel="stylesheet" href="../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../index.html">Back to index</a>
    </div>

    <h1>Autofix for UP032 swallows comment</h1>

    <div class="meta">
        <span class="state state-closed">Closed</span>
        <a href="https://github.com/astral-sh/ruff/issues/6336">#6336</a>
        opened by <a href="https://github.com/WhyNotHugo">@WhyNotHugo</a>
        on 2023-08-04 09:42
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/WhyNotHugo">@WhyNotHugo</a> on 2023-08-04 09:42</div>
            <div class="timeline-body"><p>Given this snippet:</p>
<pre><code class="language-py">        return &quot;data:image/{};base64,{}&quot;.format(
            ext[1:], data.decode()  # Remove the leading dot.
        )
</code></pre>
<p>Ruff autofix produces this output:</p>
<pre><code class="language-py">        return f&quot;data:image/{ext[1:]};base64,{data.decode()}&quot;
</code></pre>
<p>Note that the autofixed code &quot;swallows&quot; the comment. See here for original context: https://github.com/WhyNotHugo/django-afip/pull/186/commits/2974184b776bede851eba0632b80d915673dea81</p>
<p>This is reproducible with ruff 0.0.281. <a href="https://github.com/WhyNotHugo/django-afip/blob/2974184b776bede851eba0632b80d915673dea81/pyproject.toml">The relevant pyproject.toml is here</a>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../WhyNotHugo/django-afip/pulls/186.html">WhyNotHugo/django-afip#186</a> on 2023-08-04 09:48</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/harupy">@harupy</a> on 2023-08-04 12:32</div>
            <div class="timeline-body"><p>@charliermarsh Can I work on fixing this?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-08-04 13:29</div>
            <div class="timeline-body"><p>Sure. How are you thinking of resolving? What's the expected behavior here?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">autofix</span> added by @charliermarsh on 2023-08-04 13:29</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">needs-decision</span> added by @charliermarsh on 2023-08-04 13:29</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/harupy">@harupy</a> on 2023-08-04 13:31</div>
            <div class="timeline-body"><pre><code class="language-diff">diff --git a/crates/ruff/src/rules/pyupgrade/rules/f_strings.rs b/crates/ruff/src/rules/pyupgrade/rules/f_strings.rs
index 1739207cb..2dbf10061 100644
--- a/crates/ruff/src/rules/pyupgrade/rules/f_strings.rs
+++ b/crates/ruff/src/rules/pyupgrade/rules/f_strings.rs
@@ -320,7 +320,7 @@ pub(crate) fn f_strings(
         return;
     };
 
-    let Expr::Attribute(ast::ExprAttribute { value, .. }) = func.as_ref() else {
+    let Expr::Attribute(ast::ExprAttribute { value, attr, .. }) = func.as_ref() else {
         return;
     };
 
@@ -334,6 +334,25 @@ pub(crate) fn f_strings(
         return;
     };
 
+    // Exit if comments are present in the argument range:
+    // ```
+    // &quot;{} {}&quot;.format(
+    //   1,  # 1
+    //   2,  # 2
+    // )
+    // ```
+    if lexer::lex(
+        checker
+            .locator()
+            .slice(TextRange::new(attr.start(), expr.end())),
+        Mode::Expression,
+    )
+    .flatten()
+    .any(|(tok, _)| matches!(tok, Tok::Comment(..)))
+    {
+        return;
+    }
+
     let Some(mut summary) = FormatSummaryValues::try_from_expr(expr, checker.locator()) else {
         return;
     };
</code></pre>
<p>I think preserving comments is not easy. Can we avoid raising UP032 if comments are present in the argument range like this^?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/WhyNotHugo">@WhyNotHugo</a> on 2023-08-04 13:33</div>
            <div class="timeline-body"><blockquote>
<p>Can we avoid raising UP032 if comments are present in the argument range like this^?</p>
</blockquote>
<p>That's definitely one approach. Another possible approach is to raise the warning but skip it when auto-fixing.</p>
<p>I'll let you decide which one is best :)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-08-04 13:45</div>
            <div class="timeline-body"><p>Yeah I'd say raise-but-not-fix if there are comments within the call.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/harupy">@harupy</a> on 2023-08-04 13:47</div>
            <div class="timeline-body"><p>+1 to raise-but-not-fix.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/6342.html">astral-sh/ruff#6342</a> on 2023-08-04 14:08</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2023-08-04 15:37</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/WhyNotHugo">@WhyNotHugo</a> on 2023-08-04 15:50</div>
            <div class="timeline-body"><p>That was quick! Thanks</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/8107.html">astral-sh/ruff#8107</a> on 2023-10-30 02:54</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:28:10 UTC
    </footer>
</body>
</html>
