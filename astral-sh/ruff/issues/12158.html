<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ruff has some cache bug that causes crashes - astral-sh/ruff #12158</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>ruff has some cache bug that causes crashes</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/issues/12158">#12158</a>
        opened by <a href="https://github.com/hauntsaninja">@hauntsaninja</a>
        on 2024-07-03 00:15
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/hauntsaninja">@hauntsaninja</a></div>
            <div class="timeline-body"><p>Here&#x27;s a directory structure that repros:</p>
<pre><code>λ tree                        
.
└── dir
    ├── prefix
    │   ├── abc
    │   │   └── __init__.py
    │   └── pyproject.toml
    ├── prefixabc
    │   └── pyproject.toml
    └── pyproject.toml

5 directories, 4 files
</code></pre>
<p>Contents don&#x27;t matter.</p>
<p>If you run ruff twice, you&#x27;ll crash with:</p>
<pre><code>warning: Different package root in cache: expected &#x27;/Users/shantanu/tmp/ruffcrash/dir/prefixabc&#x27;, got &#x27;/Users/shantanu/tmp/ruffcrash/dir/prefix/abc&#x27;
error: Panicked while linting dir/prefixabc/pyproject.toml: This indicates a bug in Ruff. If you could open an issue at:

    https://github.com/astral-sh/ruff/issues/new?title=%5BLinter%20panic%5D

...with the relevant file contents, the `pyproject.toml` settings, and the following stack trace, we&#x27;d be very appreciative!

panicked at crates/ruff/src/diagnostics.rs:195:18:
wrong package cache for file
Backtrace:    0: std::backtrace::Backtrace::force_capture
   1: std::backtrace::Backtrace::force_capture
   2: &lt;ruff::panic::PanicError as core::fmt::Display&gt;::fmt
   3: std::panicking::rust_panic_with_hook
   4: &lt;std::panicking::begin_panic_handler::StaticStrPayload as core::panic::PanicPayload&gt;::take_box
   5: &lt;std::sys_common::backtrace::_print::DisplayBacktrace as core::fmt::Display&gt;::fmt
   6: _rust_begin_unwind
   7: core::panicking::panic_fmt
   8: &lt;core::panic::panic_info::PanicInfo as core::fmt::Display&gt;::fmt
   9: core::option::expect_failed
  10: &lt;ruff::diagnostics::FixMap as core::ops::arith::AddAssign&gt;::add_assign
  11: &lt;ruff::panic::PanicError as core::fmt::Display&gt;::fmt
  12: ruff::check
  13: &lt;ruff::version::VersionInfo as core::fmt::Display&gt;::fmt
  14: &lt;ruff::args::LogLevelArgs as clap_builder::derive::Args&gt;::augment_args
  15: &lt;ruff::panic::PanicError as core::fmt::Display&gt;::fmt
  16: &lt;ruff::args::LogLevelArgs as clap_builder::derive::Args&gt;::augment_args
  17: &lt;ruff::panic::PanicError as core::fmt::Display&gt;::fmt
  18: ruff::check
  19: rayon_core::registry::WorkerThread::wait_until_cold
  20: rayon_core::registry::ThreadBuilder::run
  21: &lt;rayon_core::unwind::AbortIfPanic as core::ops::drop::Drop&gt;::drop
  22: &lt;rayon_core::registry::WorkerThread as core::convert::From&lt;rayon_core::registry::ThreadBuilder&gt;&gt;::from
  23: std::sys::pal::unix::thread::Thread::new
  24: __pthread_start
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/hauntsaninja">@hauntsaninja</a> on 2024-07-03 00:17</div>
            <div class="timeline-body"><pre><code>mkdir dir
cd dir

mkdir prefixabc
touch prefixabc/pyproject.toml

mkdir prefix
touch prefix/pyproject.toml
mkdir prefix/abc
touch prefix/abc/__init__.py

cd ..
ruff check .
ruff check .
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">great writeup</span> added by <a href="https://github.com/zanieb">@zanieb</a> on 2024-07-03 00:19</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by <a href="https://github.com/zanieb">@zanieb</a> on 2024-07-03 00:19</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-07-03 00:24</div>
            <div class="timeline-body"><p>I&#x27;m very suspicious of our <code>CacheKey</code> implementation at</p>
<p>https://github.com/astral-sh/ruff/blob/f9214f95bb8fae17822981c95a9a8549035bace2/crates/ruff_cache/src/cache_key.rs#L350-L355</p>
<p>The standard library implementation we call appears to skip separators? https://doc.rust-lang.org/src/std/path.rs.html#3083-3085</p>
<p>Seems weird it&#x27;d treat these paths as the same when hashing though?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-07-03 00:27</div>
            <div class="timeline-body"><p>I successfully reproduced the panic (thank you so so much for the easy script) and resolved it with</p>
<pre><code>diff --git a/crates/ruff_cache/src/cache_key.rs b/crates/ruff_cache/src/cache_key.rs
index 1208c4010..710be29c6 100644
--- a/crates/ruff_cache/src/cache_key.rs
+++ b/crates/ruff_cache/src/cache_key.rs
@@ -350,7 +350,7 @@ impl&lt;K: CacheKey + Ord, V: CacheKey&gt; CacheKey for BTreeMap&lt;K, V&gt; {
 impl CacheKey for Path {
     #[inline]
     fn cache_key(&amp;self, state: &amp;mut CacheKeyHasher) {
-        self.hash(&amp;mut *state);
+        self.to_string_lossy().hash(&amp;mut *state);
     }
 }
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-07-03 00:33</div>
            <div class="timeline-body"><p>Ah yeesh and here&#x27;s a confirmation https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2021&amp;gist=467c0f7aedcfbfb484c9ca1ec65ff406</p>
<p>cc @BurntSushi is this.. intentional?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-07-03 06:25</div>
            <div class="timeline-body"><p>Uh that&#x27;s nasty, but technically the <code>Hash</code> implementation of rustc is correct because the only contract of <code>Hash</code> is</p>
<pre><code>k1 == k2 -&gt; hash(k1) == hash(k2)
</code></pre>
<p>This is fine in hash maps where the next step is to call <code>k1.eq(k2)</code>. IMO, rolling our own <code>CacheKey</code> implementation is the correct solution.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/zanieb">@zanieb</a> on 2024-07-03 12:36</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/zanieb">@zanieb</a> on 2024-07-03 12:36</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 18:48:55 UTC
    </footer>
</body>
</html>
