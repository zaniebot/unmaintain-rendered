<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Make `VendoredFileSystem` lazy - astral-sh/ruff #12219</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Make `VendoredFileSystem` lazy</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/issues/12219">#12219</a>
        opened by <a href="https://github.com/MichaReiser">@MichaReiser</a>
        on 2024-07-06 16:11
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-07-06 16:11</div>
            <div class="timeline-body"><p>The <code>VendoredFileSystem</code> reads the entire zip file when calling <code>new</code>. We should consider making the <code>VendoredFileSystem</code> lazy by using internal mutability with an inner <code>enum</code> that has two variants <code>Raw(Cow&lt;'static, [u8]&gt;)</code> and <code>Zip(ZipArchive)</code>. The <code>VendoredFileSystem::new</code> initializes with <code>Raw</code> and transitions to <code>Zip</code> when calling the first method.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by @MichaReiser on 2024-07-06 16:11</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-07-07 21:59</div>
            <div class="timeline-body"><p>Interesting. Do you think this is likely to buy us much? IIUC, we'd still have to read the whole zip as soon as a single method on the <code>VendoredFileSystem</code> instance is called, and that will be necessary as soon as we need to lookup information on a single builtin or standard-library type. I doubt there will be many Python programs that can be type-checked without resolving a single builtin or standard-library type.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-07-07 22:57</div>
            <div class="timeline-body"><p>I do like the idea though, this might open up some other possibilities</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @AlexWaygood by @AlexWaygood on 2024-07-07 22:57</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-07-08 07:57</div>
            <div class="timeline-body"><blockquote>
<p>Interesting. Do you think this is likely to buy us much</p>
</blockquote>
<p>I'm not so sure anymore. Your recommendation on https://github.com/astral-sh/ruff/pull/12214 to change <code>Program::vendored</code> to lazy load the vendored file system mitigates the concern for now. We may want to consider alternatives if returning a lazy version in <code>Program::vendored</code> isn't possible anymore (for whatever reason).</p>
<blockquote>
<p>I doubt there will be many Python programs that can be type-checked without resolving a single builtin or standard-library type.</p>
</blockquote>
<p>It is nice if we can avoid loading the zip e.g. when just formatting the files in a <code>Program</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @MichaReiser on 2024-07-08 07:57</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 01:30:13 UTC
    </footer>
</body>
</html>
