<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RUF045 on dataclass method assignment - astral-sh/ruff #16360</title>
    <link rel="stylesheet" href="../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../index.html">Back to index</a>
    </div>

    <h1>RUF045 on dataclass method assignment</h1>

    <div class="meta">
        <span class="state state-open">Open</span>
        <a href="https://github.com/astral-sh/ruff/issues/16360">#16360</a>
        opened by <a href="https://github.com/beskep">@beskep</a>
        on 2025-02-25 03:21
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/beskep">@beskep</a> on 2025-02-25 03:21</div>
            <div class="timeline-body"><h3>Description</h3>
<p>ruff version: 0.9.7
command: <code>ruff check test.py --select RUF --preview</code></p>
<pre><code class="language-python">import functools
from collections.abc import Callable
from dataclasses import dataclass


@dataclass
class Vector:
    x: float
    y: float

    def __call__(self) -&gt; None:
        print(self)

    # RUF045: Assignment without annotation found in dataclass body
    call = __call__

    call2: Callable[..., None] = __call__  # this makes new field

    def add(self, x: float, y: float):
        return Vector(x=self.x + x, y=self.y + y)

    # RUF045: Assignment without annotation found in dataclass body
    add_x = functools.partialmethod(add, y=0)
</code></pre>
<p>I am not sure if it's intended, but ruff check RUF045 for assigning a method of dataclass.</p>
<p>Is there a more appropriate way for typing new method, perhaps?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a> on 2025-02-25 07:55</div>
            <div class="timeline-body"><p>@dylwil3 This was a potential problem <a href="https://github.com/astral-sh/ruff/pull/14349#issuecomment-2477727417">I noticed</a>. What do you think, as the approver of that PR?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">rule</span> added by @dhruvmanila on 2025-02-25 10:14</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">needs-decision</span> added by @dhruvmanila on 2025-02-25 10:14</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">preview</span> added by @dhruvmanila on 2025-02-25 10:14</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dylwil3">@dylwil3</a> on 2025-02-25 12:04</div>
            <div class="timeline-body"><blockquote>
<p>Is there a more appropriate way for typing new method, perhaps?</p>
</blockquote>
<p>The suggestion in the documentation and &quot;help&quot; text of the rule is still correct: annotating the assignment with <code>ClassVar[Callable]</code> will give the behavior you're looking for.</p>
<blockquote>
<p>I am not sure if it's intended, but ruff check RUF045 for assigning a method of dataclass.</p>
</blockquote>
<blockquote>
<p>@dylwil3 This was a potential problem <a href="https://github.com/astral-sh/ruff/pull/14349#issuecomment-2477727417">I noticed</a>. What do you think, as the approver of that PR?</p>
</blockquote>
<p>Good questions!</p>
<p>I think the lint is correct to emit here: You can have dataclass fields that are typed as <code>Callable</code> and you can give them defaults; the help text of the diagnostic message is correct as given and the presence of the lint is consistent with the reasoning given in the documentation. I don't consider this a false positive and would argue in keeping this behavior even if we had stronger type inference around to avoid it.</p>
<p>In the discussion of the PR for this rule, I think there was some connection drawn to <a href="https://github.com/astral-sh/ruff/issues/5243">this issue around <code>RUF012</code></a> and the comment:</p>
<blockquote>
<p>This has the (maybe desirable, maybe not, but was surprising to me) effect of forcing typing for a RUF rule, in places where you would not necessarily use typing (if you did not want to).</p>
</blockquote>
<p>But I really don't think those complaints apply to <code>RUF045</code>: dataclasses <em>already</em> enforce the use of typing, and in fact the main concern raised in that thread was about extending the scope of the rule to include classes <em>other</em> than dataclasses.</p>
<p>All that being said: It seems like the situation is unclear enough that the current issue was submitted. So I'm happy to be convinced I'm wrong here, and to hear other points of view!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/beskep">@beskep</a> on 2025-02-26 00:32</div>
            <div class="timeline-body"><p><code>add_x: ClassVar = functools.partialmethod(add, y=0)</code> worked fine.
I had not thought of typing <code>ClassVar</code> for a function. How about adding this case to the example?</p>
<p>Or, perhaps, how about applying RUF045 only before <code>def</code> section?
It would increase false negatives though.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a> on 2025-02-26 07:13</div>
            <div class="timeline-body"><p>The semantics of such a bare <code>ClassVar</code> annotation is currently unclear. Recently, <a href="https://github.com/python/typing/pull/1931">a proposal</a> was made to address this. It hasn't been accepted yet, however.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/beskep">@beskep</a> on 2025-02-26 08:10</div>
            <div class="timeline-body"><p>I appreciate RUF045 (I forget to type dataclass fields time to time), but <code>ClassVar[Callable[..., None]]</code> and <code>ClassVar[partialmethod[Vector]]</code> seems a bit verbose and cumbersome to me.
I'd rather mark noqa for those lines.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">needs-decision</span> removed by @dylwil3 on 2025-03-10 10:07</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">question</span> added by @dylwil3 on 2025-03-10 10:07</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/CommentatorForAll">@CommentatorForAll</a> on 2025-06-16 17:54</div>
            <div class="timeline-body"><p>I do agree with OP here, from my understanding, partialmethod returns a function that requires <code>self</code>. Hence the assigned variable is a callable on the object not the class. Why does one need to annotate it as a classvar then?</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:28:15 UTC
    </footer>
</body>
</html>
