<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Server: Consider `root_uri`/`root_path` as a fallback to detect workspace root - astral-sh/ruff #19200</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Server: Consider <code>root_uri</code>/<code>root_path</code> as a fallback to detect workspace root</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/issues/19200">#19200</a>
        opened by <a href="https://github.com/lunik1">@lunik1</a>
        on 2025-07-08 09:36
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/lunik1">@lunik1</a></div>
            <div class="timeline-body">Summary
<p>When running the ruff LSP server via <code>ruff server</code> I am not seeing diagnostics I have enabled using a <code>pyproject.toml</code> in a subdirectory. I <em>do</em> see the correct diagnostics when running <code>ruff check</code> or the standalone <code>ruff-lsp</code>.</p>
<p>I have a mwe of this bug here: https://github.com/lunik1/ruff-server-bug-mwe</p>
<p>The top-level <code>pyproject.toml</code> contains a basic ruff configuration:</p>
<pre><code>[tool.ruff]
target-version = &quot;py311&quot;

[tool.ruff.lint]
</code></pre>
<p>which is then extended by <code>ruff-mwe/pyproject.toml</code> to enable the <code>RUF</code> linting rules</p>
<pre><code>[tool.ruff]
extend = &quot;../pyproject.toml&quot;

[tool.ruff.lint]
extend-select = [&quot;RUF&quot;]
</code></pre>
<p><code>main.py</code> contains some code that violates <code>F401</code> (a default rule) and <code>RUF005</code></p>
<pre><code>import math

def main():
    foo = [2, 3, 4]
    bar = [1] + foo + [5, 6]

    print(bar)
</code></pre>
<p>which is correctly detected by <code>ruff check</code></p>
<pre><code>ruff-mwe/main.py:1:8: F401 [*] `math` imported but unused
  |
1 | import math
  |        ^^^^ F401
2 |
3 | def main():
  |
  = help: Remove unused import: `math`

ruff-mwe/main.py:5:11: RUF005 Consider `[1, *foo, 5, 6]` instead of concatenation
  |
3 | def main():
4 |     foo = [2, 3, 4]
5 |     bar = [1] + foo + [5, 6]
  |           ^^^^^^^^^^^^^^^^^^ RUF005
6 |
7 |     print(bar)
  |
  = help: Replace with `[1, *foo, 5, 6]`

Found 2 errors.
[*] 1 fixable with the `--fix` option (1 hidden fix can be enabled with the `--unsafe-fixes` option).
</code></pre>
<p>however, only the <code>F401</code> is displayed in my editor (emacs + lsp-mode) using <code>ruff server</code></p>
<p><img alt="Image" src="https://github.com/user-attachments/assets/e7d75252-1059-4e18-a14d-146c1db814ec"></p>
<p>If I switch my server command to be <code>ruff-lsp</code>, I see both diagnostics:</p>
<p><img alt="Image" src="https://github.com/user-attachments/assets/1675258e-c82b-4e03-8664-68dbe5adc9e1"></p>
Version
<p>ruff 0.12.2 (9bee8376a 2025-07-03)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntBre">@ntBre</a> on 2025-07-08 19:56</div>
            <div class="timeline-body"><p>Thanks for the nice example!</p>
<p>I can reproduce this in Emacs, but I can&#x27;t reproduce it when opening the same workspace in VS Code. cc @dhruvmanila</p>
Emacs logs

<pre><code>2025-07-08 15:47:43.090006744  INFO No workspace(s) were provided during initialization. Using the current working directory as a default workspace: /tmp/ruff-server-bug-mwe-master
2025-07-08 15:47:43.090077074  INFO No workspace options found for file:///tmp/ruff-server-bug-mwe-master, using default options
2025-07-08 15:47:43.090082242 DEBUG Negotiated position encoding: UTF32
2025-07-08 15:47:43.090094464 DEBUG Indexing settings for workspace: /tmp/ruff-server-bug-mwe-master
2025-07-08 15:47:43.091025450 DEBUG Loaded settings from: `/tmp/ruff-server-bug-mwe-master/pyproject.toml`
2025-07-08 15:47:43.091172956  INFO Registering workspace: /tmp/ruff-server-bug-mwe-master
2025-07-08 15:47:43.091926684 DEBUG notification{method=&quot;textDocument/didOpen&quot;}: enter
2025-07-08 15:47:43.102397310 DEBUG request{id=2 method=&quot;textDocument/diagnostic&quot;}: enter
2025-07-08 15:47:43.102458351 DEBUG request{id=2 method=&quot;textDocument/diagnostic&quot;}: Included path via `include`: /tmp/ruff-server-bug-mwe-master/ruff-mwe/main.py
2025-07-08 15:47:43.115683383 DEBUG request{id=3 method=&quot;textDocument/codeAction&quot;}: enter
2025-07-08 15:47:43.120755267 DEBUG client_response{id=0 method=&quot;client/registerCapability&quot;}: enter
2025-07-08 15:47:43.120765394  INFO client_response{id=0 method=&quot;client/registerCapability&quot;}: Configuration file watcher successfully registered
2025-07-08 15:47:43.590841378 DEBUG request{id=4 method=&quot;textDocument/codeAction&quot;}: enter
</code></pre>


VS Code logs

<pre><code>2025-07-08 15:55:00.100977666 DEBUG Negotiated position encoding: UTF16
2025-07-08 15:55:00.101040593 DEBUG Indexing settings for workspace: /tmp/ruff-server-bug-mwe-master
2025-07-08 15:55:00.104332844 DEBUG Loaded settings from: `/tmp/ruff-server-bug-mwe-master/pyproject.toml` for `/tmp/ruff-server-bug-mwe-master`
2025-07-08 15:55:00.104847155 DEBUG Loaded settings from: `/tmp/ruff-server-bug-mwe-master/ruff-mwe/pyproject.toml` for `/tmp/ruff-server-bug-mwe-master/ruff-mwe`
2025-07-08 15:55:00.107996580  INFO Registering workspace: /tmp/ruff-server-bug-mwe-master
2025-07-08 15:55:00.108315266 DEBUG notification{method=&quot;textDocument/didOpen&quot;}: enter
2025-07-08 15:55:00.108422961 DEBUG request{id=1 method=&quot;textDocument/diagnostic&quot;}: enter
2025-07-08 15:55:00.108511101 DEBUG request{id=1 method=&quot;textDocument/diagnostic&quot;}: Included path via `include`: /tmp/ruff-server-bug-mwe-master/ruff-mwe/main.py
2025-07-08 15:55:00.109651819 DEBUG client_response{id=0 method=&quot;client/registerCapability&quot;}: enter
2025-07-08 15:55:00.109659921  INFO client_response{id=0 method=&quot;client/registerCapability&quot;}: Configuration file watcher successfully registered
</code></pre>


<p>It seems like ruff never reads the nested config file in Emacs for some reason.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">question</span> added by <a href="https://github.com/ntBre">@ntBre</a> on 2025-07-08 19:56</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntBre">@ntBre</a> on 2025-07-08 20:03</div>
            <div class="timeline-body"><p>I also can&#x27;t reproduce this with eglot, so I think this might be an issue with lsp-mode rather than Ruff.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/lunik1">@lunik1</a> on 2025-07-08 22:03</div>
            <div class="timeline-body"><p>Interesting, thanks for the repro and checking with VSCode. I&#x27;ll open a report in lsp-mode.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-07-09 07:01</div>
            <div class="timeline-body"><p>What I see from the logs is that Emacs loads the settings going through</p>
<p>https://github.com/astral-sh/ruff/blob/015222900f16ae3100b3415e1b6be44aed867e4b/crates/ruff_server/src/session/index/ruff_settings.rs#L197-L207</p>
<p>(It logs: &quot;Loaded settings from&quot; without the &quot;for&quot;)</p>
<p>And I suspect we early exit in</p>
<p>https://github.com/astral-sh/ruff/blob/015222900f16ae3100b3415e1b6be44aed867e4b/crates/ruff_server/src/session/index/ruff_settings.rs#L245-L254</p>
<p>VS code skips most of that code and loads the settings as part of:</p>
<p>https://github.com/astral-sh/ruff/blob/015222900f16ae3100b3415e1b6be44aed867e4b/crates/ruff_server/src/session/index/ruff_settings.rs#L321-L334</p>
<p>@dhruvmanila do you know if this is expected.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2025-07-09 08:39</div>
            <div class="timeline-body"><p>I think this is because lsp-mode isn&#x27;t providing the workspace folders to the server, so Ruff is using the current working directory as the default workspace. The default workspace means that the server is running in single-file mode and has different behavior w.r.t. indexing the settings (ref <a href="https://github.com/astral-sh/ruff/pull/13770">astral-sh/ruff#13770</a>).</p>
<pre><code>2025-07-08 15:47:43.090006744  INFO No workspace(s) were provided during initialization. Using the current working directory as a default workspace: /tmp/ruff-server-bug-mwe-master
2025-07-08 15:47:43.090077074  INFO No workspace options found for file:///tmp/ruff-server-bug-mwe-master, using default options
...
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2025-07-09 08:42</div>
            <div class="timeline-body"><p>@lunik1 / @ntBre Will you be able to provide the initialization options that the client sends to the server?</p>
<p>You could possibly do this and check the client logs which hopefully captures the stderr:</p>
<pre><code>diff --git a/crates/ruff_server/src/server.rs b/crates/ruff_server/src/server.rs
index 19e0d75a23..108199333a 100644
--- a/crates/ruff_server/src/server.rs
+++ b/crates/ruff_server/src/server.rs
@@ -56,6 +56,8 @@ impl Server {
     ) -&gt; crate::Result&lt;Self&gt; {
         let (id, init_params) = connection.initialize_start()?;
 
+        eprintln!(&quot;{init_params:#?}&quot;);
+
         let client_capabilities = init_params.capabilities;
         let position_encoding = Self::find_best_position_encoding(&amp;client_capabilities);
 
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntBre">@ntBre</a> on 2025-07-09 15:27</div>
            <div class="timeline-body">Emacs init params

<pre><code>InitializeParams {
    process_id: Some(
        96169,
    ),
    root_path: Some(
        &quot;/tmp/ruff-server-bug-mwe-master&quot;,
    ),
    root_uri: Some(
        Url {
            scheme: &quot;file&quot;,
            cannot_be_a_base: false,
            username: &quot;&quot;,
            password: None,
            host: None,
            port: None,
            path: &quot;/tmp/ruff-server-bug-mwe-master&quot;,
            query: None,
            fragment: None,
        },
    ),
    initialization_options: Some(
        Object {
            &quot;settings&quot;: Object {
                &quot;fixAll&quot;: Bool(true),
                &quot;importStrategy&quot;: String(&quot;fromEnvironment&quot;),
                &quot;logLevel&quot;: String(&quot;debug&quot;),
                &quot;organizeImports&quot;: Bool(true),
                &quot;showNotifications&quot;: String(&quot;off&quot;),
            },
        },
    ),
    capabilities: ClientCapabilities {
        workspace: Some(
            WorkspaceClientCapabilities {
                apply_edit: Some(
                    true,
                ),
                workspace_edit: Some(
                    WorkspaceEditClientCapabilities {
                        document_changes: Some(
                            true,
                        ),
                        resource_operations: Some(
                            [
                                Create,
                                Rename,
                                Delete,
                            ],
                        ),
                        failure_handling: None,
                        normalizes_line_endings: None,
                        change_annotation_support: None,
                    },
                ),
                did_change_configuration: None,
                did_change_watched_files: Some(
                    DidChangeWatchedFilesClientCapabilities {
                        dynamic_registration: Some(
                            true,
                        ),
                        relative_pattern_support: None,
                    },
                ),
                symbol: Some(
                    WorkspaceSymbolClientCapabilities {
                        dynamic_registration: None,
                        symbol_kind: Some(
                            SymbolKindCapability {
                                value_set: Some(
                                    [
                                        File,
                                        Module,
                                        Namespace,
                                        Package,
                                        Class,
                                        Method,
                                        Property,
                                        Field,
                                        Constructor,
                                        Enum,
                                        Interface,
                                        Function,
                                        Variable,
                                        Constant,
                                        String,
                                        Number,
                                        Boolean,
                                        Array,
                                        Object,
                                        Key,
                                        Null,
                                        EnumMember,
                                        Struct,
                                        Event,
                                        Operator,
                                        TypeParameter,
                                    ],
                                ),
                            },
                        ),
                        tag_support: None,
                        resolve_support: None,
                    },
                ),
                execute_command: Some(
                    DynamicRegistrationClientCapabilities {
                        dynamic_registration: Some(
                            false,
                        ),
                    },
                ),
                workspace_folders: Some(
                    true,
                ),
                configuration: Some(
                    true,
                ),
                semantic_tokens: None,
                code_lens: Some(
                    CodeLensWorkspaceClientCapabilities {
                        refresh_support: Some(
                            true,
                        ),
                    },
                ),
                file_operations: Some(
                    WorkspaceFileOperationsClientCapabilities {
                        dynamic_registration: None,
                        did_create: Some(
                            false,
                        ),
                        will_create: Some(
                            false,
                        ),
                        did_rename: Some(
                            true,
                        ),
                        will_rename: Some(
                            true,
                        ),
                        did_delete: Some(
                            false,
                        ),
                        will_delete: Some(
                            false,
                        ),
                    },
                ),
                inline_value: None,
                inlay_hint: None,
                diagnostics: Some(
                    DiagnosticWorkspaceClientCapabilities {
                        refresh_support: Some(
                            false,
                        ),
                    },
                ),
            },
        ),
        text_document: Some(
            TextDocumentClientCapabilities {
                synchronization: Some(
                    TextDocumentSyncClientCapabilities {
                        dynamic_registration: None,
                        will_save: Some(
                            true,
                        ),
                        will_save_wait_until: Some(
                            true,
                        ),
                        did_save: Some(
                            true,
                        ),
                    },
                ),
                completion: Some(
                    CompletionClientCapabilities {
                        dynamic_registration: Some(
                            true,
                        ),
                        completion_item: Some(
                            CompletionItemCapability {
                                snippet_support: Some(
                                    false,
                                ),
                                commit_characters_support: None,
                                documentation_format: Some(
                                    [
                                        Markdown,
                                        PlainText,
                                    ],
                                ),
                                deprecated_support: Some(
                                    true,
                                ),
                                preselect_support: None,
                                tag_support: None,
                                insert_replace_support: Some(
                                    true,
                                ),
                                resolve_support: Some(
                                    CompletionItemCapabilityResolveSupport {
                                        properties: [
                                            &quot;documentation&quot;,
                                            &quot;detail&quot;,
                                            &quot;additionalTextEdits&quot;,
                                            &quot;command&quot;,
                                        ],
                                    },
                                ),
                                insert_text_mode_support: Some(
                                    InsertTextModeSupport {
                                        value_set: [
                                            AsIs,
                                            AdjustIndentation,
                                        ],
                                    },
                                ),
                                label_details_support: Some(
                                    true,
                                ),
                            },
                        ),
                        completion_item_kind: None,
                        context_support: Some(
                            true,
                        ),
                        insert_text_mode: None,
                        completion_list: None,
                    },
                ),
                hover: Some(
                    HoverClientCapabilities {
                        dynamic_registration: Some(
                            true,
                        ),
                        content_format: Some(
                            [
                                Markdown,
                                PlainText,
                            ],
                        ),
                    },
                ),
                signature_help: Some(
                    SignatureHelpClientCapabilities {
                        dynamic_registration: Some(
                            true,
                        ),
                        signature_information: Some(
                            SignatureInformationSettings {
                                documentation_format: None,
                                parameter_information: Some(
                                    ParameterInformationSettings {
                                        label_offset_support: Some(
                                            true,
                                        ),
                                    },
                                ),
                                active_parameter_support: Some(
                                    true,
                                ),
                            },
                        ),
                        context_support: None,
                    },
                ),
                references: Some(
                    DynamicRegistrationClientCapabilities {
                        dynamic_registration: Some(
                            true,
                        ),
                    },
                ),
                document_highlight: None,
                document_symbol: Some(
                    DocumentSymbolClientCapabilities {
                        dynamic_registration: None,
                        symbol_kind: Some(
                            SymbolKindCapability {
                                value_set: Some(
                                    [
                                        File,
                                        Module,
                                        Namespace,
                                        Package,
                                        Class,
                                        Method,
                                        Property,
                                        Field,
                                        Constructor,
                                        Enum,
                                        Interface,
                                        Function,
                                        Variable,
                                        Constant,
                                        String,
                                        Number,
                                        Boolean,
                                        Array,
                                        Object,
                                        Key,
                                        Null,
                                        EnumMember,
                                        Struct,
                                        Event,
                                        Operator,
                                        TypeParameter,
                                    ],
                                ),
                            },
                        ),
                        hierarchical_document_symbol_support: Some(
                            true,
                        ),
                        tag_support: None,
                    },
                ),
                formatting: Some(
                    DynamicRegistrationClientCapabilities {
                        dynamic_registration: Some(
                            true,
                        ),
                    },
                ),
                range_formatting: Some(
                    DynamicRegistrationClientCapabilities {
                        dynamic_registration: Some(
                            true,
                        ),
                    },
                ),
                on_type_formatting: Some(
                    DynamicRegistrationClientCapabilities {
                        dynamic_registration: Some(
                            true,
                        ),
                    },
                ),
                declaration: Some(
                    GotoCapability {
                        dynamic_registration: Some(
                            true,
                        ),
                        link_support: Some(
                            true,
                        ),
                    },
                ),
                definition: Some(
                    GotoCapability {
                        dynamic_registration: Some(
                            true,
                        ),
                        link_support: Some(
                            true,
                        ),
                    },
                ),
                type_definition: Some(
                    GotoCapability {
                        dynamic_registration: Some(
                            true,
                        ),
                        link_support: Some(
                            true,
                        ),
                    },
                ),
                implementation: Some(
                    GotoCapability {
                        dynamic_registration: Some(
                            true,
                        ),
                        link_support: Some(
                            true,
                        ),
                    },
                ),
                code_action: Some(
                    CodeActionClientCapabilities {
                        dynamic_registration: Some(
                            true,
                        ),
                        code_action_literal_support: Some(
                            CodeActionLiteralSupport {
                                code_action_kind: CodeActionKindLiteralSupport {
                                    value_set: [
                                        &quot;&quot;,
                                        &quot;quickfix&quot;,
                                        &quot;refactor&quot;,
                                        &quot;refactor.extract&quot;,
                                        &quot;refactor.inline&quot;,
                                        &quot;refactor.rewrite&quot;,
                                        &quot;source&quot;,
                                        &quot;source.organizeImports&quot;,
                                    ],
                                },
                            },
                        ),
                        is_preferred_support: Some(
                            true,
                        ),
                        disabled_support: None,
                        data_support: Some(
                            true,
                        ),
                        resolve_support: Some(
                            CodeActionCapabilityResolveSupport {
                                properties: [
                                    &quot;edit&quot;,
                                    &quot;command&quot;,
                                ],
                            },
                        ),
                        honors_change_annotations: None,
                    },
                ),
                code_lens: None,
                document_link: Some(
                    DocumentLinkClientCapabilities {
                        dynamic_registration: Some(
                            true,
                        ),
                        tooltip_support: Some(
                            true,
                        ),
                    },
                ),
                color_provider: None,
                rename: Some(
                    RenameClientCapabilities {
                        dynamic_registration: Some(
                            true,
                        ),
                        prepare_support: Some(
                            true,
                        ),
                        prepare_support_default_behavior: None,
                        honors_change_annotations: None,
                    },
                ),
                publish_diagnostics: Some(
                    PublishDiagnosticsClientCapabilities {
                        related_information: Some(
                            true,
                        ),
                        tag_support: Some(
                            TagSupport {
                                value_set: [
                                    Unnecessary,
                                    Deprecated,
                                ],
                            },
                        ),
                        version_support: Some(
                            true,
                        ),
                        code_description_support: None,
                        data_support: None,
                    },
                ),
                folding_range: Some(
                    FoldingRangeClientCapabilities {
                        dynamic_registration: Some(
                            true,
                        ),
                        range_limit: None,
                        line_folding_only: None,
                        folding_range_kind: None,
                        folding_range: None,
                    },
                ),
                selection_range: Some(
                    SelectionRangeClientCapabilities {
                        dynamic_registration: Some(
                            true,
                        ),
                    },
                ),
                linked_editing_range: Some(
                    DynamicRegistrationClientCapabilities {
                        dynamic_registration: Some(
                            true,
                        ),
                    },
                ),
                call_hierarchy: Some(
                    DynamicRegistrationClientCapabilities {
                        dynamic_registration: Some(
                            false,
                        ),
                    },
                ),
                semantic_tokens: None,
                moniker: None,
                type_hierarchy: Some(
                    DynamicRegistrationClientCapabilities {
                        dynamic_registration: Some(
                            true,
                        ),
                    },
                ),
                inline_value: None,
                inlay_hint: None,
                diagnostic: Some(
                    DiagnosticClientCapabilities {
                        dynamic_registration: Some(
                            false,
                        ),
                        related_document_support: Some(
                            false,
                        ),
                    },
                ),
                inline_completion: None,
            },
        ),
        notebook_document: None,
        window: Some(
            WindowClientCapabilities {
                work_done_progress: Some(
                    true,
                ),
                show_message: None,
                show_document: Some(
                    ShowDocumentClientCapabilities {
                        support: true,
                    },
                ),
            },
        ),
        general: Some(
            GeneralClientCapabilities {
                regular_expressions: None,
                markdown: None,
                stale_request_support: None,
                position_encodings: Some(
                    [
                        PositionEncodingKind(
                            &quot;utf-32&quot;,
                        ),
                        PositionEncodingKind(
                            &quot;utf-16&quot;,
                        ),
                    ],
                ),
            },
        ),
        offset_encoding: None,
        experimental: None,
    },
    trace: None,
    workspace_folders: None,
    client_info: Some(
        ClientInfo {
            name: &quot;emacs&quot;,
            version: Some(
                &quot;GNU Emacs 31.0.50 (build 1, x86_64-pc-linux-gnu, cairo version 1.18.4)\n of 2025-06-29&quot;,
            ),
        },
    ),
    locale: None,
    work_done_progress_params: WorkDoneProgressParams {
        work_done_token: Some(
            String(
                &quot;1&quot;,
            ),
        ),
    },
}
2025-07-09 11:18:35.866223665  INFO No workspace(s) were provided during initialization. Using the current working directory as a default workspace: /tmp/ruff-server-bug-mwe-master
2025-07-09 11:18:35.866380739  INFO No workspace options found for file:///tmp/ruff-server-bug-mwe-master, using default options
2025-07-09 11:18:35.866395475 DEBUG Negotiated position encoding: UTF32
2025-07-09 11:18:35.866425996 DEBUG Indexing settings for workspace: /tmp/ruff-server-bug-mwe-master
2025-07-09 11:18:35.873467129 DEBUG Loaded settings from: `/tmp/ruff-server-bug-mwe-master/pyproject.toml`
2025-07-09 11:18:35.874970326  INFO Registering workspace: /tmp/ruff-server-bug-mwe-master
2025-07-09 11:18:35.876230615 DEBUG notification{method=&quot;textDocument/didOpen&quot;}: enter
2025-07-09 11:18:35.893975505 DEBUG request{id=2 method=&quot;textDocument/diagnostic&quot;}: enter
2025-07-09 11:18:35.894303830 DEBUG request{id=2 method=&quot;textDocument/diagnostic&quot;}: Included path via `include`: /tmp/ruff-server-bug-mwe-master/ruff-mwe/main.py
2025-07-09 11:18:35.906733997 DEBUG notification{method=&quot;$/cancelRequest&quot;}: enter
2025-07-09 11:18:35.906792664 DEBUG notification{method=&quot;$/cancelRequest&quot;}: Cancelled request id=3 method=textDocument/codeAction
2025-07-09 11:18:35.906858943 DEBUG request{id=3 method=&quot;textDocument/codeAction&quot;}: enter
2025-07-09 11:18:35.907035712 DEBUG request{id=4 method=&quot;textDocument/codeAction&quot;}: enter
2025-07-09 11:18:35.911939139 DEBUG client_response{id=0 method=&quot;client/registerCapability&quot;}: enter
2025-07-09 11:18:35.911967285  INFO client_response{id=0 method=&quot;client/registerCapability&quot;}: Configuration file watcher successfully registered
2025-07-09 11:18:35.920926473 DEBUG request{id=5 method=&quot;textDocument/codeAction&quot;}: enter
2025-07-09 11:18:50.708845760 DEBUG request{id=6 method=&quot;textDocument/codeAction&quot;}: enter
2025-07-09 11:18:50.708908268 DEBUG request{id=7 method=&quot;textDocument/hover&quot;}: enter
</code></pre>


VS Code init params

<pre><code>InitializeParams {
    process_id: Some(
        96649,
    ),
    root_path: Some(
        &quot;/tmp/ruff-server-bug-mwe-master&quot;,
    ),
    root_uri: Some(
        Url {
            scheme: &quot;file&quot;,
            cannot_be_a_base: false,
            username: &quot;&quot;,
            password: None,
            host: None,
            port: None,
            path: &quot;/tmp/ruff-server-bug-mwe-master&quot;,
            query: None,
            fragment: None,
        },
    ),
    initialization_options: Some(
        Object {
            &quot;globalSettings&quot;: Object {
                &quot;codeAction&quot;: Object {
                    &quot;disableRuleComment&quot;: Object {
                        &quot;enable&quot;: Bool(true),
                    },
                    &quot;fixViolation&quot;: Object {
                        &quot;enable&quot;: Bool(true),
                    },
                },
                &quot;configuration&quot;: Null,
                &quot;configurationPreference&quot;: String(&quot;editorFirst&quot;),
                &quot;cwd&quot;: String(&quot;/tmp/ruff-server-bug-mwe-master&quot;),
                &quot;enable&quot;: Bool(true),
                &quot;fixAll&quot;: Bool(true),
                &quot;format&quot;: Object {
                    &quot;args&quot;: Array [],
                },
                &quot;ignoreStandardLibrary&quot;: Bool(true),
                &quot;importStrategy&quot;: String(&quot;fromEnvironment&quot;),
                &quot;interpreter&quot;: Array [],
                &quot;lint&quot;: Object {
                    &quot;args&quot;: Array [],
                    &quot;enable&quot;: Bool(true),
                    &quot;run&quot;: String(&quot;onType&quot;),
                },
                &quot;logLevel&quot;: String(&quot;debug&quot;),
                &quot;nativeServer&quot;: String(&quot;on&quot;),
                &quot;organizeImports&quot;: Bool(true),
                &quot;path&quot;: Array [
                    String(&quot;/home/brent/astral/ruff/target/debug/ruff&quot;),
                ],
                &quot;showNotifications&quot;: String(&quot;off&quot;),
                &quot;showSyntaxErrors&quot;: Bool(true),
                &quot;workspace&quot;: String(&quot;/tmp/ruff-server-bug-mwe-master&quot;),
            },
            &quot;settings&quot;: Array [
                Object {
                    &quot;codeAction&quot;: Object {
                        &quot;disableRuleComment&quot;: Object {
                            &quot;enable&quot;: Bool(true),
                        },
                        &quot;fixViolation&quot;: Object {
                            &quot;enable&quot;: Bool(true),
                        },
                    },
                    &quot;configuration&quot;: Null,
                    &quot;configurationPreference&quot;: String(&quot;editorFirst&quot;),
                    &quot;cwd&quot;: String(&quot;/tmp/ruff-server-bug-mwe-master&quot;),
                    &quot;enable&quot;: Bool(true),
                    &quot;exclude&quot;: Null,
                    &quot;fixAll&quot;: Bool(true),
                    &quot;format&quot;: Object {
                        &quot;args&quot;: Array [],
                        &quot;preview&quot;: Null,
                    },
                    &quot;ignoreStandardLibrary&quot;: Bool(true),
                    &quot;importStrategy&quot;: String(&quot;fromEnvironment&quot;),
                    &quot;interpreter&quot;: Array [
                        String(&quot;/bin/python&quot;),
                    ],
                    &quot;lineLength&quot;: Null,
                    &quot;lint&quot;: Object {
                        &quot;args&quot;: Array [],
                        &quot;enable&quot;: Bool(true),
                        &quot;extendSelect&quot;: Null,
                        &quot;ignore&quot;: Null,
                        &quot;preview&quot;: Null,
                        &quot;run&quot;: String(&quot;onType&quot;),
                        &quot;select&quot;: Null,
                    },
                    &quot;logFile&quot;: Null,
                    &quot;logLevel&quot;: String(&quot;debug&quot;),
                    &quot;nativeServer&quot;: String(&quot;on&quot;),
                    &quot;organizeImports&quot;: Bool(true),
                    &quot;path&quot;: Array [
                        String(&quot;/home/brent/astral/ruff/target/debug/ruff&quot;),
                    ],
                    &quot;showNotifications&quot;: String(&quot;off&quot;),
                    &quot;showSyntaxErrors&quot;: Bool(true),
                    &quot;workspace&quot;: String(&quot;file:///tmp/ruff-server-bug-mwe-master&quot;),
                },
            ],
        },
    ),
    capabilities: ClientCapabilities {
        workspace: Some(
            WorkspaceClientCapabilities {
                apply_edit: Some(
                    true,
                ),
                workspace_edit: Some(
                    WorkspaceEditClientCapabilities {
                        document_changes: Some(
                            true,
                        ),
                        resource_operations: Some(
                            [
                                Create,
                                Rename,
                                Delete,
                            ],
                        ),
                        failure_handling: Some(
                            TextOnlyTransactional,
                        ),
                        normalizes_line_endings: Some(
                            true,
                        ),
                        change_annotation_support: Some(
                            ChangeAnnotationWorkspaceEditClientCapabilities {
                                groups_on_label: Some(
                                    true,
                                ),
                            },
                        ),
                    },
                ),
                did_change_configuration: Some(
                    DynamicRegistrationClientCapabilities {
                        dynamic_registration: Some(
                            true,
                        ),
                    },
                ),
                did_change_watched_files: Some(
                    DidChangeWatchedFilesClientCapabilities {
                        dynamic_registration: Some(
                            true,
                        ),
                        relative_pattern_support: Some(
                            true,
                        ),
                    },
                ),
                symbol: Some(
                    WorkspaceSymbolClientCapabilities {
                        dynamic_registration: Some(
                            true,
                        ),
                        symbol_kind: Some(
                            SymbolKindCapability {
                                value_set: Some(
                                    [
                                        File,
                                        Module,
                                        Namespace,
                                        Package,
                                        Class,
                                        Method,
                                        Property,
                                        Field,
                                        Constructor,
                                        Enum,
                                        Interface,
                                        Function,
                                        Variable,
                                        Constant,
                                        String,
                                        Number,
                                        Boolean,
                                        Array,
                                        Object,
                                        Key,
                                        Null,
                                        EnumMember,
                                        Struct,
                                        Event,
                                        Operator,
                                        TypeParameter,
                                    ],
                                ),
                            },
                        ),
                        tag_support: Some(
                            TagSupport {
                                value_set: [
                                    Deprecated,
                                ],
                            },
                        ),
                        resolve_support: Some(
                            WorkspaceSymbolResolveSupportCapability {
                                properties: [
                                    &quot;location.range&quot;,
                                ],
                            },
                        ),
                    },
                ),
                execute_command: Some(
                    DynamicRegistrationClientCapabilities {
                        dynamic_registration: Some(
                            true,
                        ),
                    },
                ),
                workspace_folders: Some(
                    true,
                ),
                configuration: Some(
                    true,
                ),
                semantic_tokens: Some(
                    SemanticTokensWorkspaceClientCapabilities {
                        refresh_support: Some(
                            true,
                        ),
                    },
                ),
                code_lens: Some(
                    CodeLensWorkspaceClientCapabilities {
                        refresh_support: Some(
                            true,
                        ),
                    },
                ),
                file_operations: Some(
                    WorkspaceFileOperationsClientCapabilities {
                        dynamic_registration: Some(
                            true,
                        ),
                        did_create: Some(
                            true,
                        ),
                        will_create: Some(
                            true,
                        ),
                        did_rename: Some(
                            true,
                        ),
                        will_rename: Some(
                            true,
                        ),
                        did_delete: Some(
                            true,
                        ),
                        will_delete: Some(
                            true,
                        ),
                    },
                ),
                inline_value: Some(
                    InlineValueWorkspaceClientCapabilities {
                        refresh_support: Some(
                            true,
                        ),
                    },
                ),
                inlay_hint: Some(
                    InlayHintWorkspaceClientCapabilities {
                        refresh_support: Some(
                            true,
                        ),
                    },
                ),
                diagnostics: Some(
                    DiagnosticWorkspaceClientCapabilities {
                        refresh_support: Some(
                            true,
                        ),
                    },
                ),
            },
        ),
        text_document: Some(
            TextDocumentClientCapabilities {
                synchronization: Some(
                    TextDocumentSyncClientCapabilities {
                        dynamic_registration: Some(
                            true,
                        ),
                        will_save: Some(
                            true,
                        ),
                        will_save_wait_until: Some(
                            true,
                        ),
                        did_save: Some(
                            true,
                        ),
                    },
                ),
                completion: Some(
                    CompletionClientCapabilities {
                        dynamic_registration: Some(
                            true,
                        ),
                        completion_item: Some(
                            CompletionItemCapability {
                                snippet_support: Some(
                                    true,
                                ),
                                commit_characters_support: Some(
                                    true,
                                ),
                                documentation_format: Some(
                                    [
                                        Markdown,
                                        PlainText,
                                    ],
                                ),
                                deprecated_support: Some(
                                    true,
                                ),
                                preselect_support: Some(
                                    true,
                                ),
                                tag_support: Some(
                                    TagSupport {
                                        value_set: [
                                            Deprecated,
                                        ],
                                    },
                                ),
                                insert_replace_support: Some(
                                    true,
                                ),
                                resolve_support: Some(
                                    CompletionItemCapabilityResolveSupport {
                                        properties: [
                                            &quot;documentation&quot;,
                                            &quot;detail&quot;,
                                            &quot;additionalTextEdits&quot;,
                                        ],
                                    },
                                ),
                                insert_text_mode_support: Some(
                                    InsertTextModeSupport {
                                        value_set: [
                                            AsIs,
                                            AdjustIndentation,
                                        ],
                                    },
                                ),
                                label_details_support: Some(
                                    true,
                                ),
                            },
                        ),
                        completion_item_kind: Some(
                            CompletionItemKindCapability {
                                value_set: Some(
                                    [
                                        Text,
                                        Method,
                                        Function,
                                        Constructor,
                                        Field,
                                        Variable,
                                        Class,
                                        Interface,
                                        Module,
                                        Property,
                                        Unit,
                                        Value,
                                        Enum,
                                        Keyword,
                                        Snippet,
                                        Color,
                                        File,
                                        Reference,
                                        Folder,
                                        EnumMember,
                                        Constant,
                                        Struct,
                                        Event,
                                        Operator,
                                        TypeParameter,
                                    ],
                                ),
                            },
                        ),
                        context_support: Some(
                            true,
                        ),
                        insert_text_mode: Some(
                            AdjustIndentation,
                        ),
                        completion_list: Some(
                            CompletionListCapability {
                                item_defaults: Some(
                                    [
                                        &quot;commitCharacters&quot;,
                                        &quot;editRange&quot;,
                                        &quot;insertTextFormat&quot;,
                                        &quot;insertTextMode&quot;,
                                        &quot;data&quot;,
                                    ],
                                ),
                            },
                        ),
                    },
                ),
                hover: Some(
                    HoverClientCapabilities {
                        dynamic_registration: Some(
                            true,
                        ),
                        content_format: Some(
                            [
                                Markdown,
                                PlainText,
                            ],
                        ),
                    },
                ),
                signature_help: Some(
                    SignatureHelpClientCapabilities {
                        dynamic_registration: Some(
                            true,
                        ),
                        signature_information: Some(
                            SignatureInformationSettings {
                                documentation_format: Some(
                                    [
                                        Markdown,
                                        PlainText,
                                    ],
                                ),
                                parameter_information: Some(
                                    ParameterInformationSettings {
                                        label_offset_support: Some(
                                            true,
                                        ),
                                    },
                                ),
                                active_parameter_support: Some(
                                    true,
                                ),
                            },
                        ),
                        context_support: Some(
                            true,
                        ),
                    },
                ),
                references: Some(
                    DynamicRegistrationClientCapabilities {
                        dynamic_registration: Some(
                            true,
                        ),
                    },
                ),
                document_highlight: Some(
                    DynamicRegistrationClientCapabilities {
                        dynamic_registration: Some(
                            true,
                        ),
                    },
                ),
                document_symbol: Some(
                    DocumentSymbolClientCapabilities {
                        dynamic_registration: Some(
                            true,
                        ),
                        symbol_kind: Some(
                            SymbolKindCapability {
                                value_set: Some(
                                    [
                                        File,
                                        Module,
                                        Namespace,
                                        Package,
                                        Class,
                                        Method,
                                        Property,
                                        Field,
                                        Constructor,
                                        Enum,
                                        Interface,
                                        Function,
                                        Variable,
                                        Constant,
                                        String,
                                        Number,
                                        Boolean,
                                        Array,
                                        Object,
                                        Key,
                                        Null,
                                        EnumMember,
                                        Struct,
                                        Event,
                                        Operator,
                                        TypeParameter,
                                    ],
                                ),
                            },
                        ),
                        hierarchical_document_symbol_support: Some(
                            true,
                        ),
                        tag_support: Some(
                            TagSupport {
                                value_set: [
                                    Deprecated,
                                ],
                            },
                        ),
                    },
                ),
                formatting: Some(
                    DynamicRegistrationClientCapabilities {
                        dynamic_registration: Some(
                            true,
                        ),
                    },
                ),
                range_formatting: Some(
                    DynamicRegistrationClientCapabilities {
                        dynamic_registration: Some(
                            true,
                        ),
                    },
                ),
                on_type_formatting: Some(
                    DynamicRegistrationClientCapabilities {
                        dynamic_registration: Some(
                            true,
                        ),
                    },
                ),
                declaration: Some(
                    GotoCapability {
                        dynamic_registration: Some(
                            true,
                        ),
                        link_support: Some(
                            true,
                        ),
                    },
                ),
                definition: Some(
                    GotoCapability {
                        dynamic_registration: Some(
                            true,
                        ),
                        link_support: Some(
                            true,
                        ),
                    },
                ),
                type_definition: Some(
                    GotoCapability {
                        dynamic_registration: Some(
                            true,
                        ),
                        link_support: Some(
                            true,
                        ),
                    },
                ),
                implementation: Some(
                    GotoCapability {
                        dynamic_registration: Some(
                            true,
                        ),
                        link_support: Some(
                            true,
                        ),
                    },
                ),
                code_action: Some(
                    CodeActionClientCapabilities {
                        dynamic_registration: Some(
                            true,
                        ),
                        code_action_literal_support: Some(
                            CodeActionLiteralSupport {
                                code_action_kind: CodeActionKindLiteralSupport {
                                    value_set: [
                                        &quot;&quot;,
                                        &quot;quickfix&quot;,
                                        &quot;refactor&quot;,
                                        &quot;refactor.extract&quot;,
                                        &quot;refactor.inline&quot;,
                                        &quot;refactor.rewrite&quot;,
                                        &quot;source&quot;,
                                        &quot;source.organizeImports&quot;,
                                    ],
                                },
                            },
                        ),
                        is_preferred_support: Some(
                            true,
                        ),
                        disabled_support: Some(
                            true,
                        ),
                        data_support: Some(
                            true,
                        ),
                        resolve_support: Some(
                            CodeActionCapabilityResolveSupport {
                                properties: [
                                    &quot;edit&quot;,
                                ],
                            },
                        ),
                        honors_change_annotations: Some(
                            true,
                        ),
                    },
                ),
                code_lens: Some(
                    DynamicRegistrationClientCapabilities {
                        dynamic_registration: Some(
                            true,
                        ),
                    },
                ),
                document_link: Some(
                    DocumentLinkClientCapabilities {
                        dynamic_registration: Some(
                            true,
                        ),
                        tooltip_support: Some(
                            true,
                        ),
                    },
                ),
                color_provider: Some(
                    DynamicRegistrationClientCapabilities {
                        dynamic_registration: Some(
                            true,
                        ),
                    },
                ),
                rename: Some(
                    RenameClientCapabilities {
                        dynamic_registration: Some(
                            true,
                        ),
                        prepare_support: Some(
                            true,
                        ),
                        prepare_support_default_behavior: Some(
                            Identifier,
                        ),
                        honors_change_annotations: Some(
                            true,
                        ),
                    },
                ),
                publish_diagnostics: Some(
                    PublishDiagnosticsClientCapabilities {
                        related_information: Some(
                            true,
                        ),
                        tag_support: Some(
                            TagSupport {
                                value_set: [
                                    Unnecessary,
                                    Deprecated,
                                ],
                            },
                        ),
                        version_support: Some(
                            false,
                        ),
                        code_description_support: Some(
                            true,
                        ),
                        data_support: Some(
                            true,
                        ),
                    },
                ),
                folding_range: Some(
                    FoldingRangeClientCapabilities {
                        dynamic_registration: Some(
                            true,
                        ),
                        range_limit: Some(
                            5000,
                        ),
                        line_folding_only: Some(
                            true,
                        ),
                        folding_range_kind: Some(
                            FoldingRangeKindCapability {
                                value_set: Some(
                                    [
                                        Comment,
                                        Imports,
                                        Region,
                                    ],
                                ),
                            },
                        ),
                        folding_range: Some(
                            FoldingRangeCapability {
                                collapsed_text: Some(
                                    false,
                                ),
                            },
                        ),
                    },
                ),
                selection_range: Some(
                    SelectionRangeClientCapabilities {
                        dynamic_registration: Some(
                            true,
                        ),
                    },
                ),
                linked_editing_range: Some(
                    DynamicRegistrationClientCapabilities {
                        dynamic_registration: Some(
                            true,
                        ),
                    },
                ),
                call_hierarchy: Some(
                    DynamicRegistrationClientCapabilities {
                        dynamic_registration: Some(
                            true,
                        ),
                    },
                ),
                semantic_tokens: Some(
                    SemanticTokensClientCapabilities {
                        dynamic_registration: Some(
                            true,
                        ),
                        requests: SemanticTokensClientCapabilitiesRequests {
                            range: Some(
                                true,
                            ),
                            full: Some(
                                Delta {
                                    delta: Some(
                                        true,
                                    ),
                                },
                            ),
                        },
                        token_types: [
                            SemanticTokenType(
                                &quot;namespace&quot;,
                            ),
                            SemanticTokenType(
                                &quot;type&quot;,
                            ),
                            SemanticTokenType(
                                &quot;class&quot;,
                            ),
                            SemanticTokenType(
                                &quot;enum&quot;,
                            ),
                            SemanticTokenType(
                                &quot;interface&quot;,
                            ),
                            SemanticTokenType(
                                &quot;struct&quot;,
                            ),
                            SemanticTokenType(
                                &quot;typeParameter&quot;,
                            ),
                            SemanticTokenType(
                                &quot;parameter&quot;,
                            ),
                            SemanticTokenType(
                                &quot;variable&quot;,
                            ),
                            SemanticTokenType(
                                &quot;property&quot;,
                            ),
                            SemanticTokenType(
                                &quot;enumMember&quot;,
                            ),
                            SemanticTokenType(
                                &quot;event&quot;,
                            ),
                            SemanticTokenType(
                                &quot;function&quot;,
                            ),
                            SemanticTokenType(
                                &quot;method&quot;,
                            ),
                            SemanticTokenType(
                                &quot;macro&quot;,
                            ),
                            SemanticTokenType(
                                &quot;keyword&quot;,
                            ),
                            SemanticTokenType(
                                &quot;modifier&quot;,
                            ),
                            SemanticTokenType(
                                &quot;comment&quot;,
                            ),
                            SemanticTokenType(
                                &quot;string&quot;,
                            ),
                            SemanticTokenType(
                                &quot;number&quot;,
                            ),
                            SemanticTokenType(
                                &quot;regexp&quot;,
                            ),
                            SemanticTokenType(
                                &quot;operator&quot;,
                            ),
                            SemanticTokenType(
                                &quot;decorator&quot;,
                            ),
                        ],
                        token_modifiers: [
                            SemanticTokenModifier(
                                &quot;declaration&quot;,
                            ),
                            SemanticTokenModifier(
                                &quot;definition&quot;,
                            ),
                            SemanticTokenModifier(
                                &quot;readonly&quot;,
                            ),
                            SemanticTokenModifier(
                                &quot;static&quot;,
                            ),
                            SemanticTokenModifier(
                                &quot;deprecated&quot;,
                            ),
                            SemanticTokenModifier(
                                &quot;abstract&quot;,
                            ),
                            SemanticTokenModifier(
                                &quot;async&quot;,
                            ),
                            SemanticTokenModifier(
                                &quot;modification&quot;,
                            ),
                            SemanticTokenModifier(
                                &quot;documentation&quot;,
                            ),
                            SemanticTokenModifier(
                                &quot;defaultLibrary&quot;,
                            ),
                        ],
                        formats: [
                            TokenFormat(
                                &quot;relative&quot;,
                            ),
                        ],
                        overlapping_token_support: Some(
                            false,
                        ),
                        multiline_token_support: Some(
                            false,
                        ),
                        server_cancel_support: Some(
                            true,
                        ),
                        augments_syntax_tokens: Some(
                            true,
                        ),
                    },
                ),
                moniker: None,
                type_hierarchy: Some(
                    DynamicRegistrationClientCapabilities {
                        dynamic_registration: Some(
                            true,
                        ),
                    },
                ),
                inline_value: Some(
                    DynamicRegistrationClientCapabilities {
                        dynamic_registration: Some(
                            true,
                        ),
                    },
                ),
                inlay_hint: Some(
                    InlayHintClientCapabilities {
                        dynamic_registration: Some(
                            true,
                        ),
                        resolve_support: Some(
                            InlayHintResolveClientCapabilities {
                                properties: [
                                    &quot;tooltip&quot;,
                                    &quot;textEdits&quot;,
                                    &quot;label.tooltip&quot;,
                                    &quot;label.location&quot;,
                                    &quot;label.command&quot;,
                                ],
                            },
                        ),
                    },
                ),
                diagnostic: Some(
                    DiagnosticClientCapabilities {
                        dynamic_registration: Some(
                            true,
                        ),
                        related_document_support: Some(
                            false,
                        ),
                    },
                ),
                inline_completion: None,
            },
        ),
        notebook_document: Some(
            NotebookDocumentClientCapabilities {
                synchronization: NotebookDocumentSyncClientCapabilities {
                    dynamic_registration: Some(
                        true,
                    ),
                    execution_summary_report: None,
                },
            },
        ),
        window: Some(
            WindowClientCapabilities {
                work_done_progress: Some(
                    true,
                ),
                show_message: Some(
                    ShowMessageRequestClientCapabilities {
                        message_action_item: Some(
                            MessageActionItemCapabilities {
                                additional_properties_support: Some(
                                    true,
                                ),
                            },
                        ),
                    },
                ),
                show_document: Some(
                    ShowDocumentClientCapabilities {
                        support: true,
                    },
                ),
            },
        ),
        general: Some(
            GeneralClientCapabilities {
                regular_expressions: Some(
                    RegularExpressionsClientCapabilities {
                        engine: &quot;ECMAScript&quot;,
                        version: Some(
                            &quot;ES2020&quot;,
                        ),
                    },
                ),
                markdown: Some(
                    MarkdownClientCapabilities {
                        parser: &quot;marked&quot;,
                        version: Some(
                            &quot;1.1.0&quot;,
                        ),
                        allowed_tags: None,
                    },
                ),
                stale_request_support: Some(
                    StaleRequestSupportClientCapabilities {
                        cancel: true,
                        retry_on_content_modified: [
                            &quot;textDocument/semanticTokens/full&quot;,
                            &quot;textDocument/semanticTokens/range&quot;,
                            &quot;textDocument/semanticTokens/full/delta&quot;,
                        ],
                    },
                ),
                position_encodings: Some(
                    [
                        PositionEncodingKind(
                            &quot;utf-16&quot;,
                        ),
                    ],
                ),
            },
        ),
        offset_encoding: None,
        experimental: None,
    },
    trace: Some(
        Messages,
    ),
    workspace_folders: Some(
        [
            WorkspaceFolder {
                uri: Url {
                    scheme: &quot;file&quot;,
                    cannot_be_a_base: false,
                    username: &quot;&quot;,
                    password: None,
                    host: None,
                    port: None,
                    path: &quot;/tmp/ruff-server-bug-mwe-master&quot;,
                    query: None,
                    fragment: None,
                },
                name: &quot;ruff-server-bug-mwe-master&quot;,
            },
        ],
    ),
    client_info: Some(
        ClientInfo {
            name: &quot;Visual Studio Code&quot;,
            version: Some(
                &quot;1.101.2&quot;,
            ),
        },
    ),
    locale: Some(
        &quot;en&quot;,
    ),
    work_done_progress_params: WorkDoneProgressParams {
        work_done_token: None,
    },
}
2025-07-09 11:21:07.118097593 DEBUG Negotiated position encoding: UTF16
2025-07-09 11:21:07.118287003 DEBUG Indexing settings for workspace: /tmp/ruff-server-bug-mwe-master
2025-07-09 11:21:07.131506239 DEBUG Loaded settings from: `/tmp/ruff-server-bug-mwe-master/pyproject.toml` for `/tmp/ruff-server-bug-mwe-master`
2025-07-09 11:21:07.134581217 DEBUG Loaded settings from: `/tmp/ruff-server-bug-mwe-master/ruff-mwe/pyproject.toml` for `/tmp/ruff-server-bug-mwe-master/ruff-mwe`
2025-07-09 11:21:07.135359041 DEBUG Ignored path via `exclude`: /tmp/ruff-server-bug-mwe-master/ruff-mwe/.mypy_cache
2025-07-09 11:21:07.136630225  INFO Registering workspace: /tmp/ruff-server-bug-mwe-master
2025-07-09 11:21:07.137233515 DEBUG notification{method=&quot;textDocument/didOpen&quot;}: enter
2025-07-09 11:21:07.137635662 DEBUG client_response{id=0 method=&quot;client/registerCapability&quot;}: enter
2025-07-09 11:21:07.137568195 DEBUG request{id=1 method=&quot;textDocument/diagnostic&quot;}: enter
2025-07-09 11:21:07.137661923  INFO client_response{id=0 method=&quot;client/registerCapability&quot;}: Configuration file watcher successfully registered
2025-07-09 11:21:07.137814596 DEBUG request{id=1 method=&quot;textDocument/diagnostic&quot;}: Included path via `include`: /tmp/ruff-server-bug-mwe-master/ruff-mwe/main.py

</code></pre>


<p>I also tried setting the <code>lsp-log-io</code> variable in Emacs and got this additional log, if it means anything:</p>
<pre><code>Command &quot;/home/brent/astral/ruff/target/debug/ruff server&quot; is present on the path.
Command &quot;/home/brent/astral/ruff/target/debug/ruff server&quot; is present on the path.
Found the following clients for /tmp/ruff-server-bug-mwe-master/ruff-mwe/main.py: (server-id ruff, priority -2)
The following clients were selected based on priority: (server-id ruff, priority -2)
Creating watchers for following 2 folders:
  /tmp/ruff-server-bug-mwe-master
  /tmp/ruff-server-bug-mwe-master/ruff-mwe
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2025-07-10 06:35</div>
            <div class="timeline-body"><p>Thank you! That&#x27;s very helpful</p>
<blockquote>
<pre><code>root_path: Some(
    &quot;/tmp/ruff-server-bug-mwe-master&quot;,
),
root_uri: Some(
    Url {
        scheme: &quot;file&quot;,
        cannot_be_a_base: false,
        username: &quot;&quot;,
        password: None,
        host: None,
        port: None,
        path: &quot;/tmp/ruff-server-bug-mwe-master&quot;,
        query: None,
        fragment: None,
    },
),</code></pre>
</blockquote>
<p>I figured it might be this. They&#x27;re using the <code>root_path</code> and <code>root_uri</code> to provide the workspace root, both of which are deprecated in favor of <code>workspace_folders</code> which is not provided. Both Ruff and ty doesn&#x27;t support this. I wonder if we should fallback to using this information as it seems that not all clients have moved to the <code>workspace_folders</code> and it doesn&#x27;t seem too difficult to add support.</p>
<p>What this would look like is that if <code>workspace_folders</code> is empty, then we&#x27;d first try <code>root_uri</code> and if that is <code>null</code> then we&#x27;d try <code>root_path</code> and then fallback to our current behavior which is to use the current working directory. For Ruff, we can rename <code>Workspaces::from_workspace_folders</code> to <code>Workspaces::from_initialization_params</code> which looks at <code>workspace_folders</code>, <code>root_uri</code>, and <code>root_path</code> from the initialization params.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from &quot;`ruff server` not respecting heirarchical configuration files&quot; to &quot;Server: Consider `root_uri`/`root_path` as a fallback to detect workspace root&quot; by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2025-07-10 06:37</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">question</span> removed by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2025-07-10 06:37</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">server</span> added by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2025-07-10 06:37</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/lunik1">@lunik1</a> on 2025-10-30 10:40</div>
            <div class="timeline-body"><p>I have a workaround for this, <code>ruff</code> seems to behave correctly when you tell lsp-mode it is multi root:</p>
<pre><code>(oset (gethash &#x27;ruff lsp-clients) multi-root t)
</code></pre>
<p>I think it makes sense to make this change to lsp-mode upstream?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/lunik1">@lunik1</a> on 2025-11-24 17:00</div>
            <div class="timeline-body"><p>Upstream MR opened <a href="https://github.com/emacs-lsp/lsp-mode/pull/4921">emacs-lsp/lsp-mode#4921</a></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/lunik1">@lunik1</a> on 2025-11-24 23:15</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/lunik1">@lunik1</a> on 2025-11-24 23:16</div>
            <div class="timeline-body"><p>Fixed in <code>lsp-mode</code>. <code>ruff</code> is now treated as multi-workspace.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 18:50:12 UTC
    </footer>
</body>
</html>
