<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Server and CLI don' t exclude the same directories - astral-sh/ruff #11587</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Server and CLI don' t exclude the same directories</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/issues/11587">#11587</a>
        opened by <a href="https://github.com/EricDepagne">@EricDepagne</a>
        on 2024-05-28 21:36
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/EricDepagne">@EricDepagne</a> on 2024-05-28 21:36</div>
            <div class="timeline-body"><p>I' m using ruff server in vscode.
Ruff version: 0.4.5
VSCode version : 1.89.1 (Universal)</p>
<p>My ruff.toml contains the following exclusion:
exclude = [&quot;*/tests/*&quot;]</p>
<p>I run ruff in a terminal at the same time as the ruff server in vscode.
The intersting part of the output of ruff -w is:</p>
<pre><code>[23:26:28 PM] Starting linter in watch mode...

warning: Unexpected `# ruff: noqa` directive at conftest.py:10. File-level suppression comments must appear on their own line. For line-level suppression, omit the `ruff:` prefix.
warning: Unexpected `# ruff: noqa` directive at bikeanalysis/activities/models/activities.py:228. File-level suppression comments must appear on their own line. For line-level suppression, omit the `ruff:` prefix.
[23:26:28 PM] Found 19 errors. Watching for file changes.
</code></pre>
<p>Only 19 errors found</p>
<p>In vscode, the same errors are flagged, as expected, but I have also all the warnings for all my test files, that are in one of the tests/ directories.</p>
<p>For instance, this one:</p>
<pre><code>
def test_missing_all_streams():
    streams = []
    assert len(get_missing_streams(streams=streams)) == 11
</code></pre>
<p>triggers D103.</p>
<p>The ruff that runs in my terminal does not show any errors for files in my tests/ directory as expected from the configuration.</p>
<p>Am I missing something when configuring ruff server in VSCode?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">server</span> added by @charliermarsh on 2024-05-28 21:43</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-05-28 22:29</div>
            <div class="timeline-body"><p>Might be a real bug in the new server. I'll try to repro tonight.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-05-28 23:56</div>
            <div class="timeline-body"><p><code>exclude = [&quot;*/tests/*&quot;]</code> doesn't actually work for me, even on the command-line. <code>exclude = [&quot;**/tests/*&quot;]</code> does work though.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @charliermarsh on 2024-05-28 23:56</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-05-28 23:59</div>
            <div class="timeline-body"><p>I can reproduce with <code>exclude = [&quot;**/tests/*&quot;]</code> though.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-05-29 00:05</div>
            <div class="timeline-body"><p>I think <code>ruff server</code> just doesn't respect exclusions yet if you open an excluded file directly.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @charliermarsh by @charliermarsh on 2024-05-29 00:15</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Unassigned @charliermarsh by @charliermarsh on 2024-05-29 00:21</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @charliermarsh by @charliermarsh on 2024-05-29 00:38</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2024-05-29 02:58</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/messense">@messense</a> on 2024-08-21 05:49</div>
            <div class="timeline-body"><p>#11590 breaks my format workflow, I'd expect the vscode <code>format document</code> and <code>format cell</code> commands to format the python/notebook file even if it's excluded in configuration file, because I'm explicitly asking vscode to format it.</p>
<p>BTW, <code>ruff format &lt;path to file&gt;</code> works regardless of file exclusions config, so IMO manually call vscode <code>format document</code> should have the same behavior.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-08-21 06:33</div>
            <div class="timeline-body"><blockquote>
<p>https://github.com/astral-sh/ruff/pull/11590 breaks my format workflow, I'd expect the vscode format document and format cell commands to format the python/notebook file even if it's excluded in configuration file, because I'm explicitly asking vscode to format it.</p>
</blockquote>
<p>Hmm, I do understand the desire that explicitly issuing format document or format cells should format the code even if it is excluded. The challenge we face is that the LSP request, as far as I know, contains no information whether the request was triggered implicitly (by enabling format on save) or explicitly (by issuing the command). Implicit request should respect the ignores, I'm open to change that explicit requests don't.</p>
<p>The alternative is that we introduce a new option.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/messense">@messense</a> on 2024-08-22 01:42</div>
            <div class="timeline-body"><p>An new option would be nice for people don't use <code>format on save</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-08-22 03:10</div>
            <div class="timeline-body"><blockquote>
<p>The challenge we face is that the LSP request, as far as I know, contains no information whether the request was triggered implicitly (by enabling format on save) or explicitly (by issuing the command)</p>
</blockquote>
<p>Yeah, this is correct. The server has no way of knowing whether the request was triggered automatically or manually.</p>
<p>It seems reasonable to add a new option and is related to https://github.com/astral-sh/ruff/issues/12176. @messense Is it that the extension should format / lint <em>every</em> document that's opened in the editor, thus not considering the includes / excludes ?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/masaccio">@masaccio</a> on 2024-10-14 17:16</div>
            <div class="timeline-body"><p>Is this really about files that are opened explicitly? I'm finding that VScode flags warnings from files that are not open but are in my workspace. In my case these files:</p>
<img width="267" alt="Screenshot 2024-10-14 at 18 15 23" src="https://github.com/user-attachments/assets/73f904dd-7f0d-475f-9c33-02f17dc41c2a">

<p>Despite:</p>
<pre><code class="language-tool">[tool.ruff]
exclude = [
  # Machine-generated files
  &quot;**/.bootstrap/*&quot;,
  &quot;**/.tox/*&quot;,
  &quot;**/.vscode/*&quot;,
  &quot;**/src/numbers_parser/generated/*&quot;,
]
</code></pre>
<p>Whether they're included by the server is a bit random. Is there a VScode log that would be helpful?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-10-15 10:14</div>
            <div class="timeline-body"><blockquote>
<p>Is this really about files that are opened explicitly? I'm finding that VScode flags warnings from files that are not open but are in my workspace.</p>
</blockquote>
<p>Can you say more about this? Is it that the diagnostics window includes violations from files that aren't opened in the editor? Are those diagnostics coming from Ruff because we don't support workspace wide diagnostics? Do you have <code>python.analysis.diagnosticMode</code> set to <code>workspace</code>? That setting is used by the Python extension to include workspace wide diagnostics.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 11:34:01 UTC
    </footer>
</body>
</html>
