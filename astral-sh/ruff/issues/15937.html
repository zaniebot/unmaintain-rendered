<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UP035 autofix breaks code when a `typing`-module alias is used in a PEP-604 union in combination with a string - astral-sh/ruff #15937</title>
    <link rel="stylesheet" href="../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../index.html">Back to index</a>
    </div>

    <h1>UP035 autofix breaks code when a `typing`-module alias is used in a PEP-604 union in combination with a string</h1>

    <div class="meta">
        <span class="state state-open">Open</span>
        <a href="https://github.com/astral-sh/ruff/issues/15937">#15937</a>
        opened by <a href="https://github.com/PhilipVinc">@PhilipVinc</a>
        on 2025-02-04 14:28
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/PhilipVinc">@PhilipVinc</a> on 2025-02-04 14:28</div>
            <div class="timeline-body"><h3>Description</h3>
<p>The following code is correct</p>
<pre><code class="language-python">from typing import Iterable
a = Iterable['ciao'] | 'ciao'
</code></pre>
<p>However it gets tagged as wrong by UP35 and automatically fixed to</p>
<pre><code class="language-python">from collections.abc import Iterable
a = Iterable['ciao'] | 'ciao'
</code></pre>
<p>And the fixed code is wrong.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @AlexWaygood on 2025-02-04 15:44</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">fixes</span> added by @AlexWaygood on 2025-02-04 15:44</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-02-04 15:46</div>
            <div class="timeline-body"><p>I'm marking this issue as a bug since it's true that the autofix changes behaviour here, and ideally we should fix that. FWIW, though, I'd recommend always quoting the entire union if you're using forward references in a PEP-604 union, e.g.</p>
<pre><code class="language-py">from collections.abc import Iterable
a = 'Iterable[ciao] | ciao'
</code></pre>
<p>You can get unpredictable results (like this) otherwise. This is the official advice given at https://docs.python.org/3/library/stdtypes.html#types-union</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Daverball">@Daverball</a> on 2025-02-04 15:46</div>
            <div class="timeline-body"><p>The original code is wrong as well, see <a href="https://docs.astral.sh/ruff/rules/runtime-string-union/"><code>runtime-string-union</code></a> for why.</p>
<p>However, since you're using an implicit type alias, ruff can't know that using <code>|</code> here is not allowed. If you want ruff to be able to detect <code>TC010</code> here, then you need to switch to an explicit type alias: https://play.ruff.rs/9bd2d888-0d78-43af-bc0e-2e7b8da5d5dc</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-02-04 15:47</div>
            <div class="timeline-body"><blockquote>
<p>The original code is wrong as well</p>
</blockquote>
<p>I'd say that the original code is &quot;ill-advised&quot; @Daverball, but it's true that it does work at runtime :-)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Daverball">@Daverball</a> on 2025-02-04 15:48</div>
            <div class="timeline-body"><p>You're right. I didn't know the aliases in the typing module had some special magic to convert strings to <code>ForwardRef</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-02-04 15:50</div>
            <div class="timeline-body"><blockquote>
<p>I didn't know the aliases in the typing module had some special magic to convert strings to <code>ForwardRef</code>.</p>
</blockquote>
<p>Yeah... and it's arguably somewhat regrettable that they do, since it leads to highly confusing situationsn like this :/ but it can't realistically be reversed now</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/PhilipVinc">@PhilipVinc</a> on 2025-02-04 16:23</div>
            <div class="timeline-body"><p>Ah, I was not aware that even my code was 'ill-advised' wrong!
Thanks for letting me know!</p>
<p>However my point stands...
I had some 'working' (albeit incorrect) code that ruff broke when I added UP rules.
I was not aware of TC rules.
I imagine you'd like to avoid this happening.</p>
<p>It might be a good idea to suggest turning on TC010 with UP035 and some other UP rules as well?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/PhilipVinc">@PhilipVinc</a> on 2025-02-04 16:24</div>
            <div class="timeline-body"><p>(Yeah, I acknowledge that the  'right' and 'wrong' adjectives I used in the original post was a bit strong. Sorry, I was just trying to open the issue quickly because I had some other things to attend to)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-02-04 16:25</div>
            <div class="timeline-body"><blockquote>
<p>However my point stands...
I had some 'working' (albeit incorrect) code that ruff broke when I added UP rules.
I was not aware of TC rules.
I imagine you'd like to avoid this happening.</p>
</blockquote>
<p>Yes, we agree that this is a bug in Ruff that should be fixed :-) The autofix for this rule isn't meant to change the behaviour of your code!</p>
<blockquote>
<p>It might be a good idea to suggest turning on TC010 with UP035 and some other UP rules as well?</p>
</blockquote>
<p>Hmm, not sure -- this is the first time I've seen this come up, so I don't think many people run into this issue.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Daverball">@Daverball</a> on 2025-02-04 16:40</div>
            <div class="timeline-body"><p>The easiest way to address this would probably be to mark the fix as unsafe if the parent node to any of the references is a union <code>BinOp</code> and either the node directly to the left or directly to the right is a string.</p>
<p>Eventually if #15222 or #15635 gets merged, we could reuse that fix to extend the quotes and make the fix safe again if it doesn't get rid of any comments.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "UP035 may leads to broken code" to "UP035 autofix breaks code when a `typing`-module alias is used in a PEP-604 union in combination with a string" by @AlexWaygood on 2025-02-04 16:43</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:28:15 UTC
    </footer>
</body>
</html>
