<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>`ruff server`: Unable to take snapshot for document - astral-sh/ruff #11651</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>`ruff server`: Unable to take snapshot for document</h1>

    <div class="meta">
        <span class="state state-closed">Closed</span>
        <a href="https://github.com/astral-sh/ruff/issues/11651">#11651</a>
        opened by <a href="https://github.com/T-256">@T-256</a>
        on 2024-05-31 21:13
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/T-256">@T-256</a> on 2024-05-31 21:13</div>
            <div class="timeline-body"><p>Repro on VSCode: create new untitled notebook then close it.</p>
<pre><code class="language-log">
2024-06-01 00:37:05.063 [info] [Trace - 12:37:05 AM] Received notification 'window/showMessage'.
2024-06-01 00:37:58.052 [info] [Trace - 12:37:58 AM] Sending notification 'notebookDocument/didOpen'.
2024-06-01 00:37:58.053 [info] [Trace - 12:37:58 AM] Sending notification 'notebookDocument/didChange'.
2024-06-01 00:37:58.056 [info]  194.326137s DEBUG ruff_server::session::index Falling back to configuration of the only active workspace for the new document 'untitled:Untitled-2.ipynb?jupyter-notebook'.
 194.326153s DEBUG ruff_server::session::index Falling back to configuration of the only active workspace for the new document 'untitled:Untitled-2.ipynb?jupyter-notebook'.

2024-06-01 00:37:58.057 [info] [Trace - 12:37:58 AM] Received notification 'textDocument/publishDiagnostics'.
2024-06-01 00:37:58.057 [info]  194.329275s DEBUG ruff_server::session::index Falling back to configuration of the only active workspace for the new document 'untitled:Untitled-2.ipynb?jupyter-notebook'.
 194.329299s DEBUG ruff_server::session::index Falling back to configuration of the only active workspace for the new document 'untitled:Untitled-2.ipynb?jupyter-notebook'.

2024-06-01 00:37:58.058 [info] [Trace - 12:37:58 AM] Received notification 'textDocument/publishDiagnostics'.
2024-06-01 00:37:58.285 [info] [Trace - 12:37:58 AM] Sending request 'textDocument/codeAction - (18)'.
2024-06-01 00:37:58.286 [info]  194.558099s DEBUG ruff_server::session::index Falling back to configuration of the only active workspace for the new document 'untitled:Untitled-2.ipynb?jupyter-notebook'.
 194.558120s DEBUG ruff_server::session::index Falling back to configuration of the only active workspace for the new document 'untitled:Untitled-2.ipynb?jupyter-notebook'.

2024-06-01 00:37:58.286 [info] [Trace - 12:37:58 AM] Received response 'textDocument/codeAction - (18)' in 1ms.
2024-06-01 00:38:08.026 [info] [Trace - 12:38:08 AM] Sending notification 'notebookDocument/didClose'.
2024-06-01 00:38:08.048 [info] [Trace - 12:38:08 AM] Sending notification 'textDocument/didClose'.
2024-06-01 00:38:08.049 [info]  204.321227s DEBUG ruff_server::session::index Falling back to configuration of the only active workspace for the new document 'vscode-notebook-cell:Untitled-2.ipynb?jupyter-notebook#W0sdW50aXRsZWQ%3D'.
 204.321249s DEBUG ruff_server::session::index Falling back to configuration of the only active workspace for the new document 'vscode-notebook-cell:Untitled-2.ipynb?jupyter-notebook#W0sdW50aXRsZWQ%3D'.
 204.321259s ERROR ruff_server::server::api An error occurred while running textDocument/didClose: Unable to take snapshot for document with URL vscode-notebook-cell:Untitled-2.ipynb?jupyter-notebook#W0sdW50aXRsZWQ%3D

2024-06-01 00:38:08.049 [info] [Trace - 12:38:08 AM] Received notification 'window/showMessage'.
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @charliermarsh on 2024-05-31 21:42</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">server</span> added by @charliermarsh on 2024-05-31 21:42</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-05-31 21:47</div>
            <div class="timeline-body"><p>I wonder if the notebook close gets called, then the cell closes get called?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/T-256">@T-256</a> on 2024-05-31 22:06</div>
            <div class="timeline-body"><p>Also, the logs show duplicated <code>ruff_server::session::index Falling back to configuration ...</code> sent for each <code>textDocument/publishDiagnostics</code> responses from server. Perhaps on second try there is no available notebook cell?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-06-01 06:22</div>
            <div class="timeline-body"><p>Can you try this with Ruff <code>0.4.7</code>? It could be a problem because the server didn't support untitled documents but it has been fixed with the latest release.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-06-01 07:08</div>
            <div class="timeline-body"><p>@dhruvmanila this should be the latest version from the logs.</p>
<p>The fallback messages are printed because untitled documents belong to no workspace, so we had to implement our own fallback logic</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../astral-sh/ruff-vscode/issues/496.html">astral-sh/ruff-vscode#496</a> on 2024-06-13 13:37</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/T-256">@T-256</a> on 2024-06-14 00:31</div>
            <div class="timeline-body"><p>Detailed log with <code>ruff.trace.server = verbose</code>:</p>
<pre><code class="language-log">2024-06-14 03:50:29.068 [info] Server: Start requested.
2024-06-14 03:51:24.256 [info] [Trace - 3:51:24 AM] Sending notification '$/setTrace'.
2024-06-14 03:51:24.256 [info] Params: {
    &quot;value&quot;: &quot;verbose&quot;
}


2024-06-14 03:51:56.972 [info] [Trace - 3:51:56 AM] Sending notification 'notebookDocument/didOpen'.
2024-06-14 03:51:56.972 [info] Params: {
    &quot;notebookDocument&quot;: {
        &quot;uri&quot;: &quot;untitled:Untitled-1.ipynb?jupyter-notebook&quot;,
        &quot;notebookType&quot;: &quot;jupyter-notebook&quot;,
        &quot;version&quot;: 0,
        &quot;cells&quot;: [
            {
                &quot;kind&quot;: 2,
                &quot;document&quot;: &quot;vscode-notebook-cell:Untitled-1.ipynb?jupyter-notebook#W0sdW50aXRsZWQ%3D&quot;,
                &quot;metadata&quot;: {
                    &quot;metadata&quot;: {}
                }
            }
        ],
        &quot;metadata&quot;: {
            &quot;cells&quot;: [],
            &quot;metadata&quot;: {
                &quot;language_info&quot;: {
                    &quot;name&quot;: &quot;python&quot;
                }
            },
            &quot;indentAmount&quot;: &quot; &quot;
        }
    },
    &quot;cellTextDocuments&quot;: [
        {
            &quot;uri&quot;: &quot;vscode-notebook-cell:Untitled-1.ipynb?jupyter-notebook#W0sdW50aXRsZWQ%3D&quot;,
            &quot;languageId&quot;: &quot;python&quot;,
            &quot;version&quot;: 1,
            &quot;text&quot;: &quot;&quot;
        }
    ]
}


2024-06-14 03:51:56.973 [info] [Trace - 3:51:56 AM] Sending notification 'notebookDocument/didChange'.
2024-06-14 03:51:56.973 [info] Params: {
    &quot;notebookDocument&quot;: {
        &quot;version&quot;: 1,
        &quot;uri&quot;: &quot;untitled:Untitled-1.ipynb?jupyter-notebook&quot;
    },
    &quot;change&quot;: {
        &quot;metadata&quot;: {
            &quot;cells&quot;: [],
            &quot;metadata&quot;: {},
            &quot;nbformat&quot;: 4,
            &quot;nbformat_minor&quot;: 2
        },
        &quot;cells&quot;: {
            &quot;data&quot;: [
                {
                    &quot;kind&quot;: 2,
                    &quot;document&quot;: &quot;vscode-notebook-cell:Untitled-1.ipynb?jupyter-notebook#W0sdW50aXRsZWQ%3D&quot;
                }
            ]
        }
    }
}


2024-06-14 03:51:56.978 [info] [Trace - 3:51:56 AM] Received notification 'textDocument/publishDiagnostics'.
2024-06-14 03:51:56.978 [info] Params: {
    &quot;diagnostics&quot;: [],
    &quot;uri&quot;: &quot;vscode-notebook-cell:Untitled-1.ipynb?jupyter-notebook#W0sdW50aXRsZWQ%3D&quot;,
    &quot;version&quot;: 0
}


2024-06-14 03:51:56.978 [info] [Trace - 3:51:56 AM] Received notification 'textDocument/publishDiagnostics'.
2024-06-14 03:51:56.978 [info] Params: {
    &quot;diagnostics&quot;: [],
    &quot;uri&quot;: &quot;vscode-notebook-cell:Untitled-1.ipynb?jupyter-notebook#W0sdW50aXRsZWQ%3D&quot;,
    &quot;version&quot;: 1
}


2024-06-14 03:51:57.147 [info] [Trace - 3:51:57 AM] Sending request 'textDocument/codeAction - (8)'.
2024-06-14 03:51:57.147 [info] Params: {
    &quot;textDocument&quot;: {
        &quot;uri&quot;: &quot;vscode-notebook-cell:Untitled-1.ipynb?jupyter-notebook#W0sdW50aXRsZWQ%3D&quot;
    },
    &quot;range&quot;: {
        &quot;start&quot;: {
            &quot;line&quot;: 0,
            &quot;character&quot;: 0
        },
        &quot;end&quot;: {
            &quot;line&quot;: 0,
            &quot;character&quot;: 0
        }
    },
    &quot;context&quot;: {
        &quot;diagnostics&quot;: [],
        &quot;triggerKind&quot;: 2
    }
}


2024-06-14 03:51:57.148 [info] [Trace - 3:51:57 AM] Received response 'textDocument/codeAction - (8)' in 1ms.
2024-06-14 03:51:57.148 [info] Result: [
    {
        &quot;data&quot;: &quot;vscode-notebook-cell:Untitled-1.ipynb?jupyter-notebook#W0sdW50aXRsZWQ%3D&quot;,
        &quot;kind&quot;: &quot;source.fixAll.ruff&quot;,
        &quot;title&quot;: &quot;Ruff: Fix all auto-fixable problems&quot;
    },
    {
        &quot;data&quot;: &quot;vscode-notebook-cell:Untitled-1.ipynb?jupyter-notebook#W0sdW50aXRsZWQ%3D&quot;,
        &quot;kind&quot;: &quot;source.organizeImports.ruff&quot;,
        &quot;title&quot;: &quot;Ruff: Organize imports&quot;
    }
]


2024-06-14 03:51:59.037 [info] [Trace - 3:51:59 AM] Sending notification 'notebookDocument/didClose'.
2024-06-14 03:51:59.037 [info] Params: {
    &quot;notebookDocument&quot;: {
        &quot;uri&quot;: &quot;untitled:Untitled-1.ipynb?jupyter-notebook&quot;
    },
    &quot;cellTextDocuments&quot;: [
        {
            &quot;uri&quot;: &quot;vscode-notebook-cell:Untitled-1.ipynb?jupyter-notebook#W0sdW50aXRsZWQ%3D&quot;
        }
    ]
}


2024-06-14 03:51:59.057 [info] [Trace - 3:51:59 AM] Sending notification 'textDocument/didClose'.
2024-06-14 03:51:59.057 [info] Params: {
    &quot;textDocument&quot;: {
        &quot;uri&quot;: &quot;vscode-notebook-cell:Untitled-1.ipynb?jupyter-notebook#W0sdW50aXRsZWQ%3D&quot;
    }
}


2024-06-14 03:51:59.058 [info]   89.959415800s ERROR ruff:main ruff_server::server::api: An error occurred while running textDocument/didClose: Unable to take snapshot for document with URL vscode-notebook-cell:Untitled-1.ipynb?jupyter-notebook#W0sdW50aXRsZWQ%3D

2024-06-14 03:51:59.058 [info] [Trace - 3:51:59 AM] Received notification 'window/showMessage'.
2024-06-14 03:51:59.058 [info] Params: {
    &quot;message&quot;: &quot;Ruff encountered a problem. Check the logs for more details.&quot;,
    &quot;type&quot;: 1
}

</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/11867.html">astral-sh/ruff#11867</a> on 2024-06-14 01:50</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone "Ruff Server: Stable" by @snowsignal on 2024-06-17 16:34</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @snowsignal by @snowsignal on 2024-06-19 18:32</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/11942.html">astral-sh/ruff#11942</a> on 2024-06-19 18:49</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @snowsignal on 2024-06-21 17:53</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @snowsignal on 2024-06-21 17:53</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:34:53 UTC
    </footer>
</body>
</html>
