<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Allow explicit select of docstring rule to override configured convention - astral-sh/ruff #2606</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Allow explicit select of docstring rule to override configured convention</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/issues/2606">#2606</a>
        opened by <a href="https://github.com/ngnpope">@ngnpope</a>
        on 2023-02-06 12:07
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ngnpope">@ngnpope</a></div>
            <div class="timeline-body"><p>I know this is <a href="https://github.com/charliermarsh/ruff#does-ruff-support-numpy--or-google-style-docstrings">documented</a>...</p>
<blockquote>
<p>Setting a <code>convention</code> force-disables any rules that are incompatible with that convention, no matter how they&#x27;re provided, which avoids accidental incompatibilities and simplifies configuration.</p>
</blockquote>
<p>...but it seems a little excessive in some cases.</p>
<p>In particular, <code>convention = &quot;pep257&quot;</code> disables <code>D212</code> and <code>D213</code>. <a href="https://peps.python.org/pep-0257/#multi-line-docstrings:~:text=The%20summary%20line%20may%20be%20on%20the%20same%20line%20as%20the%20opening%20quotes%20or%20on%20the%20next%20line.">PEP 257</a> states:</p>
<blockquote>
<p>The summary line may be on the same line as the opening quotes or on the next line.</p>
</blockquote>
<p>But I&#x27;d like to be a little stricter. I&#x27;d like to have <code>convention = &quot;pep257&quot;</code> and force enable <code>D213</code>. Not sure whether this is best as a new configuration option to make it something you have to explicitly opt in to, e.g. <code>force-enable = [&quot;D213&quot;]</code>?</p>
<p><em>(Using v0.0.241.)</em></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-02-06 15:38</div>
            <div class="timeline-body"><p>I think this was overly aggressive. We can reconsider. It was done to avoid things like users accidentally enabling both <code>D212</code> and <code>D213</code>, which led to infinite autofix loops. But we since &quot;solved&quot; that with #2369. So we could instead treat conventions slightly differently.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">configuration</span> added by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-02-06 15:38</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">core</span> added by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-02-06 15:38</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">core</span> removed by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-02-06 15:38</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-02-06 17:59</div>
            <div class="timeline-body"><p>It probably makes sense to treat <code>convention</code> as equivalent to inlining an <code>extend-select</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ngnpope">@ngnpope</a> on 2023-02-06 18:37</div>
            <div class="timeline-body"><p>Aye, that sounds like how I expected it to work</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/smackesey">@smackesey</a> on 2023-03-10 20:29</div>
            <div class="timeline-body"><p>Came here to say that I added <code>convention = &quot;google&quot;</code> but was unsure how it would interact with my existing set of <code>D</code> ignores. Went looking for answers under <code>convention</code> in <a href="https://beta.ruff.rs/docs/settings/#convention">the docs</a> but didn&#x27;t find anything. What&#x27;s the current behavior?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-03-10 20:49</div>
            <div class="timeline-body"><p>The current behavior is that it turns off any rules that are incompatible with the convention.</p>
<p>So, specifically, <code>convention = &quot;google&quot;</code> is equivalent to ignoring <code>D203</code>, <code>D204</code>, <code>D213</code>, <code>D215</code>, <code>D400</code>, <code>D401</code>, <code>D404</code>, <code>D406</code>, <code>D407</code>, <code>D408</code>, <code>D409</code>, and <code>D413</code>.</p>
<p>So for Dagster, you can remove that first block of <code>(non-google docstring)</code> ignores. That is, I think you&#x27;d want:</p>
<pre><code>[tool.ruff]
select = [&quot;D&quot;]
ignore = [
  # (missing public docstrings) These work off of the Python sense of &quot;public&quot;, rather than our
  # bespoke definition based off of `@public`. When ruff supports custom plugins then we can write
  # appropriate rules to require docstrings for `@public`.
  &quot;D100&quot;,
  &quot;D101&quot;,
  &quot;D102&quot;,
  &quot;D103&quot;,
  &quot;D104&quot;,
  &quot;D105&quot;,
  &quot;D106&quot;,
  &quot;D107&quot;,

  ##### TEMPORARY DISABLES

  # (assorted docstring rules) There are too many violations of these to enable
  # right now, but we should enable after fixing the violations.
  &quot;D200&quot;,  # (one-line docstring should fit)
  &quot;D205&quot;,  # (blank line after summary)
  &quot;D212&quot;,  # (multi-line docstring summary should start at 1st line)
  &quot;D415&quot;,  # (docstring summary should end with a period)
  &quot;D417&quot;,  # (missing arg in docstring)

  # (indent docstring rules) These rules should be enabled when ruff lands
  # on/off style comments, which would allow turning them off for specific
  # docstrings.
  &quot;D207&quot;, # (under-indented docstring)
  &quot;D208&quot;, # (over-indented docstring)
  &quot;D402&quot;, # (first line should not be the function&#x27;s &quot;signature&quot;)
]

[tool.ruff.pydocstyle]
convention = &quot;google&quot;
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ssbarnea">@ssbarnea</a> on 2023-04-29 10:27</div>
            <div class="timeline-body"><p>The situation seem to be worse for those deciding to use <code>select = [&quot;ALL&quot;]</code> as apparently you get two warnings that you cannot silence in any way (adding to ignore does not work), neither trying to define <code>convention = &quot;pep257&quot;</code> - even if documentation states that it should work.</p>
<pre><code>warning: `one-blank-line-before-class` (D203) and `no-blank-line-before-class` (D211) are incompatible. Ignoring `one-blank-line-before-class`.
warning: `multi-line-summary-first-line` (D212) and `multi-line-summary-second-line` (D213) are incompatible. Ignoring `multi-line-summary-second-line`.
</code></pre>
<p>Does anyone know a way to keep using ALL and avoid these confusing warnings?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-04-29 16:05</div>
            <div class="timeline-body"><p>@ssbarnea - Do you mind sharing your configuration? For me, I don&#x27;t see any warnings with this <code>pyproject.toml</code>:</p>
<pre><code>[tool.ruff]
select = [&quot;ALL&quot;]

[tool.ruff.pydocstyle]
convention = &quot;pep257&quot;
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ssbarnea">@ssbarnea</a> on 2023-05-16 16:19</div>
            <div class="timeline-body"><p>@charliermarsh Sure, look at https://github.com/ansible/ansible-compat/blob/main/pyproject.toml#L138 -- apparently I get this warning with current ruff too:</p>
<pre><code>$ ruff .
warning: `one-blank-line-before-class` (D203) and `no-blank-line-before-class` (D211) are incompatible. Ignoring `one-blank-line-before-class`.
warning: `multi-line-summary-first-line` (D212) and `multi-line-summary-second-line` (D213) are incompatible. Ignoring `multi-line-summary-second-line`.
 
$ ruff --version
ruff 0.0.267
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-05-16 16:27</div>
            <div class="timeline-body"><p>@ssbarnea - Thanks, I&#x27;ll take a look now.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-05-16 16:31</div>
            <div class="timeline-body"><p>I&#x27;m not seeing those warnings, need to think on why they could be showing up for you:</p>
<pre><code>ansible-compat on ÓÇ† main via üêç v3.8.16
‚ùØ ruff . --no-cache
ansible-compat on ÓÇ† main via üêç v3.8.16
‚ùØ ruff --version
ruff 0.0.267
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-05-16 16:33</div>
            <div class="timeline-body"><p>Could you share the output of <code>ruff --show-settings .</code>, if you have time?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ssbarnea">@ssbarnea</a> on 2023-05-16 19:24</div>
            <div class="timeline-body"><p>Something is confusing ruff, and apparently is not the cache:</p>
<pre><code>ssbarnea@m1: ~/c/a/ansible-compat chore/test
$ ruff .
warning: `one-blank-line-before-class` (D203) and `no-blank-line-before-class` (D211) are incompatible. Ignoring `one-blank-line-before-class`.
warning: `multi-line-summary-first-line` (D212) and `multi-line-summary-second-line` (D213) are incompatible. Ignoring `multi-line-summary-second-line`.

ssbarnea@m1: ~/c/a/ansible-compat chore/test
$ ruff --version
ruff 0.0.267

ssbarnea@m1: ~/c/a/ansible-compat chore/test
$ ruff --no-cache .
warning: `one-blank-line-before-class` (D203) and `no-blank-line-before-class` (D211) are incompatible. Ignoring `one-blank-line-before-class`.
warning: `multi-line-summary-first-line` (D212) and `multi-line-summary-second-line` (D213) are incompatible. Ignoring `multi-line-summary-second-line`.
</code></pre>
<p>Result of settings dump https://gist.github.com/ssbarnea/18819983d585ad1ed674e1a2e2b49616</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-05-16 20:41</div>
            <div class="timeline-body"><p>Is there any way you have something like a <code>ruff.toml</code> or <code>.ruff.toml</code> or <code>pyproject.toml</code> in the filesystem (under <code>ansible-compat</code>) that&#x27;s not tracked by Git? That <em>could</em> trigger this message but wouldn&#x27;t show up with <code>--show-settings</code>.</p>
<p>(Do you not see the warnings when you run <code>--show-settings</code>? Or were they omitted from the settings dump?)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ssbarnea">@ssbarnea</a> on 2023-05-19 10:11</div>
            <div class="timeline-body"><p>You are right, I see the warning without even doing anything:</p>
<pre><code>$ ruff --show-settings
warning: `one-blank-line-before-class` (D203) and `no-blank-line-before-class` (D211) are incompatible. Ignoring `one-blank-line-before-class`.
warning: `multi-line-summary-first-line` (D212) and `multi-line-summary-second-line` (D213) are incompatible. Ignoring `multi-line-summary-second-line`.
error: Expected at least one path to search for Python files
FAIL: 2
</code></pre>
<p>I do not have any other ruff config file in my filesystem other than the git-tracked one at https://github.com/ansible/ansible-lint/blob/main/pyproject.toml#L225-L262</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/tlambert03">@tlambert03</a> on 2023-06-30 10:38</div>
            <div class="timeline-body"><p>just wanna add my +1 to this request.  Specifically, I&#x27;d love to be able to simply add D417 to numpy docstrings.</p>
<pre><code>[tool.ruff]
extend-select = [&quot;D417&quot;]
[tool.ruff.pydocstyle]
convention = &quot;numpy&quot;
</code></pre>
<p>Currently, I do this by manually including the full numpy include/exclude spec just so I can keep D417.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/smackesey">@smackesey</a> on 2023-07-16 20:30</div>
            <div class="timeline-body"><p>Revisiting to say that IMO the current docs are still too uninformative-- if I read https://beta.ruff.rs/docs/settings/#pydocstyle-convention it is not obvious what this does in terms of <code>select</code>/<code>ignore</code>.</p>
<p>If the content from <a href="https://github.com/astral-sh/ruff/issues/2606">astral-sh/ruff#2606</a>#issuecomment-1464451372 were posted in the docs that would go a ways.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-07-17 02:51</div>
            <div class="timeline-body"><p>For now, I expanded on the documentation in #5819.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/alanhdu">@alanhdu</a> on 2023-11-09 03:21</div>
            <div class="timeline-body"><p>I&#x27;ve been taking a look at this and quite surprised by the behavior. From a code POV, I think the fix should be simple: changing
https://github.com/astral-sh/ruff/blob/4760af3dcbcf772fdcc1cae9aa9d0c4b8037c132/crates/ruff_workspace/src/configuration.rs#L891-L893</p>
<p>to something more like:</p>
<pre><code> for rule in convention.rules_to_be_ignored() { 
    if !rules.enabled(*rule) {
        rules.disable(*rule);
    }     
 } 
</code></pre>
<p>which would turn the rules off-by-default but allow users to force override it. My question is whether that would be the right path forward, or if we want something more complicated (e.g. if there are rules that are truly incompatible with a convention, then we can distinguish <code>convention.incompatilbe_rules()</code> from <code>convention.off_by_default_rules()</code>. @charliermarsh -- do you have any guidance on what the desired outcome here is? I&#x27;m happy to send a PR either way.</p>
<p>(I also have, uestions aboutf where these rules for the conventions came from -- I would&#x27;ve expected several of them to have been <em>on</em> by default for the numpy convention at least, but I&#x27;m happy to move that out of this issue&#x27;s discussion).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-11-09 05:00</div>
            <div class="timeline-body"><p>@alanhdu -- Thanks for taking a look! I think the fix isn&#x27;t quite that simple. We probably need some logic like: if the rule wasn&#x27;t <em>explicitly</em> selected (like <code>--select D200</code>, as opposed to <code>--select D</code>), then we should force it off. For each <code>rules_to_be_ignored</code>, we could check if the rule was included verbatim in any of the <code>select</code> or <code>extend_select</code> selectors?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/alanhdu">@alanhdu</a> on 2023-11-09 17:42</div>
            <div class="timeline-body"><p>Yeah, I agree this is a little trickier than I first thought. I filed <a href="https://github.com/astral-sh/ruff/pull/8586">astral-sh/ruff#8586</a> with what I think is a reasonable approach -- would be happy to discuss more about the implementation there!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-11-09 19:31</div>
            <div class="timeline-body"><p>Nice, thanks @alanhdu! Will take a look at that PR later today or tomorrow.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-11-10 18:47</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/tlambert03">@tlambert03</a> on 2023-11-10 18:54</div>
            <div class="timeline-body"><p>hooray!!  Thanks @alanhdu!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sorenmc">@sorenmc</a> on 2024-08-15 09:04</div>
            <div class="timeline-body"><p>For anyone else wanting to add D417 while using numpy convention you have to explicitly include it as</p>
<pre><code>[tool.ruff.lint]
extend-select = [&quot;D&quot;, &lt;other selections&gt;, &quot;D417&quot;]

[tool.ruff.lint.pydocstyle]
convention = &quot;numpy&quot; 
</code></pre>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 18:48:32 UTC
    </footer>
</body>
</html>
