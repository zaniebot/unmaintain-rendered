<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[red-knot] add ecosystem check - astral-sh/ruff #15697</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[red-knot] add ecosystem check</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/issues/15697">#15697</a>
        opened by <a href="https://github.com/carljm">@carljm</a>
        on 2025-01-23 17:18
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a></div>
            <div class="timeline-body"><h3>Description</h3>
<p>We regularly observe the effects of changes to red-knot in the diagnostics emitted when running our (performance) benchmark against tomllib, and sometimes catch issues by seeing new false positives. But a) tomllib is one small codebase, not necessarily representative, and b) the ergonomics of catching these issues in the performance benchmark is poor.</p>
<p>We should select some larger real-world codebases and implement tooling to run red-knot on them and snapshot the diagnostics emitted, such that we can see (and easily update) this snapshot when we make changes to red-knot.</p>
<p>We should run this in CI to ensure our snapshot stays up to date.</p>
<p>(This is very similar to the ruff ecosystem check, and we can likely reuse some of that infrastructure?)</p>
<p>Bonus: if we implement https://github.com/astral-sh/ty/issues/213, we can also track changes to the prevalence of Todo types over time.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by @carljm on 2025-01-23 17:18</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone "Red Knot Q1 2025" by @carljm on 2025-01-23 17:18</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "[red-knot] correctness "benchmark" against real codebases" to "[red-knot] add ecosystem check" by @carljm on 2025-01-23 23:32</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @sharkdp by @sharkdp on 2025-03-07 13:18</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-03-07 13:37</div>
            <div class="timeline-body"><p>Just noting down some thoughts while working on this:</p>
<ul>
<li><p>It would help to have a concise (or structured) diagnostics diagnostics format. <code>mypy_primer</code> uses a simple line-based diff (without context) and it turns out that diffs between two rich-diagnostics red-knot outputs are … not great
<img src="https://github.com/user-attachments/assets/e1aee9ac-41a9-43c8-b8cf-58ce902aa0d8" alt="image" /></p>
<ul>
<li>This is planned in https://github.com/astral-sh/ruff/issues/14194</li>
</ul>
</li>
<li><p>We do still panic on a lot of the projects included in <a href="https://github.com/hauntsaninja/mypy_primer/blob/7543da9b113a282219e43fe36f054219a4a61c38/mypy_primer/projects.py#L74"><code>mypy_primer</code>'s list</a></p>
<ul>
<li>This will likely be fixed by astral-sh/ruff#14029</li>
</ul>
</li>
<li><p>Support for importing from <code>-stubs</code> packages is another thing that would make the ecosystem check more helpful.</p>
<ul>
<li>This is planned in https://github.com/astral-sh/ruff/issues/11653#issuecomment-2446185608</li>
</ul>
</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-03-10 11:23</div>
            <div class="timeline-body"><p>While selecting some projects from mypy_primer, I noted down some issues that appear very frequently across multiple codebases. If we want to work on reducing false positives diagnostics, those would likely be the candidates with the biggest impact:</p>
<ul>
<li>[x] Panics due to salsa cycles =&gt; https://github.com/astral-sh/ruff/pull/14029</li>
<li>[ ] Importing from <code>-stubs</code> packages =&gt; https://github.com/astral-sh/ruff/issues/16612</li>
<li>[ ] <code>lint:unresolved-import</code> and subsequent <code>lint:unresolved-attribute</code> due to <code>*</code>-imports from e.g. <code>collections.abc</code> or <code>asyncio</code> =&gt; https://github.com/astral-sh/ruff/issues/14169</li>
<li>[ ] Consider <code>__all__</code> for re-export convention =&gt; https://github.com/astral-sh/ty/issues/199</li>
<li>[x] Assignability of intersection types (results in e.g. <code>lint:invalid-argument-type</code>) =&gt; https://github.com/astral-sh/ruff/issues/14899</li>
<li>[ ] Incorrect <code>lint:unresolved-reference</code> in the presence of unreachable code =&gt; https://github.com/astral-sh/ruff/issues/15797</li>
<li>[x] <code>lint:unresolved-attribute</code> due to custom <code>__getattr__</code>, e.g. <code>argparse.Namespace</code> =&gt; https://github.com/astral-sh/ruff/issues/16614</li>
<li>[ ] <code>lint:unused-ignore-comment</code> =&gt; Some of these could be a signal for false negatives? Others could just be an indication that we might need a feature to silence those unused <em>generic</em> <code># type: ignore</code> comments</li>
<li>[ ] <code>lint:unresolved-attribute</code> because we don't understand <code>super</code> =&gt; https://github.com/astral-sh/ruff/issues/16615</li>
<li>[ ] Missing understanding of <code>@property</code> =&gt; https://github.com/astral-sh/ruff/issues/16616</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-03-14 21:29</div>
            <div class="timeline-body"><p>I think it's probably fine to close this. At the time of writing, we emit 1935 diagnostics on <code>main</code> when running <code>mypy_primer</code> with the following project selector (current setting in CI):</p>
<pre><code class="language-regex">'/(mypy_primer|black|pyp|git-revise|zipp|arrow|isort|itsdangerous|rich|packaging|pybind11|pyinstrument)$'
</code></pre>
<p>I have merged all those diagnostics into a single text file for a quick analysis: <a href="https://github.com/user-attachments/files/19254794/diagnostics.txt">diagnostics.txt</a></p>
<p>We can group by lint, for example:</p>
<pre><code>▶ cat diagnostics.txt | cut -d' ' -f1 | uniq -c | sort -nr
    494 error[lint:unresolved-import]
    386 error[lint:unresolved-attribute]
    237 warning[lint:possibly-unresolved-reference]
    178 warning[lint:possibly-unbound-attribute]
    162 warning[lint:unresolved-reference]
    120 error[lint:invalid-argument-type]
     84 warning[lint:unused-ignore-comment]
     62 error[lint:invalid-assignment]
     58 error[lint:invalid-return-type]
     38 error[lint:call-non-callable]
     24 error[lint:unsupported-operator]
     21 error[lint:division-by-zero]
     16 error[lint:invalid-base]
     13 error[lint:inconsistent-mro]
     10 error[lint:non-subscriptable]
      8 error[lint:missing-argument]
      7 error[lint:invalid-parameter-default]
      6 error[lint:not-iterable]
      3 warning[lint:call-possibly-unbound-method]
      3 error[lint:invalid-raise]
      2 error[lint:too-many-positional-arguments]
      1 warning[lint:possibly-unbound-import]
      1 error[lint:invalid-type-form]
      1 error[lint:invalid-exception-caught]
</code></pre>
<p>I have looked through most of the more obscure ones (starting this list from the bottom), and haven't found anything surprising. A lot of it comes down to known problems (no generics, no enums, …). The 21 <code>division-by-zero</code> are true positives because apparently <code>rich</code> likes to put <code>1 / 0</code> in their codebase to force a crash(?).</p>
<p>Apart from that, I think the list above is still accurate. The highest impact would still be working on imports, but note that some of these might be true positives (mypy_primer doesn't install all dependencies for a project. there's also no version requirements or similar, so even if a dependency is specified, it could be the wrong version).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @sharkdp on 2025-03-14 21:29</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 16:52:03 UTC
    </footer>
</body>
</html>
