<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>False positive for `PT005` and function returning `Iterator[None]` - astral-sh/ruff #12742</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>False positive for <code>PT005</code> and function returning <code>Iterator[None]</code></h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/issues/12742">#12742</a>
        opened by <a href="https://github.com/ZeeD">@ZeeD</a>
        on 2024-08-08 07:09
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ZeeD">@ZeeD</a></div>
            <div class="timeline-body">

<p>Minimal snippet:</p>
<pre><code>from collections.abc import Iterator

import pytest

@pytest.fixture()
def _my_fixture_none() -&gt; None:
  return

@pytest.fixture()
def _my_fixture_itor() -&gt; Iterator[None]:
  yield

def test_mytest(
  _my_fixture_none: None,
  _my_fixture_itor: None,
):
    ...
</code></pre>
<p>ruff returns error <code>PT005</code> on <code>_my_fixture_itor</code>. It shouldn&#x27;t.</p>
<p>According to https://docs.pytest.org/en/latest/reference/reference.html#pytest-fixture</p>
<blockquote>
<p>Fixtures can provide their values to test functions using return or yield statements. When using yield the code block after the yield statement is executed as teardown code regardless of the test outcome, and must yield exactly once.</p>
</blockquote>
<p>So a fixture that work only by side effect may <code>return</code> <code>None</code> or <code>Iterator[None]</code> - and in fact if you use a fixture that <code>return</code>s <code>Iterator[None]</code> have the variable set to <code>None</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">rule</span> added by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-08-09 01:20</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">needs-decision</span> added by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-08-09 01:20</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-08-09 01:21</div>
            <div class="timeline-body"><p>Is the suggestion that both implicit <code>return</code> and implicit <code>yield</code> (without a value) should be allowed?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-08-09 01:22</div>
            <div class="timeline-body"><p>I don&#x27;t get a PT005 error on this: https://play.ruff.rs/b404e34f-2c6e-4228-a300-cd783adb9980. Can you help me reproduce?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">needs-decision</span> removed by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-08-09 01:22</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">needs-mre</span> added by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-08-09 01:23</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ZeeD">@ZeeD</a> on 2024-08-09 07:25</div>
            <div class="timeline-body"><p>Sorry, it seems there was a fluke from my side.</p>
<p>I got the <code>PT005</code> because in my actual code I have explicit <code>yield None</code>
In fact I see that I can see the <code>PT005</code> if I write</p>
<pre><code>@pytest.fixture
def _my_fixture_none() -&gt; None:
    return None

@pytest.fixture
def _my_fixture_itor() -&gt; Iterator[None]:
    try:
        yield None
    finally:
        ...
</code></pre>
<p>cfr: https://play.ruff.rs/cd4496f2-4176-4a30-8471-8dee0b8d090a</p>
<p>regarding this gh issue, I understand that the explicit <code>None</code> is not necessary, but should be &quot;functionally equivalent&quot; of the bare <code>return</code> and <code>yield</code>, and it seems a bit strange to me how this is related to the <code>PT005</code> itself. In any case I can see that the error was in my code, not in ruff.</p>
<p>Maybe it could be possible to better rephrase the error message / add a note in the documentation page?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-08-15 17:14</div>
            <div class="timeline-body"><p>Thanks for the example!</p>
<p>We decided to deprecate <code>PT005</code> because it has other flaws and isn&#x27;t recommended by the community. I close the issue because we don&#x27;t plan on making improvements to the rule further.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-08-15 17:14</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 18:48:56 UTC
    </footer>
</body>
</html>
