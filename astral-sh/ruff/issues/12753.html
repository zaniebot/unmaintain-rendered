<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UP012 fix does not handle non-bytes escape sequences - astral-sh/ruff #12753</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>UP012 fix does not handle non-bytes escape sequences</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/ruff/issues/12753">#12753</a>
        opened by <a href="https://github.com/dscorbett">@dscorbett</a>
        on 2024-08-08 13:29
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dscorbett">@dscorbett</a></div>
            <div class="timeline-body"><p>When converting string literals to bytes literals, UP012 does not handle escape sequences that are only recognized in string literals. It should convert them to literal characters or to recognized escape sequences.</p>
<pre><code class="language-console">$ ruff --version
ruff 0.5.6
$ cat up012.py
print(&quot;\N{DIGIT ONE}&quot;.encode())
print(&quot;\u0031&quot;.encode())
print(&quot;\U00000031&quot;.encode())
$ python up012.py 
b'1'
b'1'
b'1'
$ ruff check --isolated --select UP012 up012.py --fix
Found 3 errors (3 fixed, 0 remaining).
$ python up012.py
b'\\N{DIGIT ONE}'
b'\\u0031'
b'\\U00000031'
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @charliermarsh on 2024-08-09 01:26</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-08-09 01:27</div>
            <div class="timeline-body"><p>Thanks, seems like a clear bug.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-08-09 01:27</div>
            <div class="timeline-body"><p>Is this done via NFKC normalization?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-08-09 05:08</div>
            <div class="timeline-body"><p>I don't think so. I think the problem is that we're using the raw string in the fix (via the tokens), so Ruff would make the following edit:</p>
<pre><code class="language-diff">-print(&quot;\N{DIGIT ONE}&quot;.encode())
-print(&quot;\u0031&quot;.encode())
-print(&quot;\U00000031&quot;.encode())
+print(b&quot;\N{DIGIT ONE}&quot;)
+print(b&quot;\u0031&quot;)
+print(b&quot;\U00000031&quot;)
</code></pre>
<p>But, we should instead use the string from the AST as it contains the replaced value (https://play.ruff.rs/f858f470-796a-4d4f-bd51-ef36f291b863). This would make the diff as:</p>
<pre><code class="language-diff">-print(&quot;\N{DIGIT ONE}&quot;.encode())
-print(&quot;\u0031&quot;.encode())
-print(&quot;\U00000031&quot;.encode())
+print(b&quot;1&quot;)
+print(b&quot;1&quot;)
+print(b&quot;1&quot;)
</code></pre>
<p>I wonder if this might bring its own set of bugs so it could be better to just ignore bytes with escapes. This is what <code>pyupgrade</code> does as well.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 16:50:49 UTC
    </footer>
</body>
</html>
