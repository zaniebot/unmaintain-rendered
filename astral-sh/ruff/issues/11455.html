<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ruff applies auto-fix in files with syntax errors - astral-sh/ruff #11455</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Ruff applies auto-fix in files with syntax errors</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/issues/11455">#11455</a>
        opened by <a href="https://github.com/Dobatymo">@Dobatymo</a>
        on 2024-05-17 08:06
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Dobatymo">@Dobatymo</a></div>
            <div class="timeline-body"><p>When running <code>ruff format</code> ruff will not modify files if it encounters a <code>SyntaxError</code> (which is expected I think). However running <code>ruff check --fix</code> will encounter the <code>SyntaxError</code> as well, but will continue to &quot;fix&quot; and modify the files. I don&#x27;t know if this is expected, but I find that behaviour surprising.</p>
<ul>
<li>List of keywords you searched for before creating this issue: fix, syntaxerror</li>
</ul>
<p>Code snippet:</p>
<pre><code>typedef struct _STORAGE_DEVICE_NUMBER_EX {
    (&quot;PartitionNumber&quot;, ULONG),
} STORAGE_DEVICE_NUMBER_EX, *PSTORAGE_DEVICE_NUMBER_EX;
</code></pre>
<p><code>ruff check --fix</code> with remove the <code>;</code> at the end of the line (which I didn&#x27;t expect since the file is not actually Python.</p>
<p>Version: ruff 0.4.4 (3e8878a1c 2024-05-09)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-05-17 08:11</div>
            <div class="timeline-body"><p>Can you provide some more details? How are you running Ruff? Is it from the command-line or is it via an editor? If it is in an editor context, could it be that it&#x27;s another extension which is removing the semicolon?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">needs-info</span> added by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-05-17 08:11</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Dobatymo">@Dobatymo</a> on 2024-05-17 08:31</div>
            <div class="timeline-body"><p>Just using the normal command line. Windows 11. I made sure it must be ruff which modifies the file.</p>
<pre><code>error: Failed to parse syntaxerror.py:1:9: Simple statements must be separated by newlines or semicolons
syntaxerror.py:1:9: E999 SyntaxError: Simple statements must be separated by newlines or semicolons
Found 2 errors (1 fixed, 1 remaining).
</code></pre>
<p>That&#x27;s the output.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from &quot;ruff check --fix modifies files with syntaxerror&quot; to &quot;ruff check --fix modifies files with SyntaxError&quot; by <a href="https://github.com/Dobatymo">@Dobatymo</a> on 2024-05-17 08:49</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-05-17 12:19</div>
            <div class="timeline-body"><p>Ruff uses the file extension to determine whether it&#x27;s a Python file or not as otherwise it&#x27;s difficult to reliably determine whether a file contains Python source code or not. It seems that the file name is <code>syntaxerror.py</code> which has the <code>.py</code> extension.</p>
<p>Can you provide us any context as to why do you have a non-Python source code in a Python file?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Dobatymo">@Dobatymo</a> on 2024-05-17 13:56</div>
            <div class="timeline-body"><p>I am working on simple C header to Python ctypes translator. And I was simply using ruff format to check if the files I generated are syntactically correct. I know I could have just used the python builtin parser, but having a nicely formatted file when the translation produced a syntactically valid file was a nice side effect.
Then for further investigation if the generated files are correct, I can <code>ruff check --fix</code> instead and was surprised to see that the file was modified even when it wasn&#x27;t syntactially valid (something <code>ruff format</code> didn&#x27;t do). So if this is expected behaviour this should be documented, but in my opinion it should not do any modifications (just like <code>ruff format</code>).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-05-17 17:56</div>
            <div class="timeline-body"><p>I think we&#x27;ll move <em>more</em> towards Ruff working on files with syntax errors. I&#x27;d recommend either excluding these files from lint checks or selecting <code>E999</code> to only check for syntax errors.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-05-18 17:30</div>
            <div class="timeline-body"><p>I honestly thought we didn&#x27;t apply fixes when a file contains a syntax error (but looks like I&#x27;m wrong). I would be open to changing the behavior, not sure what @dhruvmanila thinks.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-05-20 05:24</div>
            <div class="timeline-body"><p>I think this is the side effect of non-AST based rules which work with tokens, logical lines, etc. And, that Ruff checks all of the tokens up to the first error token. In your case, the <a href="https://play.ruff.rs/a3fdde43-21a3-45f0-9a32-378a9655db69">code produces a valid token stream</a> and so it checks for violations which uses the token stream. Ruff doesn&#x27;t know that this isn&#x27;t a syntactically valid code unless it&#x27;s processed by the parser.</p>
<blockquote>
<p>Then for further investigation if the generated files are correct, I can <code>ruff check --fix</code> instead and was surprised to see that the file was modified even when it wasn&#x27;t syntactially valid (something <code>ruff format</code> didn&#x27;t do).</p>
</blockquote>
<p>The reason <code>ruff format</code> doesn&#x27;t do this is because it works with the AST and the code you mentioned is invalid syntactically.</p>
<blockquote>
<p>I honestly thought we didn&#x27;t apply fixes when a file contains a syntax error (but looks like I&#x27;m wrong).</p>
</blockquote>
<p>This isn&#x27;t exactly possible today because unless the parser processes the token stream, Ruff can&#x27;t know whether it contains a syntax error. And, the code provided by the author produces a valid token stream. This will change during this week when we combine the lexing and parsing step and then Ruff can get this knowledge.</p>
<p>I&#x27;m not opposed to this idea although this does mean that we&#x27;d stop fixing code like the following:</p>
<pre><code>x;

# unterminated f-string
f&quot;hello
</code></pre>
<p>In the future, we <em>do</em> want to make Ruff capable of applying a fix even if the source code contains syntax error. This will be done after we expand Ruff&#x27;s capabilities to allow diagnosing issues in a file containing syntax errors.</p>
<p><strong>td;dr</strong> I&#x27;m more in favor of documenting this behavior rather than disallowing to generate fixes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Dobatymo">@Dobatymo</a> on 2024-05-20 07:11</div>
            <div class="timeline-body"><p>Better documentation sounds good!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">needs-info</span> removed by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-05-20 07:23</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">documentation</span> added by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-05-20 07:23</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-05-20 07:30</div>
            <div class="timeline-body"><p>This seems like good place for the content to be in: https://docs.astral.sh/ruff/linter/#fixes</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-07-01 09:22</div>
            <div class="timeline-body"><p>I think we might have to disable fixes for source code with syntax errors with #11950 because otherwise Ruff could panic or go into infinite auto-fix loop where first auto-fix creates a need for the second auto-fix which then creates a need for the first auto-fix again. This infinite loop can be created quite easily when there&#x27;s a syntax error. For example, <a href="https://github.com/astral-sh/ruff/issues/12094">astral-sh/ruff#12094</a> or between <code>E226</code> and <code>E201</code> for <code>(/</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-07-01 09:26</div>
            <div class="timeline-body"><p>Disabling fixes for token-based rules makse sense to me, unless we have a way to know whether a token range overlaps with a parser error range.</p>
<p>Long term, I think fixing files with syntax errors would be nice but only if the specific code doesn&#x27;t overlap with a syntax error.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-07-01 10:53</div>
            <div class="timeline-body"><blockquote>
<p>Disabling fixes for token-based rules makse sense to me, unless we have a way to know whether a token range overlaps with a parser error range.</p>
</blockquote>
<p>This seems like a good idea although I&#x27;m not sure if that could cover all cases. I guess it might be more useful to look at the logical line for token-based rules and the enclosing AST node for AST-based rules.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-07-01 11:02</div>
            <div class="timeline-body"><blockquote>
<p>Disabling fixes for token-based rules makse sense to me</p>
</blockquote>
<p>I was more thinking of disabling fixes for <em>all</em> rules and not just token-based although it might be ok to keep the fix for line-based rules on.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from &quot;ruff check --fix modifies files with SyntaxError&quot; to &quot;Ruff applies auto-fix in files with syntax errors&quot; by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-07-01 11:16</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">documentation</span> removed by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-07-01 11:17</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">linter</span> added by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-07-01 11:17</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-07-02 08:52</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-07-02 08:52</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 18:48:53 UTC
    </footer>
</body>
</html>
