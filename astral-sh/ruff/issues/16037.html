<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Infinite loop when fixing file with `cast` and format strings - astral-sh/ruff #16037</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Infinite loop when fixing file with <code>cast</code> and format strings</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/issues/16037">#16037</a>
        opened by <a href="https://github.com/qarmin">@qarmin</a>
        on 2025-02-08 09:16
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/qarmin">@qarmin</a></div>
            <div class="timeline-body">Description
<pre><code>ruff 0.9.5+2240 (a29009e4e 2025-02-07)
</code></pre>
<p>command</p>
<pre><code>ruff_normal check problematic_file.py --select ALL --preview --output-format concise --no-cache --fix --unsafe-fixes --isolated
</code></pre>
<p>freeze ruff in</p>
<pre><code>Downloading source file /home/runner/work/Automated-Fuzzer/Automated-Fuzzer/ruff/crates/ruff_python_parser/src/lexer/cursor.rs
0x0000555556d1c611 in ruff_python_parser::lexer::cursor::Cursor::first (self=&lt;optimized out&gt;) at crates/ruff_python_parser/src/lexer/cursor.rs:44                                              
warning: 44	crates/ruff_python_parser/src/lexer/cursor.rs: No such file or directory
(gdb) backtrace
#0  0x0000555556d1c611 in ruff_python_parser::lexer::cursor::Cursor::first (self=&lt;optimized out&gt;) at crates/ruff_python_parser/src/lexer/cursor.rs:44
#1  0x0000555556d1d4c0 in ruff_python_parser::lexer::Lexer::lex_fstring_middle_or_end (self=0x7fffffff31b0) at crates/ruff_python_parser/src/lexer.rs:796
#2  ruff_python_parser::lexer::Lexer::lex_token (self=0x7fffffff31b0) at crates/ruff_python_parser/src/lexer.rs:167
#3  0x0000555556d1cdb5 in ruff_python_parser::lexer::Lexer::next_token (self=0x7fffffff31b0) at crates/ruff_python_parser/src/lexer.rs:156
#4  0x0000555556d25579 in ruff_python_parser::token_source::TokenSource::next_non_trivia_token (self=&lt;error reading variable: Cannot access memory at address 0x0&gt;)
    at crates/ruff_python_parser/src/token_source.rs:142
#5  ruff_python_parser::token_source::TokenSource::peek (self=0x7fffffff31b0) at crates/ruff_python_parser/src/token_source.rs:98
#6  ruff_python_parser::parser::Parser::peek (self=0x7fffffff31b0) at crates/ruff_python_parser/src/parser/mod.rs:295
#7  ruff_python_parser::parser::Parser::parse_binary_expression_or_higher_recursive (self=0x7fffffff31b0, left=..., 
    left_precedence=ruff_python_parser::parser::expression::OperatorPrecedence::Initial, context=..., start=...) at crates/ruff_python_parser/src/parser/expression.rs:264
#8  0x0000555556d2475a in ruff_python_parser::parser::Parser::parse_binary_expression_or_higher (self=0x7fffffff31b0, 
    left_precedence=ruff_python_parser::parser::expression::OperatorPrecedence::Initial, context=...) at crates/ruff_python_parser/src/parser/expression.rs:241
#9  ruff_python_parser::parser::Parser::parse_simple_expression (self=0x7fffffff31b0, context=...) at crates/ruff_python_parser/src/parser/expression.rs:228
#10 ruff_python_parser::parser::Parser::parse_conditional_expression_or_higher_impl (self=0x7fffffff31b0, context=...) at crates/ruff_python_parser/src/parser/expression.rs:205
#11 ruff_python_parser::parser::Parser::parse_expression_list (self=0x7fffffff31b0, context=...) at crates/ruff_python_parser/src/parser/expression.rs:143
#12 0x0000555556d30e68 in ruff_python_parser::parser::Parser::parse_fstring_expression_element (self=0x7fffffff31b0, flags=...) at crates/ruff_python_parser/src/parser/expression.rs:1404
#13 ruff_python_parser::parser::expression::{impl#0}::parse_fstring_elements::{closure#0} (parser=0x7fffffff31b0) at crates/ruff_python_parser/src/parser/expression.rs:1333
#14 ruff_python_parser::parser::Parser::parse_list&lt;ruff_python_parser::parser::expression::{impl#0}::parse_fstring_elements::{closure_env#0}&gt; (self=0x7fffffff31b0, 
    recovery_context_kind=..., parse_element=...) at crates/ruff_python_parser/src/parser/mod.rs:479
#15 ruff_python_parser::parser::Parser::parse_fstring_elements (self=0x7fffffff31b0, flags=..., kind=ruff_python_parser::parser::FStringElementsKind::Regular)
    at crates/ruff_python_parser/src/parser/expression.rs:1330
#16 0x0000555556d2e19f in ruff_python_parser::parser::Parser::parse_fstring (self=0x7fffffff31b0) at crates/ruff_python_parser/src/parser/expression.rs:1307
#17 ruff_python_parser::parser::Parser::parse_strings (self=0x7fffffff31b0) at crates/ruff_python_parser/src/parser/expression.rs:1099
#18 0x0000555556d26e79 in ruff_python_parser::parser::Parser::parse_atom (self=0x7fffffff31b0) at crates/ruff_python_parser/src/parser/expression.rs:581
#19 ruff_python_parser::parser::Parser::parse_lhs_expression (self=0x7fffffff31b0, left_precedence=ruff_python_parser::parser::expression::OperatorPrecedence::Initial, context=...)
    at crates/ruff_python_parser/src/parser/expression.rs:404
#20 0x0000555556d2473f in ruff_python_parser::parser::Parser::parse_binary_expression_or_higher (self=0x7fffffff31b0, 
    left_precedence=ruff_python_parser::parser::expression::OperatorPrecedence::Initial, context=...) at crates/ruff_python_parser/src/parser/expression.rs:240
#21 ruff_python_parser::parser::Parser::parse_simple_expression (self=0x7fffffff31b0, context=...) at crates/ruff_python_parser/src/parser/expression.rs:228
#22 ruff_python_parser::parser::Parser::parse_conditional_expression_or_higher_impl (self=0x7fffffff31b0, context=...) at crates/ruff_python_parser/src/parser/expression.rs:205
#23 ruff_python_parser::parser::Parser::parse_expression_list (self=0x7fffffff31b0, context=...) at crates/ruff_python_parser/src/parser/expression.rs:143
#24 0x0000555556d57266 in ruff_python_parser::parser::Parser::parse_single_expression (self=0x7fffffff31b0) at crates/ruff_python_parser/src/parser/mod.rs:96
#25 ruff_python_parser::parser::Parser::parse (self=...) at crates/ruff_python_parser/src/parser/mod.rs:78
#26 0x00005555567a23e2 in ruff_python_parser::parse_expression (source=...) at crates/ruff_python_parser/src/lib.rs:136
#27 ruff_linter::rules::ruff::rules::missing_fstring_syntax::should_be_fstring (locator=&lt;optimized out&gt;, semantic=0x7fffffff42f0, literal=&lt;optimized out&gt;)
    at crates/ruff_linter/src/rules/ruff/rules/missing_fstring_syntax.rs:177
#28 ruff_linter::rules::ruff::rules::missing_fstring_syntax::missing_fstring_syntax (checker=0x7fffffff42b0, literal=&lt;optimized out&gt;)
    at crates/ruff_linter/src/rules/ruff/rules/missing_fstring_syntax.rs:107
#29 0x000055555694d11c in ruff_linter::checkers::ast::analyze::expression::expression (expr=&lt;optimized out&gt;, checker=0x7fffffff42b0)
    at crates/ruff_linter/src/checkers/ast/analyze/expression.rs:1541
#30 0x000055555676f6fe in ruff_linter::checkers::ast::{impl#5}::visit_expr (self=0x7fffffff42b0, expr=0x7ffff792e000) at crates/ruff_linter/src/checkers/ast/mod.rs:1656
#31 0x000055555676fde7 in ruff_linter::checkers::ast::Checker::visit_type_definition (self=0x7fffffff42b0, expr=0x7ffff792e000) at crates/ruff_linter/src/checkers/ast/mod.rs:1989
#32 ruff_linter::checkers::ast::{impl#5}::visit_expr (self=0x7fffffff42b0, expr=0x7ffff782c180) at crates/ruff_linter/src/checkers/ast/mod.rs:1344
#33 0x000055555676db74 in ruff_linter::checkers::ast::{impl#5}::visit_stmt (self=&lt;optimized out&gt;, stmt=0x7ffff7884e78) at crates/ruff_linter/src/checkers/ast/mod.rs:1082
#34 0x0000555556773c61 in ruff_linter::checkers::ast::{impl#5}::visit_body (self=0x7fffffff42b0, body=...) at crates/ruff_linter/src/checkers/ast/mod.rs:1768
#35 ruff_linter::checkers::ast::Checker::visit_deferred_functions (self=0x7fffffff42b0) at crates/ruff_linter/src/checkers/ast/mod.rs:2506
#36 ruff_linter::checkers::ast::Checker::visit_deferred (self=0x7fffffff42b0) at crates/ruff_linter/src/checkers/ast/mod.rs:2546
#37 ruff_linter::checkers::ast::check_ast (parsed=&lt;optimized out&gt;, locator=&lt;optimized out&gt;, stylist=&lt;optimized out&gt;, indexer=&lt;optimized out&gt;, noqa_line_for=&lt;optimized out&gt;, 
    settings=0x7fffffff8c18, noqa=&lt;optimized out&gt;, path=..., package=..., source_type=ruff_python_ast::PySourceType::Python, cell_offsets=..., notebook_index=...)
    at crates/ruff_linter/src/checkers/ast/mod.rs:2715
#38 0x0000555556778b9c in ruff_linter::linter::check_path (path=..., package=..., locator=&lt;optimized out&gt;, stylist=&lt;optimized out&gt;, indexer=&lt;optimized out&gt;, directives=&lt;optimized out&gt;, 
    settings=&lt;optimized out&gt;, noqa=&lt;optimized out&gt;, source_kind=&lt;optimized out&gt;, source_type=&lt;optimized out&gt;, parsed=&lt;optimized out&gt;) at crates/ruff_linter/src/linter.rs:148
#39 0x000055555677a787 in ruff_linter::linter::lint_fix (path=..., package=..., noqa=&lt;optimized out&gt;, unsafe_fixes=&lt;optimized out&gt;, settings=&lt;optimized out&gt;, source_kind=&lt;optimized out&gt;, 
    source_type=&lt;optimized out&gt;) at crates/ruff_linter/src/linter.rs:513
#40 0x00005555564ea7c4 in ruff::diagnostics::lint_path (path=..., package=..., settings=0x7fffffff8c18, cache=..., noqa=&lt;optimized out&gt;, fix_mode=&lt;optimized out&gt;, 
    unsafe_fixes=&lt;optimized out&gt;) at crates/ruff/src/diagnostics.rs:278
#41 0x00005555564fd705 in ruff::commands::check::lint_path::{closure#0} () at crates/ruff/src/commands/check.rs:195
#42 std::panicking::try::do_call&lt;ruff::commands::check::lint_path::{closure_env#0}, core::result::Result&lt;ruff::diagnostics::Diagnostics, anyhow::Error&gt;&gt; (
    data=&lt;error reading variable: Cannot access memory at address 0x0&gt;)
    at /home/runner/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std/src/panicking.rs:587
#43 std::panicking::try&lt;core::result::Result&lt;ruff::diagnostics::Diagnostics, anyhow::Error&gt;, ruff::commands::check::lint_path::{closure_env#0}&gt; (f=...)
    at /home/runner/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std/src/panicking.rs:550
#44 std::panic::catch_unwind&lt;ruff::commands::check::lint_path::{closure_env#0}, core::result::Result&lt;ruff::diagnostics::Diagnostics, anyhow::Error&gt;&gt; (f=...)
    at /home/runner/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std/src/panic.rs:358
#45 ruff_db::panic::catch_unwind&lt;ruff::commands::check::lint_path::{closure_env#0}, core::result::Result&lt;ruff::diagnostics::Diagnostics, anyhow::Error&gt;&gt; (f=...)
    at crates/ruff_db/src/panic.rs:83
#46 0x000055555640ad65 in ruff::commands::check::lint_path (path=..., package=&lt;error reading variable: Cannot access memory at address 0x5c&gt;, settings=0x7fff12d53f53, cache=..., 
    noqa=ruff_linter::settings::flags::Noqa::Enabled, fix_mode=ruff_linter::settings::flags::FixMode::Apply, unsafe_fixes=ruff_linter::settings::types::UnsafeFixes::Enabled)
    at crates/ruff/src/commands/check.rs:194
#47 0x0000555556541386 in ruff::commands::check::check::{closure#0} (resolved_file=&lt;error reading variable: Cannot access memory at address 0x0&gt;) at crates/ruff/src/commands/check.rs:96
#48 rayon::iter::filter_map::{impl#6}::consume&lt;&amp;core::result::Result&lt;ruff_workspace::resolver::ResolvedFile, ignore::Error&gt;, ruff::diagnostics::Diagnostics, rayon::iter::fold::FoldFolder&lt;rayon::iter::reduce::ReduceFolder&lt;ruff::commands::check::check::{closure_env#4}, (ruff::diagnostics::Diagnostics, u64)&gt;, (ruff::diagnostics::Diagnostics, u64), ruff::commands::check::check::{closure_env#2}&gt;, ruff::commands::check::check::{closure_env#0}&gt; (self=..., item=&lt;optimized out&gt;)
    at /home/runner/.cargo/registry/src/index.crates.io-1949cf8c6b5b557f/rayon-1.10.0/src/iter/filter_map.rs:123
#49 rayon::iter::plumbing::Folder::consume_iter&lt;rayon::iter::filter_map::FilterMapFolder&lt;rayon::iter::fold::FoldFolder&lt;rayon::iter::reduce::ReduceFolder&lt;ruff::commands::check::check::{closure_env#4}, (ruff::diagnostics::Diagnostics, u64)&gt;, (ruff::diagnostics::Diagnostics, u64), ruff::commands::check::check::{closure_env#2}&gt;, ruff::commands::check::check::{closure_env#0}&gt;, &amp;core::result::Result&lt;ruff_workspace::resolver::ResolvedFile, ignore::Error&gt;, core::slice::iter::Iter&lt;core::result::Result&lt;ruff_workspace::resolver::ResolvedFile, ignore::Error&gt;&gt;&gt; (self=..., 
    iter=...) at /home/runner/.cargo/registry/src/index.crates.io-1949cf8c6b5b557f/rayon-1.10.0/src/iter/plumbing/mod.rs:178
#50 rayon::iter::plumbing::Producer::fold_with&lt;rayon::slice::IterProducer&lt;core::result::Result&lt;ruff_workspace::resolver::ResolvedFile, ignore::Error&gt;&gt;, rayon::iter::filter_map::FilterMapFolder&lt;rayon::iter::fold::FoldFolder&lt;rayon::iter::reduce::ReduceFolder&lt;ruff::commands::check::check::{closure_env#4}, (ruff::diagnostics::Diagnostics, u64)&gt;, (ruff::diagnostics::Diagnostics, u64), ruff::commands::check::check::{closure_env#2}&gt;, ruff::commands::check::check::{closure_env#0}&gt;&gt; (self=..., folder=...)
    at /home/runner/.cargo/registry/src/index.crates.io-1949cf8c6b5b557f/rayon-1.10.0/src/iter/plumbing/mod.rs:109
#51 0x000055555651ba9d in rayon::iter::plumbing::bridge_producer_consumer::helper&lt;rayon::slice::IterProducer&lt;core::result::Result&lt;ruff_workspace::resolver::ResolvedFile, ignore::Error&gt;&gt;, rayon::iter::filter_map::FilterMapConsumer&lt;rayon::iter::fold::FoldConsumer&lt;rayon::iter::reduce::ReduceConsumer&lt;ruff::commands::check::check::{closure_env#4}, ruff::commands::check::check::{closure_env#3}&gt;, ruff::commands::check::check::{closure_env#1}, ruff::commands::check::check::{closure_env#2}&gt;, ruff::commands::check::check::{closure_env#0}&gt;&gt; (len=1, migrated=&lt;optimized out&gt;, 
    splitter=..., producer=..., consumer=...) at /home/runner/.cargo/registry/src/index.crates.io-1949cf8c6b5b557f/rayon-1.10.0/src/iter/plumbing/mod.rs:437
#52 0x000055555640a1ad in rayon::iter::plumbing::bridge_producer_consumer&lt;rayon::slice::IterProducer&lt;core::result::Result&lt;ruff_workspace::resolver::ResolvedFile, ignore::Error&gt;&gt;, rayon::iter::filter_map::FilterMapConsumer&lt;rayon::iter::fold::FoldConsumer&lt;rayon::iter::reduce::ReduceConsumer&lt;ruff::commands::check::check::{closure_env#4}, ruff::commands::check::check::{closure_env#3}&gt;, ruff::commands::check::check::{closure_env#1}, ruff::commands::check::check::{closure_env#2}&gt;, ruff::commands::check::check::{closure_env#0}&gt;&gt; (len=1, 
    producer=&lt;error reading variable: access outside bounds of object referenced via synthetic pointer&gt;, consumer=...)
    at /home/runner/.cargo/registry/src/index.crates.io-1949cf8c6b5b557f/rayon-1.10.0/src/iter/plumbing/mod.rs:396
#53 rayon::iter::plumbing::bridge::{impl#0}::callback&lt;rayon::iter::filter_map::FilterMapConsumer&lt;rayon::iter::fold::FoldConsumer&lt;rayon::iter::reduce::ReduceConsumer&lt;ruff::commands::check::check::{closure_env#4}, ruff::commands::check::check::{closure_env#3}&gt;, ruff::commands::check::check::{closure_env#1}, ruff::commands::check::check::{closure_env#2}&gt;, ruff::commands::check::check::{closure_env#0}&gt;, &amp;core::result::Result&lt;ruff_workspace::resolver::ResolvedFile, ignore::Error&gt;, rayon::slice::IterProducer&lt;core::result::Result&lt;ruff_workspace::resolver::ResolvedFile, ignore::Error&gt;&gt;&gt; (self=&lt;error reading variable: access outside bounds of object referenced via synthetic pointer&gt;, 
    producer=&lt;error reading variable: access outside bounds of object referenced via synthetic pointer&gt;)
    at /home/runner/.cargo/registry/src/index.crates.io-1949cf8c6b5b557f/rayon-1.10.0/src/iter/plumbing/mod.rs:372
#54 rayon::slice::{impl#6}::with_producer&lt;core::result::Result&lt;ruff_workspace::resolver::ResolvedFile, ignore::Error&gt;, rayon::iter::plumbing::bridge::Callback&lt;rayon::iter::filter_map::FilterMapConsumer&lt;rayon::iter::fold::FoldConsumer&lt;rayon::iter::reduce::ReduceConsumer&lt;ruff::commands::check::check::{closure_env#4}, ruff::commands::check::check::{closure_env#3}&gt;, ruff::commands::check::check::{closure_env#1}, ruff::commands::check::check::{closure_env#2}&gt;, ruff::commands::check::check::{closure_env#0}&gt;&gt;&gt; (self=..., 
    callback=&lt;error reading variable: access outside bounds of object referenced via synthetic pointer&gt;)
    at /home/runner/.cargo/registry/src/index.crates.io-1949cf8c6b5b557f/rayon-1.10.0/src/slice/mod.rs:826
#55 rayon::iter::plumbing::bridge&lt;rayon::slice::Iter&lt;core::result::Result&lt;ruff_workspace::resolver::ResolvedFile, ignore::Error&gt;&gt;, rayon::iter::filter_map::FilterMapConsumer&lt;rayon::iter::fold::FoldConsumer&lt;rayon::iter::reduce::ReduceConsumer&lt;ruff::commands::check::check::{closure_env#4}, ruff::commands::check::check::{closure_env#3}&gt;, ruff::commands::check::check::{closure_env#1}, ruff::commands::check::check::{closure_env#2}&gt;, ruff::commands::check::check::{closure_env#0}&gt;&gt; (par_iter=..., consumer=...)
    at /home/runner/.cargo/registry/src/index.crates.io-1949cf8c6b5b557f/rayon-1.10.0/src/iter/plumbing/mod.rs:356
#56 rayon::slice::{impl#5}::drive_unindexed&lt;core::result::Result&lt;ruff_workspace::resolver::ResolvedFile, ignore::Error&gt;, rayon::iter::filter_map::FilterMapConsumer&lt;rayon::iter::fold::FoldConsumer&lt;rayon::iter::reduce::ReduceConsumer&lt;ruff::commands::check::check::{closure_env#4}, ruff::commands::check::check::{closure_env#3}&gt;, ruff::commands::check::check::{closure_env#1}, ruff::commands::check::check::{closure_env#2}&gt;, ruff::commands::check::check::{closure_env#0}&gt;&gt; (self=..., consumer=...)
    at /home/runner/.cargo/registry/src/index.crates.io-1949cf8c6b5b557f/rayon-1.10.0/src/slice/mod.rs:802
#57 rayon::iter::filter_map::{impl#2}::drive_unindexed&lt;rayon::slice::Iter&lt;core::result::Result&lt;ruff_workspace::resolver::ResolvedFile, ignore::Error&gt;&gt;, ruff::commands::check::check::{closure_env#0}, ruff::diagnostics::Diagnostics, rayon::iter::fold::FoldConsumer&lt;rayon::iter::reduce::ReduceConsumer&lt;ruff::commands::check::check::{closure_env#4}, ruff::commands::check::check::{closure_env#3}&gt;, ruff::commands::check::check::{closure_env#1}, ruff::commands::check::check::{closure_env#2}&gt;&gt; (self=..., consumer=...)
    at /home/runner/.cargo/registry/src/index.crates.io-1949cf8c6b5b557f/rayon-1.10.0/src/iter/filter_map.rs:46
#58 rayon::iter::fold::{impl#2}::drive_unindexed&lt;(ruff::diagnostics::Diagnostics, u64), rayon::iter::filter_map::FilterMap&lt;rayon::slice::Iter&lt;core::result::Result&lt;ruff_workspace::resolver::ResolvedFile, ignore::Error&gt;&gt;, ruff::commands::check::check::{closure_env#0}&gt;, ruff::commands::check::check::{closure_env#1}, ruff::commands::check::check::{closure_env#2}, rayon::iter::reduce::ReduceConsumer&lt;ruff::commands::check::check::{closure_env#4}, ruff::commands::check::check::{closure_env#3}&gt;&gt; (self=..., consumer=...)
    at /home/runner/.cargo/registry/src/index.crates.io-1949cf8c6b5b557f/rayon-1.10.0/src/iter/fold.rs:59
#59 rayon::iter::reduce::reduce&lt;rayon::iter::fold::Fold&lt;rayon::iter::filter_map::FilterMap&lt;rayon::slice::Iter&lt;core::result::Result&lt;ruff_workspace::resolver::ResolvedFile, ignore::Error&gt;&gt;, ruff::commands::check::check::{closure_env#0}&gt;, ruff::commands::check::check::{closure_env#1}, ruff::commands::check::check::{closure_env#2}&gt;, ruff::commands::check::check::{closure_env#4}, ruff::commands::check::check::{closure_env#3}, (ruff::diagnostics::Diagnostics, u64)&gt; (pi=..., identity=..., reduce_op=...)
    at /home/runner/.cargo/registry/src/index.crates.io-1949cf8c6b5b557f/rayon-1.10.0/src/iter/reduce.rs:15
#60 rayon::iter::ParallelIterator::reduce&lt;rayon::iter::fold::Fold&lt;rayon::iter::filter_map::FilterMap&lt;rayon::slice::Iter&lt;core::result::Result&lt;ruff_workspace::resolver::ResolvedFile, ignore::Error&gt;&gt;, ruff::commands::check::check::{closure_env#0}&gt;, ruff::commands::check::check::{closure_env#1}, ruff::commands::check::check::{closure_env#2}&gt;, ruff::commands::check::check::{closure_env#4}, ruff::commands::check::check::{closure_env#3}&gt; (self=...) at /home/runner/.cargo/registry/src/index.crates.io-1949cf8c6b5b557f/rayon-1.10.0/src/iter/mod.rs:998
#61 ruff::commands::check::check (files=..., pyproject_config=&lt;optimized out&gt;, config_arguments=&lt;optimized out&gt;, cache=&lt;optimized out&gt;, noqa=ruff_linter::settings::flags::Noqa::Enabled, 
    fix_mode=ruff_linter::settings::flags::FixMode::Apply, unsafe_fixes=ruff_linter::settings::types::UnsafeFixes::Enabled) at crates/ruff/src/commands/check.rs:166
#62 0x000055555645b9a4 in ruff::check (args=..., global_options=...) at crates/ruff/src/lib.rs:423
#63 0x000055555645843b in ruff::run () at crates/ruff/src/lib.rs:195
#64 0x0000555556592838 in ruff::main () at crates/ruff/src/main.rs:44

</code></pre>
<p>File content</p>
<pre><code>def _():
    ne_ite=()
    cast(&quot;%s&quot;%ne_ite)
from typing import(cast)
</code></pre>
<p>File - <a href="https://github.com/user-attachments/files/18717724/a.py.zip">a.py.zip</a></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-02-08 14:00</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">parser</span> added by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-02-08 15:47</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">parser</span> removed by <a href="https://github.com/dylwil3">@dylwil3</a> on 2025-02-08 23:20</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">rule</span> added by <a href="https://github.com/dylwil3">@dylwil3</a> on 2025-02-08 23:20</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">fixes</span> added by <a href="https://github.com/dylwil3">@dylwil3</a> on 2025-02-08 23:20</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from &quot;Freeze when fixing file inside `ruff_python_parser`&quot; to &quot;Infinite loop when fixing file with `cast` and format strings&quot; by <a href="https://github.com/dylwil3">@dylwil3</a> on 2025-02-08 23:22</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">preview</span> added by <a href="https://github.com/dylwil3">@dylwil3</a> on 2025-02-08 23:24</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dylwil3">@dylwil3</a> on 2025-02-08 23:27</div>
            <div class="timeline-body"><p>A fun puzzle!</p>
<p>This turns out to be an infinite loop and unrelated to the parser. The original example has a more minimal reproduction with just enabling <code>TC006</code>,<code>UP031</code>,<code>UP032</code>, and <code>RUF027</code>. The <code>UP</code> rules just serve to turn the format strings into an f-string, so the real problem is the interaction between <code>TC006</code> and <code>RUF027</code>: the former adds quotes around the f-string, and the latter turns the string to an f-string... ad infinitum.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-02-09 13:12</div>
            <div class="timeline-body"><p>Brilliant work @dylwil3. How did you narrow that down?!</p>
<p>A minimal repro here, then, is to run <code>ruff check --no-cache foo.py --select=TC006,RUF027 --diff --unsafe-fixes --isolated --preview</code>, where <code>foo.py</code> has these contents:</p>
<pre><code>from typing import cast

x = 42
cast(f&quot;{x}&quot;)
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dylwil3">@dylwil3</a> on 2025-02-09 16:11</div>
            <div class="timeline-body"><blockquote>
<p>Brilliant work @dylwil3. How did you narrow that down?!</p>
</blockquote>
<p>By an embarrassingly manual binary search ðŸ˜… ... it helped that at some point I guessed it was a loop and turned the max iterations down to 10 so I could reproduce more quickly.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/dylwil3">@dylwil3</a> on 2025-02-09 16:16</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 18:49:28 UTC
    </footer>
</body>
</html>
