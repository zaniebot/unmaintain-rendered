<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>New rule: Unnecessary unicode escape character - astral-sh/ruff #15056</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>New rule: Unnecessary unicode escape character</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/ruff/issues/15056">#15056</a>
        opened by <a href="https://github.com/un-pogaz">@un-pogaz</a>
        on 2024-12-19 10:46
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/un-pogaz">@un-pogaz</a></div>
            <div class="timeline-body"><p>Since Python3 is all UTF-8 by default, use explicit unicode escape is unnecessary. So a suggest to add 3 rules to control and check their presence (UP category).</p>
<ul>
<li>UP*** unnecessary 16-bit unicode escape character (<code>\u0394</code>)</li>
<li>UP*** unnecessary 32-bit unicode escape character (<code>\U00000394</code>)</li>
<li>UP*** unnecessary named unicode character (<code>\N{GREEK CAPITAL LETTER DELTA}</code>)</li>
</ul>
<p>Note that some codepoints should probably be excluded and not raising a errors, like all the characters in the &quot;Private Use Area&quot; block, range E000-F8FF.</p>
<hr>

<p>Additionaly, this three rules can certainly be fixable with <code>--fix</code> option, by converting the unicode escape to their character.</p>
<ul>
<li><p>The codepoints U+0000, U+0009, U+000A and U+000D should converted to their standard escape representation (<code>\0</code>, <code>\t</code>, <code>\n</code>, <code>\r</code>). The character in the range <code>0001-0008, 000B, 000C, 000E-001F, 007F-00A0, 00AD</code> should converted to their hexadecimal representation <code>\x00</code>, and only under the flag <code>--unsafe-fixes</code>.</p>
</li>
<li><p>The correspondence of &#x27;named&#x27; format and their character can easily be found in the <a href="https://www.unicode.org/Public/UCD/latest/ucd/NamesList.txt">table of unicode standard name</a>, but this represents almost 2 Mo of data to append (compressed to ~796 Ko) for a rare case, BUT as it is extremely unlikely that anyone used a &#x27;named unicode&#x27; for a character above U+FFFF, so we can probably cut out to only include the range below U+FFFF (still 880 Ko to append, compressed to ~384 Ko). Also note that the character name under bracket can be any case.</p>
</li>
<li><p>This could become a little complex  because some codepoints have no associated character and/or must be kept in their unicode escape form to avoid corrupting the file.</p>
</li>
</ul>

Range of currently obligatory unicode escape

<p><code>0378-0379, 0380-0383, 038B, 038D, 03A2, 0530, 0557-0558, 058B-058C, 0590, 05C8-05CF, 05EB-05EE, 05F5-0605, 061C, 06DD, 070E-070F, 074B-074C, 07B2-07BF, 07FB-07FC, 082E-082F, 083F, 085C-085D, 085F, 086B-086F, 088F-0897, 08E2, 0984, 098D-098E, 0991-0992, 09A9, 09B1, 09B3-09B5, 09BA-09BB, 09C5-09C6, 09C9-09CA, 09CF-09D6, 09D8-09DB, 09DE, 09E4-09E5, 09FF-0A00, 0A04, 0A0B-0A0E, 0A11-0A12, 0A29, 0A31, 0A34, 0A37, 0A3A-0A3B, 0A3D, 0A43-0A46, 0A49-0A4A, 0A4E-0A50, 0A52-0A58, 0A5D, 0A5F-0A65, 0A77-0A80, 0A84, 0A8E, 0A92, 0AA9, 0AB1, 0AB4, 0ABA-0ABB, 0AC6, 0ACA, 0ACE-0ACF, 0AD1-0ADF, 0AE4-0AE5, 0AF2-0AF8, 0B00, 0B04, 0B0D-0B0E, 0B11-0B12, 0B29, 0B31, 0B34, 0B3A-0B3B, 0B45-0B46, 0B49-0B4A, 0B4E-0B54, 0B58-0B5B, 0B5E, 0B64-0B65, 0B78-0B81, 0B84, 0B8B-0B8D, 0B91, 0B96-0B98, 0B9B, 0B9D, 0BA0-0BA2, 0BA5-0BA7, 0BAB-0BAD, 0BBA-0BBD, 0BC3-0BC5, 0BC9, 0BCE-0BCF, 0BD1-0BD6, 0BD8-0BE5, 0BFB-0BFF, 0C0D, 0C11, 0C29, 0C3A-0C3B, 0C45, 0C49, 0C4E-0C54, 0C57, 0C5B-0C5C, 0C5E-0C5F, 0C64-0C65, 0C70-0C76, 0C8D, 0C91, 0CA9, 0CB4, 0CBA-0CBB, 0CC5, 0CC9, 0CCE-0CD4, 0CD7-0CDC, 0CDF, 0CE4-0CE5, 0CF0, 0CF4-0CFF, 0D0D, 0D11, 0D45, 0D49, 0D50-0D53, 0D64-0D65, 0D80, 0D84, 0D97-0D99, 0DB2, 0DBC, 0DBE-0DBF, 0DC7-0DC9, 0DCB-0DCE, 0DD5, 0DD7, 0DE0-0DE5, 0DF0-0DF1, 0DF5-0E00, 0E3B-0E3E, 0E5C-0E80, 0E83, 0E85, 0E8B, 0EA4, 0EA6, 0EBE-0EBF, 0EC5, 0EC7, 0ECF, 0EDA-0EDB, 0EE0-0EFF, 0F48, 0F6D-0F70, 0F98, 0FBD, 0FCD, 0FDB-0FFF, 10C6, 10C8-10CC, 10CE-10CF, 1249, 124E-124F, 1257, 1259, 125E-125F, 1289, 128E-128F, 12B1, 12B6-12B7, 12BF, 12C1, 12C6-12C7, 12D7, 1311, 1316-1317, 135B-135C, 137D-137F, 139A-139F, 13F6-13F7, 13FE-13FF, 1680, 169D-169F, 16F9-16FF, 1716-171E, 1737-173F, 1754-175F, 176D, 1771, 1774-177F, 17DE-17DF, 17EA-17EF, 17FA-17FF, 180E, 181A-181F, 1879-187F, 18AB-18AF, 18F6-18FF, 191F, 192C-192F, 193C-193F, 1941-1943, 196E-196F, 1975-197F, 19AC-19AF, 19CA-19CF, 19DB-19DD, 1A1C-1A1D, 1A5F, 1A7D-1A7E, 1A8A-1A8F, 1A9A-1A9F, 1AAE-1AAF, 1ACF-1AFF, 1B4D-1B4F, 1B7F, 1BF4-1BFB, 1C38-1C3A, 1C4A-1C4C, 1C89-1C8F, 1CBB-1CBC, 1CC8-1CCF, 1CFB-1CFF, 1F16-1F17, 1F1E-1F1F, 1F46-1F47, 1F4E-1F4F, 1F58, 1F5A, 1F5C, 1F5E, 1F7E-1F7F, 1FB5, 1FC5, 1FD4-1FD5, 1FDC, 1FF0-1FF1, 1FF5, 1FFF-200F, 2028-202F, 205F-206F, 2072-2073, 208F, 209D-209F, 20C1-20CF, 20F1-20FF, 218C-218F, 2427-243F, 244B-245F, 2B74-2B75, 2B96, 2CF4-2CF8, 2D26, 2D28-2D2C, 2D2E-2D2F, 2D68-2D6E, 2D71-2D7E, 2D97-2D9F, 2DA7, 2DAF, 2DB7, 2DBF, 2DC7, 2DCF, 2DD7, 2DDF, 2E5E-2E7F, 2E9A, 2EF4-2EFF, 2FD6-2FEF, 2FFC-3000, 3040, 3097-3098, 3100-3104, 3130, 318F, 31E4-31EF, 321F, A48D-A48F, A4C7-A4CF, A62C-A63F, A6F8-A6FF, A7CB-A7CF, A7D2, A7D4, A7DA-A7F1, A82D-A82F, A83A-A83F, A878-A87F, A8C6-A8CD, A8DA-A8DF, A954-A95E, A97D-A97F, A9CE, A9DA-A9DD, A9FF, AA37-AA3F, AA4E-AA4F, AA5A-AA5B, AAC3-AADA, AAF7-AB00, AB07-AB08, AB0F-AB10, AB17-AB1F, AB27, AB2F, AB6C-AB6F, ABEE-ABEF, ABFA-ABFF, D7A4-D7AF, D7C7-D7CA, D7FC-F8FF, FA6E-FA6F, FADA-FAFF, FB07-FB12, FB18-FB1C, FB37, FB3D, FB3F, FB42, FB45, FBC3-FBD2, FD90-FD91, FDC8-FDCE, FDD0-FDEF, FE1A-FE1F, FE53, FE67, FE6C-FE6F, FE75, FEFD-FF00, FFBF-FFC1, FFC8-FFC9, FFD0-FFD1, FFD8-FFD9, FFDD-FFDF, FFE7, FFEF-FFFB, FFFE-FFFF</code></p>
<p>Note that this range progamaticly create, don&#x27;t include the &quot;Private Use Area&quot; block (E000-F8FF) that also need to <em>not</em> be converted.</p>


<p>And that only for &#x27;16-bit unicode escape&#x27; character! To avoid any unexpected error, it will be safe to not try to convert a &#x27;32-bit unicode escape&#x27; character that represent a codepoint above FFFF, or only a selection of safely know codepoint above that.</p>
<p>EDIT: Also add a setting <code>ignore-unicode-escapes</code> (string array), and to avoid to manual enter each code point, the entry support range format like &quot;058B-058C&quot;. The default value is to determined.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">needs-decision</span> added by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-12-19 12:02</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-12-19 12:04</div>
            <div class="timeline-body"><p>Thanks for the suggestion and the nice write up!</p>
<p>I think such a rule is too opinionated to add to ruff now and you already point out that it probably shouldn&#x27;t apply to all code. I agree with that because there are cases where it&#x27;s hard to tell two Unicode characters apart, which is why <a href="https://docs.astral.sh/ruff/rules/ambiguous-unicode-character-string/">RUF001</a> exists. A new rule would have to be compatible with RUF001</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/un-pogaz">@un-pogaz</a> on 2024-12-20 11:54</div>
            <div class="timeline-body"><p>I understand clearly from where RUF001 come from and why it exists.</p>
<p>But something about that bother me.
While the example shown is very relevant and demonstrates the purpose of this rule, I think that this rule it is not at all of the case where a string is hard-coded with a ohters language that English. Yes, English need to be prefered when coding, but there is some case, is needed (or just terribly easliest and enough to don&#x27;t care about internationalization/localization) to write a string in a other language. And in this case, the ambiguous unicode characters exist for a reason. And so, use their character instead to have to read the unicode escape it&#x27;s very mutch better.</p>
<p>I want to pointed out that this proposal comes from recent real experience: I&#x27;m doing a major clean-up of an old project. A compatibility migration has been done a long time ago, but large part of the code was left as it in &quot;Py2&quot; and I&#x27;m in the process of doing a complete migration.
And this include <a href="https://github.com/un-pogaz/calibre/commit/98b5f6eb700da999c117ba1c1ac5f28a71d4815f">decoding the unicode-escape... and oh god their was a lot</a>. I had to do it all manually (aka make a very odd script), and the warning about corrupting file is something I&#x27;ve experienced during this.
Once done, and given the number and complexity of some rules implemented and fixeable in Ruff, I thought that this kind of operation was exactly the sort of thing this powerful tool could do.</p>
<p>To go back about the posibility of conflict between my proposoal and RUF001: Ruff already has part of the solution, as it is possible to select very precisely which rules we want to apply in our project, what kind to igniore for each sub-part of them, etc.
Plus, UP and RUF rules are not actived by default, so if the user add them, that means they know what their do and wants to manage them.</p>
<p>If both are selected, when perform a check/linting, Ruff might add/output a additional warning message &quot;The rules RUF001 and UP*** are both selected and can be in conflict&quot; and so, that to the final user to decide wich one need to be apply on each case, and wich one to be ignore.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-12-23 08:26</div>
            <div class="timeline-body"><p>I agree that the rule is useful, and I also agree that <code>RUF001</code> flags too many valid cases because it assumes English and it&#x27;s something we&#x27;re aware of (<a href="https://github.com/astral-sh/ruff/issues/14433">astral-sh/ruff#14433</a>, <a href="https://github.com/astral-sh/ruff/issues/13330">astral-sh/ruff#13330</a>)</p>
<p>That&#x27;s why I think the first step is to revisit RUF001, and then decide on if we can build a rule as suggested by you.</p>
<blockquote>
<p>If both are selected, when perform a check/linting, Ruff might add/output a additional warning message &quot;The rules RUF001 and UP*** are both selected and can be in conflict&quot; and so, that to the final user to decide wich one need to be apply on each case, and wich one to be ignore.</p>
</blockquote>
<p>We prefer not to add any new rules that are conflicting. But there are possibly other ways how this can be avoided, but it requires some careful design</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/eli-schwartz">@eli-schwartz</a> on 2024-12-23 23:56</div>
            <div class="timeline-body"><blockquote>
<p>I want to pointed out that this proposal comes from recent real experience: I&#x27;m doing a major clean-up of an old project. A compatibility migration has been done a long time ago, but large part of the code was left as it in &quot;Py2&quot; and I&#x27;m in the process of doing a complete migration.
And this include <a href="https://github.com/un-pogaz/calibre/commit/98b5f6eb700da999c117ba1c1ac5f28a71d4815f">decoding the unicode-escape... and oh god their was a lot</a>. I had to do it all manually (aka make a very odd script), and the warning about corrupting file is something I&#x27;ve experienced during this.
Once done, and given the number and complexity of some rules implemented and fixeable in Ruff, I thought that this kind of operation was exactly the sort of thing this powerful tool could do.</p>
</blockquote>
<p>Aside: back when I was porting that project to python3, we explicitly excluded the recipes directory since it needs (needed?) to be able to provide dynamic updates to people still on python2 releases, no different from the metadata sources and bookstore code. I suppose the status may have changed recently -- I haven&#x27;t asked @kovidgoyal recently, how much backwards compatibility is wanted. :shrug:</p>
<p>I am generally concerned about the exact change you implemented there, because from a quick glance it includes converting <code>\u2008</code> to <code> </code> which is kind of exactly why RUF001 exists.</p>
<p>I think if a rule was created for unnecessary unicode escape characters, it would make sense to me for such a rule to interpret &quot;unnecessary unicode escape&quot; as &quot;unlikely to cause confusion&quot;, otherwise it would be <em>necessary</em> unicode escapes, or at least &quot;opinionatedly necessary&quot;, so... I don&#x27;t think there&#x27;s any conflict with RUF001, even if you don&#x27;t enable RUF001 but you do enable this proposed new rule it should only suggest changes that wouldn&#x27;t violate RUF001. (If people want to convert all such characters anyway then really this should be a disabled-by-default option.)</p>
<p>Building the necessary confusion tables sounds like a bit of a pain though. :(</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/un-pogaz">@un-pogaz</a> on 2024-12-24 08:44</div>
            <div class="timeline-body"><p>Damn it. Unlike metadata sources and bookstore code, the recipe code is not localy cache saved and entirely dowloaded and compiled in memory, so a miss it. Rollback!</p>
<p>I agree that some unicode escapes are realy more help full that their characters, but this can variated from a project to another, so maybe also add a setting <code>ignore-unicode-escapes</code> (string array). And to avoid to manual enter each code point, the entry support range format like &quot;058B-058C&quot;. The default value is to determined.</p>
<p>And we&#x27;re talking unicode, language and all the package that come with: &quot;pain&quot; is the starting point that precisely unicode try to avoid. A lovely paradox.
I think it will be very difficult to avoid conflict with RUF001, or at least we won&#x27;t get it right the first time.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 18:49:11 UTC
    </footer>
</body>
</html>
