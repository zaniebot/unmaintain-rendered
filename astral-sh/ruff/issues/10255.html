<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>False positive TCH004 - astral-sh/ruff #10255</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>False positive TCH004</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/ruff/issues/10255">#10255</a>
        opened by <a href="https://github.com/tlambert03">@tlambert03</a>
        on 2024-03-06 19:24
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/tlambert03">@tlambert03</a> on 2024-03-06 19:24</div>
            <div class="timeline-body"><p>I occasionally use the following pattern in an <code>__init__</code> when I want to publicly re-export a name (<code>&quot;RiskyExport&quot;</code>) from a sub-module (<code>.dangerous_submodule</code>), without greedily importing that submodule (for example, if it requires an additional module-level dependency that may or may not be installed)</p>
<pre><code class="language-python">from typing import TYPE_CHECKING, Any

__all__ = [&quot;RiskyExport&quot;]

if TYPE_CHECKING:
    from .dangerous_submodule import RiskyExport

def __getattr__(name: str) -&gt; Any:
    if name == &quot;RiskyExport&quot;:
        from .dangerous_submodule import RiskyExport  # here's the actual import

        return RiskyExport
    raise AttributeError(f&quot;module {__name__!r} has no attribute {name!r}&quot;)
</code></pre>
<p>ruff will complain with:</p>
<ul>
<li>Move import <code>.dangerous_submodule. RiskyExport</code> out of type-checking block. Import is used for more than type hinting. Ruff(TCH004)</li>
</ul>
<p>but it's <em>not</em> used for more than type hinting at the top level, because i import it again inside of <code>__getattr__</code> if someone explicitly imports that name.</p>
<p>Note that if I remove <code>RiskyExport</code> from <code>__all__</code>, then the error changes to F401 (imported by unused)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-03-07 08:00</div>
            <div class="timeline-body"><p>That does make sense to me. To summarize what I understand you're suggesting: The idea is to change the heuristic to not flag <code>RiskyExport</code> as runtime type because it gets re-imported as runtime type in all paths referencing the runtime value.</p>
<p>I don't know if we have the capabilities to do this today, because it requires that the analysis is path-sensitive (it doesn't just track whether a symbol is imported and used as typing or runtime type, but doing so for each possible path through your program)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">rule</span> added by @MichaReiser on 2024-03-07 08:01</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/tlambert03">@tlambert03</a> on 2024-03-11 19:48</div>
            <div class="timeline-body"><p>yep, your summarized understanding is correct.  and I agree it is path sensitive, you'd need to check whether the name being used for more than type hinting wasn't available in either its global <em>or</em> local namespace</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 01:30:12 UTC
    </footer>
</body>
</html>
