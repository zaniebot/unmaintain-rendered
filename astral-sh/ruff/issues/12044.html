<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[FALSE NEGATIVE] &quot;S608 Possible SQL injection&quot; - astral-sh/ruff #12044</title>
    <link rel="stylesheet" href="../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../index.html">Back to index</a>
    </div>

    <h1>[FALSE NEGATIVE] &quot;S608 Possible SQL injection&quot;</h1>

    <div class="meta">
        <span class="state state-closed">Closed</span>
        <a href="https://github.com/astral-sh/ruff/issues/12044">#12044</a>
        opened by <a href="https://github.com/mpolyakov-plutoflume">@mpolyakov-plutoflume</a>
        on 2024-06-26 10:59
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/mpolyakov-plutoflume">@mpolyakov-plutoflume</a> on 2024-06-26 10:59</div>
            <div class="timeline-body"><p>Hello.
I'm very exited to migrate our codebase to ruff. However, while doing so I've noticed, that rule <code>S608</code> works different from the corresponding <code>B608</code>.
It only triggers if <code>SELECT</code> is on the same line.
So <code>SELECT * FROM {foo}.table</code> is an error and</p>
<pre><code>SELECT *
FROM {foo}.table
</code></pre>
<p>Is not.</p>
<p>Kind regards, Mikhail</p>
<ul>
<li>B608</li>
<li>S608</li>
<li>sql injection</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @AlexWaygood on 2024-06-26 11:27</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">rule</span> added by @AlexWaygood on 2024-06-26 11:27</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-06-26 11:30</div>
            <div class="timeline-body"><p>I just tried and the rule works as expected for triple-quoted f-strings. Any chance that you're using a line continuation token?</p>
<p>https://play.ruff.rs/1c1c9715-2f69-48e1-9e31-f2edcef405ac</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/mpolyakov-plutoflume">@mpolyakov-plutoflume</a> on 2024-06-26 15:39</div>
            <div class="timeline-body"><p>Than you for a quick reply.
I've added a couple of examples to https://play.ruff.rs/d3adeb3f-9657-4314-8d99-a45d426d6674</p>
<p>Basically, it does not work, when <code>SELECT</code> is on a new line or <code>SELECT</code> and <code>FROM</code> are on different lines.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/bricker">@bricker</a> on 2024-08-12 19:49</div>
            <div class="timeline-body"><p>The rule seems to be sensitive to certain indentation. Here are a few examples where the rule is <em>not</em> triggered but it should be:</p>
<pre><code class="language-python">def sql():
    foo = &quot;foo&quot;

    f&quot;&quot;&quot;
SELECT {foo}
    FROM bar
    &quot;&quot;&quot;
</code></pre>
<pre><code class="language-python">def sql():
    foo = &quot;foo&quot;

    f&quot;&quot;&quot;
    SELECT
        {foo}
    FROM bar
    &quot;&quot;&quot;
</code></pre>
<pre><code class="language-python">def sql():
    foo = &quot;foo&quot;

    f&quot;&quot;&quot;
    SELECT {foo}
    FROM
        bar
    &quot;&quot;&quot;
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-08-13 08:20</div>
            <div class="timeline-body"><blockquote>
<p>The rule seems to be sensitive to certain indentation.</p>
</blockquote>
<p>Yeah, I think the regex is not considering the case where there could be &quot;one or more whitespace characters&quot;:</p>
<p>https://github.com/astral-sh/ruff/blob/7027344dfce3c6ea13d96490e262551026357c1b/crates/ruff_linter/src/rules/flake8_bandit/rules/hardcoded_sql_expression.rs#L13-L16</p>
<p>So, the <code>\s</code> should be <code>\s+</code> instead.</p>
<p>https://regex101.com/r/UPYDXC/2</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-08-13 15:21</div>
            <div class="timeline-body"><p>@dhruvmanila do you plan to PR or should we mark this as a good first issue?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">good first issue</span> added by @dhruvmanila on 2024-08-13 15:56</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/DataEnggNerd">@DataEnggNerd</a> on 2024-08-22 16:10</div>
            <div class="timeline-body"><p>@dhruvmanila Shall I pick this issue?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-08-23 05:00</div>
            <div class="timeline-body"><p>@DataEnggNerd For sure! Thanks</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/DataEnggNerd">@DataEnggNerd</a> on 2024-08-23 20:00</div>
            <div class="timeline-body"><p>Need help here.
I have added <code>\s+</code> before <code>from</code> but it is failing with examples given at https://github.com/astral-sh/ruff/issues/12044#issuecomment-2284789116 during compilation, but being detected at regex101.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/13106.html">astral-sh/ruff#13106</a> on 2024-08-26 09:03</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/DataEnggNerd">@DataEnggNerd</a> on 2024-09-14 13:18</div>
            <div class="timeline-body"><p>@MichaReiser I need a clarity here. As per my understanding based on the documentation <a href="https://bandit.readthedocs.io/en/latest/plugins/b608_hardcoded_sql_expressions.html">here</a>, every SQL statement which have string formatting should be reported with <code>S608</code>. Did I get it right?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-09-16 09:22</div>
            <div class="timeline-body"><p>@DataEnggNerd Yes, the rule ideally flags all SQL statements with as few false positives as possible.</p>
<p>The change mentioned in this issue is that we should <a href="https://github.com/astral-sh/ruff/blob/90e5bc2bd95e15086a3af81589cc2a1af298b6b2/crates/ruff_linter/src/rules/flake8_bandit/rules/hardcoded_sql_expression.rs#L13-L16">re-visit Ruff's regex</a> to allow optional whitespace between the different keywords. It's a non-goal to change how the rule detects SQL expressions significantly.</p>
<p>As reference, the Regex used by bandit</p>
<p>https://github.com/PyCQA/bandit/blob/4ac55dfaaacf2083497831294b2dcd7e679f8428/bandit/plugins/injection_sql.py#L74-L80</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/DataEnggNerd">@DataEnggNerd</a> on 2024-09-17 17:21</div>
            <div class="timeline-body"><p>@MichaReiser Yes, I have started with modifying the regex first and faced some problem with the regex. @dhruvmanila mentioned there is something missing beyond the regex(you can refer closer PR linked to the issue), so i started looking into this. Apologies it is making more time to implement at code.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-09-18 07:11</div>
            <div class="timeline-body"><p>@DataEnggNerd</p>
<p>Playing with it in Regex101, the following should work: <code>(?i)\b(select\s+.*\s+from)</code> https://regex101.com/r/T8ojD0/1</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/13445.html">astral-sh/ruff#13445</a> on 2024-09-22 03:17</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/DataEnggNerd">@DataEnggNerd</a> on 2024-09-22 03:19</div>
            <div class="timeline-body"><p>@MichaReiser  With the changes you suggested, along with the regex from bandit, unfortunately both are not helping.
I have added details in the draft PR - https://github.com/astral-sh/ruff/pull/13445?
Help me out if I am missing something.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/13574.html">astral-sh/ruff#13574</a> on 2024-09-30 17:47</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @MichaReiser on 2024-10-17 05:42</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:28:13 UTC
    </footer>
</body>
</html>
