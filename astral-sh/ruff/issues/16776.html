<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>New C420 code triggers on cases that cannot allow for `fromkeys` - astral-sh/ruff #16776</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>New C420 code triggers on cases that cannot allow for <code>fromkeys</code></h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/issues/16776">#16776</a>
        opened by <a href="https://github.com/facelessuser">@facelessuser</a>
        on 2025-03-16 14:41
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/facelessuser">@facelessuser</a> on 2025-03-16 14:41</div>
            <div class="timeline-body"><h3>Summary</h3>
<p>The new code can be helpful, but can also burn people, especially less experienced coders who aren't paying close attention. The new check doesn't take into consideration the context of the default value.</p>
<p>For instance, consider the example below. We have a dict comprehension which ruff will suggest that <code>fromkeys</code> should be used.</p>
<pre><code class="language-py">&gt;&gt;&gt; d = {'a': 0, 'b': 0, 'c': 0}
&gt;&gt;&gt; d2 = {k: [0] for k in d}
&gt;&gt;&gt; d2['a'][0] = 1
&gt;&gt;&gt; d2
{'a': [1], 'b': [0], 'c': [0]}
</code></pre>
<p>But look what happens if we take its advise:</p>
<pre><code class="language-py">&gt;&gt;&gt; d = {'a': 0, 'b': 0, 'c': 0}
&gt;&gt;&gt; d2 = dict.fromkeys(d, [0])
&gt;&gt;&gt; d2['a'][0] = 1
&gt;&gt;&gt; d2
{'a': [1], 'b': [1], 'c': [1]}
</code></pre>
<p>This suggestion should not be made in this case.</p>
<h3>Version</h3>
<p>ruff 0.11.0</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/facelessuser">@facelessuser</a> on 2025-03-16 14:45</div>
            <div class="timeline-body"><p>Additionally, if I try to ignore it, I get: <code>RUF100 [*] Unused </code>noqa<code>directive (unused:</code>C420<code>)</code>.</p>
<p>I'm not sure why.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a> on 2025-03-16 14:55</div>
            <div class="timeline-body"><p>I can't reproduce the problem:</p>
<pre><code class="language-shell">$ ruff check --isolated --select C420 -
d = {}
d2 = {k: [0] for k in d}
All checks passed!
</code></pre>
<p>The rule <a href="https://github.com/astral-sh/ruff/blob/2de8455e43efc55b2ed302c0bdf4e59744338504/crates/ruff_linter/src/rules/flake8_comprehensions/rules/unnecessary_dict_comprehension_for_iterable.rs#L84-L87">does have a check</a> for this case and it has been there ever since the rule was added in #9613.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/facelessuser">@facelessuser</a> on 2025-03-16 14:58</div>
            <div class="timeline-body"><p>I had two cases that looked similar, and I looked at the wrong one ü§¶üèª. This looks to be my mistake. Thanks for verifying.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @facelessuser on 2025-03-16 14:58</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 11:36:57 UTC
    </footer>
</body>
</html>
