<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[`ruff`] Confusing error message during TOML parsing - astral-sh/ruff #20678</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[<code>ruff</code>] Confusing error message during TOML parsing</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/issues/20678">#20678</a>
        opened by <a href="https://github.com/chirizxc">@chirizxc</a>
        on 2025-10-02 09:26
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/chirizxc">@chirizxc</a> on 2025-10-02 09:26</div>
            <div class="timeline-body"><h3>Summary</h3>
<p><code>ruff.toml</code>:</p>
<pre><code class="language-toml">target-version = &quot;py312&quot;

line-length = 90

[tool.lint.isort]  # &lt;=== error here
force-wrap-aliases = true
combine-as-imports = true
no-lines-before = [&quot;local-folder&quot;]
</code></pre>
<pre><code>❯ ruff check
ruff failed                                                                                                                                           
  Cause: Failed to load configuration `C:\Users\chiri\Desktop\ttt\ruff.toml`
  Cause: Failed to parse C:\Users\chiri\Desktop\ttt\ruff.toml
  Cause: TOML parse error at line 1, column 1
  |
1 | target-version = &quot;py312&quot;
  | ^
unknown field `tool`
</code></pre>
<p>Arrow seems to be pointing in the wrong place</p>
<h3>Version</h3>
<p>ruff 0.13.2 (b0bdf0334 2025-09-25)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/chirizxc">@chirizxc</a> on 2025-10-02 09:50</div>
            <div class="timeline-body"><p>I haven't checked all the other cases or run any tests, but something like this should work</p>
<pre><code>❯ C:\Users\chiri\Desktop\ruff\target\debug\ruff.exe check .
ruff failed
  Cause: Failed to load configuration `C:\Users\chiri\Desktop\ttt\ruff.toml`
  Cause: TOML parse error at line 5, column 1
  |
5 | [tool.lint.isort]
  | ^
unknown field `tool`
</code></pre>
<pre><code class="language-diff">❯ git diff 
diff --git a/crates/ruff_workspace/src/pyproject.rs b/crates/ruff_workspace/src/pyproject.rs                                                          
index 0f2251ee1..e104d3c44 100644
--- a/crates/ruff_workspace/src/pyproject.rs
+++ b/crates/ruff_workspace/src/pyproject.rs
@@ -45,7 +45,38 @@ fn parse_ruff_toml&lt;P: AsRef&lt;Path&gt;&gt;(path: P) -&gt; Result&lt;Options&gt; {
     let path = path.as_ref();
     let contents = std::fs::read_to_string(path)
         .with_context(|| format!(&quot;Failed to read {}&quot;, path.display()))?;
-    toml::from_str(&amp;contents).with_context(|| format!(&quot;Failed to parse {}&quot;, path.display()))
+
+    match toml::from_str::&lt;Options&gt;(&amp;contents) {
+        Ok(options) =&gt; Ok(options),
+        Err(err) =&gt; {
+            let err_msg = err.to_string();
+
+            if let Some(field_start) = err_msg.find(&quot;unknown field `&quot;) {
+                if let Some(field_end) = err_msg[field_start + 15..].find('`') {
+                    let field_name = &amp;err_msg[field_start + 15..field_start + 15 + field_end];
+
+                    let mut line_num = 1;
+                    for line in contents.lines() {
+                        let trimmed = line.trim_start();
+                        if trimmed.starts_with('[') &amp;&amp; trimmed.contains(field_name) ||
+                            trimmed.starts_with(field_name) &amp;&amp; trimmed.contains('=') {
+                            return Err(anyhow::anyhow!(
+                                &quot;TOML parse error at line {}, column {}\n  |\n{} | {}\n  | ^\nunknown field `{}`&quot;,
+                                line_num,
+                                line.len() - trimmed.len() + 1,
+                                line_num,
+                                trimmed,
+                                field_name
+                            ));
+                        }
+                        line_num += 1;
+                    }
+                }
+            }
+
+            Err(err.into())
+        }
+    }
 }
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "[`ruff`] Confusing error message" to "[`ruff`] Confusing error message when TOML parsing error" by @chirizxc on 2025-10-02 11:39</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "[`ruff`] Confusing error message when TOML parsing error" to "[`ruff`] Confusing error message during TOML parsing" by @chirizxc on 2025-10-02 11:39</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntBre">@ntBre</a> on 2025-10-02 14:36</div>
            <div class="timeline-body"><p>Thanks for the report and for looking into a patch! To me this is more of an issue in the <code>toml</code> package we use, and I found https://github.com/toml-rs/toml/issues/589, which seems related (although I'm not sure we're using <code>flatten</code> here).</p>
<p>Ah, and then linked from the <code>toml</code> issue, I found that this is a duplicate of one of our issues too: https://github.com/astral-sh/ruff/issues/12359.</p>
<p>I think we should continue waiting on the upstream instead of trying to reparse part of the TOML and the error message ourselves.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @ntBre on 2025-10-02 14:36</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 11:38:29 UTC
    </footer>
</body>
</html>
