<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>E731: Introduction of invalid indentation - astral-sh/ruff #4924</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>E731: Introduction of invalid indentation</h1>

    <div class="meta">
        <span class="state state-open">Open</span>
        <a href="https://github.com/astral-sh/ruff/issues/4924">#4924</a>
        opened by <a href="https://github.com/addisoncrump">@addisoncrump</a>
        on 2023-06-07 11:59
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/addisoncrump">@addisoncrump</a> on 2023-06-07 11:59</div>
            <div class="timeline-body"><p>Python 3 allows for the use of different indentation styles, provided that they remain consistent within a single block and do not add tabs after spaces.</p>
<p>E731 fix may introduce invalid indentation if the indentation choice in the first block does not match the indentation of the block in which the fix is applied. As an example:</p>
<pre><code class="language-py">def a():
	pass

def b():
  c = lambda x: print(x)
  c(&quot;hi&quot;)
</code></pre>
<p><code>a</code> uses tabs, <code>b</code> uses spaces. Ruff infers the indentation from the first observed, so the replacement suggested is:</p>
<pre><code class="language-py">def a():
	pass

def b():
  def c(x):
  	return print(x)
  c(&quot;hi&quot;)
</code></pre>
<p>The inner function <code>c</code> uses tabs, which triggers a tab inconsistency syntax error.</p>
<p>This was discovered by #4822.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @charliermarsh on 2023-06-07 21:22</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2023-06-08 19:14</div>
            <div class="timeline-body"><p>This is occurring because the <code>detect_indentation</code> function will use the first <code>Indent</code> token to determine the indentation which in this case is the indented body of function <code>a</code>. I'm not sure what the correct solution would look like. If each block can have it's own indentation, a possible solution would be to keep track of indentation per-block and resolve it as per the location of the code generation.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/4972.html">astral-sh/ruff#4972</a> on 2023-06-08 19:55</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-06-08 19:56</div>
            <div class="timeline-body"><p>Yeah it might be tough right now. We have to find the indentation of the containing block. (This is an unlikely bug in practice but it should definitely be fixed when possible.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/addisoncrump">@addisoncrump</a> on 2023-07-31 23:05</div>
            <div class="timeline-body"><p>Er, so this no longer seems to trigger a tab inconsistency error. Local python accepts it no problem, and ruff no longer emits a panic about generating invalid content.</p>
<p>Solved? :stuck_out_tongue_closed_eyes:</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/T-256">@T-256</a> on 2024-06-12 23:35</div>
            <div class="timeline-body"><p>It's still issue if you've converted between <code>a</code> and <code>b</code> indentations:
After unsafe fix:
<img src="https://github.com/astral-sh/ruff/assets/132141463/6c3b56d1-be47-4df1-8e3b-6524b7e1021c" alt="image" /></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dylwil3">@dylwil3</a> on 2024-12-20 06:05</div>
            <div class="timeline-body"><p>Just to clarify the state of this issue:</p>
<ul>
<li>The fix does not cause a syntax error</li>
<li>The fix may cause a violation of E101 (which unfortunately does not have an autofix)</li>
<li>The issue vanishes in the presence of an auto-formatter (either the original code would never have been in that state or, if somehow it was, formatting afterwards would fix the discrepancy)</li>
</ul>
<p>It's hard for me to imagine a situation where this would arise in &quot;real world&quot; code.</p>
<p>It may be that other issues arise where it becomes clear that we want the generator to know about &quot;local&quot; styles, in which case this problem would be solved - but this particular case doesn't quite seem like motivation enough to introduce that functionality.</p>
<p>I would vote to close this as unplanned. What do others think?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-12-24 06:10</div>
            <div class="timeline-body"><blockquote>
<p>It may be that other issues arise where it becomes clear that we want the generator to know about &quot;local&quot; styles, in which case this problem would be solved - but this particular case doesn't quite seem like motivation enough to introduce that functionality.</p>
<p>I would vote to close this as unplanned. What do others think?</p>
</blockquote>
<p>Yeah, it'll also make the <code>Generator</code> a bit complex because it would need to track state on a per-block basis. I'd be fine in closing it but would check-in with @addisoncrump as the issue author.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:34:50 UTC
    </footer>
</body>
</html>
