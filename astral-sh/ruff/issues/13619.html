<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RUF006 does not catch violations in lambda expressions - astral-sh/ruff #13619</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>RUF006 does not catch violations in lambda expressions</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/issues/13619">#13619</a>
        opened by <a href="https://github.com/hpelwintervold">@hpelwintervold</a>
        on 2024-10-03 21:46
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/hpelwintervold">@hpelwintervold</a> on 2024-10-03 21:46</div>
            <div class="timeline-body"><p>Ruff does not appear to find violations for rule <code>RUF006</code> (<a href="https://docs.astral.sh/ruff/rules/asyncio-dangling-task/">link</a>) in lambda expressions. Example below:</p>
<ul>
<li><p>List of keywords searched before opening:
<code>RUF006</code>, <code>lambda</code></p>
</li>
<li><p>Minimal code snippet:
<code>sandbox.py</code></p>
</li>
</ul>
<pre><code>import asyncio


async def foo():
    return

f = lambda *args: asyncio.create_task(foo())

</code></pre>
<ul>
<li><p>Command invoked:
<code>ruff check --select RUF006 --isolated sandbox.py</code></p>
</li>
<li><p>Current ruff settings
N/A - overridden in command</p>
</li>
<li><p>Ruff version
<code>ruff 0.6.7</code></p>
</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-10-04 02:51</div>
            <div class="timeline-body"><p>Thanks for the report. This is a bit tricky, as the return value of <code>f</code> could be stored in a variable later. This is technically not a violation as-written, right? Because <code>create_task</code> is never called?</p>
<p>Implementation-wise, I tried adding this rule to the existing expression visitor but this causes a bunch of false positives when the variable <em>is</em> assigned. I think we need to write a <code>Visitor</code> specifically to find call expressions in lambdas?</p>
<p>I wrote some test cases</p>
<pre><code class="language-python">f = lambda *args: asyncio.create_task(foo())
f = lambda *args: lambda *args: asyncio.create_task(foo())
f = lambda *args: [asyncio.create_task(foo()) for x in args]
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/hpelwintervold">@hpelwintervold</a> on 2024-10-04 15:22</div>
            <div class="timeline-body"><p>Thanks for taking a look, the more specific use case I have where I ran into this is signal handling. The example (which does not assign the lambda to anything)</p>
<pre><code>import asyncio
import signal


async def foo():
    return

signal.signal(signal.SIGINT, lambda *args: asyncio.create_task(foo()))

</code></pre>
<p>Ruff does not report an error for this which prompted me to raise this bug. But thinking about this some more, I was not understanding lambdas correctly. I had thought the lambda expression <code>lambda *args: asyncio.create_task(foo())</code> essentially mapped to the following function definition:</p>
<pre><code>def create_task():
    asyncio.create_task(foo())
</code></pre>
<p>And ruff emits an error:</p>
<pre><code>sandbox2.py:10:5: RUF006 Store a reference to the return value of `asyncio.create_task`
   |
 9 | def create_task():
10 |     asyncio.create_task(foo())
   |     ^^^^^^^^^^^^^^^^^^^^^^^^^^ RUF006
11 | 
12 | async def sigint_handler(*args):
   |

Found 1 error.
</code></pre>
<p>But actually the lambda returns the value - so an equivalent function is this:</p>
<pre><code>def create_task():
    return asyncio.create_task(foo())
</code></pre>
<p>Ruff does not emit an error for this, because the reference is returned (not lost), right?</p>
<p>Whether or not that reference is later dropped or not seems to be outside of the scope of <code>RUF006</code>. It's a little tricky to think though, but I think the current behavior of not reporting an error makes sense - because it's up to the caller of the lambda to track the reference to the result. So I think this issue could be closed</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-10-04 15:30</div>
            <div class="timeline-body"><p>Thanks for following up!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @zanieb on 2024-10-04 15:30</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 11:35:18 UTC
    </footer>
</body>
</html>
