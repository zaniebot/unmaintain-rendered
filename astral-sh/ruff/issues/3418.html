<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Keep `# noqa` comments when forcing single-line imports - astral-sh/ruff #3418</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Keep <code># noqa</code> comments when forcing single-line imports</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/issues/3418">#3418</a>
        opened by <a href="https://github.com/stinodego">@stinodego</a>
        on 2023-03-09 13:41
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/stinodego">@stinodego</a></div>
            <div class="timeline-body"><p>Consider the following file <code>repro.py</code>:</p>
<pre><code>from datetime import date, time  # noqa: F401
</code></pre>
<p>And let&#x27;s say my ruff config has <code>isort</code> lints, with force-single-line option:</p>
<pre><code>[tool.ruff]
fix = true
select = [&quot;F&quot;, &quot;I&quot;]

[tool.ruff.isort]
force-single-line = true
</code></pre>
<p>Running <code>ruff repro.py</code> results in the <code>time</code> import being deleted:</p>
<pre><code>from datetime import date  # noqa: F401
</code></pre>
<p>Running <code>ruff repro.py --unfixable=F401</code> results in:</p>
<pre><code>from datetime import date  # noqa: F401
from datetime import time
</code></pre>
<p>So the problem here is that the <code># noqa</code> comment is not reproduced on the extra lines. Desired outcome would be:</p>
<pre><code>from datetime import date  # noqa: F401
from datetime import time  # noqa: F401
</code></pre>
<p>This is on the latest version of ruff (<code>0.0.254</code>).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-03-12 05:27</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">isort</span> added by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-03-12 05:27</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-03-12 05:27</div>
            <div class="timeline-body"><p>(Do you know if <code>isort</code> does this?)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/stinodego">@stinodego</a> on 2023-03-12 15:05</div>
            <div class="timeline-body"><p>I checked, and <code>isort</code> keeps the comment on the first line of the split imports (same as <code>ruff</code> does currently). The other lines have no comments (goes for regular comments too).</p>
<p>I&#x27;d argue that this is a shortcoming in <code>isort</code>, but one that I can sort-of live with.
For <code>ruff</code>, thanks to its amazing autofix functionality, this is a more serious issue because it&#x27;s deleting valid imports.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-03-12 17:46</div>
            <div class="timeline-body"><p>Yeah that makes sense. Do you think <code># noqa</code> comments should be special-cased here? Or should this apply to any end-of-line comment on-split?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/stinodego">@stinodego</a> on 2023-03-12 18:33</div>
            <div class="timeline-body"><p>There are valid comments that one could like to see replicated:</p>
<pre><code>from datetime import date, time  # noqa: F401  # Import side effects required for functionality X
</code></pre>
<p>Without knowing what&#x27;s in the comments exactly, I think our best guess is to just replicate the full comment entirely (noqa and regular).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Kilo59">@Kilo59</a> on 2023-03-13 02:41</div>
            <div class="timeline-body"><p>This would make adopting new ruff rules or bringing new code under the coverage of <code>ruff</code> much easier.</p>
<p>The way this can be done now is by turning on some new rule and then using <code>--noqa</code> to add in-line ignores to any existing violations. However, on very large code bases this invariably leads to many lines that have to be formatted (via <code>black</code> or the <code>ruff</code> <code>I</code> rules). The newly formatted lines now no longer have an inline <code># noqa</code> comment and require manual intervention.</p>
<p>Although this can be mitigated by running <code>ruff</code> 2 more times, once with <code>--noqa</code> (to add back <code>noqa</code> comments to the newly formatted lines) and then again with <code>--select RUF100 --fix</code> (to remove the now unused <code>noqa</code> comments).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-03-14 18:48</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 18:48:34 UTC
    </footer>
</body>
</html>
