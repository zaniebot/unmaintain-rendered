<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>False positive for `G201` and `G202`? - astral-sh/ruff #2356</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>False positive for <code>G201</code> and <code>G202</code>?</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/issues/2356">#2356</a>
        opened by <a href="https://github.com/ngnpope">@ngnpope</a>
        on 2023-01-30 17:08
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/ngnpope">@ngnpope</a> on 2023-01-30 17:08</div>
            <div class="timeline-body"><p>We may have a situation where we have a callback function defined to handle exception, e.g. this generic catch-all when using a resolver from <code>aws-lambda-powertools</code>:</p>
<pre><code class="language-python">from __future__ import annotations

from typing import Any

from aws_lambda_powertools.event_handler import ALBResolver, Response
from aws_lambda_powertools.logging import Logger
from aws_lambda_powertools.utilities.typing import LambdaContext

app = ALBResolver()
logger = Logger()


@app.get(&quot;/&quot;)
def handle_default() -&gt; Response:
    raise Exception  # Something went wrong...


@logger.inject_lambda_context
def lambda_handler(event: dict[str, Any], context: LambdaContext) -&gt; dict[str, Any]:
    return app.resolve(event, context)


@app.exception_handler(Exception)
def handle_exception(exc: Exception) -&gt; Response:
    event = app.current_event
    extra = {&quot;path&quot;: event.path, &quot;method&quot;: event.http_method, &quot;status&quot;: 500}
    message = &quot;An unexpected error occurred.&quot;
    logger.error(message, exc_info=exc, extra=extra)
    return Response(
        status_code=500,
        payload={&quot;error&quot;: message},
        content_type=&quot;application/json&quot;,
    )
</code></pre>
<p>I get the following:</p>
<pre><code class="language-console">‚ùØ ruff --version
ruff 0.0.237

‚ùØ ruff --select G bug.py 
bug.py:28:12: G201 Logging `.exception(...)` should be used instead of `.error(..., exc_info=True)`
Found 1 error.
</code></pre>
<p>For context, <code>Logger.exception()</code> is defined as:</p>
<pre><code class="language-python">class Logger(Filterer):
    ...

    def exception(self, msg, *args, exc_info=True, **kwargs):
        &quot;&quot;&quot;
        Convenience method for logging an ERROR with exception information.
        &quot;&quot;&quot;
        self.error(msg, *args, exc_info=exc_info, **kwargs)

    ...
</code></pre>
<p>There are two issues here:</p>
<ol>
<li>I'm not using <code>exc_info=True</code>, I'm explicitly passing the exception object</li>
<li>The guidance to use <code>.exception(...)</code> really only applies in an <code>except:</code> block<ul>
<li>This is because passing <code>exc_info=True</code> calls <code>sys.exc_info()</code> under the hood</li>
<li>And <code>sys.exc_info()</code> cannot be guaranteed to have an exception outside of <code>except:</code><pre><code class="language-console">‚ùØ python -c 'import sys; print(sys.exc_info())'
(None, None, None)
</code></pre>
</li>
</ul>
</li>
</ol>
<p>Given the definition of <code>.exception(...)</code>, it looks as though we ought to be able to bypass <code>G201</code> by passing <code>exc_info=exc</code> to <code>.exception(...)</code> instead of <code>.error(...)</code>, but that gives the following:</p>
<pre><code class="language-console">‚ùØ ruff --select G bug.py 
bug.py:28:31: G202 Logging statement has redundant `exc_info`
Found 1 error.
</code></pre>
<p>Which is also incorrect... It's only redundant if it is <code>exc_info=True</code>, the default value.</p>
<p>So I believe the following should change:</p>
<ul>
<li>Only flag up <code>G201</code> in an <code>except:</code> block and only when <code>.error(...)</code> is passed <code>exc_info=True</code> or <code>exc_info=sys.exc_info()</code></li>
<li>Only flag up <code>G202</code> for <code>.exception(..., exc_info=True)</code> or <code>.exception(..., exc_info=sys.exc_info())</code></li>
<li>Consider whether <code>.exception(..., exc_info=exc)</code> should be forced back to <code>.error(..., exc_info=exc)</code> with a new rule<ul>
<li><em>The only benefit of <code>.exception(...)</code> is to pass <code>exc_info=True</code> automatically. It's syntactic sugar.</em></li>
</ul>
</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ngnpope">@ngnpope</a> on 2023-01-30 17:11</div>
            <div class="timeline-body"><p>Also note that <code>G201</code> flags up for <code>.error(..., exc_info=False)</code> and <code>.exception(..., exc_info=False)</code> which are both wrong.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-01-30 17:17</div>
            <div class="timeline-body"><p>Yeah those seem like correct adjustments to me.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @charliermarsh on 2023-01-30 17:17</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ngnpope">@ngnpope</a> on 2023-01-30 17:20</div>
            <div class="timeline-body"><p>I think <code>flake8-logging-format</code> also gets these wrong, but fixing things is always good! üòâ</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-01-30 17:21</div>
            <div class="timeline-body"><p>The one area I'm happy to deviate from &quot;upstream&quot; is when there are clear false positives or false negatives that can improved reliably :)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">good first issue</span> added by @charliermarsh on 2023-01-30 18:20</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @charliermarsh by @charliermarsh on 2023-01-30 20:30</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-01-30 20:31</div>
            <div class="timeline-body"><p>I'm going to fix this quickly so that it can be included in today's release.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2023-01-30 21:32</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 11:29:07 UTC
    </footer>
</body>
</html>
