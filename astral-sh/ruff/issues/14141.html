<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[red-knot] consolidate detection of cyclic class definitions - astral-sh/ruff #14141</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[red-knot] consolidate detection of cyclic class definitions</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/issues/14141">#14141</a>
        opened by <a href="https://github.com/carljm">@carljm</a>
        on 2024-11-06 21:33
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a></div>
            <div class="timeline-body"><p>Currently both MRO resolution and metaclass resolution separately detect cycles, but we emit the diagnostic only from MRO resolution and ignore it from metaclass resolution. This is inefficient both in code to maintain and runtime cost.</p>
<p>Since detection of cyclic class definitions in the MRO case is already implemented as a standalone function, we can instead hoist the call to that function out to <code>TypeInferenceBuilder::check_class_definitions</code>, before resolving MRO or metaclass. If the class definition is cyclic, we can specify an <code>Unknown</code> result for the class&#x27; MRO and metaclass and avoid ever calculating them. Then MRO and metaclass resolution can assume non-cyclic as an invariant.</p>
<p>One thing we may have to guard against here is if the MRO or metaclass is accessed before we&#x27;ve done full inference of the scope the class is defined in.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by <a href="https://github.com/carljm">@carljm</a> on 2024-11-06 21:33</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-11-06 21:47</div>
            <div class="timeline-body"><p>Wouldn&#x27;t that regress the recovery? I believe we now only replace the cyclic-subgraph with <code>Unknown</code> instead of the entire MRO.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2024-11-06 22:18</div>
            <div class="timeline-body"><blockquote>
<p>Wouldn&#x27;t that regress the recovery? I believe we now only replace the cyclic-subgraph with <code>Unknown</code> instead of the entire MRO.</p>
</blockquote>
<p>Yes, but I think this doesn&#x27;t actually matter at all.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-11-06 22:22</div>
            <div class="timeline-body"><blockquote>
<p>Yes, but I think this doesn&#x27;t actually matter at all.</p>
</blockquote>
<p>Is that because <code>Unknown</code> silences all resulting false positives anyway?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2024-11-06 22:32</div>
            <div class="timeline-body"><blockquote>
<p>Is that because <code>Unknown</code> silences all resulting false positives anyway?</p>
</blockquote>
<p>Exactly. It may mean a few more false negatives, but if you have a cyclic class definition it&#x27;d be perfectly reasonable to call the entire class <code>Unknown</code>; it&#x27;s really not worth going out of our way for incrementally more precise types on a nonsense/impossible class definition.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-11-08 22:17</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 18:48:59 UTC
    </footer>
</body>
</html>
