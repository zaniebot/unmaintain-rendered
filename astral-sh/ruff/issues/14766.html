<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[`ruff`] Formatting hex codes changes output with f-string debug - astral-sh/ruff #14766</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[<code>ruff</code>] Formatting hex codes changes output with f-string debug</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/issues/14766">#14766</a>
        opened by <a href="https://github.com/MeGaGiGaGon">@MeGaGiGaGon</a>
        on 2024-12-04 07:43
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MeGaGiGaGon">@MeGaGiGaGon</a></div>
            <div class="timeline-body"><p>I had this idea while reading <a href="https://github.com/psf/black/issues/4522">psf/black#4522</a> when @MichaReiser said ruff had already stabilized hex code formatting.</p>
<p>I don&#x27;t actively use ruff/am not familiar with it, but I assume that just like black formatting code should not have an observable runtime effect.</p>
<p><a href="https://play.ruff.rs/de93de37-677a-4e26-a125-d2a3b2504a62">playground link</a> formatting <code>f&quot;{r&#x27;\xFF&#x27;=}&quot;</code> gives <code>f&quot;{r&#x27;\xff&#x27;=}&quot;</code></p>
<pre><code>&gt;&gt;&gt; f&quot;{r&quot;\xFF&quot;=}&quot;
&#x27;r&quot;ÿ&quot;=\&#x27;\\\\xFF\&#x27;&#x27;
&gt;&gt;&gt; f&quot;{r&quot;\xff&quot;=}&quot;
&#x27;r&quot;ÿ&quot;=\&#x27;\\\\xff\&#x27;&#x27;
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-12-04 07:48</div>
            <div class="timeline-body"><p>Oh that&#x27;s a nice find!</p>
<p>Funny enough, this is fixed in the new preview style <a href="https://play.ruff.rs/b59dbaa9-f6a8-402d-8b99-a8b5be707c26">playground</a></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-12-04 07:50</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">formatter</span> added by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-12-04 07:50</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-12-12 06:00</div>
            <div class="timeline-body"><p>Is this a bug in the CPython parser? Why does it parse the hex code even though it is a raw string?</p>
<pre><code>❯ uv run --python=3.12 python
&gt;&gt;&gt; import ast

&gt;&gt;&gt; f&quot;{r&quot;\xFF&quot;=}&quot;
&#x27;r&quot;ÿ&quot;=\&#x27;\\\\xFF\&#x27;&#x27;

&gt;&gt;&gt; print(ast.dump(ast.parse(r&#x27;f&quot;{r&quot;\xFF&quot;=}&quot;&#x27;), indent=2))
Module(
  body=[
    Expr(
      value=JoinedStr(
        values=[
          Constant(value=&#x27;r&quot;ÿ&quot;=&#x27;),
          FormattedValue(
            value=Constant(value=&#x27;\\xFF&#x27;),
            conversion=114)]))],
  type_ignores=[])

&gt;&gt;&gt; r&quot;\xFF&quot;
&#x27;\\xFF&#x27;
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-12-12 06:55</div>
            <div class="timeline-body"><p>You mean why the hex code is interpreted in the debug expression? I don&#x27;t know. It is surprising and I couldn&#x27;t find anything in the <a href="https://docs.python.org/3/reference/lexical_analysis.html#formatted-string-literals">f-string lexing section</a> indicating why it should (it only says that it calls <code>repr(expr)</code></p>
<p>I somewhat suspect that python parses everything before the <code>=</code> as a regular string and uses that in the debug expression because Python can&#x27;t go back to the source for an expression, unlike we can.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-12-12 07:16</div>
            <div class="timeline-body"><blockquote>
<p>You mean why the hex code is interpreted in the debug expression?</p>
</blockquote>
<p>Yes</p>
<blockquote>
<p>I somewhat suspect that python parses everything before the <code>=</code> as a regular string and uses that in the debug expression because Python can&#x27;t go back to the source for an expression, unlike we can.</p>
</blockquote>
<p>Yeah, that&#x27;s what I thought as well but it&#x27;s a bit surprising.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-12-12 08:03</div>
            <div class="timeline-body"><blockquote>
<p>Yeah, that&#x27;s what I thought as well but it&#x27;s a bit surprising.</p>
</blockquote>
<p>Definitely. It&#x27;s not what I expected.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-12-12 09:09</div>
            <div class="timeline-body"><p>Should this be closed as it&#x27;s &quot;resolved&quot; on <code>main</code> ?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-12-12 09:11</div>
            <div class="timeline-body"><p>We could. I kept it open to make it clear it&#x27;s part of the Ruff 2025 style guide and it requires fixing if we, for whatever reason, decide not to stabilize f-string formatting.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-12-12 09:11</div>
            <div class="timeline-body"><p>Let me add a test for this :)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dscorbett">@dscorbett</a> on 2024-12-12 13:02</div>
            <div class="timeline-body"><blockquote>
<p>Is this a bug in the CPython parser?</p>
</blockquote>
<p>I think so: I opened <a href="https://github.com/python/cpython/issues/124363">python/cpython#124363</a>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-01-07 13:32</div>
            <div class="timeline-body"><p>I&#x27;ll close this because we&#x27;re about to release the new style guide and I&#x27;m sure I forget to close it otherwise. Look out for the 0.9 release ;)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-01-07 13:32</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 18:49:06 UTC
    </footer>
</body>
</html>
