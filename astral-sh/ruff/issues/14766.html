<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[`ruff`] Formatting hex codes changes output with f-string debug - astral-sh/ruff #14766</title>
    <link rel="stylesheet" href="../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../index.html">Back to index</a>
    </div>

    <h1>[`ruff`] Formatting hex codes changes output with f-string debug</h1>

    <div class="meta">
        <span class="state state-closed">Closed</span>
        <a href="https://github.com/astral-sh/ruff/issues/14766">#14766</a>
        opened by <a href="https://github.com/MeGaGiGaGon">@MeGaGiGaGon</a>
        on 2024-12-04 07:43
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/MeGaGiGaGon">@MeGaGiGaGon</a> on 2024-12-04 07:43</div>
            <div class="timeline-body"><p>I had this idea while reading https://github.com/psf/black/issues/4522 when @MichaReiser said ruff had already stabilized hex code formatting.</p>
<p>I don't actively use ruff/am not familiar with it, but I assume that just like black formatting code should not have an observable runtime effect.</p>
<p><a href="https://play.ruff.rs/de93de37-677a-4e26-a125-d2a3b2504a62">playground link</a> formatting <code>f&quot;{r'\xFF'=}&quot;</code> gives <code>f&quot;{r'\xff'=}&quot;</code></p>
<pre><code class="language-pycon">&gt;&gt;&gt; f&quot;{r&quot;\xFF&quot;=}&quot;
'r&quot;ÿ&quot;=\'\\\\xFF\''
&gt;&gt;&gt; f&quot;{r&quot;\xff&quot;=}&quot;
'r&quot;ÿ&quot;=\'\\\\xff\''
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-12-04 07:48</div>
            <div class="timeline-body"><p>Oh that's a nice find!</p>
<p>Funny enough, this is fixed in the new preview style <a href="https://play.ruff.rs/b59dbaa9-f6a8-402d-8b99-a8b5be707c26">playground</a></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @MichaReiser on 2024-12-04 07:50</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">formatter</span> added by @MichaReiser on 2024-12-04 07:50</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/13371.html">astral-sh/ruff#13371</a> on 2024-12-04 07:51</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/14926.html">astral-sh/ruff#14926</a> on 2024-12-11 21:22</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-12-12 06:00</div>
            <div class="timeline-body"><p>Is this a bug in the CPython parser? Why does it parse the hex code even though it is a raw string?</p>
<pre><code>❯ uv run --python=3.12 python
&gt;&gt;&gt; import ast

&gt;&gt;&gt; f&quot;{r&quot;\xFF&quot;=}&quot;
'r&quot;ÿ&quot;=\'\\\\xFF\''

&gt;&gt;&gt; print(ast.dump(ast.parse(r'f&quot;{r&quot;\xFF&quot;=}&quot;'), indent=2))
Module(
  body=[
    Expr(
      value=JoinedStr(
        values=[
          Constant(value='r&quot;ÿ&quot;='),
          FormattedValue(
            value=Constant(value='\\xFF'),
            conversion=114)]))],
  type_ignores=[])

&gt;&gt;&gt; r&quot;\xFF&quot;
'\\xFF'
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-12-12 06:55</div>
            <div class="timeline-body"><p>You mean why the hex code is interpreted in the debug expression? I don't know. It is surprising and I couldn't find anything in the <a href="https://docs.python.org/3/reference/lexical_analysis.html#formatted-string-literals">f-string lexing section</a> indicating why it should (it only says that it calls <code>repr(expr)</code></p>
<p>I somewhat suspect that python parses everything before the <code>=</code> as a regular string and uses that in the debug expression because Python can't go back to the source for an expression, unlike we can.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-12-12 07:16</div>
            <div class="timeline-body"><blockquote>
<p>You mean why the hex code is interpreted in the debug expression?</p>
</blockquote>
<p>Yes</p>
<blockquote>
<p>I somewhat suspect that python parses everything before the <code>=</code> as a regular string and uses that in the debug expression because Python can't go back to the source for an expression, unlike we can.</p>
</blockquote>
<p>Yeah, that's what I thought as well but it's a bit surprising.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-12-12 08:03</div>
            <div class="timeline-body"><blockquote>
<p>Yeah, that's what I thought as well but it's a bit surprising.</p>
</blockquote>
<p>Definitely. It's not what I expected.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-12-12 09:09</div>
            <div class="timeline-body"><p>Should this be closed as it's &quot;resolved&quot; on <code>main</code> ?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-12-12 09:11</div>
            <div class="timeline-body"><p>We could. I kept it open to make it clear it's part of the Ruff 2025 style guide and it requires fixing if we, for whatever reason, decide not to stabilize f-string formatting.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-12-12 09:11</div>
            <div class="timeline-body"><p>Let me add a test for this :)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/14929.html">astral-sh/ruff#14929</a> on 2024-12-12 09:28</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dscorbett">@dscorbett</a> on 2024-12-12 13:02</div>
            <div class="timeline-body"><blockquote>
<p>Is this a bug in the CPython parser?</p>
</blockquote>
<p>I think so: I opened https://github.com/python/cpython/issues/124363.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-01-07 13:32</div>
            <div class="timeline-body"><p>I'll close this because we're about to release the new style guide and I'm sure I forget to close it otherwise. Look out for the 0.9 release ;)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @MichaReiser on 2025-01-07 13:32</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../Homebrew/homebrew-core/pulls/203745.html">Homebrew/homebrew-core#203745</a> on 2025-01-09 17:12</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:28:14 UTC
    </footer>
</body>
</html>
