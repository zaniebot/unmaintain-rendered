<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formatter: Comprehension ifs should break if the comprehension breaks - astral-sh/ruff #6063</title>
    <link rel="stylesheet" href="../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../index.html">Back to index</a>
    </div>

    <h1>Formatter: Comprehension ifs should break if the comprehension breaks</h1>

    <div class="meta">
        <span class="state state-closed">Closed</span>
        <a href="https://github.com/astral-sh/ruff/issues/6063">#6063</a>
        opened by <a href="https://github.com/konstin">@konstin</a>
        on 2023-07-25 10:46
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/konstin">@konstin</a> on 2023-07-25 10:46</div>
            <div class="timeline-body"><p>Black breaks the <code>if</code> into its own line if the comprehension breaks</p>
<pre><code class="language-python">a = (
    aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa
    for f in bbbbbbbbbbbbbbb
    if f not in ccccccccccc
)
</code></pre>
<p>while we don't</p>
<pre><code class="language-python">a = (
    aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa
    for f in bbbbbbbbbbbbbbb if f not in ccccccccccc
)
</code></pre>
<p>Conversely, parentheses should not require the target breaking</p>
<p>black:</p>
<pre><code class="language-python">aaaaaaaaaaaaaaaaaaaaa = (
    o for o in self.registry.values if o.__class__ is not ModelAdmin
)
</code></pre>
<p>ours:</p>
<pre><code class="language-python">aaaaaaaaaaaaaaaaaaaaa = (
    o
    for o in self.registry.values if o.__class__ is not ModelAdmin
)
</code></pre>
<p>Fixing this requires changing the grouping strategy for comprehensions and generator expressions.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">good first issue</span> added by @konstin on 2023-07-25 10:46</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">formatter</span> added by @konstin on 2023-07-25 10:46</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/6069.html">astral-sh/ruff#6069</a> on 2023-07-25 11:22</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AbhinavMir">@AbhinavMir</a> on 2023-07-27 16:48</div>
            <div class="timeline-body"><p>Happy to work on this. Where would the source for this be? I tried looking in <a href="https://github.com/astral-sh/ruff/blob/main/crates/ruff_python_formatter/src/other/comprehension.rs">comprehensions</a> and a few other places, but couldn't find the grouping strat. Thx.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-07-28 06:18</div>
            <div class="timeline-body"><blockquote>
<p>Happy to work on this. Where would the source for this be? I tried looking in <a href="https://github.com/astral-sh/ruff/blob/main/crates/ruff_python_formatter/src/other/comprehension.rs?rgh-link-date=2023-07-27T16%3A48%3A44Z">comprehensions</a> and a few other places, but couldn't find the grouping strat. Thx.</p>
</blockquote>
<p>You're in the right file. The grouping of the <code>if</code>s and adding the line break before it happens here. It may already be sufficient to just move the line break outside of the <code>group</code>.</p>
<p>https://github.com/astral-sh/ruff/blob/cd4147423cdcea141bd57143d6c4d930935fa4bd/crates/ruff_python_formatter/src/other/comprehension.rs#L83-L89</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @AbhinavMir by @MichaReiser on 2023-07-28 06:18</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2023-07-28 09:20</div>
            <div class="timeline-body"><p>Additionally, you might need to look at <code>expr_list_comp.rs</code>/<code>expr_dict_comp.rs</code>/<code>expr_set_comp.rs</code> (they follow the same structure so i can fix one and then copy that to the others once one works). I think i tried and moving a single <code>group</code> wasn't enough, but it should still be doable by shuffling <code>group()</code>s in the right way.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AbhinavMir">@AbhinavMir</a> on 2023-07-28 12:14</div>
            <div class="timeline-body"><p>Thanks @konstin will get to that too!
@MichaReiser quick question: how does <code>soft_line_break_or_space()</code> decide between line break or space? I assume by moving the line break outside you meant something like this?</p>
<pre><code>write!(
            f,
            [
                text(&quot;for&quot;),
                // ADD in line break here!
                trailing_comments(before_target_comments),
                group(&amp;format_args!(
                    Spacer(target),
                    ExprTupleWithoutParentheses(target),
                    in_spacer,
                    leading_comments(before_in_comments),
                    text(&quot;in&quot;),
                    trailing_comments(trailing_in_comments),
                    Spacer(iter),
                    iter.format(),
                )),
            ]
        )?;
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-07-28 12:41</div>
            <div class="timeline-body"><p><code>soft_line_break_or_space</code> renders a <code>space</code> if its enclosing group fits on a line and it renders a line break if it does not.</p>
<p>A group fits on a line if all its content (including nested groups) can be printed on a line without exceeding the configured line width. The way this is determined is by measuring if the groups content and any content coming after the group up to the first line break (soft or hard doesn't matter) doesn't exceed the line width.</p>
<p>You may also want to take a look at the documentation of the different builder methdos (like <code>soft_line_break_or_space</code>). Each of them comes with examples.</p>
<blockquote>
<p>moving the line break outside you meant something like this?</p>
</blockquote>
<p>Yeah, that's what I had in mind but it may not work (always hard to tell with formatting)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone "Formatter: Alpha" by @MichaReiser on 2023-07-31 16:08</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/6203.html">astral-sh/ruff#6203</a> on 2023-07-31 17:12</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/6321.html">astral-sh/ruff#6321</a> on 2023-08-03 23:15</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2023-08-04 14:00</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Unassigned @AbhinavMir by @AbhinavMir on 2024-02-13 00:00</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:28:09 UTC
    </footer>
</body>
</html>
