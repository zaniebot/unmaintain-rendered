<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Support flake8-annotations-complexity - astral-sh/ruff #2323</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Support flake8-annotations-complexity</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/ruff/issues/2323">#2323</a>
        opened by <a href="https://github.com/Crocmagnon">@Crocmagnon</a>
        on 2023-01-29 10:00
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Crocmagnon">@Crocmagnon</a></div>
            <div class="timeline-body"><p>I'm using https://github.com/best-doctor/flake8-annotations-complexity to keep my type annotations from going wild, and would love to see support in ruff :)</p>
<p>There are two config options (https://github.com/best-doctor/flake8-annotations-complexity/blob/master/flake8_annotations_complexity/checker.py#L27-L38) and two checks (https://github.com/best-doctor/flake8-annotations-complexity/blob/master/flake8_annotations_complexity/ast_helpers.py#L59-L69).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">plugin</span> added by @charliermarsh on 2023-01-29 16:30</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/karpa4o4">@karpa4o4</a> on 2023-01-31 13:29</div>
            <div class="timeline-body"><p>@charliermarsh, hi. can i take this issue?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-01-31 17:31</div>
            <div class="timeline-body"><p>@karpa4o4 - Sure, this seems reasonable to include.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/darikoneil">@darikoneil</a> on 2025-12-19 22:24</div>
            <div class="timeline-body"><p>Is anyone still on this?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntBre">@ntBre</a> on 2025-12-22 14:32</div>
            <div class="timeline-body"><p>@darikoneil I don't think so.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/danjones1618">@danjones1618</a> on 2026-01-06 23:01</div>
            <div class="timeline-body"><p>I've started working on this in https://github.com/astral-sh/ruff/pull/22427</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/danjones1618">@danjones1618</a> on 2026-01-06 23:31</div>
            <div class="timeline-body"><p>A couple of discussion points/questions for this rule(s):</p>
<h2>1. single rule vs multiple rules</h2>
<p>The plugin only implements one rule, <code>TAE002</code>, which flags for any annotation. This means there is no differentiation between annotation complexity in function/method arguments vs parameter declarations.</p>
<p>By splitting into two rules, function parameters can be configured to warn at a lower complexity than variable annotations. Is this desired or is it better to align with the plugin?</p>
<h2>2. The <code>Annotated</code> type</h2>
<p>The <code>Annotated</code> type introduced by <a href="https://peps.python.org/pep-0593/">PEP-593</a> allows adding additional metadata that can be queried at runtime. This is used by libraries such as Pydantic to provide contextual configuration.</p>
<p><code>flake8-annotations-complexity</code> does not make any special considerations for this type therefore using an <code>Annotated</code> type increases the reported complexity. Given the default configuration, a type of <code>Annotated[dict[str, Model], Field(...)]</code> would become an error. This is a likely annotation in a application. Should the <code>Annotated</code> type be ignored for the purpose of complexity calculation? Perhaps, with a configuration flag to disable this behaviour?</p>
<h2>3. PEP-604 union syntax</h2>
<p><a href="https://peps.python.org/pep-0604/">PEP-604</a> provides syntactic sugar for <code>Union[int, str]</code> as <code>int | str</code>. <code>flake8-annoations-complexity</code> does not increase complexity with the PEP-604 syntax. This seems like an oversight in the plugin as opposed to a feature therefore the new syntax should be reported as increasing complexity.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/darikoneil">@darikoneil</a> on 2026-01-08 00:59</div>
            <div class="timeline-body"><blockquote>
<p>A couple of discussion points/questions for this rule(s):</p>
<h2>1. single rule vs multiple rules</h2>
<p>The plugin only implements one rule, <code>TAE002</code>, which flags for any annotation. This means there is no differentiation between annotation complexity in function/method arguments vs parameter declarations.</p>
<p>By splitting into two rules, function parameters can be configured to warn at a lower complexity than variable annotations. Is this desired or is it better to align with the plugin?</p>
</blockquote>
<p>I don't particularly feel strongly about this one.</p>
<blockquote>
<h2>2. The <code>Annotated</code> type</h2>
<p>The <code>Annotated</code> type introduced by <a href="https://peps.python.org/pep-0593/">PEP-593</a> allows adding additional metadata that can be queried at runtime. This is used by libraries such as Pydantic to provide contextual configuration.</p>
<p><code>flake8-annotations-complexity</code> does not make any special considerations for this type therefore using an <code>Annotated</code> type increases the reported complexity. Given the default configuration, a type of <code>Annotated[dict[str, Model], Field(...)]</code> would become an error. This is a likely annotation in a application. Should the <code>Annotated</code> type be ignored for the purpose of complexity calculation? Perhaps, with a configuration flag to disable this behaviour?</p>
</blockquote>
<p>As far as I understand, <code>Annotated</code> is intended to be treated as type <code>T</code> and the major type checkers all consider <code>Annotated[T, meta]</code> as <code>T</code>. For that reason, I think the complexity count should be calculated only on <code>T</code>. Being said, eliminating nested chaos is really in the <em>spirit</em> of annotations complexity rules, so I wouldn't necessarily having it as an option.</p>
<blockquote>
<h2>3. PEP-604 union syntax</h2>
<p><a href="https://peps.python.org/pep-0604/">PEP-604</a> provides syntactic sugar for <code>Union[int, str]</code> as <code>int | str</code>. <code>flake8-annoations-complexity</code> does not increase complexity with the PEP-604 syntax. This seems like an oversight in the plugin as opposed to a feature therefore the new syntax should be reported as increasing complexity.</p>
</blockquote>
<p>This is actually kind of funny, because I think whether <code>Union[int, str]</code> (or <code>tuple[str, int]</code>) should be considered the same complexity as <code>str | int</code> is pretty debatable. For example, <code>str | bytes | PathLike</code> vs something like <code>list[tuple[int]]</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntBre">@ntBre</a> on 2026-01-12 18:39</div>
            <div class="timeline-body"><blockquote>
<p>A couple of discussion points/questions for this rule(s):</p>
<h2>1. single rule vs multiple rules</h2>
<p>The plugin only implements one rule, <code>TAE002</code>, which flags for any annotation. This means there is no differentiation between annotation complexity in function/method arguments vs parameter declarations.</p>
<p>By splitting into two rules, function parameters can be configured to warn at a lower complexity than variable annotations. Is this desired or is it better to align with the plugin?</p>
<h2>2. The <code>Annotated</code> type</h2>
<p>The <code>Annotated</code> type introduced by <a href="https://peps.python.org/pep-0593/">PEP-593</a> allows adding additional metadata that can be queried at runtime. This is used by libraries such as Pydantic to provide contextual configuration.</p>
<p><code>flake8-annotations-complexity</code> does not make any special considerations for this type therefore using an <code>Annotated</code> type increases the reported complexity. Given the default configuration, a type of <code>Annotated[dict[str, Model], Field(...)]</code> would become an error. This is a likely annotation in a application. Should the <code>Annotated</code> type be ignored for the purpose of complexity calculation? Perhaps, with a configuration flag to disable this behaviour?</p>
<h2>3. PEP-604 union syntax</h2>
<p><a href="https://peps.python.org/pep-0604/">PEP-604</a> provides syntactic sugar for <code>Union[int, str]</code> as <code>int | str</code>. <code>flake8-annoations-complexity</code> does not increase complexity with the PEP-604 syntax. This seems like an oversight in the plugin as opposed to a feature therefore the new syntax should be reported as increasing complexity.</p>
</blockquote>
<p>I'd be curious to hear from @MichaReiser and @amyreese on these, but my initial reaction would probably be:</p>
<ol>
<li>stick with a single rule for now, we can split them later if needed</li>
<li>probably not count the <code>Annotated</code> layer and treat the annotation as the first element in the subscript</li>
<li>I think I probably would count this as additional complexity, but only one layer/level like the subscript version (assuming that <em>is</em> how it works, I haven't looked at the PR yet)</li>
</ol>
<p>I'm also wondering if we should just make this a <code>RUF</code> rule instead of adding a new linter for one rule, but that kind of relates to point (1) as well. We don't have to answer that now and can recode it before landing the PR anyway.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 19:15:09 UTC
    </footer>
</body>
</html>
