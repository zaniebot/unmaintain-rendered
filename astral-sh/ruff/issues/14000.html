<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RUF027 False positive for non-runtime context binding - astral-sh/ruff #14000</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>RUF027 False positive for non-runtime context binding</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/issues/14000">#14000</a>
        opened by <a href="https://github.com/Daverball">@Daverball</a>
        on 2024-10-30 14:52
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Daverball">@Daverball</a></div>
            <div class="timeline-body"><p>This might be incredibly easy to fix depending on how this check is implemented. Currently RUF027 can be triggered by something like:</p>
<pre><code>from typing import TYPE_CHECKING
if TYPE_CHECKING:
    from datetime import date

path = &quot;foo/{date}/&quot;  # RUF027
</code></pre>
<p>Now, to be fair, this would also be a false positive for a runtime binding. But this seems like an easy low hanging fruit to reduce the false positive rate at least a little bit.</p>
<p>Although a more reliable solution long-term would be to add a setting for specifying additional methods which expect a template string.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-10-30 15:00</div>
            <div class="timeline-body"><blockquote>
<p>Now, to be fair, this would also be a false positive for a runtime binding. But this seems like an easy low hanging fruit to reduce the false positive rate at least a little bit.</p>
</blockquote>
<p>Can you talk me through the heuristic you have in mind to identifying the false positives? Is it that ruff should ignore all strings in function decorator positions if the function has a parameter with the same name?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">rule</span> added by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-10-30 15:00</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Daverball">@Daverball</a> on 2024-10-30 15:18</div>
            <div class="timeline-body"><p>It&#x27;s very simple. From what I understand, this rule triggers when a string template contains a name that would reference a binding if it were changed into a f-string. But if the binding is not in a runtime context, then turning it into a f-string would trigger a <code>NameError</code> (or <code>UnboundLocalError</code> if the name is shadowed later in the same scope).</p>
<p>So all I&#x27;m suggesting is to ignore references that can&#x27;t actually be used at runtime.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Daverball">@Daverball</a> on 2024-10-30 15:33</div>
            <div class="timeline-body"><p>@MichaReiser I&#x27;ve simplified the example, so it&#x27;s just about the runtime context of the binding and there&#x27;s no additional visual noise, even if it would trigger additional violations for the unused import.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-10-30 15:34</div>
            <div class="timeline-body"><p>@Daverball, is this something that&#x27;s actually causing false-positive errors to be emitted on your code, or is this just a theoretical concern? It feels like a bit of an edge case</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Daverball">@Daverball</a> on 2024-10-30 15:41</div>
            <div class="timeline-body"><p>@AlexWaygood I am seeing some false positives in my code that would go away with this heuristic, yes, otherwise I would not have reported it. Since you&#x27;re already keeping track of the runtime context of bindings in the semantic model anyways this seemed like a fairly cheap win.</p>
<p>Although as I&#x27;ve said, being able to specify functions in addition to <code>gettext</code>/<code>logging</code>/<code>FastAPI.path</code> where this check is skipped would be more reliable.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-10-30 15:47</div>
            <div class="timeline-body"><blockquote>
<p>@AlexWaygood I am seeing some false positives in my code that would go away with this heuristic, yes, otherwise I would not have reported it.</p>
</blockquote>
<p>Thanks for confirming. We get more issues reported than you might think which <em>are</em> actually purely theoretical, so I just wanted to check :-)</p>
<p>I agree that RUF027 has too many false positives right now, and I&#x27;d happily accept any PR that&#x27;s not too complicated and manages to reduce the number of false positives from the rule! Thanks for opening the issue with the suggestion.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Daverball">@Daverball</a> on 2024-10-30 15:51</div>
            <div class="timeline-body"><p>I just realized that this might come for free with #12927, since this will add <code>simulate_runtime_load</code> to the semantic model, the current implementation appears to be using <code>lookup_symbol</code> which handles deletion properly, but doesn&#x27;t care about which context the lookup happens from, it just assumes it&#x27;s being called at the right time during semantic analysis.</p>
<p>So if that ever gets merged I will open a PR to change <code>lookup_symbol</code> to <code>simulate_runtime_load</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-12-18 07:50</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-12-18 07:50</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 18:48:59 UTC
    </footer>
</body>
</html>
