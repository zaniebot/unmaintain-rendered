<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Negation of per-file-ignores not working as expected - astral-sh/ruff #13716</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Negation of per-file-ignores not working as expected</h1>

    <div class="meta">
        <span class="state state-closed">Closed</span>
        <a href="https://github.com/astral-sh/ruff/issues/13716">#13716</a>
        opened by <a href="https://github.com/jmspereira">@jmspereira</a>
        on 2024-10-11 09:44
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/jmspereira">@jmspereira</a> on 2024-10-11 09:44</div>
            <div class="timeline-body"><p>Hey everyone,</p>
<p>I have a monorepo where I am using the banned-api from flake8-tidy-imports to block the usage of an import of a certain package. However, I only want this to work inside the projects that are inside a folder called abc. I am trying to use the per-file-ignores
configuration, in a config file that I use globally across the repo, with the following:</p>
<pre><code class="language-toml">[lint.per-file-ignores]
&quot;!abc/**.py&quot; = [&quot;TID251&quot;] 
</code></pre>
<p>However, this appears not to be working. Am I doing something wrong?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-10-11 14:32</div>
            <div class="timeline-body"><p>Can you tell me a bit more about what exactly isn't working? For which files is <code>TID0251</code> not enabled or disabled where you would expect it to be enabled/disabled.</p>
<p>You might want to consider using <code>!abc/**/*.py</code> to match files at an arbitrary deep nesting level (e.g. even if they're in sub directories of <code>abc</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/jmspereira">@jmspereira</a> on 2024-10-15 16:28</div>
            <div class="timeline-body"><p>Hey @MichaReiser,</p>
<p>Sorry for the delay. I want TID0251 to be enabled in every project inside abc folder and disable otherwise. I'm not sure what ruff does about the path that is used for those exclusions when a config file is passed, but it appears to be using the relative path instead of the absolute path.</p>
<p>For instance, I have a project inside abc, let's call it xpto, that has a src folder inside.
If I pass as parameter src/**.py the per-file-ingores configuration seems to be doing what I want.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-10-16 06:48</div>
            <div class="timeline-body"><p>That makes sense. Did you try using <code>!abc/**/*.py</code>? Also see https://www.atlassian.com/git/tutorials/saving-changes/gitignore as a reference</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/jmspereira">@jmspereira</a> on 2024-10-16 07:37</div>
            <div class="timeline-body"><p>Yes, I tried <code>!abc/**/*.py</code>, and still does not work.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">question</span> added by @MichaReiser on 2024-10-16 07:39</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-10-16 07:44</div>
            <div class="timeline-body"><p>Can you share an example project?</p>
<p>I created a project with:</p>
<pre><code>- abc
  - test.py
  - subfolder/test2.py
- src
	- test.py
root.py
pyproject.toml
</code></pre>
<pre><code class="language-toml">[tool.ruff.lint.per-file-ignores]
&quot;!abc/**/*.py&quot; = [&quot;TID251&quot;]


[tool.ruff.lint.flake8-tidy-imports.banned-api]
&quot;os&quot;.msg = &quot;We don't want to rely on any platform specific code&quot;
</code></pre>
<p>And ruff correctly flags <code>import os</code> in <code>abc/test.py</code> and <code>abc/subfolder/test2.py</code> but it doesn't flag the import in <code>src/test</code> or <code>root.py</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">needs-info</span> added by @MichaReiser on 2024-10-16 07:44</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/jmspereira">@jmspereira</a> on 2024-10-16 10:13</div>
            <div class="timeline-body"><p>Let's assume that the project is somewhat like this:</p>
<pre><code>- abc
  - xpto1 
       - src 
           - test.py
           - subfolder/test2.py
           - ...
       - pyproject.toml
  - xpto2
       - src 
           - test.py
           - subfolder/test2.py
           - ...
       - pyproject.toml
    ....
- def
    - xpto3
       - src 
           - test.py
           - subfolder/test2.py
           - ...
       - pyproject.toml
  - xpto4
       - src 
           - test.py
           - subfolder/test2.py
           - ...
       - pyproject.toml
    .... 
- &lt;tool-that-wraps-ruff&gt;
     - resources/
         - config.toml
     - src
         - ... 
</code></pre>
<p>And what is specified in the config.toml is (I do not have the ruff configurations on a pyproject.toml by project):</p>
<pre><code>[tool.ruff.lint.per-file-ignores]
&quot;!abc/**/*.py&quot; = [&quot;TID251&quot;]

[tool.ruff.lint.flake8-tidy-imports.banned-api]
&quot;os&quot;.msg = &quot;We don't want to rely on any platform-specific code&quot;
</code></pre>
<p>And the tool that calls ruff is calling it:</p>
<pre><code>ruff check &lt;absolute_path_to_xpto1_src&gt; --config &lt;absolute_path_to_config.toml&gt; --fix 
ruff check &lt;absolute_path_to_xpto2_src&gt; --config &lt;absolute_path_to_config.toml&gt; --fix 
ruff check &lt;absolute_path_to_xpto3_src&gt; --config &lt;absolute_path_to_config.toml&gt; --fix 
ruff check &lt;absolute_path_to_xpto4_src&gt; --config &lt;absolute_path_to_config.toml&gt; --fix 
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-10-16 10:40</div>
            <div class="timeline-body"><p>I'm not sure if <code>--config</code> works with ignore. I would have to look into this in more detail. I'm also not sure if the config passed to <code>--config</code> MUST use <code>lint.per-file-ignores</code> without the <code>tool.ruff</code> prefix because it isn't a pyproject.toml.</p>
<p>The easiest here might actually be to make use of ruff's configuration inheritance feature where:</p>
<ul>
<li>You have a <code>config.toml</code> at the root</li>
<li>You add a <code>ruff.toml</code> inside of <code>abc</code> and it sets <code>lint.extend-select = [&quot;TID251&quot;]</code> and <code>extend = &quot;../config.toml&quot;</code></li>
<li>You set <code>extend=&quot;../config&quot;</code> in every <code>pyproject.toml</code> <strong>unless</strong> they contain no ruff configuration. If so, you're good to go.</li>
</ul>
<p>That should also remove the need to call ruff with an explicit config parameter because it will automatically pick up the closest <code>ruff.toml</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @MichaReiser on 2024-11-20 12:02</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:34:53 UTC
    </footer>
</body>
</html>
