<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Improve CI performance - astral-sh/ruff #1743</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Improve CI performance</h1>

    <div class="meta">
        <span class="state state-closed">Closed</span>
        <a href="https://github.com/astral-sh/ruff/issues/1743">#1743</a>
        opened by <a href="https://github.com/charliermarsh">@charliermarsh</a>
        on 2023-01-09 08:08
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-01-09 08:08</div>
            <div class="timeline-body"><p>A few ideas (all of which should be benchmarked prior to committing):</p>
<ul>
<li>[x] Skip <code>--release</code> in CI builds</li>
<li>[x] Install <code>insta</code> via <a href="https://github.com/marketplace/actions/rust-cargo-install"><code>rust-cargo-install</code></a> (#1750)</li>
<li>[ ] Try out <a href="https://nexte.st/"><code>cargo nextest</code></a></li>
<li>[x] Try out <a href="https://github.com/Swatinem/rust-cache"><code>rust-cache</code></a> action (#1750)</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">internal</span> added by @charliermarsh on 2023-01-09 08:08</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">performance</span> added by @charliermarsh on 2023-01-09 08:08</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-01-09 08:11</div>
            <div class="timeline-body"><p>Couple data points -- given this, it's really only worth focusing on <code>test</code> and <code>build</code> for now:</p>
<img width="306" alt="Screen Shot 2023-01-09 at 3 10 07 AM" src="https://user-images.githubusercontent.com/1309177/211264177-3cebb9bc-ee86-44be-bbe2-2413a0f8d086.png">
<img width="310" alt="Screen Shot 2023-01-09 at 3 10 23 AM" src="https://user-images.githubusercontent.com/1309177/211264180-ce8adcf3-0b23-48f1-ad8d-5a2db261f3cf.png">

</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-01-09 08:11</div>
            <div class="timeline-body"><p>(I feel like our build cache is really bad, though I don't understand why.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-01-09 08:13</div>
            <div class="timeline-body"><p>Oh, maybe the problem is that we need to use separate caches for the different actions.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/colin99d">@colin99d</a> on 2023-01-09 14:18</div>
            <div class="timeline-body"><p>This isn't an issue yet since the CI is relatively quick and we dont have too many PRs at the same time, but stopping obsolete workflows could save us some time waiting to get a machine:
https://yonatankra.com/7-github-actions-tricks-i-wish-i-knew-before-i-started/ (see number 6)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-01-09 16:20</div>
            <div class="timeline-body"><p>Good suggestion! Although I think we actually do that now thanks to @messense:</p>
<pre><code class="language-yaml">concurrency:
  group: ${{ github.workflow }}-${{ github.ref_name }}-${{ github.event.pull_request.number || github.sha }}
  cancel-in-progress: true
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/colin99d">@colin99d</a> on 2023-01-09 16:28</div>
            <div class="timeline-body"><p>Awesome!! I guess I need to improve my fuzzy finder (;.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ducaale">@ducaale</a> on 2023-01-09 19:47</div>
            <div class="timeline-body"><blockquote>
<ul>
<li>Try out <a href="https://github.com/Swatinem/rust-cache"><code>rust-cache</code></a> action</li>
</ul>
</blockquote>
<p>This option seems to halve the CI duration time (~8m vs ~5m). The <code>Clippy</code> step is a bottleneck at the moment, but I believe splitting it into two jobs will speed things up further.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/1750.html">astral-sh/ruff#1750</a> on 2023-01-09 19:50</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/1752.html">astral-sh/ruff#1752</a> on 2023-01-09 20:35</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/max-sixty">@max-sixty</a> on 2023-01-10 07:51</div>
            <div class="timeline-body"><p>FYI for binaries like <code>cargo-insta</code>, you probably want https://github.com/PRQL/prql/blob/b88083c63a83c235d454ab5eff190e1661fea048/.github/actions/test-rust/action.yaml#L41, which caches just the binary â€” so the runner doesn't need to pull a huge cache. The cache size is then just few MBs, and it loads in a few seconds.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Boshen">@Boshen</a> on 2023-01-10 07:58</div>
            <div class="timeline-body"><p>FYI you can replace the <code>uses: actions-rs/toolchain@v1</code> step with a simple <code>rustup show</code>.
I used this in the rome repo and it's working great.</p>
<p>https://github.com/rome/tools/blob/e0325d39ed9276eda6c08f973f4edd1af99e9b40/.github/workflows/main.yml#L29-L30</p>
<p>This'll save a few seconds from installing the plugin, and as a bonus, you no longer need to manually sync your Rust version.</p>
<p>(Hi from twitter ðŸ‘‹ )</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-01-10 12:57</div>
            <div class="timeline-body"><p>@Boshen - Oh nice! Thank you! I tried it briefly (https://github.com/charliermarsh/ruff/pull/1769) but think it needs some fiddling since we use nightly for <code>rustfmt</code> and need to support the WASM target. Maybe I'll come back to it later :)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-01-10 12:57</div>
            <div class="timeline-body"><p>@Boshen - I looked through the originating PR on those changes -- should I also be doing a cache clean at the end of the job?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2023-01-10 21:51</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-01-10 21:51</div>
            <div class="timeline-body"><p>Closing for now as I think we've gotten through most of the items, and CI got way faster.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/not-my-profile">@not-my-profile</a> on 2023-01-12 14:40</div>
            <div class="timeline-body"><p>My latest PR does some minor edits to <code>.github/workflows/ci.yaml</code> and the CI is now taking &gt;9min just to run <code>cargo install cargo-insta</code>. Would separating the <code>cargo insta test --all</code> into its own <code>.yaml</code> file help with that?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-01-12 15:27</div>
            <div class="timeline-body"><p>@not-my-profile - I wouldn't expect those changes to impact the install time. But they're definitely invalidating the cache given the <code>Cargo.toml</code> and <code>Cargo.lock</code> modifications. Is it possible that it's just a cold-cache artifact, and that discrepancy will go away once it's merged etc.?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/not-my-profile">@not-my-profile</a> on 2023-01-12 15:33</div>
            <div class="timeline-body"><p>Yes I am quite certain that it's a cold-cache effect. My point was that having the <code>cargo insta</code> in its own <code>.yml</code> file probably would result in fewer cache invalidations.</p>
<p>I was only slightly annoyed by the long build time since I was repeatedly editing the <code>ci.yaml</code> file but since we generally only seldomly do that and the cache works as expected feel free to ignore my comment.^^</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/messense">@messense</a> on 2023-01-12 15:50</div>
            <div class="timeline-body"><p>I think it's because <a href="https://github.com/rust-lang/crates.io-index">crates.io-index</a> <a href="https://internals.rust-lang.org/t/cargos-crate-index-upcoming-squash-into-one-commit/8440">squashed into one commit</a> today, which makes the git clone delta calculation extremely slow when you have old caches.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/max-sixty">@max-sixty</a> on 2023-01-13 19:21</div>
            <div class="timeline-body"><p>FYI if it's a cold cache effect, this approach does get its own cache line https://github.com/charliermarsh/ruff/issues/1743#issuecomment-1376857341...</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:34:49 UTC
    </footer>
</body>
</html>
