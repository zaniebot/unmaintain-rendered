<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Include error code and message in json output - astral-sh/ruff #242</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Include error code and message in json output</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/issues/242">#242</a>
        opened by <a href="https://github.com/harupy">@harupy</a>
        on 2022-09-21 15:27
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/harupy">@harupy</a></div>
            <div class="timeline-body"><p>It'd be nice if the JSON output includes error code and message.</p>
<h3>Current:</h3>
<pre><code>&gt; ruff --format json resources/test/fixtures/F634.py
[
  {
    &quot;kind&quot;: &quot;IfTuple&quot;,
    &quot;fixed&quot;: false,
    &quot;location&quot;: {
      &quot;row&quot;: 1,
      &quot;column&quot;: 1
    },
    &quot;filename&quot;: &quot;/home/haru/Desktop/repositories/ruff/resources/test/fixtures/F634.py&quot;
  },
  ...
]
</code></pre>
<h3>Proposed:</h3>
<pre><code>&gt; ruff --format json resources/test/fixtures/F634.py
[
  {
    &quot;check&quot;: {
      &quot;kind&quot;: &quot;IfTuple&quot;,
      &quot;code&quot;: &quot;F123&quot;,
      &quot;message&quot;: &quot;If test is a tuple, which is always `True`&quot;
    },
    &quot;fixed&quot;: false,
    &quot;location&quot;: {
      &quot;row&quot;: 1,
      &quot;column&quot;: 1
    },
    &quot;filename&quot;: &quot;/home/haru/Desktop/repositories/ruff/resources/test/fixtures/F634.py&quot;
  },
  ...
]
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">enhancement</span> added by @charliermarsh on 2022-09-21 15:30</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/harupy">@harupy</a> on 2022-09-22 14:03</div>
            <div class="timeline-body"><p>Can I work on this?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2022-09-22 15:12</div>
            <div class="timeline-body"><p>Yeah, that'd be awesome!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/harupy">@harupy</a> on 2022-09-22 16:35</div>
            <div class="timeline-body"><p>I'm making changes to include <code>code</code> and <code>body</code>. <code>git diff</code> looks like below. Is this the right way?</p>
<pre><code class="language-diff">diff --git a/src/message.rs b/src/message.rs
index f273111..5ab0666 100644
--- a/src/message.rs
+++ b/src/message.rs
@@ -4,12 +4,13 @@ use std::path::Path;
 
 use colored::Colorize;
 use rustpython_parser::ast::Location;
+use serde::ser::{SerializeStruct, Serializer};
 use serde::{Deserialize, Serialize};
 
-use crate::checks::CheckKind;
+use crate::checks::{CheckCode, CheckKind};
 use crate::fs::relativize_path;
 
-#[derive(Debug, PartialEq, Eq, Serialize, Deserialize)]
+#[derive(Debug, PartialEq, Eq, Deserialize)]
 pub struct Message {
     pub kind: CheckKind,
     pub fixed: bool,
@@ -17,6 +18,32 @@ pub struct Message {
     pub filename: String,
 }
 
+#[derive(Serialize)]
+struct Check&lt;'a&gt; {
+    kind: &amp;'a CheckKind,
+    code: &amp;'a CheckCode,
+    body: &amp;'a String,
+}
+
+impl Serialize for Message {
+    fn serialize&lt;S&gt;(&amp;self, serializer: S) -&gt; Result&lt;S::Ok, S::Error&gt;
+    where
+        S: Serializer,
+    {
+        let mut state = serializer.serialize_struct(&quot;Message&quot;, 4)?;
+        let check = Check {
+            kind: &amp;self.kind,
+            code: &amp;self.kind.code(),
+            body: &amp;self.kind.body(),
+        };
+        state.serialize_field(&quot;check&quot;, &amp;check)?;
+        state.serialize_field(&quot;fixed&quot;, &amp;self.fixed)?;
+        state.serialize_field(&quot;location&quot;, &amp;self.location)?;
+        state.serialize_field(&quot;filename&quot;, &amp;self.filename)?;
+        state.end()
+    }
+}
+
 impl Ord for Message {
     fn cmp(&amp;self, other: &amp;Self) -&gt; Ordering {
         (&amp;self.filename, self.location.row(), self.location.column()).cmp(&amp;(
</code></pre>
<pre><code class="language-bash">&gt; cargo run -- --format json resources/test/fixtures/F634.py
    Finished dev [unoptimized + debuginfo] target(s) in 0.07s
     Running `target/debug/ruff --format json resources/test/fixtures/F634.py`
[
  {
    &quot;check&quot;: {
      &quot;kind&quot;: &quot;IfTuple&quot;,
      &quot;code&quot;: &quot;F634&quot;,
      &quot;body&quot;: &quot;If test is a tuple, which is always `True`&quot;
    },
    &quot;fixed&quot;: false,
    &quot;location&quot;: {
      &quot;row&quot;: 1,
      &quot;column&quot;: 1
    },
    &quot;filename&quot;: &quot;/home/haru/Desktop/repositories/ruff/resources/test/fixtures/F634.py&quot;
  },
  {
    &quot;check&quot;: {
      &quot;kind&quot;: &quot;IfTuple&quot;,
      &quot;code&quot;: &quot;F634&quot;,
      &quot;body&quot;: &quot;If test is a tuple, which is always `True`&quot;
    },
    &quot;fixed&quot;: false,
    &quot;location&quot;: {
      &quot;row&quot;: 7,
      &quot;column&quot;: 5
    },
    &quot;filename&quot;: &quot;/home/haru/Desktop/repositories/ruff/resources/test/fixtures/F634.py&quot;
  }
]
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/harupy">@harupy</a> on 2022-09-22 16:48</div>
            <div class="timeline-body"><p>Another pattern:</p>
<pre><code class="language-diff">diff --git a/src/message.rs b/src/message.rs
index f273111..3d8dea6 100644
--- a/src/message.rs
+++ b/src/message.rs
@@ -4,12 +4,13 @@ use std::path::Path;
 
 use colored::Colorize;
 use rustpython_parser::ast::Location;
+use serde::ser::{SerializeStruct, Serializer};
 use serde::{Deserialize, Serialize};
 
-use crate::checks::CheckKind;
+use crate::checks::{CheckCode, CheckKind};
 use crate::fs::relativize_path;
 
-#[derive(Debug, PartialEq, Eq, Serialize, Deserialize)]
+#[derive(Debug, PartialEq, Eq, Deserialize)]
 pub struct Message {
     pub kind: CheckKind,
     pub fixed: bool,
@@ -17,6 +18,22 @@ pub struct Message {
     pub filename: String,
 }
 
+impl Serialize for Message {
+    fn serialize&lt;S&gt;(&amp;self, serializer: S) -&gt; Result&lt;S::Ok, S::Error&gt;
+    where
+        S: Serializer,
+    {
+        let mut state = serializer.serialize_struct(&quot;Message&quot;, 6)?;
+        state.serialize_field(&quot;kind&quot;, &amp;self.kind)?;
+        state.serialize_field(&quot;code&quot;, &amp;self.kind.code())?;
+        state.serialize_field(&quot;message&quot;, &amp;self.kind.body())?;
+        state.serialize_field(&quot;fixed&quot;, &amp;self.fixed)?;
+        state.serialize_field(&quot;location&quot;, &amp;self.location)?;
+        state.serialize_field(&quot;filename&quot;, &amp;self.filename)?;
+        state.end()
+    }
+}
+
 impl Ord for Message {
     fn cmp(&amp;self, other: &amp;Self) -&gt; Ordering {
         (&amp;self.filename, self.location.row(), self.location.column()).cmp(&amp;(
</code></pre>
<pre><code>[
  {
    &quot;kind&quot;: &quot;IfTuple&quot;,
    &quot;code&quot;: &quot;F634&quot;,
    &quot;message&quot;: &quot;If test is a tuple, which is always `True`&quot;,
    &quot;fixed&quot;: false,
    &quot;location&quot;: {
      &quot;row&quot;: 1,
      &quot;column&quot;: 1
    },
    &quot;filename&quot;: &quot;/home/haru/Desktop/repositories/ruff/resources/test/fixtures/F634.py&quot;
  },
  {
    &quot;kind&quot;: &quot;IfTuple&quot;,
    &quot;code&quot;: &quot;F634&quot;,
    &quot;message&quot;: &quot;If test is a tuple, which is always `True`&quot;,
    &quot;fixed&quot;: false,
    &quot;location&quot;: {
      &quot;row&quot;: 7,
      &quot;column&quot;: 5
    },
    &quot;filename&quot;: &quot;/home/haru/Desktop/repositories/ruff/resources/test/fixtures/F634.py&quot;
  }
]
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2022-09-22 19:01</div>
            <div class="timeline-body"><p>Can you think of any way to implement this such that it doesn't affect the serialized results that we write to the cache, but instead, only the serialized representation that gets output by the JSON formatter? (Maybe we create a different struct, like <code>ExpandedMessage</code>, with all the fields we want, then map <code>Message</code> to <code>ExpandedMessage</code> and output <em>that</em>?)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/harupy">@harupy</a> on 2022-09-22 23:56</div>
            <div class="timeline-body"><p>Mapping to <code>ExpandedMessage</code> sounds good!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2022-09-23 00:29</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 16:45:19 UTC
    </footer>
</body>
</html>
