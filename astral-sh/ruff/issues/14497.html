<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>bug/surprise: adding an empty ruff.toml affects how import rules behaves - astral-sh/ruff #14497</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>bug/surprise: adding an empty ruff.toml affects how import rules behaves</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/ruff/issues/14497">#14497</a>
        opened by <a href="https://github.com/kaddkaka">@kaddkaka</a>
        on 2024-11-20 19:39
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/kaddkaka">@kaddkaka</a> on 2024-11-20 19:39</div>
            <div class="timeline-body"><p>Adding an <code>ruff.toml</code> to your project file structure affects how ruff finds and categorizes imports, and therefore how rule I001 behaves.</p>
<p>version: <code>ruff 0.7.4</code></p>
<h1>Detailed description</h1>
<h2>Without ruff.toml</h2>
<p>Project structure:</p>
<pre><code class="language-console">$ tree
.
├── proj
│   ├── lib
│   │   └── bar.py
│   └── src
│       └── foo.py
└── pyproject.toml
</code></pre>
<p>File content:</p>
<pre><code class="language-console">File: proj/lib/bar.py


File: proj/src/foo.py
import banana
import lib.bar
import itertools

File: pyproject.toml
[tool.ruff]
</code></pre>
<p>Here <code>lib.bar</code> is identified as <code>'lib.bar' as Known(ThirdParty)</code></p>
<pre><code class="language-console">$ ruff check --select I -v --no-cache proj/src/foo.py
[2024-11-20][20:25:48][ruff::resolve][DEBUG] Using configuration file (via parent) at: /home/david/projects/bugreport_ruff_toml_dir/pyproject.toml
[2024-11-20][20:25:48][ruff::commands::check][DEBUG] Identified files to lint in: 4.268338ms
[2024-11-20][20:25:48][ruff::diagnostics][DEBUG] Checking: /home/david/projects/bugreport_ruff_toml_dir/proj/src/foo.py
[2024-11-20][20:25:48][ruff_linter::rules::isort::categorize][DEBUG] Categorized 'banana' as Known(ThirdParty) (NoMatch)
[2024-11-20][20:25:48][ruff_linter::rules::isort::categorize][DEBUG] Categorized 'lib.bar' as Known(ThirdParty) (NoMatch)
[2024-11-20][20:25:48][ruff_linter::rules::isort::categorize][DEBUG] Categorized 'itertools' as Known(StandardLibrary) (KnownStandardLibrary)
[2024-11-20][20:25:48][ruff::commands::check][DEBUG] Checked 1 files in: 1.303531ms
proj/src/foo.py:1:1: I001 [*] Import block is un-sorted or un-formatted
  |
1 | / import banana
2 | | import lib.bar
3 | | import itertools
  |
  = help: Organize imports

Found 1 error.
[*] 1 fixable with the `--fix` option.
</code></pre>
<pre><code class="language-console">$ ruff check --select I --fix --no-cache proj/src/foo.py ; git diff
Found 1 error (1 fixed, 0 remaining).
diff --git a/proj/src/foo.py b/proj/src/foo.py
index 11710ea..ad0a354 100644
--- a/proj/src/foo.py
+++ b/proj/src/foo.py
@@ -1,3 +1,4 @@
+import itertools
+
 import banana
 import lib.bar
-import itertools
</code></pre>
<h2>With an empty ruff.toml</h2>
<pre><code class="language-console">$ touch proj/ruff.toml
$ tree
.
├── proj
│   ├── lib
│   │   └── bar.py
│   ├── ruff.toml
│   └── src
│       └── foo.py
└── pyproject.toml
</code></pre>
<p>Here the <code>lib.bar</code> import is identified as <code>'lib.bar' as Known(FirstParty)</code></p>
<pre><code class="language-console">$ ruff check --select I -v --no-cache proj/src/foo.py
[2024-11-20][20:28:25][ruff::resolve][DEBUG] Using configuration file (via parent) at: /home/david/projects/bugreport_ruff_toml_dir/pyproject.toml
[2024-11-20][20:28:25][ruff_workspace::pyproject][DEBUG] `project.requires_python` in `pyproject.toml` will not be used to set `target_version` when using `ruff.toml`.
[2024-11-20][20:28:25][ruff::commands::check][DEBUG] Identified files to lint in: 5.248828ms
[2024-11-20][20:28:25][ruff::diagnostics][DEBUG] Checking: /home/david/projects/bugreport_ruff_toml_dir/proj/src/foo.py
[2024-11-20][20:28:25][ruff_linter::rules::isort::categorize][DEBUG] Categorized 'banana' as Known(ThirdParty) (NoMatch)
[2024-11-20][20:28:25][ruff_linter::rules::isort::categorize][DEBUG] Categorized 'lib.bar' as Known(FirstParty) (SourceMatch(&quot;/home/david/projects/bugreport_ruff_toml_dir/proj&quot;))
[2024-11-20][20:28:25][ruff_linter::rules::isort::categorize][DEBUG] Categorized 'itertools' as Known(StandardLibrary) (KnownStandardLibrary)
[2024-11-20][20:28:25][ruff::commands::check][DEBUG] Checked 1 files in: 1.36171ms
proj/src/foo.py:1:1: I001 [*] Import block is un-sorted or un-formatted
  |
1 | / import banana
2 | | import lib.bar
3 | | import itertools
  |
  = help: Organize imports

Found 1 error.
[*] 1 fixable with the `--fix` option.
</code></pre>
<pre><code class="language-console">$ ruff check --select I --fix --no-cache proj/src/foo.py ; git diff
Found 1 error (1 fixed, 0 remaining).
diff --git a/proj/src/foo.py b/proj/src/foo.py
index 11710ea..9b3f53b 100644
--- a/proj/src/foo.py
+++ b/proj/src/foo.py
@@ -1,3 +1,5 @@
+import itertools
+
 import banana
+
 import lib.bar
-import itertools
</code></pre>
<h1>Additional wishes</h1>
<p>This issue would have been easier to debug if <code>ruff check -v</code>  also listed:</p>
<ul>
<li>which <code>ruff.toml</code> has been visitted</li>
<li>which <code>pyproject.toml</code> has been visitted (even though ignore due to missing ruff section)</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/kaddkaka">@kaddkaka</a> on 2024-11-20 19:49</div>
            <div class="timeline-body"><p>Similar issue:</p>
<ul>
<li>https://github.com/astral-sh/ruff/issues/14036</li>
<li>https://github.com/astral-sh/ruff/issues/10519</li>
<li>https://github.com/astral-sh/ruff/issues/9130</li>
<li>https://github.com/astral-sh/ruff/issues/10266</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">question</span> added by @MichaReiser on 2024-11-21 12:30</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-11-21 12:31</div>
            <div class="timeline-body"><p>Thanks for your feedback on your ruff experience. I can see how this can be surprising. The behavior is intentional (not speaking about the linked issue) but probably hard to find. It is explained in the documentation of the <a href="https://docs.astral.sh/ruff/settings/#src"><code>src</code></a> setting.</p>
<p>You can explicitly set the <code>src</code> setting to exclude the <code>lib</code> folder.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/kaddkaka">@kaddkaka</a> on 2024-11-21 16:23</div>
            <div class="timeline-body"><p>So if I don't want this automatic behavior, what's my option?</p>
<pre><code class="language-toml">[tool.ruff]
src = []
</code></pre>
<p>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/kaddkaka">@kaddkaka</a> on 2024-11-21 16:37</div>
            <div class="timeline-body"><p>And what about</p>
<blockquote>
<p>ruff check -v should list:</p>
</blockquote>
<ul>
<li>which ruff.toml has been visitted</li>
<li>which pyproject.toml has been visitted (even though ignore due to missing ruff section)</li>
</ul>
<p>Propose in separate issue?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/kaddkaka">@kaddkaka</a> on 2024-11-25 19:12</div>
            <div class="timeline-body"><p>Or for a more complex file structure, what to do? Which folders should be marked as <code>src</code> folders?</p>
<pre><code>$ tree
.
├── proj
│   ├── lib
│   │   └── bar.py
│   ├── src
│   │   └── foo.py
│   ├── test_suite_unittests
│   │   └── test_bar
│   │       └── test_unittets.py
│   └── test_suite_integration
│       └── test_bar
│           └── test_integration_with_X.py
├── tools
│   ├── Banana
│   │   ├── test
│   │   │   └── main.py
│   │   └── main.py
│   ├── Mango
│   │   └── main.py
│   └── Potato
│       └── main.py
└── pyproject.toml
</code></pre>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 11:35:47 UTC
    </footer>
</body>
</html>
