<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>(üêû) Cache moment &quot;error: Failed to create fix for MetaClassABCMeta: Unable to insert `ABC` into scope due to name conflict&quot; failure - astral-sh/ruff #10058</title>
    <link rel="stylesheet" href="../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../index.html">Back to index</a>
    </div>

    <h1>(üêû) Cache moment &quot;error: Failed to create fix for MetaClassABCMeta: Unable to insert `ABC` into scope due to name conflict&quot; failure</h1>

    <div class="meta">
        <span class="state state-closed">Closed</span>
        <a href="https://github.com/astral-sh/ruff/issues/10058">#10058</a>
        opened by <a href="https://github.com/KotlinIsland">@KotlinIsland</a>
        on 2024-02-20 06:12
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/KotlinIsland">@KotlinIsland</a> on 2024-02-20 06:12</div>
            <div class="timeline-body"><p>ruff 0.2.2
Windows 10/11</p>
<p><img src="https://github.com/astral-sh/ruff/assets/65446343/665fc2f6-9745-4113-9db3-d11e1bde6798" alt="image" /></p>
<pre><code>&gt; ruff check
error: Failed to create fix for MetaClassABCMeta: Unable to insert `ABC` into scope due to name conflict
</code></pre>
<p>Ruff returns exit code 0</p>
<p>This happens intermittently and I haven't been able to narrow down what is causing it.</p>
<details><summary>config file:</summary>
<p>

<pre><code class="language-toml">[tool.ruff]
target-version = &quot;py312&quot;
preview = true
unsafe-fixes = true
extend-exclude = [&quot;pw&quot;]

[tool.ruff.lint]
extend-select = [&quot;ALL&quot;]
ignore = [
    # rules that are disabled due to a bug (make sure you include the issue link):
    &quot;E112&quot;,  # no-indented-block (https://github.com/astral-sh/ruff/issues/6931 and https://github.com/astral-sh/ruff/issues/6930)
    &quot;E721&quot;,  # unidiomatic typecheck (using pylint's one for now due to https://github.com/astral-sh/ruff/issues/6465)
    &quot;N818&quot;,  # error-suffix-on-exception-name (https://github.com/astral-sh/ruff/issues/5367)
    &quot;UP040&quot;, # non-pep695-type-alias (https://github.com/python/mypy/issues/15238)

    # rules that are disabled because it was too much work to fix existing instances in our codebase.
    # TODO: enable them once they're fixed or when ruff gets baseline https://github.com/astral-sh/ruff/issues/1149:
    &quot;A003&quot;,    # builtin-attribute-shadowing
    &quot;ERA001&quot;,  # commented-out-code
    &quot;RUF012&quot;,  # mutable-class-default
    &quot;FBT001&quot;,  # boolean-type-hint-positional-argument
    &quot;FBT002&quot;,  # boolean-default-value-positional-argument
    &quot;FBT003&quot;,  # boolean-positional-value-in-call
    &quot;N815&quot;,    # mixed-case-variable-in-class-scope
    &quot;N803&quot;,    # invalid-argument-name
    &quot;TD003&quot;,   # missing-todo-link
    &quot;DTZ001&quot;,  # call-datetime-without-tzinfo
    &quot;DTZ002&quot;,  # call-datetime-today
    &quot;DTZ005&quot;,  # call-datetime-now-without-tzinfo
    &quot;DTZ006&quot;,  # call-datetime-fromtimestamp
    &quot;DTZ007&quot;,  # call-datetime-strptime-without-zone
    &quot;DTZ011&quot;,  # call-date-today
    &quot;DTZ012&quot;,  # call-date-fromtimestamp
    &quot;BLE001&quot;,  # blind-except
    &quot;SLF001&quot;,  # private-member-access
    &quot;TRY301&quot;,  # raise-within-try
    &quot;PLR0917&quot;, # Too many potisional arguments

    # rules that are disabled because we don't like them or some other permanent reason:
    &quot;ANN&quot;,     # flake8-annotations (covered by mypy)
    &quot;EM&quot;,      # flake8-errmsg
    &quot;FIX&quot;,     # flake8-fixme
    &quot;S&quot;,       # lake8-bandit (security related rules, we have no external/untrusted users so these are mostly useless)
    &quot;E501&quot;,    # Doc line too long
    &quot;PLR0913&quot;, # Too many arguments to function call
    &quot;PLR0912&quot;, # Too many branches
    &quot;PLR0915&quot;, # Too many statements
    &quot;PLR0916&quot;, # Too many Boolean expressions
    &quot;PLR2004&quot;, # Magic value used in comparison
    &quot;PLR1722&quot;, # Use `sys.exit()` instead of `exit`
    &quot;PLW2901&quot;, # `for` loop variable overwritten by assignment target
    &quot;PLE0605&quot;, # Invalid format for `__all__`, must be `tuple` or `list` (covered by mypy)
    &quot;PLR0911&quot;, # Too many return statements
    &quot;PLW0603&quot;, # Using the global statement is discouraged
    &quot;PLW1514&quot;, # `open` in text mode without explicit `encoding` argument (we set this globally in the setup script)
    &quot;PLC0105&quot;, # `TypeVar` name does not reflect its covariance
    &quot;PLC0414&quot;, # Import alias does not rename original package (used by mypy for explicit re-export)
    &quot;PLC1901&quot;, # compare-to-empty-string
    &quot;PLC2701&quot;, # import-private-name, the underscore is clear enough
    &quot;PLR0904&quot;, # too-many-public-methods
    &quot;PLR0914&quot;, # too-many-local-variables
    &quot;FURB171&quot;, # single-item-membership-test (used for checks where more values will be added in the future)
    &quot;D100&quot;,    # Missing docstring in public module (ideally would be enabled, but would be too annoying for stuff like REDACTED where you'd have to add a useless docstring to each file)
    &quot;D105&quot;,    # Missing docstring in magic method
    &quot;D107&quot;,    # Missing docstring in __init__
    &quot;D200&quot;,    # One-line docstring should fit on one line with quotes
    &quot;D202&quot;,    # No blank lines allowed after function docstring
    &quot;D203&quot;,    # 1 blank line required before class docstring
    &quot;D205&quot;,    # 1 blank line required between summary line and description
    &quot;D209&quot;,    # Multi-line docstring closing quotes should be on a separate line
    &quot;D212&quot;,    # Multi-line docstring summary should start at the first line
    &quot;D213&quot;,    # Multi-line docstring summary should start at the second line
    &quot;D400&quot;,    # First line should end with a period
    &quot;D401&quot;,    # First line should be in imperative mood
    &quot;D402&quot;,    # First line should not be the function's &quot;signature&quot;
    &quot;D403&quot;,    # First word of the first line should be properly capitalized
    &quot;D404&quot;,    # First word of the docstring should not be `This`
    &quot;D405&quot;,    # Section name should be properly capitalized
    &quot;D406&quot;,    # Section name should end with a newline
    &quot;D407&quot;,    # Missing dashed underline after section
    &quot;D412&quot;,    # No blank lines allowed between a section header and its content (required for pycharm to format example code correctly)
    &quot;D413&quot;,    # Missing blank line after last section
    &quot;D415&quot;,    # First line should end with a period, question mark, or exclamation point
    &quot;D418&quot;,    # Function/ Method decorated with @overload shouldn't contain a docstring (vscode supports it)
    &quot;RUF001&quot;,  # ambiguous-unicode-character-string (plenty of intentional instances when checking error messages etc)
    &quot;SIM300&quot;,  # yoda-conditions
    &quot;RET503&quot;,  # implicit-return (covered by mypy)
    &quot;C901&quot;,    # complex-structure
    &quot;CPY001&quot;,  # missing-copyright-notice
    &quot;TRY003&quot;,  # raise-vanilla-args
    &quot;S101&quot;,    # assert (pytest uses assert statements)
    &quot;TD002&quot;,   # missing-todo-author
    &quot;PT013&quot;,   # pytest-incorrect-pytest-import
    &quot;TRY002&quot;,  # raise-vanilla-class
    &quot;PERF401&quot;, # manual-list-comprehension (it suggests nested comprehensions which are unreadable)
    &quot;SLOT000&quot;, # no-slots-in-str-subclass
    &quot;PTH207&quot;,  # glob (seems to require part path and part glob)
    &quot;RET505&quot;,  # superfluous-else-return (can make code harder to read)
    &quot;PGH003&quot;,  # blanket-type-ignore (covered by mypy)
    &quot;TRY300&quot;,  # try-consider-else (just a suggestion, sometimes makes sense, other times makes code harder to understand)
    &quot;PLR1702&quot;, # too-many-nested-blocks
    &quot;ISC001&quot;,  # single-line-implicit-string-concatenation (conflicts with ruff formatter)
    &quot;COM812&quot;,  # missing-trailing-comma (conflicts with ruff formatter)
    &quot;W293&quot;,    # blank-line-with-whitespace (handled by ruff formatter, also https://github.com/astral-sh/ruff/issues/10038)
    &quot;E301&quot;,    # blank-line-between-methods (conflicts with ruff formatter, https://github.com/astral-sh/ruff/issues/10039)
    &quot;E302&quot;,    # blank-lines-top-level (conflicts with ruff formatter, https://github.com/astral-sh/ruff/issues/10039)
    &quot;E305&quot;,    # blank-lines-after-function-or-class (conflicts with ruff formatter, https://github.com/astral-sh/ruff/issues/10039)
]

[tool.ruff.lint.per-file-ignores]
&quot;*.pyi&quot; = [
    &quot;PLW1641&quot;, # Object does not implement `__hash__` method
    &quot;TID252&quot;,  # relative-imports
    &quot;FURB180&quot;, # meta-class-abc-meta (conflicts with how mypy handles abstract classes in stubs)
    # we don't control names in 3rd party modules:
    &quot;N&quot;,       # pep8-naming
    &quot;F811&quot;,    # redefined-while-unused
    &quot;PLW3201&quot;, # bad-dunder-method-name
    &quot;A001&quot;,    # builtin-variable-shadowing
    &quot;A002&quot;,    # builtin-argument-shadowing
    &quot;N804&quot;,    # invalid-first-argument-name-for-class-method
    &quot;PYI042&quot;,  # snake-case-type-alias
]
&quot;scripts/**/*.py&quot; = [
    &quot;T201&quot;, # print (allowed in scripts but not in REDACTED because you should use robot logging instead)
    &quot;T203&quot;, # pprint (allowed in scripts but not in REDACTED because you should use robot logging instead)
    &quot;PT&quot;,   # flake8-pytest-style (scripts are not executed by pytest)
]
&quot;REDACTED/**/*.py&quot; = [
    &quot;T201&quot;, # print (allowed in REDACTED files)
    &quot;T203&quot;, # pprint (allowed in REDACTED files)
]
&quot;REDACTED/**/*.py&quot; = [
    &quot;PT&quot;, # flake8-pytest-style (REDACTED aren't always executed by pytest)
]
&quot;REDACTED/**/*.py&quot; = [
    &quot;N999&quot;, # invalid-module-name (robot listener modules should have the same name as the class)
]
&quot;tests/unit/**/*.py&quot; = [
    &quot;D101&quot;, # Missing docstring in public class
    &quot;D102&quot;, # Missing docstring in public method
    &quot;D103&quot;, # Missing docstring in public function
    &quot;D104&quot;, # Missing docstring in public package
]
&quot;conftest.py&quot; = [
    &quot;D101&quot;, # Missing docstring in public class
    &quot;D102&quot;, # Missing docstring in public method
    &quot;D103&quot;, # Missing docstring in public function
]
[tool.ruff.lint.isort]
# ruff detects unrelated folder names as first party source code
known-third-party = [&quot;coverage&quot;, &quot;robot&quot;]
combine-as-imports = true
split-on-trailing-comma = false

[tool.ruff.lint.flake8-bugbear]
extend-immutable-calls = [
    &quot;datetime.date.today&quot;, # very unlikely for tests to run across midnight
]

[tool.ruff.lint.flake8-tidy-imports.banned-api]
&quot;typing.NoReturn&quot;.msg = &quot;use `typing.Never` instead&quot;                                             # https://github.com/astral-sh/ruff/issues/5241
&quot;typing_extensions.deprecated&quot;.msg = &quot;use `REDACTED` instead&quot;                 # https://youtrack.jetbrains.com/issue/PY-61651
&quot;pytest_robotframework.as_keyword&quot;.msg = &quot;use `REDACTED` instead&quot;
&quot;unittest.TestCase&quot;.msg = &quot;use pytest instead&quot;

[tool.ruff.lint.pylint]
allow-dunder-method-names = [&quot;__get_pydantic_core_schema__&quot;]

[tool.ruff.lint.flake8-type-checking]
runtime-evaluated-base-classes = [&quot;pydantic.BaseModel&quot;, &quot;REDACTED&quot;]
runtime-evaluated-decorators = [
    &quot;pydantic.validate_call&quot;,
    &quot;pydantic.dataclasses.dataclass&quot;,
    &quot;REDACTED&quot;,
    &quot;REDACTED&quot;,
    &quot;REDACTED&quot;,
    &quot;REDACTED&quot;
]

[tool.ruff.lint.flake8-pytest-style]
# This is unfortunate, but `pytest.fixture` contains `Any`, while `pytest.fixture()` doesn't
fixture-parentheses = true

[tool.ruff.format]
skip-magic-trailing-comma = true
</code></pre>
</p>
</details> 

</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-02-20 06:14</div>
            <div class="timeline-body"><p>This typically means that the file contains some symbol named <code>ABC</code>, so we can't add <code>from abc import ABC</code> to the file, and thus can't generate the fix.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/KotlinIsland">@KotlinIsland</a> on 2024-02-20 06:15</div>
            <div class="timeline-body"><p>Why does ruff not fail then?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-02-20 06:17</div>
            <div class="timeline-body"><p>Sorry, what do you mean? It's a failure to create the fix, so the fix just won't be offered for that violation. (Arguably we should not show these warnings to users.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-02-20 06:18</div>
            <div class="timeline-body"><p>Like, the net effect here is that you see a violation that's missing an autofix that would otherwise be available.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/KotlinIsland">@KotlinIsland</a> on 2024-02-20 06:18</div>
            <div class="timeline-body"><p><img src="https://github.com/astral-sh/ruff/assets/65446343/74df3bc1-0b0b-4ccb-9a25-494ac0598886" alt="image" /></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/KotlinIsland">@KotlinIsland</a> on 2024-02-20 06:19</div>
            <div class="timeline-body"><p>the 19 errors went away because I changed the config, but that command didn't fail, and did show an error</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-02-20 06:22</div>
            <div class="timeline-body"><p>These are more &quot;warnings&quot; than &quot;errors&quot;, they won't cause <code>ruff check</code> to fail. But it <em>should</em> be showing you lint errors for the relevant rule.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-02-20 16:26</div>
            <div class="timeline-body"><p>Are you able to share the file, or a subset of the file that reproduces it?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">needs-info</span> added by @charliermarsh on 2024-02-20 16:26</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/KotlinIsland">@KotlinIsland</a> on 2024-02-21 22:46</div>
            <div class="timeline-body"><p>At this point, I've only seen it when checking the entire code base, and I can't bisect it down because I don't have a consistent repro. Additionally, I can't share the codebase üò≠</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/KotlinIsland">@KotlinIsland</a> on 2024-04-02 06:49</div>
            <div class="timeline-body"><h1>Caught it!</h1>
<p>It only appears when the cache isn't used:</p>
<pre><code class="language-py">from abc import ABCMeta


class ABC(metaclass=ABCMeta):  # noqa: FURB180
    ...
</code></pre>
<pre><code class="language-toml">[tool.ruff]
unsafe-fixes = true

[tool.ruff.lint]
select = [&quot;FURB180&quot;]
preview = true
</code></pre>
<pre><code>&gt; ruff check test.py
error: Failed to create fix for MetaClassABCMeta: Unable to insert `ABC` into scope due to name conflict
All checks passed!
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "(üêû) Mysterious "error: Failed to create fix for MetaClassABCMeta: Unable to insert `ABC` into scope due to name conflict" failure" to "(üêû) Cache moment "error: Failed to create fix for MetaClassABCMeta: Unable to insert `ABC` into scope due to name conflict" failure" by @KotlinIsland on 2024-04-02 07:11</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-04-02 09:29</div>
            <div class="timeline-body"><blockquote>
<p>It only appears when the cache isn't used:</p>
</blockquote>
<p>This is because Ruff tries to create the fix on the first run (and fails) but then caches the diagnostic without the fix (because it is unlikely to succeed when doing so again).</p>
<p>Nice narrowing of the error into a minimal repro. I can reproduce with the given configuration, test code, and the latest ruff version.</p>
<p>What I consider a bug here is that Ruff emits the error message even when the diagnostic is suppressed. There's no way for users to avoid the error message (other than fixing the code manually). Suppressing the rule isn't sufficient because Ruff first creates all diagnostics (including fixes) and only then filters out suppressed diagnostics. Fixing this would require (and I think that would be a good change overall, especially for the editor) splitting rules into a diagnostic generation and fix generation phase, and Ruff would only pull the fixes for not suppressed diagnostics.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">needs-info</span> removed by @MichaReiser on 2024-04-02 09:29</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @MichaReiser on 2024-04-02 09:29</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/10954.html">astral-sh/ruff#10954</a> on 2024-04-15 12:46</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-01-27 01:27</div>
            <div class="timeline-body"><p>I believe this is no longer shown by default (only under <code>--verbose</code>), which seems sufficient to me.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2025-01-27 01:27</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:28:12 UTC
    </footer>
</body>
</html>
