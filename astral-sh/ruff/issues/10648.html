<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>`RUF005` with numpy arrays - astral-sh/ruff #10648</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1><code>RUF005</code> with numpy arrays</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/issues/10648">#10648</a>
        opened by <a href="https://github.com/mikedh">@mikedh</a>
        on 2024-03-28 20:02
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/mikedh">@mikedh</a></div>
            <div class="timeline-body"><p>Thanks for the great work on ruff! I ran <code>ruff check . --fix --unsafe-fixes --preview</code> with all the <code>RUF</code> rules enabled and they nearly all worked great with no manual editing. The only exception being <code>RUF005</code>. Admittedly it is correctly marked as &quot;unsafe&quot; so feel free to close. However, if it is possible to whitelist types for both sides of the addition I think this rule would be more robust, since any object that overloads <code>__add__</code> could do anything:</p>
<pre><code>import numpy as np

a = np.array([1, 2], dtype=int)

# RUF005 wants to alter this
correct = [2, 3] + a

# RUF005 emits this
broken = [2, 3, *a]

print(f&quot;correct: {correct}&quot;)
print(f&quot;broken:  {broken}&quot;)

# correct: [3 5]
# broken:  [2, 3, 1, 2]
</code></pre>
<p><a href="https://play.ruff.rs/d81613dd-88d6-4903-bce2-1c863fc76af3">Here's the example in playground</a>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-04-02 14:07</div>
            <div class="timeline-body"><p>Hy. I'm sorry you ran into this.</p>
<p>Allow listing types for which the fix is allowed is clever. Unfortunately, I don't think Ruff's type inference today is powerful enough to infer the types precise enough to be useful (it only supports local type inference, and even that in a very limited scope).</p>
<p>I think the proper solution here is that Ruff needs to understand the used types (full type inference). The type information should then even allow to automatically determine which transformations are safe (all without an <code>__add__</code> overload?)</p>
<p>I'll mark this as needing type-inference but are going to close it as it's nothing we can implement today.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">type-inference</span> added by @MichaReiser on 2024-04-02 14:07</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @MichaReiser on 2024-04-02 14:07</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 16:49:58 UTC
    </footer>
</body>
</html>
