<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>E302 and E305 cause the linter and formatter to make conflicting changes in notebooks - astral-sh/ruff #10228</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>E302 and E305 cause the linter and formatter to make conflicting changes in notebooks</h1>

    <div class="meta">
        <span class="state state-closed">Closed</span>
        <a href="https://github.com/astral-sh/ruff/issues/10228">#10228</a>
        opened by <a href="https://github.com/vancromy">@vancromy</a>
        on 2024-03-04 10:34
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/vancromy">@vancromy</a> on 2024-03-04 10:34</div>
            <div class="timeline-body"><!--
Thank you for taking the time to report an issue! We're glad to have you involved with Ruff.

If you're filing a bug report, please consider including the following information:

* A minimal code snippet that reproduces the bug.
* The command you invoked (e.g., `ruff /path/to/file.py --fix`), ideally including the `--isolated` flag.
* The current Ruff settings (any relevant sections from your `pyproject.toml`).
* The current Ruff version (`ruff --version`).
-->

<p>The new rules introduced in ruff v0.2.2 via #9266 are causing the ruff linter to make conflicting changes in notebook cells that the formatter is then trying to fix.</p>
<p>Here is an example notebook which reproduces the bug:
<img src="https://github.com/astral-sh/ruff/assets/59556820/cc5c3db0-89f1-4dd4-a89d-507d585ebc9e" alt="image" /></p>
<p>ruff config:</p>
<pre><code>[tool.ruff]
extend-include = [&quot;*.ipynb&quot;]

[tool.ruff.lint]
select = [
    &quot;E&quot;,
]
</code></pre>
<p>If you run the commands in this succession and look at the diffs you will notice that the linter adds two lines at the end of:</p>
<ol>
<li>Cell 3 (the one just printing out the variable <code>some_computation</code>). This is rule <code>E302</code> in action</li>
<li>Cell 4 (after the function definition). This is rule <code>E305</code> in action.</li>
</ol>
<p>The commands I ran:</p>
<ol>
<li><code>ruff check --force-exclude --preview --fix test.ipynb</code></li>
<li><code>ruff format --force-exclude --preview test.ipynb</code></li>
</ol>
<p>(The <code>--force-exclude</code> is because I discovered this bug through pre-commit and I was trying to mimic the pre-commit behaviour)</p>
<p>This behaviour happens from v0.2.2 upwards (I've also tested v0.3.0) as long as the preview flag is on.</p>
<p>Let me know if the MRE needs more explanation.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">rule</span> added by @MichaReiser on 2024-03-04 11:41</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">notebook</span> added by @MichaReiser on 2024-03-04 11:41</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-03-04 11:41</div>
            <div class="timeline-body"><p>Thanks for the excellent write up. Agree, that is a bug in <code>E302</code> and <code>E305</code>. It should not enforce blank lines at the end of a cell.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/hoel-bagard">@hoel-bagard</a> on 2024-03-04 15:01</div>
            <div class="timeline-body"><p>I can try to fix it if no one has started working on it yet.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/9128305">@9128305</a> on 2024-03-06 08:45</div>
            <div class="timeline-body"><p>I have the same conflicts in .pyi files like this:</p>
<pre><code class="language-python">class C:
    def foo(self) -&gt; None: ...

x: C
</code></pre>
<p>This triggers E305. E301, E302 also make conflicts between ruff check and ruff format</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-03-06 09:03</div>
            <div class="timeline-body"><p>@9128305 this should be fixed in the next release. See https://github.com/astral-sh/ruff/pull/10098</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/hoel-bagard">@hoel-bagard</a> on 2024-03-06 13:37</div>
            <div class="timeline-body"><p>@MichaReiser You are only talking about the comment above, right ?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-03-06 13:54</div>
            <div class="timeline-body"><p>@hoel-bagard Yes, my comment was specific about compatibility within typing stub file (pyi). The incompatibility documented in this issue isn't solved.</p>
<p>@dhruvmanila any recommendation how to fix this or is this something you could take on?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-03-06 16:34</div>
            <div class="timeline-body"><p>We do have custom handling for rules in Notebooks (<code>B018</code>, <code>B015</code>), so I think this should be possible.</p>
<p>There's a <a href="https://github.com/astral-sh/ruff/blob/cbd927f3463e1de4b664103b2cc70d5e67486e0e/crates/ruff_linter/src/rules/flake8_bugbear/helpers.rs">helper function</a> which checks if it's the last expression in the cell. We could either use the same function or provide a similar function depending on what the needs are here and check if we're at the cell boundary. If so, ignore checking for blank lines.</p>
<p>In the linked function, the tokenizer would start at the <em>end</em> of the expression. But for <code>E302</code>, we will need to start from the cell boundary and end at the statement start position. This will require a new function.</p>
<p>I'm not sure how exactly to get the range of the entire function / class as these rules are token-based and not AST-based. For an AST node we can directly get the end of the function / class node. It might be that I would need to look into it in detail to understand that.</p>
<p>@MichaReiser I'm not sure if I want to look into it right now unless it's a priority.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-03-06 17:11</div>
            <div class="timeline-body"><p>Thanks @dhruvmanila. @hoel-bagard would you be interested to look into this issue? I'm sure @dhruvmanila would reply to any questions you have</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/hoel-bagard">@hoel-bagard</a> on 2024-03-07 00:18</div>
            <div class="timeline-body"><p>@MichaReiser I would be interested to look into it yes. I'll start by looking at the references given by @dhruvmanila, and ask if I get stuck on something.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @hoel-bagard by @MichaReiser on 2024-03-07 06:14</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/10291.html">astral-sh/ruff#10291</a> on 2024-03-08 03:41</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @dhruvmanila on 2024-03-25 11:19</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:34:52 UTC
    </footer>
</body>
</html>
