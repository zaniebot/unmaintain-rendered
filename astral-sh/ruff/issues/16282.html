<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Excludes match against parent directories outside of the project when formatting through the language server - astral-sh/ruff #16282</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Excludes match against parent directories outside of the project when formatting through the language server</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/issues/16282">#16282</a>
        opened by <a href="https://github.com/kageurufu">@kageurufu</a>
        on 2025-02-20 17:16
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/kageurufu">@kageurufu</a> on 2025-02-20 17:16</div>
            <div class="timeline-body"><h3>Description</h3>
<p>Non-relative paths in <code>ruff.exclude</code> match against parent directories outside of the project.</p>
<p>My working path is <code>$HOME/src/&lt;project&gt;/</code> and with <code>tool.ruff.extend-exclude = ['src']</code> set the ruff language server will not format any python within <code>~/src/project/</code>.
Calling <code>ruff format</code> on the command line works normally.</p>
<ul>
<li>Version: Ruff 0.9.7</li>
<li>Minimal snippet<pre><code>mkdir -p ~/src
uv init ~/src/test-ruff-exclude
cd ~/src/test-ruff-exclude
echo 'exclude = [&quot;src&quot;]' &gt;&gt; ruff.toml
</code></pre>
</li>
<li>Invoked using the VSCode ruff extension, however any lsp integration could trigger this</li>
<li>Keywords searched: &quot;exclude&quot;, &quot;directory&quot;</li>
</ul>
<p>LSP Trace:</p>
<pre><code>[Trace - 10:16:19 AM] Sending request 'textDocument/formatting - (28)'.
Params: {
    &quot;textDocument&quot;: {
        &quot;uri&quot;: &quot;file:///home/frank/src/ruff-exclude-ex/hello.py&quot;
    },
    &quot;options&quot;: {
        &quot;tabSize&quot;: 4,
        &quot;insertSpaces&quot;: true
    }
}


[Trace - 10:16:19 AM] Received response 'textDocument/formatting - (28)' in 0ms.
No result returned.
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">server</span> added by @dylwil3 on 2025-02-20 18:00</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @dylwil3 on 2025-02-20 18:00</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-02-21 15:12</div>
            <div class="timeline-body"><p>I'm not sure I follow. Let me explain what I understand:</p>
<ul>
<li>You open the <code>$HOME/src/project</code> directory in VS code</li>
<li>The <code>ruff.toml</code> in the <code>src</code> directory contains <code>exclude = [&quot;src&quot;]</code></li>
<li>You run ruff in <code>$HOME/src/project</code> and it formats all files in that directory except the files in `src</li>
<li>VS Code doesn't format the files because it incorrectly thinks that the exclude <code>src</code> matches <code>$HOME/src</code></li>
</ul>
<p>Is this accurate?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/kageurufu">@kageurufu</a> on 2025-02-21 18:45</div>
            <div class="timeline-body"><p>Yes, exactly.</p>
<p>I believe the language server is not detecting the project root</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-02-21 18:51</div>
            <div class="timeline-body"><p>@dhruvmanila is our LSP expert. I wonder if we incorrectly anchor <code>exclude</code> (or not anchor it at all)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2025-02-24 11:05</div>
            <div class="timeline-body"><p>I thought this was fixed in https://github.com/astral-sh/ruff/pull/16043 but let me take a look at the MRE</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2025-02-24 11:09</div>
            <div class="timeline-body"><blockquote>
<ul>
<li>Minimal snippet<pre><code>mkdir -p ~/src
uv init ~/src/test-ruff-exclude
cd ~/src/test-ruff-exclude
echo 'exclude = [&quot;src&quot;]' &gt;&gt; ruff.toml
</code></pre>
</li>
</ul>
</blockquote>
<p>Using this MRE, I'm opening the <code>main.py</code> file that uv created and changing the source code (e.g., using single quotes instead of double) does format the code. And, the logs also show that the file is included:</p>
<pre><code>  38.514488875s DEBUG  ruff:worker:5 ruff_server::resolve: Included path via `include`: /private/tmp/src/test-ruff-exclude/main.py
</code></pre>
<p>Here's the directory structure:</p>
<pre><code class="language-console">$ tree -a -I .git .      
.
├── .gitignore
├── .python-version
├── README.md
├── main.py
├── pyproject.toml
└── ruff.toml
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> removed by @dhruvmanila on 2025-02-24 11:10</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">needs-mre</span> added by @dhruvmanila on 2025-02-24 11:10</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/kageurufu">@kageurufu</a> on 2025-02-28 15:18</div>
            <div class="timeline-body"><p>Now I can't recreate the issue again.
I'm wondering if somehow vscode was picking up the wrong ruff version (system or uv tool instead of the project?)</p>
<p>I'll reopen if this pops back up, but it's working now</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @kageurufu on 2025-02-28 15:18</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 11:36:42 UTC
    </footer>
</body>
</html>
