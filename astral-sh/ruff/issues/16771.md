```yaml
number: 16771
title: "FURB157 fix panics on `Decimal(float(\"\\x2dnan\"))`"
type: issue
state: closed
author: dscorbett
labels:
  - bug
  - help wanted
assignees: []
created_at: 2025-03-15T21:08:08Z
updated_at: 2025-03-17T10:09:09Z
url: https://github.com/astral-sh/ruff/issues/16771
synced_at: 2026-01-10T01:56:56Z
```

# FURB157 fix panics on `Decimal(float("\x2dnan"))`

---

_Issue opened by @dscorbett on 2025-03-15 21:08_

### Summary

The fix for [`verbose-decimal-constructor` (FURB157)](https://docs.astral.sh/ruff/rules/verbose-decimal-constructor/) panics when the minus sign in `float("-nan")` is represented by an escape sequence.
```console
$ cat >furb157.py <<'# EOF'
from decimal import Decimal
Decimal(float("\x2dnan"))
# EOF

$ ruff --isolated check --preview --select FURB157 furb157.py --diff
error: Panicked while linting furb157.py: This indicates a bug in Ruff. If you could open an issue at:

    https://github.com/astral-sh/ruff/issues/new?title=%5BLinter%20panic%5D

...with the relevant file contents, the `pyproject.toml` settings, and the following stack trace, we'd be very appreciative!

panicked at
 crates/ruff_linter/src/rules/refurb/rules/verbose_decimal_constructor.rs:181:58:
called `Option::unwrap()` on a `None` value
Backtrace:    0: __mh_execute_header
   1: __mh_execute_header
   2: __mh_execute_header
   3: __mh_execute_header
   4: __mh_execute_header
   5: __mh_execute_header
   6: __mh_execute_header
   7: __mh_execute_header
   8: __mh_execute_header
   9: __mh_execute_header
  10: __mh_execute_header
  11: __mh_execute_header
  12: __mh_execute_header
  13: __mh_execute_header
  14: __mh_execute_header
  15: __mh_execute_header
  16: __mh_execute_header
  17: __mh_execute_header
  18: __mh_execute_header
  19: __mh_execute_header
  20: __mh_execute_header
  21: __mh_execute_header
  22: __mh_execute_header
  23: __mh_execute_header
  24: __mh_execute_header
  25: __mh_execute_header
  26: __mh_execute_header
  27: __mh_execute_header



```

### Version

ruff 0.11.0 (2cd25ef64 2025-03-14)

---

_Label `bug` added by @ntBre on 2025-03-15 22:30_

---

_Label `help wanted` added by @ntBre on 2025-03-15 22:30_

---

_Comment by @dylwil3 on 2025-03-16 00:14_

I think this one may have been my fault- can't get to it until tomorrow but I'll do it first thing!

---

_Assigned to @dylwil3 by @dylwil3 on 2025-03-16 00:14_

---

_Comment by @dylwil3 on 2025-03-16 15:07_

Relatedly, and sort of frustratingly: 

```console
â¯ cat tmp.py
from decimal import Decimal

Decimal(float("\N{HYPHEN-MINUS}nan"))

â¯ ruff check --no-cache --select FURB157 --preview --fix tmp.py

error: Fix introduced a syntax error. Reverting all changes.

This indicates a bug in Ruff. If you could open an issue at:

    https://github.com/astral-sh/ruff/issues/new?title=%5BFix%20error%5D

...quoting the contents of `tmp.py`, the rule codes FURB157, along with the `pyproject.toml` settings and executed command, we'd be very appreciative!

tmp.py:3:9: FURB157 Verbose expression in `Decimal` constructor
  |
1 | from decimal import Decimal
2 |
3 | Decimal(float("\N{HYPHEN-MINUS}nan"))
  |         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^ FURB157
  |
  = help: Replace with `"\N{HYPHENMINUS}nan"`

Found 1 error.
[*] 1 fixable with the `--fix` option.
```

This means even if we wanted to just omit the fix for weird unicode situations, we now have to check for this exceedingly rare case in order to offer the fix for the much more common case ðŸ˜ž 

I guess the alternative is not to offer a fix in the presence of any escaped characters...

---

_Comment by @dylwil3 on 2025-03-16 15:11_

Actually, as a compromise, I think I'll just do this: In the case where we are replacing something equivalent to `"-nan"` with `"nan"`, I'm just going to replace it with `"nan"` and ignore whatever special formatting/unicode escaped whitespace/strangeness the original string had in it. That's still a valid fix, it's a pretty rare case, and while it's _nice_ to retain the original choices and formatting, it is not a guarantee in fixes.

---

_Referenced in [astral-sh/ruff#16777](../../astral-sh/ruff/pulls/16777.md) on 2025-03-16 15:39_

---

_Closed by @dylwil3 on 2025-03-17 10:09_

---

_Referenced in [astral-sh/ruff#19468](../../astral-sh/ruff/pulls/19468.md) on 2025-07-21 16:15_

---
