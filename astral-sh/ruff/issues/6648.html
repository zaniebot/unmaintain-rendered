<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>False-positive N805 in `Protocol` of method - astral-sh/ruff #6648</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>False-positive N805 in <code>Protocol</code> of method</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/ruff/issues/6648">#6648</a>
        opened by <a href="https://github.com/bersbersbers">@bersbersbers</a>
        on 2023-08-17 10:52
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/bersbersbers">@bersbersbers</a></div>
            <div class="timeline-body"><pre><code class="language-python">from typing import Protocol

class Class:
    def method(self) -&gt; None:
        ...

class Method(Protocol):
    def __call__(self_, self: Class) -&gt; None:
        ...

method: Method = Class.method
</code></pre>
<p><code>ruff --isolated --select N805 bug.py</code> (0.0.284) gives</p>
<blockquote>
<p>bug.py:8:18: N805 First argument of a method should be named <code>self</code></p>
</blockquote>
<p>I think <code>ruff</code> is correct, <em>but</em> mypy seems to require that <code>self</code> match the name of the variable in <code>Class.method</code> (compare https://github.com/python/typing/discussions/1040), so we have to use <code>self_</code> (or anything else) as a first parameter in <code>Method.method</code>.</p>
<p>One alternative that also type-checks (but throws the same ruff error N805, just at a different location), is</p>
<pre><code class="language-python">from typing import Protocol

class Class:
    def method(self_) -&gt; None:
        ...

class Method(Protocol):
    def __call__(self, self_: Class) -&gt; None:
        ...

method: Method = Class.method
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-08-17 15:46</div>
            <div class="timeline-body"><p>Ah interesting. I'm not sure what the best solution is here. Allow <code>self_</code> if the second argument to the method is <code>self</code> in a protocol?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @charliermarsh on 2023-08-17 17:10</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">needs-decision</span> added by @charliermarsh on 2023-08-17 17:10</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-08-17 17:10</div>
            <div class="timeline-body"><p>Or always allow <code>self_</code> in <code>__call__</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/bersbersbers">@bersbersbers</a> on 2023-08-17 20:04</div>
            <div class="timeline-body"><p>Or both, allow <code>self_</code> if the second argument to the method is <code>self</code> in <code>__call__</code> in a protocol? I don't know, to be honest.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/SXHRYU">@SXHRYU</a> on 2023-09-07 07:30</div>
            <div class="timeline-body"><p>I don't think it should be considered a false positive. Nowhere in mypy docs nor python docs is <code>self_</code> used. On the contrary, both docs contain valid examples with <code>Protocol</code> classes with methods that have <code>self</code> passed as first argument.</p>
<p>You can find topics online regarding usage of <code>self_</code> in callable protocols, but they all seem to be more of a workaround or hacking things together (some are done simply for typing reasons, which is more of an <strong>extension</strong> of python than core functionality). A simple <code>noqa: N805</code> should be enough.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/bersbersbers">@bersbersbers</a> on 2023-09-07 08:48</div>
            <div class="timeline-body"><blockquote>
<p>On the contrary, both docs contain valid examples with Protocol classes with methods that have self passed as first argument.</p>
</blockquote>
<p>I would love to see those in the mypy docs - I cannot seem to find any. Note that this is about typing the method, not the class, which is why there are two different versions of <code>self</code>, one referring to the instance holding the method, and another one referring to to the instance of the Protocol.</p>
<blockquote>
<p>You can find topics online regarding usage of self_ in callable protocols, but they all seem to be more of a workaround or hacking things together (some are done simply for typing reasons, which is more of an extension of python than core functionality).</p>
</blockquote>
<p>I would argue that the whole point of <code>Protocol</code>s is typing reasons, see PEP 544. Saying that <code>self_</code> should be flagged because it is used only for typing reasons basically comes down to saying <code>Protocol</code> could be flagged for whatever it is doing, because it is used only for typing reasons.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 16:48:01 UTC
    </footer>
</body>
</html>
