<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>`flake8-bugbear.extend-immutable-calls` does not work with relative imports in sub-packages - astral-sh/ruff #18358</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1><code>flake8-bugbear.extend-immutable-calls</code> does not work with relative imports in sub-packages</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/ruff/issues/18358">#18358</a>
        opened by <a href="https://github.com/JuneStepp">@JuneStepp</a>
        on 2025-05-28 22:31
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/JuneStepp">@JuneStepp</a> on 2025-05-28 22:31</div>
            <div class="timeline-body"><h3>Summary</h3>
<p>I've attached a minimal reproducible example to this issue, including the ruff.toml file. The <code>does_not_work.py</code> file shows that <code>extend-immutable-calls</code> does not prevent a linting error when the function is imported using a relative import from a sub-package. The two <code>works.py</code> files demonstrate that it does work with both relative imports within the main package and with absolute imports in a sub-package The command run is <code>ruff check</code>.</p>
<p><a href="https://github.com/user-attachments/files/20495754/example.zip">example.zip</a></p>
<h3>Version</h3>
<p>ruff 0.11.11</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntBre">@ntBre</a> on 2025-05-30 13:45</div>
            <div class="timeline-body"><p>This sounds plausible to me because I think <code>extend-mutable-calls</code> does a pretty simple comparison that may not match the relative path correctly. However, I'm having some trouble with the attached example. I unzipped the file and ran</p>
<pre><code class="language-shell">ruff check
</code></pre>
<p>which only reports two <code>RUF009</code> errors since that's the only rule selected in <code>ruff.toml</code>. When I select the <code>flake8-bugbear</code> rules with</p>
<pre><code class="language-shell">ruff check --select B
</code></pre>
<p>I don't get any diagnostics at all.</p>
<p>Could you provide a reproducing example? I'd also slightly prefer a couple of markdown code blocks, if possible so I can avoid downloading a file ðŸ˜…</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">needs-mre</span> added by @ntBre on 2025-05-30 13:45</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/JuneStepp">@JuneStepp</a> on 2025-05-30 14:12</div>
            <div class="timeline-body"><blockquote>
<p>which only reports two <code>RUF009</code> errors since that's the only rule selected in <code>ruff.toml</code>.</p>
</blockquote>
<p>That's the correct error. The example uses dataclasses. <code>RUF009</code> is also affected by <code>extend-immutable-calls</code> as documented at https://docs.astral.sh/ruff/settings/#lint_flake8-bugbear_extend-immutable-calls. Oddly, only the example using an absolute import is working now. I swear when I made the example, the non-sub-package relative import worked.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntBre">@ntBre</a> on 2025-05-30 17:26</div>
            <div class="timeline-body"><p>Oh I see, I missed that in the docs, thanks! I'll take a closer look at the reproduction then.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">needs-mre</span> removed by @ntBre on 2025-05-30 17:26</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @ntBre on 2025-05-30 17:26</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntBre">@ntBre</a> on 2025-06-02 17:59</div>
            <div class="timeline-body"><p>Just to make this a little easier to glance at in the future, this is the project structure in the <code>example</code> directory:</p>
<pre><code>.
â”œâ”€â”€ package
â”‚Â Â  â”œâ”€â”€ custom_field.py
â”‚Â Â  â”œâ”€â”€ sub_package
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ does_not_work.py
â”‚Â Â  â”‚Â Â  â””â”€â”€ works.py
â”‚Â Â  â””â”€â”€ works.py
â””â”€â”€ ruff.toml
</code></pre>
<p>And these are the contents of the files, with comments added showing where RUF009 is emitted.</p>
<h3><code>ruff.toml</code></h3>
<pre><code class="language-toml">[lint]
select = [&quot;RUF&quot;]
flake8-bugbear.extend-immutable-calls = [&quot;package.custom_field.custom_field&quot;]
</code></pre>
<h3><code>package/custom_field.py</code></h3>
<pre><code class="language-python">def custom_field() -&gt; list[int]:
    return [1, 2, 3, 4]
</code></pre>
<h3><code>package/sub_package/does_not_work.py</code></h3>
<pre><code class="language-python">from dataclasses import dataclass

from ..custom_field import custom_field


@dataclass
class A:
    some_field: list[int] = custom_field()  # RUF009
</code></pre>
<h3><code>package/sub_package/works.py</code></h3>
<pre><code class="language-python">from dataclasses import dataclass

from package.custom_field import custom_field


@dataclass
class A:
    some_field: list[int] = custom_field()
</code></pre>
<h3><code>package/works.py</code></h3>
<pre><code class="language-python">from dataclasses import dataclass

from .custom_field import custom_field


@dataclass
class A:
    some_field: list[int] = custom_field()  # RUF009
</code></pre>
<p>If I add an empty <code>package/__init__.py</code> file, I get the error in <code>package/works.py</code> to go away. Could that be what you were seeing before?</p>
<p>In that case, the false positive would be with the <code>from ..custom_field import custom_field</code> import in <code>package/sub_package/does_not_work.py</code>.</p>
<p>As a minor note, everything still seems to reproduce even if I delete <code>package/custom_field.py</code>, which might be a slight help to someone turning this into a CLI test in the future.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/JuneStepp">@JuneStepp</a> on 2025-06-02 18:13</div>
            <div class="timeline-body"><blockquote>
<p>If I add an empty package/<strong>init</strong>.py file, I get the error in package/works.py to go away. Could that be what you were seeing before?</p>
</blockquote>
<p>Probably.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 11:37:32 UTC
    </footer>
</body>
</html>
