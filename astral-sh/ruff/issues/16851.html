<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[red-knot] Ban most `Type::Instance` types in type expressions - astral-sh/ruff #16851</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[red-knot] Ban most `Type::Instance` types in type expressions</h1>

    <div class="meta">
        <span class="state state-closed">Closed</span>
        <a href="https://github.com/astral-sh/ruff/issues/16851">#16851</a>
        opened by <a href="https://github.com/AlexWaygood">@AlexWaygood</a>
        on 2025-03-19 16:00
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-03-19 16:00</div>
            <div class="timeline-body"><p>If a symbol that we infer as having an instance type appears in a type expression, we should almost always emit a diagnostic saying that it's an invalid type expression. For example:</p>
<pre><code class="language-py">def f(x: int):
    def g(y: x): ...  # the annotation for `y` here is invalid:
                      # `x` has a `Type::Instance` type.
                      # We need to emit a diagnostic for type expressions like this
</code></pre>
<p>Making this change involves changing this branch of <code>Type::in_type_expression()</code> so that it returns an <code>Err()</code> in most cases:</p>
<p>https://github.com/astral-sh/ruff/blob/98fdc0ebae5b1f8279d2400445acaf3f172a6513/crates/red_knot_python_semantic/src/types.rs#L3328-L3330</p>
<p>But we need to make sure we avoid emitting an error if an instance of a <code>TypeVar</code>, <code>TypeVarTuple</code> or <code>ParamSpec</code> is used in a type expression, e.g.</p>
<pre><code class="language-py">from typing import TypeVar

T = TypeVar(&quot;T&quot;)

def f(x: T) -&gt; T: ...  # annotation for `x` is valid here,
                       # despite the fact that we currently infer it as a `Type::Instance` type
</code></pre>
<p>To avoid these false positives, we should probably do something like this for the branch:</p>
<pre><code class="language-rs">            Type::Instance(InstanceType { class }) =&gt; match class.known(db) {
                Some(KnownClass::TypeVar) =&gt; Ok(todo_type!(&quot;Support for `typing.TypeVar` instances in type expressions&quot;)),
                Some(KnownClass::ParamSpec) =&gt; Ok(todo_type!(&quot;Support for `typing.ParamSpec` instances in type expressions&quot;)),
                Some(KnownClass::TypeVarTuple) =&gt; Ok(todo_type!(&quot;Support for `typing.TypeVarTuple` instances in type expressions&quot;)),
                _ =&gt; Err(...)
            }
</code></pre>
<p>Note that we do not yet have <code>ParamSpec</code> and <code>TypeVarTuple</code> variants in our <code>KnownClass</code> enum, but they probably need to be added in order to complete this task.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">help wanted</span> added by @AlexWaygood on 2025-03-19 16:00</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by @AlexWaygood on 2025-03-19 16:00</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/16872.html">astral-sh/ruff#16872</a> on 2025-03-20 15:00</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @carljm on 2025-03-20 22:19</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @carljm on 2025-03-20 22:19</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:34:54 UTC
    </footer>
</body>
</html>
