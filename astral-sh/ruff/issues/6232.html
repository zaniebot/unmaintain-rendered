<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>requires-python being set as * makes ruff fail - astral-sh/ruff #6232</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>requires-python being set as * makes ruff fail</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/issues/6232">#6232</a>
        opened by <a href="https://github.com/a666">@a666</a>
        on 2023-08-01 08:08
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/a666">@a666</a> on 2023-08-01 08:08</div>
            <div class="timeline-body"><p>Given:</p>
<pre><code class="language-toml">#pyproject.toml
[project]
#...
requires-python = &quot;*&quot;
#...
[tool.ruff]
target-version = &quot;py39&quot;
</code></pre>
<p>And running:</p>
<pre><code class="language-shell">$ ruff --fix something.py
ruff failed
  Cause: TOML parse error at line 9, column 19
  |
9 | requires-python = &quot;*&quot;
  |                   ^^^
Failed to parse version:
*
^
</code></pre>
<p>Shouldn't <code>target-version</code> take priority over <code>requires-python</code>?
Then again I'm not even sure if setting requires-python as <code>&quot;*&quot;</code> is correct...
Cannot find documentation about it, but seems to be a valid value in <code>pdm</code> and <code>poetry</code>...</p>
<p>Running command with <code>--isolated</code> is not relevant in this case (the toml config is the problem).</p>
<pre><code class="language-shell">$ ruff --version
ruff 0.0.281
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/flying-sheep">@flying-sheep</a> on 2023-08-01 09:55</div>
            <div class="timeline-body"><blockquote>
<p>Then again I'm not even sure if setting requires-python as &quot;*&quot; is correct...</p>
</blockquote>
<p>almost definitely not, only very very trivial snippets could still run with Python 1.0</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2023-08-01 14:21</div>
            <div class="timeline-body"><p>Hm this is not really used in the wild https://github.com/search?q=%22requires-python+%3D+%5C%22*%5C%22%22&amp;type=code — I do not think we should support this.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-08-01 15:48</div>
            <div class="timeline-body"><p>It should probably parse though, if it's valid according to the spec. @konstin would know.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2023-08-01 16:14</div>
            <div class="timeline-body"><p>This option follows the PEP-440 version specifiers spec (https://peps.python.org/pep-0440/) which does not appear to allow a lonely <code>*</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/a666">@a666</a> on 2023-08-01 16:15</div>
            <div class="timeline-body"><p>Also note that both <a href="https://pdm.fming.dev/latest/usage/dependency/#save-version-specifiers">pdm</a> and <a href="https://python-poetry.org/docs/dependency-specification/#wildcard-requirements">poetry</a> both seem to support it. Because it solves a real issue (what if you don't care about the version and only want the latest, setting <code>ruff = &quot;*&quot;</code> as dev dependency is a classic example).</p>
<p>The real question is if <code>requires-python</code> should be parsed if ruff's <code>target-version</code> is set?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2023-08-01 16:19</div>
            <div class="timeline-body"><p><code>*</code> is not a valid value for <code>requires-python</code> (it's defined through <a href="https://packaging.python.org/en/latest/specifications/core-metadata/#requires-python">Requires-Python</a> which allows <a href="https://peps.python.org/pep-0440/#version-matching">trailing <code>.*</code></a> but no star alone. pdm 2.8.2 generates <code>requires-python = &quot;&gt;=3.8&quot;</code> if i enter <code>*</code> in the interactive dialog for python requires. Poetry currently uses <code>tool.poetry.dependencies.python</code> with their own syntax which predates <code>[project]</code> (but they have plans to move to the standard too).</p>
<p>The reason why ruff fails to start even though we don't actually need the value is a bit more complex: We load the whole toml file into our schema, and our schema has a parsed version object, so we can't load it even if we don't need the value. The error message could be better though (it doesn't tell you about pyproject.toml or https://packaging.python.org/en/latest/specifications/declaring-project-metadata/#declaring-project-metadata or PEP 440).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/a666">@a666</a> on 2023-08-01 16:28</div>
            <div class="timeline-body"><p>Understood, setting requires-python to a valid version spec.</p>
<p>Still, the PEPs always seem to fall short, and <code>*</code> seems like a valid value to me for certain usecases...</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2023-08-01 16:33</div>
            <div class="timeline-body"><p>@a666 for which use-case? If it's not a valid specifier and not a correct declaration of compatible Python versions why not just use <code>&gt;=3.7</code> or <code>&gt;3</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2023-08-01 16:42</div>
            <div class="timeline-body"><blockquote>
<p>Also note that both <a href="https://pdm.fming.dev/latest/usage/dependency/#save-version-specifiers">pdm</a> and <a href="https://python-poetry.org/docs/dependency-specification/#wildcard-requirements">poetry</a> both seem to support it. Because it solves a real issue (what if you don't care about the version and only want the latest, setting ruff = &quot;*&quot; as dev dependency is a classic example).</p>
</blockquote>
<p>The pdm one is interesting, because they are using the <code>*</code> very liberally/just metaphorically and don't actually write one. E.g. <code>pdm add --save-wildcard requests</code> writes:</p>
<pre><code class="language-toml">[project]
name = &quot;a&quot;
version = &quot;0.1.0&quot;
description = &quot;&quot;
authors = [
    {name = &quot;konstin&quot;, email = &quot;konstin@mailbox.org&quot;},
]
dependencies = [
    &quot;requests&quot;,
]
requires-python = &quot;&gt;=3.8&quot;
readme = &quot;README.md&quot;
license = {text = &quot;MIT&quot;}

[build-system]
requires = [&quot;pdm-backend&quot;]
build-backend = &quot;pdm.backend&quot;
</code></pre>
<p>There's no <code>*</code> in there, they just elide the version altogether! I'd very much not recommend that (there's clearly at least a minimum version you, if you don't write it down you risk version resolution picking a too old and cause weird hard to debug breakage), but it's possible. <code>requires-python</code> is an optional field, so the equivalent would be to elide the field. Again, i recommend determining the actual lower limit of your code and setting this; Given that you set <code>target-version = &quot;py39&quot;</code> i'd recommend <code>&gt;=3.9</code></p>
<p>Poetry otoh extended PEP 440 with <code>*</code> because they use a toml table instead of a list of strings (<code>package_name = &quot;1.2.3&quot;</code> instead of <code>package_name==1.2.3</code>). I don't know whether they will keep their PEP 440 extensions when <a href="https://github.com/python-poetry/roadmap/issues/3">migrating to PEP 621</a>. As much as i'd like to change PEP 440, this is a contentious topic and at least the case of any version is already covered for <code>[project]</code> by eliding the version.</p>
<p>(sorry for the wall of specification and packaging tooling minutiae, i used to work on packaging tooling and reimplemented PEP 440 so i have way to many details on this)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/a666">@a666</a> on 2023-08-01 16:54</div>
            <div class="timeline-body"><p>Yeah, I was writing my own wall of text, mostly related to pdm and poetry stuff...</p>
<p>In short, we've had some issues with dependency management.
Setting <code>requires-python = &quot;&gt;=3.7&quot;</code> makes every tool/lib/dependency version that declares <code>requires-python = &quot;&gt;=3.9&quot;</code> uninstalable (or reverts to the version that agrees with &quot;&gt;=3.7&quot;), so setting it to <code>&quot;*&quot;</code> would solve the issue.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-08-05 16:43</div>
            <div class="timeline-body"><p>@konstin @zanieb - Anyone have a strong opinion on how to resolve?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2023-08-05 18:21</div>
            <div class="timeline-body"><p>I guess I don't quite understand how setting it to <code>*</code> resolves the dependency resolution issue — this sounds like a discussion for the upstream package managers.</p>
<p>I think that at most we should handle invalid version specifiers in <code>requires-python</code> by throwing a warning and continuing with our default / oldest compatible Python version. I'm not sure it's our role to enforce this is a valid version specifier and I'm hesitant to special case an invalid specification like <code>*</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2023-08-07 09:06</div>
            <div class="timeline-body"><p>The solution for the project would be removing <code>requires-python</code> (it's an optional field) or setting it to the effective minimal version. From our end we could improve the error message be special casing <code>*</code>, but i wouldn't want to start accepting invalid pyproject.toml for fields that ruff's behavior depends on.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-09-22 04:13</div>
            <div class="timeline-body"><p>I'm going to close this for now -- it sounds like we'd prefer not to special case <code>*</code>, and we're not fully clear on why <code>*</code> is necessary.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2023-09-22 04:13</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 11:30:53 UTC
    </footer>
</body>
</html>
