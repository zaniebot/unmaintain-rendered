<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Config file &quot;extend&quot; not working from language server - astral-sh/ruff #13261</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Config file &quot;extend&quot; not working from language server</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/issues/13261">#13261</a>
        opened by <a href="https://github.com/jakeanq">@jakeanq</a>
        on 2024-09-06 07:44
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/jakeanq">@jakeanq</a> on 2024-09-06 07:44</div>
            <div class="timeline-body"><!--
Thank you for taking the time to report an issue! We're glad to have you involved with Ruff.

If you're filing a bug report, please consider including the following information:

* List of keywords you searched for before creating this issue. Write them down here so that others can find this issue more easily and help provide feedback.
  e.g. "RUF001", "unused variable", "Jupyter notebook"
* A minimal code snippet that reproduces the bug.
* The command you invoked (e.g., `ruff /path/to/file.py --fix`), ideally including the `--isolated` flag.
* The current Ruff settings (any relevant sections from your `pyproject.toml`).
* The current Ruff version (`ruff --version`).
-->

<p>I don't seem to be able to include a config file from another config file when using the language server, however it works fine from the command line.</p>
<h2>Example</h2>
<p>This is fairly arbitrary...</p>
<p><code>ruff_config1.toml</code>:</p>
<pre><code class="language-toml">[lint]
select = [&quot;F401&quot;, &quot;F821&quot;, &quot;ANN&quot;]
</code></pre>
<p><code>ruff_config2.toml</code>:</p>
<pre><code class="language-toml">extend = &quot;./ruff_config1.toml&quot;
[lint]
ignore = [&quot;F401&quot;]
</code></pre>
<p><code>ruff_test.py</code>:</p>
<pre><code class="language-py">import typing

print(lemurs)

def x():
    return 10
</code></pre>
<p>When I run this with <code>ruff check</code> I get the expected output:</p>
<pre><code>$ ruff check ruff_test.py --config ~/ruff_configs/ruff_config2.toml --output-format concise
ruff_test.py:3:7: F821 Undefined name `lemurs`
ruff_test.py:5:5: ANN201 Missing return type annotation for public function `x`
Found 2 errors.
No fixes available (1 hidden fix can be enabled with the `--unsafe-fixes` option).
</code></pre>
<p>(note that F821 is a default rule)</p>
<p>However with the following Neovim LSP config:</p>
<pre><code>lc = require'lspconfig'
lc.ruff.setup{
  init_options = {
    settings = {
      configuration = &quot;~/ruff_configs/ruff_config2.toml&quot;
    }
  }
}
</code></pre>
<p>I see the F821 violation (this is enabled by default and indicates that checking is working) and I don't see the F401 violation (expected, indicating that <code>ruff_config2.toml</code> is being loaded, since that rule is enabled by default) but I don't see the ANN201 violation, indicating that <code>ruff_config1.toml</code> was not loaded.</p>
<p>I have also tried changing the <code>extend</code> path to use an absolute path or a path based on an environment variable, but it doesn't seem to make a difference.</p>
<p>Replicated with <code>ruff</code> 0.6.2 and 0.6.3.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @MichaReiser on 2024-09-08 10:27</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">server</span> added by @MichaReiser on 2024-09-08 10:27</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-09-08 10:27</div>
            <div class="timeline-body"><p>Thanks for reporting this.</p>
<p>I haven't reproduced it yet myself, but I'm pretty confident to say that this is a bug in the server. The server loads the configuration but it doesn't follow the <code>extends</code> chain here (not saying that we should add it here ;))</p>
<p>https://github.com/astral-sh/ruff/blob/0c98b5949c90a570fb500df78590f0ee60f6ba4f/crates/ruff_server/src/session/index/ruff_settings.rs#L342-L352</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-09-08 16:31</div>
            <div class="timeline-body"><p>I think the fix is:</p>
<pre><code class="language-rust">fn open_configuration_file(config_path: &amp;Path) -&gt; crate::Result&lt;Configuration&gt; {
    ruff_workspace::resolver::resolve_configuration(config_path, Relativity::Parent, &amp;())
}
</code></pre>
<p>Need to find a good approach to test this change.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">great writeup</span> added by @MichaReiser on 2024-09-08 19:26</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @MichaReiser on 2024-09-09 18:46</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/jakeanq">@jakeanq</a> on 2024-09-17 12:50</div>
            <div class="timeline-body"><p>Thank you for the fix!  It is working perfectly with the newly released ruff.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 11:35:03 UTC
    </footer>
</body>
</html>
