<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>F821 (Undefined name) and F722 (bad forward annotation) can trigger on `@no_type_check`-ed annotations - astral-sh/ruff #13824</title>
    <link rel="stylesheet" href="../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../index.html">Back to index</a>
    </div>

    <h1>F821 (Undefined name) and F722 (bad forward annotation) can trigger on `@no_type_check`-ed annotations</h1>

    <div class="meta">
        <span class="state state-closed">Closed</span>
        <a href="https://github.com/astral-sh/ruff/issues/13824">#13824</a>
        opened by <a href="https://github.com/Wuestengecko">@Wuestengecko</a>
        on 2024-10-19 17:37
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/Wuestengecko">@Wuestengecko</a> on 2024-10-19 17:37</div>
            <div class="timeline-body"><!--
Thank you for taking the time to report an issue! We're glad to have you involved with Ruff.

If you're filing a bug report, please consider including the following information:

* List of keywords you searched for before creating this issue. Write them down here so that others can find this issue more easily and help provide feedback.
  e.g. "RUF001", "unused variable", "Jupyter notebook"
* A minimal code snippet that reproduces the bug.
* The command you invoked (e.g., `ruff /path/to/file.py --fix`), ideally including the `--isolated` flag.
* The current Ruff settings (any relevant sections from your `pyproject.toml`).
* The current Ruff version (`ruff --version`).
-->

<p>Hi! I found that F821 (&quot;Undefined name&quot;) and F722 (&quot;Syntax error in forward annotation&quot;) can erroneously trigger on functions that marked <code>@no_type_check</code>, if they happen to either use names that aren't in scope, or aren't even valid Python.</p>
<p>Consider the following example file:</p>
<pre><code class="language-python">from typing import no_type_check

@no_type_check
def f821(arg: &quot;A&quot;) -&gt; &quot;R&quot;:
    pass

@no_type_check
def f722(arg: &quot;this isn't python&quot;) -&gt; &quot;this isn't python either&quot;:
    pass
</code></pre>
<p>Save it as &quot;demo.py&quot; and run ruff with:</p>
<pre><code>ruff check --isolated --select=F722,F821 demo.py --output-format concise</code></pre>
<p>This will emit the following errors, which are all false-positives:</p>
<pre><code>demo.py:4:16: F821 Undefined name `A`
demo.py:4:24: F821 Undefined name `R`
demo.py:8:15: F722 Syntax error in forward annotation: `this isn't python`
demo.py:8:39: F722 Syntax error in forward annotation: `this isn't python either`
Found 4 errors.
</code></pre>
<p>I'm presuming (but haven't tested) that this could apply to other rules that inspect annotations as well. Ruff should treat these annotations as opaque strings without any meaning. As per <a href="https://peps.python.org/pep-0484/#the-meaning-of-annotations">PEP-484</a>:</p>
<blockquote>
<p>Functions with the <code>@no_type_check</code> decorator should be treated as having no annotations.</p>
</blockquote>
<hr />
<p><strong>ruff --version</strong>: 0.7.0
<strong>settings</strong>: no config file exists</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">rule</span> added by @MichaReiser on 2024-10-19 19:06</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-10-19 19:06</div>
            <div class="timeline-body"><p>Thanks for reporting. Suppressing some rules annotated with <code>@no_type_check</code> makes sense to me.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-10-19 22:43</div>
            <div class="timeline-body"><p>This seems reasonable to me too</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">help wanted</span> added by @AlexWaygood on 2024-10-19 22:43</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-11-09 19:36</div>
            <div class="timeline-body"><p>Should we just skip visiting them altogether when in a <code>@no_type_check</code> context?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-11-11 13:12</div>
            <div class="timeline-body"><blockquote>
<p>Should we just skip visiting them altogether when in a <code>@no_type_check</code> context?</p>
</blockquote>
<p>That might make sense, yeah</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-11-11 13:48</div>
            <div class="timeline-body"><blockquote>
<p>Should we just skip visiting them altogether when in a @no_type_check context?</p>
</blockquote>
<p>Are you suggesting skipping such functions only for <code>F821</code> and <code>F722</code> or all rules?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-11-11 13:49</div>
            <div class="timeline-body"><p>I'm suggesting skipping looking at those nodes entirely, for all rules.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-11-11 13:53</div>
            <div class="timeline-body"><p>Alternatively, we could visit them as strings (so enforce rules like implicit concat -- weird but possible) but skip parsing them and visiting the <em>content</em>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-11-11 13:58</div>
            <div class="timeline-body"><p>To clarify, with all nodes you mean skipping the entire function or only the type annotations? I'm somewhat fine skipping the annotations but would find it a stretch if we skip the entire function</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-11-11 14:02</div>
            <div class="timeline-body"><p>Just the annotations. The rest of the function would be unchanged.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/14615.html">astral-sh/ruff#14615</a> on 2024-11-26 17:45</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a> on 2024-11-27 09:31</div>
            <div class="timeline-body"><p>This seems to have been resolved by #14615.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @MichaReiser on 2024-11-27 10:05</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Reopened by @MichaReiser on 2024-12-02 12:20</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-12-02 12:20</div>
            <div class="timeline-body"><p>We'll probably <a href="https://github.com/astral-sh/ruff/pull/14726">revert this change</a>. It's a bit more involved, see https://github.com/astral-sh/ruff/issues/14698</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/15215.html">astral-sh/ruff#15215</a> on 2025-01-02 00:12</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @MichaReiser on 2025-01-03 09:05</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:28:14 UTC
    </footer>
</body>
</html>
