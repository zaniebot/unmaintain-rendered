<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formatter is formatting inconsistent in CI - astral-sh/ruff #10302</title>
    <link rel="stylesheet" href="../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../index.html">Back to index</a>
    </div>

    <h1>Formatter is formatting inconsistent in CI</h1>

    <div class="meta">
        <span class="state state-closed">Closed</span>
        <a href="https://github.com/astral-sh/ruff/issues/10302">#10302</a>
        opened by <a href="https://github.com/joostlek">@joostlek</a>
        on 2024-03-08 22:56
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/joostlek">@joostlek</a> on 2024-03-08 22:56</div>
            <div class="timeline-body"><!--
Thank you for taking the time to report an issue! We're glad to have you involved with Ruff.

If you're filing a bug report, please consider including the following information:

* A minimal code snippet that reproduces the bug.
* The command you invoked (e.g., `ruff /path/to/file.py --fix`), ideally including the `--isolated` flag.
* The current Ruff settings (any relevant sections from your `pyproject.toml`).
* The current Ruff version (`ruff --version`).
-->

<p>When upgrading to ruff 0.3.1 we encountered a special formatting issue in Ruff which was only happening in the CI.</p>
<p>When running ruff locally it seems to favor this variant:</p>
<pre><code class="language-py">    with patch(
        &quot;bleak.BleakScanner.discovered_devices_and_advertisement_data&quot;,  # Must patch before we setup
        {
            &quot;44:44:33:11:23:45&quot;: (
                MagicMock(address=&quot;44:44:33:11:23:45&quot;),
                MagicMock(),
            )
        },
    ):
</code></pre>
<p>But when committing this and pushing this, the CI will complain that this is not correct:</p>
<pre><code class="language-diff">diff --git a/tests/components/bluetooth/test_passive_update_coordinator.py b/tests/components/bluetooth/test_passive_update_coordinator.py
index cbe23142..f4128c98 100644
--- a/tests/components/bluetooth/test_passive_update_coordinator.py
+++ b/tests/components/bluetooth/test_passive_update_coordinator.py
@@ -142,14 +142,16 @@ async def test_unavailable_callbacks_mark_the_coordinator_unavailable(
 ) -&gt; None:
     &quot;&quot;&quot;Test that the coordinator goes unavailable when the bluetooth stack no longer sees the device.&quot;&quot;&quot;
     start_monotonic = time.monotonic()
-    with patch(
-        &quot;bleak.BleakScanner.discovered_devices_and_advertisement_data&quot;,  # Must patch before we setup
-        {
-            &quot;44:44:33:11:23:45&quot;: (
-                MagicMock(address=&quot;44:44:33:11:23:45&quot;),
-                MagicMock(),
-            )
-        },
+    with (
+        patch(
+            &quot;bleak.BleakScanner.discovered_devices_and_advertisement_data&quot;,  # Must patch before we setup
+            {
+                &quot;44:44:33:11:23:45&quot;: (
+                    MagicMock(address=&quot;44:44:33:11:23:45&quot;),
+                    MagicMock(),
+                )
+            },
+        )
     ):
</code></pre>
<p><a href="https://github.com/home-assistant/core/actions/runs/8209853253/job/22456201337?pr=112690">CI run</a>
I mean that's strange, they usually are doing the same. But when we listen to the CI and commit what they propose we get this:</p>
<pre><code class="language-diff">diff --git a/tests/components/bluetooth/test_passive_update_coordinator.py b/tests/components/bluetooth/test_passive_update_coordinator.py
index f4128c98..cbe23142 100644
--- a/tests/components/bluetooth/test_passive_update_coordinator.py
+++ b/tests/components/bluetooth/test_passive_update_coordinator.py
@@ -142,16 +142,14 @@ async def test_unavailable_callbacks_mark_the_coordinator_unavailable(
 ) -&gt; None:
     &quot;&quot;&quot;Test that the coordinator goes unavailable when the bluetooth stack no longer sees the device.&quot;&quot;&quot;
     start_monotonic = time.monotonic()
-    with (
-        patch(
-            &quot;bleak.BleakScanner.discovered_devices_and_advertisement_data&quot;,  # Must patch before we setup
-            {
-                &quot;44:44:33:11:23:45&quot;: (
-                    MagicMock(address=&quot;44:44:33:11:23:45&quot;),
-                    MagicMock(),
-                )
-            },
-        )
+    with patch(
+        &quot;bleak.BleakScanner.discovered_devices_and_advertisement_data&quot;,  # Must patch before we setup
+        {
+            &quot;44:44:33:11:23:45&quot;: (
+                MagicMock(address=&quot;44:44:33:11:23:45&quot;),
+                MagicMock(),
+            )
+        },
     ):
         await async_setup_component(hass, DOMAIN, {DOMAIN: {}})
         await hass.async_block_till_done()
</code></pre>
<p><a href="https://github.com/home-assistant/core/actions/runs/8209297748/job/22454549068?pr=112690">CI run</a></p>
<p>Within the home assistant project we don't have any specific settings for the formatter (as far as I know).</p>
<p>Good to mention, both locally as in the CI pre-commit is used to run ruff.</p>
<p>Let me know if you need more information.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-03-08 23:19</div>
            <div class="timeline-body"><p>Thanks! There are a few open PRs from today to fix up issues in with formatting. I’m planning to review and merge them tonight (hopefully). I’ll check if they resolve this case.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @charliermarsh by @charliermarsh on 2024-03-08 23:20</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @charliermarsh on 2024-03-08 23:20</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-03-09 07:11</div>
            <div class="timeline-body"><p>Thanks for reporting, and I'm sorry for the inconvenience. I just tested the example in our playground that uses 0.3.2 and it now uses a consistent formatting. https://play.ruff.rs/99f78327-4a41-4c57-9b2c-bbfafab494a9</p>
<p>This is related to https://github.com/astral-sh/ruff/issues/10267</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @MichaReiser on 2024-03-09 07:11</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/joostlek">@joostlek</a> on 2024-03-09 10:04</div>
            <div class="timeline-body"><p>Ooh that also makes sense, i still run 3.11 locally and the CI just got updated to 3.12 yesterday afternoon. Thanks!</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:28:12 UTC
    </footer>
</body>
</html>
