```yaml
number: 20774
title: Formatter can reuse nested quotes before 3.12
type: issue
state: closed
author: ntBre
labels:
  - bug
  - formatter
assignees: []
created_at: 2025-10-08T19:26:06Z
updated_at: 2025-10-17T12:49:17Z
url: https://github.com/astral-sh/ruff/issues/20774
synced_at: 2026-01-10T01:56:57Z
```

# Formatter can reuse nested quotes before 3.12

---

_Issue opened by @ntBre on 2025-10-08 19:26_

### Summary

While updating our black compatibility tests for https://github.com/astral-sh/ruff/pull/20768, I ran into a failure related to this test case:

```py
f"{f'''{'nested'} inner'''} outer"
```

This is valid on Python versions before 3.12 (when quote reuse became allowed in f-strings), but the formatted result converts the innermost quotes to double quotes, making it invalid:

```py
f"{f'''{"nested"} inner'''} outer"
```

I was hoping to put up a quick PR fixing this, but I'm still working on it and figured I might as well open an issue. I bisected the issue to #13906, but that's not too helpful because this PR is when we first introduced f-string formatting, as Micha pointed out on Discord.

Something interesting I've found besides the bug itself is that our main `format` test doesn't really catch this. `fstring.py` actually has more unsupported syntax errors before formatting than after, which I think prevents our error fingerprinting from working as intended. Our test runner produces a snapshot with the invalid quotes above, without panicking from the new unsupported syntax error, like the black test did.

I've played a bit with more information we could add to the fingerprint, but unfortunately I haven't found a good solution there yet either.

---

_Assigned to @ntBre by @ntBre on 2025-10-08 19:26_

---

_Label `bug` added by @ntBre on 2025-10-08 19:26_

---

_Label `formatter` added by @ntBre on 2025-10-08 19:26_

---

_Comment by @MichaReiser on 2025-10-08 20:41_

Could we list the syntax errors at the end of the test snapshot? We could even use diagnostics to render them nicely 

---

_Referenced in [astral-sh/ruff#20777](../../astral-sh/ruff/pulls/20777.md) on 2025-10-08 22:00_

---

_Referenced in [astral-sh/ruff#20794](../../astral-sh/ruff/pulls/20794.md) on 2025-10-09 21:54_

---

_Referenced in [astral-sh/ruff#20930](../../astral-sh/ruff/pulls/20930.md) on 2025-10-16 20:33_

---

_Closed by @ntBre on 2025-10-17 12:49_

---
