<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bug in PIE790 in Ruff v0.1.6 (`...` is meaningful in protocol methods and should not be removed) - astral-sh/ruff #8756</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Bug in PIE790 in Ruff v0.1.6 (`...` is meaningful in protocol methods and should not be removed)</h1>

    <div class="meta">
        <span class="state state-closed">Closed</span>
        <a href="https://github.com/astral-sh/ruff/issues/8756">#8756</a>
        opened by <a href="https://github.com/kkom">@kkom</a>
        on 2023-11-18 16:42
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/kkom">@kkom</a> on 2023-11-18 16:42</div>
            <div class="timeline-body"><p>Hey, I've got a regression in Ruff 0.1.6 to report.</p>
<p>PIE790 wants the <code>...</code> removed, but it's necessary in this case – because <code>foo</code> is a protocol method:</p>
<pre><code class="language-python">from typing import Protocol

class Repro(Protocol):
    def foo(self) -&gt; str:
        &quot;&quot;&quot;docblock&quot;&quot;&quot;
        ...
</code></pre>
<p>At least according to Pyright 1.1.336, which shows this error if I allow Ruff to remove the <code>...</code>:</p>
<pre><code>error: Function with declared return type &quot;str&quot; must return value on all code paths
    &quot;None&quot; is incompatible with &quot;str&quot; (reportGeneralTypeIssues)
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2023-11-18 16:50</div>
            <div class="timeline-body"><p>Thanks for the report!</p>
<p>Would you mind reporting this on mypy? This seems like a bug on their end unless there's something in the specification that says <code>...</code> is required for protocol methods.</p>
<p>ref https://peps.python.org/pep-0544/</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/kkom">@kkom</a> on 2023-11-18 16:51</div>
            <div class="timeline-body"><p>Ah, I didn't think of it this way! Yeah, it's possible Pyright is in the (heh) wrong here. I'll report!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../microsoft/pyright/issues/6487.html">microsoft/pyright#6487</a> on 2023-11-18 17:09</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/erictraut">@erictraut</a> on 2023-11-18 17:21</div>
            <div class="timeline-body"><p>I'm the author of pyright, and I can say that this isn't a bug in pyright. Ruff's formatter should not remove the ellipsis in this case because it has significant meaning.</p>
<p>A protocol class is allowed to provide a default implementation for a method, in which case all subclasses of that protocol inherit that implementation. If the implementation of a method does not include a <code>...</code> as its implementation, pyright assumes it's a default implementation and type checks it accordingly.</p>
<p>I'll note that <code>black</code> doesn't remove the ellipsis in this case, so I consider this a bug in ruff's formatter.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../microsoft/pylance-release/issues/5127.html">microsoft/pylance-release#5127</a> on 2023-11-18 17:23</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "Bug in PIE790 in Ruff v0.1.6 (`...` is necessary for protocol methods which return something else than None)" to "Bug in PIE790 in Ruff v0.1.6 (`...` is meaningul in protocol methods and should not be removed)" by @kkom on 2023-11-18 17:29</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "Bug in PIE790 in Ruff v0.1.6 (`...` is meaningul in protocol methods and should not be removed)" to "Bug in PIE790 in Ruff v0.1.6 (`...` is meaningful in protocol methods and should not be removed)" by @kkom on 2023-11-18 17:29</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2023-11-18 18:14</div>
            <div class="timeline-body"><p>Thanks for the context Eric!</p>
<p>This isn't part of Ruff's formatter — it will never change the semantics of the code.</p>
<p>This is a fix for rule removing unnecessary <code>pass</code> statements which was recently expanded to include ellipses (<code>...</code>). If a function has a docstring, there is no need for a <code>pass</code> or <code>...</code> for it to be syntactically valid. Should Pyright be treating a function with no expressions in its body as the default implementation? Is that part of the protocol specification or is that just what you've implemented?</p>
<p>Regardless, I think we should add a special exemption to this lint rule in Ruff.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2023-11-18 18:17</div>
            <div class="timeline-body"><p>It looks like mypy (1.7.0) does not raise an error for this</p>
<pre><code class="language-python">from typing import Protocol


class Repro(Protocol):
    def foo(self) -&gt; str:
        &quot;&quot;&quot;docblock&quot;&quot;&quot;
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/erictraut">@erictraut</a> on 2023-11-18 18:26</div>
            <div class="timeline-body"><blockquote>
<p>Is that part of the protocol specification or is that just what you've implemented?</p>
</blockquote>
<p>The protocol spec doesn't specify this, nor do any other parts of the typing spec. Pyright's treatment of <code>...</code> as a placeholder is consistent with how an ellipsis is used elsewhere in the language and typing spec.</p>
<p>Mypy's treatment of <code>...</code> in function bodies is inconsistent. It treats <code>...</code> as a placeholder in protocols but not in regular classes. Mypy's behavior has also <a href="https://microsoft.github.io/pyright/#/mypy-comparison?id=ellipsis-in-function-body">changed over time</a>. Pyright's behavior has been consistent and principled. I'm not inclined to change it because this would be disruptive to pyright users who rely on the current behavior.</p>
<blockquote>
<p>This is a fix for rule removing unnecessary <code>pass</code> statements which was recently expanded to include ellipses (...).</p>
</blockquote>
<p>Ah, I see. Thanks for the clarification. Yes, I agree that it would be good to add an exemption for this case. The <code>...</code> is not extraneous in this situation.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @charliermarsh on 2023-11-18 23:17</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-11-18 23:22</div>
            <div class="timeline-body"><p>Thanks @erictraut! Does this apply anywhere outside of <code>Protocol</code> methods? Should be an easy fix.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/erictraut">@erictraut</a> on 2023-11-18 23:29</div>
            <div class="timeline-body"><p>It also applies to abstract methods (those decorated with <code>@abc.abstractmethod</code>) within an abstract class. Protocols and abstract classes are closely related.</p>
<blockquote>
<p>Should be an easy fix.</p>
</blockquote>
<p>Great to hear!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-11-18 23:37</div>
            <div class="timeline-body"><p>Okay great, thanks Eric!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @charliermarsh by @charliermarsh on 2023-11-18 23:41</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-11-18 23:41</div>
            <div class="timeline-body"><p>I can take this one since it's my regression :)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/8769.html">astral-sh/ruff#8769</a> on 2023-11-19 14:50</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2023-11-19 15:05</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/9840.html">astral-sh/ruff#9840</a> on 2024-02-05 18:50</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/10358.html">astral-sh/ruff#10358</a> on 2024-03-12 14:23</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/rsokl">@rsokl</a> on 2024-03-12 14:41</div>
            <div class="timeline-body"><blockquote>
<p>Does this apply anywhere outside of Protocol methods?</p>
</blockquote>
<p>This also applies for stubs defined inside <code>if TYPE_CHECKING</code> clauses. See https://github.com/astral-sh/ruff/issues/10358</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/10538.html">astral-sh/ruff#10538</a> on 2024-03-25 14:20</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../pypa/setuptools/pulls/4192.html">pypa/setuptools#4192</a> on 2024-08-21 14:59</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../pylint-dev/pylint/issues/9319.html">pylint-dev/pylint#9319</a> on 2024-10-27 20:56</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:34:51 UTC
    </footer>
</body>
</html>
