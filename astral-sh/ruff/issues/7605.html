<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formatter instability: hard line break in binary expression - astral-sh/ruff #7605</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Formatter instability: hard line break in binary expression</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/issues/7605">#7605</a>
        opened by <a href="https://github.com/charliermarsh">@charliermarsh</a>
        on 2023-09-22 16:37
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a></div>
            <div class="timeline-body"><p>Given:</p>
<pre><code class="language-python">[
    1 for components in  # pylint: disable=undefined-loop-variable
    b +  # integer 1 may only have decimal 01-09
    c  # negative decimal
] 
</code></pre>
<p>We format as:</p>
<pre><code class="language-python">[
    1
    for components in b  # pylint: disable=undefined-loop-variable  # integer 1 may only have decimal 01-09
    +
    c  # negative decimal
]
</code></pre>
<p>(Notice the hard line break between <code>+</code> and <code>c # negative decimal</code>.)</p>
<p>Which is then formatted as:</p>
<pre><code class="language-python">[
    1
    for components in b  # pylint: disable=undefined-loop-variable  # integer 1 may only have decimal 01-09
    + c  # negative decimal
]

</code></pre>
<p>Sourced from https://github.com/astral-sh/ruff/issues/7590 (<code>A_1798643049678049848.py</code>).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @charliermarsh on 2023-09-22 16:37</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">formatter</span> added by @charliermarsh on 2023-09-22 16:37</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone "Formatter: Beta" by @charliermarsh on 2023-09-22 16:37</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-09-22 16:44</div>
            <div class="timeline-body"><p>I updated the summary with a smaller reproduction</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-09-22 16:46</div>
            <div class="timeline-body"><p>Thanks.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @charliermarsh by @charliermarsh on 2023-09-22 16:46</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Unassigned @charliermarsh by @charliermarsh on 2023-09-22 16:46</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-09-22 16:46</div>
            <div class="timeline-body"><p>Didn't mean to assign to myself :joy:</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-09-27 13:49</div>
            <div class="timeline-body"><p>I think this is caused by https://github.com/astral-sh/ruff/issues/6588</p>
<p>The binary expression can have dangling comments and it formats them manually. But it's the comprehension that attaches a dangling comment to the binary expression, which messes up the formatting logic, which it intends to handle but the binary expression formatting can't know that.</p>
<p>The solution here is that comprehension shouldn't attach dangling comments to other nodes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-09-27 13:51</div>
            <div class="timeline-body"><p>I can fix that.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-09-27 14:10</div>
            <div class="timeline-body"><p>The problematic comment placement are:</p>
<p>https://github.com/astral-sh/ruff/blob/865c89800ee7bc03ec43b87ce8c0f063a4f50a7d/crates/ruff_python_formatter/src/comments/placement.rs#L2124-L2131</p>
<p>Not related to this issue but has the same underlying problem
https://github.com/astral-sh/ruff/blob/865c89800ee7bc03ec43b87ce8c0f063a4f50a7d/crates/ruff_python_formatter/src/comments/placement.rs#L2158-L2164</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @charliermarsh by @charliermarsh on 2023-09-27 16:00</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Unassigned @charliermarsh by @charliermarsh on 2023-09-27 18:51</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">accepted</span> added by @charliermarsh on 2023-09-27 18:51</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @MichaReiser by @MichaReiser on 2023-09-28 07:56</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @MichaReiser on 2023-09-29 09:45</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 16:48:27 UTC
    </footer>
</body>
</html>
