<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Support parsing IPython escape commands - astral-sh/ruff #8354</title>
    <link rel="stylesheet" href="../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../index.html">Back to index</a>
    </div>

    <h1>Support parsing IPython escape commands</h1>

    <div class="meta">
        <span class="state state-closed">Closed</span>
        <a href="https://github.com/astral-sh/ruff/issues/8354">#8354</a>
        opened by <a href="https://github.com/maximlt">@maximlt</a>
        on 2023-10-30 11:24
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/maximlt">@maximlt</a> on 2023-10-30 11:24</div>
            <div class="timeline-body"><p>With ruff 0.1.3, running <code>ruff check test.ipynb</code> on a notebook whose content is:</p>
<pre><code class="language-python">%time x = 2
print(x)
</code></pre>
<p>returns:</p>
<pre><code>test.ipynb:cell 2:1:7: F821 Undefined name `x`
Found 1 error.
</code></pre>
<p>While I would expect no error to be found. It seems the IPython <code>%time</code> magic isn't supported. I haven't tested other magics.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">parser</span> added by @konstin on 2023-10-30 13:24</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2023-10-30 13:25</div>
            <div class="timeline-body"><p>Currently, we don't yet parse the contents of ipython, we merely ignore them.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-10-30 13:26</div>
            <div class="timeline-body"><p>@dhruvmanila - What would it take for us to selectively support common magics, i.e., parse the bodies?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2023-10-31 03:27</div>
            <div class="timeline-body"><p>Related https://github.com/astral-sh/ruff/issues/8094. I'll close that one in favor of this and bring any relevant information here.</p>
<p>I'm a bit hesitant to support parsing magics as there's no clear grammar for it. There are other reasons as well which I'll outline here.</p>
<h3>Magic arguments</h3>
<p>Each magic command can have any number of CLI type of arguments which needs to be skipped as they aren't valid Python syntax. For example, the <code>%timeit</code> <a href="https://ipython.readthedocs.io/en/stable/interactive/magics.html#magic-timeit">documentation</a> usage is:</p>
<pre><code>%timeit [-n&lt;N&gt; -r&lt;R&gt; [-t|-c] -q -p&lt;P&gt; -o] statement
</code></pre>
<p>But then how do we differentiate between a CLI type of argument and an actual Python code. That would probably require having an understanding of the supported magic commands and basically adding the logic for parsing such commands in Ruff.</p>
<h3>Syntax</h3>
<p>The linked issue (https://github.com/astral-sh/ruff/issues/8094) provides a real world example for a false positive. I've narrowed it down to the following lines:</p>
<pre><code class="language-python">versions = {'Latest': 1, 'v7.2-112': 2, 'v6': 3}
# ^^^^^^ F841 unused variable
!sed -i '/^GPUOWL_PRP_PM1=/c\GPUOWL_PRP_PM1={versions[gpuowl_prp_pm1]}' '{file}'
#                                            ^^^^^^^^ used here
</code></pre>
<p>Here, the warning we raise is that the <code>versions</code> variable is defined but unused (<code>F841</code>). The problem here is that the variable is used in bash syntax and not Python.</p>
<p>That said, if we do decide to parse the escape commands, the following would be required:</p>
<ol>
<li>Understanding the said magic command (in case of <code>%</code>), it's CLI type arguments and the position of Python code in the command itself</li>
<li>Integrating a shell parser (in case of <code>!</code>), updating our AST structure to include that.</li>
</ol>
<p>Even in the case of (2), we would further need to add an ability to parse arguments for the shell commands (see the above <code>sed</code> example).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">needs-decision</span> added by @dhruvmanila on 2023-10-31 03:27</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/8094.html">astral-sh/ruff#8094</a> on 2023-10-31 03:28</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "IPython `%time` magic not supported" to "Support parsing IPython escape commands" by @dhruvmanila on 2023-10-31 03:28</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2023-10-31 03:29</div>
            <div class="timeline-body"><p>(Converting this into a general issue to discuss parsing IPython escape commands.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/tdulcet">@tdulcet</a> on 2023-10-31 10:20</div>
            <div class="timeline-body"><blockquote>
<p>2. Integrating a shell parser (in case of <code>!</code>), updating our AST structure to include that.</p>
</blockquote>
<p>I am not sure if Ruff would actually need a full shell parser, as least not for that example from my notebook. Ruff would only need to look for matching pairs of curly brackets and check if there is valid Python syntax inside. This would need to be done before running a shell parser anyway, as it could be invalid Bash syntax, especially if it is unquoted. Jupyter seems to be smart enough to silently ignore any curly brackets with invalid Python syntax inside, such as with Bash <a href="https://www.gnu.org/software/bash/manual/html_node/Brace-Expansion.html">brace expansion</a> or an <code>awk</code> command for example.</p>
<p>Supporting my first example in #8094 likely would require a shell parser, but that would only affect a single Ruff rule (<code>F841</code>) compared to the bracket syntax that could affect dozens of rules since it can include arbitrary Python expressions. Note that Python does include a (partial) shell parser with the <a href="https://docs.python.org/3/library/shlex.html">shlex library</a>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/henryiii">@henryiii</a> on 2023-11-29 16:14</div>
            <div class="timeline-body"><p>The simplest starting point for cell magics would be to mark some cell magics as transparent (possibly a customizable list to allow third party magics to be added?). That would allow this:</p>
<pre><code class="language-ipython">y = 1
%%timeit
x = y
</code></pre>
<p>to no longer mark y as unused. It's only a first order fix - <code>%%timeit</code> doesn't add variables to the environment, it only captures it. So x isn't set to y after this statement. But that's probably a lot better than all the errors that pop up about unused imports and variables; I'm having to deactivate related checks due to this. Some other cell magics, like <code>%%time</code>, are truly transparent, they are just like normal code.</p>
<p>I think these are the built-in transparent cell magics (based on looking at the details given by <code>%magic</code>):</p>
<ul>
<li><code>%%capture</code></li>
<li><code>%%debug</code></li>
<li><code>%%prun</code></li>
<li><code>%%pypy</code></li>
<li><code>%%python</code></li>
<li><code>%%python3</code></li>
<li><code>%%time</code></li>
<li><code>%%timeit</code> (captures environment, but doesn't set new variables)</li>
<li><code>%%writefile</code>/<code>%%file</code> (only with a <code>.py</code> extension).</li>
</ul>
<p>Supporting inline magics seems like a second order issue, and a tricker one, since the arguments are inline with the body. And you can rewrite the above example into a cell magic easily.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/henryiii">@henryiii</a> on 2023-11-29 17:34</div>
            <div class="timeline-body"><p>Also, this is exactly how Black works, I think:</p>
<p>https://black.readthedocs.io/en/latest/usage_and_configuration/the_basics.html#python-cell-magics</p>
<p>It seems to have a pre-built list of magics and that can be extended.</p>
<p>https://github.com/psf/black/blob/a0e270d0f246387202e676b25abbf7a02ddcbc71/src/black/handle_ipynb_magics.py#L35C1-L43</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-11-29 17:35</div>
            <div class="timeline-body"><p>I'm very interested in supporting this!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2023-11-29 20:36</div>
            <div class="timeline-body"><blockquote>
<p>The simplest starting point for cell magics would be to mark some cell magics as transparent (possibly a customizable list to allow third party magics to be added?).</p>
</blockquote>
<p>Correct me if I'm wrong but by transparent, I'm assuming you mean that the variables / imports defined in that cell are available in the global scope to be accessed by other code in other cells.</p>
<blockquote>
<p>That would allow this:</p>
<pre><code>y = 1
%%timeit
x = y
</code></pre>
<p>to no longer mark y as unused.</p>
</blockquote>
<p>I see what you mean here. I think this should be trivial to implement. We would just need to update the <code>is_magic_cell</code> function to consider the cells as valid if it's one of the listed magics. The parser then should take care of the rest.</p>
<p>https://github.com/astral-sh/ruff/blob/ec7456bac049d1d4f4763f8c7ad764d27dd383bd/crates/ruff_notebook/src/cell.rs#L62-L63</p>
<p>For example, taking the above code:</p>
<pre><code class="language-rs">Module(
    ModModule {
        range: 0..20,
        body: [
            Assign(
                StmtAssign { .. },  // y = 1
            ),
            IpyEscapeCommand(
                StmtIpyEscapeCommand {
                    range: 6..13,
                    kind: Magic2,
                    value: &quot;timeit&quot;,
                },
            ),
            Assign(
                StmtAssign { .. },  // x = y
            ),
        ],
    },
)
</code></pre>
<p>This means we wouldn't mark <code>y</code> as unused then.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/8911.html">astral-sh/ruff#8911</a> on 2023-11-29 21:26</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-01-03 17:08</div>
            <div class="timeline-body"><p>I believe we now support these transparent / simple cases, which is probably the best we can do.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2024-01-03 17:08</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">needs-decision</span> removed by @dhruvmanila on 2024-01-16 20:02</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/10454.html">astral-sh/ruff#10454</a> on 2024-03-19 08:41</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:28:11 UTC
    </footer>
</body>
</html>
