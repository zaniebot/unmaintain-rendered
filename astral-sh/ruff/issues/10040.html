<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Update line break heuristic when f-string has format specifier - astral-sh/ruff #10040</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Update line break heuristic when f-string has format specifier</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/issues/10040">#10040</a>
        opened by <a href="https://github.com/dhruvmanila">@dhruvmanila</a>
        on 2024-02-19 07:34
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a></div>
            <div class="timeline-body"><p>Given:</p>
<pre><code>aaaaaaaaaaa = f&quot;asaaaaaaaaaaaaaaaa { 
    aaaaaaaaaaaa + bbbbbbbbbbbb + ccccccccccccccc + dddddddd:.3f} cccccccccc&quot;
</code></pre>
<p>Ruff (with <code>--preview</code>) would format is as:</p>
<pre><code>aaaaaaaaaaa = f&quot;asaaaaaaaaaaaaaaaa {
    aaaaaaaaaaaa + bbbbbbbbbbbb + ccccccccccccccc + dddddddd:.3f
} cccccccccc&quot;
</code></pre>
<p>Here, we&#x27;re changing the format specifier from <code>.3f</code> to <code>.3f\n</code>.</p>
<p>Now, if the user had the following code:</p>
<pre><code>aaaaaaaaaaa = f&quot;asaaaaaaaaaaaaaaaa {
    aaaaaaaaaaaa + bbbbbbbbbbbb + ccccccccccccccc + dddddddd:.3f
} cccccccccc&quot;
</code></pre>
<p>Then, with the new heuristic to not have line breaks would mean that we&#x27;d format the above code as:</p>
<pre><code>aaaaaaaaaaa = f&quot;asaaaaaaaaaaaaaaaa {aaaaaaaaaaaa + bbbbbbbbbbbb + ccccccccccccccc + dddddddd:.3f
} cccccccccc&quot;
</code></pre>
<p>The newline is already present in the format specifier <code>.3f\n</code> in the original source code.</p>
Local or Global?
<p>Another question is whether this heuristic should be applied globally or local to an individual expression element. For example, in the following code snippet,</p>
<pre><code>f&quot;&quot;&quot;fooooooooooooooooooo barrrrrrrrrrrrrrrrrrr {
        xxxxxxxxxxxxxxx:.3f} aaaaaaaaaaaaaaaaa { xxxxxxx } bbbbbbbbbbbb { 
xxxxxxxxxxx + xxxxxxxxxxx } end&quot;&quot;&quot;
</code></pre>
<p>We&#x27;ve an expression element which has a line break and doesn&#x27;t contain a format specifier (third field). This means that the f-string layout is multiline. So, the first element cannot have line breaks while the second and third can have. If so, then we&#x27;d potentially format it as:</p>
<pre><code>f&quot;&quot;&quot;fooooooooooooooooooo barrrrrrrrrrrrrrrrrrr {xxxxxxxxxxxxxxx:.3f} aaaaaaaaaaaaaaaaa {xxxxxxx} bbbbbbbbbbbb {
	xxxxxxxxxxx + xxxxxxxxxxx
} end&quot;&quot;&quot;
</code></pre>
<p>If we apply the heuristic globally, then the formatter would collapse all of the expression elements.</p>
<p>Playground: https://play.ruff.rs/c2d0cc39-30ab-4c17-ac8c-0f4d8a9afbb6</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-02-19 07:34</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">formatter</span> added by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-02-19 07:34</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">preview</span> added by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-02-19 07:34</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-02-19 07:38</div>
            <div class="timeline-body"><p>Thanks for opening this as an issue. Is this something you plan to work on?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-02-19 08:05</div>
            <div class="timeline-body"><p>Yeah, although not right away. It should be a simple fix.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to <a href="https://github.com/dhruvmanila">@dhruvmanila</a> by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-04-24 09:22</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-04-24 10:17</div>
            <div class="timeline-body"><p>I think with <a href="https://github.com/astral-sh/ruff/pull/7787">astral-sh/ruff#7787</a>, this issue isn&#x27;t relevant anymore because both unformatted and formatted code produces the same AST as the lexer would stop at the newline token.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-04-24 10:18</div>
            <div class="timeline-body"><p>Right, but only for single-quoted string. It&#x27;s still relevant for triple-quoted string.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-04-26 13:34</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 18:48:50 UTC
    </footer>
</body>
</html>
