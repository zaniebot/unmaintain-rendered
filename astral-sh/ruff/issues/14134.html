<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>method on a class that returns an instance of that class gets F821 (undefined name) for the annotated return type - astral-sh/ruff #14134</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>method on a class that returns an instance of that class gets F821 (undefined name) for the annotated return type</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/issues/14134">#14134</a>
        opened by <a href="https://github.com/JoranDox">@JoranDox</a>
        on 2024-11-06 13:18
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/JoranDox">@JoranDox</a></div>
            <div class="timeline-body">

<p>file <code>path/to/myclass.py</code> contents:</p>
<pre><code>class Myclass:
    def returnself(self) -&gt; Myclass:
        return self
</code></pre>
<p>command: <code>ruff check --isolated path/to/myclass.py</code>
error:</p>
<pre><code>path/to/myclass.py:2:29: F821 Undefined name `Myclass`
  |
1 | class Myclass:
2 |     def returnself(self) -&gt; Myclass:
  |                             ^^^^^^^ F821
3 |         return self
  |

Found 1 error.
</code></pre>
<p>This code (in a much more complex form, specifically as a factory method for a class) works fine in production code, and I see no reason the linter shouldn&#x27;t just see the name from right above.</p>
<p>ruff version: ruff 0.5.4</p>
<p>keywords searched for: F821, return type, classmethod, factory method</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-11-06 13:21</div>
            <div class="timeline-body"><p>I believe the above syntax is only valid when importing <code>annotations</code> from <code>__future__</code> (https://peps.python.org/pep-0563/). See https://play.ruff.rs/89d2b517-496d-473d-8208-25afdf2ac177</p>
<p>But I let @carljm or @AlexWaygood weigh in on this</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">question</span> added by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-11-06 13:21</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dylwil3">@dylwil3</a> on 2024-11-06 13:23</div>
            <div class="timeline-body"><p>I agree with Micha - you could also surround the annotation with quotation marks (<a href="https://play.ruff.rs/bfd71d97-6d9a-4385-b945-6c571d3d8d65">playground</a>).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dylwil3">@dylwil3</a> on 2024-11-06 13:26</div>
            <div class="timeline-body"><p>But it sounds like you&#x27;re seeing an undesired lint with your production code (which presumably can&#x27;t have a syntax error in it!) Would it be possible to find a version of the more complex code that produces the undesired lint?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">needs-mre</span> added by <a href="https://github.com/dylwil3">@dylwil3</a> on 2024-11-06 13:27</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/JoranDox">@JoranDox</a> on 2024-11-06 13:31</div>
            <div class="timeline-body"><p>@MichaReiser Huh, I was literally just going to comment that pandas does literally this here https://github.com/pandas-dev/pandas/blob/v2.2.3/pandas/core/frame.py#L1805-L1931</p>
<p>but it doesn&#x27;t trigger the same error, and you&#x27;re right, they import annotations from <strong>future</strong></p>
<p>Is that the intended way to do this? Python allows this as-is, right?</p>
<p>@dylwil3 Indeed, I realised now that quoting the annotation is exactly what <code>from __future__ import annotations</code> does lol
I&#x27;m not entirely understanding why this makes a difference,</p>
<p>As for the production code, it&#x27;s really very similar in structure, just with more arguments &amp; other irrelevant things.
It gets the underline in vscode from ruff, but just runs fine with actual python.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dylwil3">@dylwil3</a> on 2024-11-06 13:33</div>
            <div class="timeline-body"><p>What version of Python are you using? This is what I see for Python 3.11:</p>
<pre><code>âžœ  ~ python
Python 3.11.5 (main, Sep  8 2023, 16:31:47) [Clang 14.0.3 (clang-1403.0.22.14.1)] on darwin
Type &quot;help&quot;, &quot;copyright&quot;, &quot;credits&quot; or &quot;license&quot; for more information.
&gt;&gt;&gt; class Myclass:
...     def returnself(self) -&gt; Myclass:
...         return self
...
Traceback (most recent call last):
  File &quot;&lt;stdin&gt;&quot;, line 1, in &lt;module&gt;
  File &quot;&lt;stdin&gt;&quot;, line 2, in Myclass
NameError: name &#x27;Myclass&#x27; is not defined
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/JoranDox">@JoranDox</a> on 2024-11-06 13:37</div>
            <div class="timeline-body"><p>Huh, I think something is being weird here, you&#x27;re right, running this example is indeed failing.
I&#x27;m afraid I accidentally found a hole in our tests :fearful:
And I was mistaken, it&#x27;s not yet production code, it&#x27;s a refactor in progress pulling a function like this</p>
<pre><code>
class Myclass:
    def __init__(self, params):
        ...

def create_myclass(params) -&gt; Myclass:
    return Myclass(params)
</code></pre>
<p>into the class as a factory method, my bad.</p>
<p>All right, TIL about how annotations (don&#x27;t) work in python, sorry for the confusion and thanks!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/JoranDox">@JoranDox</a> on 2024-11-06 13:37</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dylwil3">@dylwil3</a> on 2024-11-06 13:47</div>
            <div class="timeline-body"><p>No worries, glad we could sort out the issue!</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 18:48:59 UTC
    </footer>
</body>
</html>
