<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[red-knot] special-case returning NotImplemented - astral-sh/ruff #16661</title>
    <link rel="stylesheet" href="../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../index.html">Back to index</a>
    </div>

    <h1>[red-knot] special-case returning NotImplemented</h1>

    <div class="meta">
        <span class="state state-closed">Closed</span>
        <a href="https://github.com/astral-sh/ruff/issues/16661">#16661</a>
        opened by <a href="https://github.com/carljm">@carljm</a>
        on 2025-03-12 05:00
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/carljm">@carljm</a> on 2025-03-12 05:00</div>
            <div class="timeline-body"><p><code>NotImplemented</code> should always be returnable, no matter what return type annotation a function has.</p>
<p>Other type checkers seem to handle this by just treating <code>NotImplemented</code> as if it were <code>Any</code>, but <a href="https://github.com/astral-sh/ty/issues/182">I don't think that's right</a>.</p>
<p>We can easily handle this by treating <code>NotImplemented</code> as a <code>KnownInstance</code> and special-casing it in return type checking.</p>
<p>(Arguably this special case should only apply to certain methods, but that seems more complex and perhaps not worth it.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by @carljm on 2025-03-12 05:00</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/cake-monotone">@cake-monotone</a> on 2025-03-21 07:46</div>
            <div class="timeline-body"><p>I found that there may be additional cases we should consider</p>
<pre><code class="language-python">class CustomInt(int):
    def __add__(self, o) -&gt; CustomInt:
        # the type of `add_result` will be inferred as `int`, but actually it will be `int | _NotImplementedType` at runtime.
        add_result = int.__add__(int(self), o)
        if add_result is NotImplemented:  # this condition will always be inferred as Literal[False]
            return NotImplemented

        return add_result * add_result
</code></pre>
<p>Treating <code>NotImplemented</code> as <code>Any</code> might be intended to cover cases like this.
If we treat <code>NotImplemented</code> as a <code>KnownInstance</code>, we might need to ensure that the result of binary operations is not always inferred as <code>Literal[True]</code> or <code>Literal[False]</code>. What do you think?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-03-21 18:41</div>
            <div class="timeline-body"><p>If you perform a binary operation that de-sugars to a dunder method call, <code>NotImplemented</code> is not a possible result of that operation, because the runtime handles <code>NotImplemented</code> internally to fall back to another behavior (e.g. calling a reverse-dunder method). So this issue only occurs when manually/explicitly calling a dunder method (which is generally discouraged), as in your example.</p>
<p>I don't think there's much we can do about this, because it's an inaccuracy that is baked in to the typeshed definitions of dunder methods and their return types.</p>
<p>It's also not clear to me how treating <code>NotImplemented</code> as <code>Any</code> (rather than special-casing it in return checking) would help with your example? I guess you are worried that we might wrongly mark the <code>return NotImplemented</code> branch as dead code?</p>
<p>Overall I think if this scenario can only be triggered with a manual call to a dunder method, then it is OK if that results in some sub-optimal behavior. It seems like a rare edge case.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/cake-monotone">@cake-monotone</a> on 2025-03-24 06:59</div>
            <div class="timeline-body"><p>You're right — I was a bit concerned about the dead code branch. But if this case isn’t something we need to specifically account for, I’ll go ahead and implement it as I initially intended. Would you mind assigning the issue to me?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @cake-monotone by @carljm on 2025-03-24 18:22</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone "Red Knot Alpha" by @carljm on 2025-03-27 18:33</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/17034.html">astral-sh/ruff#17034</a> on 2025-03-28 11:48</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @carljm on 2025-03-30 18:06</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:28:15 UTC
    </footer>
</body>
</html>
