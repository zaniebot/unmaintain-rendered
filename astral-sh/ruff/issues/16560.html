<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Partial unpacking in `return`, `yield`, and `for` before Python 3.9 - astral-sh/ruff #16560</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Partial unpacking in `return`, `yield`, and `for` before Python 3.9</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/ruff/issues/16560">#16560</a>
        opened by <a href="https://github.com/ntBre">@ntBre</a>
        on 2025-03-07 20:54
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/ntBre">@ntBre</a> on 2025-03-07 20:54</div>
            <div class="timeline-body"><p>I made this a sub-issue of #6591 for easier discussion, but I ran into the fact that syntax like this:</p>
<pre><code class="language-python">def f(): return 1, (*rest)
def g(): yield 1, (*rest)
for _ in  1, (*rest): ...
</code></pre>
<p>is allowed on Python 3.7 and 3.8 but not on 3.9 while working on #16485 and then again on #16558.</p>
<p>We actually already emit a normal parse error for this, so the change I guess we'd need is more like skipping the existing <code>ParseError</code> based on the version rather than adding an <code>UnsupportedSyntaxError</code>.</p>
<p>On the other hand, this only affects Python versions before 3.9, which are no longer supported. I'm leaning toward just removing this from #6591 and considering it finished without this check, but I wanted to get some other thoughts on this too.</p>
<p>That approach also raises the question of whether we should have taken the same approach with the parenthesized keyword argument names in #16482. That's the only other example of removed syntax in #6591, unless I'm missing another case in my unmerged PRs. We could just emit a <code>ParseError</code> for that and not worry about removed syntax for versions before 3.9.</p>
<p>For the partial unpacking case, specifically, I also didn't find any documentation about that change, so I think it just fell out of the PEG parser change in 3.9.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "`def i(): return 1, (*rest)` is no longer allowed (something with `*rest`)" to "Partial unpacking in `return`, `yield`, and `for` before Python 3.9" by @ntBre on 2025-03-07 20:55</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">rule</span> added by @ntBre on 2025-03-07 21:06</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">parser</span> added by @ntBre on 2025-03-07 21:06</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2025-03-10 11:33</div>
            <div class="timeline-body"><p>Starred expressions are a bit tricky because they depend on the context in which it's being used. I see that it seems to also need to consider the target version.</p>
<blockquote>
<p>On the other hand, this only affects Python versions before 3.9, which are no longer supported. I'm leaning toward just removing this from <a href="https://github.com/astral-sh/ruff/issues/6591">#6591</a> and considering it finished without this check, but I wanted to get some other thoughts on this too.</p>
</blockquote>
<p>I'd be fine to proceed with this.</p>
<blockquote>
<p>That approach also raises the question of whether we should have taken the same approach with the parenthesized keyword argument names in <a href="https://github.com/astral-sh/ruff/pull/16482">#16482</a>. That's the only other example of removed syntax in <a href="https://github.com/astral-sh/ruff/issues/6591">#6591</a>, unless I'm missing another case in my unmerged PRs. We could just emit a <code>ParseError</code> for that and not worry about removed syntax for versions before 3.9.</p>
</blockquote>
<p>Hmm, that's a good point. I wouldn't consider this a high priority but it might make sense to use <code>ParseError</code> for this case and just avoid raising <code>ParseError</code> if the target version allows it.</p>
<p>So, that prompted me to look at why the current implementation doesn't already raise a <code>ParseError</code> for this and I realize that I didn't special case this. In certain cases we do try to parse it using a more relaxed grammar but then later raise <code>ParseError</code> if we encounter invalid expression in that position (<a href="https://github.com/astral-sh/ruff/blob/7d8fdb04c240d5c4f9f72a0e6aae42d0739fc099/crates/ruff_python_parser/src/parser/expression.rs#L384-L390">example</a>).</p>
<p>This also make me think as to whether there's any need for <code>Change::Removed</code> especially as the current list only includes the removed syntax in end-of-life Python versions.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntBre">@ntBre</a> on 2025-03-10 23:02</div>
            <div class="timeline-body"><p>Thanks @dhruvmanila! It sounds like we're leaning in the same direction. I think you're right that we could get rid of <code>Change::Removed</code> and the <code>Change</code> enum if we just made these <code>ParseError</code>s.</p>
<p>On the other hand, I mentioned this to Alex in our 1:1 today, and he said that a significant number of people are still using older, unsupported Python versions, so it may still be worth making these <code>UnsupportedSyntaxError</code>s.</p>
<p>I agree that it's probably not too high a priority either way, especially this week.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 01:30:16 UTC
    </footer>
</body>
</html>
