<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>autofix for TCH (flake8-type-checking) rules - astral-sh/ruff #2329</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>autofix for TCH (flake8-type-checking) rules</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/issues/2329">#2329</a>
        opened by <a href="https://github.com/LefterisJP">@LefterisJP</a>
        on 2023-01-29 23:39
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/LefterisJP">@LefterisJP</a> on 2023-01-29 23:39</div>
            <div class="timeline-body"><p>I enabled the TCH rules to see what it suggests and finds in rotki's codebase. I got about ~700 hits.</p>
<p>They don't seem like bad suggestions. I .. ehm ... just don't want to do it manually and without knowing the internals of ruff well I can imagine all TCH rules should be autofixable.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">autofix</span> added by @charliermarsh on 2023-01-30 00:08</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-01-30 00:09</div>
            <div class="timeline-body"><p>It's non-trivial (but also not impossible) because it requires rewrites across various parts of the file -- we have to remove an import from one part of a file, add it to another part which could be non-adjacent, etc.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/LefterisJP">@LefterisJP</a> on 2023-01-30 00:53</div>
            <div class="timeline-body"><blockquote>
<p>It's non-trivial (but also not impossible) because it requires rewrites across various parts of the file -- we have to remove an import from one part of a file, add it to another part which could be non-adjacent, etc.</p>
</blockquote>
<p>I understand. In some rules you would also need to adjust types and wrap them in quotes if the import is moved inside an <code>if TYPE_CHECKING</code> block.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Kilo59">@Kilo59</a> on 2023-02-03 14:15</div>
            <div class="timeline-body"><blockquote>
<p>I understand. In some rules you would also need to adjust types and wrap them in quotes if the import is moved inside an if TYPE_CHECKING block.</p>
</blockquote>
<p>I would expect these fixes to be paired with a <code>from __future__ import annotations</code> import. In this case, wrapping them in quotes would be unnecessary.
Should also make it easier to implement.</p>
<p>Converting the annotations to strings could also lead to problems if an import is removed, the type-checker and linter won't save you.</p>
<p>For example. Let's assume this is the initial state of the file.</p>
<pre><code class="language-python">from pandas import DataFrame

def do_something(df: DataFrame):
   ...
</code></pre>
<hr />
<p>Now here's two different ways of auto-fixing this.</p>
<pre><code class="language-python">from __future__ import annotations
from typing import TYPE_CHECKING

if TYPE_CHECKING:
  from pandas import DataFrame

def do_something(df: DataFrame):
   ...
</code></pre>
<p>or with string annotations</p>
<pre><code class="language-python">from typing import TYPE_CHECKING

if TYPE_CHECKING:
  from pandas import DataFrame

def do_something(df: 'DataFrame'):
   ...
</code></pre>
<hr />
<p>Now imagine the <code>from pandas import DataFrame</code> is removed by accident.</p>
<pre><code class="language-python">from __future__ import annotations

def do_something(df: DataFrame):  # this will get caught by the ruff linter as an undefined-name
   ...
</code></pre>
<pre><code class="language-python">def do_something(df: 'DataFrame'):  # this won't be caught and the type-checker won't know what it is
   ...

# mypy will treat `df` as an `Any` if it can't determine the type.
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/LefterisJP">@LefterisJP</a> on 2023-02-03 22:24</div>
            <div class="timeline-body"><p>Nice suggestion @Kilo59! One question. Do you know from which version of python <code>from __future__ import annotations</code> will no longer be required for this? I thought it was supposed to be 3.10 but seems like this is not the case?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-02-03 22:28</div>
            <div class="timeline-body"><p>I believe it will be Python 3.12 at the earliest.</p>
<p>https://docs.python.org/3/library/<strong>future</strong>.html#id2
https://mail.python.org/archives/list/python-dev@python.org/message/VIZEBX5EYMSYIJNDBF6DMUMZOCWHARSO/</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MaksimZayats">@MaksimZayats</a> on 2023-02-12 17:24</div>
            <div class="timeline-body"><p>Hi, @charliermarsh!</p>
<p>Do you have any news/plans on this ?</p>
<p>I don't think the auto-fix should be a big problem in case of using <code>from __future__ import annotations</code>.
What do you think?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-05-18 15:28</div>
            <div class="timeline-body"><p>I'm currently working on this.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @charliermarsh by @charliermarsh on 2023-05-18 15:28</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2023-05-31 17:53</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 11:29:06 UTC
    </footer>
</body>
</html>
