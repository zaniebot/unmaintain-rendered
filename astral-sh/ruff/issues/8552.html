<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Running as file watcher in container with PyCharm truncates file - astral-sh/ruff #8552</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Running as file watcher in container with PyCharm truncates file</h1>

    <div class="meta">
        <span class="state state-open">Open</span>
        <a href="https://github.com/astral-sh/ruff/issues/8552">#8552</a>
        opened by <a href="https://github.com/daveisfera">@daveisfera</a>
        on 2023-11-08 04:50
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/daveisfera">@daveisfera</a> on 2023-11-08 04:50</div>
            <div class="timeline-body"><p>I've setup a file watcher that run <code>ruff --fix</code> and <code>ruff format</code> in a docker image. I've run just one of those commands to isolate the issue and have seen it happen when just <code>ruff --fix</code> or <code>ruff format</code> is running so it's happening with either command run separately</p>
<p>Here's an example of the error output and when I look at the file, several characters from the last few lines have been removed (i.e. the file was truncated):</p>
<pre><code>/Users/dlj/projects/myproject/local/format_file.sh myfile.py
error: Failed to parse myfile.py:117:5: Unexpected token 'exc'
Found 1 error (1 fixed, 0 remaining).
error: Failed to format myfile.py: source contains syntax errors: ParseError { error: UnrecognizedToken(Name { name: &quot;exc&quot; }, None), offset: 3254, source_path: &quot;&lt;filename&gt;&quot; }

Process finished with exit code 2
</code></pre>
<p>Here's the scripts that I use as the watcher (which I have setup in the same manner that <a href="https://black.readthedocs.io/en/stable/integrations/editors.html#as-file-watcher"><code>black</code> recommends</a>):</p>
<pre><code>#!/usr/bin/env sh

cd &quot;$(dirname &quot;$0&quot;)/..&quot; || exit

if ! local/_run_ruff.sh --fix &quot;$@&quot;; then
  exit 1
fi
local/_run_ruff.sh format &quot;$@&quot;
exit $?
</code></pre>
<pre><code>#!/usr/bin/env sh

cd &quot;$(dirname &quot;$0&quot;)/..&quot; || exit

docker run --rm \
  -v &quot;${PWD}&quot;:/usr/src/app:z,cached \
  -w /usr/src/app \
  ruff:0.1.4 \
  /usr/local/bin/ruff &quot;$@&quot;
exit $?
</code></pre>
<p>On a related note, I know there's a <a href="https://github.com/koxudaxi/ruff-pycharm-plugin">PyCharm plugin</a> but I like running it in a container, because then <a href="https://github.com/astral-sh/ruff/issues/5072#issuecomment-1779227790">CI and every developer machine is automagically kept in sync</a></p>
<p>Here's my <code>ruff.toml</code></p>
<pre><code>line-length = 120

select = [&quot;C&quot;, &quot;I&quot;, &quot;U&quot;, &quot;W&quot;]
ignore = [&quot;E&quot;, &quot;F&quot;, &quot;C901&quot;, &quot;W191&quot;]

target-version = &quot;py39&quot;

[isort]
combine-as-imports = true

[format]
# Like Black, use double quotes for strings.
quote-style = &quot;double&quot;

# Like Black, indent with spaces, rather than tabs.
indent-style = &quot;space&quot;

# Like Black, automatically detect the appropriate line ending.
line-ending = &quot;auto&quot;
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @charliermarsh on 2023-11-09 02:09</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "Running format as file watcher with PyCharm truncates file" to "Running as file watcher in container with PyCharm truncates file" by @daveisfera on 2023-11-10 01:55</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/daveisfera">@daveisfera</a> on 2023-11-10 01:56</div>
            <div class="timeline-body"><p>I thought that maybe this was an issue with the cache, but I tried <a href="https://github.com/astral-sh/ruff/pull/8538">setting <code>RUFF_NO_CACHE=true</code> from 0.1.5</a> and the problem still happens</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/daveisfera">@daveisfera</a> on 2023-11-17 18:55</div>
            <div class="timeline-body"><p>I've tried playing around with different things when this happens to understand what's going on and the oddest thing I've noticed is that undoing the format and then editing the file usually doesn't change anything about the result. Here's an example:</p>
<p>This was the function at the end of a file I just edited:</p>
<pre><code>@require_POST
  def video(request: HttpRequest, stream_name: str) -&gt; HttpResponse:
      return _handle_data(request, stream_name, HlsType.video, UploadVideoForm, &quot;data&quot;)
</code></pre>
<p>And it was truncated to this:</p>
<pre><code>@require_POST
def video(request: HttpRequest, stream_name: str) -&gt; Http
</code></pre>
<p>As mentioned, I undid the change from the format applied on save and then copied a second copy of the function just below it and saved again and it truncated to the same spot. I then did that 2 more times, so there were 4 copies of the function and it did the same thing. I added newlines above the function and after doing that a few times, it returned a result without the truncation and a warning about the multiple definitions of the function.</p>
<p>So it appears that the issue is happening on the reading of the file (or else the warning about the multiple definitions would have happened) and it appears that it's using the old length of the file when reading the data and that's what is causing the truncation</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-08-01 01:10</div>
            <div class="timeline-body"><p>@daveisfera -- Any idea if this is still an issue?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/daveisfera">@daveisfera</a> on 2024-08-01 03:16</div>
            <div class="timeline-body"><p>Yes, it is unfortunately still an issue. I'm guessing it's something to do with the way that PyCharm handles files and edits that isn't playing nice with how <code>ruff</code> inputs and/or outputs the file inside of a container on macOS</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-08-01 06:08</div>
            <div class="timeline-body"><p>Sounds mysterious. Does this only happen in a container or also when running it locally? Is my understanding correct that you created a pycharm watcher to run the script or is there another watch task?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/daveisfera">@daveisfera</a> on 2024-08-01 15:00</div>
            <div class="timeline-body"><p>Only when I run it in a container so I've switched to running <code>ruff</code> natively to workaround this problem (but then all the developers on our team have to synchronize the upgrade instead of it being controlled by a script)</p>
<p>And yes, it's a PyCharm watcher that's running the script, and I set it up the <a href="https://black.readthedocs.io/en/stable/integrations/editors.html#as-file-watcher">same way that I used to run <code>black</code></a></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-08-02 09:20</div>
            <div class="timeline-body"><p>That's very strange. Could you try adding a random 10ms timeout before calling ruff to emulate Python's startup time :rofl:</p>
<p>Have you tried https://plugins.jetbrains.com/plugin/20574-ruff ?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-08-02 09:27</div>
            <div class="timeline-body"><p>Do you run into the same issue when using ruff as an external tool? https://docs.astral.sh/ruff/editors/setup/#via-external-tool</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/daveisfera">@daveisfera</a> on 2024-08-06 02:10</div>
            <div class="timeline-body"><p>I prefer to run it in a container, because then the version being run is controlled by the code itself and changes automatically roll out to all developers and CI as the commit with the change is merged</p>
<p>From my testing so far, putting <code>sleep 0.1</code> before running <code>ruff</code> has prevented the problem from happening, so I'll keep testing with that and see if the issue ever happens</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:34:51 UTC
    </footer>
</body>
</html>
