<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FURB157 has incorrect fixes when replacing strings with integers - astral-sh/ruff #14204</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>FURB157 has incorrect fixes when replacing strings with integers</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/issues/14204">#14204</a>
        opened by <a href="https://github.com/dscorbett">@dscorbett</a>
        on 2024-11-08 14:23
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/dscorbett">@dscorbett</a> on 2024-11-08 14:23</div>
            <div class="timeline-body"><p>The fixes for <a href="https://docs.astral.sh/ruff/rules/verbose-decimal-constructor/"><code>verbose-decimal-constructor</code> (FURB157)</a> are sometimes incorrect in Ruff 0.7.3. Two of them change behavior and one introduces a syntax error.</p>
<p>First, negative zero should be kept as a string. <code>int</code> doesn’t have signed zeroes but <code>Decimal</code> does.</p>
<pre><code class="language-console">$ cat furb157.py
from decimal import Decimal
print(Decimal(&quot;-0&quot;))

$ python furb157.py
-0

$ ruff check --isolated --preview --select FURB157 furb157.py --fix
Found 1 error (1 fixed, 0 remaining).

$ cat furb157.py
from decimal import Decimal
print(Decimal(-0))

$ python furb157.py
0
</code></pre>
<p>Second, the empty string should not be normalized to zero. The empty string signals an <code>InvalidOperation</code>, which can be trapped and converted to NaN or can cause an error. “Empty” here refers to the string after normalizing away white space and underscores.</p>
<pre><code class="language-console">$ cat furb157.py
from decimal import Decimal, ExtendedContext
print(Decimal(&quot;_&quot;, ExtendedContext))
print(Decimal(&quot; &quot;))

$ python furb157.py
NaN
Traceback (most recent call last):
  File &quot;furb157.py&quot;, line 3, in &lt;module&gt;
    print(Decimal(&quot; &quot;))
          ^^^^^^^^^^^
decimal.InvalidOperation: [&lt;class 'decimal.ConversionSyntax'&gt;]

$ ruff check --isolated --preview --select FURB157 furb157.py --fix
Found 2 errors (2 fixed, 0 remaining).

$ cat furb157.py
cat furb157.py
from decimal import Decimal, ExtendedContext
print(Decimal(0, ExtendedContext))
print(Decimal(0))

$ python furb157.py
0
0
</code></pre>
<p>Third, decimal <code>int</code> literals with too many digits cause syntax errors. <a href="https://docs.python.org/3.13/library/sys.html#sys.int_info.str_digits_check_threshold">The minimum maximum digit count</a> is 640. If the integer-valued string argument to <code>Decimal</code> has over that many digits, it should stay a string.</p>
<pre><code class="language-console">$ { printf 'from decimal import Decimal\nDecimal(&quot;1'; printf 0%0.s {1..640}; printf '&quot;)\n'; } &gt;furb157.py

$ PYTHONINTMAXSTRDIGITS=640 python furb157.py

$ ruff check --isolated --preview --select FURB157 furb157.py --fix
Found 1 error (1 fixed, 0 remaining).

$ PYTHONINTMAXSTRDIGITS=640 python furb157.py 2&gt;&amp;1 | tail -n 1
SyntaxError: Exceeds the limit (640 digits) for integer string conversion: value has 641 digits; use sys.set_int_max_str_digits() to increase the limit - Consider hexadecimal for huge integer literals to avoid decimal conversion limits.
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dylwil3">@dylwil3</a> on 2024-11-08 21:29</div>
            <div class="timeline-body"><p>Fantastic, thank you!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @dylwil3 by @dylwil3 on 2024-11-08 21:30</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @AlexWaygood on 2024-11-08 22:34</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">fixes</span> added by @AlexWaygood on 2024-11-08 22:34</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2024-11-09 02:08</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 11:35:40 UTC
    </footer>
</body>
</html>
