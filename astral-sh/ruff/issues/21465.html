<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>panic: `internal error: entered unreachable code: IPython escape command expression is only allowed for % and !` - astral-sh/ruff #21465</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>panic: `internal error: entered unreachable code: IPython escape command expression is only allowed for % and !`</h1>

    <div class="meta">
        <span class="state state-closed">Closed</span>
        <a href="https://github.com/astral-sh/ruff/issues/21465">#21465</a>
        opened by <a href="https://github.com/correctmost">@correctmost</a>
        on 2025-11-14 23:45
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/correctmost">@correctmost</a> on 2025-11-14 23:45</div>
            <div class="timeline-body"><h3>Summary</h3>
<p>This panic was originally reported without a reproducer at https://github.com/facebook/pyrefly/issues/1559 .  I was able to track it down with some targeted fuzzing:</p>
<pre><code>panic: Panicked at crates/ruff_python_parser/src/parser/expression.rs:2782:13 when checking `/home/user/crash.ipynb`: `internal error: entered unreachable code: IPython escape command expression is only allowed for % and !`
--&gt; crash.ipynb:1:1
</code></pre>
<p><strong>crash.ipynb</strong></p>
<pre><code class="language-ipython">{
  &quot;cells&quot;: [
    {
      &quot;cell_type&quot;: &quot;code&quot;,
      &quot;metadata&quot;: {},
      &quot;outputs&quot;: [],
      &quot;source&quot;: [
        &quot;with a,?b\n?&quot;
      ]
    }
  ],
  &quot;metadata&quot;: {},
  &quot;nbformat&quot;: 4,
  &quot;nbformat_minor&quot;: 2
}
</code></pre>
<h3>Version</h3>
<p>ruff 0.14.5</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../facebook/pyrefly/issues/1559.html">facebook/pyrefly#1559</a> on 2025-11-14 23:50</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntBre">@ntBre</a> on 2025-11-15 01:22</div>
            <div class="timeline-body"><p>Thank you!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @ntBre on 2025-11-15 01:22</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">parser</span> added by @ntBre on 2025-11-15 01:22</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/21480.html">astral-sh/ruff#21480</a> on 2025-11-16 17:40</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../facebook/pyrefly/issues/1631.html">facebook/pyrefly#1631</a> on 2025-11-21 01:58</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @dhruvmanila on 2025-11-24 05:40</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/21705.html">astral-sh/ruff#21705</a> on 2025-11-30 18:01</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:34:55 UTC
    </footer>
</body>
</html>
