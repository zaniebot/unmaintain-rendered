<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>panic: `internal error: entered unreachable code: IPython escape command expression is only allowed for % and !` - astral-sh/ruff #21465</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>panic: <code>internal error: entered unreachable code: IPython escape command expression is only allowed for % and !</code></h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/issues/21465">#21465</a>
        opened by <a href="https://github.com/correctmost">@correctmost</a>
        on 2025-11-14 23:45
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/correctmost">@correctmost</a></div>
            <div class="timeline-body">Summary
<p>This panic was originally reported without a reproducer at <a href="https://github.com/facebook/pyrefly/issues/1559">facebook/pyrefly#1559</a> .  I was able to track it down with some targeted fuzzing:</p>
<pre><code>panic: Panicked at crates/ruff_python_parser/src/parser/expression.rs:2782:13 when checking `/home/user/crash.ipynb`: `internal error: entered unreachable code: IPython escape command expression is only allowed for % and !`
--&gt; crash.ipynb:1:1
</code></pre>
<p><strong>crash.ipynb</strong></p>
<pre><code>{
  &quot;cells&quot;: [
    {
      &quot;cell_type&quot;: &quot;code&quot;,
      &quot;metadata&quot;: {},
      &quot;outputs&quot;: [],
      &quot;source&quot;: [
        &quot;with a,?b\n?&quot;
      ]
    }
  ],
  &quot;metadata&quot;: {},
  &quot;nbformat&quot;: 4,
  &quot;nbformat_minor&quot;: 2
}
</code></pre>
Version
<p>ruff 0.14.5</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntBre">@ntBre</a> on 2025-11-15 01:22</div>
            <div class="timeline-body"><p>Thank you!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by <a href="https://github.com/ntBre">@ntBre</a> on 2025-11-15 01:22</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">parser</span> added by <a href="https://github.com/ntBre">@ntBre</a> on 2025-11-15 01:22</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2025-11-24 05:40</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 18:50:37 UTC
    </footer>
</body>
</html>
