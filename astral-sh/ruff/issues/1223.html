<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ignore `pyproject.toml` files that lack `[tool.ruff]` - astral-sh/ruff #1223</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Ignore `pyproject.toml` files that lack `[tool.ruff]`</h1>

    <div class="meta">
        <span class="state state-closed">Closed</span>
        <a href="https://github.com/astral-sh/ruff/issues/1223">#1223</a>
        opened by <a href="https://github.com/charliermarsh">@charliermarsh</a>
        on 2022-12-13 00:11
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2022-12-13 00:11</div>
            <div class="timeline-body"><p>Maybe? I think so?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">configuration</span> added by @charliermarsh on 2022-12-13 00:11</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">question</span> added by @charliermarsh on 2022-12-13 00:11</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/messense">@messense</a> on 2022-12-13 04:33</div>
            <div class="timeline-body"><p>Not sure if it's related, ruff starts to complain about E501 line too long suddenly: https://github.com/PyO3/maturin/actions/runs/3682202853/jobs/6229621666</p>
<p>while I have set <code>line-length = 120</code> in top level <code>pyproject.toml</code>: https://github.com/PyO3/maturin/blob/e7b8c22591e89a8b3e9bb02416105a8731fed847/pyproject.toml#L49 while the <code>pyproject.toml</code> in sub-project lacks <code>[tool.ruff]</code>: https://github.com/PyO3/maturin/blob/e7b8c22591e89a8b3e9bb02416105a8731fed847/test-crates/with-data/pyproject.toml</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2022-12-13 04:41</div>
            <div class="timeline-body"><p>Yeah it's related. We now use the closest <code>pyproject.toml</code> file to each Python file when resolving settings. And right now, we're not ignoring empty <code>pyproject.toml</code>, so from Ruff's perspective, there's no configuration for the files within <code>test-crates/with-data</code>.</p>
<p>One way to fix this is to add the following to <code>test-crates/with-data/pyproject.toml</code>:</p>
<pre><code class="language-toml">[tool.ruff]
extend = &quot;../../pyproject.toml&quot;
</code></pre>
<p>But, this issue was sort of based around this question -- of whether we should ignore <code>pyproject.toml</code> files that don't have a <code>[tool.ruff]</code>. Any opinion?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2022-12-13 04:45</div>
            <div class="timeline-body"><p>(I should just go ahead and change this to ignore those ‚Äúempty pyproject files, it‚Äôll almost always lead to undesired behavior like you‚Äôre experiencing now.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/messense">@messense</a> on 2022-12-13 04:51</div>
            <div class="timeline-body"><p>I'd expect sub-project extends parent ruff settings automatically, so when <code>pyproject.toml</code> file doesn't have a <code>[tool.ruff]</code> it's the same as its parent settings, when <code>pyproject.toml</code> file has a <code>[tool.ruff]</code> it merges with its parent settings.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2022-12-13 05:09</div>
            <div class="timeline-body"><p>Yeah, you do get the merging if you use the <code>extend</code> keyword, it's just explicit rather than automatic right now. I'll take that as +1 vote for making it automatic...</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2022-12-13 05:13</div>
            <div class="timeline-body"><p>(And if I made the change described in this issue, then if the child doesn't have <code>[tool.ruff]</code>, you'd automatically get the parent settings, which isn't true today.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2022-12-13 05:18</div>
            <div class="timeline-body"><p>I was hesitant to make this behavior automatic, but it <em>is</em> what ESLint does.</p>
<p>I ran a Twitter poll and it did get 53% of the vote ü§î</p>
<p>https://twitter.com/charliermarsh/status/1601803434948456448</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2022-12-13 05:19</div>
            <div class="timeline-body"><p>\cc @smackesey in case you have an opinion on whether parent-child settings should be inherited automatically or only explicitly (as it is now)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/smackesey">@smackesey</a> on 2022-12-13 09:21</div>
            <div class="timeline-body"><blockquote>
<p>Yeah, you do get the merging if you use the extend keyword, it's just explicit rather than automatic right now. I'll take that as +1 vote for making it automatic...</p>
</blockquote>
<p>I like ESLint's system of auto-merging, described fully here: https://eslint.org/docs/latest/user-guide/configuring/configuration-files</p>
<p>Am important feature is that you can stop merging at any point by putting <code>root: true</code> in your config-- this provides an escape from frustrating scenarios where you have a complex and bespoke root config but want something closer to the defaults in a subtree.</p>
<p>Regardless, the most important thing is that the system be fully documented in all its nuances and that those docs are easy to find. Would also be nice to have a CLI command to dump the full, post-merge config used for a file. It's always frustrating trying to discern the source of implicit configuration when docs are inaccurate or unclear.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/auscompgeek">@auscompgeek</a> on 2022-12-13 11:34</div>
            <div class="timeline-body"><p>Could also limit the amount of automatic nested configs one could have. I personally don't see many use cases than two levels of nesting, and if more really is desired the explicit <code>extend</code> is still there.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2022-12-13 15:01</div>
            <div class="timeline-body"><p>I know all-docs-in-README is bad (and not intended as a proper solution) but if helpful, I did document the behavior in the <a href="https://github.com/charliermarsh/ruff#pyprojecttoml-discovery"><code>pyproject.toml</code> discovery</a> section.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2022-12-13 15:03</div>
            <div class="timeline-body"><p>@smackesey - This actually does exist as <code>--show-settings</code>, like <code>ruff examples/docs_snippets/docs_snippets/__init__.py --show-settings</code>.</p>
<p>(It needs to be improved in a number of ways, but it'll show the settings for the <em>first</em> Python file resolved in the path, so it's best to pass it a single Python file. The output format is also a little overwhelming, but it is useful for debugging.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/arthur-st">@arthur-st</a> on 2022-12-13 16:32</div>
            <div class="timeline-body"><p>I have a use case where this would've helped - a monorepo with root-level CI-ish files like a <code>pyproject.toml</code> with configs for <code>ruff</code> and friends, which then has subprojects in a hierarchy roughly like this:</p>
<pre><code>pyproject.toml
foo/pyproject.toml
foo/main.py
</code></pre>
<p>And running <code>ruff foo/main.py</code> from the context root seems to consume <code>foo/pyproject.toml</code> exclusively.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2022-12-13 16:48</div>
            <div class="timeline-body"><p>Ok cool. Sounds like this is confusing enough that we should indeed ignore ‚Äúempty‚Äù pyproject files.</p>
<p>Just confirming that ‚Äúextend‚Äù does solve your problem though, if foo/pyproject.toml gets an ‚Äúextend‚Äù: ‚Äú../pyproject.toml‚Äù?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/smackesey">@smackesey</a> on 2022-12-13 17:48</div>
            <div class="timeline-body"><blockquote>
<p>Could also limit the amount of automatic nested configs one could have. I personally don't see many use cases than two levels of nesting, and if more really is desired the explicit extend is still there.</p>
</blockquote>
<p>IMO this could become very confusing-- I think it should be either 100% explicit or auto-merge all the way to the filesystem root.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/arthur-st">@arthur-st</a> on 2022-12-13 18:01</div>
            <div class="timeline-body"><blockquote>
<p>Ok cool. Sounds like this is confusing enough that we should indeed ignore ‚Äúempty‚Äù pyproject files.Just confirming that ‚Äúextends‚Äù does solve your problem though, if foo/pyproject.toml gets an ‚Äúextend‚Äù: ‚Äú../pyproject.toml‚Äù?</p>
</blockquote>
<p>You know, this would even be the preferred solution in my case - as that way monorepo &quot;tenants&quot; don't need to janitor tracking the code quality &quot;upstream&quot;. I didn't think to check for proper remedies before posting, apologies.</p>
<p>That said, I agree with @smackesey that the tool should be explicit about the config it's using. My current take on possible solution, using file system layout example from my previous post, would have the tool log a message in case it detects multiple <code>pyproject.toml</code> files in the hierarchy. As in, running <code>ruff foo/main.py</code> from context root would log (output verbose by default, hidden by flag/config) <code>Using config from foo/pyproject.toml, multiple config files detected in hierarchy</code>.</p>
<p>Say, then we change <code>foo/pyproject.toml</code> to extend the root <code>pyproject.toml</code>. Running <code>ruff foo/main.py</code> from context root would now log <code>Using config from foo/pyproject.toml, which extends root pyproject.toml</code>.</p>
<p>Undoubtedly, messaging can be improved, and there are some corner cases to ponder about here, but I think the key idea to give users control and information here is to explicitly inform them of a situation with multiple &quot;unlinked&quot; configuration files in the scanned tree.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2022-12-13 20:57</div>
            <div class="timeline-body"><p>Cool, so just recapping for a sec.</p>
<p>The current behavior is that when considering a given file, Ruff looks for the first <code>pyproject.toml</code> in the past (regardless of its contents), and uses that to determine the appropriate settings. Any <code>pyproject.toml</code> can extend any other <code>pyproject.toml</code> via an explicit <code>&quot;extend&quot;</code> option.</p>
<p>There are two different changes to this behavior being discussed in this thread.</p>
<p>The first change would be to keep the above behavior, but ignore any <code>pyproject.toml</code> that doesn't include <code>[tool.ruff]</code>. So inheritance would always be explicit, but we'd avoid &quot;breaking the chain&quot; in some common cases (like a base configuration in a monorepo, with some example projects nested therein, as we see in Maturin and Dagster).</p>
<p>The second change (mutually exclusive with the first) would be to <em>always</em> merge all <code>pyproject.toml</code> files in the path (i.e., merge every parent into its child). This is effectively how ESLint works. It would lead to the same behavior as the first change in the case of a <code>pyproject.toml</code> without a <code>[tool.ruff]</code> (since merging the parent into the child is the same as ignoring an empty child entirely).</p>
<p>(In this latter case, I guess we'd still support an <code>&quot;extend&quot;</code> keyword to allow extending a configuration file by a file that's <em>not</em> in its path, though it's hard for me to reason about what the order of precedence is when we have both explicit <code>&quot;extend&quot;</code> and this implicit merging. What would the semantics be? Do you merge in the <code>&quot;extend&quot;</code>, <em>then</em> the parents? Or skip the parents?)</p>
<p>(In this latter case, we'd also need to support something like ESLint's <code>root: true</code>.)</p>
<p>My current preference is to make the first change, but to continue requiring explicit <code>&quot;extend&quot;</code> rather than merging parents implicitly. I believe that all of these systems support effectively the same functionality -- it's mostly a question of what should be implicit vs. explicit. I honestly think they're all reasonable choices as long as they're well-documented!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/arthur-st">@arthur-st</a> on 2022-12-13 21:14</div>
            <div class="timeline-body"><p>I'm not sure I fully follow the first scenario, but if I do then I like it. Let's consider the following file hierarchy, where &quot;p&quot; is <code>pyproject.toml</code> file (sorry, scribbling on phone):</p>
<p>p
1/p
1/2/p
1/2/foo.py</p>
<p>If I understand you correctly, calling ruff on the Python file with <code>1/2/p</code> being the only <code>pyproject.toml</code> file without a ruff configuration block would load <code>1/p</code> settings, and it's up to the author of <code>1/p</code> to explicitly import settings from the root <code>p</code>.</p>
<p>If that's the case, I like this. I think a logging message noting the config used would remain a practical guardrail, but this would in any case remove a plausible source of confusion for newer users.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2022-12-13 21:16</div>
            <div class="timeline-body"><p>@arthur-st - Yes, I believe that's correct and matches what I'm proposing. (Today, calling ruff on <code>1/2/foo.py</code> would load <code>1/2/p</code> even if it's &quot;empty&quot;. If we make this change, it'd instead skip <code>1/2/p</code> and fall back to <code>1/p</code>.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @charliermarsh by @charliermarsh on 2022-12-14 22:48</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/1243.html">astral-sh/ruff#1243</a> on 2022-12-14 22:59</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2022-12-15 00:35</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:34:49 UTC
    </footer>
</body>
</html>
