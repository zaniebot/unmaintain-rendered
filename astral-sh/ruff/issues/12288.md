```yaml
number: 12288
title: RUF012 false positive with annotations set as strings
type: issue
state: open
author: ZeeD
labels:
  - bug
assignees: []
created_at: 2024-07-11T12:38:38Z
updated_at: 2024-07-12T12:56:54Z
url: https://github.com/astral-sh/ruff/issues/12288
synced_at: 2026-01-10T01:56:53Z
```

# RUF012 false positive with annotations set as strings

---

_Issue opened by @ZeeD on 2024-07-11 12:38_

<!--
Thank you for taking the time to report an issue! We're glad to have you involved with Ruff.

If you're filing a bug report, please consider including the following information:

* List of keywords you searched for before creating this issue. Write them down here so that others can find this issue more easily and help provide feedback.
  e.g. "RUF001", "unused variable", "Jupyter notebook"
* A minimal code snippet that reproduces the bug.
* The command you invoked (e.g., `ruff /path/to/file.py --fix`), ideally including the `--isolated` flag.
* The current Ruff settings (any relevant sections from your `pyproject.toml`).
* The current Ruff version (`ruff --version`).
-->

minimal case:

```python
from typing import ClassVar
from typing import Final


class C:
    cv_orig: ClassVar[list[int]] = []
    cv_str: 'ClassVar[list[int]]' = []

    cv_final_orig: Final[list[int]] = []
    cv_final_str: 'Final[list[int]]' = []

    use_case: 'Final[list[C]]' = []
```

with `ruff 0.5.1` I got the error
```
RUF012 Mutable class attributes should be annotated with `typing.ClassVar`
```

for `cv_str`, `cv_final_str` and `use_case` (that was my initial scenario...)


---

_Label `bug` added by @dhruvmanila on 2024-07-12 04:26_

---

_Comment by @dhruvmanila on 2024-07-12 04:27_

I think this is the case for other rules as well like `RUF008`, `RUF009`, etc.

---

_Comment by @charliermarsh on 2024-07-12 12:36_

üëç Yeah we would need to parse these. I wonder if we should consider parsing these in the parser and adding them to the AST...

---

_Comment by @charliermarsh on 2024-07-12 12:37_

Actually, we probably can't do that because you often need semantic information to know if a string is a type annotation.

---

_Comment by @dhruvmanila on 2024-07-12 12:44_

We _do_ parse it: https://github.com/astral-sh/ruff/blob/ecd6865d2800a574baf122583b6e463605af2ef5/crates/ruff_python_parser/src/typing.rs; I guess we need to provide some API to resolve it to the AST node if the model is in a type annotation context.

---

_Comment by @charliermarsh on 2024-07-12 12:45_

Yeah we just parse it much later, at the end IIRC.

---

_Comment by @charliermarsh on 2024-07-12 12:45_

Perhaps we could parse these on-demand and store them on the semantic model.

---

_Comment by @charliermarsh on 2024-07-12 12:46_

I guess that might not work because in theory these need to be evaluated lazily, at the very end (e.g., they can reference symbols that are imported afterwards, IIRC).

---

_Comment by @dhruvmanila on 2024-07-12 12:56_

At least for these 3 rules, they all require a class node which means we can store them in `Analyze` struct (https://github.com/astral-sh/ruff/blob/ecd6865d2800a574baf122583b6e463605af2ef5/crates/ruff_linter/src/checkers/ast/deferred.rs#L30-L37) and then later use `deferred_class.rs` (similar to `deferred_lambdas.rs`) to check for violations for these rules. We might want to update existing logic to not raise a violation if the annotation is a string.

---

_Referenced in [astral-sh/ruff#15345](../../astral-sh/ruff/pulls/15345.md) on 2025-01-08 10:36_

---

_Referenced in [astral-sh/ruff#15857](../../astral-sh/ruff/issues/15857.md) on 2025-01-31 17:23_

---
