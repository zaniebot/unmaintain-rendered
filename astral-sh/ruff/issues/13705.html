<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>detect if a regex escape is needed in a pytest match statement - astral-sh/ruff #13705</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>detect if a regex escape is needed in a pytest match statement</h1>

    <div class="meta">
        <span class="state state-closed">Closed</span>
        <a href="https://github.com/astral-sh/ruff/issues/13705">#13705</a>
        opened by <a href="https://github.com/nstarman">@nstarman</a>
        on 2024-10-10 14:59
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/nstarman">@nstarman</a> on 2024-10-10 14:59</div>
            <div class="timeline-body"><p>Sometimes <code>re.escape</code> are needed in pytest for <code>match=...</code> arguments.
Then the string is modified and the regex escape is no longer needed.
It would be great if ruff could detect this and remove the unneeded <code>re.escape</code>.</p>
<p>M~WE:</p>
<pre><code class="language-python">import pytest, re

with pytest.raises(Exception, match=re.escape(&quot;regexnotneeded&quot;)):
    ...
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../astropy/astropy/pulls/16847.html">astropy/astropy#16847</a> on 2024-10-10 14:59</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">rule</span> added by @MichaReiser on 2024-10-22 06:42</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/14746.html">astral-sh/ruff#14746</a> on 2024-12-03 00:41</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-12-10 12:34</div>
            <div class="timeline-body"><p>@InSyncWithFoo was so kind to implement the rule and we looked through the ecosystem changes. After seeing the changes, I don't think we should add this rule to ruff. While it's true that the <code>re.escape</code> call is unnecessary, it does train people not to use <code>re.escape</code> and they might then forget using it in cases where they actually should.</p>
<p>It makes me wonder if we could create ar ule that warns about <code>match</code> parameters that would need escaping. Are there heuristics that would allow us to detect correctly escaped from incorrectly escaped strings?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/nstarman">@nstarman</a> on 2024-12-10 14:19</div>
            <div class="timeline-body"><p>Easier for escaped that don't need to be, much harder for not-escaped that should to be. Pytest matches can work with regex, so it would be very hard to figure out if a string that looks like a regex isn't and should be escaped.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-12-10 16:45</div>
            <div class="timeline-body"><p>If you have a string passed to <code>pytest.raises()</code> that is:</p>
<ol>
<li>Not a raw string</li>
<li>Not surrounded by <code>re.escape()</code> and</li>
<li>contains a regex metacharacter</li>
</ol>
<p>Then I think it's reasonable to say that the string should <em>either</em> be a raw string (if it's meant to be a regex) <em>or</em> should be surrounded by <code>re.escape()</code> (if it's not meant to be a regex). That might possibly be a useful rule to add? What do we think?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a> on 2024-12-10 17:11</div>
            <div class="timeline-body"><blockquote>
<p>Then I think it's reasonable to say that the string should <em>either</em> be a raw string (if it's meant to be a regex) <em>or</em> should be surrounded by <code>re.escape()</code> (if it's not meant to be a regex).</p>
</blockquote>
<p>Sounds good to me. This also goes well with <a href="https://docs.astral.sh/ruff/rules/unraw-re-pattern/"><code>unraw-re-pattern</code></a>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/nstarman">@nstarman</a> on 2024-12-10 20:29</div>
            <div class="timeline-body"><p>And the reverse — if a string is surrounded by <code>re.escape</code> but doesn't have any regex in it?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-12-10 20:32</div>
            <div class="timeline-body"><blockquote>
<p>And the reverse — if a string is surrounded by <code>re.escape</code> but doesn't have any regex in it?</p>
</blockquote>
<p>We already considered and rejected that check in https://github.com/astral-sh/ruff/pull/14746, as Micha stated above in https://github.com/astral-sh/ruff/issues/13705#issuecomment-2531517937 I agree with his rationale.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a> on 2024-12-10 22:11</div>
            <div class="timeline-body"><p>I suppose I can go ahead and implement the new rule then? A PR should be ready sometime later this week.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/14966.html">astral-sh/ruff#14966</a> on 2024-12-14 00:27</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @AlexWaygood on 2024-12-18 11:53</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:34:53 UTC
    </footer>
</body>
</html>
