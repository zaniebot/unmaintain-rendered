<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ruff formatter ignoring `fmt: skip` - astral-sh/ruff #17331</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Ruff formatter ignoring <code>fmt: skip</code></h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/ruff/issues/17331">#17331</a>
        opened by <a href="https://github.com/madduck">@madduck</a>
        on 2025-04-10 10:05
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/madduck">@madduck</a> on 2025-04-10 10:05</div>
            <div class="timeline-body"><h3>Summary</h3>
<p>Taking this over from #8415:</p>
<p>I have a little snippet that inserts <code>ipdb</code> into code, and I want to keep it on a single line, so that I can easily remove it again with Vim <code>dd</code>, here is the test-case:</p>
<pre><code class="language-Python">def main() -&gt; None:
    import ipdb; ipdb.set_trace()  # noqa: E402,E702,I001 fmt: skip
</code></pre>
<p>This passes ruff's check alright:</p>
<pre><code>% ruff --isolated check test.py --fix 
All checks passed!
</code></pre>
<p>But when I run the formatter on it, it seems that <code>fmt: skip</code> is being ignored:</p>
<pre><code>% ruff --isolated format test.py --diff
--- test.py
+++ test.py
@@ -1,2 +1,4 @@
 def main() -&gt; None:
-    import ipdb; ipdb.set_trace()  # noqa: E402 E702 I001 # fmt: skip
+    import ipdb
+
+    ipdb.set_trace()  # noqa: E402 E702 I001 # fmt: skip

1 file would be reformatted
</code></pre>
<p>I have tried <code># fmt: skip</code> before and after the <code>noqa</code> filter, I have tried two spaces before the <code>#</code>, and I have tried without <code>noqa</code>, i.e. just <code># fmt: skip</code>, with and without a space after the colon — the same result for each of these permutations.</p>
<p>If I enclose the line in <code>fmt:off</code> and <code>fmt:on</code> statements, then the formatter finds nothing to do, but that defies the purpose of the single-line import, and the per-line <code>fmt:skip</code> instruction.</p>
<h3>Version</h3>
<p>0.11.4</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">formatter</span> added by @AlexWaygood on 2025-04-10 10:46</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-04-10 12:13</div>
            <div class="timeline-body"><p>Thanks. I thought this is the same as https://github.com/astral-sh/ruff/issues/11216 but it's only related.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @MichaReiser on 2025-04-10 12:13</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/madduck">@madduck</a> on 2025-07-27 15:14</div>
            <div class="timeline-body"><p>Is there anything I can do to expedite addressing of this bug?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-07-28 08:21</div>
            <div class="timeline-body"><p>No. I don't think so. We have all the information we need. It's just that someone needs to find time to fix this.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/madduck">@madduck</a> on 2025-07-28 08:51</div>
            <div class="timeline-body"><blockquote>
<p>No. I don't think so. We have all the information we need. It's just that someone needs to find time to fix this.</p>
</blockquote>
<p>Ok. I don't know Rust too well, nor do I have ample free time, but if you pointed me in the right direction, I could take a look…?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-07-28 09:17</div>
            <div class="timeline-body"><p>That's kind. I expect this fix to be somewhat involved. The best I can point you towards is https://github.com/astral-sh/ruff/blob/8c0743df97dc7afa1deab7506b322551f2e392bb/crates/ruff_python_formatter/src/comments/mod.rs#L501-L509. Then search where it is used</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-07-28 14:37</div>
            <div class="timeline-body"><p>I tried to implement this with claude but it struggled big times. But the tests are useful:</p>
<pre><code class="language-py"># Test cases for fmt: skip with compound statements (semicolon-separated statements)

# Simple assignment statements
a = 1
b = 2  # fmt: skip

# Import statements
import os
import sys  # fmt: skip

# Mixed statement types
x = 1
import json  # fmt: skip

# Import and function call
import ipdb

ipdb.set_trace()  # fmt: skip


# In function context
def test_function():
    import pdb

    pdb.set_trace()  # fmt: skip


# Original issue case
def main() -&gt; None:
    import ipdb

    ipdb.set_trace()  # fmt: skip


# Test whitespace preservation - no space after semicolon
import json
import os  # fmt: skip

# Test whitespace preservation - multiple spaces after semicolon
import ast
import csv  # fmt: skip

# Test that both statements remain entirely unformatted
a.b
c   .   d  # fmt: skip

# Test with method calls - both should be unformatted
obj.method1()
obj2   .   method2(   arg  )  # fmt: skip

# Test with string concatenation - both should be unformatted
&quot;hello&quot; + &quot;world&quot;
&quot;foo&quot;    +    &quot;bar&quot;  # fmt: skip

# Test with list operations - both should be unformatted
[1, 2, 3]
[4,   5,6   ]  # fmt: skip

# Test with leading comment on first statement and trailing comment on second
# leading comment
x.y
z.w  # trailing comment and fmt: skip

# Should format normally when no fmt: skip (compare with above)
a.b
c.d

# Should still break lines when no fmt: skip
import os
import sys

# Should still break when only first statement has fmt: skip on separate line
import os  # fmt: skip
import sys

# Test cases with 3+ statements on single line with fmt: skip
a = 1
b = 2
c = 3  # fmt: skip

# Three imports
import os
import sys
import json  # fmt: skip

# Four mixed statements
x = 1
y = 2
import math

z = 3  # fmt: skip

# Five statements with various formatting
a = 1
b = 2
c = 3
d = 4
e    =    5  # fmt: skip

# Multiple method calls
obj.method1()
obj.method2()
obj.method3()
obj.method4()  # fmt: skip

# Mixed operations with whitespace preservation
[1, 2]
{&quot;a&quot;: 1}
(3, 4)
x   +   y  # fmt: skip

# Many simple statements
a
b
c
d
e
f
g  # fmt: skip

# Function calls with arguments
print(1)
print(2, 3)
print(4, 5, 6)
print()  # fmt: skip


# In function context with multiple statements
def test_multiple():
    import pdb

    pdb.set_trace()
    x = 1
    y = 2  # fmt: skip


# Test cases where many statements are first in suite

# Module level - many statements as first statements in module
a = 1
b = 2
c = 3
d=4  # fmt: skip
regular_statement = &quot;after compound&quot;


# Function with many statements as first statements
def func_with_compound_first():
    x = 1
    y = 2
    z = 3
    w = 4
    v   =   5  # fmt: skip
    normal_statement = &quot;after&quot;


# Class with many statements as first statements
class ClassWithCompoundFirst:
    attr1 = 1
    attr2 = 2
    attr3=3  # fmt: skip

    def method(self):
        pass


# Nested function with compound first statements
def outer():
    def inner():
        import sys
        import os
        import json
        import ast  # fmt: skip

        return &quot;done&quot;

    return inner


# Class method with compound first statements
class TestClass:
    def method_with_compound_first(self):
        a = 1
        b = 2
        c    =    3  # fmt: skip
        return a + b + c


# Complex nesting - compound statements as first in various suites
if True:
    x = 1
    y = 2
    z = 3
    w = 4
    v = 5
    u=6  # fmt: skip
    print(&quot;after compound&quot;)

    def nested_func():
        import math
        import random
        from collections import defaultdict  # fmt: skip

        pass

    class NestedClass:
        value1 = 10
        value2 = 20
        value3 = 30
        value4=40  # fmt: skip


# Conditional with compound first statements
if True:
    first = 1
    second = 2
    third = 3
    fourth = 4
    fifth=5  # fmt: skip
elif False:
    alt1 = 10
    alt2 = 20
    alt3=30  # fmt: skip
else:
    else1 = 100
    else2 = 200
    else3 = 300
    else4=400  # fmt: skip

# Loop with compound first statements
for i in range(3):
    loop_var1 = i
    loop_var2 = i * 2
    loop_var3 = i * 3
    loop_var4=i*4  # fmt: skip

# While loop with compound first statements
while False:
    while_var1 = 1
    while_var2 = 2
    while_var3=3  # fmt: skip

# Try block with compound first statements
try:
    try_var1 = 1
    try_var2 = 2
    try_var3 = 3
    try_var4 = 4
    try_var5=5  # fmt: skip
except:
    except_var1 = 1
    except_var2 = 2
    except_var3=3  # fmt: skip
finally:
    finally_var1 = 1
    finally_var2=2  # fmt: skip

# With statement with compound first statements
with open(&quot;test.txt&quot;) as f:
    with_var1 = 1
    with_var2 = 2
    with_var3 = 3
    with_var4=4  # fmt: skip
</code></pre>
<p>And we probably need to integrate this into <code>FormatSuite</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dylwil3">@dylwil3</a> on 2025-12-22 15:22</div>
            <div class="timeline-body"><p>This will be fixed by #22119 but note that the exact example given in the OP does not use correct syntax for a <code>fmt: skip</code> directive. So that example still does not keep the two import statements on the same line - to get that you need to add another <code>#</code> character between the directive comments:</p>
<pre><code class="language-diff"> def main() -&gt; None:
-    import ipdb; ipdb.set_trace()  # noqa: E402,E702,I001 fmt: skip
+    import ipdb; ipdb.set_trace()  # noqa: E402,E702,I001 # fmt: skip
</code></pre>
<p>(I assume this is just a typo though because the other examples in the post <em>do</em> have a <code>#</code> character in between)</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 11:37:13 UTC
    </footer>
</body>
</html>
