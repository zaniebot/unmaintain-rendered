```yaml
number: 1083
title: "[bug?] 0.0.161 removes blank lines under indented import blocks"
type: issue
state: closed
author: smackesey
labels: []
assignees: []
created_at: 2022-12-05T22:42:31Z
updated_at: 2022-12-06T01:46:39Z
url: https://github.com/astral-sh/ruff/issues/1083
synced_at: 2026-01-10T01:56:44Z
```

# [bug?] 0.0.161 removes blank lines under indented import blocks

---

_Issue opened by @smackesey on 2022-12-05 22:42_

Ruff 0.0.161 seemed to change the handling of blank lines around imports significantly. This block was sorted with `0.0.160`:

```python
if TYPE_CHECKING:
    from dagster._grpc.client import DagsterGrpcClient


def sync_get_external_execution_plan_grpc(
    api_client: "DagsterGrpcClient",
    # ...
```

But 0.0.161 turned it into this:

```python
if TYPE_CHECKING:
    from dagster._grpc.client import DagsterGrpcClient
def sync_get_external_execution_plan_grpc(
    api_client: "DagsterGrpcClient",
    # ...
```

This seemed to happen wherever an import block was indented-- was that intended?

---

_Comment by @charliermarsh on 2022-12-05 22:55_

Not intended, will fix in a sec.

---

_Referenced in [astral-sh/ruff#1085](../../astral-sh/ruff/pulls/1085.md) on 2022-12-05 23:02_

---

_Closed by @charliermarsh on 2022-12-05 23:02_

---

_Comment by @charliermarsh on 2022-12-05 23:07_

@smackesey - Are you running from Dagster root? Would love to test against Dagster to make sure I'm not missing cases.

---

_Comment by @smackesey on 2022-12-05 23:09_

Thanks for the quick fix! Yes I'm running `ruff --select=I001 --fix` `git ls-files '*.py'` from the root, although it's on my stack which has already corrected other errors, so you will see a lot more noise (i.e. correct fixes) if you run against `master`.

---

_Comment by @charliermarsh on 2022-12-05 23:12_

Okay cool. I may revert some of the newline stuff for now, or try to fix some of the other changes that you're seeing, but will cut a new release in a bit.

---

_Comment by @charliermarsh on 2022-12-05 23:13_

(I was trying to mimic isort's behavior of inserting newlines when import blocks precede class and function definitions.)

---

_Comment by @charliermarsh on 2022-12-05 23:22_

Oddly, isort doesn't seem to enforce that behavior for indented imports -- that is, it doesn't add a newline here:

```py
if True:
    import os
    def f():
        pass
```

But, I think it should? I.e., I think that should be corrected to:

```py
if True:
    import os


    def f():
        pass
```

---

_Comment by @charliermarsh on 2022-12-05 23:30_

I changed that behavior here (https://github.com/charliermarsh/ruff/pull/1088), which reduces the churn with isort but I think is less desirable behavior, but curious if you have a preference @smackesey.

---

_Comment by @smackesey on 2022-12-05 23:52_

I agree that your suggested correction is better-- probably a bug in isort that it doesn't enforce that. Probably never caught because so many people follow `isort` with a formatter like `black` which will add those newlines.

---

_Comment by @charliermarsh on 2022-12-06 00:03_

There's one case here that I'm handling differently than `isort`, which is that I'm changing this:

```py
import os

# Comment here.

def f():
    pass
```

...to:

```py
import os


# Comment here.

def f():
    pass
```

Because the next AST node is a function, and we so we insert two lines after the import. I'd like to fix this, but it's kind of a tedious case so just a heads up as you may run into it.

---

_Comment by @smackesey on 2022-12-06 01:13_

I just tried `0.0.162` and I think due to this extra newline behavior you mention above, Ruff's `I001` ends up incompatible with black. Here's an example:

After running `black`:

```
        from dagster._core.events import DagsterEventType
        from dagster._core.storage.event_log.base import EventRecordsFilter

        def _wrap_asset_fn(materialization_fn):
```

And after running `ruff --fix --select=I001`:

```
        from dagster._core.events import DagsterEventType
        from dagster._core.storage.event_log.base import EventRecordsFilter


        def _wrap_asset_fn(materialization_fn):
```

So `black --check` and `ruff` can't both pass if `I001` is enabled.

---

_Comment by @charliermarsh on 2022-12-06 01:24_

Ahh interesting, ok. Is that only in indented blocks? Will check + fix.

---

_Comment by @charliermarsh on 2022-12-06 01:28_

Ok yeah, looks like Black has different rules in indented blocks. Will fix.

---

_Comment by @charliermarsh on 2022-12-06 01:46_

Ok, I believe this is fixed in [v0.0.163](https://github.com/charliermarsh/ruff/releases/tag/v0.0.163) (building now). I tested against Dagster, with Black, etc. That release also contains the D415 autofix, which I also tested against Dagster.

---
