<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>B023 False positive when there is a list comprehension with the same variable name in a loop. - astral-sh/ruff #15716</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>B023 False positive when there is a list comprehension with the same variable name in a loop.</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/ruff/issues/15716">#15716</a>
        opened by <a href="https://github.com/vivodi">@vivodi</a>
        on 2025-01-24 13:55
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/vivodi">@vivodi</a> on 2025-01-24 13:55</div>
            <div class="timeline-body"><h3>Description</h3>
<p><strong>minimal code snippet:</strong></p>
<pre><code class="language-py">for _ in range(3):
    [x for x in []]
    def func():
        lambda x: x
</code></pre>
<p><strong>command:</strong></p>
<pre><code>ruff check --isolated --select B023 demo.py
</code></pre>
<p><strong>log:</strong></p>
<pre><code>demo.py:5:19: B023 Function definition does not bind loop variable `x`
  |
4 |     def func():
5 |         lambda x: x
  |                   ^ B023
  |

Found 1 error.
</code></pre>
<p><strong>ruff version:</strong> 0.9.2</p>
<p>This is NOT a duplicate of https://github.com/astral-sh/ruff/issues/7847, because <code>x</code> is only used in a list comprehension in the same loop. Ruff should not raise a false positive in this situation.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @MichaReiser on 2025-01-24 14:27</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/orgua">@orgua</a> on 2025-02-28 14:40</div>
            <div class="timeline-body"><p>I got a similar false positive when variable name is not reused, but <code>pandas.apply()</code> is used:</p>
<pre><code class="language-python">import pandas as pd

data = pd.DataFrame()
data.loc[0, &quot;hex&quot;] = &quot;72756666&quot;
data.loc[1, &quot;hex&quot;] = &quot;75767576&quot;

def modifier(value):
    return chr(int(value, 16))


for _i in range(0, 4):
    data[f&quot;v{_i}&quot;] = data[&quot;hex&quot;].apply(
        lambda x: modifier(x[2 * _i : 2 * _i + 2]),
    )

print(data)
</code></pre>
<p>I am pretty sure that the code is correct and it returns what I want:</p>
<pre><code class="language-shell">        hex v0 v1 v2 v3
0  72756666  r  u  f  f
1  75767576  u  v  u  v
</code></pre>
<p>but the linting command</p>
<pre><code class="language-shell">ruff check --isolated --select B023 demo.py
</code></pre>
<p>triggers</p>
<pre><code class="language-Shell">demo.py:13:34: B023 Function definition does not bind loop variable `_i`
   |
11 | for _i in range(0, 4):
12 |     data[f&quot;v{_i}&quot;] = data[&quot;hex&quot;].apply(
13 |         lambda x: modifier(x[2 * _i : 2 * _i + 2]),
   |                                  ^^ B023
14 |     )
   |

demo.py:13:43: B023 Function definition does not bind loop variable `_i`
   |
11 | for _i in range(0, 4):
12 |     data[f&quot;v{_i}&quot;] = data[&quot;hex&quot;].apply(
13 |         lambda x: modifier(x[2 * _i : 2 * _i + 2]),
   |                                           ^^ B023
14 |     )
   |

Found 2 errors.
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/nyoungstudios">@nyoungstudios</a> on 2025-09-17 17:50</div>
            <div class="timeline-body"><p>I am experiencing the same issue. It is more generally any loop, not just list comprehension that causes the problem.</p>
<p>On ruff <code>0.13.0</code>.</p>
<p>Here is my example that raises a false positive.</p>
<pre><code class="language-python">for _ in range(2):

    def add_one():
        def _add_one_inner(value):
            return value + 1

        return _add_one_inner

    for value in range(5):
        result = add_one()(value)
        print(result)
</code></pre>
<p>Here is the error from the check command.</p>
<pre><code>B023 Function definition does not bind loop variable `value`
 --&gt; example_error.py:5:20
  |
3 |     def add_one():
4 |         def _add_one_inner(value):
5 |             return value + 1
  |                    ^^^^^
6 |
7 |         return _add_one_inner
  |

Found 1 error.
</code></pre>
<p>And here is the output from my simple example to show this is indeed a false positive.</p>
<pre><code>1
2
3
4
5
1
2
3
4
5
</code></pre>
<p>And to show this only happens when there is an outer loop, here is a code snippet that passes the checks which is the same except not nested in a loop.</p>
<pre><code class="language-python">def add_one():
    def _add_one_inner(value):
        return value + 1

    return _add_one_inner

for value in range(5):
    result = add_one()(value)
    print(result)
</code></pre>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 11:36:24 UTC
    </footer>
</body>
</html>
