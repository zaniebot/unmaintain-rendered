<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[red-knot] support invalid syntax without panics - astral-sh/ruff #13778</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[red-knot] support invalid syntax without panics</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/issues/13778">#13778</a>
        opened by <a href="https://github.com/carljm">@carljm</a>
        on 2024-10-16 16:03
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a></div>
            <div class="timeline-body"><p>The ruff parser is error-resilient and will generate a best-effort AST for any input, but red-knot currently assumes a valid AST in some places, and this can cause panics if it&#x27;s run over an invalid AST.</p>
<p>We should do best-effort type-checking for invalid ASTs, and never panic.</p>
<p>The trick is to do this while, as much as feasible, still maintaining some useful internal invariants, and failing fast (panic is good in this case!) if those invariants are violated, rather than allowing programming errors to pass silently and result in type-checking bugs.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by <a href="https://github.com/carljm">@carljm</a> on 2024-10-16 16:03</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2024-10-16 16:11</div>
            <div class="timeline-body"><p>https://github.com/astral-sh/ruff/pull/13701 is a useful reference on what changes were needed as of a few days ago to avoid panics on the Python files present in the ruff repo. At least some of those are due to invalid syntax.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone &quot;Red Knot 2024&quot; by <a href="https://github.com/carljm">@carljm</a> on 2024-11-07 16:21</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to <a href="https://github.com/dhruvmanila">@dhruvmanila</a> by <a href="https://github.com/carljm">@carljm</a> on 2024-11-07 16:21</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2024-11-07 16:23</div>
            <div class="timeline-body"><p>In addition to &quot;not panic&quot;, we also want to avoid useless or confusing diagnostics.</p>
<p>Inferring useful types in the face of syntax errors is less of a priority.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sharkdp">@sharkdp</a> on 2024-11-14 14:51</div>
            <div class="timeline-body"><p>We can now run red knot on all invalid-syntax examples in ruffs repository without panicking. We can also run it on a fuzzing corpus with ~4000 invalid-syntax files (<a href="https://github.com/astral-sh/ruff/issues/13448">astral-sh/ruff#13448</a>). The next step could be to look into direct fuzzing (#14157), or to look for other corpuses (corpi? corpora?) with invalid syntax examples.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-11-14 14:55</div>
            <div class="timeline-body"><p>@sharkdp could we extend our corpus tests to run over all ruff tests to ensure we catch regressions early?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sharkdp">@sharkdp</a> on 2024-11-14 15:28</div>
            <div class="timeline-body"><blockquote>
<p>@sharkdp could we extend our corpus tests to run over all ruff tests to ensure we catch regressions early?</p>
</blockquote>
<p>Yes â€” I&#x27;ll do that.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-11-15 16:32</div>
            <div class="timeline-body"><p>One specific case that we should handle is that we don&#x27;t put names synthesized by the parser during recovery into the symbol table (or try to look them up). There&#x27;s an AST method that allows testing for whether the name is valid.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-11-25 12:00</div>
            <div class="timeline-body"><blockquote>
<p>We can now run red knot on all invalid-syntax examples in ruffs repository without panicking. We can also run it on a fuzzing corpus with ~4000 invalid-syntax files (#13448). The next step could be to look into direct fuzzing (#14157), or to look for other corpuses (corpi? corpora?) with invalid syntax examples.</p>
</blockquote>
<p>@sharkdp just to note -- the unique thing about the fuzzer in #14157 is that the randomly generated source-code files it produces are guaranteed to always be valid Python syntax (at least, assuming there isn&#x27;t a bug in the fuzzer). That&#x27;s an extremely useful property of the fuzzer in some ways, but it does mean that the fuzzer is somewhat useless for testing how good red-knot is at handling invalid <em>syntax</em>. We&#x27;ll have to look into other fuzzing libraries if we want to have some automated fuzzing for that as well.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-12-02 12:40</div>
            <div class="timeline-body"><p>I&#x27;ve been exploring ways to create panics on source code with syntax errors but I haven&#x27;t found any that requires any source code that&#x27;s raising syntax errors which isn&#x27;t already documented which is <a href="https://github.com/astral-sh/ruff/issues/14672">astral-sh/ruff#14672</a> and https://github.com/astral-sh/ruff/blob/b63c2e126b928fab4180eda5d9132552beeee7fe/crates/red_knot_workspace/tests/check.rs#L273-L277.</p>
<p>I&#x27;ve also ran the fuzzer which produces source code with invalid syntax (<a href="https://github.com/astral-sh/ruff/pull/14678">astral-sh/ruff#14678</a>) multiple times and it always finds the one as linked above. The corpus is initiated with most of the Python files in the Ruff code base and all Python files in the CPython code base. The fuzzer runs on them and then starts shuffling the bytes around producing new source code which is then filtered to avoid the ones that doesn&#x27;t produce syntax errors as per our parser. This has an obvious limitation that the syntax errors that&#x27;s raised by the compiler</p>
<p>I looked at <a href="https://github.com/astral-sh/ruff/issues/13778">astral-sh/ruff#13778</a>#issuecomment-2479383240 as well but I&#x27;ve been unable to create a source code that could panic. I think that might be because of lack of type inference for positions where that could occur like type parameters, function parameters in combination with the AST key that includes the node range. So, technically even though that behavior might be incorrect, it doesn&#x27;t create a panic in red knot, at least not today.</p>
<p>Additionally, I also extracted all the examples from the syntax error test file in CPython code base (https://github.com/python/cpython/blob/bf21e2160d1dc6869fb230b90a23ab030835395b/Lib/test/test_syntax.py) as it&#x27;s a doctest and ran red knot on top of it and got no panics.</p>
<p>There are certain changes that can be done but I&#x27;ve been unable to create a source code related to those changes that would make red knot panic. I&#x27;m going to list them down here for posterity:</p>
<ul>
<li>Currently, for an invalid <code>Identifier</code>, the <code>ExprAttribute</code> doesn&#x27;t set an <code>Invalid</code> expression context. We use this information to avoid recording a use of a symbol and / or creating the definition. Carl did mention previously that an attribute expression will be handled in a different manner and wouldn&#x27;t create a definition.</li>
<li>The parser recovers from a syntax error where a keyword is used instead of a name by creating a name expression with the keyword: https://play.ruff.rs/cb616a58-855a-431e-8ee3-3ecd6320e45d. The downstream tools have no way of knowing whether this identifier was recovered from this syntax error. Regardless, this shouldn&#x27;t cause any panic.</li>
<li>Avoid adding the symbol for an <code>ExprName</code> which has an invalid expression context as that indicates a syntax error from which the parser recovered</li>
</ul>
<p>That said, I think we should periodically run the fuzzer and iteratively fix any errors that the model encounters. The model is still a work in progress so there are missing pieces which might prove necessary to create these panics if any.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-12-02 16:39</div>
            <div class="timeline-body"><p>Thanks for writing this up.</p>
<p>Do you think it would be possible and useful to have mdtests for invalid identifiers and keywords used as identifiers?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-12-03 04:59</div>
            <div class="timeline-body"><blockquote>
<p>Do you think it would be possible and useful to have mdtests for invalid identifiers and keywords used as identifiers?</p>
</blockquote>
<p>I think they should be covered by the invalid parser tests:</p>
<ul>
<li>Keyword assignment target: https://github.com/astral-sh/ruff/blob/5137fcc9c81610f687b6cb45413ef83c2c5eea73/crates/ruff_python_parser/resources/inline/err/assign_stmt_keyword_target.py</li>
<li>Invalid assignment target: https://github.com/astral-sh/ruff/blob/5137fcc9c81610f687b6cb45413ef83c2c5eea73/crates/ruff_python_parser/resources/invalid/statements/invalid_assignment_targets.py</li>
<li>Invalid augmented assignment target: https://github.com/astral-sh/ruff/blob/5137fcc9c81610f687b6cb45413ef83c2c5eea73/crates/ruff_python_parser/resources/invalid/statements/invalid_augmented_assignment_target.py</li>
</ul>
<p>Although, I think they don&#x27;t have complete coverage especially around &quot;keywords used as identifiers&quot;, I&#x27;ll add them.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-12-03 07:20</div>
            <div class="timeline-body"><p>That makes sense, thanks.</p>
<p>We could also assert that red knot doesn&#x27;t generate useless diagnostics for missing identifiers. For example. Red Knot should not emit a <code>undefined-variable</code> diagnostic for</p>
<pre><code>5 + 
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/carljm">@carljm</a> on 2024-12-09 16:10</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 18:48:59 UTC
    </footer>
</body>
</html>
