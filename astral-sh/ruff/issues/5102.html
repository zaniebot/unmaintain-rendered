<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Configuration via JSON - astral-sh/ruff #5102</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Configuration via JSON</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/issues/5102">#5102</a>
        opened by <a href="https://github.com/tgross35">@tgross35</a>
        on 2023-06-14 21:58
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/tgross35">@tgross35</a> on 2023-06-14 21:58</div>
            <div class="timeline-body"><p>This is my second (and I think improved) take on https://github.com/astral-sh/ruff/issues/4970</p>
<p>What would thoughts be on accepting a parameter <code>--config-json</code> that takes identical configuration to <code>ruff.toml</code>? Example:</p>
<pre><code class="language-sh">ruff . --config-json '{&quot;per-file-ignores&quot;:{&quot;__init__.py&quot;:[&quot;E402&quot;],&quot;path/to/file.py&quot;:[&quot;E402&quot;]},&quot;ruff&quot;:{&quot;ignore&quot;:[&quot;E501&quot;],&quot;select&quot;:[&quot;E&quot;,&quot;F&quot;,&quot;B&quot;],&quot;unfixable&quot;:[&quot;B&quot;]}}'
</code></pre>
<p>Reasoning:</p>
<ul>
<li>It would be possible to invoke <code>ruff</code> from tools that are unaware of ruff's CLI format or schema. For example, a <code>cargo-ruff</code> tool could (1) grab the <code>package.metadata.ruff</code> table from <code>Cargo.toml</code>, (2) naively reserialize it as JSON, no validation required, (3) invoke ruff with the CLI option. Same for a NPM tool that uses config in <code>package.json</code>, or something that uses legacy <code>tox.ini</code> or <code>setup.cfg</code></li>
<li>There is minimal maintenance overhead: since the schema is identical to the <code>toml</code> version, the same structs can be used with serde and no additional documentation is required</li>
<li>If there is ever highly nested or advanced configuration that can be specified in <code>ruff.toml</code>/<code>pyproject.toml</code> but is difficult to supply via CLI arguments, this would provide a workaround for CI tools</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-06-14 22:06</div>
            <div class="timeline-body"><p>I think this does make sense, and it's come up at least once before.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-06-14 22:09</div>
            <div class="timeline-body"><p>It would help with this too: https://github.com/astral-sh/ruff/issues/3694.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/tgross35">@tgross35</a> on 2023-06-14 22:11</div>
            <div class="timeline-body"><p>Good point with #3694 - I can take a try at this sometime this week if you're OK with what I described</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-06-14 22:13</div>
            <div class="timeline-body"><p>I'm supportive of it! You can probably look at how the <code>config</code> command-line argument is treated (which takes a path to a configuration file), and mostly follow the same pattern.</p>
<p>(Disclaimer that I'll want to get @MichaReiser's take prior to merging since he's thought about the future of configuration -- he's on vacation but will be back next week.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">configuration</span> added by @charliermarsh on 2023-06-14 22:14</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">cli</span> added by @charliermarsh on 2023-06-14 22:14</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/tgross35">@tgross35</a> on 2023-06-14 22:16</div>
            <div class="timeline-body"><p>Sounds great! I will jump on this</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-06-19 08:37</div>
            <div class="timeline-body"><p>I think being able to set any configuration value via the CLI would have two benefits:</p>
<ul>
<li>Reduce the explicit need to add a CLI argument for every configuration option</li>
<li>Allow other tools to <em>generate</em> the configuration on the fly and pass it to ruff.</li>
</ul>
<p>The downside I see of using <code>--config-json</code> is that:</p>
<ul>
<li>Writting JSON is cumbersome and some users may prefer YAML, meaning we would need to support different input formats</li>
<li>It replaces any existing configuration. Thus, it doesn't help to reduce the amount of CLI arguments that ruff must support to allow customizing all configuration options via the CLI.</li>
</ul>
<p>@tgross35 what would you think if we instead use an approach similar to <code>cargo</code> that allows you to override every key in the configuration:</p>
<pre><code>--config &lt;KEY=VALUE&gt;      Override a configuration value
</code></pre>
<p>We would need to come up with a different name because ruff already uses <code>--config</code>.</p>
<p>I think this should work for your use case too, because you can iterate over the toml and create one <code>--config</code> argument for each <em>terminal</em> key in the configuration.</p>
<p>One issue that could potentially come up is that this approach fails for very large configurations where it would be necessary to pass a few thousands of lines of key value pairs.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/tgross35">@tgross35</a> on 2023-06-19 17:54</div>
            <div class="timeline-body"><blockquote>
<p>The downside I see of using <code>--config-json</code> is that:</p>
<ul>
<li>Writting JSON is cumbersome and some users may prefer YAML, meaning we would need to support different input formats</li>
<li>It replaces any existing configuration. Thus, it doesn't help to reduce the amount of CLI arguments that ruff must support to allow customizing all configuration options via the CLI.</li>
</ul>
</blockquote>
<p>I don't think there is any need to support YAML or anything else. As I see it, this option would be available for other tools to run <code>ruff</code> using their configuration - such as in #3694 where they want to configure via python (they could simply <code>json.dumps</code> a dict to get a valid <code>--config-json</code> CLI option). Or for other tools that use JSON, YAML, or TOML configuration - that tool would be responsible for converting YAML to JSON, but ruff has no need of burdening itself with anything other than a JSON representation (which comes for free with the <code>serde</code> structs used for TOML).</p>
<blockquote>
<p>@tgross35 what would you think if we instead use an approach similar to <code>cargo</code> that allows you to override every key in the configuration:</p>
<pre><code>--config &lt;KEY=VALUE&gt;      Override a configuration value
</code></pre>
<p>We would need to come up with a different name because ruff already uses <code>--config</code>.</p>
</blockquote>
<p>This might be a good idea if you are looking for ways to ease user configuration, but I think it is clunkier for other tools - because now you need to take configuration that is easily serializable to JSON (as is the case for TOML and YAML) and manually split it up, remove quotes, convert lists to CSV, recurse this for all nesting options, etc. And then do the opposite on the <code>ruff</code> side. Not that that's impossible, but it seems like more trouble than it's worth when the TOML&lt;-&gt;JSON and YAML&lt;-&gt;JSON conversion is already well defined.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-06-19 20:16</div>
            <div class="timeline-body"><p>Have you considered creating a (named) temp file and passing that path to Ruff? It seems that unlocks the functionality you want without requiring any changes on Ruff's side.</p>
<p>The reason I'm heistant of adding <code>--config-json</code> is that it only solves a very particular use case and may not be useful to many other users. Each added option makes ruff more difficult to use (mental overload because you get hit by a wall of options). That's why I be more in favor of adding an option that uses multiple purposes like cargo's config. I can see how this is more difficult to use from a tooling perspective because you need to flatten lists (specify the same key multiple times) and correctly escape values as you pointed out. I wonder if it would be possible to use <code>jq</code> and <code>yq</code> to perform this conversation.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-06-19 20:24</div>
            <div class="timeline-body"><p>I did some more research and the only tool that I found that supports something similar is Jest where <code>--config</code> either accepts a path or a JSON encoded value. We could probably support this but I'm still leaning towards this being a very specific use case.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/tgross35">@tgross35</a> on 2023-06-22 07:15</div>
            <div class="timeline-body"><blockquote>
<p>Have you considered creating a (named) temp file and passing that path to Ruff? It seems that unlocks the functionality you want without requiring any changes on Ruff's side.</p>
</blockquote>
<p>The named temp file is the current solution, but it is unfortunately quite cumbersome.</p>
<blockquote>
<p>Each added option makes ruff more difficult to use (mental overload because you get hit by a wall of options). That's why I be more in favor of adding an option that uses multiple purposes like cargo's config.</p>
</blockquote>
<p>Could the option be hidden from the <code>--help</code> output?</p>
<p>In any case, I don't think <code>--config-json</code> option would be any more of a mental overload than <code>--config KEY=VALUE</code>. It's a well defined &amp; understood schema that uses the identical config to <code>ruff.toml</code> (just put a <code>ruff.toml</code> into https://pseitz.github.io/toml-to-json-online-converter/ and you would have the <code>--config-json</code> argument). For any sort of <code>KEY=VALUE</code> configuration, the user needs to read the docs to figure out how to do the things like lists or nested objects - not a bad thing to have, but not as intuitive when you're trying to run from another program.</p>
<p>Samples of the use cases I am imagining, which could be documented examples:</p>
<pre><code class="language-rust">//! A `cargo-ruff` tool that would run ruff upon running `cargo ruff`, with config in
//! `[package.metadata.ruff]` in `Cargo.toml`

fn main() {
    let manifest_path = // ... use cargo_metadata to extract
    let contents = std::fs::read_to_string(manifest_path)?;
    let v: Value = serde_json::from_str(contents)?;
    let cfg = v[&quot;package&quot;][&quot;metadata&quot;][&quot;ruff&quot;];
    Command::new(&quot;ruff&quot;).arg(&quot;--config-json&quot;).arg(cfg.to_str()).status();
}
</code></pre>
<pre><code class="language-make"># Makefile for C+Py projects where some configuration exists in a YAML file

lint:
    ruff --config-json $(yq '.ruff-config' project-config.yaml)
</code></pre>
<pre><code class="language-json5">// A NPM project with a few python files (very similar to above)
{
  &quot;name&quot;: &quot;demo&quot;,
  // ...
  &quot;scripts&quot;: {
    &quot;lint:py&quot;: &quot;ruff $(jq '.ruff-config' package.json)&quot;
  },
  &quot;ruff-config&quot;:
    &quot;per-file-ignores&quot;: {
      &quot;__init__.py&quot;: [&quot;E402&quot;],
      &quot;path/to/file.py&quot;: [&quot;E402&quot;]
    }
}
</code></pre>
<pre><code class="language-py"># Python just needs to construct a dict to run `ruff`

cfg = {&quot;extend-exclude&quot;: [f for f in skip_files]}
subprocess.run([&quot;ruff&quot;, &quot;--config-json&quot;, json.dumps(cfg)])
</code></pre>
<pre><code class="language-rust">// The ruff changes would only be a few dozen lines: more or
// less just the below

if let Some(cfg) = args.config_json {
    return serde_json::from_str::&lt;Options&gt;()?;
}
</code></pre>
<p>All of those are simple yet powerful use cases in 1-3 lines -  super easy to add to any project. Any sort of custom <code>KEY=VALUE</code> schema turns any of the above into multiple lines, not something you could easily put in a <code>package.json</code> script.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-07-10 08:29</div>
            <div class="timeline-body"><p>Thank you for adding the additional detail and I see why a temporary file doesn't work well for a script in <code>package.json</code>.</p>
<p>We discussed this further internally. We do see the value of it and may decide to support it eventually, but we aren't sure if adding a new CLI option accepting JSON is the right way to go. I'll close this issue in favor of https://github.com/astral-sh/ruff/issues/3694 which asks for a similar feature.</p>
<p>I, unfortunately, can't suggest a better solution for the time being other than autogenerating the <code>ruff.toml</code> and committing it. You can also put the file in a subfolder and pass it with <code>--config &lt;path&gt;</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @MichaReiser on 2023-07-10 08:29</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 11:30:26 UTC
    </footer>
</body>
</html>
