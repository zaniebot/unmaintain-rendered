<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PERF401 should not apply to nested list comprehensions - astral-sh/ruff #11936</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>PERF401 should not apply to nested list comprehensions</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/issues/11936">#11936</a>
        opened by <a href="https://github.com/knyazer">@knyazer</a>
        on 2024-06-19 09:16
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/knyazer">@knyazer</a></div>
            <div class="timeline-body">

Description
<p>PERF401 recommends to use list comprehensions even if it leads to nested list comprehensions. I would guess a lot of people agree that nested list comprehensions are a bad code practice, but I cannot find any sources, sadly.</p>
Minimal example
<pre><code># test.py
def func():
    mylist = []
    for iterable in [[1], [2], [3]]:
        mylist.append([el + 1 for el in iterable])
    return mylist
</code></pre>
<p>When you run <code>ruff check --select PERF401 test.py</code>, you would get a recommendation to use a list comprehension.</p>
<p>While minimal example does not look this bad, here is a real world example:</p>
Real example
<pre><code>times = [
    [transcription.captions[index].end for index in range(len(transcription.captions) - 1)]
    for transcription in [*transcriptionStorage.get(), new_transcription]
    if transcription.isValid()
]
</code></pre>
<p>and wow, this is awful!</p>
Possible solution
<p>I&#x27;m not sure how ruff internals work, but I guess it should not be extremely hard to figure out that there is a list comprehension inside of the block where the PERF401 is detected.</p>
Other
<p><code>ruff --version # 0.4.5</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-06-23 16:32</div>
            <div class="timeline-body"><p>I see the motivation but I feel like this is working as intended. The rule is looking for iterations that could be rewritten as comprehensions for micro-optimization purposes, and it&#x27;s identifying one here. To take the other side of the argument, it would be surprising for <code>PERF401</code> to sometimes trigger and sometimes not depending on the target expression. (Candidly, I don&#x27;t find the real example to be much harder to read, but I recognize that&#x27;s just subjective).</p>
<p>It&#x27;s kind of a niche rule -- I&#x27;d recommend just disabling it if you&#x27;re not in a situation that demands it, and aren&#x27;t happy with the suggestions.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-06-23 16:32</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 18:48:54 UTC
    </footer>
</body>
</html>
