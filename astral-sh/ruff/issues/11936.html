<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PERF401 should not apply to nested list comprehensions - astral-sh/ruff #11936</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>PERF401 should not apply to nested list comprehensions</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/issues/11936">#11936</a>
        opened by <a href="https://github.com/knyazer">@knyazer</a>
        on 2024-06-19 09:16
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/knyazer">@knyazer</a></div>
            <div class="timeline-body"><!--
Thank you for taking the time to report an issue! We're glad to have you involved with Ruff.

If you're filing a bug report, please consider including the following information:

* List of keywords you searched for before creating this issue. Write them down here so that others can find this issue more easily and help provide feedback.
Keywords: PERF401, nested comprehension, list comprehension
* A minimal code snippet that reproduces the bug.
* The command you invoked (e.g., `ruff /path/to/file.py --fix`), ideally including the `--isolated` flag.
* The current Ruff settings (any relevant sections from your `pyproject.toml`).
* The current Ruff version (`ruff --version`).
-->

<h3>Description</h3>
<p>PERF401 recommends to use list comprehensions even if it leads to nested list comprehensions. I would guess a lot of people agree that nested list comprehensions are a bad code practice, but I cannot find any sources, sadly.</p>
<h3>Minimal example</h3>
<pre><code class="language-py"># test.py
def func():
    mylist = []
    for iterable in [[1], [2], [3]]:
        mylist.append([el + 1 for el in iterable])
    return mylist
</code></pre>
<p>When you run <code>ruff check --select PERF401 test.py</code>, you would get a recommendation to use a list comprehension.</p>
<p>While minimal example does not look this bad, here is a real world example:</p>
<h3>Real example</h3>
<pre><code class="language-py">times = [
    [transcription.captions[index].end for index in range(len(transcription.captions) - 1)]
    for transcription in [*transcriptionStorage.get(), new_transcription]
    if transcription.isValid()
]
</code></pre>
<p>and wow, this is awful!</p>
<h3>Possible solution</h3>
<p>I'm not sure how ruff internals work, but I guess it should not be extremely hard to figure out that there is a list comprehension inside of the block where the PERF401 is detected.</p>
<h3>Other</h3>
<p><code>ruff --version # 0.4.5</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-06-23 16:32</div>
            <div class="timeline-body"><p>I see the motivation but I feel like this is working as intended. The rule is looking for iterations that could be rewritten as comprehensions for micro-optimization purposes, and it's identifying one here. To take the other side of the argument, it would be surprising for <code>PERF401</code> to sometimes trigger and sometimes not depending on the target expression. (Candidly, I don't find the real example to be much harder to read, but I recognize that's just subjective).</p>
<p>It's kind of a niche rule -- I'd recommend just disabling it if you're not in a situation that demands it, and aren't happy with the suggestions.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2024-06-23 16:32</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 16:50:29 UTC
    </footer>
</body>
</html>
