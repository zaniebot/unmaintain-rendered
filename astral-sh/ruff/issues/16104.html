<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>`invalid-formatter-suppression-comment (RUF028)` false positives - astral-sh/ruff #16104</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1><code>invalid-formatter-suppression-comment (RUF028)</code> false positives</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/issues/16104">#16104</a>
        opened by <a href="https://github.com/Avasam">@Avasam</a>
        on 2025-02-11 20:54
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/Avasam">@Avasam</a> on 2025-02-11 20:54</div>
            <div class="timeline-body"><h3>Description</h3>
<p>In https://github.com/Toufool/AutoSplit, I have a handful of false-positives for <a href="https://docs.astral.sh/ruff/rules/invalid-formatter-suppression-comment/#invalid-formatter-suppression-comment-ruf028">invalid-formatter-suppression-comment (RUF028)</a>:</p>
<pre><code class="language-python">src\AutoSplit.py:550:53: RUF028 This suppression comment is invalid because it cannot be in an expression, pattern, argument list, or other non-statement
    |
548 |             or &quot;Delayed Split&quot; in self.current_split_image.text()
549 |             or not (
550 |                 self.skip_split_button.isEnabled()  # fmt: skip
    |                                                     ^^^^^^^^^^^ RUF028
551 |                 or self.is_auto_controlled
552 |                 or navigate_image_only
    |
    = help: Remove this comment

src\AutoSplit.py:962:29: RUF028 This suppression comment is invalid because it cannot be in an expression, pattern, argument list, or other non-statement
    |
960 |         # Get split image
961 |         self.split_image = (
962 |             specific_image  # fmt: skip
    |                             ^^^^^^^^^^^ RUF028
963 |             or self.split_images_and_loop_number[0 + self.split_image_number][0]
964 |         )
    |
    = help: Remove this comment

src\capture_method\DesktopDuplicationCaptureMethod.py:51:46: RUF028 This suppression comment is invalid because it cannot be in an expression, pattern, argument list, or other non-statement
   |
49 |             display
50 |             for display in self.desktop_duplication.displays
51 |             if display.hmonitor == hmonitor  # fmt: skip
   |                                              ^^^^^^^^^^^ RUF028
52 |         )
53 |         offset_x, offset_y, *_ = win32gui.GetWindowRect(hwnd)
   |
   = help: Remove this comment

src\capture_method\WindowsGraphicsCaptureMethod.py:165:54: RUF028 This suppression comment is invalid because it cannot be in an expression, pattern, argument list, or other non-statement
    |
163 |     def check_selected_region_exists(self):
164 |         return bool(
165 |             is_valid_hwnd(self._autosplit_ref.hwnd)  # fmt: skip
    |                                                      ^^^^^^^^^^^ RUF028
166 |             and self.frame_pool
167 |             and self.session
    |
    = help: Remove this comment

src\compare.py:85:42: RUF028 This suppression comment is invalid because it cannot be in an expression, pattern, argument list, or other non-statement
   |
83 |     # that the value can be. Used for normalizing from 0 to 1.
84 |     max_error = (
85 |         source.size * MAXBYTE * MAXBYTE  # fmt: skip
   |                                          ^^^^^^^^^^^ RUF028
86 |         if not is_valid_image(mask)
87 |         else cv2.countNonZero(mask)
   |
   = help: Remove this comment

src\hotkeys.py:139:40: RUF028 This suppression comment is invalid because it cannot be in an expression, pattern, argument list, or other non-statement
    |
137 |     # keyboard.send(keyboard.key_to_scan_codes(key_or_scan_code)[1])
138 |     pyautogui.hotkey(*[
139 |         &quot;+&quot; if key == &quot;plus&quot; else key  # fmt: skip
    |                                        ^^^^^^^^^^^ RUF028
140 |         for key in hotkey_or_scan_code.replace(&quot; &quot;, &quot;&quot;).split(&quot;+&quot;)
141 |     ])
    |
    = help: Remove this comment

src\menu_bar.py:190:9: RUF028 This suppression comment is invalid because it cannot be on its own line
    |
188 |         self.setFocus()
189 |
190 |         # region Build the Capture method combobox  # fmt: skip
    |         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ RUF028
191 |
192 |         capture_method_values = CAPTURE_METHODS.values()
    |
    = help: Remove this comment

src\menu_bar.py:239:35: RUF028 This suppression comment is invalid because it cannot be in an expression, pattern, argument list, or other non-statement
    |
237 |         try:
238 |             return [
239 |                 device.device_id  # fmt: skip
    |                                   ^^^^^^^^^^^ RUF028
240 |                 for device in self.__video_capture_devices
241 |             ].index(capture_device_id)
    |
    = help: Remove this comment

src\user_profile.py:194:34: RUF028 This suppression comment is invalid because it cannot be in an expression, pattern, argument list, or other non-statement
    |
192 |     )
193 |     if not (
194 |         load_settings_file_path  # fmt: skip
    |                                  ^^^^^^^^^^^ RUF028
195 |         and __load_settings_from_file(autosplit, load_settings_file_path)
196 |     ):
    |
    = help: Remove this comment

src\user_profile.py:207:15: RUF028 This suppression comment is invalid because it cannot be in an expression, pattern, argument list, or other non-statement
    |
205 | def load_settings_on_open(autosplit: &quot;AutoSplit&quot;):
206 |     settings_files = [
207 |         file  # fmt: skip
    |               ^^^^^^^^^^^ RUF028
208 |         for file in os.listdir(auto_split_directory)
209 |         if file.endswith(&quot;.toml&quot;)
    |
    = help: Remove this comment
</code></pre>
<p>Removing any of them would cause the formatter (<code>ruff format</code>) to unwrap the line. These are all related to https://github.com/astral-sh/ruff/issues/5528#issuecomment-2564419176 and https://github.com/astral-sh/ruff/issues/11753#issuecomment-2161337125</p>
<p>Ruff version: 0.9.6</p>
<p>Settings: <a href="https://github.com/user-attachments/files/18758584/ruff.toml.txt">ruff.toml.txt</a></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @ntBre on 2025-02-11 21:02</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">preview</span> added by @ntBre on 2025-02-11 21:02</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-02-11 21:54</div>
            <div class="timeline-body"><p>These are all true positives with the exception of:</p>
<pre><code>src\capture_method\DesktopDuplicationCaptureMethod.py:51:46: RUF028 This suppression comment is invalid because it cannot be in an expression, pattern, argument list, or other non-statement
   |
49 |             display
50 |             for display in self.desktop_duplication.displays
51 |             if display.hmonitor == hmonitor  # fmt: skip
   |                                              ^^^^^^^^^^^ RUF028
52 |         )
53 |         offset_x, offset_y, *_ = win32gui.GetWindowRect(hwnd)
   |
   = help: Remove this comment
</code></pre>
<p>The reason why the formatter doesn't collapse the other expressions is because there's an end-of-line comment inside the expression but it could also be <code># blabla</code> instead of <code>fmt: skip</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-02-11 21:55</div>
            <div class="timeline-body"><p>Actually, never mind. All of those are true-positives. I thought the one is an if-statement but it's also an if expression.</p>
<blockquote>
<p><code># fmt: skip</code> comments suppress formatting for a preceding statement, case header, decorator, function definition, or class definition:
<a href="https://docs.astral.sh/ruff/formatter/#format-suppression">source</a></p>
</blockquote>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> removed by @MichaReiser on 2025-02-11 21:55</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">preview</span> removed by @MichaReiser on 2025-02-11 21:55</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">question</span> added by @MichaReiser on 2025-02-11 21:55</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Avasam">@Avasam</a> on 2025-02-11 22:04</div>
            <div class="timeline-body"><p>Oh I see, having any comment there would work.
But I do use it to prevent formatter from formatting, it's be weird to use any other comment than <code># fmt: skip</code>.</p>
<p>I'm not sure what to make of this, I'll just keep <code>RUF028</code> disabled for now.</p>
<p>Would it make sense to request my usage to be supported? (ie actually telling the formatter to not unwrap, rather than just incidentally not unwrapping because of an arbitrary comment)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">suppression</span> added by @MichaReiser on 2025-02-12 08:20</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">formatter</span> added by @MichaReiser on 2025-02-12 08:20</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-02-12 08:25</div>
            <div class="timeline-body"><blockquote>
<p>But I do use it to prevent formatter from formatting, it's be weird to use any other comment than # fmt: skip.</p>
</blockquote>
<p>That makes sense. You could do <code>fmt: ignore</code>,  <code>fmt: split</code>, <code>fmt: splitting on multiple lines is prettier</code> or any other comment for as long as it isn't <code>fmt: off</code> or <code>fmt: skip</code> because the formatter will keep formatting it.</p>
<blockquote>
<p>Would it make sense to request my usage to be supported? (ie actually telling the formatter to not unwrap, rather than just incidentally not unwrapping because of an arbitrary comment)</p>
</blockquote>
<p>I don't think that's unreasonable. I considered it when working on suppression comments. There are two reasons why I decided against it:</p>
<ol>
<li>I found it unintuitive how and when and where expression level suppression comments apply in Black. <a href="https://github.com/astral-sh/ruff/discussions/6338">discussion</a></li>
<li>Implementing suppressions is fairly complicated in our design and I rather spent the time on improving the formatting itself, than making suppressions better. However, we could consider supporting a suppression comment similar to Prettier where you add the suppression before the expression you want to suppress rather than at its end (https://prettier.io/docs/ignore.html#javascript). However, Python is a bit different than JS because it sometimes requires parentheses around expressions to prevent syntax errors where JS doesn't.</li>
</ol>
<p>I hope that makes sense to you.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Avasam">@Avasam</a> on 2025-02-12 16:14</div>
            <div class="timeline-body"><blockquote>
<p>fmt: splitting on multiple lines is prettier</p>
</blockquote>
<p>Unironically though, I want to go with something that will clearly show it's not a special pragma comment supported by the formatted. I think I'll go with:
<code># fmt: Don't unwrap</code> or even just <code># Don't unwrap</code>.</p>
<blockquote>
<p>I hope that makes sense to you.</p>
</blockquote>
<p>Yes and thanks for the insight!</p>
<p>Since this issue was originally about false-positives, and I got a resolution to my issue, I'll close it.</p>
<p>I also think that improving the formatter would be preferable over supporting more (official) ways to disable it. Plenty of ideas in #11753 for this case.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @Avasam on 2025-02-12 16:14</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 11:36:38 UTC
    </footer>
</body>
</html>
