<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>`RET503`: Conflict with `--warn-unreachable` in `mypy` - astral-sh/ruff #2602</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>`RET503`: Conflict with `--warn-unreachable` in `mypy`</h1>

    <div class="meta">
        <span class="state state-closed">Closed</span>
        <a href="https://github.com/astral-sh/ruff/issues/2602">#2602</a>
        opened by <a href="https://github.com/ngnpope">@ngnpope</a>
        on 2023-02-06 10:03
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/ngnpope">@ngnpope</a> on 2023-02-06 10:03</div>
            <div class="timeline-body"><p>I strongly suspect this one is in the realms of &quot;cannot do without typing support&quot;, but it's at least worth having in the issue tracker for documentation purposes. Maybe it's possible to special case, but we'll never capture all possibilities.</p>
<p>Consider the following:</p>
<pre><code class="language-python">import pytest
import typing

@pytest.fixture
def test_function(request: pytest.FixtureRequest) -&gt; typing.Any:
    if request.param == &quot;something&quot;:
        return request.getfixturevalue(&quot;whatever&quot;)
    pytest.fail(&quot;Invalid parameters.&quot;)
</code></pre>
<p>I get the following output:</p>
<pre><code class="language-console">❯ ruff --version
ruff 0.0.241

❯ mypy --version
mypy 0.991 (compiled: yes)

❯ ruff --isolated --select RET503 bug.py 
bug.py:8:5: RET503 [*] Missing explicit `return` at the end of function able to return non-`None` value
Found 1 error.
[*] 1 potentially fixable with the --fix option.

❯ mypy --strict --warn-unreachable bug.py 
Success: no issues found in 1 source file

❯ ruff --isolated --select RET503 --fix bug.py 
Found 1 error (1 fixed, 0 remaining).

❯ mypy --strict --warn-unreachable bug.py 
bug.py:9: error: Statement is unreachable  [unreachable]
Found 1 error in 1 file (checked 1 source file)
</code></pre>
<p>The issue here is that <code>pytest.fail()</code> is typed to return <code>typing.NoReturn</code> as it always raises.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @charliermarsh on 2023-02-06 15:34</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-02-06 15:34</div>
            <div class="timeline-body"><p>We could consider treating <code>pytest.fail</code> equivalently to raising an exception, which I think would avoid <code>RET503</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ngnpope">@ngnpope</a> on 2023-02-06 16:34</div>
            <div class="timeline-body"><p>Also <code>pytest.exit()</code>, <code>pytest.skip()</code>, and <code>pytest.xfail()</code> in addition to <code>pytest.fail()</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-02-06 16:36</div>
            <div class="timeline-body"><p>I have to look back at the code, but I think it's reasonably well-setup to do that...</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ngnpope">@ngnpope</a> on 2023-02-09 21:37</div>
            <div class="timeline-body"><p>Came across another case of this: <a href="https://github.com/typeddjango/djangorestframework-stubs/blob/bf9d3837eaf0b1e2928f28bad48c1f617813376b/rest_framework-stubs/fields.pyi#L121"><code>Field.fail()</code></a> in Django REST Framework.</p>
<p>This one is probably a bit harder though as it'd be called using <code>self.fail()</code> when overriding one of the methods in a subclass... Without typing support to identify <code>typing.NoReturn</code>, it's a bit tricky.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/2701.html">astral-sh/ruff#2701</a> on 2023-02-10 01:31</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-02-10 19:32</div>
            <div class="timeline-body"><p>Much improved by #2701 and friends.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2023-02-10 19:32</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:34:49 UTC
    </footer>
</body>
</html>
