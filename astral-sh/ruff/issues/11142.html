<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Feature request: make `typing_modules` configurable - astral-sh/ruff #11142</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Feature request: make <code>typing_modules</code> configurable</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/issues/11142">#11142</a>
        opened by <a href="https://github.com/bersbersbers">@bersbersbers</a>
        on 2024-04-25 08:07
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/bersbersbers">@bersbersbers</a></div>
            <div class="timeline-body"><p>The <a href="https://github.com/agronholm/typeguard"><code>typeguard</code> package</a> enables run-time type checks. One of the drawbacks of run-time  type checks is that type annotations behind <code>if typing.TYPE_CHECKING</code> are not visible (https://typeguard.readthedocs.io/en/stable/userguide.html#notes-on-forward-reference-handling; compare also <a href="https://github.com/agronholm/typeguard/issues/456">agronholm/typeguard#456</a>).</p>
<p>So this passes in <code>python bug.py</code> while it shouldn&#x27;t (ideally):</p>
<p><code>bug.py</code></p>
<pre><code>from typing import TYPE_CHECKING

from typeguard import typechecked

if TYPE_CHECKING:
    A = int

@typechecked
def bug() -&gt; None:
    a: A = 1.5
    print(a)

bug()
</code></pre>
<p>One workaround that I am investigating is to use a project-local <code>typing_</code> module from which I import my own <code>TYPE_CHECKING</code>, like this:</p>
<p><code>typing_.py</code></p>
<pre><code>from typing import TYPE_CHECKING as _TYPE_CHECKING

def enable_runtime_typing_checks() -&gt; bool:
    return True  # more complicated, obviously

TYPE_CHECKING = _TYPE_CHECKING or enable_runtime_typing_checks()
</code></pre>
<p><code>workaround.py</code></p>
<pre><code>from typeguard import typechecked

from typing_ import TYPE_CHECKING

if TYPE_CHECKING:
    A = int

@typechecked
def bug() -&gt; None:
    a: A = 1.5
    print(a)

bug()
</code></pre>
<p>Then, <code>python workaround.py</code> fails as expected:</p>
<pre><code>Traceback (most recent call last):
  File &quot;C:\Code\project\workaround.py&quot;, line 15, in &lt;module&gt;
    bug()
  File &quot;C:\Code\project\workaround.py&quot;, line 11, in bug
    a: A = 1.5
  File &quot;c:\Code\project\.venv\Lib\site-packages\typeguard\_functions.py&quot;, line 251, in check_variable_assignment
    check_type_internal(value, annotation, memo)
  File &quot;c:\Code\project\.venv\Lib\site-packages\typeguard\_checkers.py&quot;, line 784, in check_type_internal
    raise TypeCheckError(f&quot;is not an instance of {qualified_name(origin_type)}&quot;)
typeguard.TypeCheckError: value assigned to a (float) is not an instance of int
</code></pre>
<p>but <code>A</code> is not used at runtime. Nice!</p>
<p>(Obviously, my real <code>A</code> is more complicated than that, and my example above is too simplistic as it fails on letting <code>enable_runtime_typing_checks</code> return <code>False</code> - anyway, I guess this is enough to make the following main point.)</p>
<p>When I apply this concept more generally, though:</p>
<p><code>code.py</code></p>
<pre><code>from typing_ import TYPE_CHECKING

if TYPE_CHECKING:
    from pathlib import Path

    from typing_ import A

def bug() -&gt; None:
    a: A = 1.5
    print(a)
    p: Path

bug()
</code></pre>
<p><code>ruff check --isolated --select=TCH003 code.py</code></p>
<p>gives me</p>
<pre><code>code.py:4:25: TCH003 Move standard library import `pathlib.Path` into a type-checking block
</code></pre>
<p>So, long story short: can I make <code>ruff</code> understand my own <code>typing_.TYPE_CHECKING</code> as a type-checking block, similar to <code>typing.TYPE_CHECKING</code> and <code>typing_extensions.TYPE_CHECKING</code> (compare <a href="https://github.com/astral-sh/ruff/pull/8429">astral-sh/ruff#8429</a>)?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-04-25 08:20</div>
            <div class="timeline-body"><p>Hi, thanks for the issue! We already have a <code>typing-modules</code> configuration option: https://docs.astral.sh/ruff/settings/#lint_typing-modules. Does that do what you&#x27;re asking for here?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">question</span> added by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-04-25 08:24</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">configuration</span> added by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-04-25 08:24</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/bersbersbers">@bersbersbers</a> on 2024-04-25 08:29</div>
            <div class="timeline-body"><p>@AlexWaygood absolutely, thank you! I feel somewhat embarrassed since I remember asking a similar question before, but could not find it in my emails or otherwise (I now know it&#x27;s <a href="https://github.com/astral-sh/ruff/issues/5400">astral-sh/ruff#5400</a>). I also searched the repository for <code>typing_modules</code> and did not find much, and I checked <code>ruff check . --show-settings</code> and could not find it there (although I clearly see it now).</p>
<p>I think the main reason why I went looking is because I checked https://docs.astral.sh/ruff/rules/typing-only-standard-library-import/ first, and the rule did not mention the configuration option. Maybe it should be added there (any in other <code>TCH</code> rules) to make it more discoverable.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-04-25 15:23</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 18:48:52 UTC
    </footer>
</body>
</html>
