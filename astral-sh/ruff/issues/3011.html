<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>F821 false positive for .pyi - astral-sh/ruff #3011</title>
    <link rel="stylesheet" href="../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../index.html">Back to index</a>
    </div>

    <h1>F821 false positive for .pyi</h1>

    <div class="meta">
        <span class="state state-closed">Closed</span>
        <a href="https://github.com/astral-sh/ruff/issues/3011">#3011</a>
        opened by <a href="https://github.com/JonathanPlasse">@JonathanPlasse</a>
        on 2023-02-18 15:43
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/JonathanPlasse">@JonathanPlasse</a> on 2023-02-18 15:43</div>
            <div class="timeline-body"><pre><code class="language-python">class Distribution(IMetadataProvider): ...
class IMetadataProvider: ...
</code></pre>
<p><code>ruff</code> detects the <code>F821</code> while <code>flake8</code> with <code>flake8-pyi</code> does not (<code>flake8-pyi</code> must be installed otherwise it will also detect an error).</p>
<p><a href="https://play.ruff.rs/#N4KABGBECGA2sHsDuBTAJgWgMYIHYDMBXAZ2gCNYVjIAuMAbQF0AacKMwgS1gBdPdqdJqwiQ0hALYSAnhgBu0AE6dylDIoDmAD1pQAegAoA+gGoAPsZP1oGAF4BBDAC0ADBgCcRxgCprdx64ejCYA-ACUYQAkkCJQKFo8KLiYnBq4CIoousJskPGJyRjEKJRYPNksufkoirhwFbGQqemZDbmw-CgYlLgaPAAWugAcQ43FpeVCbKIAojHTUABikGyVojxKGig88jXEnHi6kAAO0gDMAIwu86L4sNAA1ihDGNC46Rt8eIJgoBCiMlOGH4nB2mR4hFqunwcGKsVExEIx2OmWIxAw4iksk2PxhsDhC0giORqPR6VwXXBkNw-A00NhKHhUDgiCQRQ2ilemleuGk9PxjMJzQyXSI8FkhFwPGkx3Q-OKbAAvo07o9nhgyG80KDdH9-pB+ko0Dg0OgMDwJMcMZxMmUMnypv99QB6C3HG5OqDOhSKV2Wj1OyDO01yZ3EfoSFZOtb6rD9FBYB7mmVm+JYFDHL64eUoJUq+5PF4cDRkFBKXWE6qFThSQgbChdLAsn5MPO5VWFjVcXj8H560Qcbh8ATAtIijrESYMRht24F9U1RQSYh0uj9qASaBadnKXrdJJ9QZ0FyzqAd9UAR0ICESfaFuA6FIwV5vVCOaAQhAbAY3hB7j66F9b3fT9vyZMQECwSddw0Z9r2AugIK-SgfxgOQEE4TAqCbWVdB4RRCFzCBlXbecXnGfAK0DYVMgwOoJDfR1PUgIxNyeH9RCMaBiG1MoOKgIxMmOe5034lj8E4Eo0GoJlOIkqSjFNGE-x4agFhnYj8zVF4+DQWQa2ODJVKo-VNVwdQSmgPg5C6AyjJ+E4lCSYzwLMilMGgY5OF1RVT0gc8dJTbB40TWkTIRfDOD4ug8QJQN4hQS0dgkBBxEoFsFnWGUwvUvyAuBS0OiwUEd2wPAmyndcYHgZAMAkFTuE6PCCKIsASLnbSCsMxQdhwXAbKlA4BHC5kOm4xjfkyqBji1bijmONAxNOJRFGQeboCWxAeFgaQADp4hRKgHOOHRZKgYpyAybNEOIYazsgApiAyO41sQnhKPu3BJFOI5cHde7Nx4YSbw6MgjkKsTAeB7bODIXbTmh+beCWhB7kUY7YCWt4Snm7N7rgDYbSOAmxP6VGEDkSSkAc-o5Cjf5fM00jOtOW8dknaQULXQkJISSEuhmzIpXjYofnwwjwMF6AGMi2wunoqhk1wt6kRQyWlGl7ZlDl+Q4EI9FpWVqAJ3KdXFE12WugUWB9fUWrDayFXhKycDzc4UWLKvG0ukBuMMHwDJsimyAACFxpmLR00zIaxIjqOszEgA1PWUBmRRVsUMSAHkAGU04zsSAEks-zwP7pmfqbTwBipVLzP7qexNtn29PA-U13oHdxWq0wTIvdo33+n9wOhBjAElCTQXnJFibxda9qzzIjBJRIM1NkkZy72osdaJ9FReLozXcQZPz3aMkb-IydMMCQc2rTgFRRZzcCA8Ua-9l6NQAOfwkP40L-OgYDTDbfY3w2iBhwBIMggDuJdXsj-QMxBhIlTwOaN2j5YKQM3M1CWhIMimk5GQWQDscGCkDK-d+Rkb6gn6PwIoCYszHwFC-K+XQeAIHNAgd0o9wIPHSEgcyEl0Y7EFtKcB+o+HIHMgMG0mBREOmnLw-h5lEBNlgMPWABDxGiHyObdks1FCYFBubRQCiciBkyPcaytlLT2QwPgmoRwiA9RFjsdh2BECi1NoSPuXBMgpFsT1FsY8oBYHuGiCa5jYzfA2FKYJ4E96qEiSEyA6RuidHRKWV+jtFGEgAuiaA+BEicjskE3QGALjgXyRqbYqAkhKwmi4Fhb8zTFClokCofkJBYCbKWC+m5tyQOdloUECirh+VlMcF49Ewrc23i0eWR8g6enOtsAAqv9YOiQlAABEpFiWKDwDZABhcJMktllkUHsgRpzuLnJWUSdZxwACyqU-wuwubsqRry0ofIedxaQuAsA5yeWJAFQKAAqlzrl42DocjZULJw7Kshte6MJuD8zjhmBO91EC9GeUdaAWxIZbh2ZwfAlF26EjCXcmWZNMCmhwObdh6NlnMRpWiOlqV6YQBSZOKyUUuUMoTBkKyGQMoPP5XwLAQqeVgA0m1RopwTRUGlFzSa8yRT2JsooPFsENjECTFgzeOYJnSA-FBNVOTgALxOJzfglVCQslqpuDQUVdY2zYSmCVzFoJiSIcBKlgYBkanNkCkWugLgACZwIhqpLUH4AA2WNW4uQaB+AAVhTduKViUTV0AzSeJmohThIg0ObU0F8ngZnUJKPgDElazLALFeeIBFSRA7Ry4gYAyXQVhnWIaBhC4Eo2GgFFAAFValMCFhDoLtedIAu1gGHdsaAY6NiTopphGoc6F1AA">Link to the playground</a></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ngnpope">@ngnpope</a> on 2023-02-18 18:10</div>
            <div class="timeline-body"><p>Surely this is correct though? At the time of declaration of <code>Distribution</code> it is necessary for <code>IMetadataProvider</code> to have been already declared.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/JonathanPlasse">@JonathanPlasse</a> on 2023-02-18 18:12</div>
            <div class="timeline-body"><p>No, it is allowed in stub files, this is taken from <code>typeshed</code>. Stub files are only read by linters never executed.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ngnpope">@ngnpope</a> on 2023-02-18 18:16</div>
            <div class="timeline-body"><p>Ok. Fair enough, I know declarations in stub files <em>can</em> be out of order. I guess I'm wondering why the declarations cannot just be reordered?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/JonathanPlasse">@JonathanPlasse</a> on 2023-02-18 18:22</div>
            <div class="timeline-body"><p>You are right even if it is allowed does not mean it should be done.
Should it be fixed?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/JonathanPlasse">@JonathanPlasse</a> on 2023-02-18 18:23</div>
            <div class="timeline-body"><p>I vote fixing it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-02-19 13:47</div>
            <div class="timeline-body"><p>Can you look into how <code>flake8-pyi</code> suppresses these? What mechanism is it using? I'm surprised.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">question</span> added by @charliermarsh on 2023-02-19 13:47</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/JonathanPlasse">@JonathanPlasse</a> on 2023-02-19 15:24</div>
            <div class="timeline-body"><p>This is done <a href="https://github.com/PyCQA/flake8-pyi/blob/main/pyi.py#L256-L277">here</a>.
When you run <code>flake8</code> with <code>flake8-pyi</code> installed with <code>--verbose</code> you can see this</p>
<pre><code class="language-console">‚ùØ flake8 stubs/setuptools/pkg_resources/__init__.pyi --verbose
flake8.checker            MainProcess     91 INFO     Making checkers
flake8.bugbear            MainProcess    107 INFO     Optional warning B950 not present in selected warnings: None. Not firing it at all.
flake8.pyi                MainProcess    119 INFO     Replacing FlakesChecker with PyiAwareFlakesChecker while checking 'stubs/setuptools/pkg_resources/__init__.pyi'
flake8.main.application   MainProcess    194 INFO     Finished running
flake8.main.application   MainProcess    194 INFO     Reporting errors
flake8.main.application   MainProcess    195 INFO     Found a total of 209 violations and reported 0
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-02-19 15:28</div>
            <div class="timeline-body"><p>Woah that's wild!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-02-19 15:29</div>
            <div class="timeline-body"><p>Yeah, we should probably just change the behavior of <code>ast.rs</code> on <code>pyi</code> files to match whatever they do there then.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/3909.html">astral-sh/ruff#3909</a> on 2023-04-07 23:36</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../Toufool/AutoSplit/pulls/207.html">Toufool/AutoSplit#207</a> on 2023-04-08 00:24</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">question</span> removed by @charliermarsh on 2023-05-08 22:54</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">core</span> added by @charliermarsh on 2023-05-08 22:54</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/7136.html">astral-sh/ruff#7136</a> on 2023-09-04 21:41</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/GabDug">@GabDug</a> on 2023-09-17 16:09</div>
            <div class="timeline-body"><p>Hey!</p>
<p>Are there any plans for this issue, now that flake8-pyi has been fully integrated?</p>
<p>Thanks and have a great day!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../python/typeshed/pulls/10909.html">python/typeshed#10909</a> on 2023-10-18 20:49</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../python/typeshed/pulls/11496.html">python/typeshed#11496</a> on 2024-02-29 04:30</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @AlexWaygood by @AlexWaygood on 2024-03-07 15:07</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-03-12 10:36</div>
            <div class="timeline-body"><p>In  #10341, I fixed the following F821 false positive on <code>.pyi</code> files:</p>
<pre><code class="language-py">x: int
y = x  # F821 previously incorrectly emitted here in a `.pyi` file
</code></pre>
<p>But Ruff still emits an error on the original snippet in this issue if it's linting a <code>.pyi</code> file:</p>
<pre><code class="language-py">class Distribution(IMetadataProvider): ...  # F821 still emitted here currently due to the forward reference
class IMetadataProvider: ...
</code></pre>
<p>However, with the latest version of flake8-monkeypatched-by-flake8-pyi, flake8 also emits an F821 error on that snippet. This is due to changes we made in flake8-pyi in https://github.com/PyCQA/flake8-pyi/pull/364. The motivation for the flake8-pyi changes were:</p>
<ul>
<li>We wanted to reduce the amount of monkeypatching we were doing to a core minimum.</li>
<li>We concluded that, although this kind of forward reference is <em>legal</em> in a stub file, it is never <em>necessary</em> when it comes to base classes (and other similar situations), and should probably be considered bad style -- so forbidding it was probably a good thing anyway.</li>
</ul>
<p>I'm not sure that ruff should necessarily make the same decisions that flake8-pyi made, however:</p>
<ul>
<li>We don't have the same concerns about keeping monkeypatching to a minimum, since we're not doing any monkeypatching at all</li>
<li>F821 is a rule that's concerned with correctness, and a forward reference like this isn't a <em>correctness</em> issue in a stub -- unlike in a <code>.py</code> file, it's perfectly legal; it's just bad style. So maybe we should avoid emitting F821 here, and emit a diagnostic with a different error code instead, to make it clear that we're banning it out of stylistic concerns rather than correctness concerns?</li>
</ul>
<p>Curious for @charliermarsh's opinion here!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-03-12 18:54</div>
            <div class="timeline-body"><p>Thanks for the clear write-up. I think my preference would be...</p>
<ol>
<li>Not emitting anything.</li>
<li>Emitting a new, dedicated rule.</li>
<li>Emitting F821 (which feels incorrect, as you point out above).</li>
</ol>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-03-12 18:59</div>
            <div class="timeline-body"><p>I'd definitely prefer it if we emitted <em>something</em> on these constructs in a stub file -- type checkers don't flag them (since they're legal in <code>.pyi</code> files), and it's honestly pretty confusing if you come across a class in a stub file that inherits from a class that hasn't been defined yet üòÑ</p>
<p>So that implies (2). I'll start off by making a PR that stops ruff from emitting F821 on this kind of construct, and then look at implementing a new rule for this.</p>
<p>Should the new rule go in the RUF ruleset?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-03-12 19:26</div>
            <div class="timeline-body"><p>Sounds good. Yeah, unless we want to add it to <code>PYI</code> and coordinate with <code>flake8-pyi</code> to reserve that code.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">rule</span> added by @dhruvmanila on 2024-03-13 07:56</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">core</span> removed by @dhruvmanila on 2024-03-13 07:56</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/10779.html">astral-sh/ruff#10779</a> on 2024-04-04 20:43</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/10788.html">astral-sh/ruff#10788</a> on 2024-04-05 11:11</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @AlexWaygood on 2024-04-07 00:16</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../python/typeshed/pulls/11771.html">python/typeshed#11771</a> on 2024-04-16 16:33</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/15677.html">astral-sh/ruff#15677</a> on 2025-01-22 22:27</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:28:08 UTC
    </footer>
</body>
</html>
