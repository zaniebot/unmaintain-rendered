<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ruff github format uses absolute paths which break annotation placement - astral-sh/ruff #17433</title>
    <link rel="stylesheet" href="../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../index.html">Back to index</a>
    </div>

    <h1>Ruff github format uses absolute paths which break annotation placement</h1>

    <div class="meta">
        <span class="state state-open">Open</span>
        <a href="https://github.com/astral-sh/ruff/issues/17433">#17433</a>
        opened by <a href="https://github.com/sochotnicky">@sochotnicky</a>
        on 2025-04-16 19:07
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/sochotnicky">@sochotnicky</a> on 2025-04-16 19:07</div>
            <div class="timeline-body"><h3>Summary</h3>
<p>I'm running ruff in a Github Enterprise environment and can't seem to force github annotation output no matter what I do.</p>
<p>Slightly redacted snippet of logs:</p>
<pre><code>...
2025-04-16T17:22:40.1751001Z [36;1mvenv/bin/ruff check --output-format=github .[0m
2025-04-16T17:22:40.1768217Z shell: /usr/bin/bash -e {0}
2025-04-16T17:22:40.1768619Z env:
2025-04-16T17:22:40.1768918Z   RUFF_OUTPUT_FORMAT: github
2025-04-16T17:22:40.1769321Z   pythonioencoding: utf-8
2025-04-16T17:22:40.1770211Z   pythonLocation: /opt/github-actions-runner2/_work/_tool/Python/3.12.8/x64
2025-04-16T17:22:40.1771299Z   PKG_CONFIG_PATH: /opt/github-actions-runner2/_work/_tool/Python/3.12.8/x64/lib/pkgconfig
2025-04-16T17:22:40.1772368Z   Python_ROOT_DIR: /opt/github-actions-runner2/_work/_tool/Python/3.12.8/x64
2025-04-16T17:22:40.1773358Z   Python2_ROOT_DIR: /opt/github-actions-runner2/_work/_tool/Python/3.12.8/x64
2025-04-16T17:22:40.1774531Z   Python3_ROOT_DIR: /opt/github-actions-runner2/_work/_tool/Python/3.12.8/x64
2025-04-16T17:22:40.1775829Z   LD_LIBRARY_PATH: /opt/github-actions-runner2/_work/_tool/Python/3.12.8/x64/lib:
2025-04-16T17:22:40.1776760Z ##[endgroup]
2025-04-16T17:22:40.2024874Z ##[error]canary.py:15:13: PLW2901 Outer `for` loop variable `i` overwritten by inner `for` loop target
2025-04-16T17:22:40.2036060Z ##[error]canary.py:15:13: B007 Loop control variable `i` not used within loop body
2025-04-16T17:22:40.2039994Z ##[error]Process completed with exit code 1.
2025-04-16T17:22:40.2142559Z Post job cleanup.
...
</code></pre>
<p>As can be seen above - ruff is run with <code>--output-format=github</code> (with env var as a bonus). But it still outputs concise output. Adding the output-format to <code>pyproject.toml</code> has no impact either.</p>
<p>I can not reproduce this outside a GH actions run. Even on the same machine setting as much of the environment to the same state.</p>
<p>I've tried downgrading and can reproduce all the way to 0.1.0 (haven't tried further).</p>
<p>I'm happy to dig through the code but I am out of ideas. Neither of the following looks suspicious to me</p>
<ul>
<li>https://github.com/astral-sh/ruff/tree/1a79722ee0fb160f8929612508d5ee88b7838d09/crates/ruff_linter/src/message/github.rs</li>
<li>https://github.com/astral-sh/ruff/tree/1a79722ee0fb160f8929612508d5ee88b7838d09/crates/ruff/src/printer.rs</li>
</ul>
<p>For example using <code>--output-format=json-lines</code> works as expected though</p>
<h3>Version</h3>
<p>0.11.5</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sochotnicky">@sochotnicky</a> on 2025-04-16 20:46</div>
            <div class="timeline-body"><p>I'm working around with something like this:
<code>venv/bin/ruff check -v --output-format=json-lines . | sed &quot;s:$(pwd)/::&quot; | jq -rs '.[] | &quot;::error title=Ruff (\(.code)),file=\(.filename),line=\(.location.row),col=\(.location.column),endLine=\(.end_location.row),endColumn=\(.end_location.column)::\(.message) -- \(.url)&quot;'</code></p>
<p>It works quite well</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sochotnicky">@sochotnicky</a> on 2025-04-16 21:03</div>
            <div class="timeline-body"><p>Actually I think I found the problem - there's no <code>relativize_path</code> called on annotation. Will submit a PR</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/17435.html">astral-sh/ruff#17435</a> on 2025-04-16 21:10</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @ntBre on 2025-04-16 21:23</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "Ruff ignores --output-format=github in some cases" to "Ruff github format uses absolute paths which break annotation placement" by @sochotnicky on 2025-04-17 06:05</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../randombit/botan/pulls/5090.html">randombit/botan#5090</a> on 2025-09-03 19:49</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:28:15 UTC
    </footer>
</body>
</html>
