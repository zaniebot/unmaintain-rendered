<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>F821 false positive when deleting inner function after call inside of method - astral-sh/ruff #9349</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>F821 false positive when deleting inner function after call inside of method</h1>

    <div class="meta">
        <span class="state state-open">Open</span>
        <a href="https://github.com/astral-sh/ruff/issues/9349">#9349</a>
        opened by <a href="https://github.com/Skylion007">@Skylion007</a>
        on 2024-01-01 17:21
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/Skylion007">@Skylion007</a> on 2024-01-01 17:21</div>
            <div class="timeline-body"><!--
Thank you for taking the time to report an issue! We're glad to have you involved with Ruff.

If you're filing a bug report, please consider including the following information:

* A minimal code snippet that reproduces the bug.
* The command you invoked (e.g., `ruff /path/to/file.py --fix`), ideally including the `--isolated` flag.
* The current Ruff settings (any relevant sections from your `pyproject.toml`).
* The current Ruff version (`ruff --version`).
-->

<p>I recently enabled flake rule F821 on <a href="https://github.com/pytorch/pytorch/pull/116579">PyTorch</a>, but ran into a false positive: https://github.com/pytorch/pytorch/blob/bd10fea79a780b9ba7430c3434849fc7991f6db3/torch/nn/modules/module.py#L2127 .</p>
<p>It was a bit of a difficult edge case, but I recreated a minimal repro here:</p>
<pre><code class="language-python">class Dog:
    def f(self, a):
        c = a
        def load(b):
           b+=1

           if b &lt; c+10:
               return load(b)
           return b


        d = load(a)
        del load
        return d
z = Dog().f(2000)
print(z)
assert z == 2010
</code></pre>
<p>This code is rather unorthodox, but valid. The load function is in scope before it's deleted and therefore the call to the inner recursive load function is defined during the first load call. This code fails the F821 rule even though the code is perfectly valid Python, so the symbols are not being parsed correctly.</p>
<p>Running <code>ruff --select F821 test_f821.py</code> on 0.1.9</p>
<p>outputs</p>
<pre><code>test_f821.py:9:23: F821 Undefined name `load`
</code></pre>
<p>This in itself is not that severe of a bug, but I am worried that other rules may be affected if it cannot resolve recursive functions like this.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "F821 false positive when deleting inner function after call." to "F821 false positive when deleting inner function after call inside of method" by @Skylion007 on 2024-01-01 17:24</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @charliermarsh on 2024-01-02 18:07</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/9858.html">astral-sh/ruff#9858</a> on 2024-02-07 06:38</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/14521.html">astral-sh/ruff#14521</a> on 2024-11-23 07:14</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:34:52 UTC
    </footer>
</body>
</html>
