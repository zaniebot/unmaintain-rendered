<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Linting on Jupyter Notebook fails after reordering cells - astral-sh/ruff #12573</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Linting on Jupyter Notebook fails after reordering cells</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/issues/12573">#12573</a>
        opened by <a href="https://github.com/michue-work">@michue-work</a>
        on 2024-07-29 09:32
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/michue-work">@michue-work</a> on 2024-07-29 09:32</div>
            <div class="timeline-body"><!--
Thank you for taking the time to report an issue! We're glad to have you involved with Ruff.

If you're filing a bug report, please consider including the following information:

* A minimal code snippet that reproduces the bug.
* The current Ruff and VS Code settings (any relevant sections from your `pyproject.toml` and `settings.json`).
* The current Ruff and VS Code extension versions (`ruff --version`).
* A description of your environment (e.g., operating system, Python version, etc.).
-->

<p>Hello, today I activated Ruff for Jupyter Notebooks and noticed some strange behavior I didn't see with normal Python files:</p>
<p><em>After reordering the cells of a notebook, the editor window shows false-positives from Ruff linting.</em></p>
<p><strong>MWE</strong>
<code>pyproject.toml</code></p>
<pre><code>[tool.ruff]
extend-include = [
    &quot;*.ipynb&quot;,
]
</code></pre>
<p><code>ruff.ipynb</code> (with --- denoting a new cell)</p>
<pre><code>import random
---
f = random.random()
---
g = random.random()
</code></pre>
<p>After moving the third cell with <code>g = ...</code> to the second position, Ruff reports F401 on <code>import random</code>.</p>
<p><strong>Environment</strong>
Operating System Windows_NT x64 10.0.19045
VS Code 1.91.1 (commit f1e16e1e6214d7c44d078b1f0607b2388f29d729)
Ruff extension v2024.36.0</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-07-29 15:03</div>
            <div class="timeline-body"><p>Hey, thanks for the issue. Can you expand on how you're reordering the cells? I'm unable to do so just by dragging it around:</p>
<p>https://github.com/user-attachments/assets/cda10601-2428-449e-8f2f-b257d8d01679</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/michue-work">@michue-work</a> on 2024-07-29 16:04</div>
            <div class="timeline-body"><p>Hey Dhruv,<br />
I did basically the same as you. You can see it in the screen recording:</p>
<p><a href="https://github.com/user-attachments/assets/0108846a-2bc7-4b05-b95d-b38fd5c6e0e9">Video 7-29 at 18.00.webm</a></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/michue-work">@michue-work</a> on 2024-07-29 16:08</div>
            <div class="timeline-body"><p>I also deactivated all VS Code extensions except for Python, Python Debugger and Ruff itself - still the same behavior.</p>
<p>But as a remark, the behavior is a little elusive - it does not show up consistently. And usually closing and reopening the file resolves the issue, but sometimes.<br />
I am sorry, that can't pin it down more precisely ...</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-07-30 02:47</div>
            <div class="timeline-body"><p>Thanks for providing the video.</p>
<blockquote>
<p>I also deactivated all VS Code extensions except for Python, Python Debugger and Ruff itself - still the same behavior.</p>
</blockquote>
<p>I can try doing this and see if that reproduces the issue.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-07-30 02:52</div>
            <div class="timeline-body"><p>Huh, I can reproduce it now.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-07-30 02:59</div>
            <div class="timeline-body"><p>Never mind, I can reproduce it even if all the extensions are enabled.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @dhruvmanila on 2024-07-30 02:59</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-07-30 03:00</div>
            <div class="timeline-body"><p>I suspect that there's some logic error in the <code>notebookDocument/didChange</code> request handling.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/michue-work">@michue-work</a> on 2024-07-30 07:10</div>
            <div class="timeline-body"><p>I'm quite happy, that you were able to reproduce this behavior!<br />
If I can help in narrowing the problem further down, please let me know.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">server</span> added by @dhruvmanila on 2024-07-30 08:25</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @dhruvmanila by @dhruvmanila on 2024-07-30 08:25</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-07-30 08:50</div>
            <div class="timeline-body"><blockquote>
<p>If I can help in narrowing the problem further down, please let me know.</p>
</blockquote>
<p>Thanks but I've found out the root cause of this bug.</p>
<p>The reason this is occurring is because we model <code>NotebookCell</code> differently than the LSP spec internally but the change request is handled as per the spec. This means there's a mismatch in the expectations on how certain changes are requested to the server.</p>
<p>The difference is that we store the <code>TextDocument</code> <em>inside</em> the <code>NotebookCell</code> itself while it should be stored elsewhere and <code>NotebookCell</code> would just act as a pointer to the text document corresponding the cell.</p>
<p>So, what happens in this case where the cells are moved but the content remains the same. VS Code sends this request as just moving the URIs and doesn't provide any content.</p>
<pre><code class="language-json">{
    &quot;notebookDocument&quot;: {
        &quot;version&quot;: 1,
        &quot;uri&quot;: &quot;file:///Users/dhruv/playground/ruff/notebooks/issue.ipynb&quot;
    },
    &quot;change&quot;: {
        &quot;cells&quot;: {
            &quot;structure&quot;: {
                &quot;array&quot;: {
                    &quot;start&quot;: 1,
                    &quot;deleteCount&quot;: 2,
                    &quot;cells&quot;: [
                        {
                            &quot;kind&quot;: 2,
                            &quot;document&quot;: &quot;vscode-notebook-cell:/Users/dhruv/playground/ruff/notebooks/issue.ipynb#W2sZmlsZQ%3D%3D&quot;,
                            &quot;metadata&quot;: {
                                &quot;metadata&quot;: {}
                            }
                        },
                        {
                            &quot;kind&quot;: 2,
                            &quot;document&quot;: &quot;vscode-notebook-cell:/Users/dhruv/playground/ruff/notebooks/issue.ipynb#W1sZmlsZQ%3D%3D&quot;,
                            &quot;metadata&quot;: {
                                &quot;metadata&quot;: {}
                            }
                        }
                    ]
                },
                &quot;didOpen&quot;: [],
                &quot;didClose&quot;: []
            }
        }
    }
}
</code></pre>
<p>This goes back to https://github.com/astral-sh/ruff/pull/11864#discussion_r1639145836 as this explains why VS Code sends a request to close the text document corresponding to a notebook cell.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/12575.html">astral-sh/ruff#12575</a> on 2024-07-30 09:40</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @dhruvmanila on 2024-07-30 09:51</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/michue-work">@michue-work</a> on 2024-07-30 12:39</div>
            <div class="timeline-body"><p>Thank you for fixing so fast!</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 01:30:13 UTC
    </footer>
</body>
</html>
