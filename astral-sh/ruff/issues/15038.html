<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[red-knot] Add a diagnostic for `raise` statements used with non-exceptions - astral-sh/ruff #15038</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[red-knot] Add a diagnostic for <code>raise</code> statements used with non-exceptions</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/issues/15038">#15038</a>
        opened by <a href="https://github.com/AlexWaygood">@AlexWaygood</a>
        on 2024-12-17 15:29
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-12-17 15:29</div>
            <div class="timeline-body"><p>Red-knot currently doesn't emit a diagnostic on this snippet:</p>
<pre><code class="language-py">raise 42
</code></pre>
<p>But we should, since <code>42</code> is not a valid object to be used in a <code>raise</code> statement:</p>
<pre><code class="language-pycon">&gt;&gt;&gt; raise 42
Traceback (most recent call last):
  File &quot;&lt;python-input-0&gt;&quot;, line 1, in &lt;module&gt;
    raise 42
TypeError: exceptions must derive from BaseException
</code></pre>
<p>The rule is that the object used in a <code>raise</code> statement must have a type that is assignable to the type <code>BaseException | type[BaseException]</code>, since both of the following work:</p>
<pre><code class="language-pycon">&gt;&gt;&gt; raise ValueError
Traceback (most recent call last):
  File &quot;&lt;python-input-1&gt;&quot;, line 1, in &lt;module&gt;
    raise ValueError
ValueError
&gt;&gt;&gt; raise ValueError()
Traceback (most recent call last):
  File &quot;&lt;python-input-2&gt;&quot;, line 1, in &lt;module&gt;
    raise ValueError()
ValueError
</code></pre>
<p>We need to add some extra logic to this branch here: https://github.com/astral-sh/ruff/blob/c9fdb1f5e3a4d0d60b4537741f2c9c19e2426038/crates/red_knot_python_semantic/src/types/infer.rs#L2193-L2201</p>
<p>I think this will probably need to be a new rule added to https://github.com/astral-sh/ruff/blob/main/crates/red_knot_python_semantic/src/types/diagnostic.rs ? I don't think it fits neatly into any other rule. The alternative might be to make the existing <code>INVALID_EXCEPTION_CAUGHT</code> rule broader (and rename it).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">help wanted</span> added by @AlexWaygood on 2024-12-17 15:29</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by @AlexWaygood on 2024-12-17 15:29</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-12-17 15:31</div>
            <div class="timeline-body"><blockquote>
<p>The alternative might be to make the existing INVALID_EXCEPTION_CAUGHT rule broader (and rename it).</p>
</blockquote>
<p>That was also my first reaction. It's kind of the same problem.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-12-17 17:37</div>
            <div class="timeline-body"><blockquote>
<blockquote>
<p>The alternative might be to make the existing INVALID_EXCEPTION_CAUGHT rule broader (and rename it).</p>
</blockquote>
<p>That was also my first reaction. It's kind of the same problem.</p>
</blockquote>
<p>The same genre of problem, for sure. Though there's a subtle difference between the rules for raising exceptions and the rules for catching exceptions:</p>
<ul>
<li>If you're raising an exception, the type must be assignable to <code>BaseException | type[BaseException]</code></li>
<li>but if you're catching an exception the type must be assignable to <code>type[BaseException] | tuple[type[BaseException], ...]</code></li>
</ul>
<p>If we bundle them together into one rule, it might be harder to explain these details in the rule's documentation.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-12-17 17:38</div>
            <div class="timeline-body"><p>I don't have a strong opinion, though. Any suggestions for what we might call the rule if we combined the two into one one rule?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a> on 2024-12-17 20:05</div>
            <div class="timeline-body"><p>Survey:</p>
<ul>
<li><a href="https://pyright-play.net/?pyrightVersion=1.1.390&amp;pythonVersion=3.14&amp;strict=true&amp;enableExperimentalFeatures=true&amp;code=C4JwngXAsAUABAuAHAhgZzbApgDwMZZLBwAMECAxHCIQPYjADiWAdliCgDYAqYSWASQwBXLJniJUGWLA4BLNFlKVqdBszYcefQSLGwgA">Pyright</a>: <code>reportGeneralTypeIssues</code></li>
<li><a href="https://mypy-play.net/?mypy=latest&amp;python=3.13&amp;flags=strict&amp;gist=ea92013ec1bbcac8ee093f4ca3ee02da">Mypy</a>: <code>misc</code></li>
<li><a href="https://pyre-check.org/play?input=try%3A%0A%20%20%20%20pass%0Aexcept%200%3A%20%20%23%20misc%0A%20%20%20%20pass%0A%0Araise%200%20%20%23%20misc%0A">Pyre</a>: <code>Invalid except clause [66]</code> and <code>Invalid Exception [48]</code></li>
<li><a href="https://github.com/user-attachments/assets/06940fd3-558c-4dcf-afe8-0eb644c8d12c">Pytype</a>: No errors</li>
<li>Ruff: <a href="https://docs.astral.sh/ruff/rules/raise-literal/"><code>raise-literal</code></a> and <a href="https://docs.astral.sh/ruff/rules/except-with-non-exception-classes/"><code>except-with-non-exception-classes</code></a></li>
</ul>
<p>I think <code>INVALID_EXCEPTION</code> is good enough. Each diagnostic can then customize the message.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @AlexWaygood on 2024-12-18 18:31</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 11:36:04 UTC
    </footer>
</body>
</html>
