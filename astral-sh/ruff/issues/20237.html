<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TC006 (runtime-cast-value) shouldn't trigger with `annotations` - astral-sh/ruff #20237</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>TC006 (runtime-cast-value) shouldn&#x27;t trigger with <code>annotations</code></h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/issues/20237">#20237</a>
        opened by <a href="https://github.com/Kilo59">@Kilo59</a>
        on 2025-09-04 14:31
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Kilo59">@Kilo59</a></div>
            <div class="timeline-body">Summary
<p>TC006 forces the use of quotes strings around casts types even when <code>from __future__ import annotations</code> is imported.</p>
<p>The explanation of the rule doesn&#x27;t apply when using a postponed annotations.
https://docs.astral.sh/ruff/rules/runtime-cast-value/</p>
<pre><code># runtime-cast-value (TC006)

...

It&#x27;s often necessary to quote the first argument passed to `cast()`,
as type expressions can involve forward references, or references
to symbols which are only imported in `typing.TYPE_CHECKING` blocks.
This can lead to a visual inconsistency across different `cast()` calls,
where some type expressions are quoted but others are not. By enabling
this rule, you ensure that all type expressions passed to `cast()` are
quoted, enforcing stylistic consistency across all of your `cast()` calls.

In some cases where `cast()` is used in a hot loop, this rule may also
help avoid overhead from repeatedly evaluating complex type expressions at
runtime.
</code></pre>
<blockquote>
<p>[!IMPORTANT]
In addition, by forcing the use of quoted strings instead of postponed annotations we &gt;introduce a very subtle but potentially serious type-checking footgun.</p>
<p>That is if the <code>TYPE_CHECKING</code> import ever changes, the quoted string reference will silently become an <code>Any</code>, and neither <code>ruff</code> nor <code>mypy</code> will be able to catch it.</p>
</blockquote>
<p>Full example of this issue described here üëá</p>
<ul>
<li>https://github.com/astral-sh/ruff/issues/2329#issuecomment-1415930582</li>
</ul>
<p>Note: There may be some configurations of mypy that will catch this (if <code>Any</code> is banned outright for example), but most configurations likely won&#x27;t catch it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntBre">@ntBre</a> on 2025-09-04 14:52</div>
            <div class="timeline-body"><p>I might be missing something, but it looks like the arguments to <code>cast</code> are still evaluated at runtime, even with <code>from __future__ import annotations</code>:</p>
<pre><code>&gt;&gt;&gt; import typing
&gt;&gt;&gt; if typing.TYPE_CHECKING:
...     from collections import Counter
...
&gt;&gt;&gt; typing.cast(Counter, 123)
Traceback (most recent call last):
  File &quot;&lt;python-input-2&gt;&quot;, line 1, in &lt;module&gt;
    typing.cast(Counter, 123)
                ^^^^^^^
NameError: name &#x27;Counter&#x27; is not defined
&gt;&gt;&gt; from __future__ import annotations
&gt;&gt;&gt; typing.cast(Counter, 123)
Traceback (most recent call last):
  File &quot;&lt;python-input-4&gt;&quot;, line 1, in &lt;module&gt;
    typing.cast(Counter, 123)
                ^^^^^^^
NameError: name &#x27;Counter&#x27; is not defined
&gt;&gt;&gt; from collections import Counter
&gt;&gt;&gt; typing.cast(Counter, 123)
123
</code></pre>
<p>so I don&#x27;t think the quotes should be suppressed, as would be the case in other annotation contexts.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">question</span> added by <a href="https://github.com/ntBre">@ntBre</a> on 2025-09-04 14:52</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Kilo59">@Kilo59</a> on 2025-09-04 15:01</div>
            <div class="timeline-body"><p>@ntBre Thanks for the quick response.
Your example doesn&#x27;t match the scenario I&#x27;m describing.
It should be..</p>
<pre><code>&gt;&gt;&gt; from __future__ import annotations
&gt;&gt;&gt; import typing
&gt;&gt;&gt; if typing.TYPE_CHECKING:
...     from collections import Counter
...
&gt;&gt;&gt; typing.cast(Counter, 123)
123
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntBre">@ntBre</a> on 2025-09-04 15:13</div>
            <div class="timeline-body"><p>Did you try running that code? I&#x27;m still getting an error in a fresh Python REPL:</p>
<pre><code>Python 3.13.5 (main, Jun 21 2025, 09:35:00) [GCC 15.1.1 20250425] on linux
Type &quot;help&quot;, &quot;copyright&quot;, &quot;credits&quot; or &quot;license&quot; for more information.
&gt;&gt;&gt; from __future__ import annotations
&gt;&gt;&gt; import typing
&gt;&gt;&gt; if typing.TYPE_CHECKING:
...     from collections import Counter
...
&gt;&gt;&gt; typing.cast(Counter, 123)
Traceback (most recent call last):
  File &quot;&lt;python-input-3&gt;&quot;, line 1, in &lt;module&gt;
    typing.cast(Counter, 123)
                ^^^^^^^
NameError: name &#x27;Counter&#x27; is not defined
</code></pre>
<p>and also when running this script:</p>
<pre><code>from __future__ import annotations
import typing

if typing.TYPE_CHECKING:
    from collections import Counter

typing.cast(Counter, 123)
</code></pre>
<pre><code>&gt; python try.py
Traceback (most recent call last):
  File &quot;/tmp/tmp.4i5jouRHcG/try.py&quot;, line 7, in &lt;module&gt;
    typing.cast(Counter, 123)
                ^^^^^^^
NameError: name &#x27;Counter&#x27; is not defined
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Kilo59">@Kilo59</a> on 2025-09-04 15:35</div>
            <div class="timeline-body"><p>@ntBre You&#x27;re right. That example does error for me as well ü§î.</p>
<p>I&#x27;m a bit confused tho, I have other examples of currently running code that don&#x27;t error in the same scenario.
Intuitively it doesn&#x27;t make sense to me; a postponed annotated <code>Counter</code> should be the same as <code>&quot;Counter&quot;</code> at runtime.</p>
<p>Let me try to come up with an MRE that doesn&#x27;t error.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Kilo59">@Kilo59</a> on 2025-09-04 15:43</div>
            <div class="timeline-body"><p>Okay here&#x27;s a working example that still triggers the ruff rule and doesn&#x27;t crash at runtime.</p>
<pre><code>‚ùØ python --version 
Python 3.13.5
</code></pre>
<pre><code>from __future__ import annotations

from typing import Literal, cast, TypeAlias

type MyType = Literal[&quot;foo&quot;, &quot;bar&quot;]

# alternate type
# MyType: TypeAlias = Literal[&quot;foo&quot;, &quot;bar&quot;]


def foo(value: str) -&gt; MyType:
    return cast(MyType, value)


print(foo(&quot;trust me&quot;))
</code></pre>
<p>This works of course because the type is defined at runtime.</p>
<p>Whatever the case, sounds like any exception to the rule can&#x27;t be as simple as checking for a <code>from __future__ import annotations</code> import üòî . The rule is still unnecessary in this limited scenario, but probably not worth creating the special case inside <code>ruff</code>.</p>
<p>My issue is really with <code>cast</code> then, I don&#x27;t understand why it needs to do anything at runtime?? ü§∑
I basically only use <code>cast</code> inside of test code, so I&#x27;m going to just disable the rule (for my tests dir).</p>
<p>@ntBre thanks again.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntBre">@ntBre</a> on 2025-09-04 17:29</div>
            <div class="timeline-body"><p>No problem, I was confused too! The <code>cast</code> docs even say:</p>
<blockquote>
<p>This returns the value unchanged. To the type checker this signals that the return value has the designated type, but <em>at runtime we intentionally don‚Äôt check anything (we want this to be as fast as possible)</em>.</p>
</blockquote>
<p>emphasis mine. But I think the arguments to <code>cast</code> still have to be evaluated, which is separate from <code>cast</code> doing anything with them internally.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-09-16 07:40</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 18:50:24 UTC
    </footer>
</body>
</html>
