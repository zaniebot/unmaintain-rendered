<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>isort Categorized `src` submodule as Known(ThirdParty) (NoMatch) inside `src` - astral-sh/ruff #10989</title>
    <link rel="stylesheet" href="../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../index.html">Back to index</a>
    </div>

    <h1>isort Categorized `src` submodule as Known(ThirdParty) (NoMatch) inside `src`</h1>

    <div class="meta">
        <span class="state state-open">Open</span>
        <a href="https://github.com/astral-sh/ruff/issues/10989">#10989</a>
        opened by <a href="https://github.com/serjflint">@serjflint</a>
        on 2024-04-17 07:12
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/serjflint">@serjflint</a> on 2024-04-17 07:12</div>
            <div class="timeline-body"><!--
Thank you for taking the time to report an issue! We're glad to have you involved with Ruff.

If you're filing a bug report, please consider including the following information:

* List of keywords you searched for before creating this issue. Write them down here so that others can find this issue more easily and help provide feedback.
  e.g. "RUF001", "unused variable", "Jupyter notebook"
* A minimal code snippet that reproduces the bug.
* The command you invoked (e.g., `ruff /path/to/file.py --fix`), ideally including the `--isolated` flag.
* The current Ruff settings (any relevant sections from your `pyproject.toml`).
* The current Ruff version (`ruff --version`).
-->

<p>Hi!</p>
<p>ruff 0.3.4</p>
<p>I am trying to use <code>ruff --select I</code> on our monorepo</p>
<pre><code>.
├── pyproject.toml
└── src
    └── dir
        └── module
            ├── __init__.py
            └── a.py
        └── test_module
            ├── __init__.py
            └── test_a.py
</code></pre>
<p>I have a config</p>
<pre><code class="language-toml">[tool.ruff]
...
src = [&quot;src/*&quot;]

[tool.ruff.lint]
preview = true
select = [&quot;I&quot;]
...
</code></pre>
<p>When I run ruff from beside <code>pyproject.toml</code> everything works as intended</p>
<pre><code class="language-test_a.py">import pytest

from module import a
</code></pre>
<p>But when I run ruff from inside src/dir the test_a.py is sorted in wrong order</p>
<pre><code class="language-test_a.py">from module import a
import pytest
</code></pre>
<pre><code class="language-bash">cd src/dir
ruff check --fix-only --verbose --config /Users/serjflint/monorepo/pyproject.toml test_module/test_a.py
warning: One or more modules are part of multiple import sections, including: `setup`
[2024-04-17][09:58:26][ruff::resolve][DEBUG] Using user-specified configuration file at: /Users/serjflint/monorepo/pyproject.toml
[2024-04-17][09:58:26][ruff::commands::check][DEBUG] Identified files to lint in: 4.061541ms
[2024-04-17][09:58:26][ruff::diagnostics][DEBUG] Checking: /Users/serjflint/monorepo/src/dir/test_module/test_a.py
[2024-04-17][09:58:26][ruff_linter::rules::isort::categorize][DEBUG] Categorized 'pytest' as Known(ThirdParty) (KnownThirdParty)
[2024-04-17][09:58:26][ruff_linter::rules::isort::categorize][DEBUG] Categorized 'module' as Known(ThirdParty) (NoMatch)
[2024-04-17][09:58:26][ruff::commands::check][DEBUG] Checked 1 files in: 33.535708ms
</code></pre>
<p>Seems similar to issue https://github.com/astral-sh/ruff/issues/10266 but the other way around</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/serjflint">@serjflint</a> on 2024-04-17 08:23</div>
            <div class="timeline-body"><p>Probably related to https://github.com/astral-sh/ruff/issues/10927 in some way</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/serjflint">@serjflint</a> on 2024-04-17 08:25</div>
            <div class="timeline-body"><p>As a workaround I added everything from &quot;src/*&quot; to <code>known-first-party</code>. https://github.com/astral-sh/ruff/issues/10926 would have helped here.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">isort</span> added by @AlexWaygood on 2024-04-17 11:04</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/11000.html">astral-sh/ruff#11000</a> on 2024-04-17 13:40</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-04-17 14:45</div>
            <div class="timeline-body"><p>I'll try to reproduce.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-04-17 14:47</div>
            <div class="timeline-body"><p>I'm unable to reproduce:</p>
<pre><code>project/src/dir on  main [$?]
❯ cargo run check . --fix -n --verbose
    Finished dev [unoptimized + debuginfo] target(s) in 0.10s
     Running `/Users/crmarsh/workspace/ruff/target/debug/ruff check . --fix -n --verbose`
[2024-04-17][10:47:26][ruff::resolve][DEBUG] Using configuration file (via parent) at: /Users/crmarsh/workspace/ruff/project/pyproject.toml
[2024-04-17][10:47:26][ruff_workspace::resolver][DEBUG] Included path via `include`: &quot;/Users/crmarsh/workspace/ruff/project/src/dir/module/__init__.py&quot;
[2024-04-17][10:47:26][ruff_workspace::resolver][DEBUG] Included path via `include`: &quot;/Users/crmarsh/workspace/ruff/project/src/dir/module/a.py&quot;
[2024-04-17][10:47:26][ruff_workspace::resolver][DEBUG] Included path via `include`: &quot;/Users/crmarsh/workspace/ruff/project/src/dir/test_module/test_a.py&quot;
[2024-04-17][10:47:26][ruff_workspace::resolver][DEBUG] Included path via `include`: &quot;/Users/crmarsh/workspace/ruff/project/src/dir/test_module/__init__.py&quot;
[2024-04-17][10:47:26][ruff::commands::check][DEBUG] Identified files to lint in: 13.962334ms
[2024-04-17][10:47:26][ruff::diagnostics][DEBUG] Checking: /Users/crmarsh/workspace/ruff/project/src/dir/module/a.py
[2024-04-17][10:47:26][ruff::diagnostics][DEBUG] Checking: /Users/crmarsh/workspace/ruff/project/src/dir/test_module/__init__.py
[2024-04-17][10:47:26][ruff::diagnostics][DEBUG] Checking: /Users/crmarsh/workspace/ruff/project/src/dir/test_module/test_a.py
[2024-04-17][10:47:26][ruff::diagnostics][DEBUG] Checking: /Users/crmarsh/workspace/ruff/project/src/dir/module/__init__.py
[2024-04-17][10:47:26][ruff_linter::rules::isort::categorize][DEBUG] Categorized 'pytest' as Known(ThirdParty) (NoMatch)
[2024-04-17][10:47:26][ruff_linter::rules::isort::categorize][DEBUG] Categorized 'module' as Known(FirstParty) (SourceMatch(&quot;/Users/crmarsh/workspace/ruff/project/src/dir&quot;))
[2024-04-17][10:47:26][ruff::commands::check][DEBUG] Checked 4 files in: 4.112042ms
All checks passed!
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-04-17 14:48</div>
            <div class="timeline-body"><p>The problem is your use of <code>--config</code>. Using <code>--config</code> means we have to use the current working directory as the root for resolving relative paths.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-04-17 14:48</div>
            <div class="timeline-body"><p>Because we can't organically discover a workspace root.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/serjflint">@serjflint</a> on 2024-04-17 14:51</div>
            <div class="timeline-body"><blockquote>
<p>The problem is your use of <code>--config</code>. Using <code>--config</code> means we have to use the current working directory as the root for resolving relative paths.</p>
</blockquote>
<p>Thanks for the investigation. How to pass a working directory as a parameter? Or force to use the directory of the config for path resolution?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-04-17 14:53</div>
            <div class="timeline-body"><p>The original example you provided works because we discover the workspace root by discovering the <code>pyproject.toml</code> on disk in the parent directory. That's the intended setup -- can you not do that?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/serjflint">@serjflint</a> on 2024-04-17 14:56</div>
            <div class="timeline-body"><blockquote>
<p>The original example you provided works because we discover the workspace root by discovering the <code>pyproject.toml</code> on disk in the parent directory. That's the intended setup -- can you not do that?</p>
</blockquote>
<p>Unfortunately I can not. There is a lot of CI with different wrappers and users can call ruff from any place in the repo.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-04-17 18:15</div>
            <div class="timeline-body"><p>If you use configuration on-disk, rather than passing <code>--config</code>, the calls will <em>always</em> yield the same results regardless of the current working directory. It's the most robust way to invoke Ruff.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/serjflint">@serjflint</a> on 2024-04-17 19:18</div>
            <div class="timeline-body"><blockquote>
<p>If you use configuration on-disk, rather than passing <code>--config</code>, the calls will <em>always</em> yield the same results regardless of the current working directory. It's the most robust way to invoke Ruff.</p>
</blockquote>
<p>Not unless someone puts their one config in a submodule.</p>
<p>My use case is to force everyone in the project use the same config as in the CI regardless. And I wish for that config to mean the same everywhere in the project.</p>
<p>I can fallback to an on-disk configuration or write a wrapper to replace cwd, but that would still be a workaround. The same as my current solution with manually passing all submodules.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../astral-sh/ruff-pre-commit/issues/103.html">astral-sh/ruff-pre-commit#103</a> on 2025-03-03 06:28</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:28:12 UTC
    </footer>
</body>
</html>
