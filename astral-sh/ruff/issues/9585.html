<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>pyproject.toml in excluded subdir is not excluded when passed explicitly (=pre-commit) - astral-sh/ruff #9585</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>pyproject.toml in excluded subdir is not excluded when passed explicitly (=pre-commit)</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/ruff/issues/9585">#9585</a>
        opened by <a href="https://github.com/reinout">@reinout</a>
        on 2024-01-19 19:40
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/reinout">@reinout</a> on 2024-01-19 19:40</div>
            <div class="timeline-body"><p>Ruff <code>0.1.13</code></p>
<p>I've excluded a &quot;cookiecutter&quot; directory because those files have <code>{{ project_name }}</code>-like variables in them that aren't valid python or toml. This works fine with ruff itself.
When run from within a pre-commit (ruff-pre-commit, also <code>v0.1.13</code>), filenames are passed explicitly to ruff.</p>
<ul>
<li>Python files in the excluded dir are ignored just fine.</li>
<li>The <code>pyproject.toml</code> in the excluded directory is <em>not</em> excluded, presumably because ruff allows multiple configuration files in various directories.</li>
</ul>
<p>I've worked around it by telling ruff to only use my top-level pyproject.toml by passing <code>--config pyproject.toml</code>. That quieted things down:</p>
<pre><code>- repo: https://github.com/astral-sh/ruff-pre-commit
  rev: v0.1.13
  hooks:
    - id: ruff
      args: [&quot;--fix&quot;, &quot;--config&quot;, &quot;pyproject.toml&quot;]
    - id: ruff-format
      args: [&quot;--config&quot;, &quot;pyproject.toml&quot;]</code></pre>
<p><strong>Expectation:</strong> ruff excludes directories that it is told to exclude, including pyproject.toml files, even when those are &quot;accidentally&quot; passed on the command line (by a pre-commit hook in this case).</p>
<p><strong>To reproduce it</strong>, create a subdir in an existing pyproject.toml-using project:</p>
<pre><code>mkdir bugger
echo &quot;this is a syntax error&quot; &gt; bugger/bugger.py
echo &quot;this is a syntax error&quot; &gt; bugger/pyproject.toml
ruff check
# ^^^ ruff fails on pyproject.toml before it reads bugger.py,
# &quot;TOML parse error&quot;</code></pre>
<p>Ignore the &quot;bugger&quot; directory in your top level <code>pyproject.toml</code>:</p>
<pre><code>[tool.ruff]
exclude = [&quot;bugger&quot;]</code></pre>
<p>Note that ruff-pre-commit automatically uses <code>--force-exclude</code> to
force the excludes to be used even when a file is passed on the
commandline. I'm using that in the examples below, too, of course.</p>
<p>Running ruff itself now works fine, but passing either the .py or the
.toml from the excluded subdir causes ruff to try and read the
<code>pyproject.toml</code> file, resulting in the &quot;TOML parse error&quot;:</p>
<pre><code>$ ruff check  # works fine, because of the exclude
$ ruff check --force-exclude bugger/bugger.py
ruff failed
  Cause: Failed to parse /.../myproject/bugger/pyproject.toml
  Cause: TOML parse error at line 1, column 6
  |
1 | this is a syntax error
  |      ^
expected `.`, `=`
$ ruff check --force-exclude bugger/pyproject.toml
ruff failed  # Same error, of course</code></pre>
<p>If you remove the pyproject.toml file, everything works just fine (the
warning is fine):</p>
<pre><code>$ rm bugger/pyproject.toml
$ ruff check --force-exclude bugger/bugger.py
warning: No Python files found under the given path(s)</code></pre>
<p>If we re-instate the pyproject.toml file in the excluded subdir it
fails again.  But passing <code>--config pyproject.toml</code> prevents ruff from
trying to read the offending .toml file, making it work fine again:</p>
<pre><code>$ echo &quot;this is a syntax error&quot; &gt; bugger/pyproject.toml
$ ruff check --force-exclude bugger/bugger.py
ruff failed
...
$ ruff check --force-exclude --config pyproject.toml bugger/bugger.py    
warning: No Python files found under the given path(s)</code></pre>
<p><strong>Conclusion</strong>: I think ruff should not look for config files in
excluded dirs.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/7959.html">astral-sh/ruff#7959</a> on 2024-01-19 19:44</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @charliermarsh on 2024-01-20 01:02</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/mikeleppane">@mikeleppane</a> on 2024-01-20 11:10</div>
            <div class="timeline-body"><p>Can I take this?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-01-20 17:42</div>
            <div class="timeline-body"><p>I think we may need to do some research (or have some discussion) around the desired behavior here.</p>
<p>Like, I think it's reasonable that if you're in a project that has an exclude for a subdirectory, and that subdirectory has its own configuration file, and you run <code>ruff check subdirectory/some_file.py</code>, that we check that file rather than ignoring it. I believe this was an intentional change we made long ago to not walk past the project root when looking for excludes.</p>
<p>Most of the confusion here, I think, comes from the pre-commit workflow wherein you're passing those excluded files to Ruff directly. It's possible that we should respect parent excludes when you run with <code>--force-exclude</code>, but it'd be a change in semantics.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/reinout">@reinout</a> on 2024-01-20 18:15</div>
            <div class="timeline-body"><p>The confusion indeed comes from pre-commit's passing of excluded files.
Ruff nicely respects parent excludes with <code>--force-exclude</code>, <em>except</em> for a <code>pyproject.toml</code> file. Which confuses me :-)</p>
<p>Is there a usecase for an excluded directory to be partially &quot;un-excluded&quot; by a config file in the excluded directory? I can't really think of one.</p>
<p>In case the current functionality <em>is</em> the desired behaviour, a comment in the ruff pre-commit documentation might be a good idea. OTOH, this issue will probably turn up in search engines, including the <code>--config</code> tip.</p>
<p>In my opinion, it is pretty much a corner case so leaving it be is okay if there's no quick solution.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-01-20 18:22</div>
            <div class="timeline-body"><p>üëç I think what's happening is... We look at the <code>pyproject.toml</code> in the subdirectory, because if it were <em>valid</em> and contained Ruff configuration, then we'd ignore the exclusion from the parent, and instead defer to the subdirectory's configuration to figure out the relevant exclusions. But then we can't parse it, and so the error shows up. It's definitely an edge case... But we should <em>probably</em> silence that error _if the <code>pyproject.toml</code> is excluded by the parent.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/mikeleppane">@mikeleppane</a> on 2024-01-20 18:28</div>
            <div class="timeline-body"><p>I think it would make sense at least to silence that error if that dir is excluded. I cannot figure any usecase to parse it if excluded?ü§î</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/mikeleppane">@mikeleppane</a> on 2024-01-22 17:02</div>
            <div class="timeline-body"><p>@charliermarsh what's the conclusion? Should we some guard around the corner or leave it as it is?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/manoelpqueiroz">@manoelpqueiroz</a> on 2024-05-08 11:52</div>
            <div class="timeline-body"><p>@charliermarsh, is there any update to this particular case? I see that #7959 was closed orienting <a href="https://github.com/astral-sh/ruff/issues/7959#issuecomment-1764751734">for the use of globset rules</a> and this was also suggested <a href="https://github.com/astral-sh/ruff/issues/9381#issuecomment-1877402073">by you</a> in #9381.</p>
<p>Using the solution mentioned in both issues works fine for excluding the whole directory, but what about specific files inside that directory? For instance, this configuration will still parse the subdirectory <code>pyproject.toml</code>, and in my case <code>ruff</code> will fail because said file contains Jinja syntax:</p>
<pre><code>extend-exclude = [&quot;[{][{] cookiecutter.repo_name [}][}]/pyproject.toml&quot;]
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/jpmckinney">@jpmckinney</a> on 2025-03-19 19:56</div>
            <div class="timeline-body"><p>Like @manoelpqueiroz, I am unable to exclude specific pyproject.toml files using extend-exclude. (If I exclude the entire cookiecutter directory, then it does get excluded.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/T4mmi">@T4mmi</a> on 2025-10-22 08:59</div>
            <div class="timeline-body"><p>Hi, did anyone found a workaround ?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/reinout">@reinout</a> on 2025-10-22 10:23</div>
            <div class="timeline-body"><p>@T4mmi: My workaround is two-fold. First, in my pre-commit config I pass <code>--config pyproject.toml</code>, which prevents ruff from trying to read other (excluded) config files anyway:</p>
<pre><code>  - repo: https://github.com/astral-sh/ruff-pre-commit
    # Ruff version.
    rev: v0.12.12
    hooks:
      # Run the linter.
      - id: ruff
        args: [&quot;--fix&quot;, &quot;--config&quot;, &quot;pyproject.toml&quot;]
      # Run the formatter.
      - id: ruff-format
        # The &quot;--config pyproject.toml&quot; here and above prevent ruff
        # from looking at the pyproject.toml in the {{ .... }} dir as
        # a possible config file. Ruff on the commandline ignores it
        # just fine, but when passed explicitly as filename by git it
        # still gets read.
        # See https://github.com/astral-sh/ruff/issues/9585
        args: [&quot;--config&quot;, &quot;pyproject.toml&quot;]</code></pre>
<p>And secondly, I, of course, exclude the entire cookiecutter directory in my pyproject.toml:</p>
<pre><code>[tool.ruff]
exclude = [&quot;*cookiecutter.project_name*&quot;]</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/T4mmi">@T4mmi</a> on 2025-10-22 11:37</div>
            <div class="timeline-body"><p>thanks, I'll dig into the <code>--config</code> flag since i use <code>ruff.toml</code> instead of <code>pyproject.toml</code> ... and I want ruff to look into several stuff inside my template, just want to exclude specific files</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/reinout">@reinout</a> on 2025-10-22 12:04</div>
            <div class="timeline-body"><p>Note: the <code>--config</code> flag is needed in the pre-commit config, not in the <code>ruff.toml</code> (or main <code>pyproject.toml</code> in my case).</p>
<ul>
<li>In your <code>ruff.toml</code> you should exclude the &quot;curly-brace-invested pyproject.toml&quot; in your template.</li>
<li>The <code>--config</code> in the pre-commit config is there to make sure ruff really really really doesn't read the pyproject.toml in your template dir :-)</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/T4mmi">@T4mmi</a> on 2025-10-22 12:09</div>
            <div class="timeline-body"><p>Yeah thanks, i managed to fix my issues:</p>
<ul>
<li>exclude the desired files from the top-level ruff configuration <em>(adding <code>exclude = [ &quot;** cookiecutter.project_name **/tests/test_package.py&quot;, &quot;** cookiecutter.project_name **/src/** cookiecutter.project_slug **/__init__.py&quot;]</code>, beware to put it at the root-level of the toml and not in the lint/format tables ... )</em></li>
<li>tell pre-commit to use ONLY the top-level config with your <code>args: [&quot;--config&quot;, &quot;ruff.toml&quot;]</code> in the <code>.pre-commit-config.yaml</code></li>
</ul>
<p>:tada:</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 01:30:11 UTC
    </footer>
</body>
</html>
