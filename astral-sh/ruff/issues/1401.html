<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>F401 (unused import) false positive - astral-sh/ruff #1401</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>F401 (unused import) false positive</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/issues/1401">#1401</a>
        opened by <a href="https://github.com/jad-haddad">@jad-haddad</a>
        on 2022-12-27 11:45
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/jad-haddad">@jad-haddad</a> on 2022-12-27 11:45</div>
            <div class="timeline-body"><p>Hello, I have an import that is used in typing and is getting removed by ruff (flake8 detects it as unused as well) here is the example:</p>
<pre><code class="language-python">from typing import Optional
import datetime # &lt;--- gets removed by ruff
import pydantic

class SomeClass(pydantic.BaseModel):
    datetime: Optional[datetime.datetime]
</code></pre>
<p>for now, i'm adding the comment <code># noqa: F401</code> to keep the import.</p>
<p>ruff version 0.0.195</p>
<p>Thank you for this project ðŸ¤©</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2022-12-27 12:46</div>
            <div class="timeline-body"><p>Thank you! Will check this out.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @charliermarsh on 2022-12-27 12:46</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2022-12-27 16:12</div>
            <div class="timeline-body"><p>Is this the exact snippet you're using? When I run Ruff on:</p>
<pre><code class="language-py">from typing import Optional
import datetime
import pydantic

class SomeClass(pydantic.BaseModel):
    datetime: Optional[datetime.datetime]
</code></pre>
<p>It doesn't report any errors ðŸ¤” Neither does <code>flake8</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> removed by @charliermarsh on 2022-12-27 16:12</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">question</span> added by @charliermarsh on 2022-12-27 16:12</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2022-12-27 16:12</div>
            <div class="timeline-body"><p>(I'm guessing that whatever the problem is, it may have to do with the use of <code>datetime</code> as the class property, which collides with the import name <code>datetime</code>.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/jad-haddad">@jad-haddad</a> on 2022-12-27 17:03</div>
            <div class="timeline-body"><p>well, there are other classes definitions in the module, but none of them have the property <code>datetime</code> nor the type <code>datetime</code> the full list of imports is</p>
<pre><code class="language-python">from __future__ import annotations
import datetime  # noqa: F401 (false positive)
from enum import Enum
from typing import List, Optional

import pydantic
</code></pre>
<p>could it be that the <code>__future__</code> annotations module is interfering with ruff/flake8 ?
I'm using python 3.8 and I have set in ruff.toml <code>target-version = &quot;py38&quot;</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2022-12-27 17:04</div>
            <div class="timeline-body"><p>Oh, yeah, it could be <code>__future__</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2022-12-27 17:07</div>
            <div class="timeline-body"><p>Here's an minimal reproducible example:</p>
<pre><code class="language-py">from __future__ import annotations

import datetime
from typing import Optional

class SomeClass:
    datetime: Optional[datetime.datetime]
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2022-12-27 17:16</div>
            <div class="timeline-body"><p>A little challenging to fix, won't happen immediately... My suggestion would be to use a different name for the class attribute, since these kinds of collisions can cause a lot of confusing behavior. For example, Mypy and Pyright handle this case differently, and I don't know which is correct:</p>
<pre><code class="language-py">from __future__ import annotations

import datetime
from typing import Optional

class SomeClass:
    datetime: Optional[datetime.datetime]

    def __init__(self, datetime: datetime.datetime):
        self.datetime = datetime

SomeClass(datetime.datetime(...))
</code></pre>
<p>Mypy flags an error on line 9 (<code>error: Name &quot;datetime.datetime&quot; is not defined</code>), because <code>datetime</code> there is bound to the class property, not the import. But Pyright does not.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">question</span> removed by @charliermarsh on 2022-12-27 17:16</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @charliermarsh on 2022-12-27 17:16</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/rassie">@rassie</a> on 2023-01-01 13:54</div>
            <div class="timeline-body"><p>Is this more or less an extended version of the &quot;A003 problem&quot; where A003 is triggered in the following code because <code>id</code> apparently shadows a Python built-in?</p>
<pre><code class="language-python">class SomeClass:
    id: int
</code></pre>
<p>Basically, <code>datetime</code> (or in my case <code>uuid</code>) is shadowing the import, so that the import becomes unusued. I wouldn't normally expect the second <code>datetime</code> in the field declaration <code>datetime: Optional[datetime.datetime]</code> to refer to the first one, would be a major gotcha for me, does this shadowing really happen?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/andersk">@andersk</a> on 2023-01-03 04:45</div>
            <div class="timeline-body"><p>An annotation like <code>id: int</code> or <code>datetime: Optional[datetime.datetime]</code> doesnâ€™t bind anything at runtime, so it shouldnâ€™t be considered as shadowing the outer binding.</p>
<p>An annotated <em>assignment</em> like <code>id: int = 0</code> or <code>datetime: Optional[datetime.datetime] = datetime.datetime.now()</code>, however, does shadow from the perspective of some references:</p>
<pre><code class="language-python">class SomeClass:
    #         â†“ shadowed except under __future__.annotations
    datetime: datetime.datetime = (
        # â†“ not shadowed
        datetime.datetime.now()
    )
    #      â†“ shadowed except under __future__.annotations
    other: datetime.datetime = (
        # â†“ always shadowed
        datetime
    )
</code></pre>
<p>(The behavior for annotations can be observed at runtime with <a href="https://docs.python.org/3/library/typing.html#typing.get_type_hints"><code>typing.get_type_hints(SomeClass)</code></a>.)</p>
<p>Mypyâ€™s understanding of annotation shadowing seems to be quite busted. It accepts nonsense like</p>
<pre><code class="language-python">x = &quot;oops&quot;

class SomeClass:
    x: int
    print(x + 1)
</code></pre>
<p>which does <code>str + int</code> at runtime.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/2248.html">astral-sh/ruff#2248</a> on 2023-01-27 13:24</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/2359.html">astral-sh/ruff#2359</a> on 2023-01-30 20:03</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/3014.html">astral-sh/ruff#3014</a> on 2023-02-18 18:06</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/4044.html">astral-sh/ruff#4044</a> on 2023-04-21 01:37</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/jack-mcivor">@jack-mcivor</a> on 2023-05-04 13:05</div>
            <div class="timeline-body"><p>Came across this today - if it helps here is where the <code>from __future__ import annotations</code> issue was raised in <code>pyflakes</code></p>
<ul>
<li>https://github.com/PyCQA/pyflakes/issues/648</li>
<li>https://github.com/PyCQA/pyflakes/issues/713</li>
<li>https://github.com/PyCQA/pyflakes/issues/773</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-05-18 19:35</div>
            <div class="timeline-body"><p>I've spent a while looking into this. What we might need is this: https://github.com/microsoft/pyright/commit/27bf8c1f2.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/4509.html">astral-sh/ruff#4509</a> on 2023-05-18 20:41</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2023-05-20 02:54</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/jad-haddad">@jad-haddad</a> on 2023-05-24 15:08</div>
            <div class="timeline-body"><p>I still have the issue @charliermarsh:</p>
<pre><code class="language-python">from __future__ import annotations

import datetime  # &lt;--- gets removed by ruff

import pydantic


class SomeClass(pydantic.BaseModel):
    datetime: datetime.datetime

</code></pre>
<p>command: <code>ruff --config ruff.toml --show-fixes --fix ./test.py</code></p>
<pre><code>Fixed 2 errors:
- test.py:
    1 Ã— F401 (unused-import)
    1 Ã— I001 (unsorted-imports)
</code></pre>
<p>Ruff 0.0.269
Python 3.11.2</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-05-24 15:09</div>
            <div class="timeline-body"><p>It hasn't been released. It'll be part of 0.0.270.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/jad-haddad">@jad-haddad</a> on 2023-05-24 15:11</div>
            <div class="timeline-body"><p>oh okay my bad, i'll wait for the next release then, thanks :)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-05-24 15:12</div>
            <div class="timeline-body"><p>Should be out soon, maybe today? We'll see! :)</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 01:30:03 UTC
    </footer>
</body>
</html>
