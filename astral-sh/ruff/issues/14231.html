<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UP044 has unsafe or incorrect fixes when `Unpack` is used in unusual ways - astral-sh/ruff #14231</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>UP044 has unsafe or incorrect fixes when `Unpack` is used in unusual ways</h1>

    <div class="meta">
        <span class="state state-closed">Closed</span>
        <a href="https://github.com/astral-sh/ruff/issues/14231">#14231</a>
        opened by <a href="https://github.com/dscorbett">@dscorbett</a>
        on 2024-11-09 18:43
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/dscorbett">@dscorbett</a> on 2024-11-09 18:43</div>
            <div class="timeline-body"><p>The fixes for <a href="https://docs.astral.sh/ruff/rules/non-pep646-unpack/"><code>non-pep646-unpack</code> (UP044)</a> have three problems in Ruff 0.7.3 when <code>Unpack</code> is used in unusual ways. One problem changes behavior, one introduces a syntax error, and one makes Ruff exit with an error.</p>
<p>First, <code>Unpack</code> and <code>*</code> produce different values at runtime, so the fix changes behavior. In particular, if it is being used as an annotation, the change could affect runtime type introspection. It is also possible to use it outside an annotation. When it makes a difference at runtime, the fix should either be marked unsafe or suppressed.</p>
<pre><code class="language-console">$ cat up044_1.py
from typing import Unpack
def f(*args: Unpack[tuple[int, ...]]) -&gt; tuple[int, ...]:
    return args
print(f.__annotations__[&quot;args&quot;])
print(Unpack[tuple[int, ...]])

$ python up044_1.py
typing.Unpack[tuple[int, ...]]
typing.Unpack[tuple[int, ...]]

$ ruff check --target-version py311 --isolated --preview --select UP044 up044_1.py --fix
Found 2 errors (2 fixed, 0 remaining).

$ cat up044_1.py
from typing import Unpack
def f(*args: *tuple[int, ...]) -&gt; tuple[int, ...]:
    return args
print(f.__annotations__[&quot;args&quot;])
print(*tuple[int, ...])

$ python up044_1.py
*tuple[int, ...]
*tuple[int, ...]
</code></pre>
<p>Second, the <code>*</code> is a syntax error unless in an annotation or within brackets. For example, it is not valid after <code>return</code>.</p>
<pre><code class="language-console">$ cat up044_2.py
from typing import Unpack
def f() -&gt; object:
    return Unpack[tuple[int, ...]]
print(f())

$ python up044_2.py
typing.Unpack[tuple[int, ...]]

$ ruff check --target-version py311 --isolated --preview --select UP044 up044_2.py --fix
Found 1 error (1 fixed, 0 remaining).

$ cat up044_2.py
from typing import Unpack
def f() -&gt; object:
    return *tuple[int, ...]
print(f())

$ python up044_2.py
  File &quot;up044_2.py&quot;, line 3
    return *tuple[int, ...]
           ^^^^^^^^^^^^^^^^
SyntaxError: can't use starred expression here
</code></pre>
<p>Third, if <code>Unpack</code> is misused as an annotation for a non-variadic parameter, Ruff exits with an error.</p>
<pre><code class="language-console">$ cat up044_3.py
from typing import Unpack
def f(x: Unpack[tuple[int, ...]]) -&gt; object:
    return x
print(f(()))

$ python up044_3.py
()

$ ruff check --target-version py311 --isolated --preview --select UP044 up044_3.py --fix

error: Fix introduced a syntax error. Reverting all changes.

This indicates a bug in Ruff. If you could open an issue at:

    https://github.com/astral-sh/ruff/issues/new?title=%5BFix%20error%5D

...quoting the contents of `up044_3.py`, the rule codes UP044, along with the `pyproject.toml` settings and executed command, we'd be very appreciative!

up044_3.py:2:10: UP044 Use `*` for unpacking
  |
1 | from typing import Unpack
2 | def f(x: Unpack[tuple[int, ...]]) -&gt; object:
  |          ^^^^^^^^^^^^^^^^^^^^^^^ UP044
3 |     return x
4 | print(f(()))
  |
  = help: Convert to `*` for unpacking

Found 1 error.
[*] 1 fixable with the `--fix` option.
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @charliermarsh on 2024-11-09 19:31</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @charliermarsh by @charliermarsh on 2024-11-09 20:12</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/14234.html">astral-sh/ruff#14234</a> on 2024-11-09 20:30</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2024-11-09 20:47</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:34:54 UTC
    </footer>
</body>
</html>
