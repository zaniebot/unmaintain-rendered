<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Update string rules when inside a forward reference - astral-sh/ruff #10586</title>
    <link rel="stylesheet" href="../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../index.html">Back to index</a>
    </div>

    <h1>Update string rules when inside a forward reference</h1>

    <div class="meta">
        <span class="state state-open">Open</span>
        <a href="https://github.com/astral-sh/ruff/issues/10586">#10586</a>
        opened by <a href="https://github.com/dhruvmanila">@dhruvmanila</a>
        on 2024-03-25 18:33
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-03-25 18:33</div>
            <div class="timeline-body"><p>This is happening because the checker is analyzing the string <em>inside</em> the annotation (three strings inside <code>Literal</code>). The ranges aren't correct in that case. We need to find a holistic solution to this because it's happening to <em>all</em> rules working on strings.</p>
<p>For example, here <code>UP025</code> is triggered for the <code>u'\\n'</code> which is inside the string type annotation.</p>
<pre><code>/Users/dhruv/playground/ruff/src/UP025.py:1:12: UP025 [*] Remove unicode literals from strings
  |
1 | NEWLINE_SEQUENCE: &quot;te.Literal[u'\\n', '\\r\\n', '\\r']&quot; = &quot;\n&quot;
  |            ^^^^^ UP025
  |
  = help: Remove unicode prefix

ℹ Safe fix
1   |-NEWLINE_SEQUENCE: &quot;te.Literal[u'\\n', '\\r\\n', '\\r']&quot; = &quot;\n&quot;
  1 |+NEWLINE_SEQENCE: &quot;te.Literal[u'\\n', '\\r\\n', '\\r']&quot; = &quot;\n&quot;

Found 1 error.
[*] 1 fixable with the --fix option.
</code></pre>
<p>We could potentially fix the range for the rules to be useful in the context of type annotation or ignore them completely. Nevertheless, we should completely avoid rules which might update the quotes because otherwise we need the context of the quote which contains the actual type annotation.</p>
<p><em>Originally posted by @dhruvmanila in https://github.com/astral-sh/ruff/issues/10546#issuecomment-2016886953</em></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @dhruvmanila on 2024-03-25 18:33</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">linter</span> added by @dhruvmanila on 2024-03-25 18:33</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-04-10 09:42</div>
            <div class="timeline-body"><p>Hey @RaulWCosta, sorry for the late reply but yeah it is available.</p>
<p>I think the first step would be to fix the range. I was able to find out the root cause of the problem and it's here:</p>
<p>https://github.com/astral-sh/ruff/blob/de46a36bbcdc1df4a56fc486ae5c7bcf2c4bbba0/crates/ruff_python_parser/src/typing.rs#L39-L42</p>
<p>The example mentioned in the PR description contains escaped characters which makes this a complex annotation. This means that <code>parse_type_annotation</code> takes the <code>else</code> path which parses it as an expression and then relocates the parsed expression and any of it's child expressions to the <em>same</em> range. This is where the bug is. The <a href="https://github.com/astral-sh/ruff/blob/de46a36bbcdc1df4a56fc486ae5c7bcf2c4bbba0/crates/ruff_python_ast/src/relocate.rs">relocation logic</a> isn't correct as it doesn't relocate any of the sub-expressions relative to the root expression. cc @charliermarsh I think there was some discussion around this logic.</p>
<p>For example,</p>
<pre><code class="language-py">import typing as t

NEWLINE_SEQUENCE: &quot;t.Literal[u'\\n', '\\r\\n', '\\r']&quot; = &quot;\n&quot;
</code></pre>
<p>Along with the following patch to print the AST:</p>
<pre><code class="language-diff">diff --git a/crates/ruff_python_parser/src/typing.rs b/crates/ruff_python_parser/src/typing.rs
index 18efe4041..09507977c 100644
--- a/crates/ruff_python_parser/src/typing.rs
+++ b/crates/ruff_python_parser/src/typing.rs
@@ -38,7 +38,9 @@ pub fn parse_type_annotation(
     } else {
         // Otherwise, consider this a &quot;complex&quot; annotation.
         let mut expr = parse_expression(value)?;
+        println!(&quot;{:#?}&quot;, expr);
         relocate_expr(&amp;mut expr, range);
+        println!(&quot;{:#?}&quot;, expr);
         Ok((expr, AnnotationKind::Complex))
     }
 }
</code></pre>
<p>We can see that the relocated ranges aren't correct as they're set to the same range regardless of the position of the node:</p>
<pre><code class="language-diff">diff --git a/a.txt b/b.txt
index bb13b780d..26b45c862 100644
--- a/a.txt
+++ b/b.txt
@@ -1,12 +1,13 @@
    ⋮  1 │+
  1 ⋮  2 │ Subscript(
  2 ⋮  3 │     ExprSubscript {
  3 ⋮    │-        range: 0..30,
    ⋮  4 │+        range: 38..74,
  4 ⋮  5 │         value: Attribute(
  5 ⋮  6 │             ExprAttribute {
  6 ⋮    │-                range: 0..9,
    ⋮  7 │+                range: 38..74,
  7 ⋮  8 │                 value: Name(
  8 ⋮  9 │                     ExprName {
  9 ⋮    │-                        range: 0..1,
    ⋮ 10 │+                        range: 38..74,
 10 ⋮ 11 │                         id: &quot;t&quot;,
 11 ⋮ 12 │                         ctx: Load,
 12 ⋮ 13 │                     },
@@ -20,11 +21,11 @@ Subscript(
 20 ⋮ 21 │         ),
 21 ⋮ 22 │         slice: Tuple(
 22 ⋮ 23 │             ExprTuple {
 23 ⋮    │-                range: 10..29,
    ⋮ 24 │+                range: 38..74,
 24 ⋮ 25 │                 elts: [
 25 ⋮ 26 │                     StringLiteral(
 26 ⋮ 27 │                         ExprStringLiteral {
 27 ⋮    │-                            range: 10..15,
    ⋮ 28 │+                            range: 38..74,
 28 ⋮ 29 │                             value: StringLiteralValue {
 29 ⋮ 30 │                                 inner: Single(
 30 ⋮ 31 │                                     StringLiteral {
@@ -42,7 +43,7 @@ Subscript(
 42 ⋮ 43 │                     ),
 43 ⋮ 44 │                     StringLiteral(
 44 ⋮ 45 │                         ExprStringLiteral {
 45 ⋮    │-                            range: 17..23,
    ⋮ 46 │+                            range: 38..74,
 46 ⋮ 47 │                             value: StringLiteralValue {
 47 ⋮ 48 │                                 inner: Single(
 48 ⋮ 49 │                                     StringLiteral {
@@ -60,7 +61,7 @@ Subscript(
 60 ⋮ 61 │                     ),
 61 ⋮ 62 │                     StringLiteral(
 62 ⋮ 63 │                         ExprStringLiteral {
 63 ⋮    │-                            range: 25..29,
    ⋮ 64 │+                            range: 38..74,
 64 ⋮ 65 │                             value: StringLiteralValue {
 65 ⋮ 66 │                                 inner: Single(
 66 ⋮ 67 │                                     StringLiteral {
</code></pre>
<p>The next step would be to go through the rules which work on strings (search for <code>StringLiteral</code>, <code>BytesLiteral</code>, <code>FString</code>, <code>StringLike</code>) and decide on the following:</p>
<ol>
<li>Is it ok to highlight this violation? If not, skip this rule through <code>checker.semantic().in_type_definition()</code> check. For example, https://github.com/astral-sh/ruff/blob/de46a36bbcdc1df4a56fc486ae5c7bcf2c4bbba0/crates/ruff_linter/src/rules/flake8_type_checking/rules/runtime_string_union.rs#L55-L58</li>
<li>Is it safe to fix this violation? If not, avoid creating the fix for it. For example, https://github.com/astral-sh/ruff/blob/de46a36bbcdc1df4a56fc486ae5c7bcf2c4bbba0/crates/ruff_linter/src/rules/pyupgrade/rules/use_pep604_annotation.rs#L68-L79</li>
</ol>
<p>That said, I don't think any of the violations that diagnosis string <strong>quotes</strong> should be highlighted or fixed as it requires context of the surrounding quote of the annotation itself.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-04-15 14:17</div>
            <div class="timeline-body"><p>Thanks for the update! I'll assign the issue to you but do not feel any pressure to complete it :)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @RaulWCosta by @dhruvmanila on 2024-04-15 14:17</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Unassigned @RaulWCosta by @RaulWCosta on 2024-04-26 20:01</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/RaulWCosta">@RaulWCosta</a> on 2024-04-26 20:02</div>
            <div class="timeline-body"><p>Hey @dhruvmanila, thank you for the clear explanation, but I believe I won't have time to do the fix</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-04-29 08:33</div>
            <div class="timeline-body"><p>@RaulWCosta Hey, no worries, thanks for informing :)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/11642.html">astral-sh/ruff#11642</a> on 2024-05-31 14:45</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/12165.html">astral-sh/ruff#12165</a> on 2024-07-04 05:10</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/12166.html">astral-sh/ruff#12166</a> on 2024-07-04 05:24</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/12167.html">astral-sh/ruff#12167</a> on 2024-07-04 05:26</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">linter</span> removed by @dhruvmanila on 2024-08-05 10:52</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">help wanted</span> added by @dhruvmanila on 2024-08-05 10:52</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-08-05 10:54</div>
            <div class="timeline-body"><p>We'd appreciate any contributions here. Refer to the issue description to understand what's happening and <a href="https://github.com/astral-sh/ruff/issues/10586#issuecomment-2047045527">this comment</a> on the root cause analysis and pointers on how to resolve it. Feel free to ping me for any questions.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/13542.html">astral-sh/ruff#13542</a> on 2024-09-30 13:22</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/14132.html">astral-sh/ruff#14132</a> on 2024-11-07 04:51</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/14700.html">astral-sh/ruff#14700</a> on 2024-12-02 05:02</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/15405.html">astral-sh/ruff#15405</a> on 2025-01-17 06:48</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/16032.html">astral-sh/ruff#16032</a> on 2025-02-08 16:30</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:28:12 UTC
    </footer>
</body>
</html>
