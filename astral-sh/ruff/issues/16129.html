<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>`RUF038` Surprising fix for  `Literal[True, False]` in functions with overloads - astral-sh/ruff #16129</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>`RUF038` Surprising fix for  `Literal[True, False]` in functions with overloads</h1>

    <div class="meta">
        <span class="state state-open">Open</span>
        <a href="https://github.com/astral-sh/ruff/issues/16129">#16129</a>
        opened by <a href="https://github.com/Geo5">@Geo5</a>
        on 2025-02-12 23:17
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/Geo5">@Geo5</a> on 2025-02-12 23:17</div>
            <div class="timeline-body"><h3>Description</h3>
<p>~~I stumbled upon some code of mine where it seems to me that <code>mypy</code> and <code>ruff</code> do not agree whether <code>Literal[True, False] == bool</code> and rule <code>RUF038</code> suggest a fix which introduces a mypy error.~~</p>
<p>Edit: I read the docs for the rule again and this general case seems to be mentioned in the &quot;Fix safety&quot; already. Maybe this example is different, but if you feel like it is already covered well enough, feel free to close the issue!</p>
<hr />
<p>Consider this code containing two <code>@overload</code>s and illustrating perhaps two different problems:</p>
<pre><code class="language-python">import random
from typing import Literal, overload


class Foo:
    @overload
    def foo(self, *, bar: Literal[True]) -&gt; int: ...

    @overload
    def foo(self, *, bar: Literal[False]) -&gt; float: ...

    def foo(self, *, bar: Literal[True, False]) -&gt; int | float:
        return 0


class FooSub(Foo):
    @overload
    def foo(self, *, bar: Literal[True]) -&gt; int: ...

    @overload
    def foo(self, *, bar: Literal[False]) -&gt; float: ...

    def foo(self, *, bar: Literal[True, False]) -&gt; int | float:
        return super().foo(bar=bar)


def compute_bool() -&gt; bool:
    return random.random() &gt; 10


Foo().foo(bar=compute_bool())  # Problem 1: For this line mypy raises an error
</code></pre>
<pre><code class="language-bash">$ mypy --strict test.py
test.py:31: error: No overload variant of &quot;foo&quot; of &quot;Foo&quot; matches argument type &quot;bool&quot;  [call-overload]
test.py:31: note: Possible overload variants:
test.py:31: note:     def foo(self, *, bar: Literal[True]) -&gt; int
test.py:31: note:     def foo(self, *, bar: Literal[False]) -&gt; float
Found 1 error in 1 file (checked 1 source file)
</code></pre>
<p>And ruff suggest fixing the annotations like this:</p>
<pre><code class="language-bash">$ ruff check --isolated --select RUF --preview test.py
test.py:12:27: RUF038 `Literal[True, False]` can be replaced with `bool`
   |
10 |     def foo(self, *, bar: Literal[False]) -&gt; float: ...
11 |
12 |     def foo(self, *, bar: Literal[True, False]) -&gt; int | float:
   |                           ^^^^^^^^^^^^^^^^^^^^ RUF038
13 |         return 0
   |
   = help: Replace with `bool`

test.py:23:27: RUF038 `Literal[True, False]` can be replaced with `bool`
   |
21 |     def foo(self, *, bar: Literal[False]) -&gt; float: ...
22 |
23 |     def foo(self, *, bar: Literal[True, False]) -&gt; int | float:
   |                           ^^^^^^^^^^^^^^^^^^^^ RUF038
24 |         return super().foo(bar=bar)
   |
   = help: Replace with `bool`

Found 2 errors.
No fixes available (2 hidden fixes can be enabled with the `--unsafe-fixes` option).
</code></pre>
<p>Resulting in:</p>
<pre><code class="language-python">import random
from typing import Literal, overload


class Foo:
    @overload
    def foo(self, *, bar: Literal[True]) -&gt; int: ...

    @overload
    def foo(self, *, bar: Literal[False]) -&gt; float: ...

    def foo(self, *, bar: bool) -&gt; int | float:
        return 0


class FooSub(Foo):
    @overload
    def foo(self, *, bar: Literal[True]) -&gt; int: ...

    @overload
    def foo(self, *, bar: Literal[False]) -&gt; float: ...

    def foo(self, *, bar: bool) -&gt; int | float:
        return super().foo(bar=bar)  # Problem 2 introduced


def compute_bool() -&gt; bool:
    return random.random() &gt; 10


Foo().foo(bar=compute_bool()) # Problem 1 again, same as unfixed code
</code></pre>
<p>And again <code>mypy</code> on the fixed code:</p>
<pre><code class="language-bash">$ mypy --strict test_fixed.py
test_fixed.py:24: error: Returning Any from function declared to return &quot;int | float&quot;  [no-any-return]
test_fixed.py:24: error: No overload variant of &quot;foo&quot; of &quot;Foo&quot; matches argument type &quot;bool&quot;  [call-overload]
test_fixed.py:24: note: Possible overload variants:
test_fixed.py:24: note:     def foo(self, *, bar: Literal[True]) -&gt; int
test_fixed.py:24: note:     def foo(self, *, bar: Literal[False]) -&gt; float
test_fixed.py:31: error: No overload variant of &quot;foo&quot; of &quot;Foo&quot; matches argument type &quot;bool&quot;  [call-overload]
test_fixed.py:31: note: Possible overload variants:
test_fixed.py:31: note:     def foo(self, *, bar: Literal[True]) -&gt; int
test_fixed.py:31: note:     def foo(self, *, bar: Literal[False]) -&gt; float
Found 3 errors in 1 file (checked 1 source file)
</code></pre>
<hr />
<pre><code class="language-bash">$ python --version
Python 3.11.10
$ ruff --version
ruff 0.9.6
$ mypy --version
mypy 1.15.0 (compiled: yes)
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../astral-sh/ty/issues/216.html">astral-sh/ty#216</a> on 2025-02-12 23:18</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Geo5">@Geo5</a> on 2025-02-12 23:34</div>
            <div class="timeline-body"><p>Oh i am so sorry! I didn't read <a href="https://docs.astral.sh/ruff/rules/redundant-bool-literal/">the doc for rule <code>RUF038</code></a> close enough and did not look at the issues linked there! I think the issues for mypy and pyright might cover this?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "`RUF038` `Literal[True, False]` might not always be equal to `bool`" to "`RUF038` Incorrect fix for  `Literal[True, False]` in functions with overloads" by @Geo5 on 2025-02-12 23:44</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "`RUF038` Incorrect fix for  `Literal[True, False]` in functions with overloads" to "`RUF038` Surprising fix for  `Literal[True, False]` in functions with overloads" by @Geo5 on 2025-02-13 00:00</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-02-13 08:35</div>
            <div class="timeline-body"><p>Yes, this part is covered by the section you call out. However, it does make me wonder if we should skip providing a fix alltogether if a method is marked as <code>@overload</code>. @AlexWaygood wdyt?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">rule</span> added by @MichaReiser on 2025-02-13 08:35</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-02-13 16:39</div>
            <div class="timeline-body"><p>It's not totally clear to me whether mypy is correct in rejecting the overloads after they've been autofixed by Ruff here. Overloads aren't currently clearly specified in the typing spec, but there is a <a href="https://github.com/python/typing/pull/1839">draft PR</a> to provide a detailed specification for them, which I think is nearly over the line now. The rendered version of the draft spec is <a href="https://typing--1839.org.readthedocs.build/en/1839/spec/overload.html">here</a>, and it describes how type checkers should perform &quot;argument type expansion&quot; for overloads, which for <code>bool</code> means that it should implicitly convert <code>bool</code> into union <code>Literal[True] | Literal[False]</code>. Assuming that the draft overload chapter is accepted to the spec without major revisions, I think that might put mypy's behaviour here in violation of the new spec. @carljm can correct me if I'm wrong!</p>
<p>Whether mypy is right or wrong, though, is perhaps irrelevant here. We perhaps shouldn't be making changes that would cause your CI to fail, and here we clearly are, since mypy now emits more errors after Ruff's autofix than it did initially. So I'd be okay with ignoring any <code>@overload</code>-decorated function definitions (or any function definitions that shadow <code>@overload</code>-decorated function definitions) for this rule. I think that makes sense.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-02-13 17:20</div>
            <div class="timeline-body"><p>According to the draft spec for overload handling, mypy is in the wrong here by failing to expand <code>bool</code> to <code>Literal[True, False]</code> when checking a call with an argument typed as <code>bool</code> to a function with overloads taking <code>Literal[True]</code> and <code>Literal[False]</code>.</p>
<p>Both the error in the initial code and the new error in the fixed code are examples of the exact same mypy limitation, the problem just occurs in a new location (inside the implementation of <code>FooSub.bar</code>) when the annotation on <code>FooSub.bar</code> is changed to <code>bool</code>.</p>
<p>If mypy were fixed to perform expansion of <code>bool</code>, neither version of the code would have any errors.</p>
<p>In general (even not considering overloads specifically) anywhere a type checker fails to treat <code>bool</code> and <code>Literal[True, False]</code> the same, it's a type checker bug IMO -- those types are equivalent. (Side note: our fix safety docs for this rule are simply wrong when they claim in the second bullet point that <code>bool</code> and <code>Literal[True, False]</code> are not strictly equivalent because <code>bool</code> is a subtype of <code>int</code> -- <code>Literal[True, False]</code> is also a subtype of <code>int</code>.)</p>
<p>The fix safety docs do already mention this exact problem in the fix safety section, and even link to relevant mypy bugs.</p>
<p>I think we could decline to autofix this in this particular overload case, as a concession to mypy, but I'm not sure how many real-world scenarios would be helped by that. An overload like this is quite likely already causing errors under mypy, because it's almost certain you'd be calling it somewhere with a value typed as <code>bool</code> (as is indeed the case in version 1 of the code here, before the autofix.) So personally my feeling is that calling it out in &quot;fix safety&quot; is sufficient concession to the mypy bug.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-02-13 17:22</div>
            <div class="timeline-body"><blockquote>
<p>(Side note: our fix safety docs for this rule are simply wrong when they claim in the second bullet point that <code>bool</code> and <code>Literal[True, False]</code> are not strictly equivalent because <code>bool</code> is a subtype of <code>int</code> -- <code>Literal[True, False]</code> is also a subtype of <code>int</code>.)</p>
</blockquote>
<p>Yeah I also noticed that -- I agree, I'm not sure what those docs are trying to say there</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Geo5">@Geo5</a> on 2025-02-16 15:01</div>
            <div class="timeline-body"><blockquote>
<p>I think we could decline to autofix this in this particular overload case, as a concession to mypy, but I'm not sure how many real-world scenarios would be helped by that. An overload like this is quite likely already causing errors under mypy, because it's almost certain you'd be calling it somewhere with a value typed as <code>bool</code> (as is indeed the case in version 1 of the code here, before the autofix.) So personally my feeling is that calling it out in &quot;fix safety&quot; is sufficient concession to the mypy bug.</p>
</blockquote>
<p>I agree with everything you said, thank you for the writeup!
Just for some additional context, i didn't hit the <code>mypy</code> bug without the fix, as i only ever called the overloaded function as <code>foo(..., True)</code> or <code>foo(..., False)</code>, but i agree that this is probably rare.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/20211.html">astral-sh/ruff#20211</a> on 2025-09-03 15:43</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:34:54 UTC
    </footer>
</body>
</html>
