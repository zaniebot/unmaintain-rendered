<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[Rule request] Flag unsupported characters in logging method calls - astral-sh/ruff #12178</title>
    <link rel="stylesheet" href="../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../index.html">Back to index</a>
    </div>

    <h1>[Rule request] Flag unsupported characters in logging method calls</h1>

    <div class="meta">
        <span class="state state-open">Open</span>
        <a href="https://github.com/astral-sh/ruff/issues/12178">#12178</a>
        opened by <a href="https://github.com/huonw">@huonw</a>
        on 2024-07-04 04:47
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/huonw">@huonw</a> on 2024-07-04 04:47</div>
            <div class="timeline-body"><p>There's two rules (F509, PLE1300) that detect when a <code>%</code> formatted string include an invalid format character. However, these don't seem to flag format strings passed to logging functions (<code>debug</code>, <code>info</code>, etc.). These strings use <code>%</code> for formatting in the same way.</p>
<p>(References: &quot;The message attribute of the record is computed using msg % args&quot; https://docs.python.org/3/library/logging.html#logging.Formatter.format , https://github.com/python/cpython/blob/9728ead36181fb3f0a4b2e8a7291a3e0a702b952/Lib/logging/<strong>init</strong>.py#L391-L401).</p>
<p>Reproducer: https://play.ruff.rs/36d5756e-44c7-48a1-8d8e-ae45a29ee480</p>
<pre><code class="language-python">&quot;&quot;&quot;x.&quot;&quot;&quot;
import logging

x = &quot;flagged: %A&quot; % 1 # error: F509, PLE1300
logging.error(&quot;ignored: %A&quot;, 1) # no error
</code></pre>
<p>Settings (note <code>&quot;select&quot;: [&quot;ALL&quot;]</code>)</p>
<pre><code class="language-json">{
  &quot;preview&quot;: false,
  &quot;builtins&quot;: [],
  &quot;target-version&quot;: &quot;py312&quot;,
  &quot;line-length&quot;: 88,
  &quot;indent-width&quot;: 4,
  &quot;lint&quot;: {
    &quot;allowed-confusables&quot;: [],
    &quot;dummy-variable-rgx&quot;: &quot;^(_+|(_+[a-zA-Z0-9_]*[a-zA-Z0-9]+?))$&quot;,
    &quot;extend-select&quot;: [],
    &quot;extend-fixable&quot;: [],
    &quot;external&quot;: [],
    &quot;ignore&quot;: [],
    &quot;select&quot;: [
      &quot;ALL&quot;
    ]
  },
  &quot;format&quot;: {
    &quot;indent-style&quot;: &quot;space&quot;,
    &quot;quote-style&quot;: &quot;double&quot;
  }
}
</code></pre>
<p>To confirm that this is an error, comment out the <code>x = ...</code> line and run the code. It prints:</p>
<pre><code>--- Logging error ---
Traceback (most recent call last):
  File &quot;/Users/huon/.pyenv/versions/3.10.4/lib/python3.10/logging/__init__.py&quot;, line 1100, in emit
    msg = self.format(record)
  File &quot;/Users/huon/.pyenv/versions/3.10.4/lib/python3.10/logging/__init__.py&quot;, line 943, in format
    return fmt.format(record)
  File &quot;/Users/huon/.pyenv/versions/3.10.4/lib/python3.10/logging/__init__.py&quot;, line 678, in format
    record.message = record.getMessage()
  File &quot;/Users/huon/.pyenv/versions/3.10.4/lib/python3.10/logging/__init__.py&quot;, line 368, in getMessage
    msg = msg % self.args
ValueError: unsupported format character 'A' (0x41) at index 10
Call stack:
  File &quot;/private/tmp/test.py&quot;, line 6, in &lt;module&gt;
    logging.error(&quot;ignored: %A&quot;, 1)  # no error
Message: 'ignored: %A'
Arguments: (1,)
</code></pre>
<p>Issues that are (somewhat) related:</p>
<ul>
<li>https://github.com/astral-sh/ruff/issues/7248</li>
<li>https://github.com/astral-sh/ruff/issues/11403</li>
</ul>
<p>Thanks for ruff, very speedy!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-07-04 04:58</div>
            <div class="timeline-body"><p>Thank you for the detailed issue!</p>
<p>I think it's a little bit complicated than that. The formatting is decided by the <a href="https://docs.python.org/3/library/logging.html#formatter-objects">Formatter objects</a> which can use <code>%</code> but it can also use other formatting style which is determined by the <code>style</code> parameter and it can be set separately for each logger or can be set through the global config.</p>
<p>Or, maybe we can just check if the string uses <code>%</code>-style format characters and make an assumption that it uses the <code>%</code> style.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">rule</span> added by @dhruvmanila on 2024-07-04 04:58</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">needs-decision</span> added by @dhruvmanila on 2024-07-04 04:58</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/huonw">@huonw</a> on 2024-07-04 08:22</div>
            <div class="timeline-body"><p>Thanks for the quick reply!</p>
<p>I'm a little confused by the ins-and-outs of <code>logging</code> at times... but, I think there's two layers of formatting:</p>
<ol>
<li>Rendering of the individual <code>LogRecord</code>'s message, using the values passed to <code>info</code>/<code>error</code>/etc (<code>msg</code> &amp; <code>args</code>) to set <code>message</code>.</li>
<li>Constructing the final output from the message and other attributes (time etc), using a <code>Formatter</code> like you say. (And its <code>style</code> arg to customise.)</li>
</ol>
<p>For 1, I believe this happens unconditionally using <code>%</code>, unless there's some way to use a <code>LogRecord</code> subclass/replacement. See code: https://github.com/python/cpython/blob/9728ead36181fb3f0a4b2e8a7291a3e0a702b952/Lib/logging/<strong>init</strong>.py#L391-L401</p>
<p>In addition, there's existing linting rules that explicitly suggest turning f-strings and <code>.format</code> calls into <code>%</code>, so &quot;use <code>%</code> for logging&quot; is an assumption with precedent:</p>
<ul>
<li>G001: https://docs.astral.sh/ruff/rules/logging-string-format/ (and variants G002, G003, G004)</li>
<li>PLE1205: https://docs.astral.sh/ruff/rules/logging-too-many-args/ (and variant PLE1206)</li>
</ul>
<p>What do you think?</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:28:13 UTC
    </footer>
</body>
</html>
