<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Changed error formatting between 0.12.8.and 0.12.9 - astral-sh/ruff #19966</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Changed error formatting between 0.12.8.and 0.12.9</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/issues/19966">#19966</a>
        opened by <a href="https://github.com/MeggyCal">@MeggyCal</a>
        on 2025-08-18 11:34
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MeggyCal">@MeggyCal</a></div>
            <div class="timeline-body">Question
<p>Hi, thank you for maintaining this useful tool! I am a packager in openSUSE, with an update to 0.12.9 we are observing a test failure in <code>pytest-examples</code> (the tests ran fine with <code>ruff</code> 0.12.8).</p>
<p>It looks like <code>ruff</code> stopped printing pointers to the place where the error occurred. The patch to <code>pytest-examples</code> would be trivial, but I just wanted to make sure that it was intentional (nothing in the release highlights sounded like this change to me).</p>
<p>The log:</p>
<pre><code>[   14s] =================================== FAILURES ===================================
[   14s] _______________________________ test_ruff_offset _______________________________
[   14s] 
[   14s]     def test_ruff_offset():
[   14s]         code = &#x27;print(x)\n&#x27;
[   14s]         example = CodeExample.create(code)
[   14s]         with pytest.raises(FormatError, match=&#x27;testing.md:1:7: F821 Undefined name&#x27;):
[   14s] &gt;           ruff_check(example, ExamplesConfig())
[   14s] 
[   14s] tests/test_lint.py:28: 
[   14s] _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
[   14s] 
[   14s] example = CodeExample(source=&#x27;print(x)\n&#x27;, path=PosixPath(&#x27;testing.md&#x27;), start_line=0, end_line=1, start_index=0, end_index=9, prefix=&#x27;&#x27;, indent=0, group=None, test_id=None)
[   14s] config = ExamplesConfig(line_length=88, quotes=&#x27;either&#x27;, magic_trailing_comma=True, target_version=&#x27;py37&#x27;, upgrade=False, isort=False, ruff_line_length=None, ruff_select=None, ruff_ignore=None, white_space_dot=False)
[   14s] 
[   14s]     def ruff_check(
[   14s]         example: CodeExample,
[   14s]         config: ExamplesConfig,
[   14s]         *,
[   14s]         extra_ruff_args: tuple[str, ...] = (),
[   14s]     ) -&gt; str:
[   14s]         ruff = find_ruff_bin()
[   14s]         args = ruff, &#x27;check&#x27;, &#x27;-&#x27;, *config.ruff_config(), *extra_ruff_args
[   14s]     
[   14s]         p = Popen(args, stdin=PIPE, stdout=PIPE, stderr=PIPE, universal_newlines=True)
[   14s]         stdout, stderr = p.communicate(example.source, timeout=10)
[   14s]         if p.returncode == 1 and stdout:
[   14s]     
[   14s]             def replace_offset(m: re.Match[str]):
[   14s]                 line_number = int(m.group(1))
[   14s]                 return f&#x27;{example.path}:{line_number + example.start_line}&#x27;
[   14s]     
[   14s]             output = re.sub(r&#x27;^-:(\d+)&#x27;, replace_offset, stdout, flags=re.M)
[   14s] &gt;           raise FormatError(f&#x27;ruff failed:\n{indent(output, &quot;  &quot;)}&#x27;)
[   14s] E           pytest_examples.lint.FormatError: ruff failed:
[   14s] E             F821 Undefined name `x`
[   14s] E              --&gt; -:1:7
[   14s] E               |
[   14s] E             1 | print(x)
[   14s] E               |       ^
[   14s] E               |
[   14s] E           
[   14s] E             Found 1 error.
[   14s] 
[   14s] ../BUILDROOT/usr/lib/python3.11/site-packages/pytest_examples/lint.py:63: FormatError
[   14s] 
[   14s] During handling of the above exception, another exception occurred:
[   14s] 
[   14s]     def test_ruff_offset():
[   14s]         code = &#x27;print(x)\n&#x27;
[   14s]         example = CodeExample.create(code)
[   14s] &gt;       with pytest.raises(FormatError, match=&#x27;testing.md:1:7: F821 Undefined name&#x27;):
[   14s] E       AssertionError: Regex pattern did not match.
[   14s] E        Regex: &#x27;testing.md:1:7: F821 Undefined name&#x27;
[   14s] E        Input: &#x27;ruff failed:\n  F821 Undefined name `x`\n   --&gt; -:1:7\n    |\n  1 | print(x)\n    |       ^\n    |\n\n  Found 1 error.\n&#x27;
[   14s] 
[   14s] tests/test_lint.py:27: AssertionError
[   14s] _______________________________ test_ruff_error ________________________________
[   14s] 
[   14s] pytester = &lt;Pytester PosixPath(&#x27;/tmp/pytest-of-abuild/pytest-0/test_ruff_error0&#x27;)&gt;
[   14s] 
[   14s]     def test_ruff_error(pytester: pytest.Pytester):
[   14s]         pytester.makefile(
[   14s]             &#x27;.md&#x27;,
[   14s]             my_file=&#x27;```py\nimport sys\nprint(missing)\n```&#x27;,
[   14s]         )
[   14s]         # language=Python
[   14s]         pytester.makepyfile(
[   14s]             &quot;&quot;&quot;
[   14s]     from pytest_examples import find_examples, CodeExample, EvalExample
[   14s]     import pytest
[   14s]     
[   14s]     @pytest.mark.parametrize(&#x27;example&#x27;, find_examples(&#x27;.&#x27;), ids=str)
[   14s]     def test_find_run_examples(example: CodeExample, eval_example: EvalExample):
[   14s]         eval_example.lint_ruff(example)
[   14s]     &quot;&quot;&quot;
[   14s]         )
[   14s]     
[   14s]         result = pytester.runpytest(&#x27;-p&#x27;, &#x27;no:pretty&#x27;, &#x27;-v&#x27;)
[   14s]         result.assert_outcomes(failed=1)
[   14s]     
[   14s]         output = &#x27;\n&#x27;.join(result.outlines)
[   14s]         output = re.sub(r&#x27;(=|_){3,}&#x27;, r&#x27;\1\1\1&#x27;, output)
[   14s]         for phrase in [
[   14s]             &#x27;=== FAILURES ===\n&#x27;,
[   14s]             &#x27;___ test_find_run_examples[my_file.md:1-4] ___\n&#x27;,
[   14s]             &#x27;ruff failed:\n&#x27;,
[   14s]             &#x27;  my_file.md:2:8: F401 [*] `sys` imported but unused\n&#x27;,
[   14s]             &#x27;  my_file.md:3:7: F821 Undefined name `missing`\n&#x27;,
[   14s]             &#x27;  Found 2 errors.\n&#x27;,
[   14s]             &#x27;  [*] 1 fixable with the `--fix` option.\n&#x27;,
[   14s]             &#x27;=== short test summary info ===\n&#x27;,
[   14s]         ]:
[   14s] &gt;           assert phrase in output
[   14s] E           AssertionError: assert &#x27;  my_file.md:2:8: F401 [*] `sys` imported but unused\n&#x27; in &#x27;=== test session starts ===\nplatform linux -- Python 3.11.13, pytest-8.4.1, pluggy-1.6.0 -- /usr/bin/python3.11\ncac... info ===\nFAILED test_ruff_error.py::test_find_run_examples[my_file.md:1-4] - Failed: r...\n=== 1 failed in 0.01s ===&#x27;
[   14s] 
[   14s] /home/abuild/rpmbuild/BUILD/python-pytest-examples-0.0.18-build/pytest_examples-0.0.18/tests/test_run_examples.py:120: AssertionError
[   14s] ----------------------------- Captured stdout call -----------------------------
[   14s] ============================= test session starts ==============================
[   14s] platform linux -- Python 3.11.13, pytest-8.4.1, pluggy-1.6.0 -- /usr/bin/python3.11
[   14s] cachedir: .pytest_cache
[   14s] rootdir: /tmp/pytest-of-abuild/pytest-0/test_ruff_error0
[   14s] plugins: examples-0.0.18
[   14s] collecting ... collected 1 item
[   14s] 
[   14s] test_ruff_error.py::test_find_run_examples[my_file.md:1-4] FAILED        [100%]
[   14s] 
[   14s] =================================== FAILURES ===================================
[   14s] ____________________ test_find_run_examples[my_file.md:1-4] ____________________
[   14s] ruff failed:
[   14s]   F401 [*] `sys` imported but unused
[   14s]    --&gt; -:1:8
[   14s]     |
[   14s]   1 | import sys
[   14s]     |        ^^^
[   14s]   2 | print(missing)
[   14s]     |
[   14s]   help: Remove unused import: `sys`
[   14s] 
[   14s]   F821 Undefined name `missing`
[   14s]    --&gt; -:2:7
[   14s]     |
[   14s]   1 | import sys
[   14s]   2 | print(missing)
[   14s]     |       ^^^^^^^
[   14s]     |
[   14s] 
[   14s]   Found 2 errors.
[   14s]   [*] 1 fixable with the `--fix` option.
[   14s] 
[   14s] =========================== short test summary info ============================
[   14s] FAILED test_ruff_error.py::test_find_run_examples[my_file.md:1-4] - Failed: r...
[   14s] ============================== 1 failed in 0.01s ===============================
[   14s] =========================== short test summary info ============================
[   14s] FAILED tests/test_lint.py::test_ruff_offset - AssertionError: Regex pattern d...
[   14s] FAILED tests/test_run_examples.py::test_ruff_error - AssertionError: assert &#x27;...
[   14s] ================== 2 failed, 70 passed, 1 deselected in 1.08s ==================
</code></pre>
Version
<p><em>No response</em></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">question</span> added by <a href="https://github.com/MeggyCal">@MeggyCal</a> on 2025-08-18 11:34</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntBre">@ntBre</a> on 2025-08-18 12:38</div>
            <div class="timeline-body"><p>Thanks for the report and the kind words!</p>
<p>Yes, this was intentional, but it looks like I mistakenly tagged the PR that made the change (<a href="https://github.com/astral-sh/ruff/pull/19415">astral-sh/ruff#19415</a>) as <code>internal</code>, so it was omitted from the release notes. Sorry about that.</p>
<p>The range of the error should still be printed, but not on the same line as the error message, as expected by the test assertions. For example:</p>
<pre><code>F401 [*] `sys` imported but unused
 --&gt; -:1:8
</code></pre>
<p>instead of <code>-:1:8: F401 [*] `sys` imported but unused</code>.</p>
<p>That might make the regex a bit tricky, so another option would be to use the <code>concise</code> output format, which should still match the old one, as long as there aren&#x27;t any additional assertions on the code snippet after the header.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MeggyCal">@MeggyCal</a> on 2025-08-18 14:12</div>
            <div class="timeline-body"><p>Tagging @samuelcolvin here so he is aware of the issue. My hotfix would be just to delete the location pointers, but that is a bit dirty.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/samuelcolvin">@samuelcolvin</a> on 2025-08-18 15:40</div>
            <div class="timeline-body"><p>Thanks @MeggyCal for letting me know.</p>
<p>Pr welcome to either fix pytest-examples and bump ruff, or pin ruff.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntBre">@ntBre</a> on 2025-08-18 16:32</div>
            <div class="timeline-body"><p>@samuelcolvin I&#x27;m happy to open a PR! Would you prefer one of those options over passing <code>--output-format=concise</code>? That would avoid needing to bump or pin ruff since the concise output hasn&#x27;t changed and still matches the old regexes, but it looks like the full output is also user-facing, so I&#x27;m not sure if that&#x27;s actually preferable for you.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/samuelcolvin">@samuelcolvin</a> on 2025-08-18 16:47</div>
            <div class="timeline-body"><p>I think increasing the minimum ruff version is fine.</p>
<p>You&#x27;ll need a multiline regex, but that would be fine.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-09-17 07:18</div>
            <div class="timeline-body"><p>I&#x27;ll mark this as closed on the ruff side.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-09-17 07:18</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 18:50:21 UTC
    </footer>
</body>
</html>
