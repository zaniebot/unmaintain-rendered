<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ruff unexpectedly moving third party packages to first party section - astral-sh/ruff #16376</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Ruff unexpectedly moving third party packages to first party section</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/issues/16376">#16376</a>
        opened by <a href="https://github.com/tboddyspargo">@tboddyspargo</a>
        on 2025-02-25 15:26
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/tboddyspargo">@tboddyspargo</a></div>
            <div class="timeline-body">Summary
<p>The presence of a directory (e.g. <code>snowflake</code>) at the &quot;config root&quot; of the <code>ruff</code> invocation causes any import starting with the same name (e.g. <code>snowflake.sqlalchemy</code>) to get categorized as &quot;first party&quot; instead of the expected &quot;third party.&quot;</p>
<p>Background: We have a 3rd party dependency in some of our internal packages named <code>snowflake-sqlalchemy</code> (import path: <code>snowflake.sqlalchemy</code>). We also share a global <code>ruff.toml</code> file at the root of our monorepo which we use to achieve consistent formatting and linting behaviors across multiple packages. Finally, there happens to be a folder named <code>snowflake</code> at the root of our monorepo (sibling to <code>ruff.toml</code>) - which is not a python package and doesn&#x27;t contain any python files at all. This triggers the behavior I&#x27;m seeing.</p>
Minimal Repro
<p>

<pre><code>├── pkg_b
│   ├── __init__.py
│   └── utils.py
├── ruff.toml
└── snowflake
    └── README.md
</code></pre>
<p>___init__.py_</p>
<pre><code>import os

from pkg_b.utils import my_var
from snowflake.sqlalchemy import snowdialect

assert my_var and snowdialect and os
</code></pre>
<p><em>utils.py</em></p>
<pre><code>my_var = 1
</code></pre>
<p><em>ruff.toml</em></p>
<pre><code>line-length = 120

[lint]
extend-select = [&quot;I&quot;]
</code></pre>
</p>
 

Expected behavior
<p>I expected that the categorization for an import path starting with <code>snowflake</code> to <em>not</em> be influenced by the presence of directories at the config root sharing that same name - in particular this is unexpected when the directory isn&#x27;t related to python code in any way.</p>
<p>Is it reasonable to expect that an import can only have a &quot;first party&quot; match if the src path is actually a valid and importable python module?</p>
Actual behavior
<p><code>snowflake.sqlalchemy</code> is (IMO incorrectly) categorized as a first party import.</p>
Logs
<p>

<pre><code>[2025-02-25][12:58:50][ruff::resolve][DEBUG] Using user-specified configuration file at: /Users/me/dev/ruff-repro/ruff.toml
[2025-02-25][12:58:50][ruff::commands::check][DEBUG] Identified files to lint in: 3.140834ms
[2025-02-25][12:58:50][ruff::diagnostics][DEBUG] Checking: /Users/me/dev/ruff-repro/pkg_b/__init__.py
[2025-02-25][12:58:50][ruff_linter::rules::isort::categorize][DEBUG] Categorized &#x27;os&#x27; as Known(StandardLibrary) (KnownStandardLibrary)
[2025-02-25][12:58:50][ruff_linter::rules::isort::categorize][DEBUG] Categorized &#x27;pkg_b.utils&#x27; as Known(FirstParty) (SamePackage)
[2025-02-25][12:58:50][ruff_linter::rules::isort::categorize][DEBUG] Categorized &#x27;snowflake.sqlalchemy&#x27; as Known(FirstParty) (SourceMatch(&quot;/Users/me/dev/ruff-repro&quot;))
[2025-02-25][12:58:50][ruff::commands::check][DEBUG] Checked 1 files in: 614.042µs
</code></pre>
</p>
 

</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">question</span> added by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-02-25 16:51</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-02-25 16:53</div>
            <div class="timeline-body"><p>Thanks. Let me have a look at it. It might be difficult for us to help without a reproduction.</p>
<p>I do suspect that the problem comes from where the <code>ruff.toml</code> is located. Can you share the entire project structure including the location of the <code>ruff.toml</code> and where the file with the incorrectly sorted imports is?</p>
<p>I moved this issue to the ruff repository because I didn&#x27;t get the impression that it is specific to the VS code extension</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">isort</span> added by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-02-25 16:53</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-02-25 16:55</div>
            <div class="timeline-body"><p>And could you maybe share your <code>ruff.toml</code> configuration as well?</p>
<p>I do suspect that part of the issue is that the <code>ruff.toml</code> is shared between different packages unless you manually specified the <code>src</code> option?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/tboddyspargo">@tboddyspargo</a> on 2025-02-25 18:26</div>
            <div class="timeline-body"><blockquote>
<p>I moved this issue to the ruff repository because I didn&#x27;t get the impression that it is specific to the VS code extension</p>
</blockquote>
<p>Thank you! Yes - my mistake!</p>
<blockquote>
<p>It might be difficult for us to help without a reproduction....
Can you share the entire project structure including the location of the ruff.toml and where the file with the incorrectly sorted imports is?</p>
</blockquote>
<p>I&#x27;ll work on providing more detail here. As a start, I added the location of <code>ruff.toml</code> to the main issue description. That structure roughly mimics what I have in real life. The submodule with a name that collides with a third-party package exists in <code>package_a</code>, while the file getting analyzed as having unsorted imports exists in <code>package_b</code>.</p>
<blockquote>
<p>And could you maybe share your <code>ruff.toml</code> configuration as well?</p>
</blockquote>
ruff.toml
<p>

<pre><code>line-length = 120

extend-exclude = [
    &quot;*venv*&quot;,
    &quot;app_data&quot;,
    &quot;__pycache__&quot;,
    &quot;.pytest_cache&quot;,
    &quot;build&quot;,
    &quot;dist&quot;,
    &quot;snap_*.py&quot;,     # auto-generated snapshot files from pytest-snapshot.
]

[lint]
extend-select = [&quot;D&quot;, &quot;I&quot;] # enable pydocstyle and isort

# - We ignore a default set of rules that Ruff indicates are problematic when used
#   in conjunction with their formatting rules. https://docs.astral.sh/ruff/formatter/#format-suppression
# - We also disable some rules that we feel would unnecessarily annoy or distract developers (e.g. consistent string quoting)
# - See https://docs.astral.sh/ruff/rules/ for reference.
ignore = [
    ##### The following rules are recommended by Ruff because they might conflict with their formatter. #####
    ##### See https://docs.astral.sh/ruff/formatter/#conflicting-lint-rules                             #####
    &quot;W191&quot;,   # pycodestyle - tab-indentation
    &quot;E111&quot;,   # pycodestyle - indentation-with-invalid-multiple
    &quot;E114&quot;,   # pycodestyle - indentation-with-invalid-multiple-comment
    &quot;E117&quot;,   # pycodestyle - over-indented
    &quot;D206&quot;,   # pydocstyle - indent-with-spaces
    &quot;D300&quot;,   # pydocstyle - triple-single-quotes
    &quot;Q000&quot;,   # flake8 - bad-quotes-inline-string
    &quot;Q001&quot;,   # flake8 - bad-quotes-multiline-string
    &quot;Q002&quot;,   # flake8 - bad-quotes-docstring
    &quot;Q003&quot;,   # flake8 - avoidable-escaped-quote
    &quot;COM812&quot;, # flake8 - missing-trailing-comma
    &quot;COM819&quot;, # flake8 - prohibited-trailing-comma
    &quot;ISC001&quot;, # flake8 - single-line-implicit-string-concatenation
    &quot;ISC002&quot;, # flake8 - multi-line-implicit-string-concatenation

    ##### The following rules are disabled because they are overly distracting at the moment. #####
    &quot;D100&quot;, # undocumented-public-module
    &quot;D105&quot;, # pydocstyle - undocumented-magic-method (e.g. __str__)
    &quot;D107&quot;, # pydocstyle - undocumented-public-init
    &quot;D212&quot;, # pydocstyle - multi-line-summary-first-line
]

[lint.pydocstyle]
convention = &quot;google&quot;

[lint.isort]
# https://docs.astral.sh/ruff/faq/#how-does-ruffs-import-sorting-compare-to-isort

</code></pre>
</p>
 

</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/tboddyspargo">@tboddyspargo</a> on 2025-02-25 19:03</div>
            <div class="timeline-body"><p>Okay - I found a detail that had escaped me before and also have a minimal repro! <strong>EDIT:</strong> I&#x27;ve updated the main issue description with the minimal repro.</p>
<p>The detail I had missed is the presence of a directory named <code>snowflake</code> as a sibling of the <code>ruff.toml</code> file.  The repro doesn&#x27;t depend on any name collision from internal packages or submodules, it&#x27;s merely the presence of a directory of the same name at the &quot;config root&quot; that causes <code>ruff</code> to categorize a third party package import as &quot;first party&quot; - even when the directory doesn&#x27;t have any python files in it.</p>
<pre><code>├── pkg_b
│   ├── __init__.py
│   └── utils.py
├── ruff.toml
└── snowflake
    └── README.md
</code></pre>
<p>___init__.py_</p>
<pre><code>import os

from pkg_b.utils import my_var
from snowflake.sqlalchemy import snowdialect

assert my_var and snowdialect and os
</code></pre>
<p><em>utils.py</em></p>
<pre><code>my_var = 1
</code></pre>
<p><em>ruff.toml</em></p>
<pre><code>line-length = 120

[lint]
extend-select = [&quot;I&quot;]
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/tboddyspargo">@tboddyspargo</a> on 2025-02-25 22:01</div>
            <div class="timeline-body"><p>This issue is also reproducible with a structure like this and without using a single <code>ruff.toml</code> file across multiple packages.</p>
<pre><code>├── __init__.py
├── snowflake
│   └── README.md
└── utils.py
</code></pre>
<p>This is also a bit contrived, but I think it might be reasonable to support directories that are never &quot;importable&quot; (docs, binaries, data files, etc.) existing at the <code>ruff</code> config root.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-02-26 08:59</div>
            <div class="timeline-body"><p>Thanks for producing a repro. This now sounds to be the same as <a href="https://github.com/astral-sh/ruff/issues/10519">astral-sh/ruff#10519</a></p>
<p>Requiring an <code>__init__.py</code> does seem reasonable, but it would be a breaking change</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-02-26 08:59</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 18:49:34 UTC
    </footer>
</body>
</html>
