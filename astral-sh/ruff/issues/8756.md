```yaml
number: 8756
title: "Bug in PIE790 in Ruff v0.1.6 (`...` is meaningful in protocol methods and should not be removed)"
type: issue
state: closed
author: kkom
labels:
  - bug
assignees: []
created_at: 2023-11-18T16:42:45Z
updated_at: 2024-03-12T14:41:04Z
url: https://github.com/astral-sh/ruff/issues/8756
synced_at: 2026-01-10T01:56:50Z
```

# Bug in PIE790 in Ruff v0.1.6 (`...` is meaningful in protocol methods and should not be removed)

---

_Issue opened by @kkom on 2023-11-18 16:42_

Hey, I've got a regression in Ruff 0.1.6 to report.

PIE790 wants the `...` removed, but it's necessary in this case – because `foo` is a protocol method:

```python
from typing import Protocol

class Repro(Protocol):
    def foo(self) -> str:
        """docblock"""
        ...
```

At least according to Pyright 1.1.336, which shows this error if I allow Ruff to remove the `...`:

```
error: Function with declared return type "str" must return value on all code paths
    "None" is incompatible with "str" (reportGeneralTypeIssues)
```

---

_Comment by @zanieb on 2023-11-18 16:50_

Thanks for the report!

Would you mind reporting this on mypy? This seems like a bug on their end unless there's something in the specification that says `...` is required for protocol methods.

ref https://peps.python.org/pep-0544/

---

_Comment by @kkom on 2023-11-18 16:51_

Ah, I didn't think of it this way! Yeah, it's possible Pyright is in the (heh) wrong here. I'll report!

---

_Referenced in [microsoft/pyright#6487](../../microsoft/pyright/issues/6487.md) on 2023-11-18 17:09_

---

_Comment by @erictraut on 2023-11-18 17:21_

I'm the author of pyright, and I can say that this isn't a bug in pyright. Ruff's formatter should not remove the ellipsis in this case because it has significant meaning.

A protocol class is allowed to provide a default implementation for a method, in which case all subclasses of that protocol inherit that implementation. If the implementation of a method does not include a `...` as its implementation, pyright assumes it's a default implementation and type checks it accordingly.

I'll note that `black` doesn't remove the ellipsis in this case, so I consider this a bug in ruff's formatter.

---

_Referenced in [microsoft/pylance-release#5127](../../microsoft/pylance-release/issues/5127.md) on 2023-11-18 17:23_

---

_Renamed from "Bug in PIE790 in Ruff v0.1.6 (`...` is necessary for protocol methods which return something else than None)" to "Bug in PIE790 in Ruff v0.1.6 (`...` is meaningul in protocol methods and should not be removed)" by @kkom on 2023-11-18 17:29_

---

_Renamed from "Bug in PIE790 in Ruff v0.1.6 (`...` is meaningul in protocol methods and should not be removed)" to "Bug in PIE790 in Ruff v0.1.6 (`...` is meaningful in protocol methods and should not be removed)" by @kkom on 2023-11-18 17:29_

---

_Comment by @zanieb on 2023-11-18 18:14_

Thanks for the context Eric!

This isn't part of Ruff's formatter — it will never change the semantics of the code. 

This is a fix for rule removing unnecessary `pass` statements which was recently expanded to include ellipses (`...`). If a function has a docstring, there is no need for a `pass` or `...` for it to be syntactically valid. Should Pyright be treating a function with no expressions in its body as the default implementation? Is that part of the protocol specification or is that just what you've implemented?

Regardless, I think we should add a special exemption to this lint rule in Ruff. 

---

_Comment by @zanieb on 2023-11-18 18:17_

It looks like mypy (1.7.0) does not raise an error for this

```python
from typing import Protocol


class Repro(Protocol):
    def foo(self) -> str:
        """docblock"""
```

---

_Comment by @erictraut on 2023-11-18 18:26_

> Is that part of the protocol specification or is that just what you've implemented?

The protocol spec doesn't specify this, nor do any other parts of the typing spec. Pyright's treatment of `...` as a placeholder is consistent with how an ellipsis is used elsewhere in the language and typing spec.

Mypy's treatment of `...` in function bodies is inconsistent. It treats `...` as a placeholder in protocols but not in regular classes. Mypy's behavior has also [changed over time](https://microsoft.github.io/pyright/#/mypy-comparison?id=ellipsis-in-function-body). Pyright's behavior has been consistent and principled. I'm not inclined to change it because this would be disruptive to pyright users who rely on the current behavior.

> This is a fix for rule removing unnecessary `pass` statements which was recently expanded to include ellipses (...).

Ah, I see. Thanks for the clarification. Yes, I agree that it would be good to add an exemption for this case. The `...` is not extraneous in this situation.

---

_Label `bug` added by @charliermarsh on 2023-11-18 23:17_

---

_Comment by @charliermarsh on 2023-11-18 23:22_

Thanks @erictraut! Does this apply anywhere outside of `Protocol` methods? Should be an easy fix.

---

_Comment by @erictraut on 2023-11-18 23:29_

It also applies to abstract methods (those decorated with `@abc.abstractmethod`) within an abstract class. Protocols and abstract classes are closely related.

> Should be an easy fix.

Great to hear!

---

_Comment by @charliermarsh on 2023-11-18 23:37_

Okay great, thanks Eric!

---

_Assigned to @charliermarsh by @charliermarsh on 2023-11-18 23:41_

---

_Comment by @charliermarsh on 2023-11-18 23:41_

I can take this one since it's my regression :)

---

_Referenced in [astral-sh/ruff#8769](../../astral-sh/ruff/pulls/8769.md) on 2023-11-19 14:50_

---

_Closed by @charliermarsh on 2023-11-19 15:05_

---

_Referenced in [astral-sh/ruff#9840](../../astral-sh/ruff/issues/9840.md) on 2024-02-05 18:50_

---

_Referenced in [astral-sh/ruff#10358](../../astral-sh/ruff/issues/10358.md) on 2024-03-12 14:23_

---

_Comment by @rsokl on 2024-03-12 14:41_

> Does this apply anywhere outside of Protocol methods?

This also applies for stubs defined inside `if TYPE_CHECKING` clauses. See https://github.com/astral-sh/ruff/issues/10358

---

_Referenced in [astral-sh/ruff#10538](../../astral-sh/ruff/issues/10538.md) on 2024-03-25 14:20_

---

_Referenced in [pypa/setuptools#4192](../../pypa/setuptools/pulls/4192.md) on 2024-08-21 14:59_

---

_Referenced in [pylint-dev/pylint#9319](../../pylint-dev/pylint/issues/9319.md) on 2024-10-27 20:56_

---
