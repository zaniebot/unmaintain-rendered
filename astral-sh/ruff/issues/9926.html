<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Discrepancy between `format` and `check` for a long string literal - astral-sh/ruff #9926</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Discrepancy between <code>format</code> and <code>check</code> for a long string literal</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/ruff/issues/9926">#9926</a>
        opened by <a href="https://github.com/fjarri">@fjarri</a>
        on 2024-02-10 21:54
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/fjarri">@fjarri</a></div>
            <div class="timeline-body"><p>Ruff version: 0.2.1</p>
<p>Consider the following code:</p>
<pre><code>a = (
    &quot;very very very very very very very very very very very very very very very very very very long line&quot;,
)
</code></pre>
<pre><code>&gt; ruff check --select E
t.py:2:89: E501 Line too long (106 &gt; 88)
Found 1 error.
&gt; ruff format
1 file left unchanged
</code></pre>
<p>So <code>ruff format</code> doesn&#x27;t find anything to fix, but <code>ruff check</code> still complains about the formatting. Is it intentional? I feel like these two commands should use the same rules when deciding what is a formatting error. But I understand the current approach too (if it was planned) - it&#x27;s hard to automatically fix that long line; one can split it in two, but the position of splitting can&#x27;t be chosen without understanding what the literal contains.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/fjarri">@fjarri</a> on 2024-02-10 22:01</div>
            <div class="timeline-body"><p>Actually, there is a case where a reformatting can be applied to fix the issue, but isn&#x27;t.</p>
<pre><code>a = {
    &quot;key&quot;: &quot;very very very very very very very very very very very very very long line  &quot;
}
</code></pre>
<p><code>ruff format</code> does not change it, and <code>ruff check</code> complains about the long line (89 characters). But it can be rewritten as</p>
<pre><code>a = {
    &quot;key&quot;: (
        &quot;very very very very very very very very very very very very very long line  &quot;
    )
}
</code></pre>
<p>Which puts it within 88 characters.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-02-11 00:08</div>
            <div class="timeline-body"><p>Ah yeah, this is intentional and it&#x27;s discussed a bit in the <a href="https://docs.astral.sh/ruff/formatter/#conflicting-lint-rules">linter-formatter compatibility</a> section of the docs. In short, the formatter treats <code>--line-length</code> as a preference such that it attempts to format code to adhere to the line length but does not <em>guarantee</em> it, whereas the linter treats it as a rule (with a few exceptions, e.g., for URLs and other unsplittable text). In practice, this is most obvious for comments and documentation (which can exceed the line length, but the formatter won&#x27;t touch), but can also impact long strings and long identifiers.</p>
<p>Your second comment may be related to <a href="https://github.com/astral-sh/ruff/issues/8438">astral-sh/ruff#8438</a> which were some changes we considered making to expression formatting but decided to revisit holistically before making further changes -- though @MichaReiser would be able to say for sure whether he&#x27;d expect that reformatting to happen today in latest Ruff (or not).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">formatter</span> added by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-02-11 00:08</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-02-11 09:39</div>
            <div class="timeline-body"><pre><code>a = {
    &quot;key&quot;: (
        &quot;very very very very very very very very very very very very very long line  &quot;
    )
}
</code></pre>
<p>Ruff doesn&#x27;t parenthesize long dict values. Black considers parenthesizing long dictionary values, but this is a <a href="https://black.readthedocs.io/en/stable/the_black_code_style/future_style.html#improved-parentheses-management-in-dicts">preview style</a>. Parenthesizing values in expression positions sets a new precedence in Black&#x27;s style guide and is something that should be considered carefully (see <a href="https://github.com/psf/black/issues/4123">my feedback on Black&#x27;s preview style</a>).</p>
<p>Parenthesizing values that can&#x27;t be split further is an option. It raises the question if the parentheses should also be added if the string, when parenthesized, doesn&#x27;t fit:</p>
<pre><code>a = {
    &quot;key&quot;: (
        &quot;very very very very very very very very very very very very very long long long long line  &quot;
    )
}
</code></pre>
<p>IMO, I would always parenthesize it because it can reduce the amount that the string exceeds the line length limit (not guaranteed). However, this &quot;optimisation&quot; is currently implemented for assignments where the string only gets parenthesized if it makes it fit on the line. Unfortunately, this style has a larger impact on runtime performance because, in the worst case, the formatter needs to consider 3 layouts for every string:</p>
<ul>
<li>unparenthesized</li>
<li>parenthesized</li>
<li>fall-back to unparenthesized</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/CarlGWatts">@CarlGWatts</a> on 2024-02-21 20:09</div>
            <div class="timeline-body"><p>If there is a long string key and a long string value in a dict literal, <code>ruff format</code> won&#x27;t insert a newline after the &quot;:&quot; in a dict literal even if that means the line exceeds the max line length.</p>
<pre><code>{
    &quot;blah blah blah blah blah blah blah blah blah blah blah blah blah blah blah&quot;: &quot;blah blah blah blah blah blah blah blah blah blah blah blah blah blah blah&quot;
}
</code></pre>
<p>In fact, if there is a newline after the &quot;:&quot; in a dict literal, ruff format will remove that newline <strong>even if that makes the line exceed the max line length</strong>.</p>
<p>I consider both of those bugs in <code>ruff format</code></p>
<p>The python formatter built into PyCharm does the correct thing and inserts a newline after the &quot;:&quot; if necessary to keep the line under the max line length.</p>
<pre><code>{
    &quot;blah blah blah blah blah blah blah blah blah blah blah blah blah blah blah&quot;:
        &quot;blah blah blah blah blah blah blah blah blah blah blah blah blah blah blah&quot;
}
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/gaborbernat">@gaborbernat</a> on 2024-02-21 21:46</div>
            <div class="timeline-body"><p>I&#x27;m running into the much more simple case of:</p>
<pre><code>-            line = f&quot;{arg_match} {line[len(arg_match):]}&quot;
+            line = f&quot;{arg_match} {line[len(arg_match) :]}&quot;
</code></pre>
<p>Where the diff is formatter the first, and check the second... https://results.pre-commit.ci/run/github/68465360/1708361725.A80kgi75QACdOne_exTHUA @MichaReiser is this a valid bug?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-02-22 13:49</div>
            <div class="timeline-body"><p>@gaborbernat yes, this is a bug (with the lint rule) and tracked in <a href="https://github.com/astral-sh/ruff/issues/10041">astral-sh/ruff#10041</a>#issuecomment-1955916714</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-02-23 09:59</div>
            <div class="timeline-body"><p>@gaborbernat I&#x27;m trying to reproduce your diff, but I&#x27;m struggling to understand it. What I understand is that.</p>
<ul>
<li>The formatter produces the second output (<code>+</code>)</li>
<li>The linter fix produces the first output (<code>-</code>)</li>
</ul>
<p>That the fix&#x27;s formatting doesn&#x27;t precisely matches the formatter&#x27;s isn&#x27;t intended but accepted. We have plans to format all fixes automatically, but we aren&#x27;t today. That&#x27;s why we recommend running <code>ruff check --fix</code> before <code>ruff format</code>, so that the formatter formats all fixes (there are other, more involved fixes that also don&#x27;t match the formatter&#x27;s output).</p>
<p>We don&#x27;t intend to make the <code>E203</code> fix fully formatter compatible (the check should be compatible, but not the fix). That would require re-implementing the entire formatter logic. In general, we advise disabling stylistic lint rules if you use the formatter because these lints are redundant to the formatter, and the formatter gives you autofixes for all errors. We mainly offer stylistic lints for users who don&#x27;t want to or can&#x27;t use our formatter but still want to enforce some stylistic rules. With the caveat that they may need to manually format some fixes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">style</span> added by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-02-23 21:01</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/gaborbernat">@gaborbernat</a> on 2024-02-23 22:09</div>
            <div class="timeline-body"><p>@henryiii told me the opposite, that the formatter should run first and then the checker because the checker is guaranteed to keep the formatters style...</p>
<blockquote>
<p>We don&#x27;t intend to make the <code>E203</code> fix fully formatter compatible (the check should be compatible, but not the fix). That would require re-implementing the entire formatter logic. In general, we advise disabling stylistic lint rules if you use the formatter because these lints are redundant to the formatter, and the formatter gives you autofixes for all errors</p>
</blockquote>
<p>I don&#x27;t want to manually define a lot of stylistic checks one by one. Do you have a group alias for these?  So I can add to the <code>ignore</code> something like <code>FORMATTER</code> to ignore all such rules?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/henryiii">@henryiii</a> on 2024-02-23 22:14</div>
            <div class="timeline-body"><p>Where did I say that? That sounds reversed from what I was told by @charliermarsh and I think I always put it, the formatter is guaranteed to not introduce new failing checks, but the checker doesn&#x27;t format its output.</p>
<p>https://github.com/pypa/build/blob/9ceb49db39d81d5e7efc50a371e4612323fbdb80/.pre-commit-config.yaml#L35-L37 for example, follows that. As does https://learn.scientific-python.org/development/guides/style/#format (with &quot;ruff would go here&quot;).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/gaborbernat">@gaborbernat</a> on 2024-02-23 22:16</div>
            <div class="timeline-body"><p>Perhaps I&#x27;ve read the opposite but is what I remembered ðŸ˜…</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-02-23 22:18</div>
            <div class="timeline-body"><blockquote>
<p>I don&#x27;t want to manually define a lot of stylistic checks one by one. Do you have a group alias for these? So I can add to the ignore something like FORMATTER to ignore all such rules?</p>
</blockquote>
<p>Unfortunately not yet but we plan to change this with <a href="https://github.com/astral-sh/ruff/issues/1774">astral-sh/ruff#1774</a></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/gaborbernat">@gaborbernat</a> on 2024-02-24 21:24</div>
            <div class="timeline-body"><blockquote>
<blockquote>
<p>I don&#x27;t want to manually define a lot of stylistic checks one by one. Do you have a group alias for these? So I can add to the ignore something like FORMATTER to ignore all such rules?</p>
</blockquote>
<p>Unfortunately not yet but we plan to change this with <a href="https://github.com/astral-sh/ruff/issues/1774">astral-sh/ruff#1774</a></p>
</blockquote>
<p>Anything we can do to help there?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/gaborbernat">@gaborbernat</a> on 2024-02-24 21:24</div>
            <div class="timeline-body"><blockquote>
<blockquote>
<p>I don&#x27;t want to manually define a lot of stylistic checks one by one. Do you have a group alias for these? So I can add to the ignore something like FORMATTER to ignore all such rules?</p>
</blockquote>
<p>Unfortunately not yet but we plan to change this with <a href="https://github.com/astral-sh/ruff/issues/1774">astral-sh/ruff#1774</a></p>
</blockquote>
<p>Anything we can do to help there?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-02-25 09:17</div>
            <div class="timeline-body"><blockquote>
<p>Anything we can do to help there?</p>
</blockquote>
<p>Not yet, because we haven&#x27;t started yet. But we plan to pick this up soon (I think @AlexWaygood would be the perfect person to do it) and your feedback on the categorization would be extremely valuable.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 18:48:50 UTC
    </footer>
</body>
</html>
