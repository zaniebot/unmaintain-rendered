<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ruff inserts `&quot;id&quot;: null` to notebook cells and breaks GitHub notebook viewer - astral-sh/ruff #6834</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Ruff inserts <code>&quot;id&quot;: null</code> to notebook cells and breaks GitHub notebook viewer</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/issues/6834">#6834</a>
        opened by <a href="https://github.com/harupy">@harupy</a>
        on 2023-08-24 02:53
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/harupy">@harupy</a> on 2023-08-24 02:53</div>
            <div class="timeline-body"><!--
Thank you for taking the time to report an issue! We're glad to have you involved with Ruff.

If you're filing a bug report, please consider including the following information:

* A minimal code snippet that reproduces the bug.
* The command you invoked (e.g., `ruff /path/to/file.py --fix`), ideally including the `--isolated` flag.
* The current Ruff settings (any relevant sections from your `pyproject.toml`).
* The current Ruff version (`ruff --version`).
-->

<h2>Summary</h2>
<p>https://github.com/harupy/mlflow/blob/3f1650db853d2c61ac0cdb0035be91b10f131859/examples/h2o/random_forest.ipynb</p>
<img width="908" alt="image" src="https://github.com/astral-sh/ruff/assets/17039389/2caaf341-f2f5-4c0a-9018-faa472aeaff8">

<p>https://github.com/harupy/mlflow/commit/3f1650db853d2c61ac0cdb0035be91b10f131859: a commit that replicates what ruff does:</p>
<p>Without <code>&quot;id&quot;: null</code>, the notebook renders fine:
https://github.com/harupy/mlflow/blob/dab36dc4fd6ac6e442bb78c016e7813ced8c0a21/examples/h2o/random_forest.ipynb</p>
<img width="908" alt="image" src="https://github.com/astral-sh/ruff/assets/17039389/1ffe3727-92da-468a-81e4-bb24a6b6847c">

<h2>How to reproduce</h2>
<pre><code class="language-sh"># Notebook without id
&gt; cat a.ipynb
{
 &quot;cells&quot;: [
  {
   &quot;cell_type&quot;: &quot;code&quot;,
   &quot;execution_count&quot;: null,
   &quot;metadata&quot;: {},
   &quot;outputs&quot;: [],
   &quot;source&quot;: [
    &quot;import math\n&quot;,
    &quot;import os\n&quot;,
    &quot;\n&quot;,
    &quot;math.pi&quot;
   ]
  }
 ],
 &quot;metadata&quot;: {
  &quot;kernelspec&quot;: {
   &quot;display_name&quot;: &quot;Python (ruff)&quot;,
   &quot;language&quot;: &quot;python&quot;,
   &quot;name&quot;: &quot;ruff&quot;
  },
  &quot;language_info&quot;: {
   &quot;codemirror_mode&quot;: {
    &quot;name&quot;: &quot;ipython&quot;,
    &quot;version&quot;: 3
   },
   &quot;file_extension&quot;: &quot;.py&quot;,
   &quot;mimetype&quot;: &quot;text/x-python&quot;,
   &quot;name&quot;: &quot;python&quot;,
   &quot;nbconvert_exporter&quot;: &quot;python&quot;,
   &quot;pygments_lexer&quot;: &quot;ipython3&quot;,
   &quot;version&quot;: &quot;3.11.3&quot;
  }
 },
 &quot;nbformat&quot;: 4,
 &quot;nbformat_minor&quot;: 5
}

# Run ruff
&gt; cargo run -p ruff_cli -- check --fix --no-cache a.ipynb
    Finished dev [unoptimized + debuginfo] target(s) in 0.07s
     Running `target/debug/ruff check --fix --no-cache a.ipynb`
Found 1 error (1 fixed, 0 remaining).

# Check
&gt; cat a.ipynb
{
 &quot;cells&quot;: [
  {
   &quot;cell_type&quot;: &quot;code&quot;,
   &quot;execution_count&quot;: null,
   &quot;id&quot;: null,
   &quot;metadata&quot;: {},
   &quot;outputs&quot;: [],
   &quot;source&quot;: [
    &quot;import math\n&quot;,
    &quot;\n&quot;,
    &quot;math.pi&quot;
   ]
  }
 ],
 &quot;metadata&quot;: {
  &quot;kernelspec&quot;: {
   &quot;display_name&quot;: &quot;Python (ruff)&quot;,
   &quot;language&quot;: &quot;python&quot;,
   &quot;name&quot;: &quot;ruff&quot;
  },
  &quot;language_info&quot;: {
   &quot;codemirror_mode&quot;: {
    &quot;name&quot;: &quot;ipython&quot;,
    &quot;version&quot;: 3
   },
   &quot;file_extension&quot;: &quot;.py&quot;,
   &quot;mimetype&quot;: &quot;text/x-python&quot;,
   &quot;name&quot;: &quot;python&quot;,
   &quot;nbconvert_exporter&quot;: &quot;python&quot;,
   &quot;pygments_lexer&quot;: &quot;ipython3&quot;,
   &quot;version&quot;: &quot;3.11.3&quot;
  }
 },
 &quot;nbformat&quot;: 4,
 &quot;nbformat_minor&quot;: 5
}
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "Ruff inserts `id: null` to notebook cells which breaks the GitHub notebook viewer" to "Ruff inserts `"id": null` to notebook cells which breaks the GitHub notebook viewer" by @harupy on 2023-08-24 02:54</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/harupy">@harupy</a> on 2023-08-24 02:55</div>
            <div class="timeline-body"><p>Can we skip serializing <code>id</code> if it's None?</p>
<pre><code class="language-diff">diff --git a/crates/ruff/src/jupyter/schema.rs b/crates/ruff/src/jupyter/schema.rs
index b6f9ed3c4..17b03e474 100644
--- a/crates/ruff/src/jupyter/schema.rs
+++ b/crates/ruff/src/jupyter/schema.rs
@@ -120,6 +120,7 @@ pub struct RawCell {
     /// Technically, id isn't required (it's not even present) in schema v4.0 through v4.4, but
     /// it's required in v4.5. Main issue is that pycharm creates notebooks without an id
     /// &lt;https://youtrack.jetbrains.com/issue/PY-59438/Jupyter-notebooks-created-with-PyCharm-are-missing-the-id-field-in-cells-in-the-.ipynb-json&gt;
+    #[serde(skip_serializing_if = &quot;Option::is_none&quot;)]
     pub id: Option&lt;String&gt;,
     /// Cell-level metadata.
     pub metadata: Value,
@@ -135,6 +136,7 @@ pub struct MarkdownCell {
     /// Technically, id isn't required (it's not even present) in schema v4.0 through v4.4, but
     /// it's required in v4.5. Main issue is that pycharm creates notebooks without an id
     /// &lt;https://youtrack.jetbrains.com/issue/PY-59438/Jupyter-notebooks-created-with-PyCharm-are-missing-the-id-field-in-cells-in-the-.ipynb-json&gt;
+    #[serde(skip_serializing_if = &quot;Option::is_none&quot;)]
     pub id: Option&lt;String&gt;,
     /// Cell-level metadata.
     pub metadata: Value,
@@ -150,6 +152,7 @@ pub struct CodeCell {
     /// Technically, id isn't required (it's not even present) in schema v4.0 through v4.4, but
     /// it's required in v4.5. Main issue is that pycharm creates notebooks without an id
     /// &lt;https://youtrack.jetbrains.com/issue/PY-59438/Jupyter-notebooks-created-with-PyCharm-are-missing-the-id-field-in-cells-in-the-.ipynb-json&gt;
+    #[serde(skip_serializing_if = &quot;Option::is_none&quot;)]
     pub id: Option&lt;String&gt;,
     /// Cell-level metadata.
     pub metadata: Value,
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "Ruff inserts `"id": null` to notebook cells which breaks the GitHub notebook viewer" to "Ruff inserts `"id": null` to notebook cells which breaks GitHub notebook viewer" by @harupy on 2023-08-24 03:09</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "Ruff inserts `"id": null` to notebook cells which breaks GitHub notebook viewer" to "Ruff inserts `"id": null` to notebook cells and breaks GitHub notebook viewer" by @harupy on 2023-08-24 03:09</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/harupy">@harupy</a> on 2023-08-24 03:18</div>
            <div class="timeline-body"><p>Found this issue while I was working on https://github.com/mlflow/mlflow/pull/9445</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-08-24 03:27</div>
            <div class="timeline-body"><p>@konstin - Do you know?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/harupy">@harupy</a> on 2023-08-24 03:29</div>
            <div class="timeline-body"><p>Tried <code>nbviewer</code> as well:</p>
<p>https://nbviewer.org/github/harupy/mlflow/blob/3f1650db853d2c61ac0cdb0035be91b10f131859/examples/h2o/random_forest.ipynb</p>
<img width="1198" alt="image" src="https://github.com/astral-sh/ruff/assets/17039389/05d87072-018a-497c-96ba-9bcb113e418f">

</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/harupy">@harupy</a> on 2023-08-24 03:35</div>
            <div class="timeline-body"><p><code>nbconvert</code> fails to convert a notebook with <code>id=null</code>.</p>
<pre><code>&gt; jupyter nbconvert --to html a.ipynb
[NbConvertApp] Converting notebook a.ipynb to html
[NbConvertApp] ERROR | Notebook JSON is invalid: None is not of type 'string'

Failed validating 'type' in code_cell['properties']['id']:

On instance['cells'][0]['id']:
None
[NbConvertApp] ERROR | Notebook is invalid after preprocessor &lt;nbconvert.preprocessors.tagremove.TagRemovePreprocessor object at 0x7f4bb237bf40&gt;
Traceback (most recent call last):
  File &quot;/home/haru/miniconda3/envs/ruff/bin/jupyter-nbconvert&quot;, line 8, in &lt;module&gt;
    sys.exit(main())
  File &quot;/home/haru/miniconda3/envs/ruff/lib/python3.10/site-packages/jupyter_core/application.py&quot;, line 285, in launch_instance
    return super().launch_instance(argv=argv, **kwargs)
  File &quot;/home/haru/miniconda3/envs/ruff/lib/python3.10/site-packages/traitlets/config/application.py&quot;, line 1043, in launch_instance
    app.start()
  File &quot;/home/haru/miniconda3/envs/ruff/lib/python3.10/site-packages/nbconvert/nbconvertapp.py&quot;, line 410, in start
    self.convert_notebooks()
  File &quot;/home/haru/miniconda3/envs/ruff/lib/python3.10/site-packages/nbconvert/nbconvertapp.py&quot;, line 585, in convert_notebooks
    self.convert_single_notebook(notebook_filename)
  File &quot;/home/haru/miniconda3/envs/ruff/lib/python3.10/site-packages/nbconvert/nbconvertapp.py&quot;, line 551, in convert_single_notebook
    output, resources = self.export_single_notebook(
  File &quot;/home/haru/miniconda3/envs/ruff/lib/python3.10/site-packages/nbconvert/nbconvertapp.py&quot;, line 477, in export_single_notebook
    output, resources = self.exporter.from_filename(
  File &quot;/home/haru/miniconda3/envs/ruff/lib/python3.10/site-packages/nbconvert/exporters/templateexporter.py&quot;, line 389, in from_filename
    return super().from_filename(filename, resources, **kw)  # type:ignore
  File &quot;/home/haru/miniconda3/envs/ruff/lib/python3.10/site-packages/nbconvert/exporters/exporter.py&quot;, line 201, in from_filename
    return self.from_file(f, resources=resources, **kw)
  File &quot;/home/haru/miniconda3/envs/ruff/lib/python3.10/site-packages/nbconvert/exporters/templateexporter.py&quot;, line 395, in from_file
    return super().from_file(file_stream, resources, **kw)  # type:ignore
  File &quot;/home/haru/miniconda3/envs/ruff/lib/python3.10/site-packages/nbconvert/exporters/exporter.py&quot;, line 220, in from_file
    return self.from_notebook_node(
  File &quot;/home/haru/miniconda3/envs/ruff/lib/python3.10/site-packages/nbconvert/exporters/html.py&quot;, line 259, in from_notebook_node
    html, resources = super().from_notebook_node(nb, resources, **kw)
  File &quot;/home/haru/miniconda3/envs/ruff/lib/python3.10/site-packages/nbconvert/exporters/templateexporter.py&quot;, line 411, in from_notebook_node
    nb_copy, resources = super().from_notebook_node(nb, resources, **kw)
  File &quot;/home/haru/miniconda3/envs/ruff/lib/python3.10/site-packages/nbconvert/exporters/exporter.py&quot;, line 154, in from_notebook_node
    nb_copy, resources = self._preprocess(nb_copy, resources)
  File &quot;/home/haru/miniconda3/envs/ruff/lib/python3.10/site-packages/nbconvert/exporters/exporter.py&quot;, line 354, in _preprocess
    self._validate_preprocessor(nbc, preprocessor)
  File &quot;/home/haru/miniconda3/envs/ruff/lib/python3.10/site-packages/nbconvert/exporters/exporter.py&quot;, line 321, in _validate_preprocessor
    nbformat.validate(nbc, relax_add_props=True)
  File &quot;/home/haru/miniconda3/envs/ruff/lib/python3.10/site-packages/nbformat/validator.py&quot;, line 502, in validate
    raise error
nbformat.validator.NotebookValidationError: None is not of type 'string'

Failed validating 'type' in code_cell['properties']['id']:

On instance['cells'][0]['id']:
None
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @MichaReiser on 2023-08-24 06:18</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/harupy">@harupy</a> on 2023-08-24 07:30</div>
            <div class="timeline-body"><p>Can I fix this (if this is really a bug)?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-08-24 07:34</div>
            <div class="timeline-body"><p>Sure. I would be interested in @konstin's input because he has experience roundtripping JSON.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2023-08-24 08:02</div>
            <div class="timeline-body"><p>That's an interesting example because according to the spec (<a href="https://nbformat.readthedocs.io/en/latest/format_description.html#cell-ids">html</a>, <a href="https://github.com/jupyter/enhancement-proposals/blob/master/62-cell-id/cell-id.md#required-field">RFC</a>, <a href="https://github.com/jupyter/nbformat/blob/a3e787dccbf629c8cbae46f79e74d53ded8b53a9/nbformat/v4/nbformat.v4.5.schema.json#L192">schema</a>), <code>id</code> is required field in every cell in a jupyter notebook 4.5+, i.e. the notebook posted above is technically invalid. From <a href="https://github.com/jupyter/enhancement-proposals/blob/master/62-cell-id/cell-id.md#required-field">JEP 62: required field</a>):</p>
<blockquote>
<p>&quot;The id field in cells would <em>always</em> be <strong>required</strong> for any future nbformat versions (4.5+). In contrast to an optional field, the required field avoids applications having to conditionally check if an id is present or not.&quot;</p>
</blockquote>
<p>The notebook still works because tools want to be backwards compatible with the &lt;4.5 format and generally don't validate that their input is valid wrt to the specified version. I believe we shouldn't emit invalid notebooks and instead <a href="https://github.com/jupyter/enhancement-proposals/blob/master/62-cell-id/cell-id.md#updating-older-formats">generate UUIDs</a> (or apply one of the other <a href="https://github.com/jupyter/enhancement-proposals/blob/master/62-cell-id/cell-id.md#case-loading-notebook-without-cell-id">suggested strategies</a>) if we see a notebook version â‰¥4.5. We should still use <code>#[serde(skip_serializing_if = &quot;Option::is_none&quot;)]</code> for &lt;4.5 notebooks which does not allow <code>id</code>. From <a href="https://github.com/jupyter/enhancement-proposals/blob/master/62-cell-id/cell-id.md#questions">JEP 62: Questions</a>:</p>
<blockquote>
<ol start="5">
<li>How should loaders handle notebook loading errors?</li>
</ol>
<p>On notebook load, if an older format update and fill in ids. If an invalid id format for a 4.5+ file, then raise a validation error like we do for other schema errors. We could auto-correct for bad ids if that's deemed appropriate.</p>
</blockquote>
<p>This case i think would be only applicable if we want to increase the nbformat version on write (i think we don't want to do that):</p>
<blockquote>
<ol start="7">
<li>So if nbformat &gt;= 4.5 loads in a pre 4.5 notebook, then a cell ID would be generated and added to each cell?</li>
</ol>
<p>Yes.</p>
</blockquote>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/harupy">@harupy</a> on 2023-08-24 11:13</div>
            <div class="timeline-body"><p>@konstin Thanks for the comment. This notebook was created 4 years ago. Maybe that's the reason why cell ids are missing.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/harupy">@harupy</a> on 2023-08-24 11:22</div>
            <div class="timeline-body"><p>Can ruff just fix code, and not touch cell ids?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2023-08-24 11:31</div>
            <div class="timeline-body"><blockquote>
<p>This notebook was created 4 years ago. Maybe that's the reason why cell ids are missing.</p>
</blockquote>
<p>It's definitely really easy to miss as a tool author! (i mean, we also missed that)</p>
<blockquote>
<p>Can ruff just fix code, and not touch cell ids?</p>
</blockquote>
<p>Not really, i'm afraid. If ruff were to write a notebook with version 4.5 and no cell ids, ruff would produce an invalid notebook with respect to the schema, which we shouldn't do. Downgrading the version on writing is also not an option because the notebook might use other 4.5+ features. The <a href="https://github.com/jupyter/enhancement-proposals/blob/master/62-cell-id/cell-id.md#required-field">JEP</a> is pretty clear that you just create some ids (with a preference towards UUIDs), so i'd do that.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/harupy">@harupy</a> on 2023-08-24 11:58</div>
            <div class="timeline-body"><p>The notebook was created with nbformat 4.2 in Python 2:</p>
<pre><code> &quot;metadata&quot;: {
  &quot;kernelspec&quot;: {
   &quot;display_name&quot;: &quot;Python 2&quot;,
   &quot;language&quot;: &quot;python&quot;,
   &quot;name&quot;: &quot;python2&quot;
  },
  &quot;language_info&quot;: {
   &quot;codemirror_mode&quot;: {
    &quot;name&quot;: &quot;ipython&quot;,
    &quot;version&quot;: 2
   },
   &quot;file_extension&quot;: &quot;.py&quot;,
   &quot;mimetype&quot;: &quot;text/x-python&quot;,
   &quot;name&quot;: &quot;python&quot;,
   &quot;nbconvert_exporter&quot;: &quot;python&quot;,
   &quot;pygments_lexer&quot;: &quot;ipython2&quot;,
   &quot;version&quot;: &quot;2.7.15&quot;
  }
 },
 &quot;nbformat&quot;: 4,
 &quot;nbformat_minor&quot;: 2
</code></pre>
<p>https://raw.githubusercontent.com/harupy/mlflow/3f1650db853d2c61ac0cdb0035be91b10f131859/examples/h2o/random_forest.ipynb</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2023-08-24 12:02</div>
            <div class="timeline-body"><p>Sorry, i forgot to check the actual notebook and only looked at the <code>cat a.ipynb</code>. For the case of random_forest.ipynb, yes, we should definitely use <code>#[serde(skip_serializing_if = &quot;Option::is_none&quot;)]</code> and omit adding <code>id</code> fields.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/harupy">@harupy</a> on 2023-08-24 12:12</div>
            <div class="timeline-body"><p>Filed #6851</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @konstin on 2023-08-24 13:20</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 11:31:06 UTC
    </footer>
</body>
</html>
