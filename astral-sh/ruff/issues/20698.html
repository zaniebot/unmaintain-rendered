<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PT018 fix should be safe instead of unsafe generally, and unsafe with comments instead of suppressed - astral-sh/ruff #20698</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>PT018 fix should be safe instead of unsafe generally, and unsafe with comments instead of suppressed</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/ruff/issues/20698">#20698</a>
        opened by <a href="https://github.com/dscorbett">@dscorbett</a>
        on 2025-10-04 13:07
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dscorbett">@dscorbett</a></div>
            <div class="timeline-body">Summary
<p>The fix for <a href="https://docs.astral.sh/ruff/rules/pytest-composite-assertion/"><code>pytest-composite-assertion</code> (PT018)</a> is marked unsafe, but it doesnâ€™t change behavior with any combination of truthy, falsy, or exception-raising expressions, so it should be safe. <a href="https://play.ruff.rs/e4bf6235-3d35-40c8-a862-932f8b340810">Example</a>:</p>
<pre><code>$ cat &gt;pt018_1.py &lt;&lt;&#x27;# EOF&#x27;
try:
    assert True and True
except Exception as e:
    print(f&quot;{type(e).__name__}:{e}&quot;)

try:
    assert True and False
except Exception as e:
    print(f&quot;{type(e).__name__}:{e}&quot;)

try:
    assert True and ~0j
except Exception as e:
    print(f&quot;{type(e).__name__}:{e}&quot;)

try:
    assert False and True
except Exception as e:
    print(f&quot;{type(e).__name__}:{e}&quot;)

try:
    assert False and False
except Exception as e:
    print(f&quot;{type(e).__name__}:{e}&quot;)

try:
    assert False and ~0j
except Exception as e:
    print(f&quot;{type(e).__name__}:{e}&quot;)

try:
    assert ~0j and True
except Exception as e:
    print(f&quot;{type(e).__name__}:{e}&quot;)

try:
    assert ~0j and False
except Exception as e:
    print(f&quot;{type(e).__name__}:{e}&quot;)

try:
    assert ~0j and ~0j
except Exception as e:
    print(f&quot;{type(e).__name__}:{e}&quot;)

try:
    assert not (True or True)
except Exception as e:
    print(f&quot;{type(e).__name__}:{e}&quot;)

try:
    assert not (True or False)
except Exception as e:
    print(f&quot;{type(e).__name__}:{e}&quot;)

try:
    assert not (True or ~0j)
except Exception as e:
    print(f&quot;{type(e).__name__}:{e}&quot;)

try:
    assert not (False or True)
except Exception as e:
    print(f&quot;{type(e).__name__}:{e}&quot;)

try:
    assert not (False or False)
except Exception as e:
    print(f&quot;{type(e).__name__}:{e}&quot;)

try:
    assert not (False or ~0j)
except Exception as e:
    print(f&quot;{type(e).__name__}:{e}&quot;)

try:
    assert not (~0j or True)
except Exception as e:
    print(f&quot;{type(e).__name__}:{e}&quot;)

try:
    assert not (~0j or False)
except Exception as e:
    print(f&quot;{type(e).__name__}:{e}&quot;)

try:
    assert not (~0j or ~0j)
except Exception as e:
    print(f&quot;{type(e).__name__}:{e}&quot;)
# EOF

$ python pt018_1.py | md5sum
78395b16351cee36624f637cee853666  -

$ ruff --isolated check pt018_1.py --select PT018 --unsafe-fixes --fix
Found 18 errors (18 fixed, 0 remaining).

$ python pt018_1.py | md5sum
78395b16351cee36624f637cee853666  -
</code></pre>
<p>The fix is suppressed when there are comments within the asserted expression, in which case it should instead be marked unsafe as in most other rules. (The fix is already marked unsafe when there is a comment at the end of the statement, which is correct.) <a href="https://play.ruff.rs/90b579c6-03ad-4c61-bedf-7cd10bb5f907">Example</a>:</p>
<pre><code>$ cat &gt;pt018_2.py &lt;&lt;&#x27;# EOF&#x27;
assert (
    # ...
    True and True
)
assert True and True  # ...
# EOF

$ ruff --isolated check pt018_2.py --select PT018 --unsafe-fixes --fix --output-format concise
pt018_2.py:1:1: PT018 Assertion should be broken down into multiple parts
Found 2 errors (1 fixed, 1 remaining).

$ cat pt018_2.py
assert (
    # ...
    True and True
)
assert True
assert True
</code></pre>
Version
<p>ruff 0.13.3 (188c0dce2 2025-10-02)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">fixes</span> added by <a href="https://github.com/ntBre">@ntBre</a> on 2025-10-06 13:14</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 18:50:29 UTC
    </footer>
</body>
</html>
