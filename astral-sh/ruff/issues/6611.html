<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Warn about incorrect formatter suppression comments - astral-sh/ruff #6611</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Warn about incorrect formatter suppression comments</h1>

    <div class="meta">
        <span class="state state-closed">Closed</span>
        <a href="https://github.com/astral-sh/ruff/issues/6611">#6611</a>
        opened by <a href="https://github.com/MichaReiser">@MichaReiser</a>
        on 2023-08-16 08:42
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-08-16 08:42</div>
            <div class="timeline-body"><p>Ruff's formatter only supports suppression comments in the following  positions (https://github.com/astral-sh/ruff/discussions/6338):</p>
<ul>
<li><code>fmt: off..fmt: on</code>: Leading or trailing statement own line comments (but e.g. not between decorators, or inside of expressions)</li>
<li><code>fmt: skip</code>: As a trailing comment of<ul>
<li>simple statements</li>
<li>decorators</li>
<li>Clause headers (everything that ends with a <code>:</code> and is followed by an indent)</li>
</ul>
</li>
</ul>
<p>We should warn if one of these comments is used in an incorrect place and, ideally, provide a code fix that moves the comment to the right position so that it suppresses the formatting of the attributed node.</p>
<p>We could also warn about <code>fmt: off</code> comments that miss a corresponding <code>fmt: on</code> comment. Omitting the <code>fmt: on</code> is valid according to the range suppression definition but can be caused by refactors where you accidentally delete the <code>fmt: on</code> comment (or even a ruff fix)</p>
<h2>Implementation</h2>
<p>That's where things get interesting. We can either implement this as part of the formatter OR the linter. The formatter seems a good fit because it is inherently a formatter problem. The formatter has extensive comments handling infrastructure and can track the &quot;handled&quot; suppression comments while formatting, ensuring that what the formatter does and the code warning about correct usages are perfectly in sync.</p>
<p>However, the formatter lacks the infrastructure to report diagnostics (other than a formatting diff), provide and apply code fixes, and a mechanism to opt in/opt out to these additional checks (e.g. some may prefer to only write the  <code>fmt: on</code> when absolutely necessary). From that standpoint, the linter would be a better fit and is what I prefer.</p>
<p>Us having the benefit of picking the best tool to solve problems like this instead of implementing it in the only tool that we have available (e.g. in the formatter) is a benefit of a unified toolchain. However this raises a couple of questions</p>
<ul>
<li>Should these check run as part of <code>ruff format</code> or <code>ruff check/lint</code> or both?</li>
<li>Should the incorrect <code>fmt: off</code> lint be enabled automatically when using the formatter (not an optional rule)</li>
<li>How and where should these rules be configured</li>
<li>Should these rules run even if Ruff's linter is disabled?</li>
</ul>
<p>Our <code>isort</code> implementation probably falls into the same category. We implemented it based on our linter infrastructure, even though it isn't really linting in that sense (it falls in between linting and formatting). The way Rome solved this is that it had a dedicated organize imports action in the editor. This has the advantage that a granular configuration on whether imports, code fixes, or formatting should run on save.</p>
<p><strong>Internal only</strong>: <a href="https://www.notion.so/astral-sh/Configuration-c291a149e50f438083221a65468a736f?pvs=4#53f40fda72a14e148c104c0ce7d180a1">More design notes</a></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">formatter</span> added by @MichaReiser on 2023-08-16 08:42</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone "Formatter: Beta" by @MichaReiser on 2023-08-16 08:42</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-08-16 16:04</div>
            <div class="timeline-body"><p>CC: @zanieb who's working on the CLI design</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/6845.html">astral-sh/ruff#6845</a> on 2023-08-24 09:12</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/7232.html">astral-sh/ruff#7232</a> on 2023-09-08 07:42</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Removed from milestone "Formatter: Beta" by @MichaReiser on 2023-09-15 10:06</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone "Formatter: Stable" by @MichaReiser on 2023-09-15 10:06</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../pypa/pip/pulls/12478.html">pypa/pip#12478</a> on 2024-01-15 14:30</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/pfmoore">@pfmoore</a> on 2024-01-15 16:07</div>
            <div class="timeline-body"><p>Very much looking at this from a user point of view, not an implementer point of view, I would strongly request that ruff reports any <code># fmt: off</code> directives that would be recognised by other formatters such as black, but which would be ignored by ruff. Otherwise, there's a risk when transitioning to a new formatter that code which was manually formatted will suddenly get auto-formatted without warning.</p>
<p>In practice, I would be even happier if formatters could agree on a common behaviour for when formatting directives are recognised and what they mean, so that there would be no need for a warning like this anyway. But maybe things need to mature a little before that makes sense.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @snowsignal by @snowsignal on 2024-01-29 16:46</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/9899.html">astral-sh/ruff#9899</a> on 2024-02-08 19:25</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @snowsignal on 2024-02-28 19:21</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:34:51 UTC
    </footer>
</body>
</html>
