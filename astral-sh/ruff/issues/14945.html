<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Valgrind reports multiple memory leaks, when checking random folders with red_knot - astral-sh/ruff #14945</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Valgrind reports multiple memory leaks, when checking random folders with red_knot</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/issues/14945">#14945</a>
        opened by <a href="https://github.com/qarmin">@qarmin</a>
        on 2024-12-12 20:09
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/qarmin">@qarmin</a></div>
            <div class="timeline-body"><p>ruff 0.8.2+1582 (45b565cbb 2024-12-12)</p>
<p>When testing with red_knot(<code>valgrind  --leak-check=full red_knot_normal --current-directory .</code>) random directories, I see in valgrind such memory leaks</p>
<pre><code>==184012== 684,137 (1,368 direct, 682,769 indirect) bytes in 1 blocks are definitely lost in loss record 177 of 177
==184012==    at 0x4E050C5: malloc (vg_replace_malloc.c:442)
==184012==    by 0x8965A0: UnknownInlinedFun (library/std/src/sys/alloc/unix.rs:14)
==184012==    by 0x8965A0: UnknownInlinedFun (library/std/src/alloc.rs:401)
==184012==    by 0x8965A0: alloc (alloc.rs:99)
==184012==    by 0x8965A0: alloc_impl (alloc.rs:195)
==184012==    by 0x8965A0: allocate (alloc.rs:257)
==184012==    by 0x8965A0: exchange_malloc (alloc.rs:352)
==184012==    by 0x8965A0: new&lt;alloc::sync::ArcInner&lt;salsa::zalsa::Zalsa&gt;&gt; (boxed.rs:254)
==184012==    by 0x8965A0: new&lt;salsa::zalsa::Zalsa&gt; (sync.rs:391)
==184012==    by 0x8965A0: &lt;salsa::storage::Storage&lt;Db&gt; as core::default::Default&gt;::default (storage.rs:49)
==184012==    by 0x8515F6: red_knot_workspace::db::RootDatabase::new (db.rs:41)
==184012==    by 0x862DF6: run (main.rs:194)
==184012==    by 0x862DF6: red_knot::main (main.rs:126)
==184012==    by 0x8579D2: call_once&lt;fn() -&gt; red_knot::ExitStatus, ()&gt; (function.rs:250)
==184012==    by 0x8579D2: std::sys::backtrace::__rust_begin_short_backtrace (backtrace.rs:152)
==184012==    by 0x893E68: std::rt::lang_start::{{closure}} (rt.rs:195)
==184012==    by 0xE1C39C: call_once&lt;(), (dyn core::ops::function::Fn&lt;(), Output=i32&gt; + core::marker::Sync + core::panic::unwind_safe::RefUnwindSafe)&gt; (function.rs:284)
==184012==    by 0xE1C39C: do_call&lt;&amp;(dyn core::ops::function::Fn&lt;(), Output=i32&gt; + core::marker::Sync + core::panic::unwind_safe::RefUnwindSafe), i32&gt; (panicking.rs:573)
==184012==    by 0xE1C39C: try&lt;i32, &amp;(dyn core::ops::function::Fn&lt;(), Output=i32&gt; + core::marker::Sync + core::panic::unwind_safe::RefUnwindSafe)&gt; (panicking.rs:536)
==184012==    by 0xE1C39C: catch_unwind&lt;&amp;(dyn core::ops::function::Fn&lt;(), Output=i32&gt; + core::marker::Sync + core::panic::unwind_safe::RefUnwindSafe), i32&gt; (panic.rs:358)
==184012==    by 0xE1C39C: {closure#1} (rt.rs:174)
==184012==    by 0xE1C39C: do_call&lt;std::rt::lang_start_internal::{closure_env#1}, isize&gt; (panicking.rs:573)
==184012==    by 0xE1C39C: try&lt;isize, std::rt::lang_start_internal::{closure_env#1}&gt; (panicking.rs:536)
==184012==    by 0xE1C39C: catch_unwind&lt;std::rt::lang_start_internal::{closure_env#1}, isize&gt; (panic.rs:358)
==184012==    by 0xE1C39C: std::rt::lang_start_internal (rt.rs:174)
==184012==    by 0x869F6B: main (in /home/rafal/.cargo/bin/red_knot_normal)

</code></pre>
<pre><code>==184012== 40 bytes in 1 blocks are definitely lost in loss record 40 of 177
==184012==    at 0x4E050C5: malloc (vg_replace_malloc.c:442)
==184012==    by 0x8965D3: UnknownInlinedFun (library/std/src/sys/alloc/unix.rs:14)
==184012==    by 0x8965D3: UnknownInlinedFun (library/std/src/alloc.rs:401)
==184012==    by 0x8965D3: alloc (alloc.rs:99)
==184012==    by 0x8965D3: alloc_impl (alloc.rs:195)
==184012==    by 0x8965D3: allocate (alloc.rs:257)
==184012==    by 0x8965D3: exchange_malloc (alloc.rs:352)
==184012==    by 0x8965D3: new&lt;alloc::sync::ArcInner&lt;salsa::storage::Coordinate&gt;&gt; (boxed.rs:254)
==184012==    by 0x8965D3: new&lt;salsa::storage::Coordinate&gt; (sync.rs:391)
==184012==    by 0x8965D3: &lt;salsa::storage::Storage&lt;Db&gt; as core::default::Default&gt;::default (storage.rs:50)
==184012==    by 0x8515F6: red_knot_workspace::db::RootDatabase::new (db.rs:41)
==184012==    by 0x862DF6: run (main.rs:194)
==184012==    by 0x862DF6: red_knot::main (main.rs:126)
==184012==    by 0x8579D2: call_once&lt;fn() -&gt; red_knot::ExitStatus, ()&gt; (function.rs:250)
==184012==    by 0x8579D2: std::sys::backtrace::__rust_begin_short_backtrace (backtrace.rs:152)
==184012==    by 0x893E68: std::rt::lang_start::{{closure}} (rt.rs:195)
==184012==    by 0xE1C39C: call_once&lt;(), (dyn core::ops::function::Fn&lt;(), Output=i32&gt; + core::marker::Sync + core::panic::unwind_safe::RefUnwindSafe)&gt; (function.rs:284)
==184012==    by 0xE1C39C: do_call&lt;&amp;(dyn core::ops::function::Fn&lt;(), Output=i32&gt; + core::marker::Sync + core::panic::unwind_safe::RefUnwindSafe), i32&gt; (panicking.rs:573)
==184012==    by 0xE1C39C: try&lt;i32, &amp;(dyn core::ops::function::Fn&lt;(), Output=i32&gt; + core::marker::Sync + core::panic::unwind_safe::RefUnwindSafe)&gt; (panicking.rs:536)
==184012==    by 0xE1C39C: catch_unwind&lt;&amp;(dyn core::ops::function::Fn&lt;(), Output=i32&gt; + core::marker::Sync + core::panic::unwind_safe::RefUnwindSafe), i32&gt; (panic.rs:358)
==184012==    by 0xE1C39C: {closure#1} (rt.rs:174)
==184012==    by 0xE1C39C: do_call&lt;std::rt::lang_start_internal::{closure_env#1}, isize&gt; (panicking.rs:573)
==184012==    by 0xE1C39C: try&lt;isize, std::rt::lang_start_internal::{closure_env#1}&gt; (panicking.rs:536)
==184012==    by 0xE1C39C: catch_unwind&lt;std::rt::lang_start_internal::{closure_env#1}, isize&gt; (panic.rs:358)
==184012==    by 0xE1C39C: std::rt::lang_start_internal (rt.rs:174)
==184012==    by 0x869F6B: main (in /home/rafal/.cargo/bin/red_knot_normal)

</code></pre>
<p>Precompiled binary with debug symbols, updated daily - https://github.com/qarmin/Automated-Fuzzer/releases/download/Nightly/red_knot_normal.7z</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-12-12 21:34</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-12-13 07:08</div>
            <div class="timeline-body"><p>Can you try commenting out this line</p>
<p>https://github.com/astral-sh/ruff/blob/81e5830585f2538df7029c8f467511937d83afca/crates/red_knot/src/main.rs#L216</p>
<p>We intentionally &quot;leak&quot; the Database right before shutting down the CLI because it&#x27;s expensive to deallocate and we know that the process is going to end in a few ms anyway.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/qarmin">@qarmin</a> on 2024-12-13 21:28</div>
            <div class="timeline-body"><p>When I compile red_knot locally, then I see in valgrind such error (<a href="https://github.com/rui314/mold/issues/1240">rui314/mold#1240</a>)</p>
<pre><code>--171610-- WARNING: Serious error when reading debug info
--171610-- When reading debug info from /home/rafal/test/ruff/target/debug/red_knot:
--171610-- Can&#x27;t make sense of .rodata section mapping
</code></pre>
<p>so in valgrind I see now only this leaks, which looks a little like false positives</p>
<pre><code>==172909== 56 bytes in 1 blocks are possibly lost in loss record 9 of 70
==172909==    at 0x4E050C5: malloc (vg_replace_malloc.c:442)
==172909==    by 0x1B7E530: ??? (in /home/rafal/test/ruff/target/debug/red_knot)
==172909==    by 0x97AE39: ??? (in /home/rafal/test/ruff/target/debug/red_knot)
==172909==    by 0x504328A: __libc_start_main@@GLIBC_2.34 (libc-start.c:360)
==172909==    by 0x9781E4: ??? (in /home/rafal/test/ruff/target/debug/red_knot)
==172909==    by 0x1FFEFFF377: ???
==172909==    by 0x37: ???
==172909== 
==172909== 304 bytes in 1 blocks are possibly lost in loss record 29 of 70
==172909==    at 0x4E0C6E5: calloc (vg_replace_malloc.c:1595)
==172909==    by 0x40145AB: calloc (rtld-malloc.h:44)
==172909==    by 0x40145AB: allocate_dtv (dl-tls.c:370)
==172909==    by 0x40145AB: _dl_allocate_tls (dl-tls.c:629)
==172909==    by 0x50B6606: allocate_stack (allocatestack.c:429)
==172909==    by 0x50B6606: pthread_create@@GLIBC_2.34 (pthread_create.c:655)
==172909==    by 0x1B90E31: ??? (in /home/rafal/test/ruff/target/debug/red_knot)
==172909==    by 0x9A25A1: ??? (in /home/rafal/test/ruff/target/debug/red_knot)
==172909==    by 0x97AE39: ??? (in /home/rafal/test/ruff/target/debug/red_knot)
==172909==    by 0x504328A: __libc_start_main@@GLIBC_2.34 (libc-start.c:360)
==172909==    by 0x9781E4: ??? (in /home/rafal/test/ruff/target/debug/red_knot)
==172909==    by 0x1FFEFFF377: ???
==172909==    by 0x37: ???
==172909== 
==172909== 348 bytes in 3 blocks are possibly lost in loss record 30 of 70
==172909==    at 0x4E050C5: malloc (vg_replace_malloc.c:442)
==172909==    by 0x17C8CCA: ??? (in /home/rafal/test/ruff/target/debug/red_knot)
==172909==    by 0xDDF495: ??? (in /home/rafal/test/ruff/target/debug/red_knot)
==172909==    by 0x50B5A93: start_thread (pthread_create.c:447)
==172909==    by 0x5142A33: clone (clone.S:100)
==172909== 
==172909== 2,128 bytes in 1 blocks are possibly lost in loss record 46 of 70
==172909==    at 0x4E050C5: malloc (vg_replace_malloc.c:442)
==172909==    by 0x19C5D6A: ??? (in /home/rafal/test/ruff/target/debug/red_knot)
==172909==    by 0xA929F3: ??? (in /home/rafal/test/ruff/target/debug/red_knot)
==172909==    by 0x97AE39: ??? (in /home/rafal/test/ruff/target/debug/red_knot)
==172909==    by 0x504328A: __libc_start_main@@GLIBC_2.34 (libc-start.c:360)
==172909==    by 0x9781E4: ??? (in /home/rafal/test/ruff/target/debug/red_knot)
==172909==    by 0x1FFEFFF377: ???
==172909==    by 0x37: ???
==172909== 
==172909== 2,432 bytes in 8 blocks are possibly lost in loss record 49 of 70
==172909==    at 0x4E0C6E5: calloc (vg_replace_malloc.c:1595)
==172909==    by 0x40145AB: calloc (rtld-malloc.h:44)
==172909==    by 0x40145AB: allocate_dtv (dl-tls.c:370)
==172909==    by 0x40145AB: _dl_allocate_tls (dl-tls.c:629)
==172909==    by 0x50B6606: allocate_stack (allocatestack.c:429)
==172909==    by 0x50B6606: pthread_create@@GLIBC_2.34 (pthread_create.c:655)
==172909==    by 0x1B90E31: ??? (in /home/rafal/test/ruff/target/debug/red_knot)
==172909==    by 0xDE6574: ??? (in /home/rafal/test/ruff/target/debug/red_knot)
==172909==    by 0xDDFBFB: ??? (in /home/rafal/test/ruff/target/debug/red_knot)
==172909==    by 0xDF1C83: ??? (in /home/rafal/test/ruff/target/debug/red_knot)
==172909==    by 0x97AE39: ??? (in /home/rafal/test/ruff/target/debug/red_knot)
==172909==    by 0x504328A: __libc_start_main@@GLIBC_2.34 (libc-start.c:360)
==172909==    by 0x9781E4: ??? (in /home/rafal/test/ruff/target/debug/red_knot)
==172909==    by 0x1FFEFFF377: ???
==172909==    by 0x37: ???
==172909== 
==172909== 16,128 bytes in 7 blocks are possibly lost in loss record 60 of 70
==172909==    at 0x4E0D0FB: posix_memalign (vg_replace_malloc.c:2099)
==172909==    by 0x1B8D83D: ??? (in /home/rafal/test/ruff/target/debug/red_knot)
==172909==    by 0x1A21F0A: ??? (in /home/rafal/test/ruff/target/debug/red_knot)
==172909==    by 0x1A23DE9: ??? (in /home/rafal/test/ruff/target/debug/red_knot)
==172909==    by 0x50B5A93: start_thread (pthread_create.c:447)
==172909==    by 0x5142A33: clone (clone.S:100)
==172909== 
==172909== 19,581 bytes in 774 blocks are possibly lost in loss record 66 of 70
==172909==    at 0x4E050C5: malloc (vg_replace_malloc.c:442)
==172909==    by 0x1BAB63D: ??? (in /home/rafal/test/ruff/target/debug/red_knot)
==172909==    by 0x13AAFB4: ??? (in /home/rafal/test/ruff/target/debug/red_knot)
==172909==    by 0xED5293: ??? (in /home/rafal/test/ruff/target/debug/red_knot)
==172909==    by 0x97AE39: ??? (in /home/rafal/test/ruff/target/debug/red_knot)
==172909==    by 0x504328A: __libc_start_main@@GLIBC_2.34 (libc-start.c:360)
==172909==    by 0x9781E4: ??? (in /home/rafal/test/ruff/target/debug/red_knot)
==172909==    by 0x1FFEFFF377: ???
==172909==    by 0x37: ???
==172909== 
==172909== 33,808 bytes in 1 blocks are possibly lost in loss record 69 of 70
==172909==    at 0x4E050C5: malloc (vg_replace_malloc.c:442)
==172909==    by 0x19C5D6A: ??? (in /home/rafal/test/ruff/target/debug/red_knot)
==172909==    by 0xED5293: ??? (in /home/rafal/test/ruff/target/debug/red_knot)
==172909==    by 0x97AE39: ??? (in /home/rafal/test/ruff/target/debug/red_knot)
==172909==    by 0x504328A: __libc_start_main@@GLIBC_2.34 (libc-start.c:360)
==172909==    by 0x9781E4: ??? (in /home/rafal/test/ruff/target/debug/red_knot)
==172909==    by 0x1FFEFFF377: ???
==172909==    by 0x37: ???

</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2024-12-14 02:14</div>
            <div class="timeline-body"><p>I&#x27;m not super experienced reading valgrind output, but the remaining issues don&#x27;t look like anything addressable in red-knot. Are we satisfied that the only real leak is the known and intentional <code>db</code> leak at shutdown, and we can close this issue?</p>
<p>(I&#x27;m going to hazard a guess on &quot;yes&quot; and go ahead and optimistically close this, but feel free to comment if you think it should be re-opened and I&#x27;ll happily do so.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/carljm">@carljm</a> on 2024-12-14 02:14</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 18:49:09 UTC
    </footer>
</body>
</html>
