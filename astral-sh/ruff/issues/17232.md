```yaml
number: 17232
title: "[red-knot] Output is not colorised even if `--color=always` is specified with `--output-format=concise`"
type: issue
state: closed
author: AlexWaygood
labels:
  - bug
  - ty
  - diagnostics
assignees: []
created_at: 2025-04-06T15:10:33Z
updated_at: 2025-04-29T14:07:18Z
url: https://github.com/astral-sh/ruff/issues/17232
synced_at: 2026-01-10T01:56:56Z
```

# [red-knot] Output is not colorised even if `--color=always` is specified with `--output-format=concise`

---

_Issue opened by @AlexWaygood on 2025-04-06 15:10_

### Summary

If you specify `--output-format=concise`, `--color` appears to have no effect. This makes the output quite hard to read:

<details>

![Image](https://github.com/user-attachments/assets/1dd7be50-6ad0-46b4-83e6-5d85f8a5421b)

</details>

And it's different to what Ruff does with `--output-format=concise`:

<details>

![Image](https://github.com/user-attachments/assets/341c5a48-8945-4b40-897c-c4c51c50525e)

</details>

---

_Label `bug` added by @AlexWaygood on 2025-04-06 15:10_

---

_Label `diagnostics` added by @AlexWaygood on 2025-04-06 15:10_

---

_Label `red-knot` added by @AlexWaygood on 2025-04-06 15:10_

---

_Added to milestone `Red Knot Alpha` by @AlexWaygood on 2025-04-06 15:11_

---

_Comment by @MichaReiser on 2025-04-06 16:58_

@BurntSushi could you take a look at this. This is probably easy to fix (I assume we simply aren't colorizing the output)

---

_Assigned to @BurntSushi by @BurntSushi on 2025-04-07 12:13_

---

_Comment by @Kalmaegi on 2025-04-18 13:30_

Can I try to fix this issue?

---

_Comment by @BurntSushi on 2025-04-18 13:36_

@Kalmaegi Go for it! I haven't started this yet, so it's all yours.

---

_Assigned to @Kalmaegi by @BurntSushi on 2025-04-18 13:36_

---

_Comment by @Kalmaegi on 2025-04-18 15:23_

https://github.com/astral-sh/ruff/blob/main/crates/ruff_db/src/diagnostic/render.rs#L61-L85

```
impl std::fmt::Display for DisplayDiagnostic<'_> {
    fn fmt(&self, f: &mut std::fmt::Formatter) -> std::fmt::Result {
        if matches!(self.config.format, DiagnosticFormat::Concise) {
            match self.diag.severity() {
                Severity::Info => f.write_str("info")?,
                Severity::Warning => f.write_str("warning")?,
                Severity::Error => f.write_str("error")?,
                Severity::Fatal => f.write_str("fatal")?,
            }

            write!(f, "[{rule}]", rule = self.diag.id())?;
            if let Some(span) = self.diag.primary_span() {
                write!(f, " {path}", path = self.resolver.path(span.file()))?;
                if let Some(range) = span.range() {
                    let input = self.resolver.input(span.file());
                    let start = input.as_source_code().source_location(range.start());
                    write!(f, ":{line}:{col}", line = start.row, col = start.column)?;
                }
                write!(f, ":")?;
            }
            return writeln!(f, " {}", self.diag.concise_message());
        }

        let resolved = Resolved::new(&self.resolver, self.diag);
        let renderable = resolved.to_renderable(self.config.context);
        for diag in renderable.diagnostics.iter() {
            writeln!(f, "{}", self.annotate_renderer.render(diag.to_annotate()))?;
        }
        writeln!(f)
    }
}
```

I think I might have found the issue. Currently, for the concise mode, we manually concatenate and call write for output, while for the full mode, we construct a render object. I can think of two possible fixes, but I'm not sure which one is better:

Add color handling directly in the write section of the concise branch â€“ straightforward, but a bit tedious.

Alternatively, could we also construct a render object for primary_span, letting it handle colors internally?

I'm not entirely sure if my approach is correct. Any help would be greatly appreciated!

---

_Comment by @BurntSushi on 2025-04-18 16:35_

I think any way you slice it, you'll need to add colors the tedious way. If you make a render object, that will do the "verbose" output. So the concise output fundamentally has to do its own thing and add colors to itself.

---

_Referenced in [astral-sh/ruff#17479](../../astral-sh/ruff/pulls/17479.md) on 2025-04-19 13:29_

---

_Closed by @MichaReiser on 2025-04-29 14:07_

---
