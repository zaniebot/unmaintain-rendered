<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PERF403 update suggestion will make code slower - astral-sh/ruff #21890</title>
    <link rel="stylesheet" href="../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../index.html">Back to index</a>
    </div>

    <h1>PERF403 update suggestion will make code slower</h1>

    <div class="meta">
        <span class="state state-open">Open</span>
        <a href="https://github.com/astral-sh/ruff/issues/21890">#21890</a>
        opened by <a href="https://github.com/hauntsaninja">@hauntsaninja</a>
        on 2025-12-10 09:21
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/hauntsaninja">@hauntsaninja</a> on 2025-12-10 09:21</div>
            <div class="timeline-body"><h3>Summary</h3>
<p>Was looking at PERF rules, noticed one of the transformations it suggests will make code like 1.4x slower</p>
<pre><code class="language-python">import timeit


def main1():
    d = {}
    for x in range(8):
        for i, j in zip(range(x), range(x)):
            d[i] = j


def main2():
    d = {}
    for x in range(8):
        d.update({i: j for i, j in zip(range(x), range(x))})


if __name__ == &quot;__main__&quot;:
    print(timeit.timeit(main1, number=10_000))
    print(timeit.timeit(main2, number=10_000))
</code></pre>
<pre><code>λ python test.py
0.01902620808687061
0.026080582989379764
</code></pre>
<h3>Version</h3>
<p><em>No response</em></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/21891.html">astral-sh/ruff#21891</a> on 2025-12-10 09:37</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">rule</span> added by @ntBre on 2025-12-10 16:26</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">needs-decision</span> added by @ntBre on 2025-12-10 16:26</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/amyreese">@amyreese</a> on 2025-12-10 20:06</div>
            <div class="timeline-body"><p>It's also a verbose fix, and at least in this case a much better fix should just be:</p>
<pre><code class="language-py">def main3():
    d = {}
    for x in range(8):
        d.update(zip(range(x), range(x)))
</code></pre>
<p>When run on my machine with 3.14, it beats the first two versions:</p>
<pre><code>0.01532745803706348
0.019240333000198007
0.012530624982900918
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/hauntsaninja">@hauntsaninja</a> on 2025-12-10 21:04</div>
            <div class="timeline-body"><p>Yup! In this and https://github.com/astral-sh/ruff/issues/21891 , the things that trigger my &quot;this rule is probably counterproductive&quot; sense are 1) creating generators where none existed previously, 2) instantiating temporary dicts/lists</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-12-10 21:18</div>
            <div class="timeline-body"><p>To me this and https://github.com/astral-sh/ruff/issues/21891 seem like pretty clear bugs. I don't think <code>PERF</code> autofixes or recommendations should ever make your code slower — if the motivation for a rule is more &quot;stylistic consistency&quot; rather than &quot;micro-optimisations&quot;, then I don't think the rule belongs in the <code>PERF</code> category at all. Even if we decide we don't want to make any changes here to how the rule works, at the very least I think we should document that the rule sometimes makes suggestions that can lead to slowdowns — as a Ruff user, that's not at all what I'd expect a <code>PERF</code> rule to ever do</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">needs-decision</span> removed by @MichaReiser on 2025-12-11 08:43</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @MichaReiser on 2025-12-11 08:43</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dylwil3">@dylwil3</a> on 2025-12-15 16:31</div>
            <div class="timeline-body"><p>A general issue with the <code>PERF</code> rules is that most of them seem dependent on CPython internals. It may very well be version specific whether these suggestions reliably give a speedup or not (e.g. https://docs.astral.sh/ruff/rules/try-except-in-loop/ where we end up skipping the rule in version 3.11+). Not sure the best way to handle this. Maybe we should be adding micro-benchmarks that get checked periodically on various Python versions? (seems a little unwieldy)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntBre">@ntBre</a> on 2025-12-15 17:54</div>
            <div class="timeline-body"><p>Yeah, that's why I didn't immediately consider these to be bugs. I found at least one case in #21891 where the <code>extend</code> version is actually faster. Assuming we don't want to maintain such a list of microbenchmarks, I would probably lean toward framing these rules as stylistic rather than performance-oriented, as Alex mentioned (and some day moving them out of a <code>PERF</code> or <code>performance</code> category entirely).</p>
<p>On the other hand, it also seems reasonable to me to drop the <code>extend</code>/<code>update</code> parts of the rules. Those intuitively feel like they would be slower and also don't feel like as much of a stylistic improvement to me as replacing a whole loop with a single comprehension.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:28:17 UTC
    </footer>
</body>
</html>
