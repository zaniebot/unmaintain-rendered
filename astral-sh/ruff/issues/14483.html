<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Can `offset_encoding` for Ruff be configured in Neovim? - astral-sh/ruff #14483</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Can `offset_encoding` for Ruff be configured in Neovim?</h1>

    <div class="meta">
        <span class="state state-closed">Closed</span>
        <a href="https://github.com/astral-sh/ruff/issues/14483">#14483</a>
        opened by <a href="https://github.com/Shinzu">@Shinzu</a>
        on 2024-11-20 10:52
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/Shinzu">@Shinzu</a> on 2024-11-20 10:52</div>
            <div class="timeline-body"><p>Hello,</p>
<p>is it possible to configure the <code>offset_enconding</code> for ruff in neovim?</p>
<p>Background:</p>
<p>by default ruff has configured <code>utf-8</code>, when you use it together with <code>pyright</code> which is default to <code>utf-16</code> neovim will produce a warning:</p>
<pre><code>warning: multiple different client offset_encodings detected for buffer, this is not supported yet
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-11-20 11:15</div>
            <div class="timeline-body"><p>I'm a bit confused by this warning because ruff isn't a client but a server. Ruff also negotiates the encoding with the client. That makes me suspect that another server doesn't support the position encoding negotiation and always enforces utf16 (in which case the previously negotiated utf8 encoding with ruff is outdated). But that seems like a neovim issue. Ideally neovim would re-negotiate with ruff if that happens</p>
<p>I found a related neovim issue https://github.com/neovim/nvim-lspconfig/issues/2184</p>
<p>It seems that setting the position encoding to the one encoding supported by all servers fix the warning</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-11-21 07:47</div>
            <div class="timeline-body"><p>It seems that Neovim added support for UTF-8 and UTF-32 quite recently (last week) https://github.com/neovim/neovim/pull/31209 which means that you must be running nightly Neovim. I think this is the reason that Ruff will select UTF-8 because the client now supports it:</p>
<p>https://github.com/astral-sh/ruff/blob/f8c20258aec5148029da904fe1ea91c1c8f1be50/crates/ruff_server/src/server.rs#L271-L283</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-11-21 07:54</div>
            <div class="timeline-body"><p>@Shinzu Can you try running the latest nightly version of Neovim? I don't see any warnings on the latest <code>master</code> branch. In the buffer, Ruff is using UTF-8 and Pyright is using UTF-16.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">question</span> added by @dhruvmanila on 2024-11-21 07:55</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">server</span> added by @dhruvmanila on 2024-11-21 07:55</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "[Question] Can offset_encoding for ruff be configured in neovim?" to "Can `offset_encoding` for Ruff be configured in Neovim?" by @dhruvmanila on 2024-11-21 07:55</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-11-21 08:00</div>
            <div class="timeline-body"><p>The function has been deprecated where the warning is being raised (https://github.com/neovim/neovim/blob/01026ba47ba8a656bb5cd09afbb25b4b33c0b752/runtime/lua/vim/lsp/util.lua#L1889-L1920) and the <code>offset_encoding</code> parameter is now a required parameter to be passed in to various LSP functions (https://github.com/neovim/neovim/blob/01026ba47ba8a656bb5cd09afbb25b4b33c0b752/runtime/lua/vim/lsp/util.lua#L1876-L1882).</p>
<p>It's marked as a breaking change (https://github.com/neovim/neovim/pull/31249), so you might want to update your dotfiles and / or wait for the ecosystem to catch up (plugins).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Shinzu">@Shinzu</a> on 2024-11-21 08:43</div>
            <div class="timeline-body"><p>Thank you both for your answers.</p>
<p>Yes i'm running nightly. I will just wait. :)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-11-22 16:09</div>
            <div class="timeline-body"><p>I'll close this issue because I understand that this is an issue with neovim. Let me know if there's something that's left unanswered or if there's something we could do on our side.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @MichaReiser on 2024-11-22 16:09</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/wookayin">@wookayin</a> on 2024-12-09 03:10</div>
            <div class="timeline-body"><p>For those one who finds this issue, this is how you can configure the <code>offset_encoding</code> <strong>client</strong> capabilities:</p>
<pre><code class="language-lua">lspconfig[&quot;ruff&quot;].setup {
  init_options = {
    settings = {
      ...,
    }
  }
  capabilities = {
    general = {
      -- positionEncodings = { &quot;utf-8&quot;, &quot;utf-16&quot;, &quot;utf-32&quot; }  &lt;--- this is the default
      positionEncodings = { &quot;utf-16&quot; }
    },
  }
}
</code></pre>
<p>in order to set offset_encoding to be <strong>utf-16</strong> only (as pyright uses utf-16 by default). This is per the LSP 3.17 specification https://microsoft.github.io/language-server-protocol/specifications/lsp/3.17/specification/#textDocuments</p>
<blockquote>
<p>The client announces itâ€™s supported encoding via the client capability <a href="https://microsoft.github.io/language-server-protocol/specifications/lsp/3.17/specification/#clientCapabilities">general.positionEncodings</a>. The value is an array of position encodings the client supports, with decreasing preference (e.g. the encoding at index 0 is the most preferred one)</p>
</blockquote>
<p>Remark: On neovim 0.11+ (or nightly), <code>positionEncodings</code> defaults to <code>{ &quot;utf-8&quot;, &quot;utf-16&quot;, &quot;utf-32&quot; } </code> (see https://github.com/neovim/neovim/issues/30034) whereas neovim &lt;= 0.10 uses <code>utf-16</code> only by default.</p>
<p>Note: With the following way (conventional ways of setting <code>capabilities.offsetEncoding</code>prior to LSP 3.17, which is not a standard but used to work for other LSP servers) will <em>NOT</em> work:</p>
<pre><code class="language-lua">require&quot;lspconfig&quot;.ruff.setup {
  init_options = {
    settings = {
      fixAll = true,
      ...
    },
  },
  capabilities = {
    offsetEncoding = 'utf-16',
  }
}
</code></pre>
<p>and ruff will crash: 'ruff failed\n  Cause: invalid type: string &quot;utf-16&quot;, expected a sequence'. But @MichaReiser, I wonder if this might be a bug because this <code>capabilities.offsetEncoding</code> is read (expected a sequence, not a str) though this does not seem to be a standard LSP spec.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-12-09 05:21</div>
            <div class="timeline-body"><blockquote>
<p>I wonder if this might be a bug because this <code>capabilities.offsetEncoding</code> is read (expected a sequence, not a str) though this does not seem to be a standard LSP spec.</p>
</blockquote>
<p>I don't think this is something that we can control on our side as the types are defined in an external crate, specifically in <code>lsp-types</code>: https://github.com/gluon-lang/lsp-types/blob/be7336e92a6ad23f214df19bcdceab17f39531a9/src/lib.rs#L1507-L1512 which specifies that it's an unofficial way to support UTF-8 encodings in clangd. There's a tracking issue (https://github.com/clangd/clangd/issues/1746) to add support for the new field in clangd.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:34:54 UTC
    </footer>
</body>
</html>
