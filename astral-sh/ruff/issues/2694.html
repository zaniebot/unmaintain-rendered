<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RUSTFLAGS handling via cargo config is not optimal. - astral-sh/ruff #2694</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>RUSTFLAGS handling via cargo config is not optimal.</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/issues/2694">#2694</a>
        opened by <a href="https://github.com/gyakovlev">@gyakovlev</a>
        on 2023-02-09 20:02
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/gyakovlev">@gyakovlev</a></div>
            <div class="timeline-body">

<p>Hi,
https://github.com/charliermarsh/ruff/commit/b5ac93d2eeb2a3af56022c948faa445a577c9ece moved lints to cargo config file.
I believe it&#x27;s not optimal solution, as it applies to everything and leads to build failures.</p>
<p>it will only get applied if <code>RUSTFLAGS</code> envvar is not defined before starting the build.
if a user/CI job has <code>RUSTFLAGS</code> defined, this file is skipped altogether.</p>
<pre><code>    Running `rustc --crate-name imperative --edition=2021 /var/tmp/portage/dev-util/ruff-0.0.244/work/cargo_home/gentoo/imperative-1.0.4/src/lib.rs --error-format=json --json=diagnostic-rendered-ansi,artifacts
,future-incompat --crate-type lib --emit=dep-info,metadata,link -C opt-level=3 -C panic=abort -C codegen-units=1 -C metadata=c59b923aa5a848a5 -C extra-filename=-c59b923aa5a848a5 --out-dir /var/tmp/portage/dev-u
til/ruff-0.0.244/work/ruff-0.0.244/target/release/deps -L dependency=/var/tmp/portage/dev-util/ruff-0.0.244/work/ruff-0.0.244/target/release/deps --extern phf=/var/tmp/portage/dev-util/ruff-0.0.244/work/ruff-0.
0.244/target/release/deps/libphf-cd1439e7d6a81c48.rmeta --extern rust_stemmers=/var/tmp/portage/dev-util/ruff-0.0.244/work/ruff-0.0.244/target/release/deps/librust_stemmers-3f0bf859cc9852ca.rmeta --cap-lints al
low -C target-cpu=pwr9 -Dunsafe_code &#x27;-Wclippy::pedantic&#x27; &#x27;-Wclippy::char_lit_as_u8&#x27; &#x27;-Aclippy::collapsible_else_if&#x27; &#x27;-Aclippy::collapsible_if&#x27; &#x27;-Aclippy::implicit_hasher&#x27; &#x27;-Aclippy::match_same_arms&#x27; &#x27;-Aclippy:
:missing_errors_doc&#x27; &#x27;-Aclippy::missing_panics_doc&#x27; &#x27;-Aclippy::module_name_repetitions&#x27; &#x27;-Aclippy::must_use_candidate&#x27; &#x27;-Aclippy::similar_names&#x27; &#x27;-Aclippy::too_many_lines&#x27; &#x27;-Wclippy::print_stdout&#x27; &#x27;-Wclippy::pr
int_stderr&#x27; &#x27;-Wclippy::dbg_macro&#x27;`                                                                                                                                                                                
error: usage of an `unsafe` block                                                                                                                                                                                 
   --&gt; /var/tmp/portage/dev-util/ruff-0.0.244/work/RustPython-adc23253e4b58980b407ba2760dbe61681d752fc/common/src/atomic.rs:121:22                                                                                
    |                                                                                                                                                                                                             
121 |                 drop(unsafe { Box::from_raw(ptr) });                                                                                                                                                        
    |                      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^                                                                                                                                                          
    |                                                                                                                                                                                                             
    = note: requested on the command line with `-D unsafe-code`                                                                                                                                                   
                                                                                                                                                                                                                  
error: usage of an `unsafe` block                                                                                                                                                                                 
   --&gt; /var/tmp/portage/dev-util/ruff-0.0.244/work/RustPython-adc23253e4b58980b407ba2760dbe61681d752fc/common/src/atomic.rs:125:9                                                                                 
    |                                                                                                                                                                                                             
125 |         unsafe { NonNull::new_unchecked(ptr) }                                                                                                                                                              
    |         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^                                                                                                                                                              
                                                                                                                                                                                                                  
error: usage of an `unsafe` block                                                                                                                                                                                 
  --&gt; /var/tmp/portage/dev-util/ruff-0.0.244/work/RustPython-adc23253e4b58980b407ba2760dbe61681d752fc/common/src/boxvec.rs:44:9                                                                                   
   |                                                                                                                                                                                                              
44 | /         unsafe {                                                                                                                                                                                           
45 | |             let layout = match alloc::Layout::array::&lt;T&gt;(n) {                                                                                                                                              
46 | |                 Ok(l) =&gt; l,                                                                                                                                                                                
47 | |                 Err(_) =&gt; capacity_overflow(),                                                                                                                                                             
...  |                                                                                                                                                                                                            
60 | |             BoxVec { xs, len: 0 }                                                                                                                                                                          
61 | |         }                                                                                                                                                                                                  
   | |_________^                
</code></pre>
<p>and many many many more.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/gyakovlev">@gyakovlev</a> on 2023-02-09 20:04</div>
            <div class="timeline-body"><p>it builds fine with <code>RUSTFLAGS</code> envvar exported (even empty one).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-02-09 22:57</div>
            <div class="timeline-body"><p>Thanks for filing! This was the best pattern I could find for enforcing a standard Clippy configuration across a multi-crate project. Is there another pattern you&#x27;ve seen elsewhere or would suggest?</p>
<p>I could try instead moving to <a href="https://github.com/ericseppanen/cargo-cranky"><code>cargo cranky</code></a>, but there are costs associated with that too.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">question</span> added by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-02-09 22:57</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/gyakovlev">@gyakovlev</a> on 2023-02-10 22:57</div>
            <div class="timeline-body"><p>I did some research and looks like no real way of doing it.</p>
<p>https://doc.rust-lang.org/cargo/reference/config.html</p>
<p>~
At present, when being invoked from a workspace, Cargo does not read config files from crates within the workspace. i.e. if a workspace has two crates in it, named /projects/foo/bar/baz/mylib and /projects/foo/bar/baz/mybin, and there are Cargo configs at /projects/foo/bar/baz/mylib/.cargo/config.toml and /projects/foo/bar/baz/mybin/.cargo/config.toml, Cargo does not read those configuration files if it is invoked from the workspace root (/projects/foo/bar/baz/).
~</p>
<p>so it will not work in workspace subdirs unfortunately...</p>
<p>that makes me believe that how it was before is the most compatible way.
And ofc running clippy via CI with specified settings or via an alias for workspace crates only, as you don&#x27;t really have control over deps.</p>
<p>build time clippy lints for downstream/user/distros are not very valuable, so I think it belongs to CI/dev environment, not release profile builds.</p>
<p>specifying at top level propagates flags to all dependencies and dependencies of dependencies and wreaks total chaos, because not all the packages qualify for those lints.</p>
<p>ofc we (gentoo linux) could simply nuke that file before build, but I&#x27;m here to let you know it may be problematic for downstreams/distros and consumers going forward as more distros package ruff.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/not-my-profile">@not-my-profile</a> on 2023-02-15 17:23</div>
            <div class="timeline-body"><p>I think the very recently (2 hours ago) proposed <a href="https://github.com/rust-lang/rfcs/pull/3389">RFC 3389</a> would provide a better way.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-02-15 18:29</div>
            <div class="timeline-body"><p>Oh yeah, I&#x27;d love that.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">internal</span> added by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-07-10 01:18</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">question</span> removed by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-07-10 01:18</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-07-10 01:19</div>
            <div class="timeline-body"><p>(We will fix this as soon as the <code>Cargo.toml</code> configuration stabilizes.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-07-26 02:13</div>
            <div class="timeline-body"><p>This got done.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-07-26 02:13</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 18:48:32 UTC
    </footer>
</body>
</html>
