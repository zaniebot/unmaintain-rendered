<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Use ruff_fix_validity to catch regressions in CI not detected by unit tests - astral-sh/ruff #4972</title>
    <link rel="stylesheet" href="../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../index.html">Back to index</a>
    </div>

    <h1>Use ruff_fix_validity to catch regressions in CI not detected by unit tests</h1>

    <div class="meta">
        <span class="state state-open">Open</span>
        <a href="https://github.com/astral-sh/ruff/issues/4972">#4972</a>
        opened by <a href="https://github.com/addisoncrump">@addisoncrump</a>
        on 2023-06-08 19:55
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/addisoncrump">@addisoncrump</a> on 2023-06-08 19:55</div>
            <div class="timeline-body"><p>The fuzzers added in #4822 can be used to catch regressions for which there exists no unit tests (see: #4863 as an example of this; caught by <code>ruff_fix_validity</code> within ~30 seconds). PRs should include a short fuzz run (5-10m) before merging. Failure cases can then be added to the unit test suite.</p>
<p>Before that happens, the following issues (discovered by fuzzing currently and will cause this CI step to fail) should be resolved:</p>
<ul>
<li>[x] #4823</li>
<li>[x] #4825</li>
<li>[x] #4826</li>
<li>[x] #4827</li>
<li>[x] #4828</li>
<li>[x] #4863</li>
<li>[x] #4865</li>
<li>[x] #4892</li>
<li>[x] #4897</li>
<li>[x] #4899</li>
<li>[x] #4901</li>
<li>[ ] #4924</li>
<li>[x] #4925</li>
<li>[x] #4973</li>
<li>[x] #4975</li>
<li>[x] #4991</li>
<li>[ ] https://github.com/RustPython/Parser/issues/89</li>
<li>[x] #5004</li>
<li>[x] #5154</li>
<li>[x] #5156</li>
<li>[x] #6213</li>
<li>[x] #6214</li>
<li>[x] #9374</li>
<li>[x] #9379</li>
</ul>
<p>This change should include the following:</p>
<ul>
<li>Caching of the fuzzer corpus, <code>fuzz/corpus/ruff_fix_validity</code> (~20MB)</li>
<li>Initialisation of the fuzzer corpus if not present (I will provide an initial corpus)</li>
<li>Execution of <code>timeout 10m cargo fuzz run -s none ruff_fix_validity -- -timeout=5 || [[ $? -eq 124 ]]</code> after the <code>fuzz build</code> step</li>
</ul>
<p>In the future, when parser idempotency is more stable or new fuzzers exist (such as for formatting), this should be included as well.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/addisoncrump">@addisoncrump</a> on 2023-06-08 20:00</div>
            <div class="timeline-body"><p>I am happy to craft these changes. :slightly_smiling_face: I just want to make sure that this implementation is sane for the maintainers.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../google/oss-fuzz/pulls/11471.html">google/oss-fuzz#11471</a> on 2024-01-10 11:39</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/T-256">@T-256</a> on 2024-06-12 23:47</div>
            <div class="timeline-body"><ul>
<li>I think this issued could be close since https://github.com/RustPython/Parser/issues/89 is solved by Ruff's internal parser at some point and https://github.com/astral-sh/ruff/issues/4924 is the only remained item which can tracking it separately.</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/addisoncrump">@addisoncrump</a> on 2024-06-12 23:52</div>
            <div class="timeline-body"><p>The list here is now very old. There are likely new bugs caught by this beyond what is tracked; the issue is about making sure that the fuzzer is not enabled constantly unnecessarily.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/T-256">@T-256</a> on 2024-06-13 00:01</div>
            <div class="timeline-body"><p>Correct, sorry for misreading discription.</p>
<blockquote>
<p>PRs should include a short fuzz run (5-10m) before merging. Failure cases can then be added to the unit test suite.</p>
</blockquote>
<p>I think it's better to use cron jobs workflow instead.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/addisoncrump">@addisoncrump</a> on 2024-06-13 00:07</div>
            <div class="timeline-body"><p>As in, a scheduled workflow? Makes sense.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/12785.html">astral-sh/ruff#12785</a> on 2024-08-09 13:21</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:28:09 UTC
    </footer>
</body>
</html>
