<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PLR1701 fix is not safe (especially together with SIM114) - astral-sh/ruff #11616</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>PLR1701 fix is not safe (especially together with SIM114)</h1>

    <div class="meta">
        <span class="state state-closed">Closed</span>
        <a href="https://github.com/astral-sh/ruff/issues/11616">#11616</a>
        opened by <a href="https://github.com/simonpercivall">@simonpercivall</a>
        on 2024-05-30 09:56
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/simonpercivall">@simonpercivall</a> on 2024-05-30 09:56</div>
            <div class="timeline-body"><!--
Thank you for taking the time to report an issue! We're glad to have you involved with Ruff.

If you're filing a bug report, please consider including the following information:

* List of keywords you searched for before creating this issue. Write them down here so that others can find this issue more easily and help provide feedback.
  e.g. "RUF001", "unused variable", "Jupyter notebook"
* A minimal code snippet that reproduces the bug.
* The command you invoked (e.g., `ruff /path/to/file.py --fix`), ideally including the `--isolated` flag.
* The current Ruff settings (any relevant sections from your `pyproject.toml`).
* The current Ruff version (`ruff --version`).
-->

<p><code>PLR1701</code> is mentioned in passing in https://github.com/astral-sh/ruff/issues/10245.</p>
<p><code>PLR1701</code> will merge repeated <code>isinstance</code> calls and also rewrite literal tuples into unions for modern Python versions. But an <code>isinstance</code> check with a variable bound <code>tuple</code> will <em>also</em> be merged into the union, and that will cause a <code>TypeError</code> at runtime.</p>
<p>This especially interacts badly with <code>SIM114</code> where you <em>could</em> have defined two <code>if</code> arms, one with a variable bound <code>tuple</code>, and one with a literal <code>tuple</code>, and it'll get merged and wrongly rewritten as a union. Example below.</p>
<p>Ruff 0.45</p>
<p><code>pyproject.toml</code>:</p>
<pre><code class="language-toml">[tool.ruff]
target-version = &quot;py311&quot;
</code></pre>
<p><code>ruff check --select SIM114,PLR1701 --fix</code></p>
<pre><code class="language-python">TYPES = (dict, list)

if isinstance(None, TYPES):
    pass
elif isinstance(None, set | float):
    pass
</code></pre>
<p>actual</p>
<pre><code class="language-python">TYPES = (dict, list)

if isinstance(None, TYPES | set | float):
    pass

# Traceback (most recent call last):
#   File &quot;PLR1701.py&quot;, line 3, in &lt;module&gt;
#     if isinstance(None, TYPES | set | float):
#                         ~~~~~~^~~~~
# TypeError: unsupported operand type(s) for |: 'tuple' and 'type'
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-05-30 13:38</div>
            <div class="timeline-body"><p>Thanks - we should mark it as unsafe. We can improve the rule in the future when we support type inference.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @charliermarsh by @charliermarsh on 2024-05-30 17:43</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-05-30 18:00</div>
            <div class="timeline-body"><p>Actually, <code>isinstance(None, (TYPES, set | float))</code> is safe... so in theory we could always rewrite to the tuple variant if we can't be certain that <code>|</code> will work?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/11622.html">astral-sh/ruff#11622</a> on 2024-05-30 18:01</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2024-05-30 18:05</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:34:53 UTC
    </footer>
</body>
</html>
