<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>--exclude glob patterns don't match on Windows (glob expansion on windows) - astral-sh/ruff #22612</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>--exclude glob patterns don&#x27;t match on Windows (glob expansion on windows)</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/issues/22612">#22612</a>
        opened by <a href="https://github.com/ahochheiden">@ahochheiden</a>
        on 2026-01-15 23:48
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ahochheiden">@ahochheiden</a></div>
            <div class="timeline-body">Summary
<p>Glob patterns passed to <code>--exclude</code> work correctly on <code>macOS</code> but fail to match on <code>Windows</code> in an <a href="https://www.msys2.org/">MSYS2</a> terminal.</p>
<p><strong>Context:</strong>
I discovered this while migrating Firefox from <code>black</code> to <code>ruff format</code>. The <a href="https://searchfox.org/firefox-main/source/pyproject.toml#82">pyproject.toml</a> exclusions use glob patterns that work correctly on <code>macOS</code> but not on <code>Windows</code>.</p>
<p><strong>Steps to reproduce:</strong></p>
<p>Given a file that has formatting issues at  <code>build/moz.configure/bindgen.configure</code> :</p>
<ul>
<li>Run <code>ruff format --check --force-exclude --exclude &quot;build/moz.configure/*.configure&quot; build/moz.configure/bindgen.configure</code> in an MSYS2 terminal.</li>
</ul>
<p>Result:</p>
<pre><code>/d/mozilla-source/firefox
$ ruff format --check --force-exclude --exclude &quot;build/moz.configure/*.configure&quot; build/moz.configure/bindgen.configure
unformatted: File would be reformatted
   --&gt; build\moz.configure\bindgen.configure:1:1
30  |     Please update using &#x27;cargo install cbindgen --force&#x27; or running
31  |     &#x27;./mach bootstrap&#x27;, after removing the existing executable located at
32  |     {}.
    -     &quot;&quot;&quot;.format(
    -                 version, cbindgen_min_version, cbindgen
    -             )
33  +     &quot;&quot;&quot;.format(version, cbindgen_min_version, cbindgen)
34  |         )
35  |     )
36  |
</code></pre>
<p>Expected result:</p>
<pre><code>warning: No Python files found under the given path(s)
</code></pre>
<p>Note: Explicit path works fine:</p>
<pre><code>/d/mozilla-source/firefox
$ ruff format --check --force-exclude --exclude &quot;build/moz.configure&quot; build/moz.configure/bindgen.configure
warning: No Python files found under the given path(s)
</code></pre>
Version
<p>ruff 0.14.9</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">question</span> added by <a href="https://github.com/amyreese">@amyreese</a> on 2026-01-16 02:01</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/amyreese">@amyreese</a> on 2026-01-16 02:01</div>
            <div class="timeline-body"><p>Is this a directory separator issue? What happens if you use backslashes in your exclude glob instead of forward slashes?  Eg,</p>
<pre><code>$ ruff format --check --force-exclude --exclude &quot;build\moz.configure\*.configure&quot; build\moz.configure\bindgen.configure
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ahochheiden">@ahochheiden</a> on 2026-01-16 02:26</div>
            <div class="timeline-body"><p>That yields the usual output, and this at the end:</p>
<pre><code>io: D:\mozilla-source\firefox-fresh\buildmoz.configurebindgen.configure: The system cannot find the file specified. (os error 2)
--&gt; buildmoz.configurebindgen.configure:1:1
</code></pre>
<p>Which is from MSYS eating the backslashes as escape sequences.</p>
<p>But we can get around that with <code>ruff format --check --force-exclude --exclude &quot;build\\moz.configure\\*.configure&quot; &quot;build\\moz.configure\\bindgen.configure&quot;</code></p>
<p>But that also doesn&#x27;t work:</p>
<pre><code>/d/mozilla-source/firefox-fresh
$ ruff format --check --force-exclude --exclude &quot;build\\moz.configure\\*.configure&quot; &#x27;build\moz.configure\bindgen.configure&#x27;
unformatted: File would be reformatted
   --&gt; build\moz.configure\bindgen.configure:1:1
30  |     Please update using &#x27;cargo install cbindgen --force&#x27; or running
31  |     &#x27;./mach bootstrap&#x27;, after removing the existing executable located at
32  |     {}.
    -     &quot;&quot;&quot;.format(
    -                 version, cbindgen_min_version, cbindgen
    -             )
33  +     &quot;&quot;&quot;.format(version, cbindgen_min_version, cbindgen)
34  |         )
35  |     )
36  |
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">question</span> removed by <a href="https://github.com/amyreese">@amyreese</a> on 2026-01-16 02:28</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by <a href="https://github.com/amyreese">@amyreese</a> on 2026-01-16 02:28</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">windows</span> added by <a href="https://github.com/amyreese">@amyreese</a> on 2026-01-16 02:28</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ahochheiden">@ahochheiden</a> on 2026-01-16 05:27</div>
            <div class="timeline-body"><pre><code>/d/mozilla-source/firefox-fresh
$ ruff format --check --force-exclude --exclude=&quot;build/moz.configure/*.configure&quot; build/moz.configure/bindgen.configure
warning: No Python files found under the given path(s)
</code></pre>
<p>That works. So it seems the issue is with how glob patterns are expanded when using <code>--exclude &quot;pattern&quot;</code> vs <code>--exclude=&quot;pattern&quot;</code> on Windows.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ahochheiden">@ahochheiden</a> on 2026-01-16 05:53</div>
            <div class="timeline-body"><p>I think this is the culprit: https://github.com/astral-sh/ruff/blob/0ce5ce4de11c7e3dc3aa131287c671618e61c014/crates/ruff/src/main.rs#L42</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2026-01-16 09:52</div>
            <div class="timeline-body"><p>I can&#x27;t reproduce this on my machine. I checked out your repository and manually created the file.</p>
<p>Without force-exclude:</p>
<pre><code>‚ùØ uvx ruff@latest format --check --exclude &quot;build/moz.configure/*.configure&quot; build/moz.configure/bindgen.configure --preview
unformatted: File would be reformatted
 --&gt; build\moz.configure\bindgen.configure:1:1
  - a   = 3
1 + a = 3

1 file would be reformatted
</code></pre>
<p>With <code>--force-exclude</code></p>
<pre><code>‚ùØ uvx ruff@latest format --check --exclude &quot;build/moz.configure/*.configure&quot; build/moz.configure/bindgen.configure --preview --force-exclude
warning: No Python files found under the given path(s)
</code></pre>
<p>But that&#x27;s when using powershell. Any chanace you&#x27;re using WSL or some other unix terminal?</p>
<p>Can you try running ruff with <code>-v</code>, it should then print why it includes/excludes certain files</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> removed by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2026-01-16 09:53</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">needs-mre</span> added by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2026-01-16 09:53</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ahochheiden">@ahochheiden</a> on 2026-01-16 16:17</div>
            <div class="timeline-body"><blockquote>
<p>But that&#x27;s when using powershell. Any chanace you&#x27;re using WSL or some other unix terminal?</p>
</blockquote>
<p>Yes, we use <a href="https://www.msys2.org/">MSYS2</a> for Windows (Bundled via <a href="https://wiki.mozilla.org/MozillaBuild">MozillaBuild</a>). I just tried both <code>cmd</code> and <code>PowerShell</code> and cannot reproduce there. I&#x27;ll update the title.</p>
<blockquote>
<p>Can you try running ruff with <code>-v</code>, it should then print why it includes/excludes certain files</p>
</blockquote>
<p>From <code>MozillaBuild</code>&#x27;s <code>MSYS2</code> within Windows Terminal:</p>
<pre><code>/d/mozilla-source/firefox
$ ruff format --check --force-exclude --exclude &quot;build/moz.configure/*.configure&quot; build/moz.configure/bindgen.configure -v
[2026-01-16][08:06:14][ruff::resolve][DEBUG] Using configuration file (via parent) at: D:\mozilla-source\firefox\pyproject.toml
[2026-01-16][08:06:14][ignore::gitignore][DEBUG] opened gitignore file: C:/Users/ahochheiden/.gitignore_global
[2026-01-16][08:06:14][ruff::commands::format][DEBUG] format_path; path=D:\mozilla-source\firefox\build\moz.configure\android-sdk.configure
[2026-01-16][08:06:14][ruff::commands::format][DEBUG] format_path; path=D:\mozilla-source\firefox\build\moz.configure\toolchain.configure
[2026-01-16][08:06:14][ruff::commands::format][DEBUG] format_path; path=D:\mozilla-source\firefox\build\moz.configure\pkg.configure
[2026-01-16][08:06:14][ruff::commands::format][DEBUG] format_path; path=D:\mozilla-source\firefox\build\moz.configure\lto-pgo.configure
[2026-01-16][08:06:14][ruff::commands::format][DEBUG] format_path; path=D:\mozilla-source\firefox\build\moz.configure\update-programs.configure
[2026-01-16][08:06:14][ruff::commands::format][DEBUG] format_path; path=D:\mozilla-source\firefox\build\moz.configure\libraries.configure
[2026-01-16][08:06:14][ruff::commands::format][DEBUG] format_path; path=D:\mozilla-source\firefox\build\moz.configure\bindgen.configure
[2026-01-16][08:06:14][ruff::commands::format][DEBUG] format_path; path=D:\mozilla-source\firefox\build\moz.configure\checks.configure
[2026-01-16][08:06:14][ruff::commands::format][DEBUG] format_path; path=D:\mozilla-source\firefox\build\moz.configure\arm.configure
[2026-01-16][08:06:14][ruff::commands::format][DEBUG] format_path; path=D:\mozilla-source\firefox\build\moz.configure\finalize-flags.configure
[2026-01-16][08:06:14][ruff::commands::format][DEBUG] format_path; path=D:\mozilla-source\firefox\build\moz.configure\default-flags.configure
[2026-01-16][08:06:14][ruff::commands::format][DEBUG] format_path; path=D:\mozilla-source\firefox\build\moz.configure\clang_plugin.configure
[2026-01-16][08:06:14][ruff::commands::format][DEBUG] format_path; path=D:\mozilla-source\firefox\build\moz.configure\bootstrap.configure
[2026-01-16][08:06:14][ruff::commands::format][DEBUG] format_path; path=D:\mozilla-source\firefox\build\moz.configure\java.configure
[2026-01-16][08:06:14][ruff::commands::format][DEBUG] format_path; path=D:\mozilla-source\firefox\build\moz.configure\memory.configure
[2026-01-16][08:06:14][ruff::commands::format][DEBUG] format_path; path=D:\mozilla-source\firefox\build\moz.configure\keyfiles.configure
[2026-01-16][08:06:14][ruff::commands::format][DEBUG] format_path; path=D:\mozilla-source\firefox\build\moz.configure\nss.configure
[2026-01-16][08:06:14][ruff::commands::format][DEBUG] format_path; path=D:\mozilla-source\firefox\build\moz.configure\nspr.configure
[2026-01-16][08:06:14][ruff::commands::format][DEBUG] format_path; path=D:\mozilla-source\firefox\build\moz.configure\flags.configure
[2026-01-16][08:06:14][ruff::commands::format][DEBUG] format_path; path=D:\mozilla-source\firefox\build\moz.configure\warnings.configure
[2026-01-16][08:06:14][ruff::commands::format][DEBUG] format_path; path=D:\mozilla-source\firefox\build\moz.configure\headers.configure
[2026-01-16][08:06:14][ruff::commands::format][DEBUG] format_path; path=D:\mozilla-source\firefox\build\moz.configure\windows.configure
[2026-01-16][08:06:14][ruff::commands::format][DEBUG] format_path; path=D:\mozilla-source\firefox\build\moz.configure\zucchini.configure
[2026-01-16][08:06:14][ruff::commands::format][DEBUG] format_path; path=D:\mozilla-source\firefox\build\moz.configure\compile-checks.configure
[2026-01-16][08:06:14][ruff::commands::format][DEBUG] format_path; path=D:\mozilla-source\firefox\build\moz.configure\util.configure
[2026-01-16][08:06:14][ruff::commands::format][DEBUG] format_path; path=D:\mozilla-source\firefox\build\moz.configure\init.configure
[2026-01-16][08:06:14][ruff::commands::format][DEBUG] format_path; path=D:\mozilla-source\firefox\build\moz.configure\compilers-util.configure
[2026-01-16][08:06:14][ruff::commands::format][DEBUG] format_path; path=D:\mozilla-source\firefox\build\moz.configure\node.configure
[2026-01-16][08:06:14][ruff::commands::format][DEBUG] format_path; path=D:\mozilla-source\firefox\build\moz.configure\rust.configure
[2026-01-16][08:06:14][tracing::span][DEBUG] Printer::print;
[2026-01-16][08:06:14][tracing::span][DEBUG] Printer::print;
[2026-01-16][08:06:14][tracing::span][DEBUG] Printer::print;
[2026-01-16][08:06:14][tracing::span][DEBUG] Printer::print;
[2026-01-16][08:06:14][tracing::span][DEBUG] Printer::print;
[2026-01-16][08:06:14][tracing::span][DEBUG] Printer::print;
[2026-01-16][08:06:14][tracing::span][DEBUG] Printer::print;
[2026-01-16][08:06:14][tracing::span][DEBUG] Printer::print;
[2026-01-16][08:06:14][tracing::span][DEBUG] Printer::print;
[2026-01-16][08:06:14][ruff::commands::format][DEBUG] Formatted 29 files in 54.00ms
unformatted: File would be reformatted
   --&gt; build\moz.configure\bindgen.configure:1:1
30  |     Please update using &#x27;cargo install cbindgen --force&#x27; or running
31  |     &#x27;./mach bootstrap&#x27;, after removing the existing executable located at
32  |     {}.
    -     &quot;&quot;&quot;.format(
    -                 version, cbindgen_min_version, cbindgen
    -             )
33  +     &quot;&quot;&quot;.format(version, cbindgen_min_version, cbindgen)
34  |         )
35  |     )
36  |
</code></pre>
<p>And with the <code>--exclude=</code>:</p>
<pre><code>ruff format --check --force-exclude --exclude=&quot;build/moz.configure/*.configure&quot; build/moz.configure/bindgen.configure -v
[2026-01-16][08:09:22][ruff::resolve][DEBUG] Using configuration file (via parent) at: D:\mozilla-source\firefox\pyproject.toml
[2026-01-16][08:09:22][ruff_workspace::resolver][DEBUG] Ignored path via `exclude`: &quot;D:\\mozilla-source\\firefox\\build\\moz.configure\\bindgen.configure&quot;
warning: No Python files found under the given path(s)
</code></pre>
<p>I also verified it reproduces on <code>MSYS2</code> directly (to rule out it being related to <code>MozillaBuild</code>):</p>
<pre><code>MSYS /d/mozilla-source/firefox
$ /d/mozilla-build/python3/Scripts/ruff format --check --force-exclude --exclude &quot;build/moz.configure/*.configure&quot; build/moz.configure/bindgen.configure
unformatted: File would be reformatted
   --&gt; build\moz.configure\bindgen.configure:1:1
30  |     Please update using &#x27;cargo install cbindgen --force&#x27; or running
31  |     &#x27;./mach bootstrap&#x27;, after removing the existing executable located at
32  |     {}.
    -     &quot;&quot;&quot;.format(
    -                 version, cbindgen_min_version, cbindgen
    -             )
33  +     &quot;&quot;&quot;.format(version, cbindgen_min_version, cbindgen)
34  |         )
35  |     )
36  |

```
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from &quot;--exclude glob patterns don&#x27;t match on Windows&quot; to &quot;--exclude glob patterns don&#x27;t match on Windows in MSYS2 Terminal&quot; by <a href="https://github.com/ahochheiden">@ahochheiden</a> on 2026-01-16 16:18</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2026-01-16 16:33</div>
            <div class="timeline-body"><p>I&#x27;ve to add some more debug logging to understand what&#x27;s happening. I&#x27;ll try to find sometime soon</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2026-01-18 17:23</div>
            <div class="timeline-body"><p>Hmm, I&#x27;m still not able to reproduce this issue. I installed msys2, copied the <code>mozsearch</code> directory (I didn&#x27;t want to install git).</p>
<pre><code>/c/Users/Micha/astral/ruff/target/debug/ruff.exe format --check --force-exclude --exclude &quot;build/moz.configure/*.configure&quot; build/moz.configure/bindgen.configure --preview -v
[2026-01-18][18:16:17][ruff::resolve][DEBUG] Using Ruff default settings
[2026-01-18][18:16:17][ruff_workspace::resolver][DEBUG] Ignored path via `exclude`: &quot;C:\\msys64\\home\\Micha\\mozsearch\\build\\moz.configure\\bindgen.configure&quot;
warning: No Python files found under the given path(s)
</code></pre>
<p>works fine. I even built 0.14.9 from source (because no uvx in my MSYS environment), but I got the same result.</p>
<p>Can you try to remove or rename <code>D:\mozilla-source\firefox\pyproject.toml</code>. I wonder if it&#x27;s some bad interaction between the config file and the CLI arguments.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2026-01-18 17:26</div>
            <div class="timeline-body"><p>Okay, you need to have at least two files matching <code>&quot;build/moz.configure/*.configure&quot;</code> for it to reproduce.</p>
<p>Once you have two files, it reproduces both on msys and powershell. Where it correctly excludes the first file, but not any others</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2026-01-18 18:01</div>
            <div class="timeline-body"><p>The issue is that <code>wild</code> expands <code>&quot;build/moz.configure/*.configure&quot;</code> to</p>
<pre><code>[crates\ruff\src\main.rs:43:5] wild::args_os().into_iter().collect::&lt;Vec&lt;_&gt;&gt;() = [
    &quot;C:\\Users\\Micha\\astral\\ruff\\target\\debug\\ruff.exe&quot;,
    &quot;format&quot;,
    &quot;--check&quot;,
    &quot;--exclude&quot;,
    &quot;build\\moz.configure\\bindgen.configure&quot;,
    &quot;build\\moz.configure\\bindgen2.configure&quot;,
    &quot;build/moz.configure/bindgen.configure&quot;,
    &quot;--preview&quot;,
    &quot;--force-exclude&quot;,
    &quot;-v&quot;,
]
</code></pre>
<p>When it should not, because the glob is quoted. I&#x27;m not sure why it does that, because it has explicit handling for parsing out quoted arguments.</p>
<p>@BurntSushi does ripgrep support wildcard expansion on Windows? If so, how is it implemented? Ahh, just found <a href="https://github.com/BurntSushi/ripgrep/issues/234">BurntSushi/ripgrep#234</a> It&#x27;s not implemented üòÖ</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2026-01-18 18:27</div>
            <div class="timeline-body"><p>Aha, this is a shell issue. I don&#x27;t think there&#x27;s anything we can do about this on the Ruff side.</p>
<p>Using <code>cmd</code>, <code>wild</code> correctly detects the double quotes. But powershell seems to strip them before calling Ruff, so that not even <code>GetCommandLineW</code> allows to retrieve the quotes.</p>
<p>I added the following code to Ruff&#x27;s <code>main</code> function to get the raw arguments passed to create the process:</p>
<pre><code>    use std::os::windows::ffi::OsStringExt;

    #[link(name = &quot;kernel32&quot;)]
    unsafe extern &quot;system&quot; {
        fn GetCommandLineW() -&gt; *const u16;
    }

    let raw = unsafe { GetCommandLineW() };
    let len = (0..).take_while(|&amp;i| unsafe { *raw.add(i) } != 0).count();
    let slice = unsafe { std::slice::from_raw_parts(raw, len) };
    let s = std::ffi::OsString::from_wide(slice);
    eprintln!(&quot;Raw command line: {:?}&quot;, s);
</code></pre>
<p>And, on powershell, the quotes are stripped.</p>
<pre><code>Raw command line: &quot;\&quot;C:\\Users\\Micha\\astral\\ruff\\target\\debug\\ruff.exe\&quot; format --check --exclude build/moz.configure/*.configure build/moz.configure/bindgen.configure --preview --force-exclude -v&quot;
</code></pre>
<p>But they&#x27;re not when Ruff is called from <code>cmd.exe</code></p>
<pre><code>Raw command line: &quot;..\\..\\ruff\\target\\debug\\ruff.exe  format --check --exclude \&quot;build/moz.configure/*.configure\&quot; build/moz.configure/bindgen.configure --preview --force-exclude -v&quot;
</code></pre>
<p>I don&#x27;t see what Ruff can do here. Even if we were to do the expansion manually for the path arguments only, Ruff still can&#x27;t know whether <code>*.py</code> is supposed to be a glob (not quoted) or a file name (quoted) because some programs strip the quotes before calling Ruff.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from &quot;--exclude glob patterns don&#x27;t match on Windows in MSYS2 Terminal&quot; to &quot;--exclude glob patterns don&#x27;t match on Windows (glob expansion on windows)&quot; by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2026-01-18 18:27</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">needs-mre</span> removed by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2026-01-18 18:27</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2026-01-18 18:27</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 18:50:45 UTC
    </footer>
</body>
</html>
