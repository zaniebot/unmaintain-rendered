<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>--exclude glob patterns don't match on Windows in MSYS2 Terminal - astral-sh/ruff #22612</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>--exclude glob patterns don't match on Windows in MSYS2 Terminal</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/ruff/issues/22612">#22612</a>
        opened by <a href="https://github.com/ahochheiden">@ahochheiden</a>
        on 2026-01-15 23:48
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ahochheiden">@ahochheiden</a></div>
            <div class="timeline-body"><h3>Summary</h3>
<p>Glob patterns passed to <code>--exclude</code> work correctly on <code>macOS</code> but fail to match on <code>Windows</code> in an <a href="https://www.msys2.org/">MSYS2</a> terminal.</p>
<p><strong>Context:</strong>
I discovered this while migrating Firefox from <code>black</code> to <code>ruff format</code>. The <a href="https://searchfox.org/firefox-main/source/pyproject.toml#82">pyproject.toml</a> exclusions use glob patterns that work correctly on <code>macOS</code> but not on <code>Windows</code>.</p>
<p><strong>Steps to reproduce:</strong></p>
<p>Given a file that has formatting issues at  <code>build/moz.configure/bindgen.configure</code> :</p>
<ul>
<li>Run <code>ruff format --check --force-exclude --exclude &quot;build/moz.configure/*.configure&quot; build/moz.configure/bindgen.configure</code> in an MSYS2 terminal.</li>
</ul>
<p>Result:</p>
<pre><code>/d/mozilla-source/firefox
$ ruff format --check --force-exclude --exclude &quot;build/moz.configure/*.configure&quot; build/moz.configure/bindgen.configure
unformatted: File would be reformatted
   --&gt; build\moz.configure\bindgen.configure:1:1
30  |     Please update using 'cargo install cbindgen --force' or running
31  |     './mach bootstrap', after removing the existing executable located at
32  |     {}.
    -     &quot;&quot;&quot;.format(
    -                 version, cbindgen_min_version, cbindgen
    -             )
33  +     &quot;&quot;&quot;.format(version, cbindgen_min_version, cbindgen)
34  |         )
35  |     )
36  |
</code></pre>
<p>Expected result:</p>
<pre><code>warning: No Python files found under the given path(s)
</code></pre>
<p>Note: Explicit path works fine:</p>
<pre><code>/d/mozilla-source/firefox
$ ruff format --check --force-exclude --exclude &quot;build/moz.configure&quot; build/moz.configure/bindgen.configure
warning: No Python files found under the given path(s)
</code></pre>
<h3>Version</h3>
<p>ruff 0.14.9</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">question</span> added by @amyreese on 2026-01-16 02:01</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/amyreese">@amyreese</a> on 2026-01-16 02:01</div>
            <div class="timeline-body"><p>Is this a directory separator issue? What happens if you use backslashes in your exclude glob instead of forward slashes?  Eg,</p>
<pre><code>$ ruff format --check --force-exclude --exclude &quot;build\moz.configure\*.configure&quot; build\moz.configure\bindgen.configure
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ahochheiden">@ahochheiden</a> on 2026-01-16 02:26</div>
            <div class="timeline-body"><p>That yields the usual output, and this at the end:</p>
<pre><code>io: D:\mozilla-source\firefox-fresh\buildmoz.configurebindgen.configure: The system cannot find the file specified. (os error 2)
--&gt; buildmoz.configurebindgen.configure:1:1
</code></pre>
<p>Which is from MSYS eating the backslashes as escape sequences.</p>
<p>But we can get around that with <code>ruff format --check --force-exclude --exclude &quot;build\\moz.configure\\*.configure&quot; &quot;build\\moz.configure\\bindgen.configure&quot;</code></p>
<p>But that also doesn't work:</p>
<pre><code>/d/mozilla-source/firefox-fresh
$ ruff format --check --force-exclude --exclude &quot;build\\moz.configure\\*.configure&quot; 'build\moz.configure\bindgen.configure'
unformatted: File would be reformatted
   --&gt; build\moz.configure\bindgen.configure:1:1
30  |     Please update using 'cargo install cbindgen --force' or running
31  |     './mach bootstrap', after removing the existing executable located at
32  |     {}.
    -     &quot;&quot;&quot;.format(
    -                 version, cbindgen_min_version, cbindgen
    -             )
33  +     &quot;&quot;&quot;.format(version, cbindgen_min_version, cbindgen)
34  |         )
35  |     )
36  |
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">question</span> removed by @amyreese on 2026-01-16 02:28</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @amyreese on 2026-01-16 02:28</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">windows</span> added by @amyreese on 2026-01-16 02:28</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ahochheiden">@ahochheiden</a> on 2026-01-16 05:27</div>
            <div class="timeline-body"><pre><code>/d/mozilla-source/firefox-fresh
$ ruff format --check --force-exclude --exclude=&quot;build/moz.configure/*.configure&quot; build/moz.configure/bindgen.configure
warning: No Python files found under the given path(s)
</code></pre>
<p>That works. So it seems the issue is with how glob patterns are expanded when using <code>--exclude &quot;pattern&quot;</code> vs <code>--exclude=&quot;pattern&quot;</code> on Windows.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ahochheiden">@ahochheiden</a> on 2026-01-16 05:53</div>
            <div class="timeline-body"><p>I think this is the culprit: https://github.com/astral-sh/ruff/blob/0ce5ce4de11c7e3dc3aa131287c671618e61c014/crates/ruff/src/main.rs#L42</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2026-01-16 09:52</div>
            <div class="timeline-body"><p>I can't reproduce this on my machine. I checked out your repository and manually created the file.</p>
<p>Without force-exclude:</p>
<pre><code>‚ùØ uvx ruff@latest format --check --exclude &quot;build/moz.configure/*.configure&quot; build/moz.configure/bindgen.configure --preview
unformatted: File would be reformatted
 --&gt; build\moz.configure\bindgen.configure:1:1
  - a   = 3
1 + a = 3

1 file would be reformatted
</code></pre>
<p>With <code>--force-exclude</code></p>
<pre><code>‚ùØ uvx ruff@latest format --check --exclude &quot;build/moz.configure/*.configure&quot; build/moz.configure/bindgen.configure --preview --force-exclude
warning: No Python files found under the given path(s)
</code></pre>
<p>But that's when using powershell. Any chanace you're using WSL or some other unix terminal?</p>
<p>Can you try running ruff with <code>-v</code>, it should then print why it includes/excludes certain files</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> removed by @MichaReiser on 2026-01-16 09:53</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">needs-mre</span> added by @MichaReiser on 2026-01-16 09:53</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ahochheiden">@ahochheiden</a> on 2026-01-16 16:17</div>
            <div class="timeline-body"><blockquote>
<p>But that's when using powershell. Any chanace you're using WSL or some other unix terminal?</p>
</blockquote>
<p>Yes, we use <a href="https://www.msys2.org/">MSYS2</a> for Windows (Bundled via <a href="https://wiki.mozilla.org/MozillaBuild">MozillaBuild</a>). I just tried both <code>cmd</code> and <code>PowerShell</code> and cannot reproduce there. I'll update the title.</p>
<blockquote>
<p>Can you try running ruff with <code>-v</code>, it should then print why it includes/excludes certain files</p>
</blockquote>
<p>From <code>MozillaBuild</code>'s <code>MSYS2</code> within Windows Terminal:</p>
<pre><code>/d/mozilla-source/firefox
$ ruff format --check --force-exclude --exclude &quot;build/moz.configure/*.configure&quot; build/moz.configure/bindgen.configure -v
[2026-01-16][08:06:14][ruff::resolve][DEBUG] Using configuration file (via parent) at: D:\mozilla-source\firefox\pyproject.toml
[2026-01-16][08:06:14][ignore::gitignore][DEBUG] opened gitignore file: C:/Users/ahochheiden/.gitignore_global
[2026-01-16][08:06:14][ruff::commands::format][DEBUG] format_path; path=D:\mozilla-source\firefox\build\moz.configure\android-sdk.configure
[2026-01-16][08:06:14][ruff::commands::format][DEBUG] format_path; path=D:\mozilla-source\firefox\build\moz.configure\toolchain.configure
[2026-01-16][08:06:14][ruff::commands::format][DEBUG] format_path; path=D:\mozilla-source\firefox\build\moz.configure\pkg.configure
[2026-01-16][08:06:14][ruff::commands::format][DEBUG] format_path; path=D:\mozilla-source\firefox\build\moz.configure\lto-pgo.configure
[2026-01-16][08:06:14][ruff::commands::format][DEBUG] format_path; path=D:\mozilla-source\firefox\build\moz.configure\update-programs.configure
[2026-01-16][08:06:14][ruff::commands::format][DEBUG] format_path; path=D:\mozilla-source\firefox\build\moz.configure\libraries.configure
[2026-01-16][08:06:14][ruff::commands::format][DEBUG] format_path; path=D:\mozilla-source\firefox\build\moz.configure\bindgen.configure
[2026-01-16][08:06:14][ruff::commands::format][DEBUG] format_path; path=D:\mozilla-source\firefox\build\moz.configure\checks.configure
[2026-01-16][08:06:14][ruff::commands::format][DEBUG] format_path; path=D:\mozilla-source\firefox\build\moz.configure\arm.configure
[2026-01-16][08:06:14][ruff::commands::format][DEBUG] format_path; path=D:\mozilla-source\firefox\build\moz.configure\finalize-flags.configure
[2026-01-16][08:06:14][ruff::commands::format][DEBUG] format_path; path=D:\mozilla-source\firefox\build\moz.configure\default-flags.configure
[2026-01-16][08:06:14][ruff::commands::format][DEBUG] format_path; path=D:\mozilla-source\firefox\build\moz.configure\clang_plugin.configure
[2026-01-16][08:06:14][ruff::commands::format][DEBUG] format_path; path=D:\mozilla-source\firefox\build\moz.configure\bootstrap.configure
[2026-01-16][08:06:14][ruff::commands::format][DEBUG] format_path; path=D:\mozilla-source\firefox\build\moz.configure\java.configure
[2026-01-16][08:06:14][ruff::commands::format][DEBUG] format_path; path=D:\mozilla-source\firefox\build\moz.configure\memory.configure
[2026-01-16][08:06:14][ruff::commands::format][DEBUG] format_path; path=D:\mozilla-source\firefox\build\moz.configure\keyfiles.configure
[2026-01-16][08:06:14][ruff::commands::format][DEBUG] format_path; path=D:\mozilla-source\firefox\build\moz.configure\nss.configure
[2026-01-16][08:06:14][ruff::commands::format][DEBUG] format_path; path=D:\mozilla-source\firefox\build\moz.configure\nspr.configure
[2026-01-16][08:06:14][ruff::commands::format][DEBUG] format_path; path=D:\mozilla-source\firefox\build\moz.configure\flags.configure
[2026-01-16][08:06:14][ruff::commands::format][DEBUG] format_path; path=D:\mozilla-source\firefox\build\moz.configure\warnings.configure
[2026-01-16][08:06:14][ruff::commands::format][DEBUG] format_path; path=D:\mozilla-source\firefox\build\moz.configure\headers.configure
[2026-01-16][08:06:14][ruff::commands::format][DEBUG] format_path; path=D:\mozilla-source\firefox\build\moz.configure\windows.configure
[2026-01-16][08:06:14][ruff::commands::format][DEBUG] format_path; path=D:\mozilla-source\firefox\build\moz.configure\zucchini.configure
[2026-01-16][08:06:14][ruff::commands::format][DEBUG] format_path; path=D:\mozilla-source\firefox\build\moz.configure\compile-checks.configure
[2026-01-16][08:06:14][ruff::commands::format][DEBUG] format_path; path=D:\mozilla-source\firefox\build\moz.configure\util.configure
[2026-01-16][08:06:14][ruff::commands::format][DEBUG] format_path; path=D:\mozilla-source\firefox\build\moz.configure\init.configure
[2026-01-16][08:06:14][ruff::commands::format][DEBUG] format_path; path=D:\mozilla-source\firefox\build\moz.configure\compilers-util.configure
[2026-01-16][08:06:14][ruff::commands::format][DEBUG] format_path; path=D:\mozilla-source\firefox\build\moz.configure\node.configure
[2026-01-16][08:06:14][ruff::commands::format][DEBUG] format_path; path=D:\mozilla-source\firefox\build\moz.configure\rust.configure
[2026-01-16][08:06:14][tracing::span][DEBUG] Printer::print;
[2026-01-16][08:06:14][tracing::span][DEBUG] Printer::print;
[2026-01-16][08:06:14][tracing::span][DEBUG] Printer::print;
[2026-01-16][08:06:14][tracing::span][DEBUG] Printer::print;
[2026-01-16][08:06:14][tracing::span][DEBUG] Printer::print;
[2026-01-16][08:06:14][tracing::span][DEBUG] Printer::print;
[2026-01-16][08:06:14][tracing::span][DEBUG] Printer::print;
[2026-01-16][08:06:14][tracing::span][DEBUG] Printer::print;
[2026-01-16][08:06:14][tracing::span][DEBUG] Printer::print;
[2026-01-16][08:06:14][ruff::commands::format][DEBUG] Formatted 29 files in 54.00ms
unformatted: File would be reformatted
   --&gt; build\moz.configure\bindgen.configure:1:1
30  |     Please update using 'cargo install cbindgen --force' or running
31  |     './mach bootstrap', after removing the existing executable located at
32  |     {}.
    -     &quot;&quot;&quot;.format(
    -                 version, cbindgen_min_version, cbindgen
    -             )
33  +     &quot;&quot;&quot;.format(version, cbindgen_min_version, cbindgen)
34  |         )
35  |     )
36  |
</code></pre>
<p>And with the <code>--exclude=</code>:</p>
<pre><code>ruff format --check --force-exclude --exclude=&quot;build/moz.configure/*.configure&quot; build/moz.configure/bindgen.configure -v
[2026-01-16][08:09:22][ruff::resolve][DEBUG] Using configuration file (via parent) at: D:\mozilla-source\firefox\pyproject.toml
[2026-01-16][08:09:22][ruff_workspace::resolver][DEBUG] Ignored path via `exclude`: &quot;D:\\mozilla-source\\firefox\\build\\moz.configure\\bindgen.configure&quot;
warning: No Python files found under the given path(s)
</code></pre>
<p>I also verified it reproduces on <code>MSYS2</code> directly (to rule out it being related to <code>MozillaBuild</code>):</p>
<pre><code>MSYS /d/mozilla-source/firefox
$ /d/mozilla-build/python3/Scripts/ruff format --check --force-exclude --exclude &quot;build/moz.configure/*.configure&quot; build/moz.configure/bindgen.configure
unformatted: File would be reformatted
   --&gt; build\moz.configure\bindgen.configure:1:1
30  |     Please update using 'cargo install cbindgen --force' or running
31  |     './mach bootstrap', after removing the existing executable located at
32  |     {}.
    -     &quot;&quot;&quot;.format(
    -                 version, cbindgen_min_version, cbindgen
    -             )
33  +     &quot;&quot;&quot;.format(version, cbindgen_min_version, cbindgen)
34  |         )
35  |     )
36  |

```
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "--exclude glob patterns don't match on Windows" to "--exclude glob patterns don't match on Windows in MSYS2 Terminal" by @ahochheiden on 2026-01-16 16:18</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2026-01-16 16:33</div>
            <div class="timeline-body"><p>I've to add some more debug logging to understand what's happening. I'll try to find sometime soon</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2026-01-18 17:23</div>
            <div class="timeline-body"><p>Hmm, I'm still not able to reproduce this issue. I installed msys2, copied the <code>mozsearch</code> directory (I didn't want to install git).</p>
<pre><code>/c/Users/Micha/astral/ruff/target/debug/ruff.exe format --check --force-exclude --exclude &quot;build/moz.configure/*.configure&quot; build/moz.configure/bindgen.configure --preview -v
[2026-01-18][18:16:17][ruff::resolve][DEBUG] Using Ruff default settings
[2026-01-18][18:16:17][ruff_workspace::resolver][DEBUG] Ignored path via `exclude`: &quot;C:\\msys64\\home\\Micha\\mozsearch\\build\\moz.configure\\bindgen.configure&quot;
warning: No Python files found under the given path(s)
</code></pre>
<p>works fine. I even built 0.14.9 from source (because no uvx in my MSYS environment), but I got the same result.</p>
<p>Can you try to remove or rename <code>D:\mozilla-source\firefox\pyproject.toml</code>. I wonder if it's some bad interaction between the config file and the CLI arguments.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2026-01-18 17:26</div>
            <div class="timeline-body"><p>Okay, you need to have at least two files matching <code>&quot;build/moz.configure/*.configure&quot;</code> for it to reproduce.</p>
<p>Once you have two files, it reproduces both on msys and powershell. Where it correctly excludes the first file, but not any others</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2026-01-18 18:01</div>
            <div class="timeline-body"><p>The issue is that <code>wild</code> expands <code>&quot;build/moz.configure/*.configure&quot;</code> to</p>
<pre><code>[crates\ruff\src\main.rs:43:5] wild::args_os().into_iter().collect::&lt;Vec&lt;_&gt;&gt;() = [
    &quot;C:\\Users\\Micha\\astral\\ruff\\target\\debug\\ruff.exe&quot;,
    &quot;format&quot;,
    &quot;--check&quot;,
    &quot;--exclude&quot;,
    &quot;build\\moz.configure\\bindgen.configure&quot;,
    &quot;build\\moz.configure\\bindgen2.configure&quot;,
    &quot;build/moz.configure/bindgen.configure&quot;,
    &quot;--preview&quot;,
    &quot;--force-exclude&quot;,
    &quot;-v&quot;,
]
</code></pre>
<p>The issue here is that <code>wild</code> expands an argument in a position where we don't want it to expand. It might make more sense to just call <code>glob</code> ourselves for the few positions where we accept file names rather than applying it to all arguments</p>
<p>@BurntSushi does ripgrep support wildcard expansion on Windows? If so, how is it implemented? Ahh, just found https://github.com/BurntSushi/ripgrep/issues/234 It's not implemented üòÖ</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-18 18:17:33 UTC
    </footer>
</body>
</html>
