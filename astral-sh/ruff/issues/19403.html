<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PYI016 fix introduces a `TypeError` for `Union[None, None]` - astral-sh/ruff #19403</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>PYI016 fix introduces a `TypeError` for `Union[None, None]`</h1>

    <div class="meta">
        <span class="state state-closed">Closed</span>
        <a href="https://github.com/astral-sh/ruff/issues/19403">#19403</a>
        opened by <a href="https://github.com/dscorbett">@dscorbett</a>
        on 2025-07-17 15:51
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/dscorbett">@dscorbett</a> on 2025-07-17 15:51</div>
            <div class="timeline-body"><h3>Summary</h3>
<p>When all the elements of a <code>Union</code> are <code>None</code>, the fix for <a href="https://docs.astral.sh/ruff/rules/duplicate-union-member/"><code>duplicate-union-member</code> (PYI016)</a> introduces a <code>TypeError</code>. <a href="https://play.ruff.rs/27f2c40f-2ac9-4949-a25b-0de875366a5a">Example</a>:</p>
<pre><code class="language-console">$ cat &gt;pyi016.py &lt;&lt;'# EOF'
from typing import Union
isinstance(None, Union[None, None])
# EOF

$ ruff --isolated check pyi016.py --select PYI016 --fix
Found 1 error (1 fixed, 0 remaining).

$ cat pyi016.py
from typing import Union
isinstance(None, None)

$ python pyi016.py 2&gt;&amp;1 | tail -n 1
TypeError: isinstance() arg 2 must be a type, a tuple of types, or a union
</code></pre>
<h3>Version</h3>
<p>ruff 0.12.3 (5bc81f26c 2025-07-11)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @ntBre on 2025-07-17 16:04</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">fixes</span> added by @ntBre on 2025-07-17 16:04</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">help wanted</span> added by @ntBre on 2025-07-17 16:04</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/soundsonacid">@soundsonacid</a> on 2025-07-17 16:29</div>
            <div class="timeline-body"><p>will take this one</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @soundsonacid by @ntBre on 2025-07-17 16:33</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/19416.html">astral-sh/ruff#19416</a> on 2025-07-17 23:21</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/soundsonacid">@soundsonacid</a> on 2025-07-17 23:22</div>
            <div class="timeline-body"><p>semantically, this issue seems to bring up a problem that is pretty tricky to solve.</p>
<p>there’s some situations in which reducing from <code>Union[None, None]</code> to <code>None</code> will introduce a <code>TypeError</code>.</p>
<p>for example:</p>
<p>this program runs:</p>
<pre><code class="language-python">from typing import Union
print(isinstance(None, Union[None, None]))
</code></pre>
<p>but this program:</p>
<pre><code class="language-python">print(isinstance(None, None))
</code></pre>
<p>throws</p>
<pre><code>  Traceback (most recent call last):
  File &quot;/Users/frank/throws_error.py&quot;, line 1, in &lt;module&gt;
    print(isinstance(None, None))
TypeError: isinstance() arg 2 must be a type, a tuple of types, or a union
</code></pre>
<p>the typical fix for PYI108 would be to reduce the <code>Union[None, None]</code> to <code>None</code> by virtue of the duplicate union member, but in this case that obviously doesn't work correctly.</p>
<p><a href="https://github.com/astral-sh/ruff/pull/19416">this pr</a>, as discussed with @ntBre, addresses the problem with a kind of duct-tapey solution, which is to <code>defuse</code> all <code>DiagnosticGuard</code>s created within <code>duplicate_union_member</code> if the only union members are <code>None</code>.</p>
<p>this is obviously not ideal as <code>Union[None, None] </code> <em>can</em> be reduced in any expr, and in some cases <em>should</em> be reduced to simply <code>None</code>, such as in a type hint:</p>
<pre><code class="language-python">x: Union[None, None] = None
</code></pre>
<p>as i see it, there's two primary options for a more adventurous solution here:</p>
<ol>
<li><p>do not reduce <code>Union[T, T]</code> when it is being passed as a function argument if the underlying <code>T</code> is a non-type or a non-runtime-checkable special form.</p>
</li>
<li><p>reduce <code>Union[T, T]</code> to <code>type(T)</code> when it is being passed as a function argument if the underlying <code>T</code> is a non-type or a non-runtime-checkable special form.</p>
</li>
</ol>
<p>the main issue with both of these two options is that we would have to be able to statically determine whether or not a given function requires a type, a tuple of types, or a union (such as <code>isinstance</code>).</p>
<p>figuring this out statically seems pretty tough without hardcoding a bunch of function names, and even then i can still do stuff like this:</p>
<pre><code>~
➜ cat override.py
def isinstance(foo, bar):
    print(&quot;oops!&quot;)

isinstance(None, None)

~
➜ python override.py
oops!
</code></pre>
<p>which might cause some user-defined functions, in corner cases, to break if <code>Union[T, T]</code> is reduced to <code>type(T)</code>.  we may not be concerned about something that narrow though.</p>
<p>any input on what direction to go here for a more concrete fix would be super appreciated!  tagging @AlexWaygood for visibility, was told that he is the resident expert on <code>typing</code> and code owner of PYI rules</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-07-18 08:59</div>
            <div class="timeline-body"><p>Thanks for diving this deep into this. Should we just bail out and not provide a fix in those cases. It seems rare enough and something a user can judge better.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/soundsonacid">@soundsonacid</a> on 2025-07-18 13:28</div>
            <div class="timeline-body"><p>yeah that is what we were thinking initially, pr #19416 does that but currently has a bug (will resolve today) with handling <code>Optional[None]</code> types.</p>
<p>i was hopeful that we could come up with a more comprehensive solution here but it does seem like bailing out &amp; not providing a fix in the most common cases is definitely the easiest way to go about it. we could also potentially leave an <code>Applicability::DisplayOnly</code> fix  saying something like &quot;either reduce to <code>type(T)</code> or <code>T</code> depending on the usage&quot;.  even that feels somewhat awkward to me though.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dscorbett">@dscorbett</a> on 2025-08-14 11:43</div>
            <div class="timeline-body"><p>The example in the original comment has been fixed. Is there anything left to do for this issue?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @AlexWaygood on 2025-08-14 12:06</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:34:55 UTC
    </footer>
</body>
</html>
