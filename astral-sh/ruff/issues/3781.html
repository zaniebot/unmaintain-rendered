<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inconsistent results running ruff via `poetry` and `pre-commit` - astral-sh/ruff #3781</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Inconsistent results running ruff via <code>poetry</code> and <code>pre-commit</code></h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/issues/3781">#3781</a>
        opened by <a href="https://github.com/ghost">@ghost</a>
        on 2023-03-28 18:33
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ghost">@ghost</a></div>
            <div class="timeline-body"><!--
Thank you for taking the time to report an issue! We're glad to have you involved with Ruff.

If you're filing a bug report, please consider including the following information:

* A minimal code snippet that reproduces the bug.
* The command you invoked (e.g., `ruff /path/to/file.py --fix`), ideally including the `--isolated` flag.
* The current Ruff settings (any relevant sections from your `pyproject.toml`).
* The current Ruff version (`ruff --version`).
-->

<p>I have ruff set up in my (monorepo's) <code>.pre-commit-config.yaml</code>, and this runs and I see a bunch of problems! Yay? For instance:</p>
<pre><code class="language-shell">% pre-commit run --files app/tools.py
# bunch of junk
ruff.....................................................................Failed
- hook id: ruff
- exit code: 1

projects/role_explorer/app/tools.py:65:21: PLR2004 Magic value used in comparison, consider replacing 365 with a constant variable
projects/role_explorer/app/tools.py:71:34: ANN401 Dynamically typed expressions (typing.Any) are disallowed in `v`
</code></pre>
<p>Sweet! But! I'm also trying to make sure I'm not too startled by large problems that ruff finds, so I try this:</p>
<pre><code class="language-shell">% poetry run ruff check app/tools.py ; and echo &quot;wat&quot; # I use fish
wat
</code></pre>
<p>huh? I would expect <code>ruff</code> in both cases to act identically.</p>
<p>If I dump the config with <code>--show-settings</code> I see all my changes from my <code>pyproject.toml</code>, but they're seemingly ignored when I run ruff? I'm really confused here.</p>
<p>Thanks? Thoughts?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ghost">@ghost</a> on 2023-03-28 18:44</div>
            <div class="timeline-body"><p>This is version 0.0.259, the same in both places.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ghost">@ghost</a> on 2023-03-28 18:45</div>
            <div class="timeline-body"><p>I turned on <code>select = [&quot;ALL&quot;]</code> for the purposes of this demonstration.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ghost">@ghost</a> on 2023-03-28 19:28</div>
            <div class="timeline-body"><p>OK, more oddness. The project setup looks like:</p>
<pre><code>monorepo/.pre-commit-config.yaml
monorepo/projects/project_name
monorepo/projects/project_name/pyproject.toml
monorepo/projects/project_name/app/tools.py
</code></pre>
<p>If I run <code>ruff check app/tools.py</code> from the <code>project_name</code> directory, nothing happens (the errors in <code>tools.py</code> are not caught). If I run <code>ruff check projects/project_name/app/tools.py</code>, everything works as expected. Even specifying the configuration (<code>ruff check --config ./pyproject.toml app/tools.py</code>) does nothing. I can see that the <code>toml</code> is being read in both cases, because when I dump the config with <code>--show-settings</code>, I get identical output <em>regardless</em> of where I'm running ruff. This is very odd!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ghost">@ghost</a> on 2023-03-28 19:31</div>
            <div class="timeline-body"><p>This is on a Mac, btw:</p>
<pre><code class="language-shell">% uname -a
Darwin moominmama.local 22.4.0 Darwin Kernel Version 22.4.0: Mon Mar  6 20:59:28 PST 2023; root:xnu-8796.101.5~3/RELEASE_ARM64_T6000 arm64
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-03-28 19:41</div>
            <div class="timeline-body"><p>Is this in a public repo? Not obvious to me whatâ€™s going on but happy to debug.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ghost">@ghost</a> on 2023-03-28 19:42</div>
            <div class="timeline-body"><p>gaaaaaaaaaaaah please ignore I am very dumb (<code>fix-only</code> is a thing!)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @ghost on 2023-03-28 19:42</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-03-28 19:56</div>
            <div class="timeline-body"><p>Aw man, you probably fell victim to one of the edge cases in configuration, which is that there are a few <code>pyproject.toml</code> fields that are only respected when you run from the current directory (<code>fix-only</code>, fix`, maybe one or two others). All other fields work as expected regardless of where you invoke Ruff from.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 16:46:54 UTC
    </footer>
</body>
</html>
