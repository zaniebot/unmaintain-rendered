<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cursor jumps to bottom of file when auto-formatting on save - astral-sh/ruff #12128</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Cursor jumps to bottom of file when auto-formatting on save</h1>

    <div class="meta">
        <span class="state state-closed">Closed</span>
        <a href="https://github.com/astral-sh/ruff/issues/12128">#12128</a>
        opened by <a href="https://github.com/DetachHead">@DetachHead</a>
        on 2024-07-01 01:59
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/DetachHead">@DetachHead</a> on 2024-07-01 01:59</div>
            <div class="timeline-body"><p>this is a very strange bug that i can't seem to minify at all.</p>
<p>to reproduce:</p>
<ol>
<li>set <code>ruff.nativeServer</code> to <code>true</code></li>
<li>set <code>editor.formatOnSave</code> to <code>true</code> (it seems to only happen reliably when formatting on save)</li>
<li>insert a newline near the top of a large file (in my case i copied the contents of <code>builtins.pyi</code> into a random <code>.py</code> file in my project)</li>
<li>save the file with ctrl+s</li>
</ol>
<p>https://github.com/astral-sh/ruff/assets/57028336/c030626b-d7ac-48fc-8259-a3c6269de2c4</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-07-01 02:01</div>
            <div class="timeline-body"><p>Oh wow, thanks for the video.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @charliermarsh on 2024-07-01 02:01</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">server</span> added by @charliermarsh on 2024-07-01 02:01</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "new language server jumps to the bottom of the file when inserting newline and formatting a file with thousands of lines of code" to "Cursor jumps to bottom of file when auto-formatting on save" by @dhruvmanila on 2024-07-02 04:29</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-07-02 07:29</div>
            <div class="timeline-body"><p>Unfortunately, I'm not able to reproduce this. Can you provide some additional details like:</p>
<ol>
<li>VS Code version</li>
<li>Ruff version</li>
<li>Ruff VS Code extension version</li>
<li>Any relevant VS Code settings related to Python and Ruff</li>
<li>If relevant, <code>pyproject.toml</code> / <code>ruff.toml</code> settings</li>
</ol>
<p>I've copied the <a href="https://github.com/python/typeshed/blob/main/stdlib/builtins.pyi"><code>builtins.pyi</code> file</a> and following the exact steps as you are:</p>
<p>https://github.com/astral-sh/ruff/assets/67177269/71d46ff6-922b-41a9-8cdc-ad00aad10039</p>
<p>Can you also provide the output of &quot;Ruff: Print Debug Information&quot; command. Here's mine:</p>
<pre><code>2024-07-02 12:57:10.422 [info] [Info  - 12:57:10 PM] executable = /Users/dhruv/.local/bin/ruff
version = 0.5.0
encoding = UTF16
open_document_count = 1
active_workspace_count = 1
configuration_files = [&quot;/Users/dhruv/playground/ruff/pyproject.toml&quot;]
capabilities.code_action_deferred_edit_resolution = true
capabilities.apply_edit = true
capabilities.document_changes = true
capabilities.workspace_refresh = true
capabilities.pull_diagnostics = true
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone "Ruff Server: Stable" by @dhruvmanila on 2024-07-02 11:15</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">needs-info</span> added by @dhruvmanila on 2024-07-03 03:36</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/DetachHead">@DetachHead</a> on 2024-07-03 05:01</div>
            <div class="timeline-body"><p>sorry, i completely forgot that i'm using <a href="https://github.com/detachhead/basedpyright?tab=readme-ov-file#docstrings-for-compiled-builtin-modules">a different version of the builtin stubs with docstrings in them</a>, and the issue doesn't seem to occur without them.</p>
<p><a href="https://github.com/user-attachments/files/16077236/foo.txt">here's the version of the file i was running it on</a> (sorry it's a <code>.txt</code> instead of <code>.py</code> because github doesn't let you upload python files for some reason)</p>
<p>in case you still aren't able to reproduce it, heres the additional info you requested:</p>
<p>vscode: v1.90.2
ruff: v0.4.10 (also tested on v0.5.0)
ruff vscode extension: v2024.30.0
<code>pyproject.toml</code>/<code>ruff.toml</code>: N/A, i deleted them and the issue still occurs
vscode settings related to ruff: <code>{&quot;ruff.nativeServer&quot;: true, &quot;[python]&quot;: {&quot;editor.formatOnSave&quot;: true, &quot;editor.defaultFormatter&quot;: &quot;charliermarsh.ruff&quot;}}</code></p>
<p>ruff debug info:</p>
<pre><code>executable = c:\Users\user\project\.venv\Scripts\ruff.exe
version = 0.4.10
encoding = UTF16
open_document_count = 28
active_workspace_count = 1
configuration_files = [&quot;c:\\Users\\user\\project\\ruff.toml&quot;]
capabilities.code_action_deferred_edit_resolution = true
capabilities.apply_edit = true
capabilities.document_changes = true
capabilities.workspace_refresh = true
capabilities.pull_diagnostics = true
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-07-03 05:32</div>
            <div class="timeline-body"><p>Thank you for providing the details! I can reproduce it now.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">needs-info</span> removed by @dhruvmanila on 2024-07-03 05:32</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @dhruvmanila by @dhruvmanila on 2024-07-03 09:46</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-07-03 10:57</div>
            <div class="timeline-body"><p>I think this is happening because the replacement algorithm (https://github.com/astral-sh/ruff/blob/88a4cc41f76cbb5d1318d5e689b118ec624b8d69/crates/ruff_server/src/edit/replacement.rs) is different than the one in <code>ruff-lsp</code> (https://github.com/astral-sh/ruff-lsp/blob/c51c77c269c3f13be2534d118b81e1c3b9bbfaff/ruff_lsp/server.py#L1430-L1470).</p>
<p>The returned <code>TextEdit</code> replacement range is different for the same formatting between <code>ruff server</code> and <code>ruff-lsp</code>:</p>
<pre><code class="language-jsonc">// ruff server
2024-07-03 16:26:59.123 [info] Result: [
    {
        &quot;newText&quot;: &quot;...&quot;,
        &quot;range&quot;: {
            &quot;end&quot;: {
                &quot;character&quot;: 0,
                &quot;line&quot;: 5089
            },
            &quot;start&quot;: {
                &quot;character&quot;: 0,
                &quot;line&quot;: 1146
            }
        }
    }
]


// ruff-lsp
2024-07-03 16:26:20.420 [info] Result: [
    {
        &quot;range&quot;: {
            &quot;start&quot;: {
                &quot;line&quot;: 1146,
                &quot;character&quot;: 0
            },
            &quot;end&quot;: {
                &quot;line&quot;: 1149,
                &quot;character&quot;: 0
            }
        },
        &quot;newText&quot;: &quot;&quot;
    }
]
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/12171.html">astral-sh/ruff#12171</a> on 2024-07-03 15:33</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @dhruvmanila on 2024-07-04 03:54</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @dhruvmanila on 2024-07-04 03:54</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:34:53 UTC
    </footer>
</body>
</html>
