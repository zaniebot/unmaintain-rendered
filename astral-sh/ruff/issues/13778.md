```yaml
number: 13778
title: "[red-knot] support invalid syntax without panics"
type: issue
state: closed
author: carljm
labels:
  - ty
assignees: []
created_at: 2024-10-16T16:03:52Z
updated_at: 2024-12-09T16:10:56Z
url: https://github.com/astral-sh/ruff/issues/13778
synced_at: 2026-01-10T01:56:54Z
```

# [red-knot] support invalid syntax without panics

---

_Issue opened by @carljm on 2024-10-16 16:03_

The ruff parser is error-resilient and will generate a best-effort AST for any input, but red-knot currently assumes a valid AST in some places, and this can cause panics if it's run over an invalid AST.

We should do best-effort type-checking for invalid ASTs, and never panic.

The trick is to do this while, as much as feasible, still maintaining some useful internal invariants, and failing fast (panic is good in this case!) if those invariants are violated, rather than allowing programming errors to pass silently and result in type-checking bugs.

---

_Label `red-knot` added by @carljm on 2024-10-16 16:03_

---

_Referenced in [astral-sh/ruff#13710](../../astral-sh/ruff/issues/13710.md) on 2024-10-16 16:04_

---

_Referenced in [astral-sh/ruff#13701](../../astral-sh/ruff/pulls/13701.md) on 2024-10-16 16:10_

---

_Comment by @carljm on 2024-10-16 16:11_

https://github.com/astral-sh/ruff/pull/13701 is a useful reference on what changes were needed as of a few days ago to avoid panics on the Python files present in the ruff repo. At least some of those are due to invalid syntax.

---

_Added to milestone `Red Knot 2024` by @carljm on 2024-11-07 16:21_

---

_Assigned to @dhruvmanila by @carljm on 2024-11-07 16:21_

---

_Comment by @carljm on 2024-11-07 16:23_

In addition to "not panic", we also want to avoid useless or confusing diagnostics.

Inferring useful types in the face of syntax errors is less of a priority.

---

_Referenced in [astral-sh/ruff#13478](../../astral-sh/ruff/issues/13478.md) on 2024-11-13 02:40_

---

_Comment by @sharkdp on 2024-11-14 14:51_

We can now run red knot on all invalid-syntax examples in ruffs repository without panicking. We can also run it on a fuzzing corpus with ~4000 invalid-syntax files (https://github.com/astral-sh/ruff/issues/13448). The next step could be to look into direct fuzzing (#14157), or to look for other corpuses (corpi? corpora?) with invalid syntax examples.

---

_Comment by @MichaReiser on 2024-11-14 14:55_

@sharkdp could we extend our corpus tests to run over all ruff tests to ensure we catch regressions early? 

---

_Comment by @sharkdp on 2024-11-14 15:28_

> @sharkdp could we extend our corpus tests to run over all ruff tests to ensure we catch regressions early?

Yes â€” I'll do that.

---

_Comment by @MichaReiser on 2024-11-15 16:32_

One specific case that we should handle is that we don't put names synthesized by the parser during recovery into the symbol table (or try to look them up). There's an AST method that allows testing for whether the name is valid.

---

_Referenced in [astral-sh/ruff#14342](../../astral-sh/ruff/issues/14342.md) on 2024-11-22 09:48_

---

_Comment by @AlexWaygood on 2024-11-25 12:00_

> We can now run red knot on all invalid-syntax examples in ruffs repository without panicking. We can also run it on a fuzzing corpus with ~4000 invalid-syntax files (#13448). The next step could be to look into direct fuzzing (#14157), or to look for other corpuses (corpi? corpora?) with invalid syntax examples.

@sharkdp just to note -- the unique thing about the fuzzer in #14157 is that the randomly generated source-code files it produces are guaranteed to always be valid Python syntax (at least, assuming there isn't a bug in the fuzzer). That's an extremely useful property of the fuzzer in some ways, but it does mean that the fuzzer is somewhat useless for testing how good red-knot is at handling invalid _syntax_. We'll have to look into other fuzzing libraries if we want to have some automated fuzzing for that as well.

---

_Comment by @dhruvmanila on 2024-12-02 12:40_

I've been exploring ways to create panics on source code with syntax errors but I haven't found any that requires any source code that's raising syntax errors which isn't already documented which is https://github.com/astral-sh/ruff/issues/14672 and https://github.com/astral-sh/ruff/blob/b63c2e126b928fab4180eda5d9132552beeee7fe/crates/red_knot_workspace/tests/check.rs#L273-L277.

I've also ran the fuzzer which produces source code with invalid syntax (https://github.com/astral-sh/ruff/pull/14678) multiple times and it always finds the one as linked above. The corpus is initiated with most of the Python files in the Ruff code base and all Python files in the CPython code base. The fuzzer runs on them and then starts shuffling the bytes around producing new source code which is then filtered to avoid the ones that doesn't produce syntax errors as per our parser. This has an obvious limitation that the syntax errors that's raised by the compiler

I looked at https://github.com/astral-sh/ruff/issues/13778#issuecomment-2479383240 as well but I've been unable to create a source code that could panic. I think that might be because of lack of type inference for positions where that could occur like type parameters, function parameters in combination with the AST key that includes the node range. So, technically even though that behavior might be incorrect, it doesn't create a panic in red knot, at least not today.

Additionally, I also extracted all the examples from the syntax error test file in CPython code base (https://github.com/python/cpython/blob/bf21e2160d1dc6869fb230b90a23ab030835395b/Lib/test/test_syntax.py) as it's a doctest and ran red knot on top of it and got no panics. 

There are certain changes that can be done but I've been unable to create a source code related to those changes that would make red knot panic. I'm going to list them down here for posterity:
* Currently, for an invalid `Identifier`, the `ExprAttribute` doesn't set an `Invalid` expression context. We use this information to avoid recording a use of a symbol and / or creating the definition. Carl did mention previously that an attribute expression will be handled in a different manner and wouldn't create a definition.
* The parser recovers from a syntax error where a keyword is used instead of a name by creating a name expression with the keyword: https://play.ruff.rs/cb616a58-855a-431e-8ee3-3ecd6320e45d. The downstream tools have no way of knowing whether this identifier was recovered from this syntax error. Regardless, this shouldn't cause any panic.
* Avoid adding the symbol for an `ExprName` which has an invalid expression context as that indicates a syntax error from which the parser recovered

That said, I think we should periodically run the fuzzer and iteratively fix any errors that the model encounters. The model is still a work in progress so there are missing pieces which might prove necessary to create these panics if any.

---

_Referenced in [astral-sh/ruff#14736](../../astral-sh/ruff/pulls/14736.md) on 2024-12-02 15:55_

---

_Comment by @MichaReiser on 2024-12-02 16:39_

Thanks for writing this up. 

Do you think it would be possible and useful to have mdtests for invalid identifiers and keywords used as identifiers?

---

_Comment by @dhruvmanila on 2024-12-03 04:59_

> Do you think it would be possible and useful to have mdtests for invalid identifiers and keywords used as identifiers?

I think they should be covered by the invalid parser tests:
* Keyword assignment target: https://github.com/astral-sh/ruff/blob/5137fcc9c81610f687b6cb45413ef83c2c5eea73/crates/ruff_python_parser/resources/inline/err/assign_stmt_keyword_target.py
* Invalid assignment target: https://github.com/astral-sh/ruff/blob/5137fcc9c81610f687b6cb45413ef83c2c5eea73/crates/ruff_python_parser/resources/invalid/statements/invalid_assignment_targets.py
* Invalid augmented assignment target: https://github.com/astral-sh/ruff/blob/5137fcc9c81610f687b6cb45413ef83c2c5eea73/crates/ruff_python_parser/resources/invalid/statements/invalid_augmented_assignment_target.py

Although, I think they don't have complete coverage especially around "keywords used as identifiers", I'll add them.

---

_Comment by @MichaReiser on 2024-12-03 07:20_

That makes sense, thanks. 

We could also assert that red knot doesn't generate useless diagnostics for missing identifiers. For example. Red Knot should not emit a `undefined-variable` diagnostic for

```py
5 + 
```



---

_Referenced in [astral-sh/ruff#14753](../../astral-sh/ruff/pulls/14753.md) on 2024-12-03 11:12_

---

_Referenced in [astral-sh/ruff#14754](../../astral-sh/ruff/pulls/14754.md) on 2024-12-03 11:25_

---

_Closed by @carljm on 2024-12-09 16:10_

---

_Referenced in [astral-sh/ty#572](../../astral-sh/ty/issues/572.md) on 2025-06-03 08:32_

---
