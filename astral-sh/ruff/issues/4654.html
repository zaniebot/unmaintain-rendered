<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>False positive for unused import when using type as string with generic class behind TYPE_CHECKING flag - astral-sh/ruff #4654</title>
    <link rel="stylesheet" href="../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../index.html">Back to index</a>
    </div>

    <h1>False positive for unused import when using type as string with generic class behind TYPE_CHECKING flag</h1>

    <div class="meta">
        <span class="state state-closed">Closed</span>
        <a href="https://github.com/astral-sh/ruff/issues/4654">#4654</a>
        opened by <a href="https://github.com/last-partizan">@last-partizan</a>
        on 2023-05-25 11:36
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/last-partizan">@last-partizan</a> on 2023-05-25 11:36</div>
            <div class="timeline-body"><!--
Thank you for taking the time to report an issue! We're glad to have you involved with Ruff.

If you're filing a bug report, please consider including the following information:

* A minimal code snippet that reproduces the bug.
* The command you invoked (e.g., `ruff /path/to/file.py --fix`), ideally including the `--isolated` flag.
* The current Ruff settings (any relevant sections from your `pyproject.toml`).
* The current Ruff version (`ruff --version`).
-->

<p>Hello, this happens when using django models with <code>django-types</code> and <code>ForeignKey[&quot;SomeModel&quot;]</code>, but here's minimal example without django:</p>
<pre><code class="language-python">from typing import TYPE_CHECKING, Generic, TypeVar


if TYPE_CHECKING:
    from pathlib import Path

T = TypeVar(&quot;T&quot;)


class ForeignKey(Generic[T]):
    ...


class Foo:
    var = ForeignKey[&quot;Path&quot;]()
</code></pre>
<pre><code class="language-sh">&gt; ruff --version
ruff 0.0.270
&gt; ruff --isolated /tmp/test.py
/tmp/test.py:5:25: F401 [*] `pathlib.Path` imported but unused
Found 1 error.
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @charliermarsh on 2023-05-25 14:12</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">type-inference</span> added by @charliermarsh on 2023-05-25 14:12</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-05-25 14:14</div>
            <div class="timeline-body"><p>Ruff isn't able to do that level of reasoning right now (i.e., to know that <code>ForeignKey</code> is a generic, and so <code>&quot;Path&quot;</code> should be treated as a forward reference). We <em>could</em> special-case members of <code>django-types</code> to support this.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/last-partizan">@last-partizan</a> on 2023-05-27 07:18</div>
            <div class="timeline-body"><p>It would be nice.</p>
<p>If i understand correctly, <code>ruff</code> does not know about <code>django-types</code> either, so it would be django-specific special case.</p>
<p>How would it looks like?</p>
<p>I think it can be some option like <code>treat-as-generics = []</code> with default pointing to django <code>models.ForeignKey</code>, and maybe some others.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/JonathanPlasse">@JonathanPlasse</a> on 2023-05-27 08:07</div>
            <div class="timeline-body"><p>You can use the <a href="https://beta.ruff.rs/docs/settings/#typing-modules">typing-modules</a> setting.
You will have to use a separate file to define your generics.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/last-partizan">@last-partizan</a> on 2023-05-27 08:14</div>
            <div class="timeline-body"><p>@JonathanPlasse can you give an example?</p>
<p>In django-types ForeignKey is defined here:</p>
<p>https://github.com/sbdchd/django-types/blob/6e63b611329e5a8fc7b9e04e4a52e8c980734c9b/django-stubs/db/models/fields/related.pyi#L173</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/JonathanPlasse">@JonathanPlasse</a> on 2023-05-27 08:48</div>
            <div class="timeline-body"><p>Sorry, I got it wrong, a setting needs to be added to extend the annotated subscripts.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/JonathanPlasse">@JonathanPlasse</a> on 2023-05-27 09:08</div>
            <div class="timeline-body"><p>I am working on adding the setting <code>extend-annotated-subscripts</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/4677.html">astral-sh/ruff#4677</a> on 2023-05-27 09:49</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2023-06-01 22:19</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/15860.html">astral-sh/ruff#15860</a> on 2025-02-01 17:05</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:28:09 UTC
    </footer>
</body>
</html>
