<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ANN2 fixes can add return types that are shadowed - astral-sh/ruff #20610</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>ANN2 fixes can add return types that are shadowed</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/issues/20610">#20610</a>
        opened by <a href="https://github.com/dscorbett">@dscorbett</a>
        on 2025-09-28 18:06
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dscorbett">@dscorbett</a></div>
            <div class="timeline-body"><h3>Summary</h3>
<p>The fixes for <a href="https://docs.astral.sh/ruff/rules/missing-return-type-undocumented-public-function/"><code>missing-return-type-undocumented-public-function</code> (ANN201)</a>, <a href="https://docs.astral.sh/ruff/rules/missing-return-type-private-function/"><code>missing-return-type-private-function</code> (ANN202)</a>, <a href="https://docs.astral.sh/ruff/rules/missing-return-type-special-method/"><code>missing-return-type-special-method</code> (ANN204)</a>, <a href="https://docs.astral.sh/ruff/rules/missing-return-type-static-method/"><code>missing-return-type-static-method</code> (ANN205)</a>, and <a href="https://docs.astral.sh/ruff/rules/missing-return-type-class-method/"><code>missing-return-type-class-method</code> (ANN206)</a> add return types without checking for shadowed variables, which can cause type-checking errors. They should use <a href="https://github.com/astral-sh/ruff/blob/0.13.2/crates/ruff_linter/src/importer/mod.rs#L285"><code>get_or_import_builtin_symbol</code></a> or similar. <a href="https://play.ruff.rs/816d2f85-9113-4039-8009-35420b66fe07">Example</a>:</p>
<pre><code class="language-console">$ cat &gt;ann2.py &lt;&lt;'# EOF'
from collections import UserString as str
from typing import override
def foo(): return &quot;!&quot;
def _foo(): return &quot;!&quot;
class C:
    @override
    def __str__(self): return &quot;!&quot;
    @staticmethod
    def foo(): return &quot;!&quot;
    @classmethod
    def bar(cls): return &quot;!&quot;
# EOF

$ ruff --isolated check --select ANN201,ANN202,ANN204,ANN205,ANN206 ann2.py --unsafe-fixes --fix
Found 5 errors (5 fixed, 0 remaining).

$ mypy ann2.py
ann2.py:3: error: Incompatible return value type (got &quot;str&quot;, expected &quot;UserString&quot;)  [return-value]
ann2.py:4: error: Incompatible return value type (got &quot;str&quot;, expected &quot;UserString&quot;)  [return-value]
ann2.py:7: error: Return type &quot;UserString&quot; of &quot;__str__&quot; incompatible with return type &quot;str&quot; in supertype &quot;builtins.object&quot;  [override]
ann2.py:7: error: Incompatible return value type (got &quot;str&quot;, expected &quot;UserString&quot;)  [return-value]
ann2.py:9: error: Incompatible return value type (got &quot;str&quot;, expected &quot;UserString&quot;)  [return-value]
ann2.py:11: error: Incompatible return value type (got &quot;str&quot;, expected &quot;UserString&quot;)  [return-value]
Found 6 errors in 1 file (checked 1 source file)
</code></pre>
<h3>Version</h3>
<p>ruff 0.13.2 (b0bdf0334 2025-09-25)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @ntBre on 2025-09-29 20:54</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">fixes</span> added by @ntBre on 2025-09-29 20:54</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @ntBre on 2025-10-02 22:44</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 16:53:23 UTC
    </footer>
</body>
</html>
