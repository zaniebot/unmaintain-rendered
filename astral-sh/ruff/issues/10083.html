<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>B006 (unsafe fix) : does not fix correctly with @overload - astral-sh/ruff #10083</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>B006 (unsafe fix) : does not fix correctly with @overload</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/issues/10083">#10083</a>
        opened by <a href="https://github.com/yoann9344">@yoann9344</a>
        on 2024-02-22 17:43
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/yoann9344">@yoann9344</a></div>
            <div class="timeline-body"><pre><code>     @overload
     @classmethod
     def query(
         cls,
-        my_list: list[Whatever | int] = [],
+        my_list: list[Whatever | int] | None = None,
     ) -&gt; Whatever:
-        ...
+        if my_list is None:
+            my_list = []

     @overload
     @classmethod
     def query(
         cls,
-        my_list: list[Whatever | int] = [],
+        my_list: list[Whatever | int] | None = None,
     ) -&gt; Whatever:
-        ...
+        if my_list is None:
+            my_list = []

     @classmethod
-    def query(cls, session, my_list=[]):
+    def query(cls, session, my_list=None):
+        if my_list is None:
+            my_list = []
</code></pre>
<p>It should not touch overloaded functions except to change the right argument :</p>
<pre><code>-        my_list: list[Whatever | int] = [],
+        my_list: list[Whatever | int] | None = None,
</code></pre>
<p>But must not add logic in it :</p>
<pre><code>-        ...
+        if my_list is None:
+            my_list = []
</code></pre>
<p>So the result should look like this for overloaded methods :</p>
<pre><code>     @overload
     @classmethod
     def query(
         cls,
-        my_list: list[Whatever | int] = [],
+        my_list: list[Whatever | int] | None = None,
     ) -&gt; Whatever:
    ...
</code></pre>
<p>NB : this overloaded method has no sens, I removed the unnecessary.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">fixes</span> added by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-02-23 08:00</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-02-23 08:04</div>
            <div class="timeline-body"><p>Thanks for reporting this improvement. I summarised the issue again in my own words after I have played with the example for a bit.</p>
<p>The <code>B006</code> replaces the <code>[]</code> default value with <code>None</code> and inserts the</p>
<pre><code>if &lt;argument&gt; is None:
	&lt;argument&gt; = []
</code></pre>
<p>as the first statement in the body which in itself is the semantically correct refactor.</p>
<p>However, inserting the statement is undesired if the function has a stub body. I don&#x27;t think we necessarily have to test if the function has the <code>@overload</code> signature because changing the body is also undesired in typing stub files.</p>
<p><a href="https://play.ruff.rs/b39d8557-bce4-4506-a6b2-ebf2ed3b7c07">Playground</a></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">help wanted</span> added by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-02-23 08:04</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/yoann9344">@yoann9344</a> on 2024-02-23 10:08</div>
            <div class="timeline-body"><blockquote>
<p>The <code>B006</code> replaces the <code>[]</code> default value with <code>None</code> and inserts the</p>
<pre><code>if &lt;argument&gt; is None:
  &lt;argument&gt; = []
</code></pre>
<p>as the first statement in the body which in itself is the semantically correct refactor.</p>
</blockquote>
<p>Yes that&#x27;s correct, it also replaces the typing by <code>&lt;initial type&gt; | None</code></p>
<blockquote>
<p>However, inserting the statement is undesired if the function has a stub body. I don&#x27;t think we necessarily have to test if the function has the <code>@overload</code> signature because changing the body is also undesired in typing stub files.</p>
</blockquote>
<p>Well see ! I think it is the best way to handle it ! (to be clear : no statement added in stubs but method signature modified)</p>
<blockquote>
<p><a href="https://play.ruff.rs/b39d8557-bce4-4506-a6b2-ebf2ed3b7c07">Playground</a></p>
</blockquote>


Except at the end there&#x27;s not a stub body.


<pre><code>class Test:
    @overload
    @classmethod
    def query(
        cls,
        my_list: list[Whatever | int] = [],
    ) -&gt; Whatever:
        ...
    
    @overload
    @classmethod
    def query(
        cls,
        my_list: list[Whatever | int] = [],
    ) -&gt; Whatever:
        ...
    
    @classmethod
    def query(cls, my_list: list[Whatever | int] = []) -&gt; Whatever:
        raise NotImplementedError(&quot;&quot;)
</code></pre>


</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Philipp-Thiel">@Philipp-Thiel</a> on 2024-02-28 19:01</div>
            <div class="timeline-body"><p>I added code that identifies all functions, where the body consists only out of a docstring, the ... literal and/or the pass keyword as a stub and doesn&#x27;t modify the body then. But now that I think more about it, I also find the case where the function body only raises a NotImplementedError compelling. Should that maybe also be identified as a stub?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-02-28 19:22</div>
            <div class="timeline-body"><p>@Philipp-Thiel - Sure, that seems like a reasonable extension. You can use the <code>SemanticModel</code> to identify the exception type.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-02-28 19:22</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 18:48:50 UTC
    </footer>
</body>
</html>
