<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>New Linting Rule: Prefer `setdefault` Over Conditional Key Checks for Dictionary Assignment - astral-sh/ruff #7897</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>New Linting Rule: Prefer `setdefault` Over Conditional Key Checks for Dictionary Assignment</h1>

    <div class="meta">
        <span class="state state-open">Open</span>
        <a href="https://github.com/astral-sh/ruff/issues/7897">#7897</a>
        opened by <a href="https://github.com/danparizher">@danparizher</a>
        on 2023-10-10 15:10
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/danparizher">@danparizher</a> on 2023-10-10 15:10</div>
            <div class="timeline-body"><h1>Proposed Linting Rule</h1>
<p>The proposed new linting rule is to prefer the use of <code>setdefault</code> over over conditional checks when assigning a value to a dictionary key. This change is suggested because <code>setdefault</code> is a more concise and efficient way to check if a key exists in a dictionary and assign a value to it if it doesn't.</p>
<h2>Reason for Preference</h2>
<p>The reason for this preference is that <code>setdefault</code> combines the check for the existence of the key and the assignment of the value into a single operation. This makes the code more readable and slightly more efficient, as it reduces the number of dictionary lookups. Additionally,  <code>setdefault</code> is atomic, whereas something like <code>if &quot;x&quot; in y: y[&quot;x&quot;] = z</code> isn't thread safe. Moreover, it aligns with the Pythonic way of writing clean and efficient code.</p>
<h2>Applicability</h2>
<p>This rule can be applied to any situation where you need to check if a key exists in a dictionary and assign a value to it if it doesn't. This includes but is not limited to:</p>
<ul>
<li>Default values for function arguments</li>
<li>Default values for class attributes</li>
<li>Default values for dictionary keys</li>
</ul>
<p>In each of these cases, <code>setdefault</code> provides a more efficient and Pythonic way to handle the situation.</p>
<h2>Examples</h2>
<h3>1. Grouping items while filling a dictionary</h3>
<p>Before:</p>
<pre><code class="language-py">new = {}
for key, value in data:
    if key in new:
        new[key].append(value)
    else:
        new[key] = [value]
</code></pre>
<p>After:</p>
<pre><code class="language-py">new = {}
for key, value in data:
    new.setdefault(key, []).append(value)
</code></pre>
<p>In this scenario, <code>setdefault</code> is used to group items by their keys in a dictionary. If a key already exists in the dictionary, it appends the value to the list of values for that key. If the key does not exist, it creates a new key with a list containing the value as its value.</p>
<h3>2. Setting default values for function arguments</h3>
<p>Before:</p>
<pre><code class="language-py">def notify(self, level, *pargs, **kwargs):
    if &quot;persist&quot; not in kwargs:
        kwargs[&quot;persist&quot;] = level &gt;= DANGER
    self.__defcon.set(level, **kwargs)
</code></pre>
<p>After:</p>
<pre><code class="language-py">def notify(self, level, *pargs, **kwargs):
    kwargs.setdefault(&quot;persist&quot;, level &gt;= DANGER)
    self.__defcon.set(level, **kwargs)
</code></pre>
<p>In this scenario, <code>setdefault</code> is used to set a default value for a keyword argument in a function. If the &quot;persist&quot; keyword is not in <code>kwargs</code>, it sets it to <code>level &gt;= DANGER</code>.</p>
<h3>3. Setting default values for dictionary keys</h3>
<p>Before:</p>
<pre><code class="language-py">headers = parse_headers(msg)  # parse the message, get a dict
for headername, defaultvalue in optional_headers:
    if headername not in headers:
        headers[headername] = defaultvalue
</code></pre>
<p>After:</p>
<pre><code class="language-py">headers = parse_headers(msg)  # parse the message, get a dict
for headername, defaultvalue in optional_headers:
    headers.setdefault(headername, defaultvalue)
</code></pre>
<p>In this scenario, <code>setdefault</code> is used to ensure that specific keys exist in a dictionary after it is created. If a key is not in the dictionary, it adds the key with a specified default value.</p>
<h2>References</h2>
<ul>
<li><a href="https://docs.python.org/3/library/stdtypes.html#dict.setdefault">Python Docs: dict.setdefault</a></li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "New Linting Rule: Prefer `setdefault` Over `if not in` for Dictionary Assignment" to "New Linting Rule: Prefer `setdefault` Over Conditional Key Checks for Dictionary Assignment" by @danparizher on 2023-10-10 15:16</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">rule</span> added by @dhruvmanila on 2023-10-12 05:21</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">needs-decision</span> added by @dhruvmanila on 2023-10-12 05:21</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/16775.html">astral-sh/ruff#16775</a> on 2025-03-16 12:39</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:34:51 UTC
    </footer>
</body>
</html>
