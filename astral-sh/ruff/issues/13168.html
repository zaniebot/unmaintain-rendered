<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[red-knot] assert that we don't infer the same expression/definition in multiple regions - astral-sh/ruff #13168</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[red-knot] assert that we don't infer the same expression/definition in multiple regions</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/issues/13168">#13168</a>
        opened by <a href="https://github.com/carljm">@carljm</a>
        on 2024-08-30 19:23
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/carljm">@carljm</a> on 2024-08-30 19:23</div>
            <div class="timeline-body"><p>We should not double-infer the same expression (or the same definition) in e.g. both &quot;scope&quot; region and &quot;definition&quot; region.</p>
<p>To check this invariant, we could modify <code>TypeInferenceBuilder::extend</code> to check that the sets of keys in the two expression maps and definition maps being combined are disjoint.</p>
<p>This will probably be a bit costly, so we probably want to do it only in a debug build.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by @carljm on 2024-08-30 19:23</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2024-11-07 15:12</div>
            <div class="timeline-body"><p>@MichaReiser I think you recently added an assertion for this and cleaned up the existing issues? Closing as completed, feel free to reopen if you feel there's more we should do here.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @carljm on 2024-11-07 15:12</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-11-07 15:20</div>
            <div class="timeline-body"><p>I added an assertion for expressions. I don't think we currently handle <code>Definition</code>s but it's also unclear to me how to detect this. However, we do have unit tests that pull the types of every (or most) definitions... so maybe that's fine for now</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 11:35:00 UTC
    </footer>
</body>
</html>
