<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Feature Request: Support formatting for `sphinx.ext.doctest` (`.. testcode::`) in docstrings - astral-sh/ruff #21640</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Feature Request: Support formatting for <code>sphinx.ext.doctest</code> (<code>.. testcode::</code>) in docstrings</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/ruff/issues/21640">#21640</a>
        opened by <a href="https://github.com/sawa3030">@sawa3030</a>
        on 2025-11-26 13:48
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/sawa3030">@sawa3030</a> on 2025-11-26 13:48</div>
            <div class="timeline-body"><h2>Summary</h2>
<p>When formatting docstrings, Ruff currently does not recognize Python code inside <code>sphinx.ext.doctest</code> directive blocks (such as <code>.. testcode::</code>). It would be helpful if these doctest-style blocks were detected and formatted in the same way as other supported docstring code blocks.</p>
<h2>Description</h2>
<p><code>sphinx.ext.doctest</code> provides directives like <code>.. testcode::</code> for writing executable examples in documentation. For example:</p>
<pre><code>class ExampleClass:
    &quot;&quot;&quot;Example class.

    Example:
        .. testcode::
            first_example = ExampleClass()
            print(first_example)
    &quot;&quot;&quot;
</code></pre>
<p>ref: <a href="https://www.sphinx-doc.org/en/master/usage/extensions/doctest.html">https://www.sphinx-doc.org/en/master/usage/extensions/doctest.html</a></p>
<p>At the moment, Ruff does not format the code inside the <code>.. testcode::</code> block.
Ref: <a href="https://docs.astral.sh/ruff/formatter/#docstring-formatting">https://docs.astral.sh/ruff/formatter/#docstring-formatting</a></p>
<p>It would be great if Ruff could also format the Python code within these blocks, similarly to other reStructuredText code directives.</p>
<p>Iâ€™m happy to open a PR to add support for this, if I could.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-11-27 07:25</div>
            <div class="timeline-body"><p>There are other directives that we should support in addition to just <code>testcode</code>, e.g. <code>testsetup</code> and <code>testcleanup</code></p>
<p>I haven't taken a close look but I think this shouldn't be too hard to add (@BurntSushi feel free to correct me), given that we already support <code>code-block::</code>. All that might be needed is to add <code>testcode</code>, <code>testsetup</code>, ... here:</p>
<p>https://github.com/astral-sh/ruff/blob/7627d3879c26dd3e9510eea8a63239f08dae1cbe/crates/ruff_python_formatter/src/string/docstring.rs#L1025-L1041</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">formatter</span> added by @MichaReiser on 2025-11-27 07:25</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 11:38:47 UTC
    </footer>
</body>
</html>
