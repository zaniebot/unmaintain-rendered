<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Autofix is unable to skip identical import edits - astral-sh/ruff #5800</title>
    <link rel="stylesheet" href="../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../index.html">Back to index</a>
    </div>

    <h1>Autofix is unable to skip identical import edits</h1>

    <div class="meta">
        <span class="state state-closed">Closed</span>
        <a href="https://github.com/astral-sh/ruff/issues/5800">#5800</a>
        opened by <a href="https://github.com/dhruvmanila">@dhruvmanila</a>
        on 2023-07-16 09:03
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2023-07-16 09:03</div>
            <div class="timeline-body"><p>There are 22 violations in this <a href="https://github.com/astral-sh/ruff/blob/d692ed08961cbdc56a9f254fba906bd6d3b711d8/crates/ruff/resources/test/fixtures/ruff/RUF013_0.py">test file</a> for <code>RUF013</code>. The autofix for the same contains an edit created using <code>get_or_import_symbol</code>. This creates a <a href="https://github.com/astral-sh/ruff/blob/d692ed08961cbdc56a9f254fba906bd6d3b711d8/crates/ruff/src/importer/mod.rs#L205-L220">no-op edit</a> for every violation. The autofix module is unable to detect that this was already applied and thus not skipping it. This means that there are multiple edits on the same line, thus it skips applying the other fix for the current iteration. This means it applies fix one at a time for each iteration from the 22 violations, meaning it requires 22 iterations to apply all of the fixes.</p>
<h3>How to reproduce?</h3>
<ol>
<li>Update the <code>MAX_ITERATIONS</code> to 21 (1 less than the total violations reported) here:</li>
</ol>
<p>https://github.com/astral-sh/ruff/blob/d692ed08961cbdc56a9f254fba906bd6d3b711d8/crates/ruff/src/linter.rs#L250</p>
<ol start="2">
<li><p>Run the following command:</p>
<pre><code class="language-console">cargo run --bin ruff -- check --select=RUF013 --no-cache --isolated crates/ruff/resources/test/fixtures/ruff/RUF013_0.py --target-version=py39 --fix --diff
</code></pre>
</li>
</ol>
<p>Output:</p>
<pre><code>debug error: Failed to converge after 21 iterations in `crates/ruff/resources/test/fixtures/ruff/RUF013_0.py` with rule codes RUF013:---
</code></pre>
<p>Or, for the test case:</p>
<ol>
<li>Update the <code>MAX_ITERATIONS</code> to 21 here:</li>
</ol>
<p>https://github.com/astral-sh/ruff/blob/d692ed08961cbdc56a9f254fba906bd6d3b711d8/crates/ruff/src/test.rs#L86</p>
<ol start="2">
<li><p>Run the following command:</p>
<pre><code class="language-console">cargo test --package ruff --lib --all-features -- rules::ruff::tests::implicit_optional_py39 --nocapture
</code></pre>
</li>
</ol>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @dhruvmanila on 2023-07-16 09:03</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">autofix</span> added by @dhruvmanila on 2023-07-16 09:03</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/6144.html">astral-sh/ruff#6144</a> on 2023-07-28 04:18</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2023-07-29 12:11</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:28:09 UTC
    </footer>
</body>
</html>
