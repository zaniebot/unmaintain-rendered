<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Server doesn't detect ruff config for files not under working directory of server - astral-sh/ruff #17944</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Server doesn&#x27;t detect ruff config for files not under working directory of server</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/ruff/issues/17944">#17944</a>
        opened by <a href="https://github.com/harrymander">@harrymander</a>
        on 2025-05-08 11:12
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/harrymander">@harrymander</a></div>
            <div class="timeline-body">Summary
<p><code>ruff server</code> does not find settings (e.g. <code>ruff.toml</code>) when processing files that are not under the directory that the server command was invoked in, instead falling back to the default config.</p>
<p>This was tested using Sublime Text with the sublimelsp package using the following directory structure:</p>
<pre><code>ruff-server-test
├── project-a
│   ├── ruff.toml
│   └── test.py
└── project-b &lt;- ruff server invoked in this directory
    ├── ruff.toml
    └── test.py
</code></pre>
<p>If the Sublime workspace is opened in <code>project-b</code>, and <code>project-a/test.py</code> is added to the workspace as a &quot;free&quot; file, calling <code>textDocument/formatting</code> causes the file to be formatted incorrectly. Debug logs including a server restart are shown below (I have isolated lines the relevant lines and added  <code>!!!</code> at start).</p>
<pre><code>LSP-ruff: 2025-05-08 22:48:24.102709487  INFO Shutdown request received. Waiting for an exit notification...
[22:48:24.102] --&gt; LSP-ruff shutdown (4): None
LSP-ruff: 2025-05-08 22:48:24.124943287  INFO Exit notification received. Server shutting down...
[22:48:24.124] --&gt; LSP-ruff initialize (1): {&#x27;processId&#x27;: 25194, &#x27;clientInfo&#x27;: {&#x27;name&#x27;: &#x27;Sublime Text LSP&#x27;, &#x27;version&#x27;: &#x27;2.3.0&#x27;}, &#x27;rootUri&#x27;: &#x27;file:///home/harry/scratch/ruff-server-test/project-b&#x27;, &#x27;rootPath&#x27;: &#x27;/home/harry/scratch/ruff-server-test/project-b&#x27;, &#x27;workspaceFolders&#x27;: [{&#x27;name&#x27;: &#x27;project-b&#x27;, &#x27;uri&#x27;: &#x27;file:///home/harry/scratch/ruff-server-test/project-b&#x27;}], &#x27;capabilities&#x27;: {&#x27;general&#x27;: {&#x27;regularExpressions&#x27;: {&#x27;engine&#x27;: &#x27;ECMAScript&#x27;}, &#x27;markdown&#x27;: {&#x27;parser&#x27;: &#x27;Python-Markdown&#x27;, &#x27;version&#x27;: &#x27;3.2.2&#x27;}}, &#x27;textDocument&#x27;: {&#x27;synchronization&#x27;: {&#x27;dynamicRegistration&#x27;: True, &#x27;didSave&#x27;: True, &#x27;willSave&#x27;: True, &#x27;willSaveWaitUntil&#x27;: True}, &#x27;hover&#x27;: {&#x27;dynamicRegistration&#x27;: True, &#x27;contentFormat&#x27;: [&#x27;markdown&#x27;, &#x27;plaintext&#x27;]}, &#x27;completion&#x27;: {&#x27;dynamicRegistration&#x27;: True, &#x27;completionItem&#x27;: {&#x27;snippetSupport&#x27;: True, &#x27;deprecatedSupport&#x27;: True, &#x27;documentationFormat&#x27;: [&#x27;markdown&#x27;, &#x27;plaintext&#x27;], &#x27;tagSupport&#x27;: {&#x27;valueSet&#x27;: [1]}, &#x27;resolveSupport&#x27;: {&#x27;properties&#x27;: [&#x27;detail&#x27;, &#x27;documentation&#x27;, &#x27;additionalTextEdits&#x27;]}, &#x27;insertReplaceSupport&#x27;: True, &#x27;insertTextModeSupport&#x27;: {&#x27;valueSet&#x27;: [2]}, &#x27;labelDetailsSupport&#x27;: True}, &#x27;completionItemKind&#x27;: {&#x27;valueSet&#x27;: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25]}, &#x27;insertTextMode&#x27;: 2, &#x27;completionList&#x27;: {&#x27;itemDefaults&#x27;: [&#x27;editRange&#x27;, &#x27;insertTextFormat&#x27;, &#x27;data&#x27;]}}, &#x27;signatureHelp&#x27;: {&#x27;dynamicRegistration&#x27;: True, &#x27;contextSupport&#x27;: True, &#x27;signatureInformation&#x27;: {&#x27;activeParameterSupport&#x27;: True, &#x27;documentationFormat&#x27;: [&#x27;markdown&#x27;, &#x27;plaintext&#x27;], &#x27;parameterInformation&#x27;: {&#x27;labelOffsetSupport&#x27;: True}}}, &#x27;references&#x27;: {&#x27;dynamicRegistration&#x27;: True}, &#x27;documentHighlight&#x27;: {&#x27;dynamicRegistration&#x27;: True}, &#x27;documentSymbol&#x27;: {&#x27;dynamicRegistration&#x27;: True, &#x27;hierarchicalDocumentSymbolSupport&#x27;: True, &#x27;symbolKind&#x27;: {&#x27;valueSet&#x27;: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26]}, &#x27;tagSupport&#x27;: {&#x27;valueSet&#x27;: [1]}}, &#x27;documentLink&#x27;: {&#x27;dynamicRegistration&#x27;: True, &#x27;tooltipSupport&#x27;: True}, &#x27;formatting&#x27;: {&#x27;dynamicRegistration&#x27;: True}, &#x27;rangeFormatting&#x27;: {&#x27;dynamicRegistration&#x27;: True, &#x27;rangesSupport&#x27;: True}, &#x27;declaration&#x27;: {&#x27;dynamicRegistration&#x27;: True, &#x27;linkSupport&#x27;: True}, &#x27;definition&#x27;: {&#x27;dynamicRegistration&#x27;: True, &#x27;linkSupport&#x27;: True}, &#x27;typeDefinition&#x27;: {&#x27;dynamicRegistration&#x27;: True, &#x27;linkSupport&#x27;: True}, &#x27;implementation&#x27;: {&#x27;dynamicRegistration&#x27;: True, &#x27;linkSupport&#x27;: True}, &#x27;codeAction&#x27;: {&#x27;dynamicRegistration&#x27;: True, &#x27;codeActionLiteralSupport&#x27;: {&#x27;codeActionKind&#x27;: {&#x27;valueSet&#x27;: [&#x27;quickfix&#x27;, &#x27;refactor&#x27;, &#x27;refactor.extract&#x27;, &#x27;refactor.inline&#x27;, &#x27;refactor.rewrite&#x27;, &#x27;source.fixAll&#x27;, &#x27;source.organizeImports&#x27;]}}, &#x27;dataSupport&#x27;: True, &#x27;isPreferredSupport&#x27;: True, &#x27;resolveSupport&#x27;: {&#x27;properties&#x27;: [&#x27;edit&#x27;]}}, &#x27;rename&#x27;: {&#x27;dynamicRegistration&#x27;: True, &#x27;prepareSupport&#x27;: True, &#x27;prepareSupportDefaultBehavior&#x27;: 1}, &#x27;colorProvider&#x27;: {&#x27;dynamicRegistration&#x27;: True}, &#x27;publishDiagnostics&#x27;: {&#x27;relatedInformation&#x27;: True, &#x27;tagSupport&#x27;: {&#x27;valueSet&#x27;: [1, 2]}, &#x27;versionSupport&#x27;: True, &#x27;codeDescriptionSupport&#x27;: True, &#x27;dataSupport&#x27;: True}, &#x27;diagnostic&#x27;: {&#x27;dynamicRegistration&#x27;: True, &#x27;relatedDocumentSupport&#x27;: True}, &#x27;selectionRange&#x27;: {&#x27;dynamicRegistration&#x27;: True}, &#x27;foldingRange&#x27;: {&#x27;dynamicRegistration&#x27;: True, &#x27;foldingRangeKind&#x27;: {&#x27;valueSet&#x27;: [&#x27;comment&#x27;, &#x27;imports&#x27;, &#x27;region&#x27;]}}, &#x27;codeLens&#x27;: {&#x27;dynamicRegistration&#x27;: True}, &#x27;inlayHint&#x27;: {&#x27;dynamicRegistration&#x27;: True, &#x27;resolveSupport&#x27;: {&#x27;properties&#x27;: [&#x27;textEdits&#x27;, &#x27;label.command&#x27;]}}, &#x27;semanticTokens&#x27;: {&#x27;dynamicRegistration&#x27;: True, &#x27;requests&#x27;: {&#x27;range&#x27;: True, &#x27;full&#x27;: {&#x27;delta&#x27;: True}}, &#x27;tokenTypes&#x27;: [&#x27;namespace&#x27;, &#x27;type&#x27;, &#x27;class&#x27;, &#x27;enum&#x27;, &#x27;interface&#x27;, &#x27;struct&#x27;, &#x27;typeParameter&#x27;, &#x27;parameter&#x27;, &#x27;variable&#x27;, &#x27;property&#x27;, &#x27;enumMember&#x27;, &#x27;event&#x27;, &#x27;function&#x27;, &#x27;method&#x27;, &#x27;macro&#x27;, &#x27;keyword&#x27;, &#x27;modifier&#x27;, &#x27;comment&#x27;, &#x27;string&#x27;, &#x27;number&#x27;, &#x27;regexp&#x27;, &#x27;operator&#x27;, &#x27;decorator&#x27;, &#x27;label&#x27;], &#x27;tokenModifiers&#x27;: [&#x27;declaration&#x27;, &#x27;definition&#x27;, &#x27;readonly&#x27;, &#x27;static&#x27;, &#x27;deprecated&#x27;, &#x27;abstract&#x27;, &#x27;async&#x27;, &#x27;modification&#x27;, &#x27;documentation&#x27;, &#x27;defaultLibrary&#x27;], &#x27;formats&#x27;: [&#x27;relative&#x27;], &#x27;overlappingTokenSupport&#x27;: False, &#x27;multilineTokenSupport&#x27;: True, &#x27;augmentsSyntaxTokens&#x27;: True}, &#x27;callHierarchy&#x27;: {&#x27;dynamicRegistration&#x27;: True}, &#x27;typeHierarchy&#x27;: {&#x27;dynamicRegistration&#x27;: True}}, &#x27;workspace&#x27;: {&#x27;applyEdit&#x27;: True, &#x27;didChangeConfiguration&#x27;: {&#x27;dynamicRegistration&#x27;: True}, &#x27;executeCommand&#x27;: {}, &#x27;workspaceEdit&#x27;: {&#x27;documentChanges&#x27;: True, &#x27;failureHandling&#x27;: &#x27;abort&#x27;}, &#x27;workspaceFolders&#x27;: True, &#x27;symbol&#x27;: {&#x27;dynamicRegistration&#x27;: True, &#x27;resolveSupport&#x27;: {&#x27;properties&#x27;: [&#x27;location.range&#x27;]}, &#x27;symbolKind&#x27;: {&#x27;valueSet&#x27;: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26]}, &#x27;tagSupport&#x27;: {&#x27;valueSet&#x27;: [1]}}, &#x27;configuration&#x27;: True, &#x27;codeLens&#x27;: {&#x27;refreshSupport&#x27;: True}, &#x27;inlayHint&#x27;: {&#x27;refreshSupport&#x27;: True}, &#x27;semanticTokens&#x27;: {&#x27;refreshSupport&#x27;: True}, &#x27;diagnostics&#x27;: {&#x27;refreshSupport&#x27;: True}}, &#x27;window&#x27;: {&#x27;showDocument&#x27;: {&#x27;support&#x27;: True}, &#x27;showMessage&#x27;: {&#x27;messageActionItem&#x27;: {&#x27;additionalPropertiesSupport&#x27;: True}}, &#x27;workDoneProgress&#x27;: True}}, &#x27;initializationOptions&#x27;: {&#x27;settings&#x27;: {&#x27;codeAction&#x27;: {&#x27;disableRuleComment&#x27;: {&#x27;enable&#x27;: True}, &#x27;fixViolation&#x27;: {&#x27;enable&#x27;: True}}, &#x27;configuration&#x27;: None, &#x27;configurationPreference&#x27;: &#x27;editorFirst&#x27;, &#x27;exclude&#x27;: None, &#x27;fixAll&#x27;: True, &#x27;format&#x27;: {&#x27;preview&#x27;: None}, &#x27;lineLength&#x27;: None, &#x27;lint&#x27;: {&#x27;enable&#x27;: True, &#x27;extendSelect&#x27;: None, &#x27;ignore&#x27;: None, &#x27;preview&#x27;: None, &#x27;select&#x27;: None}, &#x27;logLevel&#x27;: &#x27;debug&#x27;, &#x27;organizeImports&#x27;: True}}}
[22:48:24.124] &lt;&lt;&lt; LSP-ruff (4) (duration: 22ms): None
[22:48:24.124]  -&gt; LSP-ruff exit: None
LSP-ruff: 2025-05-08 22:48:24.128674236  INFO No workspace settings found for file:///home/harry/scratch/ruff-server-test/project-b, using default settings
LSP-ruff: 2025-05-08 22:48:24.128733887 DEBUG Negotiated position encoding: UTF16
LSP-ruff: 2025-05-08 22:48:24.128745653 DEBUG Indexing settings for workspace: /home/harry/scratch/ruff-server-test/project-b
LSP-ruff: 2025-05-08 22:48:24.130593970 DEBUG No `target-version` found in `ruff.toml` log.target=&quot;ruff_workspace::pyproject&quot; log.module_path=&quot;ruff_workspace::pyproject&quot; log.file=&quot;crates/ruff_workspace/src/pyproject.rs&quot; log.line=179
LSP-ruff: 2025-05-08 22:48:24.130643360 DEBUG No `pyproject.toml` with `requires-python` in same directory; `target-version` unspecified log.target=&quot;ruff_workspace::pyproject&quot; log.module_path=&quot;ruff_workspace::pyproject&quot; log.file=&quot;crates/ruff_workspace/src/pyproject.rs&quot; log.line=188

!!! LSP-ruff: 2025-05-08 22:48:24.130856678 DEBUG Loaded settings from: `/home/harry/scratch/ruff-server-test/project-b/ruff.toml` for `/home/harry/scratch/ruff-server-test/project-b`

LSP-ruff: 2025-05-08 22:48:24.130978834 DEBUG Ignored path via `exclude`: /home/harry/scratch/ruff-server-test/project-b/.ruff_cache
LSP-ruff: 2025-05-08 22:48:24.131981675  INFO Registering workspace: /home/harry/scratch/ruff-server-test/project-b
LSP-ruff: 2025-05-08 22:48:24.132271587  WARN LSP client does not support dynamic capability registration - automatic configuration reloading will not be available.
[22:48:24.127] &lt;&lt;&lt; LSP-ruff (1) (duration: 3ms): {&#x27;capabilities&#x27;: {&#x27;codeActionProvider&#x27;: {&#x27;codeActionKinds&#x27;: [&#x27;quickfix&#x27;, &#x27;source.fixAll.ruff&#x27;, &#x27;source.organizeImports.ruff&#x27;, &#x27;notebook.source.fixAll.ruff&#x27;, &#x27;notebook.source.organizeImports.ruff&#x27;], &#x27;resolveProvider&#x27;: True, &#x27;workDoneProgress&#x27;: True}, &#x27;diagnosticProvider&#x27;: {&#x27;identifier&#x27;: &#x27;Ruff&#x27;, &#x27;interFileDependencies&#x27;: False, &#x27;workDoneProgress&#x27;: True, &#x27;workspaceDiagnostics&#x27;: False}, &#x27;documentFormattingProvider&#x27;: True, &#x27;documentRangeFormattingProvider&#x27;: True, &#x27;executeCommandProvider&#x27;: {&#x27;commands&#x27;: [&#x27;ruff.applyFormat&#x27;, &#x27;ruff.applyAutofix&#x27;, &#x27;ruff.applyOrganizeImports&#x27;, &#x27;ruff.printDebugInformation&#x27;], &#x27;workDoneProgress&#x27;: False}, &#x27;hoverProvider&#x27;: True, &#x27;notebookDocumentSync&#x27;: {&#x27;notebookSelector&#x27;: [{&#x27;cells&#x27;: [{&#x27;language&#x27;: &#x27;python&#x27;}]}], &#x27;save&#x27;: False}, &#x27;positionEncoding&#x27;: &#x27;utf-16&#x27;, &#x27;workspace&#x27;: {&#x27;workspaceFolders&#x27;: {&#x27;changeNotifications&#x27;: True, &#x27;supported&#x27;: True}}, &#x27;textDocumentSync&#x27;: {&#x27;change&#x27;: {&#x27;syncKind&#x27;: 2}, &#x27;didOpen&#x27;: {}, &#x27;didClose&#x27;: {}}}, &#x27;serverInfo&#x27;: {&#x27;name&#x27;: &#x27;ruff&#x27;, &#x27;version&#x27;: &#x27;0.11.8&#x27;}}
[22:48:24.128]  -&gt; LSP-ruff initialized: {}

!!! LSP-ruff: 2025-05-08 22:48:24.148410097  WARN No settings available for file:///home/harry/scratch/ruff-server-test/project-a/test.py - falling back to default settings

LSP-ruff: 2025-05-08 22:48:24.148808138 DEBUG Included path via `include`: /home/harry/scratch/ruff-server-test/project-a/test.py
LSP-ruff: 2025-05-08 22:48:24.160964661 DEBUG Included path via `include`: /home/harry/scratch/ruff-server-test/project-b/test.py
[22:48:24.146]  -&gt; LSP-ruff textDocument/didOpen: {&#x27;textDocument&#x27;: {&#x27;uri&#x27;: &#x27;file:///home/harry/scratch/ruff-server-test/project-a/test.py&#x27;, &#x27;languageId&#x27;: &#x27;python&#x27;, &#x27;version&#x27;: 0, &#x27;text&#x27;: &#x27;a = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12]\n&#x27;}}
[22:48:24.148] --&gt; LSP-ruff textDocument/diagnostic (2): {&#x27;textDocument&#x27;: {&#x27;uri&#x27;: &#x27;file:///home/harry/scratch/ruff-server-test/project-a/test.py&#x27;}, &#x27;identifier&#x27;: &#x27;Ruff&#x27;}
[22:48:24.160]  -&gt; LSP-ruff textDocument/didOpen: {&#x27;textDocument&#x27;: {&#x27;uri&#x27;: &#x27;file:///home/harry/scratch/ruff-server-test/project-b/test.py&#x27;, &#x27;languageId&#x27;: &#x27;python&#x27;, &#x27;version&#x27;: 14, &#x27;text&#x27;: &#x27;a = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12]\n&#x27;}}
[22:48:24.160] --&gt; LSP-ruff textDocument/diagnostic (3): {&#x27;textDocument&#x27;: {&#x27;uri&#x27;: &#x27;file:///home/harry/scratch/ruff-server-test/project-b/test.py&#x27;}, &#x27;identifier&#x27;: &#x27;Ruff&#x27;}
[22:48:24.176] &lt;&lt;&lt; LSP-ruff (2) (duration: 28ms): {&#x27;items&#x27;: [], &#x27;kind&#x27;: &#x27;full&#x27;}
[22:48:24.179] &lt;&lt;&lt; LSP-ruff (3) (duration: 18ms): {&#x27;items&#x27;: [], &#x27;kind&#x27;: &#x27;full&#x27;}

!!! LSP-ruff: 2025-05-08 22:48:34.373418407  WARN No settings available for file:///home/harry/scratch/ruff-server-test/project-a/test.py - falling back to default settings

LSP-ruff: 2025-05-08 22:48:34.373891352 DEBUG Included path via `include`: /home/harry/scratch/ruff-server-test/project-a/test.py
LSP-ruff: 2025-05-08 22:48:34.374117597 DEBUG Printer::print: enter
[22:48:34.373] --&gt; LSP-ruff textDocument/formatting (4): {&#x27;textDocument&#x27;: {&#x27;uri&#x27;: &#x27;file:///home/harry/scratch/ruff-server-test/project-a/test.py&#x27;}, &#x27;options&#x27;: {&#x27;tabSize&#x27;: 4, &#x27;insertSpaces&#x27;: True, &#x27;trimTrailingWhitespace&#x27;: True, &#x27;insertFinalNewline&#x27;: True, &#x27;trimFinalNewlines&#x27;: True}, &#x27;workDoneToken&#x27;: &#x27;$ublime-work-done-progress-4&#x27;}
[22:48:34.379] &lt;&lt;&lt; LSP-ruff (4) (duration: 6ms): None
</code></pre>
<p>If the sublime workspace is opened in the directory above (<code>ruff-server-test</code>), then the server detects both <code>ruff.toml</code>s and formats each file according to their respective configs. Not sure if this is really a bug or the intended behaviour, but (at least for me) it&#x27;s  common to  open files that are not in the workspace - if the editor is configured to auto-format on save these files will be incorrectly formatted.</p>
Version
<p>ruff 0.11.8</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">server</span> added by <a href="https://github.com/ntBre">@ntBre</a> on 2025-05-08 12:50</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ZedThree">@ZedThree</a> on 2026-01-13 18:01</div>
            <div class="timeline-body"><p>Apologies if this is too much detail, just getting everything out of my head! Possible fix is below the line.</p>
<p>A brief summary of the situation from other issues:</p>
<ul>
<li>when an editor opens a single file directly, <code>ruff server</code> gets an initial (default) workspace which is the current working directory</li>
<li>for editors not launched from the terminal, the cwd is usually something like <code>/</code> or <code>~</code>, and since we don&#x27;t want to scan the whole filesystem, only the cwd and above are scanned for config files (in <code>RuffSettingsIndex::new</code>), and then we bail without going deeper</li>
<li>now, when we open a file not directly in the cwd we get one of two situations:<ul>
<li>if the file is <em>under</em> the cwd, we use the settings from whatever config file was found in the cwd</li>
<li>otherwise, we use the default settings</li>
</ul>
</li>
</ul>
<p>I have the following setup which I think demonstrates both this issue and the setup in #22536:</p>
<pre><code>/tmp/mvce
├── dir_0
│   ├── dir_0_1
│   │   ├── ruff.toml
│   │   └── test_0_1.py
│   ├── ruff.toml
│   └── test_0.py
└── dir_1
    ├── ruff.toml
    └── test_1.py
</code></pre>
<p>The three <code>.py</code> files are all identical:</p>
<pre><code>import os

with open(&quot;foo&quot;) as f:
    contents = f.read()
</code></pre>
<p>The config files are different, however:</p>
<p><code>dir_0/ruff.toml</code>:</p>
<pre><code>[lint]
select = [&quot;FURB&quot;, &quot;F&quot;]
preview = true
</code></pre>
<p>whereas both <code>dir_1/ruff.toml</code> and <code>dir_0_1/ruff.toml</code>:</p>
<pre><code>[lint]
select = [&quot;FURB&quot;]
preview = false
</code></pre>
<p>So that <code>dir_0/test_0.py</code> has two warnings, but <code>dir_1/test_1.py</code> and <code>dir_0_1/test_0_1.py</code> have none -- unless the default settings are used for a file, in which case we get one warning for that file, <code>F401</code> on <code>import os</code>.</p>
<p>Results summary (I&#x27;ve used nvim here, but this is consistent across editors):</p>
<ol>
<li><code>cd dir_0; nvim test_0.py</code> or <code>cd dir_1; nvim test_1.py</code> gives the expected warnings</li>
<li><code>nvim dir_0/test_0.py</code> or <code>nvim dir_1/test_1.py</code> only gives one warning (bug)<ul>
<li>this is the issue from #22536</li>
</ul>
</li>
<li><code>cd dir_0; nvim test_0.py</code> then <code>:edit dir_0_1/test_0_1.py</code> gives two warnings (bug)   - this is because <code>dir_0/ruff.toml</code> is used instead of <code>dir_0_1/ruff.toml</code><ul>
<li>this is <em>maybe</em> the same issue as #20847, with the parent directory taking precedence over the closer config file</li>
</ul>
</li>
<li><code>cd dir_0; nvim test_0.py</code> then <code>:edit ../dir_1/test_1.py</code> gives one warning (bug)<ul>
<li>as does the other way round</li>
<li>this is the original situation in this issue</li>
</ul>
</li>
</ol>
<p>Details from the log file from running the above cases in order:</p>


<p>I&#x27;ve also added my own extra logging, mostly in <code>session::Index::open_text_document</code></p>
<ol>
<li><code>cd dir_0; nvim test_0.py</code></li>
</ol>
<pre><code> INFO No workspace(s) were provided during initialization. Using the current working directory as a default workspace: /tmp/mvce/dir_0
 INFO No workspace options found for file:///tmp/mvce/dir_0, using default options
DEBUG Negotiated position encoding: UTF8
DEBUG Indexing settings for workspace: /tmp/mvce/dir_0
DEBUG No `target-version` found in `ruff.toml`
DEBUG No `pyproject.toml` with `requires-python` in same directory; `target-version` unspecified
DEBUG Loaded settings from: `/tmp/mvce/dir_0/ruff.toml`
 INFO Registering workspace: /tmp/mvce/dir_0
 WARN LSP client does not support dynamic capability registration - automatic configuration reloading will not be available.
DEBUG notification{method=&quot;textDocument/didOpen&quot;}: enter
DEBUG notification{method=&quot;textDocument/didOpen&quot;}: *** file:///tmp/mvce/dir_0/test_0.py is in index
DEBUG notification{method=&quot;textDocument/didOpen&quot;}: **** contains key: true
DEBUG notification{method=&quot;textDocument/didOpen&quot;}: *** has settings: true
DEBUG request{id=2 method=&quot;textDocument/diagnostic&quot;}: enter
DEBUG request{id=2 method=&quot;textDocument/diagnostic&quot;}: Included path via `include`: /tmp/mvce/dir_0/test_0.py
DEBUG request{id=3 method=&quot;shutdown&quot;}: enter
DEBUG request{id=3 method=&quot;shutdown&quot;}: Received shutdown request, waiting for shutdown notification
DEBUG Received exit notification, exiting
 INFO Server shut down
</code></pre>
<ol>
<li><code>nvim dir_0/test_0.py</code></li>
</ol>
<pre><code> INFO No workspace(s) were provided during initialization. Using the current working directory as a default workspace: /tmp/mvce
 INFO No workspace options found for file:///tmp/mvce, using default options
DEBUG Negotiated position encoding: UTF8
DEBUG Indexing settings for workspace: /tmp/mvce
 INFO Registering workspace: /tmp/mvce
 WARN LSP client does not support dynamic capability registration - automatic configuration reloading will not be available.
DEBUG notification{method=&quot;textDocument/didOpen&quot;}: enter
DEBUG notification{method=&quot;textDocument/didOpen&quot;}: *** file:///tmp/mvce/dir_0/test_0.py is in index
DEBUG notification{method=&quot;textDocument/didOpen&quot;}: **** contains key: false
DEBUG notification{method=&quot;textDocument/didOpen&quot;}: *** has settings: false
DEBUG @@@ using fallback for &quot;/tmp/mvce/dir_0/test_0.py&quot;
DEBUG request{id=2 method=&quot;textDocument/diagnostic&quot;}: enter
DEBUG request{id=2 method=&quot;textDocument/diagnostic&quot;}: Included path via `include`: /tmp/mvce/dir_0/test_0.py
DEBUG request{id=3 method=&quot;shutdown&quot;}: enter
DEBUG request{id=3 method=&quot;shutdown&quot;}: Received shutdown request, waiting for shutdown notification
DEBUG Received exit notification, exiting
 INFO Server shut down
</code></pre>
<ol>
<li><code>cd dir_0; nvim test_0.py</code> then <code>:edit dir_0_1/test_0_1.py</code></li>
</ol>
<pre><code> INFO No workspace(s) were provided during initialization. Using the current working directory as a default workspace: /tmp/mvce/dir_0
 INFO No workspace options found for file:///tmp/mvce/dir_0, using default options
DEBUG Negotiated position encoding: UTF8
DEBUG Indexing settings for workspace: /tmp/mvce/dir_0
DEBUG No `target-version` found in `ruff.toml`
DEBUG No `pyproject.toml` with `requires-python` in same directory; `target-version` unspecified
DEBUG Loaded settings from: `/tmp/mvce/dir_0/ruff.toml`
 INFO Registering workspace: /tmp/mvce/dir_0
 WARN LSP client does not support dynamic capability registration - automatic configuration reloading will not be available.
DEBUG notification{method=&quot;textDocument/didOpen&quot;}: enter
DEBUG notification{method=&quot;textDocument/didOpen&quot;}: *** file:///tmp/mvce/dir_0/test_0.py is in index
DEBUG notification{method=&quot;textDocument/didOpen&quot;}: **** contains key: true
DEBUG notification{method=&quot;textDocument/didOpen&quot;}: *** has settings: true
DEBUG request{id=2 method=&quot;textDocument/diagnostic&quot;}: enter
DEBUG request{id=2 method=&quot;textDocument/diagnostic&quot;}: Included path via `include`: /tmp/mvce/dir_0/test_0.py
DEBUG notification{method=&quot;textDocument/didOpen&quot;}: enter
DEBUG notification{method=&quot;textDocument/didOpen&quot;}: *** file:///tmp/mvce/dir_0/dir_0_1/test_0_1.py is in index
DEBUG notification{method=&quot;textDocument/didOpen&quot;}: **** contains key: false
DEBUG notification{method=&quot;textDocument/didOpen&quot;}: *** has settings: true
DEBUG request{id=3 method=&quot;textDocument/diagnostic&quot;}: enter
DEBUG request{id=3 method=&quot;textDocument/diagnostic&quot;}: Included path via `include`: /tmp/mvce/dir_0/dir_0_1/test_0_1.py
DEBUG request{id=4 method=&quot;shutdown&quot;}: enter
DEBUG request{id=4 method=&quot;shutdown&quot;}: Received shutdown request, waiting for shutdown notification
DEBUG Received exit notification, exiting
 INFO Server shut down
</code></pre>
<ol>
<li><code>cd dir_0; nvim test_0.py</code> then <code>:edit ../dir_1/test_1.py</code></li>
</ol>
<pre><code> INFO No workspace(s) were provided during initialization. Using the current working directory as a default workspace: /tmp/mvce/dir_0
 INFO No workspace options found for file:///tmp/mvce/dir_0, using default options
DEBUG Negotiated position encoding: UTF8
DEBUG Indexing settings for workspace: /tmp/mvce/dir_0
DEBUG No `target-version` found in `ruff.toml`
DEBUG No `pyproject.toml` with `requires-python` in same directory; `target-version` unspecified
DEBUG Loaded settings from: `/tmp/mvce/dir_0/ruff.toml`
 INFO Registering workspace: /tmp/mvce/dir_0
 WARN LSP client does not support dynamic capability registration - automatic configuration reloading will not be available.
DEBUG notification{method=&quot;textDocument/didOpen&quot;}: enter
DEBUG notification{method=&quot;textDocument/didOpen&quot;}: *** file:///tmp/mvce/dir_0/test_0.py is in index
DEBUG notification{method=&quot;textDocument/didOpen&quot;}: **** contains key: true
DEBUG notification{method=&quot;textDocument/didOpen&quot;}: *** has settings: true
DEBUG request{id=2 method=&quot;textDocument/diagnostic&quot;}: enter
DEBUG request{id=2 method=&quot;textDocument/diagnostic&quot;}: Included path via `include`: /tmp/mvce/dir_0/test_0.py
DEBUG notification{method=&quot;textDocument/didOpen&quot;}: enter
DEBUG notification{method=&quot;textDocument/didOpen&quot;}: *** file:///tmp/mvce/dir_1/test_1.py is in index
DEBUG notification{method=&quot;textDocument/didOpen&quot;}: **** contains key: false
DEBUG notification{method=&quot;textDocument/didOpen&quot;}: *** has settings: false
DEBUG @@@ using fallback for &quot;/tmp/mvce/dir_1/test_1.py&quot;
DEBUG request{id=4 method=&quot;textDocument/diagnostic&quot;}: enter
DEBUG request{id=4 method=&quot;textDocument/diagnostic&quot;}: Included path via `include`: /tmp/mvce/dir_1/test_1.py
DEBUG request{id=5 method=&quot;shutdown&quot;}: enter
DEBUG request{id=5 method=&quot;shutdown&quot;}: Received shutdown request, waiting for shutdown notification
DEBUG Received exit notification, exiting
 INFO Server shut down
</code></pre>
<ul>
<li><code>**** contains key:</code> is <code>self.settings.contains_key(url.to_file_path()?.parent()?)</code></li>
<li><code>@@@ using fallback</code> is in the <code>.unwrap_or_else</code> part of <code>RuffSettingsIndex::get</code>, during <code>Index::make_document_ref</code></li>
</ul>


<hr>
<p>One possible way to fix issues 2. and 4. above is, during <code>session::Index::open_text_document</code>, to check if <code>self.settings_for_url().ruff_settings</code> has our file&#x27;s parent directory, and if not, to call <code>self.open_workspace_folder</code>.</p>
<p>This seems to work, without negatively affecting editors like VS Code that open folders. I don&#x27;t know if it would have other consequences. It&#x27;s also not a fix for #20847. Should I open a PR for it?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntBre">@ntBre</a> on 2026-01-13 19:30</div>
            <div class="timeline-body"><p>Thanks for looking into this! @MichaReiser or @dhruvmanila would know better than me if this sounds like a promising approach, but it probably wouldn&#x27;t hurt to open a PR if you have something working locally. Then we could test it out too.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2026-01-14 09:31</div>
            <div class="timeline-body"><p>thanks for the detailed analysis</p>
<blockquote>
<p>One possible way to fix issues 2. and 4. above is, during session::Index::open_text_document, to check if self.settings_for_url().ruff_settings has our file&#x27;s parent directory, and if not, to call self.open_workspace_folder.</p>
</blockquote>
<p>I&#x27;m not convinced we should do this unless we have a very clear strategy for cleaning them up when the file is closed (or if the user adds that directory as a workspace folder). Given that all that&#x27;s missing are the settings, I wonder if we could just try to discover the settings walking the file&#x27;s ancestor directories and collect all configuration files instead.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ZedThree">@ZedThree</a> on 2026-01-14 10:33</div>
            <div class="timeline-body"><p>Sorry @MichaReiser, I didn&#x27;t see your comment till after I made the PR! I tried the workspace approach first, because that seems to be the only way to cache the discovered settings.</p>
<p>I&#x27;ll try your approach instead</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2026-01-16 10:00</div>
            <div class="timeline-body"><p>Sorry for the delay!</p>
<p>I&#x27;m not sure if this is going to be the case for Neovim mainly because Neovim will start a separate server for each of these directories because it has all of the possible configuration files for Ruff to <a href="https://github.com/neovim/nvim-lspconfig/blob/92ee7d42320edfbb81f3cad851314ab197fa324a/lua/lspconfig/configs/ruff.lua#L14-L17">detect the project root</a> which it uses to detect if there&#x27;s a common root. In this case, there isn&#x27;t but if there was a config file in the root project, then it might not spawn a separate server for each of these directories:</p>
<pre><code>- ruff (id: 2)
  - Version: 0.14.11
  - Root directory: ~/playground/ruff/issue-17944/project-b
  - Command: { &quot;ruff&quot;, &quot;server&quot; }
  - Settings: {}
  - Attached buffers: 6

- ruff (id: 5)
  - Version: 0.14.11
  - Root directory: ~/playground/ruff/issue-17944/project-a
  - Command: { &quot;ruff&quot;, &quot;server&quot; }
  - Settings: {}
  - Attached buffers: 13
</code></pre>
<blockquote>
<ul>
<li>cwd at top-level, opening <code>dir_0/test_0.py</code></li>
<li>cwd at top-level, opening <code>dir_0/test_0.py</code>, then <code>../dir_1/test_1.py</code> in same session</li>
<li>cwd in <code>dir_0</code>, opening <code>../dir_1/test_1.py</code></li>
<li>cwd in <code>dir_0</code>, opening <code>test_0.py</code> first, then <code>../dir_1/test_1.py</code> in same session</li>
</ul>
</blockquote>
<p>So, all of these cases (copied from the linked PR) works as expected at least in Neovim because it spawns two separate Ruff servers with different project root.</p>
<p>Although I do see the issue in VS Code.</p>
<p>I&#x27;m going to look at the PR now, but I wanted to understand the issue first.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2026-01-16 10:16</div>
            <div class="timeline-body"><blockquote>
<p>2. <code>nvim dir_0/test_0.py</code> or <code>nvim dir_1/test_1.py</code> only gives one warning (bug)</p>
</blockquote>
<p>In this case in Neovim, I&#x27;m actually seeing</p>
<ul>
<li>both warnings from Ruff for <code>nvim dir_0/test_0.py</code> which is as expected, doesn&#x27;t look like a bug)</li>
<li>seeing no warnings for <code>nvim dir_1/test_1.py</code> which is also as expected because the <code>dir_1/ruff.toml</code> doesn&#x27;t have <code>F</code> selected, preview is disabled so <code>FURB101</code> will not be checked</li>
</ul>
<blockquote>
<p>3. <code>cd dir_0; nvim test_0.py</code> then <code>:edit dir_0_1/test_0_1.py</code> gives two warnings (bug)   - this is because <code>dir_0/ruff.toml</code> is used instead of <code>dir_0_1/ruff.toml</code></p>
</blockquote>
<p>I&#x27;m seeing the expected behavior in this case as well for Neovim where the later addition of <code>dir_0_1/test_0_1.py</code> gives me zero warnings from Ruff as it spawns a different LSP for that file because it is considered to have a different root than the existing LSP.</p>
<blockquote>
<p>4. <code>cd dir_0; nvim test_0.py</code> then <code>:edit ../dir_1/test_1.py</code> gives one warning (bug)</p>
</blockquote>
<p>Same here, I&#x27;m seeing expected behavior because of the way Neovim tries to find project root for the LSP.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ZedThree">@ZedThree</a> on 2026-01-16 10:38</div>
            <div class="timeline-body"><p>Ah, I hadn&#x27;t set <code>root_markers</code> in my neovim config. That does indeed make things work correctly. It&#x27;s not my usual editor, so I hadn&#x27;t realised that was required -- could be useful to add this to the docs?</p>
<p>The issue does seem to also affect other editors like VS Code in single file mode, and helix.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 18:49:55 UTC
    </footer>
</body>
</html>
