<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[Linter panic] RUF027 preview rule can cause linter panic on specific string - astral-sh/ruff #21538</title>
    <link rel="stylesheet" href="../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../index.html">Back to index</a>
    </div>

    <h1>[Linter panic] RUF027 preview rule can cause linter panic on specific string</h1>

    <div class="meta">
        <span class="state state-open">Open</span>
        <a href="https://github.com/astral-sh/ruff/issues/21538">#21538</a>
        opened by <a href="https://github.com/skraeven">@skraeven</a>
        on 2025-11-20 14:01
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/skraeven">@skraeven</a> on 2025-11-20 14:01</div>
            <div class="timeline-body"><p>Ruff has crashed while running on our code base, due to a specific string/rule combination.</p>
<p>Given this (minimal repro version) string in a python file:</p>
<pre><code>foo = &quot;{'bar': {\t'&quot;
</code></pre>
<p>Running <code>ruff check . --preview --select=RUF027 --isolated</code> will cause linter panic.</p>
<p>Playground: https://play.ruff.rs/486e305d-99f7-4dcb-88fb-60d8fe45f002</p>
<p>Here's <code>RUST_BACKTRACE=1</code> output:</p>
<pre><code>info: Backtrace:
   0: &lt;unknown&gt;
   1: &lt;unknown&gt;
   2: &lt;unknown&gt;
   3: &lt;unknown&gt;
   4: &lt;unknown&gt;
   5: &lt;unknown&gt;
   6: &lt;unknown&gt;
   7: &lt;unknown&gt;
   8: &lt;unknown&gt;
   9: &lt;unknown&gt;
  10: &lt;unknown&gt;
  11: &lt;unknown&gt;
  12: &lt;unknown&gt;
  13: &lt;unknown&gt;
  14: &lt;unknown&gt;
  15: &lt;unknown&gt;
  16: &lt;unknown&gt;
  17: &lt;unknown&gt;
  18: &lt;unknown&gt;
  19: &lt;unknown&gt;
  20: &lt;unknown&gt;
  21: &lt;unknown&gt;
  22: &lt;unknown&gt;
  23: &lt;unknown&gt;
  24: &lt;unknown&gt;
  25: &lt;unknown&gt;
  26: &lt;unknown&gt;
  27: start_thread
             at ./nptl/pthread_create.c:447:8
  28: clone3
             at ./misc/../sysdeps/unix/sysv/linux/x86_64/clone3.S:78:0

</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @ntBre on 2025-11-20 14:07</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-11-20 14:08</div>
            <div class="timeline-body"><p>Thanks. The playground has a more useful stacktrace and it points to:  <code>crates/ruff_python_parser/src/parser/expression.rs:1619:25</code> with the message <code>internal error: entered unreachable code: f-string: unexpected token </code>TStringMiddle<code> at 14..15</code> (Sorry @dylwil3)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">parser</span> added by @MichaReiser on 2025-11-20 14:08</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @dylwil3 by @dylwil3 on 2025-11-21 03:10</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-12-10 13:55</div>
            <div class="timeline-body"><p>This is actually valid Python syntax :)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/21895.html">astral-sh/ruff#21895</a> on 2025-12-10 14:10</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dylwil3">@dylwil3</a> on 2025-12-10 14:10</div>
            <div class="timeline-body"><p>Yes but the panic is caused not from parsing the expression in the OP, but from calling <code>parse_expression</code> on</p>
<pre><code class="language-python">f&quot;{'bar': {\t'&quot;
</code></pre>
<p>Recall that RUF027 checks to see whether turning a string into an f-string would be correct syntax before suggesting it. Unfortunately this has lead to errors in the past, mainly because our error recovery is not nearly as battle-tested for <code>parse_expression</code> as it is for parsing a module.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-12-10 14:20</div>
            <div class="timeline-body"><p>Ah right. Too bad, my other change also doesn't fix that</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:28:17 UTC
    </footer>
</body>
</html>
