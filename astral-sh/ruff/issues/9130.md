```yaml
number: 9130
title: No way to exclude folders from first-party detection for import sorting?
type: issue
state: open
author: celynw
labels:
  - question
assignees: []
created_at: 2023-12-14T16:16:16Z
updated_at: 2023-12-15T14:45:32Z
url: https://github.com/astral-sh/ruff/issues/9130
synced_at: 2026-01-10T01:56:50Z
```

# No way to exclude folders from first-party detection for import sorting?

---

_Issue opened by @celynw on 2023-12-14 16:16_

In my use-case, I want to apply import sorting to a large repository which has packages and also many stand-alone scripts. Those scripts import from their sibling and child python files, so I they should have a large amount of first party imports. Those scripts don't support relative imports (like `from .app import func`), and I don't want to maintain a large list of `known-first-party` imports in my Ruff configuration.

One way around this was to include every directory in `src`, just so long as there are no collisions with directories named the same as third-party packages. But there is no way to subtract from this list. I guess this is because the exclude list is for `.py` files but the `src` list is a list of directories. I tried using the `exclude` list, `force-exclude`, and also by honouring `.gitignore`.

Perhaps the exclude list should also affect the first-party detection? Or does anybody have any suggestions?

Directory structure:
```
ruff_test/
  ├─ main.py
  ├─ ruff.toml
  └─ .mypy_cache/
     └─ 3.8/
        └─ numpy/
           └─ ... only directories of JSON files
```

Before formatting:

```python
# main.py
from __future__ import annotations
import os
import pandas as pd
import numpy as np
```

```toml
# ruff.toml
src = [".", "**"]

[lint]
select = [
    "I001", # unsorted-imports
]
```

After formatting with `ruff check --fix -v .`:

```python
# main.py
from __future__ import annotations

import os

import pandas as pd

import numpy as np
```

Verbose output:
```
[2023-12-14][15:39:16][ruff_cli::resolve][DEBUG] Using configuration file (via parent) at: ruff_test/ruff.toml
[2023-12-14][15:39:16][ruff_workspace::pyproject][DEBUG] `project.requires_python` in `pyproject.toml` will not be used to set `target_version` when using `ruff.toml`.
[2023-12-14][15:39:16][ruff_workspace::pyproject][DEBUG] `project.requires_python` in `pyproject.toml` will not be used to set `target_version` when using `ruff.toml`.
[2023-12-14][15:39:16][ruff_workspace::pyproject][DEBUG] `project.requires_python` in `pyproject.toml` will not be used to set `target_version` when using `ruff.toml`.
[2023-12-14][15:39:16][ruff_workspace::resolver][DEBUG] Ignored path via `exclude`: "ruff_test/.mypy_cache"
[2023-12-14][15:39:16][ruff_workspace::resolver][DEBUG] Included path via `include`: "ruff_test/main.py"
[2023-12-14][15:39:16][ruff_cli::commands::check][DEBUG] Identified files to lint in: 3.69786ms
[2023-12-14][15:39:16][ruff_cli::diagnostics][DEBUG] Checking: ruff_test/main.py
[2023-12-14][15:39:16][ruff_linter::rules::isort::categorize][DEBUG] Categorized 'pandas' as Known(ThirdParty) (NoMatch)
[2023-12-14][15:39:16][ruff_linter::rules::isort::categorize][DEBUG] Categorized 'os' as Known(StandardLibrary) (KnownStandardLibrary)
[2023-12-14][15:39:16][ruff_linter::rules::isort::categorize][DEBUG] Categorized 'numpy' as Known(FirstParty) (SourceMatch("ruff_test/.mypy_cache/3.8"))
[2023-12-14][15:39:16][ruff_linter::rules::isort::categorize][DEBUG] Categorized '__future__' as Known(Future) (Future)
[2023-12-14][15:39:16][ruff_linter::rules::isort::categorize][DEBUG] Categorized 'pandas' as Known(ThirdParty) (NoMatch)
[2023-12-14][15:39:16][ruff_linter::rules::isort::categorize][DEBUG] Categorized 'os' as Known(StandardLibrary) (KnownStandardLibrary)
[2023-12-14][15:39:16][ruff_linter::rules::isort::categorize][DEBUG] Categorized 'numpy' as Known(FirstParty) (SourceMatch("ruff_test/.mypy_cache/3.8"))
[2023-12-14][15:39:16][ruff_linter::rules::isort::categorize][DEBUG] Categorized '__future__' as Known(Future) (Future)
[2023-12-14][15:39:16][ruff_cli::commands::check][DEBUG] Checked 1 files in: 1.587502ms
Found 1 error (1 fixed, 0 remaining).
```

As you can see, it now thinks numpy is a first-party package because it matched `ruff_test/.mypy_cache/3.8/numpy/`

---

_Comment by @charliermarsh on 2023-12-15 00:10_

Can you give an example directory structure that's requiring the `**` in `src`? Trying to understand if there's an alternative solution that wouldn't require that configuration, since it's a bit non-standard.

---

_Label `question` added by @charliermarsh on 2023-12-15 00:10_

---

_Comment by @celynw on 2023-12-15 14:45_

Sure - I do appreciate this could be an abuse of the `src` option!
And actually, I now have told Mypy (in `pyproject.toml`) to put its cache somewhere else, circumventing the problem for now.

Anyway...

In this imaginary project, I have two independent packages called `client` and `server` which can be installed with pip.
The files in one package can import from another, e.g. `from server.file import Class`

Also, there is a `scripts` folder, where each directory is self-contained.

```
project/
  ├─ client/
  │  ├─ client
  │  │  ├─ __init__.py
  │  │  ├─ ... .py
  │  │  └─ ... .py
  │  └─ setup.py
  ├─ server/
  │  ├─ server
  │  │  ├─ __init__.py
  │  │  ├─ ... .py
  │  │  └─ ... .py
  │  └─ setup.py
  └─ scripts/
     ├─ create_dataset/
     │  ├─ dataset/
     │  │  └─ dataset.py
     │  └─ create_dataset.py
     ├─ .../
     ├─ .../
     ...
```

Each script might make a 'local' import such as:

```python
# create_dataset.py
from dataset.dataset import Dataset
```

(I feel like this should be a "local-folder" import, but it can't start with a dot because it's not part of a package..?)

I want to run Ruff on the entire project.
If I just set `src = ["."]` as the default, `dataset.dataset` is classed as `ThirdParty` because it didn't match.

> [ruff_linter::rules::isort::categorize][DEBUG] Categorized 'dataset.dataset' as Known(ThirdParty) (NoMatch)

If I set `src = [".", "**"]`, it is correctly detected as FirstParty

> [ruff_linter::rules::isort::categorize][DEBUG] Categorized 'dataset.dataset' as Known(FirstParty) (SourceMatch("scripts/create_dataset"))

This is also solved if I add that script directory, as `src = [".", "scripts/create_dataset"]`
However if I have lots of scripts, I don't really want to maintain a list here.
I could do `src = [".", "scripts/**"]` here, but there was still some `.mypy_cache/` directories within `scripts/` causing the same problem.

My real question is, how can I run Ruff on the entire repo, with it correctly identifying imports within self-contained directories, without specifying them all manually?

---

_Referenced in [astral-sh/ruff#10266](../../astral-sh/ruff/issues/10266.md) on 2024-03-07 06:25_

---

_Referenced in [astral-sh/ruff#14497](../../astral-sh/ruff/issues/14497.md) on 2024-11-20 20:08_

---
