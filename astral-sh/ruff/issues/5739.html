<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ruff fails when a directory ends with .py - astral-sh/ruff #5739</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Ruff fails when a directory ends with .py</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/issues/5739">#5739</a>
        opened by <a href="https://github.com/konstin">@konstin</a>
        on 2023-07-13 15:17
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a></div>
            <div class="timeline-body"><p>Ruff gets confused when a directory is named like a python file (ends with <code>.py</code>):</p>
<pre><code class="language-shell">$ mkdir repro
$ mkdir repro/some_folder.py
$ cargo run --bin ruff -- --no-cache repro
error: Failed to lint repro/some_folder.py: Is a directory (os error 21)
  Caused by: Is a directory (os error 21)
repro/some_folder.py:1:1: E902 Is a directory (os error 21)
  Caused by: Is a directory (os error 21)
Found 1 error.
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @konstin on 2023-07-13 15:17</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2023-07-13 23:18</div>
            <div class="timeline-body"><p>@konstin is this a good first issue?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-07-13 23:21</div>
            <div class="timeline-body"><p>(From my perspective, seems like a good issue, will probably require digging into how we collect the &quot;files to lint&quot;.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">help wanted</span> added by @zanieb on 2023-07-13 23:25</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">good first issue</span> added by @konstin on 2023-07-14 08:47</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2023-07-14 08:48</div>
            <div class="timeline-body"><p>i've confirmed it's not related to #5611, so yes it's a good first issue</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/harupy">@harupy</a> on 2023-07-15 07:38</div>
            <div class="timeline-body"><p>can I work on this?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/harupy">@harupy</a> on 2023-07-15 07:51</div>
            <div class="timeline-body"><p>Is this the part that needs to be fixed?</p>
<p>https://github.com/astral-sh/ruff/blob/f029f8b7840e4477f2f42d8f589c4ac290a249e6/crates/ruff/src/resolver.rs#L332-L350</p>
<p>It looks like the else block is missing <code>is_file</code> check.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/harupy">@harupy</a> on 2023-07-15 07:59</div>
            <div class="timeline-body"><p>Testing the following change:</p>
<pre><code class="language-diff">diff --git a/crates/ruff/src/resolver.rs b/crates/ruff/src/resolver.rs
index 0ad0fa244..0d851135c 100644
--- a/crates/ruff/src/resolver.rs
+++ b/crates/ruff/src/resolver.rs
@@ -330,9 +330,12 @@ pub fn python_files_in_path(
             }
 
             if result.as_ref().map_or(true, |entry| {
+                if !(entry.file_type().map_or(false, |ft| ft.is_file())) {
+                    return false;
+                }
                 if entry.depth() == 0 {
                     // Accept all files that are passed-in directly.
-                    entry.file_type().map_or(false, |ft| ft.is_file())
+                    true
                 } else {
                     // Otherwise, check if the file is included.
                     let path = entry.path();
</code></pre>
<p>Result:</p>
<pre><code>&gt; tree dir
dir
├── dir.py
│   └── file.py
└── file.py

1 directory, 2 files

&gt; cargo run -p ruff_cli -- check dir --no-cache
    Finished dev [unoptimized + debuginfo] target(s) in 0.08s
     Running `target/debug/ruff check dir --no-cache`
dir/dir.py/file.py:1:7: F821 Undefined name `a`
dir/file.py:1:7: F821 Undefined name `a`
Found 2 errors.
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @harupy by @konstin on 2023-07-15 08:43</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @zanieb on 2023-07-18 01:25</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 16:47:40 UTC
    </footer>
</body>
</html>
