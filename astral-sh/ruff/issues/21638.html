<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Import Sorting not stable - astral-sh/ruff #21638</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Import Sorting not stable</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/issues/21638">#21638</a>
        opened by <a href="https://github.com/noahdormann">@noahdormann</a>
        on 2025-11-26 10:04
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/noahdormann">@noahdormann</a></div>
            <div class="timeline-body"><h3>Question</h3>
<p>Hi, weâ€™re using Ruff in our project and itâ€™s been great so far.
However, weâ€™ve run into a strange inconsistency with import sorting. Two machines that should be configured identically are producing different sorted imports.</p>
<p>Environment (both machines):</p>
<ul>
<li>Ubuntu 24.04.3 LTS</li>
<li>uv installed through the official installer script</li>
<li>same Git project checked out on the same commit</li>
<li>Virtual environment created via <code>uv sync</code> (uv.lock file is in git)</li>
<li><code>ruff --version</code> reports 0.14.6</li>
<li><code>ruff -v check --select I --show-settings</code> report identical settings</li>
<li>pyproject.toml is the only config source found running <code>ruff -v check --select I --fix 2&gt;&amp;1 | grep conf</code></li>
</ul>
<p>The issue:
On one machine, this file gets sorted like this:</p>
<pre><code class="language-python">from logging.config import fileConfig

from alembic import context
from sqlalchemy import engine_from_config, pool
</code></pre>
<p>On the other machine, the result is:</p>
<pre><code class="language-python">from logging.config import fileConfig

from sqlalchemy import engine_from_config, pool

from alembic import context
</code></pre>
<p>Both machines consistently produce the same ordering every time, but they disagree with each other.</p>
<p>What Iâ€™ve tried / verified:</p>
<ul>
<li>[x] Same Ruff version</li>
<li>[x] Same project directory</li>
<li>[x] Same virtual environment setup</li>
<li>[x] Same command invocation</li>
<li>[x] Same --show-settings output</li>
<li>[x] Same config file detected (pyproject.toml)</li>
<li>[x] Same source tree</li>
</ul>
<p>At this point Iâ€™m not sure what else could cause two Ruff installs with identical configs to classify alembic and sqlalchemy differently.
Is there anything I might be missing, or any additional diagnostic step I could run to narrow this down?
I would write this up as a bug report, if I had an idea how to create a reproducible setup.</p>
<p>Thanks!</p>
<h3>Version</h3>
<p>0.14.6</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">question</span> added by @noahdormann on 2025-11-26 10:04</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">great writeup</span> added by @MichaReiser on 2025-11-26 10:06</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-11-26 10:10</div>
            <div class="timeline-body"><p>Thanks for the great write up!</p>
<p>There are two possible causes:</p>
<ul>
<li>There's a known issue with isort that Ruff's caching sometimes isn't correctly invalidated. Can you try running <code>ruff clean</code> on both machines?</li>
<li>isort looks at what folders exist on your file system to decide whether a package is a first-party or third-party library. Any chance there's a local <code>sqlalchemy</code> or <code>alembic</code> folder on one of the two machines?</li>
</ul>
<p>What I've found most useful in the past is to run ruff with <code>ruff check -v &lt;problematic_file&gt;</code>. It makes Ruff print debug logs, which include Ruff's reasoning for classifying a specific module in a specific way. The easiest might be to run the command with <code>-v</code> on both machines and than compare the log output (using something like https://www.diffchecker.com/)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/noahdormann">@noahdormann</a> on 2025-11-26 13:34</div>
            <div class="timeline-body"><p>Thank you for the quick reply!</p>
<p>I was able to pinpoint the issue with your help ðŸ¥³ . We recently refactored our project structure and moved the standard alembic directory from <code>./alembic</code> to <code>./core/alembic</code>. On my colleagueâ€™s machine the old <code>./alembic</code> directory still existed, because Git doesnâ€™t remove empty folders. Removing that leftover directory resolved the inconsistent sorting.</p>
<p>The only remaining question is that the directory was completely empty and contained no <code>__init__.py</code>, so itâ€™s a bit surprising that Ruff detected it as a Python package or used it for module classification.</p>
<p>To answer my own question, I was not aware of <a href="https://peps.python.org/pep-0420/">PEP 420</a> allowing <em>namespace packages</em>. Thus, I assume this is expected behavior on Ruffâ€™s side. Thanks again for the quick assistance!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-11-27 06:48</div>
            <div class="timeline-body"><blockquote>
<p>To answer my own question, I was not aware of <a href="https://peps.python.org/pep-0420/">PEP 420</a> allowing namespace packages. Thus, I assume this is expected behavior on Ruffâ€™s side. Thanks again for the quick assistance!</p>
</blockquote>
<p>Yes, this is because of namespace packages. Depending on your project layout, setting <a href="https://docs.astral.sh/ruff/settings/#src"><code>src</code></a> can also help (e.g. if you have a src layout, set it to <code>[&quot;src&quot;]</code>)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/noahdormann">@noahdormann</a> on 2025-11-27 12:01</div>
            <div class="timeline-body"><p>Thanks you! I close the question as solved.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @noahdormann on 2025-11-27 12:01</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/txomon">@txomon</a> on 2025-12-29 17:50</div>
            <div class="timeline-body"><p>Hello, I was just hit with this &quot;feature&quot; and after spending almost all Christmas on it, would it be possible to remove it? or at least deactivate it?</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 16:53:38 UTC
    </footer>
</body>
</html>
