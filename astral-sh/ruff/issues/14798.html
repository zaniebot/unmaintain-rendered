<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RUF052 fix is unsafe when renaming TypeVars - astral-sh/ruff #14798</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>RUF052 fix is unsafe when renaming TypeVars</h1>

    <div class="meta">
        <span class="state state-closed">Closed</span>
        <a href="https://github.com/astral-sh/ruff/issues/14798">#14798</a>
        opened by <a href="https://github.com/oguzhanmeteozturk">@oguzhanmeteozturk</a>
        on 2024-12-05 22:57
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/oguzhanmeteozturk">@oguzhanmeteozturk</a> on 2024-12-05 22:57</div>
            <div class="timeline-body"><p>The automatic fix for RUF052 is unsafe when applied to TypeVar definitions. It renames <code> _T = TypeVar(&quot;_T&quot;)</code> to<code> T = TypeVar(&quot;_T&quot;)</code> resulting in invalid code. The TypeVar name string must match the assigned variable name to maintain correctness, and the resulting T = TypeVar(&quot;_T&quot;) violates this requirement.</p>
<p>The underscore is often used to indicate private or internal TypeVars and is a common and valid pattern in python.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @dylwil3 on 2024-12-05 23:05</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">rule</span> added by @dylwil3 on 2024-12-05 23:05</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">fixes</span> added by @dylwil3 on 2024-12-05 23:05</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">preview</span> added by @dylwil3 on 2024-12-05 23:06</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-12-05 23:28</div>
            <div class="timeline-body"><p>Thanks for opening the issue! Interesting, are you defining TypeVars inside functions? I thought RUF052 only applied inside function scopes</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/oguzhanmeteozturk">@oguzhanmeteozturk</a> on 2024-12-05 23:34</div>
            <div class="timeline-body"><p>Tests define TypeVars internally sometimes</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-12-05 23:37</div>
            <div class="timeline-body"><p>Just to make sure I understand -- something like this?</p>
<pre><code class="language-py">def test_foo():
    _T = TypeVar(&quot;_T&quot;)
    
    def bar(x: _T) -&gt; _T:
        ...  # some logic here
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/oguzhanmeteozturk">@oguzhanmeteozturk</a> on 2024-12-06 00:55</div>
            <div class="timeline-body"><p>Yes, very similar. Not sure how relevant it is, but the exact point where it broke the test involves _T being passed as an argument to a FUT within a context (pytest.raises in this case).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-12-06 00:59</div>
            <div class="timeline-body"><p>Great, thanks. I'd argue that this is within the purview of RUF052 -- since the TypeVar is a local variable, it's private to the function even without the underscore; leading underscores are more usually used to indicate unused variables in function scopes, I think.</p>
<p>However, we obviously shouldn't be breaking TypeVar definitions by changing the name the TypeVar is assigned to without changing the string passed into the constructor. We either need to make our renaming logic more sophisticated and/or mark the autofix as unsafe in more cases.</p>
<p>Thanks for the report!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @AlexWaygood by @AlexWaygood on 2024-12-06 13:07</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/14819.html">astral-sh/ruff#14819</a> on 2024-12-06 14:21</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @AlexWaygood on 2024-12-06 17:05</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:34:54 UTC
    </footer>
</body>
</html>
