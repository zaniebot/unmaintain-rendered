<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>S308 (mark_safe) doesn't detects decorator usage and imports from another place - astral-sh/ruff #9780</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>S308 (mark_safe) doesn't detects decorator usage and imports from another place</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/issues/9780">#9780</a>
        opened by <a href="https://github.com/ashrub-holvi">@ashrub-holvi</a>
        on 2024-02-02 09:43
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/ashrub-holvi">@ashrub-holvi</a> on 2024-02-02 09:43</div>
            <div class="timeline-body"><p>Hi, thank you for the cool project!</p>
<p>I am looking to <a href="https://docs.astral.sh/ruff/rules/suspicious-mark-safe-usage/">suspicious-mark-safe-usage (S308)</a> check. <a href="https://github.com/astral-sh/ruff/issues/1646">Here</a> I see it's implemented, but something named &quot;S703: django_mark_safe&quot; is not, not sure what does it means, but looks like S308 works only if <code>mark_safe</code> is imported from  <a href="https://docs.djangoproject.com/en/5.0/ref/utils/#module-django.utils.safestring">django.utils.safestring</a> and used as a function:</p>
<ol>
<li>With  <code>mark_safe</code> used as a function:</li>
</ol>
<pre><code>from django.utils.safestring import SafeString
from django.utils.safestring import mark_safe

def some_func():
    return mark_safe('&lt;script&gt;alert(&quot;evil!&quot;)&lt;/script&gt;')  # oh no

print(type(some_func()) is SafeString)
</code></pre>
<p>it works fine:</p>
<pre><code>ruff --select S308 test.py 
test.py:7:12: S308 Use of `mark_safe` may expose cross-site scripting vulnerabilities
Found 1 error.
</code></pre>
<ol start="2">
<li>With  <code>mark_safe</code> used as a decorator:</li>
</ol>
<pre><code>from django.utils.safestring import SafeString
from django.utils.safestring import mark_safe

@mark_safe
def some_func():
    return '&lt;script&gt;alert(&quot;evil!&quot;)&lt;/script&gt;'  # oh no

print(type(some_func()) is SafeString)
</code></pre>
<p>it doesn't raise the error:</p>
<pre><code>ruff --select S308 test.py
</code></pre>
<ol start="3">
<li>With function imported from <a href="https://docs.djangoproject.com/en/5.0/ref/utils/#module-django.utils.html">django.utils.html</a>, might be it's wrong way to import it, but it works and we have a lot of such usages in old code.</li>
</ol>
<pre><code>from django.utils.safestring import SafeString
from django.utils.html import mark_safe

def some_func():
    return mark_safe('&lt;script&gt;alert(&quot;evil!&quot;)&lt;/script&gt;')  # oh no

print(type(some_func()) is SafeString)
</code></pre>
<p>there is no errors:</p>
<pre><code>ruff --select S308 test.py
</code></pre>
<ol start="4">
<li>With decorator imported from django.utils.html</li>
</ol>
<pre><code>from django.utils.safestring import SafeString
from django.utils.html import mark_safe

@mark_safe
def some_func():
    return '&lt;script&gt;alert(&quot;evil!&quot;)&lt;/script&gt;'  # oh no

print(type(some_func()) is SafeString)
</code></pre>
<p>also no errors:</p>
<pre><code>ruff --select S308 test.py
</code></pre>
<p>So, perhaps this check can be improved, I tried to looks to <a href="https://github.com/astral-sh/ruff/blob/467c091382fa60243e261417b4620aeca4012bf5/crates/ruff_linter/src/rules/flake8_bandit/rules/suspicious_function_call.rs#L851">code</a>, but for the first look I understand nothing ) Rust is only in far away future plan for me.</p>
<pre><code>ruff --version
ruff 0.1.15
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-02-05 00:38</div>
            <div class="timeline-body"><p>Interesting, thanks. We should be able to add these diagnostics to the existing rule.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">rule</span> added by @charliermarsh on 2024-02-05 00:38</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @charliermarsh by @charliermarsh on 2024-02-08 03:48</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/9887.html">astral-sh/ruff#9887</a> on 2024-02-08 03:51</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2024-02-08 04:10</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-02-08 04:10</div>
            <div class="timeline-body"><p>Fixed in https://github.com/astral-sh/ruff/pull/9887 -- thank you!</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 01:30:11 UTC
    </footer>
</body>
</html>
