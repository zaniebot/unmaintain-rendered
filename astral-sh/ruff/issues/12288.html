<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RUF012 false positive with annotations set as strings - astral-sh/ruff #12288</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>RUF012 false positive with annotations set as strings</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/ruff/issues/12288">#12288</a>
        opened by <a href="https://github.com/ZeeD">@ZeeD</a>
        on 2024-07-11 12:38
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ZeeD">@ZeeD</a></div>
            <div class="timeline-body">

<p>minimal case:</p>
<pre><code>from typing import ClassVar
from typing import Final


class C:
    cv_orig: ClassVar[list[int]] = []
    cv_str: &#x27;ClassVar[list[int]]&#x27; = []

    cv_final_orig: Final[list[int]] = []
    cv_final_str: &#x27;Final[list[int]]&#x27; = []

    use_case: &#x27;Final[list[C]]&#x27; = []
</code></pre>
<p>with <code>ruff 0.5.1</code> I got the error</p>
<pre><code>RUF012 Mutable class attributes should be annotated with `typing.ClassVar`
</code></pre>
<p>for <code>cv_str</code>, <code>cv_final_str</code> and <code>use_case</code> (that was my initial scenario...)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-07-12 04:26</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-07-12 04:27</div>
            <div class="timeline-body"><p>I think this is the case for other rules as well like <code>RUF008</code>, <code>RUF009</code>, etc.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-07-12 12:36</div>
            <div class="timeline-body"><p>üëç Yeah we would need to parse these. I wonder if we should consider parsing these in the parser and adding them to the AST...</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-07-12 12:37</div>
            <div class="timeline-body"><p>Actually, we probably can&#x27;t do that because you often need semantic information to know if a string is a type annotation.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-07-12 12:44</div>
            <div class="timeline-body"><p>We <em>do</em> parse it: https://github.com/astral-sh/ruff/blob/ecd6865d2800a574baf122583b6e463605af2ef5/crates/ruff_python_parser/src/typing.rs; I guess we need to provide some API to resolve it to the AST node if the model is in a type annotation context.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-07-12 12:45</div>
            <div class="timeline-body"><p>Yeah we just parse it much later, at the end IIRC.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-07-12 12:45</div>
            <div class="timeline-body"><p>Perhaps we could parse these on-demand and store them on the semantic model.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-07-12 12:46</div>
            <div class="timeline-body"><p>I guess that might not work because in theory these need to be evaluated lazily, at the very end (e.g., they can reference symbols that are imported afterwards, IIRC).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-07-12 12:56</div>
            <div class="timeline-body"><p>At least for these 3 rules, they all require a class node which means we can store them in <code>Analyze</code> struct (https://github.com/astral-sh/ruff/blob/ecd6865d2800a574baf122583b6e463605af2ef5/crates/ruff_linter/src/checkers/ast/deferred.rs#L30-L37) and then later use <code>deferred_class.rs</code> (similar to <code>deferred_lambdas.rs</code>) to check for violations for these rules. We might want to update existing logic to not raise a violation if the annotation is a string.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 18:48:55 UTC
    </footer>
</body>
</html>
