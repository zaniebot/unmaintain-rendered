<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rule idea: close file before copy - astral-sh/ruff #12477</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Rule idea: close file before copy</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/ruff/issues/12477">#12477</a>
        opened by <a href="https://github.com/pjonsson">@pjonsson</a>
        on 2024-07-23 14:58
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/pjonsson">@pjonsson</a></div>
            <div class="timeline-body"><p>I recently came across the following (slightly simplified) pattern in two different code bases:</p>
<pre><code>import shutil

from requests import Session


def fun(session: Session, url: str) -&gt; None:
  with session.get(url, stream=True) as response:
    file = &quot;hello.txt&quot;
    dst = &quot;/tmp/otherfile.txt&quot;
    with open(file, &quot;wb&quot;) as f:
      for b in response.iter_content():
        f.write(b)
      shutil.copy(file, dst)
</code></pre>
<p>The issue is the <code>shutil.copy</code> being indented one level too much, so the copy is done before closing the file. Most of the time the code will work as intended, but sometimes the last kilobytes will be missing from the destination file (for the real code, ~100/250000 files were corrupted).</p>
<p>I&#x27;m guessing this kind of bug is typically for code in a single function, so perhaps matching on something like this would catch most cases in the wild:</p>
<pre><code>with open(file, &quot;wb&quot;) as f:
  ...
  shutil.copy(file, dst)
</code></pre>
<pre><code>with tempfile.NamedTemporaryFile() as f:
  ...
  shutil.copy(f.name, dst)
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">rule</span> added by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-07-24 21:22</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 18:48:55 UTC
    </footer>
</body>
</html>
