<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>☂️ Error recovery improvements for the new parser - astral-sh/ruff #10653</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>☂️ Error recovery improvements for the new parser</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/ruff/issues/10653">#10653</a>
        opened by <a href="https://github.com/dhruvmanila">@dhruvmanila</a>
        on 2024-03-29 07:58
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-03-29 07:58</div>
            <div class="timeline-body"><p>This issue tracks any improvements that could or should be made when working on error recovery for the new parser. This will be <em>after</em> #10036 is merged and when error recovery work is started.</p>
<ul>
<li><p>[ ] 1. Avoid including the invalid expression node for empty and unclosed container types. For example,</p>
<pre><code class="language-py">[
</code></pre>
<p>Here, there are no elements and the list isn't closed. Currently, the parser would emit an invalid node and report an error. The AST would contain a list expression with a single invalid node. Refer https://github.com/astral-sh/ruff/pull/10554#discussion_r1540762104</p>
<p>This should be done for list, set, dictionary, and tuple literals and possibly their comprehension variants.</p>
</li>
<li><p>[ ] 2. Re-visit error recovery in pattern parsing. Refer https://github.com/astral-sh/ruff/pull/10966#pullrequestreview-2002663533</p>
</li>
<li><p>[ ] 3. https://github.com/astral-sh/ruff/issues/10570</p>
</li>
<li><p>[ ] 4. Check if we should use the list parsing to recovery from a syntax error in a <code>case</code> block: https://github.com/astral-sh/ruff/pull/10831#discussion_r1557231096</p>
</li>
<li><p>[ ] 5. Double starred expression in a dictionary can only be used as a standalone element. If it's combined with either key or value in dictionary literal or comprehension, the parser doesn't recover well. For example,</p>
<pre><code class="language-py"># Used as key or value
{1: 2, **a: b, a: **b}

# Used in comprehension
{**x: y for x, y in iter}
{x: **y for x, y in iter}
</code></pre>
<p>Possible solution <a href="https://github.com/astral-sh/ruff/pull/10636#discussion_r1542405830">as suggested here</a> to recover is by parsing this as a power operator without a left hand side</p>
<pre><code class="language-py">{ x: &lt;missing&gt;**y for x, y in data}
</code></pre>
<p>See https://github.com/microsoft/TypeScript/blob/02bb3108ad625cddcec228846b9ff56cc5398976/src/compiler/parser.ts#L5506-L5569</p>
</li>
<li><p>[ ] Possible improvement to recovery from an unparenthesized named expression at the statement level. For example,</p>
<pre><code class="language-py">x := 1
</code></pre>
<p>Currently, the parser would parse the <code>x</code> as a statement and throw an error at the <code>:=</code> token as it cannot start any statement. One way would be to <em>allow</em> named expression and check if it's parenthesized or not. Refer https://github.com/astral-sh/ruff/pull/10641#discussion_r1542500243</p>
</li>
<li><p>[ ] 6. If there are multiple expressions in a parenthesized context <strong>not</strong> separated by a comma, we could possibly use the tuple parsing. For example,</p>
<pre><code class="language-py">(1 2)
</code></pre>
<p>Here, it could be a missing comma error but currently the parser would expect a closing parenthesis after <code>1</code>. Refer https://github.com/astral-sh/ruff/pull/10641#discussion_r1542503837</p>
</li>
<li><p>[x] #20849</p>
</li>
<li><p>[ ] 8. Currently, the top level expression parsing uses the <code>star_expressions</code> rule which is what the grammar has. This means that for an unparenthesized named expression, the error messages aren't really that useful. We could potentially use <code>star_named_expressions</code> rule and report an error if an unparenthesized named expression was found. Refer https://github.com/astral-sh/ruff/pull/10659/files#r1547373837</p>
</li>
<li><p>[ ] 9. The default case for expression parsing gives confusing error message:</p>
<pre><code>  |
3 | (x :=
4 | 
5 | def foo():
  | ^^^ Syntax Error: Expected an identifier, but found a keyword 'def' that cannot be used here
6 |     pass
  |
</code></pre>
<p>This is because the if the expression parsing didn't find any valid start token for an expression, it first checks if it's a keyword and if it is then it parses it as a named expression (<a href="https://github.com/astral-sh/ruff/blob/9a4bed5eec6584950afc5458a2e1f3273ef168be/crates/ruff_python_parser/src/parser/expression.rs#L523-L524">source</a>). Refer https://github.com/astral-sh/ruff/pull/10659/files#r1547376735</p>
</li>
<li><p>[ ] 10. Possible improvement when the left-hand side is missing for an infix expressions such as binary, boolean and compare expression. Currently, the parser would drop the token and parse the right-hand side as a standalone expression. Refer https://github.com/astral-sh/ruff/pull/10730#discussion_r1547606839</p>
</li>
<li><p>[ ] 11. Currently, the parser drops the left side of <code>=</code> of the keyword argument in a call expression when it's not a name expression. The reason being that only a name expression is allowed at that position. A possible recovery would be to add it to the <code>args</code> list but that means that it's a missing comma. For example, <code>call(x + y = 1)</code>, here <code>x + y</code> isn't allowed. Refer https://github.com/astral-sh/ruff/pull/10733#discussion_r1547831007</p>
</li>
<li><p>[ ] 12. In <code>for</code> statement, the parser should parse the target if it's <em>not</em> at <code>in</code> token. This could improve error recovery in case the target is absent. For example, <code>for in b: ...</code>. Refer https://github.com/astral-sh/ruff/pull/10816#discussion_r1555479143.</p>
<p>The underlying problem could be something else. If the parser doesn't find a token which starts an expression, then the expression parsing's fallback mechanism is to first check if the token is a keyword, if so then parse it as <code>ExprName</code>, else report an error and return an empty <code>ExprName</code> (<a href="https://discord.com/channels/1039017663004942429/1144561539219734578/1227243794190045236">Internal discussion</a>).</p>
</li>
<li><p>[ ] 13. In <code>try</code> statement, if <code>finally</code> is present then the <code>else</code> block can come only before it. If it comes after the <code>finally</code> block, it's an error. In that case, the parser will not parse the <code>else</code> block as part of the try statement and it'll parse the statements inside the block as per of the outer node. Refer https://github.com/astral-sh/ruff/pull/10815#discussion_r1555451275</p>
</li>
<li><p>[ ] 14. Decorators with missing expressions or decorators being applied on the wrong node. Refer https://github.com/astral-sh/ruff/blob/f4fd047ea43e2c32cf4b12e73e9106e038c2db59/crates/ruff_python_parser/src/parser/statement.rs#L2224-L2237</p>
</li>
<li><p>[ ] 15. Avoid dropping the <code>async</code> token while parsing an async statement. Refer: https://github.com/astral-sh/ruff/pull/10819#discussion_r1555471523</p>
</li>
<li><p>[ ] 16. For <code>Mode::Expression</code>, currently the parser will drop all of the remaining tokens after the first expression is parsed. We could potentially have a better recovery by continue parsing till the current token is not the start of an expression and collect all the parsed expressions as a <code>ExprTuple</code>. The parser would raise an &quot;expected a comma&quot; error between each expression. Even after this, there could potentially be extra tokens which could represent a statement so we should keep dropping the tokens. Refer: https://github.com/astral-sh/ruff/pull/10981#pullrequestreview-2004395758</p>
</li>
<li><p>[ ] 17. https://github.com/astral-sh/ruff/issues/16140</p>
</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">parser</span> added by @dhruvmanila on 2024-03-29 07:58</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @dhruvmanila by @dhruvmanila on 2024-03-29 08:39</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/10730.html">astral-sh/ruff#10730</a> on 2024-04-03 09:13</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/14315.html">astral-sh/ruff#14315</a> on 2024-11-14 04:44</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Unassigned @dhruvmanila by @dhruvmanila on 2025-02-14 08:37</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/16140.html">astral-sh/ruff#16140</a> on 2025-02-14 08:49</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">tracking</span> added by @dhruvmanila on 2025-02-19 03:05</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/16493.html">astral-sh/ruff#16493</a> on 2025-03-08 03:31</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2025-03-08 03:36</div>
            <div class="timeline-body"><ul>
<li>[ ] 18. Consider changing <code>ast::ExprSubscript</code> to make <code>slice</code> field <code>Optional</code> so that an empty slice (which is an error) does not need to include an empty <code>ExprName</code> node as a placeholder.</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/18281.html">astral-sh/ruff#18281</a> on 2025-05-26 11:29</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/11happy">@11happy</a> on 2025-11-07 03:40</div>
            <div class="timeline-body"><p>Hello @dhruvmanila , is this issue still open ? I noticed its not marked as <code>help_wanted</code> so I just wanted to check. I am interested to work on this and would really appreciate any pointers or context to get started. Thank you : )</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntBre">@ntBre</a> on 2025-11-07 19:15</div>
            <div class="timeline-body"><p>@11happy are you interested in any of the sub-tasks in particular? I think these could be pretty tricky to work on and may require some design work from us, but Dhruv would know better than me.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/11happy">@11happy</a> on 2025-11-09 10:15</div>
            <div class="timeline-body"><p>I am interested to start with first one <code>Avoid including the invalid expression node for empty and unclosed container types</code> , overall I am interested on this broader task &amp; exploring other subtasks as I go,</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-11-10 08:59</div>
            <div class="timeline-body"><p>@11happy this seems like a good start as it doesn't require any changes to the AST. Do you have any specific questions?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/21703.html">astral-sh/ruff#21703</a> on 2025-11-30 13:41</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/11happy">@11happy</a> on 2025-11-30 13:42</div>
            <div class="timeline-body"><p>I have linked the PR for first one.
Thank you : )</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/21720.html">astral-sh/ruff#21720</a> on 2025-12-01 09:13</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/11happy">@11happy</a> on 2025-12-01 09:15</div>
            <div class="timeline-body"><p>I have linked the PR for 5th one , would appreciate a review.
Thank you : )</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 01:30:12 UTC
    </footer>
</body>
</html>
