<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>F504: Carriage return prevents expression extraction - astral-sh/ruff #4899</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>F504: Carriage return prevents expression extraction</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/issues/4899">#4899</a>
        opened by <a href="https://github.com/addisoncrump">@addisoncrump</a>
        on 2023-06-06 09:22
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/addisoncrump">@addisoncrump</a></div>
            <div class="timeline-body"><p>In Python, a standalone carriage return character (0xd or <code>\r</code>) is considered whitespace. One could easily argue that this is quite problematic, given that carriage returns can potentially be used to hide parts of source code. That said, it does trigger a failure in F504 (<code>\r</code> replaced literally):</p>
<pre><code class="language-py">&quot;&quot; % {
  'test1': '',\r  'test2': '',
}
</code></pre>
<p><a href="https://github.com/charliermarsh/ruff/files/11662694/pathological.txt">And a downloadable version to test against.</a></p>
<p>I would simply mark F504 as sometimes fixable, but this solution doesn't feel right. Instead, this feels indicative of incorrect handling of carriage returns as plain whitespace. At the same time, standalone carriage returns should probably be marked as invalid anyways.</p>
<p>I leave this to the discretion of the developers of Ruff :slightly_smiling_face: We should find a fix one way or another to avoid future issues with this being marked as a failure case in the fuzzer.</p>
<p>Discovered by #4822.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @charliermarsh on 2023-06-06 14:27</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-08-16 04:14</div>
            <div class="timeline-body"><p>Perhaps a bug in LibCST, which is failing to parse it?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/addisoncrump">@addisoncrump</a> on 2023-08-17 19:25</div>
            <div class="timeline-body"><p>I'm not so clear on that. Is this because libCST is used to parse the expression for repair?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-08-17 19:27</div>
            <div class="timeline-body"><p>Yeah</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-08-17 19:27</div>
            <div class="timeline-body"><p>The LibCST parse call throws an error, but it could be our fault, not theirs. We may need to wrap the expression in parentheses before parsing.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2023-08-20 03:45</div>
            <div class="timeline-body"><blockquote>
<p>We may need to wrap the expression in parentheses before parsing.</p>
</blockquote>
<p>I did a quick experiment and this doesn't help either, it still throws an error:</p>
<pre><code class="language-rust">libcst_native::parse_expression(&amp;format!(&quot;({})&quot;, &amp;contents))
</code></pre>
<pre><code>Failed to parse file: Internal error while parsing whitespace: Found newline at (2, 15) but it's not EOL
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-08-21 08:11</div>
            <div class="timeline-body"><p>This is a bug in LibCST. It seems they don't support mixed newlines:</p>
<p>https://github.com/Instagram/LibCST/blob/c91655fbba7c27db05423673609f10203316b9c0/native/libcst/src/tokenizer/whitespace_parser.rs#L67-L88</p>
<p>Changing the <code>split</code> to split on all new lines seems trivial enough, but I worry that there's other code that simply doesn't work if you use <code>\r</code></p>
<p>For example:</p>
<p>https://github.com/Instagram/LibCST/blob/c91655fbba7c27db05423673609f10203316b9c0/native/libcst/src/tokenizer/whitespace_parser.rs#L90-L94</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-08-30 11:38</div>
            <div class="timeline-body"><p>Upstream fix in LibCST https://github.com/Instagram/LibCST/pull/1007</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-09-02 09:03</div>
            <div class="timeline-body"><p>The upstream fix is merged. All that we need to do now is to update libcst ðŸ«£</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @dhruvmanila on 2023-09-03 03:41</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 16:47:22 UTC
    </footer>
</body>
</html>
