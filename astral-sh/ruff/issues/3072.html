<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Adding flake8-future-annotations - astral-sh/ruff #3072</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Adding flake8-future-annotations</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/issues/3072">#3072</a>
        opened by <a href="https://github.com/TylerYep">@TylerYep</a>
        on 2023-02-20 22:01
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/TylerYep">@TylerYep</a></div>
            <div class="timeline-body"><p>Hi, I authored the flake8-future-annotations plugin: https://github.com/TylerYep/flake8-future-annotations and I think it would be a good addition to ruff.</p>
<p>The goal of the lint rule is to verifies python 3.7+ files use from <strong>future</strong> import annotations if a type is used in the module that can be rewritten using <a href="https://www.python.org/dev/peps/pep-0563/">PEP 563</a> e.g. <code>typing.List, Dict, Optional, Union, etc</code>.</p>
<p>It pairs especially well with <a href="https://github.com/asottile/pyupgrade">pyupgrade</a> with the --py37-plus flag or higher, since pyupgrade only replaces type annotations with the PEP 563 rules if from <strong>future</strong> import annotations is present, which I also see is included in ruff.</p>
<p>I plan to take a stab at implementing it (I see many of the necessary components are already tracked in ast.rs) in the following order:</p>
<ul>
<li>Add FA100 (missing future annotations import in Python 3.7+)</li>
<li>Add an autofix for FA100 (adds missing future annotations import)</li>
<li>Add FA102 (uses simplified types like <code>list</code> or <code>dict</code> but missing future annotations import in Python 3.7 to 3.10)</li>
</ul>
<p>All feedback is welcome, thanks!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-02-21 03:36</div>
            <div class="timeline-body"><p>Cool, thanks for writing this up! My only hesitation is around how this overlaps / interacts with some of the functionality that we already support -- e.g., right now, you <em>can</em> enforce <code>__future__</code> annotation imports via <a href="https://beta.ruff.rs/docs/settings/#required-imports"><code>required-imports</code></a>. So if I understand correctly, these rules would be similar (and the autofix would be equivalent), with the distinction that they'd only trigger under certain conditions -- e.g., quoted annotations or simplified types, is that right?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">question</span> added by @charliermarsh on 2023-02-21 03:36</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/TylerYep">@TylerYep</a> on 2023-02-21 07:52</div>
            <div class="timeline-body"><p>Yes, the lint rule was designed such that it only raises an error if the file benefits from <code>from __future__ import annotations</code> because it uses some <code>typing</code> import, but doesn't complain for files that don't need it. This prevents adding extra <code>from __future__ import annotations</code> imports that aren't actually needed.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-02-28 17:10</div>
            <div class="timeline-body"><p>Hey sorry -- lost track of this one. I try not to inject too much opinion into what gets included and excluded, but what do you see as the benefit of omitting future annotations from files that don't need it? To me it feels easier to either use them in all files for a given package (for consistency of semantics) or none at all.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/TylerYep">@TylerYep</a> on 2023-02-28 18:23</div>
            <div class="timeline-body"><p>I'm currently type-checking a large monorepo, and to avoid making changes to all files at once, adding future annotations only to changed files is easier for incremental rollout and safety on legacy code. I'm not sure if you can achieve the same effect using isort's require_imports.</p>
<p>Honestly fine either way you decide here, I recognize that adding redundant plugins can add to the future maintainability of a project. But I am interested to hear what the broader criteria for including/excluding lint rules is; the flake8-future-annotations plugin has ~600k downloads now, so it is getting some use, but it is unclear to me if ruff just eats all tools to become the mega-tool or is more selective at redirecting functionality.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-03-06 03:17</div>
            <div class="timeline-body"><p>If you're still interested, I'd be happy to support you in implementing this. It does seem complementary to what we already have with <code>require_imports</code>.</p>
<p>A couple questions...</p>
<blockquote>
<p>I'm currently type-checking a large monorepo, and to avoid making changes to all files at once, adding future annotations only to changed files is easier for incremental rollout and safety on legacy code.</p>
</blockquote>
<p>What's the workflow typically look like here? As in, how do the rules help with incremental migrations?</p>
<blockquote>
<p>Add FA100 (missing future annotations import in Python 3.7 to 3.10)</p>
</blockquote>
<p>Does FA100 not go beyond 3.10?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/TylerYep">@TylerYep</a> on 2023-03-06 08:32</div>
            <div class="timeline-body"><blockquote>
<p>What's the workflow typically look like here? As in, how do the rules help with incremental migrations?</p>
</blockquote>
<p>One example is I want to upgrade types in certain parts of a project to modern PEP 585 syntax (e.g. <code>list[int | None]</code> instead of <code>List[Optional[int]]</code>) . To do so, I need to add <code>from __future__ import annotations</code> to those files and then run pyupgrade on it.</p>
<p>In ruff, the existing mechanism to do so would be to add the future annotations line to <code>required-imports</code>, however if my codebase has 1000 files, it would be unwise to add the import to all files in one go, especially if many of the files don't need the line added at all. The more minimal process is to enforce this import to one subfolder at a time, deploying changes and monitoring for errors, and trying to keep these commits as small as possible (minimize touched files and lines) to limit the blast radius.</p>
<blockquote>
<p>Does FA100 not go beyond 3.10?</p>
</blockquote>
<p>Fixed above to clarify the lint rule is currently applied for Python 3.7+, but the rules are not strictly necessary past Python 3.10 because <code>set[int]</code> works without <code>from __future__ import annotations</code> in Python 3.10+, and pyupgrade fixes those when <code>--py310-plus</code> is enabled. However as many projects support older versions the import is still recommended.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-03-06 13:59</div>
            <div class="timeline-body"><blockquote>
<p>One example is I want to upgrade types in certain parts of a project to modern PEP 585 syntax (e.g. list[int | None] instead of List[Optional[int]]) . To do so, I need to add from <strong>future</strong> import annotations to those files and then run pyupgrade on it.</p>
</blockquote>
<p>Yeah this makes sense. I was mostly wondering if <code>flake8-future-annotations</code> helps with that, since in that case, you still need to add <code>from __future__ import annotations</code> manually in order to trigger that flow, right?</p>
<blockquote>
<p>Fixed above to clarify the lint rule is currently applied for Python 3.7+, but the rules are not strictly necessary past Python 3.10.</p>
</blockquote>
<p>Oh right right. (I was mistakenly wondering if the 3.10 limit was based on the original timeline for stabilizing future annotations.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">question</span> removed by @charliermarsh on 2023-03-06 13:59</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">plugin</span> added by @charliermarsh on 2023-03-06 13:59</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/TylerYep">@TylerYep</a> on 2023-03-06 20:00</div>
            <div class="timeline-body"><blockquote>
<p>Yeah this makes sense. I was mostly wondering if flake8-future-annotations helps with that, since in that case, you still need to add from <strong>future</strong> import annotations manually in order to trigger that flow, right?</p>
</blockquote>
<p>Yes, because flake8-future-annotations only raises the lint error if a file uses an import like <code>typing.List</code> or <code>typing.Optional</code> without future annotations. On files that don't use this error, the future annotations import does not need to be added. SO presumably the ruff version of this lint would detect those <code>typing.List</code> imports and auto-add future annotations to only those files.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Avasam">@Avasam</a> on 2023-04-07 23:29</div>
            <div class="timeline-body"><p>I skimmed through the conversation here, I wanted to suggest a standalone <code>from __future__ import annotations</code> rule as well.
My reasoning is builtin exclusion from stub files. Basically wrapping all this configuration into a single rule:</p>
<pre><code class="language-toml">[tool.ruff.isort]
required-imports = [&quot;from __future__ import annotations&quot;]

[tool.ruff.per-file-ignores]
&quot;*.pyi&quot; = [
  &quot;I002&quot;, # from __future__ import annotations
]
</code></pre>
<p>Even more so in the context of eventually having extendible configuration, I would prefer leaving &quot;required-imports&quot; empty in my base config and let per-project configuration override it.</p>
<hr />
<p>As for TylerYep's request to only adding the line when needed. I'd consider it dead code. It's a good standard to always add it when devs have to manually track it. But if tooling is aware of when it's needed of not, then devs don't have to think about it or see it when it's not needed.</p>
<p>In other words: it's an unused import and imo should be treated as such.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "Adding flake8-future-annotatations" to "Adding flake8-future-annotations" by @TylerYep on 2023-04-08 06:54</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-05-29 22:53</div>
            <div class="timeline-body"><p>I think this is good to go after #4702, apart from the autofix.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2023-05-29 22:53</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Kludex">@Kludex</a> on 2025-01-03 13:22</div>
            <div class="timeline-body"><p>Is the autofix work being tracked somewhere?</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 16:46:36 UTC
    </footer>
</body>
</html>
