```yaml
number: 14200
title: "[red-knot] Audit handling of metaclasses in various contexts, add more tests"
type: issue
state: closed
author: AlexWaygood
labels:
  - ty
assignees: []
created_at: 2024-11-08T12:04:14Z
updated_at: 2025-03-31T11:01:26Z
url: https://github.com/astral-sh/ruff/issues/14200
synced_at: 2026-01-10T01:56:54Z
```

# [red-knot] Audit handling of metaclasses in various contexts, add more tests

---

_Issue opened by @AlexWaygood on 2024-11-08 12:04_

Now that we support metaclasses, we should verify that all of the following work as expected. If they do, we should add tests that assert that they do; if they don't, we have some bugs to fix:

```py
from __future__ import annotations
from typing import Literal


class IntIterator:
    def __next__(self) -> int:
        return 42


class Meta(type):
    def __add__(self, other: Meta) -> int:
        return 42

    def __lt__(self, other: Meta) -> Literal[True]:
        return True

    def __getitem__(self, key: int) -> str:
        return "foo"

    def __iter__(self) -> IntIterator:
        return IntIterator()

    def __enter__(self) -> bytes:
        return b"42"

    def __exit__(self, *args) -> None:
        pass


class A(metaclass=Meta): ...
class B(metaclass=Meta): ...


reveal_type(A + B)  # revealed: int
reveal_type(A < B)  # revealed: Literal[True]
reveal_type(A[42])  # revealed: str


for x in A:
    reveal_type(x)  # revealed: int


with A as var:
    reveal_type(var)  # revealed: bytes
```

Cc. @charliermarsh, if you're interested!

---

_Label `red-knot` added by @AlexWaygood on 2024-11-08 12:04_

---

_Label `help wanted` added by @AlexWaygood on 2024-11-08 13:30_

---

_Assigned to @charliermarsh by @charliermarsh on 2024-11-08 21:38_

---

_Comment by @carljm on 2024-11-09 19:17_

I'm torn here, because we definitely do want this eventually, and it makes a lot of sense for @charliermarsh to follow up on it while the metaclass stuff is still fresh, but on the other hand -- I don't think that understanding these aspects of metaclasses is blocking other type system features, nor do I think it has a lot of technical risk, nor do I think it's necessary to pass much of the conformance suite. So is it a priority to work on right now?

---

_Comment by @AlexWaygood on 2024-11-09 19:20_

No, not a priority, agreed! There may well be more important things for Charlie to work on. It felt like it wasn't a huge task, though, and as you say, it felt like it make sense to work on it now while metaclass considerations were fresh in our minds.

No strong opinion at all as to whether we work on it now or just add this issue to the backlog to work on later!

---

_Unassigned @charliermarsh by @charliermarsh on 2024-11-09 19:27_

---

_Referenced in [astral-sh/ruff#14548](../../astral-sh/ruff/issues/14548.md) on 2024-11-23 11:20_

---

_Assigned to @carljm by @carljm on 2024-12-02 18:33_

---

_Label `help wanted` removed by @carljm on 2024-12-02 18:38_

---

_Unassigned @carljm by @carljm on 2025-01-09 17:49_

---

_Referenced in [astral-sh/ruff#17081](../../astral-sh/ruff/pulls/17081.md) on 2025-03-31 08:04_

---

_Comment by @sharkdp on 2025-03-31 08:07_

All of these things are now supported with the new dunder-call infrastructure and proper attribute lookup via meta types. One last remaining case was binary operator inference, which needed to be generalized from `Type::Instance(â€¦)` to all types: #17081 

---

_Closed by @sharkdp on 2025-03-31 11:01_

---
