<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>F842 false positive when using local variable in list comprehension - astral-sh/ruff #13190</title>
    <link rel="stylesheet" href="../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../index.html">Back to index</a>
    </div>

    <h1>F842 false positive when using local variable in list comprehension</h1>

    <div class="meta">
        <span class="state state-closed">Closed</span>
        <a href="https://github.com/astral-sh/ruff/issues/13190">#13190</a>
        opened by <a href="https://github.com/billwallis">@billwallis</a>
        on 2024-09-01 10:01
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/billwallis">@billwallis</a> on 2024-09-01 10:01</div>
            <div class="timeline-body"><blockquote>
<p>[!NOTE]</p>
<p>Keywords searched for before raising this issue:</p>
<ul>
<li><code>F842</code></li>
<li><code>unused-annotation</code></li>
<li><code>false positive</code></li>
<li><code>list comprehension</code></li>
</ul>
</blockquote>
<h2>Issue summary</h2>
<p>Rule <a href="https://docs.astral.sh/ruff/rules/unused-annotation/">F842 (<code>unused-annotation</code>)</a> is incorrectly flagging a type-annotated local variable as unused when the variable is used in a list comprehension.</p>
<p>For example, the snippet below:</p>
<pre><code class="language-python">def main():
    var: int
    [print(var) for var in range(1)]
</code></pre>
<p>...will cause the following linting error:</p>
<pre><code>...: F842 Local variable `var` is annotated but never used
  |
1 | def main():
2 |     var: int
  |     ^^^ F842
3 |     [print(var) for var in range(1)]
</code></pre>
<p>Note, however, that this does <strong><em>NOT</em></strong> get flagged when <code>var</code> is a global variable:</p>
<pre><code class="language-python">var: int  # this is fine
[print(var) for var in range(1)]
</code></pre>
<hr />
<h2>Configuration and invocation details</h2>
<p>I use Ruff in pre-commit -- hooks config is:</p>
<pre><code class="language-yaml">- repo: https://github.com/astral-sh/ruff-pre-commit
  rev: v0.6.3
  hooks:
    - id: ruff
      args: [&quot;--fix&quot;]
    - id: ruff-format
</code></pre>
<p>...and Ruff was invoked both via <code>git commit</code> and <code>pre-commit run ruff --all-files</code>.</p>
<p>My <code>pyproject.toml</code> settings for Ruff are:</p>
<pre><code class="language-toml">[tool.ruff]
line-length = 80
indent-width = 4
target-version = &quot;py311&quot;

[tool.ruff.format]
quote-style = &quot;double&quot;
indent-style = &quot;space&quot;
skip-magic-trailing-comma = false
line-ending = &quot;auto&quot;

[tool.ruff.lint]
select = [&quot;F&quot;, &quot;I&quot;, &quot;N&quot;, &quot;PL&quot;, &quot;R&quot;, &quot;RUF&quot;, &quot;S&quot;, &quot;UP&quot;, &quot;W&quot;]
ignore = []
fixable = [&quot;ALL&quot;]
unfixable = []
# Allow unused variables when underscore-prefixed
dummy-variable-rgx = &quot;^(_+|(_+[a-zA-Z0-9_]*[a-zA-Z0-9]+?))$&quot;

# https://github.com/astral-sh/ruff/issues/4368
[tool.ruff.lint.extend-per-file-ignores]
&quot;tests/**/*.py&quot; = [
    &quot;S101&quot;,    #  Use of `assert` detected
    &quot;PLR2004&quot;, #  Magic value used in comparison
]
</code></pre>
<p>Environment details:</p>
<ul>
<li>Operating system: <code>Windows 10</code></li>
<li>Python version: <code>3.11.5</code></li>
<li>Pre-commit version: <code>3.8.0</code></li>
<li>Ruff version: <code>0.6.3</code></li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @AlexWaygood on 2024-09-01 10:14</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dylwil3">@dylwil3</a> on 2024-09-01 15:53</div>
            <div class="timeline-body"><p>Is this a bug? Isn't the <code>var</code> that appears in the comprehension in it's own local scope?</p>
<p>Like if I do:</p>
<pre><code class="language-python">x = 3
[print(x) for x in [&quot;a&quot;,&quot;b&quot;,&quot;c&quot;]]
print(x)
</code></pre>
<p>I get the output:</p>
<pre><code>a
b
c
3
</code></pre>
<p>So even if I know the first <code>x</code> is an int, there's no need for it to still be an <code>int</code> inside the comprehension.</p>
<p>And the global variable example is part of the rule's documented behavior: &quot;Checks for local variables that are annotated but never used.&quot; (Presumably global variables are never checked in the 'used' rules since they may be imported - though this case is a little weird since I'm not sure people are declaring types of global variables without assigning them, then later importing those unbound variables... But in any event it is expected behavior for the rule, I think).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> removed by @AlexWaygood on 2024-09-01 16:06</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-09-01 16:08</div>
            <div class="timeline-body"><p>Very good point @dylwil3! Apparently that's the <a href="https://github.com/astral-sh/ruff/pull/13177#discussion_r1739860392">second time</a> I've managed to confuse myself about the scoping of comprehension variables this weekend...</p>
<p>@Bilbottom does that make sense to you?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">question</span> added by @AlexWaygood on 2024-09-01 16:08</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/billwallis">@billwallis</a> on 2024-09-02 06:11</div>
            <div class="timeline-body"><p>Thanks @dylwil3 and @AlexWaygood for the quick replies ðŸ¤“</p>
<p>I also didnâ€™t think about scope... and I totally agree that the variable in the function scope doesnâ€™t have to be the same type as the variable in the list comprehension scope ðŸ˜‹</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @billwallis on 2024-09-02 06:11</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:28:13 UTC
    </footer>
</body>
</html>
