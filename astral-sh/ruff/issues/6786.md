```yaml
number: 6786
title: Rules D100, F401, F811, ICN001 cause infinite loop error
type: issue
state: closed
author: qarmin
labels:
  - bug
  - fixes
  - accepted
assignees: []
created_at: 2023-08-22T17:58:41Z
updated_at: 2023-10-01T08:23:18Z
url: https://github.com/astral-sh/ruff/issues/6786
synced_at: 2026-01-10T01:56:49Z
```

# Rules D100, F401, F811, ICN001 cause infinite loop error

---

_Issue opened by @qarmin on 2023-08-22 17:58_

Ruff 0.0.285 (latest changes from main branch)

```
ruff  *.py --select ALL --no-cache
```

file content:
```
try:
  import pandas as pa
  import pyarrow as pa
except ImportError:
  pass
```

error:
```
error: Failed to converge after 100 iterations.

This indicates a bug in `ruff`. If you could open an issue at:

    https://github.com/astral-sh/ruff/issues/new?title=%5BInfinite%20loop%5D

...quoting the contents of `PY_FILE_TEST_4291307560.py`, the rule codes D100, F401, F811, ICN001, along with the `pyproject.toml` settings and executed command, we'd be very appreciative!

```

[PY_FILE_TEST_4291307560.py.zip](https://github.com/astral-sh/ruff/files/12411494/PY_FILE_TEST_4291307560.py.zip)



---

_Comment by @zanieb on 2023-08-22 18:06_

Oscillates between the following

```python
try:
    import pandas as pd
    import pyarrow as pd
except ImportError:
    pass
```
```python
try:
    import pandas as pa
    import pyarrow as pa
except ImportError:
    pass
```

---

_Comment by @zanieb on 2023-08-22 18:07_

`ICN001` is sufficient to trigger this

Probably related to https://github.com/astral-sh/ruff/blob/db1c5565083fe16b3e2c8892a39412e464b320a1/crates/ruff/src/renamer.rs#L223-L224

---

_Renamed from "Rules D100, F401, F811, ICN00 cause infinite loop error" to "Rules D100, F401, F811, ICN001 cause infinite loop error" by @qarmin on 2023-08-22 18:10_

---

_Label `bug` added by @zanieb on 2023-08-22 18:11_

---

_Label `accepted` added by @zanieb on 2023-08-22 18:11_

---

_Label `autofix` added by @zanieb on 2023-08-22 18:11_

---

_Comment by @charliermarsh on 2023-08-22 18:14_

I think this is actually working "correctly" although we may want to find a way to avoid attempting the fix here. We rename the symbol within the scope, and it's shadowed here. Other editors behave the same way -- if you try to rename the second `pa` here in PyCharm, it will rename both `pa` references:

```python
try:
    import pandas as pa
    import pyarrow as pa
except ImportError:
    pass
```

---

_Comment by @zanieb on 2023-08-22 18:19_

Hm it seems like ideally we would stop once we reach the shadowed binding.

---

_Comment by @charliermarsh on 2023-08-22 18:22_

Although that comes with other problems -- for example, this would fail:

```python
if True:
    import pandas as pa
else:
    import pyarrow as pa
```

I _think_ our behavior is correct since I see the same from PyCharm and Pylance (VS Code).


---

_Comment by @qarmin on 2023-10-01 08:23_

Fix no longer cause problems 

---

_Closed by @qarmin on 2023-10-01 08:23_

---
