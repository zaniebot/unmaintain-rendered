<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>`ruff format` not formatting the files recursively but `ruff format folder/folder1/folder2/folder3` works - astral-sh/ruff #12146</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>`ruff format` not formatting the files recursively but `ruff format folder/folder1/folder2/folder3` works</h1>

    <div class="meta">
        <span class="state state-closed">Closed</span>
        <a href="https://github.com/astral-sh/ruff/issues/12146">#12146</a>
        opened by <a href="https://github.com/vigneshmanick">@vigneshmanick</a>
        on 2024-07-02 08:38
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/vigneshmanick">@vigneshmanick</a> on 2024-07-02 08:38</div>
            <div class="timeline-body"><p>This is a weird issue that i have encountered. I cannot also reproduce it in a similar folder structure outside the current project. I'll try to describe what happens.</p>
<p>I have a python project setup using <code>pyproject.toml</code> and the ruff configuration is as follows</p>
<pre><code class="language-toml">
[tool.pytest.ini_options]
testpaths = [
  &quot;testSuite&quot;,
]

[tool.ruff]
preview = false

exclude = [
  &quot;src/mymodule/somefolder/anotherfolder&quot;,
]

[tool.ruff.lint]
select = [&quot;E&quot;, &quot;F&quot;, &quot;W&quot;, &quot;NPY&quot;, &quot;RUF&quot;, &quot;I&quot;]
ignore = [&quot;E722&quot;, &quot;RUF012&quot;, &quot;E111&quot;, &quot;E114&quot;, &quot;E117&quot;, &quot;E501&quot;, &quot;W191&quot;, &quot;E203&quot;]

[tool.ruff.lint.per-file-ignores]
# Ignore `E402` (import violations) in all `__init__.py` files
&quot;__init__.py&quot; = [&quot;E402&quot;]

</code></pre>
<h4>Issue</h4>
<p>The files inside <code>testSuite</code> are not fomatted when running <code>ruff format</code> from the top level folder.</p>
<p>If i run <code>ruff format testSuite/path/to/folder/inside/</code> then it works but only if the path supplied is the last level in the tree. See output below. Note how the last command formats the files but the first 2 don't.</p>
<pre><code class="language-bash">(myenv) user@node123 project&gt;ruff format .
1001 files left unchanged
(myenv) user@node123 project&gt;ruff format testSuite/testCases/abcutTests/
67 files left unchanged
(myenv) user@node123 project&gt;ruff format testSuite/testCases/abcutTests/HamstrTest/
6 files reformatted, 20 files left unchanged
</code></pre>
<h3>System info</h3>
<ul>
<li>ruff version: 0.4.4</li>
<li>python: 3.11.4</li>
<li>system: Redhat-7.9</li>
</ul>
<p>Any pointers here on what exactly i am doing wrong would be helpful.</p>
<p>Thanks!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "`ruff format` command not formatting the files recursively but `ruff format folder/folder1/folder2/folder3` works" to "`ruff format` not formatting the files recursively but `ruff format folder/folder1/folder2/folder3` works" by @vigneshmanick on 2024-07-02 08:39</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-07-02 09:36</div>
            <div class="timeline-body"><p>Hmm that sounds strange. Any chance that you have a <code>.gitignore</code> or any other ignore file that excludes the <code>testSuite</code> directory?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/vigneshmanick">@vigneshmanick</a> on 2024-07-02 09:41</div>
            <div class="timeline-body"><p>there are <code>.gitignore</code> files but none of them exclude the <code>testSuite</code> directory itself. The existing <code>.gitignore</code> only have entries for test generated files that need to be ignored.</p>
<p>None of the <code>.py</code> files inside the <code>testSuite</code> folder are in the <code>.gitignore</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/vigneshmanick">@vigneshmanick</a> on 2024-07-02 09:55</div>
            <div class="timeline-body"><p>thanks for the hint, i think i might have found out what the issue is.</p>
<p>In one <code>.gitignore</code> an entry was set to <code>**/Hamstr*</code> and i guess this is causing ruff to ignore <code>HamstrTest</code> even though the <code>.py</code> files inside themselves were not in the <code>.gitignore</code>. ?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-07-02 14:15</div>
            <div class="timeline-body"><blockquote>
<p>In one .gitignore an entry was set to **/Hamstr* and i guess this is causing ruff to ignore HamstrTest even though the .py files inside themselves were not in the .gitignore. ?</p>
</blockquote>
<p>Yes, I think that's correct and should also match Git's behavior, as far as I understand, unless you added the files explicitly (or they were tracked before adding the ignore). We use the <a href="https://docs.rs/ignore/latest/ignore/struct.WalkBuilder.html#ignore-rules"><code>ignore</code></a> library that handles this for us.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/vigneshmanick">@vigneshmanick</a> on 2024-07-02 14:35</div>
            <div class="timeline-body"><p>is there a way to see if ruff formatter s ignoring a file due to <code>gitignore</code> ?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-07-02 14:49</div>
            <div class="timeline-body"><p>You can try <code>ruff format -v</code> but I'm not sure if it logs git ignores. Otherwise, <code>ruff format --no-respect-gitignore</code> might do the trick.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/vigneshmanick">@vigneshmanick</a> on 2024-07-03 12:33</div>
            <div class="timeline-body"><p>ok, i have a reproducible example now</p>
<h4>Folder structure</h4>
<pre><code>├── src
│   └── ruff_test
│       ├── __init__.py
│       └── classA.py
├── tests
│   └── NewTests
│       ├── __init__.py
│       └── test_func.py
├── .gitattributes
├── .gitignore
└── pyproject.toml
</code></pre>
<h4>contents of .gitignore</h4>
<pre><code>**/New*/
</code></pre>
<h4>Git</h4>
<p>force add the <code>NewTests</code> folder <code>git add -f NewTests</code></p>
<h4>Ruff</h4>
<p>Now run <code>ruff -v format .</code> at the same level as <code>pyproject.toml</code> The output is as follows</p>
<pre><code>warning: `ruff &lt;path&gt;` is deprecated. Use `ruff check &lt;path&gt;` instead.
[2024-07-03][14:20:25][ruff::resolve][DEBUG] Using Ruff default settings
[2024-07-03][14:20:25][ignore::walk][DEBUG] ignoring /scratch/vm/testDir/ruff_test/tests/NewTests: Ignore(IgnoreMatch(Gitignore(Glob { from: Some(&quot;/scratch/vm/testDir/ruff_test/.gitignore&quot;), original: &quot;**/New*/&quot;, actual: &quot;**/New*&quot;, is_whitelist: false, is_only_dir: true })))
[2024-07-03][14:20:25][ruff_workspace::resolver][DEBUG] Included path via `include`: &quot;/scratch/vm/testDir/ruff_test/pyproject.toml&quot;
[2024-07-03][14:20:25][ruff_workspace::resolver][DEBUG] Ignored path via `exclude`: &quot;/scratch/vm/testDir/ruff_test/.ruff_cache&quot;
[2024-07-03][14:20:25][ruff_workspace::resolver][DEBUG] Ignored path via `exclude`: &quot;/scratch/vm/testDir/ruff_test/.git&quot;
[2024-07-03][14:20:25][ruff_workspace::resolver][DEBUG] Included path via `include`: &quot;/scratch/vm/testDir/ruff_test/src/ruff_test/__init__.py&quot;
[2024-07-03][14:20:25][ruff_workspace::resolver][DEBUG] Included path via `include`: &quot;/scratch/vm/testDir/ruff_test/src/ruff_test/classA.py&quot;
[2024-07-03][14:20:25][ruff::commands::check][DEBUG] Identified files to lint in: 5.58252ms
[2024-07-03][14:20:25][ruff::diagnostics][DEBUG] Checking: /scratch/vm/testDir/ruff_test/pyproject.toml
[2024-07-03][14:20:25][ruff::commands::check][DEBUG] Checked 4 files in: 165.711µs
format:1:1: E902 No such file or directory (os error 2)
</code></pre>
<p>So the <code>ignore</code> library is removing the folder <code>NewTests</code> at the start and the files within <code>NewTests</code> are not shown even though they have been added to the repo.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-07-03 12:38</div>
            <div class="timeline-body"><p>Ruff doesn't check whether a file is added to your git repository. It only interprets your gitignore and determines whether a file should be excluded.</p>
<p>I recommend you update your git ignore to only ignore files that are not part of your repository. This also makes it less likely that someone forgets to commit a python file that's later added to <code>NewTest</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/vigneshmanick">@vigneshmanick</a> on 2024-07-03 12:40</div>
            <div class="timeline-body"><p>Yup, this is what i did now. Just posting it here so that it's documented on why this is happening.  Someone else might be wondering the same as me in future :)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @vigneshmanick on 2024-07-03 12:40</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">question</span> added by @dhruvmanila on 2024-07-04 05:27</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:34:53 UTC
    </footer>
</body>
</html>
