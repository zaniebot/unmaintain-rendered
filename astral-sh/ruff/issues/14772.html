<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>F821 false positive for using a builtin after deleting a name that shadowed the builtin - astral-sh/ruff #14772</title>
    <link rel="stylesheet" href="../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../index.html">Back to index</a>
    </div>

    <h1>F821 false positive for using a builtin after deleting a name that shadowed the builtin</h1>

    <div class="meta">
        <span class="state state-open">Open</span>
        <a href="https://github.com/astral-sh/ruff/issues/14772">#14772</a>
        opened by <a href="https://github.com/dscorbett">@dscorbett</a>
        on 2024-12-04 14:42
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/dscorbett">@dscorbett</a> on 2024-12-04 14:42</div>
            <div class="timeline-body"><p><a href="https://docs.astral.sh/ruff/rules/undefined-name/"><code>undefined-name</code> (F821)</a> in Ruff 0.8.1 reports a name as undefined if it is used after being deleted but the name was shadowing a builtin. In that case, the name will resolve to the builtin without a <code>NameError</code>, so the rule should not report a problem.</p>
<pre><code class="language-console">$ cat f821_1.py
print = 0
del print
print(1)

$ python f821_1.py
1

$ ruff check --isolated --select F821 f821_1.py
f821_1.py:3:1: F821 Undefined name `print`. Consider specifying `requires-python = &quot;&gt;= 3.0&quot;` or `tool.ruff.target-version = &quot;py30&quot;` in your `pyproject.toml` file.
  |
1 | print = 0
2 | del print
3 | print(1)
  | ^^^^^ F821
  |

Found 1 error.
</code></pre>
<p>Specifying the target version as suggested gives a different error.</p>
<pre><code class="language-console">$ ruff check --isolated --select F821 f821_1.py --config 'target-version = &quot;py30&quot;'
error: invalid value 'target-version = &quot;py30&quot;' for '--config &lt;CONFIG_OPTION&gt;'

  tip: A `--config` flag must either be a path to a `.toml` configuration file
       or a TOML `&lt;KEY&gt; = &lt;VALUE&gt;` pair overriding a specific configuration
       option

Could not parse the supplied argument as a `ruff.toml` configuration option:

unknown variant `py30`, expected one of `py37`, `py38`, `py39`, `py310`, `py311`, `py312`, `py313`
in `target-version`

For more information, try '--help'.
</code></pre>
<p>That‚Äôs just a minimal example. Here is more realistic example based on <a href="https://docs.python.org/3/library/gettext.html#deferred-translations">the documentation of the <code>gettext</code> module</a>, which recommends this pattern for deferred translations.</p>
<pre><code class="language-console">$ cat f821_2.py
import gettext
gettext.install(&quot;example&quot;)
def _(message):
    return message
messages = [_(&quot;x&quot;), _(&quot;y&quot;), _(&quot;z&quot;)]
del _
for message in messages:
    print(_(message))

$ python f821_2.py
x
y
z

$ ruff check --isolated --select F821 f821_2.py
f821_2.py:8:11: F821 Undefined name `_`
  |
6 | del _
7 | for message in messages:
8 |     print(_(message))
  |           ^ F821
  |

Found 1 error.
</code></pre>
<p>That example fails even when <code>_</code> is configured as a builtin.</p>
<pre><code class="language-console">$ ruff check --isolated --select F821 f821_2.py --config 'builtins = [&quot;_&quot;]'
f821_2.py:8:11: F821 Undefined name `_`
  |
6 | del _
7 | for message in messages:
8 |     print(_(message))
  |           ^ F821
  |

Found 1 error.
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @AlexWaygood on 2024-12-05 01:13</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dylwil3">@dylwil3</a> on 2024-12-13 15:10</div>
            <div class="timeline-body"><p>That's an interesting and subtle find! I didn't know about this special treatment of builtins. A related thing happens if you try to delete a built-in:</p>
<pre><code class="language-console">‚ùØ uv run --no-project python
Python 3.12.7 (main, Oct 16 2024, 07:12:08) [Clang 18.1.8 ] on darwin
Type &quot;help&quot;, &quot;copyright&quot;, &quot;credits&quot; or &quot;license&quot; for more information.
&gt;&gt;&gt; print
&lt;built-in function print&gt;
&gt;&gt;&gt; del print
Traceback (most recent call last):
  File &quot;&lt;stdin&gt;&quot;, line 1, in &lt;module&gt;
NameError: name 'print' is not defined
</code></pre>
<p>Sort of curious...</p>
<p>Neither <a href="https://pyright-play.net/?pythonVersion=3.12&amp;code=A4JwlgdgLgBAvDAjAKACYFMA2NSSsgD3h3GiA">pyright</a> nor <a href="https://mypy-play.net/?mypy=latest&amp;python=3.12&amp;gist=892483f184ba77b480e95bd8fe9ba21b">mypy</a> seem to know about these facts either.</p>
<p>Does <code>red-knot</code> know about this @carljm ?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2024-12-13 17:50</div>
            <div class="timeline-body"><p>Yeah, mypy and pyright both look pretty confused here :) <code>del</code> isn't very common, and even less common with a name that is also a builtin, so it probably doesn't come up often.</p>
<blockquote>
<p>Does <code>red-knot</code> know about this <a href="https://github.com/carljm">@carljm</a> ?</p>
</blockquote>
<p>Red-knot doesn't understand <code>del</code> at all yet, so no :) But if we implement <code>del</code> support in the way I expect we would, I think correct handling of this should fall out naturally from our model.</p>
<p>FWIW, in terms of what's happening at runtime, this isn't really &quot;special treatment of builtins&quot;. The <code>del</code> statement is working on a name that shadows a builtin in exactly the same way it works on any other name. The behavior falls out from the fact that builtins are a separate scope, they aren't part of the module scope; name lookups fall back to builtins if the name is not found in the module scope. And <code>del</code> only operates on the local scope. So you can't <code>del</code> a builtin if you didn't shadow it with a definition in the module scope, and if you do shadow it and then <code>del</code> that name, the <code>del</code> only removes the shadowing in the module scope, it doesn't affect builtins, so future lookups of that name will not see any definition in the module scope anymore and will fall back to builtins normally.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dylwil3">@dylwil3</a> on 2024-12-13 18:54</div>
            <div class="timeline-body"><blockquote>
<p>so it probably doesn't come up often.
Yeah I don't think this should be a high priority to support üòÑ though it sounds like you're saying it may happen automatically</p>
</blockquote>
<blockquote>
<p>FWIW, in terms of what's happening at runtime, this isn't really &quot;special treatment of builtins&quot;. The del statement is working on a name that shadows a builtin in exactly the same way it works on any other name.</p>
</blockquote>
<p>I think what I found surprising/special is the console example I had above:</p>
<pre><code class="language-console">‚ùØ uv run --no-project python
Python 3.12.7 (main, Oct 16 2024, 07:12:08) [Clang 18.1.8 ] on darwin
Type &quot;help&quot;, &quot;copyright&quot;, &quot;credits&quot; or &quot;license&quot; for more information.
&gt;&gt;&gt; print
&lt;built-in function print&gt;
&gt;&gt;&gt; del print
Traceback (most recent call last):
  File &quot;&lt;stdin&gt;&quot;, line 1, in &lt;module&gt;
NameError: name 'print' is not defined
</code></pre>
<p>Specifically, it's strange to me that the error it's giving me is that <code>'print' is not defined</code>. But maybe what you're saying is that NameError's form CPython have an implicit &quot;within the module scope&quot; in them.</p>
<p>Anyway this is pretty obscure, so no need to keep letting me distract you with it üòÑ</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2024-12-13 19:15</div>
            <div class="timeline-body"><blockquote>
<p>maybe what you're saying is that NameError's form CPython have an implicit &quot;within the module scope&quot; in them.</p>
</blockquote>
<p>In general, no: typically for a name <em>reference</em> you'd only get a <code>NameError</code> if we can't find the name, even after looking up in enclosing scopes / builtins (if not defined in local scope.)</p>
<p>But for the <code>NameError</code> in <code>del</code>, yes, that's exactly right.</p>
<p>So I think really what I'm saying is &quot;it's <code>del</code> that's weird, not builtins&quot; :)</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:28:14 UTC
    </footer>
</body>
</html>
