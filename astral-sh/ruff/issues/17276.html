<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[red-knot] Incorrect syntax error persistent in playground - astral-sh/ruff #17276</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[red-knot] Incorrect syntax error persistent in playground</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/issues/17276">#17276</a>
        opened by <a href="https://github.com/sharkdp">@sharkdp</a>
        on 2025-04-07 14:05
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a></div>
            <div class="timeline-body"><p>This is something that happened to me a few times. It&#x27;s always the same situation. I add a return type annotation by typing <code> -&gt; â€¦</code> after a function definition, and then I&#x27;m left with a syntax error that shouldn&#x27;t be there:</p>
<p><img src="https://github.com/user-attachments/assets/65eb4de3-2ca1-419b-ab07-07c82db6a647" alt="Image"></p>
<p>How to reproduce:</p>
<ul>
<li>Go to https://playknot.ruff.rs/ffc63887-bdf3-4471-a4be-097a2f047e2b</li>
<li>Add an <em>incorrect</em> return annotation (by typing), for example: <code> -&gt; str</code></li>
<li>Observe incorrect syntax error <code>Expected &#x27;:&#x27;, found &#x27;-&#x27; (invalid-syntax)</code></li>
</ul>
<p>Seems to be related to there being <em>another</em> diagnostic as well. If you type <code>-&gt; int</code>, it works fine. If you do random other changes to that file, the error often goes away. For example, if you select all text, cut it, and paste it back in, the error is gone.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">playground</span> added by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-04-07 14:05</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-04-07 14:05</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-04-07 14:57</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-04-07 16:18</div>
            <div class="timeline-body"><p>It&#x27;s very specific about adding <code>-</code> when typing the return type. The problem is that the parser generates 6(!) diagnostics, all starting at the very same position</p>
<pre><code>[
  {
    &quot;id&quot;: &quot;invalid-syntax&quot;,
    &quot;message&quot;: &quot;Expected &#x27;:&#x27;, found &#x27;-&#x27;&quot;,
    &quot;severity&quot;: 2,
    &quot;range&quot;: {
      &quot;__wbg_ptr&quot;: 4924664
    },
    &quot;textRange&quot;: {
      &quot;__wbg_ptr&quot;: 4924816
    }
  },
  {
    &quot;id&quot;: &quot;invalid-syntax&quot;,
    &quot;message&quot;: &quot;Invalid annotated assignment target&quot;,
    &quot;severity&quot;: 2,
    &quot;range&quot;: {
      &quot;__wbg_ptr&quot;: 4924840
    },
    &quot;textRange&quot;: {
      &quot;__wbg_ptr&quot;: 4924872
    }
  },
  {
    &quot;id&quot;: &quot;invalid-syntax&quot;,
    &quot;message&quot;: &quot;Expected an expression&quot;,
    &quot;severity&quot;: 2,
    &quot;range&quot;: {
      &quot;__wbg_ptr&quot;: 4924896
    },
    &quot;textRange&quot;: {
      &quot;__wbg_ptr&quot;: 4924928
    }
  },
  {
    &quot;id&quot;: &quot;invalid-syntax&quot;,
    &quot;message&quot;: &quot;Expected an expression&quot;,
    &quot;severity&quot;: 2,
    &quot;range&quot;: {
      &quot;__wbg_ptr&quot;: 4924952
    },
    &quot;textRange&quot;: {
      &quot;__wbg_ptr&quot;: 4924984
    }
  },
  {
    &quot;id&quot;: &quot;invalid-syntax&quot;,
    &quot;message&quot;: &quot;Unexpected indentation&quot;,
    &quot;severity&quot;: 2,
    &quot;range&quot;: {
      &quot;__wbg_ptr&quot;: 4925008
    },
    &quot;textRange&quot;: {
      &quot;__wbg_ptr&quot;: 4925040
    }
  },
  {
    &quot;id&quot;: &quot;invalid-syntax&quot;,
    &quot;message&quot;: &quot;Expected a statement&quot;,
    &quot;severity&quot;: 2,
    &quot;range&quot;: {
      &quot;__wbg_ptr&quot;: 4925064
    },
    &quot;textRange&quot;: {
      &quot;__wbg_ptr&quot;: 4925096
    }
  }
]
</code></pre>
<p>This seems like something we should improve in the parser but, obviously, this shouldn&#x27;t break the playground.</p>
<p>The reason this breaks the playground is because I use <code>{startLine}:{startColumn}-{id}</code> as a unique identifier, which obviously isn&#x27;t as unique as I thought...</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-04-07 16:39</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-04-07 16:39</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone &quot;Red Knot Alpha&quot; by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-04-07 16:47</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 18:49:48 UTC
    </footer>
</body>
</html>
