<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>nbqa + isort produces false positive - astral-sh/ruff #3744</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>nbqa + isort produces false positive</h1>

    <div class="meta">
        <span class="state state-closed">Closed</span>
        <a href="https://github.com/astral-sh/ruff/issues/3744">#3744</a>
        opened by <a href="https://github.com/patrick-kidger">@patrick-kidger</a>
        on 2023-03-26 17:00
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/patrick-kidger">@patrick-kidger</a> on 2023-03-26 17:00</div>
            <div class="timeline-body"><p>Given a <code>ipynb</code> notebook cell containing only imports:</p>
<pre><code>{
  &quot;cells&quot;: [
    {
      ...
      &quot;source&quot;: [
        &quot;import foo&quot;
      ]
    },
    ...
  ]
}
</code></pre>
<p>then</p>
<pre><code>nbqa ruff --select=I001 --diff my_notebook.ipynb
</code></pre>
<p>produces</p>
<pre><code>@@ -1,6 +1,7 @@
 # %%NBQA-CELL-SEP1d84dd
 import foo
 
+
</code></pre>
<p>i.e. it attempts to add superfluous padding at the end.</p>
<p>If e.g. the config file has <code>lines-after-imports = 2</code> then two superfluous lines of padding are added.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-03-26 17:15</div>
            <div class="timeline-body"><p>Ahh interesting. I'm assuming this is because <code>nbqa</code> concatenates the cells internally, and so can't draw a distinction between a cell consisting of <em>just</em> imports (with non-import content in the subsequent) and a single cell containing both imports and further content.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-03-26 17:16</div>
            <div class="timeline-body"><p>I'll have to look into how the <code>nbqa</code> integration works (since that's implemented in <code>nbqa</code>), though we're also in the process of shipping first-class Jupyter support within Ruff so we'd be much more likely to be able to fix this once that's live.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @charliermarsh on 2023-03-26 17:16</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MarcoGorelli">@MarcoGorelli</a> on 2023-04-01 15:38</div>
            <div class="timeline-body"><p>hey - just FYI, I'm hoping to have a fix for this on the nbqa side some time this weekend</p>
<p>looking forward to first-class jupyter support directly in ruff anyway!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MarcoGorelli">@MarcoGorelli</a> on 2023-04-03 07:31</div>
            <div class="timeline-body"><p>Hi @patrick-kidger - could you try with nbqa version 1.7.0 please? I'd like to think this is now fixed</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/patrick-kidger">@patrick-kidger</a> on 2023-04-03 19:40</div>
            <div class="timeline-body"><p>Hmm, I'm trying it with</p>
<pre><code>repos:
  - repo: https://github.com/nbQA-dev/nbQA
    rev: 1.7.0
    hooks:
    - id: nbqa-ruff 
</code></pre>
<p>and am still getting</p>
<pre><code>nbqa-ruff................................................................Failed
- hook id: nbqa-ruff
- exit code: 1

my_notebook.ipynb:cell_1:1:1: I001 [*] Import block is un-sorted or un-formatted
</code></pre>
<p>My use-case is linting this repo: https://github.com/patrick-kidger/equinox/tree/3744-reproducer. If you want a reproducer than clone the branch I've linked there and run <code>pre-commit run --all-files</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MarcoGorelli">@MarcoGorelli</a> on 2023-04-03 20:18</div>
            <div class="timeline-body"><blockquote>
<p>If you want a reproducer than clone the branch I've linked there and run pre-commit run --all-files.</p>
</blockquote>
<p>thanks, this is useful! will look into it</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../conda-forge/nbqa-feedstock/pulls/49.html">conda-forge/nbqa-feedstock#49</a> on 2023-04-04 08:55</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MarcoGorelli">@MarcoGorelli</a> on 2023-04-04 18:51</div>
            <div class="timeline-body"><p>OK got it - it's because you have <code>lines-after-imports = 2</code></p>
<p>I'm just having a look to see if there's an easy way to turn that off for notebooks which I can document and suggest</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-09-14 20:02</div>
            <div class="timeline-body"><p>I just confirmed that running Ruff directly on the notebook has the expected behavior (e.g., <code>ruff check Untitled.ipynb --select I --fix</code>).</p>
<p>Going to close for now since any further refinements in <code>nbqa</code> can probably be tracked over there!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2023-09-14 20:02</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:34:50 UTC
    </footer>
</body>
</html>
