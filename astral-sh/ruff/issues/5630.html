<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Measuring `LineSuffix` when formatting to include trailing comments - astral-sh/ruff #5630</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Measuring <code>LineSuffix</code> when formatting to include trailing comments</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/issues/5630">#5630</a>
        opened by <a href="https://github.com/cnpryer">@cnpryer</a>
        on 2023-07-09 16:32
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/cnpryer">@cnpryer</a> on 2023-07-09 16:32</div>
            <div class="timeline-body"><p>In #5169 I'm playing with test cases and noticed <code>tuple</code>s with trailing comments exceeding line-length don't get formatted.</p>
<p>I added this to the <code>ruff</code> fixtures for <code>tuple</code> formatting:</p>
<pre><code class="language-py"># Trailing comment should force format
i1 = (&quot;aasdsdasd&quot;, &quot;aasdsdasd&quot;, &quot;aasdsdasd&quot;, &quot;aasdsdasd&quot;, &quot;aasdsdasd&quot;, &quot;aasdsdasd&quot;)  # Trailing
</code></pre>
<p>With <code>black</code> you'll get:</p>
<pre><code class="language-py"># Trailing comment should force format
i1 = (
    &quot;aasdsdasd&quot;,
    &quot;aasdsdasd&quot;,
    &quot;aasdsdasd&quot;,
    &quot;aasdsdasd&quot;,
    &quot;aasdsdasd&quot;,
    &quot;aasdsdasd&quot;,
)  # Trailing
</code></pre>
<p>Here's the modified snapshot results:</p>
<pre><code>Snapshot file: crates/ruff_python_formatter/tests/snapshots/format@expression__tuple.py.snap
Snapshot: format@expression/tuple.py
Source: crates/ruff_python_formatter/tests/fixtures.rs:151
Input file: crates/ruff_python_formatter/resources/test/fixtures/ruff/expression/tuple.py
────────────────────────────────────────────────────────────────────────────────────────
-old snapshot
+new results
────────────┬───────────────────────────────────────────────────────────────────────────
  258   258 │     &quot;qweiurpoiqwurepqiurpqirpuqoiwrupqoirupqoirupqoiurpqiorupwqiourpqurpqurpqurpqurpqurpqurüqurqpuriq&quot;,
  259   259 │ )
  260   260 │ 
  261   261 │ # Trailing comment should force format
  262       │-i1 = (
  263       │-    &quot;aasdsdasd&quot;,
  264       │-    &quot;aasdsdasd&quot;,
  265       │-    &quot;aasdsdasd&quot;,
  266       │-    &quot;aasdsdasd&quot;,
  267       │-    &quot;aasdsdasd&quot;,
  268       │-    &quot;aasdsdasd&quot;,
  269       │-)  # Trailing
        262 │+i1 = (&quot;aasdsdasd&quot;, &quot;aasdsdasd&quot;, &quot;aasdsdasd&quot;, &quot;aasdsdasd&quot;, &quot;aasdsdasd&quot;, &quot;aasdsdasd&quot;)  # Trailing
  270   263 │ ```
</code></pre>
<p>If I can scoop this up in #5169 I'll submit a separate PR, but I figured I could start by documenting this here.</p>
<br>

<p><strong>UPDATE</strong>: Looking into it more this looks like a general trailing comment issue rather than specifically a <code>tuple</code> issue. You can repro with <code>dict</code> using:</p>
<pre><code class="language-py">d2 = {&quot;a&quot;: 1000, &quot;b&quot;: 1000, &quot;c&quot;: 1000, &quot;d&quot;: 1000, &quot;e&quot;: 1000, &quot;f&quot;: 1000, &quot;g&quot;: 1000}  # Trailing
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">formatter</span> added by @MichaReiser on 2023-07-09 18:09</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-07-09 18:14</div>
            <div class="timeline-body"><p>Yes, this is a generic problem applying to all trailing comments. The reason is that the <code>Printer</code> doesn't measure the content of a <code>LineSuffix</code>. This is mainly to keep the implementation simpler because it would otherwise be necessary to not only track the current position (needed for source maps), but also the line width with trailing comments included.</p>
<p>I don't mind changing the implementation, depending on its performance impact. But I think that this can also be a reasonable deviation. The relevant line where we skip over line suffixes is here:</p>
<p>https://github.com/astral-sh/ruff/blob/56bae34f09acec3963503955693cd393d6555359/crates/ruff_formatter/src/printer/mod.rs#L218-L220</p>
<p>I would probably add a new <code>line_suffix_width</code> state-variable and compute the width of the content on the above-mentioned lines. We can then create a new <code>width()</code> method on the <code>Printer</code> that returns the width (current line position + line suffix width).</p>
<p>The main challenge is how to compute the width without actually printing the content. I guess, we could call into fits and then take the width from there but that feels like a hack.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "Formatter fails to format `tuple`s with trailing comments exceeding line-length" to "Measuring `LineSuffix` when formatting to include trailing comments" by @cnpryer on 2023-07-16 02:11</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-08-06 16:30</div>
            <div class="timeline-body"><p>Does it simplify the problem at all if we constrain the kinds of nodes that can be printed as line suffixes? (Do we ever need line suffix apart from for comments?)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-08-06 16:35</div>
            <div class="timeline-body"><p>I can answer those questions myself. The bigger question is probably whether we want to deviate from Black here or fix this.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/cnpryer">@cnpryer</a> on 2023-08-06 17:09</div>
            <div class="timeline-body"><blockquote>
<p>The bigger question is probably whether we want to deviate from Black here or fix this.</p>
</blockquote>
<p>I think linting influences some of my formatting decisions. So if my understanding is that line-length violations <em>include</em> trailing comments as part of the line suffix calculation, then naturally I'll probably expect the formatting to align with that constraint.</p>
<p>In other words, I currently lean towards how <code>black</code> handles it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-08-07 06:47</div>
            <div class="timeline-body"><blockquote>
<p>I think linting influences some of my formatting decisions. So if my understanding is that line-length violations include trailing comments as part of the line suffix calculation, then naturally I'll probably expect the formatting to align with that constraint.</p>
</blockquote>
<p>That makes sense to me. But this raises the question of whether the formatting must be consistent with all lint rules Ruff supports. I don't think this is a desired property of the formatter because it would limit our options when choosing a formatting, because we could only design for the least common denominator.</p>
<p>I'm leaning towards automatically disabling rules that we know conflict with the formatter (you shouldn't need formatting-related rules if you use our formatter).</p>
<blockquote>
<p>Does it simplify the problem at all if we constrain the kinds of nodes that can be printed as line suffixes? (Do we ever need line suffix apart from for comments?)</p>
</blockquote>
<p>The question is, what are comments ;) We need to support text and hard line breaks at least, possibly labels too. I don't see this as a high risk issue. I'm confident that we can support it and would prefer to delay working on it until we're further along with the formatter. However, we'll have to be extra careful to:</p>
<ul>
<li>ideally: Only pay the additional overhead for line suffixes (don't introduce a new code path that must be executed for each FormatElement)</li>
<li>The change is in line with the semantics of all other IR elements (My main concern is <code>MeasureMode::AllLines</code></li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-08-17 10:21</div>
            <div class="timeline-body"><p>Related black issues</p>
<ul>
<li>https://github.com/psf/black/issues/1713</li>
<li>https://github.com/psf/black/issues/1125</li>
<li>https://github.com/psf/black/issues/3450</li>
<li>https://github.com/psf/black/issues/3329</li>
</ul>
<p>Prettier issue:</p>
<ul>
<li>https://github.com/prettier/prettier/issues/4754</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-08-17 13:26</div>
            <div class="timeline-body"><p>Regarding the consistency with the lint rule issue. I would recommend disabling the rule if someone uses our formatter, similar to what Prettier's eslint plugin does. There are cases where it is known that Black doesn't break your line (it may even not be allowed to break in these positions) and requiring a suppression comment in that case only makes things worse (to add on top of that, the formatter might move your comment, because the line is too long :laughing:)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-08-17 14:36</div>
            <div class="timeline-body"><p>One good counter example of why Ruff should respect the line width that @zanieb made:</p>
<pre><code class="language-python">if (
    first_test() 
    and not settings.TEST_SUITE
):  # nocoverage: We can't verify the signature in test suite since we fetch the events
    pass
</code></pre>
<p>If I deliberately formatted the comment on its own line for better readability, then the formatter shouldn't collapse the line and make the comment exceed the line width.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-08-17 14:39</div>
            <div class="timeline-body"><p>One &quot;simple&quot; implementation idea: Add a <code>reserved_width</code> field to <code>LineSuffix</code> and add that width to <code>printer.state.line_width</code>. This means its up to the line suffix user to decide whether the line suffix should count to the line width or not. The downside to this is that the client code needs to count the characters and use <code>options.tab_width()</code> (doesn't exist today) for the tab space.</p>
<p>@cnpryer would you be interested in implementing this?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-08-17 15:20</div>
            <div class="timeline-body"><p>I promise I'll stop my spam after this.</p>
<p>After discussing this internally. We want to align with black because we believe that respecting the line width improves the readability of code, this includes comments.</p>
<p>There are examples of where Black/Ruff split the line weirdly if it has a long trailing comments. Comments may more likely trigger these problems but aren't limited to them. Let's take the subscript example:</p>
<pre><code class="language-python">a[0] # a very long comment that exceeds the line width and makes the subscript split eventually

# Black
a[
    0
]  # a very long comment that exceeds the line width and makes the subscript split eventually
</code></pre>
<p>This is worse formatting, in my view, but it isn't specific to comments:</p>
<pre><code class="language-python">aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa[4] 

# Ruff
aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa[
    4
]
</code></pre>
<p>It's less likely that you trigger the second case, but the proper solution IMO is to <strong>never</strong> break subscripts if indexing by a number literal. This solves the odd formatting in both cases.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/cnpryer">@cnpryer</a> on 2023-08-17 16:25</div>
            <div class="timeline-body"><blockquote>
<p>@cnpryer would you be interested in implementing this?</p>
</blockquote>
<p>I would, but I want to spend some time today looking at this again (and thinking about it) before I claim it. I've got several things I'm trying to juggle right now, so my main concern is that causing any delay on the formatter's progress.</p>
<p>Off the bat I'm struggling to wrap my head around the client code impact (needing <code>options.tab_width()</code>), but I'm sure it'll make more sense after digging around.</p>
<blockquote>
<p>After discussing this internally. We want to align with black because we believe that respecting the line width improves the readability of code, this includes comments.</p>
</blockquote>
<p>Are you thinking about tossing this in the Alpha bucket? Or would it be Beta territory?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/cnpryer">@cnpryer</a> on 2023-08-17 16:27</div>
            <div class="timeline-body"><p>Ah I see it's in Alpha tracked by #6069</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-08-17 16:30</div>
            <div class="timeline-body"><blockquote>
<p>Are you thinking about tossing this in the Alpha bucket? Or would it be Beta territory?</p>
</blockquote>
<p>Don't feel pressured by it. It's ready when it's ready.</p>
<blockquote>
<p>Off the bat I'm struggling to wrap my head around the client code impact (needing options.tab_width()), but I'm sure it'll make more sense after digging around.</p>
</blockquote>
<p>The client code will need to compute the width of a comment. This means we'll have to duplicate some (or all of)</p>
<p>https://github.com/astral-sh/ruff/blob/910dbbd9b605eb98a27b06611544fa2de11a1256/crates/ruff_formatter/src/printer/mod.rs#L1278-L1298</p>
<p>Specifically, the width of a tab is configurable (is a tab 2 or 4 spaces)?.</p>
<blockquote>
<p>I would, but I want to spend some time today looking at this again (and thinking about it) before I claim it. I've got several things I'm trying to juggle right now, so my main concern is that causing any delay on the formatter's progress.</p>
</blockquote>
<p>Totally up to you. I tagged you because you showed interest in working on the Printer, but I also don't want to pressure you.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-08-17 18:48</div>
            <div class="timeline-body"><p>Okay, I lied... I have one other observation to share. <a href="https://github.com/google/pyink">Pyink</a> excludes trailing pragma comments from the computed width. What's nice about the IR change we've been discussing is that we could support this as well, by simply setting the width to 0 if it is a pragma comment.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/cnpryer">@cnpryer</a> on 2023-08-18 11:55</div>
            <div class="timeline-body"><p>Started looking into it this morning. I'd say leave this as unassigned in case someone wants to leapfrog me. At some point I'll have more time, and when that happens I'd be more comfortable claiming issues.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone "Formatter: Beta" by @MichaReiser on 2023-08-22 14:13</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Removed from milestone "Formatter: Beta" by @MichaReiser on 2023-08-22 14:32</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone "Formatter: Alpha" by @MichaReiser on 2023-08-22 14:32</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/cnpryer">@cnpryer</a> on 2023-08-23 17:19</div>
            <div class="timeline-body"><p>Just wanted to provide some kind of update. Been working on this in small bursts unfortunately (caught up with some other stuff). <a href="https://github.com/cnpryer/ruff/tree/line-suffix">Here</a> is my branch so far. I noticed some pragma activity so I wanted to provide whatever I can to help those efforts.</p>
<p>Don't let me hold you up though. I'll open up a PR if I feel like I can finish this.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @MichaReiser on 2023-08-28 05:46</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/davidszotten">@davidszotten</a> on 2023-08-31 07:40</div>
            <div class="timeline-body"><p>i was expecting this to also fix (example from django)</p>
<p>(<code>-ruff +black</code>)</p>
<pre><code class="language-diff">-UNUSABLE_PASSWORD_SUFFIX_LENGTH = 40  # number of random chars to add after UNUSABLE_PASSWORD_PREFIX
+UNUSABLE_PASSWORD_SUFFIX_LENGTH = (
+    40  # number of random chars to add after UNUSABLE_PASSWORD_PREFIX
+)
</code></pre>
<p>did i misunderstand something?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-08-31 07:45</div>
            <div class="timeline-body"><blockquote>
<p>i was expecting this to also fix (example from django)</p>
<p>(<code>-ruff +black</code>)</p>
<pre><code class="language-diff">-UNUSABLE_PASSWORD_SUFFIX_LENGTH = 40  # number of random chars to add after UNUSABLE_PASSWORD_PREFIX
+UNUSABLE_PASSWORD_SUFFIX_LENGTH = (
+    40  # number of random chars to add after UNUSABLE_PASSWORD_PREFIX
+)
</code></pre>
<p>did i misunderstand something?</p>
</blockquote>
<p>Yes and no. This is related to https://github.com/astral-sh/ruff/pull/6872 The current implementation uses an heuristic of when to use this layout because it is expensive.</p>
<p>https://github.com/astral-sh/ruff/blob/fc89976c24d1c8b9d13d88ef70b619e8a2ac393a/crates/ruff_python_formatter/src/expression/parentheses.rs#L38-L50</p>
<p>We could extend the heuristic to take trailing end of line comments into consideration (use it if the node has any trailing end of line comments).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/davidszotten">@davidszotten</a> on 2023-08-31 12:49</div>
            <div class="timeline-body"><p>thanks for the explanation. your suggestion seems worth a try so started having a look. however, e.g. in the example above we call <code>should_use_best_fit</code> with the <code>ExprConstant</code> but the comments is attached to the <code>StmtAssign</code>. is there some nice way to find the comment from the constant?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-08-31 12:56</div>
            <div class="timeline-body"><p>Hmm good point. You get the parent in <code>NeedsParentheses</code>, but not sure if that will work reliably.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/davidszotten">@davidszotten</a> on 2023-08-31 13:22</div>
            <div class="timeline-body"><p>hm. parent improves the django example but doesn't quite fix it</p>
<pre><code class="language-diff"> UNUSABLE_PASSWORD_SUFFIX_LENGTH = (
-    40
-)  # number of random chars to add after UNUSABLE_PASSWORD_PREFIX
+    40  # number of random chars to add after UNUSABLE_PASSWORD_PREFIX
+)
</code></pre>
<p>we now end up moving the comment</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-08-31 13:36</div>
            <div class="timeline-body"><p>Do I understand correctly that it now gets moved inside of the parentheses? That's rather unexpected.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/davidszotten">@davidszotten</a> on 2023-08-31 14:24</div>
            <div class="timeline-body"><p>sorry for being unclear. it's the other way around</p>
<p>input:</p>
<pre><code>UNUSABLE_PASSWORD_SUFFIX_LENGTH = 40  # number of random chars to add after UNUSABLE_PASSWORD_PREFIX
</code></pre>
<p>black</p>
<pre><code>UNUSABLE_PASSWORD_SUFFIX_LENGTH = (
    40  # number of random chars to add after UNUSABLE_PASSWORD_PREFIX
)
</code></pre>
<p>ruff:</p>
<pre><code>UNUSABLE_PASSWORD_SUFFIX_LENGTH = (
    40
)  # number of random chars to add after UNUSABLE_PASSWORD_PREFIX
</code></pre>
<p>oh, and starting with the black version as input, my ruff impl is unstable :(</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/davidszotten">@davidszotten</a> on 2023-08-31 14:37</div>
            <div class="timeline-body"><p>made a pr so we have code to discuss and a better place for this discussion https://github.com/astral-sh/ruff/pull/7023</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 11:30:39 UTC
    </footer>
</body>
</html>
