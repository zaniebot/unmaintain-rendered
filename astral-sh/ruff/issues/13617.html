<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pydantics model validator causing weird issues when in classmethod-decorators - astral-sh/ruff #13617</title>
    <link rel="stylesheet" href="../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../index.html">Back to index</a>
    </div>

    <h1>Pydantics model validator causing weird issues when in classmethod-decorators</h1>

    <div class="meta">
        <span class="state state-closed">Closed</span>
        <a href="https://github.com/astral-sh/ruff/issues/13617">#13617</a>
        opened by <a href="https://github.com/ollz272">@ollz272</a>
        on 2024-10-03 17:55
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/ollz272">@ollz272</a> on 2024-10-03 17:55</div>
            <div class="timeline-body"><!--
Thank you for taking the time to report an issue! We're glad to have you involved with Ruff.

If you're filing a bug report, please consider including the following information:

* List of keywords you searched for before creating this issue. Write them down here so that others can find this issue more easily and help provide feedback.
  e.g. "RUF001", "unused variable", "Jupyter notebook"
* A minimal code snippet that reproduces the bug.
* The command you invoked (e.g., `ruff /path/to/file.py --fix`), ideally including the `--isolated` flag.
* The current Ruff settings (any relevant sections from your `pyproject.toml`).
* The current Ruff version (`ruff --version`).
-->

<p>We have the following in our ruff config:</p>
<pre><code class="language-.toml">[tool.ruff.lint.pep8-naming]
classmethod-decorators = [&quot;classmethod&quot;, &quot;pydantic.model_validator&quot;, &quot;pydantic.field_validator&quot;]
</code></pre>
<p>This is so we can do the following in our code:</p>
<pre><code class="language-python">import pydantic
from pydantic import BaseModel

class Model(BaseModel):
    &quot;&quot;&quot;Some Model.&quot;&quot;&quot;

    foo: str
    bar: int

    @pydantic.model_validator(mode=&quot;before&quot;)
    def some_validation(cls, data):
        &quot;&quot;&quot;Before Validation.&quot;&quot;&quot;
        if data[&quot;foo&quot;] == &quot;hello&quot; and data[&quot;bar&quot;] == 1:
            raise ValueError

        return data
</code></pre>
<p>This works well, however when we set the validator mode to &quot;after&quot;, this is an instance method rather than a class method, so we get:</p>
<pre><code class="language-python">import pydantic
from pydantic import BaseModel


class Model(BaseModel):
    &quot;&quot;&quot;Some Model.&quot;&quot;&quot;

    foo: str
    bar: int

    @pydantic.model_validator(mode=&quot;before&quot;)
    def before_validation(cls, data):
        &quot;&quot;&quot;Before Validation.&quot;&quot;&quot;
        if data[&quot;foo&quot;] == &quot;hello&quot; and data[&quot;bar&quot;] == 1:
            raise ValueError

        return data

    @pydantic.model_validator(mode=&quot;after&quot;)
    def after_validation(self):
        &quot;&quot;&quot;After Validation.&quot;&quot;&quot;
        if not self.bar:
            raise ValueError

        return self

</code></pre>
<p>We get the following:</p>
<pre><code> N804 First argument of a class method should be named `cls`
   |
19 |     @pydantic.model_validator(mode=&quot;after&quot;)
20 |     def after_validation(self):
   |                          ^^^^ N804
21 |         &quot;&quot;&quot;After Validation.&quot;&quot;&quot;
22 |         if not self.bar:
   |
   = help: Rename `self` to `cls`
</code></pre>
<p>Which is slightly... annoying. We know we can remove this from config and add a class method decorator, but this has always felt a bit verbose to use.</p>
<p>Is there a better way to handle this case? is this something ruff would consider fixing?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-10-03 19:44</div>
            <div class="timeline-body"><p>How would you imagine us fixing this? Taking the full invocation in the config?</p>
<pre><code class="language-toml">classmethod-decorators = [&quot;classmethod&quot;, &quot;pydantic.model_validator(mode=\&quot;before\&quot;)&quot;, &quot;pydantic.field_validator&quot;]
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-10-04 04:15</div>
            <div class="timeline-body"><p>FWIW, the Pydantic docs do recommend to add the <code>@classmethod</code> decorator:</p>
<blockquote>
<p>The first argument should be <code>cls</code> (and we also recommend you use <code>@classmethod</code> below <code>@model_validator</code> for proper type checking), [...]</p>
<p>https://docs.pydantic.dev/latest/concepts/validators/#field-validators</p>
</blockquote>
<p>And, similarly for field validators:</p>
<blockquote>
<p>A few things to note on validators:</p>
<ol>
<li><code>@field_validators</code> are &quot;class methods&quot;, so the first argument value they receive is the <code>UserModel</code> class, not an instance of <code>UserModel</code>. We recommend you use the <code>@classmethod</code> decorator on them below the <code>@field_validator</code> decorator to get proper type checking.</li>
</ol>
<p>https://docs.pydantic.dev/latest/concepts/validators/#field-validators</p>
</blockquote>
<p>Do you use any type checker like mypy or Pyright? Do they work properly?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">question</span> added by @MichaReiser on 2024-10-07 08:08</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">needs-info</span> added by @MichaReiser on 2024-10-07 08:08</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @MichaReiser on 2024-11-20 12:04</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:28:13 UTC
    </footer>
</body>
</html>
