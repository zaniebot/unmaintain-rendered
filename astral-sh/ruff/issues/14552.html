<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RUF022 autofix should be marked unsafe if there are own-line comments between `__all__` items - astral-sh/ruff #14552</title>
    <link rel="stylesheet" href="../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../index.html">Back to index</a>
    </div>

    <h1>RUF022 autofix should be marked unsafe if there are own-line comments between `__all__` items</h1>

    <div class="meta">
        <span class="state state-closed">Closed</span>
        <a href="https://github.com/astral-sh/ruff/issues/14552">#14552</a>
        opened by <a href="https://github.com/phil65">@phil65</a>
        on 2024-11-23 04:12
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/phil65">@phil65</a> on 2024-11-23 04:12</div>
            <div class="timeline-body"><ul>
<li>I searched issues for <code>__all__</code>, couldnt see anything from today.</li>
</ul>
<p>Since 0.8.0, ruff wants to sort my <code>__all__</code> array.
Thats generally very nice, but it also messes up something like.</p>
<pre><code class="language-python">__all__ = [
    # Core components
    &quot;TaskManager&quot;,
    &quot;TaskExecutor&quot;,
    # Models
    &quot;TaskContext&quot;,
    &quot;TaskProvider&quot;,
    &quot;TaskResult&quot;,
    # Utilities
    &quot;execute_concurrent&quot;,
]
</code></pre>
<p>gets sorted to:</p>
<pre><code class="language-python">__all__ = [
    # Models
    &quot;TaskContext&quot;,
    &quot;TaskExecutor&quot;,
    # Core components
    &quot;TaskManager&quot;,
    &quot;TaskProvider&quot;,
    &quot;TaskResult&quot;,
    # Utilities
    &quot;execute_concurrent&quot;,
]
</code></pre>
<p>So it messes up the groups.
Comments are only attached to one item instead of the group when sorting. I am not sure if that is a good assumption. Perhaps ignore sorting it when comments are inside the <strong>all</strong> array?</p>
<p>Thanks! :)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-11-23 08:49</div>
            <div class="timeline-body"><p>Thanks for opening this issue.</p>
<p>Comments are difficult to get right because they have no semantic meaning. Is <code># Core components</code> commenting <code>TaskManager</code> or the entire group? I also know that @AlexWaygood spent a lot of time adding good comment support. So I'm interested to hear his thoughts too.</p>
<p>I see two possible changes instead of removing the fix entirely:</p>
<ol>
<li>Mark the fix as unsafe if there are own-line comments because the fix might change the comment's semantic</li>
<li>Improve the heuristic. For example, the rule could implement sort-by-group similar to isort if some items are separated by blank lines</li>
</ol>
<pre><code class="language-py">__all__ = [
    # Core components
    &quot;TaskManager&quot;,
    &quot;TaskExecutor&quot;,

    # Models
    &quot;TaskContext&quot;,
    &quot;TaskProvider&quot;,
    &quot;TaskResult&quot;,
    
    # Utilities
    &quot;execute_concurrent&quot;,
]
</code></pre>
<p>Is formatted to</p>
<pre><code class="language-py">__all__ = [
    # Core components
    &quot;TaskExecutor&quot;,
    &quot;TaskManager&quot;,

    # Models
    &quot;TaskContext&quot;,
    &quot;TaskProvider&quot;,
    &quot;TaskResult&quot;,
    
    # Utilities
    &quot;execute_concurrent&quot;,
]
</code></pre>
<p>I'm sure @AlexWaygood has some thought</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @MichaReiser on 2024-11-23 08:49</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Reopened by @MichaReiser on 2024-11-23 08:49</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">rule</span> added by @MichaReiser on 2024-11-23 08:50</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">rule</span> removed by @MichaReiser on 2024-11-23 08:50</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">fixes</span> added by @MichaReiser on 2024-11-23 08:50</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-11-23 09:25</div>
            <div class="timeline-body"><p>Thanks for opening the issue @phil65!</p>
<p>There's already some extensive documentation on the fix safety of this rule at https://docs.astral.sh/ruff/rules/unsorted-dunder-all/#fix-safety, and we note this problem there. However, I'm open to making this fix unsafe if there are any own-line comments. I think that's in the spirit of the policy on fix safety we recently adopted when it comes to comments. We should make the same change to <code>sort-dunder-slots</code> as well.</p>
<blockquote>
<p>2. Improve the heuristic. For example, the rule could implement sort-by-group similar to isort if some items are separated by blank lines</p>
</blockquote>
<p>Unfortunately doing this would make the rule incompatible with the formatter, because the formatter will remove blank lines in between the items, which would then lead to the rule applying a different sort to the items than if the blank lines were present.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-11-23 09:40</div>
            <div class="timeline-body"><blockquote>
<p>Unfortunately doing this would make the rule incompatible with the formatter, because the formatter will remove blank lines in between the items, which would then lead to the rule applying a different sort to the items than if the blank lines were present.</p>
</blockquote>
<p>Right, I think we even discussed this back then. Thanks for reminding me.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "Over-eager __all__ sorting" to "RUF022 autoroute shouldOver-eager __all__ sorting" by @AlexWaygood on 2024-11-23 16:11</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "RUF022 autoroute shouldOver-eager __all__ sorting" to "RUF022 autofix should be marked unsafe if there are own-line comments" by @AlexWaygood on 2024-11-23 16:12</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "RUF022 autofix should be marked unsafe if there are own-line comments" to "RUF022 autofix should be marked unsafe if there are own-line comments between `__all__` items" by @AlexWaygood on 2024-11-23 16:12</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @AlexWaygood by @AlexWaygood on 2024-11-23 22:49</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/14560.html">astral-sh/ruff#14560</a> on 2024-11-23 23:18</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/phil65">@phil65</a> on 2024-11-23 23:20</div>
            <div class="timeline-body"><p>Thank you for quick handling and a great piece of software. :)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @AlexWaygood on 2024-11-24 12:49</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:28:14 UTC
    </footer>
</body>
</html>
