<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PT017 triggers on non-test code - astral-sh/ruff #14205</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>PT017 triggers on non-test code</h1>

    <div class="meta">
        <span class="state state-closed">Closed</span>
        <a href="https://github.com/astral-sh/ruff/issues/14205">#14205</a>
        opened by <a href="https://github.com/ashb">@ashb</a>
        on 2024-11-08 14:54
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/ashb">@ashb</a> on 2024-11-08 14:54</div>
            <div class="timeline-body"><p>I've ran into a case where the &quot;pytest&quot; rules are triggering on my non-tests code. This snippet triggers it (the <code>noqa</code> line shows where)</p>
<pre><code class="language-python">def raise_on_4xx_5xx(response: httpx.Response):
    return response.raise_for_status()


# Py 3.11+ version
def raise_on_4xx_5xx_with_note(response: httpx.Response):
    try:
        return response.raise_for_status()
    except httpx.HTTPStatusError as e:
        if TYPE_CHECKING:
            assert hasattr(e, &quot;add_note&quot;)  # noqa: PT017
        e.add_note(
            f&quot;Correlation-id={response.headers.get('correlation-id', None) or response.request.headers.get('correlation-id', 'no-correlction-id')}&quot;
        )
        raise


if hasattr(BaseException, &quot;add_note&quot;):
    # Py 3.11+
    raise_on_4xx_5xx = raise_on_4xx_5xx_with_note
</code></pre>
<p>(I know I can disable <code>PT</code> for non-test files as a work around. )</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dylwil3">@dylwil3</a> on 2024-11-08 21:53</div>
            <div class="timeline-body"><p>Thanks for bringing this up! I think this is a place where more documentation might be helpful.</p>
<p>To the best of my understanding, there is currently no way for Ruff to know which functions are tests and which are not. This is mainly because users can <a href="https://docs.pytest.org/en/stable/example/pythoncollection.html#changing-naming-conventions">customize the naming convention for tests</a> and Ruff wouldn't know.</p>
<p>As you point out, you can get around this limitation by putting a <code>ruff.toml</code> file in your <code>tests</code> directory (assuming that is your layout) that has:</p>
<pre><code class="language-toml">[lint]
extend-select = [&quot;PT&quot;]
</code></pre>
<p>Added: You can verify that the same behavior happens with <code>flake8</code> itself</p>
<pre><code class="language-python"># tmp.py
def foo():
    try:
        ...
    except Exception as e:
        assert e
</code></pre>
<pre><code class="language-console">$ uv tool run --with flake8-pytest-style flake8 --select PT tmp.py
tmp.py:5:9: PT017 found assertion on exception e in except block, use pytest.raises() instead
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @dylwil3 on 2024-11-11 04:48</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/LordAro">@LordAro</a> on 2024-11-29 13:11</div>
            <div class="timeline-body"><p>This affects PT018 as well, for reference.</p>
<p>Is there any particular reason why ruff couldn't also provide a similar configuration option? It could even look for pytest options in pyproject.toml...</p>
<p>We have a large monorepo with lots of individual test directories in it but a single pyproject.toml controlling everything, so adding a ruff.toml file per test directory would get infeasible quickly</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:34:54 UTC
    </footer>
</body>
</html>
