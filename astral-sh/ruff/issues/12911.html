<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>F601 `multi-value-repeated-key-literal` various issues - astral-sh/ruff #12911</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>F601 `multi-value-repeated-key-literal` various issues</h1>

    <div class="meta">
        <span class="state state-closed">Closed</span>
        <a href="https://github.com/astral-sh/ruff/issues/12911">#12911</a>
        opened by <a href="https://github.com/dylwil3">@dylwil3</a>
        on 2024-08-15 21:39
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/dylwil3">@dylwil3</a> on 2024-08-15 21:39</div>
            <div class="timeline-body"><p>This is an extension of #12772.</p>
<h1>Observed issues</h1>
<p><a href="https://play.ruff.rs/e6b35fd7-dca9-421a-915a-fa3d34f04dd9">Playground Link</a></p>
<ul>
<li>F601 should only be triggered for Expr's whose leaves are literals of some kind - the following two examples ought to fall under F602 instead.</li>
</ul>
<pre><code class="language-python">{(foo, bar): &quot;a&quot;, (foo, bar): &quot;b&quot;}

{
    f&quot;{foo}&quot;: &quot;a&quot;,
    f&quot;{foo}&quot;: &quot;b&quot;,
}
</code></pre>
<ul>
<li>As in https://github.com/astral-sh/ruff/issues/12772 booleans and numbers that are equal should trigger this rule.</li>
</ul>
<pre><code class="language-python">{
    True: &quot;a&quot;,
    1: &quot;b&quot;,
    1.0: &quot;c&quot;,
    1.0
    + 0.0j: &quot;d&quot;,  # &lt;-- this may be out of scope depending on the implementation of the fix
    2: &quot;e&quot;,
    2.0: &quot;f&quot;,
}
</code></pre>
<ul>
<li>(Maybe a feature request rather than a bug) It would be nice to extend F601 to situations like this, where expression ASTs have <em>literal</em> leaves and internal nodes do not involve a function call</li>
</ul>
<pre><code class="language-python">{
    -1: &quot;a&quot;,
    -1: &quot;b&quot;,
}

{
    1 + 1: &quot;a&quot;,
    1 + 1: &quot;b&quot;,
}

# but _not_ to situations which require any kind of actual evaluation
{
    1 + 1: &quot;a&quot;,
    2: &quot;b&quot;,
}

# except maybe this, which appears above as well
# and which is arguably a casting/type promotion
{
    1: &quot;a&quot;,
    1.0 + 0.0j: &quot;b&quot;,
}
</code></pre>
<ul>
<li>There is also an issue with the suggested fix for values which are the &quot;same&quot;, as there could be side effects, eg</li>
</ul>
<pre><code class="language-python"># Suggested fix is unsafe, since we can't know
# which value of iterator was desired
{
    1: next(it),
    1: next(it),
}
</code></pre>
<ul>
<li>Finally, a minor issue: the name of the rule does not seem quite right, since the linter complains if a key is repeated even if the same value appears.</li>
</ul>
<h1>Potential Solution</h1>
<p>I propose that the <em>logic</em> of this check (independently of the implementation) should be as follows:</p>
<ol>
<li>F601 should ignore keys which do not satisfy all of the following:<ul>
<li>They are expressions that have only literals as leaves</li>
<li>They are expressions where no node is a <code>Name</code> (that may be redundant since Name's are terminal?)</li>
</ul>
</li>
<li>F601 should consider keys duplicated if the corresponding <code>ComparableExpr</code>'s are equal after further replacing all boolean and numeric literals with their complex-valued equivalent (for these purposes, I think &quot;large&quot; integers should be left as is).</li>
<li>F601 should not propose a fix if the &quot;unique&quot; value found has possible side effects - for example, we could just never propose a fix if the value found involves a function call.</li>
<li>Change the name of the rule to <code>repeated-key-literal</code> (and similarly for F602).</li>
</ol>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dylwil3">@dylwil3</a> on 2024-08-15 21:47</div>
            <div class="timeline-body"><p>By the way, I'm happy to work on this I just wanna pin down the &quot;assignment&quot; first.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">needs-design</span> added by @MichaReiser on 2024-08-16 06:47</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-08-16 06:49</div>
            <div class="timeline-body"><p>I hope you don't mind if I convert this to a discussion.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Locked by @MichaReiser on 2024-08-16 06:49</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:34:53 UTC
    </footer>
</body>
</html>
