<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FURB157 fix panics on `Decimal(float(&quot;\x2dnan&quot;))` - astral-sh/ruff #16771</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>FURB157 fix panics on <code>Decimal(float(&quot;\x2dnan&quot;))</code></h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/issues/16771">#16771</a>
        opened by <a href="https://github.com/dscorbett">@dscorbett</a>
        on 2025-03-15 21:08
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dscorbett">@dscorbett</a></div>
            <div class="timeline-body"><h3>Summary</h3>
<p>The fix for <a href="https://docs.astral.sh/ruff/rules/verbose-decimal-constructor/"><code>verbose-decimal-constructor</code> (FURB157)</a> panics when the minus sign in <code>float(&quot;-nan&quot;)</code> is represented by an escape sequence.</p>
<pre><code class="language-console">$ cat &gt;furb157.py &lt;&lt;'# EOF'
from decimal import Decimal
Decimal(float(&quot;\x2dnan&quot;))
# EOF

$ ruff --isolated check --preview --select FURB157 furb157.py --diff
error: Panicked while linting furb157.py: This indicates a bug in Ruff. If you could open an issue at:

    https://github.com/astral-sh/ruff/issues/new?title=%5BLinter%20panic%5D

...with the relevant file contents, the `pyproject.toml` settings, and the following stack trace, we'd be very appreciative!

panicked at
 crates/ruff_linter/src/rules/refurb/rules/verbose_decimal_constructor.rs:181:58:
called `Option::unwrap()` on a `None` value
Backtrace:    0: __mh_execute_header
   1: __mh_execute_header
   2: __mh_execute_header
   3: __mh_execute_header
   4: __mh_execute_header
   5: __mh_execute_header
   6: __mh_execute_header
   7: __mh_execute_header
   8: __mh_execute_header
   9: __mh_execute_header
  10: __mh_execute_header
  11: __mh_execute_header
  12: __mh_execute_header
  13: __mh_execute_header
  14: __mh_execute_header
  15: __mh_execute_header
  16: __mh_execute_header
  17: __mh_execute_header
  18: __mh_execute_header
  19: __mh_execute_header
  20: __mh_execute_header
  21: __mh_execute_header
  22: __mh_execute_header
  23: __mh_execute_header
  24: __mh_execute_header
  25: __mh_execute_header
  26: __mh_execute_header
  27: __mh_execute_header



</code></pre>
<h3>Version</h3>
<p>ruff 0.11.0 (2cd25ef64 2025-03-14)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @ntBre on 2025-03-15 22:30</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">help wanted</span> added by @ntBre on 2025-03-15 22:30</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dylwil3">@dylwil3</a> on 2025-03-16 00:14</div>
            <div class="timeline-body"><p>I think this one may have been my fault- can't get to it until tomorrow but I'll do it first thing!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @dylwil3 by @dylwil3 on 2025-03-16 00:14</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dylwil3">@dylwil3</a> on 2025-03-16 15:07</div>
            <div class="timeline-body"><p>Relatedly, and sort of frustratingly:</p>
<pre><code class="language-console">‚ùØ cat tmp.py
from decimal import Decimal

Decimal(float(&quot;\N{HYPHEN-MINUS}nan&quot;))

‚ùØ ruff check --no-cache --select FURB157 --preview --fix tmp.py

error: Fix introduced a syntax error. Reverting all changes.

This indicates a bug in Ruff. If you could open an issue at:

    https://github.com/astral-sh/ruff/issues/new?title=%5BFix%20error%5D

...quoting the contents of `tmp.py`, the rule codes FURB157, along with the `pyproject.toml` settings and executed command, we'd be very appreciative!

tmp.py:3:9: FURB157 Verbose expression in `Decimal` constructor
  |
1 | from decimal import Decimal
2 |
3 | Decimal(float(&quot;\N{HYPHEN-MINUS}nan&quot;))
  |         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^ FURB157
  |
  = help: Replace with `&quot;\N{HYPHENMINUS}nan&quot;`

Found 1 error.
[*] 1 fixable with the `--fix` option.
</code></pre>
<p>This means even if we wanted to just omit the fix for weird unicode situations, we now have to check for this exceedingly rare case in order to offer the fix for the much more common case üòû</p>
<p>I guess the alternative is not to offer a fix in the presence of any escaped characters...</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dylwil3">@dylwil3</a> on 2025-03-16 15:11</div>
            <div class="timeline-body"><p>Actually, as a compromise, I think I'll just do this: In the case where we are replacing something equivalent to <code>&quot;-nan&quot;</code> with <code>&quot;nan&quot;</code>, I'm just going to replace it with <code>&quot;nan&quot;</code> and ignore whatever special formatting/unicode escaped whitespace/strangeness the original string had in it. That's still a valid fix, it's a pretty rare case, and while it's <em>nice</em> to retain the original choices and formatting, it is not a guarantee in fixes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @dylwil3 on 2025-03-17 10:09</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 16:52:23 UTC
    </footer>
</body>
</html>
