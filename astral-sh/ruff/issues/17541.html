<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[red-knot] Detect overloads decorated with `@dataclass_transform` - astral-sh/ruff #17541</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[red-knot] Detect overloads decorated with <code>@dataclass_transform</code></h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/issues/17541">#17541</a>
        opened by <a href="https://github.com/sharkdp">@sharkdp</a>
        on 2025-04-22 08:51
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a></div>
            <div class="timeline-body"><p>We currently do not properly detect when an overload of a function is decorated with <code>@dataclass_transform</code>. See the <a href="https://github.com/astral-sh/ruff/blob/main/crates/red_knot_python_semantic/resources/mdtest/dataclass_transform.md#applying-dataclass_transform-to-an-overload">existing test here</a>. The goal of this ticket is to resolve the TODOs in this test.</p>
<p>See <a href="https://github.com/astral-sh/ruff/pull/17445#discussion_r2051100043">this discussion</a> for a concrete plan on how to implement this.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by @sharkdp on 2025-04-22 08:51</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone "Red Knot Beta" by @sharkdp on 2025-04-22 08:51</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2025-04-25 17:06</div>
            <div class="timeline-body"><p>I think this can be a &quot;help wanted&quot; issue now that we have <code>FunctionType::to_overloaded</code> in place.</p>
<p>From what I understand, this would mainly require updating the following site to first call <code>to_overloaded</code> and check whether there are any <code>dataclass_transformer_params</code> on any of the overloads, then check whether it is on the overload implementation.</p>
<p>https://github.com/astral-sh/ruff/blob/afc18ff1a12b38cf4b8430059732499a2f2d907a/crates/red_knot_python_semantic/src/types/call/bind.rs#L718-L739</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">help wanted</span> added by @dhruvmanila on 2025-04-25 17:06</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/abhijeetbodas2001">@abhijeetbodas2001</a> on 2025-04-26 04:57</div>
            <div class="timeline-body"><p>Hi @dhruvmanila, can I work on this?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2025-04-26 14:15</div>
            <div class="timeline-body"><p>@abhijeetbodas2001 Go for it, thanks.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/abhijeetbodas2001">@abhijeetbodas2001</a> on 2025-04-28 07:35</div>
            <div class="timeline-body"><p>The <a href="https://typing.python.org/en/latest/spec/dataclasses.html">spec</a> also mentions this constraint:</p>
<pre><code class="language-quote">If the function has overloads, the `dataclass_transform` decorator can be applied to the implementation
of the function or any one, but not more than one, of the overloads.
</code></pre>
<p>Is imposing this also part of this issue? I tested out <code>mypy</code> and <code>pyright</code>, but neither raised any errors for the below:</p>
<pre><code class="language-py">from typing_extensions import dataclass_transform, TypeVar, Callable, overload

T = TypeVar(&quot;T&quot;, bound=type)

@overload
@dataclass_transform()  # overload has it
def versioned_class(
    cls: T,
    *,
    version: int = 1,
) -&gt; T: ...

@overload
def versioned_class(
    *,
    version: int = 1,
) -&gt; Callable[[T], T]: ...

@dataclass_transform()  # implementation also has it
def versioned_class(
    cls: T | None = None,
    *,
    version: int = 1,
) -&gt; T | Callable[[T], T]:
    raise NotImplementedError

</code></pre>
<p>For the case of <code>dataclass_transform</code> applied to more than one decorator also, neither of <code>mypy</code> or <code>pyright</code> raised any errors.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-04-28 07:38</div>
            <div class="timeline-body"><blockquote>
<p><code>If the function has overloads, the `dataclass_transform` decorator can be applied to the implementation of the function or any one, but not more than one, of the overloads.</code></p>
</blockquote>
<p>I also mentioned this in the <a href="https://github.com/astral-sh/ruff/blob/main/crates/red_knot_python_semantic/resources/mdtest/dataclass_transform.md#overloaded-dataclass-like-decorators">test suite</a>, but haven't written an explicit test, since I also noticed that other type checkers don't catch this. I think it's perfectly fine to postpone this for now.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2025-04-28 12:56</div>
            <div class="timeline-body"><blockquote>
<p>I think it's perfectly fine to postpone this for now.</p>
</blockquote>
<p>I agree with David here. Regardless, this check would be done elsewhere, in <code>check_overload_functions</code> that's being added in #17609.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @sharkdp on 2025-05-07 13:51</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 16:52:37 UTC
    </footer>
</body>
</html>
