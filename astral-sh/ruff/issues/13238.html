<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Error on Neovim after upgrading to 0.6.3 - astral-sh/ruff #13238</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Error on Neovim after upgrading to 0.6.3</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/issues/13238">#13238</a>
        opened by <a href="https://github.com/Zeioth">@Zeioth</a>
        on 2024-09-04 07:19
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Zeioth">@Zeioth</a></div>
            <div class="timeline-body">Description
<p>Ruff displays errors on neovim (installed using)</p>
Screenshot
<p><img src="https://github.com/user-attachments/assets/472f8496-d270-4eb8-9dc0-51a46aaab36d" alt="screenshot_2024-09-04_09-17-36_480641034"></p>
<p><img src="https://github.com/user-attachments/assets/71df3752-4241-4d3d-b6a6-da08f184c53f" alt="screenshot_2024-09-04_09-18-48_932678326"></p>
LSP Log
<pre><code>[START][2024-09-04 09:14:29] LSP logging initiated
[ERROR][2024-09-04 09:14:29] .../vim/lsp/rpc.lua:770	&quot;rpc&quot;	&quot;/home/zeioth/.local/share/nvim/mason/bin/ruff-lsp&quot;	&quot;stderr&quot;	&#x27;Cancel notification for unknown message id &quot;2&quot;\n&#x27;
[START][2024-09-04 09:14:36] LSP logging initiated
[ERROR][2024-09-04 09:14:36] .../vim/lsp/rpc.lua:770	&quot;rpc&quot;	&quot;/home/zeioth/.local/share/nvim/mason/bin/ruff-lsp&quot;	&quot;stderr&quot;	&#x27;Cancel notification for unknown message id &quot;2&quot;\n&#x27;
[ERROR][2024-09-04 09:15:27] .../vim/lsp/rpc.lua:770	&quot;rpc&quot;	&quot;/home/zeioth/.local/share/nvim/mason/bin/ruff-lsp&quot;	&quot;stderr&quot;	&#x27;Cancel notification for unknown message id &quot;3&quot;\n&#x27;
[ERROR][2024-09-04 09:15:28] .../vim/lsp/rpc.lua:770	&quot;rpc&quot;	&quot;/home/zeioth/.local/share/nvim/mason/bin/ruff-lsp&quot;	&quot;stderr&quot;	&#x27;Cancel notification for unknown message id &quot;4&quot;\n&#x27;
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Zeioth">@Zeioth</a> on 2024-09-04 07:21</div>
            <div class="timeline-body"><p>also, my ruff-lsp version</p>
<p><img src="https://github.com/user-attachments/assets/3181d9b1-6e19-42e2-a77b-82d9a7964520" alt="screenshot_2024-09-04_09-21-14_744180110"></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-09-04 07:40</div>
            <div class="timeline-body"><p>Closing as duplicate of <a href="https://github.com/astral-sh/ruff-lsp/issues/486">astral-sh/ruff-lsp#486</a></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-09-04 07:40</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-09-04 07:43</div>
            <div class="timeline-body"><p>Let&#x27;s keep this open as the notification is coming from the native server.</p>
<p>Can you try removing <code>ruff_lsp</code> and only running the native server? It&#x27;s not recommended to use both at the same time.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Reopened by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-09-04 07:43</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-09-04 07:46</div>
            <div class="timeline-body"><p>Can you also check the logs via <code>:LspLog</code> and check if there&#x27;s any error message present there? I think you&#x27;ll need to turn on the server tracing like so:</p>
<pre><code>require(&#x27;lspconfig&#x27;).ruff.setup({
  trace = &#x27;messages&#x27;,
  init_options = {
    settings = {
      logLevel = &#x27;debug&#x27;,
    },
  },
})
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-09-04 07:48</div>
            <div class="timeline-body"><p>Sorry, I didn&#x27;t notice the logs that you&#x27;ve provided. That doesn&#x27;t contain anything relevant, you&#x27;ll need to turn on server tracing via the config that I&#x27;ve provided in my previous comment.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">server</span> added by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-09-04 07:49</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/Zeioth">@Zeioth</a> on 2024-09-15 19:12</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Reopened by <a href="https://github.com/Zeioth">@Zeioth</a> on 2024-09-15 19:14</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/Zeioth">@Zeioth</a> on 2024-09-20 20:16</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Reopened by <a href="https://github.com/Zeioth">@Zeioth</a> on 2024-09-20 20:47</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Zeioth">@Zeioth</a> on 2024-09-21 09:28</div>
            <div class="timeline-body"><p>The issue is on ruff itself, so the workaround on my end has been using <code>ruff-lsp</code> + <code>pywright</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-09-21 09:43</div>
            <div class="timeline-body"><p>@Zeioth please stop opening and closing this issue unnecessarily because it triggers a notification for everyone observing the repository.</p>
<p>To get this resolved, please provide us with the log that @dhruvmanila asked you for. It&#x27;s very difficult to help you without it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">needs-mre</span> added by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-09-21 09:43</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Zeioth">@Zeioth</a> on 2024-09-21 10:58</div>
            <div class="timeline-body"><p>@MichaReiser @dhruvmanila Here is the log generated by</p>
Process followed to generate the log file
<ul>
<li>opening nvim</li>
<li>Opening a python file</li>
<li>Exucuting <code>:lua require(&#x27;lspconfig&#x27;).ruff.setup({ trace = &#x27;messages&#x27;, init_options = { settings = { logLevel = &#x27;debug&#x27; } } }) </code></li>
</ul>
log file (when opening a python file and pass the cursor over lines)
<pre><code>[START][2024-09-21 12:42:58] LSP logging initiated
[ERROR][2024-09-21 12:42:58] .../vim/lsp/rpc.lua:770	&quot;rpc&quot;	&quot;/home/zeioth/.local/share/nvim/mason/bin/ruff&quot;	&quot;stderr&quot;	&quot;   0.000011050s  WARN main ruff_server::server: No workspace(s) were provided during initialization. Using the current working directory as a default workspace...\n&quot;
[ERROR][2024-09-21 12:42:59] .../vim/lsp/rpc.lua:770	&quot;rpc&quot;	&quot;/home/zeioth/.local/share/nvim/mason/bin/ruff&quot;	&quot;stderr&quot;	&quot;   0.012430178s  WARN ruff:main ruff_server::server: LSP client does not support dynamic capability registration - automatic configuration reloading will not be available.\n&quot;
[ERROR][2024-09-21 12:43:01] .../vim/lsp/rpc.lua:770	&quot;rpc&quot;	&quot;/home/zeioth/.local/share/nvim/mason/bin/ruff-lsp&quot;	&quot;stderr&quot;	&#x27;Cancel notification for unknown message id &quot;2&quot;\n&#x27;
[ERROR][2024-09-21 12:43:01] .../vim/lsp/rpc.lua:770	&quot;rpc&quot;	&quot;/home/zeioth/.local/share/nvim/mason/bin/ruff-lsp&quot;	&quot;stderr&quot;	&#x27;Cancel notification for unknown message id &quot;3&quot;\n&#x27;
[ERROR][2024-09-21 12:43:57] .../vim/lsp/rpc.lua:770	&quot;rpc&quot;	&quot;/home/zeioth/.local/share/nvim/mason/bin/ruff-lsp&quot;	&quot;stderr&quot;	&#x27;Cancel notification for unknown message id &quot;27&quot;\n&#x27;
</code></pre>
log file (when lsp autocomplete is triggered)
<pre><code>[ERROR][2024-09-21 12:53:47] .../vim/lsp/rpc.lua:770	&quot;rpc&quot;	&quot;/home/zeioth/.local/share/nvim/mason/bin/ruff&quot;	&quot;stderr&quot;	&quot; 424.907668433s DEBUG  ruff:worker:5 ruff_server::resolve: Included path via `include`: /home/zeioth/raven-app/src/utils/controller.py\n&quot;
[ERROR][2024-09-21 12:53:47] .../vim/lsp/rpc.lua:770	&quot;rpc&quot;	&quot;/home/zeioth/.local/share/nvim/mason/bin/ruff-lsp&quot;	&quot;stderr&quot;	&#x27;Cancel notification for unknown message id &quot;103&quot;\n&#x27;
[ERROR][2024-09-21 12:53:47] .../vim/lsp/rpc.lua:770	&quot;rpc&quot;	&quot;/home/zeioth/.local/share/nvim/mason/bin/ruff&quot;	&quot;stderr&quot;	&quot; 425.022634237s ERROR  ruff:worker:8 ruff_server::server::api: An error occurred with result ID 73: failed to deserialize diagnostic data: invalid length 0, expected struct AssociatedDiagnosticData with 4 elements\n&quot;
[ERROR][2024-09-21 12:53:47] .../vim/lsp/rpc.lua:770	&quot;rpc&quot;	&quot;/home/zeioth/.local/share/nvim/mason/bin/ruff-lsp&quot;	&quot;stderr&quot;	&quot;Exception occurred for message \&quot;104\&quot;: AttributeError: &#x27;NoneType&#x27; object has no attribute &#x27;get&#x27;\nTraceback (most recent call last):\n  File \&quot;/home/zeioth/.local/share/nvim/mason/packages/ruff-lsp/venv/lib/python3.12/site-packages/pygls/protocol/json_rpc.py\&quot;, line 194, in _execute_request_callback\n    self._send_response(msg_id, result=future.result())\n                                       ^^^^^^^^^^^^^^^\n  File \&quot;/home/zeioth/.local/share/nvim/mason/packages/ruff-lsp/venv/lib/python3.12/site-packages/ruff_lsp/server.py\&quot;, line 992, in code_action\n    fix = cast(DiagnosticData, diagnostic.data).get(\&quot;fix\&quot;)\n          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\nAttributeError: &#x27;NoneType&#x27; object has no attribute &#x27;get&#x27;\n&quot;
[ERROR][2024-09-21 12:53:47] .../vim/lsp/rpc.lua:770	&quot;rpc&quot;	&quot;/home/zeioth/.local/share/nvim/mason/bin/ruff&quot;	&quot;stderr&quot;	&quot; 425.084355442s DEBUG  ruff:worker:4 ruff_server::resolve: Included path via `include`: /home/zeioth/raven-app/src/utils/controller.py\n&quot;
[ERROR][2024-09-21 12:53:47] .../vim/lsp/rpc.lua:770	&quot;rpc&quot;	&quot;/home/zeioth/.local/share/nvim/mason/bin/ruff&quot;	&quot;stderr&quot;	&quot; 425.092566072s DEBUG  ruff:worker:9 ruff_server::resolve: Included path via `include`: /home/zeioth/raven-app/src/utils/controller.py\n&quot;
[ERROR][2024-09-21 12:53:47] .../vim/lsp/rpc.lua:770	&quot;rpc&quot;	&quot;/home/zeioth/.local/share/nvim/mason/bin/ruff&quot;	&quot;stderr&quot;	&quot; 425.277145226s DEBUG ruff:worker:10 ruff_server::resolve: Included path via `include`: /home/zeioth/raven-app/src/utils/controller.py\n&quot;
[ERROR][2024-09-21 12:53:47] .../vim/lsp/rpc.lua:770	&quot;rpc&quot;	&quot;/home/zeioth/.local/share/nvim/mason/bin/ruff&quot;	&quot;stderr&quot;	&quot; 425.707603056s DEBUG ruff:worker:11 ruff_server::resolve: Included path via `include`: /home/zeioth/raven-app/src/utils/controller.py\n&quot;
[ERROR][2024-09-21 12:53:50] .../vim/lsp/rpc.lua:770	&quot;rpc&quot;	&quot;/home/zeioth/.local/share/nvim/mason/bin/ruff-lsp&quot;	&quot;stderr&quot;	&#x27;Cancel notification for unknown message id &quot;105&quot;\n&#x27;
[ERROR][2024-09-21 12:53:52] .../vim/lsp/rpc.lua:770	&quot;rpc&quot;	&quot;/home/zeioth/.local/share/nvim/mason/bin/ruff-lsp&quot;	&quot;stderr&quot;	&#x27;Cancel notification for unknown message id &quot;106&quot;\n&#x27;
</code></pre>
More info
<p>Might be a problem in the package itself?</p>
<ul>
<li>by installing ruff-lsp on mason, I get linting and formatting.</li>
<li>by installing ruff on mason, I get linting and formatting.</li>
<li>none of them provide lsp autocompletion / go to definition.</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-09-22 08:01</div>
            <div class="timeline-body"><p>Thanks for sharing the logs. From the logs, it seems you&#x27;re running both <code>ruff-lsp</code> and <code>ruff</code> (server) at the same time. This is not a supported setup and shouldn&#x27;t be needed. Can you try to remove <code>ruff-lsp</code> and only use <code>ruff</code> server?</p>
<pre><code>[ERROR][2024-09-21 12:53:47] .../vim/lsp/rpc.lua:770	&quot;rpc&quot;	&quot;/home/zeioth/.local/share/nvim/mason/bin/ruff&quot;	&quot;stderr&quot;	&quot; 425.022634237s ERROR  ruff:worker:8 ruff_server::server::api: An error occurred with result ID 73: failed to deserialize diagnostic data: invalid length 0, expected struct AssociatedDiagnosticData with 4 elements\n&quot;
[ERROR][2024-09-21 12:53:47] .../vim/lsp/rpc.lua:770	&quot;rpc&quot;	&quot;/home/zeioth/.local/share/nvim/mason/bin/ruff-lsp&quot;	&quot;stderr&quot;
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Zeioth">@Zeioth</a> on 2024-09-22 13:24</div>
            <div class="timeline-body"><p>@MichaReiser I&#x27;ve tried with <code>ruff</code> alone. Now I only get this error when I trigger lsp autocomplete (which doesn&#x27;t work). Linting work as expected.</p>
<pre><code>[ERROR][2024-09-22 15:19:50] .../vim/lsp/rpc.lua:770	&quot;rpc&quot;	&quot;/home/zeioth/.local/share/nvim/mason/bin/ruff&quot;	&quot;stderr&quot;	&quot;  59.355577387s DEBUG ruff:worker:16 ruff_server::resolve: Included path via `include`: /home/zeioth/raven-app/src/main.py\n&quot;
</code></pre>
<p>Because you say using both ruffs at the same time is not supported, I understand <code>ruff-lsp</code> is already included inside <code>ruff</code>, and lsp autocompletion should be working fine?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-09-22 14:11</div>
            <div class="timeline-body"><p>What you&#x27;re seeing there isn&#x27;t an error. It&#x27;s only a debug message. I think you can turn it of again by removing the <code>logInfo</code> setting</p>
<blockquote>
<p>ruff, and lsp autocompletion should be working fine</p>
</blockquote>
<p>Ruff&#x27;s LSP doesn&#x27;t provide any auto completion. It only provides formatting and linting capabilities.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Zeioth">@Zeioth</a> on 2024-09-22 14:24</div>
            <div class="timeline-body"><p>Got it. Thank you. I think we can close this for now then.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/Zeioth">@Zeioth</a> on 2024-09-22 14:24</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">server</span> removed by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-09-30 11:02</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">needs-mre</span> removed by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-09-30 11:02</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">question</span> added by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-09-30 11:02</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">server</span> added by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2025-01-07 05:16</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 18:48:57 UTC
    </footer>
</body>
</html>
