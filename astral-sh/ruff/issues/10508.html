<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Strange autofix for PYI025 if `&quot;Set&quot;` is included in `__all__` - astral-sh/ruff #10508</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Strange autofix for PYI025 if <code>&quot;Set&quot;</code> is included in <code>__all__</code></h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/issues/10508">#10508</a>
        opened by <a href="https://github.com/AlexWaygood">@AlexWaygood</a>
        on 2024-03-21 11:23
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-03-21 11:23</div>
            <div class="timeline-body"><p>The following snippet correctly causes Ruff to emit PYI025:</p>
<pre><code class="language-py">from collections.abc import Set as Set

__all__ = [&quot;Set&quot;]
</code></pre>
<p>But if you apply the autofix, it &quot;fixes&quot; it to this, which is... not correct:</p>
<pre><code class="language-py">from collections.abc import Set as AbstractSet

AbstractSet = [&quot;Set&quot;]
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @AlexWaygood on 2024-03-21 11:23</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">fixes</span> added by @AlexWaygood on 2024-03-21 11:23</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">linter</span> added by @AlexWaygood on 2024-03-21 11:23</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-03-21 11:28</div>
            <div class="timeline-body"><p>What's the correct fix in your view or should the rule not emit a fix if it's a module scoped variable named <code>__all__</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-03-21 11:37</div>
            <div class="timeline-body"><p>Including the name <code>&quot;Set&quot;</code> in <code>__all__</code> marks the symbol as being publicly exported from the module, but it doesn't create a binding in and of itself -- the <code>Set</code> binding is created via the import. So we definitely shouldn't be removing the <code>__all__</code> variable from the module here.</p>
<p>If we stipulate that it's correct for us to emit the violation here at all, the correct fix would be to modify the original snippet to</p>
<pre><code class="language-py">from collections.abc import Set as AbstractSet

__all__ = [&quot;AbstractSet&quot;]
</code></pre>
<p>rather than what we currently do, which is to modify the snippet to this:</p>
<pre><code class="language-py">from collections.abc import Set as AbstractSet

AbstractSet = [&quot;Set&quot;]
</code></pre>
<p>This is an edge case that's unlikely to come up. However, I'm somewhat concerned that it points to a broader issue with the autofix machinery that could also impact other rules.</p>
<h2>Should we be emitting PYI025 on this snippet at all?</h2>
<p>This is debatable. However, I think it's fine to emit PYI025 even if the <code>&quot;Set&quot;</code> symbol appears in <code>__all__</code>, since that's very much an edge case that's extremely unlikely to actually come up. I'm not really concerned about this.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-03-21 11:40</div>
            <div class="timeline-body"><p>Note that the code will actually trigger F811 after being &quot;autofixed&quot; for PYI025:</p>
<pre><code class="language-py">from collections.abc import Set as AbstractSet

AbstractSet = [&quot;Set&quot;]  # F811: Redefinition of unused `AbstractSet` from line 1
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @charliermarsh by @AlexWaygood on 2024-03-21 15:02</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Unassigned @charliermarsh by @AlexWaygood on 2024-03-21 15:18</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-03-22 11:58</div>
            <div class="timeline-body"><p>The autofix is done using the renamer here:</p>
<p>https://github.com/astral-sh/ruff/blob/4f06d59ff6f58f2d13c2f8fcfe375b81058f87c3/crates/ruff_linter/src/rules/flake8_pyi/rules/unaliased_collections_abc_set_import.rs#L80</p>
<p>The issue in the renamer is here where, after renaming the binding itself (<code>from collections.abc import Set</code>), we then proceed to try to rename all <em>references</em> to the binding that we've just renamed:</p>
<p>https://github.com/astral-sh/ruff/blob/4f06d59ff6f58f2d13c2f8fcfe375b81058f87c3/crates/ruff_linter/src/renamer.rs#L202-L206</p>
<p>The renamer correctly recognises that <code>__all__ = [&quot;Set&quot;]</code> counts as a resolved reference to the <code>Set</code> symbol that we've just renamed. But it then incorrectly renames the target of the assignment rather than the string in the assignment's value.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-03-22 12:20</div>
            <div class="timeline-body"><p>Adding this debug print:</p>
<pre><code class="language-diff">diff --git a/crates/ruff_linter/src/renamer.rs b/crates/ruff_linter/src/renamer.rs
index 8571d7f53..e8f4d1295 100644
--- a/crates/ruff_linter/src/renamer.rs
+++ b/crates/ruff_linter/src/renamer.rs
@@ -202,6 +202,7 @@ impl Renamer {
                 // Rename the references to the binding.
                 edits.extend(binding.references().map(|reference_id| {
                     let reference = semantic.reference(reference_id);
+                    dbg!(reference);
                     Edit::range_replacement(target.to_string(), reference.range())
                 }));
</code></pre>
<p>reveals that the range of the <code>ResolvedReference</code> is <code>33..40</code>, which is the range of <code>__all__</code> in the expression <code>__all__ = [&quot;Set&quot;]</code>, rather than the range of <code>&quot;Set&quot;</code>. The incorrect range is then what causes the renamer to change <code>__all__ = [&quot;Set&quot;]</code> to <code>AbstractSet = [&quot;Set&quot;]</code> rather than to <code>__all__ = [&quot;AbstractSet&quot;]</code>.</p>
<p>This TODO comment looks relevant @charliermarsh ;)</p>
<p>https://github.com/astral-sh/ruff/blob/4f06d59ff6f58f2d13c2f8fcfe375b81058f87c3/crates/ruff_linter/src/checkers/ast/mod.rs#L2114-L2120</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @AlexWaygood by @AlexWaygood on 2024-03-22 12:27</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @AlexWaygood on 2024-03-22 20:06</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 11:33:14 UTC
    </footer>
</body>
</html>
