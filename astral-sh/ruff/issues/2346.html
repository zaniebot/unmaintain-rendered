<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>`staticmethod-decorators` configuration option not working. - astral-sh/ruff #2346</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>`staticmethod-decorators` configuration option not working.</h1>

    <div class="meta">
        <span class="state state-closed">Closed</span>
        <a href="https://github.com/astral-sh/ruff/issues/2346">#2346</a>
        opened by <a href="https://github.com/ngnpope">@ngnpope</a>
        on 2023-01-30 10:44
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/ngnpope">@ngnpope</a> on 2023-01-30 10:44</div>
            <div class="timeline-body"><p>This is a bit of an odd one. Let's start with the ~minimal reproducer to refer to:</p>
<pre><code class="language-python">from __future__ import annotations

import enum
import sys
import typing

if sys.version_info &gt;= (3, 11):
    StrEnum = enum.StrEnum
else:
    # Or use backports.strenum.StrEnum
    class StrEnum(str, enum.Enum):
        pass

if typing.TYPE_CHECKING:
    from collections.abc import Callable
    from typing import Any


if typing.TYPE_CHECKING or sys.version_info &gt;= (3, 10):
    staticmethod_hack = staticmethod
else:
    # Python &lt; 3.10 does not support calling static methods direct from the class body.
    # This happens with the weirdness that the enum module uses when generating members.
    # As we only need to add @staticmethod for mypy, just substitute a dummy decorator.
    def staticmethod_hack(f: Callable[..., Any]) -&gt; Callable[..., Any]:
        return f


class Animal(StrEnum):
    # Override the default as enum.StrEnum forces lowercase values.
    @staticmethod
    def _generate_next_value_(
        name: str, start: int, count: int, last_values: list[Any]
    ) -&gt; str:
        return name.upper()

    CAT = enum.auto()
    DOG = enum.auto()
</code></pre>
<p>Python's <code>enum</code> does some weird things. Normally linters complain that <a href="https://docs.python.org/3/library/enum.html#enum.Enum._generate_next_value_"><code>_generate_next_value_</code></a>, as a method, should have the first argument named <code>self</code>. There are also issues with <code>mypy</code> - see <a href="https://github.com/python/mypy/issues/7591">this</a>, and the solution there is to add a <code>@staticmethod</code> decorator.</p>
<p>However, on Python &lt; 3.10 it isn't possible to define <code>_generate_next_value_()</code> inside the same class in which we define members. This is because until Python 3.10, static methods could not be called from within the class body, which is what happens when an enum class is created. <em>(So you can split into a separate <code>AnimalBase</code> and <code>Animal</code> to work around this.)</em></p>
<p>So the idea in the above example is to define a dummy decorator for runtime on Python &lt; 3.10. And this works:</p>
<pre><code class="language-console">‚ùØ mypy --version
mypy 0.991 (compiled: yes)

‚ùØ mypy --strict bug.py 
Success: no issues found in 1 source file
</code></pre>
<p>But <code>N805</code> doesn't understand this. Looking at the configuration options, <code>ruff</code> has <a href="https://github.com/charliermarsh/ruff#staticmethod-decorators"><code>staticmethod-decorators</code></a> for <code>pep8-naming</code>. But this doesn't seem to work...</p>
<pre><code class="language-console">‚ùØ ruff --version
ruff 0.0.237

‚ùØ ruff --select N805 bug.py 
bug.py:33:9: N805 First argument of a method should be named `self`
Found 1 error.

‚ùØ cat &gt; ruff.toml &lt;&lt;EOF
‚àô [pep8-naming]
‚àô staticmethod-decorators = [&quot;staticmethod&quot;, &quot;staticmethod_hack&quot;]
‚àô EOF

‚ùØ ruff --config ruff.toml --select N805 bug.py 
bug.py:33:9: N805 First argument of a method should be named `self`
Found 1 error.

‚ùØ cat &gt; ruff.toml &lt;&lt;EOF
‚àô [pep8-naming]
‚àô staticmethod-decorators = [&quot;staticmethod_hack&quot;]
‚àô EOF

‚ùØ ruff --config ruff.toml --select N805 bug.py 
bug.py:33:9: N805 First argument of a method should be named `self`
Found 1 error.

‚ùØ rm ruff.toml
‚ùØ # Switch back to `@staticmethod` to show the normal decorator works...
‚ùØ sed -i 31s/_hack// bug.py
‚ùØ ruff --select N805 bug.py
‚ùØ # No errors were raised...
</code></pre>
<p>So either <code>staticmethod-decorators</code> doesn't work properly, or the above way of defining the decorator is confusing <code>ruff</code>... ü§î</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-01-30 12:16</div>
            <div class="timeline-body"><p>I'm assuming the decorator here, in the example:</p>
<pre><code class="language-py">class Animal(StrEnum):
    # Override the default as enum.StrEnum forces lowercase values.
    @staticmethod
    def _generate_next_value_(
        name: str, start: int, count: int, last_values: list[Any]
    ) -&gt; str:
        return name.upper()

    CAT = enum.auto()
    DOG = enum.auto()
</code></pre>
<p>Should be <code>@staticmethod_hack</code>?</p>
<p>Right now, Ruff is gonna have trouble tracking that it's <code>@staticmethod_hack</code> is sometimes equal to <code>@staticmethod</code>, unfortunately.</p>
<p>I suppose one workaround would be to move that <code>@staticmethod_hack</code> into a separate file, then import it, and add that path to <code>staticmethod-decorators</code>, like <code>staticmethod-decorators = [&quot;my_file.staticmethod_hack&quot;]</code>. I haven't tried it... but I assume that would work.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">question</span> added by @charliermarsh on 2023-01-30 12:16</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ngnpope">@ngnpope</a> on 2023-01-30 12:30</div>
            <div class="timeline-body"><blockquote>
<p>Should be @staticmethod_hack?</p>
</blockquote>
<p>Yes ü§¶üèª Copy-pasted the wrong version.</p>
<blockquote>
<p>Ruff is gonna have trouble tracking that it's <code>@staticmethod_hack</code> is sometimes equal to <code>@staticmethod</code>, unfortunately.</p>
</blockquote>
<p>Ok, I guess this is one of those too-dynamic things... It's easy enough to use <code># noqa: N805</code> or split out the method to a separate enum base until 3.10 becomes the minimum version. I'd just wondered if there was something that was overlooked.</p>
<p>Feel free to close this one out if there's nothing to action. It can serve as documentation for someone searching the issue tracker.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-01-30 12:33</div>
            <div class="timeline-body"><p>I appreciate it, thanks for all the info!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2023-01-30 12:33</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/l0b0">@l0b0</a> on 2023-02-08 22:17</div>
            <div class="timeline-body"><p>Thank you for <code>staticmethod_hack</code>! Unfortunately, <code>pylint</code> has some issues with it:</p>
<blockquote>
<p>Class name &quot;staticmethod_hack&quot; doesn't conform to PascalCase naming style (invalid-name)</p>
</blockquote>
<p>and</p>
<blockquote>
<p>Method should have &quot;self&quot; as first argument (no-self-argument)</p>
</blockquote>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../saltstack/salt/pulls/66135.html">saltstack/salt#66135</a> on 2024-04-14 22:34</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:34:49 UTC
    </footer>
</body>
</html>
