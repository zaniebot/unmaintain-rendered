<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ERA001: autofix removes valid comments that do not contain code or removes not everything - astral-sh/ruff #4845</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>ERA001: autofix removes valid comments that do not contain code or removes not everything</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/issues/4845">#4845</a>
        opened by <a href="https://github.com/saippuakauppias">@saippuakauppias</a>
        on 2023-06-03 23:41
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/saippuakauppias">@saippuakauppias</a> on 2023-06-03 23:41</div>
            <div class="timeline-body"><p>Example:</p>
<pre><code class="language-python"># Example of headers:
# X-token: &lt;token_id&gt;
# X-scope: no-scope
# End of comment about headers


# {
#    &quot;some-key&quot;: {
#         '1': 1,
#         '2': 2',
#     }
# }


# some = 1
# awesome = 2
#
# foobar = 3
# barfoo = 4


# example code from IPython:
# In [20]: parse.parse_qsl('&amp;l=55.123;123.1&amp;count=3', keep_blank_values=1)
# Out[20]: [('l', '55.123'), ('123.1', ''), ('count', '3')]
# End of comment


# (пример, пример2) = (example1, example2)


# if not success:  # TODO: comment
#    errors.append('Ошибка: error')


# comment
# 1. [{пример первый}]
# 2. [[пример]]
# 3. [] - пусто


# Пример: {&quot;description&quot;: &quot;weight: &quot;}


# comment about calculation
# 100 / 2 = 50
# end of comment


# comment:
# - tuple: ()
# - list: []
# - set: set()
# - dict: {}


# example of output:
# 'OK: message sent. Message-ID: 123456'


# MySQL: enum('positive', 'negative')


# query: lock + user.id
</code></pre>
<p>Ruff output:</p>
<pre><code class="language-sh">$ ruff --fix --select ERA001 ruff_errors/ERA001.py
Found 24 errors (24 fixed, 0 remaining).
</code></pre>
<p>Contents of the file after fix:</p>
<pre><code class="language-python"># Example of headers:
# X-token: &lt;token_id&gt;
# End of comment about headers


#    &quot;some-key&quot;: {


#


# example code from IPython:
# End of comment




# if not success:  # TODO: comment


# comment
# 1. [{пример первый}]
# 3. [] - пусто




# comment about calculation
# end of comment


# comment:


# example of output:





</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-06-05 02:45</div>
            <div class="timeline-body"><p>I don't think we're in a position to improve this much, the logic itself is derived from eradicate, and I'd bet eradicate has the same or very similar behavior. Perhaps we should remove the autofix from this rule though. It seems correct to flag that there's some commented-out code here, but rely on users to remove it.</p>
<p>Alternatively, we could only autofix if <em>all</em> lines in a comment block are identified as code.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2023-06-05 04:06</div>
            <div class="timeline-body"><p>We could make this as a Suggested (<code>Applicability::Suggested</code>) fix.</p>
<pre><code class="language-rust">    /// The fix may be what the user intended, but it is uncertain.
    /// The fix should result in valid code if it is applied.
    /// The fix can be applied with user opt-in.
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2023-06-05 04:39</div>
            <div class="timeline-body"><p>I like</p>
<blockquote>
<p>Alternatively, we could only autofix if all lines in a comment block are identified as code.</p>
</blockquote>
<p>Perhaps we could use <code>Suggested</code> in that case and <code>Manual</code> otherwise?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/karolinepauls">@karolinepauls</a> on 2023-06-15 08:45</div>
            <div class="timeline-body"><p>Another example: it thinks the comment is code even though <code>params</code> isn't a valid keyword</p>
<pre><code># params: abc
query = &quot;&quot;&quot;
SELECT :abc;
&quot;&quot;&quot;
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2023-06-15 14:04</div>
            <div class="timeline-body"><blockquote>
<p>Another example: it thinks the comment is code even though <code>params</code> isn't a valid keyword</p>
<pre><code># params: abc
query = &quot;&quot;&quot;
SELECT :abc;
&quot;&quot;&quot;
</code></pre>
</blockquote>
<p>I believe this is considered as a valid code (<code>variable: annotation</code>):</p>
<pre><code class="language-python">params: int
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/bodograumann">@bodograumann</a> on 2023-08-24 13:21</div>
            <div class="timeline-body"><p>I am absolutely in favor of not automatically removing these comments in any situation. Yes, commented-out code is usually a mistake, but you really don't want to loose actual comments accidentally.</p>
<p>Our example:</p>
<pre><code># foo and bar (JIRA-9999)
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2023-08-24 14:01</div>
            <div class="timeline-body"><p>@bodograumann what is the benefit of enabling the ERA001 rule for you then?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/bodograumann">@bodograumann</a> on 2023-08-24 14:35</div>
            <div class="timeline-body"><p>It will still warn me and usually correctly so, but I still need to decide myself whether a line needs to be removed.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2023-08-24 15:09</div>
            <div class="timeline-body"><p>We've updated the applicability of the fix here to &quot;Manual&quot; which will <em>never</em> automatically apply once we merge #5119 — I don't think there's more to do here this issue will be resolved once applicability is respected by the CLI per https://github.com/astral-sh/ruff/issues/4185</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/jaap3">@jaap3</a> on 2023-08-30 10:49</div>
            <div class="timeline-body"><p>Was about to open a new issue, but I think this fits here:</p>
<p>While testing out ruff, I ran into some false positives for <code>ERA001</code> that confused me a bit.</p>
<p>Some examples:</p>
<pre><code class="language-python"># Keep this list sorted alphabetically
# (it is used in example)
</code></pre>
<pre><code class="language-python"># Check if the ip address in either:
# local (loopback) or internal (private)
</code></pre>
<pre><code class="language-python">##
# Client (consumers)
##

...

##
# Server (protocol)
##
</code></pre>
<p>All trigger <code>ERA001</code> even though they are not really code.</p>
<p>I had also hoped that code fragments that are part of a larger comment wouldn't trigger <code>ERA001</code>, yet all of these do:</p>
<pre><code class="language-python"># XXX: Cannot use:
# self.example(foo, 'bar')
# because of issue #1337
</code></pre>
<pre><code class="language-python"># XXX: Example category has a duplicate 'code' and is omitted
# EXAMPLE_CATEGORY = '1.0', 'Example Category'
</code></pre>
<pre><code class="language-python"># Note: Admin site instance should be passed when calling
# ExampleAdminView.as_view(site=site)
</code></pre>
<pre><code class="language-python"># main categories themselves are not part of the return value of
# get_subcategories()
</code></pre>
<p>This is all using <code>ruff 0.0.286</code>.</p>
<p>I've already marked <code>ERA001</code> as <code>unfixable</code> in my configuration file. I'm hoping it is possible to tweak the heuristics of <code>ERA001</code> a bit so it takes the surrounding context into account or something?</p>
<p>For now I'll just be working around this by rewording/reformatting these comments until they don't trigger anymore.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2023-08-30 14:52</div>
            <div class="timeline-body"><p>Yeah the ERA001 heuristics are very prone to false positives, unfortunately. I think there's room for improvement, but it's not entirely clear how.</p>
<pre><code class="language-python">def foo():
    x = 1
    # add to x
    # x += 1
   return x
</code></pre>
<p>I think this should raise as an ERA001 violation but if we ignore comments that are part of a larger non-code context then we won't raise here. Maybe that's worth the false negative to reduce the false positives.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/jaap3">@jaap3</a> on 2023-08-31 11:53</div>
            <div class="timeline-body"><p>This seems like a bug:</p>
<p>A single parenthesis triggers <code>ERA001</code>:</p>
<pre><code class="language-sh">echo &quot;# )&quot; | ruff --select ERA001,RUF100 --stdin-filename test.py
test.py:1:1: ERA001 [*] Found commented-out code
</code></pre>
<p>Adding a <code>noqa</code> to that line triggers <code>RUF100</code>:</p>
<pre><code class="language-sh">echo &quot;# )  # noqa: ERA001&quot; | ruff --select ERA001,RUF100 --stdin-filename test.py
test.py:1:6: RUF100 [*] Unused `noqa` directive (unused: `ERA001`)
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-08-31 13:31</div>
            <div class="timeline-body"><p>@jaap3 - Funnily enough that specific case was reported recently and is fixed on <code>main</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @zanieb on 2023-10-06 03:41</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/tusharsadhwani">@tusharsadhwani</a> on 2024-06-27 12:25</div>
            <div class="timeline-body"><p>Is there scope for a PR for better algorithms, and a better set of false positive rules here?</p>
<p>It will deviate from the eradicate plugin, would that be okay or should it be a different rule entirely then?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-06-27 12:31</div>
            <div class="timeline-body"><p>Yeah definitely fine to fold in improvements even if it deviates from eradicate.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/tusharsadhwani">@tusharsadhwani</a> on 2024-06-27 12:40</div>
            <div class="timeline-body"><p>Self-documenting here for later.</p>
<p>Examples of false negatives:</p>
<pre><code class="language-py"># if foo:

# elif bar:

# if (
#  x
# ):

# else:
</code></pre>
<p>Examples of false positives:</p>
<pre><code class="language-py"># continue
# pragma: cover
# (something)
# O(1)
# this is O(1)
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/abhijith-404">@abhijith-404</a> on 2024-12-26 07:17</div>
            <div class="timeline-body"><pre><code>#  Checking if the first default_path is there in api_paths if true then, return the action i.e create, read, update, delete

</code></pre>
<p>this is the comment I wrote, it contains <code>return</code> in this sentence only because of that, it is raising a warning</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/tusharsadhwani">@tusharsadhwani</a> on 2024-12-26 07:25</div>
            <div class="timeline-body"><p>That should be fixable, let me do just that much for now.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/webknjaz">@webknjaz</a> on 2025-04-19 19:55</div>
            <div class="timeline-body"><blockquote>
<p>I don't think we're in a position to improve this much, the logic itself is derived from eradicate, and I'd bet eradicate has the same or very similar behavior. Perhaps we should remove the autofix from this rule though. It seems correct to flag that there's some commented-out code here, but rely on users to remove it.</p>
<p>Alternatively, we could only autofix if <em>all</em> lines in a comment block are identified as code.</p>
</blockquote>
<p>@charliermarsh FYI flake8-eradicate has a <code>eradicate-whitelist-extend</code> setting (and a few more) that allow tweaking the regex used to get rid or false-positives: https://github.com/cherrypy/cheroot/blob/733cbd1/.flake8#L158-L160.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 11:30:16 UTC
    </footer>
</body>
</html>
