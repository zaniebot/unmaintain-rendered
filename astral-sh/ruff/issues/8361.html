<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bash completion emits error about invalid nosort option after installing ruff - astral-sh/ruff #8361</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Bash completion emits error about invalid nosort option after installing ruff</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/issues/8361">#8361</a>
        opened by <a href="https://github.com/gbelouze">@gbelouze</a>
        on 2023-10-30 16:38
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/gbelouze">@gbelouze</a></div>
            <div class="timeline-body"><!--
Thank you for taking the time to report an issue! We're glad to have you involved with Ruff.

If you're filing a bug report, please consider including the following information:

* A minimal code snippet that reproduces the bug.
* The command you invoked (e.g., `ruff /path/to/file.py --fix`), ideally including the `--isolated` flag.
* The current Ruff settings (any relevant sections from your `pyproject.toml`).
* The current Ruff version (`ruff --version`).
-->

<h1>Context</h1>
<pre><code class="language-bash">$ ruff --version
ruff 0.0.292
</code></pre>
<h1>Summary</h1>
<p>Hi, I have <code>ruff</code> installed via <code>homebrew</code>. Whenever I open a new terminal I get a</p>
<pre><code class="language-bash">bash: complete: nosort: invalid option name
</code></pre>
<p>I have traced it back to <code>ruff</code> autocompletion. This is similar to <a href="https://github.com/Homebrew/homebrew-core/issues/32535">this issue</a> although that user was having trouble with another package (<code>wireguard-tools</code>).
The issue in that case was that <code>wireguard</code> was relying on bash v4 (where presumably the <code>nosort</code> option exists), while macOS still uses bash v3. They ended up explicitly disabling autocompletion when detecting an old bash version, see <a href="https://lists.zx2c4.com/pipermail/wireguard/2018-October/003418.html">their fix</a>. I have no idea if the root of the issue is similar here, though.</p>
<h1>Steps to reproduce</h1>
<p><code>brew install ruff</code>
and somewhere in your <code>.bash_profile</code> or <code>.bashrc</code></p>
<pre><code class="language-bash">if [ -f $(brew --prefix)/etc/bash_completion ]; then
    . $(brew --prefix)/etc/bash_completion
fi
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/gbelouze">@gbelouze</a> on 2023-10-30 16:42</div>
            <div class="timeline-body"><p>For users who want a quick-and-dirty fix removing the warning, but also the autocompletion for <code>ruff</code>, you can add an explicit check in your <code>$(brew --prefix)/etc/bash_completion</code> file (for me this is <code>/usr/local/etc/bash_completion</code>)</p>
<pre><code class="language-diff"># source completion directory definitions
if [[ -d $BASH_COMPLETION_COMPAT_DIR &amp;&amp; -r $BASH_COMPLETION_COMPAT_DIR &amp;&amp; \
    -x $BASH_COMPLETION_COMPAT_DIR ]]; then
    for i in $(LC_ALL=C command ls &quot;$BASH_COMPLETION_COMPAT_DIR&quot;); do
-            i=$BASH_COMPLETION_COMPAT_DIR/$i
-            [[ ${i##*/} != @(*~|*.bak|*.swp|\#*\#|*.dpkg*|*.rpm@(orig|new|save)|Makefile*) \
-                &amp;&amp; -f $i &amp;&amp; -r $i ]] &amp;&amp; . &quot;$i&quot;
+            if [ $i != &quot;ruff&quot; ] 
+            then
+                i=$BASH_COMPLETION_COMPAT_DIR/$i
+                [[ ${i##*/} != @(*~|*.bak|*.swp|\#*\#|*.dpkg*|*.rpm@(orig|new|save)|Makefile*) \
+                    &amp;&amp; -f $i &amp;&amp; -r $i ]] &amp;&amp; . &quot;$i&quot;
+            fi
    done
fi
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2023-10-30 20:20</div>
            <div class="timeline-body"><p>Thanks for the well written issue!</p>
<p>Hm is our bash completion generated by us (e.g. via Clap) or by Homebrew during the build?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @zanieb on 2023-10-30 20:21</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">cli</span> added by @zanieb on 2023-10-30 20:21</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-10-30 20:23</div>
            <div class="timeline-body"><p>I believe it's generated by us using <code>clap_completion</code> (can grep for <code>Command::GenerateShellCompletion</code>).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2023-10-30 20:26</div>
            <div class="timeline-body"><p>Ah so it comes from https://github.com/clap-rs/clap/blob/9bfa5a338c6532419e2477e89708395fbb02ca06/clap_complete/src/shells/bash.rs#L61</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2023-10-30 20:28</div>
            <div class="timeline-body"><p>Surprisingly there are no issues on <code>clap</code> for this â€” if you have the time I suggest creating one there and we can see if they're interested in support for bash v3.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/gbelouze">@gbelouze</a> on 2023-10-30 20:52</div>
            <div class="timeline-body"><p>Thanks for the quick response, I'll run it by the <code>clap</code> people then.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntBre">@ntBre</a> on 2025-09-19 22:26</div>
            <div class="timeline-body"><p>I believe this was fixed as early as Ruff v0.3.0! To double-check, I built an old version of bash, reproduced the issue on Ruff v0.0.292 and then confirmed that it was fixed on a later version:</p>
<pre><code class="language-shell">bash-4.0# source &lt;(uvx ruff@v0.0.292 generate-shell-completion bash)
bash: complete: nosort: invalid option name
bash-4.0# source &lt;(uvx ruff@v0.3.0 generate-shell-completion bash)
bash-4.0# source &lt;(uvx ruff@v0.2.0 generate-shell-completion bash)
bash: complete: nosort: invalid option name
bash-4.0# source &lt;(uvx ruff@v0.13.1 generate-shell-completion bash)
</code></pre>
<p>Based on the clap PR and when we bumped to clap 4.4.13, I thought this would have been fixed as early as Ruff v0.1.12, but the earliest working version I found was 0.3.0. Anyway, it should definitely be fixed now!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @ntBre on 2025-09-19 22:26</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 16:48:50 UTC
    </footer>
</body>
</html>
