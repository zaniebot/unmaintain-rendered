<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RSE102 error despite parentheses being necessary - astral-sh/ruff #5416</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>RSE102 error despite parentheses being necessary</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/issues/5416">#5416</a>
        opened by <a href="https://github.com/sultur">@sultur</a>
        on 2023-06-28 10:57
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/sultur">@sultur</a> on 2023-06-28 10:57</div>
            <div class="timeline-body"><!--
Thank you for taking the time to report an issue! We're glad to have you involved with Ruff.

If you're filing a bug report, please consider including the following information:

* A minimal code snippet that reproduces the bug.
* The command you invoked (e.g., `ruff /path/to/file.py --fix`), ideally including the `--isolated` flag.
* The current Ruff settings (any relevant sections from your `pyproject.toml`).
* The current Ruff version (`ruff --version`).
-->

<p>Hello, thank you for ruff, it's fantastic!
I encountered this small bug regarding rule RSE102.</p>
<p>Ruff version: <code>ruff 0.0.274</code>
Ruff settings: All rules turned on (ignoring a few specific ones, not relevant here).</p>
<p>Minimal code snippet:</p>
<pre><code class="language-python3">def return_error():
    return ValueError(&quot;Something&quot;)

raise return_error()
</code></pre>
<p>Commands to reproduce:</p>
<pre><code class="language-sh">$ ruff bug.py
test.py:4:19: RSE102 [*] Unnecessary parentheses on raised exception
Found 1 error.
[*] 1 potentially fixable with the --fix option.
$ ruff bug.py --fix
Found 1 error (1 fixed, 0 remaining).
</code></pre>
<p>Resulting file after autofix:</p>
<pre><code class="language-python3">def return_error():
    return ValueError(&quot;Something&quot;)

raise return_error
</code></pre>
<p>Issue:
The line <code>raise return_error()</code> is diagnosed as violating RSE102 (Unecessary parentheses on raised exception), despite the parentheses being necessary.
This gets autofixed as <code>raise return_error</code>, which raises a <code>TypeError</code> (as the function isn't an exception) instead of a <code>ValueError</code>.</p>
<hr />
<p>Solution idea <em>(I took a quick glance at the changes in https://github.com/astral-sh/ruff/pull/2596, but I'm not well versed enough in Rust to fully understand them.)</em>:
When autofixing, instead of removing any empty parentheses at the end of <code>raise ...</code> lines, only attempt to remove them when they come directly after the name of a built-in exception (e.g. <code>ValueError</code>, <code>TypeError</code>, <code>(asyncio.)?CancelledError</code>, etc.).</p>
<p>So lines like</p>
<pre><code class="language-python3">raise NotImplementedError()
raise ValueError()
</code></pre>
<p>can be autofixed into</p>
<pre><code class="language-python3">raise NotImplementedError
raise ValueError
</code></pre>
<p>but lines like</p>
<pre><code class="language-python3">raise SomeCustomError()
# or
raise my_error_function()
</code></pre>
<p>would require manual fixing.</p>
<p>Maybe you have some more clever solution to this than matching a long list of built-in exceptions, but I hope this helps though!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @charliermarsh on 2023-06-28 20:02</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-06-28 20:03</div>
            <div class="timeline-body"><p>Thank you for the kind words :)</p>
<p>So, I think the issue here is that a function call (rather than a class instantiation) is being passed to the <code>raise</code> statement, which is not invalid per se, but does strike me as non-idiomatic (FWIW). It's totally fine to call <code>raise MyCustomError</code> on custom errors, they just have to be classes, per the <a href="https://docs.python.org/3/tutorial/errors.html#raising-exceptions">Python docs</a>:</p>
<blockquote>
<p>If an exception class is passed, it will be implicitly instantiated by calling its constructor with no arguments.</p>
</blockquote>
<p>In other words, what we'd like to do here is guard against triggering <code>RSE102</code> on <code>raise foo()</code> where <code>foo</code> is a function, not a class.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sultur">@sultur</a> on 2023-06-29 09:30</div>
            <div class="timeline-body"><p>I agree, the raising from a function example is a bit odd :).</p>
<p>I encountered this in a situation closer to the following example (perhaps a bit less odd? Still raising from a function call though):</p>
<pre><code class="language-python3">class CustomError(Exception):
    def __init__(self, msg: str):
        self.msg = msg

    @staticmethod
    def timeout():
        return CustomError(&quot;Operation timed out!&quot;)

raise CustomError.timeout()
</code></pre>
<p>These kinds of instantiations of exceptions of course don't trigger RSE102 when they are called with arguments.</p>
<p>But if you have a way of distinguishing function calls from class instantiations with no arguments, then that would of course be the perfect solution!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-07-05 02:12</div>
            <div class="timeline-body"><p>This is being worked on in #5536.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2023-07-05 19:19</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sultur">@sultur</a> on 2023-07-06 09:26</div>
            <div class="timeline-body"><p>Great work! Thank you for the quick response and fix. Looking forward to this in upcoming releases :)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/lostcontrol">@lostcontrol</a> on 2023-08-18 12:04</div>
            <div class="timeline-body"><p>Still occurs to me in 0.0.285. Is that expected?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-08-18 13:30</div>
            <div class="timeline-body"><p>I think the current version only works for definitions and <code>raises</code> that occur in the same file. Fixing this for multi-file references will be part of a larger project. Can you post a repro for your use-case?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/lostcontrol">@lostcontrol</a> on 2023-08-21 07:29</div>
            <div class="timeline-body"><blockquote>
<p>I think the current version only works for definitions and <code>raises</code> that occur in the same file. Fixing this for multi-file references will be part of a larger project. Can you post a repro for your use-case?</p>
</blockquote>
<p>Indeed, that's the problem.</p>
<p><code>custom.py</code></p>
<pre><code class="language-python">class CustomError(Exception):
    def __init__(self, msg: str):
        self.msg = msg

    @staticmethod
    def timeout():
        return CustomError(&quot;Operation timed out!&quot;)
</code></pre>
<p><code>bug.py</code></p>
<pre><code class="language-python">from backend.ruff_bug.custom import CustomError

raise CustomError().timeout()
</code></pre>
<p>Auto-fix will remove the method call:</p>
<p><code>bug.py</code></p>
<pre><code class="language-python">from ruff_bug.custom import CustomError

raise CustomError().timeout
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/tdulcet">@tdulcet</a> on 2023-08-21 14:37</div>
            <div class="timeline-body"><p>Raising <a href="https://docs.python.org/3/library/ctypes.html#ctypes.WinError"><code>ctypes.WinError()</code></a> also triggers this. There is a <a href="https://code.activestate.com/recipes/577972-disk-usage/">code snippet here</a> for example.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-08-21 14:39</div>
            <div class="timeline-body"><p>Wow, that's a function? That's a rough API. Anyway, we can special-case it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/joostmeulenbeld">@joostmeulenbeld</a> on 2024-02-20 12:50</div>
            <div class="timeline-body"><p>An example from the python standard library: <code>concurrent.futures.Future.exception()</code> returns an exception raised by the called function, or <code>None</code> if no exception was raised.</p>
<pre><code class="language-python">from concurrent.futures import ThreadPoolExecutor

with ThreadPoolExecutor() as executor:
    future = executor.submit(float, &quot;a&quot;)
    if future.exception():
        raise future.exception()  # RSE102 Unnecessary parentheses on raised exception
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Rizhiy">@Rizhiy</a> on 2024-03-02 22:59</div>
            <div class="timeline-body"><p>@charliermarsh <code>future.exception()</code> example given above is part of the standard library and should not be linted.
Can we get a fix, please?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-03-03 00:22</div>
            <div class="timeline-body"><p>Fixed here: https://github.com/astral-sh/ruff/pull/10206</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 11:30:33 UTC
    </footer>
</body>
</html>
