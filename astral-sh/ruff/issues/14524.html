<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[red-knot] Properly handle gradual types in subtyping/equivalence relations - astral-sh/ruff #14524</title>
    <link rel="stylesheet" href="../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../index.html">Back to index</a>
    </div>

    <h1>[red-knot] Properly handle gradual types in subtyping/equivalence relations</h1>

    <div class="meta">
        <span class="state state-closed">Closed</span>
        <a href="https://github.com/astral-sh/ruff/issues/14524">#14524</a>
        opened by <a href="https://github.com/sharkdp">@sharkdp</a>
        on 2024-11-22 10:51
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/sharkdp">@sharkdp</a> on 2024-11-22 10:51</div>
            <div class="timeline-body"><p>From https://typing.readthedocs.io/en/latest/spec/concepts.html#materialization:</p>
<blockquote>
<p>Since <a href="https://typing.readthedocs.io/en/latest/spec/special-types.html#any">Any</a> represents an unknown static type, it does not represent any known single set of values (it represents an unknown set of values). Thus it is not in the domain of the subtype, supertype, or equivalence relations on static types described above.</p>
</blockquote>
<p>But we currently return true for <code>Type::Any.is_subtype_of(Type::Any)</code>.</p>
<p>The reason for that is that <code>is_subtype_of</code> relies on <code>is_equivalent_to</code>.</p>
<p>And <code>is_equivalent_to</code> doesn't model type equivalence for fully static types as defined <a href="https://typing.readthedocs.io/en/latest/spec/concepts.html#subtype-supertype-and-type-equivalence">here</a>.</p>
<p>But rather something (but also not exactly) what would be the <a href="https://typing.readthedocs.io/en/latest/spec/concepts.html#summary-of-type-relations">is-consistent-with</a> definition for gradual types (for example, we currently have <code>Any.is_equivalent_to(Any)</code> but not <code>Any.is_equivalent_to(Int)</code>, which would be required for is-consistent-with).</p>
<ul>
<li>[x] Fix subtyping for gradual types</li>
<li>[x]  Clarify what kind of equivalence <code>is_equivalent_to</code> implements and potentially make it more consistent with that definition</li>
<li>[x] Make sure that this is the interpretation of <code>is_equivalent_to</code> that we want at all call sites.</li>
<li>[x] Potentially introduce <code>is_fully_static</code></li>
<li>[x] Make sure we still handle assignability correctly.</li>
<li>[x] Make sure we still simplify unions of <code>Any</code>.</li>
<li>[x] Add new property test: non-fully-static types should never participate in subtyping</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @sharkdp on 2024-11-22 10:51</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by @sharkdp on 2024-11-22 10:51</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @sharkdp by @sharkdp on 2024-11-22 10:51</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/14178.html">astral-sh/ruff#14178</a> on 2024-12-03 08:02</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/14758.html">astral-sh/ruff#14758</a> on 2024-12-03 14:16</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @sharkdp on 2024-12-04 16:11</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @sharkdp on 2024-12-04 16:11</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:28:14 UTC
    </footer>
</body>
</html>
