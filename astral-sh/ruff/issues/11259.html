<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Code action breaks when using both `ruff_lsp` and `ruff` on unused import - astral-sh/ruff #11259</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Code action breaks when using both `ruff_lsp` and `ruff` on unused import</h1>

    <div class="meta">
        <span class="state state-closed">Closed</span>
        <a href="https://github.com/astral-sh/ruff/issues/11259">#11259</a>
        opened by <a href="https://github.com/xl4624">@xl4624</a>
        on 2024-05-03 04:18
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/xl4624">@xl4624</a> on 2024-05-03 04:18</div>
            <div class="timeline-body"><!--
Thank you for taking the time to report an issue! We're glad to have you involved with Ruff.

If you're filing a bug report, please consider including the following information:

* List of keywords you searched for before creating this issue. Write them down here so that others can find this issue more easily and help provide feedback.
"missing field 'range'", "deserialize diagnostic data", "KeyError: 'location'"
* A minimal code snippet that reproduces the bug.
* The command you invoked (e.g., `ruff /path/to/file.py --fix`), ideally including the `--isolated` flag.
* The current Ruff settings (any relevant sections from your `pyproject.toml`).
* The current Ruff version (`ruff --version`).
-->

<p>When I run neovim with this config:</p>
<pre><code class="language-lua">local on_windows = vim.loop.os_uname().version:match 'Windows'

local function join_paths(...)
  local path_sep = on_windows and '\\' or '/'
  local result = table.concat({ ... }, path_sep)
  return result
end

vim.cmd [[set runtimepath=$VIMRUNTIME]]

local temp_dir = vim.loop.os_getenv 'TEMP' or '/tmp'

vim.cmd('set packpath=' .. join_paths(temp_dir, 'nvim', 'site'))

local package_root = join_paths(temp_dir, 'nvim', 'site', 'pack')
local lspconfig_path = join_paths(package_root, 'test', 'start', 'nvim-lspconfig')

if vim.fn.isdirectory(lspconfig_path) ~= 1 then
  vim.fn.system { 'git', 'clone', 'https://github.com/neovim/nvim-lspconfig', lspconfig_path }
end

vim.lsp.set_log_level 'trace'
require('vim.lsp.log').set_format_func(vim.inspect)
local nvim_lsp = require 'lspconfig'
local on_attach = function(_, bufnr)
  local function buf_set_option(...)
    vim.api.nvim_buf_set_option(bufnr, ...)
  end

  buf_set_option('omnifunc', 'v:lua.vim.lsp.omnifunc')

  -- Mappings.
  local opts = { buffer = bufnr, noremap = true, silent = true }
  vim.keymap.set('n', 'gD', vim.lsp.buf.declaration, opts)
  vim.keymap.set('n', 'gd', vim.lsp.buf.definition, opts)
  vim.keymap.set('n', 'K', vim.lsp.buf.hover, opts)
  vim.keymap.set('n', 'gi', vim.lsp.buf.implementation, opts)
  vim.keymap.set('n', '&lt;C-k&gt;', vim.lsp.buf.signature_help, opts)
  vim.keymap.set('n', '&lt;space&gt;ca', vim.lsp.buf.code_action, opts)
  vim.keymap.set('n', '&lt;space&gt;wa', vim.lsp.buf.add_workspace_folder, opts)
  vim.keymap.set('n', '&lt;space&gt;wr', vim.lsp.buf.remove_workspace_folder, opts)
  vim.keymap.set('n', '&lt;space&gt;wl', function()
    print(vim.inspect(vim.lsp.buf.list_workspace_folders()))
  end, opts)
  vim.keymap.set('n', '&lt;space&gt;D', vim.lsp.buf.type_definition, opts)
  vim.keymap.set('n', '&lt;space&gt;rn', vim.lsp.buf.rename, opts)
  vim.keymap.set('n', 'gr', vim.lsp.buf.references, opts)
  vim.keymap.set('n', '&lt;space&gt;e', vim.diagnostic.open_float, opts)
  vim.keymap.set('n', '[d', vim.diagnostic.goto_prev, opts)
  vim.keymap.set('n', ']d', vim.diagnostic.goto_next, opts)
  vim.keymap.set('n', '&lt;space&gt;q', vim.diagnostic.setloclist, opts)
end

-- LspInfo shows:
-- Client: ruff (id: 1, bufnr: [1])
-- 	filetypes:       python
-- 	autostart:       true
-- 	root directory:  Running in single file mode.
-- 	cmd:             /Users/xiaomin/.local/share/nvim/mason/bin/ruff server --preview
-- 
-- Client: ruff_lsp (id: 2, bufnr: [1])
-- 	filetypes:       python
-- 	autostart:       true
-- 	root directory:  Running in single file mode.
-- 	cmd:             /Users/xiaomin/.local/share/nvim/mason/bin/ruff-lsp
--
-- Configured servers list: ruff, ruff_lsp

nvim_lsp['ruff'].setup {
  cmd = { '/Users/xiaomin/.local/share/nvim/mason/bin/ruff', 'server', '--preview' },
  on_attach = on_attach,
}
nvim_lsp['ruff_lsp'].setup {
  cmd = { '/Users/xiaomin/.local/share/nvim/mason/bin/ruff-lsp' },
  on_attach = on_attach,
}

print [[You can find your log at $HOME/.cache/nvim/lsp.log. Please paste in a github issue under a details tag as described in the issue template.]]
</code></pre>
<p>And then wait a bit for ruff to load in, when I try <code>&lt;space&gt;ca</code> on this test file:</p>
<pre><code class="language-python">from datetime import datetime
</code></pre>
<p>I get &quot;No code actions available&quot;</p>
<p>Here are the relevant logs:</p>
<pre><code>[ERROR][2024-05-02 23:55:00] .../vim/lsp/rpc.lua:734	&quot;rpc&quot;	&quot;/Users/xiaomin/.local/share/nvim/mason/bin/ruff&quot;	&quot;stderr&quot;	&quot;  62.696570s INFO ruff_server::session::workspace::ruff_settings No ruff settings file (pyproject.toml/ruff.toml/.ruff.toml) found for /Users/xiaomin/test.py - falling back to default configuration\n  62.696950s ERROR ruff_server::server::api An error occurred with result ID 2: failed to deserialize diagnostic data: missing field `range`\n&quot;
[DEBUG][2024-05-02 23:55:00] .../vim/lsp/rpc.lua:387	&quot;rpc.receive&quot;	{
  jsonrpc = &quot;2.0&quot;,
  method = &quot;window/showMessage&quot;,
  params = {
    message = &quot;Ruff encountered a problem. Check the logs for more details.&quot;,
    type = 1
  }
}
[DEBUG][2024-05-02 23:55:00] .../vim/lsp/rpc.lua:387	&quot;rpc.receive&quot;	{
  error = {
    code = -32603,
    message = &quot;failed to deserialize diagnostic data: missing field `range`&quot;
  },
  id = 2,
  jsonrpc = &quot;2.0&quot;
}
[TRACE][2024-05-02 23:55:00] .../lua/vim/lsp.lua:1052	&quot;notification&quot;	&quot;window/showMessage&quot;	{
  message = &quot;Ruff encountered a problem. Check the logs for more details.&quot;,
  type = 1
}
[TRACE][2024-05-02 23:55:00] ...lsp/handlers.lua:618	&quot;default_handler&quot;	&quot;window/showMessage&quot;	{
  ctx = '{\n  client_id = 1,\n  method = &quot;window/showMessage&quot;\n}',
  result = {
    message = &quot;Ruff encountered a problem. Check the logs for more details.&quot;,
    type = 1
  }
}
[ERROR][2024-05-02 23:55:00] .../vim/lsp/rpc.lua:734	&quot;rpc&quot;	&quot;/Users/xiaomin/.local/share/nvim/mason/bin/ruff-lsp&quot;	&quot;stderr&quot;	&quot;Exception occurred for message \&quot;2\&quot;: KeyError: 'location'\nTraceback (most recent call last):\n  File \&quot;/Users/xiaomin/.local/share/nvim/mason/packages/ruff-lsp/venv/lib/python3.12/site-packages/pygls/protocol/json_rpc.py\&quot;, line 194, in _execute_request_callback\n    self._send_response(msg_id, result=future.result())\n                                       ^^^^^^^^^^^^^^^\n  File \&quot;/Users/xiaomin/.local/share/nvim/mason/packages/ruff-lsp/venv/lib/python3.12/site-packages/ruff_lsp/server.py\&quot;, line 1000, in code_action\n    edit=_create_workspace_edit(\n         ^^^^^^^^^^^^^^^^^^^^^^^\n  File \&quot;/Users/xiaomin/.local/share/nvim/mason/packages/ruff-lsp/venv/lib/python3.12/site-packages/ruff_lsp/server.py\&quot;, line 1490, in _create_workspace_edit\n    line=edit[\&quot;location\&quot;][\&quot;row\&quot;] - 1,\n         ~~~~^^^^^^^^^^^^\nKeyError: 'location'\n&quot;
[DEBUG][2024-05-02 23:55:00] .../vim/lsp/rpc.lua:387	&quot;rpc.receive&quot;	{
  error = {
    code = -32603,
    data = {
      traceback = { '  File &quot;/Users/xiaomin/.local/share/nvim/mason/packages/ruff-lsp/venv/lib/python3.12/site-packages/pygls/protocol/json_rpc.py&quot;, line 194, in _execute_request_callback\n    self._send_response(msg_id, result=future.result())\n                                       ^^^^^^^^^^^^^^^\n', '  File &quot;/Users/xiaomin/.local/share/nvim/mason/packages/ruff-lsp/venv/lib/python3.12/site-packages/ruff_lsp/server.py&quot;, line 1000, in code_action\n    edit=_create_workspace_edit(\n         ^^^^^^^^^^^^^^^^^^^^^^^\n', '  File &quot;/Users/xiaomin/.local/share/nvim/mason/packages/ruff-lsp/venv/lib/python3.12/site-packages/ruff_lsp/server.py&quot;, line 1490, in _create_workspace_edit\n    line=edit[&quot;location&quot;][&quot;row&quot;] - 1,\n         ~~~~^^^^^^^^^^^^\n' }
    },
    message = &quot;KeyError: 'location'&quot;
  },
  id = 2,
  jsonrpc = &quot;2.0&quot;
}
</code></pre>
<p>I'm using <code>ruff 0.4.2</code> and <code>ruff-lsp 0.0.53</code> installed with Mason. It works fine if you disable one or the other so probably not a big deal ðŸ˜…</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-05-03 04:51</div>
            <div class="timeline-body"><p>Interesting find! It's because both <code>ruff_lsp</code> and <code>ruff server</code> sends the diagnostics with the same name &quot;Ruff&quot;. So, when you invoke code actions, Neovim sends all (from both <code>ruff server</code> and <code>ruff_lsp</code>) the diagnostics on the cursor line to all the servers (both <code>ruff server</code> and <code>ruff_lsp</code>). But, the structure of diagnostic expected by <code>ruff server</code> and <code>ruff_lsp</code> is different which is why you're getting a key error.</p>
<p>It's not recommended to use <code>ruff-lsp</code> and the new server at the same time. I think we should make this clear in the documentation if it's not mentioned.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-05-03 04:57</div>
            <div class="timeline-body"><p>Ok, it's at least mentioned for the Neovim setup guide: https://github.com/astral-sh/ruff/blob/main/crates/ruff_server/docs/setup/NEOVIM.md</p>
<p>And I don't think it's possible to even run both <code>ruff_lsp</code> and <code>ruff server</code> in VS Code at the same time because they both are available exclusively in the stable and pre-release version of the extension. Even in pre-release one can only enable either one of the server.</p>
<p>I'll close this issue as it's not recommended to run both the server at the same time.</p>
<p>cc @snowsignal</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @dhruvmanila on 2024-05-03 04:57</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">server</span> added by @dhruvmanila on 2024-05-03 04:57</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/xl4624">@xl4624</a> on 2024-05-03 05:10</div>
            <div class="timeline-body"><p>Makes sense. Not even sure what compelled me to install <code>ruff_lsp</code> to be honest, I probably installed it by accident one day and just ran with it.</p>
<p>Thanks for the response!</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:34:52 UTC
    </footer>
</body>
</html>
