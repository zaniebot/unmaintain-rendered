<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SIM102 Warning when checking value returned from walrus operator - astral-sh/ruff #13024</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>SIM102 Warning when checking value returned from walrus operator</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/issues/13024">#13024</a>
        opened by <a href="https://github.com/emilal">@emilal</a>
        on 2024-08-21 07:31
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/emilal">@emilal</a></div>
            <div class="timeline-body"><!--
Thank you for taking the time to report an issue! We're glad to have you involved with Ruff.

If you're filing a bug report, please consider including the following information:

* List of keywords you searched for before creating this issue. Write them down here so that others can find this issue more easily and help provide feedback.
  e.g. "RUF001", "unused variable", "Jupyter notebook"
* A minimal code snippet that reproduces the bug.
* The command you invoked (e.g., `ruff /path/to/file.py --fix`), ideally including the `--isolated` flag.
* The current Ruff settings (any relevant sections from your `pyproject.toml`).
* The current Ruff version (`ruff --version`).
-->

<p>In the case of using the walrus operator with an if to weed out <code>None</code> values, checking the non-<code>None</code> value and then potentially using it for something, ruff gives a SIM102 warning and a non-working suggestion. E.g. this code:</p>
<pre><code class="language-python">#!/usr/bin/env python3

from typing import Optional


def do_something(n):
    print(n)


def return_something() -&gt; Optional[int]:
    return 42


if k := return_something():
    if k &gt; 3:
        do_something(k)
</code></pre>
<p>will print 42, but get the following feedback with S enabled:</p>
<pre><code>sim102.py:14:1: SIM102 Use a single `if` statement instead of nested `if` statements
   |
14 | / if k := return_something():
15 | |     if k &gt; 3:
   | |_____________^ SIM102
16 |           do_something(k)
   |
   = help: Combine `if` statements using `and`

Found 1 error.
No fixes available (1 hidden fix can be enabled with the `--unsafe-fixes` option).
</code></pre>
<p>However, combining these two if statements does not work:</p>
<pre><code class="language-python">#!/usr/bin/env python3

from typing import Optional


def do_something(_):
    pass


def return_something() -&gt; Optional[int]:
    return 42


if k := return_something() and k &gt; 3:
    do_something(k)
</code></pre>
<p>will get the following feedback:</p>
<pre><code>sim102e.py:14:32: F821 Undefined name `k`
   |
14 | if k := return_something() and k &gt; 3:
   |                                ^ F821
15 |     do_something(k)
   |

Found 1 error.
</code></pre>
<p>and if you actually run it:</p>
<pre><code>Traceback (most recent call last):
  File &quot;/path/to/sim102e.py&quot;, line 14, in &lt;module&gt;
    if k := return_something() and k &gt; 3:
                                   ^
NameError: name 'k' is not defined
</code></pre>
<p>As far as I can tell, the <code>if</code> needs to have branched and concluded whether <code>k</code> contains a <code>None</code> before we can do another comparison; and SIM102 should not warn for tests using values obtained from walrus operators in previous <code>if</code>s.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/trag1c">@trag1c</a> on 2024-08-21 07:37</div>
            <div class="timeline-body"><p>The (unsafe) autofix ruff provides correctly puts the first condition in parentheses:</p>
<pre><code>λ ruff check foo.py --select=SIM --fix --unsafe-fixes
Found 1 error (1 fixed, 0 remaining).

λ tail -n 2 foo.py
if (k := return_something()) and k &gt; 3:
    do_something(k)
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @emilal on 2024-08-21 14:53</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 16:50:56 UTC
    </footer>
</body>
</html>
