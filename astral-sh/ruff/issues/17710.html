<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ERA001 &amp; RUF003 false positives on mathematical expressions in comments - astral-sh/ruff #17710</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>ERA001 &amp; RUF003 false positives on mathematical expressions in comments</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/ruff/issues/17710">#17710</a>
        opened by <a href="https://github.com/nicoonoclaste">@nicoonoclaste</a>
        on 2025-04-29 14:42
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/nicoonoclaste">@nicoonoclaste</a></div>
            <div class="timeline-body"><h3>Summary</h3>
<p>I noticed that ERA001 triggers on mathematical expressions (as produced by <code>unicodeit</code>, or manually authored) in comments, for example:</p>
<pre><code class="language-py">def encode_int(n: int) -&gt; bytes:
	&quot;&quot;&quot;A non-prefix-free, variable-length, optimal encoding of (unsigned) integers

	The code puts 256‚Å± integers in the length-i byte strings (in order),
	 then the next 256‚Å±‚Å∫¬π integers in length-(i+1) strings, etc.
	&quot;&quot;&quot;
	if n &lt; 0:
		raise ValueError(f&quot;encode_int expected a non-negative integer, got {n}&quot;)

	# minimum i s.t.      n &lt; ‚àë 256 ≤ = (256‚Å±‚Å∫¬π ‚àí 1) / 255
	#  &lt;=&gt;         255n + 1 &lt; 256‚Å±‚Å∫¬π
	#  &lt;=&gt; log‚ÇÇ‚ÇÖ‚ÇÜ(255n + 1) &lt; i + 1
	i = byte_length(255 * n + 1) - 1  # no greater than byte_length(n)
	return (n - (256**i - 1) // 255).to_bytes(byteorder=&quot;big&quot;, length=i)
</code></pre>
<p>Moreover, the use of <code>‚àí</code> (mathematical ‚Äúminus sign‚Äù in Unicode) triggers RUF003.</p>
<p>This is a recurring issue, as I often need to document the mathematics behind the algorithms my code implements.</p>
<p>Would it be possible to</p>
<ul>
<li>make RUF003 ignore the <a href="https://en.wikipedia.org/wiki/Mathematical_Operators_(Unicode_block)">Mathematical Operators</a> (U+2200‚ÄìU+22FF) and <a href="https://en.wikipedia.org/wiki/Supplemental_Mathematical_Operators">Supplemental Mathematical Operators</a> (U+2A00‚ÄìU+2AFF) blocks, at least within comments, and</li>
<li>improve ERA001's heuristic, not to cause false positives on mathematical expression which are not syntactically-valid Python.</li>
</ul>
<h3>Version</h3>
<p>ruff 0.11.7</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/nicoonoclaste">@nicoonoclaste</a> on 2025-04-29 14:42</div>
            <div class="timeline-body"><p>Oops, accidentally hit Ctrl+Return before I was done  üòÖ</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/nicoonoclaste">@nicoonoclaste</a> on 2025-04-29 14:54</div>
            <div class="timeline-body"><p>Wikipedia has a <a href="https://en.wikipedia.org/wiki/Mathematical_operators_and_symbols_in_Unicode">more-extensive list</a> of commonly-used mathematical symbols</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntBre">@ntBre</a> on 2025-04-29 20:37</div>
            <div class="timeline-body"><p>For ERA001, it looks like the <code>=</code> and <code>()</code> are causing the false positive here. These are included in the <code>POSITIVE_CASES</code> regex set, so I think we'd need a new heuristic to avoid lines like this.</p>
<p>https://github.com/astral-sh/ruff/blob/888c45584d483146dc38438e5ec7975f6b6ec502/crates/ruff_linter/src/rules/eradicate/detection.rs#L60-L72</p>
<p>It looks like RUF003 already has a config option to allow specific operators, and the minus sign is even used as an example: https://docs.astral.sh/ruff/settings/#lint_allowed-confusables</p>
<p>It might be a bit tedious to include all of the mathematical symbols, but at least it's possible. Otherwise, this seems to be the intention behind the rule, so it's more of a true positive, in my opinion.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">rule</span> added by @ntBre on 2025-04-29 20:37</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-04-30 06:44</div>
            <div class="timeline-body"><p>The &quot;proper&quot; solution is probably to rework ERA001 and make it stricter (e.g. analyze consecutive commented lines together instead of line by line which causes the false positive here).</p>
<p>I'm not sure if there's a good short-term fix.</p>
<p>We're aware that RUF003 and similar are overly strict right now, see https://github.com/astral-sh/ruff/issues/14433</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 16:52:39 UTC
    </footer>
</body>
</html>
