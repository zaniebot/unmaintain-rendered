<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rule B909 (loop-iterator-mutation) doesn't detect many kinds of list mutation - astral-sh/ruff #12164</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Rule B909 (loop-iterator-mutation) doesn't detect many kinds of list mutation</h1>

    <div class="meta">
        <span class="state state-closed">Closed</span>
        <a href="https://github.com/astral-sh/ruff/issues/12164">#12164</a>
        opened by <a href="https://github.com/Boon-in-Oz">@Boon-in-Oz</a>
        on 2024-07-03 07:10
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/Boon-in-Oz">@Boon-in-Oz</a> on 2024-07-03 07:10</div>
            <div class="timeline-body"><!--
Thank you for taking the time to report an issue! We're glad to have you involved with Ruff.

If you're filing a bug report, please consider including the following information:

* List of keywords you searched for before creating this issue. Write them down here so that others can find this issue more easily and help provide feedback.
  e.g. "RUF001", "unused variable", "Jupyter notebook"
* A minimal code snippet that reproduces the bug.
* The command you invoked (e.g., `ruff /path/to/file.py --fix`), ideally including the `--isolated` flag.
* The current Ruff settings (any relevant sections from your `pyproject.toml`).
* The current Ruff version (`ruff --version`).
-->

<p>Hello and thank you for this excellent tool,</p>
<p>I'm running Ruff as a linter in VS Code with <code>select = [&quot;ALL&quot;]</code>, <code>preview = true</code> and only specific rules ignored. I'm still on Python 3.7.7, and using the Ruff 2024.28.0 extension.</p>
<p>I've found that B909 sometimes fires when I extend a list in a loop, but not when I remove or del an item from it. I'm not sure how the original Bugbear behaves in this case but in practice these seem very similar and any of them can cause bugs.</p>
<p>I can't find any report of this in issues, searching for &quot;B909&quot;, &quot;mutation&quot;, &quot;iterator&quot;. The only issue I found was the original task to implement B038: https://github.com/astral-sh/ruff/issues/9511</p>
<p>Repros:</p>
<p>This does not generate any linting errors:
(from https://stackoverflow.com/questions/6260089/strange-result-when-removing-item-from-a-list-while-iterating-over-it-in-python)</p>
<pre><code>numbers = list(range(1, 30))
for i in numbers:
    if i &lt; 20:
        numbers.remove(i)
print(numbers)
</code></pre>
<blockquote>
<p>[2, 4, 6, 8, 10, 12, 14, 16, 18, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29]</p>
</blockquote>
<p>But this triggers both B909 and PERF401:</p>
<pre><code>numbers = list(range(1, 30))
for i in numbers:
    if i &lt; 20:
        numbers.append(i + 20)
print(numbers)
</code></pre>
<p>This does not trigger B909 or PERF401 either (though it does correctly trigger FURB148 on the <code>enumerate</code> call)</p>
<pre><code>numbers = list(range(1, 30))
for i, _ in enumerate(numbers):
    if i &lt; 20:
        numbers.append(i)
</code></pre>
<p>Same for this:</p>
<pre><code>numbers = list(range(1, 30))
for i, _ in enumerate(numbers):
    if i &lt; 20:
        del numbers[i]
print(numbers)
</code></pre>
<blockquote>
<p>[2, 4, 6, 8, 10, 12, 14, 16, 18, 20, 22, 24, 26, 28]</p>
</blockquote>
<p>And this (don't try this one, it's an infinite loop)</p>
<pre><code>numbers = list(range(1, 30))
for i, _ in enumerate(numbers):
    if i &gt; 20:
        numbers.append(i)
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-07-17 02:08</div>
            <div class="timeline-body"><pre><code class="language-python">numbers = list(range(1, 30))
for i in numbers:
    if i &lt; 20:
        numbers.remove(i)
print(numbers)
</code></pre>
<p>It looks like we specifically allow this pattern... For example, we <em>do</em> flag an error for this:</p>
<pre><code class="language-python">numbers = list(range(1, 30))
for i in numbers:
    if i &lt; 20:
        numbers.remove(i + 1)
print(numbers)
</code></pre>
<p>The <code>enumerate(...)</code> variants we should probably catch.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-07-17 02:10</div>
            <div class="timeline-body"><p>I feel like we <em>should</em> still be flagging:</p>
<pre><code class="language-python">numbers = list(range(1, 30))
for i in numbers:
    if i &lt; 20:
        numbers.remove(i)
print(numbers)
</code></pre>
<p>But need to look at the source to understand why that exception was added.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-07-17 02:40</div>
            <div class="timeline-body"><p>Ok, I think I should remove that exception -- it seems misguided.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @charliermarsh by @charliermarsh on 2024-07-17 02:40</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/12365.html">astral-sh/ruff#12365</a> on 2024-07-17 14:15</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/12366.html">astral-sh/ruff#12366</a> on 2024-07-17 14:21</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2024-07-17 16:03</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:34:53 UTC
    </footer>
</body>
</html>
