<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rule B909 (loop-iterator-mutation) doesn't detect many kinds of list mutation - astral-sh/ruff #12164</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Rule B909 (loop-iterator-mutation) doesn&#x27;t detect many kinds of list mutation</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/issues/12164">#12164</a>
        opened by <a href="https://github.com/Boon-in-Oz">@Boon-in-Oz</a>
        on 2024-07-03 07:10
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Boon-in-Oz">@Boon-in-Oz</a></div>
            <div class="timeline-body">

<p>Hello and thank you for this excellent tool,</p>
<p>I&#x27;m running Ruff as a linter in VS Code with <code>select = [&quot;ALL&quot;]</code>, <code>preview = true</code> and only specific rules ignored. I&#x27;m still on Python 3.7.7, and using the Ruff 2024.28.0 extension.</p>
<p>I&#x27;ve found that B909 sometimes fires when I extend a list in a loop, but not when I remove or del an item from it. I&#x27;m not sure how the original Bugbear behaves in this case but in practice these seem very similar and any of them can cause bugs.</p>
<p>I can&#x27;t find any report of this in issues, searching for &quot;B909&quot;, &quot;mutation&quot;, &quot;iterator&quot;. The only issue I found was the original task to implement B038: <a href="https://github.com/astral-sh/ruff/issues/9511">astral-sh/ruff#9511</a></p>
<p>Repros:</p>
<p>This does not generate any linting errors:
(from https://stackoverflow.com/questions/6260089/strange-result-when-removing-item-from-a-list-while-iterating-over-it-in-python)</p>
<pre><code>numbers = list(range(1, 30))
for i in numbers:
    if i &lt; 20:
        numbers.remove(i)
print(numbers)
</code></pre>
<blockquote>
<p>[2, 4, 6, 8, 10, 12, 14, 16, 18, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29]</p>
</blockquote>
<p>But this triggers both B909 and PERF401:</p>
<pre><code>numbers = list(range(1, 30))
for i in numbers:
    if i &lt; 20:
        numbers.append(i + 20)
print(numbers)
</code></pre>
<p>This does not trigger B909 or PERF401 either (though it does correctly trigger FURB148 on the <code>enumerate</code> call)</p>
<pre><code>numbers = list(range(1, 30))
for i, _ in enumerate(numbers):
    if i &lt; 20:
        numbers.append(i)
</code></pre>
<p>Same for this:</p>
<pre><code>numbers = list(range(1, 30))
for i, _ in enumerate(numbers):
    if i &lt; 20:
        del numbers[i]
print(numbers)
</code></pre>
<blockquote>
<p>[2, 4, 6, 8, 10, 12, 14, 16, 18, 20, 22, 24, 26, 28]</p>
</blockquote>
<p>And this (don&#x27;t try this one, it&#x27;s an infinite loop)</p>
<pre><code>numbers = list(range(1, 30))
for i, _ in enumerate(numbers):
    if i &gt; 20:
        numbers.append(i)
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-07-17 02:08</div>
            <div class="timeline-body"><pre><code>numbers = list(range(1, 30))
for i in numbers:
    if i &lt; 20:
        numbers.remove(i)
print(numbers)
</code></pre>
<p>It looks like we specifically allow this pattern... For example, we <em>do</em> flag an error for this:</p>
<pre><code>numbers = list(range(1, 30))
for i in numbers:
    if i &lt; 20:
        numbers.remove(i + 1)
print(numbers)
</code></pre>
<p>The <code>enumerate(...)</code> variants we should probably catch.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-07-17 02:10</div>
            <div class="timeline-body"><p>I feel like we <em>should</em> still be flagging:</p>
<pre><code>numbers = list(range(1, 30))
for i in numbers:
    if i &lt; 20:
        numbers.remove(i)
print(numbers)
</code></pre>
<p>But need to look at the source to understand why that exception was added.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-07-17 02:40</div>
            <div class="timeline-body"><p>Ok, I think I should remove that exception -- it seems misguided.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to <a href="https://github.com/charliermarsh">@charliermarsh</a> by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-07-17 02:40</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-07-17 16:03</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 18:48:55 UTC
    </footer>
</body>
</html>
