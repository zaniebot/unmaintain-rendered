<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>How to pass the document version number for `workspace/executeCommand` request in Neovim? - astral-sh/ruff #14495</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>How to pass the document version number for <code>workspace/executeCommand</code> request in Neovim?</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/issues/14495">#14495</a>
        opened by <a href="https://github.com/matt-gardner">@matt-gardner</a>
        on 2024-11-20 17:13
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/matt-gardner">@matt-gardner</a></div>
            <div class="timeline-body"><!--
Thank you for taking the time to report an issue! We're glad to have you involved with Ruff.

If you're filing a bug report, please consider including the following information:

* List of keywords you searched for before creating this issue. Write them down here so that others can find this issue more easily and help provide feedback.
  e.g. "RUF001", "unused variable", "Jupyter notebook"
* A minimal code snippet that reproduces the bug.
* The command you invoked (e.g., `ruff /path/to/file.py --fix`), ideally including the `--isolated` flag.
* The current Ruff settings (any relevant sections from your `pyproject.toml`).
* The current Ruff version (`ruff --version`).
-->

<p>I just upgraded my LSP setup and packages, and I got a message that <code>ruff-lsp</code> was deprecated and I should use <code>ruff</code> instead.  After updated everything, a command that was previously working in my IDE is no longer working, and I can't figure out why not.  I suspect it might be something to do with my environment, but I've hit a wall trying to debug it.</p>
<p>This is what I'm trying to do, taken from docs / github somewhere from <code>ruff-lsp</code> (I'm using neovim as my IDE):</p>
<pre><code>map(&quot;n&quot;, &quot;&lt;leader&gt;fa&quot;, &quot;&quot;, {
  callback = function()
    vim.lsp.buf.execute_command {
      command = 'ruff.applyAutofix',
      arguments = {
        { uri = vim.uri_from_bufnr(0) },
      },
    }
  end,
  desc = &quot;Fix all (ruff-lsp, in python)&quot;
})
</code></pre>
<p>After updating, most functionality still works, but this command fails.  I see this in the logs:</p>
<pre><code>[DEBUG][2024-11-20 08:53:25] ...m/lsp/client.lua:565	&quot;LSP[ruff]&quot;	&quot;client.request&quot;	3	&quot;workspace/executeCommand&quot;	{  arguments = { {      uri = &quot;file:///some/path/to/a/file.py&quot;    } },  command = &quot;ruff.applyOrganizeImports&quot;}	&lt;function 1&gt;	1
[DEBUG][2024-11-20 08:53:25] .../vim/lsp/rpc.lua:282	&quot;rpc.send&quot;	{  id = 7,  jsonrpc = &quot;2.0&quot;,  method = &quot;workspace/executeCommand&quot;,  params = {    arguments = { {        uri = &quot;file:///some/path/to/a/file.py&quot;      } },    command = &quot;ruff.applyOrganizeImports&quot;  }}
[DEBUG][2024-11-20 08:53:25] .../vim/lsp/rpc.lua:404	&quot;rpc.receive&quot;	{  jsonrpc = &quot;2.0&quot;,  method = &quot;window/showMessage&quot;,  params = {    message = &quot;Ruff encountered a problem. Check the logs for more details.&quot;,    type = 1  }}
[DEBUG][2024-11-20 08:53:25] .../vim/lsp/rpc.lua:404	&quot;rpc.receive&quot;	{  error = {    code = -32602,    message = &quot;missing field `version`&quot;  },  id = 7,  jsonrpc = &quot;2.0&quot;}
</code></pre>
<p>I can't figure out what thing is missing a <code>version</code> field.  Is this an issue with my <code>.toml</code> settings?  With how I'm calling the LSP command from within the IDE?  Something else?  I don't know what changed in the updated version to make the previously-working configuration no longer work.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">fixes</span> added by @AlexWaygood on 2024-11-20 17:54</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">server</span> added by @AlexWaygood on 2024-11-20 17:54</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">fixes</span> removed by @MichaReiser on 2024-11-20 20:26</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-11-20 20:30</div>
            <div class="timeline-body"><p>I suspect that the problem is that ruff server expects a <code>version</code> argument, which is the version of the document but I don't know how to configure this in neovim. I'm sure @dhruvmanila can help you tomorrow morning. He's our neovim expert.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-11-21 06:19</div>
            <div class="timeline-body"><p>It's the table within the <code>arguments</code> table that's missing the <code>version</code> key:</p>
<pre><code class="language-lua">map(&quot;n&quot;, &quot;&lt;leader&gt;fa&quot;, &quot;&quot;, {
  callback = function()
    vim.lsp.buf.execute_command {
      command = 'ruff.applyAutofix',
      arguments = {
        { uri = vim.uri_from_bufnr(0), version = 0 },
      },
    }
  end,
  desc = &quot;Fix all (ruff-lsp, in python)&quot;
})
</code></pre>
<p>You can just set it to 0 for now. I'm not exactly sure of the original intent for this argument because it's currently only being used for the formatting edits (not others):</p>
<p>https://github.com/astral-sh/ruff/blob/f8c20258aec5148029da904fe1ea91c1c8f1be50/crates/ruff_server/src/server/api/requests/execute_command.rs#L79-L84</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-11-21 07:13</div>
            <div class="timeline-body"><blockquote>
<p>I'm not exactly sure of the original intent for this argument because it's currently only being used for the formatting edits (not others):</p>
</blockquote>
<p>The version allows clients to easily detect outdated server responses (unless they use another mechanism for it). We should use the version for organize imports and fixes too. For example:</p>
<ul>
<li>The user makes edit, hits save (version = 1)</li>
<li>The LSP sends a format and organize import request to the LSP</li>
<li>The format request finishes first and there are changes. The client applies the changes (version = 2) and it sends another organize import requests</li>
<li>The first organize import request finishes and there are changes. However, it's not safe to apply the edits now because the client is at version 2, but the edits sent by the server are for version 1.</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-11-21 07:23</div>
            <div class="timeline-body"><p>I see, thanks for the explanation.</p>
<p>I did a quick search as to any reference for document version in the lsp client code in Neovim and I found this: https://github.com/neovim/neovim/blob/07db909eb5ae2a559771068be64439eba394cd61/runtime/lua/vim/lsp/util.lua#L2165-L2171 which is then being used in multiple places across the client code.</p>
<p>I think that can be used to get the current version of the document on the client side which can then be passed to the server:</p>
<pre><code class="language-lua">map(&quot;n&quot;, &quot;&lt;leader&gt;fa&quot;, &quot;&quot;, {
  callback = function()
	local bufnr = vim.api.nvim_get_current_buf()
    vim.lsp.buf.execute_command {
      command = 'ruff.applyAutofix',
      arguments = {
        { 
		  uri = vim.uri_from_bufnr(bufnr),
          version = vim.lsp.util.buf_versions[bufnr],
		},
      },
    }
  end,
  desc = &quot;Fix all (ruff-lsp, in python)&quot;
})
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-11-21 07:25</div>
            <div class="timeline-body"><p>You could also assert that Neovim always keeps track of the versions as it should do so:</p>
<pre><code class="language-lua">        version = assert(
          vim.lsp.util.buf_versions[bufnr],
          ('No version found for buffer %d'):format(bufnr)
        )
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "ruff server fails when calling `ruff.applyAutofix` from IDE" to "How to pass the document version number for `executeCommand` request in Neovim?" by @dhruvmanila on 2024-11-21 07:26</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">question</span> added by @dhruvmanila on 2024-11-21 07:26</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "How to pass the document version number for `executeCommand` request in Neovim?" to "How to pass the document version number for `workspace/executeCommand` request in Neovim?" by @dhruvmanila on 2024-11-21 07:26</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/matt-gardner">@matt-gardner</a> on 2024-11-21 15:47</div>
            <div class="timeline-body"><p>Thanks a lot for your help!  I can confirm that setting <code>version</code> as suggested solves the issue for me; querying <code>vim.lsp.util.buf_versions</code> as described above worked without issue.  Setting it to 0 also worked initially, which I tried before finishing reading the comments, though I didn't keep editing to see if it would have failed later.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @matt-gardner on 2024-11-21 15:47</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 16:51:35 UTC
    </footer>
</body>
</html>
