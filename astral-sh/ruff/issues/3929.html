<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real-time code changes cannot be detected in Docker. (--watch) - astral-sh/ruff #3929</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Real-time code changes cannot be detected in Docker. (--watch)</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/ruff/issues/3929">#3929</a>
        opened by <a href="https://github.com/ngnl0">@ngnl0</a>
        on 2023-04-11 04:18
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/ngnl0">@ngnl0</a> on 2023-04-11 04:18</div>
            <div class="timeline-body"><p>Summary: Ruff check &lt;src.py&gt; --watch not working under Docker</p>
<p>Detailed information: I am developing using Docker+Poetry+Python, but I found the ruff check &lt;src.py&gt; --watch mode does not detect file changes in real time when running under Docker.</p>
<p>Reproduction steps: Create a container image based on python:3.11-bullseye and run it in sleep infinity mode, use ruff check <src> --watch to detect code changes in real time.</p>
<p>Version information: Ruff 0.0.261, Python 3.11-bullseye.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @charliermarsh on 2023-04-11 04:24</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-04-11 04:25</div>
            <div class="timeline-body"><p>Oh interesting, I've never tried this. To confirm my understanding: you're editing and saving files within the Docker container, and Ruff is also running within the Docker container. Is that right?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ngnl0">@ngnl0</a> on 2023-04-11 04:43</div>
            <div class="timeline-body"><blockquote>
<p>哦，有趣，我从来没有试过这个。为了确认我的理解：您正在 Docker 容器中编辑和保存文件，Ruff 也在 Docker 容器中运行。是对的吗？</p>
</blockquote>
<p>Yes, the first error was that I used poetry run ruff check in the docker container but it didn't work, so I suspected that it was poetry and abandoned poetry run and used the ruff check command directly in the container, and found that it still didn't work</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/evanrittenhouse">@evanrittenhouse</a> on 2023-04-12 03:41</div>
            <div class="timeline-body"><p>Hmm, I'm seeing errors pop up successfully when I try to repro this. I pulled down <code>python:3.11-bullseye</code>, then attached to the session, created <code>test.py</code>, and ran <code>ruff check --watch test.py</code>.  The linter started with no errors.</p>
<p>In a separate terminal, I edited <code>test.py</code> to have:</p>
<pre><code class="language-python">x = [&quot;1']
</code></pre>
<p>and <code>E999</code> (syntax error) popped up on my terminal running Ruff. I do notice that changing the file several times doesn't update the watch. Essentially, the watch is only picking up the first change made during its lifetime. Is this the behavior that you're seeing, or is your Ruff instance not picking up anything at all?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ngnl0">@ngnl0</a> on 2023-04-13 06:46</div>
            <div class="timeline-body"><blockquote>
<p>Hmm, I'm seeing errors pop up successfully when I try to repro this. I pulled down <code>python:3.11-bullseye</code>, then attached to the session, created <code>test.py</code>, and ran <code>ruff check --watch test.py</code>. The linter started with no errors.</p>
<p>In a separate terminal, I edited <code>test.py</code> to have:</p>
<pre><code class="language-python">x = [&quot;1']
</code></pre>
<p>and <code>E999</code> (syntax error) popped up on my terminal running Ruff. I do notice that changing the file several times doesn't update the watch. Essentially, the watch is only picking up the first change made during its lifetime. Is this the behavior that you're seeing, or is your Ruff instance not picking up anything at all?</p>
</blockquote>
<p>Yes. If you restart Ruff in the original terminal after making changes to the file, while ensuring that the Docker container is still running, then the --watch option will work normally until the container is paused or terminated. I'm very curious about the root cause of this bug. Later today, I will record a short video to reproduce the issue I encountered.Also, thank you very much for the solution to the problem.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/evanrittenhouse">@evanrittenhouse</a> on 2023-04-13 13:35</div>
            <div class="timeline-body"><p>That'd be great, thanks!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2023-04-13 13:46</div>
            <div class="timeline-body"><p>I'm unable to reproduce this. If possible, can you provide the <code>Dockerfile</code> content, command used to run the container and how are you editing the files (from the container or attaching a volume).</p>
<p><em><strong>These steps assumes your working directory to be: <code>/tmp/ruff-docker</code></strong></em></p>
<h3>Case 1: Editing the file inside the container</h3>
<ol>
<li><code>Dockerfile</code> content:</li>
</ol>
<pre><code class="language-dockerfile">FROM python:3.11-bullseye

WORKDIR /root/ruff-docker
RUN touch t.py
RUN python -m pip install --no-cache ruff

CMD [ &quot;ruff&quot;, &quot;check&quot;, &quot;--watch&quot;, &quot;t.py&quot; ]
</code></pre>
<ol start="2">
<li>Build the image using:</li>
</ol>
<pre><code class="language-console">docker build -t repro/ruff-docker:latest .
</code></pre>
<ol start="3">
<li>Run the container using:</li>
</ol>
<pre><code class="language-console">docker run --rm -it --name=ruff-docker repro/ruff-docker:latest
</code></pre>
<ol start="4">
<li>In a separate terminal access the docker container using:</li>
</ol>
<pre><code class="language-console">docker exec -it ruff-docker bash
</code></pre>
<ol start="5">
<li>Run this command to update the file which should throw a <code>SyntaxError</code>:</li>
</ol>
<pre><code class="language-console">echo &quot;import&quot; &gt; t.py
</code></pre>
<h3>Case 2: Attaching a volume, updating the file outside the container</h3>
<ol>
<li>Remove the following line from the <code>Dockerfile</code></li>
</ol>
<pre><code class="language-dockerfile">RUN touch t.py
</code></pre>
<ol start="2">
<li><p>Rebuild the image using step 2 mentioned above</p>
</li>
<li><p>Run the container using:</p>
</li>
</ol>
<pre><code class="language-console">docker run --rm -it -v /tmp/ruff-docker:/root/ruff-docker --name=ruff-docker repro/ruff-docker:latest
</code></pre>
<ol start="4">
<li>Update the content of <code>/tmp/ruff-docker/t.py</code></li>
</ol>
<hr />
<p>Stop the container using:</p>
<pre><code class="language-console">docker container stop ruff-docker
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/evanrittenhouse">@evanrittenhouse</a> on 2023-04-13 17:02</div>
            <div class="timeline-body"><blockquote>
<p>If possible, can you provide the Dockerfile content, command used to run the container and how are you editing the files (from the container or attaching a volume).</p>
</blockquote>
<p>Agreed with @dhruvmanila, this information would probably be more helpful than a video</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ngnl0">@ngnl0</a> on 2023-04-15 14:58</div>
            <div class="timeline-body"><p>Here is my dockerfile file</p>
<pre><code class="language-Dockerfile"># base image
FROM python:3.11-bullseye

# install poetry
RUN curl -sSL https://install.python-poetry.org | python3 -

# add poetry to the PATH environment variable
ENV PATH=&quot;/root/.local/bin:${PATH}&quot;

# install the zsh shell and set it as the default shell
RUN apt update &amp;&amp; \
    DEBIAN_FRONTEND=noninteractive apt install -y --no-install-recommends zsh &amp;&amp; \
    apt-get clean &amp;&amp; \
    rm -rf /var/lib/apt/lists/* &amp;&amp; \ 
    chsh -s $(which zsh)

# install oh-my-zsh (quiet install)
RUN curl -fsSL https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh -o install.sh &amp;&amp; \
    sh install.sh --unattended

# add poetry's complementary suggestions to oh-my-zsh
RUN mkdir /root/.oh-my-zsh/custom/plugins/poetry &amp;&amp; \
    poetry completions zsh &gt; /root/.oh-my-zsh/custom/plugins/poetry/_poetry
</code></pre>
<p>And my compose file</p>
<pre><code class="language-yaml">services:
  app:
    entrypoint:
    - sleep
    - infinity
    build:
      context: ./docker/app
      dockerfile: Dockerfile
    init: true
    volumes:
    - type: bind
      source: /var/run/docker.sock
      target: /var/run/docker.sock
</code></pre>
<p>I am sorry that due to some unforeseen circumstances, I was unable to fulfil my commitment in a timely manner.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ngnl0">@ngnl0</a> on 2023-04-15 14:58</div>
            <div class="timeline-body"><p>Here is a demo video of the error I encountered</p>
<p>https://user-images.githubusercontent.com/57034574/232232561-7da28f63-3de9-45af-8703-525f17e05aac.mp4</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/evanrittenhouse">@evanrittenhouse</a> on 2023-04-16 00:06</div>
            <div class="timeline-body"><p>Thanks for the information @ngnl0! That looks what I was experiencing as well.</p>
<p>Since the diagnostics are found initially, but not on update, I think that <a href="https://github.com/charliermarsh/ruff/blob/main/crates/ruff_cli/src/lib.rs#L210">this loop</a> isn't catching <code>rx.recv()</code> events. The <code>recv()</code> call <a href="https://docs.rs/crossbeam-channel/latest/crossbeam_channel/struct.Receiver.html#method.recv">blocks</a> until it sees another message, but throws if the channel closes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/evanrittenhouse">@evanrittenhouse</a> on 2023-04-16 17:47</div>
            <div class="timeline-body"><p>It seems like I can replicate this on my native Ubuntu 22.04 setup <strong>without</strong> running it in a Docker container. Very strange.</p>
<ol>
<li>Create empty file called <code>test.py</code></li>
<li>Run <code>ruff check test.py --watch</code></li>
<li>Edit <code>test.py</code> to <code>import math</code> - should trigger unused imports error</li>
<li>Unused import error comes in as expected</li>
<li>Remove <code>import math</code></li>
<li>Ruff doesn't update the screen - the unexpected import error remains.</li>
</ol>
<p>@dhruvmanila Are you able to repro that behavior? I'm surprised that it isn't working even on native Linux</p>
<p>E: Keeping for posterity, but it looks like Neovim actually emits events on swapfiles or something, not the actual <code>test.py</code> file.
~~On Linux, <code>notify</code> uses <a href="https://github.com/notify-rs/notify/blob/main/notify/src/lib.rs#L187"><code>INotifyWatcher</code></a>, monitoring <a href="https://man7.org/linux/man-pages/man7/inotify.7.html">inotify</a> syscalls, to read file system events. Using <a href="https://github.com/inotify-tools/inotify-tools"><code>inotify-tools</code></a> (used <code>inotifywait -m test.py</code> to monitor) to check the events myself, it seems like the events aren't getting emitted when I expect them to. They get emitted after the first save, but not after any subsequent ones.~~</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2023-04-17 17:37</div>
            <div class="timeline-body"><blockquote>
<p>I am sorry that due to some unforeseen circumstances, I was unable to fulfil my commitment in a timely manner.</p>
</blockquote>
<p>No need to be sorry, we're all doing this in our free time :)</p>
<blockquote>
<p>@dhruvmanila Are you able to repro that behavior? I'm surprised that it isn't working even on native Linux</p>
</blockquote>
<p>I'm unable to reproduce it using the mentioned steps :(
I'm on a mac machine with 13.0. I tried it in WSL as well but it works as expected.</p>
<p>Now, back to @ngnl0 issue -- using the provided <code>Dockerfile</code> and <code>docker-compose.yml</code> file, I tried the following but still unable to reproduce the error:</p>
<ol>
<li>Build the image</li>
<li>Run using <code>docker-compose up -d</code></li>
<li>Open VSCode and, using the official Docker extension, connect to the shell</li>
<li>Initialize a project with <code>poetry</code> and <code>ruff</code></li>
<li>Run <code>ruff</code> in watch mode</li>
<li>Update the file through VSCode</li>
</ol>
<p>A few things I'm noticing in the video:</p>
<ul>
<li>Running on Windows (will try this on a windows machine)</li>
<li>Using Docker dev environment -- If possible, could you provide a way to replicate the environment?</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/evanrittenhouse">@evanrittenhouse</a> on 2023-04-17 17:41</div>
            <div class="timeline-body"><p>I'm thinking it may be Windows. Docker will use the host kernel (in @ngnl0's case, Windows) to process kevents. I think there may be an issue with Windows trying to process the Linux-specific inotify event, but need to check into it more</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2023-04-17 18:17</div>
            <div class="timeline-body"><blockquote>
<p>I'm thinking it may be Windows.</p>
</blockquote>
<p>Yes, it is Windows.</p>
<p>I can reproduce this issue but some unexpected things are going on:</p>
<ul>
<li>The cache is behaving incorrectly as I'm getting diagnostics for the file content from an earlier revision.</li>
<li>The <code>--watch</code> flag works on the first save, then it stops refreshing from all the subsequent saves.</li>
</ul>
<p>I'm using the same dockerfile and compose content as mentioned by the author and running it using <code>docker-compose up -d</code>. I'm connected to the container using the shell and opened a test file in VSCode.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 01:30:06 UTC
    </footer>
</body>
</html>
