<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formatter undocumented deviation: comment on function arguments forces wrapping - astral-sh/ruff #7368</title>
    <link rel="stylesheet" href="../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../index.html">Back to index</a>
    </div>

    <h1>Formatter undocumented deviation: comment on function arguments forces wrapping</h1>

    <div class="meta">
        <span class="state state-open">Open</span>
        <a href="https://github.com/astral-sh/ruff/issues/7368">#7368</a>
        opened by <a href="https://github.com/andersk">@andersk</a>
        on 2023-09-13 20:57
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/andersk">@andersk</a> on 2023-09-13 20:57</div>
            <div class="timeline-body"><p>Input, unchanged under Black:</p>
<pre><code class="language-python">reasonably_long_function_name_to_force_three_line_formatting(
    a, b, c, d, e, f  # comment
)
</code></pre>
<p>Ruff:</p>
<pre><code class="language-python">reasonably_long_function_name_to_force_three_line_formatting(
    a,
    b,
    c,
    d,
    e,
    f,  # comment
)
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2023-09-13 21:16</div>
            <div class="timeline-body"><p>Thanks for the report!</p>
<p>We'll need to hear from someone else on the team, but I believe the idea here is that comments should either be regarding:</p>
<ul>
<li>All of the arguments and consequently present on a line before them</li>
<li>A single argument and consequently present on the line before it or trailing on the same line</li>
</ul>
<p>So I prefer this formatting because it encourages better comment placement.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">formatter</span> added by @zanieb on 2023-09-13 21:16</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/andersk">@andersk</a> on 2023-09-13 21:24</div>
            <div class="timeline-body"><p>In the <a href="https://github.com/zulip/zulip/blob/28597365da030d88c137adfc78156ae0b9c59cd4/zerver/lib/cache.py#L726-L728">actual code</a> that inspired this report, the comment is a <code>type: ignore</code> pragma and must be on the same line, so Ruff and mypy would together require duplicating the comment:</p>
<pre><code class="language-diff">             return self.cached_function(
-                *args, **kwargs  # type: ignore[arg-type] # might be unhashable
+                *args,  # type: ignore[arg-type] # might be unhashable
+                **kwargs,  # type: ignore[arg-type] # might be unhashable
             )
</code></pre>
<p>which is not the end of the world but seems suboptimal.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-09-13 21:27</div>
            <div class="timeline-body"><p>Thanks for testing the formatter @andersk!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2023-09-13 22:00</div>
            <div class="timeline-body"><p>Ah thanks for the additional context! I believe we have special handling for pragma comments in some places. In this case I remember discussing that it would be good to suggest <em>narrower</em> use of the pragmas as it's rare that you want it to apply to all of the arguments but I'm not sure the formatter should force you to duplicate like this (or break pragmas in general).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone "Formatter: Beta" by @MichaReiser on 2023-09-14 06:12</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">needs-decision</span> added by @MichaReiser on 2023-09-14 06:12</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-09-14 06:23</div>
            <div class="timeline-body"><p>The underlying technical reason for the splitting is that Ruff associates the comment with the <code>kwargs</code> argument and it splits the whole function to ensure the comment stays close to the <code>kwargs</code> argument (or we  may run into issues where comments wander from one node to the next the more code is collapsed).</p>
<p>We could improve our formatting to test if the last end of line comment is on the same line as the first argument (indicating that it uses the <code>a(\n\tb, c, d # arg\n)</code> layout, attach it as a dangling comment to arguments and render the comment right after the inner <code>arguments </code>group`.</p>
<p>The alternative is that you write this as:</p>
<pre><code class="language-python">             return self.cached_function(*args, **kwargs)  # type: ignore[arg-type] # might be unhashable
</code></pre>
<p>Ruff allows this formatting because pragma comments don't count toward the line width.</p>
<p>Regarding pragma comments. You can read more about the <a href="https://github.com/astral-sh/ruff/discussions/6670#discussion-5533063">decision the reasoning in this discussion</a>. The main challenge with pragma comments is that there's a tension between:</p>
<ol>
<li>Guaranteeing that the pragma comment doesn't move at all cost. This means that only limited formatting rules can be applied to attributed code (which is what Black does for type ignore)</li>
<li>Format the code as usual, at the cost that pragma comments may move</li>
</ol>
<p>I wanted to avoid 1. because it defeats the purpose of a formatter: Having consistent code formatting is the primary goal. We instead change the definition of pragma comments so that they don't count toward the line width do avoid the annoying case where you've written some code, add a pragma comment, and now the whole code re-flows (including your pragma comment) because it now exceeds the line width. You then have to move the comment and, if you're unlucky, it will trigger another reformat... which is very annoying.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Removed from milestone "Formatter: Beta" by @MichaReiser on 2023-09-27 15:56</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone "Formatter: Stable" by @MichaReiser on 2023-09-27 15:56</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">needs-decision</span> removed by @MichaReiser on 2023-09-27 15:57</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-09-27 15:57</div>
            <div class="timeline-body"><p>We're going to explore treating these as dangling and implementing special formatting. It's a known deviation, and not blocking for Beta, but we want to at least <em>try</em> to improve it and see how it goes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/henribru">@henribru</a> on 2023-10-24 20:21</div>
            <div class="timeline-body"><p>Is this the same issue that's making the <code>type: ignore</code> comment follow <code>None</code> here instead of the full expression? Ran into this a few times in our codebase. Though I ran into the version the OP mentions a lot more, it caused 64 Ruff errors from misplaced noqa comments after formatting.</p>
<p>https://black.vercel.app/?version=stable&amp;state=_Td6WFoAAATm1rRGAgAhARYAAAB0L-Wj4AKmAOxdAD2IimZxl1N_WlbvK5V9KEd0suDTtKdXyW-KHSefan1a-gnTsIBd_i7g2CHARB-DRfppQ8G8Ear_soAoOgGdRLZ8Od6lFlSonZzv7GuFtvxwFXtmT_90wnYxJXLNuTD2c3g0ZVM_jFV9YDTyvP-o8lPe_pQJx7Knkl8vNaac-zdyi5hcdcUS0mHilW73yIeIYoDw_Ba2rFZPXGwljEA0EoCbazw2DY8EA4lPVkDEeu1Q8h11L3Xu1JSHDRN-bbFlEPdq-jLPkQrDK3eCovkt9GT45eDhUVFZk5RoyZvJuX5xvRE3ZSQVFGGgMRFAAHmJjfhkn-EfAAGIAqcFAABf8gGdscRn-wIAAAAABFla</p>
<p>https://play.ruff.rs/62d5edc9-46dd-46b8-89bd-bc3f835a7d24?secondary=Format</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-10-24 23:40</div>
            <div class="timeline-body"><p>@henribru What you're seeing is related to Ruff handling <a href="https://docs.astral.sh/ruff/formatter/black/#trailing-end-of-line-comments">trailing end of line comments</a> and <a href="https://docs.astral.sh/ruff/formatter/black/#pragma-comments-are-ignored-when-computing-line-width">pragma comments</a> differently.</p>
<p>Pragma comments are challenging to get right, especially when migrating between the formatters. I expect them to be less of a problem when you only use ruff (or black, to the matter)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/henribru">@henribru</a> on 2023-10-25 05:23</div>
            <div class="timeline-body"><blockquote>
<p>@henribru What you're seeing is related to Ruff handling <a href="https://docs.astral.sh/ruff/formatter/black/#trailing-end-of-line-comments">trailing end of line comments</a> and <a href="https://docs.astral.sh/ruff/formatter/black/#pragma-comments-are-ignored-when-computing-line-width">pragma comments</a> differently.</p>
<p>Pragma comments are challenging to get right, especially when migrating between the formatters. I expect them to be less of a problem when you only use ruff (or black, to the matter)</p>
</blockquote>
<p>That makes more sense, but the descriptions there arguably don't cover my case, since the first one says &quot;This deviation only impacts unformatted code, in that Ruff's output should not deviate for code that has already been formatted by Black.&quot; and the second talks about Ruff <em>not</em> moving pragma comments. Perhaps those descriptions need to be expanded a bit.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/kdebrab">@kdebrab</a> on 2023-10-28 12:07</div>
            <div class="timeline-body"><p>I encountered the same issue with <code>noqa</code> pragma comments. E.g., following code is left as is by black, whereas ruff wraps the arguments:</p>
<pre><code class="language-python">def read_csv_file(
    sensor_fpath, start, end, header, timezone, convention  # noqa: ARG001
):
    pass
</code></pre>
<p>One could indeed argue that wrapping encourages <em>narrower</em> use of the pragma, but then it would be consequent to apply it also for other cases, like, e.g., the following example (which is left as is by both black and ruff):</p>
<pre><code class="language-python">def read_csv_file(sensor_fpath, start, end, header, timezone):  # noqa: ARG001
    pass
</code></pre>
<p>In my view, wrapping is undesired in both cases. Encouraging &quot;narrower&quot; use of pragma comments makes sense and could e.g. become a lint rule, but I don't think it should determine the wrapping behaviour of the formatter.</p>
<p>FYI, this is the only deviation I encountered (twice) when migrating four projects from black to ruff.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/henribru">@henribru</a> on 2023-11-02 06:55</div>
            <div class="timeline-body"><blockquote>
<p>We're going to explore treating these as dangling and implementing special formatting. It's a known deviation, and not blocking for Beta, but we want to at least <em>try</em> to improve it and see how it goes.</p>
</blockquote>
<p>Could it be added to the documented known deviations in the meantime? Or is that only intended for deviations that aren't expected to change?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-11-03 14:57</div>
            <div class="timeline-body"><p>We could implement a similar logic to https://github.com/astral-sh/ruff/pull/8431. Except that the <code>arguments</code> formatting &quot;steals&quot; the trailing end of line comments from the last argument.</p>
<p>https://github.com/astral-sh/ruff/blob/f4c7bff36b0cb8470e87aa597c2e35f92414f2b2/crates/ruff_python_formatter/src/other/arguments.rs#L106-L107</p>
<ul>
<li>Extract the last argument's end of line comments</li>
<li>Give the group a unique id (<code>.with_group_id(...)</code>, generate the id with <code>f.group_id</code>)</li>
<li>Format the comments with <code>if_group_breaks(&amp;trailing_comments(end_of_line_comments))</code> after <code>all_arguments</code> (inside of the group). This ensures that the comment sticks with the last argument if the group expands</li>
<li>Format the comments with <code>if_group_fits(&amp;trailing_comments(end_of_line_comments)).with_group_id(Some(group_id))</code> where <code>group_id</code> is the unique id created above. Formatting the comments outside of the group ensures that a trailing comment does not expand the group.</li>
</ul>
<p>Note:</p>
<ul>
<li>It is necessary to manually mark the comments as formatted before formatting the arguments, then mark the comments as unformatted again each time before calling <code>trailing_comments</code>.</li>
<li>We should avoid creating the <code>if_group_fits</code> and <code>if_group_breaks</code> IR elements if no trailing comments exist.</li>
</ul>
<p>One issue I see come up is that call formatting, arrays, etc would be different from parameter formatting:</p>
<pre><code class="language-python">def func(
	a, b, c, d  # a
): ...
</code></pre>
<p>We may need to make the same change for parameters if we want to be consistent.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/fruch">@fruch</a> on 2024-01-11 08:13</div>
            <div class="timeline-body"><p>I think it's something I'm hitting now</p>
<p>I was using the lint for some time, and add lots of noqa comments,
now I've introduced the formatter and getting those type of changes, which break the linter, cause command is in the wrong place:</p>
<pre><code class="language-diff">-    def compare_table_data(self, expected_table_data: list[dict[str, str]], table_name: str | None = None,  # noqa: PLR0913
-                           node: ScyllaNode = None, ignore_order: bool = True, consistent_read: bool = True,
-                           table_data: list[dict[str, str]] | None = None, **kwargs) -&gt; DeepDiff:
+    def compare_table_data(
+        self,
+        expected_table_data: list[dict[str, str]],
+        table_name: str | None = None,  # noqa: PLR0913
+        node: ScyllaNode = None,
+        ignore_order: bool = True,
+        consistent_read: bool = True,
+        table_data: list[dict[str, str]] | None = None,
+        **kwargs,
+    ) -&gt; DeepDiff:
</code></pre>
<p>I fixed it with the linter <code>ruff --fix --add-no-qa</code>, but now I have hundred of leftover comments</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-01-11 08:23</div>
            <div class="timeline-body"><p>@fruch this sounds related but is slightly different because the comment isn't at the end of the arguments line (it's after a specific argument). Unfortunately, it's challenging for the formatter to know to which node a suppression comment belongs without running the linter, which would be extremely slow.</p>
<p>Can you try using the <code>RUF100</code> rule. It should point out unused noqa comments and has a fix to remove them</p>
<pre><code class="language-bash">ruff  check --select=RUF100 &lt;path&gt;
</code></pre>
<p>And apply the fixes with</p>
<pre><code class="language-bash">ruff  check --fix --select=RUF100 &lt;path&gt;
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/10440.html">astral-sh/ruff#10440</a> on 2024-03-18 14:59</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/kurt-rhee">@kurt-rhee</a> on 2025-01-10 01:25</div>
            <div class="timeline-body"><p>I find this interesting because adding a comment is the only way that I can figure out how to force ruff to allow me to put function arguments on separate lines.  Is there a better way to do something like that?</p>
<pre><code class="language-py">if __name__ == &quot;__main__&quot;:
    commission_inverter(
        source_data=InverterDataSource.CEC,
        inverter_name=&quot;string&quot;,  # comment
    )
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/15388.html">astral-sh/ruff#15388</a> on 2025-01-10 01:27</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-01-10 07:19</div>
            <div class="timeline-body"><p>Adding a trailing comma forces Ruff to split the arguments on their own line. so this should be enough</p>
<pre><code class="language-py">if __name__ == &quot;__main__&quot;:
    commission_inverter(
        source_data=InverterDataSource.CEC,
        inverter_name=&quot;string&quot;,
    )
</code></pre>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:28:10 UTC
    </footer>
</body>
</html>
