<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[red-knot] Decide if `Type::to_instance` should return a `Result` - astral-sh/ruff #16302</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[red-knot] Decide if <code>Type::to_instance</code> should return a <code>Result</code></h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/issues/16302">#16302</a>
        opened by <a href="https://github.com/MichaReiser">@MichaReiser</a>
        on 2025-02-21 12:34
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a></div>
            <div class="timeline-body">Description
<p>There&#x27;s a TODO in <code>Types::to_instance</code>:</p>
<pre><code>// TODO: calling `.to_instance()` on any of these should result in a diagnostic,
// since they already indicate that the object is an instance of some kind:
</code></pre>
<p>We could consider returning a <code>Result</code> from <code>to_instance</code> so that it&#x27;s the caller&#x27;s responsibility, that the method is never called on a type that already is an instance or handle the error gracefully.</p>
<p>I remember that I replaced the fallback to <code>Type::Unknown</code> with a panic and it didn&#x27;t result in any failing tests. But @AlexWaygood mentioned that it is possible to trigger the panic with a custom/broken typeshed. I&#x27;m not sure if I care about that use case too much (existing with a useful panic message might be good enough?) to reduce ergonomics.</p>
<p>I&#x27;m leaning toward making it a <code>Result</code> unless it is too painful and can only ever happen with a rather fundamentally broken typeshed.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-02-21 12:35</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone &quot;Red Knot Q1 2025&quot; by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-02-21 12:35</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-02-21 12:48</div>
            <div class="timeline-body"><p>I&#x27;m currently leaning towards making <code>Type::to_instance()</code> return an <code>Option&lt;Type&gt;</code> and then doing something like this in <code>KnownClass::to_instance()</code>:</p>
<pre><code>impl KnownClass {
    pub fn to_instance(&amp;self, db: &amp;&#x27;db dyn Db) -&gt; Type&lt;&#x27;db&gt; {
        self
            .to_class_literal(db)
            .to_instance(db)
            .unwrap_or_else(|| {
                tracing::debug!(&quot;oh no, typeshed seems broken!&quot;);
                Type::unknown()
            })
    }
}
</code></pre>
<p>But I haven&#x27;t tried it yet to see how well it works</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-02-21 12:55</div>
            <div class="timeline-body"><p>I like that. Although I would make this at least a warning (and we may want to use a <code>Lazy</code> to avoid logging the same message a million times :D</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to <a href="https://github.com/AlexWaygood">@AlexWaygood</a> by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-02-24 18:50</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-03-11 16:42</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-03-11 16:42</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 18:49:33 UTC
    </footer>
</body>
</html>
