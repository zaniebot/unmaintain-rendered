<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rule UP040 incorrect fix when `TypeVar` is used multiple times - astral-sh/ruff #9904</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Rule UP040 incorrect fix when <code>TypeVar</code> is used multiple times</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/issues/9904">#9904</a>
        opened by <a href="https://github.com/ostr00000">@ostr00000</a>
        on 2024-02-09 02:52
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ostr00000">@ostr00000</a></div>
            <div class="timeline-body">Initial code
<p>This is code in stub file <code>decorators.pyi</code>:</p>
<pre><code>import logging
from collections.abc import Callable
from typing import TypeAlias, TypeVar

_BaseFun = TypeVar(&#x27;_BaseFun&#x27;, bound=Callable)
_Decorator: TypeAlias = Callable[[_BaseFun], _BaseFun]

def logCurrentTask(
    *, logger: logging.Logger | None = None, msg: str = &#x27;&#x27;
) -&gt; _Decorator: ...

</code></pre>
Ruff command
<p>After running ruff with command:</p>
<pre><code>ruff check ./decorators.pyi --isolated --select UP040 --target-version py312 --fix
</code></pre>
<p><code>TypeVar</code> is replaced to generic type alias.</p>
Code after fix
<p>The code after change is:</p>
<pre><code>import logging
from collections.abc import Callable
from typing import TypeAlias, TypeVar

_BaseFun = TypeVar(&#x27;_BaseFun&#x27;, bound=Callable)
type _Decorator[_BaseFun: Callable, _BaseFun: Callable] = Callable[[_BaseFun], _BaseFun]

def logCurrentTask(
    *, logger: logging.Logger | None = None, msg: str = &#x27;&#x27;
) -&gt; _Decorator: ...
</code></pre>
What is wrong
<p>Type alias <code>_Decorator</code> has two declarations with same name <code>_BaseFun</code> which is incorrect syntax.
The <a href="https://peps.python.org/pep-0695/#generic-type-alias">PEP 695</a> states:</p>
<blockquote>
<p>Type parameter names within a generic class, function, or type alias must be unique within that same class, function, or type alias</p>
</blockquote>
Possible fix
<p>Need to check for duplicates.</p>
Ruff version
<pre><code>ruff --version
</code></pre>
<p><code>ruff 0.2.1</code></p>
Additional thinking
<p>Not required to this issue, but it may be worth to notify user about remaining, old <code>TypeVar</code> or even remove it when rule UP040 is applying.
Although the variable is not used anymore, it remains in code, possibly unnoticed (I assume that currently only stubs are processed for this rule, but in future it may change).
The old object remains in global scope, which is not detected by most linters/type checkers.</p>


</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-02-09 02:53</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-02-09 02:53</div>
            <div class="timeline-body"><p>Interesting, thank you for the clear issue! We can fix this.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to <a href="https://github.com/charliermarsh">@charliermarsh</a> by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-02-09 03:10</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-02-09 03:14</div>
            <div class="timeline-body"><p>Put up a PR to fix here: <a href="https://github.com/astral-sh/ruff/pull/9905">astral-sh/ruff#9905</a></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-02-09 14:02</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 18:48:49 UTC
    </footer>
</body>
</html>
