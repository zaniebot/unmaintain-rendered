<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rule UP040 incorrect fix when `TypeVar` is used multiple times - astral-sh/ruff #9904</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Rule UP040 incorrect fix when <code>TypeVar</code> is used multiple times</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/issues/9904">#9904</a>
        opened by <a href="https://github.com/ostr00000">@ostr00000</a>
        on 2024-02-09 02:52
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ostr00000">@ostr00000</a></div>
            <div class="timeline-body"><h2>Initial code</h2>
<p>This is code in stub file <code>decorators.pyi</code>:</p>
<pre><code class="language-python">import logging
from collections.abc import Callable
from typing import TypeAlias, TypeVar

_BaseFun = TypeVar('_BaseFun', bound=Callable)
_Decorator: TypeAlias = Callable[[_BaseFun], _BaseFun]

def logCurrentTask(
    *, logger: logging.Logger | None = None, msg: str = ''
) -&gt; _Decorator: ...

</code></pre>
<h2>Ruff command</h2>
<p>After running ruff with command:</p>
<pre><code class="language-bash">ruff check ./decorators.pyi --isolated --select UP040 --target-version py312 --fix
</code></pre>
<p><code>TypeVar</code> is replaced to generic type alias.</p>
<h2>Code after fix</h2>
<p>The code after change is:</p>
<pre><code class="language-python">import logging
from collections.abc import Callable
from typing import TypeAlias, TypeVar

_BaseFun = TypeVar('_BaseFun', bound=Callable)
type _Decorator[_BaseFun: Callable, _BaseFun: Callable] = Callable[[_BaseFun], _BaseFun]

def logCurrentTask(
    *, logger: logging.Logger | None = None, msg: str = ''
) -&gt; _Decorator: ...
</code></pre>
<h2>What is wrong</h2>
<p>Type alias <code>_Decorator</code> has two declarations with same name <code>_BaseFun</code> which is incorrect syntax.
The <a href="https://peps.python.org/pep-0695/#generic-type-alias">PEP 695</a> states:</p>
<blockquote>
<p>Type parameter names within a generic class, function, or type alias must be unique within that same class, function, or type alias</p>
</blockquote>
<h2>Possible fix</h2>
<p>Need to check for duplicates.</p>
<h2>Ruff version</h2>
<pre><code class="language-bash">ruff --version
</code></pre>
<p><code>ruff 0.2.1</code></p>
<h2>Additional thinking</h2>
<p>Not required to this issue, but it may be worth to notify user about remaining, old <code>TypeVar</code> or even remove it when rule UP040 is applying.
Although the variable is not used anymore, it remains in code, possibly unnoticed (I assume that currently only stubs are processed for this rule, but in future it may change).
The old object remains in global scope, which is not detected by most linters/type checkers.</p>
<!--
Thank you for taking the time to report an issue! We're glad to have you involved with Ruff.

If you're filing a bug report, please consider including the following information:

* A minimal code snippet that reproduces the bug.
* The command you invoked (e.g., `ruff /path/to/file.py --fix`), ideally including the `--isolated` flag.
* The current Ruff settings (any relevant sections from your `pyproject.toml`).
* The current Ruff version (`ruff --version`).
-->

</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @charliermarsh on 2024-02-09 02:53</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-02-09 02:53</div>
            <div class="timeline-body"><p>Interesting, thank you for the clear issue! We can fix this.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @charliermarsh by @charliermarsh on 2024-02-09 03:10</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-02-09 03:14</div>
            <div class="timeline-body"><p>Put up a PR to fix here: https://github.com/astral-sh/ruff/pull/9905</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2024-02-09 14:02</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 16:49:35 UTC
    </footer>
</body>
</html>
