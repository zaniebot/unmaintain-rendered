<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>false positive syntax errors when using syntax for newer python version in `.pyi` files - astral-sh/ruff #21677</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>false positive syntax errors when using syntax for newer python version in <code>.pyi</code> files</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/ruff/issues/21677">#21677</a>
        opened by <a href="https://github.com/DetachHead">@DetachHead</a>
        on 2025-11-28 13:42
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/DetachHead">@DetachHead</a></div>
            <div class="timeline-body">Summary
<pre><code># foo.pyi

def foo[T](): ...

type Foo = int
</code></pre>
<pre><code>Cannot use type parameter lists on Python 3.8 (syntax was added in Python 3.12)
Cannot use `type` alias statement on Python 3.8 (syntax was added in Python 3.12)
</code></pre>
<p>since <code>.pyi</code> files are not executed at runtime, they should be able to use newer syntax than the target python version</p>
Version
<p>0.14.6</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-11-28 14:13</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-11-28 14:15</div>
            <div class="timeline-body"><p>Thanks for reporting. Yes, that makes sense. @ntBre I think this would be great to fix unless a contributor gets to it first :)</p>
<p>One option is to ensure we always pass the latest Python version to <code>parse</code> if the file is a <code>pyi</code> file, or we add a new option to <code>ParseOptions</code> to signify whether we&#x27;re parsing a stub file (requires reviewing all call sites)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">help wanted</span> added by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-11-28 14:15</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/11happy">@11happy</a> on 2025-11-30 12:29</div>
            <div class="timeline-body"><p>I have linked the PR fixing it.
Thank you : )</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-11-30 12:48</div>
            <div class="timeline-body"><blockquote>
<p>since <code>.pyi</code> files are not executed at runtime, they should be able to use newer syntax than the target python version</p>
</blockquote>
<p>while this is true, the most popular type checker (mypy) currently uses the Python <code>ast</code> module to parse all Python files, including <code>.pyi</code> files. If mypy is invoked using Python 3.11, it won&#x27;t be able to parse syntax introduced in Python 3.12. So if a <code>.pyi</code> file uses Python 3.12+ syntax, it won&#x27;t be usable with mypy unless you use Python 3.12 or newer to invoke mypy. I don&#x27;t think that&#x27;s what most authors of stubs would want: I think most authors of stubs would want their stubs to be legible by all type checkers, regardless of what Python version you use to invoke that type checker.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/DetachHead">@DetachHead</a> on 2025-11-30 13:39</div>
            <div class="timeline-body"><p>the way i see it, mypy&#x27;s days as &quot;the most popular type checker&quot; are numbered, so ruff should not be held back by it. ruff should be able to support projects that don&#x27;t care about supporting mypy anymore. i would think any project that cares about mypy support on older python versions versions would already be running mypy with that version of python in their CI anyway, so i don&#x27;t think it&#x27;s ruff&#x27;s responsibility to account for this. but i guess this behavior could be configurable if this is really a concern?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-11-30 13:46</div>
            <div class="timeline-body"><p>As a developer of ty, I obviously hope that ty succeeds :-)</p>
<p>And as a developer of typeshed, I would of <em>course</em> love to be able to use the latest and greatest Python syntax when writing stubs!</p>
<p>But as an author of Python libraries, and a developer of typeshed, I would very much want any stubs I write to work with whatever type checker a user of my library might be using. Whether you&#x27;re a fan of mypy or not, the fact of the matter is that for many users that type checker is currently mypy, and it will continue to be mypy for many users for many years to come, even if it loses its spot as the <em>most</em> popular type checker.</p>
<p><a href="https://github.com/python/mypy/issues/19776">There has been talk over at mypy</a> of switching to a new parser (possibly the Ruff parser!), so it would be interesting to revisit this discussion if and when that happens. But unless and until that happens, I would definitely at least want to be able to opt into these syntax errors on <code>.pyi</code> files (and making them opt-out makes most sense IMHO).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-11-30 14:45</div>
            <div class="timeline-body"><blockquote>
<p>(and making them opt-out makes most sense IMHO)</p>
</blockquote>
<p>which they already are. Or more specifically, you can opt-out of the syntax errors by using <a href="https://docs.astral.sh/ruff/settings/#per-file-target-version"><code>per-file-target-version</code></a> and setting it to 3.14 for all <code>pyi</code> files</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> removed by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-12-01 07:23</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">help wanted</span> removed by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-12-01 07:23</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">needs-decision</span> added by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-12-01 07:23</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/flying-sheep">@flying-sheep</a> on 2025-12-19 09:10</div>
            <div class="timeline-body"><p>A few points:</p>
<ul>
<li>I don’t know if that only applies to ty, but at least ty already unconditionally allows <code>UnionType</code> syntax: <a href="https://github.com/astral-sh/ty/issues/1525">astral-sh/ty#1525</a></li>
<li>ty doesn’t have a <code>per-file-target-version</code> setting, right?</li>
</ul>
<p>I’m personally interested in making the following <code>.pyi</code> file content parse without either Ruff or ty complaining in a project with <code>requires-python = &#x27;&gt;= 3.12&#x27;</code>:</p>
<pre><code>class Spam[E = Eggs]: ...
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-12-19 09:13</div>
            <div class="timeline-body"><blockquote>
<p>at least ty already unconditionally allows <code>UnionType</code> syntax: <a href="https://github.com/astral-sh/ty/issues/1525">PEP 604 union syntax should be allowed in stubs (<code>.pyi</code>) on all Python versions ty#1525</a></p>
</blockquote>
<p>That&#x27;s somewhat different because it can be parsed by the Python <code>ast</code> module on all versions of Python. It&#x27;s not actually new <em>syntax</em>, formally speaking (it fails at runtime on older Python versions, but the CPython parser can <em>parse</em> it on older Python versions)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/flying-sheep">@flying-sheep</a> on 2025-12-19 09:19</div>
            <div class="timeline-body"><p>That makes sense. So Ruff has a workaround, how to make this work in <code>ty</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-12-19 11:33</div>
            <div class="timeline-body"><blockquote>
<p>So Ruff has a workaround, how to make this work in <code>ty</code>?</p>
</blockquote>
<p>You&#x27;re correct that ty doesn&#x27;t have a <code>per-file-target-version</code> setting, and it wouldn&#x27;t be realistic to implement such a setting for a multifile analysis tool like a type checker.</p>
<p>It would be nice if it was possible to suppress syntax errors -- then you could just add a <code>per-file-ignore</code> for this specific syntax error for all <code>.pyi</code> files, if you&#x27;re happy to accept that your stub files are likely not to work with certain type checkers.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-12-19 11:47</div>
            <div class="timeline-body"><p>I&#x27;d prefer an option to either disable this behavior or changing the syntax version per file over making syntax errors suppressable</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-12-19 11:53</div>
            <div class="timeline-body"><p>I&#x27;d be okay with an <code>allow-new-stub-syntax = true</code> configuration setting for ty. But I still don&#x27;t really understand the opposition to making some syntax errors suppressable. I think we&#x27;ve seen in several user reports at this point that users expect these errors to be suppressable just like any other Ruff/ty diagnostic, and it seems like a much more generalised, versatile solution than introducing new configuration settings just for this. I don&#x27;t understand how it harms the user experience in any way to make them suppressable, even if it&#x27;s not something that most users should ideally ever need.</p>
<p>Anyway, I don&#x27;t feel that strongly. I&#x27;m okay with a new configuration setting for ty if you think that&#x27;s the way to go here.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-12-19 11:56</div>
            <div class="timeline-body"><p>We&#x27;ve only had very few reports and some of them were related to bugs in the parser.</p>
<p>It&#x27;s also easier to have a single config flag than to configure a handful of rules for what should be allowed in the pyi files.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/flying-sheep">@flying-sheep</a> on 2025-12-19 17:58</div>
            <div class="timeline-body"><p>Question is if there is any other use case where different subsets of a project&#x27;s files are supposed to be parsed with different settings and then typechecked together.</p>
<p>Apart from monorepos I can&#x27;t think of anything, and there, file subsets are subprojects, so parsing is entirely defined by <code>requires-python</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-12-19 18:13</div>
            <div class="timeline-body"><p>I think it&#x27;s reasonably common to have a <code>scripts/</code> directory that requires a newer Python version to the &quot;production&quot; directories elsewhere in your project. But I would generally just invoke the type checker on those directories separately. If you&#x27;re using ty as an LSP, I guess you&#x27;d want something like <a href="https://github.com/astral-sh/ty/issues/1554">astral-sh/ty#1554</a>? But I wouldn&#x27;t usually have a separate pyproject.toml file in my <code>scripts/</code> directory</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/flying-sheep">@flying-sheep</a> on 2025-12-19 18:27</div>
            <div class="timeline-body"><p>Right, instead of a <code>pyproject.toml</code>, scripts would have an <a href="https://packaging.python.org/en/latest/specifications/inline-script-metadata/">inline script metadata</a> block that could define the <code>requires-python</code>.</p>
<p>I haven’t checked how monorepo support works for uv/ruff. Is it just adding more <code>pyproject.toml</code> files? If so, inline script metadata should work the same!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/flying-sheep">@flying-sheep</a> on 2026-01-16 09:12</div>
            <div class="timeline-body"><p>OK, so it seems like the plan could be</p>
<p>independent task 1</p>
<ul>
<li>add subproject support to ty</li>
<li>treat files with inline script metadata as single-file subprojects in ty</li>
</ul>
<p>independent task 2</p>
<ul>
<li>parse .pyi files with the newest syntax in both ruff and ty<ul>
<li><strong>maybe</strong> add a boolean setting called <code>allow-new-stub-syntax</code> (default <code>true</code>) for projects that want to <code>ast.parse</code> their .pyi files for some reason?</li>
</ul>
</li>
</ul>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 18:50:39 UTC
    </footer>
</body>
</html>
