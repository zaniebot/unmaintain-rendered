<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[bug] RUF010 autofix bug - astral-sh/ruff #4927</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[bug] RUF010 autofix bug</h1>

    <div class="meta">
        <span class="state state-closed">Closed</span>
        <a href="https://github.com/astral-sh/ruff/issues/4927">#4927</a>
        opened by <a href="https://github.com/smackesey">@smackesey</a>
        on 2023-06-07 13:05
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/smackesey">@smackesey</a> on 2023-06-07 13:05</div>
            <div class="timeline-body"><p>On upgrading to 0.0.271, running <code>ruff --fix</code> is giving a lot of errors on trying to fix f strings. Here's an example string that triggers the error:</p>
<pre><code>f&quot;Member of tuple mismatches type at index {i}. Expected {of_shape_i}. Got &quot;
f&quot;{repr(obj)} of type {type(obj)}.{additional_message}&quot;
</code></pre>
<p>And here's the full output, which references many more examples</p>
<pre><code>error: Failed to create fix for ExplicitFStringTypeConversion: Failed to extract expression from source
error: Failed to create fix for ExplicitFStringTypeConversion: Failed to extract expression from source
error: Failed to create fix for ExplicitFStringTypeConversion: Failed to extract expression from source
error: Failed to create fix for ExplicitFStringTypeConversion: Failed to extract expression from source
error: Failed to create fix for ExplicitFStringTypeConversion: Failed to extract expression from source
error: Failed to create fix for ExplicitFStringTypeConversion: Failed to extract expression from source
error: Failed to create fix for ExplicitFStringTypeConversion: Failed to extract expression from source
error: Failed to create fix for ExplicitFStringTypeConversion: Failed to extract expression from source
error: Failed to create fix for ExplicitFStringTypeConversion: Failed to extract expression from source
error: Failed to create fix for ExplicitFStringTypeConversion: Failed to extract expression from source
error: Failed to create fix for ExplicitFStringTypeConversion: Failed to extract expression from source
error: Failed to create fix for ExplicitFStringTypeConversion: Failed to extract expression from source
error: Failed to create fix for ExplicitFStringTypeConversion: Failed to extract expression from source
error: Failed to create fix for ExplicitFStringTypeConversion: Failed to extract expression from source
error: Failed to create fix for ExplicitFStringTypeConversion: Failed to extract expression from source
error: Failed to create fix for ExplicitFStringTypeConversion: Failed to extract expression from source
error: Failed to create fix for ExplicitFStringTypeConversion: Failed to extract expression from source
error: Failed to create fix for ExplicitFStringTypeConversion: Failed to extract expression from source
error: Failed to create fix for ExplicitFStringTypeConversion: Failed to extract expression from source
error: Failed to create fix for ExplicitFStringTypeConversion: Failed to extract expression from source
error: Failed to create fix for ExplicitFStringTypeConversion: Failed to extract expression from source
error: Failed to create fix for ExplicitFStringTypeConversion: Failed to extract expression from source
error: Failed to create fix for ExplicitFStringTypeConversion: Failed to extract expression from source
error: Failed to create fix for ExplicitFStringTypeConversion: Failed to extract expression from source
error: Failed to create fix for ExplicitFStringTypeConversion: Failed to extract expression from source
python_modules/dagster/dagster/_check/__init__.py:1587:24: RUF010 Use conversion in f-string
python_modules/dagster/dagster/_check/__init__.py:1709:18: RUF010 Use conversion in f-string
python_modules/dagster/dagster/_check/__init__.py:1709:56: RUF010 Use conversion in f-string
python_modules/dagster/dagster/_check/__init__.py:1709:77: RUF010 Use conversion in f-string
python_modules/dagster/dagster/_check/__init__.py:1724:69: RUF010 Use conversion in f-string
python_modules/dagster/dagster/_check/__init__.py:1729:68: RUF010 Use conversion in f-string
python_modules/dagster/dagster/_check/__init__.py:1745:83: RUF010 Use conversion in f-string
python_modules/dagster/dagster/_check/__init__.py:1771:54: RUF010 Use conversion in f-string
python_modules/dagster/dagster/_check/__init__.py:1798:21: RUF010 Use conversion in f-string
python_modules/dagster/dagster/_check/__init__.py:1820:77: RUF010 Use conversion in f-string
python_modules/dagster/dagster/_check/__init__.py:1821:21: RUF010 Use conversion in f-string
python_modules/dagster/dagster/_check/__init__.py:1827:35: RUF010 Use conversion in f-string
python_modules/dagster/dagster/_core/definitions/assets.py:1154:20: RUF010 Use conversion in f-string
python_modules/dagster/dagster/_core/definitions/assets.py:1269:40: RUF010 Use conversion in f-string
python_modules/dagster/dagster/_core/definitions/multi_dimensional_partitions.py:342:49: RUF010 Use conversion in f-string
python_modules/dagster/dagster/_core/definitions/multi_dimensional_partitions.py:343:49: RUF010 Use conversion in f-string
python_modules/dagster/dagster/_core/definitions/reconstruct.py:605:45: RUF010 Use conversion in f-string
python_modules/dagster/dagster/_core/definitions/resource_requirement.py:227:31: RUF010 Use conversion in f-string
python_modules/dagster/dagster/_core/definitions/resource_requirement.py:229:21: RUF010 Use conversion in f-string
python_modules/dagster/dagster/_core/execution/execute_in_process.py:135:45: RUF010 Use conversion in f-string
python_modules/dagster/dagster/_core/execution/plan/compute.py:201:53: RUF010 Use conversion in f-string
python_modules/dagster/dagster/_core/execution/plan/compute.py:202:24: RUF010 Use conversion in f-string
python_modules/dagster/dagster/_core/execution/with_resources.py:90:24: RUF010 Use conversion in f-string
python_modules/dagster/dagster/_grpc/server.py:1041:84: RUF010 Use conversion in f-string
python_modules/libraries/dagstermill/dagstermill/factory.py:329:29: RUF010 Use conversion in f-string
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-06-07 13:21</div>
            <div class="timeline-body"><p>Interesting, thanks. Will take a look at these today.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @charliermarsh on 2023-06-07 13:21</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-06-07 13:28</div>
            <div class="timeline-body"><p>Anyone is welcome to beat me to it :)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @charliermarsh by @charliermarsh on 2023-06-07 21:22</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/qdegraaf">@qdegraaf</a> on 2023-06-07 21:34</div>
            <div class="timeline-body"><p>Having a quick look but can't replicate. Both running ruff 0.0.271 after installing it through pip and running:</p>
<pre><code class="language-bash">cargo run -p ruff_cli -- check --fix test.py --select RUF010 --no-cache
</code></pre>
<p>on up to date main just fix the snippet.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-06-07 21:49</div>
            <div class="timeline-body"><p>I'm able to repro by running on:</p>
<pre><code class="language-py">(
    f&quot;Member of tuple mismatches type at index {i}. Expected {of_shape_i}. Got &quot;
    f&quot;{repr(obj)} of type {type(obj)}.{additional_message}&quot;
)
</code></pre>
<p>I'm assuming that we're not matching properly against implicit concatenations.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-06-07 21:55</div>
            <div class="timeline-body"><p>I think I have a fix for this.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/qdegraaf">@qdegraaf</a> on 2023-06-07 21:57</div>
            <div class="timeline-body"><blockquote>
<p>I'm able to repro by running on:</p>
<pre><code class="language-python">(
    f&quot;Member of tuple mismatches type at index {i}. Expected {of_shape_i}. Got &quot;
    f&quot;{repr(obj)} of type {type(obj)}.{additional_message}&quot;
)
</code></pre>
<p>I'm assuming that we're not matching properly against implicit concatenations.</p>
</blockquote>
<p>Yeah that triggers it here too. Let me know if you need an extra pair of hands on the fix.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-06-07 22:01</div>
            <div class="timeline-body"><p>I'd appreciate it if you have time. What I was planning to do was artificially parenthesize the expression when passing to the LibCST parser:</p>
<pre><code class="language-diff">‚ùØ git diff HEAD
diff --git a/crates/ruff/src/rules/ruff/rules/explicit_f_string_type_conversion.rs b/crates/ruff/src/rules/ruff/rules/explicit_f_string_type_conversion.rs
index 18e93ab3c..f276b837b 100644
--- a/crates/ruff/src/rules/ruff/rules/explicit_f_string_type_conversion.rs
+++ b/crates/ruff/src/rules/ruff/rules/explicit_f_string_type_conversion.rs
@@ -1,11 +1,11 @@
 use anyhow::{bail, Result};
 use rustpython_parser::ast::{self, Expr, Ranged};

-use crate::autofix::codemods::CodegenStylist;
 use ruff_diagnostics::{AlwaysAutofixableViolation, Diagnostic, Edit, Fix};
 use ruff_macros::{derive_message_formats, violation};
 use ruff_python_ast::source_code::{Locator, Stylist};

+use crate::autofix::codemods::CodegenStylist;
 use crate::checkers::ast::Checker;
 use crate::cst::matchers::{
     match_call_mut, match_expression, match_formatted_string, match_formatted_string_expression,
@@ -55,7 +55,8 @@ fn fix_explicit_f_string_type_conversion(
     // Replace the call node with its argument and a conversion flag.
     let range = expr.range();
     let content = locator.slice(range);
-    let mut expression = match_expression(content)?;
+    let parenthesized_content = format!(&quot;({})&quot;, content);
+    let mut expression = match_expression(&amp;parenthesized_content)?;
     let formatted_string = match_formatted_string(&amp;mut expression)?;
</code></pre>
<p>Right now, we're passing this literal, which isn't a valid expression (it has to be parenthesized):</p>
<pre><code class="language-py">f&quot;Member of tuple mismatches type at index {i}. Expected {of_shape_i}. Got &quot;
    f&quot;{repr(obj)} of type {type(obj)}.{additional_message}&quot;
</code></pre>
<p>We then need to do two things:</p>
<ol>
<li>Strip the parentheses that we added artificially.</li>
<li>Handle the case of implicitly concatenated substrings, which LibCST represents with a different node (<code>ConcatenatedString</code>). We assume that LibCST gives us a <code>FormattedString</code>. We need to handle both cases.</li>
</ol>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/qdegraaf">@qdegraaf</a> on 2023-06-07 22:06</div>
            <div class="timeline-body"><p>I'll have a look, see how far I get</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/4947.html">astral-sh/ruff#4947</a> on 2023-06-08 01:57</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2023-06-08 02:04</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:34:50 UTC
    </footer>
</body>
</html>
