<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add an `--exit-non-zero-on-fix` equivalent to the formatter. - astral-sh/ruff #8191</title>
    <link rel="stylesheet" href="../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../index.html">Back to index</a>
    </div>

    <h1>Add an `--exit-non-zero-on-fix` equivalent to the formatter.</h1>

    <div class="meta">
        <span class="state state-closed">Closed</span>
        <a href="https://github.com/astral-sh/ruff/issues/8191">#8191</a>
        opened by <a href="https://github.com/TheReverend403">@TheReverend403</a>
        on 2023-10-25 00:40
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/TheReverend403">@TheReverend403</a> on 2023-10-25 00:40</div>
            <div class="timeline-body"><p>Title says it all really. <code>--exit-non-zero-on-change</code>? I think this would be useful when using tools like pre-commit with CI in the same way as the checker's <code>--exit-non-zero-on-fix</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">formatter</span> added by @MichaReiser on 2023-10-25 00:56</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-10-25 00:57</div>
            <div class="timeline-body"><p>How does your setup look like? Do you use <code>--diff</code> or <code>--check</code>? The formatter already exits with 0 when not using <code>--check</code> or <code>--diff</code>.</p>
<p>How do you detect changes when using <code>ruff</code> in CI when using <code>--diff</code> or <code>--check</code> when it exists with 0?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/TheReverend403">@TheReverend403</a> on 2023-10-25 01:13</div>
            <div class="timeline-body"><blockquote>
<p>How does your setup look like?</p>
</blockquote>
<p>https://github.com/TheReverend403/cappuccino/blob/main/.pre-commit-config.yaml#L34-L44</p>
<blockquote>
<p>Do you use --diff or --check? The formatter already exits with 0 when not using --check or --diff.</p>
</blockquote>
<p>I already use <code>--check</code> and I know the formatter exits 0 without it. What I'm suggesting is a way to make it format <em>and</em> exit non-zero if anything changed in the same way as <code>check --fix --exit-non-zero-on-fix</code>. The problem with using <code>--check</code> alone is that if you run <code>pre-commit</code> locally, you first have to run <code>pre-commit</code> to see that things need formatting, then run <code>ruff format</code> separately without <code>--check</code>. I can't just remove <code>--check</code> because then when the CI runs <code>pre-commit</code>, it won't fail if somebody committed code without first formatting it, it will just quietly make the changes which is not useful on CI where those changes won't persist.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-10-25 01:16</div>
            <div class="timeline-body"><blockquote>
<p>I already use <code>--check</code> and I know the formatter exits 0 without it. What I'm suggesting is a way to make it format <em>and</em> exit non-zero if anything changed in the same way as <code>check --fix --exit-non-zero-on-fix</code>.</p>
</blockquote>
<p><code>ruff format --check</code> has different semantics than <code>ruff check --fix</code>. It only checks if files would be reformatted but it doesn't change the files on disk. You want to use <code>ruff format</code> (without check) if you want to format AND persist the files.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/TheReverend403">@TheReverend403</a> on 2023-10-25 01:20</div>
            <div class="timeline-body"><p>Updated my previous comment.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-10-25 02:12</div>
            <div class="timeline-body"><p>Oh sorry. I misunderstood you. If I understand you correctly, you're asking that <code>ruff format --check</code> exits with a non-zero exit code if it would reformat any files but it would also write the changes back to disk so that running <code>ruff format</code> isn't necessary locally.</p>
<p>I'm a bit torn where to integrate this functionality best. We could either to <code>ruff format --exit-non-zero-on-fix</code> (undecided on the name of the flag) without using check. However, the option would be incompatible when using with <code>--check</code> or <code>--diff</code>.</p>
<p>Did you use black before? If so, how did your setup look like?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2023-10-25 03:01</div>
            <div class="timeline-body"><blockquote>
<p>We could either to ruff format --exit-non-zero-on-fix (undecided on the name of the flag) without using check. However, the option would be incompatible when using with --check or --diff.</p>
</blockquote>
<p>This seems like a reasonable approach if we do implement it. It isn't incompatible with <code>--check</code> though, it just has no effect. With <code>--diff</code> I don't know our exit code behavior.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone "Formatter: Stable" by @MichaReiser on 2023-10-25 03:05</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/TheReverend403">@TheReverend403</a> on 2023-10-25 09:57</div>
            <div class="timeline-body"><blockquote>
<p>If I understand you correctly, you're asking that <code>ruff format --check</code> exits with a non-zero exit code if it would reformat any files but it would also write the changes back to disk so that running <code>ruff format</code> isn't necessary locally.</p>
</blockquote>
<p>Exactly, but as an additional flag rather than changing <code>--check</code> so as to avoid breaking everyone's current CI workflows. üòè</p>
<blockquote>
<p>Did you use black before? If so, how did your setup look like?</p>
</blockquote>
<p><a href="https://github.com/TheReverend403/cappuccino/blob/835b34d92e2c83d9e1766d383ece40cb7456c909/.pre-commit-config.yaml#L12-L16">I used black</a>, just not with this behaviour. It was actually ruff's own <code>--exit-non-zero-on-fix</code> that gave me this idea for the formatter.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/henryiii">@henryiii</a> on 2023-10-26 13:54</div>
            <div class="timeline-body"><p>FYI, <code>--exit-non-zero-on-fix</code> in the checker isn't required in pre-commit; pre-commit checks for changed files.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2023-10-26 13:58</div>
            <div class="timeline-body"><p>Hm so <code>ruff format</code> is all you should need in pre-commit? Having pre-commit tooling check for differences makes a lot more sense than adding more exit code flags to Ruff.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/henryiii">@henryiii</a> on 2023-10-26 13:59</div>
            <div class="timeline-body"><p>Yes, a non-zero exit code has always only been required if there were no file changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/TheReverend403">@TheReverend403</a> on 2023-10-26 14:14</div>
            <div class="timeline-body"><p>Oh shit you're right. How did I overlook the fact that pre-commit has its own exit code? Idiot. üòî</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2023-10-26 15:29</div>
            <div class="timeline-body"><p>Good to hear it works :) I don't think this is justified then, I'm not sure what use-case would require this behavior.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @zanieb on 2023-10-26 15:29</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/noamraph">@noamraph</a> on 2023-12-25 19:42</div>
            <div class="timeline-body"><p>@zanieb I do have a need for this, so perhaps this could be re-opened? My use case: I can't use pre-commit, because my project is a subdirectory in a larger git repo (&quot;monorepo&quot;). pre-commit decided to <a href="https://github.com/pre-commit/pre-commit/issues/466#issuecomment-921945015">not support</a> this use case, so I have my own &quot;pre-commit&quot; script, which indeed, I want to fail if it makes changes. Currently I wrote this:</p>
<pre><code>if ! ruff format --check .; then ruff format .; false; fi
</code></pre>
<p>but having a --exit-non-zero-on-fix would be much nicer.</p>
<p>If this is approved, I will be happy to try and implement this.</p>
<p>Thanks!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Reopened by @zanieb on 2024-01-07 17:50</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">needs-decision</span> added by @zanieb on 2024-01-07 17:50</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-01-08 07:55</div>
            <div class="timeline-body"><p>@noamraph I'm trying to understand your use case and I'm sorry if this is obvious but my bash knowledge is rather terrible :sweat:</p>
<p>What I understand from the script is that it runs <code>ruff format .</code> only if <code>ruff format --check</code> failed. Can you explain the reason for it? I would also be interested to understand what functionality you miss from using <code>ruff format --diff</code>. It doesn't write the files as <code>ruff format</code> does.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/noamraph">@noamraph</a> on 2024-01-08 12:33</div>
            <div class="timeline-body"><p>@MichaReiser it's convenient for me to have one script which formats files and returns a nonzero code if it modified files. This is the behavior of the pre-commit tool. It's convenient because I use the same tool on my machine before committing, to format all the files, and also in CI, to block a pull request which isn't formatted according to the rules. For running on my machine, I need it to format the files. For running in CI, I need it to return nonzero if files aren't formatted. It's convenient to combine the two uses.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Removed from milestone "Formatter: Stable" by @MichaReiser on 2024-01-11 14:08</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/danieleades">@danieleades</a> on 2024-02-22 11:53</div>
            <div class="timeline-body"><p>the use case for us would be to have a single <code>format</code> makefile target that can be used both for:</p>
<ul>
<li>developers formatting their local repo</li>
<li>CI jobs checking the formatting</li>
</ul>
<p>something like</p>
<pre><code class="language-makefile">.PHONY: format
format:
	poetry run ruff format . --exit-error-on-fix
</code></pre>
<p>without this we need separate targets for dev and CI</p>
<pre><code class="language-makefile">.PHONY: format-check
format-check:
	poetry run ruff format . --diff

.PHONY: format
format:
        poetry run ruff format .
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../ADemkin/aaa-frontend-app/pulls/3.html">ADemkin/aaa-frontend-app#3</a> on 2024-05-03 10:58</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/noamraph">@noamraph</a> on 2024-06-13 16:58</div>
            <div class="timeline-body"><p>@zanieb I have another use case: I'm trying leftcommit (a pre-commit alternative) and it doesn't check if the files were changed.</p>
<p>If you want, I hope I can submit a PR.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/rayjlinden">@rayjlinden</a> on 2024-08-23 15:56</div>
            <div class="timeline-body"><p>Also need this.  Like above its fine to make the changes &quot;ruff format&quot; - we just need to know if it ended up making any changes...</p>
<p>If &quot;ruff format&quot; returned a 1 if it made changes then we know.  We stop the pre-commit.  Developer does a git status and can see we already fixed some things.  They review and do a commit and all is good.</p>
<p>Otherwise, as mentioned before we have to run ruff twice.  (Though since it is so much faster than black that isn't as bad as it could be!  :)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/chadrik">@chadrik</a> on 2024-12-26 01:29</div>
            <div class="timeline-body"><p>I have a similar need.   I'm moving to <a href="https://moonrepo.dev/">moon</a> for monorepo task management, and it has most of what I need for a pre-commit alternative, and by eliminating pre-commit I can have a single source of truth for task execution.</p>
<p>As a developer running a formatter on pre-commit, I want the formatter to format my code, but I <em>also</em> want pre-commit to abort so that the user can review the changes that were made (same behavior as with <code>pre-commit</code> tool).   As it stands, I have to run <code>ruff format</code> twice:  with and without <code>--check</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/15906.html">astral-sh/ruff#15906</a> on 2025-02-03 09:35</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/thejcannon">@thejcannon</a> on 2025-02-05 03:09</div>
            <div class="timeline-body"><p>Toss my name in the mix of users &quot;who want this&quot;, I'm trying out using <code>lefthook</code>: https://github.com/evilmartians/lefthook</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-02-05 04:47</div>
            <div class="timeline-body"><p>I think I'm okay with adding this for parity with <code>ruff check</code>.</p>
<p>Why aren't various <code>git</code> command sufficient for checking if files have changed?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/thejcannon">@thejcannon</a> on 2025-02-05 15:49</div>
            <div class="timeline-body"><p>My 2c: They (maybe*) are, but that's bad ergonomics.</p>
<p>*: You'd have to either fold the <code>git</code> checking into the command running <code>ruff format</code> or the overarching command which is running <code>ruff format</code> (and there's a chance both is impossible/improbable)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/16009.html">astral-sh/ruff#16009</a> on 2025-02-07 02:40</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/1667.html">astral-sh/ruff#1667</a> on 2025-03-18 05:21</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @ntBre on 2025-03-19 14:55</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../hukkin/mdformat/issues/531.html">hukkin/mdformat#531</a> on 2025-08-16 05:20</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../TobikoData/sqlmesh/pulls/5121.html">TobikoData/sqlmesh#5121</a> on 2025-08-19 14:30</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:28:11 UTC
    </footer>
</body>
</html>
