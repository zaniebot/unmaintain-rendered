<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Unify `OperatorPrecedence` enums - astral-sh/ruff #16071</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Unify <code>OperatorPrecedence</code> enums</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/issues/16071">#16071</a>
        opened by <a href="https://github.com/MichaReiser">@MichaReiser</a>
        on 2025-02-10 08:56
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a></div>
            <div class="timeline-body"><h3>Description</h3>
<p>There are now 3 <code>OperatorPrecedence</code> structs in ruff</p>
<ul>
<li>Formatter (only the expression one, the pattern one is different)</li>
<li>Linter</li>
<li>Parser</li>
</ul>
<ol>
<li>[x] Move the Linter <code>OperatorPrecedence</code> struct into ruff-python-ast and expose a <code>precedence()</code> method on <code>Expr</code> (and `ExpressionRef) and ideally on each Expression node.</li>
<li>[ ] Try to replace some of the other <code>OperatorPrecedence</code> structs with the one now defined in the AST crate</li>
</ol>
<p>Ideally, these would be two separate PRs</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">internal</span> added by @MichaReiser on 2025-02-10 08:56</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">help wanted</span> added by @MichaReiser on 2025-02-10 08:58</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/junhsonjb">@junhsonjb</a> on 2025-02-13 03:53</div>
            <div class="timeline-body"><p>I can take this on, I have a few questions though</p>
<ul>
<li>what is the <code>ExpressionRef</code> type? I'm grepping around and I only see <code>LiteralExpressionRef</code>, is that what you're referring to?</li>
<li>when you say &quot;Expression node&quot;, are you referring to the <code>Expr</code> struct that's implemented in <code>ruff_python_linter/src/nodes.rs</code>?</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-02-13 08:06</div>
            <div class="timeline-body"><blockquote>
<p>what is the ExpressionRef type? I'm g</p>
</blockquote>
<p>Oh, I forgot that it was renamed. It's <a href="https://github.com/astral-sh/ruff/blob/ef85c682bdd76ed63457bdfbec72e09424ac20ab/crates/ruff_python_ast/src/generated.rs#L1738"><code>ExprRef</code></a>.</p>
<blockquote>
<p>when you say &quot;Expression node&quot;, are you referring to the Expr struct that's implemented in ruff_python_linter/src/nodes.rs?</p>
</blockquote>
<p>Yes, but the file is in the <code>ruff_python_ast</code> crate (<a href="https://github.com/astral-sh/ruff/blob/ef85c682bdd76ed63457bdfbec72e09424ac20ab/crates/ruff_python_ast/src/generated.rs#L271">source</a>)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a> on 2025-02-14 08:50</div>
            <div class="timeline-body"><p>This needs some good design. The fix results in #15919 weren't as nice as I'd want them to be. I found no easy way to avoid parenthesizing when unnecessary:</p>
<pre><code class="language-python">  2 ** -2  # Intended result: 0.25
# ^^^^^^^ This doesn't need parentheses

  -2 ** 2  # Intended result: 4
# ^^ This does
</code></pre>
<p>The newest <code>OperatorPrecedence</code> accepts an expression and output the precedence of the operator that expression represents, but it doesn't consider the context.</p>
<pre><code class="language-python"># This entire subscript resolves to the precedence of the subscript operator,
# while its slice resolves to that of the unary `-`.
lorem[-ipsum]

# `[]` binds more tightly than `-`,
# so a simple precedence comparison would result in the expected output for this case,
# where `-` is supposed to apply to `lorem` alone:
(-lorem)[ipsum]  # Necessary

# On the other hand, the slice expression doesn't need parenthesizing.
# The comparison result alone isn't enough to avoid this:
lorem[(-ipsum)]  # Unnecessary
</code></pre>
<p>A more complex example:</p>
<pre><code class="language-python">  (a + 1)(
# ^^^^^^^ This needs extra parentheses, as binary `+` binds less tightly than `()`
      a + 1,
#     ^^^^^ This doesn't, as it is an argument
      b := 0,
#     ^^^^^^ This also doesn't; bare named expressions can be passed positionally.
      c = (d := -1)
#         ^^^^^^^^^ But this does.
  )
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/junhsonjb">@junhsonjb</a> on 2025-02-14 14:29</div>
            <div class="timeline-body"><p>Just sent out a <a href="https://github.com/astral-sh/ruff/pull/16162">PR</a>. I wrote most of the code before @InSyncWithFoo's comment. It doesn't attempt to address the problems with parenthesizing yet but I think may still be a good step towards unifying the many definitions of <code>OperatorPrecedence</code> ðŸ™‚</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @MichaReiser on 2025-02-14 14:55</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @MichaReiser on 2025-02-14 14:55</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Reopened by @MichaReiser on 2025-02-14 14:55</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/junhsonjb">@junhsonjb</a> on 2025-02-14 23:07</div>
            <div class="timeline-body"><p>I can get started on the second PR for this issue soon. Should be interesting to see how nicely the other versions of <code>OperatorPrecedence</code> play with each other ðŸ‘€</p>
<p>In regards to the parenthesizing issue, I think that should either be a third PR on this issue or a separate issue -- would you agree @InSyncWithFoo? To be honest, I have no idea how to even approach the problem yet but it seems like a really cool learning opportunity, especially if I can be pointed in the right direction ðŸ™‚</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a> on 2025-02-14 23:59</div>
            <div class="timeline-body"><p>@junhsonjb The parenthesizing problem is indeed big and deserves its own PR. That said, I also don't have a good idea of what the logic should be.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/junhsonjb">@junhsonjb</a> on 2025-03-14 13:40</div>
            <div class="timeline-body"><p>Sorry about the delay here ðŸ™‚ This PR only makes the changes for <code>ruff_python_parser</code> -- I thought it might be a good idea to keep things simple and separate the changes for each crate</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-03-14 13:58</div>
            <div class="timeline-body"><p>@junhsonjb no worries. We'll take a look in the next few days. I noticed that you mentioned that you plan on doing the formatter next. For me, the formatter has the lowest priority because it has some more bespoke behavior around it and I'm not 100% if we should unify it with the other enums. Maybe start with the linter enum next?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/junhsonjb">@junhsonjb</a> on 2025-03-17 13:06</div>
            <div class="timeline-body"><p>@MichaReiser Thanks! That sounds fine about the formatter. The linter's version of the enum is the one that was moved into <code>ruff_python_ast</code> to become the general <code>OperatorPrecedence</code>. This was done in the first PR for this issue, so I think it might be safe to close this issue for now</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @dhruvmanila on 2025-03-21 04:10</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @dhruvmanila on 2025-03-21 04:10</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Reopened by @dhruvmanila on 2025-03-21 04:11</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2025-03-21 04:11</div>
            <div class="timeline-body"><p>I think the one in the formatter is still remaining.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/junhsonjb">@junhsonjb</a> on 2025-03-21 12:35</div>
            <div class="timeline-body"><p>Do we still want to do the formatter? Micha <a href="https://github.com/astral-sh/ruff/issues/16071#issuecomment-2724788995">mentioned</a> that we may not want to do work on the formatter:</p>
<blockquote>
<p>For me, the formatter has the lowest priority because it has some more bespoke behavior around it and I'm not 100% if we should unify it with the other enums. Maybe start with the linter enum next?</p>
</blockquote>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-03-21 12:47</div>
            <div class="timeline-body"><p>@junhsonjb we can give it a try if the variants line up. We can't do it if either enum as fewer or more variants (or if they differ)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/junhsonjb">@junhsonjb</a> on 2025-03-21 13:12</div>
            <div class="timeline-body"><p><code>ruff_python_ast::OperatorPrecedence</code> has 21 variants, the one in the formatter (specifically the expression one) has 13.</p>
<p>It may also be worth noting that the formatter's version is reversed -- the higher precedence variants are at the top, this could complicate things further.</p>
<p>So we likely can't do it, then.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-03-21 13:23</div>
            <div class="timeline-body"><p>That makes sense and roughly matches what I remember when I implemented it. The formatter precedence isn't an exact match of Python's parsing precedence. It's more: Users expect expressions with these operations to be grouped together.</p>
<p>Thanks for working on this and making ruff better!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @MichaReiser on 2025-03-21 13:23</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 16:52:11 UTC
    </footer>
</body>
</html>
