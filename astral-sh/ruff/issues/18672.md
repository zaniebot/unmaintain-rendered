```yaml
number: 18672
title: Formatter can delete comments between f-string expr and format spec
type: issue
state: closed
author: MeGaGiGaGon
labels:
  - bug
  - formatter
assignees: []
created_at: 2025-06-14T00:49:20Z
updated_at: 2025-06-17T05:39:43Z
url: https://github.com/astral-sh/ruff/issues/18672
synced_at: 2026-01-10T01:56:56Z
```

# Formatter can delete comments between f-string expr and format spec

---

_Issue opened by @MeGaGiGaGon on 2025-06-14 00:49_

### Summary

As the title says, any comments between the f-string expr and format spec can get deleted by the formatter if it gets collapsed to one line and there is a `#` in the format spec [playground](https://play.ruff.rs/463c05cd-3cd6-4276-85d0-9a988d1992fc)
```py
f"{1
# test
:#}"
```
Formats to
```py
f"{1:#}"
```

### Version

playground

---

_Label `bug` added by @MichaReiser on 2025-06-14 05:03_

---

_Label `formatter` added by @MichaReiser on 2025-06-14 05:03_

---

_Comment by @LaBatata101 on 2025-06-14 22:57_

@MichaReiser how should the formatted output look like? 

I was prototyping a fix for this issue and got this output:
```python
f"{
    1:# comment
    #
}"
```

---

_Comment by @MeGaGiGaGon on 2025-06-14 23:36_

@LaBatata101 Unfortunately that's invalid code on 3.13.5/3.14, see #18632
It also changes the meaning of the code since in format specs `#`s are not comments (running on 3.12 to avoid the error)
```pycon
>>> f"{1:  # comment? nope
... }"
Traceback (most recent call last):
  File "<stdin>", line 1, in <module>
ValueError: Invalid format specifier '  # comment? nope' for object of type 'int'
```

---

_Comment by @MichaReiser on 2025-06-15 06:13_

> @MichaReiser how should the formatted output look like?

I don't know. There's no one-fits-all solution to this. It requires finding heurisitcs that keep the comments close to where they were, keep them in source order and, ideally, preseves if the comment was an own-line or end-of-line comment.

I think in this case, a reasonable formatting would be 

```py
f"{1:#}"  # test
```

But we need to be careful to only apply it if there's no debug expression

---

_Comment by @dhruvmanila on 2025-06-16 04:21_

After playing around with the original code, I found that if the comment is an end-of-line comment for the expression, and if there's a format spec present, the comment gets moved _after_ the format spec which makes it not a comment anymore.

```py
f"{1 # comment
:.2f
}"
```

The above gets formatted to:
```py
f"{
    1:.2f  # comment
}"
```

The core issue might be the same although I'm not sure.

---

_Comment by @MichaReiser on 2025-06-16 07:51_

I think I need to fix this to fix the format spec issue because we drop the comment in

```
x = f"{x  !s
         :>{0
         # comment 21
         }}"
```

---

_Assigned to @MichaReiser by @MichaReiser on 2025-06-16 09:06_

---

_Referenced in [astral-sh/ruff#18704](../../astral-sh/ruff/pulls/18704.md) on 2025-06-16 11:40_

---

_Closed by @MichaReiser on 2025-06-17 05:39_

---
