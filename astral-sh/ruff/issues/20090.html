<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Configurations incorrectly merged when using `extend` key - astral-sh/ruff #20090</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Configurations incorrectly merged when using `extend` key</h1>

    <div class="meta">
        <span class="state state-closed">Closed</span>
        <a href="https://github.com/astral-sh/ruff/issues/20090">#20090</a>
        opened by <a href="https://github.com/A-CGray">@A-CGray</a>
        on 2025-08-25 19:57
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/A-CGray">@A-CGray</a> on 2025-08-25 19:57</div>
            <div class="timeline-body"><h3>Summary</h3>
<p>I am running into issues trying to use the <code>extend</code> key to combine global and local ruff configurations.</p>
<p>My &quot;global&quot; ruff config file is at <code>~/.config/ruff/ruff.toml</code>:</p>
<pre><code class="language-toml">target-version = &quot;py39&quot;

line-length = 120

exclude = [
    &quot;.git&quot;,
    &quot;**/__pycache__&quot;,
    &quot;**/doc/conf.py&quot;,
    &quot;**/__init__.py&quot;,
    &quot;setup.py&quot;,
]

[lint]
ignore = [
    &quot;E266&quot;, 
    &quot;B006&quot;, 
    &quot;E501&quot;, 
    &quot;W605&quot;, 
    &quot;D301&quot;, 
    &quot;D10&quot;, 
    &quot;D400&quot;, 
    &quot;D205&quot;, 
    &quot;D200&quot;, 
    &quot;D202&quot;, 
    &quot;D401&quot;, 
    &quot;D404&quot;, 
]

select = [
    &quot;B&quot;,
    &quot;D&quot;,
    &quot;E&quot;,
    &quot;F&quot;,
    &quot;W&quot;,
]

[lint.pydocstyle]
convention = &quot;numpy&quot;

[format]
quote-style = &quot;double&quot;
indent-style = &quot;space&quot;
docstring-code-format = true

[lint.per-file-ignores]
&quot;tests/*&quot; = [&quot;D&quot;] # Ignore docstring checks in tests
</code></pre>
<p>Then, in the root folder of a project called CMPLXFOIL, I have the following local ruff config that I want to add to the global config:</p>
<pre><code class="language-toml">extend = &quot;~/.config/ruff/ruff.toml&quot;
extend-exclude =[
    &quot;src_cs/complexify.py&quot;
]
</code></pre>
<p>However, when I run <code>ruff check -v</code> in the root folder of this project I get the following:</p>
<pre><code>[2025-08-25][15:31:05][ruff::resolve][DEBUG] Using configuration file (via parent) at: /home/ali/repos/CMPLXFOIL/ruff.toml
[2025-08-25][15:31:05][ruff_workspace::pyproject][DEBUG] No `target-version` found in `ruff.toml`
[2025-08-25][15:31:05][ruff_workspace::pyproject][DEBUG] No `pyproject.toml` with `requires-python` in same directory; `target-version` unspecified
[2025-08-25][15:31:05][ignore::gitignore][DEBUG] opened gitignore file: /home/ali/repos/CMPLXFOIL/.gitignore
[2025-08-25][15:31:05][ignore::gitignore][DEBUG] opened gitignore file: /home/ali/repos/CMPLXFOIL/.git/info/exclude
[2025-08-25][15:31:05][ruff_workspace::pyproject][DEBUG] No `target-version` found in `ruff.toml`
[2025-08-25][15:31:05][ruff_workspace::pyproject][DEBUG] No `pyproject.toml` with `requires-python` in same directory; `target-version` unspecified
[2025-08-25][15:31:05][ignore::walk][DEBUG] ignoring /home/ali/repos/CMPLXFOIL/testflo_report.out: Ignore(IgnoreMatch(Gitignore(Glob { from: Some(&quot;/home/ali/repos/CMPLXFOIL/.gitignore&quot;), original: &quot;*.out&quot;, actual: &quot;**/*.out&quot;, is_whitelist: false, is_only_dir: false })))
[2025-08-25][15:31:05][ignore::walk][DEBUG] ignoring /home/ali/repos/CMPLXFOIL/cmplxfoil.egg-info: Ignore(IgnoreMatch(Gitignore(Glob { from: Some(&quot;/home/ali/repos/CMPLXFOIL/.gitignore&quot;), original: &quot;*.egg-info/&quot;, actual: &quot;**/*.egg-info&quot;, is_whitelist: false, is_only_dir: true })))
[2025-08-25][15:31:05][ignore::gitignore][DEBUG] opened gitignore file: /home/ali/repos/CMPLXFOIL/.ruff_cache/.gitignore
[2025-08-25][15:31:05][ignore::walk][DEBUG] ignoring /home/ali/repos/CMPLXFOIL/.pre-commit-config.yaml: Ignore(IgnoreMatch(Gitignore(Glob { from: Some(&quot;/home/ali/repos/CMPLXFOIL/.gitignore&quot;), original: &quot;.pre-commit-config.yaml&quot;, actual: &quot;**/.pre-commit-config.yaml&quot;, is_whitelist: false, is_only_dir: false })))
[2025-08-25][15:31:05][ignore::walk][DEBUG] ignoring /home/ali/repos/CMPLXFOIL/.ruff_cache/CACHEDIR.TAG: Ignore(IgnoreMatch(Gitignore(Glob { from: Some(&quot;/home/ali/repos/CMPLXFOIL/.ruff_cache/.gitignore&quot;), original: &quot;*&quot;, actual: &quot;**/*&quot;, is_whitelist: false, is_only_dir: false })))
[2025-08-25][15:31:05][ignore::walk][DEBUG] ignoring /home/ali/repos/CMPLXFOIL/.ruff_cache/0.12.10: Ignore(IgnoreMatch(Gitignore(Glob { from: Some(&quot;/home/ali/repos/CMPLXFOIL/.ruff_cache/.gitignore&quot;), original: &quot;*&quot;, actual: &quot;**/*&quot;, is_whitelist: false, is_only_dir: false })))
[2025-08-25][15:31:05][ignore::walk][DEBUG] ignoring /home/ali/repos/CMPLXFOIL/.ruff_cache/0.12.7: Ignore(IgnoreMatch(Gitignore(Glob { from: Some(&quot;/home/ali/repos/CMPLXFOIL/.ruff_cache/.gitignore&quot;), original: &quot;*&quot;, actual: &quot;**/*&quot;, is_whitelist: false, is_only_dir: false })))
[2025-08-25][15:31:05][ignore::walk][DEBUG] ignoring /home/ali/repos/CMPLXFOIL/.ruff_cache/.gitignore: Ignore(IgnoreMatch(Gitignore(Glob { from: Some(&quot;/home/ali/repos/CMPLXFOIL/.ruff_cache/.gitignore&quot;), original: &quot;*&quot;, actual: &quot;**/*&quot;, is_whitelist: false, is_only_dir: false })))
[2025-08-25][15:31:05][ignore::walk][DEBUG] ignoring /home/ali/repos/CMPLXFOIL/src/build: Ignore(IgnoreMatch(Gitignore(Glob { from: Some(&quot;/home/ali/repos/CMPLXFOIL/.gitignore&quot;), original: &quot;build/&quot;, actual: &quot;**/build&quot;, is_whitelist: false, is_only_dir: true })))
[2025-08-25][15:31:05][ignore::walk][DEBUG] ignoring /home/ali/repos/CMPLXFOIL/config.mk: Ignore(IgnoreMatch(Gitignore(Glob { from: Some(&quot;/home/ali/repos/CMPLXFOIL/.gitignore&quot;), original: &quot;config.mk&quot;, actual: &quot;**/config.mk&quot;, is_whitelist: false, is_only_dir: false })))
[2025-08-25][15:31:05][ignore::walk][DEBUG] ignoring /home/ali/repos/CMPLXFOIL/cmplxfoil/libcmplxfoil.so: Ignore(IgnoreMatch(Gitignore(Glob { from: Some(&quot;/home/ali/repos/CMPLXFOIL/.gitignore&quot;), original: &quot;*.so&quot;, actual: &quot;**/*.so&quot;, is_whitelist: false, is_only_dir: false })))
[2025-08-25][15:31:05][ignore::walk][DEBUG] ignoring /home/ali/repos/CMPLXFOIL/config/config.mk: Ignore(IgnoreMatch(Gitignore(Glob { from: Some(&quot;/home/ali/repos/CMPLXFOIL/.gitignore&quot;), original: &quot;config/config*&quot;, actual: &quot;config/config*&quot;, is_whitelist: false, is_only_dir: false })))
[2025-08-25][15:31:05][ruff_workspace::resolver][DEBUG] Included path via `include`: &quot;/home/ali/repos/CMPLXFOIL/doc/conf.py&quot;
[2025-08-25][15:31:05][ruff_workspace::resolver][DEBUG] Ignored path via `exclude`: &quot;/home/ali/repos/CMPLXFOIL/setup.py&quot;
[2025-08-25][15:31:05][ruff_workspace::resolver][DEBUG] Included path via `include`: &quot;/home/ali/repos/CMPLXFOIL/cmplxfoil/MExt.py&quot;
[2025-08-25][15:31:05][ruff_workspace::resolver][DEBUG] Included path via `include`: &quot;/home/ali/repos/CMPLXFOIL/examples/single_point.py&quot;
[2025-08-25][15:31:05][ignore::walk][DEBUG] ignoring /home/ali/repos/CMPLXFOIL/tests/__pycache__: Ignore(IgnoreMatch(Gitignore(Glob { from: Some(&quot;/home/ali/repos/CMPLXFOIL/.gitignore&quot;), original: &quot;__pycache__/&quot;, actual: &quot;**/__pycache__&quot;, is_whitelist: false, is_only_dir: true })))
[2025-08-25][15:31:05][ignore::walk][DEBUG] ignoring /home/ali/repos/CMPLXFOIL/cmplxfoil/__pycache__: Ignore(IgnoreMatch(Gitignore(Glob { from: Some(&quot;/home/ali/repos/CMPLXFOIL/.gitignore&quot;), original: &quot;__pycache__/&quot;, actual: &quot;**/__pycache__&quot;, is_whitelist: false, is_only_dir: true })))
[2025-08-25][15:31:05][ignore::walk][DEBUG] ignoring /home/ali/repos/CMPLXFOIL/cmplxfoil/libcmplxfoil_cs.so: Ignore(IgnoreMatch(Gitignore(Glob { from: Some(&quot;/home/ali/repos/CMPLXFOIL/.gitignore&quot;), original: &quot;*.so&quot;, actual: &quot;**/*.so&quot;, is_whitelist: false, is_only_dir: false })))
[2025-08-25][15:31:05][ruff_workspace::resolver][DEBUG] Included path via `include`: &quot;/home/ali/repos/CMPLXFOIL/tests/test_solver_class.py&quot;
[2025-08-25][15:31:05][ruff_workspace::resolver][DEBUG] Included path via `include`: &quot;/home/ali/repos/CMPLXFOIL/cmplxfoil/__init__.py&quot;
[2025-08-25][15:31:05][ignore::walk][DEBUG] ignoring /home/ali/repos/CMPLXFOIL/src_cs/build: Ignore(IgnoreMatch(Gitignore(Glob { from: Some(&quot;/home/ali/repos/CMPLXFOIL/.gitignore&quot;), original: &quot;build/&quot;, actual: &quot;**/build&quot;, is_whitelist: false, is_only_dir: true })))
[2025-08-25][15:31:05][ruff_workspace::resolver][DEBUG] Included path via `include`: &quot;/home/ali/repos/CMPLXFOIL/cmplxfoil/CMPLXFOIL.py&quot;
[2025-08-25][15:31:05][ruff_workspace::resolver][DEBUG] Included path via `include`: &quot;/home/ali/repos/CMPLXFOIL/cmplxfoil/postprocess.py&quot;
[2025-08-25][15:31:05][ruff_workspace::resolver][DEBUG] Ignored path via `exclude`: &quot;/home/ali/repos/CMPLXFOIL/.git&quot;
[2025-08-25][15:31:05][ruff::commands::check][DEBUG] Identified files to lint in: 5.243998ms
[2025-08-25][15:31:05][ruff::commands::check][DEBUG] Checked 7 files in: 145.042Âµs
cmplxfoil/__init__.py:3:24: F401 `.CMPLXFOIL.CMPLXFOIL` imported but unused; consider removing, adding to `__all__`, or using a redundant alias
  |
1 | __version__ = &quot;2.1.2&quot;
2 |
3 | from .CMPLXFOIL import CMPLXFOIL
  |                        ^^^^^^^^^ F401
4 |
5 | try:
  |
  = help: Use an explicit re-export: `CMPLXFOIL as CMPLXFOIL`

cmplxfoil/__init__.py:6:30: F401 `.postprocess.AnimateAirfoilOpt` imported but unused; consider using `importlib.util.find_spec` to test for availability
  |
5 | try:
6 |     from .postprocess import AnimateAirfoilOpt
  |                              ^^^^^^^^^^^^^^^^^ F401
7 | except ImportError:
8 |     pass
  |
  = help: Remove unused import: `.postprocess.AnimateAirfoilOpt`

doc/conf.py:1:1: F403 `from sphinx_mdolab_theme.config import *` used; unable to detect undefined names
  |
1 | from sphinx_mdolab_theme.config import *
  | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ F403
2 |
3 | # -- Path setup --------------------------------------------------------------
  |

doc/conf.py:25:1: F405 `extensions` may be undefined, or defined from star imports
   |
23 | # here we add external extensions, which must also be added to requirements.txt
24 | # so that RTD can import and use them
25 | extensions.extend([])
   | ^^^^^^^^^^ F405
26 |
27 | # mock import for autodoc
   |

Found 4 errors.
</code></pre>
<p>It seems like ruff is ignoring several of the configuration options specified in my global config file. For example, it complains that &quot;No <code>target-version</code> found in <code>ruff.toml</code>&quot; despite this being specified in my global config file. Additionally it is running checks on files such as <code>__init__.py</code> and <code>doc/conf.py</code> that are specifically excluded from checks in the global config.</p>
<p>If I run <code>ruff check</code> in a different project that doesn't have its own local ruff config, the global config file is found and used correctly, so I don't think there are any issues with the content of that file, the issue seems to be with how the local and global configs are merged when using <code>extend</code>.</p>
<h3>Version</h3>
<p>ruff 0.12.10</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntBre">@ntBre</a> on 2025-08-25 20:59</div>
            <div class="timeline-body"><p>Thanks for the report!</p>
<p>I'm having some trouble reproducing this. Are there any other configuration files around that could be having an impact?</p>
<p>I tried a fresh docker image with this local config:</p>
<pre><code class="language-toml">extend = &quot;~/.config/ruff/ruff.toml&quot;
extend-exclude =[
    &quot;src_cs/complexify.py&quot;
]
</code></pre>
<p>A global ruff config at <code>~/.config/ruff/ruff.toml</code>:</p>
<pre><code class="language-toml">target-version = &quot;py313&quot;

exclude = [
    &quot;.git&quot;,
    &quot;**/__pycache__&quot;,
    &quot;**/doc/conf.py&quot;,
    &quot;**/__init__.py&quot;,
    &quot;setup.py&quot;,
]

[lint]
select = [&quot;UP046&quot;]
</code></pre>
<p>And a Python file with an UP046 violation for the configured Python version in <code>src/try.py</code>:</p>
<pre><code class="language-py">from typing import TypeVar, Generic

T = TypeVar(&quot;T&quot;)

class C(Generic[T]): ...
</code></pre>
<p>This reports a diagnostic as written and no diagnostic if I comment out the  local <code>extend</code> setting.</p>
<p>I'm not sure the logs are going to be very helpful here. I didn't see any logging calls around where we do the extending, and my logs don't show any mention of <code>~/.config/ruff/ruff.toml</code> either. The <code>--show-settings</code> flag, however, does show the correct <code>target_version</code>.</p>
<p>There is a known issue with overlapping configuration options in https://github.com/astral-sh/ruff/issues/9872, which you could be running into if your local config is longer than what's included here.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">question</span> added by @ntBre on 2025-08-25 20:59</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/A-CGray">@A-CGray</a> on 2025-08-25 22:29</div>
            <div class="timeline-body"><p>Thanks for the quick response @ntBre !</p>
<p>I created a MWE at https://github.com/A-CGray/ruffMWE, it has an even simpler set of config files and still shows the issue on my machine. The <code>select</code> key from the global config is respected while the <code>exclude</code> key is not. Would you be able to clone it and see if you get the same behaviour described in the readme?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../mdolab/.github/issues/73.html">mdolab/.github#73</a> on 2025-08-25 22:32</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ewu63">@ewu63</a> on 2025-08-25 23:23</div>
            <div class="timeline-body"><p>FWIW may be related to <a href="https://github.com/astral-sh/ruff/issues/8795#issuecomment-3215813669">this report</a> I made</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/A-CGray">@A-CGray</a> on 2025-08-25 23:41</div>
            <div class="timeline-body"><blockquote>
<p>FWIW may be related to <a href="https://github.com/astral-sh/ruff/issues/8795#issuecomment-3215813669">this report</a> I made</p>
</blockquote>
<p>You're right, if I pass the local config file explicitly (<code>ruff check -v --config ruff.toml</code>) this issue goes away. As suggested by a comment on that issue, if I change the exclude from <code>&quot;doc/conf.py&quot;</code> to <code>&quot;/**/doc/conf.py&quot;</code> then the issue also goes away. so clearly it is a matter of the paths in the global config not being correctly treated as relative to the location of the local config.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Teyik0">@Teyik0</a> on 2025-09-02 06:25</div>
            <div class="timeline-body"><p>Also found that lint.per-file-ignores don't work when using extend configuration.</p>
<pre><code class="language-bash"># ruff_base.toml
[lint.per-file-ignores]
&quot;tests/**/*.py&quot; = [
    &quot;S101&quot;,    # Allow assert statements
    &quot;PLR2004&quot;, # Allow magic values in tests
    &quot;SLF001&quot;,  # Allow private member access
]

# pyproject.toml
[tool.ruff]
extend = &quot;src/ultrapyup/resources/ruff_base.toml&quot;
</code></pre>
<p>The rules actually works when inside pyproject.toml directly.</p>
<pre><code class="language-bash"># pyproject.toml
[tool.ruff]
extend = &quot;src/ultrapyup/resources/ruff_base.toml&quot;
[tool.ruff.lint.per-file-ignores] # Workaround for now
&quot;tests/**/*.py&quot; = [
    &quot;S101&quot;,    # Allow assert statements
    &quot;PLR2004&quot;, # Allow magic values in tests
    &quot;SLF001&quot;,  # Allow private member access
]
</code></pre>
<p>Currently trying to build something like <a href="https://www.ultracite.ai/">ultracite</a> but for the python ecosystem, this is blocking.
You may label this as a bug</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntBre">@ntBre</a> on 2025-09-02 13:48</div>
            <div class="timeline-body"><p>Thank y'all! I think I'll close this in favor of #8795 since it sounds like the root cause is the same (relative paths in <code>extend</code>ed globs). That way we can keep the discussion in one place.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @ntBre on 2025-09-02 13:48</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:34:55 UTC
    </footer>
</body>
</html>
