<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[red-knot] Add understanding of terminal statements to control-flow analysis - astral-sh/ruff #14014</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[red-knot] Add understanding of terminal statements to control-flow analysis</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/issues/14014">#14014</a>
        opened by <a href="https://github.com/AlexWaygood">@AlexWaygood</a>
        on 2024-10-31 12:04
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a></div>
            <div class="timeline-body"><p>red-knot currently issues false positives on the following snippets:</p>
<pre><code>def str_instance() -&gt; str:
    return &quot;foo&quot;

some_string = str_instance()


try:
    x = some_string[5]
except IndexError:
    raise ValueError(&quot;no&quot;)
print(x)  # false positive &#x27;possibly not defined&#x27; error here


def f():
    try:
        y = some_string[5]
    except IndexError:
        return
    print(y)  # false positive &#x27;possibly not defined&#x27; error here


while True:
    try:
        z = some_string[5]
    except IndexError:
        continue
    print(z)  # false positive &#x27;possibly not defined&#x27; error here

    try:
        aa = some_string[5]
    except IndexError:
        break
    print(aa)  # false positive &#x27;possibly not defined&#x27; error here
</code></pre>
<p>In all of these situations, we see that a variable is declared in the <code>try</code> branch but not the <code>except</code> branch of the <code>try</code>/<code>except</code> block. We realise that either branch could be taken, so we union together the boundedness of the two branches to conclude that the variable is possibly unbound at the point where it is read later in the same scope.</p>
<p>What we&#x27;re missing is special understanding of the <code>return</code>, <code>raise</code>, <code>break</code> and <code>continue</code> statements. When we union together the boundedness of the branches, we need to exclude all branches that always end in one of these statements, because we can determine that later statements in the same scope will be unreachable by branches that always end in one of those statements.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-10-31 12:05</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to <a href="https://github.com/AlexWaygood">@AlexWaygood</a> by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-10-31 12:05</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone &quot;Red Knot 2024&quot; by <a href="https://github.com/carljm">@carljm</a> on 2024-11-07 15:24</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Removed from milestone &quot;Red Knot 2024&quot; by <a href="https://github.com/carljm">@carljm</a> on 2025-01-09 17:43</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone &quot;Red Knot Q1 2025&quot; by <a href="https://github.com/carljm">@carljm</a> on 2025-01-09 17:43</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Unassigned <a href="https://github.com/AlexWaygood">@AlexWaygood</a> by <a href="https://github.com/carljm">@carljm</a> on 2025-01-09 17:46</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to <a href="https://github.com/dcreager">@dcreager</a> by <a href="https://github.com/carljm">@carljm</a> on 2025-01-09 22:12</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dcreager">@dcreager</a> on 2025-02-05 22:49</div>
            <div class="timeline-body"><p>This is done with #15676 and #15817.  We might change how we handle terminal statements as part of figuring out what we want to do with unreachable code (<a href="https://github.com/astral-sh/ruff/issues/15797">astral-sh/ruff#15797</a>).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/dcreager">@dcreager</a> on 2025-02-05 22:49</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 18:48:59 UTC
    </footer>
</body>
</html>
