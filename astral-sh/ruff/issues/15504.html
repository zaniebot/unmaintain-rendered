<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>diagnostic rendering for import lint `I001` is sub-optimal in some cases - astral-sh/ruff #15504</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>diagnostic rendering for import lint <code>I001</code> is sub-optimal in some cases</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/issues/15504">#15504</a>
        opened by <a href="https://github.com/BurntSushi">@BurntSushi</a>
        on 2025-01-15 15:34
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2025-01-15 15:34</div>
            <div class="timeline-body"><p>On current <code>main</code>, here's what one example of a <code>I001</code> diagnostic looks like:</p>
<pre><code>lines_after_imports.pyi:1:1: I001 [*] Import block is un-sorted or un-formatted
   |
 1 | / from __future__ import annotations
 2 | |
 3 | | from typing import Any
 4 | |
 5 | | from requests import Session
 6 | |
 7 | | from my_first_party import my_first_party_object
 8 | |
 9 | | from . import my_local_folder_object
10 | |
11 | |
12 | |
13 | | class Thing(object):
   | |_^ I001
14 |     name: str
15 |     def __init__(self, name: str):
   |
   = help: Organize imports
</code></pre>
<p>In particular, the above comes from this snapshot:</p>
<p>https://github.com/astral-sh/ruff/blob/55a7f72035390cf1093e4da0cf2462e793bfbce1/crates/ruff_linter/src/rules/isort/snapshots/ruff_linter__rules__isort__tests__lines_after_imports.pyi.snap</p>
<p>In the above rendering, the <code>^</code> is pointing to a class definition, but it should be pointing to an import statement. After #15359 is merged, the rendering will improve somewhat to this:</p>
<pre><code>lines_after_imports.pyi:1:1: I001 [*] Import block is un-sorted or un-formatted
   |
 1 | / from __future__ import annotations
 2 | |
 3 | | from typing import Any
 4 | |
 5 | | from requests import Session
 6 | |
 7 | | from my_first_party import my_first_party_object
 8 | |
 9 | | from . import my_local_folder_object
10 | |
11 | |
12 | |
   | |__^ I001
13 |   class Thing(object):
14 |     name: str
15 |     def __init__(self, name: str):
   |
   = help: Organize imports
</code></pre>
<p>This is <em>better</em>, but still not ideal. However, this isn't a problem in the diagnostic rendering itself (which is what #15359 didn't address it), but rather, in the spans generated by the <code>I001</code> lint. To demonstrate, this is a minimal reproducer I made by debug printing the <code>annotate-snippets::Message</code> when running the above test:</p>
<pre><code class="language-rust">use annotate_snippets::{Level, Renderer, Snippet};

fn main() {
    let source = &quot;from __future__ import annotations\n\nfrom typing import Any\n\nfrom requests import Session\n\nfrom my_first_party import my_first_party_object\n\nfrom . import my_local_folder_object\n\n\n\nclass Thing(object):\n  name: str\n  def __init__(self, name: str):\n&quot;;
    let src_annotation = Level::Error.span(0..180).label(&quot;I001&quot;);
    let snippet =
        Snippet::source(source).line_start(1).annotation(src_annotation);
    let message = Level::Error.title(&quot;&quot;).snippet(snippet);

    println!(&quot;{}&quot;, Renderer::plain().render(message));
}
</code></pre>
<p>This outputs the same rendering as above. And the span, <code>0..180</code>, corresponds to this substring:</p>
<pre><code>from __future__ import annotations\n\nfrom typing import Any\n\nfrom requests import Session\n\nfrom my_first_party import my_first_party
_object\n\nfrom . import my_local_folder_object\n\n\n\n
</code></pre>
<p>So whatever is generating the spans here is including those empty lines at the end. We should fix the span generation to be tighter. (It's perhaps as simple as trimming the trailing lines from the range.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @BurntSushi on 2025-01-15 15:34</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">help wanted</span> added by @BurntSushi on 2025-01-15 15:34</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">diagnostics</span> added by @AlexWaygood on 2025-01-15 16:22</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dylwil3">@dylwil3</a> on 2025-01-15 21:19</div>
            <div class="timeline-body"><p>Edit: Ignore this, see comment below</p>
<p>This is confusing because if I add a debug print to display the line number, it seems to give the right answer for the range emitted from the lint:</p>
<pre><code class="language-console">&gt; cargo run -p ruff -- check tmp.py --no-cache --preview --isolated --select I001
[crates/ruff_linter/src/rules/isort/rules/organize_imports.rs:96:5] &amp;range = 0..176
[crates/ruff_linter/src/rules/isort/rules/organize_imports.rs:97:5] locator.compute_source_location(range.end()) = SourceLocation {
    row: 9,
    column: 37,
}
tmp.py:1:1: I001 [*] Import block is un-sorted or un-formatted
   |
 1 | / from __future__ import annotations
 2 | |
 3 | | from typing import Any
 4 | |
 5 | | from requests import Session
 6 | |
 7 | | from my_first_party import my_first_party_object
 8 | |
 9 | | from . import my_local_folder_object
10 | |
11 | |
12 | |
   | |__^ I001
13 |   class Foo:...
   |
   = help: Organize imports

Found 1 error.
[*] 1 fixable with the `--fix` option.
</code></pre>
<p>Is there some transformation done to the range before it gets to the diagnostic/user?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-01-15 21:39</div>
            <div class="timeline-body"><p><code>annotated-snippet</code> determines where to draw the arrow. It's quiet possible that there's a bug if the range points to the end of the line?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dylwil3">@dylwil3</a> on 2025-01-15 22:05</div>
            <div class="timeline-body"><p>ah, actually my mistake - I was printing the range from the &quot;early return&quot; diagnostic. there's additional logic in the lint that makes a different range, which explicitly includes trailing whitespace:</p>
<p>https://github.com/astral-sh/ruff/blob/c034e280a9d1c9e7fc312699f57115987f5850d2/crates/ruff_linter/src/rules/isort/rules/organize_imports.rs#L135-L136</p>
<p>It looks like this choice is related to implementing the fix.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @dylwil3 by @dylwil3 on 2025-01-15 22:12</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @dylwil3 on 2025-01-18 17:08</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 11:36:18 UTC
    </footer>
</body>
</html>
