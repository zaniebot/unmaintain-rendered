<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Autofix or better error message/docs for PERF401 + walrus operator - astral-sh/ruff #13621</title>
    <link rel="stylesheet" href="../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../index.html">Back to index</a>
    </div>

    <h1>Autofix or better error message/docs for PERF401 + walrus operator</h1>

    <div class="meta">
        <span class="state state-closed">Closed</span>
        <a href="https://github.com/astral-sh/ruff/issues/13621">#13621</a>
        opened by <a href="https://github.com/jamesbraza">@jamesbraza</a>
        on 2024-10-03 23:13
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/jamesbraza">@jamesbraza</a> on 2024-10-03 23:13</div>
            <div class="timeline-body"><p>With this code:</p>
<pre><code class="language-python">my_list = []
for element in my_list:
    if walrus_element := element:
        my_list.append(walrus_element)
</code></pre>
<p><code>ruff==0.6.7</code>'s <a href="https://docs.astral.sh/ruff/rules/manual-list-comprehension/">PERF401</a> errors like so: <code>PERF401 Use a list comprehension to create a transformed list</code></p>
<p>However, due to the walrus operator (also see https://github.com/astral-sh/ruff/issues/6056), the fix involves putting parenthesis around the walrus.</p>
<p>This is just confusing enough that at first one thinks it's a PERF401 false positive. The request here is to either:</p>
<ul>
<li>Document this special case in the PERF401 docs</li>
<li>Emit a special and more specific PERF401 error message when a walrus operator is present</li>
<li>Implement an autofix for PERF401 that knows about the parenthesis</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-10-04 01:51</div>
            <div class="timeline-body"><p>There's never an autofix for PERF401 now, right? I'm a bit confused about why this case feels like a false positive, can you share a bit more?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/jamesbraza">@jamesbraza</a> on 2024-10-04 03:06</div>
            <div class="timeline-body"><p>Yeah there's no autofix, I was trying to say a possible solution is just doing an autofix.</p>
<p>Does this clarify? It's that what the PERF401 docs suggest in this case is a <code>SyntaxError</code>:</p>
<pre><code class="language-python">my_list = []
for element in my_list:
    if walrus_element := element:
        my_list.append(walrus_element)

# What ruff's PERF401 docs say, which leads to: SyntaxError: invalid syntax
my_list = [
    walrus_element for element in my_list if walrus_element := element
]

# What you actually need to do is know this parenthesis trick
my_list = [
    walrus_element for element in my_list if (walrus_element := element)
]
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">question</span> added by @MichaReiser on 2024-10-07 08:03</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">question</span> removed by @MichaReiser on 2024-10-07 08:06</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">documentation</span> added by @MichaReiser on 2024-10-07 08:06</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-10-07 08:07</div>
            <div class="timeline-body"><p>I can see how the walrus case is confusing because it requires manual code adjusting to make it valid syntax. However, our goal is to keep the documentation concise and that doesn't leave room to document every possible syntax combination.</p>
<blockquote>
<p>Yeah there's no autofix, I was trying to say a possible solution is just doing an autofix.</p>
</blockquote>
<p>I understand that a fix is desirable, but implementing a code fix is often very involved, especially in cases like the one you outline above. We would accept a code fix implementation if someone is interested in working on it.</p>
<p>I'm closing this as not planned. While I agree that finding the right fix in the walrus case is somewhat more involved, the rule documentation isn't the right place to teach this. An automatic fix would be nice but it can be added without a tracking issue</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @MichaReiser on 2024-10-07 08:07</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/jamesbraza">@jamesbraza</a> on 2024-10-07 15:41</div>
            <div class="timeline-body"><p>I follow your logic and sounds good üëç</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:28:13 UTC
    </footer>
</body>
</html>
