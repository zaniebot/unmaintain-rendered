<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>`C417` has multiple problems - astral-sh/ruff #15809</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>`C417` has multiple problems</h1>

    <div class="meta">
        <span class="state state-open">Open</span>
        <a href="https://github.com/astral-sh/ruff/issues/15809">#15809</a>
        opened by <a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a>
        on 2025-01-29 14:16
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a> on 2025-01-29 14:16</div>
            <div class="timeline-body"><p>While working on #15802, I noticed a few problems with <a href="https://docs.astral.sh/ruff/rules/unnecessary-map/"><code>C417</code></a> (<a href="https://play.ruff.rs/f6b44cea-27b5-44c5-bdab-f8c9678fe99f">playground</a>).</p>
<p>When <code>list</code>/<code>set</code>/<code>dict</code> from the outer call is an overshadowed binding, the inner <code>map()</code> call is not reported at all:</p>
<pre><code class="language-python">	map(lambda x: x, [])
#   ^^^^^^^^^^^^^^^^^^^^ Reported

	list(map(lambda x: x, []))
#   ^^^^^^^^^^^^^^^^^^^^^^^^^^ Outer `list()` call reported, nested `map()` call not reported

	def _():
		list = ...  # Overshadowed

		map(lambda x: x, [])
#       ^^^^^^^^^^^^^^^^^^^^ Reported

		list(map(lambda x: x, []))  # Currently no error
#            ^^^^^^^^^^^^^^^^^^^^ This should be reported on its own merit
</code></pre>
<p>If the iterable is a starred expression, the fix outputs a comprehension with different semantics:</p>
<pre><code class="language-python">a = [(1, 2), (3, 4)]

# Before
map(lambda x: [*x, 10], *a)  # TypeError: &lt;lambda&gt;() takes 1 positional argument but 2 were given

# After
([*x, 10] for x in a)        # [1, 2, 10], [3, 4, 10]
</code></pre>
<p><code>map()</code> calls over named expressions are not rewritten, but <code>list(map())</code>/<code>set(map())</code>/<code>dict(map())</code> are:</p>
<pre><code class="language-python"># Before
map(lambda x: x + 10, (a := []))
list(map(lambda x: x + 10, (a := [])))
set(map(lambda x: x + 10, (a := [])))
dict(map(lambda x: (x, 10), (a := [])))

# After
map(lambda x: x + 10, (a := []))
[x + 10 for x in (a := [])]  # Undetected syntax error
{x + 10 for x in (a := [])}  # Undetected syntax error
{x: 10 for x in (a := [])}   # Undetected syntax error
</code></pre>
<p>The rule currently also doesn't report when there are multiple iterables:</p>
<pre><code class="language-python">map(lambda x, y: x + y, a, b)  # Currently no error

# Can be simplified to:
(x + y for x, y in zip(a, b))
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/15802.html">astral-sh/ruff#15802</a> on 2025-01-29 15:21</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @charliermarsh on 2025-01-29 15:59</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/15876.html">astral-sh/ruff#15876</a> on 2025-02-02 00:47</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/15955.html">astral-sh/ruff#15955</a> on 2025-02-05 01:01</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/enkiusz">@enkiusz</a> on 2025-11-06 14:16</div>
            <div class="timeline-body"><p>Double parenthesis are also sometimes introduced, for example:</p>
<pre><code class="language-shell">$ ruff cat test.py
d = {
    'ep': [
        { 'c': 21 },
        { 'c': 22 }
    ]
}

sum(map(lambda x: x.c, d['ep']))

$ ruff ruff check --fix --unsafe-fixes --show-fixes test.py
Fixed 1 error:
- test.py:
    1 × C417 (unnecessary-map)

Found 1 error (1 fixed, 0 remaining).                                                                               
➜  ruff cat test.py
d = {
    'ep': [
        { 'c': 21 },
        { 'c': 22 }
    ]
}

sum((x.c for x in d['ep']))

$ ruff 
</code></pre>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:34:54 UTC
    </footer>
</body>
</html>
