<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weird conflict between formatter and linter fix all - astral-sh/ruff #10624</title>
    <link rel="stylesheet" href="../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../index.html">Back to index</a>
    </div>

    <h1>Weird conflict between formatter and linter fix all</h1>

    <div class="meta">
        <span class="state state-open">Open</span>
        <a href="https://github.com/astral-sh/ruff/issues/10624">#10624</a>
        opened by <a href="https://github.com/mgzenitech">@mgzenitech</a>
        on 2024-03-27 08:59
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/mgzenitech">@mgzenitech</a> on 2024-03-27 08:59</div>
            <div class="timeline-body"><!--
Thank you for taking the time to report an issue! We're glad to have you involved with Ruff.

If you're filing a bug report, please consider including the following information:

* List of keywords you searched for before creating this issue. Write them down here so that others can find this issue more easily and help provide feedback.
  e.g. "RUF001", "unused variable", "Jupyter notebook"
* A minimal code snippet that reproduces the bug.
* The command you invoked (e.g., `ruff /path/to/file.py --fix`), ideally including the `--isolated` flag.
* The current Ruff settings (any relevant sections from your `pyproject.toml`).
* The current Ruff version (`ruff --version`).
-->

<p>Here are two files:</p>
<pre><code>#!/usr/bin/env -S poetry run python

from typing import Any
from toml import load

# @BUG: https://github.com/darrenburns/ward/issues/378
from ward import Scope, fixture  # pyright: ignore [reportUnknownVariableType]
</code></pre>
<p>and</p>
<pre><code>#!/usr/bin/env -S poetry run python

from collections.abc import Callable
from typing import Any
from unittest.mock import MagicMock

# @BUG: https://github.com/darrenburns/ward/issues/378
from ward import Scope, fixture  # pyright: ignore [reportUnknownVariableType]
</code></pre>
<p>First one doesn't have any issues yet the second one is triggering <code>I001</code>,</p>
<p>.ruff.toml:</p>
<pre><code>builtins = [
  &quot;_&quot;
]
cache-dir = &quot;tmp/ruff&quot;
preview = true
target-version = &quot;py312&quot;
unsafe-fixes = true

[format]
docstring-code-format = true
docstring-code-line-length = 120
line-ending = &quot;lf&quot;

[lint]
dummy-variable-rgx = &quot;^_$&quot;
extend-select = [
  &quot;D213&quot;
]
ignore = [
  &quot;CPY001&quot;,
  &quot;D212&quot;
]
select = [
  &quot;ALL&quot;
]
task-tags = [
  &quot;@BUG&quot;,
  &quot;@HACK&quot;,
  &quot;@TODO&quot;
]

[lint.isort]
combine-as-imports = true
force-sort-within-sections = true
lines-after-imports = 2
no-lines-before = [
  &quot;first-party&quot;,
  &quot;future&quot;,
  &quot;local-folder&quot;,
  &quot;standard-library&quot;,
  &quot;third-party&quot;
]

[lint.pycodestyle]
max-doc-length = 120
max-line-length = 120

[lint.pydocstyle]
convention = &quot;google&quot;

[lint.pylint]
allow-magic-value-types = [
]

[lint.flake8-annotations]
allow-star-arg-any = true
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-03-27 09:28</div>
            <div class="timeline-body"><p>Thanks for reporting this bug.</p>
<p>The issue here is that the formatter enforces a blank line between two imports if there's an own-line comment between them (similar to black).</p>
<pre><code class="language-py">from unittest.mock import MagicMock
# @BUG: https://github.com/darrenburns/ward/issues/378
from ward import Scope, fixture  # pyright: ignore [reportUnknownVariableType]
</code></pre>
<p>Gets reformatted to</p>
<pre><code class="language-py">from unittest.mock import MagicMock

# @BUG: https://github.com/darrenburns/ward/issues/378
from ward import Scope, fixture  # pyright: ignore [reportUnknownVariableType]
</code></pre>
<p>Now, <code>isort</code> doesn't agree with the blank line because of the <code>no-lines-before</code>  configuration.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">isort</span> added by @MichaReiser on 2024-03-27 09:28</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">formatter</span> added by @MichaReiser on 2024-03-27 09:28</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">incompatibility</span> added by @MichaReiser on 2024-03-27 09:28</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/mgzenitech">@mgzenitech</a> on 2024-03-27 09:34</div>
            <div class="timeline-body"><p>Will formatter be updated to take into account .ruff.toml config of isort?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-03-27 09:51</div>
            <div class="timeline-body"><p>I need to think in more detail about what the best solution here is. We want to avoid that the <code>formatter</code> needs to read the <code>isort</code> configuration and reimplement the same logic (the formatter doesn't know about first-party-imports etc).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/mgzenitech">@mgzenitech</a> on 2024-03-27 14:59</div>
            <div class="timeline-body"><p>I think I've found a bunch of other issues too with formatter conflicting lint fix. Long term formatter should be compatible with linter config file...</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-03-27 15:01</div>
            <div class="timeline-body"><p>For what it's worth, by far the best way to ensure compatibility is to avoid highly customized formatting rules or configuration in the linter (e.g., modifying the <code>isort</code> settings). It's possible that we don't end up &quot;fixing&quot; those and instead just mark them as incompatible with user-facing warnings, as with other formatter-conflicting lint rules and settings (see: https://docs.astral.sh/ruff/formatter/#conflicting-lint-rules).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ERW105">@ERW105</a> on 2025-02-02 10:30</div>
            <div class="timeline-body"><blockquote>
<p>I need to think in more detail about what the best solution here is. We want to avoid that the <code>formatter</code> needs to read the <code>isort</code> configuration and reimplement the same logic (the formatter doesn't know about first-party-imports etc).</p>
</blockquote>
<p>In the original isort, it appears that <code>ensure_newline_before_comments</code> takes priority over <code>no_lines_before</code>, such that there is always a newline before comments and the output is black-compatible. Including when a comment is before the first import of a <code>no_lines_before</code> section.</p>
<p><code>ensure_newline_before_comments</code> is part of isort's black profile and I assume the behavior ruff implements implicitly. Perhaps this divergence is unintended? I don't think we need the formatter to be involved here.</p>
<p>Super impressed with ruff and would love to keep using <code>no-lines-before</code>!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-02-03 14:29</div>
            <div class="timeline-body"><p>Nice find @ERW105 Yes, implementing the behavior of <code>ensure_newline_before_comments</code> -- at least if <code>no_lines_before = 0</code> (without adding an option) is probably the solution here, although it is a breaking change.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:28:12 UTC
    </footer>
</body>
</html>
