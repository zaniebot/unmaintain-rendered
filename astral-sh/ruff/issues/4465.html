<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>False positive `B030` when using `*exc_types or ValueError` - astral-sh/ruff #4465</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>False positive <code>B030</code> when using <code>*exc_types or ValueError</code></h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/issues/4465">#4465</a>
        opened by <a href="https://github.com/jamesbraza">@jamesbraza</a>
        on 2023-05-17 06:28
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/jamesbraza">@jamesbraza</a> on 2023-05-17 06:28</div>
            <div class="timeline-body"><!--
Thank you for taking the time to report an issue! We're glad to have you involved with Ruff.

If you're filing a bug report, please consider including the following information:

* A minimal code snippet that reproduces the bug.
* The command you invoked (e.g., `ruff /path/to/file.py --fix`), ideally including the `--isolated` flag.
* The current Ruff settings (any relevant sections from your `pyproject.toml`).
* The current Ruff version (`ruff --version`).
-->

<p><code>ruff==0.0.265</code> has a false positive <code>B030</code>:</p>
<pre><code class="language-python">def foo(msg: str, *exc_types: type[Exception]) -&gt; None:
    try:
        raise ValueError(msg)
    except exc_types or ValueError as exc:
        print(exc)


foo(&quot;BOOM&quot;)
foo(&quot;BOOM2&quot;, ValueError)
foo(&quot;BOOM3&quot;, ValueError, IndexError)
</code></pre>
<pre><code class="language-bash">&gt; ruff --select=B030 a.py
a.py:4:12: B030 `except` handlers should only be exception classes or tuples of exception classes
Found 1 error.
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/tjkuson">@tjkuson</a> on 2023-05-17 08:30</div>
            <div class="timeline-body"><p>I don't think this is a false positive; binary operations shouldn't be used in <code>except</code> clauses, as, in your example, only the first exceptions (<code>exc_types</code>) will be caught.</p>
<p>Doing this instead passes the check and should work as you intend.</p>
<pre><code class="language-python">def foo(msg: str, *exc_types: type[Exception]) -&gt; None:
    try:
        raise ValueError(msg)
    except (*exc_types, ValueError) as exc:
        print(exc)


foo(&quot;BOOM&quot;)
foo(&quot;BOOM2&quot;, ValueError)
foo(&quot;BOOM3&quot;, ValueError, IndexError)
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-05-17 13:22</div>
            <div class="timeline-body"><p>Yeah this looks like a true positive to me. What behavior are you seeing, and what are you expecting?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">question</span> added by @charliermarsh on 2023-05-17 13:22</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/jamesbraza">@jamesbraza</a> on 2023-05-17 19:08</div>
            <div class="timeline-body"><p>Yeah thanks for asking for clarification!</p>
<p>The <code>or ValueError</code> is a valid use case, it's basically the fallback if no <code>exc_types</code> were passed.</p>
<details>
<summary> Original Unclear Snippet's Extension</summary>

<p>The below code (paired with the <code>foo</code> in the OP) might also help, if you want to play around with something.</p>
<pre><code class="language-python">import pytest

def foo(msg: str, *exc_types: type[Exception]) -&gt; None:
    try:
        raise ValueError(msg)
    except exc_types or ValueError as exc:
        print(exc)

foo(&quot;BOOM&quot;)  # Rely on `or ValueError` fallback
foo(&quot;BOOM2&quot;, ValueError)  # Manually passing
foo(&quot;BOOM3&quot;, ValueError, IndexError)  # Manually passing multiple

# Here we don't catch the ValueError as we don't include in `exc_types`
with pytest.raises(ValueError, match=&quot;BOOM4&quot;):
    foo(&quot;BOOM4&quot;, KeyError, IndexError)
with pytest.raises(ValueError, match=&quot;BOOM5&quot;):
    foo(&quot;BOOM5&quot;, KeyError)
</code></pre>
</details>

<hr />
<p>Let's start anew with a better snippet:</p>
<pre><code class="language-python"># I can contain 0+ Exceptions
# When I contain 1+ Exceptions and don't include ValueError,
# it overrides the default behavior
exc_types: tuple[type[Exception], ...] = ()

try:
    pass  # Some code
except exc_types or ValueError as exc:
    pass  # Some handling code
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-05-18 00:54</div>
            <div class="timeline-body"><p>Ahhh I see! Thanks for sharing. That makes sense.</p>
<p>I see how this could be considered a false positive, but to be honest, I think this is the rule working as intended. The pattern that's being used here, even if it has the correct runtime behavior, is confusing -- as evidence, the two readers on this issue thought the intended behavior was different from the author's intended behavior. I'd argue that it's correct for the rule to flag this case, even if the runtime behavior is correct.</p>
<p>My humble suggestion would be to assign <code>exc_types or ValueError</code> to a temporary variable and match on that, which IMO is clearer.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2023-05-18 00:54</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 11:30:06 UTC
    </footer>
</body>
</html>
