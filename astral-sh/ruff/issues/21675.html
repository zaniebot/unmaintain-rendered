<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Incorrect Line Number Reporting when Importing scienceplots - astral-sh/ruff #21675</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Incorrect Line Number Reporting when Importing scienceplots</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/issues/21675">#21675</a>
        opened by <a href="https://github.com/cospeng">@cospeng</a>
        on 2025-11-28 13:06
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/cospeng">@cospeng</a> on 2025-11-28 13:06</div>
            <div class="timeline-body"><h3>Summary</h3>
<p>I am encountering an issue with Ruff when importing the scienceplots library in my Python code. Specifically, when I import scienceplots, the line number in the error reports appears to be incorrect. The error is reported on the line above the actual line where the problem occurs.</p>
<p><strong>Steps to Reproduce:</strong></p>
<p>Create a Python script with the following content:</p>
<pre><code>import scienceplots
a == 9
</code></pre>
<p>Run Ruff static analysis on the script.</p>
<p>The error will be reported on the line 1, even though the actual error occurs on the line 2.</p>
<p><strong>Expected Behavior:</strong></p>
<p>The error should be reported on the actual line where the issue occurs, without any discrepancy in the reported line number.</p>
<p><strong>Possible Cause:</strong></p>
<p>The likely reason for the error is that the imported scienceplots library isn't explicitly used in the code. I tried replacing it with other libraries, such as numpy—importing it without actually calling or using it—and encountered the same issue.</p>
<p><strong>Environment:</strong></p>
<p>Ruff version: 0.14.6</p>
<p>Python version: 3.13</p>
<p>Operating system:windows11 vim(ale+ruff)</p>
<h3>Version</h3>
<p>0.14.6</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-11-28 13:17</div>
            <div class="timeline-body"><p>Can you tell me more how you run Ruff? The line numbers all look correct to me:</p>
<pre><code>D100 Missing docstring in public module
--&gt; test.py:1:1

I001 [*] Import block is un-sorted or un-formatted
 --&gt; test.py:1:1
  |
1 | import scienceplots
  | ^^^^^^^^^^^^^^^^^^^
2 | a == 9
  |
help: Organize imports

F401 [*] `scienceplots` imported but unused
 --&gt; test.py:1:8
  |
1 | import scienceplots
  |        ^^^^^^^^^^^^
2 | a == 9
  |
help: Remove unused import: `scienceplots`

B015 Pointless comparison. Did you mean to assign a value? Otherwise, prepend `assert` or remove it.
 --&gt; test.py:2:1
  |
1 | import scienceplots
2 | a == 9
  | ^^^^^^
  |

F821 Undefined name `a`
 --&gt; test.py:2:1
  |
1 | import scienceplots
2 | a == 9
  | ^
  |

PLR2004 Magic value used in comparison, consider replacing `9` with a constant variable
 --&gt; test.py:2:6
  |
1 | import scienceplots
2 | a == 9
  |      ^
  |

Found 6 errors.
[*] 2 fixable with the `--fix` option.
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">needs-info</span> added by @MichaReiser on 2025-11-28 13:17</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/cospeng">@cospeng</a> on 2025-11-29 04:17</div>
            <div class="timeline-body"><p>Thanks for the quick response!</p>
<p>I’m using <strong>Ruff through ALE (Asynchronous Lint Engine) in Vim on Windows</strong>, not via the command line. The line number issue <strong>only appears when I enable <code>--fix</code> in ALE’s Ruff options</strong>. When I comment out that line, all diagnostics show correct line numbers.</p>
<p>Here’s my relevant ALE configuration:</p>
<pre><code class="language-vim">let g:ale_linters = {'python': ['ruff']}
let g:ale_fixers  = {'python': ['ruff']}
let g:ale_fix_on_save = 1
let g:ale_python_ruff_options = '--fix'   &quot; ← this triggers the issue
</code></pre>
<p>From <code>:ALEInfo</code>, here’s the actual command ALE runs:</p>
<pre><code class="language-text">ruff check -q --no-fix --fix --output-format json-lines --stdin-filename C:\Users\pyxuan\Documents\Python\todo\test.py - &lt; C:\Users\pyxuan\AppData\Local\Temp\VMQ7276.tmp\test.py
</code></pre>
<p>And the output was:</p>
<pre><code class="language-json">a == 1
{&quot;cell&quot;:null,&quot;code&quot;:&quot;F821&quot;,&quot;end_location&quot;:{&quot;column&quot;:2,&quot;row&quot;:1},&quot;filename&quot;:&quot;C:\\Users\\..\\test.py&quot;,&quot;fix&quot;:null,&quot;location&quot;:{&quot;column&quot;:1,&quot;row&quot;:1},&quot;message&quot;:&quot;Undefined name `a`&quot;,&quot;noqa_row&quot;:1,&quot;url&quot;:&quot;https://docs.astral.sh/ruff/rules/undefined-name&quot;}
</code></pre>
<p>Notice that <strong>the content sent to Ruff via stdin is only <code>a == 1</code></strong> — meaning the <code>import scienceplots</code> line was already removed (likely because Ruff fixed the unused import before linting). So Ruff correctly reports the error on <code>row: 1</code> <strong>relative to the modified input</strong>.</p>
<p>However, in my <strong>original file</strong>, that line is actually <strong>line 2</strong>, so ALE displays the diagnostic on the wrong line in the editor.</p>
<p>Since running <code>ruff check test.py</code> directly in PowerShell shows correct line numbers, this seems to be an <strong>integration issue between ALE and Ruff in <code>--fix</code> mode on Windows</strong>, possibly related to how ALE pipes the buffer content after applying fixes.</p>
<p>Thanks again for your help! Let me know if you’d still like more details (e.g., full file content, ALE logs).</p>
<p>And if this turns out to be relevant to ALE’s side, I’m happy to open an issue there too.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-11-29 14:51</div>
            <div class="timeline-body"><blockquote>
<p>Notice that the content sent to Ruff via stdin is only a == 1 — meaning the import scienceplots line was already removed (likely because Ruff fixed the unused import before linting). So Ruff correctly reports the error on row: 1 relative to the modified input.</p>
</blockquote>
<p>Interesting, why does ale only sent the second line to Ruff rather than the entire document?</p>
<p>I don't see how Ruff should know about the correct line numbers if it doesn't receive the entire document. I think ALE either has to send the entire buffer or patch up Ruff's line numbers and convert them from relative to absolute line numbers again</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/cospeng">@cospeng</a> on 2025-11-30 06:03</div>
            <div class="timeline-body"><p>Thanks for the help and clarification.</p>
<p>After further investigation, I can confirm that <strong>Ruff is reporting line numbers correctly</strong> based on the input it receives. The issue arises because <strong>ALE applies fixes first and then lints the <em>modified</em> buffer</strong>, which no longer matches the original file structure.</p>
<p>In my case:</p>
<ul>
<li>Original file had unused imports (e.g., <code>import scienceplots</code>);</li>
<li>ALE ran <code>ruff --fix</code>, which removed those lines;</li>
<li>It then passed the <strong>fixed (shorter) content</strong> to Ruff for linting;</li>
<li>Ruff correctly reported errors relative to that input (e.g., <code>row: 1</code>);</li>
<li>But ALE displayed those diagnostics against the original buffer without remapping line numbers.</li>
</ul>
<p>So the root cause lies in <strong>how ALE integrates Ruff in <code>--fix</code> mode</strong>, not in Ruff itself.<br />
I’ve worked around it by configuring ALE to <strong>not pass <code>--fix</code> to the linter</strong>, only to the fixer:</p>
<pre><code class="language-vim">let g:ale_python_ruff_options = ''   &quot; linter: no --fix
let g:ale_fixers = {'python': ['ruff']}
let g:ale_fix_on_save = 1
</code></pre>
<p>This ensures linting happens on the full original buffer, preserving correct line numbers.</p>
<p>Appreciate your support — feel free to close this issue!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @MichaReiser on 2025-11-30 10:49</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 11:38:47 UTC
    </footer>
</body>
</html>
