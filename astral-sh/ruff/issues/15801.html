<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>pyproject.toml fix-only=True cannot be toggled per directory by using multiple pyproject.toml files and the extend setting. - astral-sh/ruff #15801</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>pyproject.toml fix-only=True cannot be toggled per directory by using multiple pyproject.toml files and the extend setting.</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/ruff/issues/15801">#15801</a>
        opened by <a href="https://github.com/jogo-openai">@jogo-openai</a>
        on 2025-01-29 00:55
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/jogo-openai">@jogo-openai</a> on 2025-01-29 00:55</div>
            <div class="timeline-body"><h3>Description</h3>
<p>I am trying to enable <code>fix-only</code> for some directories and not for others, while running <code>ruff check .</code> in the repo root directory.</p>
<p>Ruff <code>fix-only</code> config option doesn't seem to use the 'closest' config file for each individual file.</p>
<p>https://docs.astral.sh/ruff/configuration/#config-file-discovery</p>
<pre><code>$ ruff --version
ruff 0.9.3
</code></pre>
<pre><code class="language-.">├── foo
│   ├── bar.py
│   └── pyproject.toml
└── pyproject.toml
</code></pre>
<p><code>pyproject.toml</code>:</p>
<pre><code>[tool.ruff]
lint.select = [&quot;F&quot;]
</code></pre>
<p><code>foo/pyproject.toml</code>:</p>
<pre><code>[tool.ruff]
extend = &quot;../pyproject.toml&quot;
fix-only = true
</code></pre>
<p><code>foo/bar.py</code>:</p>
<pre><code class="language-python">import os

from __future__ import annotations
</code></pre>
<p>When running <code>ruff check from the root directory here, I expect it to use </code>fix-only<code>from</code>foo/pyproject.toml<code>since it's the closest config file to</code>foo/bar.py` but it doesn't.</p>
<pre><code>$ ruff check .
foo/bar.py:1:8: F401 [*] `os` imported but unused
  |
1 | import os
  |        ^^ F401
2 |
3 | from __future__ import annotations
  |
  = help: Remove unused import: `os`

foo/bar.py:3:1: F404 `from __future__` imports must occur at the beginning of the file
  |
1 | import os
2 |
3 | from __future__ import annotations
  | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ F404
  |

Found 2 errors.
[*] 1 fixable with the `--fix` option.
</code></pre>
<p>When running from the directory foo, the same command respects <code>fix-only</code> from <code>foo/pyproject.toml</code>.</p>
<pre><code>$ ruff check .
Fixed 1 error.
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @dylwil3 on 2025-01-29 18:15</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">configuration</span> added by @dylwil3 on 2025-01-29 18:15</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> removed by @dylwil3 on 2025-01-29 18:23</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dylwil3">@dylwil3</a> on 2025-01-29 18:29</div>
            <div class="timeline-body"><p>Thank you! I'm able to reproduce this behavior.</p>
<p>Trying to decide if this should be a bug, feature request, or expected behavior that is not documented. For comparison, the same sort of thing happens if you have conflicting settings for <code>output-format</code> or <code>show-fixes</code>, etc. It feels like it should be expected behavior for &quot;display&quot; settings but a bug/feature request for settings like <code>fix</code> and <code>fix-only</code>. But this probably needs some input from others.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">needs-decision</span> added by @dylwil3 on 2025-01-29 18:29</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-02-02 16:21</div>
            <div class="timeline-body"><p>This is the expected behavior as it is a global setting that affects the entire CLI, similar to other settings like <code>output-format</code>, <code>show-fixes</code>, etc.</p>
<p>Can you try using <code>unsafe-fixes = [ALL]</code> in the directories where you want to disable fixes? However, that only works as long as you don't want to fix unsafe fixes with <code>--fix</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/jogo-openai">@jogo-openai</a> on 2025-02-03 19:06</div>
            <div class="timeline-body"><blockquote>
<p>Can you try using <code>unsafe-fixes = [ALL]</code> in the directories where you want to disable fixes? However, that only works as long as you don't want to fix unsafe fixes with <code>--fix</code></p>
</blockquote>
<p>We are hoping to do the opposite, have fixes enabled everywhere but only fail some projects on checks without fixes.</p>
<p>We are hoping to do something like this:</p>
<p>Have a single CI job that runs across multiple projects in a single repo that calls <code>ruff check --fix</code>, where  all projects have the fix items enabled and a subset of projects can opt into failing on fixes that don't have a fix for them.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dylwil3">@dylwil3</a> on 2025-02-04 02:29</div>
            <div class="timeline-body"><p>I wonder if a version of https://github.com/astral-sh/ruff/issues/1256 could achieve this- where the warning level was hierarchically configurable?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-02-04 07:48</div>
            <div class="timeline-body"><blockquote>
<p>I wonder if a version of <a href="https://github.com/astral-sh/ruff/issues/1256">#1256</a> could achieve this- where the warning level was hierarchically configurable?</p>
</blockquote>
<p>You mean by setting all rules without a fix to severity warning? It sounds somewhat cumbersome or even impossible because it would require setting all rules without a fix to severity error but some rules only sometimes have a fix.</p>
<p>I do think that Red Knot's new rule configuration should help where the configuration allows to override <code>fixability</code> for a subset of files. But that still sounds rather annoying.</p>
<p>I think my recommendation here is to run ruff multiple times. Either per-project other at least twice: once over the projects that want to apply fixes and a second time over projects that don't want to apply fixes.</p>
<p>It does sound to me that this is a mono repository setup.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/jogo-openai">@jogo-openai</a> on 2025-02-04 16:51</div>
            <div class="timeline-body"><blockquote>
<p>I think my recommendation here is to run ruff multiple times. Either per-project other at least twice: once over the projects that want to apply fixes and a second time over projects that don't want to apply fixes.</p>
<p>It does sound to me that this is a mono repository setup.</p>
</blockquote>
<p>This is a monorepo setup, where <em>all projects apply automatic fixes</em> but some want to additionally fail for ruff check rules that cannot be automatically fixed.</p>
<p>Today we already run <code>ruff check --fix-only --exit-non-zero-on-fix</code> over everything, but to run <code>ruff check</code> on the subset of projects that want to additionally fail on that command, we would either:</p>
<ul>
<li>Generate some sort of centralized list of projects that opt-in. Project CI definition for everything else is located per project, so we would need something clunky here</li>
<li>Run a separate ruff CI step for each project that opts in, in which case the setup overhead for these jobs would be much greater than the time it takes for ruff to run in each case.</li>
</ul>
<p>We can make this approach work it just seems less efficient and/or more awkward.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-02-04 17:56</div>
            <div class="timeline-body"><p>Yeah I understand. Thanks for the extra context. Ruff doesn't have a solution for this today and it's not obvious to me how we'd change Ruff to make this work on a project level. It requires some more design thinking, and it probably is a while before we have time to dig into this more.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/jogo-openai">@jogo-openai</a> on 2025-02-04 20:57</div>
            <div class="timeline-body"><p>Thanks @MichaReiser we will go with one of the workaround for now, much appreciated.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 01:30:16 UTC
    </footer>
</body>
</html>
