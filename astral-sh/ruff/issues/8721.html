<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>New rule suggestion: Force parentheses in `A or B and C` - astral-sh/ruff #8721</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>New rule suggestion: Force parentheses in <code>A or B and C</code></h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/issues/8721">#8721</a>
        opened by <a href="https://github.com/JelleZijlstra">@JelleZijlstra</a>
        on 2023-11-16 14:38
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/JelleZijlstra">@JelleZijlstra</a></div>
            <div class="timeline-body"><p>When I see code like <code>A or B and C</code>, I never know immediately whether it means <code>(A or B) and C</code> or <code>A or (B and C)</code>. (The answer is the latter; <code>and</code> has higher precedence than <code>or</code>.) I would suggest adding a lint rule that triggers if an <code>and</code> operation contains an unparenthesized <code>or</code>, or if an <code>or</code> contains an unparenthesized <code>and</code>.</p>
<p>I considered implementing this in flake8-bugbear or Black, but this rule can't be implemented on the AST, so it's hard to do in flake8-bugbear. It could be done in Black, but I would like to be able to see violations of this rule explicitly listed so I can check for possible bugs, and that's easier to do in a linter.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2023-11-16 15:20</div>
            <div class="timeline-body"><p>I like it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">rule</span> added by @zanieb on 2023-11-16 15:20</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/tjkuson">@tjkuson</a> on 2023-12-02 13:28</div>
            <div class="timeline-body"><p>Would it be possible for this rule to also lint against the use of compound <code>in</code> comparisons without parentheses? <code>False == False in [False]</code> evaluating to <code>True</code> is likely unintended and surprising.</p>
<p>EDIT: Actually, this might be better as a different rule due to the AST differences.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-01-08 10:19</div>
            <div class="timeline-body"><p>(I'm having a go at implementing this.)</p>
<p>How should this rule interact with the <code>not</code> operator? My initial instinct was that we should also flag ambiguous uses of <code>not</code> as part of this rule, as it's not immediately obvious to me what's going on with <code>not a or b or c</code>: <code>(not a) or b or c</code> is much clearer, in my opinion. At the same time, though, <code>a or b or not c</code> feels pretty clear: emitting a diagnostic there feels like it would be overly noisy.</p>
<p>My suggestion is that we do the following -- what do we think?</p>
<ul>
<li><code>not a or b or c</code> =&gt; diagnostic: use <code>(not a) or b or c)</code></li>
<li><code>a or not b or c</code> =&gt; diagnostic: use <code>a or (not b) or c</code></li>
<li><code>a or b or not c</code> =&gt; no diagnostic; using it at the end is fine.</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @AlexWaygood by @MichaReiser on 2024-01-08 10:37</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-01-08 10:43</div>
            <div class="timeline-body"><p>Hmm, considering the <code>not</code> operator as well raises the question what the scope of the rule is:</p>
<ul>
<li>Is it a specific rule only concerned about <code>and</code> and <code>or</code></li>
<li>Is it a more general rule recommending parentheses to clarify operator precedence.</li>
</ul>
<p>I really like what Prettier is doing in the JS ecosystem by normalizing parentheses for all code. Unfortunately, our formatter can't do this because Python supports operator overloading, and the overloads may not adhere to the standard operator-semantic (making it unsafe to add or remove parentheses). It would be nice to have a lint rule that establishes a good standard around parenthesizing binary expressions, but that significantly increases this issue's scope.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-01-08 10:52</div>
            <div class="timeline-body"><p>I agree with keeping the scope narrow for now. The reason why I think <code>not</code> fits in pretty well, though, is that it's considered a &quot;logical/boolean&quot; operator by the language reference: https://docs.python.org/3/reference/expressions.html#boolean-operations. This naturally results in it being right next to the other two in the operator precedence: https://docs.python.org/3/reference/expressions.html#operator-precedence. If we're covering interactions between the other two boolean operators, it feels like it makes sense to include the third one as well?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/JelleZijlstra">@JelleZijlstra</a> on 2024-01-08 13:45</div>
            <div class="timeline-body"><p>I would prefer to keep <code>not</code> out, as the precedence is a lot easier to remember and code like <code>if not x or y</code> is likely to be innocuous. Here are a few examples from the mypy codebase:</p>
<pre><code>mypy/checker.py:        if not isinstance(typ, TupleType) or not all(
mypy/checker.py:        if not self.options.disallow_any_decorated or self.is_stub:
mypy/build.py:        if not module or not graph[module].tree:
mypy/main.py:        elif not messages or n_notes == len(messages):
mypy/config_parser.py:    if not filename or not modules:
</code></pre>
<p>I don't think Ruff should flag any of these.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-01-08 13:49</div>
            <div class="timeline-body"><blockquote>
<p>Here are a few examples from the mypy codebase:</p>
<pre><code>mypy/checker.py:        if not isinstance(typ, TupleType) or not all(
mypy/checker.py:        if not self.options.disallow_any_decorated or self.is_stub:
mypy/build.py:        if not module or not graph[module].tree:
mypy/main.py:        elif not messages or n_notes == len(messages):
mypy/config_parser.py:    if not filename or not modules:
</code></pre>
<p>I don't think Ruff should flag any of these.</p>
</blockquote>
<p>Alright, those are pretty persuasive. I'll leave <code>not</code> out for now, thanks!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2024-01-09 01:28</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2024-01-09 01:28</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/johnslavik">@johnslavik</a> on 2024-01-09 20:30</div>
            <div class="timeline-body"><p>That might be a bit off-topic, but I felt like I need to say it, as you might be teaching others how to read a code like this without parentheses:
The precedence can be explained with a math analogy.
Broadly speaking, in combinatorics, when creating formulas that describe probabilities, multiplication is like <code>and</code> (the rule of product) and addition is like <code>or</code> (the rule of sum). That's how I teach my students and it becomes very simple for them to read cases like <code>A or B and C</code> and see clearly that <code>B and C</code> gets evaluated before <code>A or ...</code>, as it would in <code>A + B * C</code>.
But yeah, I agree it might be confusing for the majority of people.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 16:49:02 UTC
    </footer>
</body>
</html>
