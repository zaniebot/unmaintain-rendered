<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>`F821`: Incorrectly reports use before assignment for conditional import - astral-sh/ruff #22467</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1><code>F821</code>: Incorrectly reports use before assignment for conditional import</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/ruff/issues/22467">#22467</a>
        opened by <a href="https://github.com/k4lizen">@k4lizen</a>
        on 2026-01-08 23:39
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/k4lizen">@k4lizen</a></div>
            <div class="timeline-body">Summary
<p>I do this in my code:</p>
<pre><code>from __future__ import annotations

import pwndbg


def myfunc() -&gt; None:
    # note that dbg is an object in the pwndbg module
    if pwndbg.dbg.is_gdblib_available():
        import pwndbg.gdblib.functions
        _ = pwndbg.gdblib.functions.functions
        print(&quot;yes!&quot;)
    else:
        print(&quot;no!&quot;)

myfunc()
</code></pre>
<p>And I get the following:</p>
<pre><code>~‚ùØ uv run ruff check repro.py
F823 Local variable `pwndbg` referenced before assignment
 --&gt; repro.py:7:8
  |
6 | def myfunc() -&gt; None:
7 |     if pwndbg.dbg.is_gdblib_available():
  |        ^^^^^^
8 |         import pwndbg.gdblib.functions
9 |         _ = pwndbg.gdblib.functions.functions
  |

Found 1 error.
</code></pre>
<p>What is going on?</p>
Repro
<pre><code>git clone https://github.com/k4lizen/pwndbg/
cd pwndbg
git checkout 4588a455f5e511b567458ef618eb627788b539d5
uv run --all-groups --all-extras ruff check repro.py
</code></pre>
Version
<p>ruff 0.14.10</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by <a href="https://github.com/amyreese">@amyreese</a> on 2026-01-09 00:28</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from &quot;ruff misinterprets a module as an object&quot; to &quot;`F821`: Incorrectly reports use before assignment for conditional import&quot; by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2026-01-09 11:12</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntBre">@ntBre</a> on 2026-01-12 20:23</div>
            <div class="timeline-body"><p>Thanks for the report! As pointed out on the PR (<a href="https://github.com/astral-sh/ruff/pull/22472">astral-sh/ruff#22472</a>#issuecomment-3732861947), this code raises an <code>UnboundLocalError</code> at runtime, so it seems like Ruff is giving an accurate diagnostic. Is there a reason you think the error should be suppressed?</p>
<p>I cloned pwndbg and tried this to confirm:</p>
<pre><code>git clone https://github.com/pwndbg/pwndbg.git
cd pwndbg/
uv run python &lt;&lt;EOF
from __future__ import annotations

import pwndbg


def myfunc() -&gt; None:
    # note that dbg is an object in the pwndbg module
    if pwndbg.dbg.is_gdblib_available():
        import pwndbg.gdblib.functions
        _ = pwndbg.gdblib.functions.functions
        print(&quot;yes!&quot;)
    else:
        print(&quot;no!&quot;)

myfunc()
EOF
</code></pre>
<pre><code>Traceback (most recent call last):
  File &quot;&lt;stdin&gt;&quot;, line 15, in &lt;module&gt;
  File &quot;&lt;stdin&gt;&quot;, line 8, in myfunc
UnboundLocalError: cannot access local variable &#x27;pwndbg&#x27; where it is not associated with a value
</code></pre>
<p>This was surprising to me too, but the local <code>import pwndbg...</code> makes the <code>pwndbg</code> reference within the function a local variable reference, which is then used before its definition. There&#x27;s even a <a href="https://docs.python.org/3/faq/programming.html#why-am-i-getting-an-unboundlocalerror-when-the-variable-has-a-value">Python FAQ</a> entry on this topic, although they use an assignment rather than an import in the example.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/k4lizen">@k4lizen</a> on 2026-01-12 21:32</div>
            <div class="timeline-body"><p>ou damn my bad, I thought this was fine at runtime. if theres a way for ruff to detect this case and maybe point to an explanation of whats going on that would be nice, but in general I&#x27;m fine with closing this issue.</p>
<p>i&#x27;m not sure what @dscorbett meant by this</p>
<blockquote>
<p>This seems like a bug in the upstream rule.</p>
</blockquote>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/k4lizen">@k4lizen</a> on 2026-01-12 21:34</div>
            <div class="timeline-body"><p>as an aside, do you know what the valid/intended way is to achieve what i&#x27;m trying to do here?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntBre">@ntBre</a> on 2026-01-12 21:55</div>
            <div class="timeline-body"><p>No worries at all, this was also confusing to me! I&#x27;ll change the label to <code>diagnostics</code>, this could be an interesting use for a sub-diagnostic if it doesn&#x27;t add too much complexity to the rule.</p>
<p>I think dscorbett was referring to the PR summary, which compared Ruff&#x27;s implementation to pyflakes. I don&#x27;t think you mentioned pyflakes, but the PR author checked the upstream tool to see if it also flagged this code.</p>
<blockquote>
<p>as an aside, do you know what the valid/intended way is to achieve what i&#x27;m trying to do here?</p>
</blockquote>
<p>I think if you declare <code>pwndbg</code> as <code>global</code> within the function, you can get the behavior you want:</p>
<pre><code> def myfunc() -&gt; None:
+    global pwndbg
     # note that dbg is an object in the pwndbg module
     if pwndbg.dbg.is_gdblib_available():
         import pwndbg.gdblib.functions
</code></pre>
<p>I&#x27;m getting a different attribute error in that case, but I think that should work in general.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> removed by <a href="https://github.com/ntBre">@ntBre</a> on 2026-01-12 21:55</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">diagnostics</span> added by <a href="https://github.com/ntBre">@ntBre</a> on 2026-01-12 21:55</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/k4lizen">@k4lizen</a> on 2026-01-12 22:04</div>
            <div class="timeline-body"><p>yup, can confirm that works, thanks!</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 18:50:44 UTC
    </footer>
</body>
</html>
