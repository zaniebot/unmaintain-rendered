<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Format breaks f-string with literal strings inside (versions 0.3.0 and 0.3.1) - astral-sh/ruff #10273</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Format breaks f-string with literal strings inside (versions 0.3.0 and 0.3.1)</h1>

    <div class="meta">
        <span class="state state-closed">Closed</span>
        <a href="https://github.com/astral-sh/ruff/issues/10273">#10273</a>
        opened by <a href="https://github.com/mvaled">@mvaled</a>
        on 2024-03-07 11:03
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/mvaled">@mvaled</a> on 2024-03-07 11:03</div>
            <div class="timeline-body"><!--
Thank you for taking the time to report an issue! We're glad to have you involved with Ruff.

If you're filing a bug report, please consider including the following information:

* A minimal code snippet that reproduces the bug.
* The command you invoked (e.g., `ruff /path/to/file.py --fix`), ideally including the `--isolated` flag.
* The current Ruff settings (any relevant sections from your `pyproject.toml`).
* The current Ruff version (`ruff --version`).
-->

<p>The f-string in the code is broken by the formater (version 0.3.1):</p>
<pre><code class="language-python">import re
def build(extensions):
    regex = re.compile(f&quot;({'|'.join(extensions)})$&quot;, re.IGNORECASE)
</code></pre>
<pre><code>$ cat src/bug.py
import re
def build(extensions):
    regex = re.compile(f&quot;({'|'.join(extensions)})$&quot;, re.IGNORECASE)


$ rye run ruff --version
ruff 0.3.1

$ rye run ruff format src/bug.py                                                                                                                                         1 file reformatted

$ cat src/bug.py                                                                                                                                                                   
import re


def build(extensions):
    regex = re.compile(f&quot;({&quot;|&quot;.join(extensions)})$&quot;, re.IGNORECASE)
</code></pre>
<p>Note: if using <code>--isolated</code> doesn't break the f-string:</p>
<pre><code>import re


def build(extensions):
    regex = re.compile(f&quot;({'|'.join(extensions)})$&quot;, re.IGNORECASE)
</code></pre>
<p>My <code>pyproject.toml</code> has little configuration for the formater:</p>
<pre><code>[tool.ruff]
required-version = &quot;0.3.1&quot;
line-length = 100
target-version = &quot;py312&quot;

[tool.ruff.lint]
preview = true
ignore = [
  &quot;E501&quot;, # line too long
  &quot;B011&quot;, # 'assert False' is fine.
  &quot;E741&quot;, # do not use variables named ‘l’, ‘O’, or ‘I’
  &quot;C901&quot;, # fn is too complex
  &quot;ISC001&quot;,
]
select = [
  &quot;C&quot;,
  &quot;E&quot;,
  &quot;F&quot;,
  &quot;W&quot;,
  &quot;B&quot;,
  &quot;INT&quot;,
  &quot;ISC&quot;,    # Implicit string concat
  &quot;G&quot;,      # f-string, %, and format in loggers is not logger-friendly.
  &quot;RUF008&quot;,
  &quot;W191&quot;,   # Indentation contains tabs
  &quot;W605&quot;,   # Invalid escape sequence
  &quot;W291&quot;,   # Trailing whitespace
  &quot;W292&quot;,   # No newline at end of file
  &quot;W293&quot;,   # Blank line contains whitespace
  &quot;SIM118&quot;, # avoid 'key in dict.keys()'
  &quot;SIM911&quot;, # use 'for k, v in dict.items()'.
  &quot;SIM210&quot;, # use 'bool(a)' instead of 'True if a else False'
  &quot;SIM211&quot;, # use 'not a' instead of 'False if a else True'
  &quot;SIM401&quot;, # use 'd.get(k, default)' instead of 'd[k] if k in d else default'
  &quot;SIM201&quot;, # use 'a != b' instead of 'not a == b'
  &quot;SIM202&quot;, # use 'a == b' instead of 'not a != b'
  &quot;SIM110&quot;, # https://docs.astral.sh/ruff/rules/reimplemented-builtin/
  &quot;SIM101&quot;, # use 'isinstance(x, (T1, T2))' instead of two checks.
]

[tool.ruff.format]
preview = true
exclude = [&quot;**/migrations/*.py&quot;]
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "Format break f-string with literal strings extensions" to "Format breaks f-string with literal strings inside" by @mvaled on 2024-03-07 11:04</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "Format breaks f-string with literal strings inside" to "Format breaks f-string with literal strings inside (versions 0.3.0 and 0.3.1)" by @mvaled on 2024-03-07 11:14</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-03-07 11:34</div>
            <div class="timeline-body"><p>Hi, thanks for providing all the necessary details regarding the issue you're facing. This is related to https://github.com/astral-sh/ruff/issues/10184.</p>
<p>What you're seeing is a preview style change specific to Python 3.12 (set by <code>target-version</code> in your config) which allows the formatter to re-use the same quote inside a f-string. The reason <code>--isolated</code> doesn't format it is because it ignores the config file which enables preview style.</p>
<p>The f-string formatting style is currently in preview and open to feedback: https://github.com/astral-sh/ruff/discussions/9785. We would appreciate if you can provide any feedback on the chosen style where the formatter can use the same quote if target version is 3.12 otherwise it would preserve the existing quote.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">formatter</span> added by @MichaReiser on 2024-03-07 11:53</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">preview</span> added by @MichaReiser on 2024-03-07 11:53</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-03-07 11:55</div>
            <div class="timeline-body"><p>@mvaled is there some tool that's telling you that the f-string is &quot;broken&quot; now?</p>
<p>Note: This is the second time this has come up. We might want to consider flipping the quotes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-03-07 14:02</div>
            <div class="timeline-body"><p>(Just tested myself -- PyCharm doesn't flag this as invalid, perhaps other editors do though.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">style</span> added by @dhruvmanila on 2024-03-07 14:14</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/mvaled">@mvaled</a> on 2024-03-07 16:11</div>
            <div class="timeline-body"><p>@charliermarsh</p>
<p>You're right.  I was targeting using Python 3.12 which would allow this weird looking quotes inside <code>f&quot;...&quot;</code>.</p>
<p>Using <code>target-version = &quot;py311&quot;</code> corrects this.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @mvaled on 2024-03-07 16:11</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/11056.html">astral-sh/ruff#11056</a> on 2024-04-22 09:39</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:34:52 UTC
    </footer>
</body>
</html>
