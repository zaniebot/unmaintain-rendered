<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Organize imports not working due to version-specific syntax errors - astral-sh/ruff #16841</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Organize imports not working due to version-specific syntax errors</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/issues/16841">#16841</a>
        opened by <a href="https://github.com/dikesh">@dikesh</a>
        on 2025-03-19 10:53
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/dikesh">@dikesh</a> on 2025-03-19 10:53</div>
            <div class="timeline-body"><h3>Summary</h3>
<p><code>Organize imports</code> code action not working when one of the function in the file is deeply nested.
Checkout the code sample and screen recording.</p>
<p><strong>models.py</strong></p>
<pre><code class="language-py">class LinkedinAccountIdValidationReq:
    pass


class LinkedinAccountIdValidationRes:
    pass


class LinkedinAdsAccount:
    pass


class LinkedinAdsCampaignGroup:
    pass
</code></pre>
<p><strong>main.py</strong></p>
<pre><code class="language-py">from models import LinkedinAdsAccount, LinkedinAdsCampaignGroup
from models import LinkedinAccountIdValidationReq, LinkedinAccountIdValidationRes

from typing import Any
import polars as pl


async def validate_account_access(
    accounts: list[LinkedinAccountIdValidationReq],
) -&gt; list[LinkedinAccountIdValidationRes]:
    &quot;&quot;&quot;Validate whether Account IDs has access on Access Token&quot;&quot;&quot;
    # Validations
    validations: list[LinkedinAccountIdValidationRes] = []

    print(accounts)

    return validations


async def get_accounts(access_token: str) -&gt; list[LinkedinAdsAccount]:
    &quot;&quot;&quot;Get Accounts&quot;&quot;&quot;
    accounts: list[LinkedinAdsAccount] = []

    print(access_token)

    return accounts


async def get_campaign_groups(
    access_token: str, account_id: int
) -&gt; list[LinkedinAdsCampaignGroup]:
    &quot;&quot;&quot;Get Campaign Groups&quot;&quot;&quot;
    campaign_groups = []
    print(access_token, account_id)
    return campaign_groups


async def transform_response_rows(
    rows: list[dict[str, Any]],
    account_id: str | None,
    access_token: str,
    column_configs: dict[str, dict[str, Any]],
) -&gt; pl.DataFrame:
    &quot;&quot;&quot;Transform Response rows&quot;&quot;&quot;
    # No data found
    if len(rows) == 0:
        return pl.DataFrame(
            schema={
                col: pl.Float64 if config[&quot;type&quot;] == &quot;METRIC&quot; else pl.Utf8
                for col, config in column_configs.items()
            }
        )

    # Rows to dataframe first
    df = pl.from_dicts(rows, infer_schema_length=None)

    # Transform Pivot values
    if &quot;pivotValues&quot; in df.columns:
        df = df.with_row_index(&quot;row_nr&quot;)
        df = df.join(df.pivot(&quot;entityType&quot;, index=&quot;row_nr&quot;, values=&quot;entityId&quot;), on=&quot;row_nr&quot;)
        df = df.drop([&quot;pivotValues&quot;, &quot;row_nr&quot;, &quot;entityType&quot;, &quot;entityId&quot;], strict=False)

        # Entity-wise data e.g {sponsoredCampaign: pl.Dataframe, ...}
        entity_data: dict[str, pl.DataFrame] = {}

        # For each column config with pivot
        for col, col_config in column_configs.items():
            # Entity type and key
            entity_type, entity_key = col_config[&quot;type&quot;], col_config[&quot;key&quot;]

            # ID column already exists in df, for other keys fetch data from API
            if entity_key == &quot;id&quot;:
                df = df.with_columns(pl.col(entity_type).alias(col))
            elif account_id:
                entity_df = entity_data.get(entity_type)
                if entity_df is None:
                    entities = []
                    args = [
                        access_token,
                        int(account_id.split(&quot;:&quot;)[-1]),
                    ]
                    match entity_type:
                        case &quot;sponsoredAccount&quot;:
                            entities = await get_accounts(args[0])
                        case &quot;sponsoredCampaign&quot;:
                            entities = await get_campaign_groups(*args)

                    entity_df = (
                        pl.from_dicts([{&quot;key&quot;: &quot;val&quot;} for _ in entities])
                        .cast(pl.Utf8)
                        .select(pl.all().name.prefix(f&quot;{entity_type}.&quot;))
                    )

                # Rename column
                if col_config[&quot;res_key&quot;] in entity_df.columns:
                    entity_df = entity_df.rename({col_config[&quot;res_key&quot;]: col_config[&quot;id&quot;]})

                # Set with dict
                entity_data[entity_type] = entity_df

        # Join dataframes
        for entity_type, entity_df in entity_data.items():
            df = df.join(entity_df, left_on=entity_type, right_on=f&quot;{entity_type}.id&quot;)

    return df
</code></pre>
<p><strong>pyproject.toml</strong></p>
<pre><code class="language-toml">[tool.ruff]
line-length = 99
lint.ignore = [&quot;E722&quot;]

[tool.poetry]
name = &quot;ruffdemo&quot;
version = &quot;0.1.0&quot;
description = &quot;&quot;
authors = [&quot;Your Name &lt;you@example.com&gt;&quot;]
readme = &quot;README.md&quot;

[tool.poetry.dependencies]
python = &quot;^3.12&quot;
polars = &quot;^1.25.2&quot;


[tool.poetry.group.dev.dependencies]
ruff = &quot;^0.11.0&quot;

[build-system]
requires = [&quot;poetry-core&quot;]
build-backend = &quot;poetry.core.masonry.api&quot;
</code></pre>
<hr />
<p>Screen recording showing code action behaviout with and without deeply nested code.</p>
<p>https://github.com/user-attachments/assets/1498b295-84e6-4508-8311-c07a1f23ef25</p>
<h3>Version</h3>
<p>ruff 0.11.0</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @dylwil3 on 2025-03-19 11:16</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">server</span> added by @dylwil3 on 2025-03-19 11:17</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dylwil3">@dylwil3</a> on 2025-03-19 11:21</div>
            <div class="timeline-body"><p>Thanks for the detailed write-up! I'm able to reproduce this. A few observations:</p>
<ol>
<li>Running <code>ruff check --select I --fix</code> works, so it appears to be an issue with the server.</li>
<li>The issue is also present if you select <code>I</code> in the linter settings and try the server action to fix all auto-fixable problems.</li>
<li>However, if you select <code>I</code> in the linter settings and try the server action <code>Ruff (I001): Organize imports</code>, this <em>does</em> work!</li>
</ol>
<p>Note: It's not clear to me that the issue is actually nesting - it'd be nice to strip this example down to a more minimal one.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2025-03-19 11:37</div>
            <div class="timeline-body"><blockquote>
<p>2. The issue is also present if you select <code>I</code> in the linter settings and try the server action to fix all auto-fixable problems.</p>
</blockquote>
<p>Can you expand on what do you mean here?</p>
<p>I'm unable to reproduce this as it seems to be working fine when I'm running it in Zed. @dikesh Can you provide me with your Zed settings? I'm wondering if you have anything related to Ruff in it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dikesh">@dikesh</a> on 2025-03-19 11:40</div>
            <div class="timeline-body"><p>I am using neovim as primary editor and was facing the same issue on it. So I tried to reproduce the same using Zed.</p>
<p>Here is the config.</p>
<pre><code class="language-json">{
  &quot;vim_mode&quot;: true,
  &quot;ui_font_size&quot;: 16,
  &quot;buffer_font_size&quot;: 16,
  &quot;format_on_save&quot;: &quot;on&quot;,
  &quot;theme&quot;: {
    &quot;mode&quot;: &quot;system&quot;,
    &quot;light&quot;: &quot;One Light&quot;,
    &quot;dark&quot;: &quot;One Dark&quot;
  },
  &quot;languages&quot;: {
    &quot;Python&quot;: {
      &quot;format_on_save&quot;: &quot;on&quot;,
      &quot;language_servers&quot;: [&quot;ruff&quot;]
    }
  },
  &quot;lsp&quot;: {
    &quot;ruff&quot;: {
      &quot;initialization_options&quot;: {
        &quot;settings&quot;: {
          &quot;lineLength&quot;: 99
        }
      }
    }
  }
}
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dylwil3">@dylwil3</a> on 2025-03-19 11:41</div>
            <div class="timeline-body"><p>I'm able to reproduce on Helix and VSCode as well, so I don't think it's zed specific.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dylwil3">@dylwil3</a> on 2025-03-19 11:42</div>
            <div class="timeline-body"><p>Here is a more minimal example. It appears to be the <code>match</code> that's messing things up?</p>
<pre><code class="language-python">from models import Foo, Bar
from models import Bizz, Buzz


match this:
    case that:
        ...
    case other:
        ...
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dikesh">@dikesh</a> on 2025-03-19 11:45</div>
            <div class="timeline-body"><p>Woww @dylwil3 . I was running the code action on large project and could not figure out what exactly is causing the problem.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dylwil3">@dylwil3</a> on 2025-03-19 11:46</div>
            <div class="timeline-body"><blockquote>
<blockquote>
<ol start="2">
<li>The issue is also present if you select I in the linter settings and try the server action to fix all auto-fixable problems.</li>
</ol>
</blockquote>
</blockquote>
<blockquote>
<p>Can you expand on what do you mean here?</p>
</blockquote>
<p>In the example above, in the <code>pyproject.toml</code>, I have added <code>lint.select = [&quot;I&quot;]</code>. Then I see the following code actions available:</p>
<p><img width="819" alt="Image" src="https://github.com/user-attachments/assets/fe59630f-34fb-4e0a-8939-68db95430ddd" /></p>
<p>Of these:</p>
<ol>
<li><code>Ruff (I001): Organize Imports</code> works, and organizes the imports</li>
<li><code>Ruff (I001): Disable for this line</code> works and adds a <code>noqa</code></li>
<li><code>Ruff: Fix all auto-fixable problems</code> does nothing</li>
<li><code>Ruff: Organize imports</code> does nothing</li>
</ol>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2025-03-19 11:51</div>
            <div class="timeline-body"><p>Oh, that is interesting. Great find @dylwil3. Are you interested in working on this?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dylwil3">@dylwil3</a> on 2025-03-19 11:53</div>
            <div class="timeline-body"><p>I can try! But I may ping you for help since I'm not super familiar with the server.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @dylwil3 by @dylwil3 on 2025-03-19 11:53</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dylwil3">@dylwil3</a> on 2025-03-19 12:05</div>
            <div class="timeline-body"><p>Workaround: set your target version to anything 3.10 or higher.</p>
<p>Hunch: this is related to the version-specific syntax errors.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntBre">@ntBre</a> on 2025-03-19 13:13</div>
            <div class="timeline-body"><blockquote>
<p>Hunch: this is related to the version-specific syntax errors.</p>
</blockquote>
<p>Yeah I was wondering that too once you reduced it to the <code>match</code>. You could try a walrus before 3.8 too if you want to double check the hypothesis, that's another of the easy ones.</p>
<p>You might want to look for calls to <a href="https://github.com/astral-sh/ruff/blob/main/crates/ruff_python_parser/src/lib.rs#L375"><code>Parsed::has_syntax_errors</code></a> or its opposite <code>has_no_syntax_errors</code>. I'm not seeing any calls in the server directly, but <code>linter::lint_only</code> returns a <code>LinterResult</code> with this as one of its fields that I could see making its way into the server.</p>
<p>Yeah I think that might be approximately it but via <code>lint_fix</code>:</p>
<p>https://github.com/astral-sh/ruff/blob/6a758e4e93e50a15e5894a249516b9bbb7f55c15/crates/ruff_server/src/fix.rs#L79-L82</p>
<p>Maybe I should have left this check as <code>Parsed::has_valid_syntax</code> instead of including the version-related errors.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "Organize imports not working due to deeply nested function" to "Organize imports not working due to version-specific syntax errors" by @dylwil3 on 2025-03-19 15:00</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @dylwil3 on 2025-03-20 10:09</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @dylwil3 on 2025-03-20 10:09</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 11:36:59 UTC
    </footer>
</body>
</html>
