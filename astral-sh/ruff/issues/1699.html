<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Installing ruff via pip on NixOs does not work - astral-sh/ruff #1699</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Installing ruff via pip on NixOs does not work</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/issues/1699">#1699</a>
        opened by <a href="https://github.com/heitorPB">@heitorPB</a>
        on 2023-01-06 21:41
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/heitorPB">@heitorPB</a> on 2023-01-06 21:41</div>
            <div class="timeline-body"><p>Installing ruff via <code>pip</code> on NixOs systems does not work:</p>
<pre><code class="language-bash">$ cd /tmp
$ python3 -m venv venv
$ source venv/bin/activate
(venv)
$ pip install ruff
Collecting ruff
  Using cached ruff-0.0.212-py3-none-manylinux_2_17_x86_64.manylinux2014_x86_64.whl (4.3 MB)
Installing collected packages: ruff
Successfully installed ruff-0.0.212

[notice] A new release of pip available: 22.2.2 -&gt; 22.3.1
[notice] To update, run: pip install --upgrade pip
(venv)
$ ruff
-bash: /tmp/venv/bin/ruff: No such file or directory
(venv)

$ file /tmp/venv/bin/ruff
/tmp/venv/bin/ruff: ELF 64-bit LSB pie executable, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, BuildID[sha1]=1ec33df614fc5020de42d625366e4684ae45a0b6, for GNU/Linux 2.6.32, stripped
(venv)
</code></pre>
<p>The dynamic loader (&quot;ELF interpreter&quot;) is not in the path hardcoded in the binary, although <code>ldd</code> shows the right path:</p>
<pre><code class="language-bash">$ ldd /tmp/venv/bin/ruff
        linux-vdso.so.1 (0x00007f8623e51000)
        libgcc_s.so.1 =&gt; /nix/store/hsk71z8admvgykn7vzjy11dfnar9f4r1-glibc-2.35-163/lib/libgcc_s.so.1 (0x00007f86233eb000)
        librt.so.1 =&gt; /nix/store/hsk71z8admvgykn7vzjy11dfnar9f4r1-glibc-2.35-163/lib/librt.so.1 (0x00007f86233e6000)
        libpthread.so.0 =&gt; /nix/store/hsk71z8admvgykn7vzjy11dfnar9f4r1-glibc-2.35-163/lib/libpthread.so.0 (0x00007f86233e1000)
        libm.so.6 =&gt; /nix/store/hsk71z8admvgykn7vzjy11dfnar9f4r1-glibc-2.35-163/lib/libm.so.6 (0x00007f8623301000)
        libdl.so.2 =&gt; /nix/store/hsk71z8admvgykn7vzjy11dfnar9f4r1-glibc-2.35-163/lib/libdl.so.2 (0x00007f86232fc000)
        libc.so.6 =&gt; /nix/store/hsk71z8admvgykn7vzjy11dfnar9f4r1-glibc-2.35-163/lib/libc.so.6 (0x00007f86230f1000)
        /lib64/ld-linux-x86-64.so.2 =&gt; /nix/store/hsk71z8admvgykn7vzjy11dfnar9f4r1-glibc-2.35-163/lib64/ld-linux-x86-64.so.2 (0x00007f8623e53000)
(venv)
</code></pre>
<p>I was able to get it working using <code>patchelf</code>, but it is not a good workflow when using a Python package manager (e.g. hatch, pdm, poetry, etc) to handle all the dev dependencies of the project.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @charliermarsh on 2023-01-06 22:03</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/messense">@messense</a> on 2023-01-07 02:29</div>
            <div class="timeline-body"><p>Can you run it with <code>LD_DEBUG=libs,files</code> env var to see what's going on?</p>
<pre><code class="language-bash">LD_DEBUG=libs,files /tmp/venv/bin/ruff
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/messense">@messense</a> on 2023-01-07 02:35</div>
            <div class="timeline-body"><p>https://nixos.wiki/wiki/Packaging/Binaries</p>
<blockquote>
<p>Downloading and attempting to run a binary on NixOS will almost never work. This is due to hard-coded paths in the executable.</p>
</blockquote>
<p>https://nixos.wiki/wiki/Packaging/Binaries#The_Dynamic_Loader</p>
<p>I think it's by design in NixOS? You should probably look into packaging <code>ruff</code> in <a href="https://github.com/NixOS/nixpkgs">nixpkgs</a>.</p>
<p>Edit: Looks like it's already packaged: https://search.nixos.org/packages?channel=unstable&amp;show=ruff&amp;from=0&amp;size=50&amp;sort=relevance&amp;type=packages&amp;query=ruff</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-01-08 03:18</div>
            <div class="timeline-body"><p>Given the above, going to close for now.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2023-01-08 03:18</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/heitorPB">@heitorPB</a> on 2023-01-09 15:16</div>
            <div class="timeline-body"><p>@messense,</p>
<blockquote>
<p>Can you run it with <code>LD_DEBUG=libs,files</code> env var to see what's going on?</p>
</blockquote>
<p>The binary does not run, due to the different path of the Dynamic Loader.</p>
<p>@charliermarsh,</p>
<p><code>ruff</code> does work if I install it on my machine via the OS package manager, but that is not a solution. The issue is that many Python projects use <code>ruff</code> as a linter defined in <code>pyproject.toml</code>/<code>requirements.txt</code>, and that gets installed via pip/pdm/hatch/poetry/etc in a local environment (a.k.a. <em>virtual env</em>). And then running the linter/test/format scripts simply does not work.</p>
<p>As an example:</p>
<pre><code class="language-bash">$ git clone git@github.com:tiangolo/fastapi.git
$ cd fastapi/
$ python -m venv env
$ source ./env/bin/activate
$ pip install -e .&quot;[dev,doc,test]&quot;
$ bash ./scripts/format.sh
+ ruff fastapi tests docs_src scripts --fix
scripts/format.sh: line 4: /home/h/projects/fastapi/venv/bin/ruff: No such file or directory
+ black fastapi tests docs_src scripts
All done! ‚ú® üç∞ ‚ú®
804 files left unchanged.
+ isort fastapi tests docs_src scripts
</code></pre>
<p>As you can see, <code>ruff</code> is just erroring out :(</p>
<p>In some cases, we can install <code>ruff</code> via the OS package manager, but some Python projects &quot;embed&quot; it, or use/require/pin a specific version.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/messense">@messense</a> on 2023-01-09 15:34</div>
            <div class="timeline-body"><p>IMHO since you choose NixOS you should embrace <a href="https://nixos.wiki/wiki/Python">their rules</a>, it is known that <code>pip install</code> native binaries and extension modules may not work on NixOS, there are some existing issues in nixpkgs:</p>
<ul>
<li>https://github.com/NixOS/nixpkgs/issues/142383</li>
<li>https://github.com/NixOS/nixpkgs/issues/10597</li>
</ul>
<p>Ideally it should be fixed in NixOS, for now as a workaround I think you can install <code>ruff</code> from sdist instead</p>
<pre><code class="language-bash">pip install --no-binary :all: ruff
</code></pre>
<p>That said, <code>ruff</code> may be able to provide fully static musl libc binaries but it might run much slower than the current glibc ones.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/heitorPB">@heitorPB</a> on 2023-01-09 17:12</div>
            <div class="timeline-body"><blockquote>
<p>for now as a workaround I think you can install <code>ruff</code> from sdist instead</p>
<pre><code class="language-shell">pip install --no-binary :all: ruff
</code></pre>
</blockquote>
<p>Unfortunately, that did not work: I don't have rust compilers. I could install cargo/rustc/etc, but that does not provide a &quot;work out of the box&quot; experience. <code>pip install flake8</code> just works and I was expecting that for <code>ruff</code>.</p>
<blockquote>
<p>That said, <code>ruff</code> may be able to provide fully static musl libc binaries but it might run much slower than the current glibc ones.</p>
</blockquote>
<p>Is this on the roadmap? Would it be possible to have an &quot;alternate&quot; installation for <code>ruff</code> that uses musl statically linked instead? For example: <code>pip install ruff[musl]</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/messense">@messense</a> on 2023-01-10 02:03</div>
            <div class="timeline-body"><blockquote>
<p><code>pip install flake8</code> just works and I was expecting that for <code>ruff</code>.</p>
</blockquote>
<p><code>flake8</code> is a pure Python wheel so it's very different than <code>ruff</code> which is a compiled Rust binary.</p>
<blockquote>
<p>Is this on the roadmap?</p>
</blockquote>
<p>That's a question for @charliermarsh, IMO the default should be glibc version unless we can prove that musl libc version is on par with its performance.</p>
<blockquote>
<p>Would it be possible to have an &quot;alternate&quot; installation for <code>ruff</code> that uses musl statically linked instead? For example: <code>pip install ruff[musl]</code>?</p>
</blockquote>
<p><code>pip install ruff[musl]</code> won't work because <code>[musl]</code> is for specifying extra dependencies. A new <code>ruff-musl</code>/<code>ruff-static</code> pip package could work.</p>
<p>Maybe <code>ruff</code> eventual provides musl libc binaries that works for you but there are more similar pip binary projects that won't, so IMHO the best solution is to ask/<a href="https://opencollective.com/nixos">sponsor</a> nixpkgs to fix https://github.com/NixOS/nixpkgs/issues/142383.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/akx">@akx</a> on 2023-04-03 13:54</div>
            <div class="timeline-body"><p>I guess a musl-linked ruff could be shipped in a <a href="https://peps.python.org/pep-0656/"><code>musllinux</code></a> tagged wheel... <code>musllinux</code> seems to be supported by <code>cibuildwheel</code>, for what it's worth.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/andrew-isakov">@andrew-isakov</a> on 2024-03-17 10:43</div>
            <div class="timeline-body"><p><code>nix-shell -p ruff</code> is work
installed by <code>configuration.nix</code> or <code>pip install</code> dont work  (nix-ld error)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/snowdrop4">@snowdrop4</a> on 2024-06-04 19:44</div>
            <div class="timeline-body"><blockquote>
<p>I was able to get it working using patchelf</p>
</blockquote>
<p>@heitorPB how did you achieve that?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/heitorPB">@heitorPB</a> on 2024-06-04 22:41</div>
            <div class="timeline-body"><p>@snowdrop4 something like <code>patchelf path/to/bin/ruff</code>. See <a href="https://nixos.wiki/wiki/Packaging/Binaries">Packaging/Binaries</a>.</p>
<p>But I recommend to set the env var <code>PIP_NO_BINARY=ruff</code> and have <code>cargo</code> and <code>rustc</code> available to compile Ruff instaled via Pip. I use this Flake for this:</p>
<pre><code class="language-nix">{
  description = &quot;A Python flake&quot;;

  inputs = {
    nixpkgs.url = &quot;nixpkgs/nixos-unstable&quot;;
    flake-utils.url = &quot;github:numtide/flake-utils&quot;;
  };

  outputs = { self, nixpkgs, flake-utils }:
    flake-utils.lib.eachSystem [ &quot;x86_64-linux&quot; ] (system:
      let
        pkgs = import nixpkgs { inherit system; };
      in
      {
        # For nix develop
        devShell = pkgs.mkShell {
          shellHook = ''
            export PIP_NO_BINARY=&quot;ruff&quot;
          '';

          packages = with pkgs; [
            (python311.withPackages (p: with p; [
              pip
              python-lsp-server
              python-lsp-ruff
            ]))

            rustc
            cargo
          ];
        };
      });
}
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/snowdrop4">@snowdrop4</a> on 2024-06-05 12:29</div>
            <div class="timeline-body"><p>Thank you!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/vanchaxy">@vanchaxy</a> on 2024-10-21 18:21</div>
            <div class="timeline-body"><p>The best way I found to make it work is using nix-ld.</p>
<p>Just add these two lines to your configuration, rebuild, reboot and you are all set.</p>
<pre><code>programs.nix-ld.enable = true;
programs.nix-ld.libraries = options.programs.nix-ld.libraries.default;
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/anadon">@anadon</a> on 2025-04-21 21:40</div>
            <div class="timeline-body"><p>What about this?</p>
<pre><code class="language-Python">def handle_nixos() -&gt; List[str]:
    result = subprocess.run([&quot;nix&quot;, &quot;help&quot;, &quot;run&quot;, &quot;&gt;&quot;, &quot;/dev/null&quot;]
    return [&quot;ruff&quot;] if result.returncode else [&quot;nix&quot;, &quot;run&quot;, &quot;nixpkgs#ruff&quot;, &quot;--&quot;]
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/akx">@akx</a> on 2025-04-22 10:44</div>
            <div class="timeline-body"><p>@anadon <code>if shutil.which(&quot;nix&quot;)</code> would do the trick to figure out whether <code>nix</code> is available at all, if that's the idea...</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/andrew-isakov">@andrew-isakov</a> on 2025-05-29 18:01</div>
            <div class="timeline-body"><p>–æ—Ç–∫—Ä—ã–ª –¥–ª—è —Å–µ–±—è devbox :)</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 11:28:47 UTC
    </footer>
</body>
</html>
