<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Use str.casefold() instead of str.lower() for comparison. - astral-sh/ruff #7728</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Use str.casefold() instead of str.lower() for comparison.</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/ruff/issues/7728">#7728</a>
        opened by <a href="https://github.com/Jeremiah-England">@Jeremiah-England</a>
        on 2023-10-01 00:05
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Jeremiah-England">@Jeremiah-England</a></div>
            <div class="timeline-body"><!--
Thank you for taking the time to report an issue! We're glad to have you involved with Ruff.

If you're filing a bug report, please consider including the following information:

* A minimal code snippet that reproduces the bug.
* The command you invoked (e.g., `ruff /path/to/file.py --fix`), ideally including the `--isolated` flag.
* The current Ruff settings (any relevant sections from your `pyproject.toml`).
* The current Ruff version (`ruff --version`).
-->

<p>I'm reading <em>Fluent Python</em> right now and the author introduced me to using <code>casefold()</code> instead of <code>lower()</code> for string comparison. This seems to be the general recommendation. See https://stackoverflow.com/questions/45745661/lower-vs-casefold-in-string-matching-and-converting-to-lowercase.</p>
<p>It seems like we could have a rule like this:</p>
<pre><code class="language-python">s1.lower() == s2.lower()  # Error: Use str.casefold() for caseless string comparison
s1.lower() != s2.lower()  # Error: Use str.casefold() for caseless string comparison
</code></pre>
<p>I tested the performance and it looks like they are about the same.</p>
<details><summary>Performance testing</summary>

<pre><code class="language-python">import random
import timeit

long = bytes(random.randint(0, 255) for _ in range(1_000_000)).decode(&quot;utf-8&quot;, errors=&quot;ignore&quot;)
short = bytes(random.randint(0, 255) for _ in range(1_000)).decode(&quot;utf-8&quot;, errors=&quot;ignore&quot;)
tiny = bytes(random.randint(0, 255) for _ in range(10)).decode(&quot;utf-8&quot;, errors=&quot;ignore&quot;)

print(f&quot;Length of long: {len(long)}&quot;)
print(f&quot;Length of short: {len(short)}&quot;)
print(f&quot;Length of tiny: {len(tiny)}&quot;)


long_lower_time = timeit.timeit(&quot;long.lower()&quot;, globals=globals(), number=100)
long_casefold_time = timeit.timeit(&quot;long.casefold()&quot;, globals=globals(), number=100)
print(f&quot;{long_lower_time=}&quot;)
print(f&quot;{long_casefold_time=}&quot;)

short_lower_time = timeit.timeit(&quot;short.lower()&quot;, globals=globals(), number=100_000)
short_casefold_time = timeit.timeit(&quot;short.casefold()&quot;, globals=globals(), number=100_000)
print(f&quot;{short_lower_time=}&quot;)
print(f&quot;{short_casefold_time=}&quot;)

tiny_lower_time = timeit.timeit(&quot;tiny.lower()&quot;, globals=globals(), number=10_000_000)
tiny_casefold_time = timeit.timeit(&quot;tiny.casefold()&quot;, globals=globals(), number=10_000_000)
print(f&quot;{tiny_lower_time=}&quot;)
print(f&quot;{tiny_casefold_time=}&quot;)

# Length of long: 533764
# Length of short: 543
# Length of tiny: 2
# long_lower_time=0.7035579030052759
# long_casefold_time=0.7010332670179196
# short_lower_time=0.6138628749758936
# short_casefold_time=0.5890167159959674
# tiny_lower_time=0.5530402820440941
# tiny_casefold_time=0.5944054980063811
</code></pre>
</details>

<p>The main risk seems to be other classes with a <code>.lower()</code> method that someone might use for comparison. It seems that should be unlikely enough that a rule would be OK. I searched private codebase and the results for <code>lower.*[!=]=.*lower</code> were all string comparisons.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">rule</span> added by @charliermarsh on 2023-10-01 03:30</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">needs-decision</span> added by @charliermarsh on 2023-10-01 03:30</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2023-10-02 17:11</div>
            <div class="timeline-body"><p>To me, <code>casefold</code> and <code>lower</code> have different semantics and you shouldn't just replace one with another. For example, in python packaging, the casing of package names generally doesn't matter, e.g. <code>asgiref</code>, <code>Asgiref</code> and <code>AsgiRef</code> will both give you the desired package, since <code>&quot;asgiref&quot;.lower() == &quot;Asgiref&quot;.lower() == &quot;AsgiRef&quot;.lower()</code>. <code>aßgiref</code> otoh is an invalid package name and should not be accepted. This is also represented by pypi:
Works: https://pypi.org/project/asgiref/
Works: https://pypi.org/project/Asgiref/, redirects to https://pypi.org/project/asgiref/
Broken: https://pypi.org/project/aßgiref/</p>
<p>(Personally, i find <code>&quot;ß&quot;.upper() == &quot;SS&quot;</code> a strange semantic already and one that does not match my feeling for language, plus the captial ß now exists (https://en.wikipedia.org/wiki/%C3%9F#Development_of_a_capital_form), but i can see how that's something you want to support now that it's a fixed part of unicode, especially when dealing which natural language rather than identifiers)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2023-10-02 17:49</div>
            <div class="timeline-body"><p>I've never seen anyone actually use this but it does seem like a reasonable suggestion.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 16:48:31 UTC
    </footer>
</body>
</html>
