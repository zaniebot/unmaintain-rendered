<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>False positive for `F821` on circular reference in `TYPE_CHECKING` block - astral-sh/ruff #11245</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>False positive for <code>F821</code> on circular reference in <code>TYPE_CHECKING</code> block</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/ruff/issues/11245">#11245</a>
        opened by <a href="https://github.com/ngnpope">@ngnpope</a>
        on 2024-05-02 10:43
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ngnpope">@ngnpope</a></div>
            <div class="timeline-body"><p>Keywords searched for before creating issue: <code>F821</code>, <code>TYPE_CHECKING</code>.</p>
<p>Example code that produces the false positive:</p>
<pre><code class="language-python">from __future__ import annotations

from typing import TYPE_CHECKING, TypeAlias

if TYPE_CHECKING:
    Nested: TypeAlias = dict[str, bool | Nested]
</code></pre>
<p>Command line and output:</p>
<pre><code class="language-console">$ ruff --version
ruff 0.4.2
$ ruff check --isolated --select=F821 bug.py 
bug.py:6:42: F821 Undefined name `Nested`
Found 1 error.
$ mypy --strict bug.py 
Success: no issues found in 1 source file
</code></pre>
<p>Expected that <code>F821</code> would not be raised in a <code>TYPE_CHECKING</code> block for a circular reference when using postponed evaluation of annotations (PEP 563).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/trag1c">@trag1c</a> on 2024-05-02 11:25</div>
            <div class="timeline-body"><p>nit: indeed, PEP 563 applies to <em>annotations</em>, but <code>dict[str, bool | Nested]</code> isn't one (in fact the <code>__future__</code> import doesn't make a difference).</p>
<p>I think the issue is still valid though :+1:</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @charliermarsh on 2024-05-02 14:29</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-05-02 14:29</div>
            <div class="timeline-body"><p>Not sure... @AlexWaygood would know.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-05-02 14:40</div>
            <div class="timeline-body"><p>Yeah I think <code>from __future__ import annotations</code> is irrelevant here, <em>but</em> if it's in an <code>if TYPE_CHECKING</code> block we should treat it as though it has &quot;stub file&quot; semantics (whether or not <code>__future__</code> annotations are enabled). The rhs of an assignment is evaluated at runtime regardless of whether <code>__future__</code> annotations are enabled, but nothing in an <code>if TYPE_CHECKING</code> block is ever evaluated at runtime, so it doesn't matter</p>
<p>TL;DR: I agree that this is a false positive</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-05-02 14:42</div>
            <div class="timeline-body"><p>If you tried to <em>use</em> <code>Nested</code> in a type annotation anywhere without either quoting it or having <code>__future__</code> annotations enabled, it would fail, because the alias doesn't exist at runtime. But that's a separate issue</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @AlexWaygood by @AlexWaygood on 2024-05-03 10:11</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 16:50:11 UTC
    </footer>
</body>
</html>
