<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add ability to handle magic commands in Jupyter notebook - astral-sh/ruff #5030</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Add ability to handle magic commands in Jupyter notebook</h1>

    <div class="meta">
        <span class="state state-closed">Closed</span>
        <a href="https://github.com/astral-sh/ruff/issues/5030">#5030</a>
        opened by <a href="https://github.com/dhruvmanila">@dhruvmanila</a>
        on 2023-06-12 16:17
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2023-06-12 16:17</div>
            <div class="timeline-body"><p>Currently, if any cell contains any magic commands it'll be ignored even if the cell contains valid Python code. This might lead to false positive as some code is intentionally ignored for linting (undefined symbol).</p>
<p>At a high level overview what <code>black</code> does is the following:</p>
<ol>
<li>Using IPython's transformer, convert the magic commands into the respective function calls (<code>% ...</code> will be converted to <code>get_ipython().run_cell_magic</code>)</li>
<li>Replace cell magics with tokens (string values which is a valid Python code) and keep track of such replacements</li>
<li>Replace line magics in the same way as mentioned in (2)</li>
<li>Returned the transformed code along with the replacements</li>
<li>At the end, use the replacements to get back the original content</li>
</ol>
<p>Reference implementation in <code>black</code>: https://github.com/psf/black/blob/main/src/black/handle_ipynb_magics.py</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">core</span> added by @dhruvmanila on 2023-06-12 16:17</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2023-06-14 16:33</div>
            <div class="timeline-body"><p>Jupytext has a simpler implementation although lots of regex: https://github.com/mwouts/jupytext/blob/main/jupytext/magics.py</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/5188.html">astral-sh/ruff#5188</a> on 2023-06-19 18:30</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @dhruvmanila by @dhruvmanila on 2023-06-26 16:11</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/1079.html">astral-sh/ruff#1079</a> on 2023-06-27 12:11</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/5552.html">astral-sh/ruff#5552</a> on 2023-07-06 05:05</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/henryiii">@henryiii</a> on 2023-07-18 03:30</div>
            <div class="timeline-body"><p>There might be an easier but dumber way to do with without invoking IPython, which I would assume would be slow. You could add a configurable list of &quot;ignored&quot; magics. The default could contain the built-in magics that don't have much affect: <code>%%time</code>, <code>%%timeit</code>, etc. But a user could override the list via configuration. Detecting them I'd assume is already mostly done, since it can ignore them?</p>
<p>This wouldn't cover magics that modify stuff or change the language, but would cover a lot of common cases &amp; is the situation that is easiest to report violations and autofix.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2023-07-20 04:08</div>
            <div class="timeline-body"><p>Hey, thanks for the suggestions. Yes, invoking IPython would be slow and we're not going that route. Instead, we'll use a new parser mode in which the parser will parse the magic commands at possible locations. New tokens and AST nodes are introduced which will be available only in that mode. Although the node isn't finalized, you can refer to https://github.com/astral-sh/RustPython-Parser/pull/31.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2023-07-26 02:11</div>
            <div class="timeline-body"><p>The solution which we've implemented is to integrate it in the parser directly. The following changes were made to the parser to accommodate the requirement:</p>
<ul>
<li>A new <a href="https://github.com/astral-sh/RustPython-Parser/blob/13196fc50010d1c89ab732bdbd348800f6815dcc/core/src/mode.rs#L12-L35"><code>Jupyter</code> mode</a> was added to allow lexing/parsing the magic commands only for Jupyter Notebooks and give an error otherwise.</li>
<li>The lexer will recognize the magic commands and emit the <a href="https://github.com/astral-sh/RustPython-Parser/blob/13196fc50010d1c89ab732bdbd348800f6815dcc/parser/src/token.rs#L46-L53"><code>MagicCommand</code> token</a> wherever it's allowed[^1] i.e., as standalone statement (<code>%matplotlib inline</code>) or in an assignment statement (<code>dir = !pwd</code>).<ul>
<li>https://github.com/astral-sh/RustPython-Parser/pull/23</li>
<li>https://github.com/astral-sh/RustPython-Parser/pull/30</li>
</ul>
</li>
<li>Two new nodes <code>StmtLineMagic</code> and <code>ExprLineMagic</code> are added for the parser.<ul>
<li>https://github.com/astral-sh/RustPython-Parser/pull/31</li>
</ul>
</li>
</ul>
<h3>References</h3>
<ul>
<li>All possible magic command related documentation is present on this page: https://ipython.readthedocs.io/en/stable/interactive/reference.html#interactive-use</li>
<li>Original implementation in IPython codebase: https://github.com/ipython/ipython/blob/main/IPython/core/inputtransformer2.py</li>
<li><code>sonar-python</code> implementation: https://github.com/SonarSource/sonar-python/blob/master/python-frontend/src/main/java/org/sonar/python/api/IPythonGrammarBuilder.java</li>
</ul>
<p>[^1]: The allowed magic token positions are determined directly from the IPython implementation of the same.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/6272.html">astral-sh/ruff#6272</a> on 2023-08-02 12:30</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/6358.html">astral-sh/ruff#6358</a> on 2023-08-05 02:06</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @dhruvmanila on 2023-08-09 04:58</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../dsa-ou/algoesup/issues/56.html">dsa-ou/algoesup#56</a> on 2025-03-16 13:07</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:34:50 UTC
    </footer>
</body>
</html>
