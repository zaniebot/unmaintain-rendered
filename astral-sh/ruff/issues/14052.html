<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RET504 false-positive when nested functions reference the variable - astral-sh/ruff #14052</title>
    <link rel="stylesheet" href="../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../index.html">Back to index</a>
    </div>

    <h1>RET504 false-positive when nested functions reference the variable</h1>

    <div class="meta">
        <span class="state state-closed">Closed</span>
        <a href="https://github.com/astral-sh/ruff/issues/14052">#14052</a>
        opened by <a href="https://github.com/Enegg">@Enegg</a>
        on 2024-11-01 19:00
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/Enegg">@Enegg</a> on 2024-11-01 19:00</div>
            <div class="timeline-body"><!--
Thank you for taking the time to report an issue! We're glad to have you involved with Ruff.

If you're filing a bug report, please consider including the following information:

* List of keywords you searched for before creating this issue. Write them down here so that others can find this issue more easily and help provide feedback.
  e.g. "RUF001", "unused variable", "Jupyter notebook"
* A minimal code snippet that reproduces the bug.
* The command you invoked (e.g., `ruff /path/to/file.py --fix`), ideally including the `--isolated` flag.
* The current Ruff settings (any relevant sections from your `pyproject.toml`).
* The current Ruff version (`ruff --version`).
-->

<p>I've searched for <code>RET504</code> before opening the issue.</p>
<pre><code class="language-py">def outer() -&gt; list[object]:
    @register
    async def inner() -&gt; None:
        print(layout)

    layout = [...]
    return layout  # noqa: RET504
</code></pre>
<p>The rule reports the assignment to <code>layout</code> as unnecessary, and provides a fix by rewriting it as <code>return [...]</code>, which will break the <code>inner</code> function.</p>
<p>The rule doesn't trigger when <code>layout</code> is assigned to above the definition of the <code>inner</code> function, however in my use-case a decorator replaces the function with an object, which is then used to define <code>layout</code>, mandating the assignment to layout happens below the function definition.</p>
<hr />
<pre><code class="language-toml">[tool.ruff.lint]
preview = true
explicit-preview-rules = true
select = [ &quot;ALL&quot; ]
</code></pre>
<p>VSCode extension (<code>v2024.54.0</code>), <code>ruff==0.7.1</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @MichaReiser on 2024-11-01 20:38</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">help wanted</span> added by @MichaReiser on 2024-11-01 20:38</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sbrugman">@sbrugman</a> on 2024-11-04 18:00</div>
            <div class="timeline-body"><p>@Enegg thanks for opening the issue. Could you please provide a more realistic (minimal) example of how you would use layout here? For instance it would help illustrate why the inner function is defined before <code>layout = [...]</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Enegg">@Enegg</a> on 2024-11-04 21:45</div>
            <div class="timeline-body"><p>Sure. Here, note how the function <code>my_button</code> is replaced with the component passed to the decorator:</p>
<pre><code class="language-py">from collections import abc
from dataclasses import dataclass, field
from typing import TypeAlias

# --------- library code ---------

@dataclass
class Component:
    custom_id: str
    disabled: bool = False


Layout: TypeAlias = abc.Sequence[abc.Sequence[Component]]


class Interaction:
    async def respond(self, content: str | None = None, *, components: Layout = ()) -&gt; None: ...


Callback: TypeAlias = abc.Callable[[Interaction], abc.Awaitable[None]]


@dataclass
class Store:
    ids_to_callbacks: dict[str, Callback] = field(default_factory=dict)

    def register(self, component: Component, /) -&gt; abc.Callable[[Callback], Component]:
        def wraps(callback: Callback) -&gt; Component:
            self.ids_to_callbacks[component.custom_id] = callback
            return component
        return wraps

    def make_id(self) -&gt; str: ...
    async def listen(self) -&gt; None: ...

# --------- user code ---------

def create_layout(store: Store) -&gt; Layout:
    @store.register(Component(custom_id=store.make_id()))
    async def my_button(inter: Interaction) -&gt; None:
        my_button.disabled = True
        await inter.respond(&quot;Hello World&quot;, components=layout)

    layout = [[my_button]]
    return layout


async def command(inter: Interaction) -&gt; None:
    store = Store()
    layout = create_layout(store)
    await inter.respond(components=layout)
    await store.listen()
</code></pre>
<p>And here are a few <a href="https://github.com/Enegg/discord-ui-store/blob/bf60916b10b5fe5cf0231e0de1c9746c65f7fc1d/examples/basic.py">examples</a> from my library relying on this setup.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/17656.html">astral-sh/ruff#17656</a> on 2025-04-27 20:41</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/joaoe">@joaoe</a> on 2025-05-23 08:39</div>
            <div class="timeline-body"><p>The presented example is quite obscure to properly detect. Like, how can ruff know if the inner function goes out of scope or is kept globally ?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Enegg">@Enegg</a> on 2025-05-23 16:25</div>
            <div class="timeline-body"><p>Whether a reference to the inner function is stored somewhere is not relevant to the issue.</p>
<p>The rule seems unaware of the fact a variable can be referenced by a closure before it is defined.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/18433.html">astral-sh/ruff#18433</a> on 2025-06-02 19:39</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @ntBre on 2025-07-10 20:10</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:28:14 UTC
    </footer>
</body>
</html>
