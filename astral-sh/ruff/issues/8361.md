```yaml
number: 8361
title: Bash completion emits error about invalid nosort option after installing ruff
type: issue
state: closed
author: gbelouze
labels:
  - bug
  - cli
assignees: []
created_at: 2023-10-30T16:38:45Z
updated_at: 2025-09-19T22:26:34Z
url: https://github.com/astral-sh/ruff/issues/8361
synced_at: 2026-01-10T01:56:50Z
```

# Bash completion emits error about invalid nosort option after installing ruff

---

_Issue opened by @gbelouze on 2023-10-30 16:38_

<!--
Thank you for taking the time to report an issue! We're glad to have you involved with Ruff.

If you're filing a bug report, please consider including the following information:

* A minimal code snippet that reproduces the bug.
* The command you invoked (e.g., `ruff /path/to/file.py --fix`), ideally including the `--isolated` flag.
* The current Ruff settings (any relevant sections from your `pyproject.toml`).
* The current Ruff version (`ruff --version`).
-->
# Context
```bash
$ ruff --version
ruff 0.0.292
```

# Summary
Hi, I have `ruff` installed via `homebrew`. Whenever I open a new terminal I get a 
```bash
bash: complete: nosort: invalid option name
```
I have traced it back to `ruff` autocompletion. This is similar to [this issue](https://github.com/Homebrew/homebrew-core/issues/32535) although that user was having trouble with another package (`wireguard-tools`). 
The issue in that case was that `wireguard` was relying on bash v4 (where presumably the `nosort` option exists), while macOS still uses bash v3. They ended up explicitly disabling autocompletion when detecting an old bash version, see [their fix](https://lists.zx2c4.com/pipermail/wireguard/2018-October/003418.html). I have no idea if the root of the issue is similar here, though.

# Steps to reproduce
`brew install ruff`
and somewhere in your `.bash_profile` or `.bashrc`
```bash
if [ -f $(brew --prefix)/etc/bash_completion ]; then
    . $(brew --prefix)/etc/bash_completion
fi
```

---

_Comment by @gbelouze on 2023-10-30 16:42_

For users who want a quick-and-dirty fix removing the warning, but also the autocompletion for `ruff`, you can add an explicit check in your `$(brew --prefix)/etc/bash_completion` file (for me this is `/usr/local/etc/bash_completion`)
```diff
# source completion directory definitions
if [[ -d $BASH_COMPLETION_COMPAT_DIR && -r $BASH_COMPLETION_COMPAT_DIR && \
    -x $BASH_COMPLETION_COMPAT_DIR ]]; then
    for i in $(LC_ALL=C command ls "$BASH_COMPLETION_COMPAT_DIR"); do
-            i=$BASH_COMPLETION_COMPAT_DIR/$i
-            [[ ${i##*/} != @(*~|*.bak|*.swp|\#*\#|*.dpkg*|*.rpm@(orig|new|save)|Makefile*) \
-                && -f $i && -r $i ]] && . "$i"
+            if [ $i != "ruff" ] 
+            then
+                i=$BASH_COMPLETION_COMPAT_DIR/$i
+                [[ ${i##*/} != @(*~|*.bak|*.swp|\#*\#|*.dpkg*|*.rpm@(orig|new|save)|Makefile*) \
+                    && -f $i && -r $i ]] && . "$i"
+            fi
    done
fi
```

---

_Comment by @zanieb on 2023-10-30 20:20_

Thanks for the well written issue!

Hm is our bash completion generated by us (e.g. via Clap) or by Homebrew during the build?

---

_Label `bug` added by @zanieb on 2023-10-30 20:21_

---

_Label `cli` added by @zanieb on 2023-10-30 20:21_

---

_Comment by @charliermarsh on 2023-10-30 20:23_

I believe it's generated by us using `clap_completion` (can grep for `Command::GenerateShellCompletion`).

---

_Comment by @zanieb on 2023-10-30 20:26_

Ah so it comes from https://github.com/clap-rs/clap/blob/9bfa5a338c6532419e2477e89708395fbb02ca06/clap_complete/src/shells/bash.rs#L61

---

_Comment by @zanieb on 2023-10-30 20:28_

Surprisingly there are no issues on `clap` for this â€” if you have the time I suggest creating one there and we can see if they're interested in support for bash v3. 

---

_Comment by @gbelouze on 2023-10-30 20:52_

Thanks for the quick response, I'll run it by the `clap` people then.

---

_Referenced in [clap-rs/clap#5190](../../clap-rs/clap/issues/5190.md) on 2023-10-30 21:13_

---

_Comment by @ntBre on 2025-09-19 22:26_

I believe this was fixed as early as Ruff v0.3.0! To double-check, I built an old version of bash, reproduced the issue on Ruff v0.0.292 and then confirmed that it was fixed on a later version:

```shell
bash-4.0# source <(uvx ruff@v0.0.292 generate-shell-completion bash)
bash: complete: nosort: invalid option name
bash-4.0# source <(uvx ruff@v0.3.0 generate-shell-completion bash)
bash-4.0# source <(uvx ruff@v0.2.0 generate-shell-completion bash)
bash: complete: nosort: invalid option name
bash-4.0# source <(uvx ruff@v0.13.1 generate-shell-completion bash)
```

Based on the clap PR and when we bumped to clap 4.4.13, I thought this would have been fixed as early as Ruff v0.1.12, but the earliest working version I found was 0.3.0. Anyway, it should definitely be fixed now!

---

_Closed by @ntBre on 2025-09-19 22:26_

---
