<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>open-alias (UP020) has unexpected auto-fix behaviour - astral-sh/ruff #15915</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>open-alias (UP020) has unexpected auto-fix behaviour</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/ruff/issues/15915">#15915</a>
        opened by <a href="https://github.com/RasmusNygren">@RasmusNygren</a>
        on 2025-02-03 18:29
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/RasmusNygren">@RasmusNygren</a></div>
            <div class="timeline-body"><h3>Description</h3>
<p>Running the UP020 rule with --fix produces weird and unexpected results.</p>
<p><strong>Example 1 (ImportStyle::ImportFrom)</strong>
When running <code>ruff check --fix --select --isolated UP020 /path/to/file.py</code> on the particular file below:</p>
<pre><code class="language-python">from io import open
open(&quot;Cargo.toml&quot;)
</code></pre>
<p>you end up with this result:</p>
<pre><code class="language-python">from io import open
import builtins
builtins.open(&quot;Cargo.toml&quot;): ...
</code></pre>
<p>Not only is the <code>from io import open</code> statement still there, but it also imports builtins which is not needed in this minimal example.</p>
<p><strong>Example 2 (ImportStyle::Import)</strong>
When running <code>ruff check --fix --select --isolated UP020 /path/to/file.py</code> on the particular file below:</p>
<pre><code class="language-python">import io
io.open(&quot;Cargo.toml&quot;)
</code></pre>
<p>you end up with the following:</p>
<pre><code class="language-python">import io
open(&quot;Cargo.toml&quot;)
</code></pre>
<p>where the <code>import io</code> statement is still there despite being unused.</p>
<p><code>ruff --version</code>: <code>ruff 0.9.4</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntBre">@ntBre</a> on 2025-02-03 18:46</div>
            <div class="timeline-body"><p>I think both of these examples boil down to the rule not removing the <code>io</code> import. Also enabling <a href="https://docs.astral.sh/ruff/rules/unused-import/">F401 - unused-import</a> should take care of the second case:</p>
<pre><code class="language-shell">$ cat &lt;&lt;EOF | ruff check --select UP020,F401 --diff -
import io
io.open(&quot;Cargo.toml&quot;)
EOF
</code></pre>
<p>Output</p>
<pre><code class="language-diff">@@ -1,2 +1 @@
-import io
-io.open(&quot;Cargo.toml&quot;)
+open(&quot;Cargo.toml&quot;)

Would fix 2 errors.
</code></pre>
<p>But I agree that the first case is not really ideal. Even with F401, <code>builtins</code> still ends up imported:</p>
<pre><code class="language-shell">$ cat &lt;&lt;EOF | ruff check --select UP020,F401 --diff --no-cache -
from io import open
open(&quot;Cargo.toml&quot;)   
EOF
</code></pre>
<p>Output</p>
<pre><code class="language-diff">@@ -1,2 +1,2 @@
-from io import open
-open(&quot;Cargo.toml&quot;)
+import builtins
+builtins.open(&quot;Cargo.toml&quot;)

Would fix 2 errors.
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @MichaReiser on 2025-02-03 19:20</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">fixes</span> added by @MichaReiser on 2025-02-03 19:20</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntBre">@ntBre</a> on 2025-02-03 19:21</div>
            <div class="timeline-body"><p>There is another rule that looks promising for cleaning up the <code>builtins</code> import: <a href="https://docs.astral.sh/ruff/rules/unnecessary-builtin-import/">UP029 - unnecessary-builtin-import</a>, but it doesn't actually help here, unfortunately, as it looks for imports like <code>from builtins import open</code>. That might be the best rule to update  to clean this up? What do you think @MichaReiser or @AlexWaygood ?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-02-03 19:34</div>
            <div class="timeline-body"><p>Adjusting UP029 seems reasonable to me. I'm a bit surprised that it wouldn't catch <code>from io import open</code> because there's an <code>io</code>, <code>open</code> in the match statement here</p>
<p>https://github.com/astral-sh/ruff/blob/14ba469fc099e0678859bba3ae6f67477d8934ec/crates/ruff_linter/src/rules/pyupgrade/rules/unnecessary_builtin_import.rs#L102</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntBre">@ntBre</a> on 2025-02-03 19:39</div>
            <div class="timeline-body"><p>Ahhh, with <code>--unsafe-fixes</code> UP029 <em>does</em> cause the desired behavior:</p>
<pre><code class="language-shell">cat &lt;&lt;EOF | ruff check --select UP020,UP029,F401 --diff --no-cache --unsafe-fixes -
from io import open
open(&quot;Cargo.toml&quot;)
EOF
</code></pre>
<pre><code class="language-diff">@@ -1,2 +1 @@
-from io import open
 open(&quot;Cargo.toml&quot;)

Would fix 1 error.
</code></pre>
<p>But without <code>--unsafe-fixes</code> and with UP020 also selected, UP020 runs and doesn't mention the unsafe fix. I only got the <code>(1 fix available with --unsafe-fixes)</code> when I didn't select UP020 too.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-02-03 19:42</div>
            <div class="timeline-body"><p>Ah nice find. I wonder why the fix is marked as unsafe.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntBre">@ntBre</a> on 2025-02-03 19:58</div>
            <div class="timeline-body"><p>Not sure either, but it's being tracked for improving that in the docs in #15584 at least.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/RasmusNygren">@RasmusNygren</a> on 2025-02-11 19:56</div>
            <div class="timeline-body"><p>Ah, It's interesting why auto-fixing (removing) <code>from builtins import open</code> is deemed unsafe to begin with. The documentation for <a href="https://docs.astral.sh/ruff/rules/unnecessary-builtin-import/">UP029</a> mentions nothing about unsafe fixes so there's a mismatch there somewhere. If the case was <code>import builtins; builtins.open(&quot;Cargo.toml&quot;)</code> (and the equivalent <code>import io; io.open(&quot;Cargo.toml&quot;)</code>) it makes sense for that variant of the problem to be unsafe to auto-fix as potential shadowing means that the same behaviour can not be guaranteed, but I can't see how this applies to the variant with <code>from ... import ...</code>.</p>
<p>However, with that logic, what UP029 does in Example 2 is probably unsafe (despite being classified as safe). As otherwise removing the builtins prefix in <code>import builtins; builtins.open</code> must be safe as well, but is not classified as such.</p>
<p>To connect this back to the original issue - I can't see why the fix for Example 1 would involve the explicit builtins import at all. It can probably be auto-fixed without it as involving the builtins import (using the <code>import builtins; builtins.open</code> syntax) essentially converts what could be a safe auto-fix into a different format of the problem where auto-fixing is most certainly unsafe. And would now require UP029 as well to get the expected behaviour.</p>
<p>Unless I'm missing something essential here, my opinion is that the Example 1 version should probably not rely on UP029 (or F401 for that matter) at all for the fix, and Example 2 should at least turn</p>
<pre><code class="language-python">import io
io.open(&quot;Cargo.toml&quot;)
</code></pre>
<p>into</p>
<pre><code class="language-python">import builtins
builtins.open(&quot;Cargo.toml&quot;)
</code></pre>
<p>if it can't be safely auto-fixed by dropping the io import</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 16:52:07 UTC
    </footer>
</body>
</html>
