<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>False positive for TCH002 when type used in a method - astral-sh/ruff #13926</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>False positive for TCH002 when type used in a method</h1>

    <div class="meta">
        <span class="state state-open">Open</span>
        <a href="https://github.com/astral-sh/ruff/issues/13926">#13926</a>
        opened by <a href="https://github.com/last-partizan">@last-partizan</a>
        on 2024-10-25 12:31
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/last-partizan">@last-partizan</a> on 2024-10-25 12:31</div>
            <div class="timeline-body"><p>I'm using DRF and drf-spectacular, and it uses runtime type introspection for some cases (like <code>serializers.SerializerMethodField()</code>. And i have no way to tell <code>ruff</code> to not move those types into TYPE_CHECKING block.</p>
<p>I tried <code>runtime-evaluated-base-classes</code>, but looks like it only works for class fields, not class methods.</p>
<pre><code>&gt; ruff --version
ruff 0.7.1
</code></pre>
<pre><code class="language-toml">[tool.ruff]
target-version = &quot;py39&quot;

[tool.ruff.lint]
select = [&quot;TCH&quot;]

[tool.ruff.lint.flake8-type-checking]
runtime-evaluated-base-classes = [
	&quot;rest_framework.serializers.Serializer&quot;,
	&quot;rest_framework.serializers.ModelSerializer&quot;,
]
</code></pre>
<pre><code class="language-py">from __future__ import annotations

from rest_framework import serializers

from app.models import Book


class BookSerializer(serializers.Serializer):
    name = serializers.SerializerMethodField()

    def get_name(self, instance: Book) -&gt; str:
        return instance.name
</code></pre>
<pre><code class="language-sh">&gt; ruff check --select TCH project/serializers.py
project/serializers.py:5:24: TCH002 Move third-party import `app.models.Book` into a type-checking block
  |
3 | from rest_framework import serializers
4 |
5 | from app.models import Book
  |                        ^^^^ TCH002
  |
  = help: Move into type-checking block
</code></pre>
<p>Workaround for this is probably using <code>runtime-evaluated-base-classes</code> and adding <code>instance: MyClass</code> for affected serializers. But would be nice to have proper solution.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-10-26 08:23</div>
            <div class="timeline-body"><p>I'm not familiar with any of the frameworks that you mentioned in the summary and not knowing <code>Book</code>s definition makes it a bit hard to follow the example. Could you explain me where the code depends on runtime type annotations and how Book'` defined (is it just a django model or is there more?)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/last-partizan">@last-partizan</a> on 2024-10-26 16:11</div>
            <div class="timeline-body"><p>Yes, <code>Book</code> is just a Django model. It's not really important, can be anything.</p>
<p><code>djangorestframework</code> is used to define API/serializers, and <code>drf_spectacular</code> is used to build <code>schema.yml</code> from it.</p>
<p>And for <code>name</code> field, it uses <code>get_type_hints</code> from <code>typing</code> module, to know what it returns.</p>
<pre><code class="language-python"># Partial traceback
    return append_meta(self._map_response_type_hint(method), meta)
# ...   .../site-packages/drf_spectacular/openapi.py:1119: in _map_response_type_hint
    hint = get_override(method, 'field') or get_type_hints(method).get('return')
</code></pre>
<p>I can make a full repo with reproduction, but it's actually boils down to this:</p>
<pre><code class="language-python">from __future__ import annotations
from typing import TYPE_CHECKING, get_type_hints

if TYPE_CHECKING:
    # We're just using this as example, instead of 'from app.models import Book'
    from collections.abc import MutableMapping


class Serializer: ...


class SerializerMethodField: ...


class BookSerializer(Serializer):
    name = SerializerMethodField()

    def get_name(self, instance: MutableMapping) -&gt; str: ...


# drf_spectacular calls get_type_hints on a method to get return type
get_type_hints(BookSerializer.get_name)
</code></pre>
<p>I hope that's enough, but if not, i can make full repo with example.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Avasam">@Avasam</a> on 2024-10-27 09:14</div>
            <div class="timeline-body"><p>@MichaReiser <code>drf-spectacular</code> inspects runtime annotations to produce an OpenAPI spec schema (an API specification that describes the shape of an endpoint and the accepted/provided types) based on your Django Serializers (or a manually written spec string, but that's irrelevant to this issue).</p>
<p>I think what's being asked here is for a way to specify that all subclasses of a certain type have all their method annotations not be picked up by <code>TCH001</code>/<code>TCH002</code>/<code>TCH003</code>. That way one could say that if the type is used as an annotation in a <code>Serializer</code> subclass, to not remove it.</p>
<p>Even without multifile analysis this could be beneficial since Django Serializers are often all grouped in a single module (due to circular import issues).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-10-27 13:54</div>
            <div class="timeline-body"><p>@AlexWaygood would you mind taking a look at this. This is definitely beyond my Python knowledge üòÖ</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @AlexWaygood by @AlexWaygood on 2024-10-27 14:09</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/last-partizan">@last-partizan</a> on 2024-10-28 10:11</div>
            <div class="timeline-body"><blockquote>
<p>I think what's being asked here is for a way to specify that all subclasses of a certain type have all their method annotations not be picked up by TCH001/TCH002/TCH003. That way one could say that if the type is used as an annotation in a Serializer subclass, to not remove it.</p>
</blockquote>
<p>Yes, that's exactly what's needed.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-10-28 12:40</div>
            <div class="timeline-body"><p>Somewhat related #13713</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/stiangrim">@stiangrim</a> on 2025-04-09 07:11</div>
            <div class="timeline-body"><p>We are struggling with this as well (Ruff telling me to move stuff into TYPE_CHECKING blocks, which breaks drf-spectacular schema). Any updates? üôè</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/johannesloibl">@johannesloibl</a> on 2025-07-15 10:45</div>
            <div class="timeline-body"><p>This is sooo annoying...</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Unassigned @AlexWaygood by @AlexWaygood on 2025-07-15 10:46</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../jupyter-server/jupyter_server/pulls/1558.html">jupyter-server/jupyter_server#1558</a> on 2025-09-01 23:59</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:34:53 UTC
    </footer>
</body>
</html>
