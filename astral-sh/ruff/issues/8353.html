<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add exception for PYI034 for the usage of Self in metaclasses - astral-sh/ruff #8353</title>
    <link rel="stylesheet" href="../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../index.html">Back to index</a>
    </div>

    <h1>Add exception for PYI034 for the usage of Self in metaclasses</h1>

    <div class="meta">
        <span class="state state-closed">Closed</span>
        <a href="https://github.com/astral-sh/ruff/issues/8353">#8353</a>
        opened by <a href="https://github.com/ZeeD">@ZeeD</a>
        on 2023-10-30 10:51
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/ZeeD">@ZeeD</a> on 2023-10-30 10:51</div>
            <div class="timeline-body"><!--
Thank you for taking the time to report an issue! We're glad to have you involved with Ruff.

If you're filing a bug report, please consider including the following information:

* A minimal code snippet that reproduces the bug.
* The command you invoked (e.g., `ruff /path/to/file.py --fix`), ideally including the `--isolated` flag.
* The current Ruff settings (any relevant sections from your `pyproject.toml`).
* The current Ruff version (`ruff --version`).
-->

<p>minimal example:</p>
<pre><code class="language-python">from __future__ import annotations
from typing import Any, Self
class Meta(type):
    def __new__(cls,
                name: str,
                bases: tuple[type, ...],
                classdict: dict[str, Any]) -&gt; Meta:
        return super().__new__(cls, name, bases, classdict)
</code></pre>
<p>in this dummy metaclass - if I run <code>ruff</code> enabling the rule <code>PYI034</code> I got</p>
<pre><code>PYI034 `__new__` methods in classes like `Meta` usually return `self` at runtime
</code></pre>
<p>Unfortunately I think this is one of the exceptions in the usual cases the error talks about :)</p>
<p>If I annotate <code>__new__</code> with <code>Self</code> as return type, in fact, <code>mypy</code> tells me</p>
<pre><code>error: Self type cannot be used in a metaclass  [misc]
</code></pre>
<p>(as you can see in https://github.com/python/mypy/blob/master/mypy/typeanal.py#L688-L689 )</p>
<p>Could you refine <code>PYI034</code> to ignore the <code>Self</code> requirements for metaclasses?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @charliermarsh on 2023-10-30 13:24</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-10-30 23:42</div>
            <div class="timeline-body"><p>Interesting, flake8-pyi reports the same thing here. (\cc @AlexWaygood, you may be interested in this.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2023-10-31 00:12</div>
            <div class="timeline-body"><blockquote>
<p>Interesting, flake8-pyi reports the same thing here. (\cc @AlexWaygood, you may be interested in this.)</p>
</blockquote>
<p>Yup. Personally I think it's somewhat unfortunate that <a href="https://peps.python.org/pep-0673/">PEP 673</a> mandates this behaviour for metaclasses â€” but it does, and it's pretty unlikely that that's going to change any time soon. So mypy is definitely correct here; this is indeed a false positive from flake8-pyi.</p>
<p>The somewhat-hacky workaround we use in typeshed that keeps both flake8-pyi and mypy happy here is to just use a normal TypeVar that happens to be called Self(!): https://github.com/python/typeshed/blob/f7aa7b709a826ed34f52b1de3f7095f90f349a9c/stdlib/abc.pyi#L14-L19</p>
<p>Possibly flake8-pyi could add some heuristics here to try to detect if a class is a metaclass, and avoid emitting this error if so. I'm not sure if it would be worth it for us, though, since:</p>
<ol>
<li>Metaclasses in general are pretty rare anyway, especially in stubs</li>
<li>I think it might significantly complicate our implementation of the check</li>
<li>Since we're a linter, not a type checker, it's pretty hard for us to reliably detect whether a class is a metaclass or not :(</li>
</ol>
<p>Ruff isn't necessarily bound by the same constraints, though, so if you can see a way of avoiding this false positive, then I'd say go ahead!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2023-10-31 01:50</div>
            <div class="timeline-body"><p>Thanks @AlexWaygood for taking the time to look at the issue!</p>
<blockquote>
<p>Ruff isn't necessarily bound by the same constraints, though, so if you can see a way of avoiding this false positive, then I'd say go ahead!</p>
</blockquote>
<p>I think one solution would be to update the semantic model to include a new <code>META_CLASS</code> flag to be set when we encounter a metaclass and use that while checking for the rule violation. But, @charliermarsh will know more about this.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../PyCQA/flake8-pyi/pulls/436.html">PyCQA/flake8-pyi#436</a> on 2023-10-31 10:54</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2023-10-31 10:58</div>
            <div class="timeline-body"><p>Here's my best attempt at fixing this for flake8-pyi: https://github.com/PyCQA/flake8-pyi/pull/436. The check's already pretty complicated, so it didn't end up significantly complicating the implementation after all :)</p>
<p>But it would be great if ruff could fix this without the hacky heuristics that I'm using there ;)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/JelleZijlstra">@JelleZijlstra</a> on 2023-10-31 15:08</div>
            <div class="timeline-body"><p>Does Ruff run this check in <code>.py</code> files? <code>flake8-pyi</code> is designed only for pyi files, and I'm not sure this kind of check should be applied to <code>.py</code> files, where the type checker can see the body and therefore can provide more feedback.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2023-10-31 15:51</div>
            <div class="timeline-body"><p>I actually think this rule could still be useful for <code>.py</code> files. If you have a class like this, a type checker won't necessarily emit an error on any of the <code>-&gt; Foo</code> return annotations, since none of them are, strictly speaking, <em>incorrect</em>. But the annotations could also perhaps be <em>better</em>, and fixing them as soon as the class is written could save the author of the code some refactoring later on:</p>
<pre><code class="language-py">from collections.abc import Iterator

class Foo(Iterator[int]):
    def __new__(cls) -&gt; Foo:
        return cls()

    def __iter__(self) -&gt; Foo:
        return self

    def __next__(self) -&gt; int:
        return 42

    def __enter__(self) -&gt; Foo:
        return self
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-10-31 15:54</div>
            <div class="timeline-body"><p>(We do run this over <code>.py</code> files. We don't run <em>all</em> <code>flake8-pyi</code> rules over <code>.py</code> files, but we do run a subset, and this one is included.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2023-11-09 18:44</div>
            <div class="timeline-body"><blockquote>
<p>Here's my best attempt at fixing this for flake8-pyi: <a href="https://github.com/PyCQA/flake8-pyi/pull/436">PyCQA/flake8-pyi#436</a>.</p>
</blockquote>
<p>This is included in the <a href="https://github.com/PyCQA/flake8-pyi/releases/tag/23.11.0">latest flake8-pyi release</a> FYI! Thanks for the ping @charliermarsh :D</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-11-09 19:30</div>
            <div class="timeline-body"><p>Awesome, thanks @AlexWaygood! You rock.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @charliermarsh by @charliermarsh on 2023-11-12 21:50</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/8639.html">astral-sh/ruff#8639</a> on 2023-11-12 22:55</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2023-11-13 00:47</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/16127.html">astral-sh/ruff#16127</a> on 2025-02-12 22:05</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:28:11 UTC
    </footer>
</body>
</html>
