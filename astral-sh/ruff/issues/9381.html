<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>`ruff format` or `ruff check` returns &quot;nested alternate groups are not allowed&quot; error - astral-sh/ruff #9381</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1><code>ruff format</code> or <code>ruff check</code> returns &quot;nested alternate groups are not allowed&quot; error</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/issues/9381">#9381</a>
        opened by <a href="https://github.com/niccolomineo">@niccolomineo</a>
        on 2024-01-03 14:58
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/niccolomineo">@niccolomineo</a></div>
            <div class="timeline-body"><p>I am attempting to exclude this dir from inspection:</p>
<pre><code>extend-exclude = [
    &quot;__pycache__&quot;,
]
</code></pre>
<p>but I am getting:</p>
<pre><code>$ python3 -m ruff format .
ruff failed
  Cause: error parsing glob &#x27;/Users/me/project/{{cookiecutter.project_dirname}}/__pycache__&#x27;: nested alternate groups are not allowed
</code></pre>
<p>Any ideas?</p>
<p>On a side note, according to <a href="https://regex101.com/r/I8WJGr/1">this</a> experiment, this syntax should be valid</p>
<pre><code>extend-exclude = [
    &quot;[{][{]cookiecutter[.]project_dirname[}][}]/__pycache__&quot;,
]
</code></pre>
<p>but it still gets me the error above.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-01-04 04:06</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-01-04 04:07</div>
            <div class="timeline-body"><p>To clarify, the whole config is:</p>
<pre><code>extend-exclude = [
    &quot;__pycache__&quot;,
]
</code></pre>
<p>Is that right? And you&#x27;re running from the <code>/Users/me/project/{{cookiecutter.project_dirname}}</code> directory?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/niccolomineo">@niccolomineo</a> on 2024-01-04 11:59</div>
            <div class="timeline-body"><p>The whole config is:</p>
<pre><code>extend-exclude = [
    &quot;__pycache__&quot;,
    &quot;.vscode*&quot;,
]
</code></pre>
<p>and I am running from <code>Users/me/project/</code>.</p>
<p><code>{{cookiecutter.project_dirname}}</code> is a subdir in that path.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-01-04 13:51</div>
            <div class="timeline-body"><p>Got it, thanks!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/niccolomineo">@niccolomineo</a> on 2024-01-04 13:56</div>
            <div class="timeline-body"><blockquote>
<p>Got it, thanks!</p>
</blockquote>
<p>Thank YOU! Are you able to confirm it is a bug and not something I have to tweak on my side?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-01-04 16:31</div>
            <div class="timeline-body"><p>From the description it looks like a bug. What you could do though is omit that directory entirely:</p>
<pre><code>extend-exclude = [
    &quot;[{][{]cookiecutter.project_dirname[}][}]&quot;,
]
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-01-04 16:31</div>
            <div class="timeline-body"><p>(Taken from: <a href="https://github.com/astral-sh/ruff/issues/7959">astral-sh/ruff#7959</a>#issuecomment-1764751734)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/niccolomineo">@niccolomineo</a> on 2024-01-04 18:38</div>
            <div class="timeline-body"><blockquote>
<p>From the description it looks like a bug. What you could do though is omit that directory entirely:</p>
<pre><code>
extend-exclude = [

    &quot;[{][{]cookiecutter.project_dirname[}][}]&quot;,

]

</code></pre>
</blockquote>
<p>Unfortunately I need to target specific subdirs of that unusual dir, so that&#x27;s not viable for me.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/niccolomineo">@niccolomineo</a> on 2024-01-05 12:41</div>
            <div class="timeline-body"><p>Hi @charliermarsh, you might be already aware of this, but this is occurring with the base <code>ruff</code> command as well, not just with <code>ruff format</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">cli</span> added by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-01-08 08:09</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">configuration</span> added by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-01-08 08:10</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">cli</span> removed by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-01-08 08:11</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from &quot;`ruff format` returns &quot;nested alternate groups are not allowed&quot; error&quot; to &quot;`ruff format` or `ruff check` returns &quot;nested alternate groups are not allowed&quot; error&quot; by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-01-08 08:11</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/GitRon">@GitRon</a> on 2024-10-29 10:23</div>
            <div class="timeline-body"><p>We have the same issue in combination with cookiecutter ðŸ˜• The curly brackets seem to be a problem.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/knowfahad">@knowfahad</a> on 2025-01-31 16:11</div>
            <div class="timeline-body"><p>Any update on this?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/lucasfijen">@lucasfijen</a> on 2025-02-21 09:47</div>
            <div class="timeline-body"><p>Yep I&#x27;m running in exactly the same in combination with cookiecutter.
In my case it&#x27;s with the per-file-ignores, but that probably translates to the same underlying issue</p>
<p>I have a folder structure:</p>
<pre><code>.
â”œâ”€â”€ pyproject.toml
â””â”€â”€ {{ cookiecutter.repo_name }}
    â”œâ”€â”€ tests
    â”‚   â””â”€â”€ maintest.py
    â”œâ”€â”€ main.py
    â””â”€â”€ pyproject.toml

</code></pre>
<p>Where my pyproject.toml contains this setting that is causing the issue, removing this line fixes the error</p>
<pre><code>[tool.ruff.lint.per-file-ignores]
&quot;tests/*&quot; = [&quot;F811&quot;]
</code></pre>
<p>Then running ruff from the root  using <code>cookiecutter format .</code> will cause:</p>
<pre><code>ruff failed
  Cause: error parsing glob &#x27;/workspaces/reponame/{{cookiecutter.repo_name}}/tests/*&#x27;: nested alternate groups are not allowed
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntBre">@ntBre</a> on 2025-02-21 16:43</div>
            <div class="timeline-body"><p>Does anyone have a link to a repo or gist where I could reproduce this? I&#x27;m trying to take a look but having some trouble reproducing it locally with this file tree:</p>
<pre><code>.
â”œâ”€â”€ ruff.toml
â””â”€â”€ {{cookiecutter.project_dirname}}
    â”œâ”€â”€ __pycache__
    â”‚Â Â  â””â”€â”€ try.py
    â””â”€â”€ try.py
</code></pre>
<p>We use <a href="https://docs.rs/globset/latest/globset/">globset</a> for most of our path globs, which has the comment &quot;Nesting {...} is not currently allowed&quot; in the docs, so I think the curly braces are definitely the problem.</p>
<p>For now the best workarounds are still &quot;escaping&quot; the curly braces with square brackets (<code>[{]</code>) or backslashes (<code>\{</code>, if you&#x27;re not on Windows), but I agree that it would be nice if we had some heuristics for detecting this automatically.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/lucasfijen">@lucasfijen</a> on 2025-02-21 17:43</div>
            <div class="timeline-body"><p>Thank you for taking your time to looking into it! This monday I should have some time to setup a small example repo for you to make it reproducible.</p>
<p>The issue with this cookiecutter example is that the glob part with the curly brackets is not included in the ignore list field, as that part should be relative paths. However the curly brackets part are included when running ruff from the root (for this example we might need a second pyproject.toml above the ccokiecutter.project_dirname to get it reproduced.</p>
<p>This explanation might not be very clear, I&#x27;ll work on an example repo for you:)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/lucasfijen">@lucasfijen</a> on 2025-02-24 08:16</div>
            <div class="timeline-body"><p>@ntBre as promised I created a repository to showcase the issue <a href="https://github.com/lucasfijen/example_ruff_glob_bug">here</a>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntBre">@ntBre</a> on 2025-02-24 14:50</div>
            <div class="timeline-body"><p>@lucasfijen Thank you so much! I cloned the repo and can now reproduce!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/ntBre">@ntBre</a> on 2025-03-03 14:30</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 18:48:48 UTC
    </footer>
</body>
</html>
