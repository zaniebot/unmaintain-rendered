<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ruff unconditionally assumes any string in a type parameter is a forward annotation - astral-sh/ruff #11378</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Ruff unconditionally assumes any string in a type parameter is a forward annotation</h1>

    <div class="meta">
        <span class="state state-open">Open</span>
        <a href="https://github.com/astral-sh/ruff/issues/11378">#11378</a>
        opened by <a href="https://github.com/lanzz">@lanzz</a>
        on 2024-05-12 11:09
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/lanzz">@lanzz</a> on 2024-05-12 11:09</div>
            <div class="timeline-body"><p>I have an alias for <code>Annotated</code>, to be used in a container class:</p>
<pre><code class="language-python">
class Container:
    # class that inspects its type annotations at runtime and does stuff with them

Field = typing.Annotated

class MyContainer(Container):
    foo_field: Field[int, 'metadata']    # ruff raises F281 &quot;Undefined name `metadata` here
    bar_field: Field[str, 'not a valid identifier']   # ruff raises F722 &quot;Syntax error in forward annotation&quot; here
    foo_ann: typing.Annotated[int, 'metadata']    # no complaints here
    bar_ann: typing.Annotated[str, 'not a valid identifier']   # no complaints here either
</code></pre>
<p>Ultimately, the <code>Field</code> alias is just sugar to make the definitions of subclasses of <code>Container</code> better self-documenting. I understand this is a pretty niche use and it's very likely not feasible for Ruff to figure out that <code>Field</code> is alias for <code>Annotated</code> (especially since in practice that alias definition is in a completely different module), but is there a way to explicitly instruct Ruff to treat those instances of <code>Field</code> the same way it treats actual <code>Annotated</code> type definitions, without having to suppress the rule explicitly on every single line that uses <code>Field</code>? If I could define ignores by line regex that would work (e.g. ignore F281, F722 for lines matching <code>:\s+Field\[</code>), but I don't think Ruff supports that, or at least I could not find it in the docs.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-05-13 01:48</div>
            <div class="timeline-body"><p>I don't know that we have a great workaround here right now. If we can't resolve a symbol, and it's subscripted in an annotation, we <em>do</em> assume that any strings within the subscript are forward annotations, since they're almost always generics.</p>
<p>I suspect this will eventually &quot;just work&quot; as we're doing a lot of foundational work right now to make Ruff capable of this kind of inference. But in the interim, struggling to think of anything other than adding <code># ruff: noqa: F281, F722</code> to the file.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">type-inference</span> added by @charliermarsh on 2024-05-13 01:48</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../microsoft/pyright/issues/8134.html">microsoft/pyright#8134</a> on 2024-06-12 23:07</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/rmorshea">@rmorshea</a> on 2024-06-12 23:07</div>
            <div class="timeline-body"><p>As an additional note, this happens for any string literal in <code>Annotated</code>:</p>
<pre><code class="language-python">Field[int, {&quot;some&quot;: &quot;metadata&quot;}] 
</code></pre>
<pre><code>Undefined name `some`
Undefined name `metadata`
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-06-12 23:09</div>
            <div class="timeline-body"><p>Do you mean, if you reassign <code>Annotated</code> to something else? I don't see that behavior for <code>Annotated</code> itself: https://play.ruff.rs/2f8e1c84-7a7d-4173-8146-4d5718d279ea</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/rmorshea">@rmorshea</a> on 2024-06-12 23:10</div>
            <div class="timeline-body"><p>Correct. If <code>Annotated</code> has been aliased or imported from a different location this is true.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-06-13 00:23</div>
            <div class="timeline-body"><p>You should be able to successfully import it from a different location by setting <a href="https://docs.astral.sh/ruff/settings/#lint_typing-modules"><code>typing-modules</code></a>, as long as it isn't aliased.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/16985.html">astral-sh/ruff#16985</a> on 2025-03-26 18:08</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/9860.html">astral-sh/ruff#9860</a> on 2025-09-12 16:55</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/21077.html">astral-sh/ruff#21077</a> on 2025-10-26 01:02</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:34:52 UTC
    </footer>
</body>
</html>
