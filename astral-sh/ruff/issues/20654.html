<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>C414 fixes should variously be documented, removed, and marked as safe - astral-sh/ruff #20654</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>C414 fixes should variously be documented, removed, and marked as safe</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/ruff/issues/20654">#20654</a>
        opened by <a href="https://github.com/dscorbett">@dscorbett</a>
        on 2025-09-30 21:48
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dscorbett">@dscorbett</a></div>
            <div class="timeline-body"><h3>Summary</h3>
<p>The fix for <a href="https://docs.astral.sh/ruff/rules/unnecessary-double-cast-or-process/"><code>unnecessary-double-cast-or-process</code> (C414)</a> is marked as unsafe. The documentation says this is because comments may be removed, which is true but not the main reason. Many of the fixes could actually be marked as safe, others should be suppressed, and the rest should be documented.</p>
<p>To avoid changing behavior by introducing or suppressing a <code>TypeError</code>, the fix (or the rule itself) should be suppressed when one of these is true:</p>
<ul>
<li>The inner function has an unknown keyword argument.</li>
<li>The inner function has the wrong number of positional arguments.</li>
<li>The inner function has zero arguments and the outer function requires an argument. (<code>sorted</code> is the only outer function that requires an argument.)</li>
<li>The inner function has a double-starred argument but doesnâ€™t accept keyword arguments. (<code>sorted</code> is the only one that accepts keyword arguments.)</li>
</ul>
<p><a href="https://play.ruff.rs/5be686f2-b5a5-4b8a-b598-cd583a458675">Examples</a>:</p>
<pre><code class="language-console">$ cat &gt;c414_1.py &lt;&lt;'# EOF'
try: print(list(list(&quot;abc&quot;, error=True)))
except TypeError as e: print(e)

try: print(list(list(&quot;abc&quot;, True)))
except TypeError as e: print(e)

try: print(set(sorted()))
except TypeError as e: print(e)

try: print(sorted(tuple()))
except TypeError as e: print(e)

try: print(list(list(&quot;abc&quot;, **{&quot;error&quot;: True})))
except TypeError as e: print(e)
# EOF

$ python c414_1.py
list() takes no keyword arguments
list expected at most 1 argument, got 2
sorted expected 1 argument, got 0
[]
list() takes no keyword arguments

$ ruff --isolated check --select C414 c414_1.py --unsafe-fixes --fix
Found 5 errors (5 fixed, 0 remaining).

$ python c414_1.py
['a', 'b', 'c']
['a', 'b', 'c']
set()
sorted expected 1 argument, got 0
['a', 'b', 'c']
</code></pre>
<p>Many combinations of functions are safe to fix. <a href="https://play.ruff.rs/8c3e70ad-ad3c-4cd8-aa08-3a3bbe33b093">All of these</a> are safe:</p>
<pre><code class="language-console">$ cat &gt;c414_2.py &lt;&lt;'# EOF'
print(list(list(&quot;LL&quot;)))
print(list(tuple(&quot;LT&quot;)))
print(tuple(list(&quot;TL&quot;)))
print(tuple(tuple(&quot;TT&quot;)))
print(set(set(&quot;SS&quot;)))
print(set(list(&quot;SL&quot;)))
print(set(tuple(&quot;ST&quot;)))
print(sorted(list(&quot;~L&quot;)))
print(sorted(tuple(&quot;~T&quot;)))
print(sorted(sorted(&quot;~!&quot;)))
# EOF

$ python c414_2.py
['L', 'L']
['L', 'T']
('T', 'L')
('T', 'T')
{'S'}
{'S', 'L'}
{'S', 'T'}
['L', '~']
['T', '~']
['!', '~']

$ ruff --isolated check --select C414 c414_2.py --unsafe-fixes --fix
Found 10 errors (10 fixed, 0 remaining).

$ python c414_2.py
['L', 'L']
['L', 'T']
('T', 'L')
('T', 'T')
{'S'}
{'L', 'S'}
{'T', 'S'}
['L', '~']
['T', '~']
['!', '~']
</code></pre>
<p>That list notwithstanding, the fix is still unsafe when one of these is true:</p>
<ul>
<li>A comment is deleted.</li>
<li>The combination of <code>sorted</code> and <code>sorted</code> uses keyword arguments with side effects.</li>
<li>The outer function is <code>sorted</code>, the inner function is <code>list</code> or <code>tuple</code>, and the argument is starred.</li>
<li>The outer and inner functions respectively are:<ul>
<li><code>sorted</code> and <code>reversed</code></li>
<li><code>set</code> and <code>reversed</code></li>
<li><code>set</code> and <code>sorted</code></li>
</ul>
</li>
</ul>
<p><a href="https://play.ruff.rs/81de048a-b41a-4dcf-a2bf-ee0d743976d7">Examples</a>:</p>
<pre><code class="language-console">$ cat &gt;c414_3.py &lt;&lt;'# EOF'
keys = iter([hex, lambda x: len(str(x))])
print(sorted(sorted([True, 2, 1], key=next(keys)), key=next(keys)))

try: print(sorted(list(*())))
except TypeError as e: print(e)

try: print(sorted(tuple(*())))
except TypeError as e: print(e)

print(sorted(reversed([1, True])))

print(set(reversed([1, True])))

try: print(set(sorted([t&quot;1&quot;, t&quot;2&quot;])))
except TypeError as e: print(e)
# EOF

$ python3.14 c414_3.py
[1, 2, True]
[]
[]
[True, 1]
{True}
'&lt;' not supported between instances of 'string.templatelib.Template' and 'string.templatelib.Template'

$ ruff --isolated check --select C414 c414_3.py --unsafe-fixes --fix --target-version py314 --preview
Found 6 errors (6 fixed, 0 remaining).

$ python3.14 c414_3.py
[True, 1, 2]
sorted expected 1 argument, got 0
sorted expected 1 argument, got 0
[1, True]
{1}
{Template(strings=('1',), interpolations=()), Template(strings=('2',), interpolations=())}
</code></pre>
<h3>Version</h3>
<p>ruff 0.13.2 (b0bdf0334 2025-09-25)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">fixes</span> added by @amyreese on 2025-10-01 01:31</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 16:53:23 UTC
    </footer>
</body>
</html>
