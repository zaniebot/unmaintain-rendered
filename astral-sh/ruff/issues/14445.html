<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fixes on Jupyter notebooks cause panics when fix replaces/deletes multiple cells - astral-sh/ruff #14445</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Fixes on Jupyter notebooks cause panics when fix replaces/deletes multiple cells</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/ruff/issues/14445">#14445</a>
        opened by <a href="https://github.com/beskep">@beskep</a>
        on 2024-11-19 00:45
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/beskep">@beskep</a></div>
            <div class="timeline-body">

<ul>
<li><p>command: <code>ruff check .\src\test.ipynb --fix --diff</code>
(No panic when <code>--isolated</code> included)</p>
</li>
<li><p>ruff version: 0.7.4</p>
</li>
<li><p>pyproject.toml</p>
</li>
</ul>
<pre><code>[project]
requires-python = &quot;&gt;=3.13&quot;
dependencies = [&quot;ruff&gt;=0.7.4&quot;]

[tool.ruff]
preview = true

[tool.ruff.lint]
select = [&quot;W&quot;]
</code></pre>
<ul>
<li>ipynb file: <a href="https://github.com/user-attachments/files/17807695/test.ipynb.zip">test.ipynb.zip</a></li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dylwil3">@dylwil3</a> on 2024-11-19 02:05</div>
            <div class="timeline-body"><p>Thanks so much for this!</p>
<p>This can be reproduced with a notebook that just consists of three empty cells. We are somehow counting empty cells as newlines and then erroring when we try to &quot;delete&quot; them.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by <a href="https://github.com/dylwil3">@dylwil3</a> on 2024-11-19 02:05</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">notebook</span> added by <a href="https://github.com/dylwil3">@dylwil3</a> on 2024-11-19 02:05</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dylwil3">@dylwil3</a> on 2024-11-19 02:20</div>
            <div class="timeline-body"><p>Actually this bug has a wider blast radius.</p>
<p>If you make a notebook with three cells like this:</p>
<pre><code>a = [1]
a.append(2)
# new cell
a.append(3)
# new cell
a.append(4)
</code></pre>
<p>and apply the unsafe fix for <code>FURB118</code> you also get a panic.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from &quot;[Linter panic] when fixing W391 in Jupyter notebook&quot; to &quot;Fixes on Jupyter notebooks cause panics when fix replaces/deletes multiple cells&quot; by <a href="https://github.com/dylwil3">@dylwil3</a> on 2024-11-19 02:21</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-11-19 03:12</div>
            <div class="timeline-body"><p>I&#x27;m guessing that cell deletion is creating a problem when <code>update_cell_offsets</code> and <code>update_cell_contents</code> are being called.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-11-19 09:37</div>
            <div class="timeline-body"><p>The root cause is because the edit spans across the cell boundary which is an invariant we like to follow. In the case of <code>FURB113</code>, the diagnostics is between 3 cells and thus the edit is as well.</p>
<p>Refer to how the cell offsets are being updated (incorrectly):</p>
<pre><code>// Original cell offsets
[crates/ruff_notebook/src/notebook.rs:229:9] &amp;self.cell_offsets = CellOffsets(
    [
        0,
        20,
        32,
        44,
    ],
)

// The edit
[crates/ruff_linter/src/fix/mod.rs:97:13] edit = Edit {
    range: 8..43,
    content: Some(
        &quot;x.extend((2, 3, 4))&quot;,
    ),
}

// Source map created for the edit
[crates/ruff_notebook/src/notebook.rs:230:9] source_map = SourceMap(
    [
        SourceMarker {
            source: 8,
            dest: 8,
        },
        SourceMarker {
            source: 43,
            dest: 27,
        },
    ]
)

// After the above source map is applied to update the cell offsets
[crates/ruff_notebook/src/notebook.rs:263:9] &amp;self.cell_offsets = CellOffsets(
    [
        0,
        20,
        32,
        28,
    ],
)
</code></pre>
<p>I don&#x27;t this rule existed when I implemented this.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-11-19 09:48</div>
            <div class="timeline-body"><p>So, I think we need to consider replacement and deletion across cell boundaries. Insertion is fine because it&#x27;s at an exact position which isn&#x27;t going to affect this logic. There&#x27;s some details on how the source markers are being used to update the cell offsets in the PR description: <a href="https://github.com/astral-sh/ruff/pull/4665">astral-sh/ruff#4665</a>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dylwil3">@dylwil3</a> on 2024-11-19 15:13</div>
            <div class="timeline-body"><p>Oh that&#x27;s neat- and nice drawing! For deletions we could just delete the cell and adjust the cell offsets (so there will be fewer cell offsets than there used to be). What do you think?</p>
<p>For replacements it&#x27;s a little less clear what to do, since folks separate things across cells in order to control what executes when.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-11-20 05:15</div>
            <div class="timeline-body"><blockquote>
<p>For deletions we could just delete the cell and adjust the cell offsets (so there will be fewer cell offsets than there used to be). What do you think?</p>
</blockquote>
<p>The thing is we don&#x27;t really know the kind of edit when trying to update the cell offsets. The main reason for adding the <code>SourceMap</code> abstraction is to avoid passing this information and it would also help in adding multi-language support in Ruff. So, in <code>update_cell_offsets</code> you only have access to the list of <code>SourceMarker</code> and we don&#x27;t really know which two source markers makes up an edit.</p>
<p>I think we&#x27;ll need a generic solution which just looks at source markers to determine that certain cell offsets needs to be removed. I&#x27;m not exactly sure what this looks like.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dylwil3">@dylwil3</a> on 2024-12-03 04:52</div>
            <div class="timeline-body"><blockquote>
<p>The thing is we don&#x27;t really know the kind of edit when trying to update the cell offsets.</p>
</blockquote>
<p>Can you say a bit more about this? It doesn&#x27;t seem like the information of edit-kind is lost. If I understand correctly, the construction of the <code>SourceMap</code> maintains the invariant that there are an even number of markers. Each edit kind is recoverable by examining the pairs of markers: adjacent markers pointing to the same destination is a delation, adjacent markers pointing to different destinations is a replacement or insertion (the latter when the markers have the same source). Could we iterate through the cell offsets and determine whether they are between adjacent source markers, and, if so,  just not propagate them to the target?</p>
<p>Is there a use for <code>SourceMap</code> instances that don&#x27;t maintain this invariant of evenness?</p>
<p>Finally - it&#x27;s unclear to me how this relates to supporting other languages. Could you say more about that?</p>
<p>Apologies for my confusion!</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 18:49:00 UTC
    </footer>
</body>
</html>
