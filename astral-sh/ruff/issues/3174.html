<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>bug: UP007 should be reversed when targeting py37 - astral-sh/ruff #3174</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>bug: UP007 should be reversed when targeting py37</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/issues/3174">#3174</a>
        opened by <a href="https://github.com/upstartjohnvandivier">@upstartjohnvandivier</a>
        on 2023-02-23 16:29
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/upstartjohnvandivier">@upstartjohnvandivier</a> on 2023-02-23 16:29</div>
            <div class="timeline-body"><p>thanks for the library! we love it. found another issue tho, consider the class:</p>
<pre><code>class Foo(TypedDict):
    bar: NotRequired[Union[bool, None]]
</code></pre>
<p>ruff lint throws on the property and will autofix to use a pipe operator when <code>&quot;UP&quot;</code> ruleset is selected:</p>
<pre><code>    bar: NotRequired[bool | None]
</code></pre>
<p>this syntax is enabled only in <a href="https://peps.python.org/pep-0604/">python 3.10+</a> and breaks applications on an earlier version. in my case, I have <code>pyproject.toml</code> with the following subsnippet:</p>
<pre><code>[tool.ruff]
target-version = 'py37'
</code></pre>
<p>two interesting asides:</p>
<ol>
<li>I am running ruff cli inside a docker container that has python 3.10 installed. hopefully ruff is smart enough to use the pyproject.toml for reference and does try to detect via the current process version</li>
<li>i couldn't easily see documentation on how to dump or log the ruff config from inside the process, so I simply have to trust that pyproject.toml is respected and I can't really troubleshoot. I'll file a feature request to enhance <code>ruff -V</code> or some other mechanism</li>
</ol>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "UP007 should be reversed when targeting py37" to "bug: UP007 should be reversed when targeting py37" by @upstartjohnvandivier on 2023-02-23 16:29</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/upstartjohnvandivier">@upstartjohnvandivier</a> on 2023-02-23 16:43</div>
            <div class="timeline-body"><p>note: just to be a bit more clear about <code>reversed</code> instead of <code>ignored</code></p>
<p>if possible, i'm hoping <code>NotRequired[bool | None]</code> will actually be linted as an error under py37 target and with autofix the expression be refactored using the <code>Union</code> keyword</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-02-23 17:15</div>
            <div class="timeline-body"><p>That rule should only be triggered on Python 3.10+, unless you have future annotations enabled (i.e., the file contains <code>from __future__ import annotations</code>). Could it be that the configuration is off somehow? (Ruff only uses the <code>pyproject.toml</code> to determine the appropriate version, it doesn't look at your Python runtime or any other versions encoded in other files.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-02-23 17:15</div>
            <div class="timeline-body"><p>(We <em>don't</em> flag the reverse.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/henryiii">@henryiii</a> on 2023-02-23 17:28</div>
            <div class="timeline-body"><p>pyupgrade has a flag,<code>--keep-runtime-typing</code>, for this. Given you can deactivate individual rules, including on a per-file basis, and you can ignore rules on a line and in a file (none of which pyupgrade can do), and you probably shouldn't have <code>from __future__ import annotations</code> on a file where runtime annotations being used, I'm not sure this extra flag is all the important to support, though. In general, <code>from __future__ import annotations</code> means you aren't planning on using the type annotations at runtime, and trying to do so will break.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/upstartjohnvandivier">@upstartjohnvandivier</a> on 2023-02-23 17:30</div>
            <div class="timeline-body"><p>this totally could be a config issue in fact I suspect it I was simply not able to debug as I was unaware of <code>--show-settings</code> previously.</p>
<p>I now believe <code>__future__ import annotations</code> is applied to the file in question, so there is no bug here</p>
<p>feel free to close this as a bug or rename it to be a feature enhancement for reversal rather than a bug, issue solved from my POV!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-02-23 17:34</div>
            <div class="timeline-body"><p>I'm gonna close for now, thanks for filing :)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2023-02-23 17:34</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/cclauss">@cclauss</a> on 2023-02-24 16:00</div>
            <div class="timeline-body"><p>Does ruff have some kind of <em>immediate mode</em> for testing stuff like this on the command line?</p>
<p>In Python, we can use the REPL or do</p>
<pre><code>python3 -c &quot;print(2 + 2)&quot;
</code></pre>
<p>Could we pipe sample Python code into ruff like:</p>
<pre><code>echo &quot;from typing import Optional ; s: Optional[str] = None&quot; | ruff --select=UP --target-version=py37
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-02-24 16:04</div>
            <div class="timeline-body"><p>That should work today if you use a dash suffix, like:</p>
<pre><code class="language-console">‚ùØ echo &quot;from typing import Optional; s: Optional[str] = a&quot; | ruff --target-version=py311 --select UP -
-:1:33: UP007 [*] Use `X | Y` for type annotations
Found 1 error.
[*] 1 potentially fixable with the --fix option.
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/cclauss">@cclauss</a> on 2023-02-24 16:26</div>
            <div class="timeline-body"><p>% <code>echo &quot;from typing import Optional ; s: Optional[str] = 'a'&quot; | ruff --select=F401,Q000,UP --target-version=py311 --fix -</code></p>
<pre><code class="language-python">s: str | None = &quot;a&quot;
</code></pre>
<h3>Impressive!</h3>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/pmhahn">@pmhahn</a> on 2023-03-25 13:11</div>
            <div class="timeline-body"><p><code>UP007</code> should not be tied to <code>from __future__ import annotations</code>:</p>
<ul>
<li>The <code>X|Y</code> syntax requires the PEG-Parser from Python 3.9+, which is  <a href="https://peps.python.org/pep-0617/">PEP-617</a></li>
<li><code>annotations</code> is <a href="https://peps.python.org/pep-0563/">PEP-563</a> and about &quot;Postponed Evaluation of Annotations&quot;, which was even back-ported to Python 3.7</li>
</ul>
<p>So it makes send to do the <code>import</code> for Python 3.7 and 3.8, which still use the old parser and thus do not support the new syntax.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/cclauss">@cclauss</a> on 2023-03-25 13:18</div>
            <div class="timeline-body"><h3>The <code>X | Y</code> syntax requires Python 3.10+ (or the future import)</h3>
<p>Q: Is the conversion made even when <code>--target-version=py37</code> or <code>--target-version=py38</code>?</p>
<p>A: The conversion happens on <strong>Py10 and above</strong>:</p>
<p>% <code>echo &quot;from typing import Optional ; s: Optional[str] = 'a'&quot; | ruff --select=F401,Q000,UP --target-version=py39 --fix -</code></p>
<pre><code>from typing import Optional ; s: Optional[str] = &quot;a&quot;
</code></pre>
<p>% <code>echo &quot;from typing import Optional ; s: Optional[str] = 'a'&quot; | ruff --select=F401,Q000,UP --target-version=py310 --fix -</code></p>
<pre><code>s: str | None = &quot;a&quot;
</code></pre>
<hr />
<p>This GitHub Action passes on Python &gt;= v3.10 and fails on Python &lt;= v3.9.</p>
<pre><code class="language-yaml">name: type_hint_test
on: [push]
env:
  CODE: &quot;def func(x: str | None) -&gt; None: pass&quot;
jobs:
  type_hint_test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/setup-python@v4
        with:
          python-version: |
            3.7
            3.8
            3.9
            3.10
            3.11
      - run: python3.11 -c &quot;$CODE&quot;  # Pass
      - run: python3.10 -c &quot;$CODE&quot;  # Pass
      - run: python3.9  -c &quot;$CODE&quot;  # Fail
      - run: python3.8  -c &quot;$CODE&quot;  # Fail
      - run: python3.7  -c &quot;$CODE&quot;  # Fail
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/henryiii">@henryiii</a> on 2023-03-25 14:22</div>
            <div class="timeline-body"><p>That all looks fine - the conversion should happen if the python version (which defaults to the current version but is settable) is 3.10+, or when <code>from __future__ import annotations</code> is true. If you have a runtime use of annotations (pydantic, typer, cattrs, etc), then don't use <code>from __future__ import annotations</code>. For most code (and even most code inside a codebase with a little runtime usage), the future import allows much simpler, cleaner annotations - and typing annotations are something that really need as much cleanup as possible.</p>
<p>PyUpgrade itself does have a &quot;keep runtime annotations&quot; flag (one of <em>very</em> few configuration options!) that will ignore <code>from __future__ import annotations</code>, but you can't set it per-file and you really shouldn't be using that import if you are using your annotations at runtime anyway. So I've not really found it useful.</p>
<p>I would like it if there was more granularity in error codes, though - this one could possibly be split, and personally, I'd really like <code>I001</code> split up - my problem is I like the automatic injection of the future import, but sometimes I do need it disabled on a few files that use runtime annotations.</p>
<p>FYI, all parsers support <code>A | B</code> <strong>syntax</strong>. That's a very old bit of syntax. They don't support or'ing together types at <em>runtime</em> but that has nothing to do with the parser, only the evaluation. That's why <code>from __future__ import annotation</code> works. If they were to introduce new <em>syntax</em> around an annotation, one that doesn't parse today, it would not work with the import either.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/antdking">@antdking</a> on 2023-03-29 14:37</div>
            <div class="timeline-body"><p>currently setting up a repo, and encountered this behaviour.
I truly thought <code>target-version</code> wasn't being detected correctly.</p>
<p>Henryiii absolutely nailed it: There are more and more libraries relying on runtime annotations.
Gone are the times where we can rely on <code>__future__.annotations</code> for anything more than working around cyclic/hoisted references.</p>
<p>My 2-cents is <code>__future__</code> is ignored, <strong>without</strong> a flag to prevent unexpected broken code.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/henryiii">@henryiii</a> on 2023-03-29 15:03</div>
            <div class="timeline-body"><p>If you specifically are using a library that depends on runtime annotations, don't use <code>from __future__ import annotations</code>. That's basically a statement saying &quot;make all annotations strings, because I'm <em>not</em> going to use them at runtime, so I'll never need to resolve them&quot;. You absolutely can get broken runtime code without the simplification if you are using this import - that's why this &quot;future&quot; is currently not being added to Python in the future anymore.</p>
<p>Using it anyway (especially now as that looks like it's not the &quot;future&quot; of Python) and then asking a <em>very</em> useful simplification to be removed from all code that is using it correctly isn't a good idea.</p>
<p>Static typing code is hard. Anything simplifying it is highly appreciated.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 11:29:29 UTC
    </footer>
</body>
</html>
