<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ruff ignores requires-python field with `ruff.toml` in %userprofile% on Windows - astral-sh/ruff #19238</title>
    <link rel="stylesheet" href="../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../index.html">Back to index</a>
    </div>

    <h1>Ruff ignores requires-python field with `ruff.toml` in %userprofile% on Windows</h1>

    <div class="meta">
        <span class="state state-open">Open</span>
        <a href="https://github.com/astral-sh/ruff/issues/19238">#19238</a>
        opened by <a href="https://github.com/orishamir">@orishamir</a>
        on 2025-07-09 16:41
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/orishamir">@orishamir</a> on 2025-07-09 16:41</div>
            <div class="timeline-body"><h3>Summary</h3>
<p>Hey!
While working on a project on <strong>Windows</strong>, I have come across the following issue:
I have a Python project with e.g. requires-python field <code>&gt;=3.12</code> (<code>uv init --lib -p 3.12</code>)
Then, I have a <code>ruff.toml</code> inside %UserProfile% with only the following contents:</p>
<blockquote>
<p>C:\Users\user\ruff.toml</p>
</blockquote>
<pre><code class="language-toml">[lint]
select = [&quot;I&quot;]
# Notice target-version is not specified
</code></pre>
<p>Then, running <code>uvx ruff check --show-settings</code> gives:</p>
<pre><code class="language-toml">...
...
analyze.target_version = 3.9
...
</code></pre>
<p>Which is the default for Ruff.
The bug does not reproduce on Linux:</p>
<pre><code class="language-Dockerfile">FROM ghcr.io/astral-sh/uv:0.7.19-python3.12-bookworm-slim
WORKDIR /app

RUN uv init --lib -p 3.12

COPY &lt;&lt;EOF /root/.config/ruff/ruff.toml
[lint]
select = [
    &quot;I&quot;
]
EOF

CMD [&quot;/bin/bash&quot;, &quot;-c&quot;, &quot;uvx ruff check --show-settings | grep analyze.target_version&quot;]
# correctly outputs `analyze.target_version = 3.12`
</code></pre>
<p>And another note: when placing the <code>ruff.toml</code> inside the project directory, the detected Python version is correct</p>
<p>It seems this issue has been solved for linux in https://github.com/astral-sh/ruff/issues/16662
Indeed, adding an empty <code>[tool.ruff]</code> as suggested in https://github.com/astral-sh/ruff/issues/16662#issuecomment-2716487692 prompts Ruff to read the <code>requires-python</code> field</p>
<p>Thank you for the help, and thank you for the amazing work on Ruff and Ty!!</p>
<h3>Version</h3>
<p>ruff 0.12.2</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntBre">@ntBre</a> on 2025-07-09 19:09</div>
            <div class="timeline-body"><p>Thanks for the report and for the kind words!</p>
<p>I'm not that familiar with config directories on Windows, but based on our <a href="https://docs.astral.sh/ruff/configuration/#config-file-discovery">docs</a>, we should be using <a href="https://docs.rs/etcetera/latest/etcetera/#native-strategy"><code>etcetera</code>'s native strategy</a> for config file discovery, which I think should correspond to <code>%userprofile%\AppData\Roaming\ruff</code>, if I'm following the <code>etcetera</code> <a href="https://docs.rs/etcetera/latest/etcetera/base_strategy/struct.Windows.html">examples</a> and the docs on <a href="https://docs.rs/home/latest/home/fn.home_dir.html"><code>home_dir</code></a> correctly. I think this also corresponds to the <code>%APPDATA%</code> environment variable.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">question</span> added by @ntBre on 2025-07-09 19:09</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/orishamir">@orishamir</a> on 2025-07-09 19:56</div>
            <div class="timeline-body"><p>@ntBre
hmmm. Indeed, when I place <code>ruff.toml</code> in <code>%userprofile%\AppData\Roaming\ruff</code>, the config file is respected, and specifically the requires-python field gets correctly identified. But when I place it in <code>%userprofile%</code>, still the <code>ruff.toml</code> gets respected (in terms of <code>[lint].select</code> for example), but not the requires-python field. So it's weird, if I put <code>ruff.toml</code> in <code>%userprofile%</code>, then only part of it is respected?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntBre">@ntBre</a> on 2025-07-09 20:21</div>
            <div class="timeline-body"><p>Sorry, I focused on the wrong part of the report! I think I have an idea of what's going on, but maybe @dylwil3 can confirm. Is your project in a subdirectory of <code>%userprofile%</code>? I can reproduce this on Linux with the following example:</p>
<pre><code class="language-shell">$ echo 'lint.select = [&quot;I&quot;]' &gt; ruff.toml
$ uv init example
Initialized project `example` at `/home/clod/example`
$ cd example
$ ruff check -v --show-settings | grep analyze.target_version
[2025-07-09][20:13:42][ruff::resolve][DEBUG] Using configuration file (via parent) at: /home/clod/ruff.toml
[2025-07-09][20:13:42][ruff_workspace::pyproject][DEBUG] No `target-version` found in `ruff.toml`
[2025-07-09][20:13:42][ruff_workspace::pyproject][DEBUG] No `pyproject.toml` with `requires-python` in same directory; `target-version` unspecified
[2025-07-09][20:13:42][ignore::gitignore][DEBUG] opened gitignore file: /home/clod/example/.gitignore
[2025-07-09][20:13:42][ignore::gitignore][DEBUG] opened gitignore file: /home/clod/example/.git/info/exclude
[2025-07-09][20:13:42][ruff_workspace::resolver][DEBUG] Included path via `include`: &quot;/home/clod/example/main.py&quot;
[2025-07-09][20:13:42][ruff_workspace::resolver][DEBUG] Ignored path via `exclude`: &quot;/home/clod/example/.git&quot;
[2025-07-09][20:13:42][ruff_workspace::resolver][DEBUG] Included path via `include`: &quot;/home/clod/example/pyproject.toml&quot;
analyze.target_version = 3.9
</code></pre>
<p>I think we will check for config files in the parent of the current directory, and that is overriding the <code>pyproject.toml</code> file. Your real config dir in <code>AppData</code> is treated differently.</p>
<p>That feels like kind of surprising behavior to me, but Dylan will know a lot more about that than I do.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dylwil3">@dylwil3</a> on 2025-07-09 21:06</div>
            <div class="timeline-body"><p>Yes I think there is an implicit assumption that the user config is not in the same hierarchy as your local project. I'm not sure of a way around this, or what a more ideal behavior might be given that Ruff supports hierachical/cascading configurations?</p>
<p>I'm not able to try to reproduce this right now, but if either of you have a moment could you see whether the target version is resolved as expected for the files <em>inside</em> the project?</p>
<p>Like, in the setup above, I'd be curious to know the result of</p>
<pre><code>ruff check -v --show-settings main.py | grep version
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntBre">@ntBre</a> on 2025-07-09 22:29</div>
            <div class="timeline-body"><pre><code>$ ruff check -v --show-settings main.py | grep version
[2025-07-09][22:11:27][ruff::resolve][DEBUG] Using configuration file (via parent) at: /home/clod/ruff.toml
[2025-07-09][22:11:27][ruff_workspace::pyproject][DEBUG] No `target-version` found in `ruff.toml`
[2025-07-09][22:11:27][ruff_workspace::pyproject][DEBUG] No `pyproject.toml` with `requires-python` in same directory; `target-version` unspecified
linter.unresolved_target_version = none
linter.per_file_target_version = {}
formatter.unresolved_target_version = 3.9
formatter.per_file_target_version = {}
analyze.target_version = 3.9
</code></pre>
<p>It did feel a bit surprising to ignore the <code>requires-python</code> in the <code>pyproject.toml</code> in the current directory, but that's consistent with our very first rule of config file discovery:</p>
<blockquote>
<ol>
<li>In locating the &quot;closest&quot; pyproject.toml file for a given path, Ruff ignores any pyproject.toml files that lack a [tool.ruff] section.</li>
</ol>
</blockquote>
<p>So I think everything is working as expected, and the two fixes mentioned earlier in the thread are still recommended:</p>
<ul>
<li>Add an empty <code>[tool.ruff]</code> section to <code>pyproject.toml</code> so it's not skipped</li>
<li>Or move <code>ruff.toml</code> to the expected global config directory where it's not a parent of the project</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/orishamir">@orishamir</a> on 2025-07-13 21:29</div>
            <div class="timeline-body"><p>Perhaps I can add to the documentation a more explicit note about where Linux/Windows configuration files should be located? In uv docs, it's said very explicitly</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntBre">@ntBre</a> on 2025-07-14 01:48</div>
            <div class="timeline-body"><p>That sounds good to me! I do find it confusing having to follow the link to etcetera and read the crate docs to figure out where config files go. One sentence with actual paths could really help.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/orishamir">@orishamir</a> on 2025-07-14 20:45</div>
            <div class="timeline-body"><p>Great! I will put up a PR soon :)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/orishamir">@orishamir</a> on 2025-07-15 18:34</div>
            <div class="timeline-body"><p>Hey @ntBre ,
It may be best for someone more familiar with Ruff to make that PR, as I'm afraid of misleading someone<br />
Also I'm not a native English speaker so the PR's review will probably reword my phrasing anyway</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntBre">@ntBre</a> on 2025-07-15 18:47</div>
            <div class="timeline-body"><p>Okay, no problem :) Thank you for looking into it and reporting the issue! If you change your mind, I'm happy to review and help with phrasing or ideas.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">question</span> removed by @ntBre on 2025-07-15 18:48</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">documentation</span> added by @ntBre on 2025-07-15 18:48</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/19646.html">astral-sh/ruff#19646</a> on 2025-07-30 19:34</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:28:16 UTC
    </footer>
</body>
</html>
