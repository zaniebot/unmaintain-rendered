<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RUF012 does not catch mutable default in dataclass - astral-sh/ruff #13137</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>RUF012 does not catch mutable default in dataclass</h1>

    <div class="meta">
        <span class="state state-open">Open</span>
        <a href="https://github.com/astral-sh/ruff/issues/13137">#13137</a>
        opened by <a href="https://github.com/msehnout">@msehnout</a>
        on 2024-08-28 10:52
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/msehnout">@msehnout</a> on 2024-08-28 10:52</div>
            <div class="timeline-body"><p>Hello,</p>
<p>I stumbled upon this bug in my code which I thought ruff should catch:</p>
<pre><code class="language-python">from dataclasses import dataclass


class Foo:
    def __init__(self) -&gt; None:
        self.counter: int = 0


@dataclass
class Bar:
    foo: Foo = Foo()


bar1 = Bar()
bar2 = Bar()
bar1.foo.counter = 1

print(bar1.foo.counter)
print(bar2.foo.counter)
</code></pre>
<p>It is fairly typical example of the https://docs.astral.sh/ruff/rules/mutable-class-default/ bug. Once I found the root cause, it was obvious how to fix it, but I expected <code>ruff</code> to tell me.</p>
<p>Result:</p>
<pre><code>$ ruff check main.py 
All checks passed!
$ ruff version
ruff 0.6.2
$ python3 main.py
1
1
</code></pre>
<p>Would it be possible to handle this case?</p>
<p>Thanks for your response and for creating <code>ruff</code>, it is awesome!
Martin</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-08-28 12:06</div>
            <div class="timeline-body"><p>I think it's hard to do much better here without more sophisticated type inference (which is a long-term goal, but which is unlikely to happen for a while).</p>
<p>RUF012 decides whether a class assignment could have a mutable default <a href="https://github.com/astral-sh/ruff/blob/cfafaa7637ef3f568d62d39654e0498f52a07b77/crates/ruff_linter/src/rules/ruff/rules/mutable_class_default.rs#L56-L93">here</a>. For call expressions (like <code>Foo()</code>), it defers to this function <a href="https://github.com/astral-sh/ruff/blob/cfafaa7637ef3f568d62d39654e0498f52a07b77/crates/ruff_python_semantic/src/analyze/typing.rs#L291-L297">here</a> to decide whether the result of the call expression might be a mutable object -- and that function uses <a href="https://github.com/astral-sh/ruff/blob/cfafaa7637ef3f568d62d39654e0498f52a07b77/crates/ruff_python_stdlib/src/typing.rs#L284-L295">this function</a> to compare the qualified name of the call expression against a list of Python functions that are known to create mutable objects when they're called.</p>
<p>With generalised type inference capabilities, we'd be able to do a much better job here -- we could lookup the class <code>Foo</code>, and analyse the class to see if it has any mutable attributes; if so, we'd know that <code>Foo()</code> creates a mutable object. We could <em>potentially</em> do this now for classes that are located in the same file, but I think it would add a <em>lot</em> of complexity, and we wouldn't be able to follow imports to other files. Without doing that kind of complicated analysis, it's hard for me to see how we could otherwise catch this without introducing lots of false-positive errors.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">type-inference</span> added by @AlexWaygood on 2024-08-28 12:06</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/msehnout">@msehnout</a> on 2024-08-28 13:05</div>
            <div class="timeline-body"><p>Ok :-) I was afraid that this would be the answer, but it makes sense that deciding whether a class is mutable or not is a difficult question in Python.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/beauxq">@beauxq</a> on 2025-01-10 15:28</div>
            <div class="timeline-body"><p>For function parameter defaults, B008 would catch this.
Couldn't that same logic be used to catch this?</p>
<p>I think it would be good for class member defaults to follow the same rules as function parameter defaults. Otherwise, it seems like an inconsistency.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/5243.html">astral-sh/ruff#5243</a> on 2025-01-10 16:11</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/16174.html">astral-sh/ruff#16174</a> on 2025-02-15 03:11</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:34:53 UTC
    </footer>
</body>
</html>
