<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>B018: false positive - astral-sh/ruff #5006</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>B018: false positive</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/issues/5006">#5006</a>
        opened by <a href="https://github.com/spaceone">@spaceone</a>
        on 2023-06-10 13:27
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/spaceone">@spaceone</a></div>
            <div class="timeline-body"><pre><code>try:
    unicode
except NameError:
    unicode = str
</code></pre>
<p>is not a useless expression <code>B018 Found useless expression. Either assign it to a variable or remove it.</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2023-06-10 14:38</div>
            <div class="timeline-body"><p>Hmm, interesting usage. So, it&#x27;s checking if there&#x27;s a <code>unicode</code> name in the scope and assigning <code>str</code> to it if there&#x27;s none. Until we find a solution for this, you could use the <code>globals()</code> dictionary:</p>
<pre><code>unicode = globals().get(&#x27;unicode&#x27;, str)
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2023-06-10 14:38</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">question</span> added by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-06-10 14:41</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-06-10 14:42</div>
            <div class="timeline-body"><p>I think the most we would do here is tailor the rule message to this specific case (e.g., suggest an alternative pattern when scoped with a <code>NameError</code> handler). Can you share a realistic example where this code is necessary, and can&#x27;t be refactored to something that doesn&#x27;t rely on an unbound name?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/spaceone">@spaceone</a> on 2023-06-10 14:49</div>
            <div class="timeline-body"><p>the above code is the real code we are using to support Python2.
other examples in our code:</p>
<pre><code>        with self.assertRaises(AttributeError):
            obj.props.unknown  # noqa: B018

        with pytest.raises(AttributeError):
            obj.props.unknown  # noqa: B018

   def validate(self, value):
        # type: (str) -&gt; object
        o = urlsplit(value)
        o.port  # may raise ValueError  # noqa: B018
        return o.scheme in {&quot;http&quot;, &quot;https&quot;}
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2023-06-10 14:57</div>
            <div class="timeline-body"><p>Related: <a href="https://github.com/astral-sh/ruff/issues/3831">astral-sh/ruff#3831</a></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-06-10 14:58</div>
            <div class="timeline-body"><p>My recommendation is still to use <code>_ = obj.props.unknown</code> to indicate that the useless expression is intentional.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-06-10 15:20</div>
            <div class="timeline-body"><p>If it&#x27;s explicitly to support Python 2, can you not use a <code>sys.version_info</code> check instead of using the error-based control flow?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-06-12 15:27</div>
            <div class="timeline-body"><p>I&#x27;m comfortable with the behavior we have for the originating example. Whether we want to special-case attribute accesses in some way will be resolved via <a href="https://github.com/astral-sh/ruff/issues/3831">astral-sh/ruff#3831</a>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-06-12 15:27</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/DanielNoord">@DanielNoord</a> on 2023-10-18 14:32</div>
            <div class="timeline-body"><p>@charliermarsh We have code at work that looks like this:</p>
<pre><code>A: list


def func():
    global A
    try:
        A
    except NameError:
        print(&quot;Help&quot;)
        A = []


func()
func()
</code></pre>
<p>We use the global in jobs to append to a global list, but we are never sure which worker (which execute the jobs) will start up first and therefore which worker will call the setup function <code>func()</code>.
Would you reconsider excluding raising this message if it is specifically guarded by a <code>NameError</code>? Doesn&#x27;t that explicit guard show that the writer is aware of the chance of an exception being raised and thus no bug is introduced?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-10-18 14:45</div>
            <div class="timeline-body"><p>@DanielNoord - I think the main question for me is whether there&#x27;s a way to (reasonably) restructure the code to avoid the &quot;useless expression&quot;. For example, would something like this work?</p>
<pre><code>A: list

def func():
    global A
    if &#x27;A&#x27; not in globals():
        print(&quot;Help&quot;)
        A = []

func()
func()
</code></pre>
<p>(I know this is a greatly simplified example -- I&#x27;m mostly trying to decide if we need to support this pattern, or if we can instead suggest a reasonable alternative.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/DanielNoord">@DanielNoord</a> on 2023-10-18 14:52</div>
            <div class="timeline-body"><blockquote>
<p>@DanielNoord - I think the main question for me is whether there&#x27;s a way to (reasonably) restructure the code to avoid the &quot;useless expression&quot;. For example, would something like this work?</p>
</blockquote>
<p>I can see how another lint would be to never use <code>globals()</code> or <code>global</code> for that matter. I think the pattern is quite bad anyway :smile: But having that global available is quite helpful as well and I think sometimes a little ugly code for a lot of usability doesn&#x27;t hurt.</p>
<p>Personally I think the <code>try ... except</code> shows in a very concise and explicit way that you know you&#x27;re introducing a possibility for <code>NameError</code> but are also handling it. Thus, it doesn&#x27;t hurt maintainability of the code too much and (as far as I can see) doesn&#x27;t introduce an actual bug into your code. I can add a <code># noqa: B018</code> but I believe that introduces more uncertainty for the reader as they now need to lookup what B018 is.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/DanielNoord">@DanielNoord</a> on 2023-11-13 08:27</div>
            <div class="timeline-body"><p>@charliermarsh Sorry for tagging again, but have you given this a thought? And if so, what is your verdict about re-opening this issue?</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 18:48:37 UTC
    </footer>
</body>
</html>
