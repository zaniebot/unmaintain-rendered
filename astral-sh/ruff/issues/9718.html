<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Broken pipe when configuration file fails to parse - astral-sh/ruff #9718</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Broken pipe when configuration file fails to parse</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/issues/9718">#9718</a>
        opened by <a href="https://github.com/kaste">@kaste</a>
        on 2024-01-30 20:04
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/kaste">@kaste</a></div>
            <div class="timeline-body"><p>Test scenario:</p>
<p>I have an error in my ruff.toml</p>
<pre><code>select = [&quot;F&quot;, &quot;E&quot;, &quot;W&quot;, &quot;B&quot;, &quot;ERA&quot;, &quot;I001&quot;]
line-length = 100

[lint.isort]
line-length = 90
</code></pre>
<p>and then I do on Windows CMD</p>
<pre><code>type plugin.py | ruff check --no-cache -
</code></pre>
<p>which outputs</p>
<pre><code>&gt; type plugin.py | ruff check --no-cache -
ruff failed
  Cause: Failed to parse C:\Users\c-flo\AppData\Roaming\Sublime Text\Packages\TreeSitter-navigate-around\ruff.toml
  Cause: TOML parse error at line 1, column 1
  |
1 | select = [&quot;F&quot;, &quot;E&quot;, &quot;W&quot;, &quot;B&quot;, &quot;ERA&quot;, &quot;I001&quot;]
  | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
unknown field `line-length`, expected one of `force-wrap-aliases`, `force-single-line`, `single-line-exclusions`, `combine-as-imports`, `split-on-trailing-comma`, `order-by-type`, `force-sort-within-sections`, `case-sensitive`, `force-to-top`, `known-first-party`, `known-third-party`, `known-local-folder`, `extra-standard-library`, `relative-imports-order`, `required-imports`, `classes`, `constants`, `variables`, `no-lines-before`, `lines-after-imports`, `lines-between-types`, `forced-separate`, `section-order`, `no-sections`, `detect-same-package`, `from-first`, `length-sort`, `length-sort-straight`, `sections`

Ein Prozess hat versucht, zu einer nicht bestehenden Pipe zu schreiben.
</code></pre>
<p>Note the last line which tells you (in german) that the process tried to write to a closed pipe.</p>
<p>This is a reduced testcase of course.  I call this within an IDE (Sublime Text, I&#x27;m the author of the linting framework SublimeLinter over there) basically like so</p>
<pre><code>            try:
                out = proc.communicate(code_b)

            except BrokenPipeError as err:
                print(&quot;BrokenPipeError&quot;, err)
</code></pre>
<p>which prints</p>
<pre><code>BrokenPipeError [Errno 32] Broken pipe
</code></pre>
<p>At this point stdout and stderr are closed so I don&#x27;t get the actual error message/printing you do on the CLI.  It just aborts here and I can only present the generic &quot;Broken pipe&quot; error.</p>
<p>Hope this helps.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/kaste">@kaste</a> on 2024-01-30 20:06</div>
            <div class="timeline-body"><p>(Also the actual error message is not very indicative as it points to the first line of the conf file which is not the problem, but that&#x27;s another story)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-01-30 20:40</div>
            <div class="timeline-body"><p>Hm I&#x27;m not sure what&#x27;s up with that error message pointing to the wrong line, we can consider that separately.</p>
<p>Here, I presume the broken pipe error is probably coming from the process that is piping content <em>to</em> Ruff, not from Ruff itself. I cannot reproduce this with <code>head</code></p>
<p>e.g.</p>
<pre><code>#!/usr/bin/env bash

set -o pipefail

head -c 10M &lt; /dev/urandom | ruff check --no-cache -
echo &quot;Finished with exit code $?&quot;
</code></pre>
<pre><code>‚ùØ bash example.sh
ruff failed
  Cause: Failed to parse /Users/mz/eng/src/astral-sh/ruff/pyproject.toml
  Cause: TOML parse error at line 59, column 1
   |
59 | [tool.ruff]
   | ^^^^^^^^^^^
unknown field `err`

Finished with exit code 2
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-01-30 20:43</div>
            <div class="timeline-body"><p>Hm I also cannot reproduce this in Python</p>
<pre><code>import subprocess

stdin = b&quot;x&quot; * 1000000

process = subprocess.Popen([&quot;ruff&quot;, &quot;check&quot;, &quot;--no-cache&quot;, &quot;-&quot;], stdin=subprocess.PIPE, stdout=subprocess.PIPE, stderr=subprocess.PIPE)

try:
    out = process.communicate(stdin)
except BrokenPipeError as err:
    print(err)
else:
    print(out)

process.wait()
</code></pre>
<pre><code>‚ùØ python example.py
(b&#x27;&#x27;, b&#x27;ruff failed\n  Cause: Failed to parse /Users/mz/eng/src/astral-sh/ruff/pyproject.toml\n  Cause: TOML parse error at line 59, column 1\n   |\n59 | [tool.ruff]\n   | ^^^^^^^^^^^\nunknown field `err`\n\n&#x27;)
</code></pre>
<p>Do you have a reproducible example?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/kaste">@kaste</a> on 2024-01-30 22:02</div>
            <div class="timeline-body"><p>That&#x27;s indeed surprisingly random.  It seems to depend on the contents of the linted file.  I&#x27;ve set up https://github.com/kaste/ruff-repro  Note that plugin.py results in a Broken Pipe and the very similar plugin_2.py not.  I tried deleting more random lines, the file contents are already fantasy code though without syntax errors, but cannot deduce any pattern here.  Maybe you can reproduce with these files, note however that I&#x27;m on Windows.</p>
<pre><code>&gt; ruff --version
ruff 0.1.15
</code></pre>
<blockquote>
<p>I presume the broken pipe error is probably coming from the process that is piping content to Ruff</p>
</blockquote>
<p>I reproduce this on the windows command line but <em>also</em> within Sublime Text editor.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/kaste">@kaste</a> on 2024-01-30 22:22</div>
            <div class="timeline-body"><p>Stupid me, if the file is larger than 4096 it fails.  The standard buffer size on Windows.  üôÑ</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/kaste">@kaste</a> on 2024-02-01 10:00</div>
            <div class="timeline-body"><p>I see that you both starred üëÄ at my previous message but that&#x27;s ambiguous.  Do you have an understanding of the bug?  I could then delete the &quot;repro-repo&quot; as it should be clear how to reproduce this.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-02-08 03:47</div>
            <div class="timeline-body"><p>Could you please provide a reproduction? It&#x27;s still not clear to me that the broken pipe error is being thrown by Ruff. Generally what happens with broken pipes is</p>
<ol>
<li>Some process is sending data into a pipe</li>
<li>Another process (Ruff in this case) is reading data from the pipe</li>
<li>The later process encounters an error (invalid configuration in this case) and exits</li>
<li>The first process continues sending data to the pipe but the second process has stopped reading it or closed it</li>
<li>The pipe is full or closed and is &quot;broken&quot;</li>
<li>The first process throws an error</li>
</ol>
<p>I think it is best practice (and I believe this is commonly implemented) for the first process to <em>not</em> throw the broken pipe error. I don&#x27;t think Ruff can do anything if the scenario is as-described above.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/kaste">@kaste</a> on 2024-02-08 08:47</div>
            <div class="timeline-body"><blockquote>
<p>Could you please provide a reproduction?</p>
</blockquote>
<p>But I have the reproduction, you just tried on the wrong system and it is not clear that you now tried it on Windows.  So the file that causes the error is &quot;plugin.py&quot; from the repo I posted.  But that is not important as the file just needs to be larger than 4096, which happens to be the buffer size on Windows.</p>
<p>With this file I do</p>
<pre><code>&gt; type plugin.py | ruff
</code></pre>
<p>and get a broken pipe error on Windows, in german that reads &quot;Ein Prozess hat versucht, zu einer nicht bestehenden Pipe zu schreiben.&quot; on the command line.  (That&#x27;s the standard cmd shell, I can try power shell later.)</p>
<p>and I do</p>
<pre><code>$ cat plugin.py | ruff
</code></pre>
<p>in bash and everything works as expected.  (Although I just used the subsystem within Windows for the test.  We don&#x27;t expect it to break here so that should be enough.)</p>
<p>So that&#x27;s the reproduction I think.  I also explained it from a different perspective as I&#x27;m the author of the linting framework for the SublimeText editor.  There we have dozens of linters that accept the input from stdin and of course they also throw and fail from time to time but don&#x27;t &quot;break the pipe&quot;.  (E.g. you can do <code>type plugin.py | eslint --stdin</code>, say with a broken eslint configuration, and you will not see &quot;Ein Prozess hat versucht, zu einer nicht bestehenden Pipe zu schreiben.&quot; on the command line and SublimeText can show the complete stderr to the end-user if that matters.)  That&#x27;s the <em>common behavior</em> I think.  I don&#x27;t think and remember that there is a common <em>implementation</em> as you suggest as that&#x27;s a low-level system thing.</p>
<p>AFAIR I had to solve and tackle this problem years ago as the number 4096 immediately shrugged me but I forgot and don&#x27;t have a deeper knowledge of Windows right now.</p>
<p>TL;DR  Have you tried on <em>Windows</em>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/kaste">@kaste</a> on 2024-02-08 17:26</div>
            <div class="timeline-body"><p>That&#x27;s a shitty issue here I made.  It is easily resproducable by me but only when
I&#x27;m using zombie tools.  Perhaps that&#x27;s because I&#x27;m old too.   ü§∑</p>
<p><code>cmd.exe</code> + <code>type</code> is of course a real thing in Windows but an ancient one.  Power
shell&#x27;s <code>Get-content</code> behaves well; and recent versions of python too. To compare
it with <code>eslint</code> is just silly because that&#x27;s just too slow for any race condition
to appear.</p>
<p>I now backported a sane <code>Popen._communicate</code> for my (also ancient) linting framework.
That&#x27;s 20 lines of code.</p>
<p>I really was mislead because <code>type &lt;file&gt; | ruff</code> was the easy reproduction.<br>
Actually a combination I never use in practice but only to reproduce or show something.
And it <em>was</em> a python bug, just fixed June 2016 üòÅ.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-02-08 17:33</div>
            <div class="timeline-body"><p>Sorry I didn&#x27;t try on Windows I don&#x27;t have easy access to a machine üò¨</p>
<p>I recently ran into a similar problem piping <code>git</code> output into <code>ripgrep</code> where the broken pipe error was coming from <code>git</code> so I had a hunch this was a problem outside of Ruff. Thanks for taking the time to investigate it ‚Äî I really appreciate it! I&#x27;m glad it&#x27;s working for you now :)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/zanieb">@zanieb</a> on 2024-02-08 17:33</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 18:48:49 UTC
    </footer>
</body>
</html>
