<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Infinite loop in import sorting for long variable names with force-single-line (ruff &gt;= 0.0.256) - astral-sh/ruff #4062</title>
    <link rel="stylesheet" href="../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../index.html">Back to index</a>
    </div>

    <h1>Infinite loop in import sorting for long variable names with force-single-line (ruff &gt;= 0.0.256)</h1>

    <div class="meta">
        <span class="state state-closed">Closed</span>
        <a href="https://github.com/astral-sh/ruff/issues/4062">#4062</a>
        opened by <a href="https://github.com/pstjohn">@pstjohn</a>
        on 2023-04-21 20:15
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/pstjohn">@pstjohn</a> on 2023-04-21 20:15</div>
            <div class="timeline-body"><p>The following code snippet causes <code>ruff</code> to hang for ruff &gt;= 0.0.256.</p>
<p>pyproject.toml</p>
<pre><code class="language-toml">[tool.ruff]
select = [&quot;I&quot;]
fix = true
line-length = 88

[tool.ruff.isort]
force-single-line = true
</code></pre>
<p>test.py</p>
<pre><code class="language-python">from mypackage.subpackage2 import (  # long comment that seems to be a problem
    a_long_variable_name_that_causes_problems,
    item2,
)
</code></pre>
<p>Doing some bisection, it works in 0.0.255 and hangs in 0.0.256 onwards.
Probably related to #3530? But it happens regardless of the <code>combine-as-imports</code> setting</p>
<p>In the newer versions, it seems to get stuck in an infinite loop</p>
<pre><code>[2023-04-21][20:08:42][ruff_cli::commands::run][DEBUG] Identified files to lint in: 521.625µs
[2023-04-21][20:08:42][ruff_cli::diagnostics][DEBUG] Checking: /Users/pstjohn/Misc/ruff_issue/test.py
[2023-04-21][20:08:42][ruff::rules::isort::categorize][DEBUG] Categorized 'mypackage' as ThirdParty (NoMatch)
[2023-04-21][20:08:42][ruff::rules::isort::categorize][DEBUG] Categorized 'mypackage' as ThirdParty (NoMatch)
[2023-04-21][20:08:42][ruff::rules::isort::categorize][DEBUG] Categorized 'mypackage' as ThirdParty (NoMatch)
[2023-04-21][20:08:42][ruff::rules::isort::categorize][DEBUG] Categorized 'mypackage' as ThirdParty (NoMatch)
[2023-04-21][20:08:42][ruff::rules::isort::categorize][DEBUG] Categorized 'mypackage' as ThirdParty (NoMatch)
[2023-04-21][20:08:42][ruff::rules::isort::categorize][DEBUG] Categorized 'mypackage' as ThirdParty (NoMatch)
[2023-04-21][20:08:42][ruff::rules::isort::categorize][DEBUG] Categorized 'mypackage' as ThirdParty (NoMatch)
[2023-04-21][20:08:42][ruff::rules::isort::categorize][DEBUG] Categorized 'mypackage' as ThirdParty (NoMatch)
[2023-04-21][20:08:42][ruff::rules::isort::categorize][DEBUG] Categorized 'mypackage' as ThirdParty (NoMatch)
[2023-04-21][20:08:42][ruff::rules::isort::categorize][DEBUG] Categorized 'mypackage' as ThirdParty (NoMatch)
[2023-04-21][20:08:42][ruff::rules::isort::categorize][DEBUG] Categorized 'mypackage' as ThirdParty (NoMatch)
[2023-04-21][20:08:42][ruff::rules::isort::categorize][DEBUG] Categorized 'mypackage' as ThirdParty (NoMatch)
[2023-04-21][20:08:42][ruff::rules::isort::categorize][DEBUG] Categorized 'mypackage' as ThirdParty (NoMatch)
[2023-04-21][20:08:42][ruff::rules::isort::categorize][DEBUG] Categorized 'mypackage' as ThirdParty (NoMatch)
[2023-04-21][20:08:42][ruff::rules::isort::categorize][DEBUG] Categorized 'mypackage' as ThirdParty (NoMatch)
[2023-04-21][20:08:42][ruff::rules::isort::categorize][DEBUG] Categorized 'mypackage' as ThirdParty (NoMatch)
</code></pre>
<p>The older versions run through twice</p>
<pre><code>[2023-04-21][20:15:05][ruff_cli::commands::run][DEBUG] Identified files to lint in: 381.25µs
[2023-04-21][20:15:05][ruff::rules::isort::categorize][DEBUG] Categorized 'mypackage' as ThirdParty (NoMatch)
[2023-04-21][20:15:05][ruff::rules::isort::categorize][DEBUG] Categorized 'mypackage' as ThirdParty (NoMatch)
[2023-04-21][20:15:05][ruff_cli::commands::run][DEBUG] Checked 1 files in: 1.910292ms
Found 1 error (1 fixed, 0 remaining).
</code></pre>
<p>resulting in this formatted import</p>
<pre><code class="language-python">from mypackage.subpackage2 import (  # long comment that seems to be a problem
    a_long_variable_name_that_causes_problems,
)
from mypackage.subpackage2 import item2
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "Ruff hangs when sorting imports with long variable names / comments" to "Infinite loop in for long variable names with force-single-line in ruff >= 0.0.256" by @pstjohn on 2023-04-22 02:19</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "Infinite loop in for long variable names with force-single-line in ruff >= 0.0.256" to "Infinite loop in import sorting for long variable names with force-single-line in ruff >= 0.0.256" by @pstjohn on 2023-04-22 02:19</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "Infinite loop in import sorting for long variable names with force-single-line in ruff >= 0.0.256" to "Infinite loop in import sorting for long variable names with force-single-line (ruff >= 0.0.256)" by @pstjohn on 2023-04-22 02:19</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @charliermarsh on 2023-04-22 05:48</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">isort</span> added by @charliermarsh on 2023-04-22 05:48</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @charliermarsh by @charliermarsh on 2023-04-23 05:14</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-04-23 05:15</div>
            <div class="timeline-body"><p>Thanks for the clear issue, taking a look :)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-04-23 05:46</div>
            <div class="timeline-body"><p>I've identified the issue (introduced in https://github.com/charliermarsh/ruff/pull/3521), which is that we're duplicating the comment with an exponential blowup. Figuring out a proper fix, if I can't fix it properly I'll revert that change prior to the next release.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/pstjohn">@pstjohn</a> on 2023-04-23 20:01</div>
            <div class="timeline-body"><p>You're welcome, thanks for the quick reply (and great package)!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/4074.html">astral-sh/ruff#4074</a> on 2023-04-24 04:20</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2023-04-24 04:39</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:28:08 UTC
    </footer>
</body>
</html>
