<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rule D102 cause panic - astral-sh/ruff #11922</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Rule D102 cause panic</h1>

    <div class="meta">
        <span class="state state-closed">Closed</span>
        <a href="https://github.com/astral-sh/ruff/issues/11922">#11922</a>
        opened by <a href="https://github.com/qarmin">@qarmin</a>
        on 2024-06-18 10:35
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/qarmin">@qarmin</a> on 2024-06-18 10:35</div>
            <div class="timeline-body"><p>ruff 0.4.9+14 (8499abfa7 2024-06-17) (latest changes from main branch)</p>
<pre><code>ruff  *.py --select D102 --no-cache --fix --unsafe-fixes --preview --output-format concise --isolated
</code></pre>
<p>file content:</p>
<pre><code>_AVAILABLE_COMMANDS_STR = &quot;&quot;&quot;\
ping                test the connection with the remote server&quot;&quot;&quot;
USAGE = f&quot;&quot;&quot;\
{_AVAILABLE_COMMANDS_STR&quot;&quot;&quot;
        return f&quot;&quot;&quot;\
Multiple commands can be given in a single line, either from the shell or from command line, \
{_AVAILABLE_COMMANDS_STR}&quot;&quot;&quot;
</code></pre>
<p>error</p>
<pre><code>All checks passed!

error: Panicked while linting /opt/tmp_folder/6086508128891050848.py: This indicates a bug in Ruff. If you could open an issue at:

    https://github.com/astral-sh/ruff/issues/new?title=%5BLinter%20panic%5D

...with the relevant file contents, the `pyproject.toml` settings, and the following stack trace, we'd be very appreciative!

panicked at /home/runner/work/Automated-Fuzzer/Automated-Fuzzer/ruff/crates/ruff_text_size/src/range.rs:48:9:
assertion failed: start.raw &lt;= end.raw
Backtrace:    0: ruff::panic::catch_unwind::{{closure}}
             at ./ruff/crates/ruff/src/panic.rs:31:25
   1: &lt;alloc::boxed::Box&lt;F,A&gt; as core::ops::function::Fn&lt;Args&gt;&gt;::call
             at /rustc/9b00956e56009bab2aa15d7bff10916599e3d6d6/library/alloc/src/boxed.rs:2034:9
   2: std::panicking::rust_panic_with_hook
             at /rustc/9b00956e56009bab2aa15d7bff10916599e3d6d6/library/std/src/panicking.rs:783:13
   3: std::panicking::begin_panic_handler::{{closure}}
             at /rustc/9b00956e56009bab2aa15d7bff10916599e3d6d6/library/std/src/panicking.rs:649:13
   4: std::sys_common::backtrace::__rust_end_short_backtrace
             at /rustc/9b00956e56009bab2aa15d7bff10916599e3d6d6/library/std/src/sys_common/backtrace.rs:171:18
   5: rust_begin_unwind
             at /rustc/9b00956e56009bab2aa15d7bff10916599e3d6d6/library/std/src/panicking.rs:645:5
   6: core::panicking::panic_fmt
             at /rustc/9b00956e56009bab2aa15d7bff10916599e3d6d6/library/core/src/panicking.rs:72:14
   7: core::panicking::panic
             at /rustc/9b00956e56009bab2aa15d7bff10916599e3d6d6/library/core/src/panicking.rs:145:5
   8: ruff_python_index::indexer::Indexer::from_tokens
   9: ruff_linter::linter::lint_fix
             at ./ruff/crates/ruff_linter/src/linter.rs:544:23
  10: ruff::diagnostics::lint_path
             at ./ruff/crates/ruff/src/diagnostics.rs:274:14
  11: ruff::commands::check::lint_path::{{closure}}
             at ./ruff/crates/ruff/src/commands/check.rs:192:9
  12: std::panicking::try::do_call
             at /rustc/9b00956e56009bab2aa15d7bff10916599e3d6d6/library/std/src/panicking.rs:552:40
  13: std::panicking::try
             at /rustc/9b00956e56009bab2aa15d7bff10916599e3d6d6/library/std/src/panicking.rs:516:19
  14: std::panic::catch_unwind
             at /rustc/9b00956e56009bab2aa15d7bff10916599e3d6d6/library/std/src/panic.rs:146:14
  15: ruff::panic::catch_unwind
             at ./ruff/crates/ruff/src/panic.rs:40:18
  16: ruff::commands::check::lint_path
             at ./ruff/crates/ruff/src/commands/check.rs:191:18
  17: ruff::commands::check::check::{{closure}}
             at ./ruff/crates/ruff/src/commands/check.rs:93:17
  18: &lt;rayon::iter::filter_map::FilterMapFolder&lt;C,P&gt; as rayon::iter::plumbing::Folder&lt;T&gt;&gt;::consume
             at /home/runner/.cargo/registry/src/index.crates.io-6f17d22bba15001f/rayon-1.10.0/src/iter/filter_map.rs:123:36
  19: rayon::iter::plumbing::Folder::consume_iter
             at /home/runner/.cargo/registry/src/index.crates.io-6f17d22bba15001f/rayon-1.10.0/src/iter/plumbing/mod.rs:178:20
  20: rayon::iter::plumbing::Producer::fold_with
             at /home/runner/.cargo/registry/src/index.crates.io-6f17d22bba15001f/rayon-1.10.0/src/iter/plumbing/mod.rs:109:9
  21: rayon::iter::plumbing::bridge_producer_consumer::helper
             at /home/runner/.cargo/registry/src/index.crates.io-6f17d22bba15001f/rayon-1.10.0/src/iter/plumbing/mod.rs:437:13
  22: rayon::iter::plumbing::bridge_producer_consumer
             at /home/runner/.cargo/registry/src/index.crates.io-6f17d22bba15001f/rayon-1.10.0/src/iter/plumbing/mod.rs:396:12
  23: &lt;rayon::iter::plumbing::bridge::Callback&lt;C&gt; as rayon::iter::plumbing::ProducerCallback&lt;I&gt;&gt;::callback
             at /home/runner/.cargo/registry/src/index.crates.io-6f17d22bba15001f/rayon-1.10.0/src/iter/plumbing/mod.rs:372:13
  24: &lt;rayon::slice::Iter&lt;T&gt; as rayon::iter::IndexedParallelIterator&gt;::with_producer
             at /home/runner/.cargo/registry/src/index.crates.io-6f17d22bba15001f/rayon-1.10.0/src/slice/mod.rs:826:9
  25: rayon::iter::plumbing::bridge
             at /home/runner/.cargo/registry/src/index.crates.io-6f17d22bba15001f/rayon-1.10.0/src/iter/plumbing/mod.rs:356:12
  26: &lt;rayon::slice::Iter&lt;T&gt; as rayon::iter::ParallelIterator&gt;::drive_unindexed
             at /home/runner/.cargo/registry/src/index.crates.io-6f17d22bba15001f/rayon-1.10.0/src/slice/mod.rs:802:9
  27: &lt;rayon::iter::filter_map::FilterMap&lt;I,P&gt; as rayon::iter::ParallelIterator&gt;::drive_unindexed
             at /home/runner/.cargo/registry/src/index.crates.io-6f17d22bba15001f/rayon-1.10.0/src/iter/filter_map.rs:46:9
  28: &lt;rayon::iter::fold::Fold&lt;I,ID,F&gt; as rayon::iter::ParallelIterator&gt;::drive_unindexed
             at /home/runner/.cargo/registry/src/index.crates.io-6f17d22bba15001f/rayon-1.10.0/src/iter/fold.rs:59:9
  29: rayon::iter::reduce::reduce
             at /home/runner/.cargo/registry/src/index.crates.io-6f17d22bba15001f/rayon-1.10.0/src/iter/reduce.rs:15:5
  30: rayon::iter::ParallelIterator::reduce
             at /home/runner/.cargo/registry/src/index.crates.io-6f17d22bba15001f/rayon-1.10.0/src/iter/mod.rs:998:9
  31: ruff::commands::check::check
             at ./ruff/crates/ruff/src/commands/check.rs:163:10
  32: ruff::check
             at ./ruff/crates/ruff/src/lib.rs:429:13
  33: ruff::run
             at ./ruff/crates/ruff/src/lib.rs:202:33
  34: ruff::main
             at ./ruff/crates/ruff/src/main.rs:65:11
  35: core::ops::function::FnOnce::call_once
             at /rustc/9b00956e56009bab2aa15d7bff10916599e3d6d6/library/core/src/ops/function.rs:250:5
  36: std::sys_common::backtrace::__rust_begin_short_backtrace
             at /rustc/9b00956e56009bab2aa15d7bff10916599e3d6d6/library/std/src/sys_common/backtrace.rs:155:18
  37: std::rt::lang_start::{{closure}}
             at /rustc/9b00956e56009bab2aa15d7bff10916599e3d6d6/library/std/src/rt.rs:166:18
  38: core::ops::function::impls::&lt;impl core::ops::function::FnOnce&lt;A&gt; for &amp;F&gt;::call_once
             at /rustc/9b00956e56009bab2aa15d7bff10916599e3d6d6/library/core/src/ops/function.rs:284:13
  39: std::panicking::try::do_call
             at /rustc/9b00956e56009bab2aa15d7bff10916599e3d6d6/library/std/src/panicking.rs:552:40
  40: std::panicking::try
             at /rustc/9b00956e56009bab2aa15d7bff10916599e3d6d6/library/std/src/panicking.rs:516:19
  41: std::panic::catch_unwind
             at /rustc/9b00956e56009bab2aa15d7bff10916599e3d6d6/library/std/src/panic.rs:146:14
  42: std::rt::lang_start_internal::{{closure}}
             at /rustc/9b00956e56009bab2aa15d7bff10916599e3d6d6/library/std/src/rt.rs:148:48
  43: std::panicking::try::do_call
             at /rustc/9b00956e56009bab2aa15d7bff10916599e3d6d6/library/std/src/panicking.rs:552:40
  44: std::panicking::try
             at /rustc/9b00956e56009bab2aa15d7bff10916599e3d6d6/library/std/src/panicking.rs:516:19
  45: std::panic::catch_unwind
             at /rustc/9b00956e56009bab2aa15d7bff10916599e3d6d6/library/std/src/panic.rs:146:14
  46: std::rt::lang_start_internal
             at /rustc/9b00956e56009bab2aa15d7bff10916599e3d6d6/library/std/src/rt.rs:148:20
  47: main
  48: &lt;unknown&gt;
  49: __libc_start_main
  50: _start

</code></pre>
<p><a href="https://github.com/user-attachments/files/15884677/python_compressed.zip">python_compressed.zip</a></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @MichaReiser on 2024-06-18 11:37</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-06-18 11:38</div>
            <div class="timeline-body"><p>@dhruvmanila I suspect this might be because of the latest parser recovery changes. Do you think you have time to have a look?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-06-18 11:47</div>
            <div class="timeline-body"><p>Yes, looking at it now</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-06-18 11:51</div>
            <div class="timeline-body"><p>It doesn't occur on <code>main</code> but it does panic on https://github.com/astral-sh/ruff/commit/8499abfa7feec5b496a438c4dc310ee9130d4745. I suspect that https://github.com/astral-sh/ruff/commit/1e0642fac8e98a93c4e416886eb8af93a187984d fixed it. Let me look at what caused this panic.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-06-18 12:02</div>
            <div class="timeline-body"><p>Yeah, I think I got it. So, basically there's a missing <code>}</code> on line 4 after <code>_AVAILABLE_COMMANDS_STR</code>:</p>
<pre><code class="language-py">_AVAILABLE_COMMANDS_STR = &quot;&quot;&quot;\
ping                test the connection with the remote server&quot;&quot;&quot;
USAGE = f&quot;&quot;&quot;\
{_AVAILABLE_COMMANDS_STR&quot;&quot;&quot;
#                       ^ f-string: expecting '}'
        return f&quot;&quot;&quot;\
Multiple commands can be given in a single line, either from the shell or from command line, \
{_AVAILABLE_COMMANDS_STR}&quot;&quot;&quot;
</code></pre>
<p>Earlier, unterminated f-strings didn't recover well but the nesting level is affected by the curly braces which forms an expression element of an f-string. So, the parser was always in a parenthesized context because it didn't recover from an unclosed <code>{</code>. With https://github.com/astral-sh/ruff/commit/1e0642fac8e98a93c4e416886eb8af93a187984d, we now reduce the nesting level correctly by calling in the re-lexing logic for f-string recovery (via <code>parse_list</code>).</p>
<p>The difference can be seen in the token stream:</p>
<p>Before (which would panic):</p>
<pre><code>0 Name 23
24 Equal 25
26 String 96
96 Newline 97
97 Name 102
103 Equal 104
105 FStringStart 109
109 FStringMiddle 111
111 Lbrace 112
112 Name 135
135 String 158
160 Name 168
169 Name 177
178 Name 181
182 Name 184
185 Name 190
191 In 193
194 Name 195
196 Name 202
203 Name 207
207 Comma 208
209 Name 215
216 From 220
221 Name 224
225 Name 230
231 Or 233
234 From 238
238 FStringMiddle 255 &lt;- panic is probably because of
254 FStringMiddle 255 &lt;- either of these two tokens
255 Lbrace 256
256 Name 279
279 Rbrace 280
280 FStringEnd 283
283 Newline 284
</code></pre>
<p>After:</p>
<pre><code>0 Name 23
24 Equal 25
26 String 96
96 Newline 97
97 Name 102
103 Equal 104
105 FStringStart 109
109 FStringMiddle 111
111 Lbrace 112
112 Name 135
135 String 158
158 FStringMiddle 255
255 Lbrace 256
256 Name 279
279 Rbrace 280
280 FStringEnd 283
283 Newline 284
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-06-18 12:06</div>
            <div class="timeline-body"><p>I'll consider this issue as fixed by https://github.com/astral-sh/ruff/pull/11871. Thank you for raising this ticket!</p>
<p>On a side note, @qarmin do you mind sharing how you're running the fuzzer? Do you have a custom setup to find these bugs? If so, I'd appreciate if you can share that.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @dhruvmanila on 2024-06-18 12:06</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/qarmin">@qarmin</a> on 2024-06-18 14:25</div>
            <div class="timeline-body"><p>https://github.com/qarmin/Automated-Fuzzer (this is mainly a tool for internal use, so the code is not very elegant)</p>
<ul>
<li>it simply downloads the python files from https://github.com/qarmin/Automated-Fuzzer/releases/tag/test (~1 year ago I downloaded this files from pip from almost all available packages)</li>
<li>randomly add python keywords and frequently used expressions or remove/replace any characters (https://github.com/qarmin/Automated-Fuzzer/blob/308b709ca57c272109685819763977554f41a635/src/broken_files.rs#L15-L24)</li>
<li>ruff check this file and the output is checked to see if contains certain words like &quot;RUST_BACKTRACE&quot; or &quot;failed to fix&quot;</li>
<li>problematic file is minimized</li>
<li>results are packed so to report bug I just need to unpack them and copy and paste content to new issue</li>
</ul>
<p>I run this daily in CI</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:34:53 UTC
    </footer>
</body>
</html>
