<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>`UP032` fix fails when braces are created via escapes - astral-sh/ruff #19792</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1><code>UP032</code> fix fails when braces are created via escapes</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/ruff/issues/19792">#19792</a>
        opened by <a href="https://github.com/MeGaGiGaGon">@MeGaGiGaGon</a>
        on 2025-08-06 20:21
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MeGaGiGaGon">@MeGaGiGaGon</a></div>
            <div class="timeline-body"><h3>Summary</h3>
<p>The fix for <a href="https://docs.astral.sh/ruff/rules/f-string/#f-string-up032">f-string (UP032)</a> will fail if the braces (<code>{</code> and <code>}</code>) are created via escapes instead of literal characters: <a href="https://play.ruff.rs/2a2c4778-a9ff-4499-b9cf-b89c38a25d4b">Example</a></p>
<pre><code class="language-powershell">PS ~&gt;echo '&quot;\x7btest\x7d&quot;.format(test=1)' | uvx ruff check --select UP032 --fix -
&quot;\x7btest\x7d&quot;
Found 1 error (1 fixed, 0 remaining).
</code></pre>
<p>This does work properly with <code>.format</code> and could be fixed the same way as the non-cursed version:</p>
<pre><code class="language-pycon">&gt;&gt;&gt; &quot;\x7btest\x7d&quot;.format(test=1)
'1'
&gt;&gt;&gt; f&quot;{1}&quot;
'1'
</code></pre>
<p>This also applies to all the other ways of writing <code>{</code> and <code>}</code> non-literally (<code>\x</code>, <code>\u</code>, <code>\U</code>, <code>\N</code>)</p>
<h3>Version</h3>
<p>ruff 0.12.7 (c5ac99889 2025-07-29)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MeGaGiGaGon">@MeGaGiGaGon</a> on 2025-08-06 20:33</div>
            <div class="timeline-body"><p>This same thing also applies to <a href="https://docs.astral.sh/ruff/rules/printf-string-formatting/#printf-string-formatting-up031">printf-string-formatting (UP031)</a> example <a href="https://play.ruff.rs/d6f0f412-a887-482b-a337-3a52a10472a1">playground</a></p>
<pre><code class="language-powershell">PS ~&gt;echo '&quot;\x25s&quot; % 1' | uvx ruff check --select UP031 --fix --unsafe-fixes -
&quot;\x25s&quot;.format(1)
Found 1 error (1 fixed, 0 remaining).
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @ntBre on 2025-08-07 11:54</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">fixes</span> added by @ntBre on 2025-08-07 11:54</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/IDrokin117">@IDrokin117</a> on 2025-08-08 12:27</div>
            <div class="timeline-body"><p>I am going to work on this</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @IDrokin117 by @ntBre on 2025-08-08 16:22</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/IDrokin117">@IDrokin117</a> on 2025-08-09 19:45</div>
            <div class="timeline-body"><h1>Investigation results</h1>
<h2>Context</h2>
<p>It looks like it's tough to deal with Unicode escape sequences in both cases for now. But before short explanation how it works:</p>
<ol>
<li>The string parsed into <code>FormatPart</code> by <code>FormatString</code> <a href="https://github.com/astral-sh/ruff/blob/0.12.7/crates/ruff_linter/src/rules/pyupgrade/rules/f_strings.rs#L273">here</a>. For example:</li>
</ol>
<pre><code>&quot;text {}&quot;.format(1) # -&gt; [Literal(&quot;test &quot;), Field { field_name: &quot;&quot;, conversion_spec: None, format_spec: &quot;&quot; }]
</code></pre>
<p>where <code>Field</code> is a place for <code>{}</code> to be replaced.
2. Next maps positional and keyword arguments to their values (e.g. <code>{}: 1</code>) and substitutes them.</p>
<p>The problem in the issue occurred due to 1) iterated through <a href="https://github.com/astral-sh/ruff/blob/0.12.7/crates/ruff_linter/src/rules/pyupgrade/rules/f_strings.rs#L246">raw contents</a>(not parsed) 2) unicode sequences treated as literals</p>
<pre><code>print(&quot;\x7btest\x7d {test}&quot;.format(test=1)) # -&gt; [Literal(&quot;\\x7btest\\x7d &quot;), Field { field_name: &quot;test&quot;, conversion_spec: None, format_spec: &quot;&quot; }]
</code></pre>
<h2>Question</h2>
<p>Are Unicode escape sequences should be decoded and replaced? I mean</p>
<pre><code>&quot;\x7btest\x7d&quot;.format(test=1)
</code></pre>
<p>to</p>
<pre><code>&quot;{1}&quot; # (1)
</code></pre>
<p>Or we can try to keep it</p>
<pre><code>&quot;\x7b1\x7d&quot; # (2)
</code></pre>
<p>I think the second one is correct, because that was the intention.</p>
<h2>First case</h2>
<p>Back to the first (1) case. It is possible to solve the problem by iterating through parsed content instead of raw (e.g. parse whole expression <code>&quot;\x7btest\x7d {test}&quot;</code> -&gt; <code>&quot;{test} {test}&quot;</code>). It is already implemented func <a href="https://github.com/astral-sh/ruff/blob/8230b79829db0148afeefa634f3dde00b3a52410/crates/ruff_python_parser/src/lib.rs#L139"><code>parse_expression</code></a>. But it means other escape sequences will parse as well (e.g. <code>&quot;\N{snowman} \x7btest\x7d {test}&quot;</code> -&gt; &quot;â˜ƒ {test} {test}&quot;). In my view, the rule shouldn't substitute Unicode sequences with literal characters in the source code.</p>
<h2>Second case</h2>
<p>The second option (2) requires handling Unicode sequences in <code>FormatString</code>. This will force a fully/partial rework of <code>FormatString</code>. We need to at least parse or check Unicode sequence brackets and retain them for substitution.</p>
<h1>Conclusion</h1>
<p>To resolve this issue, we need to identify Unicode sequence brackets when parsing source content into FormatPart objects and classify them as Field rather than Literal. The possible solutions require a decision, so I'm asking more experienced contributors for help. There may already be a sophisticated solution in the repository.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MeGaGiGaGon">@MeGaGiGaGon</a> on 2025-08-09 21:10</div>
            <div class="timeline-body"><p>Sadly keeping the escapes as escapes for <code>.format</code> -&gt; f-string won't work, since f-strings only work with literal <code>{}</code>s:</p>
<pre><code class="language-pycon">&gt;&gt;&gt; &quot;\x7btest\x7d&quot;.format(test=1)
'1'
&gt;&gt;&gt; f&quot;{1}&quot; # works
'1'
&gt;&gt;&gt; f&quot;\x7b1\x7d&quot; # doesnt work
'{1}'
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/IDrokin117">@IDrokin117</a> on 2025-08-09 21:24</div>
            <div class="timeline-body"><p>Should we make it unsafe fix in such case?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntBre">@ntBre</a> on 2025-08-11 19:56</div>
            <div class="timeline-body"><p>Thank you for looking into this!</p>
<p>I actually misinterpreted the initial report. I thought the rule knew that the escapes were braces and was still trying to perform the substitution, but the <code>test</code> in the input string is actually irrelevant. UP032 still flags this <a href="https://play.ruff.rs/2fb58f99-8885-4a19-b83a-81012d750265">case</a>:</p>
<pre><code class="language-py">&quot;\x7b\x7d&quot;.format(test=1)
</code></pre>
<p>and just drops the <code>format</code> call. I think that would be another way around this: don't offer a fix if there's a mismatch between the number of placeholders and arguments to <code>format</code>. That kind of seems like a bug in its own right anyway.</p>
<p>It would be cool to replace the escapes with real braces, but I think it would be totally fine just to avoid offering an incorrect fix. I expect this kind of thing to be rare anyway.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntBre">@ntBre</a> on 2025-08-11 20:04</div>
            <div class="timeline-body"><p>Even more directly, UP032 flags this case: <code>&quot;&quot;.format(test=1)</code>, definitely showing that it's not interpreting the escapes as I thought.</p>
<p>Hmm, another interesting data point is that we do flag F524 in the <a href="https://play.ruff.rs/07806812-ce88-4760-a13f-151a78bbee83">playground</a> case I linked above. So we may be able to look at its implementation if we do want to replace the braces. I don't immediately see the difference between the two because they both use <code>FormatString::from_str</code>, but I guess there's something different in there.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 16:53:11 UTC
    </footer>
</body>
</html>
