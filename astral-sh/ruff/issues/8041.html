<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Don't parenthesize unsplittable expressions to make comments fit - astral-sh/ruff #8041</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Don't parenthesize unsplittable expressions to make comments fit</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/issues/8041">#8041</a>
        opened by <a href="https://github.com/konstin">@konstin</a>
        on 2023-10-18 10:04
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a></div>
            <div class="timeline-body"><p>Black:</p>
<pre><code class="language-python">__ = excel_safe  # just so the compatibility import above is &quot;used&quot; and doesn't get removed by linter
</code></pre>
<p>Ours:</p>
<pre><code class="language-python">__ = (
    excel_safe
)  # just so the compatibility import above is &quot;used&quot; and doesn't get removed by linter
</code></pre>
<p>We make the comment fit, but the style is worse.</p>
<p>This also applies to:</p>
<ul>
<li>Other assignments</li>
<li>Return</li>
<li>Await</li>
<li>Yield</li>
</ul>
<p>It does not apply to:</p>
<ul>
<li>Clause headers (because followed by a <code>:</code>)</li>
<li>Assert (even if it only has one expression)</li>
<li>Black's new preview style</li>
</ul>
<p>Note:</p>
<p>Black moves the comment for unsplittable nodes into the parentheses (keeps them with the expression) rather than moving them at the end of the assignment (as it does with other expressions)</p>
<pre><code class="language-python">return (
    aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa  # com
)
</code></pre>
<p>Edited by @MichaReiser</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @konstin on 2023-10-18 10:04</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">formatter</span> added by @konstin on 2023-10-18 10:04</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-10-18 13:05</div>
            <div class="timeline-body"><p>For what itâ€™s worth, this is already documented as an intentional deviation (though we could revisit it): https://github.com/astral-sh/ruff/blob/main/crates/ruff_python_formatter/README.md#expressions-with-non-pragma-trailing-comments-are-split-more-often--7823</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2023-10-18 13:10</div>
            <div class="timeline-body"><p>Sorry, i missed that. I like the behavior without comments, with comments i find it looking really strange</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> removed by @konstin on 2023-10-18 13:10</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">needs-decision</span> added by @konstin on 2023-10-18 13:10</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-10-18 22:00</div>
            <div class="timeline-body"><p>I expect that we have the same behavior for literals and I'm not sure how you would implement this because we would need to lift comments of the &quot;best fitting&quot; content. I further think that what we have is more consistent with Black's approach of considering comments as part of the content (vs Prettier that never includes comments in the measured width)</p>
<p>Edit: The problem is slightly different than I thought. The comment is a trailing comment on the assignment statement. So the expression itself doesn't know about the comment. The issue is that the name should be parenthesized if it makes it fit (including any content, including comments, after it). This would mean we need to exclude the comment from the width for this specific case which seems odd.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone "Formatter: Stable" by @MichaReiser on 2023-10-20 07:09</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Avasam">@Avasam</a> on 2023-10-24 21:47</div>
            <div class="timeline-body"><p>Arguably long same-line comments aren't great to begin with and this will fit both:</p>
<pre><code class="language-python"># just so the compatibility import above is &quot;used&quot; and doesn't get removed by linter
__ = excel_safe
</code></pre>
<p>But I agree for Black-to-Ruff transition PRs it's a bit annoying as I'd have to first include a commit that moves all these comments, and then the &quot;<em>autoformat, no manual changes</em>&quot; commit that shows minimal differences.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-10-25 23:23</div>
            <div class="timeline-body"><p>FWIW, I got more feedback wondering about this deviation.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-10-27 10:42</div>
            <div class="timeline-body"><p>What about:</p>
<pre><code class="language-python">await (
      self._shade.refresh()
)  # force update data to ensure new info is in coordinator
</code></pre>
<p>Black doesn't parenthesis, Ruff does.</p>
<p>Edit: this is related to https://github.com/astral-sh/ruff/issues/8182</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @MichaReiser by @MichaReiser on 2023-10-30 00:48</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-10-30 09:39</div>
            <div class="timeline-body"><p>To make this slightly more complicated, the comment width influences whether the target should split or not. Blacked code</p>
<pre><code class="language-python">a[
    &quot;bbbbb&quot;
] = excel_safe  # just so the compatibility import above is &quot;used&quot; and doesn't get removed by linter
a[
    &quot;bbbbb&quot;
] = excel_saaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaafe  # just so the compatibility import above is &quot;used&quot; and doesn't get removed by linter
</code></pre>
<p>That means it's somehow required to only exclude the line-suffix lengths when deciding if <code>best_fit_parentheses</code> should expand or not. Such conditional inclusion/excludion of widths can be problematic because it breaks the <code>measured_group_fits</code> optimization in the <code>Printer</code> (the <code>excel_safe</code> group fits, the printer avoids testing if other groups before the next line break fit too, but that's incorrect when ignoring the width only for <code>excel_safe</code>).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-10-30 09:51</div>
            <div class="timeline-body"><p>I want to try the following tomorrow:</p>
<ul>
<li>Change the <code>LineSuffix</code> width to be measured lazily when encountering the end of the file, a line break, or a line suffix.</li>
<li>Change the semantics of <code>BestFitsParenthesize</code> to only measure its own width to make the decision whether it should be parenthesized</li>
</ul>
<p>Issue, I need to double check if this would play nice with preview style where the right should break first. I fear it does not.</p>
<p>Interestingly, black's preview style formatting formats this as:</p>
<pre><code class="language-python">a[&quot;bbbbb&quot;] = (
    excel_safe  # just so the compatibility import above is &quot;used&quot; and doesn't get removed by linter
)
a[&quot;bbbbb&quot;] = (
    excel_saaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaafe  # just so the compatibility import above is &quot;used&quot; and doesn't get removed by linter
)
</code></pre>
<p>Edit: but only if the left side can be split. It still doesn't parenthesize</p>
<pre><code class="language-python">a = excel_saaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaafe  # just so the compatibility import above is &quot;used&quot; and doesn't get removed by linter
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "Don't parenthesize names to make comments fit" to "Don't parenthesize unsplittable expressions to make comments fit" by @MichaReiser on 2023-11-01 03:01</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-11-01 07:45</div>
            <div class="timeline-body"><p>Okay this is embarrassing that it took me so long to realise this, but it could have been because I believe there's an off by one bug in black.</p>
<p>Black respects the comment width in all cases, but it &quot;just works&quot; for them because they place the trailing comment differently than Ruff:</p>
<pre><code class="language-python">## ident, 83 columns, comment 89 columns
____aaa = aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaabbbbbbbbbbbbbbbbbbbbbbbbbbbvvvvvvvvvvv  # ccc

## ident, 83 columns, comment 88 columns
____aaa = aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaabbbbbbbbbbbbbbbbbbbbbbbbbbbvvvvvvvvvvv  # cc

## ident, 83 columns, comment 87 columns
____aaa = (
    aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaabbbbbbbbbbbbbbbbbbbbbbbbbbbvvvvvvvvvvv  # c
)

# 88 column
a = aaaaaaaaaaaaaaaaaaaaaaaaaaaaaa and bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb
# 89
a = (
    aaaaaaaaaaaaaaaaaaaaaaaaaaaaaa
    and bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb
)
</code></pre>
<p>Black attaches the trailing end-of-line comment to the parenthesized expression and only parenthesizes it if the expression and comment fit. It otherwise omits the parentheses and formats the comments after the expression.</p>
<p>What's unclear to me is why Black only keeps the parentheses up to a length of 87, and not 88 as configured. I suspect that this is an off-by-one error.</p>
<p>Now, we could implement the same comment design in Ruff but there are two challenges:</p>
<ol>
<li>Assigning the comment to the expression is not in line with our general guiding principle that comments should always split the parent. This is relevant here because Ruff needs to &quot;undo&quot; the parenthesizing if the line suddenly fits (or no longer fits).</li>
<li>Attaching the comments to the value sounds trivial, but it isn't when the value is parenthesized because the enclosing node then is the Suite (module) and not the <code>AssignStmt</code>. Meaning, we now need to handle the comments for all suites.</li>
</ol>
<p>We have two options:</p>
<ol>
<li>Keep our existing layout and never parenthesize unsplittable values in simple assignments (simple value, single, unspittable target). May result in Ruff not splitting an expression if parenthesizing could make it fit</li>
<li>Use Black's layout at the cost of a more complex comment placement</li>
</ol>
<p>I'm leaning towards two</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @MichaReiser on 2023-11-03 05:13</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 16:48:39 UTC
    </footer>
</body>
</html>
