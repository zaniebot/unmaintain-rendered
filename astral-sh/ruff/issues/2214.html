<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TCH rules require from __future__ import annotations - astral-sh/ruff #2214</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>TCH rules require from __future__ import annotations</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/issues/2214">#2214</a>
        opened by <a href="https://github.com/twoertwein">@twoertwein</a>
        on 2023-01-26 18:33
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/twoertwein">@twoertwein</a> on 2023-01-26 18:33</div>
            <div class="timeline-body"><p>The following does not work with 3.11.1 at runtime:</p>
<p>test.py</p>
<pre><code class="language-py">from typing import TYPE_CHECKING

if TYPE_CHECKING:
    from test_b import B

def test(x: B) -&gt; B:
    return x
</code></pre>
<p>test_b.py</p>
<pre><code class="language-py">class B:
    ...
</code></pre>
<pre><code class="language-sh">$ python test.py 
Traceback (most recent call last):
  File &quot;test.py&quot;, line 9, in &lt;module&gt;
    def test(x: B) -&gt; B:
                ^
NameError: name 'B' is not defined
</code></pre>
<p>but it works when <code>test.py </code>contains <code>from __future__ import annotations</code>.</p>
<p>It might be good to either skip the TCH rules when <code>from __future__ import annotations</code> is not there or mention that this import needs to be added.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-01-26 18:59</div>
            <div class="timeline-body"><p>Hmm yeah. <a href="https://github.com/snok/flake8-type-checking#choosing-how-to-handle-forward-references"><code>flake8-type-checking</code></a> has some things to say about that and additional rules. @sondrelg - I promise I'll stop pinging you, but anything else you'd say about the &quot;right&quot; way to handle this, based on your experience?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sondrelg">@sondrelg</a> on 2023-01-26 20:23</div>
            <div class="timeline-body"><p>Yeah this is correct for all Python version above 3.7 I believe. Ideally ruff should implement <code>TC100</code>, <code>TC101</code>, <code>TC200</code>, and <code>TC201</code> as these are meant to complement the <code>TC00[1,2,3]</code> rule by telling you how to handle forward references.</p>
<p>What happens we when put an import inside a <code>TYPE_CHECKING</code> block (or any condition that is evaluated as <code>False</code> at runtime) is that the code path is not evaluated, so the import effectively doesn't happen at runtime. Since code outside the condition cannot reference something that isn't defined, we either wrap the undefined values in quotes or add a <code>from __futures__ import annotations</code> since this enables <a href="https://peps.python.org/pep-0563/">PEP563</a> behavior.</p>
<p>tl;dr: The <code>TC00[1,2,3]</code> need either  the <code>TC1*</code> or <code>TC2*</code> range errors enabled (not both) to guide users into setting up their code in a valid way.</p>
<p>Sorry for not noticing this earlier. I should have warned you about this. And no worries about the pings - happy to help :+1:</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sondrelg">@sondrelg</a> on 2023-01-26 20:24</div>
            <div class="timeline-body"><p>This section explains the concepts adequately, I hope: https://github.com/snok/flake8-type-checking#choosing-how-to-handle-forward-references</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/RayJameson">@RayJameson</a> on 2023-01-30 06:45</div>
            <div class="timeline-body"><p>So for now there is no way to turn TC1/TC2 in ruff?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sondrelg">@sondrelg</a> on 2023-01-30 07:54</div>
            <div class="timeline-body"><p>The code just has to be written I think @RayJameson. There shouldn't be any real blockers in place.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-01-30 12:12</div>
            <div class="timeline-body"><p>Yup that's right -- we don't support those rules yet, only <a href="https://github.com/charliermarsh/ruff#flake8-type-checking-tch">TC001 - TC005</a>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @charliermarsh on 2023-02-28 22:44</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-02-28 22:44</div>
            <div class="timeline-body"><p>I think this specific issue was actually a bug that we fixed around runtime requirements for annotations in function scopes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2023-02-28 22:44</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-02-28 22:45</div>
            <div class="timeline-body"><p>(That snippet no longer raises an error.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Faithfinder">@Faithfinder</a> on 2024-06-04 14:17</div>
            <div class="timeline-body"><p>Sorry for necroposting, but I've been studying this for the last couple of hours and don't get it. Is <code>from __future__ import annotation</code> needed with these rules or not? If it is, why doesn't ruff add it?</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 01:30:04 UTC
    </footer>
</body>
</html>
