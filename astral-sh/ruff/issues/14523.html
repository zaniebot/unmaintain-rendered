<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RUF035 (unsafe-markup-use) can be noisy and would benefit from a whitelist - astral-sh/ruff #14523</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>RUF035 (unsafe-markup-use) can be noisy and would benefit from a whitelist</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/issues/14523">#14523</a>
        opened by <a href="https://github.com/ThiefMaster">@ThiefMaster</a>
        on 2024-11-22 10:32
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/ThiefMaster">@ThiefMaster</a> on 2024-11-22 10:32</div>
            <div class="timeline-body"><p>There are a few cases where it does not really make sense to get the warning, since it's pretty clearly intentional to avoid escaping, but adding noqa comments in every place where it's used would be very noisy/verbose:</p>
<ul>
<li><code>Markup(render_template(...))</code></li>
<li><code>Markup(_('Have a look at &lt;strong&gt;this&lt;/strong&gt; translated string!'))</code></li>
<li><code>msg = _('Have a look at &lt;strong&gt;this&lt;/strong&gt;!'); Markup(msg)</code></li>
</ul>
<p>So ideally I'd like to have a setting where I can add function names (ideally as import strings, but just names would also be OK most of the time) to be considered safe to have their return value passed to <code>Markdown</code> - either directly or via a variable assignment.</p>
<p>In the above case, I'd expect all 3 warnings to disappear by whitelisting <code>render_template</code> and <code>_</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-11-22 10:47</div>
            <div class="timeline-body"><p>@Daverball what are your thoughts on this. I remember that you intentionally decided not to exclude gettext.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">rule</span> added by @MichaReiser on 2024-11-22 10:47</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">preview</span> added by @MichaReiser on 2024-11-22 10:47</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Daverball">@Daverball</a> on 2024-11-22 10:58</div>
            <div class="timeline-body"><p>Generally my recommendation in these cases it to encapsulate the behavior that looks unsafe into a new function and use that instead of the original one, that way you only have to ignore errors in those few helper functions.</p>
<p>i.e. define a <code>render_template_markup</code> and <code>translated_markup</code> (you can configure i18n tooling to pick up additional function names for picking up i18n strings automatically) for those two cases and use those where appropriate. I think that's also good documentation.</p>
<p>Allowing <code>gettext</code> and other translation functions to pass through unchecked still has some risk, since the translations themselves could be compromised and that's a lot harder to spot than a compromised string literal. So I would try to avoid including markup in translation strings. That being said, I realize it can be inconvenient to split translations into chunks just for the sake of safety, so I have included markup in translations myself in some occasions.</p>
<p>In either case we could perhaps add an additional setting to define a number of functions that are considered safe to be wrapped in <code>Markup</code>, things like sanitization functions and template rendering functions come to mind. But I still think it's generally better to define wrapper functions, since then you don't always have to manually wrap the result. It's also less likely that you will forget to wrap the result this way.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Daverball">@Daverball</a> on 2024-11-22 11:03</div>
            <div class="timeline-body"><p>Another thing I have done in the past is define a function like this:</p>
<pre><code class="language-python">@overload
def my_gettext(text: str) -&gt; str: ...

@overload
def my_gettext(text:str, *, markup: Literal[True]) -&gt; Markup: ...

def my_gettext(text: str, *, markup: bool = False) -&gt; str:
    return Markup(gettext(text)) if markup else gettext(text)
</code></pre>
<p>And then import that as <code>_</code> instead of <code>gettext</code>.</p>
<p>(Of course you would then also want to add that function to the list of functions that should be treated like <code>Markup</code> for RUF035)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Daverball">@Daverball</a> on 2024-11-22 15:09</div>
            <div class="timeline-body"><p>All in all I'm +0 on adding a whitelist. It can genuinely make sense for some cases and it puts the power to make the decision where to draw the line for safety into the user's hands (you may e.g. decide that you take proper care to secure your translation data, so it's fine to include markup in translations).</p>
<p>But it also comes with the risk of making it too easy to accidentally ignore a large set of patterns that still have some unsafe corner cases and this is a security rule, so a higher level of churn is to be expected. Prompting people to restructure their code a bit, to make it less likely to introduce safety bugs seems like a net-positive to me, but that could also be resolved by recommending against using that whitelist as anything other than a temporary stop-gap measure for functions other than sanitization functions (like <code>bleach.clean</code>).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ThiefMaster">@ThiefMaster</a> on 2024-11-22 15:10</div>
            <div class="timeline-body"><p>I think w/o the whitelist the most likely &quot;solution&quot; people come up with is just ignoring the whole rule... which is not great :)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Daverball">@Daverball</a> on 2024-11-22 15:17</div>
            <div class="timeline-body"><p>You're not wrong, but giving people a false sense of security isn't great either. A lot of bandit rules are even noisier than this one and don't even try to exclude some easily detectable false positives, so by that measure this rule is actually quite forgiving.</p>
<p>I'm not sure what the correct trade-off is going to be. But I'm certainly not strongly opposed to adding a whitelist, just cautioning that it may weaken the rule's effect.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-11-22 16:40</div>
            <div class="timeline-body"><p>I like your suggestion of a wrapper function for new code. But I can see how existing code can't easily be rewritten to use such a wrapper function, which is why an allow-list probably makes sense.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @dhruvmanila on 2024-12-20 09:36</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @dhruvmanila on 2024-12-20 09:36</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 11:35:48 UTC
    </footer>
</body>
</html>
