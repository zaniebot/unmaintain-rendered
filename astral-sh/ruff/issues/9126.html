<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Docstring formatting does not always respect line length in `dynamic` mode - astral-sh/ruff #9126</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Docstring formatting does not always respect line length in <code>dynamic</code> mode</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/issues/9126">#9126</a>
        opened by <a href="https://github.com/stinodego">@stinodego</a>
        on 2023-12-14 09:39
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/stinodego">@stinodego</a></div>
            <div class="timeline-body"><p>First off, thanks so much for the great work on the docstring formatter! I'm very much looking forward to using it for the Polars code base.</p>
<p>When running the new docstring formatter on our code base, I found a number of examples where dynamic line length mode did not produce the expected result. See the three examples below:</p>
<pre><code class="language-python">def example1():
    &quot;&quot;&quot;
    Docstring example containing a class.

    Examples
    --------
    &gt;&gt;&gt; @pl.api.register_dataframe_namespace(&quot;split&quot;)
    ... class SplitFrame:
    ...     def __init__(self, df: pl.DataFrame):
    ...         self._df = df
    ...
    ...     def by_first_letter_of_column_values(self, col: str) -&gt; list[pl.DataFrame]:
    ...         return [
    ...             self._df.filter(pl.col(col).str.starts_with(c))
    ...             for c in sorted(
    ...                 set(df.select(pl.col(col).str.slice(0, 1)).to_series())
    ...             )
    ...         ]
    &quot;&quot;&quot;


class Nested:
    def example2():
        &quot;&quot;&quot;
        Regular docstring of class method.

        Examples
        --------
        &gt;&gt;&gt; df = pl.DataFrame(
        ...     {&quot;foo&quot;: [1, 2, 3], &quot;bar&quot;: [6, 7, 8], &quot;ham&quot;: [&quot;a&quot;, &quot;b&quot;, &quot;c&quot;]}
        ... )
        &quot;&quot;&quot;


def example3():
    &quot;&quot;&quot;
    Pragma comment.

    Examples
    --------
    &gt;&gt;&gt; af1, af2, af3 = pl.align_frames(
    ...     df1, df2, df3, on=&quot;dt&quot;
    ... )  # doctest: +IGNORE_RESULT
    &quot;&quot;&quot;

</code></pre>
<p>In ruff <code>0.1.8</code>, running the ruff docstring formatter on these with <code>line-length = 88</code> will produce line lengths over 88.</p>
<p>I think examples 1 and 2 are clear violations. Example 3 is debatable whether the result is desired or not.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">docstring</span> added by @MichaReiser on 2023-12-14 10:12</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">formatter</span> added by @MichaReiser on 2023-12-14 10:12</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-12-14 10:15</div>
            <div class="timeline-body"><p>Thanks for the feedback!</p>
<p>I wonder if this is happening because we only subtract $indent.level * indent.width$ but not necessarily the space required by <code>&gt;&gt;&gt;</code>?</p>
<p>@BurntSushi would you mind taking a look</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @MichaReiser on 2023-12-14 10:17</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone "Formatter: Stable" by @MichaReiser on 2023-12-14 10:17</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @BurntSushi by @MichaReiser on 2023-12-14 10:17</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/stinodego">@stinodego</a> on 2023-12-14 10:40</div>
            <div class="timeline-body"><blockquote>
<p>I wonder if this is happening because we only subtract  but not necessarily the space required by <code>&gt;&gt;&gt; </code>?</p>
</blockquote>
<p>That might be it actually. I figured it might be because of edge cases with classes or something, but indeed a simple example like this also exceeds the line length, but only by 4 characters:</p>
<pre><code>def example3():
    &quot;&quot;&quot;
    ...

    Examples
    --------
    &gt;&gt;&gt; af1, af2, af3 = pl.align_frames(
    ...     df1, df2, df3, on=&quot;dt&quot;, foo=&quot;looooooooooong_string&quot;
    ... )
    &quot;&quot;&quot;
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2023-12-14 13:12</div>
            <div class="timeline-body"><p>Nice find! I put up a fix in #9129.</p>
<p>@MichaReiser You were exactly correct! At least for this bug, it was indeed that the line length setting on the nested call to the formatter wasn't taking the extra spaces from the doctest prompt into account.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @BurntSushi on 2023-12-14 14:53</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 16:49:15 UTC
    </footer>
</body>
</html>
