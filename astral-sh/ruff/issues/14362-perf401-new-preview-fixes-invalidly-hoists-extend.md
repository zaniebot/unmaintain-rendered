```yaml
number: 14362
title: PERF401 new preview fixes invalidly hoists extend to list compre
type: issue
state: closed
author: Skylion007
labels:
  - bug
  - fixes
assignees: []
created_at: 2024-11-15T14:41:50Z
updated_at: 2024-12-12T08:11:10Z
url: https://github.com/astral-sh/ruff/issues/14362
synced_at: 2026-01-10T11:09:56Z
```

# PERF401 new preview fixes invalidly hoists extend to list compre

---

_Issue opened by @Skylion007 on 2024-11-15 14:41_

<!--
Thank you for taking the time to report an issue! We're glad to have you involved with Ruff.

If you're filing a bug report, please consider including the following information:

* List of keywords you searched for before creating this issue. Write them down here so that others can find this issue more easily and help provide feedback.
  e.g. "RUF001", "unused variable", "Jupyter notebook"
* A minimal code snippet that reproduces the bug.
* The command you invoked (e.g., `ruff /path/to/file.py --fix`), ideally including the `--isolated` flag.
* The current Ruff settings (any relevant sections from your `pyproject.toml`).
* The current Ruff version (`ruff --version`).
-->
I tried running the new autofixes on the PyTorch codebase and was mostly impressed, but found one really annoying (and handable edge case).

Here is an example bad fix
```diff
     @dist_init
     def test_wait_all_with_exception(self):
-        futs = []
+        futs = [rpc.rpc_async(dst, raise_func) for _ in range(10)]
         dst = worker_name((self.rank + 1) % self.world_size)
-        for _ in range(10):
-            futs.append(rpc.rpc_async(dst, raise_func))

         with self.assertRaisesRegex(ValueError, "Expected error"):
             torch.futures.wait_all(futs)
```
Here is an example diff generated by ruff. Note that list comprehensions uses `dst` even though dst is first defined on the line underneath the list comprehension. Ruff can already detect this because it immeaditely created a bunch of ruff F821 errors as soon as the fixes were applied. It would be good not to hoist the forloop from an extend to a list comprehensions if there are any variables needed for the list comprehension defined or mutated in anyway. I was kind of surprised given that it did properly not hoist the function if there were any comments in between the list definition and the loop.

```ruff 0.7.4```
```ruff check --select=PERF401 --fix --unsafe-fixes --preview```

FYI @w0nder1ng 


---

_Renamed from "PERF401 new fixes generates invalid code" to "PERF401 new preview fixes invalidly hoists extend to list compre" by @Skylion007 on 2024-11-15 14:42_

---

_Comment by @w0nder1ng on 2024-11-15 15:29_

I didn't consider that when I was writing the fix, and I guess the question now is how this case should be handled. I guess a possible fix could look like:
```python
     @dist_init
     def test_wait_all_with_exception(self):
-        futs = []
         dst = worker_name((self.rank + 1) % self.world_size)
-        for _ in range(10):
-            futs.append(rpc.rpc_async(dst, raise_func))
+        futs = [rpc.rpc_async(dst, raise_func) for _ in range(10)]
         with self.assertRaisesRegex(ValueError, "Expected error"):
             torch.futures.wait_all(futs)
```

As long as we check that the `futs` variable isn't used between `futs = []` and the for loop, it should be fine.

> I was kind of surprised given that it did properly not hoist the function if there were any comments in between the list definition and the loop.

If you have an example of this, I'd be happy to take a look.

---

_Label `bug` added by @dylwil3 on 2024-11-15 15:53_

---

_Label `fixes` added by @dylwil3 on 2024-11-15 15:53_

---

_Comment by @Skylion007 on 2024-11-15 16:38_

Sorry typo, it properly did NOT hoist the function if there were comments (to preserve the comments). As it did not hoist the list comprehension if there was a comment there. It did do if there was code in the way, which was surprising.

---

_Comment by @Skylion007 on 2024-11-17 17:32_

Also, FYI once these fixes are landed. We should look into PERF403, as the fixes will share a lot of similar logic. :)

---

_Closed by @MichaReiser on 2024-12-12 08:11_

---
