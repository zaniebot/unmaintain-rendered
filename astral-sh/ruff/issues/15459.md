```yaml
number: 15459
title: Broken f-string formatting after ruff 0.9
type: issue
state: closed
author: AlexElvers
labels:
  - bug
  - formatter
assignees: []
created_at: 2025-01-13T17:46:04Z
updated_at: 2025-01-15T08:22:49Z
url: https://github.com/astral-sh/ruff/issues/15459
synced_at: 2026-01-10T01:56:55Z
```

# Broken f-string formatting after ruff 0.9

---

_Issue opened by @AlexElvers on 2025-01-13 17:46_

Ruff 0.9.0/1 are introducing syntax syntax errors in f-strings with braces.

While f-strings with simple sets and dicts do not remove the necessary spaces:

```shell
$ echo 'print(f"{ {1, 2, 3} }")\nprint(f"{ {1: 2} }")' > main.py

$ ruff format --diff main.py
1 file already formatted
```

the spaces around the braces are removed in version 0.9.0/1, which leads to syntax errors:

```shell
$ echo 'print(f"{ {1, 2, 3} - {2} }")\nprint(f"{ {1: 2}.keys() }")' > main.py

$ ruff format --diff main.py
--- main.py
+++ main.py
@@ -1,2 +1,2 @@
-print(f"{ {1, 2, 3} - {2} }")
-print(f"{ {1: 2}.keys() }")
+print(f"{{1, 2, 3} - {2}}")
+print(f"{{1: 2}.keys()}")

1 file would be reformatted

$ ruff format main.py
1 file reformatted

$ ruff check main.py
main.py:1:18: SyntaxError: f-string: single '}' is not allowed
  |
1 | print(f"{{1, 2, 3} - {2}}")
  |                  ^
2 | print(f"{{1: 2}.keys()}")
  |

main.py:1:25: SyntaxError: f-string: single '}' is not allowed
  |
1 | print(f"{{1, 2, 3} - {2}}")
  |                         ^
2 | print(f"{{1: 2}.keys()}")
  |

main.py:2:15: SyntaxError: f-string: single '}' is not allowed
  |
1 | print(f"{{1, 2, 3} - {2}}")
2 | print(f"{{1: 2}.keys()}")
  |               ^
  |

main.py:2:23: SyntaxError: f-string: single '}' is not allowed
  |
1 | print(f"{{1, 2, 3} - {2}}")
2 | print(f"{{1: 2}.keys()}")
  |                       ^
  |

Found 4 errors.

$ python main.py
  File "/tmp/foo/main.py", line 1
    print(f"{{1, 2, 3} - {2}}")
                              ^
SyntaxError: f-string: single '}' is not allowed
```

Ruff 0.8.6 kept these f-strings unchanged:

```bash
$ uvx ruff@0.8.6 format --diff main.py
1 file already formatted
```

---

_Label `formatter` added by @AlexWaygood on 2025-01-13 19:32_

---

_Label `bug` added by @MichaReiser on 2025-01-13 19:46_

---

_Comment by @MichaReiser on 2025-01-13 20:00_

Thanks for reporting this. We do have code handling dictionary and other expressions that use curly braces but it only tests the expression itself rather than the left most or right most sub-expression.

---

_Assigned to @MichaReiser by @MichaReiser on 2025-01-13 20:13_

---

_Referenced in [astral-sh/ruff#15471](../../astral-sh/ruff/pulls/15471.md) on 2025-01-14 10:16_

---

_Closed by @MichaReiser on 2025-01-15 08:22_

---
