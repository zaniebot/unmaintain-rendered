<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Extend PEP 695 generic class and function rules - astral-sh/ruff #15642</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Extend PEP 695 generic class and function rules</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/ruff/issues/15642">#15642</a>
        opened by <a href="https://github.com/ntBre">@ntBre</a>
        on 2025-01-21 13:58
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a></div>
            <div class="timeline-body"><p>Follow up tasks from #15565</p>
<ul>
<li>[ ] Handle generic methods</li>
<li>[ ] Handle <code>default</code> kwargs for Python &gt;= 3.13</li>
<li>[ ] Unquote type variable forward reference annotations (see below)</li>
<li>[ ] Handle <code>TypeVarTuple</code> generics with <code>Unpack</code> instead of <code>*</code>: <code>class MultipleGenerics(Generic[S, T, Unpack[Ts], P]): ...</code> <a href="https://github.com/astral-sh/ruff/pull/15565#discussion_r1925489033">^1</a></li>
<li>[x] Allow multiple base classes for generic classes (https://github.com/astral-sh/ruff/pull/15659)</li>
<li>[x] Use string replacements for UP040's autofix too, instead of using the <code>ExprGenerator</code> (https://github.com/astral-sh/ruff/pull/15840)</li>
<li>[x] Rename private type variables in generics (don't make inline generics like <code>[_T]</code>) (https://github.com/astral-sh/ruff/pull/15862)</li>
</ul>
<p>Related: #4617, #12542</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">rule</span> added by @MichaReiser on 2025-01-21 14:02</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-01-21 14:30</div>
            <div class="timeline-body"><p>One other thing that might be nice would be to unquote annotations. E.g. old-style type variables often need to quote their <code>bound</code>s if the bound needs to use a forward reference to a name not yet defined</p>
<pre><code class="language-py">from typing import Generic, TypeVar

T = TypeVar(&quot;T&quot;, bound=&quot;list[T | None]&quot;)

class Foo(Generic[T]):
    var: T
</code></pre>
<p>But the bounds for PEP-695 type parameters are lazily evaluated, so there's no need to quote forward references:</p>
<pre><code class="language-pycon">&gt;&gt;&gt; class Foo[T: list[T | None]]:
...     var: T
...     
&gt;&gt;&gt; Foo.__type_params__[0].__bound__
list[typing.Optional[T]]
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntBre">@ntBre</a> on 2025-01-22 22:50</div>
            <div class="timeline-body"><p>I started working on renaming private type variables, but I think it's a bit more complicated than I thought. At first I was just going to do the rename as part of <code>DisplayTypeVar::fmt</code>, but I realized that you have to be pretty careful not to change the meaning of other instances of the type you're renaming. For example,</p>
<pre><code class="language-python">class T: ...

_T = TypeVar(&quot;_T&quot;)

def generic(var: _T) -&gt; _T:
    x: T = T()
    return var
</code></pre>
<p>You can't even just look at the signature or the parent scopes, you also have to look at the body of the class or function.</p>
<p>Even if you restrict the fix to variables not in the parent scope, you then have to update the name of the type in the body of the class or function too:</p>
<pre><code class="language-python">_G = TypeVar(&quot;_G&quot;)

class SafePrivate(Generic[_G]):
    var1: _G
</code></pre>
<p>This was the test case I was writing when I realized that I needed to rename the inner <code>_G</code> too, not just the one in the class signature. I found the <a href="https://github.com/astral-sh/ruff/blob/05abd642a8ddb3f3b6e7c78592995c6ccfca2520/crates/ruff_linter/src/renamer.rs#L12">Renamer</a> API, which sounded very promising, but I'm running into some panics like this: <code>assertion failed: start.raw &lt;= end.raw</code>, which I assume is because of the overlapping <code>Edit::replacement</code> from the existing UP046 code and the edits from <code>Renamer::rename</code>.</p>
<p>Would I need a separate rule to do the <code>rename</code> in a separate pass from the initial replacement? Or is there another approach I'm missing?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-01-22 23:03</div>
            <div class="timeline-body"><blockquote>
<p>Would I need a separate rule to do the <code>rename</code> in a separate pass from the initial replacement? Or is there another approach I'm missing?</p>
</blockquote>
<p>This might be quite a good solution. It would allow us to use the <code>Renamer</code> API (which I agree is the easiest, most robust way to do this!), and would also allow us to complain about e.g. handwritten PEP-695 classes that use TypeVars with leading underscores, which I think is a bit of a stylistic antipattern since they're private to the class by default. For this, though, I think it does make sense to have one rule that would rename type parameters in type aliases, functions and classes, rather than a separate rule for each. (That doesn't mean that they all have to be tackled in one PR, however!)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-02-05 13:15</div>
            <div class="timeline-body"><blockquote>
<p>One other thing that might be nice would be to unquote annotations. E.g. old-style type variables often need to quote their <code>bound</code>s if the bound needs to use a forward reference to a name not yet defined</p>
</blockquote>
<p>I suppose this could be done as an (initially preview-only) extension of UP037 and PYI020, rather than adding a new rule</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 16:52:02 UTC
    </footer>
</body>
</html>
