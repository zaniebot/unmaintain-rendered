<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[Autofix error] My File: pandas\tests\groupby\test_apply.py - astral-sh/ruff #4277</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[Autofix error] My File: pandas\tests\groupby\test_apply.py</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/issues/4277">#4277</a>
        opened by <a href="https://github.com/FishAlchemist">@FishAlchemist</a>
        on 2023-05-08 10:46
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/FishAlchemist">@FishAlchemist</a></div>
            <div class="timeline-body"><h2>Version(ruff --version)</h2>
<p><strong>ruff 0.0.265</strong></p>
<h2>Command(Powershell)</h2>
<pre><code class="language-powershell"> ruff check --select=ALL  .\test_apply.py
</code></pre>
<p><strong>If you add --isolated , there will be no problem about Autofix error</strong></p>
<h2>Terminal Content</h2>
<pre><code class="language-powershell">warning: `one-blank-line-before-class` (D203) and `no-blank-line-before-class` (D211) are incompatible. Ignoring `one-blank-line-before-class`.
warning: `multi-line-summary-first-line` (D212) and `multi-line-summary-second-line` (D213) are incompatible. Ignoring `multi-line-summary-second-line`.

error: Autofix introduced a syntax error. Reverting all changes.

This indicates a bug in `ruff`. If you could open an issue at:

    https://github.com/charliermarsh/ruff/issues/new?title=%5BAutofix%20error%5D

...quoting the contents of `test_apply.py`, along with the `pyproject.toml` settings and executed command, we'd be very appreciative!

test_apply.py:1:1: D100 Missing docstring in public module
test_apply.py:1:1: I001 Import block is un-sorted or un-formatted
test_apply.py:22:5: ANN201 Missing return type annotation for public function `test_apply_issues`
test_apply.py:22:5: D103 Missing docstring in public function
test_apply.py:38:5: PD901 `df` is a bad variable name. Be kinder to your future self.
.....(Hide more)
</code></pre>
<p><a href="https://github.com/charliermarsh/ruff/files/11420281/full_terminal_content.txt">full_terminal_content.txt</a></p>
<h3>Command(Powershell): --isolated</h3>
<pre><code class="language-powershell">ruff check --select=ALL --isolated .\test_apply.py
</code></pre>
<p><a href="https://github.com/charliermarsh/ruff/files/11420301/full_terminal_content_isolated.txt">full_terminal_content_isolated.txt</a></p>
<h2>Python Code</h2>
<p><strong>Please change the file extension from txt to py</strong>
<a href="https://github.com/charliermarsh/ruff/files/11420307/test_apply.txt">test_apply.txt</a></p>
<h2>pyproject.toml</h2>
<p><strong>Please change the file extension from txt to toml</strong>
<a href="https://github.com/charliermarsh/ruff/files/11420318/pyproject.txt">pyproject.txt</a></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-05-08 12:26</div>
            <div class="timeline-body"><p>This is a bug in the fix of PD002</p>
<p>It creates an invalid fix for</p>
<pre><code class="language-py">def test_apply_no_name_column_conflict():
    df = DataFrame(
        {
            &quot;name&quot;: [1, 1, 1, 1, 1, 1, 2, 2, 2, 2],
            &quot;name2&quot;: [0, 0, 0, 1, 1, 1, 0, 0, 1, 1],
            &quot;value&quot;: range(9, -1, -1),
        }
    )

    # it works! #2605
    grouped = df.groupby([&quot;name&quot;, &quot;name2&quot;])
    grouped.apply(lambda x: x.sort_values(&quot;value&quot;, inplace=True))
</code></pre>
<p>Suggested fixes</p>
<pre><code>PD002.py:36:31: E999 SyntaxError: invalid syntax. Got unexpected token '='
   |
36 |     # it works! #2605
37 |     grouped = df.groupby([&quot;name&quot;, &quot;name2&quot;])
38 |     grouped.apply(lambda x: x = x.sort_values(&quot;value&quot;))
   |                               ^ E999
   |


Last generated fixes:
PD002.py:5:23: PD002 [*] `inplace=True` should be avoided; it has inconsistent behavior
  |
5 | x = pd.DataFrame()
6 | 
7 | x.drop([&quot;a&quot;], axis=1, inplace=True)
  |                       ^^^^^^^^^^^^ PD002
8 | 
9 | x.drop([&quot;a&quot;], axis=1, inplace=True)
  |
  = help: Assign to variable; remove `inplace` arg

ℹ Suggested fix
2 2 | 
3 3 | x = pd.DataFrame()
4 4 | 
5   |-x.drop([&quot;a&quot;], axis=1, inplace=True)
  5 |+x = x.drop([&quot;a&quot;], axis=1)
6 6 | 
7 7 | x.drop([&quot;a&quot;], axis=1, inplace=True)
8 8 | 

PD002.py:7:23: PD002 [*] `inplace=True` should be avoided; it has inconsistent behavior
   |
 7 | x.drop([&quot;a&quot;], axis=1, inplace=True)
 8 | 
 9 | x.drop([&quot;a&quot;], axis=1, inplace=True)
   |                       ^^^^^^^^^^^^ PD002
10 | 
11 | x.drop(
   |
   = help: Assign to variable; remove `inplace` arg

ℹ Suggested fix
4 4 | 
5 5 | x.drop([&quot;a&quot;], axis=1, inplace=True)
6 6 | 
7   |-x.drop([&quot;a&quot;], axis=1, inplace=True)
  7 |+x = x.drop([&quot;a&quot;], axis=1)
8 8 | 
9 9 | x.drop(
10 10 |     inplace=True,

PD002.py:10:5: PD002 [*] `inplace=True` should be avoided; it has inconsistent behavior
   |
10 | x.drop(
11 |     inplace=True,
   |     ^^^^^^^^^^^^ PD002
12 |     columns=[&quot;a&quot;],
13 |     axis=1,
   |
   = help: Assign to variable; remove `inplace` arg

ℹ Suggested fix
6  6  | 
7  7  | x.drop([&quot;a&quot;], axis=1, inplace=True)
8  8  | 
9     |-x.drop(
10    |-    inplace=True,
   9  |+x = x.drop(
11 10 |     columns=[&quot;a&quot;],
12 11 |     axis=1,
13 12 | )

PD002.py:17:9: PD002 [*] `inplace=True` should be avoided; it has inconsistent behavior
   |
17 | if True:
18 |     x.drop(
19 |         inplace=True,
   |         ^^^^^^^^^^^^ PD002
20 |         columns=[&quot;a&quot;],
21 |         axis=1,
   |
   = help: Assign to variable; remove `inplace` arg

ℹ Suggested fix
13 13 | )
14 14 | 
15 15 | if True:
16    |-    x.drop(
17    |-        inplace=True,
   16 |+    x = x.drop(
18 17 |         columns=[&quot;a&quot;],
19 18 |         axis=1,
20 19 |     )

PD002.py:22:33: PD002 [*] `inplace=True` should be avoided; it has inconsistent behavior
   |
22 |     )
23 | 
24 | x.drop([&quot;a&quot;], axis=1, **kwargs, inplace=True)
   |                                 ^^^^^^^^^^^^ PD002
25 | x.drop([&quot;a&quot;], axis=1, inplace=True, **kwargs)
26 | f(x.drop([&quot;a&quot;], axis=1, inplace=True))
   |
   = help: Assign to variable; remove `inplace` arg

ℹ Suggested fix
19 19 |         axis=1,
20 20 |     )
21 21 | 
22    |-x.drop([&quot;a&quot;], axis=1, **kwargs, inplace=True)
   22 |+x = x.drop([&quot;a&quot;], axis=1, **kwargs)
23 23 | x.drop([&quot;a&quot;], axis=1, inplace=True, **kwargs)
24 24 | f(x.drop([&quot;a&quot;], axis=1, inplace=True))
25 25 | 

PD002.py:23:23: PD002 `inplace=True` should be avoided; it has inconsistent behavior
   |
23 | x.drop([&quot;a&quot;], axis=1, **kwargs, inplace=True)
24 | x.drop([&quot;a&quot;], axis=1, inplace=True, **kwargs)
   |                       ^^^^^^^^^^^^ PD002
25 | f(x.drop([&quot;a&quot;], axis=1, inplace=True))
   |

PD002.py:24:25: PD002 `inplace=True` should be avoided; it has inconsistent behavior
   |
24 | x.drop([&quot;a&quot;], axis=1, **kwargs, inplace=True)
25 | x.drop([&quot;a&quot;], axis=1, inplace=True, **kwargs)
26 | f(x.drop([&quot;a&quot;], axis=1, inplace=True))
   |                         ^^^^^^^^^^^^ PD002
   |

PD002.py:38:52: PD002 [*] `inplace=True` should be avoided; it has inconsistent behavior
   |
38 |     # it works! #2605
39 |     grouped = df.groupby([&quot;name&quot;, &quot;name2&quot;])
40 |     grouped.apply(lambda x: x.sort_values(&quot;value&quot;, inplace=True))
   |                                                    ^^^^^^^^^^^^ PD002
   |
   = help: Assign to variable; remove `inplace` arg

ℹ Suggested fix
35 35 | 
36 36 |     # it works! #2605
37 37 |     grouped = df.groupby([&quot;name&quot;, &quot;name2&quot;])
38    |-    grouped.apply(lambda x: x.sort_values(&quot;value&quot;, inplace=True))
   38 |+    grouped.apply(lambda x: x = x.sort_values(&quot;value&quot;))
</code></pre>
<p>Source with fixes applied</p>
<pre><code class="language-py">def test_apply_no_name_column_conflict():
    df = DataFrame(
        {
            &quot;name&quot;: [1, 1, 1, 1, 1, 1, 2, 2, 2, 2],
            &quot;name2&quot;: [0, 0, 0, 1, 1, 1, 0, 0, 1, 1],
            &quot;value&quot;: range(9, -1, -1),
        }
    )

    # it works! #2605
    grouped = df.groupby([&quot;name&quot;, &quot;name2&quot;])
    grouped.apply(lambda x: x = x.sort_values(&quot;value&quot;))
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @MichaReiser on 2023-05-08 12:26</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2023-05-08 12:58</div>
            <div class="timeline-body"><p>Right! <code>lambda</code> expressions can't have assignment statements. This should be an easy fix :)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-05-08 12:59</div>
            <div class="timeline-body"><p>We definitely have guards against this somewhere else (to avoid fixes that convert expressions-to-statements when within an expression)... Maybe the rule that converts lambdas to function definitions, in Pyflakes?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2023-05-08 13:04</div>
            <div class="timeline-body"><p>My first thought was to <em>just</em> remove the <code>inplace = True</code> and <em>not</em> add the assignment when inside a <code>lambda</code> scope. The reason being that when <code>inplace</code> is <code>True</code> the function will return <code>None</code>, while in the other case it'll return a new object. As <code>lambda</code> expressions return whatever they evaluate, I thought the above solution would make sense.</p>
<p>Do we want to continue with that or just avoid to fix?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-05-08 14:11</div>
            <div class="timeline-body"><p>I think we should just avoid the fix, since merely removing <code>inplace = True</code> could lead to unintended changes in code behavior.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2023-05-08 18:24</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 16:47:08 UTC
    </footer>
</body>
</html>
