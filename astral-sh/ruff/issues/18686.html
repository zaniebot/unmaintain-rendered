<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>F401 autofix (adding import to `__all__`) should be unsafe - astral-sh/ruff #18686</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>F401 autofix (adding import to <code>__all__</code>) should be unsafe</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/ruff/issues/18686">#18686</a>
        opened by <a href="https://github.com/robsdedude">@robsdedude</a>
        on 2025-06-15 16:37
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/robsdedude">@robsdedude</a> on 2025-06-15 16:37</div>
            <div class="timeline-body"><h3>Summary</h3>
<p>The docs state</p>
<blockquote>
<h3><a href="https://docs.astral.sh/ruff/linter/#fix-safety">Fix safety</a></h3>
<p>Ruff labels fixes as &quot;safe&quot; and &quot;unsafe&quot;. The meaning and intent of your code will be retained when applying safe fixes, but the meaning could change when applying unsafe fixes.</p>
</blockquote>
<p><code>F401</code>'s autofix will add unused (first-party) imports to <code>__all__</code> and consider that a safe fix. I argue it's unsafe. It caught me multiple times off-guard where I just forgot to also delete the import after restructuring a package.</p>
<pre><code class="language-python">from ._foo import BarOld as _BarOld
from ._foo import Bar

__all__ = [
    &quot;Bar&quot;,
]

def __getattr__(name):
    if name in {&quot;BarOld&quot;}:  # actual code has more than just one name here
        import warnings
        warnings.warn(&quot;don't&quot;, category=DeprecationWarning, stack_level=2)
        return globals[f&quot;_{name}&quot;]
</code></pre>
<p>I'm absolutely fine with ruff not understanding the <code>globals</code> magic and am happy to slap a <code>noqa: F401</code> on the import, that's not the issue.
But exposing <code>_BarOld</code> (as the fix adds it to <code>__all__</code> is really not my intention or what I meant. So for such use-cases, the fix is not safe.</p>
<p>Even if I were to omit the <code>globals</code> access and spell out <code>return _BarOld</code> instead, it's fine for now until I decide to turn the deprecation into a removal. Removing the branch in <code>__getattr__</code> will leave me again with the same fix that's considered safe, whereas in reality I've just forgotten to remove the import.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntBre">@ntBre</a> on 2025-06-15 17:12</div>
            <div class="timeline-body"><p>Hmm, I wonder if we should avoid adding imports with an underscore prefix to <code>__all__</code> in general. Otherwise I think it could make sense just to make the fix always unsafe in <code>__init__.py</code> files. There's currently some pretty complicated logic for deciding if it's safe or not:</p>
<p>https://github.com/astral-sh/ruff/blob/e4423044f8abc139b33f8f56061d03692ca2cc5f/crates/ruff_linter/src/rules/pyflakes/rules/unused_import.rs#L279-L290</p>
<p>We also mentioned skipping a related rule in the presence of a <code>__getattr__</code> function recently, which could be relevant here too: https://github.com/astral-sh/ruff/issues/18504.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-06-16 06:25</div>
            <div class="timeline-body"><p>Isn't this less about fix safety but more that we can't tell what the user intentions are in case of an unused import with an <code>__all__</code>? The import could be a leftover from a refactor and now indeed be unused or it was intended to be exportet and should be added to <code>__all__</code>. But Ruff simply can't know and shouldn't provide safe fix.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntBre">@ntBre</a> on 2025-06-16 14:20</div>
            <div class="timeline-body"><blockquote>
<p>Isn't this less about fix safety but more that we can't tell what the user intentions are in case of an unused import with an <code>__all__</code>? The import could be a leftover from a refactor and now indeed be unused or it was intended to be exportet and should be added to <code>__all__</code>. But Ruff simply can't know and shouldn't provide safe fix.</p>
</blockquote>
<p>Yeah, I think that's right. It's ambiguous what the user intended. Did you mean we shouldn't provide a fix at all there at the end? I think that could make sense too, or maybe a display-only fix that could be applied in an editor.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-06-16 17:16</div>
            <div class="timeline-body"><p>I mainly changed the reasoning for the fix safety. I don't think it's not safe because it breaks code in anyway. It's mainly that ruff doesn't know what the user wants.</p>
<p>I don't remember. Are manual fixes shown in vs code?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntBre">@ntBre</a> on 2025-06-16 17:32</div>
            <div class="timeline-body"><p>Oh I see what you mean, I misunderstood.</p>
<p>And yes, it looks like <code>DisplayOnly</code> fixes are shown in VS Code. I tested with UP049:</p>
<p>https://github.com/astral-sh/ruff/blob/c5b58187da1809c778d886595ec50f7db68fd3b9/crates/ruff_linter/src/rules/pyupgrade/rules/pep695/private_type_parameter.rs#L156-L163</p>
<p><img src="https://github.com/user-attachments/assets/be10c114-cc55-4599-b1aa-5fc66869096e" alt="Image" /></p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 11:37:42 UTC
    </footer>
</body>
</html>
