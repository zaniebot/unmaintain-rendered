```yaml
number: 19132
title: Unsafe fix from PERF401
type: issue
state: open
author: corrylc
labels:
  - documentation
  - preview
assignees: []
created_at: 2025-07-03T21:28:31Z
updated_at: 2025-07-04T13:09:10Z
url: https://github.com/astral-sh/ruff/issues/19132
synced_at: 2026-01-10T01:56:57Z
```

# Unsafe fix from PERF401

---

_Issue opened by @corrylc on 2025-07-03 21:28_

### Summary

PERF401 (manual-list-comprehension) produces an unsafe fix, introducing a test failure.

The fix changes a for-loop into a list comprehension, but due to the expected exception from the generator the result is not the same from the "fixed" code. The list comprehension throws the exception before updating the `chunks` list, unlike the original code which will update it as it goes.

Original code:

```python
    gen = _generate_request_body(receive)
    chunks: list[bytes] = []
    with pytest.raises(ClientDisconnectError):
        async for chunk in gen:
            chunks.append(chunk)
```

After `ruff check`:

```python
    gen = _generate_request_body(receive)
    chunks: list[bytes] = []
    with pytest.raises(ClientDisconnectError):
        chunks.extend([chunk async for chunk in gen])
```

### Version

ruff 0.12.1

---

_Comment by @ntBre on 2025-07-03 22:13_

The fix for `PERF401` should already be marked as unsafe, so this is arguably expected or at least allowed behavior. I see that we still don't have a `## Fix safety` section in the docs, though, so we should fix that and mention a case like this at least.

---

_Label `preview` added by @ntBre on 2025-07-03 22:13_

---

_Label `documentation` added by @ntBre on 2025-07-03 22:13_

---

_Comment by @MeGaGiGaGon on 2025-07-03 22:15_

Standalone reproduction: https://play.ruff.rs/0f94c04a-46fd-47df-91e5-4da7b0489bba
<details>
<summary>Testing it locally</summary>

```
PS ~\Desktop\New_folder\ruff>Set-Content issue.py @"
```
```py
import asyncio
async def async_range(limit):
    for i in range(limit):
        if i == 3:
            raise ValueError
        yield i

async def main():
    chunks = []
    try:
        async for x in async_range(5):
            chunks.append(x)
    except ValueError:
        pass
    print(chunks)
asyncio.run(main())
```
```
"@
```
```
PS ~\Desktop\New_folder\ruff>py issue.py
```
```
[0, 1, 2]
```
```
PS ~\Desktop\New_folder\ruff>uvx ruff check issue.py --isolated --select PERF --preview --fix --unsafe-fixes
```
```
Found 1 error (1 fixed, 0 remaining).
```
```
PS ~\Desktop\New_folder\ruff>Get-Content issue.py
```
```py
import asyncio
async def async_range(limit):
    for i in range(limit):
        if i == 3:
            raise ValueError
        yield i

async def main():
    chunks = []
    try:
        chunks.extend([x async for x in async_range(5)])
    except ValueError:
        pass
    print(chunks)
asyncio.run(main())
```
```
PS ~\Desktop\New_folder\ruff>py issue.py
```
```
[]
```

</details>

The fix comes from here. The comment is partially wrong, it should say "async_generators" instead of "generators", but that's the reason for the `[]`. This shouldn't be an issue in the normal case since there's no `[]` needed.
https://github.com/astral-sh/ruff/blob/333191b7f7d78473a4ee88f6a24e199b29b01070/crates/ruff_linter/src/rules/perflint/rules/manual_list_comprehension.rs#L427-L432

---

_Comment by @ntBre on 2025-07-03 22:19_

Hmm, maybe it shouldn't apply to async generators? I'm definitely open to considering it a bug rather than just unsafety. It feels borderline to me at the moment.

---

_Comment by @MeGaGiGaGon on 2025-07-03 22:45_

> The fix for `PERF401` should already be marked as unsafe, so this is arguably expected or at least allowed behavior. I see that we still don't have a `## Fix safety` section in the docs, though, so we should fix that and mention a case like this at least.

This is mentioned in [#15584](https://github.com/astral-sh/ruff/issues/15584#issuecomment-2988951082), and I have looked at it, but the main issue I've run into is I'm not sure why the fix is blanket unsafe. Assuming this doesn't happen, and there's no comment deletion, and the target is properly verified to be a list, I don't see why the fix isn't safe.

---

_Comment by @ntBre on 2025-07-04 13:09_

> This is mentioned in [#15584](https://github.com/astral-sh/ruff/issues/15584#issuecomment-2988951082), and I have looked at it, but the main issue I've run into is I'm not sure why the fix is blanket unsafe. Assuming this doesn't happen, and there's no comment deletion, and the target is properly verified to be a list, I don't see why the fix isn't safe.

I haven't thought too deeply about this case, but making a fix sometimes safe is definitely a viable outcome of working on #15584. We've had a couple of cases like that already. The conditions you mention sound reasonable for a safe fix, we'd just need to add it in preview since the rule is stable.


---
