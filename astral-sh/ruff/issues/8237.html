<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>☂️ Formatter: Support formatting of embedded code - astral-sh/ruff #8237</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>☂️ Formatter: Support formatting of embedded code</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/ruff/issues/8237">#8237</a>
        opened by <a href="https://github.com/MichaReiser">@MichaReiser</a>
        on 2023-10-26 02:56
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-10-26 02:56</div>
            <div class="timeline-body"><p>Support formatting Python code embedded in other languages like:</p>
<ul>
<li>Markdown</li>
<li>reStructuredText</li>
<li>HTML</li>
<li>...</li>
</ul>
<p>The goal of this issue is not that we implement support for all these languages but to build up the infrastructure to run ruff (at least the formatter) on files that contain embedded python code and format it. Ideally, the infrastructure would, in the future, allow us to support arbitrary nesting:</p>
<ul>
<li>Format SQL in Python</li>
<li>Format Markdown in Python</li>
<li>...</li>
</ul>
<p>Prettier and JetBrains code formatter do an excellent job at this.</p>
<p>Related:</p>
<ul>
<li>https://github.com/astral-sh/ruff/issues/7146</li>
<li>https://github.com/astral-sh/ruff/issues/3792</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">formatter</span> added by @MichaReiser on 2023-10-26 02:56</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">wish</span> added by @MichaReiser on 2023-10-26 02:56</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "☂️ Format Python code embedded in other languages" to "☂️ Formatter: Support formatting of embedded code" by @MichaReiser on 2023-10-26 02:58</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2023-10-26 03:10</div>
            <div class="timeline-body"><blockquote>
<p>The goal of this issue is not that we implement support for all these languages but to build up the infrastructure to run ruff (at least the formatter) on files that contain embedded python code and format it.</p>
</blockquote>
<p>I think we should keep the linter in mind while designing the infrastructure as, and I'm not 100% sure but it's mainly my intuition from working on the Notebook support, it's more than likely than we get the formatter support for <em>free</em>. Free in the sense that it'll require considerably less effort on the formatter side once the infrastructure is in place.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-10-26 03:14</div>
            <div class="timeline-body"><p>I agree, but I wanted to keep this issue scoped. The linter and formatter likely have similar requirements and need similar infrastructure, but with slight nuances.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ddelange">@ddelange</a> on 2023-10-26 06:41</div>
            <div class="timeline-body"><p>potential duplicate of https://github.com/astral-sh/ruff/issues/3792</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/henryiii">@henryiii</a> on 2023-10-26 16:25</div>
            <div class="timeline-body"><p>https://github.com/adamchainz/blacken-docs does this with black and markdown, ReST, and LaTeX. You can see the block types supported there. (python, pycon, etc). Even better, maybe  the block types could be configurable, say setting <code>md-blocks = [&quot;python&quot;, &quot;ipython&quot;, &quot;{code-cell} ipython3&quot;]</code> would allow you to run on python, ipython, and executable Python (see https://jupyterbook.org/en/stable/file-types/myst-notebooks.html).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/KelSolaar">@KelSolaar</a> on 2024-01-29 04:44</div>
            <div class="timeline-body"><p>Hello,</p>
<p>I would be keen to see doctests formatting, e.g.:</p>
<pre><code class="language-python">def least_square_mapping_MoorePenrose(
    y: ArrayLike, x: ArrayLike
) -&gt; NDArrayFloat:
    &quot;&quot;&quot;
    Compute the *least-squares* mapping from dependent variable :math:`y` to
    independent variable :math:`x` using *Moore-Penrose* inverse.

    Parameters
    ----------
    y
        Dependent and already known :math:`y` variable.
    x
        Independent :math:`x` variable(s) values corresponding with :math:`y`
        variable.

    Returns
    -------
    :class:`numpy.ndarray`
        *Least-squares* mapping.

    References
    ----------
    :cite:`Finlayson2015`

    Examples
    --------
    &gt;&gt;&gt; prng = np.random.RandomState(2)
    &gt;&gt;&gt; y = prng.random_sample((24, 3))
    &gt;&gt;&gt; x = y + (    prng.random_sample(    (24, 3)) - 0.5) * 0.5
    &gt;&gt;&gt; least_square_mapping_MoorePenrose(y, x)  # doctest: +ELLIPSIS
    array([[ 1.0526376...,  0.1378078..., -0.2276339...],
           [ 0.0739584...,  1.0293994..., -0.1060115...],
           [ 0.0572550..., -0.2052633...,  1.1015194...]])
    &quot;&quot;&quot;

    y = np.atleast_2d(y)
    x = np.atleast_2d(x)

    return np.dot(np.transpose(x), np.linalg.pinv(np.transpose(y)))
</code></pre>
<p><em>Ruff</em> currently does not format anything inside <code>&gt;&gt;&gt;</code> and <code>...</code> in docstrings. I managed to drop <em>Black</em> and replace it with <em>Ruff</em> but I still depend on <em>adamchainz/blacken-docs</em>.</p>
<p>Cheers,</p>
<p>Thomas</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-01-29 07:25</div>
            <div class="timeline-body"><p>Hey @KelSolaar</p>
<p>Docstring code block formatting is supported but off by default. You can enable it in your settings using <a href="https://docs.astral.sh/ruff/settings/#format-docstring-code-format"><code>format.docstring-code-format = true</code></a></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/KelSolaar">@KelSolaar</a> on 2024-01-29 07:42</div>
            <div class="timeline-body"><p>Hi @MichaReiser,</p>
<p>I have it enabled but it does not seem to format the above.</p>
<p>Cheers,</p>
<p>Thomas</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-01-29 08:22</div>
            <div class="timeline-body"><p>@KelSolaar</p>
<p>The issue is that</p>
<pre><code class="language-python">array([[ 1.0526376...,  0.1378078..., -0.2276339...],
           [ 0.0739584...,  1.0293994..., -0.1060115...],
           [ 0.0572550..., -0.2052633...,  1.1015194...]])
</code></pre>
<p>is not valid python syntax (because of the <code>...</code>). The formatter can only format examples that are valid python.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/KelSolaar">@KelSolaar</a> on 2024-01-29 08:30</div>
            <div class="timeline-body"><p>Right I see! So this particular code output is used as a <a href="https://docs.python.org/3/library/doctest.html">doctest</a> where any whitespace counts so it should NOT be formatted, ever. Ruff formatter should ignore those outputs fully which is what <code>adamchainz/blacken-docs</code> does. Hope it does make sense!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/KelSolaar">@KelSolaar</a> on 2024-01-29 18:36</div>
            <div class="timeline-body"><p>For that specific case, Ruff should only consider docstring lines starting with either <code>&gt;&gt;&gt;</code> or <code>...</code>. There might be some subtleties and I would check the doctests parser to confirm but it is the main idea.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/henryiii">@henryiii</a> on 2024-01-29 19:46</div>
            <div class="timeline-body"><p>That example should use the <a href="https://pygments.org/docs/lexers/#pygments.lexers.python.PythonConsoleLexer"><code>pycon</code> lexer</a> (similar to how &quot;console&quot; is used for console input with <code>$</code>/<code>#</code>). Anything in the <code>python</code> language should be valid Python and formatted, so I think Ruff is doing the right thing trying to format it (and failing). Supporting pycon and formatting the &quot;python&quot; parts would be nice, though! (Note that <code>pycon</code> is supported elsewhere, including in markdown like here on GitHub)</p>
<p>If no language is given (such code with a 4-space indent), I think it should be treated as whatever the default is (which IIRC might be Python).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ddelange">@ddelange</a> on 2024-01-29 20:06</div>
            <div class="timeline-body"><p>corresponding <a href="https://sphinxcontrib-napoleon.readthedocs.io/en/latest/">google-style</a> doctest:</p>
<pre><code class="language-py">def least_square_mapping_MoorePenrose(
    y: ArrayLike, x: ArrayLike
) -&gt; NDArrayFloat:
    &quot;&quot;&quot;
    Compute the *least-squares* mapping from dependent variable :math:`y` to
    independent variable :math:`x` using *Moore-Penrose* inverse.

    Examples:
        &gt;&gt;&gt; prng = np.random.RandomState(2)
        &gt;&gt;&gt; y = prng.random_sample((24, 3))
        &gt;&gt;&gt; x = y + (    prng.random_sample(    (24, 3)) - 0.5) * 0.5
        &gt;&gt;&gt; least_square_mapping_MoorePenrose(y, x)  # doctest: +ELLIPSIS
        array([[ 1.0526376...,  0.1378078..., -0.2276339...],
               [ 0.0739584...,  1.0293994..., -0.1060115...],
               [ 0.0572550..., -0.2052633...,  1.1015194...]])
    &quot;&quot;&quot;

    y = np.atleast_2d(y)
    x = np.atleast_2d(x)

    return np.dot(np.transpose(x), np.linalg.pinv(np.transpose(y)))
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/aneeshusa">@aneeshusa</a> on 2024-03-04 23:10</div>
            <div class="timeline-body"><p>+1 to this - beyond <code>blacken-docs</code>, <code>shed</code> which I'm currently switching from has this feature too!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/paddyroddy">@paddyroddy</a> on 2025-11-03 15:26</div>
            <div class="timeline-body"><blockquote>
<p>potential duplicate of <a href="https://github.com/astral-sh/ruff/issues/3792">#3792</a></p>
</blockquote>
<p>I would say it was. I made that issue for this same desired feature.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 11:31:44 UTC
    </footer>
</body>
</html>
