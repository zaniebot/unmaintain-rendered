<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>formats `assert f(a,) == (b)` and `assert f(a,) == b` very differently - astral-sh/ruff #15842</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>formats <code>assert f(a,) == (b)</code> and <code>assert f(a,) == b</code> very differently</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/ruff/issues/15842">#15842</a>
        opened by <a href="https://github.com/rdaysky">@rdaysky</a>
        on 2025-01-31 01:43
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/rdaysky">@rdaysky</a> on 2025-01-31 01:43</div>
            <div class="timeline-body"><h3>Description</h3>
<p>ruff format transforms</p>
<pre><code>assert f(a,) == (b)
assert f(a,) == b
</code></pre>
<p>into</p>
<pre><code>assert f(
    a,
) == (b)
assert (
    f(
        a,
    )
    == b
)
</code></pre>
<p>which doesn’t make too much sense.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2025-01-31 04:11</div>
            <div class="timeline-body"><p>Thanks for the report. Can you say why it doesn't make sense?</p>
<p>@MichaReiser will be able to provide more context on why this is the case but he's currently on leave and will be able to reply next week.</p>
<p>Regardless, it matches what Black does https://black.vercel.app/?version=main&amp;state=_Td6WFoAAATm1rRGAgAhARYAAAB0L-Wj4ACpAGFdAD2IimZxl1N_WlPTQ06-Nur1lMjjikbZBUWzXuAQNKhFphrTQvWGzojFvt24KBUXaI3nTaBMACVKkaNvMxbDMiDTeDauQNv4yFlbtT0lJmLmdtWcjJOxsFmoi2ajLXi1CwAAAAAAM4BGDhyTg2EAAX2qAQAAAJAqwvaxxGf7AgAAAAAEWVo%3D</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">question</span> added by @dhruvmanila on 2025-01-31 04:11</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">formatter</span> added by @dhruvmanila on 2025-01-31 04:11</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/rdaysky">@rdaysky</a> on 2025-02-03 00:54</div>
            <div class="timeline-body"><p>It doesn’t make sense for two reasons:</p>
<ol>
<li>Why should a short expression and the same expression but parenthesized behave differently?</li>
<li>Why should outer parentheses appear when the expression can be satisfactorily formatted without them?</li>
</ol>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2025-02-03 03:42</div>
            <div class="timeline-body"><p>I think one part of the reason is the trailing comma that's present in the function call arguments. That indicates the formatter to break the expression, even though it might short and under the configured line length, into multiple lines and keep them as multiline expression. You can opt-out of this behavior by setting <a href="https://docs.astral.sh/ruff/settings/#format_skip-magic-trailing-comma"><code>format.skip-magic-trailing-comma</code></a> to <code>true</code>. Refer to the <a href="https://play.ruff.rs/372ce9ec-23fe-42ed-9b23-487eb1b474c2">playground</a> to checkout this behavior.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/rdaysky">@rdaysky</a> on 2025-02-03 12:23</div>
            <div class="timeline-body"><p>But the magic trailing comma is an immensely useful parameter that can’t be turned off without major impact on the rest of the code.</p>
<p>In any case, the magic comma in <code>assert f(a,) == b</code> should insert newlines around <code>a</code>, not around <code>b</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">question</span> removed by @MichaReiser on 2025-02-03 13:19</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">style</span> added by @MichaReiser on 2025-02-03 13:19</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-02-03 13:19</div>
            <div class="timeline-body"><p>What you see here is also not specific to <code>assert</code>; you can observe the same in any clause header (<code>if,</code> <code>while,</code> <code>match</code> ...) <a href="https://play.ruff.rs/adda069e-1846-41e8-a9f0-ec8b38be85cd">playground</a></p>
<p>Specifically, Ruff supports two layouts for clause headers (which are also used for assert conditions):</p>
<ol>
<li>A layout that avoids adding parentheses around the condition and instead breaks after existing parentheses (<code>[</code>, <code>{</code>, <code>(</code>). This is what you see for <code>assert f(a,) == (b)</code>. However, this layout is only applied if the parentheses are at the very right (or very start</li>
<li>If the parentheses aren't at the very start (which isn't for calls because the leftmost part is an identifier), then Ruff/Black parenthesizes the entire expression instead. You see this for <code>f(a,) = b</code> because it neither starts nor ends with parentheses.</li>
</ol>
<p>You can also see this if you flip the operands:</p>
<pre><code class="language-py">assert f(a,) == b
assert b == f(a, )
</code></pre>
<p>The code for this can be found here:</p>
<p>https://github.com/astral-sh/ruff/blob/f3b918de95f9bea0a9ab42587f09547bf6ffdb0b/crates/ruff_python_formatter/src/expression/mod.rs#L527-L610</p>
<p>The layout 1 exists to avoid unnecessary parentheses in common cases and it obviously don't pick the ideal solution in this case. However, this is also a very trivial example where the parentheses around <code>b</code> are unnecessary. Respecting the parentheses is useful because you normally want to keep the parenthesized expressions together</p>
<pre><code class="language-python">assert f(
    a,
) == (
    aaaaaaaaaaaaaa
    and bbbbbbbbbbbbbb
    and cccccccccccc
    and dddddddddddddddddd
    and eeeeeeeeeeee
)
assert f(
    a,
) == (aaaaaaaaaaaaaa and bbbbbbbbbbbbbb and cccccccccccc and dddddddddddddddddd)
</code></pre>
<p>I do agree that there's some room for improvement here so I'll keep the issue open but I don't expect to change this anytime soon because changing this behavior is a fairly significant break with Black's style guide and there are other &quot;bad formattings&quot; that I want to improve first.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/rdaysky">@rdaysky</a> on 2025-02-04 00:56</div>
            <div class="timeline-body"><p>The same issue in Black: https://github.com/psf/black/issues/2581</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 11:36:29 UTC
    </footer>
</body>
</html>
