<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Server diagnostics linger when cell language is changed - astral-sh/ruff #12874</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Server diagnostics linger when cell language is changed</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/ruff/issues/12874">#12874</a>
        opened by <a href="https://github.com/dhruvmanila">@dhruvmanila</a>
        on 2024-08-14 03:11
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a></div>
            <div class="timeline-body"><p>This is related to <a href="https://github.com/astral-sh/ruff/pull/11864">astral-sh/ruff#11864</a> where we assumed that VS Code would always send a <code>textDocument/didClose</code> request when the <code>notebookDocument/didChange</code> request contained a cell deletion change. But, it turns out that is not true. If you change the language of a code cell from Python to any other language, VS Code would only send the <code>notebookDocument/didChange</code> request because the cell was never closed, it was just closed for Ruff (the text document is still present).</p>
<p>For reference, here&#x27;s the request payload sent by VS Code for which there&#x27;s no <code>textDocument/didClose</code> event:</p>
<pre><code>{
    &quot;notebookDocument&quot;: {
        &quot;version&quot;: 0,
        &quot;uri&quot;: &quot;file:///Users/dhruv/work/astral/ruff/crates/ruff_notebook/resources/test/fixtures/jupyter/kernelspec_language.ipynb&quot;
    },
    &quot;change&quot;: {
        &quot;cells&quot;: {
            &quot;structure&quot;: {
                &quot;array&quot;: {
                    &quot;start&quot;: 0,
                    &quot;deleteCount&quot;: 1
                },
                &quot;didClose&quot;: [
                    {
                        &quot;uri&quot;: &quot;vscode-notebook-cell:/Users/dhruv/work/astral/ruff/crates/ruff_notebook/resources/test/fixtures/jupyter/kernelspec_language.ipynb#W1sZmlsZQ%3D%3D&quot;
                    }
                ]
            }
        }
    }
}
</code></pre>
<p>In the video, you can see that initially there are diagnostics from both Ruff and Pylance but as soon as I change the language, diagnostics from Pylance disappear which means it&#x27;s handling it correctly.</p>
<p>https://github.com/user-attachments/assets/76ab3093-e916-4ee4-ba4a-144c9627fb9a</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-08-14 03:11</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">server</span> added by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-08-14 03:11</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">notebook</span> added by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2025-07-08 05:53</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 18:48:56 UTC
    </footer>
</body>
</html>
