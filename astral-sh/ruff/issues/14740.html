<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[red-knot] add narrowing support in match class patterns - astral-sh/ruff #14740</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[red-knot] add narrowing support in match class patterns</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/issues/14740">#14740</a>
        opened by <a href="https://github.com/carljm">@carljm</a>
        on 2024-12-02 18:30
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a></div>
            <div class="timeline-body"><p>The goal of this issue is to make this mdtest pass:</p>
<pre><code class="language-py">def get_bool() -&gt; bool: ...
def get_object() -&gt; object: ...
class A: ...
class B: ...

x = get_object()

reveal_type(x)  # revealed: object

match x:
    case A():
        reveal_type(x)  # revealed: A
    case B():
        reveal_type(x)  # revealed: B

reveal_type(x)  # revealed: object
</code></pre>
<p>This should just require filling in the TODO for <code>MatchClass</code> at https://github.com/astral-sh/ruff/blob/83651deac756db988f3809c21cff9b1535bef1c2/crates/red_knot_python_semantic/src/types/narrow.rs#L232</p>
<p>We don't need to worry about arguments yet; the goal here is just to narrow based on the implicit <code>isinstance</code> check performed by the class pattern.</p>
<p>See https://docs.python.org/3/reference/compound_stmts.html#class-patterns for the documentation of the language feature.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by @carljm on 2024-12-02 18:30</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @carljm by @carljm on 2024-12-02 18:30</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a> on 2024-12-07 21:27</div>
            <div class="timeline-body"><p>I looked into this and got a major block:</p>
<pre><code class="language-rust">match pattern.pattern(self.db).node() {
    // ...
    ast::Pattern::MatchClass(PatternMatchClass { cls, .. }) =&gt; {
        let inference = infer_scope_types(self.db, self.scope());  // This panics.
    }
    // ...
}
</code></pre>
<p>The last logged message is <code>Box&lt;dyn Any&gt;</code>.</p>
<p>The problem appears to be reproducible with just:</p>
<pre><code class="language-markdown">```py
x = object()

match x:
    case int():
        x  # Or any name
```
</code></pre>
<p><a href="https://github.com/astral-sh/ruff/blob/269e47be961d3eb95c0351e8f7006b71e083a6a4/crates/red_knot_python_semantic/src/types/narrow.rs#L464">This comment</a> seems relevant:</p>
<pre><code class="language-rust">// SAFETY: we should always have a symbol for every Name node.
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2024-12-09 21:20</div>
            <div class="timeline-body"><p>The inscrutable <code>Box&lt;dyn Any&gt;</code> error message indicates a Salsa query cycle. In this case it would be due to calling <code>infer_scope_types</code> in type narrowing, when in turn type narrowing may well have been called by <code>infer_scope_types</code> on that same scope.</p>
<p>For expressions that function as narrowing predicates, we will usually need to add them as standalone expressions when building the semantic index, so we can query their type independently. Though since match patterns don't use <code>Expr</code> but rather <code>ComparableExpr</code>, this will probably require adding some new infrastructure for standalone ComparableExpr.</p>
<p>(Note this task is assigned to me, it's not up-for-grabs at the moment.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sharkdp">@sharkdp</a> on 2024-12-11 19:27</div>
            <div class="timeline-body"><p>Just a quick note that I touched some of the relevant code in #14759. So maybe contact me before starting with this task (in case #14759 has not been merged in the meantime).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @dcreager by @dcreager on 2024-12-31 14:41</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Unassigned @carljm by @dcreager on 2024-12-31 14:41</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @carljm on 2025-01-09 17:49</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 16:51:43 UTC
    </footer>
</body>
</html>
