<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Improve f-string error recovery within list parsing - astral-sh/ruff #11946</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Improve f-string error recovery within list parsing</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/ruff/issues/11946">#11946</a>
        opened by <a href="https://github.com/dhruvmanila">@dhruvmanila</a>
        on 2024-06-20 03:33
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a></div>
            <div class="timeline-body"><p>F-string error recovery within list parsing is good but it breaks when it&#x27;s within a parenthesized context.</p>
<p>For example,</p>
<pre><code>bad_function_call(
    param1=f&#x27;test
    param2=&#x27;test&#x27;
)
</code></pre>
<p>The re-lexing will reduce the nesting level when recovering from an unclosed f-string but the lexer isn&#x27;t in an expression element so the nesting level it reduced is the one from the outer context. This means that it&#x27;ll emit an <code>Indent</code> token before <code>param2</code> which is incorrect.</p>
<p>Another example is when the parser is recovering from within a format spec,</p>
<pre><code>bad_function_call(
    param1=f&#x27;test{x:.3f,
    param2=&#x27;test&#x27;
)
</code></pre>
<p>Here, the parser uses the same list parsing logic for parsing both the outer f-string elements and the ones in the format specifier. This means that when it tries to recover from an unclosed f-string, it reduces the nesting level twice (1) when re-lexing from the format spec and (2) when re-lexing from the outer f-string.</p>
Todo
<ul>
<li>[ ] Reduce the nesting level only if the parser is recovering from within an expression element of an f-string (<code>fstring.is_in_expression</code>)</li>
<li>[ ] Avoid calling into re-lexing when recovering from the format specifier. Let the recovery from the outer context (f-string) take care of that.</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">parser</span> added by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-06-20 03:34</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-06-20 03:56</div>
            <div class="timeline-body"><p>(1) is difficult because by the time we&#x27;re re-lexing, the f-string context is no longer on the stack because the lexer removed it when encountering a newline character. Another potential reason to do <a href="https://github.com/astral-sh/ruff/issues/11916">astral-sh/ruff#11916</a>.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 18:48:54 UTC
    </footer>
</body>
</html>
