<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>`ruff server`: No diagnostics in Neovim - astral-sh/ruff #11022</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>`ruff server`: No diagnostics in Neovim</h1>

    <div class="meta">
        <span class="state state-closed">Closed</span>
        <a href="https://github.com/astral-sh/ruff/issues/11022">#11022</a>
        opened by <a href="https://github.com/MithicSpirit">@MithicSpirit</a>
        on 2024-04-19 02:14
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/MithicSpirit">@MithicSpirit</a> on 2024-04-19 02:14</div>
            <div class="timeline-body"><h2>Description</h2>
<p>When using <code>ruff server</code>, there appear to be no diagnostics in Neovim (although other features work as expected). This issue is not reflected in <code>ruff_lsp</code>.</p>
<h2>Minimal example</h2>
<p>I have been able to reproduce the following in Docker (Arch and Alpine images) after installing neovim, git, and ruff/ruff_lsp (through pipx).</p>
<ol>
<li>Create the file below as <code>repro.lua</code> (basic lazy.nvim MWE template + nvim-lspconfig setup)</li>
<li>Run <code>nvim -u repro.lua</code> to install plugins, then quit after they are installed</li>
<li>Run <code>nvim -u repro.lua test.py</code> and try typing some code that ruff would complain about (no diagnostics; unexpected)</li>
</ol>
<p>As a sanity check, you can also try the following:</p>
<ol start="4">
<li>With the file still open write some code that ruff would have a fix for (e.g.: just <code>import foo</code>), use <code>&lt;Space&gt;ca</code> to open the code actions menu, and select option <code>1</code> to trigger the fix (code is fixed; expected)</li>
<li>Edit <code>repro.lua</code> to change the last line to <code>require('lspconfig').ruff_lsp.setup {}</code> (basically just add the <code>_lsp</code>)</li>
<li>Repeat step 3 (diagnostics appear; expected)</li>
</ol>
<pre><code class="language-lua">-- DO NOT change the paths and don't remove the colorscheme
local root = vim.fn.fnamemodify(&quot;./.repro&quot;, &quot;:p&quot;)

-- set stdpaths to use .repro
for _, name in ipairs({ &quot;config&quot;, &quot;data&quot;, &quot;state&quot;, &quot;cache&quot; }) do
  vim.env[(&quot;XDG_%s_HOME&quot;):format(name:upper())] = root .. &quot;/&quot; .. name
end

-- bootstrap lazy
local lazypath = root .. &quot;/plugins/lazy.nvim&quot;
if not vim.loop.fs_stat(lazypath) then
  vim.fn.system({ &quot;git&quot;, &quot;clone&quot;, &quot;--filter=blob:none&quot;, &quot;https://github.com/folke/lazy.nvim.git&quot;, lazypath, })
end
vim.opt.runtimepath:prepend(lazypath)

-- install plugins
local plugins = {
  &quot;folke/tokyonight.nvim&quot;,
  -- add any other plugins here
  &quot;neovim/nvim-lspconfig&quot;
}
require(&quot;lazy&quot;).setup(plugins, {
  root = root .. &quot;/plugins&quot;,
})

vim.cmd.colorscheme(&quot;tokyonight&quot;)
-- add anything else here
local lspconfig = require('lspconfig')

-- Global mappings.
-- See `:help vim.diagnostic.*` for documentation on any of the below functions
vim.keymap.set('n', '&lt;space&gt;e', vim.diagnostic.open_float)
vim.keymap.set('n', '[d', vim.diagnostic.goto_prev)
vim.keymap.set('n', ']d', vim.diagnostic.goto_next)
vim.keymap.set('n', '&lt;space&gt;q', vim.diagnostic.setloclist)

-- Use LspAttach autocommand to only map the following keys
-- after the language server attaches to the current buffer
vim.api.nvim_create_autocmd('LspAttach', {
  group = vim.api.nvim_create_augroup('UserLspConfig', {}),
  callback = function(ev)
    -- Enable completion triggered by &lt;c-x&gt;&lt;c-o&gt;
    vim.bo[ev.buf].omnifunc = 'v:lua.vim.lsp.omnifunc'

    -- Buffer local mappings.
    -- See `:help vim.lsp.*` for documentation on any of the below functions
    local opts = { buffer = ev.buf }
    vim.keymap.set('n', 'gD', vim.lsp.buf.declaration, opts)
    vim.keymap.set('n', 'gd', vim.lsp.buf.definition, opts)
    vim.keymap.set('n', 'K', vim.lsp.buf.hover, opts)
    vim.keymap.set('n', 'gi', vim.lsp.buf.implementation, opts)
    vim.keymap.set('n', '&lt;C-k&gt;', vim.lsp.buf.signature_help, opts)
    vim.keymap.set('n', '&lt;space&gt;wa', vim.lsp.buf.add_workspace_folder, opts)
    vim.keymap.set('n', '&lt;space&gt;wr', vim.lsp.buf.remove_workspace_folder, opts)
    vim.keymap.set('n', '&lt;space&gt;wl', function()
      print(vim.inspect(vim.lsp.buf.list_workspace_folders()))
    end, opts)
    vim.keymap.set('n', '&lt;space&gt;D', vim.lsp.buf.type_definition, opts)
    vim.keymap.set('n', '&lt;space&gt;rn', vim.lsp.buf.rename, opts)
    vim.keymap.set({ 'n', 'v' }, '&lt;space&gt;ca', vim.lsp.buf.code_action, opts)
    vim.keymap.set('n', 'gr', vim.lsp.buf.references, opts)
    vim.keymap.set('n', '&lt;space&gt;f', function()
      vim.lsp.buf.format { async = true }
    end, opts)
  end,
})
require('lspconfig').ruff.setup {}
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @snowsignal on 2024-04-19 02:15</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">server</span> added by @snowsignal on 2024-04-19 02:15</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @snowsignal by @snowsignal on 2024-04-19 02:15</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-04-19 09:17</div>
            <div class="timeline-body"><p>I think I need to look into this as it might be the new parser which is causing it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-04-19 12:24</div>
            <div class="timeline-body"><p>@MithicSpirit Is it like on any code that the diagnostics aren't visible or is it a specific one? Does it contain syntax errors? Is it possible for you to share a small snippet from it? Are you seeing any error messages while you type?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MithicSpirit">@MithicSpirit</a> on 2024-04-19 14:24</div>
            <div class="timeline-body"><p>@dhruvmanila Seems to be that all diagnostics are not visible on all code. The code I've been using for testing is just the one-liner <code>import foo</code> (which should trigger F401). There are no error messages in the diagnostics, but there are some messages in <code>:LspLog</code>; the following seem relevant.</p>
<pre><code>[ERROR][2024-04-19 14:11:40] .../vim/lsp/rpc.lua:734    &quot;rpc&quot;   &quot;/root/.local/bin/ruff&quot; &quot;stderr&quot;        &quot;   0.001722s DEBUG ruff_server::server No workspace(s) were provided during initialization. Using the current working directory as a default workspace...\n&quot;
[ERROR][2024-04-19 14:11:40] .../vim/lsp/rpc.lua:734    &quot;rpc&quot;   &quot;/root/.local/bin/ruff&quot; &quot;stderr&quot;        &quot;   0.174506s WARN ruff_server::server LSP client does not support dynamic capability registration - automatic configuration reloading will not be available.\n&quot;
[ERROR][2024-04-19 14:12:40] .../vim/lsp/rpc.lua:734    &quot;rpc&quot;   &quot;/root/.local/bin/ruff&quot; &quot;stderr&quot;        &quot;  59.445650s INFO ruff_server::session::workspace::ruff_settings No ruff settings file (pyproject.toml/ruff.toml/.ruff.toml) found for /test.py - falling back to default configuration\n&quot;
</code></pre>
<p>As a side note, there are a lot of messages being printed to stderr that are not error messages (mostly &quot;file changed&quot; notifications), but all of these get picked up as <code>[ERROR]</code>s by Neovim. Maybe these should be logged some other way? Not sure how logging is usually done for LSPs.</p>
<p>EDIT: just tried doing this inside another project (tried with https://github.com/pandas-dev/pandas because why not) and the first and third messages (&quot;No workspaces&quot; and &quot;No ruff settings file&quot;) did not appear in <code>:LspLog</code>. The &quot;dynamic capability registration&quot; message still appeared, however.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/bluthej">@bluthej</a> on 2024-04-20 07:36</div>
            <div class="timeline-body"><p>I am experiencing a similar issue with Helix (v24.3), for example:</p>
<ul>
<li>formatting on save works</li>
<li>I can trigger the import sorting code action</li>
</ul>
<p>but the diagnostics don' show up and when I look at the log I have a lot of these messages:</p>
<pre><code>2024-04-20T09:32:13.041 helix_lsp::transport [ERROR] ruff err &lt;- &quot;┘\n&quot;
2024-04-20T09:32:13.190 helix_lsp::transport [ERROR] ruff err &lt;- &quot;┐ruff_server::server::api::notifications::did_change::run{file=file:///home/joffrey/repos/numerical-schemes/main.py}\n&quot;
2024-04-20T09:32:13.190 helix_lsp::transport [ERROR] ruff err &lt;- &quot;┘\n&quot;
2024-04-20T09:32:14.840 helix_lsp::transport [ERROR] ruff err &lt;- &quot;┐ruff_formatter::printer::Printer::print{}\n&quot;
2024-04-20T09:32:14.840 helix_lsp::transport [ERROR] ruff err &lt;- &quot;┘\n&quot;
</code></pre>
<p>I have no idea where all those &quot;┘&quot; are coming from! None of this shows up with <code>ruff-lsp</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/snowsignal">@snowsignal</a> on 2024-04-20 15:16</div>
            <div class="timeline-body"><p>@bluthej I think the &quot;┘&quot; are a side-effect of how we currently log things. Right now, the LSP logs to <code>stderr</code> instead of using the LSP protocol, which is why they appear as <code>[ERROR]</code>s instead of their proper warning level. This will be fixed soon.</p>
<p>I'm currently investigating why diagnostics don't appear in Neovim, and my guess is that the problems you're experiencing in Helix are probably related.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MithicSpirit">@MithicSpirit</a> on 2024-04-20 21:55</div>
            <div class="timeline-body"><p>As per the discussion with @snowsignal on the Discord, the issue appears to be with pull diagnostics. Building the latest Neovim commit from source, which has support therefor, fixes the issue. I think it would be appropriate to document the requirement for pull diagnostics and update the Neovim setup guide to mention 0.10 (not yet released) is required for diagnostics.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/snowsignal">@snowsignal</a> on 2024-04-20 22:00</div>
            <div class="timeline-body"><p>@bluthej This is also why Helix diagnostics don't work yet - pull diagnostics aren't supported by the Helix LSP client yet. There was <a href="https://github.com/helix-editor/helix/pull/7900">a recent pull request to implement them</a>, but unfortunately it's been abandoned.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/11059.html">astral-sh/ruff#11059</a> on 2024-04-20 22:20</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/snowsignal">@snowsignal</a> on 2024-04-20 22:20</div>
            <div class="timeline-body"><p>I've created a new issue to track implementation of <code>publishDiagnostics</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-04-21 05:38</div>
            <div class="timeline-body"><p>Oh wow, good find. I'm always on Neovim nightly which is why I did not see this behavior. Thanks for debugging it! I think we could technically create an integration test, at least for Neovim, to check that certain features work on the latest (two?) stable version.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../LazyVim/LazyVim/pulls/3037.html">LazyVim/LazyVim#3037</a> on 2024-04-24 15:30</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/snowsignal">@snowsignal</a> on 2024-04-29 14:41</div>
            <div class="timeline-body"><p>@MithicSpirit This was fixed in <code>v0.4.2</code>. It should also be fixed for Helix! Let me know if you run into any more issues.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @snowsignal on 2024-04-29 14:41</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:34:52 UTC
    </footer>
</body>
</html>
