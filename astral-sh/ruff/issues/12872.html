<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Import sorting does not (immediately) converge? - astral-sh/ruff #12872</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Import sorting does not (immediately) converge?</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/issues/12872">#12872</a>
        opened by <a href="https://github.com/ax3l">@ax3l</a>
        on 2024-08-13 23:59
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/ax3l">@ax3l</a> on 2024-08-13 23:59</div>
            <div class="timeline-body"><p>Hi,</p>
<p>I am using <code>ruff</code> verison 0.5.6 in <a href="https://github.com/AMReX-Codes/pyamrex">pyAMReX</a> (linter, not the formatter).</p>
<p>I am using <a href="https://pre-commit.com/">pre-commit</a> to update our source code after merge to <code>development</code>. I used <code>black</code> in the past and switched this week, discovering on August 10th and following that <code>ruff</code> creates a lot of rotating changes when run multiple times:
https://github.com/AMReX-Codes/pyamrex/commit/74e076228d4f3d2d6d7ca137610b60b4f91495a5
https://github.com/AMReX-Codes/pyamrex/commit/5dc9c029bacec441ca4484763b34527112408d2b
https://github.com/AMReX-Codes/pyamrex/commit/902c41b012b58fe9479ab6fd414193d9c5f81a97
...
https://github.com/AMReX-Codes/pyamrex/commits/development/</p>
<p>for code of the form</p>
<pre><code class="language-py">from a.b1 import c1
from a.b1 import c1 as cc1
from a.b2 import c2
from a.b3 import c3
</code></pre>
<p>Is there a way to avoid this?</p>
<p>This happens for us on <code>.pyi</code> headers and we intentionally have an alias for some of those imports (for backwards compatibility with a public API change that we are shipping).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "Sorting Issue" to "Import sorting does not (immediately) converge?" by @ax3l on 2024-08-14 00:00</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-08-14 01:11</div>
            <div class="timeline-body"><p>I can take a look.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @charliermarsh by @charliermarsh on 2024-08-14 01:12</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">isort</span> added by @charliermarsh on 2024-08-14 01:12</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-08-14 01:12</div>
            <div class="timeline-body"><p>It's possible that we've just never seen this pattern before and so the sort isn't stable:</p>
<pre><code class="language-python">from amrex.space1d.amrex_1d_pybind import IntVect1D
from amrex.space1d.amrex_1d_pybind import IntVect1D as IntVect
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ax3l">@ax3l</a> on 2024-08-14 01:42</div>
            <div class="timeline-body"><p>Thank you for taking a look. Yes, an unstable isort pattern seems to cause this. I recently switched over to all-<code>ruff</code>ing from isort+black+...</p>
<details>
The pattern here is for backwards compatibility as we face out the `IntVect` type for more explicit versions in our public APIs. Technically, the file that shows this is autogenerated from [pybind11-stubgen](https://github.com/sizmailov/pybind11-stubgen).
This is the line we do to declare the alias: https://github.com/AMReX-Codes/pyamrex/blob/c61add4fd44ad4ec69b131865375d76c68f12b29/src/Base/IntVect.cpp#L185
</details>

</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../AMReX-Codes/pyamrex/pulls/351.html">AMReX-Codes/pyamrex#351</a> on 2024-08-14 01:57</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-08-14 02:53</div>
            <div class="timeline-body"><p>Did you have any sort of configuration set? Like:</p>
<pre><code class="language-toml">[tool.ruff.lint.isort]
force-single-line = true
</code></pre>
<p>The style in those files doesn't match our standard style, so trying to figure out how to reproduce.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">needs-mre</span> added by @MichaReiser on 2024-08-14 06:52</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ax3l">@ax3l</a> on 2024-08-14 14:07</div>
            <div class="timeline-body"><p>No, none of that kind set. I now add &quot;amrex&quot; as known first party module, but that's all I set (no change with or without that option regarding the stability issue).</p>
<p>I just realized I rebaded out the unstable sort commits yesterday in my mainline (using isort again for a stable sort), please let me know if I shall add those again in a feature branch.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-08-14 14:12</div>
            <div class="timeline-body"><p>Okay thanks. I'm just struggling because if I check out <code>858e2a9359c6379782b3f2766e5415ba61be44f2</code> and run <code>ruff check --select I --fix</code>, it completely changes the import style in those files, so I don't think Ruff was run on those commits. Am I misunderstanding?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ax3l">@ax3l</a> on 2024-08-14 15:42</div>
            <div class="timeline-body"><p>That is right, this is the commit just right before I switched from black+isort to ruff.</p>
<p>Here is how I see the issue:</p>
<ol>
<li>I <a href="https://github.com/AMReX-Codes/pyamrex?tab=readme-ov-file#build">build and install</a> the project.</li>
<li>I run <a href="https://github.com/sizmailov/pybind11-stubgen">pybind-stubgen</a> via <a href="https://github.com/AMReX-Codes/pyamrex/blob/development/.github/update_stub.sh">this script</a> to update (recreate) the <code>.pyi</code> files in the repo</li>
<li>I run the ruff linter</li>
</ol>
<p>The last two steps repeated create the unstable result for these imports.</p>
<p>(Automated via <a href="https://github.com/AMReX-Codes/pyamrex/blob/development/.pre-commit-config.yaml">pre-commit rules</a> - I just added <code>isort</code> again at the end for stability - in this <a href="https://github.com/AMReX-Codes/pyamrex/blob/development/.github/workflows/stubs.yml">workflow</a>)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ax3l">@ax3l</a> on 2024-08-14 15:49</div>
            <div class="timeline-body"><p>Example file after step 1 &amp; 2: <a href="https://github.com/user-attachments/files/16615669/__init__.pyi.txt"><code>src/amrex/space3d/__init__.pyi</code></a></p>
<p>After running <code>ruff check --select I --fix</code> v0.5.7: <a href="https://github.com/user-attachments/files/16615690/__init__.pyi.ruff.txt"><code>src/amrex/space3d/__init__.pyi</code></a></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ax3l">@ax3l</a> on 2024-08-14 15:57</div>
            <div class="timeline-body"><p>This is super interesting, the local files I create differ from the commits I autogenerated with pre-commit above (only difference I know is that they used ruff 0.5.6).
Maybe because I actually run all of <a href="https://github.com/AMReX-Codes/pyamrex/blob/c61add4fd44ad4ec69b131865375d76c68f12b29/pyproject.toml#L10-L18">E,F,I</a>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ax3l">@ax3l</a> on 2024-08-14 19:09</div>
            <div class="timeline-body"><p>Oh no, I think I see the issue, it's the pre commit.</p>
<p>Either I should list no types or include explicitly pyi
https://github.com/AMReX-Codes/pyamrex/blob/c61add4fd44ad4ec69b131865375d76c68f12b29/.pre-commit-config.yaml#L82</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ax3l">@ax3l</a> on 2024-08-14 20:20</div>
            <div class="timeline-body"><p>I think it was indeed the case that in the pre-commit rules, the <code>.pyi</code> files were not sorted at all, resulting in the unstable result of <code>pybind11-stubgen</code> to fluctuate.
https://github.com/AMReX-Codes/pyamrex/pull/356</p>
<p>The underlying issue is  that I did not know what to put in <code>types_or</code>, which comes from pre-commit itself, but I only looked at the ruff docs:
https://github.com/astral-sh/ruff-pre-commit?tab=readme-ov-file#using-ruff-with-pre-commit
https://pre-commit.com/#filtering-files-with-types</p>
<p>I am so sorry for the confusion and noise.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @ax3l on 2024-08-14 20:20</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 01:30:14 UTC
    </footer>
</body>
</html>
