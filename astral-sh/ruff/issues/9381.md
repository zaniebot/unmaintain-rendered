```yaml
number: 9381
title: "`ruff format` or `ruff check` returns \"nested alternate groups are not allowed\" error"
type: issue
state: closed
author: niccolomineo
labels:
  - bug
  - configuration
assignees: []
created_at: 2024-01-03T14:58:00Z
updated_at: 2025-03-03T14:30:00Z
url: https://github.com/astral-sh/ruff/issues/9381
synced_at: 2026-01-10T01:56:51Z
```

# `ruff format` or `ruff check` returns "nested alternate groups are not allowed" error

---

_Issue opened by @niccolomineo on 2024-01-03 14:58_

I am attempting to exclude this dir from inspection:

```
extend-exclude = [
    "__pycache__",
]
```

but I am getting:

```sh
$ python3 -m ruff format .
ruff failed
  Cause: error parsing glob '/Users/me/project/{{cookiecutter.project_dirname}}/__pycache__': nested alternate groups are not allowed
```

Any ideas?

On a side note, according to [this](https://regex101.com/r/I8WJGr/1) experiment, this syntax should be valid

```
extend-exclude = [
    "[{][{]cookiecutter[.]project_dirname[}][}]/__pycache__",
]
```

but it still gets me the error above.

---

_Label `bug` added by @charliermarsh on 2024-01-04 04:06_

---

_Comment by @charliermarsh on 2024-01-04 04:07_

To clarify, the whole config is:

```toml
extend-exclude = [
    "__pycache__",
]
```

Is that right? And you're running from the `/Users/me/project/{{cookiecutter.project_dirname}}` directory?

---

_Comment by @niccolomineo on 2024-01-04 11:59_

The whole config is:

```
extend-exclude = [
    "__pycache__",
    ".vscode*",
]
```

and I am running from `Users/me/project/`. 

`{{cookiecutter.project_dirname}}` is a subdir in that path.

---

_Comment by @charliermarsh on 2024-01-04 13:51_

Got it, thanks!

---

_Comment by @niccolomineo on 2024-01-04 13:56_

> Got it, thanks!

Thank YOU! Are you able to confirm it is a bug and not something I have to tweak on my side?

---

_Comment by @charliermarsh on 2024-01-04 16:31_

From the description it looks like a bug. What you could do though is omit that directory entirely:

```toml
extend-exclude = [
    "[{][{]cookiecutter.project_dirname[}][}]",
]
```

---

_Comment by @charliermarsh on 2024-01-04 16:31_

(Taken from: https://github.com/astral-sh/ruff/issues/7959#issuecomment-1764751734)

---

_Comment by @niccolomineo on 2024-01-04 18:38_

> From the description it looks like a bug. What you could do though is omit that directory entirely:
> 
> 
> 
> ```toml
> 
> extend-exclude = [
> 
>     "[{][{]cookiecutter.project_dirname[}][}]",
> 
> ]
> 
> ```

Unfortunately I need to target specific subdirs of that unusual dir, so that's not viable for me.

---

_Referenced in [20tab/django-continuous-delivery#290](../../20tab/django-continuous-delivery/pulls/290.md) on 2024-01-04 18:43_

---

_Comment by @niccolomineo on 2024-01-05 12:41_

Hi @charliermarsh, you might be already aware of this, but this is occurring with the base `ruff` command as well, not just with `ruff format`.

---

_Label `cli` added by @MichaReiser on 2024-01-08 08:09_

---

_Label `configuration` added by @MichaReiser on 2024-01-08 08:10_

---

_Label `cli` removed by @MichaReiser on 2024-01-08 08:11_

---

_Renamed from "`ruff format` returns "nested alternate groups are not allowed" error" to "`ruff format` or `ruff check` returns "nested alternate groups are not allowed" error" by @MichaReiser on 2024-01-08 08:11_

---

_Referenced in [astral-sh/ruff#9585](../../astral-sh/ruff/issues/9585.md) on 2024-05-08 11:52_

---

_Referenced in [fpgmaas/cookiecutter-poetry#112](../../fpgmaas/cookiecutter-poetry/pulls/112.md) on 2024-07-02 19:12_

---

_Comment by @GitRon on 2024-10-29 10:23_

We have the same issue in combination with cookiecutter ðŸ˜• The curly brackets seem to be a problem.

---

_Comment by @knowfahad on 2025-01-31 16:11_

Any update on this?

---

_Comment by @lucasfijen on 2025-02-21 09:47_

Yep I'm running in exactly the same in combination with cookiecutter.
In my case it's with the per-file-ignores, but that probably translates to the same underlying issue

I have a folder structure:
```
.
â”œâ”€â”€ pyproject.toml
â””â”€â”€ {{ cookiecutter.repo_name }}
    â”œâ”€â”€ tests
    â”‚   â””â”€â”€ maintest.py
    â”œâ”€â”€ main.py
    â””â”€â”€ pyproject.toml

```
Where my pyproject.toml contains this setting that is causing the issue, removing this line fixes the error

```pyproject.toml
[tool.ruff.lint.per-file-ignores]
"tests/*" = ["F811"]
```

Then running ruff from the root  using `cookiecutter format .` will cause:
```
ruff failed
  Cause: error parsing glob '/workspaces/reponame/{{cookiecutter.repo_name}}/tests/*': nested alternate groups are not allowed
```



---

_Comment by @ntBre on 2025-02-21 16:43_

Does anyone have a link to a repo or gist where I could reproduce this? I'm trying to take a look but having some trouble reproducing it locally with this file tree:

```
.
â”œâ”€â”€ ruff.toml
â””â”€â”€ {{cookiecutter.project_dirname}}
    â”œâ”€â”€ __pycache__
    â”‚Â Â  â””â”€â”€ try.py
    â””â”€â”€ try.py
```

We use [globset](https://docs.rs/globset/latest/globset/) for most of our path globs, which has the comment "Nesting {...} is not currently allowed" in the docs, so I think the curly braces are definitely the problem.

For now the best workarounds are still "escaping" the curly braces with square brackets (`[{]`) or backslashes (`\{`, if you're not on Windows), but I agree that it would be nice if we had some heuristics for detecting this automatically.

---

_Comment by @lucasfijen on 2025-02-21 17:43_

Thank you for taking your time to looking into it! This monday I should have some time to setup a small example repo for you to make it reproducible. 

The issue with this cookiecutter example is that the glob part with the curly brackets is not included in the ignore list field, as that part should be relative paths. However the curly brackets part are included when running ruff from the root (for this example we might need a second pyproject.toml above the ccokiecutter.project_dirname to get it reproduced.

This explanation might not be very clear, I'll work on an example repo for you:)

---

_Comment by @lucasfijen on 2025-02-24 08:16_

@ntBre as promised I created a repository to showcase the issue [here](https://github.com/lucasfijen/example_ruff_glob_bug). 

---

_Comment by @ntBre on 2025-02-24 14:50_

@lucasfijen Thank you so much! I cloned the repo and can now reproduce!

---

_Referenced in [astral-sh/ruff#16407](../../astral-sh/ruff/pulls/16407.md) on 2025-02-26 22:17_

---

_Closed by @ntBre on 2025-03-03 14:30_

---
