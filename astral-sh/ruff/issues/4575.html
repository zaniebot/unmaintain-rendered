<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[Infinite loop] When adding required import to file with `# isort: off` as first line - astral-sh/ruff #4575</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[Infinite loop] When adding required import to file with <code># isort: off</code> as first line</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/issues/4575">#4575</a>
        opened by <a href="https://github.com/bendoerry">@bendoerry</a>
        on 2023-05-22 11:31
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/bendoerry">@bendoerry</a></div>
            <div class="timeline-body">

Summary
<p>If I add required imports to a python file where the very first line is <code># isort: off</code> ruff will raise an error and add the required import multiple times. This does not happen if the <code># isort: off</code> directive is not the first line</p>
Ruff Version:
<p><a href="https://github.com/charliermarsh/ruff/releases/tag/v0.0.269">0.0.269</a></p>
Ruff Config:
<pre><code>[isort]
required-imports = [
  &quot;from __future__ import annotations&quot;,
]
</code></pre>
Ruff Command:
<pre><code>ruff check --fix --select I002 unsorted.py
</code></pre>
<code>isort: off</code> directive on first line
Python File: <code>unsorted.py</code>
<pre><code># isort: off
from json import dumps
from base64 import b64encode

# isort: on
from collections import defaultdict
from functools import wraps
</code></pre>
Ruff Output
<pre><code>error: Failed to converge after 100 iterations.

This indicates a bug in `ruff`. If you could open an issue at:

    https://github.com/charliermarsh/ruff/issues/new?title=%5BInfinite%20loop%5D

...quoting the contents of `unsorted.py`, the rule codes I002, along with the `pyproject.toml` settings and executed command, we&#x27;d be very appreciative!

unsorted.py:1:1: I002 Missing required import: `from __future__ import annotations`
Found 101 errors (100 fixed, 1 remaining).
</code></pre>
Modified Python File
<pre><code># isort: off
from __future__ import annotations
from __future__ import annotations
from __future__ import annotations
from __future__ import annotations
from __future__ import annotations
from __future__ import annotations
from __future__ import annotations
from __future__ import annotations
from __future__ import annotations
from __future__ import annotations
from __future__ import annotations
from __future__ import annotations
from __future__ import annotations
from __future__ import annotations
from __future__ import annotations
from __future__ import annotations
from __future__ import annotations
from __future__ import annotations
from __future__ import annotations
from __future__ import annotations
from __future__ import annotations
from __future__ import annotations
from __future__ import annotations
from __future__ import annotations
from __future__ import annotations
from __future__ import annotations
from __future__ import annotations
from __future__ import annotations
from __future__ import annotations
from __future__ import annotations
from __future__ import annotations
from __future__ import annotations
from __future__ import annotations
from __future__ import annotations
from __future__ import annotations
from __future__ import annotations
from __future__ import annotations
from __future__ import annotations
from __future__ import annotations
from __future__ import annotations
from __future__ import annotations
from __future__ import annotations
from __future__ import annotations
from __future__ import annotations
from __future__ import annotations
from __future__ import annotations
from __future__ import annotations
from __future__ import annotations
from __future__ import annotations
from __future__ import annotations
from __future__ import annotations
from __future__ import annotations
from __future__ import annotations
from __future__ import annotations
from __future__ import annotations
from __future__ import annotations
from __future__ import annotations
from __future__ import annotations
from __future__ import annotations
from __future__ import annotations
from __future__ import annotations
from __future__ import annotations
from __future__ import annotations
from __future__ import annotations
from __future__ import annotations
from __future__ import annotations
from __future__ import annotations
from __future__ import annotations
from __future__ import annotations
from __future__ import annotations
from __future__ import annotations
from __future__ import annotations
from __future__ import annotations
from __future__ import annotations
from __future__ import annotations
from __future__ import annotations
from __future__ import annotations
from __future__ import annotations
from __future__ import annotations
from __future__ import annotations
from __future__ import annotations
from __future__ import annotations
from __future__ import annotations
from __future__ import annotations
from __future__ import annotations
from __future__ import annotations
from __future__ import annotations
from __future__ import annotations
from __future__ import annotations
from __future__ import annotations
from __future__ import annotations
from __future__ import annotations
from __future__ import annotations
from __future__ import annotations
from __future__ import annotations
from __future__ import annotations
from __future__ import annotations
from __future__ import annotations
from __future__ import annotations
from __future__ import annotations
from json import dumps
from base64 import b64encode

# isort: on
from collections import defaultdict
from functools import wraps
</code></pre>
Other comment as first line
Python File: <code>unsorted.py</code>
<pre><code># No Issue
# isort: off
from json import dumps
from base64 import b64encode

# isort: on
from collections import defaultdict
from functools import wraps
</code></pre>
Ruff Output
<pre><code>Found 1 error (1 fixed, 0 remaining).
</code></pre>
Modified Python File
<pre><code># No Issue
from __future__ import annotations
# isort: off
from json import dumps
from base64 import b64encode

# isort: on
from collections import defaultdict
from functools import wraps
</code></pre>
<p>Ideally I would have an extra line between the <code>future</code> import and the <code># isort: off</code> comment.</p>
Blank first line
Python File: <code>unsorted.py</code>
<pre><code>
# isort: off
from json import dumps
from base64 import b64encode

# isort: on
from collections import defaultdict
from functools import wraps
</code></pre>
Ruff Output
<pre><code>Found 1 error (1 fixed, 0 remaining).
</code></pre>
Modified Python File
<pre><code>from __future__ import annotations

# isort: off
from json import dumps
from base64 import b64encode

# isort: on
from collections import defaultdict
from functools import wraps
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-05-22 13:12</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">isort</span> added by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-05-22 13:12</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to <a href="https://github.com/charliermarsh">@charliermarsh</a> by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-05-22 15:09</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-05-22 15:49</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 18:48:36 UTC
    </footer>
</body>
</html>
