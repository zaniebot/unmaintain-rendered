<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rule request: abstractmethod appears on normal class - astral-sh/ruff #12861</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Rule request: abstractmethod appears on normal class</h1>

    <div class="meta">
        <span class="state state-open">Open</span>
        <a href="https://github.com/astral-sh/ruff/issues/12861">#12861</a>
        opened by <a href="https://github.com/Skylion007">@Skylion007</a>
        on 2024-08-13 13:30
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/Skylion007">@Skylion007</a> on 2024-08-13 13:30</div>
            <div class="timeline-body"><!--
Thank you for taking the time to report an issue! We're glad to have you involved with Ruff.

If you're filing a bug report, please consider including the following information:

* List of keywords you searched for before creating this issue. Write them down here so that others can find this issue more easily and help provide feedback.
  e.g. "RUF001", "unused variable", "Jupyter notebook"
* A minimal code snippet that reproduces the bug.
* The command you invoked (e.g., `ruff /path/to/file.py --fix`), ideally including the `--isolated` flag.
* The current Ruff settings (any relevant sections from your `pyproject.toml`).
* The current Ruff version (`ruff --version`).
-->

<p>the case where an abstractmethod decorator is used on a class that does not subclass <code>abc.ABC</code> uses the <code>ABC</code> metaclass, is probably a bug. It would be great to have a rule to detect the obvious case where it is used on the wrong type of class (when all ancestors of the class in the same file for instance).</p>
<p>If there is a rule that already implements this, let me know. :)</p>
<p>Here is a real example from PyTorch:</p>
<pre><code class="language-python">class RemoteCacheBackend:
    &quot;&quot;&quot;
    A backend implementation for accessing a remote/distributed cache.
    &quot;&quot;&quot;

    def __init__(self, cache_id: str) -&gt; None:
        pass

    @abstractmethod
    def get(self, key: str) -&gt; Optional[object]:
        pass

    @abstractmethod
    def put(self, key: str, data: bytes) -&gt; None:
        pass
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-08-14 07:21</div>
            <div class="timeline-body"><p>@AlexWaygood any thoughts on this?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-08-14 11:05</div>
            <div class="timeline-body"><p>I think this is a good idea for a rule. I agree that if a class that doesn't have <code>ABCMeta</code> (or a subclass of <code>ABCMeta</code>) as its metaclass, but has <code>@abstractmethod</code>-decorated methods, that's probably a bug. Here's a few things we'll need to keep in mind, however:</p>
<ol>
<li><p>We need to recognise as valid any class that has <code>metaclass=X</code>, or any class that inherits from a class that has <code>metaclass=X</code>, where <code>X</code> is either <code>abc.ABCMeta</code> or a subclass of <code>abc.ABCMeta</code>.</p>
</li>
<li><p>For a class like the example @Skylion007 gives, that doesn't inherit from any classes or have a custom metaclass, it's easy to see that it doesn't have <code>ABCMeta</code> as its metaclass. But we'd need multifile analysis to be able to accurately determine whether this class has <code>ABCMeta</code> as its metaclass, since it depends on whether <code>ForeignSuperclass</code> has <code>ABCMeta</code> as its metaclass or not:</p>
<pre><code class="language-py">from other_module import ForeignSuperclass

class Klass(ForeignSuperclass): pass
</code></pre>
<p>What should we do in cases like this? I vote for not emitting the error if a class inherits from any classes that come from external modules, since this is a common pattern, and I think there will be too many false positives otherwise.</p>
</li>
<li><p>Stub files need to be excluded from this rule. Legacy code that was written before the introduction of the <code>abc</code> module often has classes that are de-facto abstract base classes, even though they don't make any use of the <code>abc</code> module. When writing type stubs for legacy code like this, you'll often want to add <code>@abstractmethod</code> to the stub methods of these classes, so that type checkers understand them to be abstract methods that need to be overridden in subclasses and emit appropriate errors. However, you won't want to lie about the metaclass in the stub file and pretend that the class has <code>abc.ABCMeta</code> as the metaclass, since this can cause spurious type-checker errors about metaclass conflicts in some situations. Adding <code>@abstractmethod</code> to a method on a class that does not have <code>ABCMeta</code> as the metaclass is fine in a stub file, since type checkers will still recognise the method as being abstract; the metaclass only makes a difference to runtime semantics, and stub files are never executed at runtime.</p>
</li>
</ol>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">rule</span> added by @AlexWaygood on 2024-08-14 11:06</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">accepted</span> added by @AlexWaygood on 2024-08-14 11:06</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/opk12">@opk12</a> on 2024-09-05 15:28</div>
            <div class="timeline-body"><p>in fact the @<a href="https://docs.python.org/3/library/abc.html#abc.abstractmethod">abc.abstractmethod</a> docs says</p>
<blockquote>
<p>Using this decorator requires that the classâ€™s metaclass is <a href="https://docs.python.org/3/library/abc.html#abc.ABCMeta">ABCMeta</a> or is derived from it.</p>
</blockquote>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/14688.html">astral-sh/ruff#14688</a> on 2024-11-30 07:29</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/17636.html">astral-sh/ruff#17636</a> on 2025-04-28 07:38</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:34:53 UTC
    </footer>
</body>
</html>
