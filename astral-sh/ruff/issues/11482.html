<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>False positive for list comprehension - astral-sh/ruff #11482</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>False positive for list comprehension</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/issues/11482">#11482</a>
        opened by <a href="https://github.com/jontwo">@jontwo</a>
        on 2024-05-21 07:56
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/jontwo">@jontwo</a></div>
            <div class="timeline-body"><!--
Thank you for taking the time to report an issue! We're glad to have you involved with Ruff.

If you're filing a bug report, please consider including the following information:

* List of keywords you searched for before creating this issue. Write them down here so that others can find this issue more easily and help provide feedback.
  e.g. "RUF001", "unused variable", "Jupyter notebook"
* A minimal code snippet that reproduces the bug.
* The command you invoked (e.g., `ruff /path/to/file.py --fix`), ideally including the `--isolated` flag.
* The current Ruff settings (any relevant sections from your `pyproject.toml`).
* The current Ruff version (`ruff --version`).
-->

<p>Ruff states that a list comprehension should be used, but the (unsafe) fix changes the syntax.</p>
<p>I have a script to make a POST request against an API and one of the inputs is a list of parameters to append onto the end of the query.</p>
<pre><code>    parser.add_argument(
        &quot;--params&quot;,
        nargs=2,
        action=&quot;append&quot;,
        metavar=(&quot;KEY&quot;, &quot;VALUE&quot;),
        help=&quot;Parameters to add to API call.&quot;,
    )
</code></pre>
<p>These are then urlencoded and appended to the query.</p>
<pre><code>    if params:
        url = f&quot;{url}?{urllib_parse.urlencode(params)}&quot;
</code></pre>
<p>If you just pass the params that come out of <code>argparse</code>, then <code>urllib</code> doesn't like that it is a list of lists and raises <code>TypeError: not a valid non-string sequence or mapping object</code>.</p>
<p>So, I convert to a list of tuples before passing the params in.</p>
<pre><code>param_tuples = [(k, v) for k, v in args.params] if args.params else None
</code></pre>
<p>This is the line that Ruff is complaining about, but the suggested fix (<code>list(args.params)</code>) doesn't convert to a list of tuples, it leaves it as a list of lists.</p>
<p>It's subtle, but I do need to convert from lists to tuples! I know it is an unsafe fix, but thought this edge case was worth flagging.</p>
<p>Keywords: &quot;list comprehension&quot;, tuple, argparse
Ruff version: 0.4.2
Command: ruff check query_api.py --config pyproject.toml --unsafe-fixes --fix</p>
<details>
<summary>pyproject.toml</summary>
[tool.ruff]
line-length = 100

<p>[tool.ruff.lint]
exclude = [&quot;docs/<em>&quot;, &quot;build/</em>&quot;]
ignore = [
&quot;B028&quot;, # allow quoting values in strings - see https://peps.python.org/pep-0498/#s-r-and-a-are-redundant
&quot;COM812&quot;, # if we add trailing commas everywhere we also need to rerun black which will reformat them again
&quot;D105&quot;, # missing docstring in magic method
&quot;D107&quot;, # missing docstring in <strong>init</strong>
&quot;D401&quot;, # first line of docstring should be imperative
&quot;E501&quot;, # use Bugbear's B950 instead to allow lines to go slightly over the limit
&quot;E203&quot;, # allow whitespace around : until https://github.com/PyCQA/pycodestyle/issues/373 is fixed
&quot;RET503&quot;, # allow missing return None when other return values present
&quot;RET504&quot;, # allow assignment before return
&quot;TD002&quot;, # missing author in TODO comments
&quot;TD003&quot;, # missing issue reference in TODO comments
&quot;TD004&quot;, # missing expiry version in TODO comments
]
select = [
&quot;A&quot;, # flake8-builtins
&quot;B&quot;, # flake8-bugbear
&quot;C4&quot;, # flake8-comprehensions
&quot;COM&quot;, # flake8-commas
&quot;D&quot;, # pydocstyle
&quot;E&quot;, # error
&quot;ERA&quot;, # eradicate
&quot;F&quot;, # pyflakes
&quot;G&quot;, # flake8-format-logging
&quot;I&quot;, # isort
&quot;N&quot;, # pep8-naming
&quot;RET&quot;, # flake8-return
&quot;TD&quot;, # flake8-todos
&quot;T20&quot;, # flake8-print
&quot;W&quot;, # warning,
]</p>
<p>[tool.ruff.lint.flake8-pytest-style]
fixture-parentheses = false</p>
<p>[tool.ruff.lint.pep8-naming]
ignore-names = [
&quot;assertGeomsAll2D&quot;,
&quot;assertHistoryEqual&quot;,
&quot;assertPolygonsEqual&quot;,
&quot;assertRastersEqual&quot;,
&quot;assertRasterSrs&quot;,
&quot;banded_strings&quot;,
&quot;doRollover&quot;,
&quot;doRollOver&quot;,
&quot;failureException&quot;,
&quot;GetDescription&quot;,
&quot;GetDriver&quot;,
&quot;GetFileList&quot;,
&quot;GetLayer&quot;,
&quot;GetMetaData&quot;,
&quot;GetMetadata&quot;,
&quot;GetSpatialRef&quot;,
&quot;longMessage&quot;,
&quot;maxDiff&quot;,
&quot;ReadAsArray&quot;,
&quot;SetMetadata&quot;,
&quot;SetMetaData&quot;,
&quot;SetMetadataItem&quot;,
&quot;SetMetaDataItem&quot;,
&quot;setUp&quot;,
&quot;setUpClass&quot;,
&quot;setUpTestData&quot;,
&quot;shortDescription&quot;,
&quot;sum_columns&quot;,
&quot;tearDown&quot;,
&quot;tearDownClass&quot;,
&quot;useZ&quot;,
]</p>
<p>[tool.ruff.lint.per-file-ignores]
&quot;setup.py&quot; = [&quot;D10&quot;]
&quot;src/<strong>init</strong>.py&quot; = [&quot;A001&quot;, &quot;E402&quot;, &quot;F401&quot;, &quot;F403&quot;]
&quot;src/**/tests/<strong>init</strong>.py&quot; = [&quot;D104&quot;]
&quot;test_*.py&quot; = [&quot;ARG002&quot;, &quot;D10&quot;, &quot;D20&quot;, &quot;D21&quot;, &quot;D30&quot;, &quot;D40&quot;, &quot;D41&quot;, &quot;PT009&quot;, &quot;S101&quot;, &quot;TID252&quot;]</p>
<p>[tool.ruff.lint.pydocstyle]
convention = &quot;google&quot;</p>
</details>

</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @charliermarsh on 2024-05-21 19:09</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-05-21 19:09</div>
            <div class="timeline-body"><p>Thanks! That's tricky.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/tdulcet">@tdulcet</a> on 2024-05-21 20:01</div>
            <div class="timeline-body"><p>Maybe try: <code>list(map(tuple, args.params))</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/harupy">@harupy</a> on 2024-12-10 11:59</div>
            <div class="timeline-body"><p>@charliermarsh Can I work on this? A similar issue was reported in the flake8-comprehensions repo: https://github.com/adamchainz/flake8-comprehensions/issues/204.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-12-10 13:54</div>
            <div class="timeline-body"><p>@harupy please feel free!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @harupy by @dylwil3 on 2024-12-10 14:57</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @dhruvmanila on 2024-12-20 09:05</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @dhruvmanila on 2024-12-20 09:05</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 16:50:17 UTC
    </footer>
</body>
</html>
