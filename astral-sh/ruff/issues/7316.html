<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formatter undocumented deviation: slice formatting - astral-sh/ruff #7316</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Formatter undocumented deviation: slice formatting</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/ruff/issues/7316">#7316</a>
        opened by <a href="https://github.com/JonathanPlasse">@JonathanPlasse</a>
        on 2023-09-12 20:50
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/JonathanPlasse">@JonathanPlasse</a></div>
            <div class="timeline-body">

<p>Black formatting</p>
<pre><code>def f():
    for event_index in range(header.number_non_empty_events):
        section_header_data = struct.unpack(
            JSON_BINARY_PARAMETERS.fmt_section_header,
            byte_array[
                byte_begin_index
                + byte_step_index * event_index : byte_begin_index
                + byte_step_index * (event_index + 1)
            ],
        )
</code></pre>
<p>Ruff formatting</p>
<pre><code>def f():
    for event_index in range(header.number_non_empty_events):
        section_header_data = struct.unpack(
            JSON_BINARY_PARAMETERS.fmt_section_header,
            byte_array[
                byte_begin_index + byte_step_index * event_index : byte_begin_index
                + byte_step_index * (event_index + 1)
            ],
        )
</code></pre>
<p>Use Ruff 0.0.289 with line length to 100</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2023-09-12 20:58</div>
            <div class="timeline-body"><p>Do you have an ideal formatting for this case? I find both of these hard to reason about.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/JonathanPlasse">@JonathanPlasse</a> on 2023-09-12 21:00</div>
            <div class="timeline-body"><p>Maybe this</p>
<pre><code>def f():
    for event_index in range(header.number_non_empty_events):
        section_header_data = struct.unpack(
            JSON_BINARY_PARAMETERS.fmt_section_header,
            byte_array[
                byte_begin_index + byte_step_index * event_index
                : byte_begin_index + byte_step_index * (event_index + 1)
            ],
        )
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-09-13 06:53</div>
            <div class="timeline-body"><p>Thanks for reporting this. The deviation here is rooted in the fact that:</p>
<ul>
<li>Black breaks a line by all binary operators first as if the left and right side of the <code>:</code> operator are a single expression</li>
<li>Ruff considered the left and right two independent expressions and split them individually</li>
</ul>
<p>Here&#x27;s an example where Black splits before all <code>+</code> operators even though it wouldn&#x27;t be necessary to make the left side fit:</p>
<pre><code>def f():
    for event_index in range(header.number_non_empty_events):
        section_header_data = struct.unpack(
            JSON_BINARY_PARAMETERS.fmt_section_header,
            byte_array[
                byte_begin_index
                + byte_step_index : byte_begin_index
                + byte_step_index
                + (event_index + 1)
            ],
        )

# Ruff
def f():
    for event_index in range(header.number_non_empty_events):
        section_header_data = struct.unpack(
            JSON_BINARY_PARAMETERS.fmt_section_header,
            byte_array[
                byte_begin_index + byte_step_index : byte_begin_index
                + byte_step_index
                + (event_index + 1)
            ],
        )

</code></pre>
<p>I generally prefer Ruff&#x27;s approach of treating them as separate expressions but we should probably add a softline break before the <code>:</code> operator similar to other operands (e.g. in binary expressions) and potentially indent the right side.</p>
<p>Prettier&#x27;s formatting looks similar to what @JonathanPlasse  proposes (I had to adjust the syntax slightly to get the JS equivalent)</p>
<pre><code>for (event_index in range(header.number_non_empty_events)) {
  section_header_data = struct.unpack(
    JSON_BINARY_PARAMETERS.fmt_section_header,
    {
      [byte_begin_index + byte_step_index * event_index]:
        byte_begin_index + byte_step_index * (event_index + 1),
    },
  );
}
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">wontfix</span> added by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-09-13 06:54</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">formatter</span> added by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-09-13 06:54</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone &quot;Formatter: Beta&quot; by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-09-13 06:54</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">wontfix</span> removed by <a href="https://github.com/konstin">@konstin</a> on 2023-09-13 10:20</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">wontfix</span> added by <a href="https://github.com/konstin">@konstin</a> on 2023-09-19 12:13</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-09-20 06:17</div>
            <div class="timeline-body"><p>We decided not to implement the deviation for now and instead focus on Black compatibility because:</p>
<ul>
<li>It eases migration for Black users</li>
<li>Having more deviation makes it harder to assess whether a deviation is a bug or due to som other deviation. The fewer deviations, the easier it is to identify the root cause and improve overall black compatibility</li>
</ul>
<p>We plan to re-visit the formatting eventually</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Removed from milestone &quot;Formatter: Beta&quot; by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-09-27 15:38</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone &quot;Formatter: Stable&quot; by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-09-27 15:38</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-09-27 15:40</div>
            <div class="timeline-body"><p>We&#x27;re not planning to change this for the Beta. We want to re-open the possibility of changing to match @JonathanPlasse&#x27;s suggested style once we have better tooling to evaluate the impact (e.g., ruff-shades).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">wontfix</span> removed by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-10-26 23:57</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">wontfix</span> added by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-10-26 23:57</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">style</span> added by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-10-26 23:57</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Removed from milestone &quot;Formatter: Stable&quot; by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-10-26 23:57</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">wontfix</span> removed by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-10-27 02:08</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-11-29 03:29</div>
            <div class="timeline-body"><p>We may want to consider <a href="https://github.com/astral-sh/ruff/issues/8897">astral-sh/ruff#8897</a> when making a style decision to make sure our handling is consistent.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 18:48:42 UTC
    </footer>
</body>
</html>
