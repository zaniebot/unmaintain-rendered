<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Handle &quot;untitled&quot; files in Neovim - astral-sh/ruff #15392</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Handle &quot;untitled&quot; files in Neovim</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/ruff/issues/15392">#15392</a>
        opened by <a href="https://github.com/dhruvmanila">@dhruvmanila</a>
        on 2025-01-10 08:20
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2025-01-10 08:20</div>
            <div class="timeline-body"><p>Currently, the language server crashes with the following panic:</p>
<pre><code>   0.000076625s  INFO main ruff_server::server: No workspace settings found for file:///Users/dhruv/playground/ruff, using default settings
   0.016819875s DEBUG ThreadId(15) ruff_server::session::index::ruff_settings: Ignored path via `exclude`: /Users/dhruv/playground/ruff/.vscode
   0.025011584s  INFO main ruff_server::session::index: Registering workspace: /Users/dhruv/playground/ruff
   0.025738917s TRACE ruff:main notification{method=&quot;textDocument/didOpen&quot;}: ruff_server::server::api: enter
   0.026116917s TRACE ruff:worker:0 request{id=2 method=&quot;textDocument/diagnostic&quot;}: ruff_server::server::api: enter
   0.026236834s DEBUG ruff:worker:0 request{id=2 method=&quot;textDocument/diagnostic&quot;}: ruff_server::resolve: Included path via `include`: /Users/dhruv/playground/ruff/type_inference/definition_vs_declaration.py
   0.027171209s  INFO     ruff:main ruff_server::server: Configuration file watcher successfully registered
  24.044284625s TRACE     ruff:main notification{method=&quot;workspace/didChangeWorkspaceFolders&quot;}: ruff_server::server::api: enter
  24.044426375s ERROR     ruff:main notification{method=&quot;workspace/didChangeWorkspaceFolders&quot;}: ruff_server::server::api: An error occurred while running workspace/didChangeWorkspaceFolders: Failed to convert workspace URL to file path: file://./
  24.044570667s TRACE     ruff:main notification{method=&quot;textDocument/didOpen&quot;}: ruff_server::server::api: enter
  24.100126375s  WARN     ruff:main ruff_server::session::index: No settings available for file:/// - falling back to default settings
  24.101414459s TRACE ruff:worker:2 request{id=3 method=&quot;textDocument/diagnostic&quot;}: ruff_server::server::api: enter
  24.101510542s DEBUG ruff:worker:2 request{id=3 method=&quot;textDocument/diagnostic&quot;}: ruff_server::resolve: Included path via Python language ID: /
  24.101617792s ERROR ruff:worker:2 request{id=3 method=&quot;textDocument/diagnostic&quot;}: ruff_server::server: panicked at crates/ruff_server/src/lint.rs:89:18:
a path to a document should have a parent path
</code></pre>
<p>At <code>24.044284625s</code>, the unnamed buffer has been assigned the filetype as Python in Neovim which triggers the following notifications from the client to the server:</p>
<p><code>didChangeWorkspaceFolders</code>:</p>
<pre><code>[DEBUG][2025-01-10 13:32:36] .../vim/lsp/rpc.lua:286	&quot;rpc.send&quot;	{
  jsonrpc = &quot;2.0&quot;,
  method = &quot;workspace/didChangeWorkspaceFolders&quot;,
  params = {
    event = {
      added = { {
          name = &quot;.&quot;,
          uri = &quot;file://.&quot;
        } },
      removed = {}
    }
  }
}
</code></pre>
<p>which fails with the following error:</p>
<pre><code>  24.044426375s ERROR     ruff:main notification{method=&quot;workspace/didChangeWorkspaceFolders&quot;}: ruff_server::server::api: An error occurred while running workspace/didChangeWorkspaceFolders: Failed to convert workspace URL to file path: file://./
</code></pre>
<p><code>textDocument/didOpen</code>:</p>
<pre><code>[DEBUG][2025-01-10 13:32:36] .../vim/lsp/rpc.lua:286	&quot;rpc.send&quot;	{
  jsonrpc = &quot;2.0&quot;,
  method = &quot;textDocument/didOpen&quot;,
  params = {
    textDocument = {
      languageId = &quot;python&quot;,
      text = &quot;\n&quot;,
      uri = &quot;file://&quot;,
      version = 0
    }
  }
}
</code></pre>
<p><code>textDocument/diagnostic</code>:</p>
<pre><code>[DEBUG][2025-01-10 13:32:36] .../vim/lsp/rpc.lua:286	&quot;rpc.send&quot;	{
  id = 2,
  jsonrpc = &quot;2.0&quot;,
  method = &quot;textDocument/diagnostic&quot;,
  params = {
    range = {
      [&quot;end&quot;] = {
        character = 0,
        line = 1
      },
      start = {
        character = 0,
        line = 0
      }
    },
    textDocument = {
      uri = &quot;file://&quot;
    }
  }
}
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @dhruvmanila on 2025-01-10 08:20</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">server</span> added by @dhruvmanila on 2025-01-10 08:20</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-01-10 08:29</div>
            <div class="timeline-body"><p>Hmm this is interesting. Can you open multiple unnamed buffers? Do they get unique uris? Is this even a valid file path?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2025-01-10 08:35</div>
            <div class="timeline-body"><p>Yes, you can open multiple unnamed buffers. They are using the same URIs.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-01-10 08:42</div>
            <div class="timeline-body"><blockquote>
<p>Yes, you can open multiple unnamed buffers. They are using the same URIs.</p>
</blockquote>
<p>That at least seems a bug to me in neovim because the server can now no longer distinguish between them. I think neovim should not use <code>file:://</code> for unnamed buffers but do the same as VS code and use some other non-file path</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-01-10 08:44</div>
            <div class="timeline-body"><p>See https://github.com/astral-sh/ruff/discussions/12336</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2025-01-10 08:49</div>
            <div class="timeline-body"><p>Yeah, I saw the Neovim issue (https://github.com/neovim/neovim/issues/21276) but that seems to have concluded with continue using &quot;file://&quot; until using &quot;untitled://&quot; is actually the recommended way in the protocol.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2025-01-10 08:53</div>
            <div class="timeline-body"><p>So, this was merged https://github.com/neovim/neovim/pull/22407 but was quickly reverted https://github.com/neovim/neovim/pull/22604</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2025-01-10 09:12</div>
            <div class="timeline-body"><p>Could this be a bug in the URI parsing library? The <code>vscode-uri</code> library is able to parse <code>file://./</code>:</p>
<pre><code>l {
  scheme: 'file',
  authority: '.',
  path: '/',
  query: '',
  fragment: '',
  _formatted: null,
  _fsPath: null
}
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2025-01-10 09:13</div>
            <div class="timeline-body"><p>And, I <em>think</em> this is why Pyright raised &quot;heap out of memory&quot; error because it tried to index the entire home directory.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-01-10 09:18</div>
            <div class="timeline-body"><p>I think we're able to parse it but <code>.</code> has no parent directory</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2025-01-10 09:20</div>
            <div class="timeline-body"><blockquote>
<p>I think we're able to parse it but <code>.</code> has no parent directory</p>
</blockquote>
<p>I don't think so:</p>
<pre><code>  24.044426375s ERROR     ruff:main notification{method=&quot;workspace/didChangeWorkspaceFolders&quot;}: ruff_server::server::api: An error occurred while running workspace/didChangeWorkspaceFolders: Failed to convert workspace URL to file path: file://./
</code></pre>
<p>which happens at:</p>
<p>https://github.com/astral-sh/ruff/blob/443bf38565ce481a10fe43a6aa6e1d57c3560c9f/crates/ruff_server/src/session/index.rs#L414-L416</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2025-01-10 09:20</div>
            <div class="timeline-body"><p>Oh so we <em>can</em> parse it but it's not being considered a valid file path (sorry!)</p>
<p>And, yes, you're correct about the parent directory part</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/kaddkaka">@kaddkaka</a> on 2025-02-21 09:18</div>
            <div class="timeline-body"><p>This issue comes up often in my vim workflow when reviewing git changes and looking at file state not in current working but rather from another branch as an ephemeral file crated from data from the <code>.git</code> folder.</p>
<p>Another way to trigger the unsaved buffers in nevom follows:</p>
<pre><code>nvim
:set filetype=python
</code></pre>
<p>Causes error:</p>
<pre><code>Client ruff quit with exit code 2 and signal 0. Check log for errors: ...
</code></pre>
<p>Log:</p>
<pre><code>ruff failed
Cause: failed to convert workspace URL to file path
</code></pre>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 11:36:15 UTC
    </footer>
</body>
</html>
