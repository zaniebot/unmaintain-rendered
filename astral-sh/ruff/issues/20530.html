<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ruff formatter adds spaces around colons in complex slice expressions, violating PEP 8 - astral-sh/ruff #20530</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Ruff formatter adds spaces around colons in complex slice expressions, violating PEP 8</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/issues/20530">#20530</a>
        opened by <a href="https://github.com/ten24bytes">@ten24bytes</a>
        on 2025-09-23 08:04
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ten24bytes">@ten24bytes</a></div>
            <div class="timeline-body"><h3>Summary</h3>
<h2>Description</h2>
<p>Ruff's formatter incorrectly adds spaces around colons in complex slice expressions (e.g., <code>i : i + batch_size</code>), which violates PEP 8 guidelines. According to PEP 8, slice notation should not have spaces around the colon.</p>
<hr />
<h2>Expected Behavior</h2>
<p>According to PEP 8:</p>
<blockquote>
<p>&quot;Always surround these binary operators with a single space on either side... However, in a slice the colon acts like a binary operator, and should have equal amounts on either side (treating it as the operator with the lowest priority). In an extended slice, both colons must have the same amount of spacing applied.&quot;</p>
</blockquote>
<p>For slice notation, this means <strong>no spaces around colons</strong>:</p>
<pre><code class="language-python">list[start:end:step]
</code></pre>
<hr />
<h2>Actual Behavior</h2>
<p>Ruff formatter adds spaces in complex slice expressions but not in simple ones, creating inconsistent formatting:</p>
<ul>
<li><p>✅ Simple slices formatted correctly:</p>
<pre><code class="language-python">data[0:5]
</code></pre>
</li>
<li><p>❌ Complex slices formatted incorrectly:</p>
<pre><code class="language-python">data[i : i + batch_size]  # should be data[i:i + batch_size]
</code></pre>
</li>
</ul>
<hr />
<h2>Reproduction Steps</h2>
<p>Create a Python file with the following content:</p>
<pre><code class="language-python"># test_slice_format.py
data = list(range(100))
batch_size = 10

# Simple slice - formats correctly
simple = data[0:5]

# Complex slice - formats incorrectly
for i in range(0, len(data), batch_size):
    batch = data[i:i + batch_size]

# More examples
result = data[start:end]
result2 = data[i:i + 1]
result3 = data[index:index + size]
</code></pre>
<p>Run:</p>
<pre><code class="language-bash">ruff format test_slice_format.py
</code></pre>
<p>Observe that complex slices get formatted with spaces:</p>
<pre><code class="language-python">data[i : i + batch_size]
</code></pre>
<hr />
<h2>Environment</h2>
<ul>
<li><strong>Ruff version:</strong> &gt;=0.12.8</li>
<li><strong>Python version:</strong> 3.13</li>
<li><strong>OS:</strong> Windows</li>
<li><strong>Configuration:</strong> Standard configuration with no special slice-related settings</li>
</ul>
<pre><code class="language-toml">[tool.ruff]
target-version = &quot;py313&quot;

[tool.ruff.format]
quote-style = &quot;double&quot;
indent-style = &quot;space&quot;
skip-magic-trailing-comma = false
line-ending = &quot;auto&quot;
docstring-code-format = false
docstring-code-line-length = &quot;dynamic&quot;
</code></pre>
<hr />
<h2>Impact</h2>
<p>This inconsistency:</p>
<ul>
<li>Violates PEP 8 compliance</li>
<li>Creates inconsistent code formatting within the same file</li>
<li>Requires manual workarounds using <code># fmt: skip</code> comments</li>
<li>Makes it difficult to maintain consistent code style in projects</li>
</ul>
<hr />
<h2>Workaround</h2>
<p>Currently using <code># fmt: skip</code> comments to prevent incorrect formatting:</p>
<pre><code class="language-python">batch = data[i:i + batch_size]  # fmt: skip
</code></pre>
<hr />
<h2>Additional Context</h2>
<p>This issue appears to affect <strong>complex slice expressions</strong> where the slice indices involve arithmetic operations or variable concatenation.</p>
<ul>
<li>✅ Simple literal slices (like <code>[0:5]</code>) are formatted correctly.</li>
<li>❌ Complex slices (like <code>[i:i + batch_size]</code>) are reformatted incorrectly.</li>
</ul>
<p>The inconsistency suggests that Ruff's parser treats complex slice expressions differently from simple ones, possibly applying <strong>general binary operator spacing rules</strong> instead of <strong>slice-specific formatting rules</strong>.</p>
<h3>Version</h3>
<p>ruff 0.13.1</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-09-23 08:30</div>
            <div class="timeline-body"><p>I don't think this violates PEP8. From PEP8</p>
<pre><code class="language-py"># Correct:
ham[1:9], ham[1:9:3], ham[:9:3], ham[1::3], ham[1:9:]
ham[lower:upper], ham[lower:upper:], ham[lower::step]
ham[lower+offset : upper+offset]
ham[: upper_fn(x) : step_fn(x)], ham[:: step_fn(x)] # &lt;-- This
ham[lower + offset : upper + offset] # &lt;-- This
</code></pre>
<p>also note:</p>
<blockquote>
<p>and should have equal amounts on either side (treating it as the operator with the lowest priority). In an extended slice, both colons must have the same amount of spacing applied.</p>
</blockquote>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">question</span> added by @MichaReiser on 2025-09-23 08:30</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @MichaReiser on 2025-11-06 13:28</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 16:53:21 UTC
    </footer>
</body>
</html>
