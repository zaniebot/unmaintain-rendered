<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Please consider changing configuration merging semantics - astral-sh/ruff #8751</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Please consider changing configuration merging semantics</h1>

    <div class="meta">
        <span class="state state-closed">Closed</span>
        <a href="https://github.com/astral-sh/ruff/issues/8751">#8751</a>
        opened by <a href="https://github.com/ofek">@ofek</a>
        on 2023-11-18 02:53
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/ofek">@ofek</a> on 2023-11-18 02:53</div>
            <div class="timeline-body"><p>I am trying to integrate with Ruff by having a default config that extends the user's config:</p>
<pre><code class="language-toml">extend = &quot;/path/to/user_repo/ruff.toml&quot;

[lint]
select = [
    # snip
]

[lint.per-file-ignores]
&quot;**/tests/**/*&quot; = [
    # snip
]
# snip
</code></pre>
<p>I want to provide the base selection and per-file ignored rules which the user can then modify by ignoring with <code>ignore</code>, selecting more rules with <code>extend-select</code>, and adding additional per-file ignored rules with <code>extend-per-file-ignores</code>.</p>
<p>Currently, the <code>ignore</code> that they define in their file has absolutely no effect. I think this is extremely unexpected and I would argue wrong behavior. It would make more sense from a UX perspective to treat merging as simply a data structure-level operation that only acts upon keys, nothing else, no other logic.</p>
<p>I don't know how I would integrate with this limitation.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2023-11-18 16:05</div>
            <div class="timeline-body"><p>Hi. Would you mind expanding your example a bit more to elucidate your point? I'm having a hard time following your problem.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">configuration</span> added by @zanieb on 2023-11-18 16:05</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ofek">@ofek</a> on 2023-11-18 17:41</div>
            <div class="timeline-body"><p>I'm using <code>ruff check --config my_ruff.toml ...</code> which extends the user's file. If I select a rule the user cannot ignore it, which is unexpected as I would assume exclusions take priority but what's actually happening is there is some extra logic that is preventing this based on the source.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-11-18 23:37</div>
            <div class="timeline-body"><p>Configuration extension is not merely a merge of the <code>select</code> lists, and that's an intentional behavior. (IIRC, this was changed long ago in https://github.com/astral-sh/ruff/pull/2312.)</p>
<p>Instead, the semantics are such that we treat each configuration source as a layer (starting with the root configuration file, then the file that <code>extends</code> it, and so on, and finally, the settings passed in on the CLI). To resolve the set of enabled rules, we resolve the <code>select</code> and <code>ignore</code> for that first layer; then we resolve the <code>select</code> and <code>ignore</code> for the second layer, and apply those changes to the set of selected rules; and so on.</p>
<p>As a concrete example, if your configuration file contains <code>select = [&quot;E&quot;, &quot;F&quot;]</code> and <code>ignore = [&quot;E501&quot;]</code>, and then the user passes <code>--select E501</code> on the command-line, we'd register two sets of selectors: the <code>select</code> and <code>ignore</code> in the configuration file, and then the <code>--select</code> from the command line. To resolve the enabled rules, we'd resolve that first set, which would give us everything from <code>E</code> and <code>F</code> except <code>E501</code>. We'd then resolve the second set, which would enable <code>E501</code>, giving us all of <code>E</code> and <code>F</code> as the final set.</p>
<p>If you &quot;just&quot; merge the keys, you introduce some confusing problems. For example, if the configuration file that you extend has <code>ignore = [&quot;E501&quot;]</code> in it, then it becomes <em>impossible</em> to enable <code>E501</code>. You can't enable it from the file with the <code>extends</code> in it, you can't enable it from the command-line, and so on -- since, in the end, all Ruff would see is a list that includes <code>E501</code> in its <code>ignore</code>, which will always beat out any method selecting <code>E501</code>. (And, in fact, we received issues in the past about those confusing problems, which led to this change, but I can't recall receiving any issues about the <em>current</em> behavior before.)</p>
<p>The problem here IMO is that in the issue as written, <code>extends</code> is being viewed as an unordered operation. Above, you want the configuration file with the <code>extends</code> in it to be the default, but those aren't the semantics of <code>extends</code>. Instead, I think you should be extending the <em>default</em> configuration file, rather than the other way around: you want <em>your file</em> to be defaults, with user configuration layered on top.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ofek">@ofek</a> on 2023-11-19 00:01</div>
            <div class="timeline-body"><p>I'm okay with closing this in favor of https://github.com/astral-sh/ruff/issues/8737</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @ofek on 2023-11-19 00:01</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ofek">@ofek</a> on 2023-11-19 01:46</div>
            <div class="timeline-body"><p>I'm sorry but I have to reopen this because I would like to get others' feedback. I ran into another case of really unexpected behavior as follows.</p>
<p>User config:</p>
<pre><code class="language-toml">extend = &quot;C:\\Users\\ofek\\AppData\\Local\\hatch\\env\\.internal\\fmt\\eof-W-rA\\ruff_defaults.toml&quot;

[lint]
preview = true

[format]
preview = true
</code></pre>
<p>My config:</p>
<pre><code class="language-toml">[lint]
select = [
  ...
]
</code></pre>
<p>Running Ruff without arguments does not enable preview mode even though that is enabled in the target config.</p>
<p>I hear you when you say that this was partially a deliberate choice but please understand that I simply cannot comprehend how config is merged and I'm not exactly a new engineer.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Reopened by @ofek on 2023-11-19 01:46</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-11-19 15:18</div>
            <div class="timeline-body"><p>I just tested this locally and it does work for me.</p>
<p>I have <code>base.toml</code>:</p>
<pre><code class="language-toml">[lint]
select = [&quot;PIE&quot;]
</code></pre>
<p>And then <code>ruff.toml</code>:</p>
<pre><code class="language-toml">extend = &quot;base.toml&quot;

[lint]
preview = true

[format]
preview = true
</code></pre>
<p>Given <code>foo.py</code>:</p>
<pre><code class="language-python">def func():
    x = 1
    pass


def func():
    x = 1
    ...
</code></pre>
<p>Running:</p>
<pre><code class="language-shell">❯ ruff check foo.py -n
foo.py:6:5: PIE790 [*] Unnecessary `pass` statement
foo.py:11:5: PIE790 [*] Unnecessary `...` literal
</code></pre>
<p>The latter violation is preview-only. And if I remove <code>preview = true</code> from <code>ruff.toml</code>, I get:</p>
<pre><code class="language-shell">❯ ruff check foo.py -n
foo.py:6:5: PIE790 [*] Unnecessary `pass` statement
Found 1 error.
[*] 1 fixable with the `--fix` option.
</code></pre>
<p>I then did the same thing with <code>select = [&quot;PL&quot;]</code>, and:</p>
<pre><code class="language-python">def func():
    import os
</code></pre>
<p>Which triggers <code>PLC0415</code>, also a preview rule. In that case, I get:</p>
<pre><code class="language-shell">❯ ruff check foo.py -n
foo.py:2:5: PLC0415 `import` should be at the top-level of a file
Found 1 error.
</code></pre>
<p>And again, if I remove <code>preview = true</code> from <code>ruff.toml</code>, the violation goes away.</p>
<p>Can you provide more information on how you've determined that &quot;Running Ruff without arguments does not enable preview mode even though that is enabled in the target config&quot;?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ofek">@ofek</a> on 2023-11-19 15:59</div>
            <div class="timeline-body"><p>This was user error from passing the wrong config file path on the command line, sorry for the noise!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @ofek on 2023-11-19 15:59</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:34:51 UTC
    </footer>
</body>
</html>
