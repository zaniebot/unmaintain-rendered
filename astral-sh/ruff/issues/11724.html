<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bug: formatting a multiline string twice gets changing results - astral-sh/ruff #11724</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Bug: formatting a multiline string twice gets changing results</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/issues/11724">#11724</a>
        opened by <a href="https://github.com/jasikpark">@jasikpark</a>
        on 2024-06-03 15:26
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/jasikpark">@jasikpark</a> on 2024-06-03 15:26</div>
            <div class="timeline-body"><!--
Thank you for taking the time to report an issue! We're glad to have you involved with Ruff.

If you're filing a bug report, please consider including the following information:

* List of keywords you searched for before creating this issue. Write them down here so that others can find this issue more easily and help provide feedback.
  e.g. "RUF001", "unused variable", "Jupyter notebook"
* A minimal code snippet that reproduces the bug.
* The command you invoked (e.g., `ruff /path/to/file.py --fix`), ideally including the `--isolated` flag.
* The current Ruff settings (any relevant sections from your `pyproject.toml`).
* The current Ruff version (`ruff --version`).
-->

<p>This was found via the <code>fuzz/ruff_formatter_idempotency.rs</code> fuzz target; It should be reproducible with standard ruff format.</p>
<p>Ruff was built from source around (https://github.com/astral-sh/ruff/commit/2b28889ca9d7935488875b5c944a159a2db20a23)</p>
<p>Original code:</p>
<pre><code>
'''
\u{15}

'''
</code></pre>
<p>Formatted once:</p>
<pre><code>&quot;&quot;&quot;
u{15}
&quot;&quot;&quot;

</code></pre>
<p>Formatted twice:</p>
<pre><code>&quot;&quot;&quot;
u{15}&quot;&quot;&quot;

</code></pre>
<p>Original fuzz crash error:</p>
<pre><code>thread '&lt;unnamed&gt;' panicked at fuzz_targets/ruff_formatter_idempotency.rs:31:17:

Reformatting the code a second time resulted in formatting changes.
Input: &quot;\n'''\n\u{15}\n\n'''&quot;
First: &quot;\&quot;\&quot;\&quot;\n\u{15}\n\&quot;\&quot;\&quot;\n&quot;

Second: &quot;\&quot;\&quot;\&quot;\n\u{15}\&quot;\&quot;\&quot;\n&quot;
diff:
--- Formatted Once
+++ Formatted Twice
@@ -1,3 +1,2 @@
 &quot;&quot;&quot;
-
-&quot;&quot;&quot;
+&quot;&quot;&quot;
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @charliermarsh on 2024-06-03 15:26</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">formatter</span> added by @charliermarsh on 2024-06-03 15:26</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @MichaReiser by @MichaReiser on 2024-06-03 15:29</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-06-04 06:28</div>
            <div class="timeline-body"><p>Hmm, I'm having a hard time reproducing this issue. The  original code mentioned in this issue isn't valid syntax and can't be formatted (not a valid unicode escape sequence) (<a href="https://play.ruff.rs/0e161383-1617-473c-86ac-fe2453019e77">playground</a>).</p>
<p>I then tried to replace <code>\u{15}</code> with the corresponding ascii character, but that gets formatted correctly and in a stable way https://play.ruff.rs/3199caf0-e3ae-4d36-ac18-da00822c6af7</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/jasikpark">@jasikpark</a> on 2024-06-04 14:51</div>
            <div class="timeline-body"><p>True original code:</p>
<pre><code>
'''


'''
</code></pre>
<p>Formatted once</p>
<img width="583" alt="Screenshot 2024-06-04 at 9 50 31â€¯AM" src="https://github.com/astral-sh/ruff/assets/10626596/45ffcc08-1556-4ac6-8a1d-1f929e1f67d6">

<p>Formatted twice</p>
<img width="579" alt="image" src="https://github.com/astral-sh/ruff/assets/10626596/17e9a42f-8f27-4e2a-87a8-8c30f607fc2e">

</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-06-04 16:11</div>
            <div class="timeline-body"><p>Hmm, I'm still struggling. Would you mind clicking on the Share button in the playground (of the original code) and share the link here?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/jasikpark">@jasikpark</a> on 2024-06-04 18:45</div>
            <div class="timeline-body"><p>Original: https://play.ruff.rs/797a9277-6c6f-4c35-bc88-fa0d5da9d950</p>
<p>First format: https://play.ruff.rs/53a83f3e-a05e-4366-99f4-7de25b880266</p>
<p>Second format: https://play.ruff.rs/066f3b1c-4130-4590-9576-e025b147c689</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @MichaReiser on 2024-06-05 15:55</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 11:34:05 UTC
    </footer>
</body>
</html>
