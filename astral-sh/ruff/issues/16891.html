<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cannot use star annotation false hit - astral-sh/ruff #16891</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Cannot use star annotation false hit</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/issues/16891">#16891</a>
        opened by <a href="https://github.com/nijel">@nijel</a>
        on 2025-03-21 09:31
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/nijel">@nijel</a></div>
            <div class="timeline-body">Summary
<p>ruff 0.11.1 started to fail with:</p>
<blockquote>
<p>Error: translate/storage/fluent.py:1221:38: SyntaxError: Cannot use star annotation on Python 3.9 (syntax was added in Python 3.11)</p>
</blockquote>
<p>I don&#x27;t think this is a syntax error when the affected code is passing CI tests on Python 3.9 since its introduction.</p>
<p>Problematic code with the error:</p>
<p>https://github.com/translate/translate/pull/5548/files#file-translate-storage-fluent-py-L1221</p>
<p>Reproducer:</p>
<pre><code>def _combine_comments(*comments: str) -&gt; str:
    return &quot;,&quot;.join(comments)
</code></pre>
<p>This works just fine with Python 3.9.21. It can also be properly type checked with mypy on Python 3.9.21.</p>
Version
<p>0.11.1</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2025-03-21 09:37</div>
            <div class="timeline-body"><p>Thank you for reporting! This is fixed on <code>main</code>, we will do a release today to get it out.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2025-03-21 09:37</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2025-03-21 09:40</div>
            <div class="timeline-body"><p>Hmm, actually I might&#x27;ve mis-understood the issue.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Reopened by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2025-03-21 09:42</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">question</span> added by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2025-03-21 09:42</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2025-03-21 09:43</div>
            <div class="timeline-body"><p>So quickly looking at the <code>pyproject.toml</code> in the project, you&#x27;ve configured Ruff&#x27;s <a href="https://github.com/translate/translate/blob/3c9628723899acaee2cd504e6c7dbb16a8f19b77/pyproject.toml#L235">target-version to be 3.9</a>, with preview mode enabled.</p>
<p>This syntax was actually added in Python 3.11 with <a href="https://peps.python.org/pep-0646/">PEP 646</a>.</p>
<p>In preview mode, Ruff will be raising syntax errors by checking whether the syntax actually exists on the configured target version.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2025-03-21 09:45</div>
            <div class="timeline-body"><blockquote>
<p>I don&#x27;t think this is a syntax error when the affected code is passing CI tests on Python 3.9 since its introduction.</p>
</blockquote>
<p>I do get an error when running it under 3.9:</p>
<pre><code>$ pbpaste | uv run --python=3.9 --no-project python -m ast -
Traceback (most recent call last):
  File &quot;/Library/Developer/CommandLineTools/Library/Frameworks/Python3.framework/Versions/3.9/lib/python3.9/runpy.py&quot;, line 197, in _run_module_as_main
    return _run_code(code, main_globals, None,
  File &quot;/Library/Developer/CommandLineTools/Library/Frameworks/Python3.framework/Versions/3.9/lib/python3.9/runpy.py&quot;, line 87, in _run_code
    exec(code, run_globals)
  File &quot;/Library/Developer/CommandLineTools/Library/Frameworks/Python3.framework/Versions/3.9/lib/python3.9/ast.py&quot;, line 1600, in &lt;module&gt;
    main()
  File &quot;/Library/Developer/CommandLineTools/Library/Frameworks/Python3.framework/Versions/3.9/lib/python3.9/ast.py&quot;, line 1596, in main
    tree = parse(source, args.infile.name, args.mode, type_comments=args.no_type_comments)
  File &quot;/Library/Developer/CommandLineTools/Library/Frameworks/Python3.framework/Versions/3.9/lib/python3.9/ast.py&quot;, line 50, in parse
    return compile(source, filename, mode, flags,
  File &quot;&lt;stdin&gt;&quot;, line 1
    def _combine_comments(*comments: *str) -&gt; str:
                                     ^
SyntaxError: invalid syntax
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/nijel">@nijel</a> on 2025-03-21 09:46</div>
            <div class="timeline-body"><p>https://github.com/astral-sh/ruff/pull/16878 seems to address the issue, if I understand it correctly. I just made the report confusing, removed the confusing part now, sorry.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2025-03-21 09:51</div>
            <div class="timeline-body"><p>No problem! Yeah, that does fix your issue :)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2025-03-21 09:51</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 18:49:42 UTC
    </footer>
</body>
</html>
