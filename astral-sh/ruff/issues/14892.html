<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RUF012 should not trigger on SQLModel models - astral-sh/ruff #14892</title>
    <link rel="stylesheet" href="../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../index.html">Back to index</a>
    </div>

    <h1>RUF012 should not trigger on SQLModel models</h1>

    <div class="meta">
        <span class="state state-closed">Closed</span>
        <a href="https://github.com/astral-sh/ruff/issues/14892">#14892</a>
        opened by <a href="https://github.com/scy">@scy</a>
        on 2024-12-10 17:18
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/scy">@scy</a> on 2024-12-10 17:18</div>
            <div class="timeline-body"><p><a href="https://sqlmodel.tiangolo.com/">SQLModel</a> is a project by FastAPI creator Sebastián Ramírez that combines SQLAlchemy models with Pydantic models, allowing you to use Pydantic-validated models for database interactions without duplicating classes.</p>
<p>The base class for these models is <code>SQLModel</code>. As usual for Pydantic models, they can have mutable default values which will be copied when creating an actual instance. However, Ruff's <a href="https://docs.astral.sh/ruff/rules/mutable-class-default/"><code>RUF012</code></a> triggers on these models.</p>
<p>Afaict, Ruff already has <a href="https://github.com/astral-sh/ruff/blob/5fc8e5d80e201654774ccc0d509d6e6d55b6db05/crates/ruff_linter/src/rules/ruff/rules/helpers.rs#L180-L192">exceptions for Pydantic's <code>BaseModel</code> and similar classes</a>; I guess these should basically be extended to the <code>SQLModel</code> class…?</p>
<p><a href="https://github.com/fastapi/sqlmodel/blob/8c275289f228a2834c7285972a5006229f41f3cf/sqlmodel/main.py#L772">The <code>SQLModel</code> code says that it's a subclass of <code>BaseModel</code></a>, not sure why Ruff doesn't recognize it; Python does.</p>
<p>The following code demonstrates the behavior:</p>
<pre><code class="language-python">from __future__ import annotations

from pydantic import BaseModel
from sqlmodel import SQLModel


class Foo(SQLModel):
    id: int
    bars: list[Bar] = []


class Bar(SQLModel):
    id: int
    name: str


one = Foo(id=1)
two = Foo(id=2)

one.bars.append(Bar(id=1, name=&quot;one&quot;))
two.bars.append(Bar(id=2, name=&quot;two&quot;))

print(one.bars)  # [Bar(id=1, name='one')]
print(two.bars)  # [Bar(id=2, name='two')]
print(isinstance(one, BaseModel))  # True
</code></pre>
<p>Thanks in advance for looking into this!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">rule</span> added by @dylwil3 on 2024-12-10 18:52</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">needs-decision</span> added by @dylwil3 on 2024-12-10 18:52</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dylwil3">@dylwil3</a> on 2024-12-10 18:58</div>
            <div class="timeline-body"><p>Thanks for submitting this issue, it's cool to learn about <code>SQLModel</code>!</p>
<blockquote>
<p><a href="https://github.com/fastapi/sqlmodel/blob/8c275289f228a2834c7285972a5006229f41f3cf/sqlmodel/main.py#L772">The SQLModel code says that it's a subclass of BaseModel</a>, not sure why Ruff doesn't recognize it; Python does.</p>
</blockquote>
<p>In general it requires more advanced type inference than what is currently available for Ruff to just &quot;know&quot; that <code>SQLModel</code> is a subclass of <code>pydantic.BaseModel</code>. However, we could theoretically teach Ruff this special case (or just modify the code snippet you linked to also allow subclasses of <code>SQLModel</code>).</p>
<p>This seems somewhat reasonable, but I do worry about where we draw the line (prior to having a type checker) for this type of manually included type information, especially for types outside the standard library.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/scy">@scy</a> on 2024-12-10 19:27</div>
            <div class="timeline-body"><p>Thanks for getting back to me so quickly. I understand that adding more and more exceptions to the codebase for third-party libraries isn't a sustainable thing to do.</p>
<p>How about exposing a setting, like <a href="https://docs.astral.sh/ruff/settings/#lint_pep8-naming_classmethod-decorators"><code>lint.pep8-naming.classmethod-decorators</code></a> or <a href="https://docs.astral.sh/ruff/settings/#lint_flake8-bugbear_extend-immutable-calls"><code>lint.flake8-bugbear.extend-immutable-calls</code></a>? This would allow users to specify their own exceptions instead of littering <code>noqa</code> comments all over the place or disabling the rule altogether.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sjdemartini">@sjdemartini</a> on 2024-12-10 23:01</div>
            <div class="timeline-body"><p>I too would appreciate a setting as @scy is suggesting, which allows users to specify their own classes/subclasses that should be excluded from RUF012. I imagine the Ruff type-inference effort is still a ways off, so this could be useful in the meantime.</p>
<p>For instance, Pydantic docs recommend creating your own subclass of <code>BaseModel</code> for any &quot;global&quot; behavior changes https://docs.pydantic.dev/latest/concepts/config/#change-behaviour-globally, so using that common pattern and importing the <code>BaseModel</code> subclass across other files will inevitably lead to a lot of false positives with RUF012 (as also noted in https://github.com/astral-sh/ruff/issues/13630).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-12-11 07:49</div>
            <div class="timeline-body"><p>I slightly prefer adding <code>SQLModel</code> for now as it solves the common case at a very low cost.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dylwil3">@dylwil3</a> on 2024-12-11 19:42</div>
            <div class="timeline-body"><p>I think I agree. Let's add <code>SQLModel</code> manually for now and forego the new configuration option in favor of type inference.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">needs-decision</span> removed by @dylwil3 on 2024-12-11 19:42</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">help wanted</span> added by @dylwil3 on 2024-12-11 19:42</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">accepted</span> added by @dylwil3 on 2024-12-11 19:42</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/14949.html">astral-sh/ruff#14949</a> on 2024-12-12 23:58</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @dylwil3 on 2024-12-13 04:19</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @dylwil3 on 2024-12-13 04:19</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/13630.html">astral-sh/ruff#13630</a> on 2025-02-07 17:04</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:28:14 UTC
    </footer>
</body>
</html>
