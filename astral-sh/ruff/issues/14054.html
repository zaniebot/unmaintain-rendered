<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[red-knot] Remove `Definition` from `Class` and `FunctionType` - astral-sh/ruff #14054</title>
    <link rel="stylesheet" href="../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../index.html">Back to index</a>
    </div>

    <h1>[red-knot] Remove `Definition` from `Class` and `FunctionType`</h1>

    <div class="meta">
        <span class="state state-closed">Closed</span>
        <a href="https://github.com/astral-sh/ruff/issues/14054">#14054</a>
        opened by <a href="https://github.com/MichaReiser">@MichaReiser</a>
        on 2024-11-02 17:18
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-11-02 17:18</div>
            <div class="timeline-body"><p>The <code>ClassType</code> and <code>FunctionType</code> both store a back reference to their origin definition, and the definition holds on to the AST node. This is problematic because <code>Type</code>s are visible cross-module:</p>
<ul>
<li>If a <code>Type</code> changes (no longer compares equal), it requires redoing type inference for all dependent types (modules). This gets worse because <code>Type</code>s flow and compose. E.g., every union containing a <code>ClassType</code> would have to be thrown away if the node's AST location changes (and, in turn, all results that depend on that Union...). Fortunately, this currently works thanks to Salsa tracking each struct field on its own. However, it will break if we change to use coarse-grained salsa dependencies for better performance.</li>
<li>Incrementally checking a program after restoring from a persistent cache shouldn't require reparsing any unchanged modules. Instead, Red Knot resolves the types directly from the cache. For this to work efficiently, it's important that <code>Type</code>s have no backreference to the AST. Otherwise, deserializing the <code>Type</code> requires reparsing the module or storing and deserializing the AST in/from the persistent cache. But it's not just the cost of deserialization; this also comes at a cost that Red Knot now holds on to ASTs that are never needed. It shouldn't be necessary to revisit the AST of standard library modules after they've been type-checked.</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by @MichaReiser on 2024-11-02 17:18</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @MichaReiser by @MichaReiser on 2024-11-02 17:18</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-11-04 08:17</div>
            <div class="timeline-body"><p>We should also remove <code>ScopeId</code> from <code>ClassType</code> because it has a reference to <code>node</code>.</p>
<p>Another approach to removing <code>Definition</code> and <code>ScopeId</code> (which both seem useful) is to decouple <code>Definition</code> and <code>ScopeId</code> from the AST node. That seems like a better solution to avoid similar foot-guns in the future.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/14087.html">astral-sh/ruff#14087</a> on 2024-11-04 15:09</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @MichaReiser on 2024-11-05 08:02</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:28:14 UTC
    </footer>
</body>
</html>
