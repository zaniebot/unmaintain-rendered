<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TCH002 false positive with pydantic subclassing - astral-sh/ruff #8725</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>TCH002 false positive with pydantic subclassing</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/issues/8725">#8725</a>
        opened by <a href="https://github.com/sorgfresser">@sorgfresser</a>
        on 2023-11-16 16:45
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sorgfresser">@sorgfresser</a></div>
            <div class="timeline-body">

<p>I am using ruff together with pydantic which works well most of the times, but here it does not seem to get it right.
So sometimes, if enough subclasses etc. are involved, it happens that ruff triggers a TCH002 on fields in a pydantic model - which is plain wrong as they have to be defined properly, not only in a type checking block.</p>
<p>As an example</p>
<pre><code>from __future__ import annotations

from abc import ABC, abstractmethod
from typing import ClassVar, Generic, TypeVar

from langchain.schema import BaseMessage
from pydantic import BaseModel, SerializeAsAny


class SuperFoo(BaseModel, ABC):
    &quot;&quot;&quot;Base class foo.&quot;&quot;&quot;

    @abstractmethod
    def value(self) -&gt; int:
        &quot;&quot;&quot;Return the value of foo.&quot;&quot;&quot;


class ChildFoo(SuperFoo):
    &quot;&quot;&quot;Subclass foo.&quot;&quot;&quot;

    def value(self) -&gt; int:
        &quot;&quot;&quot;Return the value of foo.&quot;&quot;&quot;
        return 0


_BT = TypeVar(&quot;_BT&quot;, bound=SuperFoo)


class _SuperBar(BaseModel, ABC, Generic[_BT]):
    something: SerializeAsAny[_BT]
    type_var: ClassVar[type[_BT]]


class ChildBar(_SuperBar[ChildFoo]):
    &quot;&quot;&quot;Subclass bar.&quot;&quot;&quot;

    type_var = ChildFoo
    where_it_breaks: list[BaseMessage]


if __name__ == &quot;__main__&quot;:
    # Create ChildBar
    child = ChildBar(where_it_breaks=[], something=ChildFoo())
</code></pre>
<p>Run with <code>ruff &lt;filename&gt; --no-cache</code> and the following pyproject.toml config</p>
<pre><code>[tool.ruff]
target-version = &#x27;py39&#x27;
line-length = 120
select = [&#x27;ALL&#x27;]
ignore = [
    &#x27;ANN101&#x27;, # don&#x27;t type self
    &#x27;D100&#x27;, &#x27;D104&#x27;, &#x27;D203&#x27;, &#x27;D212&#x27;, # limited docs
]

[tool.ruff.flake8-type-checking]
runtime-evaluated-base-classes = [&quot;pydantic.BaseModel&quot;]

[tool.ruff.pyupgrade]
keep-runtime-typing = true
</code></pre>
<p>raises an</p>
<pre><code>TCH002 Move third-party import `langchain.schema.BaseMessage` into a type-checking block
</code></pre>
<p>I thought the <code>pydantic.BaseModel</code> as runtime-evaluated-base-class should fix it, but seemingly it does not.
I believe this can be considered a bug, but I might be missing something.</p>
<p>This happened with ruff version <code>0.1.5</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-11-16 18:01</div>
            <div class="timeline-body"><p>So we don&#x27;t currently traverse the full class hierarchy, within a file or across files. So if you wanted <code>ChildBar</code> to be considered a runtime-evaluated class, you&#x27;d need to either add <code>BaseModel</code> as a <em>direct</em> parent class, or add <code>_SuperBar</code> to the list of runtime-evaluated base classes. These are just limitations in Ruff&#x27;s semantic model right now.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">multifile-analysis</span> added by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-11-16 18:01</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-11-16 18:02</div>
            <div class="timeline-body"><p>I&#x27;m gonna merge this into <a href="https://github.com/astral-sh/ruff/issues/7893">astral-sh/ruff#7893</a> -- thank you fro the clear write-up!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-11-16 18:02</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-11-16 18:03</div>
            <div class="timeline-body"><p>How much of the problem would it solve, for you, if we were able to support this for classes defined in the same file, like above? Or is that not-very-useless unless it also works for classes imported from other files?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sorgfresser">@sorgfresser</a> on 2023-11-19 19:39</div>
            <div class="timeline-body"><p>Thanks a lot for the response!</p>
<p>Actually being aware of the incomplete parsing is already a huge benefit. It will most certainly not solve all of my problems, but parsing at least classes within the same file would be helpful - I think there is only one case I can think of where the same file would be insufficient for our codebase.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-11-19 20:12</div>
            <div class="timeline-body"><p>No worries! In the next release, this should work for subclasses within the same file -- I just fixed it today. Hopefully that helps!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">type-inference</span> added by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-10-24 14:34</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">multifile-analysis</span> removed by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-10-24 14:34</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 18:48:46 UTC
    </footer>
</body>
</html>
