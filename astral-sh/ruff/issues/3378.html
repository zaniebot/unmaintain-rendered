<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>F401 has started being incorrectly missed - astral-sh/ruff #3378</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>F401 has started being incorrectly missed</h1>

    <div class="meta">
        <span class="state state-closed">Closed</span>
        <a href="https://github.com/astral-sh/ruff/issues/3378">#3378</a>
        opened by <a href="https://github.com/henryiii">@henryiii</a>
        on 2023-03-07 03:47
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/henryiii">@henryiii</a> on 2023-03-07 03:47</div>
            <div class="timeline-body"><p>This pattern suddenly has stopped triggering F401:</p>
<pre><code class="language-python">try:
   import something  # noqa: F401
except ModuleNotFound:
   ...
</code></pre>
<p>If <code>something</code> is never used, the F401 is correct. It's helpful to tell the reader that this is not going to be used later, and it's a hint that this is actually often an incorrect pattern (the correct one in Python 3.4+ is to use <code>importlib.utils.find_spec(&quot;something&quot;)</code>, which won't trigger the error and will be faster, since it doesn't have to run the <code>Loader</code>, and won't trigger side effects).</p>
<p>I couldn't find anything in the changelogs or PRs about it, but happened between v0.0.253 and v0.0.254. https://github.com/scikit-hep/hist/pull/482 and https://github.com/pypa/build/pull/585 are two recent cases where this is happening.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-03-07 03:50</div>
            <div class="timeline-body"><p>For context the relevant PR and Issue is https://github.com/charliermarsh/ruff/pull/3288 and https://github.com/charliermarsh/ruff/issues/3279, but I'm guessing you don't agree with the change :)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/henryiii">@henryiii</a> on 2023-03-07 04:15</div>
            <div class="timeline-body"><p>It should have been in the changelogs, and no, I don't like the change. It wasn't broken. If you import something, you should use it (that's the point of the check). If you only want to ask if something is there, that's what <code>importlib.util.find_spec</code> is useful for. It's faster and doesn't trigger side effects. And if you really want the side effects, then it deserves a noqa.</p>
<p>What about just making the error message smarter in the case it's inside the block, giving the <code>importlib.util.find_spec</code> suggestion? As it stands, this is a regression from the matching Flake8 check too, Ruff is less useful now than Flake8 for this check. If I have a &quot;find unused imports&quot; checks, I want to find unused imports, including inside a try block. They are still unused. :)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/henryiii">@henryiii</a> on 2023-03-07 04:16</div>
            <div class="timeline-body"><p><code>importlib.util.find_spec</code> used to be <code>importlib.util.find_module</code>, which I think was more discoverable, but it triggered the import side effects, so it was replaced in Python 3.4 with <code>find_spec</code>. But that's exactly what it's for.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-03-07 04:24</div>
            <div class="timeline-body"><p>Yeah I hear you, it <em>is</em> in the changelog, but it's marked as a bugfix rather than a breaking change (https://github.com/charliermarsh/ruff/releases/tag/v0.0.254 -- search for <code>ModuleNotFound</code>).</p>
<p>I think you're right that we can do better here. Just to explain the reasoning a bit more: prior to this change, the autofix was unsafe in those cases, because the import itself affected the <code>try</code>-<code>catch</code>. My primary motivation in changing the rule was to avoid autofix breakages due to code that <em>depended</em> on the import (i.e., cases in which the import was effectively being <em>used</em> by the <code>try</code>-<code>catch</code>).</p>
<p>If we revert, and add a more refined error message, would you agree that we should still avoid autofixing, since the import in that case <em>does</em> have a side-effect?</p>
<p>(Aside: we could also look at the <code>except</code> block and continue flagging in the event that it's empty. Would that have mattered here?)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">question</span> added by @charliermarsh on 2023-03-07 04:25</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/henryiii">@henryiii</a> on 2023-03-07 14:56</div>
            <div class="timeline-body"><p>Ahh, I was searching for the error code.</p>
<p>I agree about the autofix; I've had that happen once, and it's a bit annoying. But all auto fixes that remove lines of code can be - T201 can delete all <code>print(...)</code> lines, F401 can delete one or more imports just because you misspell a usage, etc. Though this is a particularly bad because it could be what you intended to do. But knowing how to check and revert changes &amp; noqa them is a required prerequisite to use any autofixer, IMO.</p>
<p>I'd agree that keeping it from being autofixed would be very helpful. In fact, I think the problem is that it's the wrong autofix, since this structure is not a no-op. It would be better to instead autofix it into the <code>importlib.util.find_spec</code> form! (still a small change of behavior, as it removes side effects, but much closer to the original intent and likely to be the desired behavior, vs. removing it).</p>
<p>The <code>except blocks</code> might be empty. If you look at the <code>pypa/build</code> PR above, that had an empty <code>except</code> block. The point of that one was to verify that <code>flit_core</code> was not installed. I sometimes have to do the same thing with <code>setuptools_scm</code>, since it changes the behavior of (all usages) of setuptools. Etc.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-03-07 15:22</div>
            <div class="timeline-body"><p>Yeah it's tricky.</p>
<p>If the user has:</p>
<pre><code class="language-py">try:
   import something
except ModuleNotFound:
   pass
</code></pre>
<p>And <code>something</code> <em>was</em> used, but the usages were removed, and then we autofix it to:</p>
<pre><code class="language-py">try:
   importlib.util.find_spec(&quot;something&quot;)  # I can't remember the exact API
except ModuleNotFound:
   ...
</code></pre>
<p>That could also be unexpected, but of course it's hard to know, we don't have enough information there to confidently infer the intent.</p>
<p>As a compromise, then, what we could do is:</p>
<ul>
<li>Flag unused imports in <code>ModuleNotFoundError</code>-handled bodies.</li>
<li>Avoid automatically fixing them.</li>
<li>Include a modified &quot;Did you mean...?&quot;-style error message for those cases.</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/henryiii">@henryiii</a> on 2023-03-07 15:53</div>
            <div class="timeline-body"><p>It's:</p>
<pre><code class="language-python">if importlib.util.find_spec(&quot;something&quot;) is None:
    ...
</code></pre>
<p>;) Also, autofixing always has this issue. Deleting unused variables, etc all can really make a mess if you make a mistake. I even have a few checks I usually suggest marking unfixable - see https://scikit-hep.org/developer/style#ruff - just because of how easy it is to have them be a bit surprising. But, IMO, that's completely okay - autofixers have permission to change code - if you didn't like it doing that, you wouldn't enable <code>--fix</code> in the first place. :) They are fantastic though if you really need the fix on a large codebase, and tweaking settings a bit to get the fix (like adding <code>--fix</code> or commenting out an unfixable line) is much faster than manually editing tens or hundreds of lines.</p>
<p>I'm not very seriously suggesting an autofix to this, though a suggestion including <code>find_spec</code> would be great. I think the &quot;compromise&quot; suggestion sounds close to ideal.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @charliermarsh by @charliermarsh on 2023-03-08 05:02</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-03-21 00:26</div>
            <div class="timeline-body"><p>I still intend to change this.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/3658.html">astral-sh/ruff#3658</a> on 2023-03-21 23:14</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2023-03-22 17:03</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:34:49 UTC
    </footer>
</body>
</html>
