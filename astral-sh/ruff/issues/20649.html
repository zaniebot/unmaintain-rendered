<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Improve notebook cell alignment in diagnostics - astral-sh/ruff #20649</title>
    <link rel="stylesheet" href="../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../index.html">Back to index</a>
    </div>

    <h1>Improve notebook cell alignment in diagnostics</h1>

    <div class="meta">
        <span class="state state-open">Open</span>
        <a href="https://github.com/astral-sh/ruff/issues/20649">#20649</a>
        opened by <a href="https://github.com/ntBre">@ntBre</a>
        on 2025-09-30 15:58
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/ntBre">@ntBre</a> on 2025-09-30 15:58</div>
            <div class="timeline-body"><p>This is somewhat related to https://github.com/astral-sh/ruff/issues/20648, but when rendering diagnostics for notebooks, there is sometimes an offset between different cells' line number separators, if the cells have different numbers of lines:</p>
<p>https://github.com/astral-sh/ruff/blob/bedfc6fd063e08f4d1e76ae8a780162404079298/crates/ruff/tests/format.rs#L683-L709</p>
<p>This example shows two discontinuities, one from the <a href="https://github.com/astral-sh/ruff/blob/bedfc6fd063e08f4d1e76ae8a780162404079298/crates/ruff/src/commands/format.rs#L767-L778">manual width calculation</a> in the formatter (the --&gt; arrow in the header is misaligned relative to the first cell), which uses the maximum cell line number, and a second from the diff code shared with the linter (the header and line number separators for cell 4 are offset relative to the earlier cells because it has 10 lines).</p>
<p>The tricky part here is that we're calculating the width per-cell by inspecting the actual <code>TextDiff</code> from the <code>similar</code> crate:</p>
<p>https://github.com/astral-sh/ruff/blob/bedfc6fd063e08f4d1e76ae8a780162404079298/crates/ruff_db/src/diagnostic/render/full.rs#L162-L165</p>
<p>I think the most promising approach here would be to introduce an intermediate representation for the diff lines, much like <code>DisplayLine</code> in <code>annotate-snippets</code> and thus the relation to #20648. This would allow us to get a precise line number from the actual <code>similar::TextDiff</code>, but without storing all of the diffs at once. A more naive approach would just be something like:</p>
<pre><code class="language-rust">let diffs: Vec&lt;_&gt; = cells.into_iter().map(|cell| TextDiff::from_lines(...)).collect();
let lineno_width = diffs.iter().max_by(...);

for diff in diffs {
    // existing rendering code
}
</code></pre>
<p>This might also be sufficient, but I think adding something like <code>DiffLine</code> would help with #20648 eventually too. A third approach would be to reuse the manual width calculation from the formatter, but we'd also like to move away from that, especially as it relies on some internal details of the <code>similar</code> crate.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">needs-design</span> added by @ntBre on 2025-09-30 15:58</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">diagnostics</span> added by @ntBre on 2025-09-30 15:58</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:28:16 UTC
    </footer>
</body>
</html>
