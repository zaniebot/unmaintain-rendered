<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[red-knot] Output is not colorised even if `--color=always` is specified with `--output-format=concise` - astral-sh/ruff #17232</title>
    <link rel="stylesheet" href="../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../index.html">Back to index</a>
    </div>

    <h1>[red-knot] Output is not colorised even if `--color=always` is specified with `--output-format=concise`</h1>

    <div class="meta">
        <span class="state state-closed">Closed</span>
        <a href="https://github.com/astral-sh/ruff/issues/17232">#17232</a>
        opened by <a href="https://github.com/AlexWaygood">@AlexWaygood</a>
        on 2025-04-06 15:10
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-04-06 15:10</div>
            <div class="timeline-body"><h3>Summary</h3>
<p>If you specify <code>--output-format=concise</code>, <code>--color</code> appears to have no effect. This makes the output quite hard to read:</p>
<details>

<p><img src="https://github.com/user-attachments/assets/1dd7be50-6ad0-46b4-83e6-5d85f8a5421b" alt="Image" /></p>
</details>

<p>And it's different to what Ruff does with <code>--output-format=concise</code>:</p>
<details>

<p><img src="https://github.com/user-attachments/assets/341c5a48-8945-4b40-897c-c4c51c50525e" alt="Image" /></p>
</details>

</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @AlexWaygood on 2025-04-06 15:10</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">diagnostics</span> added by @AlexWaygood on 2025-04-06 15:10</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by @AlexWaygood on 2025-04-06 15:10</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone "Red Knot Alpha" by @AlexWaygood on 2025-04-06 15:11</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-04-06 16:58</div>
            <div class="timeline-body"><p>@BurntSushi could you take a look at this. This is probably easy to fix (I assume we simply aren't colorizing the output)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @BurntSushi by @BurntSushi on 2025-04-07 12:13</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Kalmaegi">@Kalmaegi</a> on 2025-04-18 13:30</div>
            <div class="timeline-body"><p>Can I try to fix this issue?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2025-04-18 13:36</div>
            <div class="timeline-body"><p>@Kalmaegi Go for it! I haven't started this yet, so it's all yours.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @Kalmaegi by @BurntSushi on 2025-04-18 13:36</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Kalmaegi">@Kalmaegi</a> on 2025-04-18 15:23</div>
            <div class="timeline-body"><p>https://github.com/astral-sh/ruff/blob/main/crates/ruff_db/src/diagnostic/render.rs#L61-L85</p>
<pre><code>impl std::fmt::Display for DisplayDiagnostic&lt;'_&gt; {
    fn fmt(&amp;self, f: &amp;mut std::fmt::Formatter) -&gt; std::fmt::Result {
        if matches!(self.config.format, DiagnosticFormat::Concise) {
            match self.diag.severity() {
                Severity::Info =&gt; f.write_str(&quot;info&quot;)?,
                Severity::Warning =&gt; f.write_str(&quot;warning&quot;)?,
                Severity::Error =&gt; f.write_str(&quot;error&quot;)?,
                Severity::Fatal =&gt; f.write_str(&quot;fatal&quot;)?,
            }

            write!(f, &quot;[{rule}]&quot;, rule = self.diag.id())?;
            if let Some(span) = self.diag.primary_span() {
                write!(f, &quot; {path}&quot;, path = self.resolver.path(span.file()))?;
                if let Some(range) = span.range() {
                    let input = self.resolver.input(span.file());
                    let start = input.as_source_code().source_location(range.start());
                    write!(f, &quot;:{line}:{col}&quot;, line = start.row, col = start.column)?;
                }
                write!(f, &quot;:&quot;)?;
            }
            return writeln!(f, &quot; {}&quot;, self.diag.concise_message());
        }

        let resolved = Resolved::new(&amp;self.resolver, self.diag);
        let renderable = resolved.to_renderable(self.config.context);
        for diag in renderable.diagnostics.iter() {
            writeln!(f, &quot;{}&quot;, self.annotate_renderer.render(diag.to_annotate()))?;
        }
        writeln!(f)
    }
}
</code></pre>
<p>I think I might have found the issue. Currently, for the concise mode, we manually concatenate and call write for output, while for the full mode, we construct a render object. I can think of two possible fixes, but I'm not sure which one is better:</p>
<p>Add color handling directly in the write section of the concise branch â€“ straightforward, but a bit tedious.</p>
<p>Alternatively, could we also construct a render object for primary_span, letting it handle colors internally?</p>
<p>I'm not entirely sure if my approach is correct. Any help would be greatly appreciated!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2025-04-18 16:35</div>
            <div class="timeline-body"><p>I think any way you slice it, you'll need to add colors the tedious way. If you make a render object, that will do the &quot;verbose&quot; output. So the concise output fundamentally has to do its own thing and add colors to itself.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/17479.html">astral-sh/ruff#17479</a> on 2025-04-19 13:29</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @MichaReiser on 2025-04-29 14:07</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:28:15 UTC
    </footer>
</body>
</html>
