<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>D406 removes colons where D416 adds them - astral-sh/ruff #13139</title>
    <link rel="stylesheet" href="../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../index.html">Back to index</a>
    </div>

    <h1>D406 removes colons where D416 adds them</h1>

    <div class="meta">
        <span class="state state-closed">Closed</span>
        <a href="https://github.com/astral-sh/ruff/issues/13139">#13139</a>
        opened by <a href="https://github.com/maxschulz-COL">@maxschulz-COL</a>
        on 2024-08-28 12:11
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/maxschulz-COL">@maxschulz-COL</a> on 2024-08-28 12:11</div>
            <div class="timeline-body"><ul>
<li>List of keywords you searched for before creating this issue. Write them down here so that others can find this issue more easily and help provide feedback.</li>
</ul>
<p>&quot;section-name-ends-in-colon&quot;, &quot;D416&quot;, &quot;removed&quot;, &quot;autofix&quot;</p>
<ul>
<li>A minimal code snippet that reproduces the bug.
Ruff seems to auto-fix</li>
</ul>
<pre><code class="language-py">def foo(a: str) -&gt; str:
    &quot;&quot;&quot;Foo bar.

    Args:
        a: Some argument.

    Examples
        Some explanation here.
        &gt;&gt;&gt; bla bla bla

    &quot;&quot;&quot;
    return a
</code></pre>
<p>to</p>
<pre><code class="language-py">def foo(a: str) -&gt; str:
    &quot;&quot;&quot;Foo bar.

    Args:
        a: Some argument.

    Examples:
        Some explanation here.
        &gt;&gt;&gt; bla bla bla

    &quot;&quot;&quot;
    return a
</code></pre>
<p>, but it changes (in my eyes erroneously?):</p>
<pre><code class="language-py">def foo(a: str) -&gt; str:
    &quot;&quot;&quot;Foo bar.

    Examples:
        Some explanation here.
        &gt;&gt;&gt; bla bla bla

    &quot;&quot;&quot;
    return a
</code></pre>
<p>to</p>
<pre><code class="language-py">def foo(a: str) -&gt; str:
    &quot;&quot;&quot;Foo bar.

    Examples
        Some explanation here.
        &gt;&gt;&gt; bla bla bla

    &quot;&quot;&quot;
    return a
</code></pre>
<p>Should this be the case?</p>
<ul>
<li><p>The command you invoked (e.g., <code>ruff /path/to/file.py --fix</code>), ideally including the <code>--isolated</code> flag.
Any ruff command with autofix</p>
</li>
<li><p>The current Ruff settings (any relevant sections from your <code>pyproject.toml</code>).</p>
</li>
</ul>
<pre><code class="language-toml">[tool.ruff]
line-length = 120
target-version = &quot;py38&quot;

[tool.ruff.lint]
# see: https://beta.ruff.rs/docs/rules/
ignore = [
  &quot;D104&quot;,  # undocumented-public-package
  &quot;D401&quot;,  # first-line should be in imperative mood
  # D407 needs to be ignored as it otherwise messes up the formatting in our API docs
  &quot;D407&quot;  # missing dashed underline after section
]
ignore-init-module-imports = true  # TODO: remove as deprecated soon
select = [
  &quot;E&quot;,  # pycodestyle errors
  &quot;W&quot;,  # pycodestyle warnings
  &quot;F&quot;,  # pyflakes
  &quot;I&quot;,  # isort
  &quot;D&quot;,  # pydocstyle
  &quot;T201&quot;,  # print
  &quot;C4&quot;,  # flake8-comprehensions
  &quot;RUF&quot;,  # Ruff-specific rules
  &quot;PL&quot;  # pylint
]
</code></pre>
<ul>
<li>The current Ruff version (<code>ruff --version</code>).
<code>0.6.2</code></li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-08-28 15:43</div>
            <div class="timeline-body"><p>Ahhh, it took me a little bit of time to reproduce this, because it seems that while it's D416 <em>adding</em> the colon to your first snippet, it's D406 that's <em>removing</em> them from your second snippet! So <code>cargo run -- check --select=D416 --no-cache --isolated --fix --diff foo.py</code> is e.g. not sufficient to reproduce this.</p>
<p>Anyway, I've now reproduced it!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">docstring</span> added by @AlexWaygood on 2024-08-28 15:43</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "D416 removes colons where it should actually add them" to "D406 removes colons where D416 adds them" by @AlexWaygood on 2024-08-28 15:59</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-08-28 16:39</div>
            <div class="timeline-body"><p>So I think the reason for this is that Ruff is inferring the incorrect <a href="https://docs.astral.sh/ruff/settings/#lint_pydocstyle_convention">docstring convention</a>. Not sure yet whether it's inferring <code>pep257</code> or <code>numpy</code> -- but if you run e.g. <code>ruff check baz.py --no-cache --select=D406 --fix --diff --config 'lint.pydocstyle.convention = &quot;google&quot;'</code> (where <code>baz.py</code> has your second snippet in it), you'll find that no errors are emitted. Whereas if you run either <code>ruff check baz.py --no-cache --select=D406 --fix --diff --config 'lint.pydocstyle.convention = &quot;pep257&quot;'</code> or <code>ruff check baz.py --no-cache --select=D406 --fix --diff --config 'lint.pydocstyle.convention = &quot;numpy&quot;'</code>, the error you're reporting is emitted. As a quick fix (that will avoid this whole category of errors), you can explicitly set the <code>lint.pydocstyle.convention</code> setting in your <code>pyproject.toml</code> file to <code>&quot;google&quot;</code>.</p>
<p>I'll keep this open for now though, since I believe we infer the docstring convention in some of our other rules... if so, we should maybe try to do that here as well. (Or maybe we already do? If so, we should do it better, since it's pretty obvious to me that you're using <code>google</code> conventions!)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-08-28 16:48</div>
            <div class="timeline-body"><p>Okay, inserting these debug prints confirms that because you haven't explicitly selected a docstring convention in your <code>pyproject.toml</code> file, we try to infer the convention -- and then for some reason we infer the convention as <code>numpy</code>, when it clearly should be <code>google</code>.</p>
<pre><code class="language-diff">--- a/crates/ruff_linter/src/docstrings/styles.rs
+++ b/crates/ruff_linter/src/docstrings/styles.rs
@@ -2,7 +2,7 @@ use crate::docstrings::google::GOOGLE_SECTIONS;
 use crate::docstrings::numpy::NUMPY_SECTIONS;
 use crate::docstrings::sections::SectionKind;
 
-#[derive(Copy, Clone)]
+#[derive(Copy, Clone, Debug)]
 pub(crate) enum SectionStyle {
     Numpy,
     Google,
diff --git a/crates/ruff_linter/src/rules/pydocstyle/rules/sections.rs b/crates/ruff_linter/src/rules/pydocstyle/rules/sections.rs
index 95e0c46af..9fdb344b1 100644
--- a/crates/ruff_linter/src/rules/pydocstyle/rules/sections.rs
+++ b/crates/ruff_linter/src/rules/pydocstyle/rules/sections.rs
@@ -1327,10 +1327,10 @@ pub(crate) fn sections(
     section_contexts: &amp;SectionContexts,
     convention: Option&lt;Convention&gt;,
 ) {
-    match convention {
+    match dbg!(convention) {
         Some(Convention::Google) =&gt; parse_google_sections(checker, docstring, section_contexts),
         Some(Convention::Numpy) =&gt; parse_numpy_sections(checker, docstring, section_contexts),
-        Some(Convention::Pep257) | None =&gt; match section_contexts.style() {
+        Some(Convention::Pep257) | None =&gt; match dbg!(section_contexts.style()) {
             SectionStyle::Google =&gt; parse_google_sections(checker, docstring, section_contexts),
             SectionStyle::Numpy =&gt; parse_numpy_sections(checker, docstring, section_contexts),
</code></pre>
<p>This seems like a clear bug to me.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @AlexWaygood on 2024-08-28 16:48</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/maxschulz-COL">@maxschulz-COL</a> on 2024-08-28 16:51</div>
            <div class="timeline-body"><p>Wow well investigated!!!</p>
<p>So I can fix the issue by setting the template, but it is also a bug that other user might benefit from having fixed?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-08-28 16:52</div>
            <div class="timeline-body"><p>Exactly! I'm working on a fix now.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @AlexWaygood by @AlexWaygood on 2024-08-28 16:52</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/13142.html">astral-sh/ruff#13142</a> on 2024-08-28 18:00</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../mckinsey/vizro/pulls/661.html">mckinsey/vizro#661</a> on 2024-08-29 09:59</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @AlexWaygood on 2024-08-29 15:33</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:28:13 UTC
    </footer>
</body>
</html>
