<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>F821 not recognizing `requires-python` in `pyproject.toml` - astral-sh/ruff #14813</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>F821 not recognizing <code>requires-python</code> in <code>pyproject.toml</code></h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/issues/14813">#14813</a>
        opened by <a href="https://github.com/CNSeniorious000">@CNSeniorious000</a>
        on 2024-12-06 11:50
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/CNSeniorious000">@CNSeniorious000</a> on 2024-12-06 11:50</div>
            <div class="timeline-body"><p>I tried to use <code>anext</code> and <code>aiter</code> in a project configured with <code>requires-python = &quot;~=3.10&quot;</code>, but Ruff still complaining</p>
<pre><code>F821 Undefined name `anext`. Consider specifying `requires-python = &quot;&gt;= 3.10&quot;` or `tool.ruff.target-version = &quot;py310&quot;` in your `pyproject.toml` file.
  |
8 | async def main():
9 |     print(anext(g()))
  |           ^^^^^ F821
  |
</code></pre>
<p>Here is a reproduction repository:</p>
<p>https://github.com/CNSeniorious000/ruff-F821-repro</p>
<p>See these workflow logs:</p>
<p>https://github.com/CNSeniorious000/ruff-F821-repro/actions/runs/12198261365/job/34029609880#step:5:13</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-12-06 11:55</div>
            <div class="timeline-body"><p>If you add <code>[tool.ruff]</code> (even followed by nothing else) to your <code>pyproject.toml</code>, then we'll read the <code>requires-python</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">question</span> added by @charliermarsh on 2024-12-06 11:55</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/CNSeniorious000">@CNSeniorious000</a> on 2024-12-06 12:06</div>
            <div class="timeline-body"><p>Thank you! I'm surprised this workaround is needed.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-12-06 12:09</div>
            <div class="timeline-body"><p>So am I! I'd expect Ruff to pick up the <code>pyproject.toml</code> as the root even if it has no <code>tool.ruff</code> section and there's no other configuration in any ancestor directory. However, that's probably a breaking change</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">configuration</span> added by @AlexWaygood on 2024-12-06 13:59</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/looztra">@looztra</a> on 2025-01-17 10:38</div>
            <div class="timeline-body"><p>Does not work for me.</p>
<pre><code class="language-toml"># in pyproject.toml
[tool.ruff]
# DO NOT PUT ANYTHING HERE, use the ruff.toml file, this is a fix for https://github.com/astral-sh/ruff/issues/14813
</code></pre>
<ul>
<li>a ruff.toml file with all the config</li>
</ul>
<p>target-version is still py39</p>
<pre><code class="language-bash">╰─»  uv run ruff check --show-settings | grep target
linter.target_version = Py39
formatter.target_version = Py39
analyze.target_version = Py39
</code></pre>
<p>using ruff 0.9.2</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/looztra">@looztra</a> on 2025-01-17 10:46</div>
            <div class="timeline-body"><p>when I run <code>uv run check --show-settings --verbose</code> there's multiple lines saying</p>
<pre><code class="language-text">[2025-01-17][11:45:48][ruff_workspace::pyproject][DEBUG] `project.requires_python` in `pyproject.toml` will not be used to set `target_version` when using `ruff.toml`
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2025-01-20 08:10</div>
            <div class="timeline-body"><p>@looztra Ruff has to pickup one configuration if there are multiple files present. The precedence is documented at https://docs.astral.sh/ruff/configuration/#config-file-discovery:</p>
<blockquote>
<p>If Ruff detects multiple configuration files in the same directory, the <code>.ruff.toml</code> file will take precedence over the <code>ruff.toml</code> file, and the <code>ruff.toml</code> file will take precedence over the <code>pyproject.toml</code> file.</p>
</blockquote>
<p>Related https://github.com/astral-sh/ruff/pull/3470. Maybe we could use a separate logic for <code>target-version</code> specifically where the precedence is different i.e., <code>pyproject.toml</code>, <code>ruff.toml</code>, <code>.ruff.toml</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">question</span> removed by @dhruvmanila on 2025-01-20 08:10</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-01-20 08:48</div>
            <div class="timeline-body"><p>I think the solution here is to implement a configuration discovery similar to uv (and, in the future, red knot) where a <code>ruff.toml</code> takes precedence, but Ruff respects the projects <code>pyproject.toml</code>'s project table (if any). In Ruff's case, it would fall back to the <code>project.requires-python</code> if the <code>ruff.toml</code> doesn't specify a <code>target-version</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">breaking</span> added by @dhruvmanila on 2025-01-20 09:00</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone "v0.10" by @MichaReiser on 2025-02-11 21:51</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-02-16 10:33</div>
            <div class="timeline-body"><p>This has just come up again and seems to -- understandably -- be very confusing to users. This, unfortunately will be a breaking change and implementing it under preview is difficult because it happens during configuration loading (we don't know yet if the user has preview enabled).</p>
<p>Either way, I think it would be good to have a fix ready for the next minor and, ideally, it would make the following two, but seperate, changes:</p>
<ol>
<li>If we can't find any configuration but there's a <code>pyproject.toml</code> without a <code>tool.ruff</code> section, don't ignore it and instead use the <code>requires-python</code> from there</li>
<li>If we find a <code>ruff.toml</code> without a <code>target-version</code> fallback to the <code>pyproject.toml</code>'s <code>requires-python</code> at the same level (if there's any).</li>
</ol>
<p>@dylwil3 @ntBre is this something either of you could look into?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @dylwil3 by @dylwil3 on 2025-02-16 16:14</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dylwil3">@dylwil3</a> on 2025-02-16 23:28</div>
            <div class="timeline-body"><p>@MichaReiser can you clarify the desired behavior of <code>ruff check foo/bar.py</code> in these situations? In each case, assume that <code>ruff.toml</code> is missing <code>target-version</code> and that <code>pyproject.toml</code> contains <code>requires-python</code> but is missing a <code>tool.ruff</code> section.</p>
<ol>
<li></li>
</ol>
<pre><code>.
├── foo
│   ├── bar.py
│   └── ruff.toml
└── pyproject.toml
</code></pre>
<ol start="2">
<li></li>
</ol>
<pre><code>.
├── foo
│   ├── bar.py
│   └── pyproject.toml
└── ruff.toml
</code></pre>
<p>I realize that in your specification (2) you say that we should only look for a <code>pyproject.toml</code> &quot;at the same level&quot;, but I just wanted to make sure since my guess is that users might expect <code>requires-python</code> to be respected as the <code>target-version</code> in both cases above.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-02-17 07:39</div>
            <div class="timeline-body"><p>That's a great call. We have to be careful that the change upholds the constraint that running ruff from the parent directory and from a child directory always results in the same results.</p>
<ol>
<li><p>No, the <code>pyproject.toml</code> here shouldn't apply because Ruff always uses the closest <code>ruff.toml</code> and it only inherits settings when explicitly using <code>extend</code>. I don't think we should change this behavior.</p>
</li>
<li><p>This case is less clear to me but I think we should ignore the <code>pyproject.toml</code> in this case as well (because there's an ancestor <code>ruff.toml</code>). I could see this to be a common setup in mono repositories where you have multiple sub-projects but you want to have a single shared ruff configuration. Although, maybe this isn't that &quot;clever&quot; because it means that you have to list all project directories in the <code>src</code> setting or ruff won't resolve the first party imports correctly. But an example of this is airflow. They use a root <a href="https://github.com/apache/airflow/blob/main/pyproject.toml">pyrpoject.toml</a> but also have multiple sub-projects (providers) where each has their own <a href="https://github.com/apache/airflow/blob/e3aabea4c2d46599291e4dbcaad8efa83fd8a780/providers/microsoft/psrp/pyproject.toml#L4">pyproject.toml</a>. We should make sure not to break this setup.</p>
</li>
</ol>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @MichaReiser on 2025-03-13 11:51</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/CNSeniorious000">@CNSeniorious000</a> on 2025-03-13 23:36</div>
            <div class="timeline-body"><p>Hey guys, it seems I'm still encountering the issue with ruff v0.10.0. What am I doing wrong?</p>
<p>https://github.com/CNSeniorious000/ruff-F821-repro/actions/runs/13846618684/job/38746272025</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntBre">@ntBre</a> on 2025-03-13 23:42</div>
            <div class="timeline-body"><p>Hmm, I'm not sure. I cloned the repo (thanks for that, it's very helpful!) and ran ruff 0.10 with the <code>--verbose</code> flag, but I'm also not seeing anything helpful, as far as I can tell:</p>
<pre><code>&gt; ruff check -v
[2025-03-13][19:40:17][ruff::resolve][DEBUG] Using Ruff default settings
[2025-03-13][19:40:17][ignore::gitignore][DEBUG] opened gitignore file: /tmp/ruff-F821-repro/.gitignore
[2025-03-13][19:40:17][ignore::gitignore][DEBUG] opened gitignore file: /tmp/ruff-F821-repro/.git/info/exclude
[2025-03-13][19:40:17][ruff_workspace::resolver][DEBUG] Ignored path via `exclude`: &quot;/tmp/ruff-F821-repro/.git&quot;
[2025-03-13][19:40:17][ruff_workspace::resolver][DEBUG] Included path via `include`: &quot;/tmp/ruff-F821-repro/hello.py&quot;
[2025-03-13][19:40:17][ruff_workspace::resolver][DEBUG] Included path via `include`: &quot;/tmp/ruff-F821-repro/pyproject.toml&quot;
[2025-03-13][19:40:17][ignore::gitignore][DEBUG] opened gitignore file: /tmp/ruff-F821-repro/.ruff_cache/.gitignore
[2025-03-13][19:40:17][ruff_workspace::resolver][DEBUG] Ignored path via `exclude`: &quot;/tmp/ruff-F821-repro/.ruff_cache&quot;
[2025-03-13][19:40:17][ruff::commands::check][DEBUG] Identified files to lint in: 5.952225ms
[2025-03-13][19:40:17][ruff::diagnostics][DEBUG] Checking: /tmp/ruff-F821-repro/pyproject.toml
[2025-03-13][19:40:17][ruff::commands::check][DEBUG] Checked 2 files in: 143.454µs
hello.py:9:11: F821 Undefined name `anext`. Consider specifying `requires-python = &quot;&gt;= 3.10&quot;` or `tool.ruff.target-version = &quot;py310&quot;` in your `pyproject.toml` file.
  |
8 | async def main():
9 |     print(anext(g()))
  |           ^^^^^ F821
  |

Found 1 error.
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-03-14 08:13</div>
            <div class="timeline-body"><p>Yes, I'm sorry. It seems the relevant commit got dropped from the release branch. We'll follow up with a release later today. We only need to decide if it should be a patch or minor release</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/CNSeniorious000">@CNSeniorious000</a> on 2025-03-14 08:38</div>
            <div class="timeline-body"><p>Thanks for quick diagnosing! I personally suggest yanking v0.10.0 and publishing a patch release because this behavior is already documented in the 0.10.0 changelog.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-03-14 08:59</div>
            <div class="timeline-body"><p>I don't think yanking a release is justified here and we can easily update the changelog. See https://docs.pypi.org/project-management/yanking/ for PyPi's guidance on when to yank a release</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 11:35:58 UTC
    </footer>
</body>
</html>
