<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BLE001 false positive - astral-sh/ruff #15473</title>
    <link rel="stylesheet" href="../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../index.html">Back to index</a>
    </div>

    <h1>BLE001 false positive</h1>

    <div class="meta">
        <span class="state state-open">Open</span>
        <a href="https://github.com/astral-sh/ruff/issues/15473">#15473</a>
        opened by <a href="https://github.com/joostlek">@joostlek</a>
        on 2025-01-14 11:12
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/joostlek">@joostlek</a> on 2025-01-14 11:12</div>
            <div class="timeline-body"><p>So I just found out that if we log the exception, we can remove the BLE001. Awesome!</p>
<p>So on my journey to achieve this, I found that (I am assuming) the type of the logging doesn't get from one file to the other.</p>
<p>So in Home Assistant core we have the config flow, which is user facing, so we want to allow the developer to catch bare exceptions to at least handle this correctly to the user. The added logging is awesome as that helps debugging and when the developers know which more specific exceptions can be raised, they can add even more situational fields.</p>
<p>Now we have some integrations where they have a centralized logging in <code>const.py</code> where they create one for the <code>__package__</code>. For some reason, ruff doesn't see that.</p>
<p>So this works</p>
<pre><code class="language-py">_LOGGER = logging.getLogger(__name__)

class MatterConfigFlow(ConfigFlow):
    async def async_step_user(self):
        try:
            await validate_input(self.hass, user_input)
        except CannotConnect:
            errors[&quot;base&quot;] = &quot;cannot_connect&quot;
        except InvalidServerVersion:
            errors[&quot;base&quot;] = &quot;invalid_server_version&quot;
        except Exception:
            _LOGGER.exception(&quot;Unexpected exception&quot;)
            errors[&quot;base&quot;] = &quot;unknown&quot;
        else:
            self.ws_address = user_input[CONF_URL]
</code></pre>
<p>But this does not</p>
<pre><code class="language-py">from .const import LOGGER

class MatterConfigFlow(ConfigFlow):
    async def async_step_user(self):
        try:
            await validate_input(self.hass, user_input)
        except CannotConnect:
            errors[&quot;base&quot;] = &quot;cannot_connect&quot;
        except InvalidServerVersion:
            errors[&quot;base&quot;] = &quot;invalid_server_version&quot;
        except Exception:
            LOGGER.exception(&quot;Unexpected exception&quot;)
            errors[&quot;base&quot;] = &quot;unknown&quot;
        else:
            self.ws_address = user_input[CONF_URL]
</code></pre>
<p>This is found in https://github.com/home-assistant/core/blob/0dc90972d893276a09aed4ede6304c7e98c93462/homeassistant/components/matter/config_flow.py#L219-L229</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../home-assistant/core/pulls/135584.html">home-assistant/core#135584</a> on 2025-01-14 11:13</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">question</span> added by @dylwil3 on 2025-01-14 11:39</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">type-inference</span> added by @dylwil3 on 2025-01-14 11:39</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dylwil3">@dylwil3</a> on 2025-01-14 11:47</div>
            <div class="timeline-body"><blockquote>
<p>So on my journey to achieve this, I found that (I am assuming) the type of the logging doesn't get from one file to the other.</p>
</blockquote>
<p>Yep that's correct - Ruff analyzes each file separately, and does not perform any sophisticated type inference (yet) that would tell it that <code>LOGGER</code> is a logger. So it may be that for now this rule does not support your use case.</p>
<p>It's possible that we could add a heuristic for this rule to look for method calls named <code>.exception</code> appearing in the right place. I don't have a good sense of how many false negatives that would produce - maybe others in the community can weigh in.</p>
<p>Thanks for bringing this up and sorry there isn't a great immediate resolution here!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2025-01-15 06:15</div>
            <div class="timeline-body"><p>Can you clarify what do you mean when you say that the first snippet &quot;works&quot; while the second one doesn't? The logic to determine whether a symbol is a logger candidate does look at some common names:</p>
<p>https://github.com/astral-sh/ruff/blob/a2dc8c93ef152d4c21dbc5de9dd79fc923d4a2eb/crates/ruff_python_semantic/src/analyze/logging.rs#L60-L74</p>
<p>I don't see <code>BLE001</code> being highlighted for both snippets: https://play.ruff.rs/7e39e399-cfd2-4d2c-831b-c1d9b8762455</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-01-15 07:14</div>
            <div class="timeline-body"><blockquote>
<p>I don't have a good sense of how many false negatives that would produce - maybe others in the community can weigh in.</p>
</blockquote>
<p>I tend to optimize for false positives over false negatives because false positives affect everyone, where a few false negatives are a missed opportunity. We've seen this with the pandas frame rules that caused a lot of confusion and frustration for users until we made it more strict to drastically reduce false positives (at the cost of increasing false negatives)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/joostlek">@joostlek</a> on 2025-01-15 08:27</div>
            <div class="timeline-body"><p>@dhruvmanila Oh that is certainly interesting. I would assume that that works as the class is named LOGGER. But reality is different</p>
<pre><code>homeassistant/components/matter/config_flow.py:225:16: BLE001 Do not catch blind exception: `Exception`
    |
223 |         except InvalidServerVersion:
224 |             errors[&quot;base&quot;] = &quot;invalid_server_version&quot;
225 |         except Exception:
    |                ^^^^^^^^^ BLE001
226 |             LOGGER.exception(&quot;Unexpected exception&quot;)
227 |             errors[&quot;base&quot;] = &quot;unknown&quot;
    |

Found 1 error.
</code></pre>
<p>Reproducable by removing the noqa here
https://github.com/home-assistant/core/blob/dev/homeassistant/components/matter/config_flow.py#L219-L229</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/joostlek">@joostlek</a> on 2025-01-15 08:29</div>
            <div class="timeline-body"><p>When I put in the whole config_flow.py file in the playground, I also don't get any BLE001 rapport, but in reality ruff does</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2025-01-15 08:42</div>
            <div class="timeline-body"><p>Oh interesting. Yes, I do get it when running locally. Also, I think this can be solved right now using the <a href="https://docs.astral.sh/ruff/settings/#lint_logger-objects"><code>lint.logger-objects</code></a> setting:</p>
<pre><code class="language-py">[tool.ruff.lint]
logger-objects = [&quot;homeassistant.components.matter.const.LOGGER&quot;]
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/joostlek">@joostlek</a> on 2025-01-15 08:58</div>
            <div class="timeline-body"><p>Right, but checking all the integrations Home Assistant has</p>
<pre><code class="language-sh">cat homeassistant/components/*/const.py | grep LOGGER | wc -l
</code></pre>
<p>We have 185 loggers in const, so on one hand this would work, I also really don't feel like adding 185 lines to our ruff config</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-01-15 09:25</div>
            <div class="timeline-body"><blockquote>
<p>We have 185 loggers in const, so on one hand this would work, I also really don't feel like adding 185 lines to our ruff config</p>
</blockquote>
<p>That's understandable. I'm not sure if possible but it might be worth exploring depending on your answer. Would it be sufficient for you if <code>logger-objects</code> accepted a glob, e.g. <code>**.LOGGER</code>, similar to what we support for <code>known-first-party</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/joostlek">@joostlek</a> on 2025-01-15 09:33</div>
            <div class="timeline-body"><p>I think that could work. I did see some cases where there were was a _LOGGER or something else, but I think they are exported most of the time so they should be LOGGER.</p>
<p>Wouldn't it also make sense if the object that we call <code>.exception</code> is named like a LOGGER?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-01-15 09:42</div>
            <div class="timeline-body"><blockquote>
<p>Wouldn't it also make sense if the object that we call .exception is named like a LOGGER?</p>
</blockquote>
<p>I'm not sure if I understand what you mean by that. Do you mean to always accept <code>LOGGER</code>, regardless if it is a local definition or imported from another module?</p>
<p>My concern is that it can lead to more false positives for other rules without providing them with a way to opt out other than disabling the rules entirely.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/joostlek">@joostlek</a> on 2025-01-15 09:46</div>
            <div class="timeline-body"><p>I think I was more coming from if a variable is named like the rules shared before</p>
<pre><code class="language-rs">if tail.starts_with(&quot;log&quot;) 
             || tail.ends_with(&quot;logger&quot;) 
             || tail.ends_with(&quot;logging&quot;) 
             || tail.starts_with(&quot;LOG&quot;) 
             || tail.ends_with(&quot;LOGGER&quot;) 
             || tail.ends_with(&quot;LOGGING&quot;) 
         { 
</code></pre>
<p>and we call <code>.exception</code> on that, that sounds fairly specific, but also keep in mind that I mainly work on one codebase. So if you think that this will cause problems, then feel free to disregard my comment :)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../home-assistant/core/pulls/134223.html">home-assistant/core#134223</a> on 2025-02-16 12:24</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/17898.html">astral-sh/ruff#17898</a> on 2025-05-07 06:31</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/18253.html">astral-sh/ruff#18253</a> on 2025-05-22 12:40</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/stevenh">@stevenh</a> on 2025-08-22 17:37</div>
            <div class="timeline-body"><blockquote>
<p>logger-objects</p>
</blockquote>
<p>This would solve our use case if its checking against the listed classes. While there may be lots of variables container loggers, I suspect there are limit implementations that would need to be tested.</p>
<p>As a specific example using:</p>
<pre><code class="language-toml">[tool.ruff.lint]
logger-objects = [&quot;logfire.Logfire&quot;]
</code></pre>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:28:15 UTC
    </footer>
</body>
</html>
