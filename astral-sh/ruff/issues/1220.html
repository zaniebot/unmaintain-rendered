<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>`exclude` and `extend-exclude` options seem ignored when running with pre-commit - astral-sh/ruff #1220</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>`exclude` and `extend-exclude` options seem ignored when running with pre-commit</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/issues/1220">#1220</a>
        opened by <a href="https://github.com/WilliamJamieson">@WilliamJamieson</a>
        on 2022-12-12 20:55
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/WilliamJamieson">@WilliamJamieson</a> on 2022-12-12 20:55</div>
            <div class="timeline-body"><p><code>ruff</code> is really awesome, and I have begun to use it in many of my projects as it is orders of magnitude faster than <code>flake8</code> and others like it.</p>
<p>In one of my projects I tried to add <code>ruff</code> to be run by pre-commit, see spacetelescope/jwst#7395. This project has a list of directories to be excluded listed in its <code>pyproject.toml</code> file. However, when running <code>ruff</code> via pre-commit <code>ruff</code> found errors in files within these excluded directories, despite trying both <code>exclude</code> and <code>extend-exclude</code> in the <code>pyproject.toml</code>. The only solution I found was to additionally exclude these directories in the <code>.pre-commit-config.yaml</code> for the <code>ruff</code> hook, which is not ideal.</p>
<p>Is this a user error or a bug in <code>ruff</code> (or its pre-commit hook)?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2022-12-12 20:56</div>
            <div class="timeline-body"><p>Let me take a look...</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2022-12-12 21:04</div>
            <div class="timeline-body"><p>I think the problem is that <code>ruff</code> still checks files if they're passed directly, e.g.:</p>
<pre><code>~/workspace/ruff on * main
‚à¥ cargo run jwst/jwst/fits_generator/
    Finished dev [unoptimized + debuginfo] target(s) in 0.11s
     Running `target/debug/ruff jwst/jwst/fits_generator/`

~/workspace/ruff on * main
‚à¥ cargo run jwst/jwst/fits_generator/main.py
    Finished dev [unoptimized + debuginfo] target(s) in 0.11s
     Running `target/debug/ruff jwst/jwst/fits_generator/main.py`
Found 3 error(s).
jwst/jwst/fits_generator/main.py:31:24: F401 `astropy.io.fits` imported but unused
jwst/jwst/fits_generator/main.py:115:17: E722 Do not use bare `except`
jwst/jwst/fits_generator/main.py:280:20: F401 `docutils` imported but unused
2 potentially fixable with the --fix option.
</code></pre>
<p>And the way pre-commit works is that it passes all changed files (IIRC) to the command directly.</p>
<p>I <em>think</em> this is the same behavior as Black. If I add this to <code>pyproject.toml</code>:</p>
<pre><code>[tool.black]
exclude = 'jwst/fits_generator'
</code></pre>
<p>Then I see:</p>
<pre><code>‚à¥ black jwst/fits_generator
No Python files are present to be formatted. Nothing to do üò¥
~/workspace/ruff/jwst on * feature/pre-commit
‚à¥ black jwst/fits_generator/generators.py
reformatted jwst/fits_generator/generators.py

All done! ‚ú® üç∞ ‚ú®
1 file reformatted.
</code></pre>
<p>So not 100% sure how to resolve, need to look into the options...</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2022-12-12 21:07</div>
            <div class="timeline-body"><p>There's a workaround <a href="https://github.com/psf/black/issues/438#issuecomment-424813931">here</a> that's discouraged but running Ruff over your codebase is fast enough that I personally think this is ok.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2022-12-12 21:07</div>
            <div class="timeline-body"><p>Otherwise, I do think you have to duplicate the exclusions in the hook definition, like in the <a href="https://github.com/psf/black/issues/438#issue-348511789">Black example</a>:</p>
<pre><code>repos:
-   repo: https://github.com/ambv/black
    rev: stable
    hooks:
    - id: black
      language_version: python3.6
      exclude: migrations
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/WilliamJamieson">@WilliamJamieson</a> on 2022-12-12 21:18</div>
            <div class="timeline-body"><p>I know from experience with <code>black</code> in <code>astropy</code> that <a href="https://github.com/astropy/astropy/blob/d31499bb3d4d4cf02981c9b7fdd35bc37c62ad54/pyproject.toml#L49-L63"><code>force-exclude</code></a> does work as expected for <code>astropy</code>'s <a href="https://github.com/astropy/astropy/blob/d31499bb3d4d4cf02981c9b7fdd35bc37c62ad54/.pre-commit-config.yaml#L82-L85"><code>.pre-commit-config.yaml</code></a>.</p>
<p>I don't think <code>ruff</code> has a <code>force-exclude</code> configuration option right now. However, that might be one way to handle this case.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2022-12-12 21:30</div>
            <div class="timeline-body"><p>Oh cool. We could probably support that...</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2022-12-13 03:59</div>
            <div class="timeline-body"><p>I guess the downside of <code>force-exclude</code> (apart from added complexity / a thing to implement + support) is that you're kind of providing an escape hatch that goes against the intention of the tool (&quot;ruff path/to/file should check file no matter what&quot;), in order to workaround a limitation in another tool. But I do see the dilemma...</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/WilliamJamieson">@WilliamJamieson</a> on 2022-12-13 20:44</div>
            <div class="timeline-body"><blockquote>
<p>I guess the downside of <code>force-exclude</code> (apart from added complexity / a thing to implement + support) is that you're kind of providing an escape hatch that goes against the intention of the tool (&quot;ruff path/to/file should check file no matter what&quot;), in order to workaround a limitation in another tool. But I do see the dilemma...</p>
</blockquote>
<p>One compromise to this issue would be to have a flag (<code>--no-exclude</code>?) which would prevent <code>ruff</code> from considering any of the set exclusion criteria.</p>
<p>I imagine the discussion in psf/black#438 and psf/black#1032 may shed light on why <code>force-exclude</code> maybe useful.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2022-12-20 00:49</div>
            <div class="timeline-body"><p>@WilliamJamieson - I'm going to make <code>force-exclude</code> a boolean flag. That way you can keep using <code>exclude</code>, but pass <code>force-exclude</code> as an argument to the pre-commit hook.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/1295.html">astral-sh/ruff#1295</a> on 2022-12-20 01:08</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2022-12-20 01:09</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../fpgmaas/cookiecutter-poetry/issues/81.html">fpgmaas/cookiecutter-poetry#81</a> on 2023-02-14 12:28</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/egeres">@egeres</a> on 2024-11-01 18:51</div>
            <div class="timeline-body"><p>I had this issue because I was only adding <code>include</code> to the dirs I wanted to check. As @charliermarsh said, the pre-commit ignores that and feeds ruff with files that shouldn't. Adding an <code>exclude</code> list fixed this issue for me. So I went from this:</p>
<pre><code class="language-toml">include = [&quot;app/**/*.py&quot;, &quot;tests/**/*.py&quot;, &quot;examples/**/*.py&quot;]
</code></pre>
<p>to this:</p>
<pre><code class="language-toml">exclude = [&quot;sketches/**&quot;]
</code></pre>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 01:30:03 UTC
    </footer>
</body>
</html>
