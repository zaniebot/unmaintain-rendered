<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Expand semantic syntax error test coverage - astral-sh/ruff #17526</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Expand semantic syntax error test coverage</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/issues/17526">#17526</a>
        opened by <a href="https://github.com/ntBre">@ntBre</a>
        on 2025-04-21 17:07
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/ntBre">@ntBre</a> on 2025-04-21 17:07</div>
            <div class="timeline-body"><h2>Summary</h2>
<p>Currently, the semantic/compile-time syntax errors are tested through a combination of inline parser tests and separate integration tests in ruff and red-knot. As suggested <a href="https://github.com/astral-sh/ruff/pull/17463#discussion_r2052629444">here</a>, it could be good to expand the integration tests to cover all of the semantic error variants to ensure that changes to the semantic models don't affect error reporting.</p>
<p>The errors correspond to variants of <a href="https://github.com/astral-sh/ruff/blob/main/crates/ruff_python_parser/src/semantic_errors.rs#L891"><code>SemanticSyntaxErrorKind</code></a>, and each variant should have documentation with examples of errors. These are a great starting point for the new tests, and in some cases they might be sufficient on their own.</p>
<p>A great first step here would be to fill in the <code>Status</code> table below by identifying which variants are currently tested.</p>
<h2>Ruff</h2>
<p>In ruff, the current integration tests are in <a href="https://github.com/astral-sh/ruff/blob/main/crates/ruff_linter/src/linter.rs#L962"><code>linter.rs</code></a>. For semantic errors that correspond to existing ruff rules, more <code>test_case</code>s can simply be added to the <code>test_syntax_errors</code> function, while standalone errors will need to be handled separately. It might be best to refactor <code>test_async_comprehension_in_sync_comprehension</code> into a more general test function that can run these cases.</p>
<h2>Red Knot</h2>
<p>In red-knot, the integration mdtests are in <a href="https://github.com/astral-sh/ruff/blob/main/crates/red_knot_python_semantic/resources/mdtest/diagnostics/semantic_syntax_errors.md?plain=1#L1"><code>semantic_syntax_errors.md</code></a>. Each level 2 heading corresponds to a single semantic syntax error, so we just need new sections  with examples for each of the missing variants.</p>
<h2>Status</h2>
<p>| Rule                                     | Ruff | Red Knot |
|------------------------------------------|------|----------|
| <code>LateFutureImport</code>                       |   <a href="https://github.com/astral-sh/ruff/pull/17612">✅</a>    |     ✅     |
| <code>ReboundComprehensionVariable</code>           |   <a href="https://github.com/astral-sh/ruff/pull/17725">✅</a>   |   <a href="https://github.com/astral-sh/ruff/pull/17725">✅</a>       |
| <code>DuplicateTypeParameter</code>                 |   <a href="https://github.com/astral-sh/ruff/pull/17725">✅</a>   |      <a href="https://github.com/astral-sh/ruff/pull/17725">✅</a>    |
| <code>MultipleCaseAssignment</code>                 |   <a href="https://github.com/astral-sh/ruff/pull/17725">✅</a>   |     <a href="https://github.com/astral-sh/ruff/pull/17725">✅</a>     |
| <code>IrrefutableCasePattern</code>                 |   <a href="https://github.com/astral-sh/ruff/pull/17748">✅</a>   |      <a href="https://github.com/astral-sh/ruff/pull/17748">✅</a>     |
| <code>SingleStarredAssignment</code>                |   <a href="https://github.com/astral-sh/ruff/pull/17748">✅</a>    |       <a href="https://github.com/astral-sh/ruff/pull/17748">✅</a>    |
| <code>WriteToDebug</code>                           |   <a href="https://github.com/astral-sh/ruff/pull/17748">✅</a>    |       <a href="https://github.com/astral-sh/ruff/pull/17748">✅</a>    |
| <code>InvalidExpression</code>                      |   <a href="https://github.com/astral-sh/ruff/pull/17748">✅</a>    |     <a href="https://github.com/astral-sh/ruff/pull/17748">✅</a>      |
| <code>DuplicateMatchKey</code>                      |   <a href="https://github.com/astral-sh/ruff/pull/17754">✅</a>   |    ✅      |
| <code>DuplicateMatchClassAttribute</code>           |    <a href="https://github.com/astral-sh/ruff/pull/17754">✅</a>  |    <a href="https://github.com/astral-sh/ruff/pull/17754">✅</a>      |
| <code>LoadBeforeGlobalDeclaration</code>            |   <a href="https://github.com/astral-sh/ruff/pull/17592">✅</a>   |     ✅     |
| <code>InvalidStarExpression</code>                  |   <a href="https://github.com/astral-sh/ruff/pull/17754">✅</a>   |     <a href="https://github.com/astral-sh/ruff/pull/17754">✅</a>     |
| <code>AsyncComprehensionInSyncComprehension</code> |   ✅   |      ✅    |
| <code>YieldOutsideFunction</code>                   |  ✅ |     ✅  |
| <code>ReturnOutsideFunction</code>                  |  ✅ |   ✅    |
| <code>AwaitOutsideAsyncFunction</code>              | <a href="https://github.com/astral-sh/ruff/pull/17785">✅</a>  |   ✅    |</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">help wanted</span> added by @ntBre on 2025-04-21 17:07</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">internal</span> added by @ntBre on 2025-04-21 17:07</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">tracking</span> added by @ntBre on 2025-04-21 17:10</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/VascoSch92">@VascoSch92</a> on 2025-04-23 18:47</div>
            <div class="timeline-body"><p>I believe for the <strong>Ruff linter</strong> the <code>ReturnOutsideFunction</code> and <code>YieldOutsideFunction</code> are already tested, see <a href="https://github.com/astral-sh/ruff/blob/main/crates/ruff_linter/resources/test/fixtures/syntax_errors/yield_scope.py">here</a> and <a href="https://github.com/astral-sh/ruff/blob/main/crates/ruff_linter/resources/test/fixtures/syntax_errors/return_outside_function.py">here</a>, respectively</p>
<p>PS: the link <code>semantic_syntax_error.md</code> seems to be broken (at least for me). This is the correct one <a href="https://github.com/astral-sh/ruff/blob/main/crates/red_knot_python_semantic/resources/mdtest/diagnostics/semantic_syntax_errors.md">[link]</a></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/17592.html">astral-sh/ruff#17592</a> on 2025-04-23 19:12</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/17612.html">astral-sh/ruff#17612</a> on 2025-04-24 16:49</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/maxmynter">@maxmynter</a> on 2025-04-24 16:51</div>
            <div class="timeline-body"><p>I'm unsure if I totally get  believe the <code>LateFutureImport</code> is tested as part of pyflakes <code>F404</code> in https://github.com/astral-sh/ruff/blob/8d2c79276d167fcfcf9143a2bc1b328bb9d0f876/crates/ruff_linter/resources/test/fixtures/pyflakes/F404_0.py#L1-L8 and https://github.com/astral-sh/ruff/blob/8d2c79276d167fcfcf9143a2bc1b328bb9d0f876/crates/ruff_linter/resources/test/fixtures/pyflakes/F404_1.py#L1-L5</p>
<p>If not, I have added a test along the lines of what @VascoSch92 proposed for <code>LoadBeforeGlobalDeclaration</code> it in <a href="https://github.com/astral-sh/ruff/pull/17612">17612</a>.</p>
<p>Happy to help with more tests. Let me know if that is on the right track.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/17725.html">astral-sh/ruff#17725</a> on 2025-04-29 22:50</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/maxmynter">@maxmynter</a> on 2025-04-29 22:52</div>
            <div class="timeline-body"><p>Added a PR (#17725) with a refactor of  <code>test_async_comprehension_in_sync_comprehension</code> and test cases for <code>ReboundComprehensionVariable</code>, <code>DuplicateTypeParameter</code>, and <code>MultipleCaseAssignment</code>.</p>
<p>Let me know if we should add more tests there or merge it so the refactor becomes available for others on <code>main</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntBre">@ntBre</a> on 2025-04-30 14:18</div>
            <div class="timeline-body"><p>Thanks for your work on this! I'll just paste what I commented on #17725 for visibility:</p>
<blockquote>
<p>I think it makes sense to batch a few of them like you did here, though, instead of necessarily one PR per error, at least if the tests are pretty straightforward.</p>
</blockquote>
<p>One PR per error is fine too, that's what I pictured initially. But feel free to batch them if you want to tackle a handful at once!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/17748.html">astral-sh/ruff#17748</a> on 2025-04-30 21:04</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/maxmynter">@maxmynter</a> on 2025-04-30 21:07</div>
            <div class="timeline-body"><p>Added propositions for <code>IrrefutableCasePattern</code>, <code>SingleStarredAssignment</code>, <code>WriteToDebug</code>, and <code>InvalidExpression</code> in #17748 .</p>
<p>Added propositions for <code>InvalidStarExpression</code>, <code>DuplicateMatchKey</code>, and <code>DuplicateMatchClassAttribue</code> in #17754 .</p>
<p>Going forward, I will add a comment here when writing tests for rules so we can avoid duplicate work.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/17754.html">astral-sh/ruff#17754</a> on 2025-05-01 03:32</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/maxmynter">@maxmynter</a> on 2025-05-01 04:12</div>
            <div class="timeline-body"><p>In <code>crates/red_knot_python_semantic/resources/mdtest/diagnostics/semantic_syntax_errors.md</code> lines 211-end, there is already a test for load before global declaration, albeit with a todo.
https://github.com/astral-sh/ruff/blob/03d8679adff964ddb4d2945d5b39665bead72755/crates/red_knot_python_semantic/resources/mdtest/diagnostics/semantic_syntax_errors.md?plain=1#L211-L221</p>
<p>Unsure what to do here.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntBre">@ntBre</a> on 2025-05-01 15:34</div>
            <div class="timeline-body"><p>I'll go ahead and mark that one covered for the sake of this issue. I'm working on that now since it requires some more extensive changes in red-knot: https://github.com/astral-sh/ruff/pull/17637</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/17785.html">astral-sh/ruff#17785</a> on 2025-05-02 02:08</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/maxmynter">@maxmynter</a> on 2025-05-02 02:20</div>
            <div class="timeline-body"><p>Added tests for <code>AsyncComprehensionOutsideAsyncFunction</code> and <code>AwaitOutsideAsync</code> in #17785. Then all cases from the Issue are covered once the associated PR's are merged.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/17804.html">astral-sh/ruff#17804</a> on 2025-05-04 13:31</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntBre">@ntBre</a> on 2025-05-09 18:56</div>
            <div class="timeline-body"><p>Looks like these are all covered now. Thanks for all the help!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @ntBre on 2025-05-09 18:56</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 01:30:17 UTC
    </footer>
</body>
</html>
