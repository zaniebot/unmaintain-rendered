<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>B006 (MutableArgumentDefault) should exempt parameters with immutable type annotations - astral-sh/ruff #572</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>B006 (MutableArgumentDefault) should exempt parameters with immutable type annotations</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/issues/572">#572</a>
        opened by <a href="https://github.com/andersk">@andersk</a>
        on 2022-11-04 01:35
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/andersk">@andersk</a></div>
            <div class="timeline-body"><p>B006 aims to prevent bugs that arise from mutating the default value of a function’s parameter, with unintended effects on all future calls to that function. But for a parameter that’s annotated with an immutable abstract type such as <code>Sequence[int]</code>, mypy already prevents the value from being mutated. So such parameters should be exempt from B006. For example:</p>
<pre><code class="language-python">from typing import Sequence

def f(a: Sequence[int] = [1, 2, 3]):  # should not raise B006
    for x in a:
        print(x)
</code></pre>
<p>This was suggested at https://github.com/PyCQA/flake8-bugbear/issues/137#issuecomment-805724850, but <a href="https://github.com/PyCQA/flake8-bugbear/issues/137#issuecomment-808161372">wasn’t implemented</a> due to flake8-bugbear lacking the machinery to accurately track <code>typing</code> imports. Since ruff has that now (#533), perhaps this is easy to implement in ruff.</p>
<p>Types that should be considered immutable:</p>
<pre><code class="language-python">object
collections.abc.Container[T]
collections.abc.Iterable[T]
collections.abc.Reversible[T]
collections.abc.Sized
collections.abc.Collection[T]
collections.abc.Sequence[T]
collections.abc.Set[T]
collections.abc.Mapping[K, V]
typing.Container[T]
typing.Iterable[T]
typing.Reversible[T]
typing.Sized
typing.Collection[T]
typing.Sequence[T]
typing.AbstractSet[T]  # not typing.Set[T]
typing.Mapping[K, V]
typing.Optional[I]  # where I is any of the above
I | None  # where I is any of the above
typing.Annotated[I, …]  # where I is any of the above
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2022-11-04 01:39</div>
            <div class="timeline-body"><p>(Agree.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">enhancement</span> added by @charliermarsh on 2022-11-04 01:39</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/harupy">@harupy</a> on 2022-11-04 08:54</div>
            <div class="timeline-body"><blockquote>
<p>mypy already prevents the value from being mutated</p>
</blockquote>
<p>There might be edge cases where mypy doesn't prevent the value from being mutated.</p>
<pre><code class="language-python"># a.py

from typing import Sequence


def untyped_func_imported_from_third_party_library(a):
    a.append(1)


def f(a: Sequence[int] = [1, 2, 3]):
    untyped_func_imported_from_third_party_library(a)
    print(a)


f()
f()
</code></pre>
<pre><code>&gt; mypy --version
mypy 0.982 (compiled: yes)

&gt; mypy a.py
Success: no issues found in 1 source file

&gt; python a.py
[1, 2, 3, 1]
[1, 2, 3, 1, 1]
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/andersk">@andersk</a> on 2022-11-04 18:47</div>
            <div class="timeline-body"><p>Sure, Python’s gonna Python, so mypy will always be an incomplete solution, although there are options like <code>--strict</code> that make it less incomplete.</p>
<pre><code class="language-console">$ mypy --strict a.py
a.py:4: error: Function is missing a type annotation
a.py:8: error: Function is missing a return type annotation
a.py:9: error: Call to untyped function &quot;untyped_func_imported_from_third_party_library&quot; in typed context
Found 3 errors in 1 file (checked 1 source file)
</code></pre>
<p>But what I really meant was that, by annotating <code>a: Sequence[int]</code>, the programmer has at least declared an <em>intention</em> to avoid mutating <code>a</code>, and it’s then up to the programmer to enforce this intention, via an appropriate mypy configuration or otherwise.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2022-11-20 00:46</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 16:45:27 UTC
    </footer>
</body>
</html>
