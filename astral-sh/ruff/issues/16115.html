<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>mdtests are no longer coloured when run locally - astral-sh/ruff #16115</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>mdtests are no longer coloured when run locally</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/issues/16115">#16115</a>
        opened by <a href="https://github.com/AlexWaygood">@AlexWaygood</a>
        on 2025-02-12 11:36
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a></div>
            <div class="timeline-body">Description
<p>There&#x27;s a known issue that the output from mdtest is not coloured if you simply run <code>cargo test</code> (<a href="https://github.com/astral-sh/ty/issues/235">astral-sh/ty#235</a>). Until recently, however, you <em>would</em> get pretty colours from the mdtest framework if you simply ran <code>cargo test -p red_knot_python_semantic</code> (which is what I usually do locally). I added the feature in <a href="https://github.com/astral-sh/ruff/pull/13725">astral-sh/ruff#13725</a>. It appears to have broken recently: whereas you used to get something like this when the tests failed:</p>

Screenshot

<p><img src="https://github.com/user-attachments/assets/7751a060-c0d3-471b-b23f-2ee6cc5c7d8b" alt="Image"></p>


<p>You now get something like this, which is much harder to read:</p>

Screenshot

<p><img src="https://github.com/user-attachments/assets/66dd1303-3adb-4b94-a498-c2b220398547" alt="Image"></p>


<p>I tried bisecting, and <code>git bisect</code> points to d47088c8f83f966f734c254a23073eeee123c347 as the first bad commit (from <a href="https://github.com/astral-sh/ruff/pull/15976">astral-sh/ruff#15976</a>). I find this surprising -- I can&#x27;t see any obvious changes in that PR that would have had any impact on this? But indeed, if I checkout that commit, no test failures are colourised when I run <code>cargo test -p red_knot_python_semantic</code>; but if I checkout the previous commit, test failures are colourised as expected.</p>
<p>Cc. @BurntSushi</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-02-12 11:36</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-02-12 11:36</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">testing</span> added by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-02-12 11:36</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-02-12 11:44</div>
            <div class="timeline-body"><p>I think the problem is that we globally disable <code>colored</code> when rendering diagnostics in the mdtest frameworks which is global ðŸ¤·</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-02-12 11:47</div>
            <div class="timeline-body"><p>sure... but why did that change in d47088c8f83f966f734c254a23073eeee123c347? I don&#x27;t see any changes to the <code>red_knot_test</code> crate or any <code>Cargo.toml</code> files in that commit</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-02-12 11:49</div>
            <div class="timeline-body"><p>It introduced a <code>snapshot-diagnostics</code> test, which disables coloring for these tests, and all tests run after it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to <a href="https://github.com/BurntSushi">@BurntSushi</a> by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2025-02-12 14:01</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2025-02-12 14:01</div>
            <div class="timeline-body"><p>I can take a look at this by making it so diagnostic display doesn&#x27;t reach out to global mutable state.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2025-02-12 14:38</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2025-02-12 14:38</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 18:49:30 UTC
    </footer>
</body>
</html>
