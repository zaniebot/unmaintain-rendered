<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formatter: `prefer_splitting_right_hand_side_of_assignments` preview style - astral-sh/ruff #6975</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Formatter: `prefer_splitting_right_hand_side_of_assignments` preview style</h1>

    <div class="meta">
        <span class="state state-closed">Closed</span>
        <a href="https://github.com/astral-sh/ruff/issues/6975">#6975</a>
        opened by <a href="https://github.com/MichaReiser">@MichaReiser</a>
        on 2023-08-29 12:50
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-08-29 12:50</div>
            <div class="timeline-body"><p>Implement Black's <a href="https://black.readthedocs.io/en/stable/the_black_code_style/future_style.html#improved-line-breaks">improved linebreaks</a> preview style. The style is gated behind the <a href="https://github.com/psf/black/pull/3368"><code>prefer_splitting_right_hand_side_of_assignments</code></a> preview flag.</p>
<p>It seems that the right side now always gets parenthesized regardless if it makes the right fit or not (no longer has the optimisation to omit parentheses if the content still doesn't fit after adding the parentheses).</p>
<p>https://play.ruff.rs/36e390bc-b3d2-41b2-80d9-87608337727a</p>
<p>We may be able to get away by simply not returning <code>BestFit</code> if the expression is an assignment value.</p>
<p>I expect this change to improve the performance because there are fewer cases where we'll need to fall back to use Best Fitting.</p>
<p>Black (and our) stable style:</p>
<pre><code class="language-python">def f():
    &quot;&quot;&quot;Black's `Preview.prefer_splitting_right_hand_side_of_assignments`&quot;&quot;&quot;
    aaaaaaaaaaaaaaaaaaaaaaaaaaaaaa[
        bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb
    ] = cccccccc.ccccccccccccc.cccccccc

    aaaaaaaaaaaaaaaaaaaaaaaaaaaaaa[
        bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb
    ] = cccccccc.ccccccccccccc().cccccccc

    aaaaaaaaaaaaaaaaaaaaaaaaaaaaaa[
        bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb
    ] = cccccccc.ccccccccccccc(d).cccccccc

    aaaaaaaaaaaaaaaaaaaaaaaaaaaaaa[bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb] = (
            cccccccc.ccccccccccccc(d).cccccccc + e
    )

    aaaaaaaaaaaaaaaaaaaaaaaaaaaaaa[bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb] = (
            cccccccc.ccccccccccccc.cccccccc + e
    )
    aaaaaaaaaaaaaaaaaaaaaaaaaaaaaa[bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb] = (
            cccccccc.ccccccccccccc.cccccccc
            + eeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee
    )

    self._cache: dict[
        DependencyCacheKey, list[list[DependencyPackage]]
    ] = collections.defaultdict(list)
    self._cached_dependencies_by_level: dict[
        int, list[DependencyCacheKey]
    ] = collections.defaultdict(list)
</code></pre>
<p>Preview style, which consistently breaks the right side first:</p>
<pre><code class="language-python">def f():
    &quot;&quot;&quot;Black's `Preview.prefer_splitting_right_hand_side_of_assignments`&quot;&quot;&quot;
    aaaaaaaaaaaaaaaaaaaaaaaaaaaaaa[bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb] = (
        cccccccc.ccccccccccccc.cccccccc
    )

    aaaaaaaaaaaaaaaaaaaaaaaaaaaaaa[bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb] = (
        cccccccc.ccccccccccccc().cccccccc
    )

    aaaaaaaaaaaaaaaaaaaaaaaaaaaaaa[bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb] = (
        cccccccc.ccccccccccccc(d).cccccccc
    )

    aaaaaaaaaaaaaaaaaaaaaaaaaaaaaa[bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb] = (
        cccccccc.ccccccccccccc(d).cccccccc + e
    )

    aaaaaaaaaaaaaaaaaaaaaaaaaaaaaa[bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb] = (
        cccccccc.ccccccccccccc.cccccccc + e
    )
    aaaaaaaaaaaaaaaaaaaaaaaaaaaaaa[bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb] = (
        cccccccc.ccccccccccccc.cccccccc
        + eeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee
    )

    self._cache: dict[DependencyCacheKey, list[list[DependencyPackage]]] = (
        collections.defaultdict(list)
    )
    self._cached_dependencies_by_level: dict[int, list[DependencyCacheKey]] = (
        collections.defaultdict(list)
    )
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/6935.html">astral-sh/ruff#6935</a> on 2023-08-29 12:50</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">formatter</span> added by @MichaReiser on 2023-08-29 12:53</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone "Formatter: Stable" by @MichaReiser on 2023-08-29 12:53</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">preview</span> added by @MichaReiser on 2023-09-15 09:50</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/8043.html">astral-sh/ruff#8043</a> on 2023-10-19 09:23</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/8188.html">astral-sh/ruff#8188</a> on 2023-10-24 23:47</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../Toufool/AutoSplit/pulls/259.html">Toufool/AutoSplit#259</a> on 2023-10-27 14:01</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-10-30 09:33</div>
            <div class="timeline-body"><p>We'll need to make <code>best_fits_parenthesize</code> break the right before the left when using preview style, similar to regular groups. This can be accomplished by measuring the parenthesized content instead of the unparenthesized content inside of <code>fits_element</code>. See https://github.com/astral-sh/ruff/issues/8182#issuecomment-1784712397</p>
<p>We should add a <code>mode</code> to <code>BestFitsParenthesize</code> to avoid exposing the <code>preview</code> flag to the printer (preview is a language specific concept)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-10-31 10:32</div>
            <div class="timeline-body"><p>Some more details. https://github.com/psf/black/issues/4006</p>
<p>Overall, the assignment will be the odd one that uses a different parenthesizing layout (not applying the logic to omit parentheses if it exceeds the line width). This will be different from clause headers and <code>await</code>, <code>return</code>, etc where expressions should only be parenthesized if necessary. This can be implemented by returning <code>Multline</code> for the <code>NeedsParentheses</code> implementation that currently return <code>BestFit</code> if the parent is an assignment</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "Improved line breaks" to "Formattter: `prefer_splitting_right_hand_side_of_assignments` preview style" by @MichaReiser on 2023-11-29 00:24</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/8678.html">astral-sh/ruff#8678</a> on 2023-11-29 00:25</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/8894.html">astral-sh/ruff#8894</a> on 2023-11-29 02:36</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "Formattter: `prefer_splitting_right_hand_side_of_assignments` preview style" to "Formatter: `prefer_splitting_right_hand_side_of_assignments` preview style" by @MichaReiser on 2023-11-29 03:08</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @MichaReiser by @MichaReiser on 2023-11-29 04:31</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Unassigned @MichaReiser by @MichaReiser on 2023-11-29 07:53</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @MichaReiser by @MichaReiser on 2023-11-29 07:54</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/8920.html">astral-sh/ruff#8920</a> on 2023-11-30 02:57</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/8943.html">astral-sh/ruff#8943</a> on 2023-12-01 07:19</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @MichaReiser on 2023-12-13 03:43</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:34:51 UTC
    </footer>
</body>
</html>
