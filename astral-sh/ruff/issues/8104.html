<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>B006 (mutable-argument-default) no longer offers autofix even with --unsafe-fixes - astral-sh/ruff #8104</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>B006 (mutable-argument-default) no longer offers autofix even with --unsafe-fixes</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/issues/8104">#8104</a>
        opened by <a href="https://github.com/cjolowicz">@cjolowicz</a>
        on 2023-10-21 13:08
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/cjolowicz">@cjolowicz</a> on 2023-10-21 13:08</div>
            <div class="timeline-body"><!--
Thank you for taking the time to report an issue! We're glad to have you involved with Ruff.

If you're filing a bug report, please consider including the following information:

* A minimal code snippet that reproduces the bug.
* The command you invoked (e.g., `ruff /path/to/file.py --fix`), ideally including the `--isolated` flag.
* The current Ruff settings (any relevant sections from your `pyproject.toml`).
* The current Ruff version (`ruff --version`).
-->

<p>Hello üëã</p>
<p>B006 (<code>mutable-argument-default</code>) no longer offers an autofix even when <code>--unsafe-fixes</code> is passed.</p>
<p>Use the example from <code>ruff rule B006</code> to reproduce this:</p>
<pre><code class="language-python"># /tmp/bad.py
def add_to_list(item, some_list=[]):
    some_list.append(item)
    return some_list
</code></pre>
<p>At HEAD (df807ff91248c896cf7f11b25e4f64ecb1d77066) and v0.1.1:</p>
<pre><code class="language-sh">‚ùØ cargo run -p ruff_cli -- check --select B --unsafe-fixes /tmp/bad.py --no-cache
/tmp/bad.py:1:33: B006 Do not use mutable data structures for argument defaults
Found 1 error.
</code></pre>
<p>I've bisected this to 22e18741bdf58bc15a69da2503d7b48443e5a038, but that may only be where the issue was surfaced in the CLI.</p>
<p>The output is slightly different in that commit, there's an additional line:</p>
<pre><code class="language-sh">/tmp/bad.py:1:33: B006 Do not use mutable data structures for argument defaults
Found 1 error.
[*] 0 fixable with the --fix option.
</code></pre>
<p>If I omit <code>--unsafe-fixes</code> there's a hint about a hidden fix:</p>
<pre><code class="language-sh">‚ùØ cargo run -p ruff_cli -- check --select B /tmp/bad2.py --no-cache
/tmp/bad.py:1:33: B006 Do not use mutable data structures for argument defaults
Found 1 error.
1 hidden fix can be enabled with the `--unsafe-fixes` option.
</code></pre>
<p>(I don't see this hint in 0.1.1 or HEAD, but I haven't bisected where it went away.)</p>
<p>In the parent of the bisected commit and in v0.0.292, I get the expected output:</p>
<pre><code class="language-sh">/tmp/bad.py:1:33: B006 [*] Do not use mutable data structures for argument defaults
Found 1 error.
[*] 1 potentially fixable with the --fix option.
</code></pre>
<p>(I noticed after the fact that I ran Ruff from its repository which has Ruff config in pyproject.toml, so that could have skewed results a little. But the repro should still be valid.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/cjolowicz">@cjolowicz</a> on 2023-10-21 14:05</div>
            <div class="timeline-body"><p>FWIW the fix is deemed unapplicable in FixableStatistics::try_from</p>
<p>https://github.com/astral-sh/ruff/blob/df807ff91248c896cf7f11b25e4f64ecb1d77066/crates/ruff_cli/src/printer.rs#L521</p>
<p>Here's what the diagnostics look like:</p>
<pre><code class="language-rust">Diagnostics {
    messages: [
        Message {
            kind: DiagnosticKind {
                name: &quot;MutableArgumentDefault&quot;,
                body: &quot;Do not use mutable data structures for argument defaults&quot;,
                suggestion: Some(&quot;Replace with `None`; initialize within function&quot;)
            },
            range: 32..34,
            fix: Some(Fix {
                edits: [Edit { range: 32..34, content: Some(&quot;None&quot;) },
                        Edit { range: 37..37, content: Some(&quot;    if some_list is None:\n        some_list = []\n&quot;) }],
                applicability: Display,
                isolation_level: NonOverlapping
            }),
            file: SourceFile {
                name: &quot;/tmp/bad.py&quot;,
                code: &quot;def add_to_list(item, some_list=[]):\n    some_list.append(item)\n    return some_list\n&quot; },
            noqa_offset: 32 }],
    fixed: FixMap({}),
    imports: ImportMap { module_to_imports: {} },
    notebook_indexes: {}
}
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/cjolowicz">@cjolowicz</a> on 2023-10-21 14:23</div>
            <div class="timeline-body"><p>I think I understand what's going on now.</p>
<p>#6131 added the fix as a &quot;manual edit&quot;, a concept which later became <code>applicability: Display</code>. This means that the fix should only be displayed to the user but never applied by Ruff. Before 22e18741bdf58bc15a69da2503d7b48443e5a038 (the bisected commit), applicability levels weren't respected, which explains why the fix was available before 0.1.0 and then went away.</p>
<p>So I suppose this issue is a feature request, not a bug:</p>
<ul>
<li>Can we move the fix from display to unsafe (or even safe)?</li>
</ul>
<p>I haven't found discussion of this (but may have missed it).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/cjolowicz">@cjolowicz</a> on 2023-10-21 14:28</div>
            <div class="timeline-body"><p>For context, I see three rules with <em>display edits</em> in the codebase, which are likely all affected by the change:</p>
<ul>
<li>mutable-argument-default (flake8-bugbear)</li>
<li>lambda-assignment (pycodestyle)</li>
<li>commented-out-code (eradicate)</li>
</ul>
<p>These rules are all marked as fixable in the docs, which is prone to create confusion? (Did for me.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-10-21 15:01</div>
            <div class="timeline-body"><p>I support upgrading this to unsafe -- we could probably increase all of those to unsafe now that it's supported on the CLI.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-10-21 15:01</div>
            <div class="timeline-body"><p>(But also, we probably shouldn't mark &quot;display&quot; rules as fixable in the docs.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2023-10-21 15:10</div>
            <div class="timeline-body"><blockquote>
<p>(But also, we probably shouldn't mark &quot;display&quot; rules as fixable in the docs.)</p>
</blockquote>
<p>We do not know applicability levels of fixes when generating the documentation. Perhaps <code>FixAvailability</code> needs a maximum applicability field.</p>
<p>I'll need to look at those specific rules but I presume they were categorized as display-only for good reason?</p>
<p>Note after #7352 these fixes will be displayed instead of entirely hidden.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/cjolowicz">@cjolowicz</a> on 2023-10-21 15:43</div>
            <div class="timeline-body"><p>I opened #8108 to promote <code>mutable-argument-default</code> to unsafe.</p>
<blockquote>
<p>I'll need to look at those specific rules but I presume they were categorized as display-only for good reason?</p>
</blockquote>
<p>I found some discussion of this, after all:</p>
<ul>
<li>https://github.com/astral-sh/ruff/pull/4880#discussion_r1257863238</li>
<li>https://github.com/astral-sh/ruff/pull/4880#discussion_r1265110215</li>
</ul>
<p>To my understanding, the rule was left in manual because of an edge case where the newline between the function signature and the body is escaped with a backslash (second link above). But it seems like there was some question whether this edge case justified making the fix display-only.</p>
<p>cc @qdegraaf @MichaReiser</p>
<p>(As a reminder for myself, the reason the fix isn't safe is because mutable argument defaults can be used intentionally, e.g. for caching.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2023-10-21 16:07</div>
            <div class="timeline-body"><p>It looks like it was marked as display/manual because it could result in invalid syntax if a continuation is used at the end of a function definition? Seems like a weird enough edge-case to just be unsafe.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">autofix</span> added by @zanieb on 2023-10-21 16:07</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2023-10-21 19:29</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 11:31:39 UTC
    </footer>
</body>
</html>
