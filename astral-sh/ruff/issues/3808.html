<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reduce ambiguous unicode character table - astral-sh/ruff #3808</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Reduce ambiguous unicode character table</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/ruff/issues/3808">#3808</a>
        opened by <a href="https://github.com/MichaReiser">@MichaReiser</a>
        on 2023-03-30 10:41
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-03-30 10:41</div>
            <div class="timeline-body"><p>The ambiguous Unicode character table generates by far the most lllvm instructions (1.3% of all generated instructions).</p>
<pre><code class="language-bash">RUSTFLAGS=&quot;-Csymbol-mangling-version=v0&quot; cargo llvm-lines -p ruff --lib | head -20

Lines                  Copies               Function name
-----                  ------               -------------
1532601                35211                (TOTAL)
  20559 (1.3%,  1.3%)      1 (0.0%,  0.0%)  ruff[9ef597ff107e57e5]::rules::ruff::rules::ambiguous_unicode_character::CONFUSABLES::{closure#0}
   8800 (0.6%,  1.9%)      1 (0.0%,  0.0%)  &lt;ruff[9ef597ff107e57e5]::codes::RuleCodePrefix&gt;::iter
   7408 (0.5%,  2.4%)      1 (0.0%,  0.0%)  &lt;ruff[9ef597ff107e57e5]::checkers::ast::Checker as ruff_python_ast[47d0f9a8c15cbca1]::visitor::Visitor&gt;::visit_stmt
   6898 (0.5%,  2.8%)      1 (0.0%,  0.0%)  &lt;ruff[9ef597ff107e57e5]::registry::Rule&gt;::noqa_code
</code></pre>
<p>I think we can do better by generating fixed arrays that we use for lookups similar to <a href="https://github.com/dtolnay/unicode-ident/blob/master/src/tables.rs">unicode-width</a> or <a href="https://github.com/dtolnay/unicode-ident/blob/master/src/tables.rs">unicode-ident</a>. The input is a mapping from &quot;UTF8&quot; character to the ascii character (ideally, as character and not the number representation).</p>
<p>Why could this work? Because UTF8 only uses a subset of the 4-byte space, the first bit is always 0 for the first byte and always 1 for the following bytes. That means, each byte has at most 128 valid values, and it should be sufficient to have at most 4-128bit tables.</p>
<p>This should also improve performance because it simplifies the lookup to a few bit operations and a static array lookup.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">internal</span> added by @MichaReiser on 2023-03-30 10:41</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">performance</span> added by @MichaReiser on 2023-03-30 10:41</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2023-03-30 14:05</div>
            <div class="timeline-body"><p>Prior art from rustc: https://github.com/rust-lang/rust/tree/8a7ca936e61d04399198911ee2b07ac110bf17b0/src/tools/unicode-table-generator/src . I'm surprised i didn't find any existing crate for that</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/evanrittenhouse">@evanrittenhouse</a> on 2023-03-31 15:55</div>
            <div class="timeline-body"><p>Out of curiosity, when you say</p>
<blockquote>
<p>The input is a mapping from &quot;UTF8&quot; character to the ascii character</p>
</blockquote>
<p>Do you mean something like <a href="https://github.com/RustPython/RustPython/blob/main/stdlib/src/binascii.rs#L161">this table</a>, except where we actually maintain a list of character representations instead of number representations? I'm also curious as to why we'd need to generate the arrays at all - could we just used a static list in a <code>consts</code> file or something?</p>
<p>Purely for my own curiosity!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-03-31 17:07</div>
            <div class="timeline-body"><blockquote>
<p>Do you mean something like <a href="https://github.com/RustPython/RustPython/blob/main/stdlib/src/binascii.rs?rgh-link-date=2023-03-31T15%3A55%3A04Z#L161">this table</a>, except where we actually maintain a list of character representations instead of number representations?</p>
</blockquote>
<p>Yeah, that's the rough idea I have. I haven't fully worked out the details but I believe something along these lines should be possible.</p>
<blockquote>
<p>I'm also curious as to why we'd need to generate the arrays at all - could we just used a static list in a consts file or something?</p>
</blockquote>
<p>We can also hand-write the table but my worry is that it becomes hard to understand because you'll have to add up the numbers from up to three table to know which unicode character it maps. That's why I think that having a <code>char -&gt; ascii</code> input table and generating the derived tables is easier to maintain.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/evanrittenhouse">@evanrittenhouse</a> on 2023-03-31 17:11</div>
            <div class="timeline-body"><p>Hmm, intriguing. I'd be very interested in helping out with this, if you'd like any!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-03-31 17:14</div>
            <div class="timeline-body"><blockquote>
<p>Hmm, intriguing. I'd be very interested in helping out with this, if you'd like any!</p>
</blockquote>
<p>That would be awesome and it should be a lot of fun if you enjoy fiddling with bytes. I'll assign the task to you. Let me know if there's anything I can help you with.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @evanrittenhouse by @MichaReiser on 2023-03-31 17:14</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/evanrittenhouse">@evanrittenhouse</a> on 2023-03-31 17:29</div>
            <div class="timeline-body"><p>Sure, there are a few implementation details I'm curious about (I'm pretty new to all the character encoding/byte stuff, so please bear with me. If this would be easier on Discord or something, I can also ping you there!).</p>
<ol>
<li>You mention 4 128-bit tables. What would those actually represent? Why do that instead of just cramming the entire conversion into one table? What would they contain and where do we draw the boundary between each table?</li>
<li>Can you please explain the <code>CONFUSABLES</code> map in the rule's current implementation and how we want to adapt that to this new dynamically generated array? It seems like we're suggesting shrinking the 4-byte space down to only the relevant bytes, but not sure how that actually works in practice.</li>
<li>How would the input actually map to the lookup table?</li>
<li>The Unicode character Ã˜ has a binary representation of <code>11000011 10011000</code>. I must be misunderstanding the statement  &quot;UTF8 only uses a subset of the 4-byte space, the first bit is always 0 for the first byte and always 1 for the following bytes&quot;. Do you mind elaborating a little bit?</li>
</ol>
<p>I haven't gone too deep into the <code>ambiguous_unicode_character</code> rule, so apologies if some of these questions are easily answerable.</p>
<p>E: At a brief glance, it seems like <code>CONFUSABLES</code> contains a character's unicode value and its ASCII counterpart (8232 being a line separator, 32 being a space in ASCII). Is that correct?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-03-31 17:55</div>
            <div class="timeline-body"><blockquote>
<p>E: At a brief glance, it seems like CONFUSABLES contains a character's unicode value and its ASCII counterpart (8232 being a line separator, 32 being a space in ASCII). Is that correct?</p>
</blockquote>
<p>That's correct!</p>
<blockquote>
<p>Sure, there are a few implementation details I'm curious about (I'm pretty new to all the character encoding/byte stuff, so please bear with me. If this would be easier on Discord or something, I can also ping you there!).</p>
</blockquote>
<blockquote>
<p>The Unicode character Ã˜ has a binary representation of 11000011 10011000. I must be misunderstanding the statement &quot;UTF8 only uses a subset of the 4-byte space, the first bit is always 0 for the first byte and always 1 for the following bytes&quot;. Do you mind elaborating a little bit?</p>
</blockquote>
<p>I was actually incorrect, the left most bit is actually 1 for unicode characters. I also don't know the details yet myself. I observed that the first bit (the left most) in every byte is always 1 for unicode characters <a href="https://en.wikipedia.org/wiki/UTF-8#Encoding">see Wikipedia</a>. That's why I think that we can use 4 smaller lookup tables (maybe even fewer depending on in which ranges our values fall) that only represent the valid ranges from <code>&gt;0b1000 0000</code>. At least that's what <code>unicodewidth</code> seems to be doing.</p>
<p>Do you want to spend some time trying to figure out the details? If not, then I'm okay with spending some time to figure out the necessary data structure and comment again.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/evanrittenhouse">@evanrittenhouse</a> on 2023-03-31 17:58</div>
            <div class="timeline-body"><p>To be honest, I'm currently pretty slammed with work stuff and am not sure that I'm able to commit to learning the problem space well enough to design a solution. If it's possible for you to work one out, I'd probably prefer that - if not, I can definitely take a stab at it, but the timeline will probably be increased ðŸ˜¬</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Unassigned @evanrittenhouse by @MichaReiser on 2023-04-03 07:34</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-04-03 07:36</div>
            <div class="timeline-body"><blockquote>
<p>To be honest, I'm currently pretty slammed with work stuff and am not sure that I'm able to commit to learning the problem space well enough to design a solution. If it's possible for you to work one out, I'd probably prefer that - if not, I can definitely take a stab at it, but the timeline will probably be increased grimacing</p>
</blockquote>
<p>Oh my mistake. It wasn't my intention to pressure you. The timeline isn't really important. This is more of a nice to have. I unassigned you for now, and I'll try to come up with a more detailed design except someone beats me to it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-06-06 01:35</div>
            <div class="timeline-body"><p>1.6% on my machine ðŸ¤¢</p>
<pre><code>  Lines                  Copies               Function name
  -----                  ------               -------------
  1738103                38931                (TOTAL)
    27423 (1.6%,  1.6%)      1 (0.0%,  0.0%)  ruff[58726c95636f7b65]::rules::ruff::rules::confusables::CONFUSABLES::{closure#0}
    10182 (0.6%,  2.2%)      1 (0.0%,  0.0%)  &lt;ruff[58726c95636f7b65]::codes::RuleCodePrefix&gt;::iter
     8094 (0.5%,  2.6%)      1 (0.0%,  0.0%)  &lt;ruff[58726c95636f7b65]::codes::Rule&gt;::noqa_code
     7315 (0.4%,  3.1%)      1 (0.0%,  0.0%)  &lt;ruff[58726c95636f7b65]::checkers::ast::Checker as ruff_python_ast[2ac961f4186054]::visitor::Visitor&gt;::visit_stmt
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/4926.html">astral-sh/ruff#4926</a> on 2023-06-07 12:33</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2023-06-07 12:34</div>
            <div class="timeline-body"><p>The table contains a lot of duplicate entries <code>cat confusables.rs | wc -l</code> returns 2120, <code>cat c.rs | sort | uniq | wc -l</code> only 1593.</p>
<p>#4926 is an attempt to solve this issue by using a perfect hash map instead. Indepent on whether we merge #4926, i think the duplicates should be removed</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @konstin on 2023-06-08 06:13</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-06-08 13:42</div>
            <div class="timeline-body"><p>I'm going to annoyingly re-open as I still think we should use fixed arrays for this when we have the time :joy:</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Reopened by @charliermarsh on 2023-06-08 13:42</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "Reduce ambigious unicode character table" to "Reduce ambiguous unicode character table" by @charliermarsh on 2023-06-08 15:54</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/evanrittenhouse">@evanrittenhouse</a> on 2023-06-08 17:17</div>
            <div class="timeline-body"><p>@charliermarsh Just because I'm still interested in this - we're talking compile-time fixed arrays, not runtime ones right? Probably a stupid question, just want to make sure</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-06-08 17:19</div>
            <div class="timeline-body"><p>Yeah, I believe so, based on my understanding.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @Thomasdezeeuw by @Thomasdezeeuw on 2023-06-12 08:10</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Unassigned @Thomasdezeeuw by @Thomasdezeeuw on 2023-06-27 13:16</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 01:30:06 UTC
    </footer>
</body>
</html>
