<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[red-knot] Follow up: Type::Unbound removal - astral-sh/ruff #14022</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[red-knot] Follow up: Type::Unbound removal</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/issues/14022">#14022</a>
        opened by <a href="https://github.com/sharkdp">@sharkdp</a>
        on 2024-10-31 18:51
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a></div>
            <div class="timeline-body"><p>This is a follow-up from astral-sh/ruff#13671 that lists some tasks that were intentionally left out from astral-sh/ruff#13980:</p>
<ul>
<li>[x] Work on the <code>Symbol</code> API: Functions like <code>as_type</code>, <code>unwrap_or</code>, <code>unwrap_or_never</code> ignore possibly-unboundness. Look into call sites of those functions and see if that&#x27;s really what we require in all cases. Possibly remove some of these functions.</li>
<li>[x] <code>.unwrap_or</code> is currently only used with <code>Type::Never</code>. We did this to keep existing behavior for some cases where we then proceed to call <code>.call(…)</code>, where <code>Type::Never</code> would lead to a &quot;not callable&quot; error, just like <code>Type::Unbound</code> before. This can be handled more explicitly, potentially with better diagnostics for the user.</li>
<li>[x] Understand if we need to handle the possibly-unboundness of the <code>replacement</code> argument in <code>Symbol::replace_unbound_with</code>. Write tests.</li>
<li>[x] Investigate and understand the performance gains of astral-sh/ruff#13671.</li>
<li>[x] Possibly look into undeclared-ness issues brought up <a href="https://github.com/astral-sh/ruff/pull/13980#discussion_r1824747585">here</a>. See also the corresponding TODO comment in <code>types.rs</code>. =&gt; moved to astral-sh/ty#229</li>
<li>[x] Clarify if we want a diagnostic for in the situation described <a href="https://github.com/astral-sh/ruff/pull/13980#discussion_r1824405789">here</a> =&gt; moved to astral-sh/ty#229</li>
<li>[x] Review the <code>Type::Union</code> case in the <code>Type::member()</code> function, potentially write some more tests</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by <a href="https://github.com/sharkdp">@sharkdp</a> on 2024-10-31 18:51</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to <a href="https://github.com/sharkdp">@sharkdp</a> by <a href="https://github.com/sharkdp">@sharkdp</a> on 2024-10-31 18:51</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone &quot;Red Knot 2024&quot; by <a href="https://github.com/carljm">@carljm</a> on 2024-11-07 15:23</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sharkdp">@sharkdp</a> on 2024-11-12 14:14</div>
            <div class="timeline-body">Performance investigation
<p>I benchmarked two states of the repository: just before and right after the merge of the <code>Type::Unbound</code>-removal PR (before: d1189c20d vs. after: 53fa32a38).</p>
<p>The performance gain is small, but real (statistically significant; smaller mean and min times):</p>
<pre><code>hyperfine -w50 -r500 -N -i \
  &#x27;red_knot_before --current-directory path/to/tomllib&#x27; -n before \
  &#x27;red_knot_after --current-directory path/to/tomllib&#x27; -n after \
  --export-json results.json
uv run path/to/hyperfine/scripts/plot_whisker.py results.json
</code></pre>
<p><img src="https://github.com/user-attachments/assets/793c8e86-e3e5-4b04-bd30-04bf940b9283" alt="image"></p>
<p>I get similar results (~ -5%) on the criterion benchmark.</p>
<p>I then looked into the profiling results, and long story short (hint: use inverted call stacks), I believe the initial guess by @MichaReiser is correct: it looks like we simply build fewer union types (previously, we had lots of <code>… | Type::Unbound</code> unions).</p>
<p>before: ~4% of the total time is spent on <code>UnionType::from_elements</code></p>
<p><img src="https://github.com/user-attachments/assets/0ba1a1eb-fff1-4ab1-9820-f7fb2a38fe29" alt="image"></p>
<p>after: only 2% of the total time is spent building union types</p>
<p><img src="https://github.com/user-attachments/assets/a6e7a06b-3344-4b1d-88db-42708fe9a935" alt="image"></p>
<p>There might be other small gains somewhere else, but at this point, it does not seem worth spending more time on it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/sharkdp">@sharkdp</a> on 2024-11-12 14:14</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sharkdp">@sharkdp</a> on 2024-11-12 14:30</div>
            <div class="timeline-body"><p>Closing this with one remaining follow up (#14297) which is unrelated to the changes done astral-sh/ruff#13980.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 18:48:59 UTC
    </footer>
</body>
</html>
