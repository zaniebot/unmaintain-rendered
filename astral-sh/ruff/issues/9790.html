<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Policy for linter fixes that can drop comments - astral-sh/ruff #9790</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Policy for linter fixes that can drop comments</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/issues/9790">#9790</a>
        opened by <a href="https://github.com/zanieb">@zanieb</a>
        on 2024-02-02 16:34
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/zanieb">@zanieb</a> on 2024-02-02 16:34</div>
            <div class="timeline-body"><p>In some cases, a lint fix can drop comments. Retaining all comments was a major goal in the Ruff formatter and we've learned that it is very hard to accomplish. There is significant foundational work that would need to be invested in the linter to prevent it from ever dropping comments. While we would like to accomplish this eventually, we're a small team with a lot of priorities to balance. In the meantime, we want to formalize a policy for fixes that may drop comments.</p>
<p>A few options:</p>
<ol>
<li>A fix should not be offered if the range contains a comment</li>
<li>A fix that may drop a comment must always be unsafe</li>
<li>A fix that may drop a comment must be unsafe if a comment is present in the fix range</li>
<li>A fix will only drop comments in ranges that use dangerous syntax e.g. line continuations</li>
<li>A fix that may drop a comment is always safe â€” we do not make guarantees about comments</li>
</ol>
<p>We currently apply a mix of these options, but we should be consistent. More options and discussion welcome.</p>
<p>Related issues and reports:</p>
<ul>
<li>https://github.com/astral-sh/ruff/issues/9779</li>
<li>https://github.com/astral-sh/ruff/issues/9715</li>
<li>https://github.com/astral-sh/ruff/issues/4296</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">autofix</span> added by @zanieb on 2024-02-02 16:34</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-02-02 16:35</div>
            <div class="timeline-body"><p>Another thing we do in some places (which IMO is incorrect): if the range contains a comment, we don't offer the fix at all. For example, this is true of <code>SIM401</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-02-02 19:24</div>
            <div class="timeline-body"><p>There also used to be some cases in which we wouldn't flag the violation <em>at all</em> if the range contained comments, but I think we removed these. (I'm not certain.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-02-02 19:28</div>
            <div class="timeline-body"><p>Just to put a decision out there for discussion, I'd propose...</p>
<blockquote>
<p>Dropping comments should be treated as unsafe (and should be documented as such -- it's not unsafe per se based on the current definition in the rustdoc, in my opinion). But we should avoid <em>disabling</em> violations and <em>disabling</em> fixes based on the presence of comments. We will go through and audit rules that rewrites large blocks of code (this tends <em>not</em> to be the norm), e.g., those that modify entire statements, and add appropriate guardrails to them.</p>
</blockquote>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-02-02 21:42</div>
            <div class="timeline-body"><p>Since I was asked elsewhere to clarify, the above suggestion is meant to say:</p>
<p>We should not disable a rule due to the presence of comments.</p>
<p>We should not disable a fix due to the presence of comments.</p>
<p>We should mark a fix as unsafe if there's a comment in the range.</p>
<p>We should only prioritize proactively changing the behavior of rules that rewrite large blocks of code (modify entire statements, or convert statements to expressions or vice versa).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-02-04 11:31</div>
            <div class="timeline-body"><p>The ideal situation would be that all rules handle comments correctly and only remove comments if a fix removes the entire code block containing the comment.</p>
<p>Now, what the short-term ideal should be is something I find much harder to implement, and I don't feel I have the understanding to decide on that. What's important to me is that we can come up with a proposal that avoids making the <code>safe</code> and <code>unsafe</code> rule separation meaningless because too many rules are <code>unsafe</code>, so that users who want to use most of our fixes are forced (or motivated) to opt-in to enable unsafe fixes by default.</p>
<p>That's why I need a better understanding of how many rules would be affected by any of the above proposals and the ideal solution to me is the solution where only enabling safe fixes remains the best default for users while being as explicit (and defensive) in which situation ruff removes comments.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/UnknownPlatypus">@UnknownPlatypus</a> on 2024-02-04 14:54</div>
            <div class="timeline-body"><p>Chiming in because I recently encountered a somehow related issue.
I got bitten by a combinaison of <code>TID252</code> with a <code>noqa: F401</code> on one of the imports.</p>
<p>Basically something like that:</p>
<pre><code class="language-diff">-from . import (
-    foo,
-    bar,
-    MyVeryImportantClass, # noqa: F401
-)
+ from yay import foo, bar
</code></pre>
<p>I think what you proposed above about demoting the fix safety to unsafe in case there are comments would have solve my issue here.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/jakkdl">@jakkdl</a> on 2024-03-06 15:53</div>
            <div class="timeline-body"><p>My 2 cents:
<code>unsafe-because-it-may-remove-comments</code> vs <code>unsafe-because-it-may-impact-logic</code> (e.g. sort stability in C413/C414) should perhaps not be treated the same in terms of flags or warnings. Depending on what you settle on, you might want different flags or different levels of unsafe-ness to differentiate them.</p>
<p>If possible it would be great if ruff could <em>detect</em> whether it has lost comments, and surface that to the user. I don't have as strong opinions between</p>
<ol>
<li>dump lost comments somewhere in the vicinity for the user to deal with</li>
<li>warn the user about comments that have been deleted</li>
<li>say that a fix was attempted, but failed because it would delete a comment, and prompt the user to possibly add a flag that would force the <code>--fix</code> and delete the comment.</li>
</ol>
<p>I do agree that the current status quo is kinda iffy, but I've also spent an unreasonable amount of time trying to preserve comments in AST &amp; libcst parsers that I can empathize &lt;3</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2024-11-13 13:04</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 11:32:38 UTC
    </footer>
</body>
</html>
