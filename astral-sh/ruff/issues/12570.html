<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fixing file with rule F401 cause infinite loop - astral-sh/ruff #12570</title>
    <link rel="stylesheet" href="../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../index.html">Back to index</a>
    </div>

    <h1>Fixing file with rule F401 cause infinite loop</h1>

    <div class="meta">
        <span class="state state-closed">Closed</span>
        <a href="https://github.com/astral-sh/ruff/issues/12570">#12570</a>
        opened by <a href="https://github.com/qarmin">@qarmin</a>
        on 2024-07-29 17:38
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/qarmin">@qarmin</a> on 2024-07-29 17:38</div>
            <div class="timeline-body"><p>ruff 0.5.5+353 (2f54d05d9 2024-07-29)</p>
<pre><code>ruff check *.py --select F401 --no-cache --fix --unsafe-fixes --preview --output-format concise --isolated
</code></pre>
<p>file content(at the bottom should be attached raw, not formatted file - github removes some non-printable characters, so copying from here may not work):</p>
<pre><code>from .main import MaµToMan
</code></pre>
<p>error</p>
<pre><code>/tmp/tmp_folder/data/5737962126122819962.py:1:8: F401 `tima` imported but unused
Found 501 errors (500 fixed, 1 remaining).
[*] 1 fixable with the --fix option.

debug error: Failed to converge after 500 iterations in `/tmp/tmp_folder/data/5737962126122819962.py` with rule codes F401:---
import timª
---
</code></pre>
<p>Ruff build, that was used to reproduce problem(compiled on Ubuntu 22.04 with release mode + debug symbols + debug assertions + overflow checks) - https://github.com/qarmin/Automated-Fuzzer/releases/download/Nightly/ruff.7z</p>
<p><a href="https://github.com/user-attachments/files/16416924/python_compressed.zip">python_compressed.zip</a></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @charliermarsh on 2024-07-29 17:40</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">fuzzer</span> added by @charliermarsh on 2024-07-29 17:40</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/12569.html">astral-sh/ruff#12569</a> on 2024-07-29 17:41</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @AlexWaygood by @AlexWaygood on 2024-07-29 17:59</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-07-29 17:59</div>
            <div class="timeline-body"><p>Cool bug, thanks!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-07-29 18:27</div>
            <div class="timeline-body"><p>This is an issue with NFKC normalization. If you apply this diff to Ruff:</p>
<pre><code class="language-diff">diff --git a/crates/ruff_linter/src/fix/codemods.rs b/crates/ruff_linter/src/fix/codemods.rs
index c3c769172..ed4061435 100644
--- a/crates/ruff_linter/src/fix/codemods.rs
+++ b/crates/ruff_linter/src/fix/codemods.rs
@@ -80,7 +80,7 @@ pub(crate) fn remove_imports&lt;'a&gt;(
     for member in member_names {
         let alias_index = aliases
             .iter()
-            .position(|alias| member == qualified_name_from_name_or_attribute(&amp;alias.name));
+            .position(|alias| dbg!(member) == dbg!(qualified_name_from_name_or_attribute(&amp;alias.name)));
         if let Some(index) = alias_index {
             aliases.remove(index);
         }
diff --git a/crates/ruff_linter/src/rules/pyflakes/rules/unused_import.rs b/crates/ruff_linter/src/rules/pyflakes/rules/unused_import.rs
index bfa884801..4c86744db 100644
--- a/crates/ruff_linter/src/rules/pyflakes/rules/unused_import.rs
+++ b/crates/ruff_linter/src/rules/pyflakes/rules/unused_import.rs
@@ -397,6 +397,8 @@ pub(crate) fn unused_import(checker: &amp;Checker, scope: &amp;Scope, diagnostics: &amp;mut
         }
         diagnostics.push(diagnostic);
     }
+
+    panic!()
 }
</code></pre>
<p>Then the output from the debug calls is as follows:</p>
<pre><code>[crates/ruff_linter/src/fix/codemods.rs:83:31] member = &quot;MaμToMan&quot;
[crates/ruff_linter/src/fix/codemods.rs:83:47] qualified_name_from_name_or_attribute(&amp;alias.name) = &quot;MaµToMan&quot;
</code></pre>
<p>And I'll also paste a screenshot because it looks like GitHub might actually normalize these confusables as well when it renders them in an issue comment?!):</p>
<hr />
<p><img src="https://github.com/user-attachments/assets/6a4a30c8-93d3-418b-a906-085f1484b0e4" alt="image" /></p>
<hr />
<p>If you look <em>very</em> closely at that screenshot, you can see that the <code>μ</code> on the first line is sliiiightly narrower in size than the <code>µ</code> on the second line. In other words, one of the two variables has been NFKC-normalized while the other has not, meaning the comparison here evaluates to <code>false</code> when it should be evaluating to <code>true</code>:</p>
<p>https://github.com/astral-sh/ruff/blob/381bd1ff4a38e0582618e76ae1bd3696b1b2ff5d/crates/ruff_linter/src/fix/codemods.rs#L83</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/12571.html">astral-sh/ruff#12571</a> on 2024-07-29 18:35</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @AlexWaygood on 2024-07-30 09:54</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:28:13 UTC
    </footer>
</body>
</html>
