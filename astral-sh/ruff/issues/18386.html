<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Allow for flake8-bugbear behavior for B008, trigger on any function call even if immutable - astral-sh/ruff #18386</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Allow for flake8-bugbear behavior for B008, trigger on any function call even if immutable</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/ruff/issues/18386">#18386</a>
        opened by <a href="https://github.com/blackary">@blackary</a>
        on 2025-05-30 14:33
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/blackary">@blackary</a> on 2025-05-30 14:33</div>
            <div class="timeline-body"><h3>Summary</h3>
<p>Ruff's handling of B008 is different from the flake8-bugbear behavior, in that it only catches cases where the default argument is a function AND the type is not annotated as something immutable.</p>
<p>On the other hand, flake8-bugbear catches any function that is called as a default argument, which catches more potential problematic code.</p>
<p>Here's a silly example:</p>
<pre><code class="language-python">import random

def get_random_number(num: int = random.randint(1, 100)) -&gt; int:
    return num
</code></pre>
<p>Ruff's behavior</p>
<pre><code class="language-sh">uvx ruff check --select B008 foo.py
All checks passed!
</code></pre>
<p>Flake8-bugbear's behavior</p>
<pre><code class="language-sh">uvx --with flake8-bugbear flake8 --select B008 foo.py
foo.py:3:34: B008 Do not perform function calls in argument defaults.  The call is performed only once at function definition time. All calls to your function will reuse the result of that definition-time function call.  If this is intended, assign the function call to a module-level variable and use that variable as a default value.
</code></pre>
<p>While I understand that keeping the default behavior as-is might be preferable in many cases, there are also many cases where the return value of a function is not static, even if the return type is, and this can cause unintended issues. Here's a recent example that came up in one of the codebases I help maintain.</p>
<pre><code class="language-python"> def log_message(message: str, username: str = get_current_username()):
	...
</code></pre>
<p>In this case, there is a bug in this code when different users use this code running on the same server. Flake8-bugbear's default behavior would flag this, but ruff's implementation does not because the annotated type is <code>str</code>.</p>
<p>I'm not sure the best way to name such an option, but I would like to suggest adding a setting like</p>
<pre><code class="language-toml">[tool.ruff.lint.flake8-bugbear]
# Don't allow any function calls in default arguments, even if they return immutable types
dont-allow-any-function-defaults = true
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntBre">@ntBre</a> on 2025-06-02 17:37</div>
            <div class="timeline-body"><p>It looks like the behavior was changed relatively recently in https://github.com/astral-sh/ruff/pull/16048. I think it makes sense to add an option to restore the original/upstream behavior.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">configuration</span> added by @ntBre on 2025-06-02 17:37</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-06-03 07:09</div>
            <div class="timeline-body"><p>I think the function to check for immutability is used in more places than just for this rule. We should consider if it makes sense to have a general option or if it should be a rule specific option.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 11:37:34 UTC
    </footer>
</body>
</html>
