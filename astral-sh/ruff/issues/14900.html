<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PLC0206 diagnostic location is confusing - astral-sh/ruff #14900</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>PLC0206 diagnostic location is confusing</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/issues/14900">#14900</a>
        opened by <a href="https://github.com/oz123">@oz123</a>
        on 2024-12-10 22:15
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/oz123">@oz123</a></div>
            <div class="timeline-body"><p>First it tells me no to use:</p>
<pre><code>for key in dict:
      do_someting(key)
</code></pre>
<p>When I try <code>dict.keys</code> it still complains.
When I try `dict.item() and throw away value, it still complains:</p>
<pre><code>oznt@dell-gentoo:/srv/oznt/Software/pypa/pipenv |pipenv-mRt4xz3R| [±|completely-remove-click-echo {2} U:3 ?:6 ✗|] $ruff check pipenv/routines/outdated.py 
pipenv/routines/outdated.py:50:23: PERF102 When using only the keys of a dict use the `keys()` method
   |
48 |     outdated = []
49 |     skipped = []
50 |     for package, _ in packages.items():
   |                       ^^^^^^^^^^^^^^ PERF102
51 |         norm_name = pep423_name(package)
52 |         if norm_name in updated_packages:
   |
   = help: Replace `.items()` with `.keys()`

Found 1 error.
No fixes available (1 hidden fix can be enabled with the `--unsafe-fixes` option).
oznt@dell-gentoo:/srv/oznt/Software/pypa/pipenv |pipenv-mRt4xz3R| [±|completely-remove-click-echo {2} U:3 ?:6 ✗|] $vim pipenv/routines/outdated.py 
oznt@dell-gentoo:/srv/oznt/Software/pypa/pipenv |pipenv-mRt4xz3R| [±|completely-remove-click-echo {2} U:3 ?:6 ✗|] $vim pipenv/routines/outdated.py 
oznt@dell-gentoo:/srv/oznt/Software/pypa/pipenv |pipenv-mRt4xz3R| [±|completely-remove-click-echo {2} U:2 ?:6 ✗|] $ruff check pipenv/routines/outdated.py 
pipenv/routines/outdated.py:50:5: PLC0206 Extracting value from dictionary without calling `.items()`
   |
48 |       outdated = []
49 |       skipped = []
50 |       for package in packages.keys():
   |  _____^
51 | |         norm_name = pep423_name(package)
52 | |         if norm_name in updated_packages:
53 | |             version = packages[package]
54 | |             if isinstance(version, Mapping):
55 | |                 version = parse_version(version.get(&quot;version&quot;, &quot;&quot;).replace(&quot;==&quot;, &quot;&quot;))
56 | |             else:
57 | |                 version = parse_version(version.replace(&quot;==&quot;, &quot;&quot;))
58 | |             if updated_packages[norm_name] != version:
59 | |                 outdated.append(
60 | |                     package_info(package, str(version), str(updated_packages[norm_name]))
61 | |                 )
62 | |             elif canonicalize_name(package) in outdated_packages:
63 | |                 skipped.append(outdated_packages[canonicalize_name(package)])
   | |_____________________________________________________________________________^ PLC0206
64 |       for package, old_version, new_version in skipped:
65 |           for category in project.get_package_categories():
   |

Found 1 error.

</code></pre>
<p>I believe PLC0206 should not be raised if I use <code>dict.keys()</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dylwil3">@dylwil3</a> on 2024-12-10 23:32</div>
            <div class="timeline-body"><p>Thanks for submitting this!</p>
<p>So I think that the error message is pointing to the wrong spot (which is confusing...), PLC0206 is complaning about this:</p>
<pre><code>    if norm_name in updated_packages:
        version = packages[package]
</code></pre>
<p>So I think it would be compatible with both rules to do something more like:</p>
<pre><code>diff --git a/tmp.py b/tmp2.py
index dfa6d6f..6975214 100644
--- a/tmp.py
+++ b/tmp2.py
@@ -1,9 +1,8 @@
 outdated = []
 skipped = []
-for package in packages.keys():
+for package, version in packages.items():
     norm_name = pep423_name(package)
     if norm_name in updated_packages:
-        version = packages[package]
         if isinstance(version, Mapping):
             version = parse_version(version.get(&quot;version&quot;, &quot;&quot;).replace(&quot;==&quot;, &quot;&quot;))
         else:
</code></pre>
<p>But I can&#x27;t quite tell from your code if you&#x27;re trying to mutate the dictionary key at that point, in which case you&#x27;d have to do something else. (The above patch would also violate <a href="https://docs.astral.sh/ruff/rules/redefined-loop-name/#redefined-loop-name-plw2901">redefined-loop-name (PLW2901)</a>, so if that rule is also enabled you would have to name the loop variable something else).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dylwil3">@dylwil3</a> on 2024-12-10 23:32</div>
            <div class="timeline-body"><p>I do think the error message being in the wrong spot is a bug though - we should fix that</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by <a href="https://github.com/dylwil3">@dylwil3</a> on 2024-12-10 23:33</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">diagnostics</span> added by <a href="https://github.com/dylwil3">@dylwil3</a> on 2024-12-10 23:33</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from &quot;PLC0206 vs PERF102 limbo ...&quot; to &quot;PLC0206 diagnostic location is confusing&quot; by <a href="https://github.com/dylwil3">@dylwil3</a> on 2024-12-11 19:38</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dylwil3">@dylwil3</a> on 2024-12-13 16:48</div>
            <div class="timeline-body"><p>I started looking into this and there&#x27;s a bit of a design question: how should we handle multiple uses of the dictionary value inside the for-loop?</p>
<p>Some options:</p>
<ol>
<li>Offer a separate diagnostic per violation, pointing to the location of the violation</li>
<li>Same as (1) but add a &quot;parent&quot; for each of these diagnostics at the start of the for-loop, so users can <code># noqa</code> the whole block (I think that&#x27;s how that would work?)</li>
<li>Overhaul the diagnostic infrastructure to allow displaying multiple ranges for a single diagnostic (I imagine this would be a last resort)</li>
<li>Keep it as-is</li>
<li>Something else</li>
</ol>
<p>@AlexWaygood / @MichaReiser have y&#x27;all run into this issue before where you want to display multiple text ranges for a single diagnostic? Is there prior art?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-12-15 15:46</div>
            <div class="timeline-body"><p>Changing the location is, unfortunately, a breaking change because it breaks all <code>noqa</code> comments. We should avoid changing the location more than once.</p>
<p>To me it&#x27;s not clear what the right location should be but I&#x27;m leaning towards:</p>
<ul>
<li>Flagging the dictionary expression in <code>in &lt;dict&gt;</code> because the rule name and its description are both about dictionary iteration (and not *use of dict index in dictionary iteration)</li>
<li>Flagging the <code>in &lt;dict&gt;</code> allows suppressing all usages with a single noqa comment</li>
</ul>
<p>However, I can see how this isn&#x27;t useful. That&#x27;s why I&#x27;m leaning towards renaming and redefining the rule to flag the usages instead. Requiring multiple <code>noqa</code> comments would then be okay in my view because the rule reports the usages and not the for loop itself.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/beauxq">@beauxq</a> on 2025-11-22 18:11</div>
            <div class="timeline-body"><p>Note that this diagnostic location has the same problem as this issue: <a href="https://github.com/astral-sh/ruff/issues/15570">astral-sh/ruff#15570</a></p>
<p>Marking an entire 100-line <code>for</code> loop with yellow squigglies is really noisy. It makes it hard to see other things that I&#x27;m looking for in the code.</p>
<p>Please steer away from marking anything that could be a large block of code.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntBre">@ntBre</a> on 2025-12-30 22:10</div>
            <div class="timeline-body"><p>I like the idea of flagging the <code>in &lt;dict&gt;</code> part as the primary diagnostic range. Now that we have sub-diagnostics, we could attach a sub-diagnostic/secondary annotation for each of the <code>dict[key]</code> uses.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/ntBre">@ntBre</a> on 2025-12-31 18:54</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 18:49:08 UTC
    </footer>
</body>
</html>
