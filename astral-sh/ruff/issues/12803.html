<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>`import-outside-top-level (PLC0415)` is incompatible with `flake8-tidy-imports.banned-module-level-imports` - astral-sh/ruff #12803</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>`import-outside-top-level (PLC0415)` is incompatible with `flake8-tidy-imports.banned-module-level-imports`</h1>

    <div class="meta">
        <span class="state state-closed">Closed</span>
        <a href="https://github.com/astral-sh/ruff/issues/12803">#12803</a>
        opened by <a href="https://github.com/Avasam">@Avasam</a>
        on 2024-08-11 17:23
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/Avasam">@Avasam</a> on 2024-08-11 17:23</div>
            <div class="timeline-body"><p>Reframed issue:</p>
<p><code>import-outside-top-level (PLC0415)</code> and <code>banned-module-level-imports (TID253)</code> are incompatible together.</p>
<p><code>ruff.toml</code></p>
<pre><code class="language-toml">
[lint]
preview = true
extend-select = [
	&quot;TID253&quot;, # banned-module-level-imports, see banned-module-level-imports below
	&quot;PLC0415&quot;, # import-outside-top-level
]

[lint.flake8-tidy-imports]
# Modules we want setuptools to be able to work without requiring
banned-module-level-imports = [
	&quot;ctypes&quot;, # see #4461 for example
	&quot;typing_extensions&quot;, # Useful for development, shouldn't be required at runtime
	# platform-specific imports
	&quot;winreg&quot;,
]
</code></pre>
<p>Code:</p>
<pre><code class="language-py">import winreg # raises TID253

def win_only_method():
    import winreg # raises PLC0415

    print(winreg)
</code></pre>
<details>
<summary>Original issue</summary>

<ul>
<li>List of keywords you searched for before creating this issue. Write them down here so that others can find this issue more easily and help provide feedback.
PLC0415, top level module import, banned api</li>
<li>The current Ruff version (<code>ruff --version</code>): ruff 0.5.5</li>
</ul>
<p>I came across a use-case where it would be preferable to check that certain imports are never imported directly at the module level. This is mainly for dependencies that should stay optional, or that are known to be be ostly and only useful in specific codepaths.</p>
<p>For example, setuptools could configure <code>ctypes</code>, <code>typing_extensions</code>, and more, to ensure that they're never unconditionally imported.</p>
<p>A check that the import is behind a conditional (if-else, try-except) or in a function, should be sufficient.</p>
<p>This is similar in idea to the https://docs.astral.sh/ruff/rules/#flake8-type-checking-tch (TCH001, TCH002, TCH003) rules.</p>
<p>This would conflict with https://docs.astral.sh/ruff/rules/import-outside-top-level/ (PLC0415). My original idea was to suggest an ignore list for PLC0415, but I think this could be pushed further with a rule that actually enforces it.
If this idea is rejected, I'd still like an ignore/allowlist for PLC0415 .</p>
</details>

</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">rule</span> added by @charliermarsh on 2024-08-11 19:24</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-08-11 19:25</div>
            <div class="timeline-body"><p>I think this is pretty reasonable. I've implemented this as a custom lint rule (for tensorflow -- to ensure it's always imported lazily) in the past.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">accepted</span> added by @charliermarsh on 2024-08-11 19:25</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-08-11 19:25</div>
            <div class="timeline-body"><p>Any imports that are marked as required-top-level should also be ignored in <code>PLC0415</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Avasam">@Avasam</a> on 2024-08-11 20:07</div>
            <div class="timeline-body"><blockquote>
<p>Any imports that are marked as required-top-level should also be ignored in <code>PLC0415</code>.</p>
</blockquote>
<p>Do you mean &quot;required<b>-not-</b>top-level&quot; ?</p>
<p>Also I just found https://docs.astral.sh/ruff/rules/banned-module-level-imports/ , it seems to be doing exactly what I want. But it's not respected by <code>PLC0415</code>. So I'll reframe my request.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "Feature Request: Configure imports that shouldn't be a module-level" to "`import-outside-top-level (PLC0415)` is incompatible with `flake8-tidy-imports.banned-module-level-imports`" by @Avasam on 2024-08-11 20:09</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-08-11 20:30</div>
            <div class="timeline-body"><p>Yes sorry, that’s what I meant. Thanks for spotting that!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">rule</span> removed by @charliermarsh on 2024-08-11 20:30</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @charliermarsh on 2024-08-11 20:30</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-08-11 20:31</div>
            <div class="timeline-body"><p>I’ll call it a bug that they’re aren’t compatible.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @charliermarsh by @charliermarsh on 2024-08-30 16:03</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Unassigned @charliermarsh by @charliermarsh on 2024-08-30 16:20</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/15628.html">astral-sh/ruff#15628</a> on 2025-01-21 04:05</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @MichaReiser on 2025-01-24 10:07</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:34:53 UTC
    </footer>
</body>
</html>
