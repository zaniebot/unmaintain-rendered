<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ruff check src/ --fix fails to discover some nested files but works when ran directly on that file - astral-sh/ruff #9504</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>ruff check src/ --fix fails to discover some nested files but works when ran directly on that file</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/ruff/issues/9504">#9504</a>
        opened by <a href="https://github.com/ringohoffman">@ringohoffman</a>
        on 2024-01-13 09:00
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/ringohoffman">@ringohoffman</a> on 2024-01-13 09:00</div>
            <div class="timeline-body"><!--
Thank you for taking the time to report an issue! We're glad to have you involved with Ruff.

If you're filing a bug report, please consider including the following information:

* A minimal code snippet that reproduces the bug.
* The command you invoked (e.g., `ruff /path/to/file.py --fix`), ideally including the `--isolated` flag.
* The current Ruff settings (any relevant sections from your `pyproject.toml`).
* The current Ruff version (`ruff --version`).
-->

<pre><code class="language-console">$ ruff --version
ruff 0.1.13
</code></pre>
<ol>
<li>clone <a href="https://github.com/nerfstudio-project/nerfstudio"><code>nerfstudio</code></a>.</li>
<li>Use this <code>ruff</code> config:</li>
</ol>
<pre><code class="language-toml">[tool.ruff]
line-length = 120
select = [
    &quot;E&quot;,  # pycodestyle errors.
    &quot;F&quot;,  # Pyflakes rules.
    &quot;I&quot;,  # isort formatting.
    &quot;PLC&quot;,  # Pylint convention warnings.
    &quot;PLE&quot;,  # Pylint errors.
    &quot;PLR&quot;,  # Pylint refactor recommendations.
    &quot;PLW&quot;,  # Pylint warnings.
]
ignore = [
    &quot;E501&quot;,  # Line too long.
    &quot;F722&quot;,  # Forward annotation false positive from jaxtyping. Should be caught by pyright.
    &quot;F821&quot;,  # Forward annotation false positive from jaxtyping. Should be caught by pyright.
    &quot;PLR2004&quot;,  # Magic value used in comparison.
    &quot;PLR0915&quot;,  # Too many statements.
    &quot;PLR0913&quot;,  # Too many arguments.
    &quot;PLC0414&quot;,  # Import alias does not rename variable. (this is used for exporting names)
    &quot;PLC1901&quot;,  # Use falsey strings.
    &quot;PLR5501&quot;,  # Use `elif` instead of `else if`.
    &quot;PLR0911&quot;,  # Too many return statements.
    &quot;PLR0912&quot;,  # Too many branches.
    &quot;PLW0603&quot;,  # Globa statement updates are discouraged.
    &quot;PLW2901&quot;,  # For loop variable overwritten.
]

[tool.ruff.lint.isort]
combine-as-imports = true
known-first-party = [&quot;nerfstudio&quot;]
split-on-trailing-comma = false
</code></pre>
<ol start="3">
<li>Apply <code>ruff</code> import formatting</li>
</ol>
<pre><code class="language-console">$ ruff check nerfstudio/ docs/ tests/ --fix
</code></pre>
<ol start="4">
<li>Use this <code>isort</code> config:</li>
</ol>
<pre><code class="language-toml">[tool.isort]
combine_as_imports = true
line_length = 120
known_first_party = [&quot;nerfstudio&quot;]
profile = &quot;black&quot;
</code></pre>
<ol start="5">
<li><code>isort</code> discovers a missed fix</li>
</ol>
<pre><code class="language-console">$ isort nerfstudio/ docs/ tests/
Fixing /Users/ringo/Repositories/nerfstudio/nerfstudio/scripts/downloads/download_data.py
</code></pre>
<ol start="6">
<li>Strangely enough:</li>
</ol>
<pre><code class="language-console">$ ruff check nerfstudio/scripts --fix
Found 1 error (1 fixed, 0 remaining).
</code></pre>
<p>or</p>
<pre><code class="language-console">$ ruff check nerfstudio/scripts/downloads/download_data.py --fix
Found 1 error (1 fixed, 0 remaining).
</code></pre>
<p>And also, <code>ruff</code> succeeds at finding and fixing other scripts in this folder.</p>
<pre><code class="language-console">$ tree nerfstudio/scripts/
nerfstudio/scripts/
├── __init__.py
├── completions
│   ├── __init__.py
│   ├── install.py
├── downloads
│   ├── __init__.py
│   └── download_data.py  // &lt;- only one that is missed?
├── process_data.py
├── render.py
└── viewer
    ├── __init__.py
    └── run_viewer.py
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "ruff check src/ --fix fails to discover fixes in some nested files but works when ran directly on that file" to "ruff check src/ --fix fails to discover some nested files but works when ran directly on that file" by @ringohoffman on 2024-01-13 09:02</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @charliermarsh on 2024-01-13 12:44</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">isort</span> added by @charliermarsh on 2024-01-13 12:44</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-01-13 12:45</div>
            <div class="timeline-body"><p>Thanks, really good issue + instructions, I was able to repro.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @charliermarsh by @charliermarsh on 2024-01-13 12:45</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-01-13 14:39</div>
            <div class="timeline-body"><p>I think the issue is that <code>nerfstudio/nerfstudio/scripts/downloads</code> is ignored by the <code>.gitignore</code>, which has this:</p>
<pre><code class="language-gitignore">downloads/
!nerfstudio/scripts/downloads/
</code></pre>
<p>@BurntSushi - is the <code>.gitignore</code> incorrect, or is the <code>ignore</code> crate not able to pick that up?</p>
<p>You can add:</p>
<pre><code class="language-toml">[tool.ruff]
respect-gitignore = false
</code></pre>
<p>For now as a workaround. (See: https://docs.astral.sh/ruff/settings/#respect-gitignore.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2024-01-14 18:38</div>
            <div class="timeline-body"><p>Just from a quick look on a checkout of <code>nerfstudio</code>, it looks like the <code>ignore</code> crate is handling the rules correctly and whitelisting <code>nerfstudio/scripts/downloads</code>:</p>
<pre><code>$ rg --files --debug 2&gt; /tmp/log | rg nerfstudio/scripts/downloads
nerfstudio/scripts/downloads/download_data.py
nerfstudio/scripts/downloads/__init__.py
$ rg nerfstudio/scripts/downloads /tmp/log
39:rg: DEBUG|ignore::walk|crates/ignore/src/walk.rs:1802: whitelisting ./nerfstudio/scripts/downloads: Whitelist(IgnoreMatch(Gitignore(Glob { from: Some(&quot;./.gitignore&quot;), original: &quot;!nerfstudio/scripts/downloads/&quot;, actual: &quot;nerfstudio/scripts/downloads&quot;, is_whitelist: true, is_only_dir: true })))
$ fd . | rg nerfstudio/scripts/downloads
nerfstudio/scripts/downloads/
nerfstudio/scripts/downloads/__init__.py
nerfstudio/scripts/downloads/download_data.py
</code></pre>
<p>Perhaps there is some interaction between ruff and the <code>ignore</code> crate that is causing the issue here. Or there is some other rule in play. I can dig more into this tomorrow.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-01-26 19:33</div>
            <div class="timeline-body"><p>I think the issue is that once we exclude a directory, we don't recurse further into it (and so we never test its children). Wouldn't it be really expensive to check all children of all excluded directories?</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 11:32:27 UTC
    </footer>
</body>
</html>
