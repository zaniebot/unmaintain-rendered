```yaml
number: 3622
title: "[Autofix error] Invalid code produce autofix error"
type: issue
state: closed
author: qarmin
labels:
  - bug
assignees: []
created_at: 2023-03-20T08:30:52Z
updated_at: 2023-03-23T17:36:51Z
url: https://github.com/astral-sh/ruff/issues/3622
synced_at: 2026-01-10T01:56:46Z
```

# [Autofix error] Invalid code produce autofix error

---

_Issue opened by @qarmin on 2023-03-20 08:30_

Ruff  a45753f462c7a53afd7f942ab3c6f9af3871bf1f

```
# flake8: noqa: F405
fom opts import *  # noqa
```
with 
```
ruff file.py --fix
```

```
error: Autofix introduced a syntax error. Reverting all changes.

This indicates a bug in `ruff`. If you could open an issue at:

    https://github.com/charliermarsh/ruff/issues/new?title=%5BAutofix%20error%5D

...quoting the contents of `Desktop/RunEveryCommand/Ruff/Broken/94966__init__ (9â€¯413th copy)0.py`, along with the `pyproject.toml` settings and executed command, we'd be very appreciative!
```


---

_Label `bug` added by @charliermarsh on 2023-03-20 15:11_

---

_Comment by @JonathanPlasse on 2023-03-20 23:27_

```python
# flake8: noqa: F405
fom opts import *  # noqa
^^^
```
`fom` seems to be an invalid syntax.

---

_Comment by @charliermarsh on 2023-03-20 23:27_

It might be a bug that we're considering that `noqa` to be unused though, it should be suppressing an `E999` error...? Not sure why that's not getting raised here.

---

_Comment by @JonathanPlasse on 2023-03-20 23:30_

I think `# noqa` should never suppress `E999`, that seems to be the problem.

---

_Comment by @charliermarsh on 2023-03-20 23:31_

I think it _should_, that was used as a workaround for a while for `match` statement. But we're raising a `RUF100`, then fixing _that_, then Ruff _thinks_ we introduced a syntax error.

---

_Comment by @charliermarsh on 2023-03-20 23:32_

Ahh, the issue is `# flake8: noqa: F405`. That suppress _all_ errors, just like in Flake8.

---

_Comment by @charliermarsh on 2023-03-20 23:33_

The issue is here:

```rust
Err(parse_error) => {
    if settings.rules.enabled(Rule::SyntaxError) {
        pycodestyle::rules::syntax_error(&mut diagnostics, &parse_error);
    }

    // If the syntax error is ignored, suppress it (regardless of whether
    // `Rule::SyntaxError` is enabled).
    if !rule_is_ignored(
        Rule::SyntaxError,
        parse_error.location.row(),
        &directives.noqa_line_for,
        locator,
    ) {
        error = Some(parse_error);
    }
}
```

That needs to respect the _whole file_ ignores, not just the inline ignores.

---

_Referenced in [astral-sh/ruff#3665](../../astral-sh/ruff/pulls/3665.md) on 2023-03-22 04:08_

---

_Assigned to @charliermarsh by @charliermarsh on 2023-03-22 04:08_

---

_Closed by @charliermarsh on 2023-03-23 17:36_

---
