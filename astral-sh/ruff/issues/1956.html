<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>INP001 check should respect `ruff.src` setting or have it configured separately - astral-sh/ruff #1956</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>INP001 check should respect <code>ruff.src</code> setting or have it configured separately</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/issues/1956">#1956</a>
        opened by <a href="https://github.com/notypecheck">@notypecheck</a>
        on 2023-01-18 14:08
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/notypecheck">@notypecheck</a></div>
            <div class="timeline-body"><p>A lot of projects nest code under <code>src</code> directory by adding <code>src</code> to PYTHONPATH:</p>
<pre><code>src/
  some_package/
    __init__.py
    ...
  main.py

pyproject.toml
</code></pre>
<pre><code>ruff .
</code></pre>
<pre><code>src\main.py:1:1: INP001 File `\src\main.py` is part of an implicit namespace package. Add an `__init__.py`.
Found 1 error(s)
</code></pre>
<p>Ruff version: 0.0.225
Ruff configuration:</p>
<pre><code>[tool.ruff]
select = [&quot;INP&quot;]
src = [&quot;src&quot;]
</code></pre>
<p>A solution to this might be using <code>ruff.src</code> or different settings to exclude files contained directly in that directory<br>
But this might be an issue for packages that would want to use <code>ruff.src</code> for example for <code>isort</code> checks but would still want their package directory to be checked by <code>INP001</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/notypecheck">@notypecheck</a> on 2023-01-18 14:11</div>
            <div class="timeline-body"><p>Adding <code>__init__.py</code> actually breaks some tools like mypy:</p>
<pre><code># src/some_package/test.py
def a() -&gt; int:
    return 42
</code></pre>
<pre><code># main.py
from some_package.test import a

reveal_type(a())
</code></pre>
<p>Without <code>__init__.py</code>:</p>
<pre><code>$ mypy .
src\main.py:3: note: Revealed type is &quot;builtins.int&quot;
Success: no issues found in 3 source files
</code></pre>
<p>With <code>__init__.py</code>:</p>
<pre><code>$ mypy .
src\main.py:1: error: Skipping analyzing &quot;some_package.test&quot;: module is installed, but missing library stubs or py.typed marker  [import]
src\main.py:1: note: See https://mypy.readthedocs.io/en/stable/running_mypy.html#missing-imports
src\main.py:3: note: Revealed type is &quot;Any&quot;
Found 1 error in 1 file (checked 4 source files)
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-01-18 16:42</div>
            <div class="timeline-body"><p>Hmm. I think omitting directories specified by <code>src</code> makes sense? Trying to think of where that would cause problems.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/notypecheck">@notypecheck</a> on 2023-01-18 16:51</div>
            <div class="timeline-body"><p>Libraries might use the following structure:</p>
<pre><code>root/ # Which is the project root
  library/
    __init__.py
    ...
  pyproject.toml
</code></pre>
<p>In this case developers would want to treat import from <code>library</code> which would be in <code>ruff.src</code> as first party, but it also should not be omitted from <code>INP</code> check</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/edgarrmondragon">@edgarrmondragon</a> on 2023-01-18 17:26</div>
            <div class="timeline-body"><p>Note that <code>flake8-no-pep420</code> has the same behavior:</p>
<pre><code>$ tree check_inp001
check_inp001
â””â”€â”€ src
    â”œâ”€â”€ main.py
    â””â”€â”€ some_package
        â””â”€â”€ __init__.py

$ flake8 --select INP check_inp001
check_inp001/src/main.py:1:1: INP001 File is part of an implicit namespace package. Add an __init__.py?
</code></pre>
<p>I&#x27;m also not sure how common it is to have modules directly nested under <code>src/</code>, but the single file in the case above could be ignored:</p>
<pre><code>[tool.ruff.per-file-ignores]
&quot;src/main.py&quot; = [&quot;INP001&quot;]
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/notypecheck">@notypecheck</a> on 2023-01-18 17:36</div>
            <div class="timeline-body"><p>I&#x27;d say having <code>src</code> directory is quite common, and specifying multiple files in <code>per-file-ignores</code> is a bit tedious
Maybe there is a way to ignore files that are placed directly in a directory? ðŸ¤”</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/edgarrmondragon">@edgarrmondragon</a> on 2023-01-18 17:42</div>
            <div class="timeline-body"><blockquote>
<p>I&#x27;d say having <code>src</code> directory is quite common</p>
</blockquote>
<p>Oh, I&#x27;m aware of that, I use it all the time ðŸ˜„. It&#x27;s how common it is to have Python files <em>directly</em> nested, e.g. <code>src/main.py</code> that I wonder.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/notypecheck">@notypecheck</a> on 2023-01-18 17:50</div>
            <div class="timeline-body"><blockquote>
<blockquote>
<p>I&#x27;d say having <code>src</code> directory is quite common</p>
</blockquote>
<p>Oh, I&#x27;m aware of that, I use it all the time ðŸ˜„. It&#x27;s how common it is to have Python files <em>directly</em> nested, e.g. <code>src/main.py</code> that I wonder.</p>
</blockquote>
<p>I&#x27;d say it&#x27;s common, if there can be a package, there can be a module, they&#x27;re interchangeable in some sense</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-01-18 17:57</div>
            <div class="timeline-body"><p>But in that case, should there not be an <code>__init__.py</code> in that directory?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-01-18 17:57</div>
            <div class="timeline-body"><p>(Genuinely asking. I&#x27;m not certain.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/notypecheck">@notypecheck</a> on 2023-01-18 18:00</div>
            <div class="timeline-body"><p>In src? <code>src</code> itself is not a package, so, no ðŸ¤”<br>
@charliermarsh Maybe there&#x27;s a way to select direct children in <code>per-file-ignores</code>? This would kind of solve this</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-01-18 18:14</div>
            <div class="timeline-body"><p>Hmm, yeah, right now, this matches <em>any</em> Python file under <code>src</code>, even in nested directories:</p>
<pre><code>[tool.ruff.per-file-ignores]
&quot;src/*.py&quot; = [&quot;INP&quot;]
</code></pre>
<p>It&#x27;s possible to change this internally, such that <code>*</code> doesn&#x27;t match <code>/</code>, in which case, these would mean two different things:</p>
<pre><code>[tool.ruff.per-file-ignores]
&quot;src/*.py&quot; = [&quot;INP&quot;]
&quot;src/**/*.py&quot; = [&quot;INP&quot;]
</code></pre>
<p>(The globbing library supports this as the <code>literal_separator</code> option.)</p>
<p>Let me look at how other tools do this. It would be a breaking change so I&#x27;d like to be confident in it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-01-18 18:17</div>
            <div class="timeline-body"><p>(Flake8 has the same behavior (<code>&quot;src/*.py&quot;</code> matches recursively).)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-01-18 18:27</div>
            <div class="timeline-body"><p>@not-my-profile - Do you have an opinion on enabling <code>literal_separator</code> here? It seems strictly more expressive for users, at the cost of being a breaking change in some cases. (I know you mentioned that setting in <a href="https://github.com/charliermarsh/ruff/issues/1545">charliermarsh/ruff#1545</a>.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-01-18 19:51</div>
            <div class="timeline-body"><p>If we enable <code>literal_separator</code>, then <code>*.py</code> will no longer match &quot;any Python file, anywhere&quot; -- you&#x27;ll have to do <code>**/*.py</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/not-my-profile">@not-my-profile</a> on 2023-01-19 03:34</div>
            <div class="timeline-body"><p>Regarding the problem described by this issue: I think ideally ruff would be smart enough to understand the packaging config in <code>pyproject.toml</code> to correctly determine the purpose of the <code>src</code> directory, e.g by understanding:</p>
<pre><code>[tool.setuptools.packages.find]
where = [&quot;src&quot;]
</code></pre>
<p>(see <a href="https://setuptools.pypa.io/en/latest/userguide/pyproject_config.html#setuptools-specific-configuration">setuptools-specific configuration</a>)</p>
<p>However since there are a bunch of such packaging tools (setuptools, poetry, flit, etc.) accurately supporting all of them would be quite the challenge (I think it&#x27;s unfortunate that such configuration isn&#x27;t better standardized via a PEP).</p>
<p>So yes <code>per-file-ignores</code> does seem like a good way of solving this for now and increasing the expressivity of our glob patterns also seems like a good idea. I want to add that the <a href="https://docs.python.org/3/library/glob.html#glob.glob"><code>glob.glob</code></a> function from the Python standard library also does not have <code>*</code> match <code>/</code>, so following that behavior might actually be what Python developers are more accustomed to.</p>
<p>I do think that such breaking config changes are unfortunate, especially when they can break stuff without you noticing ... perhaps we could introduce something like Rust&#x27;s <code>package.edition</code> .... e.g. <code>tool.ruff.config-version</code> so changes like these would result in a config version bump with ruff still supporting the older version and supporting an automated config upgrade (which would translate all existing globs to the new syntax). Implementing that would however of course take some effort and such &quot;sneaky&quot; config changes (that just change how values are interpreted) are probably quite rare anyway ... although as ruff continues to gain adoption the collective pain caused by such breaking changes would also grow, so perhaps we should consider it?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/notypecheck">@notypecheck</a> on 2023-01-19 05:49</div>
            <div class="timeline-body"><p>I&#x27;d say since glob uses <code>**</code> for recursive matching it&#x27;s a good idea to either make it standard or add an option to choose between the two formats.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-01-19 12:44</div>
            <div class="timeline-body"><p>Yeah using <code>**</code> does seem better to me. But it does feel like a disruptive change if it&#x27;s not coupled with some kind of opt-in. Let me think about how to handle.</p>
<p>It still seems to me that omitting the <code>src</code> directories from this check would solve this problem, since anything is <code>src</code> is assumed to be part of the Python path, effectively.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/not-my-profile">@not-my-profile</a> on 2023-01-19 15:01</div>
            <div class="timeline-body"><p>I&#x27;d rather not have a <code>glob_syntax</code> setting for the sake of simplicity ... I think it makes more sense to have a versioned config format and deprecate the old syntax in favor of the new one ... which could also be done in a backwards-compatible manner (and let us easily drop support for the old syntax at some point in the future).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-01-19 15:08</div>
            <div class="timeline-body"><p>Yes agreed.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-02-04 00:20</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 18:48:30 UTC
    </footer>
</body>
</html>
