<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formatter can delete comments between f-string expr and format spec - astral-sh/ruff #18672</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Formatter can delete comments between f-string expr and format spec</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/issues/18672">#18672</a>
        opened by <a href="https://github.com/MeGaGiGaGon">@MeGaGiGaGon</a>
        on 2025-06-14 00:49
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MeGaGiGaGon">@MeGaGiGaGon</a></div>
            <div class="timeline-body">Summary
<p>As the title says, any comments between the f-string expr and format spec can get deleted by the formatter if it gets collapsed to one line and there is a <code>#</code> in the format spec <a href="https://play.ruff.rs/463c05cd-3cd6-4276-85d0-9a988d1992fc">playground</a></p>
<pre><code>f&quot;{1
# test
:#}&quot;
</code></pre>
<p>Formats to</p>
<pre><code>f&quot;{1:#}&quot;
</code></pre>
Version
<p>playground</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-06-14 05:03</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">formatter</span> added by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-06-14 05:03</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/LaBatata101">@LaBatata101</a> on 2025-06-14 22:57</div>
            <div class="timeline-body"><p>@MichaReiser how should the formatted output look like?</p>
<p>I was prototyping a fix for this issue and got this output:</p>
<pre><code>f&quot;{
    1:# comment
    #
}&quot;
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MeGaGiGaGon">@MeGaGiGaGon</a> on 2025-06-14 23:36</div>
            <div class="timeline-body"><p>@LaBatata101 Unfortunately that&#x27;s invalid code on 3.13.5/3.14, see #18632
It also changes the meaning of the code since in format specs <code>#</code>s are not comments (running on 3.12 to avoid the error)</p>
<pre><code>&gt;&gt;&gt; f&quot;{1:  # comment? nope
... }&quot;
Traceback (most recent call last):
  File &quot;&lt;stdin&gt;&quot;, line 1, in &lt;module&gt;
ValueError: Invalid format specifier &#x27;  # comment? nope&#x27; for object of type &#x27;int&#x27;
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-06-15 06:13</div>
            <div class="timeline-body"><blockquote>
<p>@MichaReiser how should the formatted output look like?</p>
</blockquote>
<p>I don&#x27;t know. There&#x27;s no one-fits-all solution to this. It requires finding heurisitcs that keep the comments close to where they were, keep them in source order and, ideally, preseves if the comment was an own-line or end-of-line comment.</p>
<p>I think in this case, a reasonable formatting would be</p>
<pre><code>f&quot;{1:#}&quot;  # test
</code></pre>
<p>But we need to be careful to only apply it if there&#x27;s no debug expression</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2025-06-16 04:21</div>
            <div class="timeline-body"><p>After playing around with the original code, I found that if the comment is an end-of-line comment for the expression, and if there&#x27;s a format spec present, the comment gets moved <em>after</em> the format spec which makes it not a comment anymore.</p>
<pre><code>f&quot;{1 # comment
:.2f
}&quot;
</code></pre>
<p>The above gets formatted to:</p>
<pre><code>f&quot;{
    1:.2f  # comment
}&quot;
</code></pre>
<p>The core issue might be the same although I&#x27;m not sure.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-06-16 07:51</div>
            <div class="timeline-body"><p>I think I need to fix this to fix the format spec issue because we drop the comment in</p>
<pre><code>x = f&quot;{x  !s
         :&gt;{0
         # comment 21
         }}&quot;
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to <a href="https://github.com/MichaReiser">@MichaReiser</a> by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-06-16 09:06</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-06-17 05:39</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 18:50:04 UTC
    </footer>
</body>
</html>
