<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PLW3301 (nested-min-max) Autofix inappropriately strips nested function call when the nested function call wasn't `max` - astral-sh/ruff #13088</title>
    <link rel="stylesheet" href="../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../index.html">Back to index</a>
    </div>

    <h1>PLW3301 (nested-min-max) Autofix inappropriately strips nested function call when the nested function call wasn't `max`</h1>

    <div class="meta">
        <span class="state state-closed">Closed</span>
        <a href="https://github.com/astral-sh/ruff/issues/13088">#13088</a>
        opened by <a href="https://github.com/AustinStarnes">@AustinStarnes</a>
        on 2024-08-25 01:39
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/AustinStarnes">@AustinStarnes</a> on 2024-08-25 01:39</div>
            <div class="timeline-body"><blockquote>
<p>Keywords used searching for existing issues: <code>&quot;nested-min-max&quot;, &quot;PLW3301&quot;</code></p>
</blockquote>
<blockquote>
<p>Using Ruff VSCode extension <code>v2024.42.0</code></p>
</blockquote>
<blockquote>
<details><summary>Click to expand <code>ruff.toml</code>:</summary>
<pre lang=toml>
line-length = 88
indent-width = 4
<br/>
[lint]
preview = true
select = ["ALL"]
ignore = [
    "ANN204", 
    "S110",
    "DOC201",
    "DOC501", 
    "D107", 
    "D105", 
    "SIM102", 
    "S404", 
    "PLW1514", 
    "ANN002", 
    "ANN003", 
    "PYI051", 
    "FIX002", 
    "ANN401", 
    "DOC402",
    "B008",
    "FAST002",
    "RET504"
]
</pre>
</details>
</blockquote>

<blockquote>
<details><summary>Click to expand VSCode User <code>settings.json</code>:</summary>
<pre lang=json>
 // ...
    "[python]": {
        "editor.formatOnSave": true,
        "editor.formatOnType": true,
        "editor.codeActionsOnSave": {
            "source.fixAll.ruff": "always",
        },
// ...
    "ruff.lint.args": [
        "--config",
        "/home/austin/.vscode/ruff.toml",
        "--ignore", "INP001,TRY003,EM101,EM102,BLE001,G004,N806,TD002,TD003",
        "--target-version", "py311",
        "--unfixable", "F401"
    ],
// ...
</pre>
</blockquote>

<blockquote>
<details><summary>Click to expand the real context in which I encountered the bug, in case I am accused of reporting an issue that isn't encountered in real-world use cases:</summary>
To get the width with which to print and right-justify a token produced by an LLM, I needed the max length of any decoded token string (plus two for bounding <code>â–»</code> and <code>â—…</code> characters that will be printed around the token).
<br/>
But, in cases where none of the tokens generated were at least 3 (two less than the length of the column label "token"), this width with which to print and right-justify would be too narrow. So, I wanted the max of not just the token string length (plus two), but the max of the token string length (plus two) and the length of the label "token".
<pre lang=python>
# ...
    token_string_label = "token"
    max_token_char_length = max(
        max(len(tokenizer.decode(tok)) + 2 for tok in generated_tokens[0]),
        len(token_string_label),
    )
    print(
        f"| {token_string_label.rjust(max_token_char_length)} "
        f"| {'token id':>8s} | {'log prob.':>9} | {'prob.':>6}",
    )
    for tok, score in zip(generated_tokens[0], transition_scores[0], strict=False):
        print(
            f"| {('â–»' + tokenizer.decode(tok) + 'â—…').rjust(max_token_char_length)} "
            f"| {tok:8d} | {score.item():9.3f} | {torch.exp(score).item():.2%}",
        )
# ...
</pre>
</blockquote>

<p>Minimal example:</p>
<pre><code class="language-py">sentence = &quot;Hello world, ruff is cool!&quot;

# The expression triggering rule PLW3301 (nested-min-max):
max_word_len = max(
    max(len(word) for word in sentence.split(&quot; &quot;)),
    len(&quot;Done!&quot;),
)
# &gt;&gt;&gt; max_word_len
# 6

# What the autofix expression produced:
max_word_len = max(*(len(word) for word in sentence.split(&quot; &quot;)), *&quot;Done!&quot;)
# &gt;&gt;&gt; max_word_len = max(*(len(word) for word in sentence.split(&quot; &quot;)), *&quot;Done!&quot;)
# Traceback (most recent call last):
#   File &quot;&lt;stdin&gt;&quot;, line 1, in &lt;module&gt;
# TypeError: '&gt;' not supported between instances of 'str' and 'int'

# If nested-min-max must be autofixed, I would imagine the result should be:
max_word_len = max(*(len(word) for word in sentence.split(&quot; &quot;)), len(&quot;Done!&quot;))
# i.e., if an argument to the outer max() is not the result of a call to max(), then it
# should be left as is

</code></pre>
<p>I believe issue #5066 also demonstrated the bug, but the issue was closed because the reporter's usage of max wasn't valid either. The issue probably should not have been closed.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "PLW3301 (nested-min-max) Autofix inappropriately strips function call for outer max argument" to "PLW3301 (nested-min-max) Autofix inappropriately strips nested function call when the nested function call wasn't `max`" by @AustinStarnes on 2024-08-25 01:42</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/13089.html">astral-sh/ruff#13089</a> on 2024-08-25 05:12</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @AlexWaygood on 2024-08-25 09:16</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">fixes</span> added by @AlexWaygood on 2024-08-25 09:16</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @dhruvmanila on 2024-08-26 04:31</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @dhruvmanila on 2024-08-26 04:31</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AustinStarnes">@AustinStarnes</a> on 2024-08-26 12:56</div>
            <div class="timeline-body"><p>ruff dev team fast like ruff ðŸš€ cheers!</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:28:13 UTC
    </footer>
</body>
</html>
