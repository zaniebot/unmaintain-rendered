<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UP036 auto-fixer breaks code at runtime after #5766 - astral-sh/ruff #6189</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>UP036 auto-fixer breaks code at runtime after #5766</h1>

    <div class="meta">
        <span class="state state-closed">Closed</span>
        <a href="https://github.com/astral-sh/ruff/issues/6189">#6189</a>
        opened by <a href="https://github.com/mrcljx">@mrcljx</a>
        on 2023-07-31 09:41
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/mrcljx">@mrcljx</a> on 2023-07-31 09:41</div>
            <div class="timeline-body"><p>After #5766 the auto-fixer for UP036 has broken some code for us:</p>
<pre><code class="language-diff">from typing import Any

import cachetools

class MyClass:
    def __init__(self) -&gt; None:
        self._cache: &quot;cachetools.LRUCache[Any, Any]&quot; = cachetools.LRUCache(maxsize=100)
</code></pre>
<pre><code>ruff --isolated --select UP --fix ruff_up037.py
</code></pre>
<blockquote>
<p>ruff_up037.py:7:22: UP037 [*] Remove quotes from type annotation</p>
</blockquote>
<p>The auto-fixer strips the quotes. However this is semantically not valid, as <code>LRUCache</code> is not <code>Generic</code> at runtime, only for the <code>pyi</code> files.</p>
<pre><code>$ ruff --version
ruff 0.0.280
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @charliermarsh on 2023-07-31 13:18</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/clement-escolano">@clement-escolano</a> on 2023-08-01 12:03</div>
            <div class="timeline-body"><p>I would like to add another example of the rule breaking code at runtime:</p>
<pre><code class="language-py">from typing import TYPE_CHECKING

if TYPE_CHECKING:
    from dependency import MyClass

def my_func():
    result: list[&quot;MyClass&quot;] = []
    return result
</code></pre>
<p>The quotes around <code>MyClass</code> are removed which breaks at run time.</p>
<p>If this should be in a separate issue, please tell me and I will open one</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-08-01 12:45</div>
            <div class="timeline-body"><p>@clement-escolano -- Hmm, I'm unable to reproduce. This, for example, runs without error for me:</p>
<pre><code class="language-python">from typing import TYPE_CHECKING

if TYPE_CHECKING:
    from dependency import MyClass

def my_func():
    result: list[MyClass] = []
    return result

my_func()
</code></pre>
<p>Running <code>python foo.py</code> completes without error.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/6237.html">astral-sh/ruff#6237</a> on 2023-08-01 12:46</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/clement-escolano">@clement-escolano</a> on 2023-08-01 12:47</div>
            <div class="timeline-body"><p>@charliermarsh
The issue is that <code>dependency</code> is not installed in our production environment (in our project, this is <code>django_stubs_ext</code> which is only used in development for typing). If this is out of scope of this rule, I understand :-)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-08-01 12:50</div>
            <div class="timeline-body"><p>I don't think the dependency has to be installed in order for the above to work, I don't have a dependency called <code>dependency</code> locally :) Python doesn't evaluate unquoted annotated assignments within function bodies. But perhaps there's another reason that it's failing for you? Or is it just that it's showing up as an error in your editor?</p>
<p>The same is true of the originating comment @mrcljx. This runs fine for me:</p>
<pre><code class="language-python">from typing import Any

import cachetools

class MyClass:
    def __init__(self) -&gt; None:
        self._cache: cachetools.LRUCache[Any, Any] = cachetools.LRUCache(maxsize=100)

MyClass()
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2023-08-01 13:03</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/mrcljx">@mrcljx</a> on 2023-08-01 13:05</div>
            <div class="timeline-body"><p>@charliermarsh This indeed seems to have been an IDE bug. Very sorry for bothering you with this report, thanks for Ruff!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-08-01 13:07</div>
            <div class="timeline-body"><p>No worries, I went ahead and reverted any way, it seems like it's going to cause some annoyance for folks.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2023-08-01 15:02</div>
            <div class="timeline-body"><p>@mrcljx Which IDE? Did you open an issue there?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/mrcljx">@mrcljx</a> on 2023-08-01 17:54</div>
            <div class="timeline-body"><img width="639" alt="CleanShot 2023-08-01 at 19 53 31@2x" src="https://github.com/astral-sh/ruff/assets/56807/b61c38e0-3454-4e02-81d5-1f754610a0fc">

<p>PyCharm. That said, it also had that warning earlier (but it became more visually pronounced in ^):</p>
<img width="364" alt="CleanShot 2023-08-01 at 19 54 10@2x" src="https://github.com/astral-sh/ruff/assets/56807/e57602ab-eb1e-4d4e-b862-604a718bdaa7">

</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:34:50 UTC
    </footer>
</body>
</html>
