<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[preview] FURB118 can be unsafe for methods - astral-sh/ruff #13829</title>
    <link rel="stylesheet" href="../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../index.html">Back to index</a>
    </div>

    <h1>[preview] FURB118 can be unsafe for methods</h1>

    <div class="meta">
        <span class="state state-closed">Closed</span>
        <a href="https://github.com/astral-sh/ruff/issues/13829">#13829</a>
        opened by <a href="https://github.com/henryiii">@henryiii</a>
        on 2024-10-20 06:05
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/henryiii">@henryiii</a> on 2024-10-20 06:05</div>
            <div class="timeline-body"><p>If you run with <code>preview</code> set, then the FURB118 check makes an unsafe replacement, you can see me rolling back the change https://github.com/wntrblm/nox/pull/870/commits/a91dbe2356a42bf8d2f03021ccd3b19a903484c8 to make the tests pass, the difference in behavior can be shown with this MWE:</p>
<pre><code class="language-pycon">&gt;&gt;&gt; class A:
...     pass
...  
&gt;&gt;&gt; A.__eq__ = lambda a, b: a == b
&gt;&gt;&gt; A() == A()
Traceback (most recent call last):
  File &quot;&lt;python-input-5&gt;&quot;, line 1, in &lt;module&gt;
    A() == A()
  File &quot;&lt;python-input-4&gt;&quot;, line 1, in &lt;lambda&gt;
    A.__eq__ = lambda a, b: a == b
                            ^^^^^^
  File &quot;&lt;python-input-4&gt;&quot;, line 1, in &lt;lambda&gt;
    A.__eq__ = lambda a, b: a == b
                            ^^^^^^
  File &quot;&lt;python-input-4&gt;&quot;, line 1, in &lt;lambda&gt;
    A.__eq__ = lambda a, b: a == b
                            ^^^^^^
  [Previous line repeated 988 more times]
RecursionError: maximum recursion depth exceeded
&gt;&gt;&gt; import operator
&gt;&gt;&gt; A.__eq__ = operator.eq
&gt;&gt;&gt; A() == A()
Traceback (most recent call last):
  File &quot;&lt;python-input-8&gt;&quot;, line 1, in &lt;module&gt;
    A() == A()
TypeError: eq expected 2 arguments, got 1
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">preview</span> added by @AlexWaygood on 2024-10-20 13:32</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-10-20 13:55</div>
            <div class="timeline-body"><p>Thanks for opening the issue. FURB118 has been <a href="https://github.com/astral-sh/ruff/issues?q=is%3Aissue+furb118">something of a problematic rule</a> for us in terms of the number of issues we've had regarding it :/</p>
<p>Here's a slightly smaller repro for the issue here, that makes it slightly clearer how the suggested change can break working code:</p>
<pre><code class="language-pycon">&gt;&gt;&gt; import operator
&gt;&gt;&gt; class Spam:
...     foo = lambda self, other: self == other
... 
&gt;&gt;&gt; class Eggs:
...     foo = operator.eq
... 
&gt;&gt;&gt; Spam().foo(Spam())
False
&gt;&gt;&gt; Eggs().foo(Eggs())
Traceback (most recent call last):
  File &quot;&lt;stdin&gt;&quot;, line 1, in &lt;module&gt;
TypeError: eq expected 2 arguments, got 1
</code></pre>
<p>It seems like the <code>operator</code> functions are always unsuitable for use as method definitions (whether monkeypatched or otherwise), because they don't have <code>__get__</code> methods in the same way that user-defined functions do. When you access the <code>foo</code> method on an instance of <code>Spam</code> in my REPL example, you don't actually get the <code>foo</code> function; behind the scenes, <code>foo.__get__</code> is called and you get back a <code>MethodType</code> instance; this is why you don't need to pass in <code>self</code> explicitly in most method calls. But when you access the <code>foo</code> method on an instance of <code>Eggs</code>, you get back the original <code>operator.eq</code> function instead of a <code>MethodType</code> instance, because <code>operator.eq</code> has no <code>__get__</code> method to call.</p>
<p>The next question is what we can do about this. I think there are a few things we can do:</p>
<ul>
<li>Document more clearly that this rule's autofix is always unsafe. It <em>is</em> always categorised as an unsafe fix (you have to opt into it with <code>--unsafe-fixes</code>), but our <a href="https://docs.astral.sh/ruff/rules/reimplemented-operator/#fix-safety">docs</a> currently emphasise that it's &quot;usually safe&quot;. While I think it <em>is</em> true that the fix is <em>usually</em> safe, we don't actually explicitly state anywhere in our docs currently that it's always categorised as an unsafe fix; we probably should.</li>
<li>We should list the missing <code>__get__</code> method on the <code>operator</code> functions as another reason <em>why</em> the fix is unsafe in our docs</li>
<li>We should avoid emitting the diagnostic at all for direct assignments in class bodies, like in my REPL example above</li>
</ul>
<p>What I think we <em>can't</em> do, unfortunately, is avoid emitting the diagnostic in dynamic cases where you're monkey-patching a method onto a class, like the original situation you ran into in your <code>nox</code> PR. Possibly we <em>might</em> be able to do that with more type inference, but for now I think it's well beyond our capabilities to reliably detect whether the thing you're monkeypatching the function onto is a class object or not.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @AlexWaygood on 2024-10-20 13:55</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/henryiii">@henryiii</a> on 2024-10-21 14:29</div>
            <div class="timeline-body"><p>I was under the impression it was a &quot;safe&quot; fix, but I reran it and it does only show up as an unsafe fix. (Aside: it would be nice if unsafe fixes were also indicated in the default printout, like <code>[**]</code> or something).</p>
<p>All three improvements sound good. Probably no rush as it's not out of preview yet.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-10-21 14:38</div>
            <div class="timeline-body"><blockquote>
<p>(Aside: it would be nice if unsafe fixes were also indicated in the default printout, like <code>[**]</code> or something).</p>
</blockquote>
<p>This might possibly be addressed by https://github.com/astral-sh/ruff/issues/7352, which is definitely something we want to do at some point!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @AlexWaygood by @AlexWaygood on 2024-11-21 17:29</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/14639.html">astral-sh/ruff#14639</a> on 2024-11-27 17:52</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @AlexWaygood on 2024-11-28 12:58</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:28:14 UTC
    </footer>
</body>
</html>
