<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Respect `PYTHONSAFEPATH` if set - astral-sh/ruff #11928</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Respect `PYTHONSAFEPATH` if set</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/ruff/issues/11928">#11928</a>
        opened by <a href="https://github.com/thejcannon">@thejcannon</a>
        on 2024-06-18 16:00
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/thejcannon">@thejcannon</a> on 2024-06-18 16:00</div>
            <div class="timeline-body"><p>Docs links:</p>
<ul>
<li>https://docs.python.org/3/using/cmdline.html#envvar-PYTHONSAFEPATH</li>
<li>https://docs.python.org/3/using/cmdline.html#cmdoption-P</li>
</ul>
<blockquote>
<p>Don‚Äôt prepend a potentially unsafe path to <a href="https://docs.python.org/3/library/sys.html#sys.path">sys.path</a>:
<code>python -m module</code> command line: Don‚Äôt prepend the current working directory.
<code>python script.py</code> command line: Don‚Äôt prepend the script‚Äôs directory. If it‚Äôs a symbolic link, resolve symbolic links.
<code>python -c code</code> and <code>python</code> (REPL) command lines: Don‚Äôt prepend an empty string, which means the current working directory.</p>
</blockquote>
<p>Reproducer with <code>ruff</code> (note <code>foo</code> is an implicit namespace package in vanilla Python-speak, but totally not something we expected to import)</p>
<pre><code class="language-console">$ mkdir foo
$ cat &lt;&lt;EOF &gt; example.py
import pathlib

import pytest

import anthem  # other 1p
import foo

[pathlib, pytest, foo,, anthem]

EOF
$ export PYTHONSAFEPATH=1
$ ruff check --fix-only example.py
</code></pre>
<p>keeps <code>foo</code> with 1p.</p>
<p>but:</p>
<pre><code class="language-console">$ python -c 'import foo'
Traceback (most recent call last):
  File &quot;&lt;string&gt;&quot;, line 1, in &lt;module&gt;
ModuleNotFoundError: No module named 'foo'
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-06-18 16:09</div>
            <div class="timeline-body"><p>Hm. Is this always going to be set for all users of Ruff with your code? Otherwise it seems like we could flip-flop behaviors here depending on the local environment which seems less than ideal.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/thejcannon">@thejcannon</a> on 2024-06-18 16:31</div>
            <div class="timeline-body"><p>Yeah, we would set it as part of machine bringup</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">help wanted</span> added by @zanieb on 2024-06-18 16:35</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">linter</span> added by @zanieb on 2024-06-18 16:35</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">help wanted</span> removed by @zanieb on 2024-06-18 16:44</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">needs-design</span> added by @zanieb on 2024-06-18 16:44</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-06-18 16:44</div>
            <div class="timeline-body"><p>After some internal discussion, we need to decide how best to support this use-case. We might want to use a dedicated setting instead of reading runtime Python variables.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/thejcannon">@thejcannon</a> on 2024-06-18 19:58</div>
            <div class="timeline-body"><p>(Not that you needed me to be, but) I'm cool with that as well üëç</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-06-18 20:59</div>
            <div class="timeline-body"><p>I think that's the most reasonable option and addresses my concern. Not entirely sure this is doable with our current module resolution handling, I'd need to look at it to refresh my understanding. If someone is interested in doing a proof of concept pull request, I'd review.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/thejcannon">@thejcannon</a> on 2024-06-19 12:35</div>
            <div class="timeline-body"><p>The issue I'm trying to solve is that sometimes folks have empty directories lying around and they get confused why their editor is reformatting in a way that CI then complains about and they don't know how to fix it (admittedly implicit namespace packages are not intuitive)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-06-23 15:10</div>
            <div class="timeline-body"><p>Sort of hacky but we could check if <code>foo</code> is non-empty for this purpose, perhaps?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/thejcannon">@thejcannon</a> on 2024-06-23 21:17</div>
            <div class="timeline-body"><p>I honestly wonder if this might be made more general with a &quot;never assume I use implicit namespace packages&quot; config?</p>
<p>That's really what we want (but Python doesn't expose that, hence the env var about &quot;safe&quot;ty)</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 01:30:13 UTC
    </footer>
</body>
</html>
