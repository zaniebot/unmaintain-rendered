<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[Infinite loop] Package-relative import issue with module `__all__` when using F401 and F822 with the preview option - astral-sh/ruff #12897</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[Infinite loop] Package-relative import issue with module <code>__all__</code> when using F401 and F822 with the preview option</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/issues/12897">#12897</a>
        opened by <a href="https://github.com/AA-Turner">@AA-Turner</a>
        on 2024-08-14 21:24
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AA-Turner">@AA-Turner</a></div>
            <div class="timeline-body"><p>This took a while to minimise, hopefully it is indicative of a real issue!</p>
<p>There's some setup involved, so you can use the following <code>reproducer.py</code> in an empty directory.</p>
<pre><code class="language-python"># reproducer.py
from pathlib import Path


def write(path, text):
    path.write_text(text, encoding=&quot;utf-8&quot;)


BUG = &quot;&quot;&quot;\
__all__ = ('Spam',)


class Spam:
    def __init__(self) -&gt; None:
        from bug.lobster_thermidor import Ham
&quot;&quot;&quot;

MOD_INIT = Path('bug/__init__.py')
MOD_LOBSTER = Path('bug/lobster_thermidor.py')
MOD_INIT.parent.mkdir(exist_ok=True)
BUG_FILE = Path('bug.py')
write(MOD_INIT, BUG)
write(BUG_FILE, BUG)
write(MOD_LOBSTER, 'Ham = 1\n')
</code></pre>
<p>This is the same as the following structure:</p>
<pre><code>bug.py
bug/
  -&gt; __init__.py
  -&gt; lobster_thermidor.py
</code></pre>
<p>In both <code>bug.py</code> and <code>bug/__init__.py</code> we have:</p>
<pre><code class="language-python">__all__ = ('Spam',)


class Spam:
    def __init__(self) -&gt; None:
        from bug.lobster_thermidor import Ham
</code></pre>
<p>In <code>lobster_thermidor.py</code> we have:</p>
<pre><code class="language-python">Ham = 1
</code></pre>
<p>The issue is then straightforwards to reproduce:</p>
<pre><code class="language-ps1con">PS&gt; ruff -V
ruff 0.5.7
PS&gt; ruff check --isolated --select F401,F822 --preview --fix bug.py
Found 1 error (1 fixed, 0 remaining).
PS&gt; ruff check --isolated --select F401,F822 --preview --fix bug/

error: Failed to converge after 100 iterations.

This indicates a bug in Ruff. If you could open an issue at:

    https://github.com/astral-sh/ruff/issues/new?title=%5BInfinite%20loop%5D

...quoting the contents of `bug\__init__.py`, the rule codes F401, F822, along with the `pyproject.toml` settings and executed command, we'd be very appreciative!

bug\__init__.py:1:20: F822 Undefined name `Ham` in `__all__`
  |
1 | __all__ = ('Spam', 'Ham', 'Ham', 'Ham', 'Ham', 'Ham', 'Ham', 'Ham', 'Ham', 'Ham', 'Ham', 'Ham', 'Ham', 'Ham', 'Ham', 'Ham', 'Ham', 'Ham', 'Ham', 'Ham', 'Ham', 'Ham', 'Ham', 'Ham', 'Ham', 'Ham', 'Ham', 'Ham', 'Ham', 'Ham', 'Ham
', 'Ham', 'Ham', 'Ham', 'Ham', 'Ham', 'Ham', 'Ham', 'Ham', 'Ham', 'Ham', 'Ham', 'Ham', 'Ham', 'Ham', 'Ham', 'Ham', 'Ham', 'Ham', 'Ham', 'Ham', 'Ham', 'Ham', 'Ham', 'Ham', 'Ham', 'Ham', 'Ham', 'Ham', 'Ham', 'Ham', 'Ham', 'Ham', 'Ha
m', 'Ham', 'Ham', 'Ham', 'Ham', 'Ham', 'Ham', 'Ham', 'Ham', 'Ham', 'Ham', 'Ham', 'Ham', 'Ham', 'Ham', 'Ham', 'Ham', 'Ham', 'Ham', 'Ham', 'Ham', 'Ham', 'Ham', 'Ham', 'Ham', 'Ham', 'Ham', 'Ham', 'Ham', 'Ham', 'Ham', 'Ham', 'Ham', 'H
am', 'Ham', 'Ham', 'Ham', 'Ham',)
  |                    ^^^^^ F822
  |
[ ... 1023(!!!) lines of output elided ... ]

Found 201 errors (100 fixed, 101 remaining).
[*] 1 fixable with the `--fix` option.
</code></pre>
<p>This only reproduces with the <code>--preview</code> option. Clearly there is a bad recursion or loop bug somewhere. If it is an topic for discussion though, I don't think an auto-fix should add an import to <code>__all__</code> -- the correct solution (as observed in <code>bug.py</code>) is to remove the import.</p>
<p>Thanks, and please let me know if any further information is needed,
Adam</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "[Infinite loop]" to "[Infinite loop] Package-relative import issue with module ``_all__`` when using F401 and F822 with the preview option" by @AA-Turner on 2024-08-14 21:26</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AA-Turner">@AA-Turner</a> on 2024-08-14 21:26</div>
            <div class="timeline-body"><p>Sorry, I forgot to set a title.</p>
<p>A</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "[Infinite loop] Package-relative import issue with module ``_all__`` when using F401 and F822 with the preview option" to "[Infinite loop] Package-relative import issue with module `__all__` when using F401 and F822 with the preview option" by @AlexWaygood on 2024-08-14 22:05</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @AlexWaygood by @AlexWaygood on 2024-08-15 07:46</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @MichaReiser on 2024-08-19 13:28</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntBre">@ntBre</a> on 2025-01-15 19:02</div>
            <div class="timeline-body"><p>I can reproduce the loop without F822 on ruff 0.8.2 and on the current main branch:</p>
<pre><code class="language-shell">$ mkdir -p bug
$ python reproducer.py
$ ~/astral/ruff/target/debug/ruff check --no-cache --isolated --select F401 --preview --fix bug/

# output
debug error: Failed to converge after 100 iterations in `bug/__init__.py` with rule codes F401:---
__all__ = ('Spam', 'Ham', 'Ham', 'Ham', 'Ham', 'Ham', 'Ham', 'Ham', 'Ham', 'Ham', 'Ham', 'Ham', 'Ham', 'Ham', 'Ham', 'Ham', 'Ham', 'Ham', 'Ham', 'Ham', 'Ham', 'Ham', 'Ham', 'Ham', 'Ham', 'Ham', 'Ham', 'Ham', 'Ham', 'Ham', 'Ham', 'Ham', 'Ham', 'Ham', 'Ham', 'Ham', 'Ham', 'Ham', 'Ham', 'Ham', 'Ham', 'Ham', 'Ham', 'Ham', 'Ham', 'Ham', 'Ham', 'Ham', 'Ham', 'Ham', 'Ham', 'Ham', 'Ham', 'Ham', 'Ham', 'Ham', 'Ham', 'Ham', 'Ham', 'Ham', 'Ham', 'Ham', 'Ham', 'Ham', 'Ham', 'Ham', 'Ham', 'Ham', 'Ham', 'Ham', 'Ham', 'Ham', 'Ham', 'Ham', 'Ham', 'Ham', 'Ham', 'Ham', 'Ham', 'Ham', 'Ham', 'Ham', 'Ham', 'Ham', 'Ham', 'Ham', 'Ham', 'Ham', 'Ham', 'Ham', 'Ham', 'Ham', 'Ham', 'Ham', 'Ham', 'Ham', 'Ham', 'Ham', 'Ham', 'Ham', 'Ham',)


class Spam:
    def __init__(self) -&gt; None:
        from bug.lobster_thermidor import Ham

---
bug/__init__.py:6:43: F401 `bug.lobster_thermidor.Ham` imported but unused; consider removing, adding to `__all__`, or using a redundant alias
  |
4 | class Spam:
5 |     def __init__(self) -&gt; None:
6 |         from bug.lobster_thermidor import Ham
  |                                           ^^^ F401
  |
  = help: Add unused import `Ham` to __all__

Found 101 errors (100 fixed, 1 remaining).
</code></pre>
<p>F822 makes the message much, much longer, but I think the actual problem is caused by F401.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @ntBre by @ntBre on 2025-01-15 19:02</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Unassigned @AlexWaygood by @AlexWaygood on 2025-01-15 19:07</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @ntBre on 2025-01-16 15:43</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AA-Turner">@AA-Turner</a> on 2025-01-16 16:12</div>
            <div class="timeline-body"><p>Thank you @ntBre!</p>
<p>A</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-01-16 16:14</div>
            <div class="timeline-body"><p>Thanks @AA-Turner for reporting, and sorry it took us a little while to fix this one!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AA-Turner">@AA-Turner</a> on 2025-01-16 16:15</div>
            <div class="timeline-body"><p>I have issues that have been open for over a decade ... five months is nothing!</p>
<p>A</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 16:50:52 UTC
    </footer>
</body>
</html>
