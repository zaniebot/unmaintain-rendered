<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>docstring code formatter: figure out how to handle line width - astral-sh/ruff #8855</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>docstring code formatter: figure out how to handle line width</h1>

    <div class="meta">
        <span class="state state-closed">Closed</span>
        <a href="https://github.com/astral-sh/ruff/issues/8855">#8855</a>
        opened by <a href="https://github.com/BurntSushi">@BurntSushi</a>
        on 2023-11-27 16:01
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2023-11-27 16:01</div>
            <div class="timeline-body"><p>In #8811, the formatter grew the ability to format doctest code snippets in docstrings. In this initial implementation, it handles line width limits by resetting the column of the code snippet to the first column. It is <a href="https://github.com/astral-sh/ruff/pull/8811#discussion_r1401165926">unclear whether this is the right behavior</a>. This means that individual lines inside the docstring can exceed <a href="https://github.com/BurntSushi/polars/actions/runs/7006619426/job/19058868021?pr=1">line length limits imposed by the linter</a>, and it also just generally means that it is difficult to maintain a line length limit in the source code.</p>
<p>The benefit of the current behavior is that it prioritizes the presentation of the code snippet itself. So that when a documentation generator renders a code snippet, its presented line length will be correct with respect to the project's configured line limits.</p>
<p>The downside of the current behavior is that the source code itself can have long lines. (This would be quite annoying to me personally, perhaps enough to eclipse the benefit of the presentation having a correct line length.)</p>
<p>Here are a few options we can pursue:</p>
<ol>
<li>We could leave the existing behavior as-is and provide no configuration.</li>
<li>We could add a new option, <code>docstring-code-line-width</code>, that lets one configure the line width of code snippets independent of the line width of the surrounding code.</li>
<li>We could add a new option, <code>docstring-code-preserve-line-width</code> that dynamically chooses the line width of a reformatted code snippet based on the column at which in starts within the source code and the globally configured line width.</li>
<li>Do (2) and (3).</li>
</ol>
<p>Maybe there are other choices. Speaking for myself personally, if I were to use code snippet formatting, I would want option (3) because it preserves the line length limit correctly regardless of the indentation of the docstring. I'm not sure I would add option (2) at all.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">docstring</span> added by @BurntSushi on 2023-11-27 16:01</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">formatter</span> added by @BurntSushi on 2023-11-27 16:01</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">needs-decision</span> added by @BurntSushi on 2023-11-27 16:01</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/8811.html">astral-sh/ruff#8811</a> on 2023-11-27 16:01</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ofek">@ofek</a> on 2023-11-27 17:04</div>
            <div class="timeline-body"><p>I would also very much prefer option 3</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/7146.html">astral-sh/ruff#7146</a> on 2023-11-27 17:05</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-11-27 23:21</div>
            <div class="timeline-body"><p>Do you know what rustfmt's experimental implementation of code-snipped formatting in the documentation does?</p>
<p>Regarding optimising for the line width when presenting the example. I'm unfamiliar with Python documentation but assuming that markdown is supported, isn't it possible that examples could be nested inside lists or are part of other nested structures? In which case we couldn't determine the rendered width (although assuming that most code blocks aren't nested is probably true for the vast majority).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-11-28 06:22</div>
            <div class="timeline-body"><p>I don't know that I have a strong opinion on what the &quot;right behavior&quot; is, but I <em>would</em> like to avoid adding an additional setting for this and instead make an opinionated decision between the two strategies -- which leads me to think we should just ship with what we have and react to user feedback if it comes in.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/stinodego">@stinodego</a> on 2023-11-28 08:33</div>
            <div class="timeline-body"><p>There is definitely something to be said for the behavior you have implemented now. It will lead to the best experience for users browsing the docs when they have been built and published.</p>
<p>However, from a developer standpoint, I will probably end up having to add <code># noqa: W505</code> to about 25%+ of our docstrings. That's a pretty bad developer experience and not really feasible for our project. I don't want to disable the lint entirely as docstrings are the number 1 thing contributors are getting wrong <em>(which is also why this formatter will make a valuable addition to ruff's capabilities!)</em>.</p>
<p>I would like to at least have to option to enforce the resulting line length (in the file as opposed to the isolated example) - so that would be your option 3. This should probably be the default (or maybe an only option as per Charlie's comment)- it would also help users transition from other docstring formatters such as <code>blackdoc</code> to <code>ruff</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ofek">@ofek</a> on 2023-11-28 14:54</div>
            <div class="timeline-body"><p>Another thing we need to be cognizant of is that rendered documentation almost always has a restricted horizontal viewport. For example, I prefer my line width to be 120 however I know that no documentation framework will do that. Here are some examples on my very large monitor:</p>
<ul>
<li>Material for MkDocs: ~80 characters https://squidfunk.github.io/mkdocs-material/reference/math/#using-inline-block-syntax</li>
<li>Docusaurus: ~110 characters https://docusaurus.io/docs/advanced/ssg#browseronly</li>
<li>Sphinx (what CPython docs use): ~80 characters https://www.sphinx-doc.org/en/master/tutorial/describing-code.html#documenting-python-objects</li>
</ul>
<p>After writing this out actually I changed my view a little bit and now I am quite confident that 3 should be the default behavior and 2 should be option so users can build for their particular theme.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2023-11-28 15:49</div>
            <div class="timeline-body"><blockquote>
<p>Do you know what rustfmt's experimental implementation of code-snipped formatting in the documentation does?</p>
</blockquote>
<p>Good question. So rustfmt has two options here. <a href="https://rust-lang.github.io/rustfmt/?version=v1.6.0&amp;search=#format_code_in_doc_comments"><code>format_code_in_doc_comments</code></a> to enable code example formatting, and <a href="https://rust-lang.github.io/rustfmt/?version=v1.6.0&amp;search=#doc_comment_code_block_width"><code>doc_comment_code_block_width</code></a> to set a line width for it.</p>
<p>In terms of its behavior, it seems like it operates the same as what we have today but also provides option (2). In particular, I went through the issues on the topic:</p>
<ul>
<li>https://github.com/rust-lang/rustfmt/issues/3348</li>
<li>https://github.com/rust-lang/rustfmt/issues/5359</li>
<li>https://github.com/rust-lang/rustfmt/issues/5345</li>
</ul>
<p>And the general sense that I got was that folks really wanted to be able to make code examples have a shorter line width than the surrounding code because the rendering <em>usually</em> uses less horizontal space overall. This drives folks to use a bit more wrapping than they otherwise would.</p>
<p>It looks like <code>rustfmt</code> does not offer option (3), which is what I would want personally. :P</p>
<p>@charliermarsh It looks to me like it would be somewhat difficult to do this without introducing another option, although I'm not opposed to shipping the status quo and seeing what kind of feedback we get. The status quo has no option, but that can lead to longer lines than one would like in the rendered docs <em>and</em> tripping linter warnings for long lines, forcing folks to either disable the lint or selectively ignore it (bummer). Doing (3) also lets us avoid adding an option, but it could result in much more tightly wrapped documentation examples than folks would like.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-11-29 03:18</div>
            <div class="timeline-body"><p>One challenge I see with a new <code>width</code> setting that sets the width for docstring examples is that it doesn't solve the potential conflict with E501, even when <code>indent-width</code> &gt; <code>docstring-indent-width</code> because whether the example fits also depends on the indent level.</p>
<p>The downside I see with option 3 is that the width for examples will be different depending on the indent level at which they were defined. This may lead to inconsistency when viewing the documentation. However, it seems to be the only option that plays nicely with E501.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2023-11-29 04:24</div>
            <div class="timeline-body"><p>If we're particularly concerned about conflicts with E501 or W505, should we consider adding a setting or exception for docstring code to the <em>linter</em>  instead of complicating the formatter?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2023-11-29 04:28</div>
            <div class="timeline-body"><p>I think in my ideal world, the code would by dynamically formatted to fit within my current line width depending on the indent of the block. While reading in an editor, the width would always be consistent. Later,  documentation tooling would format the code blocks again at the desired width for display e.g. on an API reference website.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ofek">@ofek</a> on 2023-11-29 05:05</div>
            <div class="timeline-body"><blockquote>
<p>Later, documentation tooling would format the code blocks again</p>
</blockquote>
<p>I don't know of any docs framework that does this. As far as I know they leave it as-is and if the line is too long the browser will automatically add a horizontal scrollbar.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-11-29 05:17</div>
            <div class="timeline-body"><p>It sounds like most folks want to make (3) our default behavior (so, use the same line width as the rest of the formatter, and take into account the docstring indentation), with a setting (2) to let you set a line width for docstring code that would ignore the indentation depth of the docstring itself. I have no objection to that, it seems reasonable to me.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-11-29 05:18</div>
            <div class="timeline-body"><p>Although, is anyone going to use this setting described in (2)? It doesn't seem like anyone in this thread would actually use it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ofek">@ofek</a> on 2023-11-29 05:46</div>
            <div class="timeline-body"><p>As I mentioned in my comment above, I would definitely use it because I prefer my line length to be 120 and my preferred documentation renders maximum ~80 characters and therefore I would set (2) to 80.</p>
<p>edit: essentially I want to have readers never encounter a horizontal scrollbar in documentation</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2023-11-29 06:16</div>
            <div class="timeline-body"><blockquote>
<p>I don't know of any docs framework that does this.</p>
</blockquote>
<p>We'll have to make one ;) although... this can be solved without a new tool if there's an option</p>
<blockquote>
<p>Although, is anyone going to use this setting described in (2)?</p>
</blockquote>
<p>You could use this option and reformat the project when generating the documentation without committing the change.</p>
<p>It'd be nice to hear some more feedback requesting such a setting though.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ofek">@ofek</a> on 2023-11-29 06:22</div>
            <div class="timeline-body"><p>To be clear, you're saying that when we build docs the recommendation is to have a separate config file just for that option and format the code in the CI using that config file, and then run the documentation generator?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone "Formatter: Stable" by @BurntSushi on 2023-11-29 13:20</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/pawamoy">@pawamoy</a> on 2023-11-29 14:20</div>
            <div class="timeline-body"><p>Most of the time, I wouldn't mind that code examples in docstrings are formatted using the global line length, i.e. regardless of their base indentation, because docstrings are usually indented by 0, 1, or 2 levels, not more. 8 characters less is not a huge difference in size, at least when using a large line length such as 120. But if the line length is configured to 80, then it can become quite small yes, and pose readability and rendering issues. This would especially be problematic for (draft) PEP 727 docstrings (parameter docstrings using <code>Annotated[..., Doc(...)]</code>, since their base indentation level can go up to 4 or more:</p>
<pre><code class="language-python">class Yo:
    def yo(
        param: Annotated[
            str,
            Doc(
                &quot;&quot;&quot;
                Here are code snippets.

                - First:
                
                    ```python
                    print(&quot;hello&quot;)
                    ```
                &quot;&quot;&quot;,
            ),
        ],
    ):
        ...
</code></pre>
<p>So in the end, I'd be more in favor of defaulting to a dynamic line length for code snippets in docstrings (configured line length + base indentation level), <em>as well as</em> allowing configuration of the line length for code snippets in docstrings, because as @ofek mentioned I think, while 120 is acceptable in the editor, SSGs will typically have a smaller rendering width like 80. Besides, configuring a smaller width for code examples in docstrings might help reducing false positive warnings on line length. For example:</p>
<ul>
<li>global line length is 120</li>
<li>code examples start with a 20 characters offset maximum</li>
<li>I configure docstrings/markdown code examples line length to 100 (or less)</li>
<li>all lines are always under 120 -&gt; no quality warning</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-11-29 14:47</div>
            <div class="timeline-body"><blockquote>
<p>As I mentioned in my comment above, I would definitely use it because I prefer my line length to be 120 and my preferred documentation renders maximum ~80 characters and therefore I would set (2) to 80.</p>
</blockquote>
<p>Just to be totally clear, when you set (2) to 80, would you expect that to be 80 characters from the start of the <em>line</em>, or 80 characters from the start of the docstring (i.e., exclusive of the indentation)?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ofek">@ofek</a> on 2023-11-29 14:54</div>
            <div class="timeline-body"><p>80 characters from the start of the docstring</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2023-11-29 16:28</div>
            <div class="timeline-body"><blockquote>
<p>To be clear, you're saying that when we build docs the recommendation is to have a separate config file just for that option and format the code in the CI using that config file, and then run the documentation generator?</p>
</blockquote>
<p>Well ideally we'd make it easier than creating a whole separate config file to override a single option (as described in https://github.com/astral-sh/ruff/issues/8368) but yes. This is more of a solution for people who have a documentation line width that <em>would</em> cause conflict with their global line width e.g. they're the same number instead of 80 / 120.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/9030.html">astral-sh/ruff#9030</a> on 2023-12-07 19:09</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2023-12-07 22:06</div>
            <div class="timeline-body"><p>Bikeshed: what name should we use for the option to control line width in docstring code snippets? rustfmt uses <a href="https://rust-lang.github.io/rustfmt/?version=v1.6.0&amp;search=#doc_comment_code_block_width"><code>doc_comment_code_block_width</code></a>, which I think would translate to <code>docstring-code-block-width</code> for us. With that said, we already have a <code>line-length</code> configuration option, so &quot;width&quot; might be read as inconsistent there.</p>
<p>Some ideas:</p>
<ul>
<li><code>docstring-code-block-length</code></li>
<li><code>docstring-code-line-length</code></li>
</ul>
<p>There is also the other question as to what the <em>default</em> value for this option should be. One thought is to make the default value <code>dynamic</code>, which makes its value a mixed type. Where <code>dynamic</code> means, &quot;the line width is dynamically set so that the lines are wrapped in a way to respect the global line length setting.&quot;</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-12-07 22:39</div>
            <div class="timeline-body"><p>My vote would be for <code>docstring-code-line-length</code>. We had a lot of discussion about length vs. width when we released the formatter Beta, and opted to keep everything as <code>-length</code> for now to avoid a bunch of deprecations while keeping things internally consistent. (We do use width conceptually, and may rename eventually, but for now it's preferable to be consistent across settings at least.)</p>
<p>My guess would be that <code>docstring-code-line-length</code> defaults to <code>None</code>, and when <code>None</code>, it behaves dynamically, matching the global line length setting.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ofek">@ofek</a> on 2023-12-07 23:27</div>
            <div class="timeline-body"><blockquote>
<p>My guess would be that docstring-code-line-length defaults to <code>None</code>, and when <code>None</code></p>
</blockquote>
<p>Do you mean a string <code>&quot;None&quot;</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-12-08 00:26</div>
            <div class="timeline-body"><p>I was suggesting that we use the absence of a value to represent the default, and internally it would be modeled as the null value. But I guess that doesn't allow overrides for projects that use <code>extends</code>, since TOML doesn't have a null value.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2023-12-08 00:45</div>
            <div class="timeline-body"><p>Yeah I was going to say that relying on &quot;absence&quot; to represent a value usually winds up breaking down for $reasons, with overrides and what not being one of them. You usually want some way to explicitly set a particular type of configuration, even if we do permit its absence to default to it. It also gives us wiggle room to add more values.</p>
<p>I'm not opposed to a mixed type field, I just don't know enough about ruff's configuration yet to know whether that's both doable and desirable. I think the alternative is another config knob right?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2023-12-08 00:45</div>
            <div class="timeline-body"><p>I also like <code>docstring-code-line-length</code> as a name.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-12-08 00:57</div>
            <div class="timeline-body"><blockquote>
<p>We had a lot of discussion about length vs. width when we released the formatter Beta, and opted to keep everything as -length for now to avoid a bunch of deprecations while keeping things internally consistent. (We do use width conceptually, and may rename eventually, but for now it's preferable to be consistent across settings at least.)</p>
</blockquote>
<p>I no longer see it as a priority to change from <code>length</code> to <code>width</code>, considering the bikeshedding that it introduces. I'm also fairly happy with our documentation, explaining the <code>length</code> well. I even considered renaming our internal variables to <code>length</code> to avoid the external/internal concept mismatch.</p>
<blockquote>
<p>My guess would be that docstring-code-line-length defaults to None, and when None, it behaves dynamically, matching the global line length setting.</p>
</blockquote>
<p>The global line length setting defaults to 88 and not <code>None</code>. Or do you mean that the absence of a value inherits the global line-length setting?</p>
<blockquote>
<p>Some ideas:</p>
</blockquote>
<ul>
<li><code>docstring-code-block-length</code></li>
<li><code>docstring-code-line-length</code></li>
</ul>
<p>I slightly prefer <code>code-in-docstring-line-length</code> because of the <code>line-length</code> suffix, although <code>docstring-code-block-length</code> seems more correct.</p>
<p>We decided to name the knob enabling docstring formatting <code>format-code-in-docstrings</code>, where <code>code</code> comes before <code>docstring</code>, opposed to the proposed options. This makes it harder to predict what the option names are without looking them up in the documentation. How about: <code>code-in-docstrings-line-length</code>. It's unfortunate that <code>format-code-in-docstrings</code> starts with <code>format</code>, because seeing all docstring options by simply typing <code>code-in</code> and waiting for intellisense won't work.</p>
<blockquote>
<p>There is also the other question as to what the default value for this option should be. One thought is to make the default value dynamic, which makes its value a mixed type. Where dynamic means, &quot;the line width is dynamically set so that the lines are wrapped in a way to respect the global line length setting.&quot;</p>
</blockquote>
<p>Implementing <code>dynamic</code> could be interesting ;) You need a way to determine the current indent level, which probably requires upward traversal (which our AST doesn't support), tracking the nesting level somewhere in the context, or build a parent tree in the pre-traversal step (probably expensive).</p>
<p>Considering that <code>blackdoc</code> (and maybe others?) never exposed such option and I agree with Zanie, that documentation tooling ideally would reformat the code again. Is now the right time to add this option or could we default to <code>dynamic</code> and defer supporting two modes?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2023-12-08 01:09</div>
            <div class="timeline-body"><blockquote>
<p>Implementing <code>dynamic</code> could be interesting ;) You need a way to determine the current indent level, which probably requires upward traversal (which our AST doesn't support), tracking the nesting level somewhere in the context, or build a parent tree in the pre-traversal step (probably expensive).</p>
</blockquote>
<p>Yeah, I don't actually know precisely how to implement this. I probably naively assumed that I would &quot;just&quot; compute the indentation length of the minimum indent of the code block, subtract that from the configured global setting and use the result of that subtraction as the new global line width setting in the call to the formatter for the snippet. And of course, have some kind of reasonable fallback for cases where the new line width setting would be unreasonable small.</p>
<p>I haven't actually tried that, so I don't know if it works. If it doesn't work, and we do indeed need to do something like what you said, then that could be an issue.</p>
<blockquote>
<p>Considering that <code>blackdoc</code> (and maybe others?) never exposed such option and I agree with Zanie, that documentation tooling ideally would reformat the code again.</p>
</blockquote>
<p>I think the issue with putting the onus on the documentation tooling is that it does let folks strike a practical middle ground when this feature ships.</p>
<p>One of the key motivating factors for having <code>dynamic</code>, or at the very least, an option to set a fixed width, is to avoid tripping the long line length limit. With the status quo, folks with a long line length lint enabled will turn this on, format their code snippets, and very likely end up with a huge set of line length violations. They <em>could</em> choose to suppress those lints for docstrings, but 1) this isn't a good UX and 2) docstrings tend to be an area where the line length lint gets tripped and is most useful. This is distilled from <a href="https://github.com/astral-sh/ruff/issues/8855#issuecomment-1829334728">existing feedback</a> from @stinodego.</p>
<blockquote>
<p>Is now the right time to add this option or could we default to <code>dynamic</code> and defer supporting two modes?</p>
</blockquote>
<p>I am slightly confused by this phrasing. The status quo today is not <code>dynamic</code>. It is a mode where the line length of reformatted code is unchanged, despite the fact that its first column may not be the actual first column in the source code.</p>
<p>To be clear, we could ship what we have today, as-is, with no new options. My <em>instinct</em> is that it will immediately lead to a bunch of complaints that we can predict. I don't know for sure though. Maybe it's fine.</p>
<p>I think we need to at least provide a way to specify a fixed line width. It won't completely solve the user experience problem with violating line length limits, but it will probably let users heuristically avoid most issues. It also lets them set it to something small to motivate more wrapping in documentation without relying on their documentation tooling to do auto-reformatting itself.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2023-12-08 01:11</div>
            <div class="timeline-body"><blockquote>
<p>I think we need to at least provide a way to specify a fixed line width.</p>
</blockquote>
<p>So to be extra clear here, one possibility is that we add a docstring code snippet line length option, set to a fixed default value (probably just <code>88</code>) and have it always enabled. Then users could shrink that if they want it shorter. But nothing will happen automatically. It basically gives end users <em>some</em> control, if not ideal control (IMO).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-12-08 02:17</div>
            <div class="timeline-body"><blockquote>
<p>Yeah, I don't actually know precisely how to implement this. I probably naively assumed that I would &quot;just&quot; compute the indentation length of the minimum indent of the code block,</p>
</blockquote>
<p>I don't think we can rely on the source text for this, because the source text may not be correctly indented.</p>
<blockquote>
<p>One of the key motivating factors for having dynamic</p>
</blockquote>
<p>From what I understand is that <code>dynamic</code> is what <code>blackdoc</code> implements today and supporting it eases migration for those users. That's why I considered only shipping <code>dynamic</code> for now and add the <code>line-length</code> option later (although adding a setting is probably easier than implementing dynamic, at least when we ignore naming)</p>
<p>On naming. ChatGPT is happy with <code>docstring-code-block-line-length</code></p>
<blockquote>
<p>The option docstring-code-block-line-length in a Python code formatter, such as Black or Pylint, is used to configure the maximum line length for code blocks within docstrings. Docstrings are multi-line strings used to provide documentation for functions, classes, modules, or methods in Python.</p>
</blockquote>
<blockquote>
<p>When a docstring contains code examples or blocks of code, this option allows you to set a specific line length for those code blocks within the docstring. This can help maintain a consistent and readable style for the documentation.</p>
</blockquote>
<blockquote>
<p>For example, if you set docstring-code-block-line-length to 80, the code formatter will ensure that lines within code blocks in docstrings do not exceed 80 characters in length. This helps to adhere to coding style guidelines and improve the overall readability of the documentation.</p>
</blockquote>
<blockquote>
<p>Here's a hypothetical configuration snippet for Black that includes the docstring-code-block-line-length option:</p>
</blockquote>
<pre><code class="language-toml">[tool.black]
line-length = 88
docstring-code-block-line-length = 80
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2023-12-08 03:53</div>
            <div class="timeline-body"><blockquote>
<p>(although adding a setting is probably easier than implementing dynamic, at least when we ignore naming)</p>
</blockquote>
<p>Yeah exactly, <code>dynamic</code> <em>may</em> be tricky to implement correctly.</p>
<blockquote>
<p>I don't think we can rely on the source text for this, because the source text may not be correctly indented.</p>
</blockquote>
<p>Right, I think I see now. I was only thinking about the contents of the docstring, but the indentation of the <em>docstring itself</em> might not be correct in the source. Is that what you mean? If so, yeah I'm not sure exactly how to implement <code>dynamic</code> in simple way.</p>
<p>I'll investigate what <code>blackened</code> and <code>blackdoc</code> do today. I had thought they did what is currently implemented, but now I can't seem to remember precisely and it looks like I may not have written it down. AIUI, <code>blackened</code> is the more popular tool.</p>
<p>As for naming, I'm still note a huge fan of adding &quot;block&quot; in there. It feels a little redundant and more verbose? I'm not strongly opposed though. If everyone likes that naming, then I'm totally cool with it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2023-12-08 14:12</div>
            <div class="timeline-body"><p>OK, let's look at a concrete example to see how things behave. We'll start with this:</p>
<pre><code class="language-python">def doctest_long_lines():
    '''
    Do cool stuff.

    This won't get wrapped even though it exceeds our configured
    line width because it doesn't exceed the line width within this
    docstring. e.g, the `f` in `foo` is treated as the first column.

    .. code-block:: python

        foo, bar, quux = this_is_a_long_line(lion, giraffe, hippo, zeba, lemur, penguin, bear)

    But this one is long enough to get wrapped.

    .. code-block:: python

        foo, bar, quux = this_is_a_long_line(lion, giraffe, hippo, zeba, lemur, penguin, monkey, spider, bear, leopard)

    '''
    # This demostrates a normal line that will get wrapped but won't
    # get wrapped in the docstring above because of how the line-width
    # setting gets reset at the first column in each code snippet.
    foo, bar, quux = this_is_a_long_line(lion, giraffe, hippo, zeba, lemur, penguin, monkey)
</code></pre>
<p>The first doctest looks like this, and on its own does not exceed 88 columns (it's 86 columns):</p>
<pre><code class="language-python">foo, bar, quux = this_is_a_long_line(lion, giraffe, hippo, zeba, lemur, penguin, bear)
</code></pre>
<p>However, in the context of the source file, it looks like this, where it <em>does</em> exceed 88 columns (94 columns, including indentation):</p>
<pre><code class="language-python">        foo, bar, quux = this_is_a_long_line(lion, giraffe, hippo, zeba, lemur, penguin, bear)
</code></pre>
<p>The second doctest exceeds 88 columns on its own (it's 111 columns):</p>
<pre><code class="language-python">foo, bar, quux = this_is_a_long_line(lion, giraffe, hippo, zeba, lemur, penguin, monkey, spider, bear, leopard)
</code></pre>
<p>Here's what <code>ruff format</code> does today with the above code, with docstring code formatting enabled and otherwise default settings (so a line length of 88):</p>
<pre><code class="language-python">def doctest_long_lines():
    &quot;&quot;&quot;
    Do cool stuff.

    This won't get wrapped even though it exceeds our configured
    line width because it doesn't exceed the line width within this
    docstring. e.g, the `f` in `foo` is treated as the first column.

    .. code-block:: python

        foo, bar, quux = this_is_a_long_line(lion, giraffe, hippo, zeba, lemur, penguin, bear)

    But this one is long enough to get wrapped.

    .. code-block:: python

        foo, bar, quux = this_is_a_long_line(
            lion, giraffe, hippo, zeba, lemur, penguin, monkey, spider, bear, leopard
        )

    &quot;&quot;&quot;
    # This demostrates a normal line that will get wrapped but won't
    # get wrapped in the docstring above because of how the line-width
    # setting gets reset at the first column in each code snippet.
    foo, bar, quux = this_is_a_long_line(
        lion, giraffe, hippo, zeba, lemur, penguin, monkey
    )
</code></pre>
<p>The first doctest, despite it exceeding the line length of 88, does not get wrapped. This is because the actual code itself does not exceed the line length. The second doctest does however, since it is long enough on its own to exceed the global configured line width.</p>
<p>So, how do <code>blackdoc</code> and <code>blackened</code> behave?</p>
<p>For <code>blackdoc</code>, we get this:</p>
<pre><code class="language-python">def doctest_long_lines():
    '''
    Do cool stuff.

    This won't get wrapped even though it exceeds our configured
    line width because it doesn't exceed the line width within this
    docstring. e.g, the `f` in `foo` is treated as the first column.

    .. code-block:: python

        foo, bar, quux = this_is_a_long_line(
            lion, giraffe, hippo, zeba, lemur, penguin, bear
        )

    But this one is long enough to get wrapped.

    .. code-block:: python

        foo, bar, quux = this_is_a_long_line(
            lion, giraffe, hippo, zeba, lemur, penguin, monkey, spider, bear, leopard
        )

    '''
    # This demostrates a normal line that will get wrapped but won't
    # get wrapped in the docstring above because of how the line-width
    # setting gets reset at the first column in each code snippet.
    foo, bar, quux = this_is_a_long_line(lion, giraffe, hippo, zeba, lemur, penguin, monkey)
</code></pre>
<p>Notice that the first doctest is wrapped, so it <em>seems</em> like <code>blackdoc</code> tries to ensure that lines respect the &quot;global&quot; line width setting. This is what I've referred to as a <code>dynamic</code> mode in my previous comments. Indeed, if we look at what <code>blackdoc</code> is actually doing, it does indeed seem to <a href="https://github.com/keewis/blackdoc/blob/822385ba8955e44397288caa07a2d2e3dc933b1e/blackdoc/blacken.py#L39-L41">set the line length based on the current indentation (and prompt length)</a>. That's what I was thinking of doing for implementing <code>dynamic</code> mode as well, but maybe that's tricky to do in our case given Micha's comments above.</p>
<p>And for <code>blackened</code>, we get this:</p>
<pre><code class="language-python">def doctest_long_lines():
    '''
    Do cool stuff.

    This won't get wrapped even though it exceeds our configured
    line width because it doesn't exceed the line width within this
    docstring. e.g, the `f` in `foo` is treated as the first column.

    .. code-block:: python

        foo, bar, quux = this_is_a_long_line(lion, giraffe, hippo, zeba, lemur, penguin, bear)

    But this one is long enough to get wrapped.

    .. code-block:: python

        foo, bar, quux = this_is_a_long_line(
            lion, giraffe, hippo, zeba, lemur, penguin, monkey, spider, bear, leopard
        )

    '''
    # This demostrates a normal line that will get wrapped but won't
    # get wrapped in the docstring above because of how the line-width
    # setting gets reset at the first column in each code snippet.
    foo, bar, quux = this_is_a_long_line(lion, giraffe, hippo, zeba, lemur, penguin, monkey)
</code></pre>
<p>So it looks like <code>blackened</code> behaves like the status quo. However, when it's actually doing is configuring the line length explicitly, and using black's default (88). The CLI provides a way to override the line length:</p>
<pre><code>$ blacken-docs --line-length 60 test.py
</code></pre>
<p>Where we now get:</p>
<pre><code class="language-python">def doctest_long_lines():
    '''
    Do cool stuff.

    This won't get wrapped even though it exceeds our configured
    line width because it doesn't exceed the line width within this
    docstring. e.g, the `f` in `foo` is treated as the first column.

    .. code-block:: python

        foo, bar, quux = this_is_a_long_line(
            lion, giraffe, hippo, zeba, lemur, penguin, bear
        )

    But this one is long enough to get wrapped.

    .. code-block:: python

        foo, bar, quux = this_is_a_long_line(
            lion,
            giraffe,
            hippo,
            zeba,
            lemur,
            penguin,
            monkey,
            spider,
            bear,
            leopard,
        )

    '''
    # This demostrates a normal line that will get wrapped but won't
    # get wrapped in the docstring above because of how the line-width
    # setting gets reset at the first column in each code snippet.
    foo, bar, quux = this_is_a_long_line(lion, giraffe, hippo, zeba, lemur, penguin, monkey)
</code></pre>
<p>And, notably, <code>blackdoc</code> also has a <code>--line-length</code> option:</p>
<pre><code>$ blackdoc --line-length 60 /tmp/test.py
</code></pre>
<p>Where we now get the same as <code>blacken-docs</code>:</p>
<pre><code class="language-python">def doctest_long_lines():
    '''
    Do cool stuff.

    This won't get wrapped even though it exceeds our configured
    line width because it doesn't exceed the line width within this
    docstring. e.g, the `f` in `foo` is treated as the first column.

    .. code-block:: python

        foo, bar, quux = this_is_a_long_line(
            lion, giraffe, hippo, zeba, lemur, penguin, bear
        )

    But this one is long enough to get wrapped.

    .. code-block:: python

        foo, bar, quux = this_is_a_long_line(
            lion,
            giraffe,
            hippo,
            zeba,
            lemur,
            penguin,
            monkey,
            spider,
            bear,
            leopard,
        )

    '''
    # This demostrates a normal line that will get wrapped but won't
    # get wrapped in the docstring above because of how the line-width
    # setting gets reset at the first column in each code snippet.
    foo, bar, quux = this_is_a_long_line(lion, giraffe, hippo, zeba, lemur, penguin, monkey)
</code></pre>
<p>So, let's categorize things. I think there are three known different configuration setups here:</p>
<ol>
<li><code>same-as-global</code> means that the line length is always fixed to whatever the global <code>line-length</code> setting is. When this setting is enabled, users cannot have a different line width for their code and the code examples in docstrings. This setting makes it difficult to avoid long line lint violations. You either need to disable the lint or selectively disable it.</li>
<li><code>dynamic</code> means that the line length of code examples in docstrings is dynamically determined based on the indent of the code example <em>and</em> the global line length setting. In this case, formatting guarantees that all lines fit within one global line length. This may lead to sub-optimal line wrapping in cases of docstrings on deeply nested code, although I suspect this is rare in practice.</li>
<li><code>{integer}</code> means that the line length of code examples can be configured separately from the line length of the surrounding source code.</li>
</ol>
<p>So that means:</p>
<ol>
<li><code>ruff format</code> today implements <code>same-as-global</code> only.</li>
<li><code>blackdoc</code> implements <code>dynamic</code> and <code>{integer}</code>.</li>
<li><code>blacken-docs</code> implements <code>{integer}</code> only.</li>
</ol>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2023-12-08 14:14</div>
            <div class="timeline-body"><p>I am not fully comfortable shipping with <code>same-as-global</code> because of the UX concerns raised in prior comments. But I think I would be comfortable shipping with <em>only</em> <code>{integer}</code>, assuming we're open to making it a mixed type field in the future to possibly support <code>dynamic</code>.</p>
<p>Note that it may be the case that we just never need to provide a <code>same-as-global</code> setting. If we have <code>{integer}</code>, then users can always just configure both the line length and the docstring line length settings to be the same value. Slightly more work for the end user, but probably clearer semantics. And in the default configuration, it's indistinguishable from <code>same-as-global</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/9055.html">astral-sh/ruff#9055</a> on 2023-12-08 19:00</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/9098.html">astral-sh/ruff#9098</a> on 2023-12-12 14:58</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2023-12-12 15:01</div>
            <div class="timeline-body"><p>With https://github.com/astral-sh/ruff/pull/9098 merged, I think we've settled on our initial strategy here. We'll provide two ways to configure the line width for docstring code snippets:</p>
<ul>
<li>One can set a fixed line length distinct from the line length that applies to the surrounding Python code.</li>
<li>Once can set it to a <code>dynamic</code> mode where the line length limit applied to code snippets in docstrings is determined based on the current indent of the docstring itself.</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @BurntSushi on 2023-12-12 15:01</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../GHOST-Science-Club/tree-classification-irim/pulls/231.html">GHOST-Science-Club/tree-classification-irim#231</a> on 2025-05-30 10:09</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:34:52 UTC
    </footer>
</body>
</html>
