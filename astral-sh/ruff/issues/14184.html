<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Request: Unsafe fix for `non-self-return-type`/`PYI034` - astral-sh/ruff #14184</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Request: Unsafe fix for `non-self-return-type`/`PYI034`</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/issues/14184">#14184</a>
        opened by <a href="https://github.com/Avasam">@Avasam</a>
        on 2024-11-08 00:59
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/Avasam">@Avasam</a> on 2024-11-08 00:59</div>
            <div class="timeline-body"><!--
Thank you for taking the time to report an issue! We're glad to have you involved with Ruff.

If you're filing a bug report, please consider including the following information:

* List of keywords you searched for before creating this issue. Write them down here so that others can find this issue more easily and help provide feedback.
  e.g. "RUF001", "unused variable", "Jupyter notebook"
* A minimal code snippet that reproduces the bug.
* The command you invoked (e.g., `ruff /path/to/file.py --fix`), ideally including the `--isolated` flag.
* The current Ruff settings (any relevant sections from your `pyproject.toml`).
* The current Ruff version (`ruff --version`).
-->

<p>https://docs.astral.sh/ruff/rules/non-self-return-type/</p>
<p>Very similar to https://github.com/astral-sh/ruff/issues/14183
I feel like logically a fix for this rule should be feasible without too much complexity? (at least in pyi files and maybe py files above 3.10, see https://github.com/astral-sh/ruff/issues/9761). The fix should be unsafe as there might be a specific intent, or a stub shows that the runtime returns an instance not actually based on <code>self/cls</code>. Marking it unsafe may also simplify the logic to apply the fix (if <code>Self</code> already exists in scope).</p>
<p>Maybe it can be restricted to where the return type to replace is the same as the class and not overloaded ?</p>
<pre><code class="language-py">class ArrayDerivative(Derivative):
    def __new__(cls, expr, *variables, **kwargs) -&gt; ArrayDerivative: ... # unsafe autofix to replace with self
</code></pre>
<pre><code class="language-py">class CaptureOutput:
    @overload
    def __new__(
        cls, backend: Literal[CaptureOutputs.PIL] = CaptureOutputs.PIL
    ) -&gt; PILCaptureOutput: ...
    @overload
    def __new__(cls, backend: Literal[CaptureOutputs.NUMPY]) -&gt; NumpyCaptureOutput: ...
    @overload
    def __new__(cls, backend: Literal[CaptureOutputs.NUMPY_FLOAT]) -&gt; NumpyFloatCaptureOutput: ...
    @overload
    def __new__(cls, backend: Literal[CaptureOutputs.PYTORCH]) -&gt; PytorchCaptureOutput: ...
    @overload
    def __new__(
        cls, backend: Literal[CaptureOutputs.PYTORCH_FLOAT]
    ) -&gt; PytorchFloatCaptureOutput: ...
    @overload
    def __new__(cls, backend: Literal[CaptureOutputs.PYTORCH_GPU]) -&gt; PytorchGPUCaptureOutput: ...
    @overload
    def __new__(
        cls, backend: Literal[CaptureOutputs.PYTORCH_FLOAT_GPU]
    ) -&gt; PytorchFloatGPUCaptureOutput: ...
    @overload
    def __new__(cls, backend: CaptureOutputs) -&gt; CaptureOutput: ...
    def __new__(cls, backend: CaptureOutputs = CaptureOutputs.PIL) -&gt; CaptureOutput:  # no autofix
        return cls._initialize_backend(backend)
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../microsoft/python-type-stubs/pulls/340.html">microsoft/python-type-stubs#340</a> on 2024-11-08 03:11</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">fixes</span> added by @dhruvmanila on 2024-11-08 08:16</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/14217.html">astral-sh/ruff#14217</a> on 2024-11-09 00:03</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2024-11-09 02:11</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 01:30:15 UTC
    </footer>
</body>
</html>
