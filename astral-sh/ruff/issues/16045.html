<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TC004 probably shouldn't trigger on typing-modules - astral-sh/ruff #16045</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>TC004 probably shouldn&#x27;t trigger on typing-modules</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/issues/16045">#16045</a>
        opened by <a href="https://github.com/mikeshardmind">@mikeshardmind</a>
        on 2025-02-08 22:08
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/mikeshardmind">@mikeshardmind</a></div>
            <div class="timeline-body">Description
<p>relevant parts of config:</p>
<pre><code>[tool.ruff]

line-length = 90
target-version = &quot;py312&quot;
preview = true

[tool.ruff.format]
line-ending = &quot;lf&quot;

[tool.ruff.lint]
select = [
    &quot;A&quot;, &quot;ANN&quot;, &quot;ASYNC&quot;, &quot;B&quot;, &quot;BLE&quot;, &quot;C4&quot;, &quot;COM&quot;, &quot;D&quot;, &quot;DOC&quot;, &quot;DTZ&quot;, &quot;E&quot;,
    &quot;EM&quot;, &quot;ERA&quot;, &quot;F&quot;, &quot;FA&quot;, &quot;FBT&quot;, &quot;FURB&quot;, &quot;G&quot;, &quot;I&quot;, &quot;INP&quot;, &quot;ISC&quot;, &quot;NPY&quot;,
    &quot;PD&quot;, &quot;PERF&quot;, &quot;PGH&quot;, &quot;PIE&quot;, &quot;PLC&quot;, &quot;PLE&quot;, &quot;PLR&quot;, &quot;PLW&quot;, &quot;PTH&quot;, &quot;PYI&quot;,
    &quot;Q&quot;, &quot;Q003&quot;, &quot;RET&quot;, &quot;RSE&quot;, &quot;RUF&quot;, &quot;S&quot;, &quot;SIM&quot;, &quot;SLOT&quot;, &quot;T20&quot;, &quot;TC&quot;, &quot;TID&quot;,
    &quot;TRY&quot;, &quot;UP&quot;, &quot;YTT&quot;
]

typing-modules = [&quot;async_utils._typings&quot;]
</code></pre>
<p>contents of <code>async_utils._typings</code></p>
<pre><code># License and context of encountering this issue available here
# https://github.com/mikeshardmind/async-utils/blob/c84b9a71f8caf5a5dcfafc675eff7dec60bd4162/src/async_utils/_typings.py#L27-L44
from __future__ import annotations

TYPE_CHECKING = False
if TYPE_CHECKING:
    from typing import Any, Literal, Never, Self
else:

    def __getattr__(name: str):
        if name in {&quot;Any&quot;, &quot;Literal&quot;, &quot;Never&quot;, &quot;Self&quot;}:
            import typing

            return getattr(typing, name)

        msg = f&quot;module {__name__!r} has no attribute {name!r}&quot;
        raise AttributeError(msg)


__all__ = [&quot;TYPE_CHECKING&quot;, &quot;Any&quot;, &quot;Literal&quot;, &quot;Never&quot;, &quot;Self&quot;]
</code></pre>
<p>errors:</p>
<pre><code>Error: src/async_utils/_typings.py:31:24: TC004 Move import `typing.Any` out of type-checking block. Import is used for more than type hinting.
Error: src/async_utils/_typings.py:31:29: TC004 Move import `typing.Literal` out of type-checking block. Import is used for more than type hinting.
Error: src/async_utils/_typings.py:31:38: TC004 Move import `typing.Never` out of type-checking block. Import is used for more than type hinting.
Error: src/async_utils/_typings.py:31:45: TC004 Move import `typing.Self` out of type-checking block. Import is used for more than type hinting.
</code></pre>
<p>Not sure there&#x27;s a good way to handle this, this is intentionally slightly dynamic use, as throughout the rest of the module, use of typing is done with something like:</p>
<pre><code>from __future__ import annotations  # remove this on 3.14+

from . import _typings as t

def errors() -&gt; t.Never:
    ...
</code></pre>
<p>Which preserves runtime introspectability, but can result in typing never being imported if that introspection capability is never used.</p>
<p>Checking that a corresponding use exists in else block here might be more trouble than it is worth, and it may be better to just exempt any file marked as part of <code>typing-modules</code> from this. For now I&#x27;m going to disable the rule.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntBre">@ntBre</a> on 2025-02-09 02:07</div>
            <div class="timeline-body"><p>Thanks for the report! This looks like a change/regression in 0.9.5 (possibly related to #15719?) I was having trouble reproducing it locally but realized my global ruff install was on 0.9.3 ðŸ˜†</p>
<p>I can actually reproduce with just <code>--select TC004</code> and <code>--preview</code> on 0.9.5:</p>
<pre><code> cat &lt;&lt;&#x27;EOF&#x27; | uvx ruff@0.9.5 check --select TC004 --no-cache --preview --isolated -
from __future__ import annotations

TYPE_CHECKING = False
if TYPE_CHECKING:
    from typing import Any, Literal, Never, Self
else:

    def __getattr__(name: str):
        if name in {&quot;Any&quot;, &quot;Literal&quot;, &quot;Never&quot;, &quot;Self&quot;}:
            import typing

            return getattr(typing, name)

        msg = f&quot;module {__name__!r} has no attribute {name!r}&quot;
        raise AttributeError(msg)


__all__ = [&quot;TYPE_CHECKING&quot;, &quot;Any&quot;, &quot;Literal&quot;, &quot;Never&quot;, &quot;Self&quot;]
EOF
</code></pre>
<p>@AlexWaygood might have more insight into the intended or desired behavior here.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by <a href="https://github.com/ntBre">@ntBre</a> on 2025-02-09 02:07</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">preview</span> added by <a href="https://github.com/ntBre">@ntBre</a> on 2025-02-09 02:07</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-02-09 12:18</div>
            <div class="timeline-body"><p>I suppose we <em>could</em> automatically switch off this rule for all modules listed in the <code>typing-modules</code> setting. I&#x27;m not sure if that&#x27;s what all users would naturally expect, though. If you find the rule otherwise useful, but you want to suppress all diagnostics from the rule in this specific file, you can do that by putting <code># ruff: noqa: TC004</code> anywhere in the file (docs at https://docs.astral.sh/ruff/linter/#error-suppression), or by using either the <a href="https://docs.astral.sh/ruff/settings/#lint_per-file-ignores"><code>per-file-ignores</code></a> setting or the <a href="https://docs.astral.sh/ruff/settings/#lint_extend-per-file-ignores"><code>extend-per-file-ignores</code></a> setting.</p>
<p>@Daverball, what do you think of automatically switching the rule off for all files listed in the <code>typing-modules</code> setting?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-02-09 12:30</div>
            <div class="timeline-body"><p>This is probably a dumb question but is there a specific reason why the typing module uses <code>.py</code> over <code>.pyi</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-02-09 12:34</div>
            <div class="timeline-body"><blockquote>
<p>This is probably a dumb question but is there a specific reason why the typing module uses <code>.py</code> over <code>.pyi</code>?</p>
</blockquote>
<p>The idea of the typing module here is to reduce the import time of the app or library at runtime by only lazily importing the <code>typing</code> module &quot;on demand&quot;. On more recent Python versions, the typing module is actually faster to import than lots of other popular stdlib modules such as <code>inspect</code> or <code>dataclasses</code>, but it has a historical reputation as being very slow to import, so this kind of thing is reasonably common. (It&#x27;s also one of the easier modules to do this kind of thing with; it&#x27;s harder to use this kind of shim module to delay the import of <code>dataclasses</code>, for example.)</p>
<p>This wouldn&#x27;t work if the typing module was a <code>.pyi</code> file because <code>.pyi</code> files are never executed at runtime; they&#x27;re just for type checkers. So a <code>.pyi</code> file would have no effect on the import time of the app or library.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">needs-decision</span> added by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-02-09 12:59</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Daverball">@Daverball</a> on 2025-02-09 13:08</div>
            <div class="timeline-body"><p>The main culprit here is <code>__all__</code>, it creates a runtime reference to these symbols and the <code>else</code> clause is too dynamic for ruff to understand that these symbols are actually available at runtime.</p>
<p>This is such a specialized case, I think it makes more sense to just <code>noqa: TC004</code> the imports, anything else is a hack at best.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Daverball">@Daverball</a> on 2025-02-09 13:14</div>
            <div class="timeline-body"><p>Another solution is to disable <code>TC004</code> if there is a module-level <code>__getattr__</code> and the only runtime reference is in <code>__all__</code>, since realistically we can&#x27;t know at that point if a symbol is available at runtime or not.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-02-09 13:15</div>
            <div class="timeline-body"><blockquote>
<p>Another solution is to disable <code>TC004</code> if there is a module-level <code>__getattr__</code> and the only runtime reference is in <code>__all__</code>, since realistically we can&#x27;t know at that point if a symbol is available at runtime or not.</p>
</blockquote>
<p>Oh, that seems like a reasonable improvement to me!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">needs-decision</span> removed by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-02-09 16:15</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-02-09 16:27</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 18:49:28 UTC
    </footer>
</body>
</html>
