```yaml
number: 12872
title: Import sorting does not (immediately) converge?
type: issue
state: closed
author: ax3l
labels:
  - isort
  - needs-mre
assignees: []
created_at: 2024-08-13T23:59:25Z
updated_at: 2024-08-14T20:21:48Z
url: https://github.com/astral-sh/ruff/issues/12872
synced_at: 2026-01-10T01:56:53Z
```

# Import sorting does not (immediately) converge?

---

_Issue opened by @ax3l on 2024-08-13 23:59_

Hi,

I am using `ruff` verison 0.5.6 in [pyAMReX](https://github.com/AMReX-Codes/pyamrex) (linter, not the formatter).

I am using [pre-commit](https://pre-commit.com/) to update our source code after merge to `development`. I used `black` in the past and switched this week, discovering on August 10th and following that `ruff` creates a lot of rotating changes when run multiple times:
https://github.com/AMReX-Codes/pyamrex/commit/74e076228d4f3d2d6d7ca137610b60b4f91495a5
https://github.com/AMReX-Codes/pyamrex/commit/5dc9c029bacec441ca4484763b34527112408d2b
https://github.com/AMReX-Codes/pyamrex/commit/902c41b012b58fe9479ab6fd414193d9c5f81a97
...
https://github.com/AMReX-Codes/pyamrex/commits/development/

for code of the form
```py
from a.b1 import c1
from a.b1 import c1 as cc1
from a.b2 import c2
from a.b3 import c3
```

Is there a way to avoid this?

This happens for us on `.pyi` headers and we intentionally have an alias for some of those imports (for backwards compatibility with a public API change that we are shipping).

---

_Renamed from "Sorting Issue" to "Import sorting does not (immediately) converge?" by @ax3l on 2024-08-14 00:00_

---

_Comment by @charliermarsh on 2024-08-14 01:11_

I can take a look.

---

_Assigned to @charliermarsh by @charliermarsh on 2024-08-14 01:12_

---

_Label `isort` added by @charliermarsh on 2024-08-14 01:12_

---

_Comment by @charliermarsh on 2024-08-14 01:12_

It's possible that we've just never seen this pattern before and so the sort isn't stable:
```python
from amrex.space1d.amrex_1d_pybind import IntVect1D
from amrex.space1d.amrex_1d_pybind import IntVect1D as IntVect
```


---

_Comment by @ax3l on 2024-08-14 01:42_

Thank you for taking a look. Yes, an unstable isort pattern seems to cause this. I recently switched over to all-`ruff`ing from isort+black+...

<details>
The pattern here is for backwards compatibility as we face out the `IntVect` type for more explicit versions in our public APIs. Technically, the file that shows this is autogenerated from [pybind11-stubgen](https://github.com/sizmailov/pybind11-stubgen).
This is the line we do to declare the alias: https://github.com/AMReX-Codes/pyamrex/blob/c61add4fd44ad4ec69b131865375d76c68f12b29/src/Base/IntVect.cpp#L185
</details>

---

_Referenced in [AMReX-Codes/pyamrex#351](../../AMReX-Codes/pyamrex/pulls/351.md) on 2024-08-14 01:57_

---

_Comment by @charliermarsh on 2024-08-14 02:53_

Did you have any sort of configuration set? Like:
```toml
[tool.ruff.lint.isort]
force-single-line = true
```

The style in those files doesn't match our standard style, so trying to figure out how to reproduce.

---

_Label `needs-mre` added by @MichaReiser on 2024-08-14 06:52_

---

_Comment by @ax3l on 2024-08-14 14:07_

No, none of that kind set. I now add "amrex" as known first party module, but that's all I set (no change with or without that option regarding the stability issue).

I just realized I rebaded out the unstable sort commits yesterday in my mainline (using isort again for a stable sort), please let me know if I shall add those again in a feature branch.

---

_Comment by @charliermarsh on 2024-08-14 14:12_

Okay thanks. I'm just struggling because if I check out `858e2a9359c6379782b3f2766e5415ba61be44f2` and run `ruff check --select I --fix`, it completely changes the import style in those files, so I don't think Ruff was run on those commits. Am I misunderstanding?

---

_Comment by @ax3l on 2024-08-14 15:42_

That is right, this is the commit just right before I switched from black+isort to ruff.

Here is how I see the issue:

1. I [build and install](https://github.com/AMReX-Codes/pyamrex?tab=readme-ov-file#build) the project.
2. I run [pybind-stubgen](https://github.com/sizmailov/pybind11-stubgen) via [this script](https://github.com/AMReX-Codes/pyamrex/blob/development/.github/update_stub.sh) to update (recreate) the `.pyi` files in the repo
3. I run the ruff linter

The last two steps repeated create the unstable result for these imports.

(Automated via [pre-commit rules](https://github.com/AMReX-Codes/pyamrex/blob/development/.pre-commit-config.yaml) - I just added `isort` again at the end for stability - in this [workflow](https://github.com/AMReX-Codes/pyamrex/blob/development/.github/workflows/stubs.yml))

---

_Comment by @ax3l on 2024-08-14 15:49_

Example file after step 1 & 2: [`src/amrex/space3d/__init__.pyi`](https://github.com/user-attachments/files/16615669/__init__.pyi.txt)

After running `ruff check --select I --fix` v0.5.7: [`src/amrex/space3d/__init__.pyi`](https://github.com/user-attachments/files/16615690/__init__.pyi.ruff.txt)


---

_Comment by @ax3l on 2024-08-14 15:57_

This is super interesting, the local files I create differ from the commits I autogenerated with pre-commit above (only difference I know is that they used ruff 0.5.6).
Maybe because I actually run all of [E,F,I](https://github.com/AMReX-Codes/pyamrex/blob/c61add4fd44ad4ec69b131865375d76c68f12b29/pyproject.toml#L10-L18)?

---

_Comment by @ax3l on 2024-08-14 19:09_

Oh no, I think I see the issue, it's the pre commit.

Either I should list no types or include explicitly pyi
https://github.com/AMReX-Codes/pyamrex/blob/c61add4fd44ad4ec69b131865375d76c68f12b29/.pre-commit-config.yaml#L82

---

_Comment by @ax3l on 2024-08-14 20:20_

I think it was indeed the case that in the pre-commit rules, the `.pyi` files were not sorted at all, resulting in the unstable result of `pybind11-stubgen` to fluctuate.
https://github.com/AMReX-Codes/pyamrex/pull/356

The underlying issue is  that I did not know what to put in `types_or`, which comes from pre-commit itself, but I only looked at the ruff docs:
https://github.com/astral-sh/ruff-pre-commit?tab=readme-ov-file#using-ruff-with-pre-commit
https://pre-commit.com/#filtering-files-with-types

I am so sorry for the confusion and noise.

---

_Closed by @ax3l on 2024-08-14 20:20_

---
