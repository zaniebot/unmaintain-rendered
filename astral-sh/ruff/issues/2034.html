<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>`exclude` looks at path components beyond &quot;project root&quot; (nÃ©e does `--force-exclude` work like it should?) - astral-sh/ruff #2034</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1><code>exclude</code> looks at path components beyond &quot;project root&quot; (nÃ©e does <code>--force-exclude</code> work like it should?)</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/issues/2034">#2034</a>
        opened by <a href="https://github.com/akx">@akx</a>
        on 2023-01-20 16:13
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/akx">@akx</a> on 2023-01-20 16:13</div>
            <div class="timeline-body"><p>I don't think <code>--force-exclude</code> does what it should; this is especially obvious when using <code>pre-commit-ruff</code> (which is supposed to be used with that flag).</p>
<p>In a repository where there are no excludes, or extend-excludes, running <code>ruff --force-exclude .</code> claims there are no Python files. AFAIU this shouldn't happen since nothing is excluded. This happens with <code>--isolated</code> too.</p>
<pre><code class="language-shell">~/b/ruff-force-exclude-test $ ruff --force-exclude --isolated foo/a.py
warning: No Python files found under the given path(s)
~/b/ruff-force-exclude-test $ ruff --isolated foo/a.py
foo/a.py:1:8: F401 `time` imported but unused
Found 1 error(s).
1 potentially fixable with the --fix option.
~/b/ruff-force-exclude-test $
</code></pre>
<ul>
<li>A minimal code snippet that reproduces the bug:<ul>
<li>https://github.com/akx/ruff-force-exclude-test</li>
</ul>
</li>
<li>The command you invoked (e.g., <code>ruff /path/to/file.py --fix</code>), ideally including the <code>--isolated</code> flag:<ul>
<li><code>ruff --force-exclude --isolated foo/a.py</code> (or without <code>--isolated</code>)</li>
</ul>
</li>
<li>The current Ruff settings (any relevant sections from your <code>pyproject.toml</code>):<ul>
<li><pre><code class="language-toml">[tool.ruff]
target-version = &quot;py37&quot;
select = [&quot;F401&quot;]
</code></pre>
</li>
</ul>
</li>
<li>The current Ruff version (<code>ruff --version</code>):<ul>
<li><code>ruff 0.0.227</code> (versions before 0.0.204 don't show the warning, but they also don't do anything).</li>
</ul>
</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-01-20 16:23</div>
            <div class="timeline-body"><p>This may be a regression. I can take a look later today.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-01-20 16:30</div>
            <div class="timeline-body"><p>(Certainly looks like a regression based on the summary :))</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/akx">@akx</a> on 2023-01-20 16:36</div>
            <div class="timeline-body"><p>Okay! It looks like this may have regressed <a href="https://github.com/charliermarsh/ruff/compare/v0.0.191...v0.0.192">between 0.0.191 and 0.0.192</a>, and 0.0.204 adds the warning:</p>
<pre><code class="language-fish">$ for ruff in (seq 185 227); pip install --quiet ruff==0.0.$ruff; ruff --version; ruff --force-exclude foo/a.py; end
ruff 0.0.185
error: Found argument '--force-exclude' which wasn't expected, or isn't valid in this context
ruff 0.0.186
error: Found argument '--force-exclude' which wasn't expected, or isn't valid in this context
ruff 0.0.187
error: Found argument '--force-exclude' which wasn't expected, or isn't valid in this context
ruff 0.0.188
error: Found argument '--force-exclude' which wasn't expected, or isn't valid in this context
ruff 0.0.189
Found 1 error(s).
foo/a.py:1:8: F401 `time` imported but unused
1 potentially fixable with the --fix option.
ruff 0.0.190
Found 1 error(s).
foo/a.py:1:8: F401 `time` imported but unused
1 potentially fixable with the --fix option.
ruff 0.0.191
foo/a.py:1:8: F401 `time` imported but unused
Found 1 error(s).
1 potentially fixable with the --fix option.
ruff 0.0.192
ruff 0.0.193
ruff 0.0.194
ruff 0.0.195
ruff 0.0.196
ERROR: No matching distribution found for ruff==0.0.197
ruff 0.0.198
ruff 0.0.199
ruff 0.0.200
ruff 0.0.201
ruff 0.0.202
ruff 0.0.203
ruff 0.0.204
warning: No Python files found under the given path(s)
ruff 0.0.205
warning: No Python files found under the given path(s)
ruff 0.0.206
warning: No Python files found under the given path(s)
^C
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-01-20 16:59</div>
            <div class="timeline-body"><p>Thanks! I'll be able to take a look at this in an hour or so. If it's indeed a regression, I'll fix and include in a release this afternoon :)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-01-20 17:52</div>
            <div class="timeline-body"><p>This actually <em>does</em> work for me, even in your test repo (which is awesome, and hugely appreciated).</p>
<p>Is it possible that you have a global <code>.gitignore</code> or something that's getting in the way? E.g., if I set <code>~/.gitignore</code> as my global ignore, and add <code>foo</code> to it, I see the behavior you're describing.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">question</span> added by @charliermarsh on 2023-01-20 17:52</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/akx">@akx</a> on 2023-01-20 18:33</div>
            <div class="timeline-body"><p>Well, I do have a global <code>excludesfile</code>, but that shouldn't matter here considering the contents...</p>
<pre><code>$ git config --global --list | grep ign
core.excludesfile=/Users/akx/.gitignore
$ cat /Users/akx/.gitignore
.DS_Store
.idea
</code></pre>
<p>Moving that file out of the way doesn't change things, so it's not that, anyway.</p>
<p>I'll dig a bit deeper, maybe add some debugging around how the files are enumerated, since I can (thankfully) repro this with my working copy of ruff too :)</p>
<p>Thanks for verifying that it's just me though! I can't repro this in a container either, now that you gave me the idea to :)</p>
<pre><code class="language-shell">$ docker run -it python:3.11 bash
root@cf9034209872:/# git clone https://github.com/akx/ruff-force-exclude-test
root@cf9034209872:/# cd ruff-force-exclude-test/
root@cf9034209872:/ruff-force-exclude-test# pip install ruff
Successfully installed ruff-0.0.227
root@cf9034209872:/ruff-force-exclude-test# ruff --force-exclude .
foo/a.py:1:8: F401 `time` imported but unused
Found 1 error(s).
1 potentially fixable with the --fix option.
root@cf9034209872:/ruff-force-exclude-test#
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/akx">@akx</a> on 2023-01-20 18:43</div>
            <div class="timeline-body"><p>... oh <em>pfff</em>. ðŸ˜‚</p>
<pre><code>~/b/ruff-force-exclude-test (master) $ ruff --force-exclude --no-respect-gitignore --isolated --show-files --verbose foo/a.py
[2023-01-20][20:39:28][globset][DEBUG] built glob set; 19 literals, 0 basenames, 0 extensions, 0 prefixes, 0 suffixes, 0 required extensions, 0 regexes
[2023-01-20][20:39:28][ruff::resolver][DEBUG] Ignored path via `exclude`: &quot;/Users/akx/build&quot;
warning: No Python files found under the given path(s)
</code></pre>
<p>I keep my projects under <code>/Users/akx/build</code> (for legacy raisins); the <code>~/b/</code> in <code>~/b/ruff-force-exclude-test</code> is the Fish shell contracting <code>build</code>.</p>
<p><code>build</code> is, of course, one of the default excludes:</p>
<p>https://github.com/charliermarsh/ruff/blob/9e704a7c639f8ad5f7751fb062c46144caec5bb7/src/settings/defaults.rs#L44</p>
<p>I guess we should root <code>exclude</code> patterns to e.g. where the <code>pyproject.toml</code> file is found?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-01-20 23:33</div>
            <div class="timeline-body"><p>Yeah I need to think on this. I agree it's surprising behavior in this case. I think, maybe, in <code>is_file_excluded</code>, we need to avoid recurring past the &quot;project root&quot;, to avoid looking at directories outside of the <code>pyproject.toml</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">question</span> removed by @charliermarsh on 2023-01-20 23:33</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">core</span> added by @charliermarsh on 2023-01-20 23:33</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "Does `--force-exclude` work like it should?" to "`exclude` looks at path components beyond "project root" (nÃ©e does `--force-exclude` work like it should?)" by @akx on 2023-01-21 16:54</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/akx">@akx</a> on 2023-02-02 12:25</div>
            <div class="timeline-body"><p>@charliermarsh How about https://github.com/charliermarsh/ruff/pull/2471? Seems almost deceptively simple though...</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-02-03 13:24</div>
            <div class="timeline-body"><p>Closed by #2471.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2023-02-03 13:24</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 11:28:57 UTC
    </footer>
</body>
</html>
