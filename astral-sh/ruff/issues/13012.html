<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Red knot panics checking some named expressions - astral-sh/ruff #13012</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Red knot panics checking some named expressions</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/issues/13012">#13012</a>
        opened by <a href="https://github.com/MichaReiser">@MichaReiser</a>
        on 2024-08-20 15:17
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a></div>
            <div class="timeline-body"><pre><code class="language-python">match x:
    case [1, 0] if x := x[:0]:
        y = 1
</code></pre>
<pre><code>thread '&lt;unnamed&gt;' panicked at crates/red_knot_python_semantic/src/types/infer.rs:143:25:
no entry found for key
stack backtrace:
   0: rust_begin_unwind
             at /rustc/051478957371ee0084a7c0913941d2a8c4757bb9/library/std/src/panicking.rs:652:5
   1: core::panicking::panic_fmt
             at /rustc/051478957371ee0084a7c0913941d2a8c4757bb9/library/core/src/panicking.rs:72:14
   2: core::panicking::panic_display
             at /rustc/051478957371ee0084a7c0913941d2a8c4757bb9/library/core/src/panicking.rs:262:5
   3: core::option::expect_failed
             at /rustc/051478957371ee0084a7c0913941d2a8c4757bb9/library/core/src/option.rs:1995:5
   4: core::option::Option&lt;T&gt;::expect
             at /rustc/051478957371ee0084a7c0913941d2a8c4757bb9/library/core/src/option.rs:898:21
   5: &lt;std::collections::hash::map::HashMap&lt;K,V,S&gt; as core::ops::index::Index&lt;&amp;Q&gt;&gt;::index
             at /rustc/051478957371ee0084a7c0913941d2a8c4757bb9/library/std/src/collections/hash/map.rs:1343:23
   6: red_knot_python_semantic::types::infer::TypeInference::expression_ty
             at ./crates/red_knot_python_semantic/src/types/infer.rs:143:25
   7: &lt;ruff_python_ast::expression::ExpressionRef as red_knot_python_semantic::semantic_model::HasTy&gt;::ty
             at ./crates/red_knot_python_semantic/src/semantic_model.rs:62:9
   8: &lt;ruff_python_ast::nodes::ExprName as red_knot_python_semantic::semantic_model::HasTy&gt;::ty
             at ./crates/red_knot_python_semantic/src/semantic_model.rs:72:17
   9: red_knot_workspace::lint::lint_maybe_undefined
             at ./crates/red_knot_workspace/src/lint.rs:130:11
  10: &lt;red_knot_workspace::lint::SemanticVisitor as ruff_python_ast::visitor::Visitor&gt;::visit_expr
             at ./crates/red_knot_workspace/src/lint.rs:257:17
  11: ruff_python_ast::visitor::walk_expr
             at ./crates/ruff_python_ast/src/visitor.rs:511:13
  12: &lt;red_knot_workspace::lint::SemanticVisitor as ruff_python_ast::visitor::Visitor&gt;::visit_expr
             at ./crates/red_knot_workspace/src/lint.rs:262:9
  13: ruff_python_ast::visitor::walk_expr
             at ./crates/ruff_python_ast/src/visitor.rs:351:13
  14: &lt;red_knot_workspace::lint::SemanticVisitor as ruff_python_ast::visitor::Visitor&gt;::visit_expr
             at ./crates/red_knot_workspace/src/lint.rs:262:9
  15: ruff_python_ast::visitor::walk_match_case
             at ./crates/ruff_python_ast/src/visitor.rs:680:9
  16: ruff_python_ast::visitor::Visitor::visit_match_case
             at ./crates/ruff_python_ast/src/visitor.rs:82:9
  17: ruff_python_ast::visitor::walk_stmt
             at ./crates/ruff_python_ast/src/visitor.rs:269:17
  18: &lt;red_knot_workspace::lint::SemanticVisitor as ruff_python_ast::visitor::Visitor&gt;::visit_stmt
             at ./crates/red_knot_workspace/src/lint.rs:251:9
  19: ruff_python_ast::visitor::walk_body
             at ./crates/ruff_python_ast/src/visitor.rs:115:9
  20: ruff_python_ast::visitor::Visitor::visit_body
             at ./crates/ruff_python_ast/src/visitor.rs:94:9
  21: &lt;red_knot_workspace::lint::lint_semantic::Configuration_ as salsa::function::Configuration&gt;::execute::inner_
             at ./crates/red_knot_workspace/src/lint.rs:106:5
  22: &lt;red_knot_workspace::lint::lint_semantic::Configuration_ as salsa::function::Configuration&gt;::execute
             at /home/micha/.cargo/git/checkouts/salsa-fa0738f776139e4c/ece083e/components/salsa-macro-rules/src/setup_tracked_fn.rs:180:21
  23: salsa::function::execute::&lt;impl salsa::function::IngredientImpl&lt;C&gt;&gt;::execute::{{closure}}
             at /home/micha/.cargo/git/checkouts/salsa-fa0738f776139e4c/ece083e/src/function/execute.rs:46:43
  24: &lt;core::panic::unwind_safe::AssertUnwindSafe&lt;F&gt; as core::ops::function::FnOnce&lt;()&gt;&gt;::call_once
             at /rustc/051478957371ee0084a7c0913941d2a8c4757bb9/library/core/src/panic/unwind_safe.rs:272:9
  25: std::panicking::try::do_call
             at /rustc/051478957371ee0084a7c0913941d2a8c4757bb9/library/std/src/panicking.rs:559:40
  26: __rust_try
  27: std::panicking::try
             at /rustc/051478957371ee0084a7c0913941d2a8c4757bb9/library/std/src/panicking.rs:523:19
  28: std::panic::catch_unwind
             at /rustc/051478957371ee0084a7c0913941d2a8c4757bb9/library/std/src/panic.rs:149:14
  29: salsa::cycle::Cycle::catch
             at /home/micha/.cargo/git/checkouts/salsa-fa0738f776139e4c/ece083e/src/cycle.rs:42:15
  30: salsa::function::execute::&lt;impl salsa::function::IngredientImpl&lt;C&gt;&gt;::execute
             at /home/micha/.cargo/git/checkouts/salsa-fa0738f776139e4c/ece083e/src/function/execute.rs:46:27
  31: salsa::function::fetch::&lt;impl salsa::function::IngredientImpl&lt;C&gt;&gt;::fetch_cold
             at /home/micha/.cargo/git/checkouts/salsa-fa0738f776139e4c/ece083e/src/function/fetch.rs:104:14
  32: salsa::function::fetch::&lt;impl salsa::function::IngredientImpl&lt;C&gt;&gt;::compute_value::{{closure}}
             at /home/micha/.cargo/git/checkouts/salsa-fa0738f776139e4c/ece083e/src/function/fetch.rs:46:29
  33: core::option::Option&lt;T&gt;::or_else
             at /rustc/051478957371ee0084a7c0913941d2a8c4757bb9/library/core/src/option.rs:1515:21
  34: salsa::function::fetch::&lt;impl salsa::function::IngredientImpl&lt;C&gt;&gt;::compute_value
             at /home/micha/.cargo/git/checkouts/salsa-fa0738f776139e4c/ece083e/src/function/fetch.rs:44:34
  35: salsa::function::fetch::&lt;impl salsa::function::IngredientImpl&lt;C&gt;&gt;::fetch
             at /home/micha/.cargo/git/checkouts/salsa-fa0738f776139e4c/ece083e/src/function/fetch.rs:21:13
  36: red_knot_workspace::lint::lint_semantic::{{closure}}
             at /home/micha/.cargo/git/checkouts/salsa-fa0738f776139e4c/ece083e/components/salsa-macro-rules/src/setup_tracked_fn.rs:277:25
  37: salsa::attach::Attached::attach
             at /home/micha/.cargo/git/checkouts/salsa-fa0738f776139e4c/ece083e/src/attach.rs:71:9
  38: salsa::attach::attach::{{closure}}
             at /home/micha/.cargo/git/checkouts/salsa-fa0738f776139e4c/ece083e/src/attach.rs:91:23
  39: std::thread::local::LocalKey&lt;T&gt;::try_with
             at /rustc/051478957371ee0084a7c0913941d2a8c4757bb9/library/std/src/thread/local.rs:283:12
  40: std::thread::local::LocalKey&lt;T&gt;::with
             at /rustc/051478957371ee0084a7c0913941d2a8c4757bb9/library/std/src/thread/local.rs:260:9
  41: salsa::attach::attach
             at /home/micha/.cargo/git/checkouts/salsa-fa0738f776139e4c/ece083e/src/attach.rs:91:5
  42: red_knot_workspace::lint::lint_semantic
             at /home/micha/.cargo/git/checkouts/salsa-fa0738f776139e4c/ece083e/components/salsa-macro-rules/src/setup_tracked_fn.rs:269:13
  43: &lt;red_knot_workspace::workspace::check_file::Configuration_ as salsa::function::Configuration&gt;::execute::inner_
             at ./crates/red_knot_workspace/src/workspace.rs:407:35
  44: &lt;red_knot_workspace::workspace::check_file::Configuration_ as salsa::function::Configuration&gt;::execute
             at /home/micha/.cargo/git/checkouts/salsa-fa0738f776139e4c/ece083e/components/salsa-macro-rules/src/setup_tracked_fn.rs:180:21
  45: salsa::function::execute::&lt;impl salsa::function::IngredientImpl&lt;C&gt;&gt;::execute::{{closure}}
             at /home/micha/.cargo/git/checkouts/salsa-fa0738f776139e4c/ece083e/src/function/execute.rs:46:43
  46: &lt;core::panic::unwind_safe::AssertUnwindSafe&lt;F&gt; as core::ops::function::FnOnce&lt;()&gt;&gt;::call_once
             at /rustc/051478957371ee0084a7c0913941d2a8c4757bb9/library/core/src/panic/unwind_safe.rs:272:9
  47: std::panicking::try::do_call
             at /rustc/051478957371ee0084a7c0913941d2a8c4757bb9/library/std/src/panicking.rs:559:40
  48: __rust_try
  49: std::panicking::try
             at /rustc/051478957371ee0084a7c0913941d2a8c4757bb9/library/std/src/panicking.rs:523:19
  50: std::panic::catch_unwind
             at /rustc/051478957371ee0084a7c0913941d2a8c4757bb9/library/std/src/panic.rs:149:14
  51: salsa::cycle::Cycle::catch
             at /home/micha/.cargo/git/checkouts/salsa-fa0738f776139e4c/ece083e/src/cycle.rs:42:15
  52: salsa::function::execute::&lt;impl salsa::function::IngredientImpl&lt;C&gt;&gt;::execute
             at /home/micha/.cargo/git/checkouts/salsa-fa0738f776139e4c/ece083e/src/function/execute.rs:46:27
  53: salsa::function::fetch::&lt;impl salsa::function::IngredientImpl&lt;C&gt;&gt;::fetch_cold
             at /home/micha/.cargo/git/checkouts/salsa-fa0738f776139e4c/ece083e/src/function/fetch.rs:104:14
  54: salsa::function::fetch::&lt;impl salsa::function::IngredientImpl&lt;C&gt;&gt;::compute_value::{{closure}}
             at /home/micha/.cargo/git/checkouts/salsa-fa0738f776139e4c/ece083e/src/function/fetch.rs:46:29
  55: core::option::Option&lt;T&gt;::or_else
             at /rustc/051478957371ee0084a7c0913941d2a8c4757bb9/library/core/src/option.rs:1515:21
  56: salsa::function::fetch::&lt;impl salsa::function::IngredientImpl&lt;C&gt;&gt;::compute_value
             at /home/micha/.cargo/git/checkouts/salsa-fa0738f776139e4c/ece083e/src/function/fetch.rs:44:34
  57: salsa::function::fetch::&lt;impl salsa::function::IngredientImpl&lt;C&gt;&gt;::fetch
             at /home/micha/.cargo/git/checkouts/salsa-fa0738f776139e4c/ece083e/src/function/fetch.rs:21:13
  58: red_knot_workspace::workspace::check_file::{{closure}}
             at /home/micha/.cargo/git/checkouts/salsa-fa0738f776139e4c/ece083e/components/salsa-macro-rules/src/setup_tracked_fn.rs:277:25
  59: salsa::attach::Attached::attach
             at /home/micha/.cargo/git/checkouts/salsa-fa0738f776139e4c/ece083e/src/attach.rs:71:9
  60: salsa::attach::attach::{{closure}}
             at /home/micha/.cargo/git/checkouts/salsa-fa0738f776139e4c/ece083e/src/attach.rs:91:23
  61: std::thread::local::LocalKey&lt;T&gt;::try_with
             at /rustc/051478957371ee0084a7c0913941d2a8c4757bb9/library/std/src/thread/local.rs:283:12
  62: std::thread::local::LocalKey&lt;T&gt;::with
             at /rustc/051478957371ee0084a7c0913941d2a8c4757bb9/library/std/src/thread/local.rs:260:9
  63: salsa::attach::attach
             at /home/micha/.cargo/git/checkouts/salsa-fa0738f776139e4c/ece083e/src/attach.rs:91:5
  64: red_knot_workspace::workspace::check_file
             at /home/micha/.cargo/git/checkouts/salsa-fa0738f776139e4c/ece083e/components/salsa-macro-rules/src/setup_tracked_fn.rs:269:13
  65: red_knot_workspace::workspace::Package::check
             at ./crates/red_knot_workspace/src/workspace.rs:315:31
  66: red_knot_workspace::workspace::Workspace::check
             at ./crates/red_knot_workspace/src/workspace.rs:191:31
  67: red_knot_workspace::db::RootDatabase::check::{{closure}}
             at ./crates/red_knot_workspace/src/db.rs:60:27
  68: red_knot_workspace::db::RootDatabase::with_db::{{closure}}
             at ./crates/red_knot_workspace/src/db.rs:82:29
  69: std::panicking::try::do_call
             at /rustc/051478957371ee0084a7c0913941d2a8c4757bb9/library/std/src/panicking.rs:559:40
  70: __rust_try
  71: std::panicking::try
             at /rustc/051478957371ee0084a7c0913941d2a8c4757bb9/library/std/src/panicking.rs:523:19
  72: std::panic::catch_unwind
             at /rustc/051478957371ee0084a7c0913941d2a8c4757bb9/library/std/src/panic.rs:149:14
  73: salsa::cancelled::Cancelled::catch
             at /home/micha/.cargo/git/checkouts/salsa-fa0738f776139e4c/ece083e/src/cancelled.rs:36:15
  74: red_knot_workspace::db::RootDatabase::with_db
             at ./crates/red_knot_workspace/src/db.rs:82:9
  75: red_knot_workspace::db::RootDatabase::check
             at ./crates/red_knot_workspace/src/db.rs:60:9
  76: red_knot::MainLoop::main_loop::{{closure}}
             at ./crates/red_knot/src/main.rs:296:45
  77: &lt;core::panic::unwind_safe::AssertUnwindSafe&lt;F&gt; as core::ops::function::FnOnce&lt;()&gt;&gt;::call_once
             at /rustc/051478957371ee0084a7c0913941d2a8c4757bb9/library/core/src/panic/unwind_safe.rs:272:9
  78: std::panicking::try::do_call
             at /rustc/051478957371ee0084a7c0913941d2a8c4757bb9/library/std/src/panicking.rs:559:40
  79: __rust_try
  80: std::panicking::try
             at /rustc/051478957371ee0084a7c0913941d2a8c4757bb9/library/std/src/panicking.rs:523:19
  81: std::panic::catch_unwind
             at /rustc/051478957371ee0084a7c0913941d2a8c4757bb9/library/std/src/panic.rs:149:14
  82: rayon_core::unwind::halt_unwinding
             at /home/micha/.cargo/registry/src/index.crates.io-6f17d22bba15001f/rayon-core-1.12.1/src/unwind.rs:17:5
  83: rayon_core::registry::Registry::catch_unwind
             at /home/micha/.cargo/registry/src/index.crates.io-6f17d22bba15001f/rayon-core-1.12.1/src/registry.rs:367:27
  84: rayon_core::spawn::spawn_job::{{closure}}
             at /home/micha/.cargo/registry/src/index.crates.io-6f17d22bba15001f/rayon-core-1.12.1/src/spawn/mod.rs:97:13
  85: &lt;rayon_core::job::HeapJob&lt;BODY&gt; as rayon_core::job::Job&gt;::execute
             at /home/micha/.cargo/registry/src/index.crates.io-6f17d22bba15001f/rayon-core-1.12.1/src/job.rs:169:9
  86: rayon_core::job::JobRef::execute
             at /home/micha/.cargo/registry/src/index.crates.io-6f17d22bba15001f/rayon-core-1.12.1/src/job.rs:64:9
  87: rayon_core::registry::WorkerThread::execute
             at /home/micha/.cargo/registry/src/index.crates.io-6f17d22bba15001f/rayon-core-1.12.1/src/registry.rs:860:9
  88: rayon_core::registry::WorkerThread::wait_until_cold
             at /home/micha/.cargo/registry/src/index.crates.io-6f17d22bba15001f/rayon-core-1.12.1/src/registry.rs:794:21
  89: rayon_core::registry::WorkerThread::wait_until
             at /home/micha/.cargo/registry/src/index.crates.io-6f17d22bba15001f/rayon-core-1.12.1/src/registry.rs:769:13
  90: rayon_core::registry::WorkerThread::wait_until_out_of_work
             at /home/micha/.cargo/registry/src/index.crates.io-6f17d22bba15001f/rayon-core-1.12.1/src/registry.rs:818:9
  91: rayon_core::registry::main_loop
             at /home/micha/.cargo/registry/src/index.crates.io-6f17d22bba15001f/rayon-core-1.12.1/src/registry.rs:923:5
  92: rayon_core::registry::ThreadBuilder::run
             at /home/micha/.cargo/registry/src/index.crates.io-6f17d22bba15001f/rayon-core-1.12.1/src/registry.rs:53:18
  93: &lt;rayon_core::registry::DefaultSpawn as rayon_core::registry::ThreadSpawn&gt;::spawn::{{closure}}
             at /home/micha/.cargo/registry/src/index.crates.io-6f17d22bba15001f/rayon-core-1.12.1/src/registry.rs:98:20
note: Some details are omitted, run with `RUST_BACKTRACE=full` for a verbose backtrace.
Rayon: detected unexpected panic; aborting
fish: Job 1, 'RUST_BACKTRACE=1 cargo run --biâ€¦' terminated by signal SIGABRT (Abort)
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @MichaReiser on 2024-08-20 15:17</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">help wanted</span> added by @MichaReiser on 2024-08-20 15:17</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by @MichaReiser on 2024-08-20 15:17</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dylwil3">@dylwil3</a> on 2024-08-21 19:09</div>
            <div class="timeline-body"><p>I think the issue is the walrus operator, not the match guard. Adding just this to the test corpus causes a panic (from a missing key in the <code>expressions</code> hashmap for the <code>TypeInference</code> struct):</p>
<pre><code class="language-python">x = 0
if x := x+1:
    pass
</code></pre>
<p>If it's helpful it seems like the missing scoped expression id is exactly one larger than the the largest scoped expression ids appearing as keys.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-08-21 19:16</div>
            <div class="timeline-body"><p>Oh interesting. I suspect we miss to visit the name or value. Are interested in taking this one?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dylwil3">@dylwil3</a> on 2024-08-21 19:16</div>
            <div class="timeline-body"><p>Maybe this is the culprit? Should something be added to <code>expressions</code> as well as <code>definitions</code>?</p>
<p>https://github.com/astral-sh/ruff/blob/dce87c21fdf73a58f3821cae5e71b9da234e29ce/crates/red_knot_python_semantic/src/types/infer.rs#L1448-L1465</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dylwil3">@dylwil3</a> on 2024-08-21 19:18</div>
            <div class="timeline-body"><p>Sure I can try but I imagine I'll be slower to fix it than you - red knot feels more like the <a href="https://en.wikipedia.org/wiki/Gordian_Knot">Gordian knot</a> to me at the moment ðŸ˜„</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-08-21 19:20</div>
            <div class="timeline-body"><p>infer_expression should add an entry into expressions. Not quite sure what's off</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-08-21 19:25</div>
            <div class="timeline-body"><p>I don't think it matters but the semantic index builder visits target and value in the opposite order</p>
<p>https://github.com/astral-sh/ruff/blob/dce87c21fdf73a58f3821cae5e71b9da234e29ce/crates/red_knot_python_semantic/src/semantic_index/builder.rs#L640</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-08-21 19:26</div>
            <div class="timeline-body"><blockquote>
<p>Sure I can try but I imagine I'll be slower to fix it than you - red knot feels more like the <a href="https://en.wikipedia.org/wiki/Gordian_Knot">Gordian knot</a> to me at the moment ðŸ˜„</p>
</blockquote>
<p>Haha ðŸ˜†. Yeah debugging missing expressions is a bit of a pain. Don't feel pressured into doing it but if you're interested go for it. We're happy to help</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2024-08-22 01:49</div>
            <div class="timeline-body"><p>It has something to do with the self-referential named expression; <code>x := 1</code> doesn't trigger it, but <code>x := x + 1</code> (or Micha's original <code>x := x[0]</code>) does.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "Red knot panics checking a match case with an `if` guard" to "Red knot panics checking some named expressions" by @carljm on 2024-08-22 01:51</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dylwil3">@dylwil3</a> on 2024-08-22 02:42</div>
            <div class="timeline-body"><p>As far as I can tell, while trying to infer types for the right hand side of <code>x := x+1</code>, type inference enters this function (specifically, while accounting for the <code>x</code> on the right hand side):</p>
<p>https://github.com/astral-sh/ruff/blob/8144a11f98032a1f109f557fbd5c8379364230b6/crates/red_knot_python_semantic/src/types/infer.rs#L83-L98</p>
<p>and then some failure must occur because it winds up in recovery:</p>
<p>https://github.com/astral-sh/ruff/blob/8144a11f98032a1f109f557fbd5c8379364230b6/crates/red_knot_python_semantic/src/types/infer.rs#L68-L78</p>
<p>which is presumably why the key never gets added?</p>
<p>But to go further than that I think I'll have to take a detour and try to learn about salsa...</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-08-22 03:31</div>
            <div class="timeline-body"><blockquote>
<p>But to go further than that I think I'll have to take a detour and try to learn about salsa...</p>
</blockquote>
<p>I think it might be also useful to look at the <code>SemanticIndexBuilder</code> alongside <code>TypeInferenceBuilder</code>. You can refer to the <a href="https://github.com/astral-sh/ruff/blob/main/crates/red_knot/docs/tracing.md">tracing docs</a> to turn on verbose logging. I'd also look at which expression it's failing to lookup and verify whether the semantic index that's built is correct or not by adding some <code>println</code> here and then basically follow the code path:</p>
<p>https://github.com/astral-sh/ruff/blob/1a8f29ea4141468f1772ff4e87da05b234a17ac2/crates/red_knot_python_semantic/src/semantic_model.rs#L55-L64</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2024-08-22 03:50</div>
            <div class="timeline-body"><p>The &quot;recovery&quot; here is recovering from a query cycle. The cycle might involve the definition of x and the use of x in the named expr (ie the definition wrongly ends up being visible to the use in the same expression?), or the cycle might involve the type of the if's test expression being resolved as a Constraint.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dylwil3">@dylwil3</a> on 2024-08-22 03:55</div>
            <div class="timeline-body"><blockquote>
<p>The &quot;recovery&quot; here is recovering from a query cycle. The cycle might involve the definition of x and the use of x in the named expr (ie the definition wrongly ends up being visible to the use in the same expression?), or the cycle might involve the type of the if's test expression being resolved as a Constraint.</p>
</blockquote>
<p>In case it helps narrow it down, a more minimal example is just:</p>
<pre><code class="language-python">x = 0
(x := x + 1)
</code></pre>
<p>So I think it's <code>x</code> vs <code>x</code> in the named expression that's causing a cycle.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dylwil3">@dylwil3</a> on 2024-08-22 04:14</div>
            <div class="timeline-body"><p>Is this related to the issue Carl and Micha discussed in this thread: https://salsa.zulipchat.com/#narrow/stream/333573-salsa-3.2E0/topic/fixpoint.20cycle.20recovery ? Was a resolution ever found to the examples brought up there?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2024-08-22 04:33</div>
            <div class="timeline-body"><p>We don't have a solution for those examples yet, but it shouldn't matter to this case. There shouldn't be any cycle here; the use of <code>x</code> on the RHS is evaluated first and doesn't see the definition it is part of. So there's a bug in the construction of the <code>UseDefMap</code> here and once it's fixed there shouldn't be any cycle in this example.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2024-08-22 04:40</div>
            <div class="timeline-body"><p>On my phone, but pretty sure the bug is in <code>SemanticIndexBuilder::visit_expr</code> in the case for <code>NamedExpr</code>; we are visiting the target (and thus creating the Definition) first, and then visiting the RHS. This is backwards and wrongly causes the definition to be visible to the RHS. We should instead visit the RHS first, just like at runtime the RHS is evaluated before the assignment occurs.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dylwil3">@dylwil3</a> on 2024-08-22 11:56</div>
            <div class="timeline-body"><p>You were right! Should've tried that first since @MichaReiser pointed to the same spot way at the beginning ðŸ˜„</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @carljm on 2024-08-22 14:59</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @carljm on 2024-08-22 14:59</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 16:50:56 UTC
    </footer>
</body>
</html>
