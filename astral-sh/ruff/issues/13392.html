<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ruff 0.6.5 occasionally panics when used as LSP inside Emacs - astral-sh/ruff #13392</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>ruff 0.6.5 occasionally panics when used as LSP inside Emacs</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/issues/13392">#13392</a>
        opened by <a href="https://github.com/offby1">@offby1</a>
        on 2024-09-18 13:18
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/offby1">@offby1</a></div>
            <div class="timeline-body"><ul>
<li>I searched for <code>in:title ruff in:title panic</code></li>
<li>I have no idea how to reproduce the bug; it seems to happen at random</li>
<li>Unfortunately I cannot provide a precise description of how I invoked ruff; it's starting as part of my absurdly complex Emacs setup. I have the emacs packages <code>lsp-mode</code>, <code>lsp-ui</code>, and <code>ruff-format</code> installed (among many others)</li>
<li><code>~/config/ruff/pyproject.toml</code> contains</li>
</ul>
<pre><code>[tool.ruff]
fix-only = true
line-length = 100

[tool.ruff.lint]
select = [&quot;ALL&quot;]
ignore = [&quot;ANN&quot;, &quot;COM812&quot;, &quot;D&quot;, &quot;ISC001&quot;, &quot;TD&quot;]
</code></pre>
<ul>
<li>the version is <code>ruff 0.6.5</code></li>
</ul>
<p>Here's the output I see:</p>
<pre><code>panicked at crates/ruff_source_file/src/line_index.rs:176:13:
index out of bounds: the len is 448 but the index is 450
   0: std::backtrace::Backtrace::create
   1: ruff_server::server::Server::run::{{closure}}
   2: std::panicking::rust_panic_with_hook
   3: std::panicking::begin_panic_handler::{{closure}}
   4: std::sys::backtrace::__rust_end_short_backtrace
   5: _rust_begin_unwind
   6: core::panicking::panic_fmt
   7: core::panicking::panic_bounds_check
   8: ruff_source_file::line_index::LineIndex::line_range
   9: &lt;lsp_types::Range as ruff_server::edit::range::RangeExt&gt;::to_text_range
  10: ruff_server::edit::text_document::TextDocument::apply_changes
  11: &lt;ruff_server::server::api::notifications::did_change::DidChange as ruff_server::server::api::traits::SyncNotificationHandler&gt;::run
  12: core::ops::function::FnOnce::call_once{{vtable.shim}}
  13: std::sys::backtrace::__rust_begin_short_backtrace
  14: core::ops::function::FnOnce::call_once{{vtable.shim}}
  15: std::sys::pal::unix::thread::Thread::new::thread_start
  16: __pthread_deallocate

panicked at /Users/runner/.cargo/registry/src/index.crates.io-6f17d22bba15001f/lsp-server-0.7.6/src/stdio.rs:28:37:
receiver was dropped, failed to send a message: &quot;SendError(..)&quot;
   0: std::backtrace::Backtrace::create
   1: ruff_server::server::Server::run::{{closure}}
   2: std::panicking::rust_panic_with_hook
   3: std::panicking::begin_panic_handler::{{closure}}
   4: std::sys::backtrace::__rust_end_short_backtrace
   5: _rust_begin_unwind
   6: core::panicking::panic_fmt
   7: core::result::unwrap_failed
   8: std::sys::backtrace::__rust_begin_short_backtrace
   9: core::ops::function::FnOnce::call_once{{vtable.shim}}
  10: std::sys::pal::unix::thread::Thread::new::thread_start
  11: __pthread_deallocate

panicked at /Users/runner/.cargo/registry/src/index.crates.io-6f17d22bba15001f/jod-thread-0.1.2/src/lib.rs:33:22:
called `Result::unwrap()` on an `Err` value: Any { .. }
   0: std::backtrace::Backtrace::create
   1: ruff_server::server::Server::run::{{closure}}
   2: std::panicking::rust_panic_with_hook
   3: std::panicking::begin_panic_handler::{{closure}}
   4: std::sys::backtrace::__rust_end_short_backtrace
   5: _rust_begin_unwind
   6: core::panicking::panic_fmt
   7: core::result::unwrap_failed
   8: ruff_server::server::Server::run
   9: ruff::run
  10: ruff::main
  11: std::sys::backtrace::__rust_begin_short_backtrace
  12: std::rt::lang_start::{{closure}}
  13: std::rt::lang_start_internal
  14: _main
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">server</span> added by @MichaReiser on 2024-09-18 15:21</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-09-18 15:21</div>
            <div class="timeline-body"><p>I wonder if this is related to https://github.com/emacs-lsp/lsp-mode/issues/4547</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-09-20 08:28</div>
            <div class="timeline-body"><p>@offby1 We released a new ruff version yesterday that might fix your issue. Could you give it a try</p>
<p>Lol... what a coincidence. The bug was an off by one error, and your handle is <code>offby1</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-10-04 04:51</div>
            <div class="timeline-body"><p>@offby1 Can you try upgrading Ruff to the latest version and see if the panic still persists?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/offby1">@offby1</a> on 2024-10-04 07:46</div>
            <div class="timeline-body"><p>I upgraded as soon as the new version was available, and haven't noticed a
problem since.  However, the original problem didn't occur all that often
to begin with.</p>
<p>On Thu, Oct 3, 2024 at 9:52 PM Dhruv Manilawala <em><strong>@</strong></em>.***&gt;
wrote:</p>
<blockquote>
<p>@offby1 <a href="https://github.com/offby1">https://github.com/offby1</a> Can you try upgrading Ruff to the
latest version and see if the panic still persists?</p>
<p>—
Reply to this email directly, view it on GitHub
<a href="https://github.com/astral-sh/ruff/issues/13392#issuecomment-2392817973">https://github.com/astral-sh/ruff/issues/13392#issuecomment-2392817973</a>,
or unsubscribe
<a href="https://github.com/notifications/unsubscribe-auth/AAAAYSLWD2CXTXXKLSTJ2ODZZYNIBAVCNFSM6AAAAABONVZTTKVHI2DSMVQWIX3LMV43OSLTON2WKQ3PNVWWK3TUHMZDGOJSHAYTOOJXGM">https://github.com/notifications/unsubscribe-auth/AAAAYSLWD2CXTXXKLSTJ2ODZZYNIBAVCNFSM6AAAAABONVZTTKVHI2DSMVQWIX3LMV43OSLTON2WKQ3PNVWWK3TUHMZDGOJSHAYTOOJXGM</a>
.
You are receiving this because you were mentioned.Message ID:
<em><strong>@</strong></em>.***&gt;</p>
</blockquote>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-10-04 09:00</div>
            <div class="timeline-body"><p>Thanks for the update. I'll mark this as resolved for now to keep the issue tracker actionable but feel free to ping me if you face the issue again, we can re-open the issue then.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @dhruvmanila on 2024-10-04 09:00</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 16:51:07 UTC
    </footer>
</body>
</html>
