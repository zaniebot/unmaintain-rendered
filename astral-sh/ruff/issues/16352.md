```yaml
number: 16352
title: "[red-knot] Make it easier to avoid typos in `<!-- snapshot-diagnostics -->` mdtest HTML comments"
type: issue
state: closed
author: AlexWaygood
labels:
  - testing
  - ty
assignees: []
created_at: 2025-02-24T18:28:19Z
updated_at: 2025-02-28T16:27:30Z
url: https://github.com/astral-sh/ruff/issues/16352
synced_at: 2026-01-10T01:56:55Z
```

# [red-knot] Make it easier to avoid typos in `<!-- snapshot-diagnostics -->` mdtest HTML comments

---

_Issue opened by @AlexWaygood on 2025-02-24 18:28_

### Description

I've been learning the hard way in #16321 (several times over...) that it's pretty easy to accidentally put `<!-- snpashot-diagnostics -->` or `<!--snapshot-diagnostics -->` in an mdtest ðŸ˜„ Either of these will result in the test snippet silently not generating any snapshots at all, leading you to think your test has been successful when in fact it never really ran at all. Maybe we should just reject all unrecognised HTML comments in an mdtest file?

Cc. @BurntSushi as the person who implemented the snapshotting feature for mdtest (not saying you need to necessarily take this on, though!)

---

_Label `testing` added by @AlexWaygood on 2025-02-24 18:28_

---

_Label `red-knot` added by @AlexWaygood on 2025-02-24 18:28_

---

_Comment by @BurntSushi on 2025-02-24 18:32_

Good point. An alternative to rejecting all HTML comments (which I could see being too aggressive) is to give _special_ comments a bit more structure. So for example, `<!-- directive: snapshot-diagnostics -->`. Then we could error for cases like `<!-- directive: snpashot-diagnostics -->`. Although, of course, a typo in `directive` itself would go unnoticed.

It might also be better to make recognition whitespace insensitive. e.g., `<!--snapshot-diagnostics-->` would be accepted.

---

_Comment by @AlexWaygood on 2025-02-25 19:02_

> rejecting all HTML comments (which I could see being too aggressive)

hmm, yes, it seems like we're already using some other HTML comments, to e.g. switch off the blacken-docs linter (since it can't handle invalid Python syntax):

https://github.com/astral-sh/ruff/blob/fa76f6cbb2c48f6fc020a00954841b6e5c71e531/crates/red_knot_python_semantic/resources/mdtest/suppressions/knot_ignore.md?plain=1#L73-L84

One solution could be to provide a whitelist of "known HTML comment directives", but that might be confusing to users and/or hard to maintain.

> An alternative to rejecting all HTML comments [...] is to give special comments a bit more structure. So for example, `<!-- directive: snapshot-diagnostics -->`. Then we could error for cases like `<!-- directive: snpashot-diagnostics -->`. Although, of course, a typo in `directive` itself would go unnoticed.

Hmm, not sure. I feel like one reason why this is already kinda typo-prone is that `snapshot-diagnostics` is already quite long (my bad I guess, since it was originally my suggestion ðŸ˜„). Making it even longer feels like it might go in the wrong direction.

> It might also be better to make recognition whitespace insensitive. e.g., `<!--snapshot-diagnostics-->` would be accepted.

Great idea! See https://github.com/astral-sh/ruff/pull/16380

---

_Referenced in [astral-sh/ruff#16426](../../astral-sh/ruff/pulls/16426.md) on 2025-02-27 22:53_

---

_Referenced in [astral-sh/ruff#16441](../../astral-sh/ruff/pulls/16441.md) on 2025-02-28 15:29_

---

_Closed by @AlexWaygood on 2025-02-28 16:27_

---
