<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>F401 false positive when using Jupyter line magic (`%timeit imported_thing()`) - astral-sh/ruff #10454</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>F401 false positive when using Jupyter line magic (<code>%timeit imported_thing()</code>)</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/ruff/issues/10454">#10454</a>
        opened by <a href="https://github.com/flying-sheep">@flying-sheep</a>
        on 2024-03-18 11:04
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/flying-sheep">@flying-sheep</a></div>
            <div class="timeline-body"><p>I searched for ‚Äútimeit F401‚Äù and didn‚Äôt find anything relevant.</p>
<p>Reproducer:</p>
<pre><code>import os

%timeit os.getcwd()
</code></pre>
<p>Will show a false positive of F401 (Unused import) for the <code>import os</code> line:</p>
<img alt="image" src="https://github.com/astral-sh/ruff/assets/291575/6cf0fda6-118d-4ec3-912f-2f6bf726a1da">

</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">rule</span> added by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-03-18 11:59</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">notebook</span> added by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-03-18 11:59</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">linter</span> added by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-03-18 12:00</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-03-18 14:50</div>
            <div class="timeline-body"><p>@dhruvmanila I assume this is due to today&#x27;s limitation where ruff doesn&#x27;t parse out anything coming after the magic command because it could, literally, be anything (a shell command).  Do you know if this is documented somewhere, if not, should we add it to the FAQ section?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/flying-sheep">@flying-sheep</a> on 2024-03-18 17:01</div>
            <div class="timeline-body"><p>That‚Äôs not true for all magics, some contain statements. E.g. <code>%time</code> only has a statement following, and <code>%timeit</code> is defined like</p>
<blockquote>
<p><code>%timeit [-n&lt;N&gt; -r&lt;R&gt; [-t|-c] -q -p&lt;P&gt; -o] statement</code></p>
</blockquote>
<p>So the statement could be parsed out.</p>
<p>Apart from <a href="https://ipython.readthedocs.io/en/stable/interactive/magics.html#magic-time"><code>%time</code></a> and <a href="https://ipython.readthedocs.io/en/stable/interactive/magics.html#magic-timeit"><code>%timeit</code></a>, the same applies only to <a href="https://ipython.readthedocs.io/en/stable/interactive/magics.html#magic-prun"><code>%prun</code></a> and <a href="https://ipython.readthedocs.io/en/stable/interactive/magics.html#magic-debug"><code>%debug</code></a> if I didn‚Äôt miss anything.</p>
<p>So all in all not too daunting.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-03-19 08:41</div>
            <div class="timeline-body"><blockquote>
<p>I assume this is due to today&#x27;s limitation where ruff doesn&#x27;t parse out anything coming after the magic command because it could, literally, be anything (a shell command).</p>
</blockquote>
<p>Yes, that&#x27;s correct.</p>
<blockquote>
<p>Do you know if this is documented somewhere, if not, should we add it to the FAQ section?</p>
</blockquote>
<p>I don&#x27;t think it&#x27;s documented anywhere except for in my comment here (<a href="https://github.com/astral-sh/ruff/issues/8354">astral-sh/ruff#8354</a>#issuecomment-1786380263).</p>
<p>We did introduce support for transparent cell magics (<a href="https://github.com/astral-sh/ruff/pull/8911">astral-sh/ruff#8911</a>), which means we only ignore the line where the magic command is defined, not the subsequent lines which might contain valid Python code.</p>
<blockquote>
<p>That‚Äôs not true for all magics, some contain statements. E.g. <code>%time</code> only has a statement following, and <code>%timeit</code> is defined like</p>
</blockquote>
<p>Thank you for pointing that out. We could potentially support selectively parsing out the code after a line magic but only if it doesn&#x27;t contain any options. This means that we could support <code>%time</code> but not <code>%timeit</code> for the reasons mentioned in the linked comment above.</p>
<blockquote>
<p>Apart from <a href="https://ipython.readthedocs.io/en/stable/interactive/magics.html#magic-time"><code>%time</code></a> and <a href="https://ipython.readthedocs.io/en/stable/interactive/magics.html#magic-timeit"><code>%timeit</code></a>, the same applies only to <a href="https://ipython.readthedocs.io/en/stable/interactive/magics.html#magic-prun"><code>%prun</code></a> and <a href="https://ipython.readthedocs.io/en/stable/interactive/magics.html#magic-debug"><code>%debug</code></a> if I didn‚Äôt miss anything.</p>
</blockquote>
<p><code>%prun</code> would be difficult because it can contain options, and the same goes for <code>%debug</code>, although it only has a single option (<code>--breakpoint</code>).</p>
<p>I quickly scanned through the line magic lists and the ones you&#x27;ve mentioned are the only ones which can have a statement or expression after the magic command.</p>
<p>While we could potentially support %time, it would necessitate significant changes in the AST representation to store the parsed-out statement or expression, as well as adjustments to the semantic model and any affected lint rules. However, I don&#x27;t believe it&#x27;s worth the effort for a single command, especially one typically used as a one-off command.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-03-19 08:41</div>
            <div class="timeline-body"><p>We should update the documentation to make this clear.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">rule</span> removed by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-03-19 08:41</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">documentation</span> added by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-03-19 08:41</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/flying-sheep">@flying-sheep</a> on 2024-03-19 09:40</div>
            <div class="timeline-body"><blockquote>
<p>but only if it doesn&#x27;t contain any options</p>
</blockquote>
<p>why add this limitation if we could just parse the options?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-03-19 13:19</div>
            <div class="timeline-body"><p>We can do that, but it requires writing a parser for the options and keeping that up-to-date with any changes in Jupyter.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/flying-sheep">@flying-sheep</a> on 2024-03-19 16:12</div>
            <div class="timeline-body"><p>That could end up being easy, depending on two factors:</p>
<ol>
<li>are we able to reliably grab a magic expression from the Python parser and then call a function on the resulting slice? Then we can just run one of Rust‚Äôs existing high-quality CLI parsers, let it tell us how long the prefix of the slice is that‚Äôs options, and then try to parse the remainder as Python.</li>
<li>Does jupyter change these magics frequently enough that that‚Äôs a concern? And even if so, they probably just add options, so we could simply wait for someone running into a problem and then updating the option parser.</li>
</ol>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-03-19 17:08</div>
            <div class="timeline-body"><p>I support doing it, it&#x27;s just work that someone needs to do :)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-03-20 03:09</div>
            <div class="timeline-body"><p>One concern with this approach, and maybe it&#x27;s not really a big problem, is that how do we differentiate between an option and something which looks similar to an option in the Python statement (<code>%timeit -n 10 x-n</code>).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/flying-sheep">@flying-sheep</a> on 2024-03-20 12:42</div>
            <div class="timeline-body"><p>By doing what I proposed üòâ</p>
<p>there&#x27;s no ambiguity if we know which options exist and which ones take a parameter and which ones don&#x27;t.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 18:48:51 UTC
    </footer>
</body>
</html>
