<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ensure Ruff Format handles gettext comments correctly - astral-sh/ruff #12180</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Ensure Ruff Format handles gettext comments correctly</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/ruff/issues/12180">#12180</a>
        opened by <a href="https://github.com/seanbudd">@seanbudd</a>
        on 2024-07-04 05:21
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/seanbudd">@seanbudd</a></div>
            <div class="timeline-body">issue
<p>Python code using gettext <a href="https://www.gnu.org/software/gettext/manual/html_node/xgettext-Invocation.html#Operation-mode">comments</a> can associate in-line comments with gettext. Like this:</p>
<pre><code># Translators: foo is programming term to represent a sample string
_(&quot;Foo&quot;)

_(
  # Translators: foo is programming term to represent a sample string
  &quot;Foo&quot;
)

pgettext(
  &quot;sampleStrings&quot;,
  # Translators: foo is programming term to represent a sample string
  &quot;Foo&quot;
)
</code></pre>
<p><code>ruff format</code> will reformat something like this</p>
<pre><code># Translators: foo is programming term to represent a sample string
(_(&quot;Foo&quot;), &quot;reallylongstringlongerthanlinelength&quot;)

# Translators: foo is programming term to represent a sample string
_(&quot;foo, reallylongstringlongerthanlinelength&quot;)

# Translators: foo is programming term to represent a sample string
pgettext(&quot;tag&quot;, &quot;foo, reallylongstringlongerthanlinelength&quot;)
</code></pre>
<p>to</p>
<pre><code># Translators: foo is programming term to represent a sample string
(
   _(&quot;Foo&quot;),
  &quot;reallylongstringlongerthanlinelength&quot;
)

# Translators: foo is programming term to represent a sample string
_(
   &quot;foo, reallylongstringlongerthanlinelength&quot;
)

# Translators: foo is programming term to represent a sample string
pgettext(
  &quot;tag&quot;,
  &quot;foo, reallylongstringlongerthanlinelength&quot;
)
</code></pre>
<p>instead of the expected</p>
<pre><code>(
   # Translators: foo is programming term to represent a sample string
   _(&quot;Foo&quot;),
  &quot;reallylongstringlongerthanlinelength&quot;
)

_(
   # Translators: foo is programming term to represent a sample string
   &quot;foo, reallylongstringlongerthanlinelength&quot;
)

pgettext(
  &quot;tag&quot;,
  # Translators: foo is programming term to represent a sample string
  &quot;foo, reallylongstringlongerthanlinelength&quot;
)
</code></pre>
Suggested fix
<p>expand the <code>flake8-gettext</code> config to set a translator comment flag e.g. &quot;Translators:&quot;
If this is set, move any comments while formatting, to keep the comments on the line above the target string.</p>
keywords
<p>gettext, translators, translations, translate, i18n, l10n, format, comments</p>
last tested ruff version
<p>v0.5.0</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-07-04 06:37</div>
            <div class="timeline-body"><p>Hmm interesting. I can see how this is frustrating. Do I understand it correctly that this is an opt-in feature for <code>gettext</code>?</p>
<p>I&#x27;m hesitant to add support for this because:</p>
<ul>
<li>It would need to be an opt-in feature</li>
<li>The formatter currently doesn&#x27;t know if e.g. <code>_</code> is a gettext call. We could use some very cheap heuristics based on the function names but that won&#x27;t be bullet prove (another reason to make this opt-in)</li>
<li>Comments are hard and it being an opt-in feature means we&#x27;ll get almost zero test exposure.</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">formatter</span> added by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-07-04 06:37</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">style</span> added by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-07-04 06:37</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/seanbudd">@seanbudd</a> on 2024-07-04 07:06</div>
            <div class="timeline-body"><p>Yes this is an opt-in part of gettext, it is fairly commonly used though.</p>
<p>I agree it should be an opt-in feature, but I think you&#x27;ll get more than zero exposure as this style for gettext usage isn&#x27;t exactly uncommon. I do agree though outside of basic unit tests it will be hard to truly be certain about every edge case.
I think there is already some level of tracking of function names in flake8-gettext rules e.g. https://github.com/astral-sh/ruff/blob/3ce8b9fcae66435285e6cd3d9259912a1f5c4768/crates/ruff_linter/src/rules/flake8_gettext/settings.rs#L14</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 18:48:55 UTC
    </footer>
</body>
</html>
