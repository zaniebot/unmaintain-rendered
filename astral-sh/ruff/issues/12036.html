<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Re-lexing should avoid line continuation in a comment - astral-sh/ruff #12036</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Re-lexing should avoid line continuation in a comment</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/issues/12036">#12036</a>
        opened by <a href="https://github.com/dhruvmanila">@dhruvmanila</a>
        on 2024-06-26 03:22
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a></div>
            <div class="timeline-body"><p>Even with the fix in https://github.com/astral-sh/ruff/pull/12035, we still need to consider the fact that the line continuation character could be part of the comment which means that the newline character is not being escaped.</p>
<p>This won't create a panic but the lexer won't be moved back and keep the <code>NonLogicalNewline</code> token instead of changing it to <code>Newline</code> token.</p>
<p>For example:</p>
<pre><code class="language-py">if call(foo # comment \
   def foo():
       pass
</code></pre>
<p>This will emit the following tokens:</p>
<pre><code>If 0..2
Name 3..7
Lpar 7..8
Name 8..11
Comment 12..23
NonLogicalNewline 23..24 &lt;- this should've been a Newline token
Def 28..31
Name 32..35
Lpar 35..36
Rpar 36..37
Colon 37..38
Newline 38..39
Indent 39..47
Pass 47..51
Newline 51..52
Dedent 52..52
</code></pre>
<p>One solution would be to update <code>TokenSource</code> to pass in the last comment token range to re-lexing method on the lexer which can be used to check if this line continuation is part of the comment or not.</p>
<p>This is backwards lexing all over again :)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @dhruvmanila on 2024-06-26 03:22</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">parser</span> added by @dhruvmanila on 2024-06-26 03:22</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-06-26 05:28</div>
            <div class="timeline-body"><p>Would it help if the lexer remebered the previous token kind? It could then test if the previous kind was a non logical newline and only then do the relexing?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-06-26 10:49</div>
            <div class="timeline-body"><p>As you've mentioned in your <a href="https://github.com/astral-sh/ruff/pull/12035#pullrequestreview-2140839786">comment in the PR</a>, I don't think so that would be sufficient.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-06-26 10:51</div>
            <div class="timeline-body"><p>Yeah. I kind of want to avoid that we need to re-implement the entire lexing. Ideally, we could just look at the previous tokens and use that information to make a decision.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-06-26 11:49</div>
            <div class="timeline-body"><blockquote>
<p>One solution would be to update <code>TokenSource</code> to pass in the last comment token range to re-lexing method on the lexer which can be used to check if this line continuation is part of the comment or not.</p>
</blockquote>
<p>Do you think this is a better idea? I'm unsure about the split logic.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-06-26 11:55</div>
            <div class="timeline-body"><p>I'm open to pass information from the <code>TokenSource</code> to the <code>Lexer</code>. I'm unsure if it should be the comment because that still requires duplicating the line continuation etc logic. Maybe we could just pass the position of the last <code>NonLogicalNewline</code> where last means, the last before any non-trivia token? But I would need to have a closer look at the implementation again to fully understand what information we need.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-06-27 03:42</div>
            <div class="timeline-body"><blockquote>
<p>Maybe we could just pass the position of the last <code>NonLogicalNewline</code> where last means, the last before any non-trivia token?</p>
</blockquote>
<p>I literally woke up in the morning thinking about this lol. I think this could work and should simplify the implementation. Let me try it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @dhruvmanila by @dhruvmanila on 2024-06-27 03:42</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @dhruvmanila on 2024-06-27 11:42</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @dhruvmanila on 2024-06-27 11:42</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 16:50:31 UTC
    </footer>
</body>
</html>
