<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Support an allowlist of function calls in argument defaults for B008 - astral-sh/ruff #3762</title>
    <link rel="stylesheet" href="../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../index.html">Back to index</a>
    </div>

    <h1>Support an allowlist of function calls in argument defaults for B008</h1>

    <div class="meta">
        <span class="state state-closed">Closed</span>
        <a href="https://github.com/astral-sh/ruff/issues/3762">#3762</a>
        opened by <a href="https://github.com/rouge8">@rouge8</a>
        on 2023-03-27 20:00
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/rouge8">@rouge8</a> on 2023-03-27 20:00</div>
            <div class="timeline-body"><p>It would be great if B008 supported an allowlist of function calls, similar to <code>extend-immutable-calls</code> for B006. We do a lot of this in our code which as far as I know has no subtle bugs:</p>
<pre><code class="language-python">def f(x=Decimal(&quot;1000&quot;)):
    pass
</code></pre>
<p>Or maybe it's worth hardcoding <code>Decimal</code> as an exception?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-03-27 20:12</div>
            <div class="timeline-body"><p>Yeah perhaps we add that to the list of <code>IMMUTABLE_FUNCS</code> in <code>crates/ruff/src/rules/flake8_bugbear/rules/function_call_argument_default.rs</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">rule</span> added by @charliermarsh on 2023-03-27 20:12</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/JonathanPlasse">@JonathanPlasse</a> on 2023-03-27 20:16</div>
            <div class="timeline-body"><p>It could be a good first issue.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">good first issue</span> added by @charliermarsh on 2023-03-27 20:18</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/rouge8">@rouge8</a> on 2023-03-27 20:34</div>
            <div class="timeline-body"><blockquote>
<p>Yeah perhaps we add that to the list of <code>IMMUTABLE_FUNCS</code> in <code>crates/ruff/src/rules/flake8_bugbear/rules/function_call_argument_default.rs</code>.</p>
</blockquote>
<p>I think it's probably worth doing that and adding an allowlist. Looking at our codebase, we have some custom functions we'd want to allow while still benefiting from flagging this in general.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/3764.html">astral-sh/ruff#3764</a> on 2023-03-27 20:55</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/rouge8">@rouge8</a> on 2023-03-27 20:55</div>
            <div class="timeline-body"><p>Okay, I opened https://github.com/charliermarsh/ruff/pull/3764 adding a few more immutable functions. I can work on another PR adding a setting if you're open to that!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/rouge8">@rouge8</a> on 2023-03-28 16:18</div>
            <div class="timeline-body"><p>Oh wait, reading the code, it looks like B008 might already support <code>extend-immutable-calls</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-03-28 16:20</div>
            <div class="timeline-body"><p>Oh wait, you're right...</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/rouge8">@rouge8</a> on 2023-03-28 16:20</div>
            <div class="timeline-body"><p>Hmm and I don't see it used in https://github.com/charliermarsh/ruff/blob/main/crates/ruff/src/rules/flake8_bugbear/rules/mutable_argument_default.rs ? Is the doc saying it's used for B006 wrong and it's actually used for B008?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-03-28 16:22</div>
            <div class="timeline-body"><p>Yeah something's a bit off between these.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/aberres">@aberres</a> on 2023-03-29 10:23</div>
            <div class="timeline-body"><p>@rouge8 <code>pathlib.Path</code> is another candidate. See https://peps.python.org/pep-0428/#immutability</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/3794.html">astral-sh/ruff#3794</a> on 2023-03-29 14:07</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/rouge8">@rouge8</a> on 2023-03-29 14:07</div>
            <div class="timeline-body"><blockquote>
<p>@rouge8 <code>pathlib.Path</code> is another candidate. See https://peps.python.org/pep-0428/#immutability</p>
</blockquote>
<p>Good catch! Added it in https://github.com/charliermarsh/ruff/pull/3794</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/JonathanPlasse">@JonathanPlasse</a> on 2023-03-29 19:04</div>
            <div class="timeline-body"><p>Why not <code>(Pure)(Posix|Windows)Path</code> too?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">accepted</span> added by @charliermarsh on 2023-07-10 01:29</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Apakottur">@Apakottur</a> on 2023-07-19 16:43</div>
            <div class="timeline-body"><p>So at this point should it be possible to use <code>extend-immutable-calls</code> for B008?
I have the following code:</p>
<pre><code class="language-python"># test.py
from typing import TypeAlias

MyTypeAlias: TypeAlias = str

def func(
    x: str = str(&quot;default&quot;),
    y: str = MyTypeAlias(&quot;default&quot;),
):
    return x + y
</code></pre>
<pre><code class="language-toml"># ruff.toml
[flake8-bugbear]
extend-immutable-calls = [&quot;MyTypeAlias&quot;]
</code></pre>
<p>And running <code>ruff check --config ruff.toml --select B008 test.py</code> still gives me:</p>
<pre><code class="language-shell">test.py:9:14: B008 Do not perform function call `MyTypeAlias` in argument defaults
Found 1 error.
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-07-19 17:05</div>
            <div class="timeline-body"><p>It should work for B008 if you use a fully-qualified path to the symbol, rather than the string name. For example:</p>
<pre><code class="language-toml">[flake8-bugbear]
extend-immutable-calls = [&quot;path.to.module.MyTypeAlias&quot;]
</code></pre>
<p>Unfortunately, that won't work for symbols defined in the file in which they're used -- they have to be imported from another file. It's just a limitation which we'll resolve eventually (#5486).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-07-19 17:09</div>
            <div class="timeline-body"><p>Unrelatedly, looking back at this issue, I see a few touch-ups we can do:</p>
<ul>
<li>B008 could ignore arguments with immutable annotations.</li>
<li>B006 could consider <code>extend_immutable_calls</code> when determining whether an annotation is immutable.</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/6781.html">astral-sh/ruff#6781</a> on 2023-08-22 16:45</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/6784.html">astral-sh/ruff#6784</a> on 2023-08-22 17:33</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2023-08-23 15:52</div>
            <div class="timeline-body"><p><code>B008</code> already supports this so I'm going to close this issue.</p>
<p>I've also added the improvements that Charlie suggested in #6781 and #6784</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @zanieb on 2023-08-23 15:52</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:28:08 UTC
    </footer>
</body>
</html>
