<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>`SIM118` fix incorrectly removes `.keys()` from `xml.etree.ElementTree` object - astral-sh/ruff #6305</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1><code>SIM118</code> fix incorrectly removes <code>.keys()</code> from <code>xml.etree.ElementTree</code> object</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/issues/6305">#6305</a>
        opened by <a href="https://github.com/bouwew">@bouwew</a>
        on 2023-08-03 14:54
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/bouwew">@bouwew</a></div>
            <div class="timeline-body">

<p>As defined here: https://docs.python.org/3/library/xml.etree.elementtree.html the <code>.keys()</code> element object is a valid one and differs from the dict <code>.keys()</code> object.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2023-08-03 14:56</div>
            <div class="timeline-body"><p>Hey @bouwew could you please include a code example as well as the rule code that&#x27;s removing the <code>keys()</code> call?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/bouwew">@bouwew</a> on 2023-08-03 14:57</div>
            <div class="timeline-body"><pre><code>    def _preset(self, loc_id: str) -&gt; str | None:
        &quot;&quot;&quot;Helper-function for smile.py: device_data_climate().

        Collect the active preset based on Location ID.
        &quot;&quot;&quot;
        locator = &quot;./rule[active=&#x27;true&#x27;]/directives/when/then&quot;
        if (
            active_rule := self._domain_objects.find(locator)
        ) is None or &quot;icon&quot; not in active_rule.keys():  # noqa: SIM118
            return None
        return str(active_rule.attrib[&quot;icon&quot;])
</code></pre>
<p><code>self._domain_objects</code> contains xml-data. It&#x27;s typed as <code>etree</code>, from <code>from defusedxml import ElementTree as etree</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-08-03 15:01</div>
            <div class="timeline-body"><p>IMO this is unavoidable without incorporating a full type inference engine. It will likely be a known bug for a while. Adding fix levels will help, since this fix is already marked as possibly-unsafe.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-08-03 15:02</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">type-inference</span> added by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-08-03 15:02</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/bouwew">@bouwew</a> on 2023-08-03 15:03</div>
            <div class="timeline-body"><p>I think I could use <code>.items()</code> as a work-around I&#x27;ve found in the meantime, so not a big problem :)</p>
<p>Tnx for the quick responses!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from &quot;BUG: ruff removes the .keys() extention incorrectly when used with xml.etree.ElementTree&quot; to &quot;`SIM118` fix incorrectly removes `.keys()` from `xml.etree.ElementTree` object&quot; by <a href="https://github.com/zanieb">@zanieb</a> on 2023-08-03 15:15</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-12-07 14:48</div>
            <div class="timeline-body"><p>We now mark this as unsafe if the object isn&#x27;t a dictionary.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-12-07 14:48</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 18:48:40 UTC
    </footer>
</body>
</html>
