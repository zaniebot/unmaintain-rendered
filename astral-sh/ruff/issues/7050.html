<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formatter removes parentheses around call chaining - astral-sh/ruff #7050</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Formatter removes parentheses around call chaining</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/issues/7050">#7050</a>
        opened by <a href="https://github.com/cnpryer">@cnpryer</a>
        on 2023-09-01 19:51
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/cnpryer">@cnpryer</a></div>
            <div class="timeline-body"><p>Version: ruff 0.0.287</p>
<p>Line-length: 88</p>
<p>Related: #5343</p>
<p>My team does a lot of exploratory scripting with Pandas (most are analysts, not developers), so often some analysts will chain together Pandas methods for SQL-like operations.</p>
<p>Note that the removed parentheses still results in valid Python. I actually prefer this change since the expression is already wrapped by <code>pd.concat</code> and shouldn&#x27;t confuse the original author or subsequent readers. The removed parentheses, IMO, are redundant (see <code>(...).groupby(..)</code>).</p>
<p>I figured this kind of code is probably common outside the current ecosystem checks (and in Python&#x27;s data analysis world), especially with Pandas users.</p>
<p>The following is an example of a diff snippet from one of our repositories:</p>
<p>Input, formatted with <code>black</code> (23.7.0):</p>
<pre><code>merged = pd.concat(
    [
        df1_aaaaaaaaaaaa[
            df1_aaaaaaaaaaaa[&quot;a&quot;].isin([&quot;aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa&quot;])
        ],
        (
            df1_aaaaaaaaaaaa.loc[
                df1_aaaaaaaaaaaa[&quot;a&quot;] == &quot;aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa&quot;,
                [
                    &quot;aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa&quot;,
                    &quot;aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa&quot;,
                    &quot;aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa&quot;,
                    &quot;aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa&quot;,
                ],
            ]
            .merge(
                df2_aaaaaaaaaaaa[[&quot;aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa&quot;]],
                on=[&quot;aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa&quot;],
                how=&quot;a&quot;,
                validate=&quot;a&quot;,
            )
            .drop(columns=[&quot;a&quot;])
            .merge(
                df3_aaaaaaaaaaaa[
                    [
                        &quot;aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa&quot;,
                        &quot;aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa&quot;,
                        &quot;aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa&quot;,
                    ]
                ],
                on=[&quot;aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa&quot;],
                how=&quot;a&quot;,
                validate=&quot;a&quot;,
            )
        )
        .groupby(
            [
                &quot;aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa&quot;,
                &quot;aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa&quot;,
                &quot;aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa&quot;,
            ]
        )
        .sum()
        .reset_index(),
    ]
)
</code></pre>
<p><code>ruff format</code> diff:</p>
<pre><code>diff --git a/scratch.py b/scratch.py
index d2ee558..2e4900c 100644
--- a/scratch.py
+++ b/scratch.py
@@ -3,35 +3,33 @@ merged = pd.concat(
         df1_aaaaaaaaaaaa[
             df1_aaaaaaaaaaaa[&quot;a&quot;].isin([&quot;aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa&quot;])
         ],
-        (
-            df1_aaaaaaaaaaaa.loc[
-                df1_aaaaaaaaaaaa[&quot;a&quot;] == &quot;aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa&quot;,
+        df1_aaaaaaaaaaaa.loc[
+            df1_aaaaaaaaaaaa[&quot;a&quot;] == &quot;aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa&quot;,
+            [
+                &quot;aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa&quot;,
+                &quot;aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa&quot;,
+                &quot;aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa&quot;,
+                &quot;aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa&quot;,
+            ],
+        ]
+        .merge(
+            df2_aaaaaaaaaaaa[[&quot;aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa&quot;]],
+            on=[&quot;aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa&quot;],
+            how=&quot;a&quot;,
+            validate=&quot;a&quot;,
+        )
+        .drop(columns=[&quot;a&quot;])
+        .merge(
+            df3_aaaaaaaaaaaa[
                 [
                     &quot;aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa&quot;,
                     &quot;aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa&quot;,
                     &quot;aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa&quot;,
-                    &quot;aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa&quot;,
-                ],
-            ]
-            .merge(
-                df2_aaaaaaaaaaaa[[&quot;aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa&quot;]],
-                on=[&quot;aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa&quot;],
-                how=&quot;a&quot;,
-                validate=&quot;a&quot;,
-            )
-            .drop(columns=[&quot;a&quot;])
-            .merge(
-                df3_aaaaaaaaaaaa[
-                    [
-                        &quot;aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa&quot;,
-                        &quot;aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa&quot;,
-                        &quot;aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa&quot;,
-                    ]
-                ],
-                on=[&quot;aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa&quot;],
-                how=&quot;a&quot;,
-                validate=&quot;a&quot;,
-            )
+                ]
+            ],
+            on=[&quot;aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa&quot;],
+            how=&quot;a&quot;,
+            validate=&quot;a&quot;,
         )
         .groupby(
             [
</code></pre>
<p>Playground: https://play.ruff.rs/11aa202b-fee6-4a8f-bc61-330acffeca9c</p>
<p>More to come :)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/cnpryer">@cnpryer</a> on 2023-09-01 20:11</div>
            <div class="timeline-body"><p>Maybe related  #6933</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">formatter</span> added by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-09-01 22:59</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-09-01 23:03</div>
            <div class="timeline-body"><p>Interesting, it looks like Black will preserve parentheses around the first part of a call chain, no matter how many components are included in the parentheses (<a href="https://black.vercel.app/?version=main&amp;state=_Td6WFoAAATm1rRGAgAhARYAAAB0L-Wj4AHbAIddAD2IimZxl1N_Wlji3aLIjlAOoWjeEBM_F5fqvT7g4nY6QiR8pVSCOPgD44-SaGL5PbocOIP6NQZMPSK8SFhNN06cxWVwWuDWlI2WmXhzZ7K8kZ-dHMf0jpKCvDhl1OHtqjoKznQG_SDlibf4R52k--a-wiJtLYTwr-EbZE3gsW-s2c1DE7yAAAAATCpVExpiO78AAaMB3AMAAFUmeQ-xxGf7AgAAAAAEWVo=">example</a>). Not obvious to me whether we want to preserve this or not.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to <a href="https://github.com/charliermarsh">@charliermarsh</a> by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-09-01 23:22</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/cnpryer">@cnpryer</a> on 2023-09-02 01:25</div>
            <div class="timeline-body"><p>Hmm maybe I&#x27;m misunderstanding your example. It seems to preserve with Ruff (<a href="https://play.ruff.rs/69cc0ba9-5297-457b-9237-6cad4fb95738">playground</a>). But I can boil my original example down as:</p>
<p>Within some parenthesized context you can get the following behavior:</p>
<p>I can get both Ruff and Black to preserve the parenthesized dataframe/series expression with one method call</p>
<pre><code># Input
[(df1_aaaaaaaaaaaa.loc[df1_aaaaaaaaaaaa[&quot;a&quot;] == &quot;aaaaaaaaaaaaaaaaa&quot;]).groupby()]

# Black
[(df1_aaaaaaaaaaaa.loc[df1_aaaaaaaaaaaa[&quot;a&quot;] == &quot;aaaaaaaaaaaaaaaaa&quot;]).groupby()]

# Ruff
[(df1_aaaaaaaaaaaa.loc[df1_aaaaaaaaaaaa[&quot;a&quot;] == &quot;aaaaaaaaaaaaaaaaa&quot;]).groupby()]
</code></pre>
<p><a href="https://black.vercel.app/?version=main&amp;state=_Td6WFoAAATm1rRGAgAhARYAAAB0L-Wj4ADEAHJdAD2IimZxl1N_Wg09_Mey5PsMtNn9Q6umuCzSUzwf_xQd5wBrHnIToNE5csx6izz-p51nsvX2pNoX_C2U6GwdfTdy6bXdnBo8C94mhSvC4tREmnHIU6hAFjXoY2mx42LcsbjplghG4Ah1laNQWC5P4bciAAAAAMVBzr2NpjZDAAGOAcUBAADG_N6ascRn-wIAAAAABFla">Black Playground</a></p>
<p><a href="https://play.ruff.rs/673711f4-b01c-4c15-824b-c9ea379e85ce">Ruff Playground</a></p>
<p>When you add a second method call Ruff will strip the parentheses</p>
<pre><code># Input
[(df1_aaaaaaaaaaaa.loc[df1_aaaaaaaaaaaa[&quot;a&quot;] == &quot;aaaaaaaaaaaaaaaaa&quot;]).groupby().sum()]

# Black
[(df1_aaaaaaaaaaaa.loc[df1_aaaaaaaaaaaa[&quot;a&quot;] == &quot;aaaaaaaaaaaaaaaaa&quot;]).groupby().sum()]

# Ruff
[df1_aaaaaaaaaaaa.loc[df1_aaaaaaaaaaaa[&quot;a&quot;] == &quot;aaaaaaaaaaaaaaaaa&quot;].groupby().sum()]
</code></pre>
<p><a href="https://black.vercel.app/?version=main&amp;state=_Td6WFoAAATm1rRGAgAhARYAAAB0L-Wj4ADKAHZdAD2IimZxl1N_Wg09_Mey5PsMtNn9Q6umuCzSUzwf_xQd5wBrHnIToNE5csx6izz-p51nsvX2pNoX_C2U6JY-jJPfrvKp7Cmykxku0BYbgJh59Z0ELUvky7RbB9sd9hOptbxjnem1pVGeur475-sTsmLMFbKLs3gAAAD0r_EWF5I19QABkgHLAQAAFUkVDrHEZ_sCAAAAAARZWg==">Black Playground</a></p>
<p><a href="https://play.ruff.rs/0b11c753-444f-47ec-bddf-f53576c670a1">Ruff Playground</a></p>
<p>What I want to play with would be examples requiring us to retain order of operations for dataframe/series operations.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/cnpryer">@cnpryer</a> on 2023-09-02 02:00</div>
            <div class="timeline-body"><p>And even simpler the same behavior occurs with:</p>
<pre><code>[((d)).call()]
</code></pre>
<p>Which is a good example of what you&#x27;re pointing out.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/cnpryer">@cnpryer</a> on 2023-09-02 02:09</div>
            <div class="timeline-body"><p>Oh wow, you don&#x27;t need the parenthesized context either.</p>
<pre><code>((d)).call()
</code></pre>
<p><a href="https://black.vercel.app/?version=main&amp;state=_Td6WFoAAATm1rRGAgAhARYAAAB0L-Wj4ABxAEddAD2IimZxl1N_WhTiKqpnadz_5hp9I0OGBK0lLz9B9g-V1SRhOBoqQVAADHPeRclIIfPZjWfTs5KGaV0ox6v-dbeOLz16ZTgAAABWvJqIZRMzwwABY3JfnV3QH7bzfQEAAAAABFla">Black Playground</a></p>
<p><a href="https://play.ruff.rs/aba7d33f-613d-4798-9b65-cd1300c2d4cd">Ruff Playground</a></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-09-02 07:58</div>
            <div class="timeline-body"><p>Ruff should preserve expression-parentheses except in clause headers (like <code>if (True)</code>). Not sure why it isn&#x27;t in this case. Thanks for narrowing down the example.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-09-02 07:58</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone &quot;Formatter: Beta&quot; by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-09-02 07:58</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">help wanted</span> added by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-09-02 07:58</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-09-02 08:11</div>
            <div class="timeline-body"><p>@charliermarsh are you working on this or is it up for grabs?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-09-02 09:39</div>
            <div class="timeline-body"><p>I was working on this but didn’t get to PR yet. I believe it’s specific to call chain formatting.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-09-02 09:43</div>
            <div class="timeline-body"><p>If I don’t find time to fix today, I’ll unassign myself :)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-09-02 10:50</div>
            <div class="timeline-body"><p>sounds good. @konstin has context on this as well.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-09-02 11:25</div>
            <div class="timeline-body"><p>For reference, using <a href="https://black.vercel.app/?version=main&amp;state=_Td6WFoAAATm1rRGAgAhARYAAAB0L-Wj4AHlAIJdAD2IimZxl1N_WhQxSjX4ufjgaLutdoZKjVr0Bl2fBAPjS2mA72tc4H7tPYw2oE32qgRx7UjuwjJJlklXhcQ0KZf_NKLwJ94RbHHxTIqGSF1efU_DgvdjEWuT2N2t90oKwmqrnyKwFJpARhO4q0h8p7t7ywVqM8TSXAUF0CvN5ogwjKgAAAD67Py4NzoEOQABngHmAwAA4yoLKLHEZ_sCAAAAAARZWg==">this</a> to demonstrate Black&#x27;s behavior are parenthesized &quot;heads&quot; on call chains.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-09-02 23:12</div>
            <div class="timeline-body"><p>I made some progress on this at <a href="https://github.com/astral-sh/ruff/compare/main...charlie/parens"><code>charlie/parens</code></a> but haven&#x27;t fully figured it out. I thought this could be solved by changing <code>expr_attribute.rs</code> alone but I&#x27;m now thinking we may need to change the fluent style detection code too. If anyone beats me to this they&#x27;re welcome to take it over (\cc @konstin as a good contender :)). I&#x27;ll re-assign if I find more time for it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Unassigned <a href="https://github.com/charliermarsh">@charliermarsh</a> by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-09-02 23:13</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to <a href="https://github.com/charliermarsh">@charliermarsh</a> by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-09-03 18:45</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Unassigned <a href="https://github.com/charliermarsh">@charliermarsh</a> by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-09-03 18:45</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to <a href="https://github.com/charliermarsh">@charliermarsh</a> by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-09-03 20:34</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-09-04 09:57</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 18:48:41 UTC
    </footer>
</body>
</html>
