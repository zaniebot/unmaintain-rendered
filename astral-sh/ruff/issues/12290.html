<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ruff doesn't find the same E721 violations as new flake8 does - astral-sh/ruff #12290</title>
    <link rel="stylesheet" href="../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../index.html">Back to index</a>
    </div>

    <h1>ruff doesn't find the same E721 violations as new flake8 does</h1>

    <div class="meta">
        <span class="state state-closed">Closed</span>
        <a href="https://github.com/astral-sh/ruff/issues/12290">#12290</a>
        opened by <a href="https://github.com/timj">@timj</a>
        on 2024-07-11 16:27
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/timj">@timj</a> on 2024-07-11 16:27</div>
            <div class="timeline-body"><!--
Thank you for taking the time to report an issue! We're glad to have you involved with Ruff.

If you're filing a bug report, please consider including the following information:

* List of keywords you searched for before creating this issue. Write them down here so that others can find this issue more easily and help provide feedback.
  e.g. "RUF001", "unused variable", "Jupyter notebook"
* A minimal code snippet that reproduces the bug.
* The command you invoked (e.g., `ruff /path/to/file.py --fix`), ideally including the `--isolated` flag.
* The current Ruff settings (any relevant sections from your `pyproject.toml`).
* The current Ruff version (`ruff --version`).
-->

<p>I searched for E721 but couldn't find a previous ticket.</p>
<pre><code class="language-$">ruff 0.5.1
</code></pre>
<p>For the file https://github.com/lsst/geom/blob/main/tests/test_coordinates.py flake8 7.1.0 reports this error:</p>
<pre><code>tests/test_coordinates.py:299:16: E721 do not compare types, for exact checks use `is` / `is not`, for instance checks use `isinstance()`
</code></pre>
<p>The relevant line is:</p>
<pre><code class="language-python">if type(result) != expected:
</code></pre>
<p>ruff 0.5.1 does not report any E721 violation. There is no ruff configuration in this directory when I clone.</p>
<p>I have other examples of inconsistency. In https://github.com/lsst/fgcm flake8 reports:</p>
<pre><code>/fgcm/fgcmConfig.py:30:20: E721 do not compare types, for exact checks use `is` / `is not`, for instance checks use `isinstance()`
./fgcm/fgcmConfig.py:33:20: E721 do not compare types, for exact checks use `is` / `is not`, for instance checks use `isinstance()`
./fgcm/fgcmConfig.py:59:16: E721 do not compare types, for exact checks use `is` / `is not`, for instance checks use `isinstance()`
</code></pre>
<p>ruff reports:</p>
<pre><code>fgcm/fgcmConfig.py:33:20: E721 Use `is` and `is not` for type comparisons, or `isinstance()` for isinstance checks
   |
31 |                     raise TypeError(&quot;Default is the wrong datatype.&quot;)
32 |             if self._value is not None:
33 |                 if type(self._value) != datatype:
   |                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ E721
34 |                     raise TypeError(&quot;Value is the wrong datatype.&quot;)
   |

fgcm/fgcmConfig.py:59:16: E721 Use `is` and `is not` for type comparisons, or `isinstance()` for isinstance checks
   |
58 |         if self._datatype is not None:
59 |             if type(self._value) != self._datatype:
   |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ E721
60 |                 raise ValueError(&quot;Datatype mismatch for %s (got %s, expected %s)&quot; %
61 |                                  (name, str(type(self._value)), str(self._datatype)))
   |

fgcm/sharedNumpyMemManager.py:100:15: E721 Use `is` and `is not` for type comparisons, or `isinstance()` for isinstance checks
    |
 98 |         elif (dtype == np.int16):
 99 |             ctype = ctypes.c_int16
100 |         elif (dtype == bool):
    |               ^^^^^^^^^^^^^ E721
101 |             ctype = ctypes.c_bool
102 |         else:
    |
</code></pre>
<p>where two of the warnings agree but flake8 is reporting one from line 30 of <code>fgcmConfig.py</code> which ruff does not report, and ruff reports one from <code>sharedNumpyMemManager.py</code> that flake8 does not report.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/timj">@timj</a> on 2024-07-11 16:46</div>
            <div class="timeline-body"><p>I see #9570 special cases numpy, which explains why line 98 above does not trigger the warning.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-07-11 18:11</div>
            <div class="timeline-body"><p>Hm I'm not sure why we're not raising a violation there. It looks like a false negative as far as I can tell?</p>
<p>Note some more context on false positives for this rule at https://github.com/astral-sh/ruff/issues/4560</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/timj">@timj</a> on 2024-07-11 19:43</div>
            <div class="timeline-body"><p>A different example from https://github.com/RobertLuptonTheGood/eups.</p>
<p>The code:</p>
<pre><code class="language-python">return isinstance(self, EupsCmd) and type(self) != EupsCmd
</code></pre>
<p>triggers E721 in flake8 but not in ruff.</p>
<pre><code>python/eups/cmd.py:253:46: E721 do not compare types, for exact checks use `is` / `is not`, for instance checks use `isinstance()`
</code></pre>
<p>ruff does find 3 places that flake8 doesn't though.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/timj">@timj</a> on 2024-07-11 21:12</div>
            <div class="timeline-body"><p>I'm also seeing cases where <code>type(x) != type(y)</code> is not triggering a warning in ruff but will in flake8.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-07-12 12:22</div>
            <div class="timeline-body"><blockquote>
<p>I'm also seeing cases where type(x) != type(y) is not triggering a warning in ruff but will in flake8.</p>
</blockquote>
<p>Can you give a concrete example of this?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/12300.html">astral-sh/ruff#12300</a> on 2024-07-12 12:33</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @charliermarsh by @charliermarsh on 2024-07-12 12:35</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @charliermarsh on 2024-07-12 12:35</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-07-12 12:35</div>
            <div class="timeline-body"><p>I believe these are fixed by https://github.com/astral-sh/ruff/pull/12300.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2024-07-12 13:21</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/timj">@timj</a> on 2024-07-12 15:37</div>
            <div class="timeline-body"><blockquote>
<p>Can you give a concrete example of this?</p>
</blockquote>
<p>Sorry. That was bad of me.</p>
<p>The code in question was https://github.com/lsst/ip_isr/blob/main/python/lsst/ip/isr/calibType.py#L139</p>
<pre><code class="language-python">elif type(attrSelf) != type(attrOther):
</code></pre>
<p>flake8 gave:</p>
<pre><code>python/lsst/ip/isr/calibType.py:139:18: E721 do not compare types, for exact checks use `is` / `is not`, for instance checks use `isinstance()`
</code></pre>
<p>and ruff said nothing.</p>
<pre><code>$ ruff --version
ruff 0.5.1
$ ruff check --select E721
All checks passed!
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-07-15 08:57</div>
            <div class="timeline-body"><p>@timj No worries! It's fixed and released in the latest version (<code>0.5.2</code>): https://play.ruff.rs/59525efe-9d7f-4683-83a9-808f15caacd6</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:28:13 UTC
    </footer>
</body>
</html>
