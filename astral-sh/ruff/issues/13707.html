<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rule S320 should be removed - astral-sh/ruff #13707</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Rule S320 should be removed</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/issues/13707">#13707</a>
        opened by <a href="https://github.com/pythonweb2">@pythonweb2</a>
        on 2024-10-10 21:12
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/pythonweb2">@pythonweb2</a></div>
            <div class="timeline-body"><p><a href="https://github.com/astral-sh/ruff/pull/10154#issuecomment-1995783400">This comment</a> seems to have been overlooked (at least was not responded to).</p>
<p>If lxml is fixed, then from what I can understand of rule S320, it should be removed as well.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-10-14 16:53</div>
            <div class="timeline-body"><p>Do you have a reference that <code>lxml</code> is fixed. Checking <code>defusedxml</code>&#x27;s documentation it seems that lxml is still vulnerable to entity expansions which is what S320 warns about. https://pypi.org/project/defusedxml/</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-10-14 17:05</div>
            <div class="timeline-body"><p>I also found <a href="https://github.com/PyCQA/bandit/issues/767">PyCQA/bandit#767</a> but it&#x27;s very unclear to me what the recommendation is...</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">rule</span> added by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-10-14 17:05</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/pythonweb2">@pythonweb2</a> on 2024-10-14 17:08</div>
            <div class="timeline-body"><p>There is this section in the <a href="https://lxml.de/FAQ.html">FAQ page</a>:</p>
<blockquote>
<p>Some of the most famous excessive content expansion attacks use XML entity references. Luckily, entity expansion is mostly useless for the data commonly sent through web services and can simply be disabled, which rules out several types of denial of service attacks at once. This also involves an attack that reads local files from the server, as XML entities can be defined to expand into the content of external resources. Consequently, version 1.2 of the SOAP standard explicitly disallows entity references in the XML stream.</p>
<p>To disable entity expansion, use an XML parser that is configured with the option resolve_entities=False. Then, after (or while) parsing the document, use root.iter(etree.Entity) to recursively search for entity references. If it contains any, reject the entire input document with a suitable error response. In lxml 3.x, you can also use the new DTD introspection API to apply your own restrictions on input documents. Since version 5.x, lxml disables the expansion of external entities (XXE) by default. If you really want to allow loading external files into XML documents using this functionality, you have to explicitly set resolve_entities=True.</p>
</blockquote>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/pythonweb2">@pythonweb2</a> on 2024-10-14 17:10</div>
            <div class="timeline-body"><p>The current lxml version is 5.0, which seems to be safe by default against entity expansion (since it disables it).</p>
<p>So, idk if ruff is able to check the version of lxml, or perhaps check to see if there are any places where <code>resolve_entities=True</code> is being used? That seems like that would be a more useful thing to check for.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-10-14 17:15</div>
            <div class="timeline-body"><blockquote>
<p>The current lxml version is 5.0, which seems to be safe by default against entity expansion (since it disables it).</p>
</blockquote>
<p>Yeah, it <em>seems</em> but I would like some more confirmation before deprecating a rule.</p>
<blockquote>
<p>So, idk if ruff is able to check the version of lxml, or perhaps check to see if there are any places where resolve_entities=True is being used? That seems like that would be a more useful thing to check for.</p>
</blockquote>
<p>Checking the version is beyond what Ruff can do today but checking for <code>resolve_entities</code> is a possibility for a new rule</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/pawel-slowik">@pawel-slowik</a> on 2024-11-17 20:39</div>
            <div class="timeline-body"><blockquote>
<p>The current lxml version is 5.0, which seems to be safe by default against entity expansion (since it disables it).</p>
</blockquote>
<p>This is not entirely true. The 5.0 version only disables the expansion of <strong>external</strong> entities by default:</p>
<p><a href="https://lxml.de/FAQ.html#how-do-i-use-lxml-safely-as-a-web-service-endpoint">https://lxml.de/FAQ.html#how-do-i-use-lxml-safely-as-a-web-service-endpoint</a></p>
<blockquote>
<p>Since version 5.x, lxml disables the expansion of <strong>external</strong> entities (XXE) by default.</p>
</blockquote>
<p><a href="https://lxml.de/5.0/changes-5.0.0.html">https://lxml.de/5.0/changes-5.0.0.html</a></p>
<blockquote>
<p>LP#1742885: lxml no longer expands <strong>external</strong> entities (XXE) by default to prevent the security risk of loading arbitrary files and URLs.</p>
</blockquote>
<p>The default value for the <code>resolve_entities</code> argument has changed from <code>True</code> to <code>&#x27;internal&#x27;</code>, <strong>not to <code>False</code></strong>: <a href="https://github.com/lxml/lxml/commit/b38cebf2f846e92bd63de4488fd3d1c8b568f397#diff-d96803514b65b282182a7d8d4ab1c076c8e7726761aecf5bb8b5eb8355d14324R1581">https://github.com/lxml/lxml/commit/b38cebf2f846e92bd63de4488fd3d1c8b568f397#diff-d96803514b65b282182a7d8d4ab1c076c8e7726761aecf5bb8b5eb8355d14324R1581</a></p>
<p>And it is still <code>&#x27;internal&#x27;</code> as of 5.3.0: <a href="https://github.com/lxml/lxml/blob/lxml-5.3.0/src/lxml/parser.pxi#L1600">https://github.com/lxml/lxml/blob/lxml-5.3.0/src/lxml/parser.pxi#L1600</a></p>
<p>The change protects from a file inclusion attack, but not from quadratic blowup.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/JeremyVriens">@JeremyVriens</a> on 2025-02-07 09:27</div>
            <div class="timeline-body"><p>Bandit removed both S410 and S320 from their blacklist since Bandit 1.8.1 (source: https://github.com/PyCQA/bandit/releases/tag/1.8.1).
Since S410 has already been removed from Ruff (source: <a href="https://github.com/astral-sh/ruff/pull/10154">astral-sh/ruff#10154</a>), my proposal is to also remove S320.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone &quot;v0.10&quot; by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-02-07 09:49</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ngnpope">@ngnpope</a> on 2025-02-14 16:18</div>
            <div class="timeline-body"><blockquote>
<p>Checking defusedxml&#x27;s documentation it seems that lxml is still vulnerable to entity expansions which is what S320 warns about</p>
</blockquote>
<p>The documentation was changed on a pre-release version. Alas, it seems that defusedxml is now largely unmaintained.</p>
<ul>
<li>https://pypi.org/project/defusedxml/0.7.1/#defusedxml-lxml</li>
<li>https://pypi.org/project/defusedxml/0.8.0rc2/#defusedxml-lxml</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Removed from milestone &quot;v0.10&quot; by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-03-12 14:52</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone &quot;v0.11&quot; by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-03-12 14:52</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-03-12 14:53</div>
            <div class="timeline-body"><p>I put up a PR to deprecate the rule (<a href="https://github.com/astral-sh/ruff/pull/16680">astral-sh/ruff#16680</a>). We should remove it in Ruff 0.11 (or 0.12)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/domWalters">@domWalters</a> on 2025-04-13 19:51</div>
            <div class="timeline-body"><p>I think this issue can be closed now?</p>
<p>S320 is unavailable in my installed copy of <code>0.11.5</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntBre">@ntBre</a> on 2025-04-14 00:36</div>
            <div class="timeline-body"><p>S320 was <em>deprecated</em> in 0.11 and its removal is on the 0.12 milestone, so we should probably leave this open until 0.12. I&#x27;m curious what you mean about it being unavailable, though. When I run 0.11.5, I get this output:</p>
<pre><code>$ ruff --version
ruff 0.11.5
$ ruff check --select S320
warning: Rule `S320` is deprecated and will be removed in a future release.
warning: No Python files found under the given path(s)
All checks passed!
</code></pre>
<p>which reports it as deprecated, as expected. When I run this on the example from the docs, I also get a diagnostic.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/domWalters">@domWalters</a> on 2025-05-05 19:56</div>
            <div class="timeline-body"><p>My apologies, I got confused as my <code>ruff</code> LSP was recommending to remove the <code># noqa: S320</code> comments.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-06-13 06:45</div>
            <div class="timeline-body"><p>Closing as this will ship with 0.12</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-06-13 06:45</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 18:48:58 UTC
    </footer>
</body>
</html>
