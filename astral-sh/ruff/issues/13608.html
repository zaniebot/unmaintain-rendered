<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FR: Easier way to suppress errors/formatting for custom code block before imports - astral-sh/ruff #13608</title>
    <link rel="stylesheet" href="../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../index.html">Back to index</a>
    </div>

    <h1>FR: Easier way to suppress errors/formatting for custom code block before imports</h1>

    <div class="meta">
        <span class="state state-open">Open</span>
        <a href="https://github.com/astral-sh/ruff/issues/13608">#13608</a>
        opened by <a href="https://github.com/dbarnett">@dbarnett</a>
        on 2024-10-02 19:26
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/dbarnett">@dbarnett</a> on 2024-10-02 19:26</div>
            <div class="timeline-body"><p>Could there be a way to allowlist a code block at the top of a python file above imports, to avoid linter errors module-import-not-at-top-of-file (E402) and unsorted-imports (I001) as well as formatter changes?</p>
<p>After inserting a code block <a href="https://github.com/insanum/gcalcli/blob/e6d452129b2ab2c5ef639e7403d21ddcac5243cb/gcalcli/cli.py#L26-L31">at the top of a python file, before imports</a>, I had to wrestle with the formatter and linter errors for E402 plus several others. It gets especially ugly because I'm not suppressing errors just for the code block I'm adding but for every import block after it. I noticed in the <a href="https://docs.astral.sh/ruff/rules/module-import-not-at-top-of-file/#why-is-this-bad">docs for E402</a> that...</p>
<blockquote>
<p>This rule makes an exception for both sys.path modifications (allowing for sys.path.insert, sys.path.append, etc.) and os.environ modifications between imports</p>
</blockquote>
<p>and wondered if I might somehow hook into the same mechanism for a code block like <code>import foo; foo.register_hooks()</code>.</p>
<hr />
<p>Additional info:</p>
<ul>
<li>List of keywords you searched for before creating this issue. -- &quot;ignore E402&quot;</li>
<li>The command you invoked. -- <code>ruff format --isolated gcalcli/cli.py; ruff check --isolated  --select I --fix gcalcli/cli.py</code></li>
<li>The current Ruff version. -- ruff 0.6.2</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dbarnett">@dbarnett</a> on 2024-10-02 19:32</div>
            <div class="timeline-body"><p>And to lift some context from the linked code snippet:</p>
<pre><code class="language-python"># Import trusted certificate store to enable SSL, e.g., behind firewalls.
# Must be called as early as possible to avoid bugs.
# fmt: off
import truststore; truststore.inject_into_ssl()  # noqa: I001,E702
# fmt: on
# ruff: noqa: E402

# â€¦ other imports â€¦
</code></pre>
<p>I had to:</p>
<ol>
<li>disable <code>unsorted-imports (I001)</code> for the weird import</li>
<li>disable <code>module-import-not-at-top-of-file (E402)</code> for the entire rest of the file (because that code block made it so none of the other imports were at the &quot;top&quot; anymore)</li>
<li>disable formatter + <code>multiple-statements-on-one-line-semicolon (E702)</code> to keep the truststore code block organized together</li>
</ol>
<p>For 3, I didn't strictly need it to be concatenated onto one line, but I didn't want it spread across 3 with a blank line between and the formatter / import sorter refused to leave other variants how I wanted them formatted.</p>
<p>I'm okay with some ugly error suppression comments but hoping to reduce it down to slightly less than that mess.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-10-03 10:25</div>
            <div class="timeline-body"><p>On the face of it, making this configurable seems like a reasonable request to me, since there's obviously an arbitrary number of things you could do in Python that might need to be done before one or more imports take place. And I can definitely see that the mess of pragma comments in your snippet there is pretty suboptimal ðŸ˜†</p>
<p>Here's where we currently apply this special-casing. The E402 rule is only applied to an import if the AST visitor detects we're at a point in the module after the &quot;import boundary&quot;, and the &quot;import boundary&quot; is crossed after we reach any statement that's not an import, and also isn't one of the various special cases that you've already noted:</p>
<p>https://github.com/astral-sh/ruff/blob/7e3894f5b3573d77b0000bbddf0293fbbb5dc986/crates/ruff_linter/src/checkers/ast/mod.rs#L496-L505</p>
<p>The actual functions that implement the special casing are all currently quite particular to each specific thing we're special-casing, however. We'd need to think up a design for a more generalised mechanism if we wanted to make it pluggable via a configuration option. Here's where these functions currently live: https://github.com/astral-sh/ruff/blob/main/crates/ruff_python_semantic/src/analyze/imports.rs.</p>
<p>Any ideas for what specifically the config option would look like? :-)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">rule</span> added by @AlexWaygood on 2024-10-03 10:25</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">configuration</span> added by @AlexWaygood on 2024-10-03 10:25</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">needs-design</span> added by @AlexWaygood on 2024-10-03 10:25</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dbarnett">@dbarnett</a> on 2024-10-03 15:32</div>
            <div class="timeline-body"><p>I'd imagined something to declare the following code block is intentionally before imports, something like</p>
<pre><code class="language-python">import truststore  # noqa: ignore-pre-import
truststore.inject_into_ssl()

# â€¦ other imports â€¦
</code></pre>
<p>Note that for it to remain one single &quot;block&quot;, the formatters need to know not to try to insert a blank line. That <em>COULD</em> be manually done with another <code># fmt: skip</code> directive, but I had trouble getting that to work correctly, and I think it's reasonable to assume if a code block is intentionally plopped into the top of the file, the formatter won't be a good judge of where to put extra newlines.</p>
<p>An alternative approach would be to try to have an allowlist of pre-import statements in the project config, but that's clunkier, less self-contained, and more limited than just tagging each block as intended pre-import in place.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-10-03 15:37</div>
            <div class="timeline-body"><p>Ahh, I see. Hmm, in that case I'm not sure. I think we generally like to keep the different kinds of suppression comments we support to a bare minimum; I think we'd need quite a strong rationale to add a new kind of suppression comment. This has the advantage of keeping things simple for users to understand, and also keeps our implementation fast and simple.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dbarnett">@dbarnett</a> on 2024-10-03 16:27</div>
            <div class="timeline-body"><p>Was there a less complex alternative you had in mind?</p>
<p>Overrides aside, it would be nice if by default (a) this only emitted one linter nag for the couple statements above the normal imports and (b) the formatters were less invasive about adding blank lines.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-10-03 18:13</div>
            <div class="timeline-body"><blockquote>
<p>Was there a less complex alternative you had in mind?</p>
</blockquote>
<p>When you said &quot;allowlist&quot;, I assumed you meant some kind of configuration setting that you might put in <code>pyproject.toml</code> or <code>ruff.toml</code> -- which I'd be very open too, if we can think of a good design for how the config setting would work!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dbarnett">@dbarnett</a> on 2024-10-03 18:44</div>
            <div class="timeline-body"><p>Could be a list of statements (in my case <code>import truststore</code> and <code>truststore.inject_into_ssl()</code>).</p>
<p>But either way, would it make sense to try to reduce the noise by default first before looking at new config mechanisms? If ruff were smarter about the &quot;import boundary&quot; then it'd at least be complaining about only the weird lines of code and not all the innocent bystander lines of imports that follow it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-10-07 08:00</div>
            <div class="timeline-body"><p>I agree that this is rather annoying but I'm not sure it's worth special casing this one-off use case.</p>
<p>We do have plans to rework our suppression comments holistically. What I have in mind is that you could suppress this with a single comment:</p>
<pre><code class="language-python"># Import trusted certificate store to enable SSL, e.g., behind firewalls.
# Must be called as early as possible to avoid bugs.
# ruff-ignore[format, lint/I001, lint/E702] -- Import trusted certificate store to enable SSL, e.g., behind firewalls. Must be called as early as possible to avoid bugs.
import truststore; truststore.inject_into_ssl()

# â€¦ other imports â€¦
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">configuration</span> removed by @MichaReiser on 2024-10-07 08:00</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">suppression</span> added by @MichaReiser on 2024-10-07 08:00</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dbarnett">@dbarnett</a> on 2024-10-07 13:44</div>
            <div class="timeline-body"><p>What about the E402 module-import-not-at-top-of-file for the entire rest of the file? That's the especially annoying one. Are you suggesting that issue would get resolved in the mix, or just not considering that part significant?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-10-07 13:59</div>
            <div class="timeline-body"><p>Right, that would require a second suppression comment. But I think that's fine, considering that this is a one-off exception/</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dbarnett">@dbarnett</a> on 2024-10-07 14:26</div>
            <div class="timeline-body"><p>But my point is that ruff is deciding the cutoff point of what is &quot;before imports&quot; and &quot;at top of file&quot; and creating a lot of fallout error spam as a result. Suppressing a few <em>other</em> errors on one line doesn't help much. I'd love to see it either use better heuristics (so it's more likely to only complain about the lines that are &quot;out of order&quot; in some meaningful sense) or at least let me provide a hint for where the main &quot;imports&quot; actually begin in this file.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-10-07 14:30</div>
            <div class="timeline-body"><p>I do understand the use case. I'm just not convinced that it's worth the complexity to special case.</p>
<p>You could also consider creating a new module <code>inject_truststore</code></p>
<pre><code class="language-python">import truststore

truststore.inject_into_ssl()
</code></pre>
<p>Then use it like this</p>
<pre><code class="language-python">import inject_truststore # isort: skip

import os

import first_party
</code></pre>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:28:13 UTC
    </footer>
</body>
</html>
