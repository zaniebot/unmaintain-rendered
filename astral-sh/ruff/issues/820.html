<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>False positive for F841 - astral-sh/ruff #820</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>False positive for F841</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/issues/820">#820</a>
        opened by <a href="https://github.com/bryevdv">@bryevdv</a>
        on 2022-11-19 23:26
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/bryevdv">@bryevdv</a></div>
            <div class="timeline-body"><p>Today the latest version of ruff (0.0.128) started  complaining about this test code:</p>
<pre><code>    def test_func_default_with_counter(self) -&gt; None:
        counter = 0
        def next_value() -&gt; int:
            nonlocal counter
            counter += 1
            return counter
        class HasFuncDefaultInt(Model):
            value = Int(default=next_value)
        obj1 = HasFuncDefaultInt()
        obj2 = HasFuncDefaultInt()
        assert obj1.value + 1 == obj2.value
</code></pre>
<p>with</p>
<blockquote>
<p>tests/unit/bokeh/test_objects.py:291:9: F841 Local variable <code>counter</code> is assigned to but never used</p>
</blockquote>
<p>It seems  the lasts<code>ruff</code> does not understand the usage with <code>nonlocal</code>. Previous versions of <code>ruff</code> (and <code>flake8</code>) do not warn on this code.</p>
<p>(this isn&#x27;t code we&#x27;d ever use in the library itself, but we do have to handle whatever crazy cases users might throw at us, and this is a test for one of those)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2022-11-19 23:31</div>
            <div class="timeline-body"><p>Iâ€™ll take a look at this tonight! Thanks for reporting.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/bryevdv">@bryevdv</a> on 2022-11-19 23:41</div>
            <div class="timeline-body"><p>I just realized I didn&#x27;t actually provide a proper MRE:</p>
<pre><code>def foo():
    counter = 0
    def next_value() -&gt; int:
        nonlocal counter
        counter += 1
        return counter
    a = next_value()
    b = next_value()
    return a, b

print(f&quot;(a, b): {foo()!r}&quot;)
</code></pre>
<p>with this setup:</p>
<p>https://github.com/bokeh/bokeh/blob/46b77a3a8d872237f333b7c7193887016d9ce507/pyproject.toml#L111-L124</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to <a href="https://github.com/charliermarsh">@charliermarsh</a> by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2022-11-19 23:52</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2022-11-19 23:54</div>
            <div class="timeline-body"><p>Thanks! As I expected this was introduced in <a href="https://github.com/charliermarsh/ruff/pull/800">charliermarsh/ruff#800</a>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2022-11-20 00:02</div>
            <div class="timeline-body"><p>The <a href="https://en.wiktionary.org/wiki/Chesterton%27s_fence">Chesterton&#x27;s Fence</a> was strong in this one:</p>
<img alt="Screen Shot 2022-11-19 at 7 01 50 PM" src="https://user-images.githubusercontent.com/1309177/202876328-a0b7d64b-3a16-4791-a009-5bcb76a0d175.png">

</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2022-11-20 00:21</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2022-11-20 00:53</div>
            <div class="timeline-body"><p>This is going out in <a href="https://github.com/charliermarsh/ruff/releases/tag/v0.0.129">v0.0.129</a> (building now).</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 18:48:26 UTC
    </footer>
</body>
</html>
