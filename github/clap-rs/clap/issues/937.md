---
number: 937
title: What is the correct way to do cargo subcommands?
type: issue
state: closed
author: golddranks
labels: []
assignees: []
created_at: 2017-04-21T05:22:50Z
updated_at: 2022-12-28T20:09:10Z
url: https://github.com/clap-rs/clap/issues/937
synced_at: 2026-01-07T12:31:16-06:00
---

# What is the correct way to do cargo subcommands?

---

_Issue opened by @golddranks on 2017-04-21 05:22_

I have a crate `cargo-flamegraph` for which I'm trying to implement the command line argument parsing. It is used like this:

    cargo flamegraph [binary name] [-- <user arguments>...]

I set the bin_name as "cargo", but after that I'm in troubles. If I go directly as the binary name as the first argument, it takes "flamegraph" as the first argument. If I set the bin_name as "cargo flamegraph" it does the same. If I set the bin_name as "cargo" and "flamegraph" as a subcommand, it doesn't for some reason capture the first argument, binary name.

It only works if I set "flamegraph" as the first argument and "binary_name" as the second. But in this case, the usage is shown like this:

    cargo [flamegraph] [binary name] [-- <user arguments>...]

Is there a bug with capturing the argument when "flamegraph" is set as the subcommand? Btw., my code in that case is like this:

    let matches = App::new("cargo flamegraph")
        .version("0.1")
        .bin_name("cargo")
        .about("Profiles your program and draws a nice flamegraph!")
        .author("Pyry Kontio")
        .setting(AppSettings::TrailingVarArg)
        .subcommand(SubCommand::with_name("flamegraph")
            .arg(Arg::with_name("binary name"))
            .arg(Arg::with_name("user arguments")
                .last(true)
                .multiple(true)
            )
        )
        .get_matches();

---

_Comment by @golddranks on 2017-04-21 06:03_

Ah, wait a minute, should I specify `.takes_value(true)` for positional arguments too to be able to get what was typed there?

---

_Comment by @golddranks on 2017-04-21 06:09_

Ugh, after adding some short-flag options this is getting even uglier:

    USAGE:
        cargo [OPTIONS] [flamegraph] [bin name] [-- <pass through args>...]

---

_Comment by @kbknapp on 2017-04-21 14:36_

Your first example is correct. Add a dummy subcommand called "flamegraph" and all your args under this subcommand.

```rust
let matches = App::new("cargo-flamegraph")
    .version("0.1")
    .bin_name("cargo")
    .about("Profiles your program and draws a nice flamegraph!")
    .author("Pyry Kontio")
    .setting(AppSettings::TrailingVarArg)
    .subcommand(SubCommand::with_name("flamegraph")
        .arg(Arg::with_name("binary name"))
        .arg(Arg::with_name("user arguments")
            .last(true)
            .multiple(true)
        )
    )
    .get_matches();
```

---

> If I go directly as the binary name as the first argument, it takes "flamegraph" as the first argument.

Do you mean you *also* want to be able to run `$ ./cargo-flamegraph [bin name] [-- <user args>...]`? If that's the case you need to go about it a different way and use a dummy *positional argument* that only accepts the value "flamegraph" and isn't required instead of a dummy subcommand.

```rust
let matches = App::new("cargo-flamegraph")
    .version("0.1")
    .about("Profiles your program and draws a nice flamegraph!")
    .author("Pyry Kontio")
    .setting(AppSettings::TrailingVarArg)
    .arg(Arg::with_name("dummy")
        .hidden(true)
        .possible_value("flamegraph"))
    .arg(Arg::with_name("binary name"))
    .arg(Arg::with_name("user arguments")
            .last(true)
            .multiple(true)
        )
    )
    .get_matches();
```

If that's not what you mean, I may be misunderstanding your question.

---

_Label `T: RFC / question` added by @kbknapp on 2017-04-21 14:41_

---

_Comment by @kbknapp on 2017-04-21 15:49_

> Ugh, after adding some short-flag options this is getting even uglier

@golddranks Note you can also [set the usage string manually](https://docs.rs/clap/2.23.3/clap/struct.App.html#method.usage) to whatever you'd like. This doesn't affect functionality, only how the usage string gets displayed to the user. You can even do [multi-line usage strings](https://github.com/BurntSushi/ripgrep/blob/362abed44a000da3b31e5dd027e16eb4e36e1bed/src/app.rs#L16-L20) if you like.

---

_Comment by @golddranks on 2017-04-24 03:51_

I am not trying to get `$ ./cargo-flamegraph [bin name] [-- <user args>...]` to work, just `$ cargo flamegraph [bin name] [-- <user args>...]`.

Here's an updated version:

    let matches = App::new("cargo flamegraph")
        .version("0.1")
        .bin_name("cargo")
        .about("Profiles your program and draws a nice flamegraph!")
        .author("Pyry Kontio")
        .setting(AppSettings::TrailingVarArg)
        .subcommand(SubCommand::with_name("flamegraph")
            .arg(Arg::with_name("verbose")
                .help("Prints out more stuff.")
                .short("v")
                .multiple(true)
            )
            .arg(Arg::with_name("timeout")
                .help("Timeout in seconds. By default, there is no timeout.")
                .short("t")
                .takes_value(true)
            )
            .arg(Arg::with_name("frequency")
                .help("The sampling frequency. By default, this is 99 Hz.")
                .short("f")
                .takes_value(true)
            )
            .arg(Arg::with_name("bin name")
                .help("The path of the binary to be profiled. If empty, Cargo.toml is searched for a binary.")
                .takes_value(true)
            )
            .arg(Arg::with_name("pass through args")
                .help("Any arguments you wish to pass to the binary being profiled.")
                .last(true)
                .multiple(true)
            )
        )
        .get_matches();

    let binary_name = matches.value_of_os("bin name");
    println!("Binary name: {:?}", binary_name);

When I install this as a cargo subcommand and call it with this: `cargo flamegraph test`, it prints out:

    Binary name: None

So it seems like a bug, or then there's something in the settings I'm overlooking. Setting `.takes_value(true)` for `Arg::with_name("bin name")` didn't help.

---

_Comment by @kbknapp on 2017-04-24 04:20_

This is because the matches are a [recursive tree-like hierarchy](https://docs.rs/clap/2.23.3/clap/struct.ArgMatches.html#method.subcommand_name) to allow multiple child subcommands to contain args with the same name. If they all existed in a flat namespace there would be conflicts.

This code should work:

```rust
let matches = App::new("cargo flamegraph")
    .version("0.1")
    .bin_name("cargo")
    .about("Profiles your program and draws a nice flamegraph!")
    .author("Pyry Kontio")
    .setting(AppSettings::TrailingVarArg)
    .subcommand(SubCommand::with_name("flamegraph")
        .arg(Arg::with_name("verbose")
            .help("Prints out more stuff.")
            .short("v")
            .multiple(true)
        )
        .arg(Arg::with_name("timeout")
            .help("Timeout in seconds. By default, there is no timeout.")
            .short("t")
            .takes_value(true)
        )
        .arg(Arg::with_name("frequency")
            .help("The sampling frequency. By default, this is 99 Hz.")
            .short("f")
            .takes_value(true)
        )
        .arg(Arg::with_name("bin name")
            .help("The path of the binary to be profiled. If empty, Cargo.toml is searched for a binary.")
            .takes_value(true)
        )
        .arg(Arg::with_name("pass through args")
            .help("Any arguments you wish to pass to the binary being profiled.")
            .last(true)
            .multiple(true)
        )
    )
    .get_matches();

// matches refers to the top-level "cargo flamegraph" App's matches. We want "flamegraph"'s matches
let fg_matches = matches.subcommand_matches("flamegraph").unwrap();

let binary_name = fg_matches.value_of_os("bin name");
println!("Binary name: {:?}", binary_name);
```

---

_Comment by @golddranks on 2017-04-24 04:24_

Ah, that explains it! Fixed and problem solved. Thank you.

---

_Closed by @golddranks on 2017-04-24 04:24_

---

_Comment by @kbknapp on 2017-04-24 04:25_

No problem :-)

On Apr 24, 2017 12:24 AM, "Pyry Kontio" <notifications@github.com> wrote:

> Ah, that explains it! Fixed and problem solved. Thank you.
>
> â€”
> You are receiving this because you commented.
> Reply to this email directly, view it on GitHub
> <https://github.com/kbknapp/clap-rs/issues/937#issuecomment-296521955>,
> or mute the thread
> <https://github.com/notifications/unsubscribe-auth/AGntttG_ymzr5hbBhvjqIajbTaAXUAIHks5rzCQGgaJpZM4ND4AK>
> .
>


---

_Referenced in [clap-rs/clap#1422](../../clap-rs/clap/issues/1422.md) on 2019-02-28 11:07_

---

_Referenced in [regexident/cargo-modules#70](../../regexident/cargo-modules/issues/70.md) on 2021-02-18 16:08_

---

_Comment by @mimoo on 2022-02-28 16:55_

It's not clear how to handle these today. I've tried the following but it still doesn't work:

```rust
#[derive(Debug, Parser)]
#[clap(author, version, about, bin_name = "cargo")]
struct Cli {
```

---

_Comment by @epage on 2022-02-28 17:18_

We now have derive and builder examples for cargo subcommands.  See https://github.com/clap-rs/clap/blob/master/examples/README.md

---

_Comment by @epage on 2022-12-28 20:06_

@blyxyas any reason you went that route  rather than the example that I linked above that is also linked [from the cookbook](https://docs.rs/clap/latest/clap/_derive/_cookbook/index.html)?



---

_Comment by @blyxyas on 2022-12-28 20:09_

@epage I removed the comment.

---

_Referenced in [PhilippPolterauer/cargo-samply#7](../../PhilippPolterauer/cargo-samply/pulls/7.md) on 2025-03-18 14:50_

---
