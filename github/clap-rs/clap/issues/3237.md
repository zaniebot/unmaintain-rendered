---
number: 3237
title: "clap::Arg stopped being covariant"
type: issue
state: closed
author: dtolnay
labels:
  - C-bug
  - A-builder
  - S-triage
assignees: []
created_at: 2022-01-01T05:29:23Z
updated_at: 2022-11-08T04:56:38Z
url: https://github.com/clap-rs/clap/issues/3237
synced_at: 2026-01-07T12:31:17-06:00
---

# clap::Arg stopped being covariant

---

_Issue opened by @dtolnay on 2022-01-01 05:29_

### Please complete the following tasks

- [X] I have searched the [discussions](https://github.com/clap-rs/clap/discussions)
- [X] I have searched the existing issues

### Rust Version

rustc 1.59.0-nightly (cfa3fe5af 2021-12-31)

### Clap Version

3.0.0

### Minimal reproducible code

```rust
use clap::{App, Arg};

fn main() {
    let x_help = "....".to_owned();
    let _ = App::new("nonstatic_arg_lifetime")
        .arg(arg_x(&x_help))
        .arg(arg_y());
}

fn arg_x<'help>(help: &'help str) -> Arg<'help> {
    Arg::new("x").help(help)
}

fn arg_y() -> Arg<'static> {
    Arg::new("y")
}
```

### Steps to reproduce the bug with the above code

`cargo check`

### Actual Behaviour

```console
error[E0597]: `x_help` does not live long enough
 --> src/main.rs:6:20
  |
6 |         .arg(arg_x(&x_help))
  |              ------^^^^^^^-
  |              |     |
  |              |     borrowed value does not live long enough
  |              argument requires that `x_help` is borrowed for `'static`
7 |         .arg(arg_y());
8 | }
  | - `x_help` dropped here while still borrowed
```

### Expected Behaviour

It would be ideal if this compiled. Exactly analogous code using clap 2.x does compile:

```rust
use clap2::{App, Arg};

fn main() {
    let x_help = "....".to_owned();
    let _ = App::new("nonstatic_arg_lifetime")
        .arg(arg_x(&x_help))
        .arg(arg_y());
}

fn arg_x<'help>(help: &'help str) -> Arg<'static, 'help> {
    Arg::with_name("x").help(help)
}

fn arg_y() -> Arg<'static, 'static> {
    Arg::with_name("y")
}
```

### Additional Context

The relevant difference appears to be the covariance of clap::Arg in 2.x / invariance in 3.0.0.

```rust
// [dependencies]
// clap2 = { package = "clap", version = "2" }
// clap3 = { package = "clap", version = "3" }

fn repro2<'arg>(arg: clap2::Arg<'static, 'static>) -> clap2::Arg<'arg, 'arg> {
    arg // okay
}

fn repro3<'arg>(arg: clap3::Arg<'static>) -> clap3::Arg<'arg> {
    arg // fail
}
```

```console
error[E0308]: mismatched types
  --> src/main.rs:10:5
   |
10 |     arg // fail
   |     ^^^ lifetime mismatch
   |
   = note: expected struct `clap::Arg<'arg>`
              found struct `clap::Arg<'static>`
note: the lifetime `'arg` as defined here...
  --> src/main.rs:9:11
   |
9  | fn repro3<'arg>(arg: clap3::Arg<'static>) -> clap3::Arg<'arg> {
   |           ^^^^
   = note: ...does not necessarily outlive the static lifetime
```

### Debug Output

_No response_

---

_Label `C-bug` added by @dtolnay on 2022-01-01 05:29_

---

_Comment by @epage on 2022-01-01 18:50_

In seeing the first example, I originally expected this to work in clap2 because of how the different lifetimes on `Arg<'static, 'help>` worked but then I saw the second example and I'm unsure what could change to cause that behavior.  @dtolnay have you seen this kind of thing before and have any pointers?

---

_Label `A-builder` added by @epage on 2022-01-04 01:34_

---

_Label `S-triage` added by @epage on 2022-01-04 01:34_

---

_Comment by @epage on 2022-11-08 04:56_

In clap v4, lifetimes were removed, making this a moot point.

---

_Closed by @epage on 2022-11-08 04:56_

---
