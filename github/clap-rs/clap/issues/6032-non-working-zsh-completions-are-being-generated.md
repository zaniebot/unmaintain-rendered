---
number: 6032
title: Non-working zsh completions are being generated
type: issue
state: open
author: werdahias
labels:
  - A-completion
assignees: []
created_at: 2025-06-10T19:58:25Z
updated_at: 2025-06-10T20:07:34Z
url: https://github.com/clap-rs/clap/issues/6032
synced_at: 2026-01-07T13:12:20-06:00
---

# Non-working zsh completions are being generated

---

_Issue opened by @werdahias on 2025-06-10 19:58_

At least for two programs I maintain in Debian have broken completions in zsh (but not fish and bash).
Both use clap-complete: `wormhole-rs` and `prs`.
Versions used: [1](https://gitlab.com/timvisee/prs/-/blob/master/cli/Cargo.toml?ref_type=heads#L84) [2](https://github.com/magic-wormhole/magic-wormhole.rs/blob/main/Cargo.toml#L28).
Both completions are generated by invoking their specific subcommand. 
When typing wormhole-rs in zsh, I would expect the subcommand to be completed. However, only local files get completed. After asking on [zsh-users](https://www.zsh.org/mla/users/2025/msg00092.html) my suspicion was confirmed.
I attached the generated zsh completion file for wormhole-rs.
```
compdef _wormhole-rs wormhole-rs
 _wormhole-rs() { #compdef wormhole-rs

autoload -U is-at-least

_wormhole-rs() {
    typeset -A opt_args
    typeset -a _arguments_options
    local ret=1

    if is-at-least 5.2; then
        _arguments_options=(-s -S -C)
    else
        _arguments_options=(-s -C)
    fi

    local context curcontext="$curcontext" state line
    _arguments "${_arguments_options[@]}" : \
'-v[Enable logging to stdout, for debugging purposes]' \
'--verbose[Enable logging to stdout, for debugging purposes]' \
'-h[Print help]' \
'--help[Print help]' \
'-V[Print version]' \
'--version[Print version]' \
":: :_wormhole-rs_commands" \
"*::: :->wormhole-rs" \
&& ret=0
    case $state in
    (wormhole-rs)
        words=($line[1] "${words[@]}")
        (( CURRENT += 1 ))
        curcontext="${curcontext%:*:*}:wormhole-rs-command-$line[1]:"
        case $line[1] in
            (send)
_arguments "${_arguments_options[@]}" : \
'*--relay-server=[Use a custom relay server (specify multiple times for multiple relays)]:tcp://HOSTNAME:PORT:_urls' \
'*--relay=[Use a custom relay server (specify multiple times for multiple relays)]:tcp://HOSTNAME:PORT:_urls' \
'--rendezvous-server=[Use a custom rendezvous server. Both sides need to use the same value in order to find each other]:ws://example.org:_urls' \
'--code=[Enter a code instead of generating one automatically]:CODE:_default' \
'-c+[Length of code (in bytes/words)]:NUMWORDS:_default' \
'--code-length=[Length of code (in bytes/words)]:NUMWORDS:_default' \
'--rename=[Suggest a different name to the receiver to keep the file'\''s actual name secret. Not allowed when sending more than one file]:FILE_NAME:_default' \
'--name=[Suggest a different name to the receiver to keep the file'\''s actual name secret. Not allowed when sending more than one file]:FILE_NAME:_default' \
'--force-direct[Disable the relay server support and force a direct connection]' \
'(--force-direct)--force-relay[Always route traffic over a relay server. This hides your IP address from the peer (but not from the server operators. Use Tor for that)]' \
'-v[Enable logging to stdout, for debugging purposes]' \
'--verbose[Enable logging to stdout, for debugging purposes]' \
'-h[Print help]' \
'--help[Print help]' \
'-V[Print version]' \
'--version[Print version]' \
'*::files:_files' \
&& ret=0
;;
(tx)
_arguments "${_arguments_options[@]}" : \
'*--relay-server=[Use a custom relay server (specify multiple times for multiple relays)]:tcp://HOSTNAME:PORT:_urls' \
'*--relay=[Use a custom relay server (specify multiple times for multiple relays)]:tcp://HOSTNAME:PORT:_urls' \
'--rendezvous-server=[Use a custom rendezvous server. Both sides need to use the same value in order to find each other]:ws://example.org:_urls' \
'--code=[Enter a code instead of generating one automatically]:CODE:_default' \
'-c+[Length of code (in bytes/words)]:NUMWORDS:_default' \
'--code-length=[Length of code (in bytes/words)]:NUMWORDS:_default' \
'--rename=[Suggest a different name to the receiver to keep the file'\''s actual name secret. Not allowed when sending more than one file]:FILE_NAME:_default' \
'--name=[Suggest a different name to the receiver to keep the file'\''s actual name secret. Not allowed when sending more than one file]:FILE_NAME:_default' \
'--force-direct[Disable the relay server support and force a direct connection]' \
'(--force-direct)--force-relay[Always route traffic over a relay server. This hides your IP address from the peer (but not from the server operators. Use Tor for that)]' \
'-v[Enable logging to stdout, for debugging purposes]' \
'--verbose[Enable logging to stdout, for debugging purposes]' \
'-h[Print help]' \
'--help[Print help]' \
'-V[Print version]' \
'--version[Print version]' \
'*::files:_files' \
&& ret=0
;;
(receive)
_arguments "${_arguments_options[@]}" : \
'*--relay-server=[Use a custom relay server (specify multiple times for multiple relays)]:tcp://HOSTNAME:PORT:_urls' \
'*--relay=[Use a custom relay server (specify multiple times for multiple relays)]:tcp://HOSTNAME:PORT:_urls' \
'--rendezvous-server=[Use a custom rendezvous server. Both sides need to use the same value in order to find each other]:ws://example.org:_urls' \
'--out-dir=[Store transferred file or folder in the specified directory. Defaults to \$PWD]:PATH:_files -/' \
'--noconfirm[Accept file transfer without asking for confirmation]' \
'--yes[Accept file transfer without asking for confirmation]' \
'--force-direct[Disable the relay server support and force a direct connection]' \
'(--force-direct)--force-relay[Always route traffic over a relay server. This hides your IP address from the peer (but not from the server operators. Use Tor for that)]' \
'-v[Enable logging to stdout, for debugging purposes]' \
'--verbose[Enable logging to stdout, for debugging purposes]' \
'-h[Print help]' \
'--help[Print help]' \
'-V[Print version]' \
'--version[Print version]' \
'::code -- Provide the code now rather than typing it interactively:_default' \
&& ret=0
;;
(rx)
_arguments "${_arguments_options[@]}" : \
'*--relay-server=[Use a custom relay server (specify multiple times for multiple relays)]:tcp://HOSTNAME:PORT:_urls' \
'*--relay=[Use a custom relay server (specify multiple times for multiple relays)]:tcp://HOSTNAME:PORT:_urls' \
'--rendezvous-server=[Use a custom rendezvous server. Both sides need to use the same value in order to find each other]:ws://example.org:_urls' \
'--out-dir=[Store transferred file or folder in the specified directory. Defaults to \$PWD]:PATH:_files -/' \
'--noconfirm[Accept file transfer without asking for confirmation]' \
'--yes[Accept file transfer without asking for confirmation]' \
'--force-direct[Disable the relay server support and force a direct connection]' \
'(--force-direct)--force-relay[Always route traffic over a relay server. This hides your IP address from the peer (but not from the server operators. Use Tor for that)]' \
'-v[Enable logging to stdout, for debugging purposes]' \
'--verbose[Enable logging to stdout, for debugging purposes]' \
'-h[Print help]' \
'--help[Print help]' \
'-V[Print version]' \
'--version[Print version]' \
'::code -- Provide the code now rather than typing it interactively:_default' \
&& ret=0
;;
(send-many)
_arguments "${_arguments_options[@]}" : \
'-n+[Only send the file up to n times, limiting the number of people that may receive it. These are also the number of tries a potential attacker gets at guessing the password]:N:_default' \
'--tries=[Only send the file up to n times, limiting the number of people that may receive it. These are also the number of tries a potential attacker gets at guessing the password]:N:_default' \
'--timeout=[Automatically stop providing the file after a certain amount of time]:MINUTES:_default' \
'*--relay-server=[Use a custom relay server (specify multiple times for multiple relays)]:tcp://HOSTNAME:PORT:_urls' \
'*--relay=[Use a custom relay server (specify multiple times for multiple relays)]:tcp://HOSTNAME:PORT:_urls' \
'--rendezvous-server=[Use a custom rendezvous server. Both sides need to use the same value in order to find each other]:ws://example.org:_urls' \
'--code=[Enter a code instead of generating one automatically]:CODE:_default' \
'-c+[Length of code (in bytes/words)]:NUMWORDS:_default' \
'--code-length=[Length of code (in bytes/words)]:NUMWORDS:_default' \
'--rename=[Suggest a different name to the receiver to keep the file'\''s actual name secret. Not allowed when sending more than one file]:FILE_NAME:_default' \
'--name=[Suggest a different name to the receiver to keep the file'\''s actual name secret. Not allowed when sending more than one file]:FILE_NAME:_default' \
'--force-direct[Disable the relay server support and force a direct connection]' \
'(--force-direct)--force-relay[Always route traffic over a relay server. This hides your IP address from the peer (but not from the server operators. Use Tor for that)]' \
'-v[Enable logging to stdout, for debugging purposes]' \
'--verbose[Enable logging to stdout, for debugging purposes]' \
'-h[Print help]' \
'--help[Print help]' \
'-V[Print version]' \
'--version[Print version]' \
'*::files:_files' \
&& ret=0
;;
(forward)
_arguments "${_arguments_options[@]}" : \
'-v[Enable logging to stdout, for debugging purposes]' \
'--verbose[Enable logging to stdout, for debugging purposes]' \
'-h[Print help]' \
'--help[Print help]' \
'-V[Print version]' \
'--version[Print version]' \
":: :_wormhole-rs__forward_commands" \
"*::: :->forward" \
&& ret=0

    case $state in
    (forward)
        words=($line[1] "${words[@]}")
        (( CURRENT += 1 ))
        curcontext="${curcontext%:*:*}:wormhole-rs-forward-command-$line[1]:"
        case $line[1] in
            (serve)
_arguments "${_arguments_options[@]}" : \
'*--relay-server=[Use a custom relay server (specify multiple times for multiple relays)]:tcp://HOSTNAME:PORT:_urls' \
'*--relay=[Use a custom relay server (specify multiple times for multiple relays)]:tcp://HOSTNAME:PORT:_urls' \
'--rendezvous-server=[Use a custom rendezvous server. Both sides need to use the same value in order to find each other]:ws://example.org:_urls' \
'--code=[Enter a code instead of generating one automatically]:CODE:_default' \
'-c+[Length of code (in bytes/words)]:NUMWORDS:_default' \
'--code-length=[Length of code (in bytes/words)]:NUMWORDS:_default' \
'--force-direct[Disable the relay server support and force a direct connection]' \
'(--force-direct)--force-relay[Always route traffic over a relay server. This hides your IP address from the peer (but not from the server operators. Use Tor for that)]' \
'-v[Enable logging to stdout, for debugging purposes]' \
'--verbose[Enable logging to stdout, for debugging purposes]' \
'-h[Print help]' \
'--help[Print help]' \
'-V[Print version]' \
'--version[Print version]' \
'*::targets -- List of ports to open up. You can optionally specify a domain/address to forward remote ports:_hosts' \
&& ret=0
;;
(open)
_arguments "${_arguments_options[@]}" : \
'*--relay-server=[Use a custom relay server (specify multiple times for multiple relays)]:tcp://HOSTNAME:PORT:_urls' \
'*--relay=[Use a custom relay server (specify multiple times for multiple relays)]:tcp://HOSTNAME:PORT:_urls' \
'--rendezvous-server=[Use a custom rendezvous server. Both sides need to use the same value in order to find each other]:ws://example.org:_urls' \
'--code=[Enter a code instead of generating one automatically]:CODE:_default' \
'-c+[Length of code (in bytes/words)]:NUMWORDS:_default' \
'--code-length=[Length of code (in bytes/words)]:NUMWORDS:_default' \
'--force-direct[Disable the relay server support and force a direct connection]' \
'(--force-direct)--force-relay[Always route traffic over a relay server. This hides your IP address from the peer (but not from the server operators. Use Tor for that)]' \
'-v[Enable logging to stdout, for debugging purposes]' \
'--verbose[Enable logging to stdout, for debugging purposes]' \
'-h[Print help]' \
'--help[Print help]' \
'-V[Print version]' \
'--version[Print version]' \
'*::targets -- List of ports to open up. You can optionally specify a domain/address to forward remote ports:_hosts' \
&& ret=0
;;
(connect)
_arguments "${_arguments_options[@]}" : \
'*-p+[Bind to specific ports instead of taking random free high ports. Can be provided multiple times]:PORT:_default' \
'*--port=[Bind to specific ports instead of taking random free high ports. Can be provided multiple times]:PORT:_default' \
'--bind=[Bind to a specific address to accept the forwarding. Depending on your system and firewall, this may make the forwarded ports accessible from the outside]:ADDRESS:' \
'*--relay-server=[Use a custom relay server (specify multiple times for multiple relays)]:tcp://HOSTNAME:PORT:_urls' \
'*--relay=[Use a custom relay server (specify multiple times for multiple relays)]:tcp://HOSTNAME:PORT:_urls' \
'--rendezvous-server=[Use a custom rendezvous server. Both sides need to use the same value in order to find each other]:ws://example.org:_urls' \
'--noconfirm[Accept the forwarding without asking for confirmation]' \
'--yes[Accept the forwarding without asking for confirmation]' \
'--force-direct[Disable the relay server support and force a direct connection]' \
'(--force-direct)--force-relay[Always route traffic over a relay server. This hides your IP address from the peer (but not from the server operators. Use Tor for that)]' \
'-v[Enable logging to stdout, for debugging purposes]' \
'--verbose[Enable logging to stdout, for debugging purposes]' \
'-h[Print help]' \
'--help[Print help]' \
'-V[Print version]' \
'--version[Print version]' \
'::code -- Provide the code now rather than typing it interactively:_default' \
&& ret=0
;;
        esac
    ;;
esac
;;
(completion)
_arguments "${_arguments_options[@]}" : \
'-v[Enable logging to stdout, for debugging purposes]' \
'--verbose[Enable logging to stdout, for debugging purposes]' \
'-h[Print help]' \
'--help[Print help]' \
'-V[Print version]' \
'--version[Print version]' \
':shell -- The shell type to generate completions for (bash, elvish, powershell, zsh):(bash elvish fish powershell zsh)' \
&& ret=0
;;
(help)
_arguments "${_arguments_options[@]}" : \
'-v[Enable logging to stdout, for debugging purposes]' \
'--verbose[Enable logging to stdout, for debugging purposes]' \
'-h[Print help]' \
'--help[Print help]' \
'-V[Print version]' \
'--version[Print version]' \
&& ret=0
;;
        esac
    ;;
esac
}

(( $+functions[_wormhole-rs_commands] )) ||
_wormhole-rs_commands() {
    local commands; commands=(
'send:Send a file or a folder' \
'tx:Send a file or a folder' \
'receive:Receive a file or a folder' \
'rx:Receive a file or a folder' \
'send-many:Send a file to many recipients' \
'forward:Forward ports from one machine to another' \
'completion:Generate shell completions for the wormhole CLI' \
'help:' \
    )
    _describe -t commands 'wormhole-rs commands' commands "$@"
}
(( $+functions[_wormhole-rs__completion_commands] )) ||
_wormhole-rs__completion_commands() {
    local commands; commands=()
    _describe -t commands 'wormhole-rs completion commands' commands "$@"
}
(( $+functions[_wormhole-rs__forward_commands] )) ||
_wormhole-rs__forward_commands() {
    local commands; commands=(
'serve:Make the following ports of your system available to your peer' \
'open:Make the following ports of your system available to your peer' \
'connect:Connect to some ports forwarded to you' \
    )
    _describe -t commands 'wormhole-rs forward commands' commands "$@"
}
(( $+functions[_wormhole-rs__forward__connect_commands] )) ||
_wormhole-rs__forward__connect_commands() {
    local commands; commands=()
    _describe -t commands 'wormhole-rs forward connect commands' commands "$@"
}
(( $+functions[_wormhole-rs__forward__serve_commands] )) ||
_wormhole-rs__forward__serve_commands() {
    local commands; commands=()
    _describe -t commands 'wormhole-rs forward serve commands' commands "$@"
}
(( $+functions[_wormhole-rs__help_commands] )) ||
_wormhole-rs__help_commands() {
    local commands; commands=()
    _describe -t commands 'wormhole-rs help commands' commands "$@"
}
(( $+functions[_wormhole-rs__receive_commands] )) ||
_wormhole-rs__receive_commands() {
    local commands; commands=()
    _describe -t commands 'wormhole-rs receive commands' commands "$@"
}
(( $+functions[_wormhole-rs__send_commands] )) ||
_wormhole-rs__send_commands() {
    local commands; commands=()
    _describe -t commands 'wormhole-rs send commands' commands "$@"
}
(( $+functions[_wormhole-rs__send-many_commands] )) ||
_wormhole-rs__send-many_commands() {
    local commands; commands=()
    _describe -t commands 'wormhole-rs send-many commands' commands "$@"
}

if [ "$funcstack[1]" = "_wormhole-rs" ]; then
    _wormhole-rs "$@"
else
    compdef _wormhole-rs wormhole-rs
fi
 }

if [ "$funcstack[1]" = "wormhole-rs" ]; then
   wormhole-rs "$@"
fi

```
Especially the first part of the script is wrong and should be reworked.

---

_Label `A-completion` added by @epage on 2025-06-10 20:00_

---

_Comment by @epage on 2025-06-10 20:07_

Could you re-work your issue to follow our template which would include reproduction steps?

> Versions used: [1](https://gitlab.com/timvisee/prs/-/blob/master/cli/Cargo.toml?ref_type=heads#L84) [2](https://github.com/magic-wormhole/magic-wormhole.rs/blob/main/Cargo.toml#L28).

Note that those are version requirements, setting the bounds of what versions might be used.

If the packaging is respecting the lockfile, then the versions used are
- [4.5.46](https://gitlab.com/timvisee/prs/-/blob/master/Cargo.lock?ref_type=heads#L687)
- [4.5.47](https://github.com/magic-wormhole/magic-wormhole.rs/blob/bc99adc2a467365941ddf5484a4cb041c289d56f/Cargo.lock#L632)

Has Debian applied any patches to any of the libraries in question?  Is this reproducible upstream?

> Especially the first part of the script is wrong and should be reworked.

That is a bit vague.  It would help if more details are given.  If you are referring to the [reply in zsh-users](https://www.zsh.org/mla/users/2025/msg00093.html), then more details are needed.  `clap_complete` for zsh does specify `#compdef`

Code:
https://github.com/clap-rs/clap/blob/194c676f60b916506f94f70decdbf319af5d1ec6/clap_complete/src/aot/shells/zsh.rs#L29

Example snapshot:
https://github.com/clap-rs/clap/blob/194c676f60b916506f94f70decdbf319af5d1ec6/clap_complete/tests/snapshots/basic.zsh#L1

---
