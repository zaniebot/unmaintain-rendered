---
number: 2307
title: "Validate `conflicts_with`"
type: issue
state: closed
author: HalfVoxel
labels:
  - C-enhancement
  - A-builder
  - ":money_with_wings: $5"
assignees: []
created_at: 2021-01-22T15:06:17Z
updated_at: 2021-12-13T15:48:10Z
url: https://github.com/clap-rs/clap/issues/2307
synced_at: 2026-01-07T12:31:17-06:00
---

# Validate `conflicts_with`

---

_Issue opened by @HalfVoxel on 2021-01-22 15:06_

### Make sure you completed the following tasks

- [x] Searched the [discussions](https://github.com/clap-rs/clap/discussions)
- [x] Searched the closed issues

### Describe your use case

Currently, it can sometimes be tricky to know which name to give to `conflicts_with`, in particular in combination with `structopt`.
Take a look at this issue for context: https://github.com/TeXitoi/structopt/issues/459

Clap currently doesn't seem to care if `conflicts_with` is given a name which isn't even a valid field.

### Describe the solution you'd like

Clap validates that the field `conflicts_with` is given actually exists.


---

_Label `T: new feature` added by @HalfVoxel on 2021-01-22 15:06_

---

_Comment by @pksunkara on 2021-01-22 18:46_

Have you checked this with master? And also please provide a minimal sample code so it's easier for everyone.

---

_Comment by @HalfVoxel on 2021-01-22 18:57_

I have not yet, my testing was done with clap v2.33.3 which is the latest stable version afaik (though I see that there's a 3.0 beta now).

I use structopt so that generates most of the code for me. You can find an example of that in the linked issue.

Here is the code that structopt generates which corresponds to this issue:

```rust
let app = app.about("Runs a module");
let app = app.arg(
    ::structopt::clap::Arg::with_name("module-name")
        .takes_value(true)
        .multiple(false)
        .validator(|s| {
            ::std::str::FromStr::from_str(s.as_str())
                .map(|_: String| ())
                .map_err(|e| e.to_string())
        })
        .help("Name of the cmdlet module to run")
        .short("n")
        .long("name"),
);
let app = app.arg(
    ::structopt::clap::Arg::with_name("module-cid")
        .takes_value(true)
        .multiple(false)
        .validator(|s| {
            ::std::str::FromStr::from_str(s.as_str())
                .map(|_: Cid| ())
                .map_err(|e| e.to_string())
        })
        .help("CID of the cmdlet module to run")
        .short("c")
        .long("cid")
        .conflicts_with("module_name"),
);
app.version("0.1.0")
```

Note that `conflicts_with` is given the name `module_name` while the generated name is actually `module-name`.


---

_Comment by @pksunkara on 2021-01-22 19:17_

Can you please test it on clap master and report back?

---

_Comment by @HalfVoxel on 2021-01-25 15:58_

Hi

I can confirm that this still happens with master.

```toml
[dependencies]
clap = { git = "https://github.com/clap-rs/clap.git", rev= "d7f6748" }
```

```rust
use clap::{App, Arg};

fn main() {
    let app = App::new("My Super Program")
        .about("Runs a module")
        .arg(
            Arg::new("module-name")
                .takes_value(true)
                .multiple(false)
                .short('n')
                .long("name"),
        )
        .arg(
            Arg::new("module-cid")
                .takes_value(true)
                .multiple(false)
                .short('c')
                .long("cid")
                .conflicts_with("module_name"),
        )
        .version("0.1.0");

    let matches = app.get_matches();
    println!("{:#?}", matches);
}
```

```
 ~/p/e/t/claptest (master) [2]> cargo run --release -- --name=NAME --cid=CID                                   (base)
   Compiling claptest v0.1.0 (/home/arong/projects/embark/test/claptest)
    Finished release [optimized] target(s) in 0.40s
     Running `target/release/claptest --name=NAME --cid=CID`
ArgMatches {
    args: {
        [hash: 49BCF4FC57DA0A4]: MatchedArg {
            occurs: 1,
            ty: CommandLine,
            indices: [
                1,
            ],
            vals: [],
        },
        [hash: 110F162FD0016129]: MatchedArg {
            occurs: 1,
            ty: CommandLine,
            indices: [
                2,
            ],
            vals: [],
        },
    },
    subcommand: None,
}
```


---

_Added to milestone `3.1` by @pksunkara on 2021-01-26 18:18_

---

_Label `T: new feature` removed by @pksunkara on 2021-01-26 18:19_

---

_Label `:money_with_wings: $5` added by @pksunkara on 2021-01-26 18:19_

---

_Label `C: asserts` added by @pksunkara on 2021-01-26 18:19_

---

_Label `D: easy` added by @pksunkara on 2021-01-26 18:19_

---

_Label `T: enhancement` added by @pksunkara on 2021-01-26 18:19_

---

_Referenced in [epage/clapng#174](../../epage/clapng/issues/174.md) on 2021-12-06 20:20_

---

_Label `C: asserts` removed by @epage on 2021-12-08 19:59_

---

_Label `A-builder` added by @epage on 2021-12-08 19:59_

---

_Comment by @epage on 2021-12-13 15:48_

This has since been resolved

We have an existing test `conflicts_with_invalid_arg` but I turned the above example code into a test to double check

```rust
#[cfg(debug_assertions)]
#[test]
#[should_panic]
fn non_existent_conflict_asserts() {
    App::new("My Super Program")
        .about("Runs a module")
        .arg(
            Arg::new("module-name")
                .takes_value(true)
                .multiple(false)
                .short('n')
                .long("name"),
        )
        .arg(
            Arg::new("module-cid")
                .takes_value(true)
                .multiple(false)
                .short('c')
                .long("cid")
                .conflicts_with("module_name"),
        )
        .version("0.1.0")
        .debug_assert();
}
```
And it passes on 3.0.0-rc.4

---

_Closed by @epage on 2021-12-13 15:48_

---
