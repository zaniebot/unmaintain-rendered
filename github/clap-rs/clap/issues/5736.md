---
number: 5736
title: "Derive parser: FromStr implemention with Err=Box<dyn Error> causes inscrutible compiler error"
type: issue
state: open
author: Sciencentistguy
labels:
  - C-bug
  - A-derive
  - S-blocked
assignees: []
created_at: 2024-09-19T21:13:31Z
updated_at: 2024-09-19T21:34:12Z
url: https://github.com/clap-rs/clap/issues/5736
synced_at: 2026-01-07T12:31:17-06:00
---

# Derive parser: FromStr implemention with Err=Box<dyn Error> causes inscrutible compiler error

---

_Issue opened by @Sciencentistguy on 2024-09-19 21:13_

### Please complete the following tasks

- [X] I have searched the [discussions](https://github.com/clap-rs/clap/discussions)
- [X] I have searched the [open](https://github.com/clap-rs/clap/issues) and [rejected](https://github.com/clap-rs/clap/issues?q=is%3Aissue+label%3AS-wont-fix+is%3Aclosed) issues

### Rust Version

1.81.0

### Clap Version

4.5.17

### Minimal reproducible code

```rust
use std::str::FromStr;
use clap::Parser;

#[derive(Debug, Clone)]
struct ArgT {
    value: usize,
}

impl FromStr for ArgT {
    type Err = Box<dyn std::error::Error>;

    fn from_str(x: &str) -> Result<Self, Self::Err> {
        todo!()
    }
}

#[derive(Parser)]
struct Args {
    #[clap()]
    arg: ArgT
}
```


### Steps to reproduce the bug with the above code

Compile the code

### Actual Behaviour

It rejects the code, and the error message is rather unhelpful

### Expected Behaviour

Either this should be supported (I don't know why it isn't, but it may be non-trivial), or ideally the error message should be improved

### Additional Context

https://play.rust-lang.org/?version=stable&mode=debug&edition=2021&gist=5598d6ddacf4b3784b92969617c54318

### Debug Output

_No response_

---

_Label `C-bug` added by @Sciencentistguy on 2024-09-19 21:13_

---

_Comment by @epage on 2024-09-19 21:16_

The error message
```
error[E0599]: the method `value_parser` exists for reference `&&&&&&_infer_ValueParser_for<ArgT>`, but its trait bounds were not satisfied
    --> src/lib.rs:19:5
     |
5    |   struct ArgT {
     |   ----------- doesn't satisfy 6 bounds
...
19   |       #[clap()]
     |       ^ method cannot be called on `&&&&&&_infer_ValueParser_for<ArgT>` due to unsatisfied trait bounds
     |
    ::: /playground/.cargo/registry/src/index.crates.io-6f17d22bba15001f/clap_builder-4.5.17/src/builder/value_parser.rs:2423:1
     |
2423 |   pub struct _infer_ValueParser_for<T>(std::marker::PhantomData<T>);
     |   ------------------------------------ doesn't satisfy `_: _impls_FromStr`
     |
    ::: /playground/.rustup/toolchains/stable-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/alloc/src/boxed.rs:238:1
     |
238  | / pub struct Box<
239  | |     T: ?Sized,
240  | |     #[unstable(feature = "allocator_api", issue = "32838")] A: Allocator = Global,
241  | | >(Unique<T>, A);
     | |_- doesn't satisfy `_: Into<Box<dyn Error + Send + Sync>>`
     |
     = note: the following trait bounds were not satisfied:
             `ArgT: ValueEnum`
             which is required by `&&&&&_infer_ValueParser_for<ArgT>: clap::builder::impl_prelude::_impls_ValueEnum`
             `ArgT: ValueParserFactory`
             which is required by `&&&&&&_infer_ValueParser_for<ArgT>: clap::builder::impl_prelude::_impls_ValueParserFactory`
             `ArgT: From<OsString>`
             which is required by `&&&&_infer_ValueParser_for<ArgT>: clap::builder::impl_prelude::_impls_From_OsString`
             `ArgT: From<&'s std::ffi::OsStr>`
             which is required by `&&&_infer_ValueParser_for<ArgT>: clap::builder::impl_prelude::_impls_From_OsStr`
             `ArgT: From<std::string::String>`
             which is required by `&&_infer_ValueParser_for<ArgT>: clap::builder::impl_prelude::_impls_From_String`
             `ArgT: From<&'s str>`
             which is required by `&_infer_ValueParser_for<ArgT>: clap::builder::impl_prelude::_impls_From_str`
             `Box<(dyn std::error::Error + 'static)>: Into<Box<(dyn std::error::Error + Send + Sync + 'static)>>`
             which is required by `_infer_ValueParser_for<ArgT>: clap::builder::impl_prelude::_impls_FromStr`
note: the traits `From`, `ValueEnum`,  and `ValueParserFactory` must be implemented
    --> /playground/.cargo/registry/src/index.crates.io-6f17d22bba15001f/clap_builder-4.5.17/src/builder/value_parser.rs:2272:1
     |
2272 | pub trait ValueParserFactory {
     | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
     |
    ::: /playground/.cargo/registry/src/index.crates.io-6f17d22bba15001f/clap_builder-4.5.17/src/derive.rs:276:1
     |
276  | pub trait ValueEnum: Sized + Clone {
     | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
     |
    ::: /playground/.rustup/toolchains/stable-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/core/src/convert/mod.rs:580:1
     |
580  | pub trait From<T>: Sized {
     | ^^^^^^^^^^^^^^^^^^^^^^^^
     = note: this error originates in the macro `clap::value_parser` (in Nightly builds, run with -Z macro-backtrace for more info)

warning: unused variable: `x`
  --> src/lib.rs:12:17
   |
12 |     fn from_str(x: &str) -> Result<Self, Self::Err> {
   |                 ^ help: if this is intentional, prefix it with an underscore: `_x`
   |
   = note: `#[warn(unused_variables)]` on by default

For more information about this error, try `rustc --explain E0599`.
warning: `playground` (lib) generated 1 warning
error: could not compile `playground` (lib) due to 2 previous errors; 1 warning emitted
```

---

_Comment by @epage on 2024-09-19 21:24_

`clap` needs to know what `ValueParser` to use for a field.

> ```
>  the method `value_parser` exists for reference `&&&&&&_infer_ValueParser_for<ArgT>`, but its trait bounds were not satisfied
> ```

We have a trait to "infer `ValueParser` for your `ArgT`"

> ```
>      |   ----------- doesn't satisfy 6 bounds
> ```

We have 6 traits available to provide `_infer_ValueParser_for` for you

> ```
>              `Box<(dyn std::error::Error + 'static)>: Into<Box<(dyn std::error::Error + Send + Sync + 'static)>>`
>              which is required by `_infer_ValueParser_for<ArgT>: clap::builder::impl_prelude::_impls_FromStr`
> ```

when inferring for `FromStr`, your error type is not convertable to `Error + Send + Sync + 'static`

To fix this, change
```rust
    type Err = Box<dyn std::error::Error>;
```
to
```rust
    type Err = Box<dyn std::error::Error + Send + Sync>;
```

---

_Comment by @epage on 2024-09-19 21:25_

#5704 previously improved the error message (browse per-commit to see how it evolved).  There isn't a `#[diagnostic]` for our case to further improve it.

---

_Comment by @Sciencentistguy on 2024-09-19 21:30_

I see. Thanks for the quick reply and explanation ðŸ™‚ 

Maybe if/when `#[diagnostic]` becomes a thing, this could be improved

---

_Label `A-derive` added by @epage on 2024-09-19 21:34_

---

_Label `S-blocked` added by @epage on 2024-09-19 21:34_

---
