---
number: 2197
title: Fatal internal error
type: issue
state: closed
author: AldaronLau
labels: []
assignees: []
created_at: 2020-11-01T18:41:24Z
updated_at: 2020-11-03T21:40:52Z
url: https://github.com/clap-rs/clap/issues/2197
synced_at: 2026-01-07T12:31:17-06:00
---

# Fatal internal error

---

_Issue opened by @AldaronLau on 2020-11-01 18:41_

### Code

https://github.com/fornwall/rust-script

### Steps to reproduce the issue

1. Run `cargo install rust-script`
2. Run `rust-script --build-only script-name.rs`

### Version

* **Rust**: rustc 1.47.0 (18bf6b4f0 2020-10-07)
* **Clap**: 2.33.3

### Actual Behavior Summary

When I add `--build-only` option before the next argument, it crashes on internal error, and I think it shouldn't.  Interestingly, this doesn't happen for other options like `--debug` (leaving everything else the same).

**I would like to use rust-script (which depends on clap) for stick, and this makes it so I can't use the --build-only option.**

### Expected Behavior Summary

It should not crash internally within the clap library, even if it is a rust-script bug.

### Debug output

<details>
<summary> Debug Output </summary>
<pre>
<code>

DEBUG:clap:Parser::propagate_settings: self=rust-script, g_settings=AppFlags(
    (empty),
)
DEBUG:clap:Parser::get_matches_with;
DEBUG:clap:Parser::create_help_and_version;
DEBUG:clap:Parser::create_help_and_version: Building --help
DEBUG:clap:Parser::create_help_and_version: Building --version
DEBUG:clap:Parser::get_matches_with: Begin parsing '"--build-only"' ([45, 45, 98, 117, 105, 108, 100, 45, 111, 110, 108, 121])
DEBUG:clap:Parser::is_new_arg:"--build-only":NotFound
DEBUG:clap:Parser::is_new_arg: arg_allows_tac=false
DEBUG:clap:Parser::is_new_arg: -- found
DEBUG:clap:Parser::is_new_arg: starts_new_arg=true
DEBUG:clap:Parser::possible_subcommand: arg="--build-only"
DEBUG:clap:Parser::get_matches_with: possible_sc=false, sc=None
DEBUG:clap:ArgMatcher::process_arg_overrides:None;
DEBUG:clap:Parser::parse_long_arg;
DEBUG:clap:Parser::parse_long_arg: Does it contain '='...No
DEBUG:clap:Parser::parse_long_arg: Found valid flag '--build-only'
DEBUG:clap:Parser::check_for_help_and_version_str;
DEBUG:clap:Parser::check_for_help_and_version_str: Checking if --build-only is help or version...Neither
DEBUG:clap:Parser::parse_flag;
DEBUG:clap:ArgMatcher::inc_occurrence_of: arg=build_only
DEBUG:clap:ArgMatcher::inc_occurrence_of: first instance
DEBUG:clap:Parser::groups_for_arg: name=build_only
DEBUG:clap:Parser::groups_for_arg: Searching through groups...
DEBUG:clap:Parser:get_matches_with: After parse_long_arg Flag
DEBUG:clap:Parser::get_matches_with: Begin parsing '"fmt_db.rs"' ([102, 109, 116, 95, 100, 98, 46, 114, 115])
DEBUG:clap:Parser::is_new_arg:"fmt_db.rs":Flag
DEBUG:clap:Parser::is_new_arg: arg_allows_tac=false
DEBUG:clap:Parser::is_new_arg: probably value
DEBUG:clap:Parser::is_new_arg: starts_new_arg=false
DEBUG:clap:Parser::possible_subcommand: arg="fmt_db.rs"
DEBUG:clap:Parser::get_matches_with: possible_sc=false, sc=None
DEBUG:clap:Parser::get_matches_with: Positional counter...1
DEBUG:clap:Parser::get_matches_with: Low index multiples...false
DEBUG:clap:ArgMatcher::process_arg_overrides:Some("build_only");
DEBUG:clap:Parser::add_val_to_arg; arg=command, val="fmt_db.rs"
DEBUG:clap:Parser::add_val_to_arg; trailing_vals=true, DontDelimTrailingVals=false
DEBUG:clap:Parser::add_single_val_to_arg;
DEBUG:clap:Parser::add_single_val_to_arg: adding val..."fmt_db.rs"
DEBUG:clap:Parser::groups_for_arg: name=command
DEBUG:clap:Parser::groups_for_arg: Searching through groups...
DEBUG:clap:ArgMatcher::needs_more_vals: o=command
DEBUG:clap:ArgMatcher::inc_occurrence_of: arg=command
DEBUG:clap:Parser::groups_for_arg: name=command
DEBUG:clap:Parser::groups_for_arg: Searching through groups...
DEBUG:clap:ArgMatcher::process_arg_overrides:Some("command");
DEBUG:clap:Parser::remove_overrides:[];
DEBUG:clap:Validator::validate;
DEBUG:clap:Parser::add_defaults;
DEBUG:clap:Parser::add_defaults:iter:dep: doesn't have conditional defaults
DEBUG:clap:Parser::add_defaults:iter:dep: doesn't have default vals
DEBUG:clap:Parser::add_defaults:iter:dep_extern: doesn't have conditional defaults
DEBUG:clap:Parser::add_defaults:iter:dep_extern: doesn't have default vals
DEBUG:clap:Parser::add_defaults:iter:extern: doesn't have conditional defaults
DEBUG:clap:Parser::add_defaults:iter:extern: doesn't have default vals
DEBUG:clap:Parser::add_defaults:iter:features: doesn't have conditional defaults
DEBUG:clap:Parser::add_defaults:iter:features: doesn't have default vals
DEBUG:clap:Parser::add_defaults:iter:unstable_features: doesn't have conditional defaults
DEBUG:clap:Parser::add_defaults:iter:unstable_features: doesn't have default vals
DEBUG:clap:Parser::add_defaults:iter:pkg_path: doesn't have conditional defaults
DEBUG:clap:Parser::add_defaults:iter:pkg_path: doesn't have default vals
DEBUG:clap:Parser::add_defaults:iter:template: doesn't have conditional defaults
DEBUG:clap:Parser::add_defaults:iter:template: doesn't have default vals
DEBUG:clap:Parser::add_defaults:iter:command: doesn't have conditional defaults
DEBUG:clap:Parser::add_defaults:iter:command: doesn't have default vals
DEBUG:clap:Validator::validate_blacklist;
DEBUG:clap:Validator::validate_blacklist:iter:build_only;
DEBUG:clap:Parser::groups_for_arg: name=build_only
DEBUG:clap:Parser::groups_for_arg: Searching through groups...
DEBUG:clap:Validator::validate_blacklist:iter:command;
DEBUG:clap:Parser::groups_for_arg: name=command
DEBUG:clap:Parser::groups_for_arg: Searching through groups...
DEBUG:clap:Validator::validate_required: required=["command"];
DEBUG:clap:Validator::validate_required:iter:command:
DEBUG:clap:Validator::validate_matched_args;
DEBUG:clap:Validator::validate_matched_args:iter:build_only: vals=[]
DEBUG:clap:Validator::validate_arg_requires:build_only;
DEBUG:clap:Validator::missing_required_error: extra=Some("script")
DEBUG:clap:Parser::color;
DEBUG:clap:Parser::color: Color setting...Auto
DEBUG:clap:is_a_tty: stderr=true
DEBUG:clap:Validator::missing_required_error: reqs=[
    "script",
]
DEBUG:clap:usage::get_required_usage_from: reqs=["script"], extra=Some("script")
DEBUG:clap:usage::get_required_usage_from: after init desc_reqs=["script"]
DEBUG:clap:usage::get_required_usage_from: no more children
DEBUG:clap:usage::get_required_usage_from: final desc_reqs=["script"]
DEBUG:clap:usage::get_required_usage_from: args_in_groups=[]
DEBUG:clap:usage::get_required_usage_from:iter:script:
thread 'main' panicked at 'Fatal internal error. Please consider filing a bug report at https://github.com/clap-rs/clap/issues', /home/aldaronlau/.cargo/registry/src/github.com-1ecc6299db9ec823/clap-2.33.3/src/app/usage.rs:475:22
note: run with `RUST_BACKTRACE=1` environment variable to display a backtrace

</code>
</pre>
</details>


---

_Label `T: bug` added by @AldaronLau on 2020-11-01 18:41_

---

_Comment by @pksunkara on 2020-11-02 14:54_

Can you please try to provide us with a minimal reproducible example?

---

_Label `:money_with_wings: $5` added by @pksunkara on 2020-11-02 14:54_

---

_Label `C: usage strings` added by @pksunkara on 2020-11-02 14:54_

---

_Comment by @AldaronLau on 2020-11-03 00:42_

@pksunkara I have never used this library before - I have no idea how to do anything with it, I only found this bug by using @fornwall's rust-script project.

---

_Comment by @pksunkara on 2020-11-03 06:48_

In that case, what was the command you were running?

---

_Comment by @AldaronLau on 2020-11-03 06:58_

@pksunkara  `rust-script --build-only script-name.rs`

---

_Referenced in [fornwall/rust-script#7](../../fornwall/rust-script/pulls/7.md) on 2020-11-03 21:33_

---

_Comment by @wfraser on 2020-11-03 21:35_

`rust-script` is referencing arguments that don't exist in the `.requires()` and `.conflicts_with()` constraints for these flags. Clap probably just needs to panic with a better error message here.

---

_Comment by @pksunkara on 2020-11-03 21:40_

We should have asserts now in v3 master which produce better error messages. Thanks for looking into it @wfraser.

---

_Closed by @pksunkara on 2020-11-03 21:40_

---

_Label `:money_with_wings: $5` removed by @pksunkara on 2020-11-03 21:40_

---

_Label `T: bug` removed by @pksunkara on 2020-11-03 21:40_

---

_Label `C: usage strings` removed by @pksunkara on 2020-11-03 21:40_

---
