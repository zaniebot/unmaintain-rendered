---
number: 2327
title: Usage string is invalid when conflicting flags are passed
type: issue
state: closed
author: dimo414
labels:
  - C-bug
assignees: []
created_at: 2021-02-05T09:11:07Z
updated_at: 2021-03-11T10:51:12Z
url: https://github.com/clap-rs/clap/issues/2327
synced_at: 2026-01-07T12:31:17-06:00
---

# Usage string is invalid when conflicting flags are passed

---

_Issue opened by @dimo414 on 2021-02-05 09:11_

### Make sure you completed the following tasks

- [x] Searched the [discussions](https://github.com/clap-rs/clap/discussions)
- [x] Searched the closed issues

### Code

```rust
use clap::{Arg, App};

fn main() {
    let app = App::new("demo")
        .arg(Arg::with_name("foo")
            .long("foo")
            .required(true)
            .conflicts_with_all(&["bar", "baz"]))
        .arg(Arg::with_name("bar")
            .long("bar"))
        .arg(Arg::with_name("baz")
            .long("baz")
            .requires("bar"));
    println!("{:?}", app.get_matches_from(&["cmd", "--foo", "--baz"]));
}
```

### Steps to reproduce the issue

Run [the above](https://play.rust-lang.org/?version=stable&mode=debug&edition=2018&gist=1ee68d63ce358ba20cf1659bc5a389ef) and look at the "USAGE" line; it displays `cmd --bar --baz --foo` which is not a valid set of arguments for this App.

### Version

* **Rust**: Output of `rustc -V`: rustc 1.48.0 (7eac88abb 2020-11-16)
* **Clap**: Can be found in Cargo.lock or Cargo.toml of your project (i.e. `grep clap Cargo.lock`). PLEASE DO NOT PUT "latest" HERE, use precise version. Put `master` (or other branch) if you're using the repo directly.: clap = "2.33.3"


---

_Label `T: bug` added by @dimo414 on 2021-02-05 09:11_

---

_Label `C: args` added by @pksunkara on 2021-02-05 09:39_

---

_Label `C: usage strings` added by @pksunkara on 2021-02-05 09:39_

---

_Added to milestone `3.1` by @pksunkara on 2021-02-05 09:39_

---

_Comment by @logansquirel on 2021-03-11 10:44_

Original issue used a combination of `required(true)` and `conflicts_with_all(...)` making other arguments obsolete. However the `USAGE` string is still incorrect without `required(true)`

# `v2.33.3`

`main.rs`: 
```rust
use clap::{App, Arg};

fn main() {
    let app = App::new("demo")
        .arg(
            Arg::with_name("foo")
                .long("foo")
                .conflicts_with("bar"),
        )
        .arg(Arg::with_name("bar").long("bar"));
    app.get_matches();
}
```

```console
❯ cargo tree | rg -w clap
└── clap v2.33.3

❯ cargo run --quiet -- --foo --bar
error: The argument '--bar' cannot be used with '--foo'

USAGE:
    clap_issue_2327 --bar --foo

For more information try --help
```

# `v3.0.0-beta.2` and `master`

`main.rs`:

```rust
use clap::{App, Arg};

fn main() {
    let app = App::new("demo")
        .arg(
            Arg::new("foo")
                .long("foo")
                .conflicts_with("bar"),
        )
        .arg(Arg::new("bar").long("bar"));
    app.get_matches();
}
```

Beta version:

```console
❯ cargo tree | rg -w clap
└── clap v3.0.0-beta.2

❯ cargo run --quiet -- --foo --bar
error: The argument '--bar' cannot be used with '--foo'

USAGE:
    clap_issue_2327 --foo

For more information try --help
```

Master version:

```console
❯ cargo tree | rg -w clap | head -1
└── clap v3.0.0-beta.2 (https://github.com/clap-rs/clap#5618ec39)

❯ cargo run --quiet -- --foo --bar
error: The argument '--bar' cannot be used with '--foo'

USAGE:
    clap_issue_2327 --foo

For more information try --help

❯ cargo run --quiet -- --bar --foo
error: The argument '--foo' cannot be used with '--bar'

USAGE:
    clap_issue_2327 --bar

For more information try --help
```

# Conclusion

The issue seems to be fixed in `v3.0.0-beta.2` and on `master`.

The issue is also covered by [conflict_output_three_conflicting](https://github.com/clap-rs/clap/blob/5618ec39e5b656912f6593e7806e71a507218808/tests/conflicts.rs#L137) test.

---

_Closed by @ldm0 on 2021-03-11 10:51_

---
