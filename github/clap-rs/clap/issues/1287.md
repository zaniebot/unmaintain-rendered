---
number: 1287
title: Incorrect parsing of hyphenized positional arguments with mutiple positionals
type: issue
state: closed
author: hstefan
labels:
  - C-bug
  - A-parsing
  - E-medium
  - E-easy
assignees: []
created_at: 2018-06-04T22:12:22Z
updated_at: 2020-06-30T13:29:38Z
url: https://github.com/clap-rs/clap/issues/1287
synced_at: 2026-01-07T12:31:16-06:00
---

# Incorrect parsing of hyphenized positional arguments with mutiple positionals

---

_Issue opened by @hstefan on 2018-06-04 22:12_

### Rust Version

rustc 1.26.0 (a77568041 2018-05-07)

### Affected Version of clap

clap = "2"

### Sample Code or Link to Sample Code
```rust
let matches = App::new("xargs (clone)")
        .setting(AppSettings::TrailingVarArg)
        .arg(
            Arg::with_name("command")
                .required(true)
                .default_value("echo"))
        .arg(
            Arg::from_usage("[initial-args]... initial arguments for command")
            .allow_hyphen_values(true)
        )
       .get_matches();
```

### Expected Behavior Summary

```./xargs echo du -s ```

"command" should be set to "echo", and "initial-args" should be a list ["du", "-s"]

### Actual Behavior Summary

```error: Found argument '-s' which wasn't expected, or isn't valid in this context```

### Steps to Reproduce the issue

Define app with two or more positional arguments, one of them being varags, and run the program with hyphenized arguments for the varargs.

### Debug output
[log.txt](https://github.com/kbknapp/clap-rs/files/2070128/log.txt)


---

_Comment by @hstefan on 2018-06-04 22:29_

A possible workaround for this issue is using `AllowLeadingHyphen`, but this still has a potential issue of parsing the remaining positionals as actual flags for the program. E.g. when calling "./xargs du -h" we'll print the help text, instead of simply storing "-h" in the list.

---

_Comment by @kbknapp on 2018-06-05 01:09_

@hstefan Thanks!

As per our discussion on Gitter, this is a bug.

Here's my thoughts when it comes to how to fix it:

Assume running `$ xargs du -s` for the following scenario

The reason it's not allowing `-s` even though the last positional arg is allowing values to start with a hyphen is that clap hasn't started parsing that command yet (`initial-args`) and therefore doesn't know how to check whether that arg allows hyphen values or not

The simplified flow of parsing is this (blue is what is happening in your case): 

![flow](https://clap.rs/wp-content/uploads/2018/06/clap-parsing.jpeg)

There are two key parts in your case, when it's checking if the arg it's parsing is part of a value from a previous arg, or a new arg altogether. In this case it's correctly determining that it's a new arg, but because the arg starts with a single `-` it jumps to parsing short arguments. Next it tries to determine if it's an option, a flag, or something unexpected (an error). It first checks all options and finds nothing, so it checks all flags and again finds nothing. So [clap now assumes it's an error, and exits.](https://github.com/kbknapp/clap-rs/blob/f74646de8c94d98db3e50f19846f050f6fee9c76/src/app/parser.rs#L1699-L1704)

Notice how it never goes back and checks if maybe this is just a positional arg that happens to allow values starting with `-`. We can see this is the case by re-running the program with `$ xargs du foo -s` which works as expected. Because once clap realizes it's parsing a positional argument which allows `-` values, at the "Is a value from a previous arg?" section it jumps to parsing the value instead of trying to parse the argument as a flag/option.

So how can we fix it? It's *slightly* more complicated than I'd first thought, but still not too bad. In short, we just need to [save the return value of `parse_short_arg`](https://github.com/kbknapp/clap-rs/blob/f74646de8c94d98db3e50f19846f050f6fee9c76/src/app/parser.rs#L940-L964) (and [here for `parse_long_arg`](https://github.com/kbknapp/clap-rs/blob/f74646de8c94d98db3e50f19846f050f6fee9c76/src/app/parser.rs#L930-L935)) and in the case it's an error for "unknown_arg", allow parsing to continue to the check for positional args.

Hopefully this is a good starting point, please let me know if you get hung up :wink: 

---

_Label `T: bug` added by @kbknapp on 2018-06-05 01:11_

---

_Label `D: easy` added by @kbknapp on 2018-06-05 01:11_

---

_Label `P3: want to have` added by @kbknapp on 2018-06-05 01:11_

---

_Label `C: parsing` added by @kbknapp on 2018-06-05 01:11_

---

_Label `W: 2.x` added by @kbknapp on 2018-06-05 01:11_

---

_Label `M: mentored` added by @kbknapp on 2018-06-05 01:11_

---

_Label `good first issue` added by @kbknapp on 2018-06-05 01:11_

---

_Referenced in [clap-rs/clap#1290](../../clap-rs/clap/pulls/1290.md) on 2018-06-07 21:02_

---

_Comment by @shakyShane on 2019-06-03 12:21_

@kbknapp I'm running into this same issue, where we want to define sub commands (to get auto generated help etc) but for those subcommands to consume all arguments regardless of hyphens.

It looks like a fix was abandonned, is that because there's a separate fix?

Thanks :)

---

_Referenced in [getsentry/sentry-cli#770](../../getsentry/sentry-cli/pulls/770.md) on 2020-06-22 15:42_

---

_Comment by @CreepySkeleton on 2020-06-30 13:29_

I can't reproduce it with master:
```rust
use clap::{App, Arg, AppSettings};

fn main() {
    let _matches = App::new("xargs (clone)")
            .setting(AppSettings::TrailingVarArg)
            .arg(
                Arg::new("command")
                    .required(true)
                    .default_value("echo"))
            .arg(
                Arg::from("[initial-args]... initial arguments for command")
                .allow_hyphen_values(true)
            )
           .get_matches_from(&["xargs",  "echo", "du", "-s"]);

    println!("{:#?}", _matches);
}
```

```
ArgMatches {
    args: {
        command: MatchedArg {
            occurs: 1,
            ty: CommandLine,
            indices: [
                1,
            ],
            vals: [
                "echo",
            ],
        },
        initial-args: MatchedArg {
            occurs: 2,
            ty: CommandLine,
            indices: [
                2,
                3,
            ],
            vals: [
                "du",
                "-s",
            ],
        },
    },
    subcommand: None,
}
```

So let's say it was fixed somewhere along the way :)

---

_Closed by @CreepySkeleton on 2020-06-30 13:29_

---
