---
number: 1596
title: Special characters not escaped for zsh completion script
type: issue
state: open
author: iyzana
labels:
  - C-bug
  - A-completion
  - E-easy
assignees: []
created_at: 2019-11-09T18:56:45Z
updated_at: 2021-12-09T20:21:00Z
url: https://github.com/clap-rs/clap/issues/1596
synced_at: 2026-01-07T12:31:17-06:00
---

# Special characters not escaped for zsh completion script

---

_Issue opened by @iyzana on 2019-11-09 18:56_

<!--
Please use the following template to assist with creating an issue and to ensure a speedy resolution. If an area is not applicable, feel free to delete the area or mark with `N/A`
-->

### Rust Version

rustc 1.38.0 (625451e37 2019-09-23)

### Affected Version of clap

clap 2.33.0

### Expected Behavior Summary

Generated Zsh completions correctly complete `possible_values` even in the presence of characters that have a special meaning for the shell

### Actual Behavior Summary

For example, when some string in `possible_values` contains `|` (a pipe) the generated completion script fails with
```
(eval):1: parse error near `|'
```
when pressing tab for that argument.
That was the problem I ran into. I then tested some other special characters.

A sample of the characters I found to have problems:
- `|` breaks completion script ``(eval):1: parse error near `|'``
- `;` splits completion value into two
- `?` makes whole value not show up in completions
- `*` makes whole value not show up in completions
- `"` breaks completion script `(eval):1: unmatched "`
- `` ` `` breaks completion script ``(eval):1: unmatched ` ``
- `$` interpreted as https://www.gnu.org/software/bash/manual/html_node/Special-Parameters.html when followed by some other chars
- `#` makes whole value not show up in completions

There are more special characters, that need to be escaped. The reproduction from the repo tests against all non control ascii characters and some dollar-something strings.

### Steps to Reproduce the issue

- Clone reproduction repo `git clone https://github.com/succcubbus/clap-zsh-completions-repro`
- `cd clap-zsh-completions-repro`
- `cargo run --release > _clap-zsh-completions-repro`
- Copy `_clap-zsh-completions-repro` somewhere into the `$fpath` of the zsh (e.g. `/usr/local/share/zsh/site-functions`)
- `cargo install --path .`
- `rehash; compinit` (so the zsh picks up the new binary and completions)
- Type `clap-zsh-completions-repro ` and try to complete the argument

### Sample Code or Link to Sample Code

https://github.com/succcubbus/clap-zsh-completions-repro

### Debug output

https://pastebin.com/KU4yd6FR

---

_Comment by @dotboris on 2019-11-10 01:37_

I've hit the same issue in a project, I've had to work around this by rephrasing the `about` of a subcommand. https://github.com/dotboris/alt/commit/37e3255a6d154a57f9cb0ca00150e25312e253b5


---

_Label `C: completion gen` added by @CreepySkeleton on 2020-02-01 11:21_

---

_Added to milestone `3.1` by @pksunkara on 2020-04-09 08:11_

---

_Label `D: easy` added by @CreepySkeleton on 2020-06-30 10:32_

---

_Label `Z: good first issue` added by @CreepySkeleton on 2020-06-30 10:32_

---

_Label `Z: mentored` added by @CreepySkeleton on 2020-06-30 10:32_

---

_Comment by @Nukesor on 2020-09-14 07:48_

`'` also breaks completion when using subcommands, which uses `"` for strings).

---

_Comment by @alerque on 2020-10-28 19:35_

We just hit this in a project too, backticks in a documentation string shouldn't be causing code execution!

In our case we're using the 3.0.0-beta.2 release, so this isn't just 2.x stuff.

https://github.com/theleagueof/fontship/pull/108

---

_Referenced in [theleagueof/fontship#108](../../theleagueof/fontship/pulls/108.md) on 2020-10-28 19:36_

---

_Comment by @pksunkara on 2020-10-28 20:08_

Unfortunately I am still unable to get zsh working properly on my computer. So, I am going to have to rely on contribution

---

_Comment by @alerque on 2020-10-29 18:36_

Would introducing a dependency for this be acceptable? I had a look at what's available now and this would take quite a bit of coding. Most of the current dependencies are focused on Claps' core function: accepting stuff in from the CLI. Passing stuff out to into the CLI (as opposed to just the TTY) would is a bit of a different problem but it seems reasonable to expect Clap to handle this robustly. As the inital report and demo repository note there are a lot of cases involved here. I haven't confirmed if [shell-escape](https://docs.rs/shell-escape/0.1.5/shell_escape/) is actually appropriate or if there are better alternatives, but before I research too much lets hear about whether a dependency to safely handle shell escapeing is going to be allowed.

---

_Comment by @pksunkara on 2020-10-29 18:53_

Since the generator lives in a separate crate and is always opt-in, I would tentatively say yes.

---

_Comment by @pksunkara on 2020-10-29 18:53_

But I don't think there are any crates that do this.

---

_Referenced in [sile-typesetter/cassowary.lua#28](../../sile-typesetter/cassowary.lua/pulls/28.md) on 2020-11-20 11:33_

---

_Referenced in [clap-rs/clap#2276](../../clap-rs/clap/pulls/2276.md) on 2020-12-27 22:39_

---

_Referenced in [tonarino/innernet#156](../../tonarino/innernet/issues/156.md) on 2021-09-21 03:34_

---

_Referenced in [ouch-org/ouch#153](../../ouch-org/ouch/pulls/153.md) on 2021-11-02 22:54_

---

_Referenced in [epage/clapng#129](../../epage/clapng/issues/129.md) on 2021-12-06 18:38_

---

_Removed from milestone `3.1` by @epage on 2021-12-09 20:20_

---

_Label `D: easy` removed by @epage on 2021-12-09 20:21_

---

_Label `E-medium` removed by @epage on 2021-12-09 20:21_

---

_Label `C-bug` added by @epage on 2021-12-09 20:21_

---

_Referenced in [clap-rs/clap#2488](../../clap-rs/clap/issues/2488.md) on 2021-12-22 02:12_

---

_Referenced in [TeXitoi/structopt#461](../../TeXitoi/structopt/issues/461.md) on 2021-12-22 02:17_

---

_Referenced in [void-linux/void-packages#34931](../../void-linux/void-packages/pulls/34931.md) on 2022-02-13 09:27_

---

_Referenced in [ouch-org/ouch#252](../../ouch-org/ouch/pulls/252.md) on 2022-02-13 09:48_

---

_Referenced in [clap-rs/clap#3713](../../clap-rs/clap/pulls/3713.md) on 2022-05-09 22:00_

---
