---
number: 3822
title: Hard to know how to respond to 3.2.0 deprecation messages in the derive API
type: issue
state: closed
author: Alexhuszagh
labels:
  - C-bug
  - E-medium
  - A-derive
assignees: []
created_at: 2022-06-13T14:57:35Z
updated_at: 2024-07-13T22:03:40Z
url: https://github.com/clap-rs/clap/issues/3822
synced_at: 2026-01-07T12:31:17-06:00
---

# Hard to know how to respond to 3.2.0 deprecation messages in the derive API

---

_Issue opened by @Alexhuszagh on 2022-06-13 14:57_

Maintainer's note:
- As of 3.2.3, deprecations are behind the `deprecated` feature which is off by default for now (see #3830)
- Until we improve the messages (if someone steps up to do so), See the [release announcement](https://epage.github.io/blog/2022/02/clap-31-a-step-towards-40/) for more details on the deprecations and [cargo-deny](https://github.com/EmbarkStudios/cargo-deny/pull/431) for an example of how to migrate to clap 3.2 (with a tl;dr).
  - One simple way of reducing the messages is opting into `unstable-v4` feature in your `Cargo.toml`.  See the [changelog](https://github.com/clap-rs/clap/blob/master/CHANGELOG.md) for what else this affects.
- [Explanation of assumptions and circumstances that got us here](https://github.com/clap-rs/clap/issues/3822#issuecomment-1155145825)
---

### Please complete the following tasks

- [X] I have searched the [discussions](https://github.com/clap-rs/clap/discussions)
- [X] I have searched the [open](https://github.com/clap-rs/clap/issues) and [rejected](https://github.com/clap-rs/clap/issues?q=is%3Aissue+label%3AS-wont-fix+is%3Aclosed) issues

### Rust Version

rustc 1.61.0 (fe5b13d68 2022-05-18)

### Clap Version

3.2.1 (or 3.2.0)

### Minimal reproducible code

**main.rs**

```rust
use clap::{Parser, Subcommand};

#[derive(Parser, Debug)]
#[clap(version, about, long_about = None)]
struct Cli {
    #[clap(subcommand)]
    command: Commands,
}

#[derive(Subcommand, Debug)]
enum Commands {
    /// Simple Command.
    GetArgs {
        /// Provide verbose diagnostic output.
        #[clap(short, long)]
        verbose: bool,
        /// Sample optional string.
        #[clap(long)]
        value: Option<String>,
        /// Just a list of valies
        list: Vec<String>
    },
}

fn main() {
    let cli = Cli::parse();
    match &cli.command {
        Commands::GetArgs { verbose, value, list } => {
            println!("verbose={:?}", verbose);
            println!("value={:?}", value);
            println!("list={:?}", list);
        }
    }
}
```

**Cargo.toml**

```toml
[package]
name = "test"
version = "0.1.0"
edition = "2021"

[dependencies]
clap = { version = "3.2.1", features = ["derive"] }
```

### Steps to reproduce the bug with the above code

Use clap >= 3.2.0, this does not produce any warnings in 3.1.18.

```bash
cargo build
```

### Actual Behaviour

```text
warning: use of deprecated unit variant `clap::ArgAction::StoreValue`: Replaced with `ArgAction::Set` or `ArgAction::Append`
  --> src/main.rs:17:9
   |
17 | /         /// Sample optional string.
18 | |         #[clap(long)]
19 | |         value: Option<String>,
   | |_____________________________^
   |
   = note: `#[warn(deprecated)]` on by default

warning: use of deprecated unit variant `clap::ArgAction::StoreValue`: Replaced with `ArgAction::Set` or `ArgAction::Append`
  --> src/main.rs:20:9
   |
20 | /         /// Just a list of valies
21 | |         list: Vec<String>
   | |_________________________^

warning: use of deprecated associated function `clap::ArgMatches::is_present`: Replaced with either `ArgAction::SetTrue` or `ArgMatches::contains_id(...)`
  --> src/main.rs:16:18
   |
16 |         verbose: bool,
   |                  ^^^^

warning: use of deprecated associated function `clap::Arg::<'help>::validator`: Replaced with `Arg::value_parser(...)`
  --> src/main.rs:17:9
   |
17 | /         /// Sample optional string.
18 | |         #[clap(long)]
19 | |         value: Option<String>,
   | |_____________________________^

warning: use of deprecated associated function `clap::Arg::<'help>::multiple_occurrences`: Replaced with `Arg::action` (Issue #3772)
  --> src/main.rs:21:15
   |
21 |         list: Vec<String>
   |               ^^^^^^^^^^^

warning: use of deprecated associated function `clap::Arg::<'help>::validator`: Replaced with `Arg::value_parser(...)`
  --> src/main.rs:20:9
   |
20 | /         /// Just a list of valies
21 | |         list: Vec<String>
   | |_________________________^

warning: `clap` (bin "clap") generated 6 warnings
    Finished dev [unoptimized + debuginfo] target(s) in 0.04s
     Running `target/debug/clap get-args`
```

### Expected Behaviour

None of these warnings should occur, I believe.

### Additional Context

_No response_

### Debug Output

The debug output is the same as the above output.

---

_Label `C-bug` added by @Alexhuszagh on 2022-06-13 14:57_

---

_Renamed from "New Version Produces Numerous Spurious Deprecation Warnings" to "Clap 3.2.0Produces Numerous Spurious Deprecation Warnings" by @Alexhuszagh on 2022-06-13 14:58_

---

_Referenced in [cross-rs/cross#786](../../cross-rs/cross/pulls/786.md) on 2022-06-13 14:59_

---

_Renamed from "Clap 3.2.0Produces Numerous Spurious Deprecation Warnings" to "Clap 3.2.0 Produces Numerous Spurious Deprecation Warnings in the Derive API" by @Alexhuszagh on 2022-06-13 15:00_

---

_Referenced in [daac-tools/daachorse#50](../../daac-tools/daachorse/pulls/50.md) on 2022-06-13 15:04_

---

_Referenced in [taiki-e/cargo-llvm-cov#185](../../taiki-e/cargo-llvm-cov/pulls/185.md) on 2022-06-13 15:05_

---

_Comment by @epage on 2022-06-13 15:30_

These deprecation warnings are intentional though, due to the derive API wrapping the builder API, the fix might not be as obvious.  We do expect to be adding deprecations every minor release and we recommend not blocking CI on this as the toil adds backpressure on crates to not evolve their API.  See the [3.1 announcement for details on this](https://epage.github.io/blog/2022/02/clap-31-a-step-towards-40/).

See the [release announcement](https://epage.github.io/blog/2022/02/clap-31-a-step-towards-40/) for more details on the deprecations and [cargo-deny](https://github.com/EmbarkStudios/cargo-deny/pull/431) for an example of how to migrate to clap 3.2 (with a tl;dr).

---

_Closed by @epage on 2022-06-13 15:30_

---

_Comment by @Emilgardis on 2022-06-13 15:45_

~~So how does one fix the deprecation warnings with the above sample code?~~

nvm, follow the tldr in cargo-deny

---

_Comment by @CraZySacX on 2022-06-13 15:45_

Shouldn't non-deprecated code be "selected" per the docs:  `When not present: will auto-select an implementation based on the field type`

Based off of this I assumed `value-parser` is always used, but it seems to use deprecated code when I don't have it explicitly specified.

---

_Comment by @Alexhuszagh on 2022-06-13 15:46_

> So how does one fix the deprecation warnings with the above sample code?

Change everything to say, `#[clap(value_parser)`, which clutters up everything. See [this](https://github.com/clap-rs/clap/commit/e23800e10e104084a06e030b205b27620d230415#diff-0ba753707cd668805766f29628117900bf44246034221b044b57948dccf54913).

---

_Comment by @epage on 2022-06-13 15:55_

> Shouldn't non-deprecated code be "selected" per the docs: When not present: will auto-select an implementation based on the field type

The problem is the new behavior is a breaking change, so you need to opt-in to it.  In clap 4.0, we'll make it the default.

> Change everything to say, #[clap(value_parser), which clutters up everything.

Yes, it clutters things up but it also let's you start testing with the clap 4.0 behavior and provide feedback.  If you would rather wait, you also always `allow` these deprecations.

---

_Comment by @Alexhuszagh on 2022-06-13 15:58_

> > Shouldn't non-deprecated code be "selected" per the docs: When not present: will auto-select an implementation based on the field type
> 
> The problem is the new behavior is a breaking change, so you need to opt-in to it. In clap 4.0, we'll make it the default.

Maybe change the deprecation warnings then in the derive API? Use `#[allow(deprecated)]` and then change the deprecation warning so you mention the default behavior is changing, and mention that the default behavior is changing in 4.0, you probably want to add `value_parser`? These deprecation notices are relatively opaque since they reference a different API than the one currently used, and have no mention of how they arise.

I'm glad to at least see the default behavior will change.

---

_Renamed from "Clap 3.2.0 Produces Numerous Spurious Deprecation Warnings in the Derive API" to "Hard to know how to respond to 3.2.0 deprecation messages in the derive API" by @epage on 2022-06-13 16:18_

---

_Label `E-medium` added by @epage on 2022-06-13 16:18_

---

_Label `A-derive` added by @epage on 2022-06-13 16:18_

---

_Comment by @epage on 2022-06-13 16:20_

I'll go ahead and re-open this for tracking improving of the deprecations within the derive API.  I'm assuming the easiest way is to wrap the existing calls in a function that allows deprecated in its body but adds its own deprecation message specific to the builder.  The challenges will be to not allow too many deprecation messages and not overly contorting the code base for this short-lived, one off need.

I'm unsure if I'll get to this but if someone wants to tackle it, I'll help move it along to be merged.

---

_Reopened by @epage on 2022-06-13 16:20_

---

_Referenced in [clap-rs/clap#3823](../../clap-rs/clap/issues/3823.md) on 2022-06-13 16:21_

---

_Referenced in [rust-lang/rustfmt#5384](../../rust-lang/rustfmt/pulls/5384.md) on 2022-06-13 16:31_

---

_Referenced in [svix/svix-webhooks#505](../../svix/svix-webhooks/pulls/505.md) on 2022-06-13 16:35_

---

_Comment by @aswild on 2022-06-13 16:53_

I skimmed through the docs but couldn't quite figure this out - what's the difference between `value_parser` and `action` when used with defaults in the derive API?

As an example,

```rust
#[derive(Debug, Parser)]
struct Args {
    #[clap(short, long)]
    flag: bool,

    #[clap(short, long)]
    optional: Option<PathBuf>,

    required: String,
}
```

This is what I'm used to writing in 3.0 and 3.1, but gives deprecation warnings in 3.2. Adding either `action` or `value_parser` attributes to each of the fields stops the warnings and seems to produce the same behavior so it's unclear which one should be used (or is more idiomatic).

On the plus side, the `PathBuf` argument works with invalid UTF-8 in 3.2 without needing `parse(from_os_str)` so that's pretty slick.

---

_Comment by @epage on 2022-06-13 16:59_

> what's the difference between value_parser and action when used with defaults in the derive API?

From https://github.com/EmbarkStudios/cargo-deny/pull/431

> By specifying a default `#[clap(action)]` or `#[clap(value_parser)]` attribute, you opt-in to the new behavior that will be the default in clap 4.0. 

Either attribute can be set to get the behavior slated for 4.0.  You also can explicitly set your action, parser, or both.

Example of setting an [action](https://docs.rs/clap/latest/clap/builder/struct.Arg.html#method.action)
```rust
use clap::Parser;

#[derive(Parser)]
#[clap(author, version, about, long_about = None)]
struct Cli {
    #[clap(short, long, action = clap::ArgAction::Count)]
    verbose: u8,
}

fn main() {
    let cli = Cli::parse();

    println!("verbose: {:?}", cli.verbose);
}
```

Example of setting the [value_parser](https://docs.rs/clap/latest/clap/builder/struct.Arg.html#method.value_parser)
```rust
use clap::Parser;

#[derive(Parser)]
#[clap(author, version, about, long_about = None)]
struct Cli {
    /// Network port to use
    #[clap(value_parser = clap::value_parser!(u16).range(1..))]
    port: u16,
}

fn main() {
    let cli = Cli::parse();

    println!("PORT = {}", cli.port);
}
```

---

_Referenced in [apache/arrow-rs#1867](../../apache/arrow-rs/issues/1867.md) on 2022-06-13 17:12_

---

_Comment by @jplatte on 2022-06-13 17:24_

I really dislike having to add a clap attribute for what seems very close to a no-op in behavior of the resulting binary? Will it behave differently at all for `bool` or `String` arguments with no clap attributes? Anyways, I guess I'll silence the deprecated lint for now, luckily there's only a handful of structs the `#[allow]` needs to go on, because I wouldn't want to use `#![allow(deprecated)]` in a whole module / crate.

edit: Oh no, `#[allow(deprecated)]` on a struct that uses a proc-macro derive doesn't seem to apply to the code generated by that derive. I guess I'll update the clap dependency to `~3.1` then ðŸ˜• 

---

_Referenced in [rust-osdev/uefi-rs#444](../../rust-osdev/uefi-rs/pulls/444.md) on 2022-06-13 17:44_

---

_Referenced in [rust-cli/book#147](../../rust-cli/book/issues/147.md) on 2022-06-13 18:19_

---

_Referenced in [bevyengine/bevy#5005](../../bevyengine/bevy/pulls/5005.md) on 2022-06-13 19:20_

---

_Comment by @steveklabnik on 2022-06-13 19:24_

For anyone who's struggling with `#[clap(help)]`, you'll get something like this:

```text
warning: use of deprecated associated function `clap::Arg::<'help>::validator`: Replaced with `Arg::value_parser(...)`
  --> cmd\vsc7448\src\lib.rs:97:5
   |
97 |     #[clap(help = "MIIM peripheral (0-2)")]
   |     ^

```

The solution is to add `action` on the end:

```rust
#[clap(help = "MIIM peripheral (0-2)", action)]
```

at least, it was for me!

---

_Comment by @epage on 2022-06-13 19:34_

> For anyone who's struggling with #[clap(help)], you'll get something like this:

I really just need to a near total ban on `quote!` in `clap_derive` in favor of `quote_spanned!`.  It is too easy to do a `quote` and overlook how bad any warnings or errors will be related to it.

---

_Referenced in [clap-rs/clap#3824](../../clap-rs/clap/issues/3824.md) on 2022-06-13 19:36_

---

_Comment by @steveklabnik on 2022-06-13 19:39_

Yeah, getting errors like

```
warning: use of deprecated associated function `clap::Arg::<'help>::validator`: Replaced with `Arg::value_parser(...)`
  --> cmd\diagnose\src\lib.rs:53:5
   |
53 |     /// number of milliseconds to sleep trying to catch crashes
   |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

```

is certainly quite confusing!

---

_Comment by @autumnontape on 2022-06-13 21:17_

It would be nice to be able to set one attribute on an entire struct to opt in to the 4.0 behavior instead of adding `action` to each field.

---

_Comment by @epage on 2022-06-13 21:51_

As a step below an attribute, I am experimenting with switching the defaults via the `unstable-v4` feature.  Overall, that flag should be relatively stable as we only expect to respond to feedback during 3.2.x before working on 4.0.0.

If need be, we could possibly break it out into a separate feature.

---

_Comment by @luqmana on 2022-06-13 22:53_

https://github.com/clap-rs/clap/blob/v3.2.1/examples/derive_ref/README.md says that `parse(from_flag = ...)` is not deprecated:
```
parse(<kind> [= <function>]): clap::Arg::validator and clap::ArgMatches::values_of_t

    Deprecated: except for from_flag or from_occurrences, instead use value_parser
```

But I'm still getting a deprecated warning on using it:

```
warning: use of deprecated associated function `clap::ArgMatches::is_present`: Replaced with either `ArgAction::SetTrue` or `ArgMatches::contains_id(...)`
```

Relatedly, is there an equivalent to specifying the parse kind with `value_parser`?

---

_Referenced in [smithy-lang/smithy-rs#1464](../../smithy-lang/smithy-rs/pulls/1464.md) on 2022-06-13 22:57_

---

_Referenced in [daac-tools/daachorse#52](../../daac-tools/daachorse/pulls/52.md) on 2022-06-13 22:58_

---

_Referenced in [clap-rs/clap#3827](../../clap-rs/clap/pulls/3827.md) on 2022-06-13 23:52_

---

_Comment by @epage on 2022-06-13 23:55_

> that `parse(from_flag = ...)` is not deprecated:

Sorry about that, I had forgotten to update it when I had implemented action support.  It is now fixed.

---

_Comment by @Gankra on 2022-06-14 02:16_

Another case that seems unclear. I am using tracing and expose [its LevelFilter type](https://docs.rs/tracing/latest/tracing/level_filters/struct.LevelFilter.html) on cli with:

```rust
    /// How verbose logging should be (log level)
    #[clap(long)]
    #[clap(default_value_t = LevelFilter::WARN)]
    #[clap(possible_values = ["off", "error", "warn", "info", "debug", "trace"])]
    pub verbose: LevelFilter,
```

This type isn't an enum and it's not under my control, so I can't derive/impl anything clap-related on it. However it implemented from_str in the way you expect, so I can just list off the cases I support as strings and clap handles it nice and cleanly.

Under the new system as far as I can tell I'm just supposed to slap `action` on the end of everything, which mostly works, but clap still complains:

```
warning: use of deprecated associated function `clap::Arg::<'help>::possible_values`: Replaced with `Arg::value_parser(PossibleValuesParser::new(...)).takes_value(true)`
  --> src\cli.rs:48:12
   |
48 |     #[clap(possible_values = ["off", "error", "warn", "info", "debug", "trace"])]
   |            ^^^^^^^^^^^^^^^
   |
   = note: `#[warn(deprecated)]` on by default
```

As best as I can tell, it wants me to write:

```rust
    /// How verbose logging should be (log level)
    #[clap(long, value_parser = clap::builder::PossibleValuesParser::new(["off", "error", "warn", "info", "debug", "trace"]))]
    #[clap(default_value_t = LevelFilter::WARN)]
    pub verbose: LevelFilter,
```

Which does indeed compile without any complaints, but then my snapshot tests explode at runtime with

```
thread 'main' panicked at 'Mismatch between definition and access of `verbose`. 
Could not downcast to tracing_core::metadata::LevelFilter, need to downcast to alloc::string::String', src\cli.rs:45:5
```

Am I doing it wrong, or is my usecase no longer supported and I need to write some proxy builder trait impl? Was I holding it wrong all along and just found some accidental magical functionality?


---

_Comment by @birkenfeld on 2022-06-14 04:55_

Adding my 2 cents here, as a derive user I basically have the same experience as others in this issue:

* appearance of heaps of warnings in a semver-compatible update (deprecations shouldn't be done lightly, think of people who `#[deny(warnings)]` in CI)
* unhelpful deprecation messages for derive users
* forced addition of verbosity with `action` or `value_parser` - why does clap need this for a simple `bool` or `String` field?
* no clarity which of the two is the way to go ("Either attribute can be set to get the behavior slated for 4.0." implies they do the same thing)
* all-in-all feeling of being a second-class citizen as a derive user

My suggestions:

* let the derive machinery add `#[allow()]` tags for the underlying deprecations, check itself for deprecated behavior and emit e.g. one deprecation warning per struct with a helpful hint.

Honestly, this shouldn't an "if someone gets around to it" item, this should be a "release blocker" item. Both derive and builder APIs are supposed to be supported equally well.

* make such sweeping deprecations in major versions in the future. Version numbers are cheap, there's no shame in using 4.0 as a transitional release, and 5.0 as the "nirvana" release.

IMO you'll get a lot of [this kind of reaction](https://github.com/Byron/gitoxide/commit/ac0528425e455dd2140623decbd946e66d202e8d) combined with a bad aftertaste, with the current approach.

Just as an observation, the clap 2+structopt to clap 3.0 upgrade was a breeze in comparison, and that involved a major jump and switching libraries...

---

_Referenced in [openrr/openrr#618](../../openrr/openrr/pulls/618.md) on 2022-06-14 06:00_

---

_Referenced in [mozilla/uniffi-rs#1273](../../mozilla/uniffi-rs/pulls/1273.md) on 2022-06-14 07:18_

---

_Referenced in [qdrant/qdrant#686](../../qdrant/qdrant/pulls/686.md) on 2022-06-14 07:51_

---

_Referenced in [pendulum-project/ntpd-rs#146](../../pendulum-project/ntpd-rs/pulls/146.md) on 2022-06-14 07:52_

---

_Referenced in [matrix-org/matrix-rust-sdk#761](../../matrix-org/matrix-rust-sdk/pulls/761.md) on 2022-06-14 08:14_

---

_Comment by @Licenser on 2022-06-14 10:00_

I wanted to add here that I share the frustration, I understand that software evolves and needs to move forward but the way this was done seems to be quite painful for users.

I'll not re-iterate the points previously made about error messages, and verbosity, but add something that I think was missed so far. 

A change like this should have been called out loud and clear in the release notes for 3.2.1. When I saw the deprecation warning I looked over them and (even after reading this thread and with trial and error putting things together) don't see any note in there that could lead a reasonable person to the conclusion of what the upgrade path from `3.1` to `3.2` is.

It doesn't help that the documentation for the function only mentions the arg builder and is written in a way that seems to expect to already understand what they do not explain what they do to someone that doesn't know them yet.


---

_Referenced in [tremor-rs/tremor-runtime#1744](../../tremor-rs/tremor-runtime/pulls/1744.md) on 2022-06-14 11:36_

---

_Comment by @epage on 2022-06-14 11:46_

@Gankra
> Another case that seems unclear. I am using tracing and expose [its LevelFilter type](https://docs.rs/tracing/latest/tracing/level_filters/struct.LevelFilter.html) on cli with:
> 
> ```rust
>     /// How verbose logging should be (log level)
>     #[clap(long)]
>     #[clap(default_value_t = LevelFilter::WARN)]
>     #[clap(possible_values = ["off", "error", "warn", "info", "debug", "trace"])]
>     pub verbose: LevelFilter,
> ```
> 
> This type isn't an enum and it's not under my control, so I can't derive/impl anything clap-related on it. However it implemented from_str in the way you expect, so I can just list off the cases I support as strings and clap handles it nice and cleanly.

The new design presupposes the field type when using possible values is a `String`.  In the short term, you would need to write your own `TypedValueParser` and do `#[clap(value_parser = LevelFilterValueParser)]`.  See [PossibleValuesParser](https://docs.rs/clap/latest/src/clap/builder/value_parser.rs.html#982) for inspiration.  I'd also say feel free to open an issue requesting native support for this.  I held off on natively supporting this because I was unsure how much it would be needed and what the combination of needs would be (would `FromStr` be sufficient or would it need to compose with another `TypedValueParser`, etc).

---

_Comment by @epage on 2022-06-14 12:10_

3.2.2 was just released:
- It slightly improved the span for the warnings
- Enabling the `unstable-v4` feature will now opt people into the new default

I also expanded some in the compatibility section of the changelog for 3.2.0 on this topic.

The main two things that derive users need to be aware of for `unstable-v4` are:
- The doc comments for `ValueEnum` will now show up in the `--help`
- We no longer rename the `Arg::id`, so the case will need to be changed when referencing an argument/field with `ArgGroup`, `default_value_if`, `required_if_eq`, etc.

---

_Comment by @de-vri-es on 2022-06-14 12:25_

That great news! But I'm still a bit hesitant to add a `unstable-v4` feature to a dependency. It would still be awesome if there was a smooth upgrade path from 3.1 to 3.2 that doesn't add tons of deprecation warnings, doesn't require cluttering your struct definition and doesn't require enabling unstable `clap` features :] 

---

_Comment by @epage on 2022-06-14 12:27_

Yes, I can understand people might not want to opt-in to `unstable-v4`.  However, it was a fast, fairly safe, and long-term compatible change so I could get it into people's hands quickly while I also look into other options.

---

_Comment by @de-vri-es on 2022-06-14 12:27_

Makes sense! Thanks for the quick effort :heart: 

---

_Comment by @epage on 2022-06-14 12:52_

Not to excuse how bad it is but some background on how we got to this

First, we have not fully defined what our compatibility guarantees are for `clap_derive`.  For example, is #3280 a breaking change which will change which builder `setting` is used to mark a subcommand as required?  The new behavior in 3.2 changed a lot of how we configure the builder API under the hood it would be difficult to predict how it might interact with attributes (ie builder methods) the user is setting.  In most cases, people won't notice a difference but out of caution we treated this as a breaking change and wanted people to explicitly opt-in to the new behavior.

I had considered more targeted deprecation warnings before release.  In the ideal case, we only `allow` for the implicit builder calls and not for the explicit ones (like `possible_values`).  Since we can't directly inject warnings, we'd have to inject a method and a call to it that has the warning.  Right now, our macro generates chained method calls which makes it difficult to insert targeted `allow`s or wrap parts in function calls.  This also goes through different layers that would need to be changed.  When  updating our test suite (and cargo-deny) to the new behavior, it didn't seem all that bad to add a defaulted attribute, especially in comparison to the work it took to update the test suite for the builder API.  Also, we have generally taken the approach of documenting the principles for how `clap_derive` interacts with the builder API and pointing people to the builder documentation.  This isn't ideal but the cost of maintaining a duplicate of documentation is high.  So with the cost of improving the warnings, our existing approach to documentation, and presumed low cost of updating, we went forward with the approach we did.

---

_Referenced in [clap-rs/clap#3830](../../clap-rs/clap/pulls/3830.md) on 2022-06-14 15:07_

---

_Comment by @epage on 2022-06-14 15:12_

https://github.com/clap-rs/clap/pull/3830 will be hiding deprecations behind the `deprecated` feature flag.  The motivation in the proposal was to allow a staged roll out so we can collect respond to feedback on deprecation messages in the small before showing it to everyone else.  It also has the benefit of allowing people to control when they respond to deprecations (besides `#[allow(deprecated)]`).

---

_Comment by @birkenfeld on 2022-06-14 15:46_

That's a great response, thanks!

---

_Comment by @epage on 2022-06-14 16:21_

3.2.3 is now released with `deprecated` off by default (for now).

I'm leaving this open for further improving the deprecation when it comes time to prepare to update to clap 4.

---

_Comment by @de-vri-es on 2022-06-14 17:57_

Just a though: maybe a nice upgrade path would be to change the scope of the `deprecated` feature somewhere on a next release. Rather than having the deprecations be conditional on the feature, the derive code could add conditional `#[allow(...)]` attributes in the generated code.

I think that way, users of the builder API will get the deprecation warnings as desired, and users of the derive API will probably have a smooth upgrade even to 4.0 without doing anything.

/edit: alternatively, the `deprecated` feature could remain what it is, but go to default-on and the derive macro could just add `#[allow(...)]` statements.

---

_Comment by @epage on 2022-06-14 18:25_

I think the reasons for the `deprecated` feature flag equally apply to the builder API as well as the derive API.  Keep in mind, for however rough the 3.2 upgrade is for derive users, its much worse for builder users.

---

_Comment by @de-vri-es on 2022-06-14 18:37_

Well, I can certainly get on board with having deprecations before a major release. It's nice to get a warning ahead of time.

But it seems now that the only way to circumvent the warnings with the derive API is to add more attributes that will no longer be needed in 4.0 (unless I misunderstood that, but I'll assume that this is true for now).

So assuming the `deprecate` feature goes to default on, the upgrade path for the derive API would be:
* Bump minimum version to `3.2`.
* Add `action` or `value_parser` attributes.
* Wait for `4.0` and upgrade to it.
* Remove `action` or `value_parser` attributes.

Whereas for the builder API I'm assuming its cleaner (but I don't use it, so I may be wrong):
* Bump minimum version to `3.2`.
* Switch to new API.
* Wait for `4.0` and upgrade to it.

The thing that bugs me with the first upgrade path is temporarily adding and then later removing attributes. With that in mind, it seems reasonable to me to have the derive API add `#[allow(...)]` attributes, and to deal with potential backwards incompatible fallout at the upgrade to `4.0`.

Unless there actually is a way to guide derive users to already fix only the backwards incompatible cases before the `4.0` release, but I'm not that familiar with the exact details to know if that is possible. If not, I would be happier to be forced to deal with the fallout on the major bump than to add temporary attributes now.

---

_Comment by @steveklabnik on 2022-06-14 18:37_

~~One thing I'm stuck on with this: it seems to me like the "add `action` onto everything" steps to move to the new behavior would just lead to then having to remove them all after 4.0 ships. So I've got a bunch of boilerplate now, and then removing a bunch of it in the future. So I'm not sure if that's the intended action for users here or not.~~ @de-vri-es said this better than I did :)

Additionally, with dozens and dozens and dozens of warnings like I have, ideally there'd be a way to split these sorts of changes from other ones. It's really hard to tell in a sea of warnings which are bigger things, like APIs I need to change, and which are these sort of "opt in" changes.

That said, 3.2.3 is building with zero warnings (without the feature) so that certainly already made this easier!

---

_Comment by @epage on 2022-06-14 18:43_

As I'm working to clean up the deprecation messages, I am considering making the default case not warn since the level of breaking change is so minor that people likely don't 
need the deprecation message to help them through the upgrade.

As I said, `deprecated` feature does not resolve this issue but reduces the level of impact as I iterate on the deprecation messages and improve them.

---

_Referenced in [clap-rs/clap#3832](../../clap-rs/clap/pulls/3832.md) on 2022-06-14 19:40_

---

_Comment by @epage on 2022-06-14 20:03_

I just released v3.2.4 which improves the deprecation messages.. You can preview some of the messages in #3832.

I didn't immediately close this issue as fixed by that PR as I wanted to get a feel for people if its sufficient or if people have feedback on further improvements.

---

_Comment by @autumnontape on 2022-06-14 21:20_

@de-vri-es This is why I suggested a struct-level attribute. Adding and later removing one line per `#[derive(Parser)]` struct seems more reasonable to me than modifying many lines per struct and then changing them back later. I'm also not super comfortable with using a non-additive unstable feature for this. I do want to test the new behavior and have updated my projects to use `#[clap(action)]`, though.

---

_Comment by @epage on 2022-06-14 21:26_

@autumnontape if you want to resolve all Builder deprecation messages and not just the ones `clap_derive` exposes in 3.2.4 with the `deprecated` feature, you can enable the `clap_derive/raw-deprecated` feature.

I am unlikely to add a struct-level opt-in at this point
- I'm assuming most people won't care about `clap_derive/raw-deprecated` to take advantage of it
- A `#[clap(action)]` or `#[clap(value_parser)]` doesn't quite make sense at the struct level.  At the field level, we already have the pattern of bald attributes providing a default behavior.  A different name would need to be discussed
- We'd then have to plumb this new attribute in

In balance, the costs don't seem worth the benefit at this time.  If there is enough demand, we can re-evaluate.

---

_Referenced in [databendlabs/openraft#374](../../databendlabs/openraft/pulls/374.md) on 2022-06-15 07:22_

---

_Comment by @Licenser on 2022-06-15 08:29_

ðŸ‘ for the great handling of this! (got to be said :) )

---

_Comment by @steveklabnik on 2022-06-15 19:55_

> I didn't immediately close this issue as fixed by that PR as I wanted to get a feel for people if its sufficient or if people have feedback on further improvements.

I think this works pretty well! a simple `clap = { version = "3.2.3", features = ["deprecated"] }` and I'm off to the races. Errors like this:

```text
warning: use of deprecated unit variant `clap::ArgAction::StoreValue`: Replaced with `ArgAction::Set` or `ArgAction::Append`
  --> cmd\rendmp\src\lib.rs:36:5
   |
36 |     bus: Option<String>,
   |     ^^^
```

This message is *way* better. It would be even nicer if there was a way to actually explain what's going on here; it's confusing at first because this sort of option has *no* clap annotations on it, so it's weird to get a message about a thing I'm not even using (directly, of course, but if I was new I wouldn't have known this). I don't think this is something you can improve, though :)

The only other things I'm unsure about is not related to those messages; I opened a discussion so as not to pollute this ticket with that stuff.

Thanks again, I have to second @Licenser, this is a great handling of this issue :)

---

_Comment by @epage on 2022-06-15 20:00_

> This message is way better. It would be even nicer if there was a way to actually explain what's going on here; it's confusing at first because this sort of option has no clap annotations on it, so it's weird to get a message about a thing I'm not even using (directly, of course, but if I was new I wouldn't have known this). I don't think this is something you can improve, though :)

It should be explaining what is going on and this is a bug.  Could you post a reproduction case?  The messages should either be about attributes you set or be in described in derive terms.  Somehow, this one slipped through.

---

_Comment by @steveklabnik on 2022-06-15 20:24_

You know what, it *might* be my error. I will do so, though I can't right this moment.

---

_Comment by @steveklabnik on 2022-06-15 22:36_

Okay so, I'm kinda stumped at the moment. When i try and create a standalone reproduction, it doesn't warn. The original project is in a workspace, so I thought maybe I had two different versions of clap, but verified that that wasn't an issue either. Will work on reducing tomorrow.

---

_Comment by @steveklabnik on 2022-06-16 17:20_

Ah! For some reason, I was still using 3.2.3, how embarrassing. Everything is great now that I'm on 3.2.5. And also, thanks for improving that one other message too:


```text
warning: use of deprecated function `<QspiArgs as clap::Args>::augment_args::parse_try_from_str`: Replaced with `#[clap(value_parser = ...)]`
   --> cmd\qspi\src\lib.rs:110:30
    |
110 |         parse(try_from_str = parse_int::parse)
    |                              ^^^^^^^^^
    |
    = note: `#[warn(deprecated)]` on by default
```

mentioning the attribute syntax is great here!

---

_Referenced in [oxidecomputer/humility#161](../../oxidecomputer/humility/pulls/161.md) on 2022-06-16 18:12_

---

_Referenced in [paritytech/cumulus#1370](../../paritytech/cumulus/pulls/1370.md) on 2022-06-17 08:54_

---

_Referenced in [paritytech/smoldot#2390](../../paritytech/smoldot/pulls/2390.md) on 2022-06-20 12:14_

---

_Comment by @epage on 2022-07-11 21:58_

I'm going to consider this resolved at this point.

Feel free to open new issues for specific points of feedback on this process.

---

_Closed by @epage on 2022-07-11 21:58_

---

_Referenced in [moonbeam-foundation/nimbus#68](../../moonbeam-foundation/nimbus/pulls/68.md) on 2022-07-16 13:49_

---

_Referenced in [clap-rs/clap#4132](../../clap-rs/clap/issues/4132.md) on 2022-08-27 02:22_

---

_Referenced in [dburgener/cascade#68](../../dburgener/cascade/pulls/68.md) on 2022-11-16 17:21_

---

_Referenced in [hyperium/hyper#3052](../../hyperium/hyper/issues/3052.md) on 2022-12-21 18:15_

---

_Referenced in [clap-rs/clap#5422](../../clap-rs/clap/issues/5422.md) on 2024-03-25 11:06_

---

_Comment by @tsal on 2024-07-13 19:08_

Sure would be nice if examples using `is_present` got removed from the `clap_complete` docs.

---

_Comment by @epage on 2024-07-13 22:03_

Could you point to the example you are referring to?

---
