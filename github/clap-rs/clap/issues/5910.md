---
number: 5910
title: "\"Requires\" restriction is wrongly satisfied by args that share a required group"
type: issue
state: closed
author: 12yanogden
labels:
  - C-bug
  - A-parsing
assignees: []
created_at: 2025-02-15T17:15:26Z
updated_at: 2025-02-17T19:31:46Z
url: https://github.com/clap-rs/clap/issues/5910
synced_at: 2026-01-07T12:31:17-06:00
---

# "Requires" restriction is wrongly satisfied by args that share a required group

---

_Issue opened by @12yanogden on 2025-02-15 17:15_

### Please complete the following tasks

- [x] I have searched the [discussions](https://github.com/clap-rs/clap/discussions)
- [x] I have searched the [open](https://github.com/clap-rs/clap/issues) and [rejected](https://github.com/clap-rs/clap/issues?q=is%3Aissue+label%3AS-wont-fix+is%3Aclosed) issues

### Rust Version

1.82.0

### Clap Version

4.5.29

### Minimal reproducible code

```rust
use clap::{Arg, ArgGroup, Command};

fn init_command() -> Command {
    Command::new("myprog")
        .arg(
            Arg::new("only_required_for_required_group")
                .long("only_required_for_required_group")
                .action(clap::ArgAction::SetTrue),
        )
        .arg(
            Arg::new("required_for_dependent_and_required_group")
                .long("required_for_dependent_and_required_group")
                .action(clap::ArgAction::SetTrue),
        )
        .group(
            ArgGroup::new("required_group")
                .args([
                    "only_required_for_required_group",
                    "required_for_dependent_and_required_group",
                ])
                .required(true),
        )
        .arg(
            Arg::new("dependent")
                .long("dependent")
                .action(clap::ArgAction::SetTrue),
        )
        .group(
            ArgGroup::new("requires_group")
                .args(["dependent"])
                .requires("required_for_dependent_and_required_group"),
        )
}

fn main() {
    let cmd = init_command();
    let matches = cmd.get_matches();
    println!("{:?}", matches);
}

#[cfg(test)]
mod tests {
    use super::*;
    use clap::error::ErrorKind;

    lazy_static::lazy_static! {
        static ref CMD: Command = init_command();
    }

    #[test]
    fn test_missing_required_argument_error() {
        let result = CMD.clone().try_get_matches_from(vec![
            "myprog",
            "--only_required_for_required_group",
            "--dependent",
        ]);

        assert!(result.is_err());
        let err = result.unwrap_err();
        assert_eq!(err.kind(), ErrorKind::MissingRequiredArgument);
    }

    #[test]
    fn test_has_required_argument() {
        let result = CMD.clone().try_get_matches_from(vec![
            "myprog",
            "--required_for_dependent_and_required_group",
            "--dependent",
        ]);

        assert!(result.is_ok());
    }
}
```

### Steps to reproduce the bug with the above code

```bash
cargo test
```

### Actual Behaviour

The test `test_missing_required_argument_error` does not pass, indicating that the `only_required_for_required_group` argument incorrectly satisfies the `requires` restriction on the `requires_group`.

### Expected Behaviour

The test `test_missing_required_argument_error` should pass, indicating that the `only_required_for_required_group` argument does not satisfy the `requires` restriction on the `requires_group`.

### Additional Context

Run these commands to check out the repo dedicated to this issue and reproduce. Easy cheesy.
```bash
git clone https://github.com/12yanogden/clap-issue.git
cd clap-issue
cargo test
```

### Debug Output

```
[clap_builder::builder::command]Command::_do_parse
[clap_builder::builder::command]Command::_do_parse
[clap_builder::builder::command]Command::_build: name="myprog"
[clap_builder::builder::command]Command::_build: name="myprog"
[clap_builder::builder::command]Command::_propagate:myprog
[clap_builder::builder::command]Command::_propagate:myprog
[clap_builder::builder::command]Command::_check_help_and_version:myprog expand_help_tree=false
[clap_builder::builder::command]Command::_check_help_and_version:myprog expand_help_tree=false
[clap_builder::builder::command]Command::long_help_exists
[clap_builder::builder::command]Command::long_help_exists
[clap_builder::builder::command]Command::_check_help_and_version: Building default --help
[clap_builder::builder::command]Command::_check_help_and_version: Building default --help
[clap_builder::builder::command]Command::_propagate_global_args:myprog
[clap_builder::builder::command]Command::_propagate_global_args:myprog
[clap_builder::builder::debug_asserts]Command::_debug_asserts
[clap_builder::builder::debug_asserts]Command::_debug_asserts
[clap_builder::builder::debug_asserts]Arg::_debug_asserts:only_required_for_required_group
[clap_builder::builder::debug_asserts]Arg::_debug_asserts:only_required_for_required_group
[clap_builder::builder::debug_asserts]Arg::_debug_asserts:required_for_dependent_and_required_group
[clap_builder::builder::debug_asserts]Arg::_debug_asserts:required_for_dependent_and_required_group
[clap_builder::builder::debug_asserts]Arg::_debug_asserts:dependent
[clap_builder::builder::debug_asserts]Arg::_debug_asserts:dependent
[clap_builder::builder::debug_asserts]Arg::_debug_asserts:help
[clap_builder::builder::debug_asserts]Arg::_debug_asserts:help
[clap_builder::builder::debug_asserts]Command::_verify_positionals
[clap_builder::builder::debug_asserts]Command::_verify_positionals
[clap_builder::parser::parser]Parser::get_matches_with
[clap_builder::parser::parser]Parser::get_matches_with
[clap_builder::parser::parser]Parser::parse
[clap_builder::parser::parser]Parser::parse
[clap_builder::parser::parser]Parser::get_matches_with: Begin parsing '"--only_required_for_required_group"'
[clap_builder::parser::parser]Parser::get_matches_with: Begin parsing '"--required_for_dependent_and_required_group"'
[clap_builder::parser::parser]Parser::possible_subcommand: arg=Ok("--only_required_for_required_group")
[clap_builder::parser::parser]Parser::possible_subcommand: arg=Ok("--required_for_dependent_and_required_group")
[clap_builder::parser::parser]Parser::get_matches_with: sc=None
[clap_builder::parser::parser]Parser::get_matches_with: sc=None
[clap_builder::parser::parser]Parser::parse_long_arg
[clap_builder::parser::parser]Parser::parse_long_arg
[clap_builder::parser::parser]Parser::parse_long_arg: Does it contain '='...
[clap_builder::parser::parser]Parser::parse_long_arg: Does it contain '='...
[clap_builder::parser::parser]Parser::parse_long_arg: Found valid arg or flag '--only_required_for_required_group'
[clap_builder::parser::parser]Parser::parse_long_arg: Found valid arg or flag '--required_for_dependent_and_required_group'
[clap_builder::parser::parser]Parser::parse_long_arg("only_required_for_required_group"): Presence validated
[clap_builder::parser::parser]Parser::parse_long_arg("required_for_dependent_and_required_group"): Presence validated
[clap_builder::parser::parser]Parser::react action=SetTrue, identifier=Some(Long), source=CommandLine
[clap_builder::parser::parser]Parser::react action=SetTrue, identifier=Some(Long), source=CommandLine
[clap_builder::parser::parser]Parser::react: has default_missing_vals
[clap_builder::parser::parser]Parser::react: has default_missing_vals
[clap_builder::parser::parser]Parser::remove_overrides: id="only_required_for_required_group"
[clap_builder::parser::parser]Parser::remove_overrides: id="required_for_dependent_and_required_group"
[clap_builder::parser::arg_matcher]ArgMatcher::start_custom_arg: id="only_required_for_required_group", source=CommandLine
[clap_builder::parser::arg_matcher]ArgMatcher::start_custom_arg: id="required_for_dependent_and_required_group", source=CommandLine
[clap_builder::builder::command]Command::groups_for_arg: id="only_required_for_required_group"
[clap_builder::builder::command]Command::groups_for_arg: id="required_for_dependent_and_required_group"
[clap_builder::parser::arg_matcher]ArgMatcher::start_custom_arg: id="required_group", source=CommandLine
[clap_builder::parser::arg_matcher]ArgMatcher::start_custom_arg: id="required_group", source=CommandLine
[clap_builder::parser::parser]Parser::push_arg_values: ["true"]
[clap_builder::parser::parser]Parser::push_arg_values: ["true"]
[clap_builder::parser::parser]Parser::add_single_val_to_arg: cur_idx:=1
[clap_builder::parser::parser]Parser::add_single_val_to_arg: cur_idx:=1
[clap_builder::parser::parser]Parser::get_matches_with: After parse_long_arg ValuesDone
[clap_builder::parser::parser]Parser::get_matches_with: Begin parsing '"--dependent"'
[clap_builder::parser::parser]Parser::get_matches_with: After parse_long_arg ValuesDone
[clap_builder::parser::parser]Parser::possible_subcommand: arg=Ok("--dependent")
[clap_builder::parser::parser]Parser::get_matches_with: Begin parsing '"--dependent"'
[clap_builder::parser::parser]Parser::get_matches_with: sc=None
[clap_builder::parser::parser]Parser::possible_subcommand: arg=Ok("--dependent")
[clap_builder::parser::parser]Parser::parse_long_arg
[clap_builder::parser::parser]Parser::get_matches_with: sc=None
[clap_builder::parser::parser]Parser::parse_long_arg: Does it contain '='...
[clap_builder::parser::parser]Parser::parse_long_arg
[clap_builder::parser::parser]Parser::parse_long_arg: Does it contain '='...
[clap_builder::parser::parser]Parser::parse_long_arg: Found valid arg or flag '--dependent'
[clap_builder::parser::parser]Parser::parse_long_arg("dependent"): Presence validated
[clap_builder::parser::parser]Parser::parse_long_arg: Found valid arg or flag '--dependent'
[clap_builder::parser::parser]Parser::react action=SetTrue, identifier=Some(Long), source=CommandLine
[clap_builder::parser::parser]Parser::parse_long_arg("dependent"): Presence validated
[clap_builder::parser::parser]Parser::react: has default_missing_vals
[clap_builder::parser::parser]Parser::react action=SetTrue, identifier=Some(Long), source=CommandLine
[clap_builder::parser::parser]Parser::remove_overrides: id="dependent"
[clap_builder::parser::parser]Parser::react: has default_missing_vals
[clap_builder::parser::arg_matcher]ArgMatcher::start_custom_arg: id="dependent", source=CommandLine
[clap_builder::parser::parser]Parser::remove_overrides: id="dependent"
[clap_builder::builder::command]Command::groups_for_arg: id="dependent"
[clap_builder::parser::arg_matcher]ArgMatcher::start_custom_arg: id="dependent", source=CommandLine
[clap_builder::parser::arg_matcher]ArgMatcher::start_custom_arg: id="requires_group", source=CommandLine
[clap_builder::builder::command]Command::groups_for_arg: id="dependent"
[clap_builder::parser::parser]Parser::push_arg_values: ["true"]
[clap_builder::parser::arg_matcher]ArgMatcher::start_custom_arg: id="requires_group", source=CommandLine
[clap_builder::parser::parser]Parser::add_single_val_to_arg: cur_idx:=2
[clap_builder::parser::parser]Parser::push_arg_values: ["true"]
[clap_builder::parser::parser]Parser::get_matches_with: After parse_long_arg ValuesDone
[clap_builder::parser::parser]Parser::add_single_val_to_arg: cur_idx:=2
[clap_builder::parser::parser]Parser::add_defaults
[clap_builder::parser::parser]Parser::add_defaults:iter:only_required_for_required_group:
[clap_builder::parser::parser]Parser::get_matches_with: After parse_long_arg ValuesDone
[clap_builder::parser::parser]Parser::add_default_value: doesn't have conditional defaults
[clap_builder::parser::parser]Parser::add_defaults
[clap_builder::parser::parser]Parser::add_default_value:iter:only_required_for_required_group: has default vals
[clap_builder::parser::parser]Parser::add_defaults:iter:only_required_for_required_group:
[clap_builder::parser::parser]Parser::add_default_value:iter:only_required_for_required_group: was used
[clap_builder::parser::parser]Parser::add_default_value: doesn't have conditional defaults
[clap_builder::parser::parser]Parser::add_defaults:iter:required_for_dependent_and_required_group:
[clap_builder::parser::parser]Parser::add_default_value:iter:only_required_for_required_group: has default vals
[clap_builder::parser::parser]Parser::add_default_value: doesn't have conditional defaults
[clap_builder::parser::parser]Parser::add_default_value:iter:only_required_for_required_group: wasn't used
[clap_builder::parser::parser]Parser::add_default_value:iter:required_for_dependent_and_required_group: has default vals
[clap_builder::parser::parser]Parser::react action=SetTrue, identifier=None, source=DefaultValue
[clap_builder::parser::parser]Parser::add_default_value:iter:required_for_dependent_and_required_group: wasn't used
[clap_builder::parser::arg_matcher]ArgMatcher::start_custom_arg: id="only_required_for_required_group", source=DefaultValue
[clap_builder::parser::parser]Parser::react action=SetTrue, identifier=None, source=DefaultValue
[clap_builder::parser::parser]Parser::push_arg_values: ["false"]
[clap_builder::parser::arg_matcher]ArgMatcher::start_custom_arg: id="required_for_dependent_and_required_group", source=DefaultValue
[clap_builder::parser::parser]Parser::add_single_val_to_arg: cur_idx:=3
[clap_builder::parser::parser]Parser::push_arg_values: ["false"]
[clap_builder::parser::parser]Parser::add_single_val_to_arg: cur_idx:=3
[clap_builder::parser::parser]Parser::add_defaults:iter:required_for_dependent_and_required_group:
[clap_builder::parser::parser]Parser::add_defaults:iter:dependent:
[clap_builder::parser::parser]Parser::add_default_value: doesn't have conditional defaults
[clap_builder::parser::parser]Parser::add_default_value: doesn't have conditional defaults
[clap_builder::parser::parser]Parser::add_default_value:iter:required_for_dependent_and_required_group: has default vals
[clap_builder::parser::parser]Parser::add_default_value:iter:dependent: has default vals
[clap_builder::parser::parser]Parser::add_default_value:iter:required_for_dependent_and_required_group: was used
[clap_builder::parser::parser]Parser::add_default_value:iter:dependent: was used
[clap_builder::parser::parser]Parser::add_defaults:iter:dependent:
[clap_builder::parser::parser]Parser::add_defaults:iter:help:
[clap_builder::parser::parser]Parser::add_default_value: doesn't have conditional defaults
[clap_builder::parser::parser]Parser::add_default_value:iter:dependent: has default vals
[clap_builder::parser::parser]Parser::add_default_value: doesn't have conditional defaults
[clap_builder::parser::parser]Parser::add_default_value:iter:dependent: was used
[clap_builder::parser::parser]Parser::add_default_value:iter:help: doesn't have default vals
[clap_builder::parser::parser]Parser::add_defaults:iter:help:
[clap_builder::parser::validator]Validator::validate
[clap_builder::parser::parser]Parser::add_default_value: doesn't have conditional defaults
[clap_builder::parser::parser]Parser::add_default_value:iter:help: doesn't have default vals
[clap_builder::builder::command]Command::groups_for_arg: id="only_required_for_required_group"
[clap_builder::parser::validator]Validator::validate
[clap_builder::parser::validator]Conflicts::gather_direct_conflicts id="only_required_for_required_group", conflicts=["required_for_dependent_and_required_group"]
[clap_builder::builder::command]Command::groups_for_arg: id="required_for_dependent_and_required_group"
[clap_builder::parser::validator]Conflicts::gather_direct_conflicts id="required_group", conflicts=[]
[clap_builder::parser::validator]Conflicts::gather_direct_conflicts id="required_for_dependent_and_required_group", conflicts=["only_required_for_required_group"]
[clap_builder::builder::command]Command::groups_for_arg: id="dependent"
[clap_builder::parser::validator]Conflicts::gather_direct_conflicts id="required_group", conflicts=[]
[clap_builder::parser::validator]Conflicts::gather_direct_conflicts id="dependent", conflicts=[]
[clap_builder::builder::command]Command::groups_for_arg: id="dependent"
[clap_builder::parser::validator]Conflicts::gather_direct_conflicts id="requires_group", conflicts=[]
[clap_builder::parser::validator]Conflicts::gather_direct_conflicts id="dependent", conflicts=[]
[clap_builder::parser::validator]Validator::validate_conflicts
[clap_builder::parser::validator]Conflicts::gather_direct_conflicts id="requires_group", conflicts=[]
[clap_builder::parser::validator]Validator::validate_exclusive
[clap_builder::parser::validator]Validator::validate_conflicts
[clap_builder::parser::validator]Validator::validate_exclusive:iter:"only_required_for_required_group"
[clap_builder::parser::validator]Validator::validate_exclusive
[clap_builder::parser::validator]Validator::validate_exclusive:iter:"required_group"
[clap_builder::parser::validator]Validator::validate_exclusive:iter:"required_for_dependent_and_required_group"
[clap_builder::parser::validator]Validator::validate_exclusive:iter:"dependent"
[clap_builder::parser::validator]Validator::validate_exclusive:iter:"required_group"
[clap_builder::parser::validator]Validator::validate_exclusive:iter:"requires_group"
[clap_builder::parser::validator]Validator::validate_exclusive:iter:"dependent"
[clap_builder::parser::validator]Validator::validate_conflicts::iter: id="only_required_for_required_group"
[clap_builder::parser::validator]Validator::validate_exclusive:iter:"requires_group"
[clap_builder::parser::validator]Conflicts::gather_conflicts: arg="only_required_for_required_group"
[clap_builder::parser::validator]Validator::validate_conflicts::iter: id="required_for_dependent_and_required_group"
[clap_builder::parser::validator]Conflicts::gather_conflicts: conflicts=[]
[clap_builder::parser::validator]Conflicts::gather_conflicts: arg="required_for_dependent_and_required_group"
[clap_builder::parser::validator]Validator::validate_conflicts::iter: id="dependent"
[clap_builder::parser::validator]Conflicts::gather_conflicts: conflicts=[]
[clap_builder::parser::validator]Conflicts::gather_conflicts: arg="dependent"
[clap_builder::parser::validator]Validator::validate_conflicts::iter: id="dependent"
[clap_builder::parser::validator]Conflicts::gather_conflicts: conflicts=[]
[clap_builder::parser::validator]Conflicts::gather_conflicts: arg="dependent"
[clap_builder::parser::validator]Validator::validate_required: required=ChildGraph([Child { id: "required_group", children: [] }])
[clap_builder::parser::validator]Conflicts::gather_conflicts: conflicts=[]
[clap_builder::parser::validator]Validator::gather_requires
[clap_builder::parser::validator]Validator::validate_required: required=ChildGraph([Child { id: "required_group", children: [] }])
[clap_builder::parser::validator]Validator::gather_requires
[clap_builder::parser::validator]Validator::gather_requires:iter:"only_required_for_required_group"
[clap_builder::parser::validator]Validator::gather_requires:iter:"required_for_dependent_and_required_group"
[clap_builder::parser::validator]Validator::gather_requires:iter:"required_group"
[clap_builder::parser::validator]Validator::gather_requires:iter:"required_group"
[clap_builder::parser::validator]Validator::gather_requires:iter:"required_group":group
[clap_builder::parser::validator]Validator::gather_requires:iter:"required_group":group
[clap_builder::parser::validator]Validator::gather_requires:iter:"dependent"
[clap_builder::parser::validator]Validator::gather_requires:iter:"dependent"
[clap_builder::parser::validator]Validator::gather_requires:iter:"requires_group"
[clap_builder::parser::validator]Validator::gather_requires:iter:"requires_group"
[clap_builder::parser::validator]Validator::gather_requires:iter:"requires_group":group
[clap_builder::parser::validator]Validator::gather_requires:iter:"requires_group":group
[clap_builder::parser::validator]Validator::validate_required: is_exclusive_present=false
[clap_builder::parser::validator]Validator::validate_required: is_exclusive_present=false
[clap_builder::parser::validator]Validator::validate_required:iter:aog="required_for_dependent_and_required_group"
[clap_builder::parser::validator]Validator::validate_required:iter: This is an arg
[clap_builder::parser::arg_matcher]ArgMatcher::get_global_values: global_arg_vec=[]
[clap_builder::parser::validator]Validator::is_missing_required_ok: required_for_dependent_and_required_group
[clap_builder::parser::validator]Conflicts::gather_conflicts: arg="required_for_dependent_and_required_group"
[clap_builder::builder::command]Command::groups_for_arg: id="required_for_dependent_and_required_group"
[clap_builder::parser::validator]Conflicts::gather_direct_conflicts id="required_for_dependent_and_required_group", conflicts=["only_required_for_required_group"]
[clap_builder::parser::validator]Conflicts::gather_conflicts: conflicts=["only_required_for_required_group", "only_required_for_required_group"]
[clap_builder::parser::validator]Validator::is_missing_required_ok: true (self)
[clap_builder::parser::arg_matcher]ArgMatcher::get_global_values: global_arg_vec=[]
```

---

_Label `C-bug` added by @12yanogden on 2025-02-15 17:15_

---

_Renamed from "Requires restriction is wrongly satisfied by args that share a required group" to ""Requires" restriction is wrongly satisfied by args that share a required group" by @12yanogden on 2025-02-16 20:05_

---

_Comment by @epage on 2025-02-17 18:57_

Without digging into this, my guess is that this is because `required_group`s members conflict with each other (because `multiple(true)` is missing).  When an argument is disallowed because of a conflict, it overrides the required status.

---

_Label `A-parsing` added by @epage on 2025-02-17 18:57_

---

_Comment by @epage on 2025-02-17 18:58_

I suspect this is a duplicate of #4707.

---

_Comment by @12yanogden on 2025-02-17 19:21_

> I suspect this is a duplicate of [#4707](https://github.com/clap-rs/clap/issues/4707).

Yes, this issue is a duplicate. I didn't recognize it initially since the syntax in #4707 is so different ðŸ˜…

---

_Closed by @epage on 2025-02-17 19:31_

---
