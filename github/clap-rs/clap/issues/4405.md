---
number: 4405
title: Option to disable runtime-validation in debug release?
type: issue
state: closed
author: fanzeyi
labels:
  - C-bug
  - A-builder
  - S-wont-fix
assignees: []
created_at: 2022-10-19T21:47:40Z
updated_at: 2022-11-08T04:47:43Z
url: https://github.com/clap-rs/clap/issues/4405
synced_at: 2026-01-07T12:31:17-06:00
---

# Option to disable runtime-validation in debug release?

---

_Issue opened by @fanzeyi on 2022-10-19 21:47_

### Please complete the following tasks

- [X] I have searched the [discussions](https://github.com/clap-rs/clap/discussions)
- [X] I have searched the [open](https://github.com/clap-rs/clap/issues) and [rejected](https://github.com/clap-rs/clap/issues?q=is%3Aissue+label%3AS-wont-fix+is%3Aclosed) issues

### Rust Version

rust playground 1.64.0

### Clap Version

4.0.6

### Minimal reproducible code

```rust
use clap::Parser;
use std::path::PathBuf;
use std::io::Result;

fn foobar(input: &str) -> Result<PathBuf> {
    println!("got input: {input}");
    if input.is_empty() {
        Ok(PathBuf::from("/"))
        // Err(std::io::Error::last_os_error())
    } else {
        Ok(PathBuf::from("/"))
    }
}

#[derive(Parser, Debug)]
#[clap(about = "Test")]
struct Args {
    #[clap(value_parser = foobar, default_value = "")]
    path: PathBuf,
}

fn main() {
    let args = Args::parse_from(vec!["binary", "/etc"]);
}
```

https://play.rust-lang.org/?version=stable&mode=debug&edition=2021&gist=42894c861ebd752bb5d6f8624cdb88ca

### Steps to reproduce the bug with the above code

Click Run button in playground.

### Actual Behaviour

`got input` got called twice, once with the default empty string and once with supplied string.

### Expected Behaviour

When the user supplies any value, the default value should not be used and parsed.

It looks like this happens in debug mode for validating supplied default values. Specifically this call here: 

https://github.com/clap-rs/clap/blob/6328c14c0c1ef256f7b40024289123da9dc2f40d/src/builder/command.rs#L3905-L3906

Would it be possible to consider at least making this configurable? We run tests in both debug and release mode and this discrepancy is hard to work around. I can either write code in my parse function to cheat in debug mode (which is kinda awkward) or to avoid using `default_value` entirely. :(

### Additional Context

_No response_

### Debug Output

_No response_

---

_Label `C-bug` added by @fanzeyi on 2022-10-19 21:47_

---

_Comment by @epage on 2022-10-19 22:18_

Could you expand on why parsing the default twice in debug builds is a problem?

> Would it be possible to consider at least making this configurable? 

One way of doing this is feature flags but they have [problems](https://github.com/clap-rs/clap/issues/4398) and should be limited in when we use them.

We do have `help_expected` and could add another flag like that but we need to make sure this feature pulls its weight for adding more noise to the API (something we are working on reducing).

The original issue is #3202 and PR is #3423.  The big problem we are trying to address is that users can only catch some invalid cases by exhaustive testing of their CLI.  Doing this in debug asserts lets users detect this sooner.

---

_Comment by @fanzeyi on 2022-10-19 22:36_

> Could you expand on why parsing the default twice in debug builds is a problem?

So we are currently using `default_value` in combination with `try_parse_str` to compute a default_value if the user has not supplied it. It depends on where the user's current working directory is and as a result it may produce an error depending on where the user runs it.

I guess our setup isn't really using clap APIs "correctly". The X problem here is that there isn't an API to supply a function to calculate the default value without implementing `Display` or being `OsString` (I'm guessing this is for including the default value in help messages?). We want something like that since computing the default is nontrivial so we want to defer it as late as possible.

>  The big problem we are trying to address is that users can only catch some invalid cases by exhaustive testing of their CLI. Doing this in debug asserts lets users detect this sooner.

I understand the motivation of having this validation and I agree that having clap to validate it before it making to production is very helpful. I'm wondering if we can do the validation separately if we were to have an option disabling this runtime check.

---

_Comment by @epage on 2022-10-20 01:36_

> So we are currently using default_value in combination with try_parse_str to compute a default_value if the user has not supplied it. It depends on where the user's current working directory is and as a result it may produce an error depending on where the user runs it.

If there isn't a default value to show in help, why give the default to clap instead of making the value optional and calculating it after parsing?

btw we are looking at generalizing how defaulting works.  We've started brainstorming it at https://github.com/clap-rs/clap/discussions/3476

---

_Referenced in [clap-rs/clap#4409](../../clap-rs/clap/issues/4409.md) on 2022-11-03 03:17_

---

_Label `S-triage` added by @epage on 2022-11-08 04:27_

---

_Label `A-builder` added by @epage on 2022-11-08 04:27_

---

_Comment by @epage on 2022-11-08 04:47_

As the original request is about providing clap with a sentinel default value that could just as well be handled by not providing a default, I'm inclined to close this.  As listed above, we also are looking at allowing defaults to be handled in a different way.  If people have input on that, see #3476.

---

_Closed by @epage on 2022-11-08 04:47_

---

_Label `S-triage` removed by @epage on 2022-11-08 04:47_

---

_Label `S-wont-fix` added by @epage on 2022-11-08 04:47_

---
