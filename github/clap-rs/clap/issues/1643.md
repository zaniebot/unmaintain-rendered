---
number: 1643
title: "Core Dump and 100% CPU Usage With Mutally `requires()` Args in Clap 3 ( with example )"
type: issue
state: closed
author: zicklag
labels:
  - C-bug
assignees: []
created_at: 2020-01-24T01:17:34Z
updated_at: 2020-04-07T13:59:54Z
url: https://github.com/clap-rs/clap/issues/1643
synced_at: 2026-01-07T12:31:17-06:00
---

# Core Dump and 100% CPU Usage With Mutally `requires()` Args in Clap 3 ( with example )

---

_Issue opened by @zicklag on 2020-01-24 01:17_

<!--
Please use the following template to assist with creating an issue and to ensure a speedy resolution. If an area is not applicable, feel free to delete the area or mark with `N/A`
-->

### Rust Version

* rustc 1.40.0 (73528e339 2019-12-16)
* rustc 1.42.0-nightly (0a58f5864 2020-01-02)

### Affected Version of clap

* `clap = { git = "https://github.com/clap-rs/clap.git", rev="f3683a9", features = ["wrap_help"] }`

> **Note:** This does **not** occur in the latest version of Clap 2.

### Expected Behavior Summary

In the example below, the `-r` and the `-u` argument should be required if either of them are provided.

### Actual Behavior Summary

When I provide one of either `-r`, `-u`, or both the app will freeze, taking up 100% of the CPU core it is running on while continually taking up memory until it crashes because of a failure to allocate memory.

### Steps to Reproduce the issue

Run the code below.

### Sample Code or Link to Sample Code

```rust
use clap::*;

fn main() {
    let app = App::new("test")
        .arg(Arg::with_name("relation_id")
                .help("The relation id to get the data from")
                .long("relation-id")
                .short("r")
                .takes_value(true)
                .requires("remote_unit_name"))
            .arg(Arg::with_name("remote_unit_name")
                .help("The name of the remote unit to get data from")
                .long("remote-unit")
                .short("u")
                .takes_value(true)
                .requires("relation_id"));
                
    app.get_matches_from("test -u hello".split(" "));
}
```

### Debug output

<details>
<summary> Debug Output </summary>
<pre>
<code>

DEBUG:clap:App::_do_parse;
DEBUG:clap:App::_build;
DEBUG:clap:App::_derive_display_order:test
DEBUG:clap:App::_create_help_and_version;
DEBUG:clap:App::_create_help_and_version: Building --help
DEBUG:clap:App::_create_help_and_version: Building --version
DEBUG:clap:App::_arg_debug_asserts:relation_id
DEBUG:clap:App::_arg_debug_asserts:remote_unit_name
DEBUG:clap:App::_arg_debug_asserts:help
DEBUG:clap:App::_arg_debug_asserts:version
DEBUG:clap:App::_app_debug_asserts;
DEBUG:clap:Parser::get_matches_with;
DEBUG:clap:Parser::_build;
DEBUG:clap:Parser::_verify_positionals;
DEBUG:clap:Parser::get_matches_with: Begin parsing '"-u"' ([45, 117])
DEBUG:clap:Parser::is_new_arg:"-u":NotFound
DEBUG:clap:Parser::is_new_arg: arg_allows_tac=false
DEBUG:clap:Parser::is_new_arg: - found
DEBUG:clap:Parser::is_new_arg: starts_new_arg=true
DEBUG:clap:Parser::possible_subcommand: arg="-u"
DEBUG:clap:Parser::get_matches_with: possible_sc=false, sc=None
DEBUG:clap:Parser::parse_short_arg: full_arg="-u"
DEBUG:clap:Parser::parse_short_arg:iter:u
DEBUG:clap:Parser::parse_short_arg:iter:u: Found valid opt or flag
DEBUG:clap:Parser::parse_short_arg:iter:u: p[0]=[], p[1]=[]
DEBUG:clap:Parser::parse_opt; opt=remote_unit_name, val=None
DEBUG:clap:Parser::parse_opt; opt.settings=ArgFlags(TAKES_VAL | DELIM_NOT_SET)
DEBUG:clap:Parser::parse_opt; Checking for val...None
DEBUG:clap:ArgMatcher::inc_occurrence_of: arg=6752898689102734025
DEBUG:clap:ArgMatcher::inc_occurrence_of: first instance
DEBUG:clap:Parser::groups_for_arg: name=6752898689102734025
DEBUG:clap:Parser::parse_opt: More arg vals required...
DEBUG:clap:Parser:get_matches_with: After parse_short_arg Opt(6752898689102734025)
DEBUG:clap:Parser::get_matches_with: Begin parsing '"test"' ([116, 101, 115, 116])
DEBUG:clap:Parser::is_new_arg:"test":Opt(6752898689102734025)
DEBUG:clap:Parser::is_new_arg: arg_allows_tac=false
DEBUG:clap:Parser::is_new_arg: probably value
DEBUG:clap:Parser::is_new_arg: starts_new_arg=false
DEBUG:clap:Parser::add_val_to_arg; arg=remote_unit_name, val="test"
DEBUG:clap:Parser::add_val_to_arg; trailing_vals=false, DontDelimTrailingVals=false
DEBUG:clap:Parser::add_single_val_to_arg;
DEBUG:clap:Parser::add_single_val_to_arg: adding val..."test"
DEBUG:clap:Parser::groups_for_arg: name=6752898689102734025
DEBUG:clap:ArgMatcher::needs_more_vals: o=remote_unit_name
DEBUG:clap:Parser::remove_overrides;
DEBUG:clap:Parser::remove_overrides:iter:6752898689102734025;
DEBUG:clap:Validator::validate;
DEBUG:clap:Parser::add_defaults;
DEBUG:clap:Parser::add_defaults:iter:relation_id: doesn't have conditional defaults
DEBUG:clap:Parser::add_defaults:iter:relation_id: doesn't have default vals
DEBUG:clap:Parser::add_defaults:iter:remote_unit_name: doesn't have conditional defaults
DEBUG:clap:Parser::add_defaults:iter:remote_unit_name: doesn't have default vals
DEBUG:clap:Validator::validate_conflicts;
DEBUG:clap:Validator::validate_conflicts_with_everything;
DEBUG:clap:Validator::validate_conflicts_with_everything:iter:6752898689102734025;
DEBUG:clap:Validator::gather_conflicts;
DEBUG:clap:Validator::gather_conflicts:iter:6752898689102734025;
DEBUG:clap:Parser::groups_for_arg: name=6752898689102734025
DEBUG:clap:Validator::validate_required: required=ChildGraph([]);
DEBUG:clap:Validator::gather_requirements;
DEBUG:clap:Validator::gather_requirements:iter:6752898689102734025;
memory allocation of 2147483648 bytes failedAborted (core dumped)

</code>
</pre>
</details>


---

_Label `T: bug` added by @CreepySkeleton on 2020-02-01 10:09_

---

_Added to milestone `v3.0.0-alpha.3` by @CreepySkeleton on 2020-02-01 10:09_

---

_Assigned to @CreepySkeleton by @CreepySkeleton on 2020-02-12 15:25_

---

_Referenced in [clap-rs/clap#1718](../../clap-rs/clap/pulls/1718.md) on 2020-03-03 19:05_

---

_Closed by @bors[bot] on 2020-03-04 13:09_

---

_Removed from milestone `3.0.0-beta.2` by @pksunkara on 2020-04-07 13:59_

---

_Added to milestone `3.0` by @pksunkara on 2020-04-07 13:59_

---
