---
number: 2458
title: clap_generate 3.0.0-beta.2 panics on generate_to
type: issue
state: closed
author: timvisee
labels: []
assignees: []
created_at: 2021-04-29T17:26:22Z
updated_at: 2021-04-29T17:38:56Z
url: https://github.com/clap-rs/clap/issues/2458
synced_at: 2026-01-07T12:31:17-06:00
---

# clap_generate 3.0.0-beta.2 panics on generate_to

---

_Issue opened by @timvisee on 2021-04-29 17:26_

### Rust Version

* `rustc 1.51.0 (2fd73fabe 2021-03-23)`

### Affected Version of clap

* `3.0.0-beta.2`

### Expected Behavior Summary

When generating completions to a file (with [`generate_to`](https://docs.rs/clap_generate/3.0.0-beta.2/clap_generate/fn.generate_to.html)), a script should be outputted to a file.

### Actual Behavior Summary

When generating completions to a file (with [`generate_to`](https://docs.rs/clap_generate/3.0.0-beta.2/clap_generate/fn.generate_to.html)), it panics. See below.

### Steps to Reproduce the issue

This happens in [`prs`](https://github.com/timvisee/prs). I don't have a minified example yet. This is how to reproduce the panic through `prs`:

```bash
# from binary
prs internal completions bash

# or from source
git clone git@github.com:timvisee/prs.git
cd prs
RUST_BACKTRACE=full cargo run --release -- internal completions bash
```

This panics:

```
    Finished release [optimized] target(s) in 0.10s
     Running `target/release/prs internal completions fish`
Generating completions for fish...thread 'main' panicked at 'called `Option::unwrap()` on a `None` value', /home/timvisee/.cargo/registry/src/github.com-1ecc6299db9ec823/clap_generate-3.0.0-beta.2/src/lib.rs:132:53
stack backtrace:
   0:     0x55c6bbc2fd60 - std::backtrace_rs::backtrace::libunwind::trace::h5e9d00f0cdf4f57e
                               at /rustc/2fd73fabe469357a12c2c974c140f67e7cdd76d0/library/std/src/../../backtrace/src/backtrace/libunwind.rs:90:5
   1:     0x55c6bbc2fd60 - std::backtrace_rs::backtrace::trace_unsynchronized::hd5302bd66215dab9
                               at /rustc/2fd73fabe469357a12c2c974c140f67e7cdd76d0/library/std/src/../../backtrace/src/backtrace/mod.rs:66:5
   2:     0x55c6bbc2fd60 - std::sys_common::backtrace::_print_fmt::ha0237cd11a34e2bf
                               at /rustc/2fd73fabe469357a12c2c974c140f67e7cdd76d0/library/std/src/sys_common/backtrace.rs:67:5
   3:     0x55c6bbc2fd60 - <std::sys_common::backtrace::_print::DisplayBacktrace as core::fmt::Display>::fmt::h171d4c10df1a98ee
                               at /rustc/2fd73fabe469357a12c2c974c140f67e7cdd76d0/library/std/src/sys_common/backtrace.rs:46:22
   4:     0x55c6bbc5548c - core::fmt::write::h89e4288724daa3fa
                               at /rustc/2fd73fabe469357a12c2c974c140f67e7cdd76d0/library/core/src/fmt/mod.rs:1096:17
   5:     0x55c6bbc2af42 - std::io::Write::write_fmt::h6d40f996e84584d9
                               at /rustc/2fd73fabe469357a12c2c974c140f67e7cdd76d0/library/std/src/io/mod.rs:1568:15
   6:     0x55c6bbc325d5 - std::sys_common::backtrace::_print::h0c0b93221682afc8
                               at /rustc/2fd73fabe469357a12c2c974c140f67e7cdd76d0/library/std/src/sys_common/backtrace.rs:49:5
   7:     0x55c6bbc325d5 - std::sys_common::backtrace::print::h57a9f95204c2fdd6
                               at /rustc/2fd73fabe469357a12c2c974c140f67e7cdd76d0/library/std/src/sys_common/backtrace.rs:36:9
   8:     0x55c6bbc325d5 - std::panicking::default_hook::{{closure}}::h4245258b50e37e69
                               at /rustc/2fd73fabe469357a12c2c974c140f67e7cdd76d0/library/std/src/panicking.rs:208:50
   9:     0x55c6bbc32133 - std::panicking::default_hook::h7b00dcc1d0944747
                               at /rustc/2fd73fabe469357a12c2c974c140f67e7cdd76d0/library/std/src/panicking.rs:225:9
  10:     0x55c6bbc32d71 - std::panicking::rust_panic_with_hook::h71e6a073d87de1f5
                               at /rustc/2fd73fabe469357a12c2c974c140f67e7cdd76d0/library/std/src/panicking.rs:591:17
  11:     0x55c6bbc32887 - std::panicking::begin_panic_handler::{{closure}}::hd549436f6bb6dbb8
                               at /rustc/2fd73fabe469357a12c2c974c140f67e7cdd76d0/library/std/src/panicking.rs:495:13
  12:     0x55c6bbc301fc - std::sys_common::backtrace::__rust_end_short_backtrace::h4e5f4b72b04174c3
                               at /rustc/2fd73fabe469357a12c2c974c140f67e7cdd76d0/library/std/src/sys_common/backtrace.rs:141:18
  13:     0x55c6bbc32819 - rust_begin_unwind
                               at /rustc/2fd73fabe469357a12c2c974c140f67e7cdd76d0/library/std/src/panicking.rs:493:5
  14:     0x55c6bbc53ba1 - core::panicking::panic_fmt::hcd56f7f635f62c74
                               at /rustc/2fd73fabe469357a12c2c974c140f67e7cdd76d0/library/core/src/panicking.rs:92:14
  15:     0x55c6bbc53aed - core::panicking::panic::h07405d6be4bce887
                               at /rustc/2fd73fabe469357a12c2c974c140f67e7cdd76d0/library/core/src/panicking.rs:50:5
  16:     0x55c6bb8e6d61 - clap_generate::generate_to::h68171329db40a4bc
  17:     0x55c6bb8f90df - prs::cmd::matcher::internal::completions::Shell::generate_to::h2aca0cf03b2ec7b4
  18:     0x55c6bb8dbed5 - prs::action::internal::completions::Completions::invoke::hd3c268b3e365f39e
  19:     0x55c6bb8e5593 - prs::action::internal::Internal::invoke::hf19c5dee3b9701b5
  20:     0x55c6bb8b0976 - prs::main::h5f53105c97e2e875
  21:     0x55c6bb8b2d13 - std::sys_common::backtrace::__rust_begin_short_backtrace::ha905b9183b3d233c
  22:     0x55c6bb8b2d29 - std::rt::lang_start::{{closure}}::h389692993c9b7c03
  23:     0x55c6bbc33287 - core::ops::function::impls::<impl core::ops::function::FnOnce<A> for &F>::call_once::h527fb2333ede305e
                               at /rustc/2fd73fabe469357a12c2c974c140f67e7cdd76d0/library/core/src/ops/function.rs:259:13
  24:     0x55c6bbc33287 - std::panicking::try::do_call::h309d8aee8149866c
                               at /rustc/2fd73fabe469357a12c2c974c140f67e7cdd76d0/library/std/src/panicking.rs:379:40
  25:     0x55c6bbc33287 - std::panicking::try::h75a60c31fd16bfc6
                               at /rustc/2fd73fabe469357a12c2c974c140f67e7cdd76d0/library/std/src/panicking.rs:343:19
  26:     0x55c6bbc33287 - std::panic::catch_unwind::h1f9892423e99bc00
                               at /rustc/2fd73fabe469357a12c2c974c140f67e7cdd76d0/library/std/src/panic.rs:431:14
  27:     0x55c6bbc33287 - std::rt::lang_start_internal::hd5b67df56ca01dae
                               at /rustc/2fd73fabe469357a12c2c974c140f67e7cdd76d0/library/std/src/rt.rs:51:25
  28:     0x55c6bb8b2c12 - main
  29:     0x7fe4c630b565 - __libc_start_main
  30:     0x55c6bb89009e - _start
  31:                0x0 - <unknown>
```


### Link to Sample Code

 [`generate_to`](https://docs.rs/clap_generate/3.0.0-beta.2/clap_generate/fn.generate_to.html) is called in:

https://github.com/timvisee/prs/blob/b6d1afcfa28388dd7d08342c687de9446df7ef7e/cli/src/action/internal/completions.rs#L49

### Debug output

<details>
<summary> Debug Output </summary>
<pre>
<code>

[            clap::build::app] 	App::_do_parse
[            clap::build::app] 	App::_build
[            clap::build::app] 	App::_propagate:prs-cli
[            clap::build::app] 	App::_propagate:add
[            clap::build::app] 	App::_propagate:clone
[            clap::build::app] 	App::_propagate:duplicate
[            clap::build::app] 	App::_propagate:edit
[            clap::build::app] 	App::_propagate:generate
[            clap::build::app] 	App::_propagate:git
[            clap::build::app] 	App::_propagate:housekeeping
[            clap::build::app] 	App::_propagate:recrypt
[            clap::build::app] 	App::_propagate:run
[            clap::build::app] 	App::_propagate:sync-keys
[            clap::build::app] 	App::_propagate:init
[            clap::build::app] 	App::_propagate:internal
[            clap::build::app] 	App::_propagate:completions
[            clap::build::app] 	App::_propagate:clip-revert
[            clap::build::app] 	App::_propagate:list
[            clap::build::app] 	App::_propagate:move
[            clap::build::app] 	App::_propagate:recipients
[            clap::build::app] 	App::_propagate:add
[            clap::build::app] 	App::_propagate:export
[            clap::build::app] 	App::_propagate:generate
[            clap::build::app] 	App::_propagate:list
[            clap::build::app] 	App::_propagate:remove
[            clap::build::app] 	App::_propagate:remove
[            clap::build::app] 	App::_propagate:show
[            clap::build::app] 	App::_propagate:sync
[            clap::build::app] 	App::_propagate:init
[            clap::build::app] 	App::_propagate:remote
[            clap::build::app] 	App::_propagate:alias
[            clap::build::app] 	App::_propagate:copy
[            clap::build::app] 	App::_derive_display_order:prs-cli
[            clap::build::app] 	App::_derive_display_order:add
[            clap::build::app] 	App::_derive_display_order:clone
[            clap::build::app] 	App::_derive_display_order:duplicate
[            clap::build::app] 	App::_derive_display_order:edit
[            clap::build::app] 	App::_derive_display_order:generate
[            clap::build::app] 	App::_derive_display_order:git
[            clap::build::app] 	App::_derive_display_order:housekeeping
[            clap::build::app] 	App::_derive_display_order:recrypt
[            clap::build::app] 	App::_derive_display_order:run
[            clap::build::app] 	App::_derive_display_order:sync-keys
[            clap::build::app] 	App::_derive_display_order:init
[            clap::build::app] 	App::_derive_display_order:internal
[            clap::build::app] 	App::_derive_display_order:completions
[            clap::build::app] 	App::_derive_display_order:clip-revert
[            clap::build::app] 	App::_derive_display_order:list
[            clap::build::app] 	App::_derive_display_order:move
[            clap::build::app] 	App::_derive_display_order:recipients
[            clap::build::app] 	App::_derive_display_order:add
[            clap::build::app] 	App::_derive_display_order:export
[            clap::build::app] 	App::_derive_display_order:generate
[            clap::build::app] 	App::_derive_display_order:list
[            clap::build::app] 	App::_derive_display_order:remove
[            clap::build::app] 	App::_derive_display_order:remove
[            clap::build::app] 	App::_derive_display_order:show
[            clap::build::app] 	App::_derive_display_order:sync
[            clap::build::app] 	App::_derive_display_order:init
[            clap::build::app] 	App::_derive_display_order:remote
[            clap::build::app] 	App::_derive_display_order:alias
[            clap::build::app] 	App::_derive_display_order:copy
[            clap::build::app] 	App::_create_help_and_version
[            clap::build::app] 	App::_create_help_and_version: Building --help
[            clap::build::app] 	App::_create_help_and_version: Building --version
[            clap::build::app] 	App::_create_help_and_version: Building help
[         clap::parse::parser] 	Parser::get_matches_with
[         clap::parse::parser] 	Parser::_build
[         clap::parse::parser] 	Parser::get_matches_with: Begin parsing '"internal"' ([105, 110, 116, 101, 114, 110, 97, 108])
[         clap::parse::parser] 	Parser::is_new_arg: "internal":NotFound
[         clap::parse::parser] 	Parser::is_new_arg: arg_allows_tac=false
[         clap::parse::parser] 	Parser::is_new_arg: probably value
[         clap::parse::parser] 	Parser::is_new_arg: starts_new_arg=false
[         clap::parse::parser] 	Parser::possible_subcommand: arg="internal"
[         clap::parse::parser] 	Parser::get_matches_with: possible_sc=true, sc=Some("internal")
[         clap::parse::parser] 	Parser::parse_subcommand
[         clap::output::usage] 	Usage::get_required_usage_from: incls=[], matcher=false, incl_last=true
[         clap::output::usage] 	Usage::get_required_usage_from: unrolled_reqs=[]
[         clap::output::usage] 	Usage::get_required_usage_from: ret_val=[]
[            clap::build::app] 	App::_propagate:prs-cli
[            clap::build::app] 	App::_build
[            clap::build::app] 	App::_propagate:internal
[            clap::build::app] 	App::_propagate:completions
[            clap::build::app] 	App::_propagate:clip-revert
[            clap::build::app] 	App::_derive_display_order:internal
[            clap::build::app] 	App::_derive_display_order:completions
[            clap::build::app] 	App::_derive_display_order:clip-revert
[            clap::build::app] 	App::_create_help_and_version
[            clap::build::app] 	App::_create_help_and_version: Building --help
[            clap::build::app] 	App::_create_help_and_version: Building help
[         clap::parse::parser] 	Parser::parse_subcommand: About to parse sc=internal
[         clap::parse::parser] 	Parser::get_matches_with
[         clap::parse::parser] 	Parser::_build
[         clap::parse::parser] 	Parser::get_matches_with: Begin parsing '"completions"' ([99, 111, 109, 112, 108, 101, 116, 105, 111, 110, 115])
[         clap::parse::parser] 	Parser::is_new_arg: "completions":NotFound
[         clap::parse::parser] 	Parser::is_new_arg: arg_allows_tac=false
[         clap::parse::parser] 	Parser::is_new_arg: probably value
[         clap::parse::parser] 	Parser::is_new_arg: starts_new_arg=false
[         clap::parse::parser] 	Parser::possible_subcommand: arg="completions"
[         clap::parse::parser] 	Parser::get_matches_with: possible_sc=true, sc=Some("completions")
[         clap::parse::parser] 	Parser::parse_subcommand
[         clap::output::usage] 	Usage::get_required_usage_from: incls=[], matcher=false, incl_last=true
[         clap::output::usage] 	Usage::get_required_usage_from: unrolled_reqs=[]
[         clap::output::usage] 	Usage::get_required_usage_from: ret_val=[]
[            clap::build::app] 	App::_propagate:internal
[            clap::build::app] 	App::_build
[            clap::build::app] 	App::_propagate:completions
[            clap::build::app] 	App::_derive_display_order:completions
[            clap::build::app] 	App::_create_help_and_version
[            clap::build::app] 	App::_create_help_and_version: Building --help
[         clap::parse::parser] 	Parser::parse_subcommand: About to parse sc=completions
[         clap::parse::parser] 	Parser::get_matches_with
[         clap::parse::parser] 	Parser::_build
[         clap::parse::parser] 	Parser::get_matches_with: Begin parsing '"fish"' ([102, 105, 115, 104])
[         clap::parse::parser] 	Parser::is_new_arg: "fish":NotFound
[         clap::parse::parser] 	Parser::is_new_arg: arg_allows_tac=false
[         clap::parse::parser] 	Parser::is_new_arg: probably value
[         clap::parse::parser] 	Parser::is_new_arg: starts_new_arg=false
[         clap::parse::parser] 	Parser::possible_subcommand: arg="fish"
[         clap::parse::parser] 	Parser::get_matches_with: possible_sc=false, sc=None
[         clap::parse::parser] 	Parser::get_matches_with: Positional counter...1
[         clap::parse::parser] 	Parser::get_matches_with: Low index multiples...false
[         clap::parse::parser] 	Parser::add_val_to_arg; arg=SHELL, val="fish"
[         clap::parse::parser] 	Parser::add_val_to_arg; trailing_vals=false, DontDelimTrailingVals=false
[         clap::parse::parser] 	Parser::add_single_val_to_arg: adding val..."fish"
[            clap::build::app] 	App::groups_for_arg: id=[hash: B2F5AE9E203B56DA]
[    clap::parse::arg_matcher] 	ArgMatcher::needs_more_vals: o=SHELL
[    clap::parse::arg_matcher] 	ArgMatcher::inc_occurrence_of: arg=[hash: B2F5AE9E203B56DA]
[            clap::build::app] 	App::groups_for_arg: id=[hash: B2F5AE9E203B56DA]
[         clap::parse::parser] 	Parser::remove_overrides
[         clap::parse::parser] 	Parser::remove_overrides:iter:[hash: B2F5AE9E203B56DA]
[      clap::parse::validator] 	Validator::validate
[         clap::parse::parser] 	Parser::add_defaults
[         clap::parse::parser] 	Parser::add_defaults:iter:output:
[         clap::parse::parser] 	Parser::add_value: doesn't have conditional defaults
[         clap::parse::parser] 	Parser::add_value:iter:output: doesn't have default vals
[         clap::parse::parser] 	Parser::add_defaults:iter:name:
[         clap::parse::parser] 	Parser::add_value: doesn't have conditional defaults
[         clap::parse::parser] 	Parser::add_value:iter:name: doesn't have default vals
[         clap::parse::parser] 	Parser::add_defaults:iter:SHELL:
[         clap::parse::parser] 	Parser::add_value: doesn't have conditional defaults
[         clap::parse::parser] 	Parser::add_value:iter:SHELL: doesn't have default vals
[      clap::parse::validator] 	Validator::validate_conflicts
[      clap::parse::validator] 	Validator::validate_exclusive
[      clap::parse::validator] 	Validator::validate_exclusive:iter:[hash: B2F5AE9E203B56DA]
[      clap::parse::validator] 	Validator::gather_conflicts
[      clap::parse::validator] 	Validator::gather_conflicts:iter: id=[hash: B2F5AE9E203B56DA]
[            clap::build::app] 	App::groups_for_arg: id=[hash: B2F5AE9E203B56DA]
[      clap::parse::validator] 	Validator::validate_required: required=ChildGraph([Child { id: [hash: B2F5AE9E203B56DA], children: [] }])
[      clap::parse::validator] 	Validator::gather_requirements
[      clap::parse::validator] 	Validator::gather_requirements:iter:[hash: B2F5AE9E203B56DA]
[      clap::parse::validator] 	Validator::validate_required_unless
[      clap::parse::validator] 	Validator::validate_matched_args
[      clap::parse::validator] 	Validator::validate_matched_args:iter:[hash: B2F5AE9E203B56DA]: vals=[
    "fish",
]
[      clap::parse::validator] 	Validator::validate_arg_num_vals
[      clap::parse::validator] 	Validator::validate_arg_values: arg="SHELL"
[      clap::parse::validator] 	Validator::validate_arg_values: possible_vals=["all", "bash", "elvish", "fish", "powershell", "zsh"]
[      clap::parse::validator] 	Validator::validate_arg_requires:"SHELL"
[      clap::parse::validator] 	Validator::validate_arg_num_occurs: "SHELL"=1
[         clap::parse::parser] 	Parser::remove_overrides
[      clap::parse::validator] 	Validator::validate
[         clap::parse::parser] 	Parser::add_defaults
[      clap::parse::validator] 	Validator::validate_conflicts
[      clap::parse::validator] 	Validator::validate_exclusive
[      clap::parse::validator] 	Validator::gather_conflicts
[      clap::parse::validator] 	Validator::validate_required: required=ChildGraph([])
[      clap::parse::validator] 	Validator::gather_requirements
[      clap::parse::validator] 	Validator::validate_required_unless
[      clap::parse::validator] 	Validator::validate_matched_args
[         clap::parse::parser] 	Parser::remove_overrides
[      clap::parse::validator] 	Validator::validate
[         clap::parse::parser] 	Parser::add_defaults
[      clap::parse::validator] 	Validator::validate_conflicts
[      clap::parse::validator] 	Validator::validate_exclusive
[      clap::parse::validator] 	Validator::gather_conflicts
[      clap::parse::validator] 	Validator::validate_required: required=ChildGraph([])
[      clap::parse::validator] 	Validator::gather_requirements
[      clap::parse::validator] 	Validator::validate_required_unless
[      clap::parse::validator] 	Validator::validate_matched_args
[    clap::parse::arg_matcher] 	ArgMatcher::get_global_values: global_arg_vec=[[hash: 593E2995C8A8EE81], [hash: E96939F085BD59A0], [hash: E14CF0E20E4FA03D], [hash: C7F5365A51954C98], [hash: 1EC9D3D5DB2284A6]]


</code>
</pre>
</details>

---

Originally reported here: https://gitlab.com/timvisee/prs/-/issues/35

---

_Comment by @pksunkara on 2021-04-29 17:27_

This has been fixed in master.

---

_Closed by @pksunkara on 2021-04-29 17:27_

---

_Comment by @timvisee on 2021-04-29 17:35_

Thanks a lot for the prompt response! I've just confirmed this.

@pksunkara Could a new beta version including this fix be released soon? I'm currently blocked by this.

---

_Comment by @pksunkara on 2021-04-29 17:37_

Unfortunately a lot of breaking things has changed and I am planning on even more bigger ones. It would be a big mess for updating between these beta releases.

---

_Comment by @timvisee on 2021-04-29 17:38_

I understand. Hope to see a release later. Thanks for looking into it!

---
