---
number: 1479
title: "Using of non-existing argument (or \"help\") in `requires` leads to internal error"
type: issue
state: closed
author: sphynx
labels: []
assignees: []
created_at: 2019-05-26T13:43:56Z
updated_at: 2020-02-01T13:37:39Z
url: https://github.com/clap-rs/clap/issues/1479
synced_at: 2026-01-07T12:31:16-06:00
---

# Using of non-existing argument (or "help") in `requires` leads to internal error

---

_Issue opened by @sphynx on 2019-05-26 13:43_

<!--
Please use the following template to assist with creating an issue and to ensure a speedy resolution. If an area is not applicable, feel free to delete the area or mark with `N/A`
-->

### Rust Version

rustc 1.36-nightly

### Affected Version of clap

2.33.0

### Bug or Feature Request Summary

Using of undefined argument (or even "help") in `Arg::requires` leads to internal error and asks for reporting it as an issue here.

### Expected Behavior Summary

I think it should report something more friendly, like "required parameter is not defined" or something like that. As far as I can tell it's not really an internal error, it's just an error of the library user.

Also, I'm not sure if failing on `requires("help")` is the right approach, since this parameter is auto-generated and technically one should be allowed to require it (unless it is turned off). 

It looks like it's related to #990 but it seems to be closed by now.

I can fix the issue, I think it is caused by using `expected(INTERNAL_ERROR_MSG` in this code: https://github.com/clap-rs/clap/blob/784524f7eb193e35f81082cc69454c8c21b948f7/src/app/usage.rs#L459

But as far as I can see, this approach is used in many places in the code (i.e. looking for something by name and failing with `INTERNAL_ERROR_MSG` if not found), so I am not sure what's the best way to proceed here, please let me know.

### Actual Behavior Summary
```
thread 'main' panicked at 'Fatal internal error. Please consider filing a bug report at https://github.com/clap-rs/clap/issues', src/libcore/option.rs:1036:5
```

### Steps to Reproduce the issue
`cargo run`

### Sample Code or Link to Sample Code
```rust
fn main() {
    let res = App::new("prog")
        .arg(
            Arg::with_name("topic")
                .takes_value(true)
                .requires("help")
                .long("topic"),
        )
        .get_matches_from_safe(vec!["prog", "--topic", "test"]);

    assert!(res.is_err());
}
```

### Debug output

<details>
<summary> Debug Output </summary>
<pre>
<code>
DEBUG:clap:Parser::propagate_settings: self=prog, g_settings=AppFlags(
    (empty),
)
DEBUG:clap:Parser::get_matches_with;
DEBUG:clap:Parser::create_help_and_version;
DEBUG:clap:Parser::create_help_and_version: Building --help
DEBUG:clap:Parser::create_help_and_version: Building --version
DEBUG:clap:Parser::get_matches_with: Begin parsing '"--topic"' ([45, 45, 116, 111, 112, 105, 99])
DEBUG:clap:Parser::is_new_arg:"--topic":NotFound
DEBUG:clap:Parser::is_new_arg: arg_allows_tac=false
DEBUG:clap:Parser::is_new_arg: -- found
DEBUG:clap:Parser::is_new_arg: starts_new_arg=true
DEBUG:clap:Parser::possible_subcommand: arg="--topic"
DEBUG:clap:Parser::get_matches_with: possible_sc=false, sc=None
DEBUG:clap:ArgMatcher::process_arg_overrides:None;
DEBUG:clap:Parser::parse_long_arg;
DEBUG:clap:Parser::parse_long_arg: Does it contain '='...No
DEBUG:clap:OptBuilder::fmt:topic
DEBUG:clap:Parser::parse_long_arg: Found valid opt '--topic <topic>'
DEBUG:clap:Parser::parse_opt; opt=topic, val=None
DEBUG:clap:Parser::parse_opt; opt.settings=ArgFlags(EMPTY_VALS | TAKES_VAL | DELIM_NOT_SET)
DEBUG:clap:Parser::parse_opt; Checking for val...None
DEBUG:clap:ArgMatcher::inc_occurrence_of: arg=topic
DEBUG:clap:ArgMatcher::inc_occurrence_of: first instance
DEBUG:clap:Parser::groups_for_arg: name=topic
DEBUG:clap:Parser::groups_for_arg: No groups defined
DEBUG:clap:Parser::parse_opt: More arg vals required...
DEBUG:clap:Parser:get_matches_with: After parse_long_arg Opt("topic")
DEBUG:clap:Parser::get_matches_with: Begin parsing '"test"' ([116, 101, 115, 116])
DEBUG:clap:Parser::is_new_arg:"test":Opt("topic")
DEBUG:clap:Parser::is_new_arg: arg_allows_tac=false
DEBUG:clap:Parser::is_new_arg: probably value
DEBUG:clap:Parser::is_new_arg: starts_new_arg=false
DEBUG:clap:Parser::add_val_to_arg; arg=topic, val="test"
DEBUG:clap:Parser::add_val_to_arg; trailing_vals=false, DontDelimTrailingVals=false
DEBUG:clap:Parser::add_single_val_to_arg;
DEBUG:clap:Parser::add_single_val_to_arg: adding val..."test"
DEBUG:clap:Parser::groups_for_arg: name=topic
DEBUG:clap:Parser::groups_for_arg: No groups defined
DEBUG:clap:ArgMatcher::needs_more_vals: o=topic
DEBUG:clap:ArgMatcher::process_arg_overrides:Some("topic");
DEBUG:clap:Parser::remove_overrides:[];
DEBUG:clap:Validator::validate;
DEBUG:clap:Parser::add_defaults;
DEBUG:clap:Parser::add_defaults:iter:topic: doesn't have conditional defaults
DEBUG:clap:Parser::add_defaults:iter:topic: doesn't have default vals
DEBUG:clap:Validator::validate_blacklist;
DEBUG:clap:Validator::validate_blacklist:iter:topic;
DEBUG:clap:Parser::groups_for_arg: name=topic
DEBUG:clap:Parser::groups_for_arg: No groups defined
DEBUG:clap:Validator::validate_required: required=[];
DEBUG:clap:Validator::validate_matched_args;
DEBUG:clap:Validator::validate_matched_args:iter:topic: vals=[
    "test",
]
DEBUG:clap:Validator::validate_arg_num_vals:topic
DEBUG:clap:Validator::validate_arg_values: arg="topic"
DEBUG:clap:Validator::validate_arg_requires:topic;
DEBUG:clap:Validator::missing_required_error: extra=Some("help")
DEBUG:clap:Parser::color;
DEBUG:clap:Parser::color: Color setting...Auto
DEBUG:clap:is_a_tty: stderr=true
DEBUG:clap:Validator::missing_required_error: reqs=[
    "help",
]
DEBUG:clap:usage::get_required_usage_from: reqs=["help"], extra=Some("help")
DEBUG:clap:usage::get_required_usage_from: after init desc_reqs=["help"]
DEBUG:clap:usage::get_required_usage_from: no more children
DEBUG:clap:usage::get_required_usage_from: final desc_reqs=["help"]
DEBUG:clap:usage::get_required_usage_from: args_in_groups=[]
DEBUG:clap:usage::get_required_usage_from:iter:help:
thread 'main' panicked at 'Fatal internal error. Please consider filing a bug report at https://github.com/clap-rs/clap/issues', src/libcore/option.rs:1036:5
note: Run with `RUST_BACKTRACE=1` environment variable to display a backtrace.
</code>
</pre>
</details>


---

_Assigned to @CreepySkeleton by @CreepySkeleton on 2020-02-01 13:35_

---

_Label `T: bug` added by @CreepySkeleton on 2020-02-01 13:36_

---

_Label `T: bug` removed by @CreepySkeleton on 2020-02-01 13:36_

---

_Comment by @CreepySkeleton on 2020-02-01 13:37_

I'm almost sure this is the way it should work, but the error message must be more descriptive. Closing in favor of #1644

---

_Closed by @CreepySkeleton on 2020-02-01 13:37_

---
