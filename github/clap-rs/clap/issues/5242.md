---
number: 5242
title: "clap_complete: incorrect args appear on nested subcommands with the same name"
type: issue
state: closed
author: m4rch3n1ng
labels:
  - C-bug
  - E-hard
  - A-completion
assignees: []
created_at: 2023-12-03T11:48:12Z
updated_at: 2024-08-10T00:48:45Z
url: https://github.com/clap-rs/clap/issues/5242
synced_at: 2026-01-07T12:31:17-06:00
---

# clap_complete: incorrect args appear on nested subcommands with the same name

---

_Issue opened by @m4rch3n1ng on 2023-12-03 11:48_

### Please complete the following tasks

- [X] I have searched the [discussions](https://github.com/clap-rs/clap/discussions)
- [X] I have searched the [open](https://github.com/clap-rs/clap/issues) and [rejected](https://github.com/clap-rs/clap/issues?q=is%3Aissue+label%3AS-wont-fix+is%3Aclosed) issues

### Rust Version

rustc 1.75.0-beta.4 (bd45872d9 2023-11-28)

### Clap Version

```toml
[[package]]
name = "clap"
version = "4.4.10"
```

### Minimal reproducible code

```rust
use clap::{Args, CommandFactory, Parser, Subcommand};
use clap_complete::{generate, Shell};

#[derive(Parser)]
struct Cli {
	#[command(subcommand)]
	sub: Option<Top>,
}

#[derive(Subcommand)]
enum Top {
	Config(TopConfigArgs),
	Sync(SyncArgs),
}

#[derive(Args)]
struct TopConfigArgs {
	/// should only appear for top level config
	#[arg(long)]
	test: bool,
}

#[derive(Args)]
struct SyncArgs {
	#[command(subcommand)]
	pub sub: SyncCmd,
}

#[derive(Subcommand)]
enum SyncCmd {
	Config,
}

fn main() {
	let _ = Cli::parse();

	let mut cli = Cli::command();
	generate(Shell::Fish, &mut cli, "stuff", &mut std::io::stdout());
}
```

### Steps to reproduce the bug with the above code

(only tested in fish shell)

```
$ cargo run > complete.fish
$ source complete.fish
```

and then test the completions for `stuff config --` and `stuff sync config --`

### Actual Behaviour


it works as expected if you try to complete for `stuff config --`

![image](https://github.com/clap-rs/clap/assets/63159454/f66b8d03-0820-41e5-aacd-a46ca4f4082b)

but it also shows it as a possible argument for `stuff sync config`

![image](https://github.com/clap-rs/clap/assets/63159454/945a5a6e-f414-4cbc-914a-1476f8ee583b)

even though running `cargo run -- sync config --test` gives an unexpected argument error

![image](https://github.com/clap-rs/clap/assets/63159454/1c6a15be-ec1f-446a-b81a-26e8e5a057e3)


### Expected Behaviour


i would expect the `--test` option to not be suggested for `stuff sync config`

### Additional Context

```
$ grep -C1 clap Cargo.lock
[[package]]
name = "clap"
version = "4.4.10"
# -- snip --
[[package]]
name = "clap_complete"
version = "4.4.4"
```

### Debug Output

_No response_

---

_Label `C-bug` added by @m4rch3n1ng on 2023-12-03 11:48_

---

_Label `E-hard` added by @epage on 2023-12-04 17:45_

---

_Label `A-completion` added by @epage on 2023-12-04 17:45_

---

_Referenced in [MilesCranmer/rip2#39](../../MilesCranmer/rip2/issues/39.md) on 2024-06-25 21:22_

---

_Comment by @epage on 2024-08-10 00:48_

As I believe this is resolved with the native completions, I'm going to close this.  If this was incorrect, let us know!

You can track stabilization at #3166

---

_Closed by @epage on 2024-08-10 00:48_

---
