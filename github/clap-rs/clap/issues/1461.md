---
number: 1461
title: Fatal internal error when running with some incorrect options
type: issue
state: closed
author: agyx
labels:
  - C-bug
assignees: []
created_at: 2019-04-29T11:20:28Z
updated_at: 2020-04-26T10:14:12Z
url: https://github.com/clap-rs/clap/issues/1461
synced_at: 2026-01-07T12:31:16-06:00
---

# Fatal internal error when running with some incorrect options

---

_Issue opened by @agyx on 2019-04-29 11:20_

### Rust Version

```
rustc 1.34.1 (fc50f328b 2019-04-24)
```

### Affected Version of clap

```
"clap 2.32.0 (registry+https://github.com/rust-lang/crates.io-index)",
"checksum clap 2.32.0 (registry+https://github.com/rust-lang/crates.io-index)" = "b957d88f4b6a63b9d70d5f454ac8011819c6efa7727858f458ab71c756ce2d3e"
```

### Bug or Feature Request Summary

Fatal internal error, systematically, when running with some incorrect options.

### Expected Behavior Summary

No crash, error message to the user about unsupported options and possibly print help.

### Actual Behavior Summary

```
Fatal internal error. Please consider filing a bug report at https://github.com/kbknapp/clap-rs/issues', src/libcore/option.rs:1038:5
```

### Steps to Reproduce the issue

run program with command:
```
cargo run --color=always --package xxx --bin xxx -- --command shutdown --target_addr 127.0.0.1 --target_port 5000
```
**Note that it does not match well with available options.**

### Sample Code or Link to Sample Code

```rust
    pub fn main() -> Result<()> {
        #[allow(clippy::needless_pass_by_value)]
        fn instance_validator(v: String) -> result::Result<(), String> {
            if v.parse::<u32>().is_ok() {
                Ok(())
            } else {
                Err("instance/target number should be an integer value".to_string())
            }
        }

        let matches = App::new(env!("CARGO_PKG_NAME"))
            .version(env!("CARGO_PKG_VERSION"))
            .author(env!("CARGO_PKG_AUTHORS"))
            .about("Xxx backend executable")
            .arg(
                Arg::with_name("mode")
                    .short("m")
                    .long("mode")
                    .value_name("MODE")
                    .possible_values(&["server", "client", "proxy", "none"])
                    .default_value("none")
                    .help("Defines execution mode"),
            )
            .arg(
                Arg::with_name("instance")
                    .short("i")
                    .long("instance")
                    .value_name("SERVER_INSTANCE_NUMBER")
                    .validator(instance_validator)
                    .help("Sets the server instance number in server/proxy mode"),
            )
            .arg(
                Arg::with_name("target address")
                    .long("target_addr")
                    .value_name("TARGET_ADDR")
                    .help("Defines the targeted server address in client mode"),
            )
            .arg(
                Arg::with_name("stream")
                    .long("stream")
                    .value_name("STREAM")
                    .possible_values(&exchange::ExchangeId::all_names())
                    .requires_if("mode", "server")
                    .help("Adds a data stream from specified exchange. Requires server mode"),
            )
            .arg(
                Arg::with_name("services")
                    .short("s")
                    .long("service")
                    .multiple(true)
                    .value_name("SERVICES")
                    .possible_values(ServiceId::all_names())
                    //.requires_if("mode", "server") // for proxy mode also
                    .help("Adds the specified service for running. Requires server mode"),
            )
            .arg(
                Arg::with_name("params")
                    .short("p")
                    .long("param")
                    .multiple(true)
                    .value_name("PARAMS")
                    .requires_if("mode", "client")
                    .help("Specifies parameters for streaming request in client mode"),
            )
            .arg(
                Arg::with_name("command")
                    .short("c")
                    .long("command")
                    .value_name("COMMAND")
                    .possible_values(&["shutdown", "reload"])
                    .requires_if("mode", "none")
                    //.requires("target addr")
                    //.requires("target port")
                    .help("Defines admin command for immediate execution"),
            )
            .arg(
                Arg::with_name("build proto")
                    .long("buildproto")
                    .hidden(true)
                    .help("Builds Rust wrapper sources from .proto files"),
            )
            .get_matches();
```

### Debug output

<details>
<summary> Debug Output </summary>
<pre>
<code>

/Users/bertrand/.cargo/bin/cargo run --color=always --package xxx --bin xxx -- --command shutdown --target_addr 127.0.0.1 --target_port 5000
    Finished dev [unoptimized + debuginfo] target(s) in 0.23s
     Running `target/debug/xxx --command shutdown --target_addr 127.0.0.1 --target_port 5000`
DEBUG:clap:Parser::propagate_settings: self=xxx, g_settings=AppFlags(
    (empty)
)
DEBUG:clap:Parser::get_matches_with;
DEBUG:clap:Parser::create_help_and_version;
DEBUG:clap:Parser::create_help_and_version: Building --help
DEBUG:clap:Parser::create_help_and_version: Building --version
DEBUG:clap:Parser::get_matches_with: Begin parsing '"--command"' ([45, 45, 99, 111, 109, 109, 97, 110, 100])
DEBUG:clap:Parser::is_new_arg:"--command":NotFound
DEBUG:clap:Parser::is_new_arg: arg_allows_tac=false
DEBUG:clap:Parser::is_new_arg: -- found
DEBUG:clap:Parser::is_new_arg: starts_new_arg=true
DEBUG:clap:Parser::possible_subcommand: arg="--command"
DEBUG:clap:Parser::get_matches_with: possible_sc=false, sc=None
DEBUG:clap:ArgMatcher::process_arg_overrides:None;
DEBUG:clap:Parser::parse_long_arg;
DEBUG:clap:Parser::parse_long_arg: Does it contain '='...No
DEBUG:clap:OptBuilder::fmt:command
DEBUG:clap:Parser::parse_long_arg: Found valid opt '--command <COMMAND>'
DEBUG:clap:Parser::parse_opt; opt=command, val=None
DEBUG:clap:Parser::parse_opt; opt.settings=ArgFlags(EMPTY_VALS | TAKES_VAL | DELIM_NOT_SET)
DEBUG:clap:Parser::parse_opt; Checking for val...None
DEBUG:clap:ArgMatcher::inc_occurrence_of: arg=command
DEBUG:clap:ArgMatcher::inc_occurrence_of: first instance
DEBUG:clap:Parser::groups_for_arg: name=command
DEBUG:clap:Parser::groups_for_arg: No groups defined
DEBUG:clap:Parser::parse_opt: More arg vals required...
DEBUG:clap:Parser:get_matches_with: After parse_long_arg Opt("command")
DEBUG:clap:Parser::get_matches_with: Begin parsing '"shutdown"' ([115, 104, 117, 116, 100, 111, 119, 110])
DEBUG:clap:Parser::is_new_arg:"shutdown":Opt("command")
DEBUG:clap:Parser::is_new_arg: arg_allows_tac=false
DEBUG:clap:Parser::is_new_arg: probably value
DEBUG:clap:Parser::is_new_arg: starts_new_arg=false
DEBUG:clap:Parser::add_val_to_arg; arg=command, val="shutdown"
DEBUG:clap:Parser::add_val_to_arg; trailing_vals=false, DontDelimTrailingVals=false
DEBUG:clap:Parser::add_single_val_to_arg;
DEBUG:clap:Parser::add_single_val_to_arg: adding val..."shutdown"
DEBUG:clap:Parser::groups_for_arg: name=command
DEBUG:clap:Parser::groups_for_arg: No groups defined
DEBUG:clap:ArgMatcher::needs_more_vals: o=command
DEBUG:clap:Parser::get_matches_with: Begin parsing '"--target_addr"' ([45, 45, 116, 97, 114, 103, 101, 116, 95, 97, 100, 100, 114])
DEBUG:clap:Parser::is_new_arg:"--target_addr":ValuesDone
DEBUG:clap:Parser::possible_subcommand: arg="--target_addr"
DEBUG:clap:Parser::get_matches_with: possible_sc=false, sc=None
DEBUG:clap:ArgMatcher::process_arg_overrides:Some("command");
DEBUG:clap:Parser::parse_long_arg;
DEBUG:clap:Parser::parse_long_arg: Does it contain '='...No
DEBUG:clap:OptBuilder::fmt:target address
DEBUG:clap:Parser::parse_long_arg: Found valid opt '--target_addr <TARGET_ADDR>'
DEBUG:clap:Parser::parse_opt; opt=target address, val=None
DEBUG:clap:Parser::parse_opt; opt.settings=ArgFlags(EMPTY_VALS | TAKES_VAL | DELIM_NOT_SET)
DEBUG:clap:Parser::parse_opt; Checking for val...None
DEBUG:clap:ArgMatcher::inc_occurrence_of: arg=target address
DEBUG:clap:ArgMatcher::inc_occurrence_of: first instance
DEBUG:clap:Parser::groups_for_arg: name=target address
DEBUG:clap:Parser::groups_for_arg: No groups defined
DEBUG:clap:Parser::parse_opt: More arg vals required...
DEBUG:clap:Parser:get_matches_with: After parse_long_arg Opt("target address")
DEBUG:clap:Parser::get_matches_with: Begin parsing '"127.0.0.1"' ([49, 50, 55, 46, 48, 46, 48, 46, 49])
DEBUG:clap:Parser::is_new_arg:"127.0.0.1":Opt("target address")
DEBUG:clap:Parser::is_new_arg: arg_allows_tac=false
DEBUG:clap:Parser::is_new_arg: probably value
DEBUG:clap:Parser::is_new_arg: starts_new_arg=false
DEBUG:clap:Parser::add_val_to_arg; arg=target address, val="127.0.0.1"
DEBUG:clap:Parser::add_val_to_arg; trailing_vals=false, DontDelimTrailingVals=false
DEBUG:clap:Parser::add_single_val_to_arg;
DEBUG:clap:Parser::add_single_val_to_arg: adding val..."127.0.0.1"
DEBUG:clap:Parser::groups_for_arg: name=target address
DEBUG:clap:Parser::groups_for_arg: No groups defined
DEBUG:clap:ArgMatcher::needs_more_vals: o=target address
DEBUG:clap:Parser::get_matches_with: Begin parsing '"--target_port"' ([45, 45, 116, 97, 114, 103, 101, 116, 95, 112, 111, 114, 116])
DEBUG:clap:Parser::is_new_arg:"--target_port":ValuesDone
DEBUG:clap:Parser::possible_subcommand: arg="--target_port"
DEBUG:clap:Parser::get_matches_with: possible_sc=false, sc=None
DEBUG:clap:ArgMatcher::process_arg_overrides:Some("target address");
DEBUG:clap:Parser::parse_long_arg;
DEBUG:clap:Parser::parse_long_arg: Does it contain '='...No
DEBUG:clap:Parser::parse_long_arg: Didn't match anything
DEBUG:clap:Parser::groups_for_arg: name=target address
DEBUG:clap:Parser::groups_for_arg: No groups defined
DEBUG:clap:usage::create_usage_with_title;
DEBUG:clap:usage::create_usage_no_title;
DEBUG:clap:usage::smart_usage;
DEBUG:clap:usage::get_required_usage_from: reqs=["target address", "command"], extra=None
DEBUG:clap:usage::get_required_usage_from:iter:command: adding arg req="none"
DEBUG:clap:usage::get_required_usage_from: after init desc_reqs=["none"]
DEBUG:clap:usage::get_required_usage_from: no more children
DEBUG:clap:usage::get_required_usage_from: final desc_reqs=["command", "none", "target address"]
DEBUG:clap:usage::get_required_usage_from: args_in_groups=[]
DEBUG:clap:usage::get_required_usage_from:iter:command:
DEBUG:clap:OptBuilder::fmt:command
DEBUG:clap:usage::get_required_usage_from:iter:none:
thread 'main' panicked at 'Fatal internal error. Please consider filing a bug report at https://github.com/kbknapp/clap-rs/issues', src/libcore/option.rs:1038:5
stack backtrace:
   0: std::sys::unix::backtrace::tracing::imp::unwind_backtrace
             at src/libstd/sys/unix/backtrace/tracing/gcc_s.rs:39
   1: std::sys_common::backtrace::_print
             at src/libstd/sys_common/backtrace.rs:70
   2: std::panicking::default_hook::{{closure}}
             at src/libstd/sys_common/backtrace.rs:58
             at src/libstd/panicking.rs:200
   3: std::panicking::default_hook
             at src/libstd/panicking.rs:215
   4: <std::panicking::begin_panic::PanicPayload<A> as core::panic::BoxMeUp>::get
             at src/libstd/panicking.rs:478
   5: std::panicking::continue_panic_fmt
             at src/libstd/panicking.rs:385
   6: std::panicking::try::do_call
             at src/libstd/panicking.rs:312
   7: <T as core::any::Any>::type_id
             at src/libcore/panicking.rs:85
   8: <T as core::any::Any>::type_id
             at src/libcore/option.rs:1038
   9: <clap::args::arg_builder::option::OptBuilder<'n, 'e> as core::clone::Clone>::clone
             at /rustc/fc50f328b0353b285421b8ff5d4100966387a997/src/libcore/option.rs:312
  10: clap::app::usage::get_required_usage_from::{{closure}}
             at /Users/bertrand/.cargo/registry/src/github.com-1ecc6299db9ec823/clap-2.32.0/src/app/usage.rs:457
  11: <clap::args::arg_builder::option::OptBuilder<'n, 'e> as core::clone::Clone>::clone
             at /rustc/fc50f328b0353b285421b8ff5d4100966387a997/src/libcore/option.rs:386
  12: clap::app::usage::needs_flags_tag::{{closure}}
             at /Users/bertrand/.cargo/registry/src/github.com-1ecc6299db9ec823/clap-2.32.0/src/app/usage.rs:454
  13: clap::app::usage::create_smart_usage
             at /Users/bertrand/.cargo/registry/src/github.com-1ecc6299db9ec823/clap-2.32.0/src/app/usage.rs:172
  14: clap::app::usage::create_usage_no_title
             at /Users/bertrand/.cargo/registry/src/github.com-1ecc6299db9ec823/clap-2.32.0/src/app/usage.rs:55
  15: clap::app::usage::create_usage_with_title
             at /Users/bertrand/.cargo/registry/src/github.com-1ecc6299db9ec823/clap-2.32.0/src/app/usage.rs:17
  16: clap::app::usage::create_usage_with_title
             at /Users/bertrand/.cargo/registry/src/github.com-1ecc6299db9ec823/clap-2.32.0/src/app/usage.rs:44
  17: clap::app::parser::Parser::did_you_mean_error
             at /Users/bertrand/.cargo/registry/src/github.com-1ecc6299db9ec823/clap-2.32.0/src/app/parser.rs:1896
  18: clap::app::parser::Parser::_version
             at /Users/bertrand/.cargo/registry/src/github.com-1ecc6299db9ec823/clap-2.32.0/src/app/parser.rs:1617
  19: clap::app::parser::Parser::is_new_arg::{{closure}}
             at /Users/bertrand/.cargo/registry/src/github.com-1ecc6299db9ec823/clap-2.32.0/src/app/parser.rs:931
  20: clap::app::App::get_matches_from::{{closure}}
             at /Users/bertrand/.cargo/registry/src/github.com-1ecc6299db9ec823/clap-2.32.0/src/app/mod.rs:1633
  21: <std::ffi::os_str::OsStr as core::cmp::PartialEq<std::ffi::os_str::OsString>>::eq
             at /Users/bertrand/.cargo/registry/src/github.com-1ecc6299db9ec823/clap-2.32.0/src/app/mod.rs:1513
  22: <std::ffi::os_str::OsStr as core::cmp::PartialEq<std::ffi::os_str::OsString>>::eq
             at /Users/bertrand/.cargo/registry/src/github.com-1ecc6299db9ec823/clap-2.32.0/src/app/mod.rs:1455
  23: xxx::application::Application::main
             at src/application.rs:201
  24: xxx::main
             at src/main.rs:38
  25: std::rt::lang_start::{{closure}}
             at /rustc/fc50f328b0353b285421b8ff5d4100966387a997/src/libstd/rt.rs:64
  26: std::panicking::try::do_call
             at src/libstd/rt.rs:49
             at src/libstd/panicking.rs:297
  27: panic_unwind::dwarf::eh::read_encoded_pointer
             at src/libpanic_unwind/lib.rs:87
  28: std::panicking::update_count_then_panic
             at src/libstd/panicking.rs:276
             at src/libstd/panic.rs:388
             at src/libstd/rt.rs:48
  29: std::rt::lang_start
             at /rustc/fc50f328b0353b285421b8ff5d4100966387a997/src/libstd/rt.rs:64
  30: xxx::main

Process finished with exit code 101

</code>
</pre>
</details>

---

_Label `C: panic` added by @CreepySkeleton on 2020-02-01 14:18_

---

_Label `P2: need to have` added by @CreepySkeleton on 2020-02-01 14:18_

---

_Label `T: bug` added by @CreepySkeleton on 2020-02-01 14:18_

---

_Added to milestone `3.0` by @CreepySkeleton on 2020-02-01 14:18_

---

_Comment by @CreepySkeleton on 2020-04-26 10:14_

Turns out this is another instance of "indescriptive panics in 2.x suck". The example is incorrect because `requires_if` takes the expected value of the arg _first_, and the name of the arg _second_. After I corrected it, if worked as expected:

```
error: Found argument '--target_port' which wasn't expected, or isn't valid in this context

If you tried to supply `--target_port` as a PATTERN use `-- --target_port`

USAGE:
    probe.exe --command <COMMAND> --target_addr <TARGET_ADDR>

For more information try --help
```

Sidenote: this order of arguments in `requires/required*` is non-intuitive. Perhaps we should change it.

---

_Closed by @CreepySkeleton on 2020-04-26 10:14_

---
