---
number: 5521
title: zsh completion ignores or fails options consumed by the zsh _arguments helper function
type: issue
state: closed
author: ben--
labels:
  - C-bug
assignees: []
created_at: 2024-06-07T18:54:47Z
updated_at: 2024-06-07T21:11:45Z
url: https://github.com/clap-rs/clap/issues/5521
synced_at: 2026-01-07T12:31:17-06:00
---

# zsh completion ignores or fails options consumed by the zsh _arguments helper function

---

_Issue opened by @ben-- on 2024-06-07 18:54_

### Please complete the following tasks

- [X] I have searched the [discussions](https://github.com/clap-rs/clap/discussions)
- [X] I have searched the [open](https://github.com/clap-rs/clap/issues) and [rejected](https://github.com/clap-rs/clap/issues?q=is%3Aissue+label%3AS-wont-fix+is%3Aclosed) issues

### Rust Version

rustc 1.76.0 (07dca489a 2024-02-04) (Homebrew)

### Clap Version

4.5.2

### Minimal reproducible code

```rust
use std::io;

use clap::CommandFactory;
use clap::Parser;
use clap_complete::generate;
use clap_complete::Shell;

#[derive(Parser)]
struct Cli {
    #[clap(short = 'M')]
    m_test: Option<String>,

    #[clap(long = "zsh")]
    zsh: bool,
}

fn main() {
    let cli = Cli::parse();
    if cli.zsh {
        let mut cmd = Cli::command();
        generate(Shell::Zsh, &mut cmd, "test-app", &mut io::stdout());
    }
}
```

### Steps to reproduce the bug with the above code

First, build the app, then set up your environment:
```zsh
# Setup
zsh
autoload -Uz compinit
compinit
. <(test-app --zsh)
```

The validate:
```
test-app <TAB><TAB>
```

### Actual Behaviour

```zsh
% test-app
_describe:compadd:114: unknown match specification character `+'
_describe:compadd:114: unknown match specification character `+'
_describe:compadd:114: unknown match specification character `+'
_describe:compadd:134: unknown match specification character `+'
_describe:compadd:134: unknown match specification character `+'
_describe:compadd:134: unknown match specification character `+'
_describe:compadd:134: unknown match specification character `+'
_describe:compadd:134: unknown match specification character `+'
_arguments:compadd:551: unknown match specification character `+'
```

### Expected Behaviour

```zsh
% test-app -
--help  -h  -- Print help
--zsh       -- Generate zsh completions
-M          -- This operation is broken
```

### Additional Context

The zsh `_arguments` completion function has the following syntax:
```
_arguments [ARGUMENTS_OPTIONS] [:] COMMAND_ARG...
```

Where the optional colon is used to disambiguate options consumed by the `_arguments` function itself.

If this colon is missing and the first `COMMAND_ARG` conflicts with one of the options supported by `_arguments`, then it is misinterpreted resulting in missing options or the `unknown match specification character` seen above.

### Debug Output

_No response_

---

_Label `C-bug` added by @ben-- on 2024-06-07 18:54_

---

_Referenced in [clap-rs/clap#5522](../../clap-rs/clap/pulls/5522.md) on 2024-06-07 18:55_

---

_Referenced in [clap-rs/clap#5523](../../clap-rs/clap/pulls/5523.md) on 2024-06-07 19:04_

---

_Closed by @epage on 2024-06-07 21:11_

---
