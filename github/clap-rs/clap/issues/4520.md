---
number: 4520
title: "`requires` is bypassed when using `conflicts_with` a certain way"
type: issue
state: open
author: pierrechevalier83
labels:
  - C-bug
  - M-breaking-change
  - A-validators
  - S-waiting-on-design
assignees: []
created_at: 2022-11-29T11:07:05Z
updated_at: 2024-07-10T15:52:11Z
url: https://github.com/clap-rs/clap/issues/4520
synced_at: 2026-01-07T12:31:17-06:00
---

# `requires` is bypassed when using `conflicts_with` a certain way

---

_Issue opened by @pierrechevalier83 on 2022-11-29 11:07_

### Please complete the following tasks

- [X] I have searched the [discussions](https://github.com/clap-rs/clap/discussions)
- [X] I have searched the [open](https://github.com/clap-rs/clap/issues) and [rejected](https://github.com/clap-rs/clap/issues?q=is%3Aissue+label%3AS-wont-fix+is%3Aclosed) issues

### Rust Version

1.65.0

### Clap Version

4.0.26

### Minimal reproducible code

```rust
use clap::Parser;

#[derive(Parser, Debug)]
struct Cli {
    #[clap(long)]
    destroy: bool,
    #[clap(long, conflicts_with = "destroy" )]
    enhance: bool,
    /// Let's assume, `--dry_run` is only implemented for the `--enhance`
    /// functionality for some reason
    /// Attempting to use `--dry-run --destroy` should fail and inform the user
    /// that these arguments conflict.
    /// The last thing we would want would be to go ahead and destroy their
    /// system when they're thinking only a dry run is going to happen.
    /// This fiction is inspired by real events :p
    #[clap(long, requires = "enhance" )]
    dry_run: bool,
}

fn main() {
    let res = Cli::try_parse_from(vec!["cli", "--destroy", "--dry-run"]);
    // *Unexpectedly*, this assertion fails.
    // One would think that because `--dry-run` requires `--enhance`, the result
    // would be an error complaining that this combination cannot be used
    // together.
    // In actuality, clap will happily parse this.
    assert!(res.is_err());
}
```


### Steps to reproduce the bug with the above code

See [the surprising code](https://play.rust-lang.org/?version=stable&mode=debug&edition=2021&gist=63c32cc6b859b83898ad0f196c09bb8a) in the rust playground.

### Actual Behaviour

The last assertion fails: clap is happy to let the user pass the `--dry-run` flag with the `--destroy` flag and without the `--enhance` flag, bypassing the fact that `--dry-run` should require `--enhance`.

### Expected Behaviour

The last assertion should pass: clap should report to the user that `--dry-run` can only be used in combination with the `--enhance` flag.

### Additional Context

This issue can be worked around by adding an explicit `conflicts_with` configuration like so:
```rust
    #[clap(long, requires = "enhance", conflicts_with = "destroy")]
    dry_run: bool,
```
but I find it surprising that this is needed to obtain the expected behaviour.

### Debug Output

_No response_

---

_Label `C-bug` added by @pierrechevalier83 on 2022-11-29 11:07_

---

_Label `A-validators` added by @epage on 2022-11-29 12:53_

---

_Label `S-waiting-on-design` added by @epage on 2022-11-29 12:53_

---

_Label `M-breaking-change` added by @epage on 2022-11-29 12:54_

---

_Comment by @epage on 2022-11-29 12:54_

Generally, conflicts override required arguments.  However, I do agree that we should evaluate these rules to make sure correctly apply for required relationships like this.

---

_Referenced in [clap-rs/clap#4523](../../clap-rs/clap/pulls/4523.md) on 2022-11-29 22:32_

---

_Comment by @pierrechevalier83 on 2022-11-29 22:55_

> Generally, conflicts override required arguments. However, I do agree that we should evaluate these rules to make sure correctly apply for required relationships like this.

I've had a look at the code, and I think I understand why things are done how they are and how to keep the desired properties while fixing this particular bug. See the PR #5423 which introduces and fixes a new unit test, but doesn't break existing unit tests that rely on groups overriding required relationships.

---

_Referenced in [clap-rs/clap#4707](../../clap-rs/clap/issues/4707.md) on 2023-02-13 17:07_

---

_Referenced in [clap-rs/clap#5041](../../clap-rs/clap/issues/5041.md) on 2023-07-22 16:00_

---

_Added to milestone `5.0` by @epage on 2024-07-10 15:52_

---

_Referenced in [clap-rs/clap#5604](../../clap-rs/clap/issues/5604.md) on 2024-07-29 13:45_

---

_Referenced in [clap-rs/clap#6050](../../clap-rs/clap/pulls/6050.md) on 2025-07-03 16:07_

---
