---
number: 3496
title: "derive: default to parse_os_str for OsString or PathBuf types"
type: issue
state: closed
author: joshtriplett
labels:
  - C-enhancement
  - E-medium
  - A-derive
assignees: []
created_at: 2022-02-22T07:08:13Z
updated_at: 2022-05-23T15:33:38Z
url: https://github.com/clap-rs/clap/issues/3496
synced_at: 2026-01-07T12:31:17-06:00
---

# derive: default to parse_os_str for OsString or PathBuf types

---

_Issue opened by @joshtriplett on 2022-02-22 07:08_

### Please complete the following tasks

- [X] I have searched the [discussions](https://github.com/clap-rs/clap/discussions)
- [X] I have searched the [open](https://github.com/clap-rs/clap/issues) and [rejected](https://github.com/clap-rs/clap/issues?q=is%3Aissue+label%3AS-wont-fix+is%3Aclosed) issues

### Clap Version

3.1.1

### Describe your use case

Most CLI applications should handle any path the user provides, not just UTF-8 paths. I'd like to make that easier to do by default when using `derive`, without having to remember to change the parse function.

### Describe the solution you'd like

Currently, according to the documentation, parsing non-UTF-8 paths requires using `parse(from_os_str)`.

I'd love to see this become the default if deriving an argument with a field type of `PathBuf` or `OsString`, to automatically do the right thing with paths.

### Alternatives, if applicable

_No response_

### Additional Context

_No response_

---

_Label `C-enhancement` added by @joshtriplett on 2022-02-22 07:08_

---

_Label `A-derive` added by @epage on 2022-02-22 15:15_

---

_Label `E-medium` added by @epage on 2022-02-22 15:15_

---

_Added to milestone `3.2` by @epage on 2022-02-22 15:15_

---

_Comment by @epage on 2022-02-22 15:22_

Huh, I know I had considered this at one point but I can't find an issue for it.  I do wonder / hope for #2683 to help with this class of problem in the long term.

I know one odd thing is for us to define how we detect these types since we just get the textual name (iirc).  For example, for external subcommands, we only support `String` and `OsString`, so users have to do `use std::ffi::OsString` (ie we don't support `ffi::OsString`, `std::ffi::OsString`, `::std::ffi::OsString`, or any kind of `use` defined alias).

As for when to do this, an awkward thing is we haven't fully defined what our compatibility story is because users might set attributes assuming what attributes we set or make direct calls on a generated `Command` or `ArgMatches`.  I'm leaning towards this being considered a "minor incompatibility" of the level of MSRV change and leaving it to a minor release, as compared to major or patch.

---

_Comment by @joshtriplett on 2022-02-22 22:23_

@epage One approach that might be viable on a clap 4 timeframe would be to do *all* conversions by way of bytes, and then conversions to String can check for UTF-8, while conversions to OsString or PathBuf or similar wouldn't. (On a comparable timeframe, we *might* manage to make OsString's use of bytes transparent in the standard library.) I'm also hoping such a change would make it easy to handle `BString`.

Meanwhile, in the short term, it seems vaguely reasonable to have the automatic behavior work the same way you're currently handling `Vec`.

---

_Referenced in [smithy-lang/smithy-rs#1293](../../smithy-lang/smithy-rs/pulls/1293.md) on 2022-04-11 18:16_

---

_Comment by @epage on 2022-04-29 13:34_

Just realized, changing any of this in the short term might be considered a breaking change since we would be implicitly setting `allow_invalid_utf8` which if someone directly accesses the field via `ArgMatches`, will now panic.

Something we've not fully defined is our expectations for the derive: how much can people expect from the behavior of the derive when they do not use it in a self-contained way (pairing the generated `Arg`s with `FromArgMatches`).  At the moment, we do not allow people deriving them independently at least.

---

_Removed from milestone `3.2` by @epage on 2022-04-29 13:54_

---

_Added to milestone `4.0` by @epage on 2022-04-29 13:54_

---

_Referenced in [clap-rs/clap#3732](../../clap-rs/clap/pulls/3732.md) on 2022-05-17 21:47_

---

_Referenced in [clap-rs/clap#3734](../../clap-rs/clap/issues/3734.md) on 2022-05-18 00:23_

---

_Referenced in [clap-rs/clap#3742](../../clap-rs/clap/pulls/3742.md) on 2022-05-23 12:26_

---

_Closed by @epage on 2022-05-23 15:33_

---

_Referenced in [clap-rs/clap#3792](../../clap-rs/clap/issues/3792.md) on 2022-06-06 14:23_

---

_Referenced in [cbeck88/conf-rs#13](../../cbeck88/conf-rs/issues/13.md) on 2024-10-14 01:40_

---
