---
number: 3467
title: "clap_generate: fish completion doesn't handle single quotes in possible values: Expected a string, but found an incomplete token"
type: issue
state: closed
author: gibfahn
labels:
  - C-bug
  - A-completion
  - E-easy
assignees: []
created_at: 2022-02-14T19:11:30Z
updated_at: 2022-02-14T21:13:58Z
url: https://github.com/clap-rs/clap/issues/3467
synced_at: 2026-01-07T12:31:17-06:00
---

# clap_generate: fish completion doesn't handle single quotes in possible values: Expected a string, but found an incomplete token

---

_Issue opened by @gibfahn on 2022-02-14 19:11_

### Please complete the following tasks

- [X] I have searched the [discussions](https://github.com/clap-rs/clap/discussions)
- [X] I have searched the [open](https://github.com/clap-rs/clap/issues) and [rejected](https://github.com/clap-rs/clap/issues?q=is%3Aissue+label%3AS-wont-fix+is%3Aclosed) issues

### Rust Version

rustc 1.58.1 (db9d1b20b 2022-01-20)

### Clap Version

3.0.14

### Minimal reproducible code

```rust
// Uses crates: clap and clap_complete.

use clap::{App, AppSettings, Arg, PossibleValue};

static CURRENTLY_GENERATED_COMPLETION: &str = r#"complete -c myapp -l config -r -f -a "{Quotes aren't escaped.	}"
"#;

fn main() {
    let mut app = App::new("my_app")
        .setting(AppSettings::DisableHelpFlag)
        .arg(
            Arg::new("config")
                .long("--config")
                .takes_value(true)
                .possible_values([PossibleValue::new("Quotes aren't escaped.")]),
        );

    let mut buf = vec![];
    clap_complete::generate(clap_complete::Shell::Fish, &mut app, "myapp", &mut buf);
    let generated_completion = String::from_utf8(buf).unwrap();

    println!("{}", generated_completion);
    assert_eq!(&generated_completion, CURRENTLY_GENERATED_COMPLETION);
}
```


### Steps to reproduce the bug with the above code

Run the above code, it outputs:

```shell
complete -c myapp -l config -r -f -a "{Quotes aren't escaped.	}"
```

Then run a `fish` shell and paste in this command.

### Actual Behaviour

It will fail with:

```console
> complete -c myapp -l config -r -f -a "{Quotes aren't escaped.   }"
complete: Completion '{Quotes aren't escaped.   }' contained a syntax error
complete: Expected a string, but found an incomplete token
{Quotes aren't escaped.   }
```


### Expected Behaviour

Command passes

### Additional Context

I know little about fish, but I think the issue here is that fish has different quoting rules. Changing:

```diff
-complete -c myapp -l config -r -f -a "{Quotes aren't escaped.	}"
+complete -c myapp -l config -r -f -a "{Quotes aren\'t escaped.	}"
```

Seems to resolve the issue.

### Debug Output

```rust
[            clap::build::app]  App::_build
[            clap::build::app]  App::_propagate:my_app
[            clap::build::app]  App::_check_help_and_version
[            clap::build::app]  App::_check_help_and_version: Removing generated help
[            clap::build::app]  App::_check_help_and_version: Removing generated version
[            clap::build::app]  App::_propagate_global_args:my_app
[            clap::build::app]  App::_derive_display_order:my_app
[clap::build::app::debug_asserts]       App::_debug_asserts
[clap::build::arg::debug_asserts]       Arg::_debug_asserts:config
[clap::build::app::debug_asserts]       App::_verify_positionals
[            clap::build::app]  App::_build_bin_names
```

---

_Label `C-bug` added by @gibfahn on 2022-02-14 19:11_

---

_Label `A-completion` added by @epage on 2022-02-14 19:23_

---

_Label `E-easy` added by @epage on 2022-02-14 19:23_

---

_Referenced in [clap-rs/clap#3469](../../clap-rs/clap/pulls/3469.md) on 2022-02-14 21:00_

---

_Closed by @epage on 2022-02-14 21:13_

---
