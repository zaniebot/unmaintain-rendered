---
number: 1480
title: "ArgMatcher with `max_values` consumes one more argument than it should"
type: issue
state: closed
author: sphynx
labels:
  - C-bug
assignees: []
created_at: 2019-05-28T07:55:01Z
updated_at: 2020-04-10T08:41:25Z
url: https://github.com/clap-rs/clap/issues/1480
synced_at: 2026-01-07T12:31:16-06:00
---

# ArgMatcher with `max_values` consumes one more argument than it should

---

_Issue opened by @sphynx on 2019-05-28 07:55_

<!--
Please use the following template to assist with creating an issue and to ensure a speedy resolution. If an area is not applicable, feel free to delete the area or mark with `N/A`
-->

### Rust Version

rustc-1.36.0-nightly

### Affected Version of clap

2.33.0

### Bug or Feature Request Summary

If I set `max_values = 1` for an option I expect that the option should consume only one argument and leave the rest for the next parsers. However, due to one-off error in `ArgMatcher`, it now consumes *two* arguments (and then fails validation, because it took one more than it should).

For example, I expect that:

```
prog --field 1 FILE
```

Should be parsed correct if `--field` has `max-values=1` and `FILE` is a positional arguments. However, `FILE` is consumed by `ArgMatcher` as the second value for the `--file` option, which then leads to validation error.

### Steps to Reproduce the issue

`cargo run`

### Sample Code or Link to Sample Code

```rust
use clap::{App, Arg};

fn main() {
    let res = App::new("prog")
        .arg(
            Arg::with_name("field")
                .takes_value(true)
                .multiple(false)
                .max_values(1)
                .long("field"),
        )
        .arg(
            Arg::with_name("positional")
                .required(true)
                .index(1),
        )
        .get_matches_from_safe(vec!["prog", "--field", "1", "file"]);

    assert!(res.is_ok());
}
```

### Debug output

Compile clap with cargo features `"debug"` such as:

```toml
[dependencies]
clap = { version = "2", features = ["debug"] }
```

<details>
<summary> Debug Output </summary>
<pre>
<code>

DEBUG:clap:Parser::propagate_settings: self=prog, g_settings=AppFlags(
    (empty),
)
DEBUG:clap:Parser::get_matches_with;
DEBUG:clap:Parser::create_help_and_version;
DEBUG:clap:Parser::create_help_and_version: Building --help
DEBUG:clap:Parser::create_help_and_version: Building --version
DEBUG:clap:Parser::get_matches_with: Begin parsing '"--field"' ([45, 45, 102, 105, 101, 108, 100])
DEBUG:clap:Parser::is_new_arg:"--field":NotFound
DEBUG:clap:Parser::is_new_arg: arg_allows_tac=false
DEBUG:clap:Parser::is_new_arg: -- found
DEBUG:clap:Parser::is_new_arg: starts_new_arg=true
DEBUG:clap:Parser::possible_subcommand: arg="--field"
DEBUG:clap:Parser::get_matches_with: possible_sc=false, sc=None
DEBUG:clap:ArgMatcher::process_arg_overrides:None;
DEBUG:clap:Parser::parse_long_arg;
DEBUG:clap:Parser::parse_long_arg: Does it contain '='...No
DEBUG:clap:OptBuilder::fmt:field
DEBUG:clap:Parser::parse_long_arg: Found valid opt '--field <field>'
DEBUG:clap:Parser::parse_opt; opt=field, val=None
DEBUG:clap:Parser::parse_opt; opt.settings=ArgFlags(EMPTY_VALS | TAKES_VAL | DELIM_NOT_SET)
DEBUG:clap:Parser::parse_opt; Checking for val...None
DEBUG:clap:ArgMatcher::inc_occurrence_of: arg=field
DEBUG:clap:ArgMatcher::inc_occurrence_of: first instance
DEBUG:clap:Parser::groups_for_arg: name=field
DEBUG:clap:Parser::groups_for_arg: No groups defined
DEBUG:clap:Parser::parse_opt: More arg vals required...
DEBUG:clap:Parser:get_matches_with: After parse_long_arg Opt("field")
DEBUG:clap:Parser::get_matches_with: Begin parsing '"1"' ([49])
DEBUG:clap:Parser::is_new_arg:"1":Opt("field")
DEBUG:clap:Parser::is_new_arg: arg_allows_tac=false
DEBUG:clap:Parser::is_new_arg: probably value
DEBUG:clap:Parser::is_new_arg: starts_new_arg=false
DEBUG:clap:Parser::add_val_to_arg; arg=field, val="1"
DEBUG:clap:Parser::add_val_to_arg; trailing_vals=false, DontDelimTrailingVals=false
DEBUG:clap:Parser::add_single_val_to_arg;
DEBUG:clap:Parser::add_single_val_to_arg: adding val..."1"
DEBUG:clap:Parser::groups_for_arg: name=field
DEBUG:clap:Parser::groups_for_arg: No groups defined
DEBUG:clap:ArgMatcher::needs_more_vals: o=field
DEBUG:clap:ArgMatcher::needs_more_vals: max_vals...1
DEBUG:clap:Parser::get_matches_with: Begin parsing '"file"' ([102, 105, 108, 101])
DEBUG:clap:Parser::is_new_arg:"file":Opt("field")
DEBUG:clap:Parser::is_new_arg: arg_allows_tac=false
DEBUG:clap:Parser::is_new_arg: probably value
DEBUG:clap:Parser::is_new_arg: starts_new_arg=false
DEBUG:clap:Parser::add_val_to_arg; arg=field, val="file"
DEBUG:clap:Parser::add_val_to_arg; trailing_vals=false, DontDelimTrailingVals=false
DEBUG:clap:Parser::add_single_val_to_arg;
DEBUG:clap:Parser::add_single_val_to_arg: adding val..."file"
DEBUG:clap:Parser::groups_for_arg: name=field
DEBUG:clap:Parser::groups_for_arg: No groups defined
DEBUG:clap:ArgMatcher::needs_more_vals: o=field
DEBUG:clap:ArgMatcher::needs_more_vals: max_vals...1
DEBUG:clap:ArgMatcher::process_arg_overrides:Some("field");
DEBUG:clap:Parser::remove_overrides:[];
DEBUG:clap:Validator::validate;
DEBUG:clap:Parser::add_defaults;
DEBUG:clap:Parser::add_defaults:iter:field: doesn't have conditional defaults
DEBUG:clap:Parser::add_defaults:iter:field: doesn't have default vals
DEBUG:clap:Parser::add_defaults:iter:positional: doesn't have conditional defaults
DEBUG:clap:Parser::add_defaults:iter:positional: doesn't have default vals
DEBUG:clap:Validator::validate_blacklist;
DEBUG:clap:Validator::validate_blacklist:iter:field;
DEBUG:clap:Parser::groups_for_arg: name=field
DEBUG:clap:Parser::groups_for_arg: No groups defined
DEBUG:clap:Validator::validate_required: required=["positional"];
DEBUG:clap:Validator::validate_required:iter:positional:
DEBUG:clap:Validator::is_missing_required_ok: a=positional
DEBUG:clap:Validator::validate_arg_conflicts: a="positional";
DEBUG:clap:Validator::validate_required_unless: a="positional";
DEBUG:clap:Validator::missing_required_error: extra=None
DEBUG:clap:Parser::color;
DEBUG:clap:Parser::color: Color setting...Auto
DEBUG:clap:is_a_tty: stderr=true
DEBUG:clap:Validator::missing_required_error: reqs=[
    "positional",
]
DEBUG:clap:usage::get_required_usage_from: reqs=["positional"], extra=None
DEBUG:clap:usage::get_required_usage_from: after init desc_reqs=[]
DEBUG:clap:usage::get_required_usage_from: no more children
DEBUG:clap:usage::get_required_usage_from: final desc_reqs=["positional"]
DEBUG:clap:usage::get_required_usage_from: args_in_groups=[]
DEBUG:clap:Colorizer::error;
DEBUG:clap:Validator::missing_required_error: req_args="\n    \u{1b}[1;31m<positional>\u{1b}[0m"
DEBUG:clap:usage::create_usage_with_title;
DEBUG:clap:usage::create_usage_no_title;
DEBUG:clap:usage::smart_usage;
DEBUG:clap:usage::get_required_usage_from: reqs=["positional", "field"], extra=None
DEBUG:clap:usage::get_required_usage_from: after init desc_reqs=[]
DEBUG:clap:usage::get_required_usage_from: no more children
DEBUG:clap:usage::get_required_usage_from: final desc_reqs=["field", "positional"]
DEBUG:clap:usage::get_required_usage_from: args_in_groups=[]
DEBUG:clap:usage::get_required_usage_from:iter:field:
DEBUG:clap:OptBuilder::fmt:field
DEBUG:clap:Parser::color;
DEBUG:clap:Parser::color: Color setting...Auto
DEBUG:clap:is_a_tty: stderr=true
DEBUG:clap:Colorizer::error;
DEBUG:clap:Colorizer::good;
thread 'main' panicked at 'assertion failed: res.is_ok()', src/main.rs:19:5
note: Run with `RUST_BACKTRACE=1` environment variable to display a backtrace.

</code>
</pre>
</details>


---

_Referenced in [clap-rs/clap#1481](../../clap-rs/clap/pulls/1481.md) on 2019-05-28 08:18_

---

_Label `C: positional args` added by @CreepySkeleton on 2020-02-01 13:34_

---

_Label `P2: need to have` added by @CreepySkeleton on 2020-02-01 13:34_

---

_Label `T: bug` added by @CreepySkeleton on 2020-02-01 13:34_

---

_Label `W: 2.x` added by @CreepySkeleton on 2020-02-01 13:34_

---

_Label `W: 3.x` added by @CreepySkeleton on 2020-02-01 13:34_

---

_Added to milestone `3.0` by @CreepySkeleton on 2020-02-01 13:34_

---

_Referenced in [clap-rs/clap#1802](../../clap-rs/clap/pulls/1802.md) on 2020-04-09 23:10_

---

_Closed by @bors[bot] on 2020-04-10 08:41_

---
