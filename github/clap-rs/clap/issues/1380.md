---
number: 1380
title: "load_yaml! cannot be used inside of lazy_static"
type: issue
state: closed
author: andrewmiller1
labels: []
assignees: []
created_at: 2018-11-10T06:15:18Z
updated_at: 2020-02-03T03:01:44Z
url: https://github.com/clap-rs/clap/issues/1380
synced_at: 2026-01-07T12:31:16-06:00
---

# load_yaml! cannot be used inside of lazy_static

---

_Issue opened by @andrewmiller1 on 2018-11-10 06:15_

<!--
Please use the following template to assist with creating an issue and to ensure a speedy resolution. If an area is not applicable, feel free to delete the area or mark with `N/A`
-->

### Rust Version

* Use the output of `rustc -V`

rustc 1.32.0-nightly (653da4fd0 2018-11-08)

### Affected Version of clap

* Can be found in Cargo.lock of your project (i.e. `grep clap Cargo.lock`)

clap 3.0.0-alpha.1

### Bug or Feature Request Summary

Feature: Improve App to be able to load yaml in a separate function.


### Expected Behavior Summary

Build cli with configurations from yaml in a separate function.


### Actual Behavior Summary

```
error[E0515]: cannot return value referencing temporary value
```


### Steps to Reproduce the issue

```sh
cargo build
```


### Sample Code or Link to Sample Code

[Source code #1380](https://gist.github.com/andrewmiller1/60db2e82d43e286f6e3b21dcd5c68b4f)

Background: https://github.com/clap-rs/clap/issues/1318#issuecomment-404635507 Can't follow instructions [#47 (clap::App example)](https://docs.rs/clap/2.32.0/clap/struct.App.html#examples-47) for [clap-rs/clap_generate](https://github.com/clap-rs/clap_generate).

From discussions in #rust-beginners, this is because [YamlLoader::load_from_str](https://docs.rs/clap/2.32.0/clap/struct.YamlLoader.html#method.load_from_str) returns a Yaml instance that contains Strings the App instance needs to borrow (the Yaml instance should even outlive the App instance). Something needs to own those Strings, but the Yaml Vec struct dies too soon (it's dead by the time build_cli returns).


### Debug output

Compile clap with cargo features `"debug"` such as:

```toml
[dependencies]
clap = { version = "2", features = ["debug"] }
```

<details><summary> Debug Output </summary>

```
    Updating crates.io index
    Updating git repository `https://github.com/clap-rs/clap_derive`
   Compiling proc-macro2 v0.4.21
   Compiling unicode-xid v0.1.0
   Compiling libc v0.2.43
   Compiling linked-hash-map v0.5.1
   Compiling unicode-width v0.1.5
   Compiling bitflags v1.0.4
   Compiling indexmap v1.0.2
   Compiling strsim v0.7.0
   Compiling ansi_term v0.11.0
   Compiling vec_map v0.8.1
   Compiling textwrap v0.10.0
   Compiling yaml-rust v0.4.2
   Compiling atty v0.2.11
   Compiling quote v0.6.10
   Compiling syn v0.14.9
   Compiling clap_derive v0.3.0 (https://github.com/clap-rs/clap_derive#2fad2c8a)
   Compiling clap v3.0.0-alpha.1 (/home/andrew/builds/clap)
   Compiling clap_generate v0.0.1 (/home/andrew/builds/clap_generate-pub-shell)
warning: unused macro definition
  --> /home/andrew/builds/clap_generate-pub-shell/src/macros.rs:59:5
   |
59 | /     macro_rules! sdebugln {
60 | |         ($fmt:expr) => {};
61 | |         ($fmt:expr, $($arg:tt)*) => {};
62 | |     }
   | |_____^
   |
   = note: #[warn(unused_macros)] on by default

warning: unused macro definition
  --> /home/andrew/builds/clap_generate-pub-shell/src/macros.rs:63:5
   |
63 | /     macro_rules! debug {
64 | |         ($fmt:expr) => {};
65 | |         ($fmt:expr, $($arg:tt)*) => {};
66 | |     }
   | |_____^

warning: unused macro definition
  --> /home/andrew/builds/clap_generate-pub-shell/src/macros.rs:69:1
   |
69 | / macro_rules! args {
70 | |     ($app:expr, $how:ident) => {
71 | |         $app.args.$how()
72 | |     };
...  |
75 | |     };
76 | | }
   | |_^

warning: unused macro definition
  --> /home/andrew/builds/clap_generate-pub-shell/src/macros.rs:78:1
   |
78 | / macro_rules! args_mut {
79 | |     ($app:expr) => {
80 | |         args!($app, iter_mut)
81 | |     };
82 | | }
   | |_^

warning: use of deprecated item 'std::ascii::AsciiExt': use inherent methods instead
 --> /home/andrew/builds/clap_generate-pub-shell/src/shells/zsh.rs:3:5
  |
3 | use std::ascii::AsciiExt;
  |     ^^^^^^^^^^^^^^^^^^^^
  |
  = note: #[warn(deprecated)] on by default

warning: use of deprecated item 'std::ascii::AsciiExt': use inherent methods instead
   --> /home/andrew/builds/clap_generate-pub-shell/src/shells/mod.rs:161:5
    |
161 | use std::ascii::AsciiExt;
    |     ^^^^^^^^^^^^^^^^^^^^

   Compiling graph v0.1.0 (/home/andrew/projects/graph)
error[E0515]: cannot return value referencing temporary value
 --> src/cli.rs:2:5
  |
2 |     app_from_crate!().add_from_yaml(load_yaml!("cli.yml"))
  |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^---------------------^
  |     |                               |
  |     |                               temporary value created here
  |     returns a value referencing data owned by the current function
  |
  = note: this error originates in a macro outside of the current crate (in Nightly builds, run with -Z external-macro-backtrace for more info)

error: aborting due to previous error

For more information about this error, try `rustc --explain E0515`.
error: Could not compile `graph`.

To learn more, run the command again with --verbose.
```

</details>

<details><summary> Macro tracing </summary>

```
   Compiling graph v0.1.0 (/home/andrew/projects/graph)
     Running `rustc --edition=2018 --crate-name build_script_build build.rs --color never --crate-type bin --emit=dep-info,link -C debuginfo=2 -C metadata=3338707160b2b133 -C extra-filename=-3338707160b2b133 --out-dir /home/andrew/projects/graph/target/debug/build/graph-3338707160b2b133 -C incremental=/home/andrew/projects/graph/target/debug/incremental -L dependency=/home/andrew/projects/graph/target/debug/deps --extern clap=/home/andrew/projects/graph/target/debug/deps/libclap-2f3391e22eb4ceb7.rlib --extern clap_generate=/home/andrew/projects/graph/target/debug/deps/libclap_generate-17515d86c877e732.rlib -Z debug-macros -Z external-macro-backtrace -Z trace-macros`
note: trace_macro
 --> src/cli.rs:2:5
  |
2 |     app_from_crate!().add_from_yaml(load_yaml!("cli.yml"))
  |     ^^^^^^^^^^^^^^^^^
  |
  = note: expanding `app_from_crate! {  }`
  = note: to `$crate :: App :: new ( crate_name ! (  ) ) . version ( crate_version ! (  ) )
          . author ( crate_authors ! (  ) ) . about ( crate_description ! (  ) )`
  = note: expanding `crate_name! {  }`
  = note: to `env ! ( "CARGO_PKG_NAME" )`
  = note: expanding `crate_version! {  }`
  = note: to `env ! ( "CARGO_PKG_VERSION" )`
  = note: expanding `crate_authors! {  }`
  = note: to `env ! ( "CARGO_PKG_AUTHORS" )`
  = note: expanding `crate_description! {  }`
  = note: to `env ! ( "CARGO_PKG_DESCRIPTION" )`

note: trace_macro
 --> src/cli.rs:2:37
  |
2 |     app_from_crate!().add_from_yaml(load_yaml!("cli.yml"))
  |                                     ^^^^^^^^^^^^^^^^^^^^^
  |
  = note: expanding `load_yaml! { "cli.yml" }`
  = note: to `& :: clap :: YamlLoader :: load_from_str ( include_str ! ( "cli.yml" ) ) .
          expect ( "failed to load YAML file" ) [ 0 ]`

error[E0515]: cannot return value referencing temporary value
 --> src/cli.rs:2:5
  |
2 |       app_from_crate!().add_from_yaml(load_yaml!("cli.yml"))
  |       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ returns a value referencing data owned by the current function
  | 
 ::: <::clap::macros::load_yaml macros>:2:3
  |
2 |   & :: clap :: YamlLoader :: load_from_str ( include_str ! ( $ yml ) ) . expect
  |  ___-
3 | | ( "failed to load YAML file" ) [ 0 ] } ;
  | |______________________________- temporary value created here

error: aborting due to previous error

For more information about this error, try `rustc --explain E0515`.
error: Could not compile `graph`.

Caused by:
  process didn't exit successfully: `rustc --edition=2018 --crate-name build_script_build build.rs --color never --crate-type bin --emit=dep-info,link -C debuginfo=2 -C metadata=3338707160b2b133 -C extra-filename=-3338707160b2b133 --out-dir /home/andrew/projects/graph/target/debug/build/graph-3338707160b2b133 -C incremental=/home/andrew/projects/graph/target/debug/incremental -L dependency=/home/andrew/projects/graph/target/debug/deps --extern clap=/home/andrew/projects/graph/target/debug/deps/libclap-2f3391e22eb4ceb7.rlib --extern clap_generate=/home/andrew/projects/graph/target/debug/deps/libclap_generate-17515d86c877e732.rlib -Z debug-macros -Z external-macro-backtrace -Z trace-macros` (exit code: 1)
```

</details>


---

_Comment by @arusahni on 2019-12-27 20:36_

Admittedly, I'm still ascending Rust's learning curve, but here's my workaround:

1. Add the `yaml_rust` crate as a dependency, using the same version that clap depends on (found in `Cargo.lock`)
2. Move the YAML-loading to the call site and pass the config in as an argument.
```rust
fn build_cli(cfg) { // snip }

let cfg = load_yaml!("cli.yml")
build_cli(&cfg);
```
3. Throwing some lifetimes around, this is what I have
```rust
fn build_cli<'a>(cfg: &'a yaml_rust::Yaml) -> App<'a, 'a> {
    App::from_yaml(&cfg)
        .version(crate_version!())
        .author(crate_authors!("\n"))
}

fn main() {
    let cfg = load_yaml!("cli.yml");
    let app = build_cli(&cfg);
    // code that consumes the app reference
    let app2 = build_cli(&cfg);
}
```

This isn't as clean as handling the configuration marshaling in the function, or being able to assign whatever lifetime I want to the output, but it makes the borrow-checker happy.

---

_Comment by @CreepySkeleton on 2020-02-01 15:32_

Cases like that can be solved by `lazy_static!`. Feel free to reopen

---

_Closed by @CreepySkeleton on 2020-02-01 15:32_

---

_Label `C: yaml parser` added by @pksunkara on 2020-02-01 19:11_

---

_Label `T: RFC / question` added by @pksunkara on 2020-02-01 19:11_

---

_Label `W: wont do` added by @pksunkara on 2020-02-01 19:11_

---

_Comment by @arusahni on 2020-02-02 03:51_

@CreepySkeleton thanks for the suggestion! Unfortunately, this doesn't appear to work:

```rust
lazy_static! {
    static ref APP_CFG: &'static Yaml = load_yaml!("cli.yml");
    static ref CLI_APP: App<'static, 'static> = App::from_yaml(&APP_CFG)
            .version(crate_version!())
            .author(crate_authors!("\n"));
}
```

with the message:

```
    | |_^ `std::rc::Rc<(dyn for<'r> std::ops::Fn(&'r std::ffi::OsStr) -> std::result::Result<(), std::ffi::OsString> + 'static)>` cannot be shared between threads safely
    |
    = help: within `clap::args::arg_builder::option::OptBuilder<'static, 'static>`, the trait `std::marker::Sync` is not implemented for `std::rc::Rc<(dyn for<'r> std::ops::Fn(&'r std::ffi::OsStr) -> std::result::Result<(), std::ffi::OsString> + 'static)>`
    = note: required because it appears within the type `std::option::Option<std::rc::Rc<(dyn for<'r> std::ops::Fn(&'r std::ffi::OsStr) -> std::result::Result<(), std::ffi::OsString> + 'static)>>`
    = note: required because it appears within the type `clap::args::arg_builder::valued::Valued<'static, 'static>`
    = note: required because it appears within the type `clap::args::arg_builder::option::OptBuilder<'static, 'static>`
    = note: required because of the requirements on the impl of `std::marker::Sync` for `std::ptr::Unique<clap::args::arg_builder::option::OptBuilder<'static, 'static>>`
    = note: required because it appears within the type `alloc::raw_vec::RawVec<clap::args::arg_builder::option::OptBuilder<'static, 'static>>`
    = note: required because it appears within the type `std::vec::Vec<clap::args::arg_builder::option::OptBuilder<'static, 'static>>`
    = note: required because it appears within the type `clap::app::parser::Parser<'static, 'static>`
    = note: required because it appears within the type `clap::app::App<'static, 'static>`
    = note: required by `lazy_static::lazy::Lazy`
    = note: this error originates in a macro outside of the current crate (in Nightly builds, run with -Z external-macro-backtrace for more info
```


---

_Reopened by @CreepySkeleton on 2020-02-02 04:22_

---

_Renamed from "Support loading yaml from a separate function" to "load_yaml! cannot be used iinside of lazy_static" by @CreepySkeleton on 2020-02-02 04:23_

---

_Renamed from "load_yaml! cannot be used iinside of lazy_static" to "load_yaml! cannot be used inside of lazy_static" by @CreepySkeleton on 2020-02-02 04:23_

---

_Label `W: wont do` removed by @CreepySkeleton on 2020-02-02 04:23_

---

_Comment by @CreepySkeleton on 2020-02-02 04:37_

The workaround is 
```rust
lazy_static! {
    static ref APP_CFG: Yaml = {
        clap::YamlLoader::load_from_str(include_str!("../cli.yml"))
            .expect("failed to load YAML file")
            .pop()
            .unwrap()
        };
}

fn main() {
    let app = App::from_yaml(&APP_CFG)
        .version(crate_version!())
        .author(crate_authors!("\n"));
}
```

---

_Comment by @CreepySkeleton on 2020-02-02 04:39_

I actually don't think we'll ever get to fixing this in clap 2.x because it would be a breaking change, especially in the light of workaround. Closing as wontfix.

---

_Closed by @CreepySkeleton on 2020-02-02 04:39_

---

_Label `W: wont do` added by @CreepySkeleton on 2020-02-02 04:39_

---

_Comment by @arusahni on 2020-02-03 03:01_

The workaround you provided worked for me.  Understood about the breaking change thing - thanks for your time!

---
