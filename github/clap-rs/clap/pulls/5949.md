---
number: 5949
title: Fix arbitrary-cardinality positionals shadowing option name completion
type: pull_request
state: merged
author: krobelus
labels: []
assignees: []
merged: true
base: master
head: option-name-completions-after-positionals
created_at: 2025-03-15T13:39:19Z
updated_at: 2025-03-19T21:00:35Z
url: https://github.com/clap-rs/clap/pull/5949
synced_at: 2026-01-07T12:31:17-06:00
---

# Fix arbitrary-cardinality positionals shadowing option name completion

---

_Pull request opened by @krobelus on 2025-03-15 13:39_

NOTE This text is outdated; see commit messages.

TODO: should double-check the root cause and add automated tests

jj dynamic completions of option names work as expected ...

	$ COMPLETE=fish jj -- jj abandon --ignore-
	--ignore-working-copy
	--ignore-immutable

... unless there is a positional argument

	$ COMPLETE=fish jj -- jj abandon @ --ignore-

The positional arguments are defined in the "abandon" subcommand as:

```rust
#[derive(clap::Args, Clone, Debug)]
pub(crate) struct AbandonArgs {
    /// The revision(s) to abandon (default: @)
    #[arg(
        value_name = "REVSETS",
        add = ArgValueCandidates::new(complete::mutable_revisions)
    )]
    revisions_pos: Vec<RevisionArg>,
}
```

After clap_complete sees the first positional argument ("@") we are stuck
in "ParseState::Pos(..)" even when we get to parsing "--ignore-".  This is
because "revisions_pos" accepts an arbitrary number of positionals.

While in "ParseState::Pos(..)", we only produce completions for positionals
(via "complete_arg_value()").  This means we fail to produce option-name
completions like "--ignore-immutable".

This was introduced in f0bd4750 (feat(clap_complete): Support
multi-values of positional argument with `num_arg(N)`, 2024-07-26).
Presumably, the main intention of that commit was to allow options
with multiple, but finitely many arguments.

For the case where arbitrarily many arguments are allowed, let's get rid of
this restriction, to fix the false negative.

Ref: https://github.com/fish-shell/fish-shell/pull/11046#discussion_r1921501251


---

_@krobelus reviewed on 2025-03-16 17:51_

---

_Review comment by @krobelus on `clap_complete/src/engine/complete.rs`:636 on 2025-03-16 17:51_

cc @shannmu @epage

FWIW the interpretation of *positional* that have `num_args>1` seems a
bit weird. I have never seen a CLI that uses them *and* disallows
interspersing it with options. But I guess I don't super care.

I mainly care about getting this bug fixed - let me know what I can do.

I'm pushing a more narrow fix that figures out whether our
multi-arg-positional is allowed to be non-contiguous (i.e. interspersed
with options).  The derived `Vec` above is one example.

Maybe the criteria can check max_value==infinity but the behavior
of max_value=infinity is super odd: it kinda supports non-contiguous
positionals but also not. Given


```rust
fn main() {
    use clap;
    clap::Command::new("dynamic")
        .arg(
            clap::Arg::new("positional")
                .value_parser(["pos_a", "pos_b", "pos_c"])
                .index(1)
                .num_args(2..),
        )
        .arg(
            clap::Arg::new("--format")
                .long("format")
                .short('F')
                .value_parser(["json", "yaml", "toml"]),
        )
        .get_matches();
}
```


More than two arguments can be collected even with options interspersed.
But each run of arguments needs to have at least two:

	$ my-app pos_a pos_a --format=json pos_a pos_a
	$ my-app pos_a --format json pos_a pos_a
	error: 2 values required by '[positional] [positional]...'; only 1 was provided

And if I replace `2..` with `2`, the first one weirdly no longer works:

	$ my-app pos_a pos_a --format=json pos_a pos_a
	error: the argument '[positional] [positional]' cannot be used multiple times

---

_@epage reviewed on 2025-03-17 16:01_

---

_Review comment by @epage on `clap_complete/src/engine/complete.rs`:636 on 2025-03-17 16:01_

Adding new `Arg` settings are not something done lightly and if a proposal is to have that, an issue should be made first that makes a clear case for the problem being solved, why it is needed, and what the full semantics should be.

And in fact, it shouldn't be needed here.  `.action(Set).num_args(..)` is contiguous and `action(Append).num_args(..)` is non-contiguous.

---

_@krobelus reviewed on 2025-03-17 17:41_

---

_Review comment by @krobelus on `clap_complete/src/engine/complete.rs`:636 on 2025-03-17 17:41_

>  if a proposal is to have that, an issue should be made first that makes a clear case for the problem being solved

I'm not trying to add a new feature, I only want to fix the regression.
I don't expect an issue would have helped me achieve my goal.

---

_@epage reviewed on 2025-03-17 17:59_

---

_Review comment by @epage on `clap_complete/src/engine/complete.rs`:636 on 2025-03-17 17:59_

> I'm not trying to add a new feature, 

Like it or not, `Arg::non_contiguous` is a new feature.

> I don't expect an issue would have helped me achieve my goal.

Our general expectation is that Issues should be made and accepted before moving on to PRs.  Frequently, we've seen
- People waste time by going with solutions that don't align with the project
- Issues lost track of because a PR gets abandoned which contained the only report
- Information fragmented as a contributor switches between PRs or they abandon an effort and someone else picks it up

---

_@epage reviewed on 2025-03-17 18:08_

---

_Review comment by @epage on `clap_complete/tests/testsuite/engine.rs`:694 on 2025-03-17 18:08_

Why is `required` added?

---

_@epage reviewed on 2025-03-17 18:10_

---

_Review comment by @epage on `clap_complete/tests/testsuite/engine.rs`:698 on 2025-03-17 18:10_

The values were chosen to make it obvious which positional argument they are associated with.  If you are reusing this test, we should probably change things to make that clearer, like adding a refactor commit before this one that changes the values to `pos_<num>_<letter>` so `positional` has `["pos_1_a"]`, `positional-2` has `["pos_2_a", "pos_2_b"]`.

Then in this commit, you'd have `["pos_3_a", "pos_3_b"]`.

---

_Review comment by @epage on `clap_complete/src/engine/complete.rs`:636 on 2025-03-17 18:11_

Also, I forgot that I added to the builder the automatic use of `Append` for unbounded `num_args`.  So unbounded positionals are always non-contiguous.

---

_@epage reviewed on 2025-03-17 18:11_

---

_Review comment by @epage on `clap_complete/tests/testsuite/engine.rs`:793 on 2025-03-17 18:12_

The old test specifically had a case to verify that there was nothing more to complete.  We lose that by extending this test.  Instead, can you add a separate test for unbounded positionals?

---

_@epage reviewed on 2025-03-17 18:12_

---

_@epage reviewed on 2025-03-17 18:13_

---

_Review comment by @epage on `clap_complete/tests/testsuite/engine.rs`:831 on 2025-03-17 18:13_

We should also have test cases for
- `"pos_1 pos_a pos_b pos_c pos_d [TAB]"`
- `"pos_1 pos_a pos_b pos_c pos_d --format json [TAB]"`

---

_@epage reviewed on 2025-03-17 18:14_

---

_Review comment by @epage on `clap_complete/tests/testsuite/engine.rs`:793 on 2025-03-17 18:14_

(in doing this, we'd make `positional-2` unbounded)

---

_@krobelus reviewed on 2025-03-17 20:12_

---

_Review comment by @krobelus on `clap_complete/src/engine/complete.rs`:636 on 2025-03-17 20:12_

Are you seriously suggesting I should have created an issue?
I have lots of points on this but I guess I'll try not to waste everyone's time.

Another general expectation is "you broke it, you fix it"

---

_@krobelus reviewed on 2025-03-17 20:12_

---

_Review comment by @krobelus on `clap_complete/tests/testsuite/engine.rs`:694 on 2025-03-17 20:12_

no idea

```
thread 'engine::suggest_multi_positional' panicked at clap_builder/src/builder/debug_asserts.rs:570:9:
Positional argument `[positional-3] [positional-3]...` *must* have `required(true)` or `last(true)` set because a prior positional argument (`<positional-2> <positional-2> <positional-2>`) has `num_args(1..)`
```

---

_@krobelus reviewed on 2025-03-17 20:15_

---

_Review comment by @krobelus on `clap_complete/tests/testsuite/engine.rs`:694 on 2025-03-17 20:15_

I guess if I create a second test I am not forced to find out what's going on. The error message is contradictory for sure

---

_@krobelus reviewed on 2025-03-17 20:27_

---

_Review comment by @krobelus on `clap_complete/tests/testsuite/engine.rs`:831 on 2025-03-17 20:27_

well tests show my change is broken

---

_@krobelus reviewed on 2025-03-17 20:27_

---

_Review comment by @krobelus on `clap_complete/tests/testsuite/engine.rs`:831 on 2025-03-17 20:27_

I guess I have to figure this out myself?

---

_@epage reviewed on 2025-03-17 20:56_

---

_Review comment by @epage on `clap_complete/src/engine/complete.rs`:636 on 2025-03-17 20:56_

> Are you seriously suggesting I should have created an issue?

Yes.  Consider that your first solution wasn't going to be accepted and your second solution was found to have holes in it.  This is the kind of thing we can talk through before putting in time.  Or I might have jumped in and just fixed it.

> Another general expectation is "you broke it, you fix it"

Sometimes that works, but sometimes contributors aren't still around to take care of that.  This is open source where people give what they can and putting pressure on contributors like that can burn them out fairly quickly.

---

_Review comment by @epage on `clap_complete/tests/testsuite/engine.rs`:831 on 2025-03-17 21:03_

> I guess I have to figure this out myself?

Thats up to you.

imo the crux of this problem is that for variable `num_args`, it is both valid to have a positional *and* a flag.  `complete_arg`s [`ParseState::Pos`](https://github.com/clap-rs/clap/blob/master/clap_complete/src/engine/complete.rs#L248-L255) should take that into account.  Just copying the code over could end up making things messy, so a separate refactor of some kind should probably done first once we understand what the final state of the function should look like.

---

_@epage reviewed on 2025-03-17 21:03_

---

_@krobelus reviewed on 2025-03-17 21:24_

---

_Review comment by @krobelus on `clap_complete/tests/testsuite/engine.rs`:831 on 2025-03-17 21:24_

> Thats up to you.

I have a preference for someone else doing it

---

_@krobelus reviewed on 2025-03-17 22:56_

---

_Review comment by @krobelus on `clap_complete/tests/testsuite/engine.rs`:831 on 2025-03-17 22:56_

LMK if you can do it in reasonable time (like a week) else I'll try to

---

_@krobelus reviewed on 2025-03-19 07:48_

---

_Review comment by @krobelus on `clap_complete/tests/testsuite/engine.rs`:831 on 2025-03-19 07:48_

any response?
I'm not sure what are the conventions of this project

---

_@epage reviewed on 2025-03-19 12:43_

---

_Review comment by @epage on `clap_complete/tests/testsuite/engine.rs`:831 on 2025-03-19 12:43_

I'll possibly get to it.

Thanks for opening the issue

---

_@krobelus reviewed on 2025-03-19 16:00_

---

_Review comment by @krobelus on `clap_complete/tests/testsuite/engine.rs`:831 on 2025-03-19 16:00_

> Just copying the code over could end up making things messy, so a separate refactor of some kind should probably done first

Are you saying that code clones are bad? Okay. I'm very sorry that you think you have to say that

---

_Review comment by @epage on `clap_complete/tests/testsuite/engine.rs`:685 on 2025-03-19 16:56_

Please either revert this commit or switch to what I suggested in https://github.com/clap-rs/clap/pull/5949#discussion_r1999363225

---

_@epage reviewed on 2025-03-19 16:56_

---

_@epage reviewed on 2025-03-19 16:58_

---

_Review comment by @epage on `clap_complete/src/engine/complete.rs`:160 on 2025-03-19 16:58_

The other intermediate completion functions return a `Vec`. The performance of doing so here is unlikely to make a difference such that we should probably do so here

---

_@epage reviewed on 2025-03-19 17:55_

---

_Review comment by @epage on `clap_complete/src/engine/complete.rs`:168 on 2025-03-19 17:55_

This works by happenstance for the current test cases but isn't the actual condition we should be checking for.  If `num_args(3..=10)`, then after `3` values, we should also report options.

We need to check if we have exceeded the minimum number of arguments for the positional.

---

_@epage reviewed on 2025-03-19 17:56_

---

_Review comment by @epage on `clap_complete/src/engine/complete.rs`:168 on 2025-03-19 17:56_

Actually, the current test cases demonstrate this bug.  `"pos_1 [TAB]"` hasn't met the minimum of `2` yet, and so should only report positionals.

---

_Review comment by @epage on `clap_complete/tests/testsuite/engine.rs`:685 on 2025-03-19 20:57_

In the scenario I gave, we would still have multiple options for `positional-1`

---

_@epage reviewed on 2025-03-19 20:57_

---

_@epage reviewed on 2025-03-19 21:00_

---

_Review comment by @epage on `clap_complete/tests/testsuite/engine.rs`:685 on 2025-03-19 21:00_

Eh, minor enough at this point

---
