---
number: 15784
title: Do not update cache ctime
type: issue
state: open
author: elazarl
labels:
  - enhancement
assignees: []
created_at: 2025-09-11T09:51:58Z
updated_at: 2025-09-14T13:28:46Z
url: https://github.com/astral-sh/uv/issues/15784
synced_at: 2026-01-07T12:31:16-06:00
---

# Do not update cache ctime

---

_Issue opened by @elazarl on 2025-09-11 09:51_

### Summary

When building a docker image, we often rely on `uv`'s great caching features.

Doing something along the lines of

```Dockerfile
FROM  ghcr.io/astral-sh/uv:debian

RUN <<EOT

uv venv
source .venv/bin/activate
uv pip install kubernetes
deactivate
rm -rf .venv

EOT

RUN <<EOT

uv venv
source .venv/bin/activate
uv pip install kubernetes requests
deactivate
rm -rf .venv

EOT
```

I expect that the last layer would only contain the `requests` package in cache, and the `kubernetes` package would be taken from the previous layer.

This is since when attempting to install `kubernetes` again, `uv` updates the `ctime` in cache.

Can I prevent it from changing existing cache items? So that docker would only grab new packages?

### Example

_No response_

---

_Label `enhancement` added by @elazarl on 2025-09-11 09:51_

---

_Comment by @elazarl on 2025-09-11 10:02_

The current workaround I found:

```
C=/tmp/uv-cache
cp -r `uv cache dir` $C
uv pip install --cache-dir $C kubernetes
rsync -avc $C/ `uv cache dir`/
```

Assuming COW filesystem the initial copy isn't aweful, and docker seems to only take the new files.

---

_Comment by @zanieb on 2025-09-11 17:05_

Hm I guess the ctime changes because the number of hardlinks changes? Why's that a problem?

---

_Comment by @elazarl on 2025-09-11 18:22_

> Hm I guess the ctime changes because the number of hardlinks changes? Why's that a problem?

TBH I'm not quite sure. I'll show you the steps I took to recreate the problem

```
â¯ bat uv.Dockerfile
â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       â”‚ File: uv.Dockerfile
â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   1   â”‚ FROM  ghcr.io/astral-sh/uv:debian
   2   â”‚
   3   â”‚ RUN apt-get update && apt-get install -y rsync
   4   â”‚
   5   â”‚ RUN <<EOT
   6   â”‚
   7   â”‚ uv venv
   8   â”‚ . .venv/bin/activate
   9   â”‚ uv pip install kubernetes
  10   â”‚ deactivate
  11   â”‚ rm -rf .venv
  12   â”‚
  13   â”‚ EOT
  14   â”‚
  15   â”‚ RUN <<EOT
  16   â”‚
  17   â”‚ uv venv
  18   â”‚ . .venv/bin/activate
  19   â”‚ uv pip install kubernetes
  20   â”‚ deactivate
  21   â”‚ rm -rf .venv
  22   â”‚
  23   â”‚ EOT
â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

ubuntu in ğŸŒ elazarl-bootstrap in ~ via C v13.3.0-gcc via ğŸ v3.12.3 (atero-um)
â¯ docker buildx build -f uv.Dockerfile -t tmp .
[+] Building 4.4s (8/8) FINISHED                                                                                                                                                                                                      docker:default
 => [internal] load build definition from uv.Dockerfile                                                                                                                                                                                         0.0s
 => => transferring dockerfile: 316B                                                                                                                                                                                                            0.0s
 => [internal] load metadata for ghcr.io/astral-sh/uv:debian                                                                                                                                                                                    0.0s
 => [internal] load .dockerignore                                                                                                                                                                                                               0.0s
 => => transferring context: 2B                                                                                                                                                                                                                 0.0s
 => [1/4] FROM ghcr.io/astral-sh/uv:debian                                                                                                                                                                                                      0.0s
 => CACHED [2/4] RUN apt-get update && apt-get install -y rsync                                                                                                                                                                                 0.0s
 => CACHED [3/4] RUN <<EOT (uv venv...)                                                                                                                                                                                                         0.0s
 => [4/4] RUN <<EOT (uv venv...)                                                                                                                                                                                                                1.3s
 => exporting to image                                                                                                                                                                                                                          2.8s
 => => exporting layers                                                                                                                                                                                                                         2.7s
 => => writing image sha256:a1647151e840c84d5b13c434b178eedf14be6c537ec2775af5d26fd17c2a9c04                                                                                                                                                    0.0s
 => => naming to docker.io/library/tmp
```

Now I ran it

```
â¯ docker run -ti tmp /bin/bash
root@0a2701e6aca1:/# du -sh `uv cache dir`
29M     /root/.cache/uv
root@0a2701e6aca1:/#
```

In another shell

```
$ docker container inspect `docker container ps -l -q`|jq -r '.[]|.GraphDriver.Data.LowerDir'|tr : \\n|xargs -I@ sudo du -sh @
4.0K    /data/docker/overlay2/95af2a7d2bcd4fe15c77252e4e94b71d1e12bde924ffd15b5db19167dfe39b5b-init/diff
28M     /data/docker/overlay2/lfhobfke608dzz9fwdswayqym/diff
29M     /data/docker/overlay2/cb4v72ruwtpk98s422nfmmcas/diff
22M     /data/docker/overlay2/iw0iyehesu4g0xdaa1ffq3ida/diff
47M     /data/docker/overlay2/c8272fc40b25c1f15d10c37cd9d17a730143e258dcea509fdef5653683bcb771/diff
590M    /data/docker/overlay2/dae5f8dcc2a8537dc1a74849febfd9bb369fc7c1da2510cf71dd89dac41735f7/diff
183M    /data/docker/overlay2/c29c935136d9ddafc56d869c70e1a1bb10c26552356618e30371d4d987475e56/diff
51M     /data/docker/overlay2/86baab4e84626efe7eafbaecdec892d6b2e40b935858ad934c4a1583e58d6fc8/diff
127M    /data/docker/overlay2/010768ffc34fecf10413f67775c7ba87cb91c45361cf534e344a29246cc2d712/diff
```

I expect `lfhobfke608dzz9fwdswayqym` would not take 28MB

Also, the layers should not contain identical files, alas:

```
$ sudo diff -rn --report-identical-files   /data/docker/overlay2/lfhobfke608dzz9fwdswayqym/diff   /data/docker/overlay2/cb4v72ruwtpk98s422nfmmcas/diff|grep identical|head -3
Files /data/docker/overlay2/lfhobfke608dzz9fwdswayqym/diff/root/.cache/uv/archive-v0/52Mg-r6jPNKsXKOiVUyQP/kubernetes/__init__.py and /data/docker/overlay2/cb4v72ruwtpk98s422nfmmcas/diff/root/.cache/uv/archive-v0/52Mg-r6jPNKsXKOiVUyQP/kubernetes/__init__.py are identical
Files /data/docker/overlay2/lfhobfke608dzz9fwdswayqym/diff/root/.cache/uv/archive-v0/52Mg-r6jPNKsXKOiVUyQP/kubernetes/client/__init__.py and /data/docker/overlay2/cb4v72ruwtpk98s422nfmmcas/diff/root/.cache/uv/archive-v0/52Mg-r6jPNKsXKOiVUyQP/kubernetes/client/__init__.py are identical
Files /data/docker/overlay2/lfhobfke608dzz9fwdswayqym/diff/root/.cache/uv/archive-v0/52Mg-r6jPNKsXKOiVUyQP/kubernetes/client/api/__init__.py and /data/docker/overlay2/cb4v72ruwtpk98s422nfmmcas/diff/root/.cache/uv/archive-v0/52Mg-r6jPNKsXKOiVUyQP/kubernetes/client/api/__init__.py are identical
```

But ctime is different

```
(atero-um) ubuntu@elazarl-bootstrap:~$ sudo stat /data/docker/overlay2/lfhobfke608dzz9fwdswayqym/diff/root/.cache/uv/archive-v0/52Mg-r6jPNKsXKOiVUyQP/kubernetes/__init__.py
  File: /data/docker/overlay2/lfhobfke608dzz9fwdswayqym/diff/root/.cache/uv/archive-v0/52Mg-r6jPNKsXKOiVUyQP/kubernetes/__init__.py
  Size: 844             Blocks: 8          IO Block: 4096   regular file
Device: 0,49    Inode: 2425323     Links: 1
Access: (0644/-rw-r--r--)  Uid: (    0/    root)   Gid: (    0/    root)
Access: 2025-09-11 09:46:47.870429496 +0000
Modify: 2025-09-11 09:46:47.870429496 +0000
Change: 2025-09-11 18:12:06.893881933 +0000
 Birth: 2025-09-11 18:12:06.433886506 +0000
(atero-um) ubuntu@elazarl-bootstrap:~$ sudo stat /data/docker/overlay2/cb4v72ruwtpk98s422nfmmcas/diff/root/.cache/uv/archive-v0/52Mg-r6jPNKsXKOiVUyQP/kubernetes/__init__.py
  File: /data/docker/overlay2/cb4v72ruwtpk98s422nfmmcas/diff/root/.cache/uv/archive-v0/52Mg-r6jPNKsXKOiVUyQP/kubernetes/__init__.py
  Size: 844             Blocks: 8          IO Block: 4096   regular file
Device: 0,49    Inode: 2270007     Links: 1
Access: (0644/-rw-r--r--)  Uid: (    0/    root)   Gid: (    0/    root)
Access: 2025-09-11 09:46:47.870429496 +0000
Modify: 2025-09-11 09:46:47.870429496 +0000
Change: 2025-09-11 09:46:48.229429913 +0000
 Birth: 2025-09-11 09:46:47.870429496 +0000
```

---

_Comment by @zanieb on 2025-09-12 10:47_

I see, thanks. Maybe you want to change to `UV_LINK_MODE=copy`? I'd also recommend using a cache mount for the uv cache? Did you see our section on this in the documentation?

---

_Comment by @elazarl on 2025-09-12 14:08_

> I see, thanks. Maybe you want to change to `UV_LINK_MODE=copy`? I'd also recommend using a cache mount for the uv cache? Did you see our section on this in the documentation?

I tried the `UV_LINK_MODE=link` and it seems like a good workaround.

( *edit:* wrong conclusion)

---

_Comment by @elazarl on 2025-09-12 14:09_

(The `copy` mode defeats the purpose of the optimization, as I don't want docker images to contain two copies of the same packages.)

---

_Comment by @eabase on 2025-09-14 13:27_

Because windows doesn't have a 1:1 mapping of `ctime`, `atime`, and `mtime`. They've been broken and confused for decades. So don't expect *any*time to match between docker/WSL distros and any normal nix ones.

Hee-ell, Windows still can't even sort file times correctly in their own File Explorer!

---
