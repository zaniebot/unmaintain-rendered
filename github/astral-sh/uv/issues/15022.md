---
number: 15022
title: "`uv-trampoline`'d entrypoint .exes are not robust to being signed"
type: issue
state: closed
author: paveldikov
labels:
  - bug
  - windows
assignees: []
created_at: 2025-08-01T23:19:32Z
updated_at: 2025-11-13T19:45:52Z
url: https://github.com/astral-sh/uv/issues/15022
synced_at: 2026-01-07T12:31:16-06:00
---

# `uv-trampoline`'d entrypoint .exes are not robust to being signed

---

_Issue opened by @paveldikov on 2025-08-01 23:19_

### Summary

The current trampoline binary relies on a `UVSC` magic literal being found at the very end of the self-file, for it to be able to locate the inline Python script contents. As per the README (although it seems a bit stale, so I have tweaked this slightly), you'd have:

| vendored pre-built .exe blob -- this is a constant |
| ------ |
| inline python script |
| length of the inline script |
| `U` `V` `S` `C` |

In many enterprise contexts, only binaries signed by a trusted PKI can be executed. The signing process will generally append stuff at the end of the file, breaking the whole thing with the following kind of error:

> Magic number 'UVSC' or 'UVPY' not found at the end of the file. Did you append the magic number, the length and the path to the python executable at the end of the file?

It would be nice if the binary instead used a more conventional mechanism of vendoring this content, perhaps using a formal PE section or similar. (Unfortunately I don't really grok PE binaries, so I don't have a proper idea as to how to implement this)

There appear to be at least 2 commonly used implementations of code signing on Windows:
* `signtool`
* `Set-AuthenticodeSignature`

The latter is readily available on any Windows host, so that's handy for testing purposes.

### Platform

Windows

### Version

0.8.4

### Python version

-- not relevant --

---

_Label `bug` added by @paveldikov on 2025-08-01 23:19_

---

_Comment by @zanieb on 2025-08-02 00:07_

Is this resolved by https://github.com/astral-sh/uv/pull/8649 which moves the magic number further up in the file?

---

_Label `windows` added by @zanieb on 2025-08-02 00:07_

---

_Comment by @paveldikov on 2025-08-02 00:43_

Ooooh. Not sure, but it sounds like it might. Happy to try out a pre-release build? (and I could even contrib an integration test if all goes well)

---

_Comment by @zanieb on 2025-08-02 02:30_

There is a build at the bottom of the CI summary at https://github.com/astral-sh/uv/actions/runs/15441918416?pr=8649

If you want to contribute a test that fails now, that'd be a helpful first step anyway! 

---

_Comment by @T-256 on 2025-08-02 11:05_

> There is a build at the bottom of the CI summary at https://github.com/astral-sh/uv/actions/runs/15441918416?pr=8649

(That build's files are now expired, it must be re-triggered)

---

_Comment by @zanieb on 2025-08-02 12:04_

Alas, then it's either `cargo build` or contribute the test and we can use that to test.

---

_Comment by @paveldikov on 2025-08-04 12:13_

I have a trivial reproducer in powershell (not a proper test case yet, because my ageing PC is struggling to compile the codebase)

```
$cert = New-SelfSignedCertificate -Subject "CN=IntegrationTest" -CertStoreLocation "Cert:\CurrentUser\My" -KeyExportPolicy Exportable -KeySpec Signature -KeyLength 2048 -KeyAlgorithm RSA -HashAlgorithm SHA256 -Type "CodeSigningCert"

Set-AuthenticodeSignature -FilePath "C:\path\to\file.exe" -Certificate $cert
```

Replace path to exe as desired. Currently it will indeed break any/all trampoline'd executable -- I tried with `black`'s entrypoint.

I will now try to muster all the CPU power on my box to make this into a proper test case.

---

_Comment by @paveldikov on 2025-08-04 13:56_

I have a test!
```
diff --git a/crates/uv-trampoline-builder/src/lib.rs b/crates/uv-trampoline-builder/src/lib.rs
index 1a25b9454..ad65dcdbf 100644
--- a/crates/uv-trampoline-builder/src/lib.rs
+++ b/crates/uv-trampoline-builder/src/lib.rs
@@ -540,6 +540,50 @@ if __name__ == "__main__":
         assert!(launcher.kind == LauncherKind::Script);
         assert!(launcher.python_path == python_executable_path);

+        // Now sign the launcher using Set-AuthenticodeSignature...
+        #[cfg(windows)]
+        {
+            Command::new("powershell")
+                .args([
+                    "-NoProfile",
+                    "-NonInteractive",
+                    "-Command",
+                    &format!(
+                        r#"
+                        $ErrorActionPreference = 'Stop'
+                        $store = 'Cert:\CurrentUser\My'
+                        $cert = New-SelfSignedCertificate `
+                            -Subject 'CN=UvTrampolineTest' `
+                            -Type CodeSigning `
+                            -KeyUsage DigitalSignature `
+                            -KeyAlgorithm RSA `
+                            -KeyLength 2048 `
+                            -CertStoreLocation $store;
+                        try {{
+                            Set-AuthenticodeSignature -FilePath '{}' -Certificate $cert;
+                        }} finally {{
+                            Remove-Item -Path "$store\$($cert.Thumbprint)" -Force;
+                        }}"#,
+                        console_bin_path
+                            .path()
+                            .display()
+                            .to_string()
+                            .replace("'", "''")
+                    ),
+                ])
+                .assert()
+                .success();
+
+            // ...and verify that it still runs as it did.
+            let stdout_predicate = "Hello from uv-trampoline-console.exe\r\n";
+            let stderr_predicate = "Hello from uv-trampoline-console.exe\r\n";
+            Command::new(console_bin_path.path())
+                .assert()
+                .success()
+                .stdout(stdout_predicate)
+                .stderr(stderr_predicate);
+        }
+
         Ok(())
     }

```

Currently fails as expected with
```
command=`"C:\\Users\\Pavel\\AppData\\Local\\Temp\\.tmpAsnlot\\launcher.console.exe"`
code=1
stdout=""
stderr="Magic number \'UVSC\' or \'UVPY\' not found at the end of the file. Did you append the magic number, the length and the path to the python executable at the end of the file?\n" 
```

---

_Comment by @paveldikov on 2025-08-04 18:01_

I tried running the test against #8649 (`72fe3dec` to be precise) and it still fails with the same error. Bonus points for the error message being unchanged and confusing me to no end... until I realised what was happening ðŸ˜°

The trampoline binary in there still depends on the EOF being unmodified. It's just that, instead of `UVSC` it now expects EOCD:
|       `launcher.exe`        | |
| :-------------------------: | :-: |
|   `<path to python.exe>`    | |
| `<len(path to python.exe)>` | |
| `<b'U', b'V', b'S', b'C'>`  | <--- [3] ... here, then it goes on as usual. |
|  `<zipped python script>`   | <----- [1] Search starts at the end of here.  [2] Try to parse EOCD, which tells it how far to backtrack to get to... |

With code signing you'd get:
|       `launcher.exe`        | |
| :-------------------------: | :-: |
|   `<path to python.exe>`    | |
| `<len(path to python.exe)>` | |
| `<b'U', b'V', b'S', b'C'>`  | <----- how do I get here? |
|  `<zipped python script>`   | |
| code signing metadata | <----- [1] Search starts at the end of here; [2] Try to parse EOCD, which fails. It then goes down the `UVPY` code path (spuriously), and fails very ungracefully. |

---

_Comment by @zanieb on 2025-08-04 18:11_

Alas okay, we can look into another fix â€” I was just curious if this issue would give us more motivation to pursue that change.

---

_Comment by @paveldikov on 2025-08-04 19:44_

I wonder if it's more 'proper' to use a resource (`.rsrc`) section in the PE file instead. I think this should be vastly more robust (incl. to the zip extraction problem that #8649 tries to address) though it will possibly be harder to construct this file.

Perhaps easiest to pre-compile the binary with a placeholder resource already embedded & then altering the file post-hoc using `goblin`, `pe` or `exe` to insert the path to python + zipped script?

---

_Referenced in [astral-sh/uv#15068](../../astral-sh/uv/pulls/15068.md) on 2025-08-04 22:42_

---

_Comment by @paveldikov on 2025-08-04 22:44_

I have something (hacky, unpolished, vibe-coded) on the `uv-trampoline` end; see #15068

I haven't done the `uv-trampoline-builder` end (yet), but have tested it by hand with manual edits using Resource Hacker and `cat` (to append zip file) and it appears to work alright!

---

_Closed by @zanieb on 2025-11-13 19:45_

---
