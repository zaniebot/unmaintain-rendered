---
number: 10969
title: "Migrate `msgpack` usages to `rkyv`"
type: issue
state: open
author: charliermarsh
labels:
  - enhancement
  - performance
assignees: []
created_at: 2025-01-27T01:08:09Z
updated_at: 2025-02-01T03:55:10Z
url: https://github.com/astral-sh/uv/issues/10969
synced_at: 2026-01-07T12:31:15-06:00
---

# Migrate `msgpack` usages to `rkyv`

---

_Issue opened by @charliermarsh on 2025-01-27 01:08_

I don't see a great reason for us to continue using `msgpack`. We've had great success with `rkyv` elsewhere.

---

_Label `enhancement` added by @charliermarsh on 2025-01-27 01:08_

---

_Label `performance` added by @charliermarsh on 2025-01-27 01:08_

---

_Comment by @charliermarsh on 2025-01-27 01:19_

(It does introduce complexity though since we have to wrap everything in `OwnedArchive`.)

---

_Assigned to @charliermarsh by @charliermarsh on 2025-01-27 02:23_

---

_Comment by @BurntSushi on 2025-01-27 12:54_

What kind of perf improvement do you think we'll have here? Is msgpack showing up on profiles?

I think there are definitely reasons to continue using msgpack, or, really, any other format that isn't tied to our in-memory representation of various data types. One of the costs associated with rkyv is that any change to a relevant data type, even just to its data layout, also invalidates all associated cached artifacts.

We also still currently don't have a good way of validating that we've bumped our rkyv-based cache versions when it's necessary to do so. Using rkyv in more places would exacerbate this.

If we're using msgpack in places where the types we are caching change very infrequently, then probably the downside of rkyv isn't as emphasized.

---

_Comment by @charliermarsh on 2025-01-27 14:04_

Yeah, it shows up for me in warm cache traces! We spend a lot of time deserializing the project metadata (as opposed to the list of files, for which we already use rkyv). That's the path I want to migrate. I don't think it's that different, honestly, that the cache gets invalidated on data layout. It already gets invalidated whenever we change the struct structures themselves.

---

_Comment by @BurntSushi on 2025-01-27 14:14_

Ah interesting. Might be worth it then. It would be great to have something that validates version bumps though. The failure modes there if we forget a version bump are pretty abysmal sadly.

---

_Comment by @charliermarsh on 2025-01-27 14:31_

Yeah. (I consider this overall low-priority, but worth doing eventually.)

---

_Comment by @charliermarsh on 2025-02-01 03:54_

I got this to compile: https://github.com/astral-sh/uv/tree/charlie/rkyv. It ended up not making a difference. I think that implementation is still spending a lot of time serializing and deserializing as strings, since `Url` and `MarkerTree` still go through strings. Plus, I end up having to deserialize everything upfront to cast from `ResolutionMetadata` to `ArchivedMetadata`.


---

_Unassigned @charliermarsh by @charliermarsh on 2025-02-01 03:55_

---

_Comment by @charliermarsh on 2025-02-01 03:55_

I'll leave this open, but I now consider it low-priority.

---
