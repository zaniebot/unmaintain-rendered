---
number: 13815
title: "`uv publish` fails with a 404 when uploading to a GitLab.com package registry in CI using CI_JOB_TOKEN"
type: issue
state: closed
author: winpat
labels:
  - bug
assignees: []
created_at: 2025-06-03T14:10:02Z
updated_at: 2025-06-04T04:47:08Z
url: https://github.com/astral-sh/uv/issues/13815
synced_at: 2026-01-07T12:31:16-06:00
---

# `uv publish` fails with a 404 when uploading to a GitLab.com package registry in CI using CI_JOB_TOKEN

---

_Issue opened by @winpat on 2025-06-03 14:10_

### Summary

Uploading packages to a GitLab.com provided package registry through `uv export` crashes with a 404 when using the job provided `CI_JOB_TOKEN` as the password.

**The upload works fine when using a personal access token instead.**

I was a bit on the fence on whether I should report this as this looks more like a GitLab issue. However with `poetry` the upload works fine `CI_JOB_TOKEN`. So chances are other people will also run into a similar issue.

Also thank you for developing `uv`, it's a phenomenal tool.

GitLab CI configuration:
```
image: python:3.10-slim

variables:
  UV_VERSION: 0.7.9
  UV_PUBLISH_URL: https://gitlab.com/api/v4/projects/REDACTED/packages/pypi
  UV_PUBLISH_USERNAME: gitlab-ci-token
  UV_PUBLISH_PASSWORD: ${CI_JOB_TOKEN}
  # GitLab CI creates a separate mountpoint for the build directory,
  # so we need to copy instead of using hard links.
  UV_LINK_MODE: copy

stages:
  - publish

publish:
  stage: publish
  script:
    - pip install uv==${UV_VERSION}
    - uv sync
    - echo $UV_PUBLISH_URL
    - echo $UV_PUBLISH_USERNAME
    - echo $UV_PUBLISH_PASSWORD
    - uv version ${CI_COMMIT_TAG}
    - uv build --sdist
    - ls dist/*
    - uv publish -vv
  only:
    - tags
```

Job logs with `uv export -vv` active.
```
$ echo $UV_PUBLISH_URL
https://gitlab.com/api/v4/projects/REDACTED/packages/pypi
$ echo $UV_PUBLISH_USERNAME
gitlab-ci-token
$ echo $UV_PUBLISH_PASSWORD
[MASKED]
$ uv version ${CI_COMMIT_TAG}
Resolved 37 packages in 760ms
   Building somelib @ file:///builds/company/somelib
      Built somelib @ file:///builds/company/somelib
Prepared 1 package in 357ms
Uninstalled 1 package in 0.81ms
Installed 1 package in 0.97ms
 - somelib==0.0.0 (from file:///builds/company/somelib)
 + somelib==25.6.1rc16 (from file:///builds/company/somelib)
somelib 0.0.0 => 25.6.1rc16
$ uv build --sdist
Building source distribution...
Successfully built dist/somelib-25.6.1rc16.tar.gz
$ ls dist/*
dist/somelib-25.6.1rc16.tar.gz
$ uv publish -vv
DEBUG uv 0.7.9
DEBUG Not a distribution filename: `.gitignore`
Publishing 1 file to https://gitlab.com/api/v4/projects/REDACTED/packages/pypi
DEBUG Using request timeout of 900s
Uploading somelib-25.6.1rc16.tar.gz (1.5MiB)
DEBUG Hashing dist/somelib-25.6.1rc16.tar.gz
Uploading somelib-25.6.1rc16.tar.gz (1.5MiB)
DEBUG Using HTTP Basic authentication
TRACE Handling request for https://gitlab-ci-token:****@gitlab.com/api/v4/projects/REDACTED/packages/pypi with authentication policy auto
TRACE Request for https://gitlab-ci-token:****@gitlab.com/api/v4/projects/REDACTED/packages/pypi already contains username and password
DEBUG Response code for https://gitlab.com/api/v4/projects/REDACTED/packages/pypi: 404 Not Found
TRACE Response headers for https://gitlab.com/api/v4/projects/REDACTED/packages/pypi: Response { url: "https://gitlab.com/api/v4/projects/REDACTED/packages/pypi", status: 404, headers: {"date": "Tue, 03 Jun 2025 14:05:02 GMT", "content-type": "application/json", "content-length": "27", "cf-ray": "949fbe384dcfe592-ATL", "cf-cache-status": "DYNAMIC", "cache-control": "no-cache", "strict-transport-security": "max-age=31536000", "vary": "Origin, Accept-Encoding", "content-security-policy": "default-src 'none'", "gitlab-lb": "haproxy-main-52-lb-gprd", "gitlab-sv": "gke-cny-api", "nel": "{\"max_age\": 0}", "referrer-policy": "strict-origin-when-cross-origin", "x-content-type-options": "nosniff", "x-frame-options": "SAMEORIGIN", "x-gitlab-meta": "{\"correlation_id\":\"bba124864df672f05130e218f9def24f\",\"version\":\"1\"}", "x-request-id": "bba124864df672f05130e218f9def24f", "x-runtime": "0.138175", "set-cookie": "_cfuvid=9zKLGRKiEXRzHDcLZjAHa.6Vrz5M_LdEz1j5qCNkTN4-1748959502534-0.0.1.1-604800000; path=/; domain=.gitlab.com; HttpOnly; Secure; SameSite=None", "server": "cloudflare"} }
TRACE Response content for non-200 response for https://gitlab.com/api/v4/projects/REDACTED/packages/pypi: {"message":"404 Not Found"}
DEBUG Upload error response: {"message":"404 Not Found"}
error: Failed to publish `dist/somelib-25.6.1rc16.tar.gz` to https://gitlab.com/api/v4/projects/REDACTED/packages/pypi
  Caused by: Upload failed with status code 404 Not Found. Server says: {"message":"404 Not Found"}
Cleaning up project directory and file based variables 00:01
ERROR: Job failed: exit code 1
```

### Platform

GitLab CI / python:3.10-slim Docker Image

### Version

0.7.9

### Python version

3.10

---

_Label `bug` added by @winpat on 2025-06-03 14:10_

---

_Comment by @winpat on 2025-06-03 14:22_

Sorry, this was configuration error on my side. The solution described in https://github.com/astral-sh/uv/issues/8563 works.

In our case the package registry is in a different GitLab repository as the code, so one has to whitelist the job token to be accepted in the other repository.

Settings > CI/CD > Job Tokens -> Job Token permissions

---

_Closed by @winpat on 2025-06-03 14:22_

---

_Comment by @zanieb on 2025-06-03 14:24_

Thanks for following up!

---

_Comment by @zanieb on 2025-06-03 14:24_

Do you think we should add that to the docs?

---

_Comment by @winpat on 2025-06-04 04:47_

> Do you think we should add that to the docs?

I don't think so, this is seems like a GitLab issue. The confusing bit was that passing an invalid password resulted in a 401 status code, which make sense. But when using the CI_JOB_TOKEN, the registry returned a 404 when the token permissions were not explicitly set for the source repository.

---
