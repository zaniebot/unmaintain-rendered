---
number: 11463
title: "universal {lock, pip compile}: ability to ignore wheels for certain platforms during resolution"
type: issue
state: open
author: paveldikov
labels:
  - enhancement
assignees: []
created_at: 2025-02-12T22:59:00Z
updated_at: 2025-08-28T12:05:49Z
url: https://github.com/astral-sh/uv/issues/11463
synced_at: 2026-01-07T12:31:15-06:00
---

# universal {lock, pip compile}: ability to ignore wheels for certain platforms during resolution

---

_Issue opened by @paveldikov on 2025-02-12 22:59_

### Summary

Example use case: I want universal resolution, except I really do not care about Mac (and in fact, Mac wheels are actively sabotaging the resolution)

Something like `--exclude-python-platform 'macos_*'` (wildcards would be nice too üòÅ)

### Example

_No response_

---

_Label `enhancement` added by @paveldikov on 2025-02-12 22:59_

---

_Comment by @charliermarsh on 2025-02-12 22:59_

I think you can accomplish this with `environments`, which lets you narrow the set of supported environments:

```toml
[tool.uv]
environments = ["sys_platform != 'darwin'"]
```

See: https://docs.astral.sh/uv/reference/settings/#environments

---

_Comment by @paveldikov on 2025-02-12 23:00_

That would be amazing. Testing...

---

_Comment by @paveldikov on 2025-02-12 23:08_

No dice. `uv pip compile --universal pyproject.toml` did not seem to pick it up.

---

_Comment by @charliermarsh on 2025-02-12 23:11_

Is the `pyproject.toml` actually in CWD? Like is uv picking up settings from it? I don't think it would work by pointing to an arbitrary `pyproject.toml`, it has to be the file that using is using for configuration.

---

_Comment by @paveldikov on 2025-02-12 23:13_

Yes it is and I deliberately broke the syntax to find out and `uv` got annoyed.

Note, the problem here is that the macos wheels have a tendency to give 403 errors on fetch. I wonder if `environments` is implemented after the initial computation i.e. it's a prune rather than an input filter?

---

_Comment by @charliermarsh on 2025-02-12 23:14_

Ah yeah, I don't think this would fix that. `environments` is a filter at the end _and_ we avoid solving branches in the resolution tree that are disjoint with the specified environments.

---

_Comment by @paveldikov on 2025-02-12 23:22_

Yeah... this issue is also a cousin of #5260 I'd raised last year.

Basically false-positive 403s are a fact of life for us (and basically anyone who uses caching proxy indexes with bolted-on security scanning on top). And I am desperately trying to minimise the impact to developer productivity...

(Right now I find myself having to deliver lectures on universal locking every time a user insists that 'this is clearly broken since I do not use Mac!')

Could `environments` be made to act as a filter at the beginning, at least in the `sys_platform` case?

---

_Renamed from "universal {lock, pip compile}: ability to exclude certain platforms" to "universal {lock, pip compile}: ability to ignore wheels for certain platforms" by @charliermarsh on 2025-02-13 15:17_

---

_Renamed from "universal {lock, pip compile}: ability to ignore wheels for certain platforms" to "universal {lock, pip compile}: ability to ignore wheels for certain platforms during resolution" by @charliermarsh on 2025-02-13 15:17_

---

_Comment by @charliermarsh on 2025-02-13 15:18_

Possibly... Is it _just_ macOS wheels where you experience this is your setup?

---

_Comment by @paveldikov on 2025-02-14 09:58_

It's not strictly limited to MacOS wheels, but the prevalence there is (for some inscrutable reason) much higher. And since MacOS is not a very common platform for us, it really draws attention to itself.

Often times users would end up just disabling universal resolution (which is unfortunate), but at the moment we have users who are actively relying on the universal resolution so that they can have repeatable tests across multiple Python versions. (a non-universal constraints file generated for the lower bound will actively fail to install on the higher versions. And the universal file fails to generate due to the 403)

---

_Referenced in [astral-sh/uv#11294](../../astral-sh/uv/pulls/11294.md) on 2025-02-28 19:53_

---

_Referenced in [astral-sh/uv#9277](../../astral-sh/uv/issues/9277.md) on 2025-04-08 18:53_

---

_Comment by @paveldikov on 2025-08-27 09:30_

This is still an issue btw. I am aware my use case is pretty niche in the scheme of things, but I'd like to give my users a robust way of not hitting this very annoying and conspicuous roadblock.

I'd be happy to contribute a change if that makes things any easier, but I have very little familiarity with the resolver part of the codebase, so I'd need lots of pointers.

---

_Comment by @konstin on 2025-08-27 10:44_

Can you use `tool.uv.environments` with `uv lock` and `uv export`? This should do a universal resolution ignoring all mac packages (including the dependency edges) and the export gives you a `requirements.txt` (or `pylock.toml`)

---

_Comment by @paveldikov on 2025-08-27 12:28_

Nope, it still tries to fetch the Mac wheels, and in turn hits the 403 error which I am wanting to sidestep. The filtering applies too late in the algorithm.

---

_Comment by @konstin on 2025-08-28 10:37_

Currently, we're always selecting the macos wheel for metadata fetching. To work around the proxy constraint, we would need to consider `tool.uv.environments` in `PrioritizedDist` construction, potentially having to generate implied markers for each wheel. Another approach would be returning PEP 658 metadata in the index, this allows fetching the information that uv needs without actually downloading any zips that could get caught in a security filter.

---

_Comment by @konstin on 2025-08-28 12:05_

(This is assuming that the security filter specifically blocks zip files and other archives, while allowing plain text API responses such as a PEP 658 `.metadata` file)

---
