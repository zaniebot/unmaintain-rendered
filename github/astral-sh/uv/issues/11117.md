---
number: 11117
title: "`uv run --with ...` leaves `_uv_ephemeral_overlay.pth` in ephemeral environment"
type: issue
state: closed
author: daviesian
labels:
  - bug
  - cache
  - great writeup
assignees: []
created_at: 2025-01-30T19:53:08Z
updated_at: 2025-02-04T22:45:46Z
url: https://github.com/astral-sh/uv/issues/11117
synced_at: 2026-01-07T12:31:15-06:00
---

# `uv run --with ...` leaves `_uv_ephemeral_overlay.pth` in ephemeral environment

---

_Issue opened by @daviesian on 2025-01-30 19:53_

## Summary

Inside a project, running `uv run --with jupyter jupyter lab` correctly [adds `_uv_ephemeral_overlay.pth`](https://github.com/astral-sh/uv/blob/7531bb866902aedd3095f8da9ed87a2ae0676d2f/crates/uv/src/commands/project/run.rs#L1003) to the ephemeral environment created for `jupyter`. However, the `_uv_ephemeral_overlay.pth` file is never cleaned up, so subsequent uses of that cached ephemeral environment will see it too. In most cases this doesn't matter because it will be overwritten, but `uv tool run` (`uvx`) will not overwrite it. In this example, running `uvx jupyter lab` elsewhere on the system matches the same cached environment and therefore incorrectly includes the original project virtual env in `sys.path`.

## Example

```bash
uv init my-project
cd my-project
uv run --with jupyter jupyter lab

# Print sys.path inside a Jupyter cell. See that the current project venv is correctly on the path
# Ctrl-C to quit Jupyter

cd /some-other-folder
uvx jupyter lab

# Print sys.path inside a Jupyter cell. See that my-project/.venv is incorrectly on the path, 
# despite the fact that this should be an entirely isolated environment

uv cache clean
uvx jupyter lab

# Print sys.path inside a Jupyter cell. See that my-project/.venv is gone, because the
# left-over _uv_ephemeral_overlay.pth is no longer in the ephemeral environment.
```

This happens with both `uvx` and `uv tool run`, and appears to be because `uv run --with x` and `uv tool run x` match the same cached ephemeral environment, even though `uv run` leaves behind the `.pth` file.

N.B. This problem is not caused by [the PR that added `_uv_ephemeral_overlay.pth`](https://github.com/astral-sh/uv/pull/7161) - the previous implemention using `sitecustomize.py` had the same problem.

---

I _think_ the solution may be as simple as cleaning up `_uv_ephemeral_overlay.pth` before using [the chosen environment for `uv tool run`](https://github.com/astral-sh/uv/blob/7531bb866902aedd3095f8da9ed87a2ae0676d2f/crates/uv/src/commands/tool/run.rs#L118), but I'm unfamiliar with Rust in general and this codebase in particular, so would be hesitant to open a PR directly.

### Platform

macOS 14 arm64 and Windows 11 x86_64

### Version

uv 0.5.25 (9c07c3fc5 2025-01-28)

### Python version

Python 3.12.0

---

_Label `bug` added by @daviesian on 2025-01-30 19:53_

---

_Renamed from "`uv run --with ...` leaves `_uv_ephemeral_overlay.pth` in ephemeral environment, which is incorrect for subsequent uses of `uv tool run ...`" to "`uv run --with ...` leaves `_uv_ephemeral_overlay.pth` in ephemeral environment" by @daviesian on 2025-01-30 19:53_

---

_Comment by @zanieb on 2025-01-30 19:54_

Interesting! Thanks for the report

---

_Label `cache` added by @zanieb on 2025-01-30 19:54_

---

_Label `great writeup` added by @zanieb on 2025-01-30 19:54_

---

_Comment by @charliermarsh on 2025-01-31 03:49_

Hmm... I mean, we can just remove it in `uv tool run`. But it seems not-completely-safe for us to do so, since another process could simultaneously be starting up the same cached environment, but with the overlay applied. I guess that's _already_ a risk today, though? Like, two commands could simultaneously use the same cached environment, and overwrite one another's `uv_ephemeral_overlay.pth`?

---

_Comment by @charliermarsh on 2025-01-31 03:54_

I wonder if there's a way for us to provide that `.pth` file to the interpreter without writing it to the cache. Could we augment the `PYTHONPATH` to look for it, or something?

---

_Comment by @charliermarsh on 2025-01-31 03:57_

Hmm, no, not seeing anything like that. I guess we should just clean it up in `uv tool run` and live with it until it becomes an issue.

---

_Assigned to @charliermarsh by @charliermarsh on 2025-01-31 18:37_

---

_Referenced in [astral-sh/uv#11141](../../astral-sh/uv/pulls/11141.md) on 2025-01-31 19:15_

---

_Closed by @charliermarsh on 2025-02-04 22:45_

---

_Closed by @charliermarsh on 2025-02-04 22:45_

---
