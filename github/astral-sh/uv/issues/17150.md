---
number: 17150
title: "`as_io_error` and coalescing `io::Error` could lead to confusing behaviour/bugs"
type: issue
state: open
author: EliteTK
labels:
  - enhancement
  - internal
  - error messages
assignees: []
created_at: 2025-12-16T15:48:32Z
updated_at: 2025-12-16T16:31:24Z
url: https://github.com/astral-sh/uv/issues/17150
synced_at: 2026-01-07T12:31:16-06:00
---

# `as_io_error` and coalescing `io::Error` could lead to confusing behaviour/bugs

---

_Issue opened by @EliteTK on 2025-12-16 15:48_

### Issue

[Currently](https://github.com/astral-sh/uv/tree/66f7093ad2f1b0fd34b59d486c3c0ac57fc0e781) the function `as_io_error` is implemented for:

* [`uv_fs::locked_file::LockedFileError`](https://github.com/astral-sh/uv/blob/66f7093ad2f1b0fd34b59d486c3c0ac57fc0e781/crates/uv-fs/src/locked_file.rs#L78-L88)
* [`uv_auth::store::TomlCredentialError`](https://github.com/astral-sh/uv/blob/66f7093ad2f1b0fd34b59d486c3c0ac57fc0e781/crates/uv-auth/src/store.rs#L93-L103)
* [`uv_tool::Error`](https://github.com/astral-sh/uv/blob/66f7093ad2f1b0fd34b59d486c3c0ac57fc0e781/crates/uv-tool/src/lib.rs#L95-L112)

These functions return the `io::Error` for any error variant within the error which contains an `io::Error`. In the case of `TomlCredentialError` and `uv_tool::Error` these also delegate to `LockedFileError`.

`LockedFileError::as_io_error` is used in one place (aside from the implementation of `as_io_error` of the other errors):

<https://github.com/astral-sh/uv/blob/66f7093ad2f1b0fd34b59d486c3c0ac57fc0e781/crates/uv-cache/src/lib.rs#L454-L488>

This problem is that the code it is used in is checking if shared locking is unsupported, which specifically relates to `LockedFileError::Lock`:

https://github.com/astral-sh/uv/blob/66f7093ad2f1b0fd34b59d486c3c0ac57fc0e781/crates/uv-fs/src/locked_file.rs#L176-L181

But various other errors in `LockedFileError` include `io::Error`. This means that if any other function fails with an error with `ErrorKind::Unsupported` then the error message will be misleading.

`TomlCredentialError::as_io_error` is used in two places:

<https://github.com/astral-sh/uv/blob/66f7093ad2f1b0fd34b59d486c3c0ac57fc0e781/crates/uv-auth/src/middleware.rs#L80-L109>

<https://github.com/astral-sh/uv/blob/66f7093ad2f1b0fd34b59d486c3c0ac57fc0e781/crates/uv-auth/src/store.rs#L31-L53>

In both cases `as_io_error` is being used to check for `ErrorKind::NotFound`. This will assume that the credential store itself was not found. But any io operation performed while locking the lockfile or reading the credential store which triggers an error of that sort would lead down this path. While it might make sense to coalesce the errors in the case of errors coming from `TextCredentialStore::from_file`, errors from `LockedFile::acquire` probably aren't relevant here.

There are 5 uses for `uv_tool::Error::as_io_error`:

* <https://github.com/astral-sh/uv/blob/66f7093ad2f1b0fd34b59d486c3c0ac57fc0e781/crates/uv/src/commands/tool/install.rs#L406>
* <https://github.com/astral-sh/uv/blob/66f7093ad2f1b0fd34b59d486c3c0ac57fc0e781/crates/uv/src/commands/tool/list.rs#L32>
* <https://github.com/astral-sh/uv/blob/66f7093ad2f1b0fd34b59d486c3c0ac57fc0e781/crates/uv/src/commands/tool/run.rs#L480>
* <https://github.com/astral-sh/uv/blob/66f7093ad2f1b0fd34b59d486c3c0ac57fc0e781/crates/uv/src/commands/tool/uninstall.rs#L22>
* <https://github.com/astral-sh/uv/blob/66f7093ad2f1b0fd34b59d486c3c0ac57fc0e781/crates/uv/src/commands/tool/uninstall.rs#L119>

All are using it to check for `ErrorKind::NotFound` and all exhibit similar issues.

### Proposal

* Consider removing implementations of `as_io_error`
* For cases where a number of different enum variants may contribute to "this operation failed because of X underlying cause" (like maybe for `uv_tool::Error`) an explicit predicate function (e.g. maybe `::Io` and `::VirtualEnvError`).
* For other cases, the relevant case should be checked explicitly.
* `Io(#[from] io::Error)` variants should be checked to ensure that they aren't used in situations where errors unrelated to each other are merged and then checked against an `ErrorKind` which could cause confusing error messages.

### Example

This would avoid buggy error reporting behaviour and make it easier to reason about the code.

---

_Label `enhancement` added by @EliteTK on 2025-12-16 15:48_

---

_Label `internal` added by @EliteTK on 2025-12-16 15:48_

---

_Label `error messages` added by @EliteTK on 2025-12-16 15:48_

---

_Comment by @konstin on 2025-12-16 15:59_

I'm very much in favor of replacing `as_io_error` with properly typed checks.

I'd implement it so that `TomlCredentialError` should have a dedicated `NotFound` variant, so what callee can decide what is a not found error at call time. We likely want to replace some `Io(#[from] io::Error)` with `Io(#[source] io::Error)` to get more explicit checking.

---
