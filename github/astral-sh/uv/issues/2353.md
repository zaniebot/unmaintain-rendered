---
number: 2353
title: Regression from 0.1.15 to 0.1.16/17 when using --system on some RHEL based Docker images
type: issue
state: closed
author: alexprengere
labels:
  - bug
  - needs-mre
assignees: []
created_at: 2024-03-11T09:03:57Z
updated_at: 2024-03-14T07:53:07Z
url: https://github.com/astral-sh/uv/issues/2353
synced_at: 2026-01-07T12:31:14-06:00
---

# Regression from 0.1.15 to 0.1.16/17 when using --system on some RHEL based Docker images

---

_Issue opened by @alexprengere on 2024-03-11 09:03_

I have a Docker image from a private registry which boils down to:

```
FROM some_private_registry/rhel:latest

RUN dnf install --assumeyes python3 \
 && dnf install --assumeyes python3-pip

RUN pip install --upgrade uv==0.1.15
RUN uv pip install httpx --system
```
This works great!
When replacing `uv==0.1.15` by `uv==0.1.16` or `uv==0.1.17`, I now have this error:

```
STEP 4/4: RUN uv pip install httpx --system
error: Failed to list installed packages
  Caused by: failed to read directory `/usr/local/lib/python3.9/site-packages`
  Caused by: No such file or directory (os error 2)
Error: building at STEP "RUN uv pip install httpx --system": while running runtime: exit status 2
```

Here are a few more details when inspecting the image:

```
[root@0d3d619df19e app]# python3 -m site
sys.path = [
    '/app',
    '/usr/lib64/python39.zip',
    '/usr/lib64/python3.9',
    '/usr/lib64/python3.9/lib-dynload',
    '/usr/local/lib64/python3.9/site-packages',
    '/usr/lib64/python3.9/site-packages',
    '/usr/lib/python3.9/site-packages',
]
USER_BASE: '/root/.local' (doesn't exist)
USER_SITE: '/root/.local/lib/python3.9/site-packages' (doesn't exist)
ENABLE_USER_SITE: True

[root@0d3d619df19e app]# python3 -c 'import site; print("\n".join(site.getsitepackages()))'
/usr/local/lib64/python3.9/site-packages
/usr/local/lib/python3.9/site-packages
/usr/lib64/python3.9/site-packages
/usr/lib/python3.9/site-packages
```
It looks like `/usr/local/lib/python3.9/site-packages` does not exist.

```
[root@0d3d619df19e app]# ls /usr/local/lib64/python3.9/site-packages
uv  uv-0.1.15.dist-info
[root@0d3d619df19e app]# ls /usr/local/lib/python3.9/site-packages
ls: cannot access '/usr/local/lib/python3.9/site-packages': No such file or directory
```
I am not sure why `/usr/local/lib64/python3.9/site-packages` was not chosen here.
I checked on Fedora, it has a similar layout and the same issue is there.

---

_Comment by @charliermarsh on 2024-03-11 13:02_

Iâ€™ll take a look, thanks! The main change between those versions is that we now follow the same logic as pip: for older Python versions or distros that override it, we use distutils instead of site-packages. Thatâ€™s likely whatâ€™s happening here, since youâ€™re pre-3.9, and my guess is distutils is patched in some way by the distro.

Can you check what directory pip installs into?

---

_Comment by @charliermarsh on 2024-03-11 13:51_

Actually, by far the most useful thing would be if you could share a minimal Dockerfile that reproduces this with Fedora or otherwise.

---

_Assigned to @charliermarsh by @charliermarsh on 2024-03-11 13:51_

---

_Label `bug` added by @charliermarsh on 2024-03-11 13:52_

---

_Label `needs-mre` added by @charliermarsh on 2024-03-11 13:52_

---

_Comment by @alexprengere on 2024-03-11 14:47_

I could not reproduce on Fedora in Docker, so I will focus on RHEL, and open a separate issue for Fedora if I can ever build a MRE.

Here is the MRE for RHEL:

```
FROM registry.access.redhat.com/rhel7/rhel
RUN python3 -m ensurepip
RUN python3 -m pip install --upgrade uv
RUN uv pip install httpx --system
```

Then I use podman to build (4.6.2). Thanks!

---

_Comment by @charliermarsh on 2024-03-11 14:50_

Thank you!

---

_Comment by @charliermarsh on 2024-03-11 14:53_

On that I get:

```
 > [2/4] RUN python3 -m ensurepip:
#5 0.137 /bin/sh: python3: command not found
```

---

_Comment by @charliermarsh on 2024-03-11 14:57_

I can try to resolve but I would like to make sure I'm using the same system Python install.

---

_Comment by @alexprengere on 2024-03-11 15:29_

My bad, some caching hid this error. I will attempt another MRE (this is a bit non-trivial as my original issue used a private registry with private base images), and I am trying to replicate on publicly available images. Thank you for your patience.

---

_Comment by @charliermarsh on 2024-03-11 16:43_

@alexprengere - No rush, I just want to get it fixed as soon as I'm able to! :)

---

_Referenced in [astral-sh/uv#2387](../../astral-sh/uv/issues/2387.md) on 2024-03-12 17:40_

---

_Referenced in [astral-sh/uv#2404](../../astral-sh/uv/issues/2404.md) on 2024-03-13 04:01_

---

_Comment by @charliermarsh on 2024-03-13 15:11_

I believe this is fixed by https://github.com/astral-sh/uv/pull/2413 (available in the next release).

---

_Closed by @charliermarsh on 2024-03-13 15:11_

---

_Comment by @charliermarsh on 2024-03-13 15:11_

If not, please re-open!

---

_Comment by @alexprengere on 2024-03-14 07:53_

I can confirm the problem is no longer there on uv 0.1.20 ðŸ¥³ Thanks!

---
