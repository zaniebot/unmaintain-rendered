---
number: 13212
title: "`version::self_version_json` and `version::version_get_fallback_unmanaged_json` test failures (outside git checkout?)"
type: issue
state: closed
author: mgorny
labels:
  - bug
assignees: []
created_at: 2025-04-30T04:19:25Z
updated_at: 2025-05-21T19:59:40Z
url: https://github.com/astral-sh/uv/issues/13212
synced_at: 2026-01-07T12:31:16-06:00
---

# `version::self_version_json` and `version::version_get_fallback_unmanaged_json` test failures (outside git checkout?)

---

_Issue opened by @mgorny on 2025-04-30 04:19_

### Summary

```
failures:

---- version::self_version_json stdout ----

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ Unfiltered output ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
----- stdout -----
{
  "package_name": "uv",
  "version": "0.7.0",
  "commit_info": null
}

----- stderr -----

────────────────────────────────────────────────────────────────────────────────

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ Snapshot Summary ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
Snapshot: self_version_json
Source: crates/uv/tests/it/version.rs:1178
────────────────────────────────────────────────────────────────────────────────
Expression: snapshot
────────────────────────────────────────────────────────────────────────────────
-old snapshot
+new results
────────────┬───────────────────────────────────────────────────────────────────
    2     2 │ ----- stdout -----
    3     3 │ {
    4     4 │   "package_name": "uv",
    5     5 │   "version": "[VERSION]",
    6       │-  "commit_info": {
    7       │-    "short_commit_hash": "[LONGHASH]",
    8       │-    "commit_hash": "[LONGHASH]",
    9       │-    "commit_date": "[DATE]",
   10       │-    "last_tag": "[TAG]",
   11       │-    "commits_since_last_tag": [COUNT]
   12       │-  }
          6 │+  "commit_info": null
   13     7 │ }
   14     8 │ 
   15     9 │ ----- stderr -----
────────────┴───────────────────────────────────────────────────────────────────
To update snapshots run `cargo insta review`
Stopped on the first failure. Run `cargo insta test` to run all snapshots.

thread 'version::self_version_json' panicked at /var/tmp/portage/dev-python/uv-0.7.0/work/cargo_home/gentoo/insta-1.43.0/src/runtime.rs
:679:13:
snapshot assertion for 'self_version_json' failed in line 1178
note: run with `RUST_BACKTRACE=1` environment variable to display a backtrace

---- version::version_get_fallback_unmanaged_json stdout ----

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ Unfiltered output ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
----- stdout -----
{
  "package_name": "uv",
  "version": "0.7.0",
  "commit_info": null
}

----- stderr -----
warning: Failed to read project metadata (The project is marked as unmanaged: `/var/tmp/portage/dev-python/uv-0.7.0/homedir/.local/shar
e/uv/tests/.tmpApoa5j/temp`). Running `uv self version` for compatibility. This fallback will be removed in the future; pass `--preview
` to force an error.

────────────────────────────────────────────────────────────────────────────────

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ Snapshot Summary ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
Snapshot: version_get_fallback_unmanaged_json
Source: crates/uv/tests/it/version.rs:947
────────────────────────────────────────────────────────────────────────────────
Expression: snapshot
────────────────────────────────────────────────────────────────────────────────
-old snapshot
+new results
────────────┬───────────────────────────────────────────────────────────────────
    2     2 │ ----- stdout -----
    3     3 │ {
    4     4 │   "package_name": "uv",
    5     5 │   "version": "[VERSION]",
    6       │-  "commit_info": {
    7       │-    "short_commit_hash": "[LONGHASH]",
    8       │-    "commit_hash": "[LONGHASH]",
    9       │-    "commit_date": "[DATE]",
   10       │-    "last_tag": "[TAG]",
   11       │-    "commits_since_last_tag": [COUNT]
   12       │-  }
          6 │+  "commit_info": null
   13     7 │ }
   14     8 │ 
   15     9 │ ----- stderr -----
   16    10 │ warning: Failed to read project metadata (The project is marked as unmanaged: `[TEMP_DIR]/`). Running `uv self version` f
or compatibility. This fallback will be removed in the future; pass `--preview` to force an error.
────────────┴───────────────────────────────────────────────────────────────────
To update snapshots run `cargo insta review`
Stopped on the first failure. Run `cargo insta test` to run all snapshots.

thread 'version::version_get_fallback_unmanaged_json' panicked at /var/tmp/portage/dev-python/uv-0.7.0/work/cargo_home/gentoo/insta-1.4
3.0/src/runtime.rs:679:13:
snapshot assertion for 'version_get_fallback_unmanaged_json' failed in line 947
```

My educated guess would be that the tests are assuming they're going to be run from a git checkout, whereas we're running them from unpacked GitHub archives.

### Platform

Gentoo Linux amd64

### Version

0.7.0

### Python version

_No response_

---

_Label `bug` added by @mgorny on 2025-04-30 04:19_

---

_Comment by @mgorny on 2025-04-30 04:20_

CC @Gankra.

---

_Assigned to @Gankra by @konstin on 2025-04-30 09:02_

---

_Comment by @Gankra on 2025-04-30 14:20_

interesting, we can definitely loosen the test but it is accurately reflecting that your tarball build of uv can't report this info.

---

_Comment by @Gankra on 2025-04-30 20:28_

Just confirmed: `uv self version --output-format json` for the prebuilt version of uv we provide does produce this commit_info regardless of where you run it. So it's not that the test suite expects to be run in the repo, but rather that the test suite expects the built binary to have this feature (and the built binary only has this feature if it was built in the repo, which our prebuilt binaries were).

---

_Comment by @Gankra on 2025-04-30 20:33_

Digging into it more, you can ensure gentoo builds of uv have this metadata by setting the following env-vars at build time:

```rust
    let commit_info = option_env_str!("UV_COMMIT_HASH").map(|commit_hash| CommitInfo {
        short_commit_hash: option_env_str!("UV_COMMIT_SHORT_HASH").unwrap(),
        commit_hash,
        commit_date: option_env_str!("UV_COMMIT_DATE").unwrap(),
        last_tag: option_env_str!("UV_LAST_TAG"),
        commits_since_last_tag: option_env_str!("UV_LAST_TAG_DISTANCE")
            .as_deref()
            .map_or(0, |value| value.parse::<u32>().unwrap_or(0)),
    });
```

That is:

* UV_COMMIT_HASH
* UV_COMMIT_SHORT_HASH
* UV_COMMIT_DATE
* UV_LAST_TAG
* UV_LAST_TAG_DISTANCE

Example values in `0.7.2`:

```
"commit_info": {
    "short_commit_hash": "481d05d8d",
    "commit_hash": "481d05d8dfb8627612dec72840a02c17b926b263",
    "commit_date": "2025-04-30",
    "last_tag": null,
    "commits_since_last_tag": 0
  }
```

---

_Comment by @Gankra on 2025-04-30 20:38_

The code we generate these values from is here, for reference: 

https://github.com/astral-sh/uv/blob/0593b967ba848909c46b4c95f4ba8cbdcba147e9/crates/uv-cli/build.rs#L53-L90

---

_Comment by @Gankra on 2025-04-30 20:38_

I'm happy to loosen the tests if setting these values would be a huge pain for gentoo, or somehow "wrong" with the packaging philosophy though.

---

_Comment by @mgorny on 2025-05-01 02:26_

Yes, it would be a huge pain for us to have to manually edit commit hashes for every `uv` release. I suppose we could set tag-related variables, since presumably these would always match the package version and 0, respectively, is that correct?

---

_Comment by @Gankra on 2025-05-01 11:52_

I believe they'd always be `null`, `0` indicating "this is a tagged commit". This is also in some sense the most important info, because it signals "this is Really 0.7.2 and not some random commit after 0.7.2".

That said those values are discarded if UV_COMMIT_HASH isn't also set, so it's a moot point.

I'll go ahead and loosen the test.

---

_Comment by @mgorny on 2025-05-01 12:11_

Thank you!

---

_Referenced in [astral-sh/uv#13251](../../astral-sh/uv/pulls/13251.md) on 2025-05-01 12:12_

---

_Referenced in [astral-sh/uv#13566](../../astral-sh/uv/pulls/13566.md) on 2025-05-21 07:43_

---

_Closed by @Gankra on 2025-05-21 19:59_

---

_Referenced in [astral-sh/uv#13602](../../astral-sh/uv/issues/13602.md) on 2025-05-22 18:48_

---

_Referenced in [astral-sh/uv#14785](../../astral-sh/uv/issues/14785.md) on 2025-07-21 11:05_

---

_Referenced in [astral-sh/uv#14786](../../astral-sh/uv/pulls/14786.md) on 2025-07-21 12:27_

---
