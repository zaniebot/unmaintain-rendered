---
number: 6380
title: Using uv to install coverage with toml extra as a dev dep gives error when generating lock file
type: issue
state: closed
author: taranlu-houzz
labels:
  - bug
assignees: []
created_at: 2024-08-21T21:38:46Z
updated_at: 2024-08-21T22:34:14Z
url: https://github.com/astral-sh/uv/issues/6380
synced_at: 2026-01-07T12:31:14-06:00
---

# Using uv to install coverage with toml extra as a dev dep gives error when generating lock file

---

_Issue opened by @taranlu-houzz on 2024-08-21 21:38_

<!--
Thank you for taking the time to report an issue! We're glad to have you involved with uv.

If you're filing a bug report, please consider including the following information:

* A minimal code snippet that reproduces the bug.
* The command you invoked (e.g., `uv pip sync requirements.txt`), ideally including the `--verbose` flag.
* The current uv platform.
* The current uv version (`uv --version`).
-->

If you install `coverage[toml]` as a dev dep, `uv` will complain about with the following error when running `uv lock`:
```
â¯ uv lock
Failed to parse lockfile; ignoring locked requirements: for package `uv-coverage-with-toml-extra-bug==0.1.0 @ editable+.:dev`, found duplicate dependency `coverage==7.6.1 @ registry+https://pypi.org/simple`
Resolved 2 packages in 3ms
```


---

_Comment by @charliermarsh on 2024-08-21 21:43_

Can you help me with a reproduction? 

```
â¯ uv add "coverage" --dev --extra toml
Resolved 3 packages in 226ms
   Built foo @ file:///Users/crmarsh/workspace/puffin/foo
Prepared 3 packages in 330ms
Installed 3 packages in 1ms
 + coverage==7.6.1
 + foo==0.1.0 (from file:///Users/crmarsh/workspace/puffin/foo)
 + tomli==2.0.1
```

---

_Comment by @charliermarsh on 2024-08-21 21:44_

Could you share the `pyproject.toml`?

---

_Comment by @taranlu-houzz on 2024-08-21 21:45_

```toml
[project]
name = "uv-coverage-with-toml-extra-bug"
version = "0.1.0"
description = "Add your description here"
readme = "README.md"
requires-python = ">=3.12"
dependencies = []

[build-system]
requires = ["hatchling"]
build-backend = "hatchling.build"

[tool.uv]
dev-dependencies = [
    "coverage[toml]>=7.6.1",
]
```

---

_Comment by @taranlu-houzz on 2024-08-21 21:46_

Interestingly, it doesn't show up when I add the dep. It is only afterward when I run something that touches the lock file (e.g. `uv lock`).

```
â†“2 ~/Documents/uv_coverage_with_toml_extra_bug is ðŸ“¦ v0.1.0 via ðŸ v3.12.1
âŒ 2 â¯ uv remove coverage --dev
Failed to parse lockfile; ignoring locked requirements: for package `uv-coverage-with-toml-extra-bug==0.1.0 @ editable+.:dev`, found duplicate dependency `coverage==7.6
.1 @ registry+https://pypi.org/simple`
Resolved 1 package in 20ms
   Built uv-coverage-with-toml-extra-bug @ file:///Users/taran/Documents/uv_coverage_with_toml_extra_bug
Prepared 1 package in 356ms
Uninstalled 2 packages in 17ms
Installed 1 package in 1ms
 - coverage==7.6.1
 ~ uv-coverage-with-toml-extra-bug==0.1.0 (from file:///Users/taran/Documents/uv_coverage_with_toml_extra_bug)

â†“2 ~/Documents/uv_coverage_with_toml_extra_bug is ðŸ“¦ v0.1.0 via ðŸ v3.12.1
â¯ uv add coverage --extra toml --dev
Resolved 2 packages in 10ms
   Built uv-coverage-with-toml-extra-bug @ file:///Users/taran/Documents/uv_coverage_with_toml_extra_bug
Prepared 2 packages in 220ms
Uninstalled 1 package in 1ms
Installed 2 packages in 3ms
 + coverage==7.6.1
 ~ uv-coverage-with-toml-extra-bug==0.1.0 (from file:///Users/taran/Documents/uv_coverage_with_toml_extra_bug)
```

---

_Comment by @charliermarsh on 2024-08-21 21:53_

I was able to replicate! Not sure how yet though. Fixing.

---

_Assigned to @charliermarsh by @charliermarsh on 2024-08-21 21:53_

---

_Label `bug` added by @charliermarsh on 2024-08-21 21:53_

---

_Comment by @charliermarsh on 2024-08-21 21:55_

Ok, I think it's because the `toml` extra _does_ exist but doesn't actually activate any dependencies for Python >= 3.12. If you change `requires-python = ">=3.10"`, it works as expected.

---

_Comment by @taranlu-houzz on 2024-08-21 21:57_

Ah, I assume that is because the toml loading part of `tomli` got integrated into the Python stdlib? In that case, I suppose I don't need that extra.

---

_Comment by @charliermarsh on 2024-08-21 21:58_

Yeah that's right. We should still fix it though haha.

---

_Referenced in [astral-sh/uv#6383](../../astral-sh/uv/pulls/6383.md) on 2024-08-21 22:21_

---

_Comment by @charliermarsh on 2024-08-21 22:24_

Fixed in https://github.com/astral-sh/uv/pull/6383, and used `coverage[toml]` as a test case, that's a good one.

---

_Comment by @taranlu-houzz on 2024-08-21 22:33_

Awesome! Thanks for the speedy fix!

---

_Closed by @taranlu-houzz on 2024-08-21 22:33_

---

_Comment by @charliermarsh on 2024-08-21 22:34_

Thanks for filing, that's a good bug!

---
