---
number: 13870
title: Add local lock for parallel commands
type: issue
state: closed
author: leviska
labels:
  - enhancement
assignees: []
created_at: 2025-06-05T19:04:14Z
updated_at: 2025-06-05T19:20:22Z
url: https://github.com/astral-sh/uv/issues/13870
synced_at: 2026-01-07T12:31:16-06:00
---

# Add local lock for parallel commands

---

_Issue opened by @leviska on 2025-06-05 19:04_

### Summary

Running `uv sync` twice in the same repo can cause issues with installing, and also if cache is clear can download files twice. 
I suggest adding optional lock file, so if another instance of uv is already syncing this repo/downloading files, current instance will wait for that to finish (similar to how `cargo` does this)

The problem becomes larger in cluster environments (we use `ray`), where this can be done hundreds of times simultaneously

### Example

Create a pyproject, add a few dependencies and run `uv cache clean && rm -rf .venv && (uv sync | uv sync)`
I had this command even fail with 
```
failed to rename file from [...]/.venv/lib/python3.12/site-packages/.tmpkICzSS/package.json.orig to [...]/.venv/lib/python3.12/site-packages/jupyterlab_widgets-3.0.13.data/data/share/jupyter/labextensions/@jupyter-widgets/jupyterlab-manager/schemas/@jupyter-widgets/jupyterlab-manager/package.json.orig: No such file or directory (os error 2)
```
Also this command will download files twice

---

_Label `enhancement` added by @leviska on 2025-06-05 19:04_

---

_Comment by @konstin on 2025-06-05 19:16_

For the latter case, we're fixing this in https://github.com/astral-sh/uv/pull/13869.

For a cluster, I recommend a `uv sync` ahead of time and reusing the cache and/or venv instead of spawning `uv sync` for each task. We're unlikely to add a global lock, the current architecture allows running e.g. downloads and builds in separate projects to run in parallel without incurring high complexity for it (cargo is different to Python here in that it has small downloads, while all builds are isolated).

---

_Comment by @leviska on 2025-06-05 19:20_

We're reusing the venv by running all the tasks from the same directory with `uv run`, but it itself syncs...
It works fine when cache is filled (I think our parallelism is slower than uv syncing), but breaks on clear run 
Thanks for the link to the issue! Local lock should fix our issue too

---

_Closed by @leviska on 2025-06-05 19:20_

---

_Referenced in [astral-sh/uv#13883](../../astral-sh/uv/issues/13883.md) on 2025-06-18 18:36_

---
