---
number: 15159
title: "uv ignores custom URL in [tool.uv.sources] when marker is used"
type: issue
state: closed
author: peacefulotter
labels:
  - question
assignees: []
created_at: 2025-08-08T08:09:44Z
updated_at: 2025-08-08T10:51:41Z
url: https://github.com/astral-sh/uv/issues/15159
synced_at: 2026-01-07T12:31:16-06:00
---

# uv ignores custom URL in [tool.uv.sources] when marker is used

---

_Issue opened by @peacefulotter on 2025-08-08 08:09_

### Summary

Hi,

I’m using uv to manage dependencies defined in pyproject.toml. I have an optional dependency pointing to a private package, which is only accessible via a direct URL to a .tar.gz archive:

```toml
[project.optional-dependencies]
mygroup = [
  "private-package"
]

[tool.uv.sources]
private-package = { url = "https://private-domain.com/private-package.tar.gz" }
```

However, in my GitLab CI pipeline running on Linux, the package fails to resolve because it cannot access the private URL. To work around this, I tried scoping the package source to Windows only:

```toml
[tool.uv.sources]
private-package = { url = "https://private-domain.com/private-package.tar.gz", marker = "sys_platform == 'windows'" }
```

But with this change, even on Windows, uv fails with:
```
error: Failed to fetch: https://pypi.org/simple/private-package/
...
Caused by: Unknown Host
```

It seems like uv is ignoring the custom url when a marker is present, and instead falls back to trying to fetch the package from PyPI.


### Platform

Windows [version 10.0.19045.6093]

### Version

uv 0.8.6 (329a6b446 2025-08-07)

### Python version

3.10.0

---

_Label `bug` added by @peacefulotter on 2025-08-08 08:09_

---

_Comment by @charliermarsh on 2025-08-08 09:19_

This is expected. Commands like `uv sync` and `uv run` need to resolve for _all_ environments at once to create a `uv.lock` file. So even if the package isn't going to be installed, uv still needs to be able to access it to create and verify the lockfile. You can run with `--frozen` to install from an existing lockfile without attempting to resolve.

---

_Label `bug` removed by @charliermarsh on 2025-08-08 09:19_

---

_Label `question` added by @charliermarsh on 2025-08-08 09:19_

---

_Assigned to @charliermarsh by @charliermarsh on 2025-08-08 09:19_

---

_Comment by @peacefulotter on 2025-08-08 10:03_

So currently, my only workaround would be:

1. Comment out the private package dependency
2. Run uv sync
3. Uncomment the private package dependency
4. Run uv sync --frozen

This is far from ideal since we’d have to repeat this process every time a new dependency is added or modified.

From looking at related issues and based on my own experience with how uv sync behaves, I believe there should be a way to opt out of resolving specific dependencies during sync.

---

_Comment by @charliermarsh on 2025-08-08 10:47_

I'm not sure you need to do any of that. Are you re-creating your lockfile _during CI_ on the GitLab machine? Typically, you'd check in your lockfile, and you'd want it to be usable in all supported environments by all users, so it _has_ to include the Windows dependencies. Then you could just run `uv sync --frozen` in CI instead of `uv sync`, and uv would never attempt to fetch that wheel.

If you never want to include Windows in the lockfile, you could set https://docs.astral.sh/uv/reference/settings/#environments:

```toml
[tool.uv]
environments = ["sys_platform != 'win32'"]
```

But at that point, why include the dependency at all? The point is: if you want to use a lockfile, it needs to support all of your supported environments. But there's no reason that you should need to run `uv sync` without `--frozen` in GitLab in your setup, at least as far as I can tell.

(As a heads up, `sys_platform == 'windows'` is incorrect, it should be `win32`.)

---

_Comment by @peacefulotter on 2025-08-08 10:51_

Thank you for all your help!

Since I'm generating the lockfile locally, using --frozen in the CI pipeline should indeed solve my problem !

Also, thanks for pointing out my mistake with win32

---

_Closed by @peacefulotter on 2025-08-08 10:51_

---
