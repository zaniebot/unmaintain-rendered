---
number: 4142
title: "`uv lock` should not treat non-compliant `pyproject.toml` fields as dynamic"
type: issue
state: closed
author: zanieb
labels:
  - bug
  - preview
assignees: []
created_at: 2024-06-07T19:16:04Z
updated_at: 2024-06-10T14:26:39Z
url: https://github.com/astral-sh/uv/issues/4142
synced_at: 2026-01-07T12:31:14-06:00
---

# `uv lock` should not treat non-compliant `pyproject.toml` fields as dynamic

---

_Issue opened by @zanieb on 2024-06-07 19:16_

e.g. with an invalid dependency section

```toml
[project.dependencies]
python = "^3.12"
msgspec = "^0.18.4"
twine = "^4.0.2"
hatchling = "^1.20.0"
chevron-blue = "^0.2.1"
setuptools = "^69.1.1"
pypiserver = { version ="^2.0.1", optional = true}
watchfiles = { version = "^0.21.0",  optional = true}
pyyaml = "^6.0.1"
```

`uv lock` happily locked this project because I had retained the Poetry dependency section too

```toml
[tool.poetry.dependencies]
python = "^3.12"
msgspec = "^0.18.4"
twine = "^4.0.2"
hatchling = "^1.20.0"
chevron-blue = "^0.2.1"
setuptools = "^69.1.1"
pypiserver = { version ="^2.0.1", optional = true}
watchfiles = { version = "^0.21.0",  optional = true}
pyyaml = "^6.0.1"
```

With verbose logs, I can see that the invalid data means that we treat the entire `pyproject.toml` as dynamic and presumably use the build backend (Poetry) to get the dependencies?


> `DEBUG No static pyproject.toml available for: packse @ file:///Users/zb/workspace/packse (DynamicPyprojectToml(Toml(Error { inner: Error { inner: TomlError { message: "invalid type: map, expected a sequence", raw: Some("[project]\nname = \"packse\"\nversion = \"0.0.0\"\ndescription = \"\"\nauthors = [\"Zanie <contact@zanie.dev>\"]\nreadme = \"README.md\"\nkeywords = [\n  \"uv\", \"packse\", \"requirements\", \"packaging\", \"testing\"\n]\nclassifiers = [\n  \"Development Status :: 4 - Beta\",\n  \"Environment :: Console\",\n  \"Intended Audience :: Developers\",\n  \"Operating System :: OS Independent\",\n  \"License :: OSI Approved :: MIT License\",\n  \"License :: OSI Approved :: Apache Software License\",\n  \"Programming Language :: Python\",\n  \"Programming Language :: Python :: 3.12\",\n  \"Programming Language :: Python :: 3 :: Only\",\n  \"Topic :: Software Development :: Quality Assurance\",\n  \"Topic :: Software Development :: Testing\",\n  \"Topic :: Software Development :: Libraries\",\n]\n\n\n[project.scripts]\npackse = \"packse.cli:entrypoint\"\n\n[project.dependencies]\npython = \"^3.12\"\nmsgspec = \"^0.18.4\"\ntwine = \"^4.0.2\"\nhatchling = \"^1.20.0\"\nchevron-blue = \"^0.2.1\"\nsetuptools = \"^69.1.1\"\npypiserver = { version =\"^2.0.1\", optional = true}\nwatchfiles = { version = \"^0.21.0\",  optional = true}\npyyaml = \"^6.0.1\"\n\n[project.optional-dependencies]\nindex = [\"pypiserver\"]\nserve = [\"pypiserver\", \"watchfiles\"]\n\n[tool.uv]\ndev-dependencies = [\n  \"syrupy>=4.6.0\",\n  \"pytest>=7.4.3\",\n  \"psutil>=5.9.7\",\n]\n\n[tool.poetry]\nname = \"packse\"\nversion = \"0.0.0\"\ndescription = \"\"\nauthors = [\"Zanie <contact@zanie.dev>\"]\nreadme = \"README.md\"\nkeywords = [\n  \"uv\", \"packse\", \"requirements\", \"packaging\", \"testing\"\n]\nclassifiers = [\n  \"Development Status :: 4 - Beta\",\n  \"Environment :: Console\",\n  \"Intended Audience :: Developers\",\n  \"Operating System :: OS Independent\",\n  \"License :: OSI Approved :: MIT License\",\n  \"License :: OSI Approved :: Apache Software License\",\n  \"Programming Language :: Python\",\n  \"Programming Language :: Python :: 3.12\",\n  \"Programming Language :: Python :: 3 :: Only\",\n  \"Topic :: Software Development :: Quality Assurance\",\n  \"Topic :: Software Development :: Testing\",\n  \"Topic :: Software Development :: Libraries\",\n]\n\n\n[tool.poetry.scripts]\npackse = \"packse.cli:entrypoint\"\n\n[tool.poetry.dependencies]\npython = \"^3.12\"\nmsgspec = \"^0.18.4\"\ntwine = \"^4.0.2\"\nhatchling = \"^1.20.0\"\nchevron-blue = \"^0.2.1\"\nsetuptools = \"^69.1.1\"\npypiserver = { version =\"^2.0.1\", optional = true}\nwatchfiles = { version = \"^0.21.0\",  optional = true}\npyyaml = \"^6.0.1\"\n\n[tool.poetry.extras]\nindex = [\"pypiserver\"]\nserve = [\"pypiserver\", \"watchfiles\"]\n\n[tool.poetry.group.dev.dependencies]\nsyrupy = \"^4.6.0\"\npytest = \"^7.4.3\"\nruff = \"^0.1.12\"\npsutil = \"^5.9.7\"\n\n[build-system]\nrequires = [\"poetry-core\"]\nbuild-backend = \"poetry.core.masonry.api\"\n\n[tool.ruff.lint]\nextend-select = [\"I\", \"W292\"]\npreview = true\nexclude = [\"src/packse/templates/**/*\", \"build/**/*\", \"dist/**/*\"]\n"), keys: ["project", "dependencies"], span: Some(786..1054) } } })))`

---

_Label `preview` added by @zanieb on 2024-06-07 19:17_

---

_Renamed from "`uv lock` should not treat non-compliant fields as dynamic" to "`uv lock` should not treat non-compliant `pyproject.toml` fields as dynamic" by @zanieb on 2024-06-07 19:17_

---

_Comment by @zanieb on 2024-06-07 19:17_

Perhaps there's a feature here? Somehow? It would be cool to be able to use `uv lock` with my Poetry project definition.

---

_Comment by @zanieb on 2024-06-07 19:18_

However, if I remove the `[project.dependencies]` section `uv` only solves for 19 packages instead of 54. Basically no clue what's happening in there.

---

_Comment by @charliermarsh on 2024-06-07 19:45_

Can you say more about the last comment? What's the final pyproject.toml in that case?

---

_Label `bug` added by @charliermarsh on 2024-06-07 19:45_

---

_Comment by @zanieb on 2024-06-07 19:55_

https://github.com/astral-sh/packse/commit/56f3c5998e01642277eb6d7bf2cbbf2b2611a8df

```
[zb/uv-example-i 56f3c59] [project.dependencies] present but invalid
❯ uv lock
warning: `uv lock` is experimental and may change without warning.
Resolved 54 packages in 480ms
```

https://github.com/astral-sh/packse/commit/69b9417589d5feb20cf2595d80c481c5bd15421e

```
[zb/uv-example-ii 69b9417] [project.dependencies] not present
❯ uv lock
warning: `uv lock` is experimental and may change without warning.
Resolved 19 packages in 7ms
```

I think what's happening in the latter case is that `dependencies` is just presumed to be _empty_ so we don't treat it as invalid and don't fetch more from Poetry? Not sure.

---

_Comment by @charliermarsh on 2024-06-07 19:56_

Hmm yeah. If `project.dependencies` is omitted but `project` is present, it's equivalent to `project.dependencies = []`, per the spec.

---

_Comment by @zanieb on 2024-06-07 20:14_

That makes sense. Why do we treat the parse error as a dynamic project though?

---

_Comment by @charliermarsh on 2024-06-07 20:27_

Yeah that part looks like a bug.

---

_Assigned to @charliermarsh by @charliermarsh on 2024-06-09 17:42_

---

_Comment by @charliermarsh on 2024-06-09 17:50_

I got this one.

---

_Comment by @charliermarsh on 2024-06-09 18:49_

The options here are bad (sigh) because we have to support non-standard stuff like Hatch:

```toml
dependencies = [
  "black @ {root:uri}/../black_editable"
]
```

---

_Comment by @charliermarsh on 2024-06-09 19:01_

I don't really know what to do here. The above basically means that we have to treat invalid `[project]` tables as "maybe just dynamic metadata". Like, we could make it more granular, such that if we fail to parse the _version specifiers_, we perform this fallback. But that still comes with a similar risk -- if you had `"black @ {root:uri}/../black_editable"` in your dependencies, then we'd assume it's dynamic, and then Poetry would give us a totally different set of dependencies.

---

_Comment by @charliermarsh on 2024-06-09 19:08_

I suppose for now we do a few things to make the common cases better:

1. Make the error case more granular -- so, fail hard if we fail to parse the TOML schema (e.g., it's a map like above when it should be a list), and only use this soft fallback if we fail to parse a requirement. Maybe we make it even stricter, and only do it if they're using Hatch and using context formatting.
2. Warn if `project` is defined, but `project.dependencies` is not, and `tool.poetry.dependencies` _is_. In that case, they need to mark `project.dependencies` as dynamic.
3. Warn if `project` is defined, `project.dependencies` is defined, and `tool.poetry.dependencies` is _also_ defined. In that case, we'll ignore the Poetry dependencies, so we should tell the user -- it's probably a mistake.

---

_Comment by @charliermarsh on 2024-06-09 19:13_

Actually, the last thing isn't right, because in future versions of Poetry they're going to encourage you to use both together (https://website-bj97773t2-python-poetry.vercel.app/docs/dependency-specification/).

---

_Referenced in [astral-sh/uv#4176](../../astral-sh/uv/pulls/4176.md) on 2024-06-09 23:59_

---

_Referenced in [astral-sh/uv#4182](../../astral-sh/uv/pulls/4182.md) on 2024-06-10 00:31_

---

_Closed by @charliermarsh on 2024-06-10 14:26_

---
