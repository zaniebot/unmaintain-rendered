---
number: 12984
title: "Workspaces Break `uv sync --locked` During Docker Build"
type: issue
state: closed
author: Samk13
labels:
  - bug
assignees: []
created_at: 2025-04-20T03:19:59Z
updated_at: 2025-04-20T14:27:20Z
url: https://github.com/astral-sh/uv/issues/12984
synced_at: 2026-01-07T12:31:15-06:00
---

# Workspaces Break `uv sync --locked` During Docker Build

---

_Issue opened by @Samk13 on 2025-04-20 03:19_

### Summary

## Description

When a nested package is declared as a workspace member:
```toml
[tool.uv.sources]
foo = { workspace = true } 
[tool.uv.workspace] 
members = ["site"]
```

running `uv sync --locked` within [Dockerfile](https://github.com/Samk13/v12-sandbox/blob/uv-setup-workspaces/Dockerfile#L55)  fails with `error: The lockfile at uv.lock needs to be updated` 
Note that this error does not occur when running the same command from the CLI, only within the Dockerfile.

Now, if I remove the workspaces sections in pyproject.toml and set the package source to:
```toml
[tool.uv.sources]
foo = [{ path = "./site", editable = true }]
```
I will be able to [lock site/package](https://github.com/Samk13/v12-sandbox/blob/uv-setup/site/pyproject.toml) and manually generate another uv.lock within the nested site package with uv lock. It works around the issue but defeats the purpose of a unified workspace workflow with one uv.lock file.

Here is a reproduction of the issue. I think it's better to explain the issue than my poor explanation:
This repro is an [Invenio instance](https://inveniordm.docs.cern.ch)#2658 where we have an [editable package](https://github.com/Samk13/v12-sandbox/tree/uv-setup-workspaces/site) within the instance.

## Reproduction
Clone the reproduction that fails:
- [repro branch that doesn't](https://github.com/Samk13/v12-sandbox/blob/uv-setup-workspaces/pyproject.toml#L29-L33)
- [repro branch that works](https://github.com/Samk13/v12-sandbox/blob/uv-setup/pyproject.toml#L27)

To trigger the error, run the full container script: `./scripts/run_full_container.sh`. 
The error shows on [this step](https://github.com/Samk13/v12-sandbox/blob/uv-setup-workspaces/Dockerfile#L55)

`error: The lockfile at `uv.lock` needs to be updated, but `--locked` was provided. To update the lockfile, run `uv lock`.`

Note that I tested by removing the --lock flag and the build ran successfully, so I `diff` the uv.lock in the app and docker image after the build, also there was no second uv.lock file within the nested package, which led me to believe this might be an issue rather than a misconfiguration.

Similar issues I found:
https://github.com/astral-sh/uv/issues/8334

Please let me know if I’ve misconfigured anything or if there’s another recommended approach to this setup.
Thanks!


### Platform

mac m4 arm64

### Version

uv 0.6.14 (Homebrew 2025-04-09)

### Python version

Python 3.12.9

---

_Label `bug` added by @Samk13 on 2025-04-20 03:19_

---

_Comment by @Samk13 on 2025-04-20 14:27_

Fixed: copying the entire project (COPY . .) before running uv sync --locked ensures the on‑disk tree exactly matches what’s in uv.lock, so the locked sync now succeeds. Closing.

---

_Closed by @Samk13 on 2025-04-20 14:27_

---
