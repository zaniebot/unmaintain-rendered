---
number: 16779
title: "`uv add` hangs forever for complex pyproject"
type: issue
state: open
author: alex-shapiro
labels:
  - bug
  - performance
assignees: []
created_at: 2025-11-19T17:55:24Z
updated_at: 2025-11-20T14:18:21Z
url: https://github.com/astral-sh/uv/issues/16779
synced_at: 2026-01-07T12:31:16-06:00
---

# `uv add` hangs forever for complex pyproject

---

_Issue opened by @alex-shapiro on 2025-11-19 17:55_

### Summary

The `uv add` command is hanging forever for the following repo and commit: https://github.com/alex-shapiro/PufferLib/commit/21807b34145822e307314dd0e3b503139c6aaa97.

uv version: 0.9.10
OS version: macOS 15.6.1 (24G90)
command: `uv add`

Command log:

```
uv add --dev ruff -vvv
DEBUG uv 0.9.10 (Homebrew 2025-11-17)
TRACE Checking shared lock for `/Users/alex/.cache/uv` at `/Users/alex/.cache/uv/.lock`
DEBUG Acquired shared lock for `/Users/alex/.cache/uv`
DEBUG Found project root: `/Users/alex/Projects/PufferLib`
DEBUG No workspace root found, using project root
TRACE Checking lock for `/Users/alex/Projects/PufferLib` at `/var/folders/lz/jby64bjj69z_mwv96l9wz6c00000gn/T/uv-1247407c379164de.lock`
DEBUG Acquired lock for `/Users/alex/Projects/PufferLib`
DEBUG No Python version file found in workspace: /Users/alex/Projects/PufferLib
DEBUG Using Python request `==3.13.*` from `requires-python` metadata
DEBUG Checking for Python environment at: `.venv`
TRACE Found cached interpreter info for Python 3.13.0, skipping query of: .venv/bin/python3
DEBUG The project environment's Python version satisfies the request: `Python ==3.13.*`
TRACE The project environment's Python version meets the Python requirement: `==3.13.*`
TRACE The virtual environment's Python interpreter meets the Python preference: `prefer managed`
DEBUG Released lock at `/var/folders/lz/jby64bjj69z_mwv96l9wz6c00000gn/T/uv-1247407c379164de.lock`
TRACE Checking lock for `.venv` at `.venv/.lock`
DEBUG Acquired lock for `.venv`
```

### Platform

macOS 15.6.1 (24G90)

### Version

0.9.10 (Homebrew 2025-11-17)

### Python version

Python 3.13.0

---

_Label `bug` added by @alex-shapiro on 2025-11-19 17:55_

---

_Comment by @zanieb on 2025-11-19 18:39_

It hangs at that log line?

Does using `--no-sync` make it complete immediately?

---

_Comment by @alex-shapiro on 2025-11-19 20:46_

Yeah it hangs at exactly that log line. Adding `--no-sync` has no effect:

```
uv add --dev ruff --no-sync -vvv
DEBUG uv 0.9.10 (Homebrew 2025-11-17)
TRACE Checking shared lock for `/Users/alex/.cache/uv` at `/Users/alex/.cache/uv/.lock`
DEBUG Acquired shared lock for `/Users/alex/.cache/uv`
DEBUG Found project root: `/Users/alex/Projects/PufferLib`
DEBUG No workspace root found, using project root
DEBUG No Python version file found in workspace: /Users/alex/Projects/PufferLib
DEBUG Using Python request `==3.13.*` from `requires-python` metadata
DEBUG Checking for Python environment at: `.venv`
TRACE Found cached interpreter info for Python 3.13.0, skipping query of: .venv/bin/python3
DEBUG The project environment's Python version satisfies the request: `Python ==3.13.*`
TRACE The project environment's Python version meets the Python requirement: `==3.13.*`
TRACE The virtual environment's Python interpreter meets the Python preference: `prefer managed`
TRACE Checking lock for `.venv` at `.venv/.lock`
DEBUG Acquired lock for `.venv`
```

---

_Comment by @zanieb on 2025-11-19 21:19_

This appears to be reproducible with just `uv lock`

```
‚ùØ docker run -it astral/uv:bookworm bash -c "git clone https://github.com/alex-shapiro/PufferLib && cd PufferLib && git checkout 21807b34145822e307314dd0e3b503139c6aaa97 && uv lock -vv"
...
TRACE Querying interpreter executable at /root/.local/share/uv/python/cpython-3.13.9-linux-aarch64-gnu/bin/python3.13
DEBUG Released lock at `/root/.local/share/uv/python/.lock`
Using CPython 3.13.9
```

In which case the last log is emitted at https://github.com/astral-sh/uv/blob/9a6eafc0431da27d6aa4d1c5a91ed80c162774b9/crates/uv/src/commands/project/mod.rs#L1009-L1015

which is here in the lock logic https://github.com/astral-sh/uv/blob/2d9fe7ca701f72b35202bd48d5758dd5b5ef12fe/crates/uv/src/commands/project/lock.rs#L143

If using `--frozen`, it hangs at

```
DEBUG uv 0.9.10
TRACE Checking shared lock for `/root/.cache/uv` at `/root/.cache/uv/.lock`
DEBUG Acquired shared lock for `/root/.cache/uv`
DEBUG Found workspace root: `/PufferLib`
TRACE Discovering workspace members for: `/PufferLib`
DEBUG Adding root workspace member: `/PufferLib`
```

which is just above interpreter retrieval https://github.com/astral-sh/uv/blob/2d9fe7ca701f72b35202bd48d5758dd5b5ef12fe/crates/uv/src/commands/project/lock.rs#L131-L134

but the downstream logic for `Frozen` is quite simple?

https://github.com/astral-sh/uv/blob/2d9fe7ca701f72b35202bd48d5758dd5b5ef12fe/crates/uv/src/commands/project/lock.rs#L331-L351

---

_Comment by @zanieb on 2025-11-19 21:20_

Oh, uhh this is suspicious? You have a _massive_ conflict list

```
conflicts = [
    [
        { extra = "avalon" },
        { extra = "atari" },
        { extra = "box2d" },
        { extra = "bsuite" },
        { extra = "butterfly" },
        { extra = "classic_control" },
        { extra = "crafter" },
        { extra = "craftax" },
        { extra = "dm_control" },
        { extra = "dm_lab" },
        { extra = "griddly" },
        { extra = "kinetix" },
        { extra = "magent" },
        { extra = "microrts" },
        { extra = "minerl" },
        { extra = "minigrid" },
        { extra = "minihack" },
        { extra = "mujoco" },
        { extra = "nethack" },
        { extra = "nmmo" },
        { extra = "open_spiel" },
        { extra = "pokemon_red" },
        { extra = "procen" },
        { extra = "slimevolley" },
        { extra = "vizdoom" },
        { extra = "tribal-village" },
    ],
    [
    { extra = "mujoco" },
        { extra = "mujoco" },
        { extra = "cleanrl" }

    ]
```

https://github.com/alex-shapiro/PufferLib/blob/21807b34145822e307314dd0e3b503139c6aaa97/pyproject.toml#L264-L300

That creates a combinatorial explosion.

---

_Comment by @zanieb on 2025-11-19 21:21_

I'm still a bit confused about where we're stuck though.

---

_Comment by @zanieb on 2025-11-19 21:30_

If I delete the lockfile and resolve from scratch, we hang _after_ resolution, e.g.:

```
root@33dda518e74d:/PufferLib# uv lock --dry-run    
Using CPython 3.13.9
Resolved 282 packages in 1.35s
```

Very peculiar.

---

_Comment by @zanieb on 2025-11-19 22:55_

Adding logs to trace where we're at

We're stuck here
https://github.com/astral-sh/uv/blob/ae1edef9c0a4906cd22838b30fd719723c6cb67e/crates/uv-resolver/src/lock/mod.rs#L265-L276

https://github.com/astral-sh/uv/blob/ae1edef9c0a4906cd22838b30fd719723c6cb67e/crates/uv-resolver/src/lock/mod.rs#L2453-L2462

This `Dependency::from_annotated_dist` does not return.

I believe it's this call in `Dependency::new` that's stuck

https://github.com/astral-sh/uv/blob/ae1edef9c0a4906cd22838b30fd719723c6cb67e/crates/uv-resolver/src/lock/mod.rs#L4852

It looks like we're calling the following function a lot of times

https://github.com/astral-sh/uv/blob/2fc5fe2ac099fa0d598c88e559ea1d034cf5a7ff/crates/uv-pep508/src/marker/algebra.rs#L561 

It looks like we're just doing a ton of work, so I'd expect it to finish someday but something is clearly wrong here. Even if I edit some of these functions to be no-ops, the operation takes a very long time.

---

_Label `performance` added by @zanieb on 2025-11-19 23:09_

---

_Comment by @zanieb on 2025-11-19 23:10_

I'd highly recommend trimming down the number of conflicts, are all of those packages actually mutually conflicting?

---

_Comment by @alex-shapiro on 2025-11-20 02:54_

Yeah a lot of the extras have mutually incompatible dependency trees. Each extra is a reinforcement learning environment with a pinned, uniquely-outdated dependency on `gym`, `gymnasium`, `pettingzoo`, etc. The user only loads one environment at runtime (to train/eval a model on a specific environment), so the mutual exclusion block seemed like the best way to avoid dependency conflicts between multiple versions of those core package dependencies.

Do we know that the exclusion block is causing the hang? Dependency resolution when creating `uv.lock` takes 2.51 seconds, which seems reasonable.

---

_Comment by @zanieb on 2025-11-20 14:18_

I think it's a problem with processing all the markers that are generated to represent the conflicts.

---
