---
number: 14966
title: "With module in subdirectory, Git branch not picked up when using `uv add`, but works with `uv pip install ...`"
type: issue
state: closed
author: phinate
labels:
  - question
assignees: []
created_at: 2025-07-30T08:48:49Z
updated_at: 2025-08-12T10:57:58Z
url: https://github.com/astral-sh/uv/issues/14966
synced_at: 2026-01-07T12:31:16-06:00
---

# With module in subdirectory, Git branch not picked up when using `uv add`, but works with `uv pip install ...`

---

_Issue opened by @phinate on 2025-07-30 08:48_

### Summary

I want to add a dependency from git -- specifically from a subdir of a monorepo -- on a specific branch, and to a dependency group called `training`. If I try the same `git+...` syntax for `uv pip` and `uv add`, they seem to refer to different commits.

Here's an example with a repo I have:

```
$ uv pip install "anemoi-training @ git+https://github.com/phinate/anemoi-core.git@mlflow-azure#subdirectory=training"         
Resolved 169 packages in 437ms
Uninstalled 1 package in 137ms
Installed 1 package in 17ms
 - anemoi-training==0.0.post846 (from git+https://github.com/phinate/anemoi-core.git@9f75c06c1ff8a720f05341ad055ff345306df7a6#subdirectory=training)
 + anemoi-training==0.0.post847 (from git+https://github.com/phinate/anemoi-core.git@a27b05098df5888a4e831aa724bca65fab741305#subdirectory=training)
```

and

```
$ uv add --group training "anemoi-training @ git+https://github.com/phinate/anemoi-core.git@mlflow-azure#subdirectory=training"
Resolved 246 packages in 26ms
Uninstalled 1 package in 109ms
Installed 1 package in 14ms
 - anemoi-training==0.0.post847 (from git+https://github.com/phinate/anemoi-core.git@a27b05098df5888a4e831aa724bca65fab741305#subdirectory=training)
 + anemoi-training==0.0.post846 (from git+https://github.com/phinate/anemoi-core.git@9f75c06c1ff8a720f05341ad055ff345306df7a6#subdirectory=training)
```

The results are inconsistent -- only `uv pip` installs the correct version.

### Platform

macOS 14.7.6 (23H626) (M1) Darwin 23.6.0 arm64

### Version

uv 0.8.3

### Python version

Python 3.12.6

---

_Label `bug` added by @phinate on 2025-07-30 08:48_

---

_Comment by @phinate on 2025-07-30 09:42_

As additional context, I am able to pin this for now via the specific commit to `rev`, e.g.
```toml
[tool.uv.sources]
anemoi-training = { git = "https://github.com/phinate/anemoi-core.git", subdirectory = "training", rev = "a27b05098df5888a4e831aa724bca65fab741305" }
```

in the `pyproject.toml`. Ideally of course, it would be great to just get the branch directly.

---

_Comment by @zanieb on 2025-07-30 16:14_

Is the previous revision of `anemoi-training` in your lockfile already during the `uv add` invocation?

---

_Comment by @phinate on 2025-07-30 16:18_

That's right -- I've ran those commands back-to-back a few times, so it's not a clean starting point in that sense. I originally did `uv add ...` with the subdir/branch syntax, and only noticed when the functionality didn't mirror my most recent commit. That's the origin of the `post846` version.

---

_Comment by @zanieb on 2025-07-30 16:21_

I think this behavior is sort of expected. `uv add` doesn't imply `--upgrade-package`, so we won't change a locked version of a package. The `uv pip` interface, of course, ignores the lock file.

---

_Comment by @phinate on 2025-07-30 16:25_

Right, I think I see where you're coming from. I think the missing piece for me is likening a commit to a version number; my default assumption when installing from a repository or branch is that the latest commit would always be pulled, but perhaps I'm thinking in pip and not in lockfile? How does `uv add` determine which version to pull from a remote dependency like this?

---

_Comment by @zanieb on 2025-07-30 16:34_

Maybe this is helpful?

Make a test repository...

```
❯ cd /tmp
❯ uv init example-repo --package
Initialized project `example-repo` at `/private/tmp/example-repo`
❯ cd example-repo
❯ gh repo create
❯ git add .
❯ git commit -am 'Initial commit'
[main (root-commit) 8681b49] Initial commit
❯ git push --set-upstream origin main
```

Make a test project, and add the test repository as a dependency...
```
❯ cd /tmp
❯ uv init example
Initialized project `example` at `/private/tmp/example`
❯ cd example
❯ uv add git+https://github.com/zanieb/example-repo.git
Resolved 2 packages in 64ms
    Updated https://github.com/zanieb/example-repo.git (8681b49be02c3e67d894b8a8a5ec59605170f39e)
      Built example-repo @ git+https://github.com/zanieb/example-repo.git@8681b49be02c3e67d894b8a8a5ec59605170f39e
Prepared 1 package in 425ms
Installed 1 package in 1ms
 + example-repo==0.1.0 (from git+https://github.com/zanieb/example-repo.git@8681b49be02c3e67d894b8a8a5ec59605170f39e)
```

Add a new commit to the test repository...
```
❯ cd /tmp/example-repo
❯ git commit -am 'Another commit' --allow-empty
[main b67c94e] Another commit
❯ git push
Enumerating objects: 1, done.
Counting objects: 100% (1/1), done.
Writing objects: 100% (1/1), 185 bytes | 185.00 KiB/s, done.
Total 1 (delta 0), reused 0 (delta 0), pack-reused 0 (from 0)
To https://github.com/zanieb/example-repo.git
   8681b49..b67c94e  main -> main
```

A new project will use the latest commit, there's no lockfile:

```
❯ cd /tmp
❯ uv init example-two
Initialized project `example-two` at `/private/tmp/example-two`
❯ cd example-two
❯ uv add git+https://github.com/zanieb/example-repo.git
Using CPython 3.12.9
Creating virtual environment at: .venv
Resolved 2 packages in 83ms
    Updated https://github.com/zanieb/example-repo.git (b67c94e96be507a7f92c81543a3658c2492e6912)
      Built example-repo @ git+https://github.com/zanieb/example-repo.git@b67c94e96be507a7f92c81543a3658c2492e6912
Prepared 1 package in 502ms
Installed 1 package in 1ms
 + example-repo==0.1.0 (from git+https://github.com/zanieb/example-repo.git@b67c94e96be507a7f92c81543a3658c2492e6912)
```

The existing project will do nothing on `add`, because a commit is already locked:
```
❯ cd /tmp/example
❯ uv add git+https://github.com/zanieb/example-repo.git
Resolved 2 packages in 2ms
Audited 1 package in 0.05ms
```

Unless `--upgrade-package` is used, to invalidate the lockfile entry:

```
❯ uv add git+https://github.com/zanieb/example-repo.git --upgrade-package example-repo
Resolved 2 packages in 67ms
Prepared 1 package in 48ms
Uninstalled 1 package in 0.96ms
Installed 1 package in 3ms
 - example-repo==0.1.0 (from git+https://github.com/zanieb/example-repo.git@8681b49be02c3e67d894b8a8a5ec59605170f39e)
 + example-repo==0.1.0 (from git+https://github.com/zanieb/example-repo.git@b67c94e96be507a7f92c81543a3658c2492e6912)
```

---

_Comment by @zanieb on 2025-07-30 16:37_

And yeah, in short, commits are like version numbers here. This behavior should be the same for a package from a registry when a new version is released.

---

_Label `bug` removed by @zanieb on 2025-07-30 16:39_

---

_Label `question` added by @zanieb on 2025-07-30 16:39_

---

_Comment by @phinate on 2025-08-12 10:57_

Sorry for the delayed reply -- just wanted to say thank you for this crystal clear example. Knowing the same behaviour tracks across repos and versioned releases for commits/versions interchangeably is a nice mental model. Much appreciated :) 

---

_Closed by @phinate on 2025-08-12 10:57_

---
