---
number: 4668
title: Python version limited requirement in universal locking
type: issue
state: closed
author: davidfritzsche
labels:
  - bug
  - resolver
assignees: []
created_at: 2024-06-30T21:12:22Z
updated_at: 2024-10-28T17:42:40Z
url: https://github.com/astral-sh/uv/issues/4668
synced_at: 2026-01-07T13:12:17-06:00
---

# Python version limited requirement in universal locking

---

_Issue opened by @davidfritzsche on 2024-06-30 21:12_

With uv 0.2.18 the following fails

```shell
$ echo 'uv;python_version>="3.8"' | uv pip compile -p 3.7 --universal -
warning: uv is only compatible with Python 3.8+, found Python 3.7.17.
  × No solution found when resolving dependencies:
```

Which on one hand makes sense, as there really is no version of uv supporting Python 3.7. On the other hand, `uv==X; python_version>="3.8"` could be installed under Python 3.7 for any version X.

In non-universal locking, `uv;python_version>="3.8"` can be compiled for Python 3.7:

```shell
$ echo 'uv;python_version>="3.8"' | uv pip compile -p 3.7 -
warning: uv is only compatible with Python 3.8+, found Python 3.7.17.
Resolved 0 packages in 0.77ms
# This file was autogenerated by uv via the following command:
#    uv pip compile -p 3.7 -
```


---

_Comment by @charliermarsh on 2024-06-30 21:36_

Oh thank you, I think this is the same as #4669 -- sorry, I missed that you created this.

---

_Comment by @charliermarsh on 2024-06-30 21:36_

I'm going to merge into #4669. Good bug!

---

_Closed by @charliermarsh on 2024-06-30 21:36_

---

_Label `bug` added by @charliermarsh on 2024-06-30 21:36_

---

_Label `resolver` added by @charliermarsh on 2024-06-30 21:36_

---

_Label `preview` added by @charliermarsh on 2024-06-30 21:36_

---

_Referenced in [astral-sh/uv#4669](../../astral-sh/uv/issues/4669.md) on 2024-06-30 21:36_

---

_Reopened by @charliermarsh on 2024-07-01 20:00_

---

_Comment by @charliermarsh on 2024-07-01 20:00_

Re-opening because this case is a little different than the NumPy one and they'll have separate PRs.

---

_Assigned to @charliermarsh by @charliermarsh on 2024-07-01 20:00_

---

_Referenced in [astral-sh/uv#4712](../../astral-sh/uv/pulls/4712.md) on 2024-07-01 21:27_

---

_Referenced in [astral-sh/uv#5134](../../astral-sh/uv/issues/5134.md) on 2024-07-17 01:19_

---

_Referenced in [astral-sh/uv#5583](../../astral-sh/uv/pulls/5583.md) on 2024-07-30 01:30_

---

_Referenced in [astral-sh/uv#5647](../../astral-sh/uv/issues/5647.md) on 2024-07-31 11:46_

---

_Referenced in [astral-sh/uv#5733](../../astral-sh/uv/pulls/5733.md) on 2024-08-02 18:30_

---

_Comment by @houbie on 2024-08-05 11:48_

I'm facing a related issue: using python 3.9, `uv pip install pdm` correctly installs pdm version 2.17.3, but `echo 'pdm==2.17.3'| uv pip compile --universal -` fails:
```
(px-uvdir) % echo 'pdm==2.17.3'| uv pip compile --universal -
  × No solution found when resolving dependencies:
  ╰─▶ Because only the following versions of truststore{python_version >= '3.10'} are available:
          truststore{python_version >= '3.10'}==0.1.0
          truststore{python_version >= '3.10'}==0.2.0
          truststore{python_version >= '3.10'}==0.3.0
          truststore{python_version >= '3.10'}==0.4.0
          truststore{python_version >= '3.10'}==0.5.0
          truststore{python_version >= '3.10'}==0.6.0
          truststore{python_version >= '3.10'}==0.6.1
          truststore{python_version >= '3.10'}==0.7.0
          truststore{python_version >= '3.10'}==0.8.0
          truststore{python_version >= '3.10'}==0.9.0
          truststore{python_version >= '3.10'}==0.9.1
      and the requested Python version (>=3.9.17) does not satisfy Python>=3.10, we can conclude that any of:
          truststore{python_version >= '3.10'}<0.9.0
          truststore{python_version >= '3.10'}>0.9.0
       are incompatible.
      And because truststore{python_version >= '3.10'}==0.9.0 was yanked (reason: Doesn't work for CPython 3.13, upgrade to 0.9.1), we can conclude that all versions of truststore{python_version >= '3.10'} are incompatible.
      And because pdm==2.17.3 depends on truststore{python_version >= '3.10'} and you require pdm==2.17.3, we can conclude that the requirements are unsatisfiable.
```

pdm has a dependency on truststore `Requires-Dist: truststore; python_version >= "3.10"`
`uv pip compile` should retain this dependency with the python constraint instead of failing on it

---

_Referenced in [pyprojectx/pyprojectx#112](../../pyprojectx/pyprojectx/issues/112.md) on 2024-08-05 12:06_

---

_Comment by @charliermarsh on 2024-08-05 13:00_

@houbie -- Think that's the same as https://github.com/astral-sh/uv/issues/4668.

---

_Referenced in [astral-sh/uv#5887](../../astral-sh/uv/pulls/5887.md) on 2024-08-07 18:51_

---

_Referenced in [astral-sh/uv#6143](../../astral-sh/uv/pulls/6143.md) on 2024-08-16 12:14_

---

_Comment by @charliermarsh on 2024-08-20 14:15_

On main there's now a workaround for this:

```toml
[project]
name = "foo"
version = "0.1.0"
description = "Add your description here"
readme = "README.md"
requires-python = ">=3.7"
dependencies = ["uv ; python_version >= '3.8'"]

[build-system]
requires = ["hatchling"]
build-backend = "hatchling.build"

[tool.uv]
environments = ["python_version < '3.8'", "python_version >= '3.8'"]
```

---

_Label `preview` removed by @zanieb on 2024-08-20 18:22_

---

_Referenced in [astral-sh/uv#6730](../../astral-sh/uv/issues/6730.md) on 2024-08-27 23:20_

---

_Comment by @DanCardin on 2024-08-28 16:39_

I'm encountering something similar, where the environments workaround doesn't appear to work. It works with **only** the `"numpy >= 2.0; python_version >= '3.9'"` dependency, but not with certain other dependencies in combination.

```toml
[project]
name = "foo"
version = "0.0.0"
description = ""
requires-python = ">=3.8,<4"
dependencies = [
  "pydantic",
  "numpy >= 2.0; python_version >= '3.9'",
]

[tool.uv]
environments = ["python_version < '3.9'", "python_version >= '3.9'"]
```
This ^ will attempt to install numpy (which then fails for me), which i think it shouldnt even be attempting. 

I'm not sure what significance `pydantic` has here, it only depends on `pydantic-core`, `typing-extensions` and `annotated-types`. And explicitly stating those dependencies (locked to the locked versions) individually instead doesn't fail.

---

_Comment by @charliermarsh on 2024-08-28 16:45_

Can you clarify what the issue is? It's attempting to install NumPy on which Python versions? (I can `uv lock` that successfully.)

---

_Comment by @DanCardin on 2024-08-28 16:59_

oh right sorry! `uv sync -p 3.8` fails trying to install numpy (when it shouldn't be), `uv sync -p 3.9` succeeds and does.

admittedly the failing part is because it's trying to build the wheel and i dont have the requirements necessary, but the point is that it's installing numpy when it shouldn't anyway.

---

_Comment by @mkniewallner on 2024-08-31 19:04_

> On main there's now a workaround for this:
> 
> ```toml
> [project]
> name = "foo"
> version = "0.1.0"
> description = "Add your description here"
> readme = "README.md"
> requires-python = ">=3.7"
> dependencies = ["uv ; python_version >= '3.8'"]
> 
> [build-system]
> requires = ["hatchling"]
> build-backend = "hatchling.build"
> 
> [tool.uv]
> environments = ["python_version < '3.8'", "python_version >= '3.8'"]
> ```

It looks like the workaround suggested here does not work anymore on 0.4.1, with the changes made in https://github.com/astral-sh/uv/pull/6841:
```console
$ uv lock
error: Environment markers `python_full_version >= '3.8'` don't overlap with Python requirement `>=3.7`
```

 Since the workaround was suggested a few weeks ago, is there maybe a better way to work around the issue now?

---

_Comment by @charliermarsh on 2024-08-31 22:37_

If that's not working, it looks like a bug. Let me take a look.

---

_Comment by @charliermarsh on 2024-08-31 22:42_

Apologies @mkniewallner, really dumb bug: https://github.com/astral-sh/uv/pull/6902

---

_Referenced in [astral-sh/uv#7821](../../astral-sh/uv/issues/7821.md) on 2024-09-30 22:30_

---

_Comment by @DanCardin on 2024-10-09 13:53_

Fwiw, if anyone else runs into https://github.com/astral-sh/uv/issues/4668#issuecomment-2315850477 (because it was blocking by ability to adopt uv), a newer release of uv (0.4.20), given the referenced pyproject.toml, produces

```
  × No solution found when resolving dependencies for split (python_full_version >= '3.9'):
  ╰─▶ Because the requested Python version (>=3.8, <4) does not satisfy Python>=3.10 and the requested Python version (>=3.8, <4) does not satisfy
      Python>=3.9,<3.10, we can conclude that Python>=3.9 is incompatible.
      And because only the following versions of numpy{python_full_version >= '3.9'} are available:
          numpy{python_full_version >= '3.9'}<=2.0.2
          numpy{python_full_version >= '3.9'}>=2.1.0
      we can conclude that all of:
          numpy{python_full_version >= '3.9'}>=2.0.0,<2.1.0
          numpy{python_full_version >= '3.9'}>2.1.0,<2.1.1
          numpy{python_full_version >= '3.9'}>2.1.1,<2.1.2
          numpy{python_full_version >= '3.9'}>2.1.2
       are incompatible.
      And because the requested Python version (>=3.8, <4) does not satisfy Python>=3.10 and your project depends on numpy{python_full_version >=
      '3.9'}>=2.0, we can conclude that your project's requirements are unsatisfiable.
```

I took that to imply that I need to match the upper bound with the upper bound of my project: `environments = ["python_version < '3.9'", "python_version >= '3.9' and python_version < '4'"]`, and **that** solved the issue, at least in the newer version of uv.

---

_Referenced in [astral-sh/uv#8601](../../astral-sh/uv/issues/8601.md) on 2024-10-27 18:53_

---

_Referenced in [astral-sh/uv#8628](../../astral-sh/uv/pulls/8628.md) on 2024-10-28 01:38_

---

_Closed by @charliermarsh on 2024-10-28 13:48_

---

_Closed by @charliermarsh on 2024-10-28 13:48_

---

_Comment by @charliermarsh on 2024-10-28 13:48_

This should "just work" without any workarounds in the next version (see: https://github.com/astral-sh/uv/pull/8628).

---

_Comment by @potiuk on 2024-10-28 17:42_

> This should "just work" without any workarounds in the next version (see: #8628).

Cool . We are getting way closer now with `uv` being the default tool for Airflow development.

---

_Referenced in [apache/airflow#43451](../../apache/airflow/pulls/43451.md) on 2024-10-28 22:38_

---
