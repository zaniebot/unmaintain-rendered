---
number: 11279
title: "How to run `uv pip compile` for PyPy (and CPython)"
type: issue
state: closed
author: alexprengere
labels:
  - bug
assignees: []
created_at: 2025-02-06T12:57:25Z
updated_at: 2025-02-07T08:57:32Z
url: https://github.com/astral-sh/uv/issues/11279
synced_at: 2026-01-07T13:12:18-06:00
---

# How to run `uv pip compile` for PyPy (and CPython)

---

_Issue opened by @alexprengere on 2025-02-06 12:57_

### Summary

I looked through the docs with no luck, hopefully I did not miss anything.
My issue boils down to a simple `requirements.in` with:

```
psycopg[binary]; platform_python_implementation!='PyPy'
psycopg; platform_python_implementation=='PyPy'
```
Following [psycopg docs](https://www.psycopg.org/psycopg3/docs/basic/install.html), the `[binary]` dependency group install an extra `psycopg-binary` library.
Installing directly `psycopg[binary]` on PyPy also works, the `[binary]` is just ignored.

I have a project that I run with both PyPy and CPython. In both cases, they manage to install with no issues:

```bash
$ uv venv -p python3.10
$ uv pip install -r requirements.in
...
 + psycopg==3.2.4
 + psycopg-binary==3.2.4
 + typing-extensions==4.12.2

$ uv venv -p pypy3.10
$ uv pip install -r requirements.in
...
 + psycopg==3.2.4
 + typing-extensions==4.12.2
 # No psycopg-binary here, as expected
```
Now I would like to either:
* generate a single `requirements.txt` for both CPython and PyPy using `uv pip compile`.
* generate one `requirements.txt` for each interpreter

AFAICT there is no option to tell "compile for PyPy", but you *can* achieve it by creating a virtualenv and let `uv pip compile` use it:

```bash
$ uv venv -p python3.10
$ uv pip compile requirements.in -o requirements.txt --upgrade -p 3.10 --quiet
$ cat requirements.txt
...
psycopg==3.2.4
    # via -r requirements.in
psycopg-binary==3.2.4
    # via psycopg
typing-extensions==4.12.2
    # via psycopg

$ uv venv -p pypy3.10
$ uv pip compile requirements.in -o requirements.txt --upgrade -p 3.10 --quiet
$ cat requirements.txt
...
psycopg==3.2.4
    # via -r requirements.in
typing-extensions==4.12.2
    # via psycopg
```
I wonder if another flag to `uv pip compile` would make sense to specify the interpreter "PyPy" or "CPython" here, so as to avoid the extra step to create the virtualenv.
To be honest, my perfect solution would be to have a single `requirements.txt` for both interpreters that would look like:

```
psycopg==3.2.4
psycopg-binary==3.2.4; platform_python_implementation != "PyPy"
typing-extensions==4.12.2
```
But I am not sure this would work with `uv pip compile` design, which does seem to solve for only one interpreter.
For the record `pip-tools` output is not better here:

```
$ pip-compile requirements.in 
psycopg[binary]==3.2.4 ; platform_python_implementation != "PyPy"
    # via -r requirements.in
psycopg-binary==3.2.4
    # via psycopg
typing-extensions==4.12.2
    # via psycopg
```

### Platform

Fedora Linux on WSL2

### Version

0.5.29

### Python version

_No response_

---

_Label `bug` added by @alexprengere on 2025-02-06 12:57_

---

_Comment by @charliermarsh on 2025-02-06 13:59_

Did you try `uv pip compile --universal`?

---

_Label `bug` removed by @charliermarsh on 2025-02-06 14:01_

---

_Label `question` added by @charliermarsh on 2025-02-06 14:01_

---

_Comment by @zanieb on 2025-02-06 14:18_

You can also solve for just PyPy using `uv pip compile -p pypy@3.10`

---

_Comment by @alexprengere on 2025-02-06 14:53_

Hi! Let me reply to both at the same time.

1. Yes, I tried `--universal`, but did not want to mention it as my post was getting long. It did not do what I thought it would, so I thought I misunderstood it:

```
$ uv pip compile requirements.in -o requirements.txt --upgrade -p 3.10 --quiet --universal
$ cat requirements.txt
# This file was autogenerated by uv via the following command:
#    uv pip compile requirements.in -o requirements.txt -p 3.10 --universal
psycopg==3.2.4 ; platform_python_implementation != 'PyPy'
    # via -r requirements.in
psycopg-binary==3.2.4 ; implementation_name != 'pypy' and platform_python_implementation != 'PyPy'
    # via psycopg
typing-extensions==4.12.2 ; python_full_version < '3.13'
    # via psycopg
tzdata==2025.1 ; sys_platform == 'win32'
    # via psycopg
```
As you can see installing this with PyPy3 will *not even install psycopg* at all.

2. I tried all the combinations of this I could think of with no luck:

```
$ uv pip compile -p pypy@3.10
error: invalid value 'pypy@3.10' for '--python-version <PYTHON_VERSION>': Python version `pypy@3.10` could not be parsed: expected version to start with a number, but no leading ASCII digits were found
$ uv pip compile -p pypy3.10
error: invalid value 'pypy3.10' for '--python-version <PYTHON_VERSION>': Python version `pypy3.10` could not be parsed: expected version to start with a number, but no leading ASCII digits were found
$ uv pip compile -p python3.10
# same
```
After digging a bit more, it turns out putting just `psycopg[binary]` in the `requirements.in` file, combined with `--universal`, gives the best results:

```
$ cat requirements.in
psycopg[binary]
$ uv pip compile requirements.in -o requirements.txt --upgrade -p 3.10 --quiet --universal
$ cat requirements.txt
psycopg==3.2.4
    # via -r requirements.in
psycopg-binary==3.2.4 ; implementation_name != 'pypy'
    # via psycopg
typing-extensions==4.12.2 ; python_full_version < '3.13'
    # via psycopg
tzdata==2025.1 ; sys_platform == 'win32'
    # via psycopg
```

---

_Comment by @charliermarsh on 2025-02-06 15:49_

I think `--universal` with:

```
psycopg[binary]; platform_python_implementation!='PyPy'
psycopg; platform_python_implementation=='PyPy'
```

Should give you what you want. That might be a bug then? I'll take a look, but `--universal` with `psycopg[binary]` seems simpler anyway :)

---

_Assigned to @charliermarsh by @charliermarsh on 2025-02-06 15:49_

---

_Comment by @zanieb on 2025-02-06 15:57_

Oh, we interpret `-p` as `--python-version` in `uv pip compile`?? Sorry, that's really weird. You want `--python` (which is what `-p` aliases to everywhere else)

---

_Comment by @alexprengere on 2025-02-06 16:08_

Oooh so this explains a lot ðŸ˜‰ 
1 mystery solved, because indeed this works as expected:
```
$ uv pip compile requirements.in -o requirements.txt --upgrade --python pypy@3.10 --quiet
psycopg==3.2.4
    # via -r requirements.in
typing-extensions==4.12.2
    # via psycopg
```
So I can always create easily 2 `requirements.txt`.
The only remaining mystery is why `--universal` is not working with:

```
psycopg[binary]; platform_python_implementation!='PyPy'
psycopg; platform_python_implementation=='PyPy'
```
Putting "just" `psycopg[binary]` is less correct I believe, as the docs *explicitly* mention to remove `[binary]` for PyPy, it just "happens to work anyway".


---

_Comment by @charliermarsh on 2025-02-06 17:00_

> Putting "just" psycopg[binary] is less correct I believe, as the docs explicitly mention to remove [binary] for PyPy, it just "happens to work anyway".

No, it's correct. The metadata for `psycopg2` includes:

```
Requires-Dist: psycopg-binary==3.2.4; implementation_name != "pypy" and extra == "binary"
```

So it's fine to just put `psycopg[binary]`. They already exclude the binary for PyPy.


---

_Comment by @zanieb on 2025-02-06 17:01_

Tracking the `-p` thing in #11285 

---

_Label `question` removed by @konstin on 2025-02-06 19:43_

---

_Label `bug` added by @konstin on 2025-02-06 19:43_

---

_Comment by @konstin on 2025-02-06 21:41_

The `--universal` bug is fixed in #11298, do we want to keep this issue open for anything else?

---

_Closed by @charliermarsh on 2025-02-06 21:52_

---

_Comment by @alexprengere on 2025-02-07 08:57_

After compiling from sources to check #11298, I confirm that everything is now working fine for me, thanks a lot for the quick fix!

---
