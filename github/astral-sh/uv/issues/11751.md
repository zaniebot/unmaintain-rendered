---
number: 11751
title: "Best way to achieve \"cascading dependencies\" that are all resolved together"
type: issue
state: closed
author: matthawkins90
labels:
  - question
assignees: []
created_at: 2025-02-24T18:22:40Z
updated_at: 2025-02-24T21:35:09Z
url: https://github.com/astral-sh/uv/issues/11751
synced_at: 2026-01-07T12:31:15-06:00
---

# Best way to achieve "cascading dependencies" that are all resolved together

---

_Issue opened by @matthawkins90 on 2025-02-24 18:22_

### Question

# Goal

I'm trying to create three different `requirements.txt` files (or `uv.lock` files, it doesn't matter to me) that are designed for different app environments with minimal dependencies.

For example:
* `prod-requirements.txt` <-- The minimal requirements to function in prod
* `train-requirements.txt` <-- Add a few additional requirements for training a ML model
* `dev-requirements.txt` <-- Add a few more requirements that are only installed in a dev environment.

The key feature I want is that the environments should all be "cascading" from each other, so that `prod` has the minimum requirements, `train` inherits all the same requirements from `prod` and adds a few more, and `dev` inherits all the requirements from `train` and adds a few more.

The most important aspect of this is that all of these separate requirements (or lock) files use all the same versions for their shared dependencies.  As in, the resolver should find the versions that can resolve for all requirements together.

# Example

This is an example of how I had it prior to using `uv`:

`prod-requirements.in`:
* (a private library that requires boto3)
* pydantic
* xgboost

`train-requirements.in`:
* pandas
* pytest
* scikit-learn

`dev-requirements.in`:
* jupyterlab
* plotly
* pre-commit

And then to ensure that the requirements were correctly cascading from one to the next, I'd run these in order (using a makefile):

```sh
pip-compile --no-emit-index-url --output-file prod-requirements.txt prod-requirements.in --resolver=backtracking
pip-compile --no-emit-index-url --output-file train-requirements.txt prod-requirements.txt train-requirements.in --resolver=backtracking
pip-compile --no-emit-index-url --output-file dev-requirements.txt train-requirements.txt dev-requirements.in --resolver=backtracking
```

This way, `train-requirements.txt` uses both `prod-requirements.txt` and `train-requirements.in` as inputs, and so on.

And then on a dev device, you'd just run `pip-sync dev-requirements.txt`.

For different Docker environments, you'd do something like:

```
COPY prod-requirements.txt .
RUN pip install --no-cache-dir -r prod-requirements.txt
```

# Attempting to get this to work with uv

I tried a few different methods, but eventually it seemed like putting everything into `project.optional-dependencies` was the move.

```
[project]
name = "example"

[project.optional-dependencies]
prod = [
    "(a private library that requires boto3)",
    "pydantic",
    "xgboost",
]
train = [
    "example[prod]", # include all prod dependencies
    "pandas",
    "pytest",
    "scikit-learn",
]
dev = [
    "example[train]", # include all train dependencies
    "jupyterlab",
    "plotly",
    "pre-commit",
]
```

Then running:

```sh
uv pip compile --no-emit-index-url --no-strip-extras --extra=prod pyproject.toml --output-file prod-requirements.txt
uv pip compile --no-emit-index-url --no-strip-extras --extra=train pyproject.toml --output-file train-requirements.txt
uv pip compile --no-emit-index-url --no-strip-extras --extra=dev pyproject.toml --output-file dev-requirements.txt
```

followed by `uv pip sync dev-requirements.txt`

# The problem

Using the `uv` commands above and checking dependency versions across all the different requirements textfiles, I noticed that:

* prod-requirements.txt uses `boto3==1.36.23`
* train-requirements.txt uses `boto3==1.36.3`
* dev-requirements.txt uses `boto3==1.36.3`

Essentially, I can't force a guarantee that they'll all be using the same versions of their dependencies as each other.

Is there a better method I should be using to achieve my goals, or did I find a bug in the resolver?

### Platform

Darwin 24.3.0 arm64

### Version

uv 0.6.2 (Homebrew 2025-02-19)

---

_Label `question` added by @matthawkins90 on 2025-02-24 18:22_

---

_Comment by @notatallshaw-gts on 2025-02-24 18:50_

This is a simplified version of how I do this using your example:

```
cat prod-requirements.in train-requirements.in dev-requirements.in | uv pip compile - -o full-constraints.txt --upgrade
cat prod-requirements.in | uv pip compile - -c full-constraints.txt -o prod-requirements.txt
cat prod-requirements.txt train-requirements.in | uv pip compile - -c full-constraints.txt -o train-requirements.txt
cat prod-requirements.txt train-requirements.txt dev-requirements.in  | uv pip compile - -c full-constraints.txt -o dev-requirements.txt
```

The main point is you first generate a file that fully resolves all your requirements, and then use that as a constraints file for all your subsets of requirements. As long as you adhere to that principle you can use this same approach in a number of different and flexible ways.

But there may be some better way by creating a lock file and exporting some subset of it?

---

_Comment by @matthawkins90 on 2025-02-24 20:36_

That method works great for me! Thank you. I didn't realize there was a `-c` / `--constraint` arg.

Would still be curious if anyone has suggestions for doing this with the `uv.lock` format instead of requirements.txt files.

---

_Comment by @zanieb on 2025-02-24 20:41_

> Would still be curious if anyone has suggestions for doing this with the uv.lock format instead of requirements.txt files.

Does it not work with `uv lock` and `uv sync`? Your project declaration looks reasonable and we already attempt to find stable versions across optional dependencies.

---

_Comment by @matthawkins90 on 2025-02-24 20:44_

`uv lock` doesn't allow me to specify cascading dependencies, right?  Can I have more than one lockfile where one lockfile uses another lockfile as a constraint?

---

_Comment by @zanieb on 2025-02-24 20:46_

Why do they need to "cascade"? We'll only use the relevant subset of lockfile at install time.

---

_Comment by @matthawkins90 on 2025-02-24 20:49_

how would I `uv sync` only the `prod` requirements in one environment, and then `uv sync` only the `prod + train` requirements in another environment, ensuring that the `prod` requirements are identical between each of those environments?

(using a uv.lock file, not the separate {prod,train}-requirements.txt files)

---

_Comment by @zanieb on 2025-02-24 20:54_

```
uv sync --extra prod
uv sync --extra train
uv sync --extra dev
```

If you need multiple environments, set `UV_PROJECT_ENVIRONMENT=<name>` before each command.

We resolve extras together by default, so unless they are _explicitly_ declared as conflicting (https://docs.astral.sh/uv/concepts/projects/config/#conflicting-dependencies) the versions will match.

---

_Comment by @matthawkins90 on 2025-02-24 21:23_

That's excellent, thank you very much!

---

_Comment by @zanieb on 2025-02-24 21:35_

No problem :)

---

_Closed by @zanieb on 2025-02-24 21:35_

---
