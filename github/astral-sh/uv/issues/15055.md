---
number: 15055
title: Relative indexes are stored as absolute in the lockfile
type: issue
state: open
author: cwiede
labels:
  - bug
  - good first issue
assignees: []
created_at: 2025-08-04T11:11:01Z
updated_at: 2026-01-07T10:40:53Z
url: https://github.com/astral-sh/uv/issues/15055
synced_at: 2026-01-07T12:31:16-06:00
---

# Relative indexes are stored as absolute in the lockfile

---

_Issue opened by @cwiede on 2025-08-04 11:11_

### Question

Hi,

I have a project which (transitively) depends on PySide6. Since the aarch64 build of PySide6 depends on manylinux_2_39 which is not satisfied for our use case, we decided to build our own wheels for the use case. I want to use `uv lock` to generate a lock file suitable for all the platforms (i.e. windows/amd64, linux/x86_64, linux/aarch64). Therefore I use

```
environments = [
    "sys_platform == 'win32' and implementation_name == 'cpython' and platform_machine == 'AMD64'",
    "sys_platform == 'linux' and implementation_name == 'cpython' and (platform_machine == 'x86_64' or platform_machine == 'aarch64')"
]
```

and I also played around with required-environments instead. Unfortunately, there seems to be no way to specify the python-platform (e.g. `aarch64-manylinux_2_35`) in these definitions, or at least I didn't find one.

The problem I'm facing is that I can't convince uv to use our self-build wheel for the linux aarch64 platform and the pypi wheels for all other platforms. I have tried to play around with

- index-strategy = "unsafe-best-match" (but it seems to either use pypi or the local wheel)
- required-environments
- platform-specific indices with marker = "platform_machine == 'aarch64'":

```
[tool.uv.sources]
pyside6 = [
    {index = "nexus", marker = "platform_machine == 'AMD64'"},
    {index = "flat-pyside6", marker = "platform_machine == 'aarch64'"},
]

[[tool.uv.index]]
name="flat-pyside6"
url="./path/to/pyside6-aarch64"
```

Are there any workarounds or suggestions for this use case?

Thanks!

### Platform

windows/amd64, linux/x86_64, linux/aarch64

### Version

uv 0.8.4

---

_Label `question` added by @cwiede on 2025-08-04 11:11_

---

_Comment by @konstin on 2025-08-04 11:38_

Does adding `format = "flat"` help? The following works for me if I place `numpy-2.3.2-cp313-cp313-manylinux_2_27_x86_64.manylinux_2_28_x86_64.whl` in the current directory.

Another option to consider is to vendor all wheels for the version you need and only use the flat index for PySide6 (or publishing your custom built wheel to nexus), this avoids having the divergent index declaration.

```toml
[project]
name = "debug"
version = "0.0.1"
requires-python = "==3.13.*"
dependencies = ["numpy"]

[tool.uv.sources]
numpy = [
  { index = "flat", marker = "platform_machine == 'x86_64'" },
  { index = "pypi", marker = "platform_machine != 'x86_64'" },
]

[[tool.uv.index]]
name = "flat"
url = "."
format = "flat"

[[tool.uv.index]]
name = "pypi"
url = "https://pypi.org/simple"
publish-url = "https://upload.pypi.org/legacy/"
```

```toml
version = 1
revision = 3
requires-python = "==3.13.*"
resolution-markers = [
    "platform_machine == 'x86_64'",
    "platform_machine != 'x86_64'",
]

[[package]]
name = "debug"
version = "0.0.1"
source = { virtual = "." }
dependencies = [
    { name = "numpy", version = "2.3.2", source = { registry = "https://pypi.org/simple" }, marker = "platform_machine != 'x86_64'" },
    { name = "numpy", version = "2.3.2", source = { registry = "." }, marker = "platform_machine == 'x86_64'" },
]

[package.metadata]
requires-dist = [
    { name = "numpy", marker = "platform_machine != 'x86_64'", index = "https://pypi.org/simple" },
    { name = "numpy", marker = "platform_machine == 'x86_64'", index = "file:///home/konsti/projects/uv/debug" },
]

[[package]]
name = "numpy"
version = "2.3.2"
source = { registry = "https://pypi.org/simple" }
resolution-markers = [
    "platform_machine != 'x86_64'",
]
sdist = { url = "https://files.pythonhosted.org/packages/37/7d/3fec4199c5ffb892bed55cff901e4f39a58c81df9c44c280499e92cad264/numpy-2.3.2.tar.gz", hash = "sha256:e0486a11ec30cdecb53f184d496d1c6a20786c81e55e41640270130056f8ee48", size = 20489306, upload-time = "2025-07-24T21:32:07.553Z" }
wheels = [
    { url = "https://files.pythonhosted.org/packages/1c/c0/c6bb172c916b00700ed3bf71cb56175fd1f7dbecebf8353545d0b5519f6c/numpy-2.3.2-cp313-cp313-macosx_10_13_x86_64.whl", hash = "sha256:c8d9727f5316a256425892b043736d63e89ed15bbfe6556c5ff4d9d4448ff3b3", size = 20949074, upload-time = "2025-07-24T20:43:07.813Z" },
    { url = "https://files.pythonhosted.org/packages/20/4e/c116466d22acaf4573e58421c956c6076dc526e24a6be0903219775d862e/numpy-2.3.2-cp313-cp313-macosx_11_0_arm64.whl", hash = "sha256:efc81393f25f14d11c9d161e46e6ee348637c0a1e8a54bf9dedc472a3fae993b", size = 14177311, upload-time = "2025-07-24T20:43:29.335Z" },
    { url = "https://files.pythonhosted.org/packages/78/45/d4698c182895af189c463fc91d70805d455a227261d950e4e0f1310c2550/numpy-2.3.2-cp313-cp313-macosx_14_0_arm64.whl", hash = "sha256:dd937f088a2df683cbb79dda9a772b62a3e5a8a7e76690612c2737f38c6ef1b6", size = 5106022, upload-time = "2025-07-24T20:43:37.999Z" },
    { url = "https://files.pythonhosted.org/packages/9f/76/3e6880fef4420179309dba72a8c11f6166c431cf6dee54c577af8906f914/numpy-2.3.2-cp313-cp313-macosx_14_0_x86_64.whl", hash = "sha256:11e58218c0c46c80509186e460d79fbdc9ca1eb8d8aee39d8f2dc768eb781089", size = 6640135, upload-time = "2025-07-24T20:43:49.28Z" },
    { url = "https://files.pythonhosted.org/packages/34/fa/87ff7f25b3c4ce9085a62554460b7db686fef1e0207e8977795c7b7d7ba1/numpy-2.3.2-cp313-cp313-manylinux_2_27_aarch64.manylinux_2_28_aarch64.whl", hash = "sha256:5ad4ebcb683a1f99f4f392cc522ee20a18b2bb12a2c1c42c3d48d5a1adc9d3d2", size = 14278147, upload-time = "2025-07-24T20:44:10.328Z" },
    { url = "https://files.pythonhosted.org/packages/1d/0f/571b2c7a3833ae419fe69ff7b479a78d313581785203cc70a8db90121b9a/numpy-2.3.2-cp313-cp313-manylinux_2_27_x86_64.manylinux_2_28_x86_64.whl", hash = "sha256:938065908d1d869c7d75d8ec45f735a034771c6ea07088867f713d1cd3bbbe4f", size = 16635989, upload-time = "2025-07-24T20:44:34.88Z" },
    { url = "https://files.pythonhosted.org/packages/24/5a/84ae8dca9c9a4c592fe11340b36a86ffa9fd3e40513198daf8a97839345c/numpy-2.3.2-cp313-cp313-musllinux_1_2_aarch64.whl", hash = "sha256:66459dccc65d8ec98cc7df61307b64bf9e08101f9598755d42d8ae65d9a7a6ee", size = 16053052, upload-time = "2025-07-24T20:44:58.872Z" },
    { url = "https://files.pythonhosted.org/packages/57/7c/e5725d99a9133b9813fcf148d3f858df98511686e853169dbaf63aec6097/numpy-2.3.2-cp313-cp313-musllinux_1_2_x86_64.whl", hash = "sha256:a7af9ed2aa9ec5950daf05bb11abc4076a108bd3c7db9aa7251d5f107079b6a6", size = 18577955, upload-time = "2025-07-24T20:45:26.714Z" },
    { url = "https://files.pythonhosted.org/packages/ae/11/7c546fcf42145f29b71e4d6f429e96d8d68e5a7ba1830b2e68d7418f0bbd/numpy-2.3.2-cp313-cp313-win32.whl", hash = "sha256:906a30249315f9c8e17b085cc5f87d3f369b35fedd0051d4a84686967bdbbd0b", size = 6311843, upload-time = "2025-07-24T20:49:24.444Z" },
    { url = "https://files.pythonhosted.org/packages/aa/6f/a428fd1cb7ed39b4280d057720fed5121b0d7754fd2a9768640160f5517b/numpy-2.3.2-cp313-cp313-win_amd64.whl", hash = "sha256:c63d95dc9d67b676e9108fe0d2182987ccb0f11933c1e8959f42fa0da8d4fa56", size = 12782876, upload-time = "2025-07-24T20:49:43.227Z" },
    { url = "https://files.pythonhosted.org/packages/65/85/4ea455c9040a12595fb6c43f2c217257c7b52dd0ba332c6a6c1d28b289fe/numpy-2.3.2-cp313-cp313-win_arm64.whl", hash = "sha256:b05a89f2fb84d21235f93de47129dd4f11c16f64c87c33f5e284e6a3a54e43f2", size = 10192786, upload-time = "2025-07-24T20:49:59.443Z" },
    { url = "https://files.pythonhosted.org/packages/80/23/8278f40282d10c3f258ec3ff1b103d4994bcad78b0cba9208317f6bb73da/numpy-2.3.2-cp313-cp313t-macosx_10_13_x86_64.whl", hash = "sha256:4e6ecfeddfa83b02318f4d84acf15fbdbf9ded18e46989a15a8b6995dfbf85ab", size = 21047395, upload-time = "2025-07-24T20:45:58.821Z" },
    { url = "https://files.pythonhosted.org/packages/1f/2d/624f2ce4a5df52628b4ccd16a4f9437b37c35f4f8a50d00e962aae6efd7a/numpy-2.3.2-cp313-cp313t-macosx_11_0_arm64.whl", hash = "sha256:508b0eada3eded10a3b55725b40806a4b855961040180028f52580c4729916a2", size = 14300374, upload-time = "2025-07-24T20:46:20.207Z" },
    { url = "https://files.pythonhosted.org/packages/f6/62/ff1e512cdbb829b80a6bd08318a58698867bca0ca2499d101b4af063ee97/numpy-2.3.2-cp313-cp313t-macosx_14_0_arm64.whl", hash = "sha256:754d6755d9a7588bdc6ac47dc4ee97867271b17cee39cb87aef079574366db0a", size = 5228864, upload-time = "2025-07-24T20:46:30.58Z" },
    { url = "https://files.pythonhosted.org/packages/7d/8e/74bc18078fff03192d4032cfa99d5a5ca937807136d6f5790ce07ca53515/numpy-2.3.2-cp313-cp313t-macosx_14_0_x86_64.whl", hash = "sha256:a9f66e7d2b2d7712410d3bc5684149040ef5f19856f20277cd17ea83e5006286", size = 6737533, upload-time = "2025-07-24T20:46:46.111Z" },
    { url = "https://files.pythonhosted.org/packages/19/ea/0731efe2c9073ccca5698ef6a8c3667c4cf4eea53fcdcd0b50140aba03bc/numpy-2.3.2-cp313-cp313t-manylinux_2_27_aarch64.manylinux_2_28_aarch64.whl", hash = "sha256:de6ea4e5a65d5a90c7d286ddff2b87f3f4ad61faa3db8dabe936b34c2275b6f8", size = 14352007, upload-time = "2025-07-24T20:47:07.1Z" },
    { url = "https://files.pythonhosted.org/packages/cf/90/36be0865f16dfed20f4bc7f75235b963d5939707d4b591f086777412ff7b/numpy-2.3.2-cp313-cp313t-manylinux_2_27_x86_64.manylinux_2_28_x86_64.whl", hash = "sha256:a3ef07ec8cbc8fc9e369c8dcd52019510c12da4de81367d8b20bc692aa07573a", size = 16701914, upload-time = "2025-07-24T20:47:32.459Z" },
    { url = "https://files.pythonhosted.org/packages/94/30/06cd055e24cb6c38e5989a9e747042b4e723535758e6153f11afea88c01b/numpy-2.3.2-cp313-cp313t-musllinux_1_2_aarch64.whl", hash = "sha256:27c9f90e7481275c7800dc9c24b7cc40ace3fdb970ae4d21eaff983a32f70c91", size = 16132708, upload-time = "2025-07-24T20:47:58.129Z" },
    { url = "https://files.pythonhosted.org/packages/9a/14/ecede608ea73e58267fd7cb78f42341b3b37ba576e778a1a06baffbe585c/numpy-2.3.2-cp313-cp313t-musllinux_1_2_x86_64.whl", hash = "sha256:07b62978075b67eee4065b166d000d457c82a1efe726cce608b9db9dd66a73a5", size = 18651678, upload-time = "2025-07-24T20:48:25.402Z" },
    { url = "https://files.pythonhosted.org/packages/40/f3/2fe6066b8d07c3685509bc24d56386534c008b462a488b7f503ba82b8923/numpy-2.3.2-cp313-cp313t-win32.whl", hash = "sha256:c771cfac34a4f2c0de8e8c97312d07d64fd8f8ed45bc9f5726a7e947270152b5", size = 6441832, upload-time = "2025-07-24T20:48:37.181Z" },
    { url = "https://files.pythonhosted.org/packages/0b/ba/0937d66d05204d8f28630c9c60bc3eda68824abde4cf756c4d6aad03b0c6/numpy-2.3.2-cp313-cp313t-win_amd64.whl", hash = "sha256:72dbebb2dcc8305c431b2836bcc66af967df91be793d63a24e3d9b741374c450", size = 12927049, upload-time = "2025-07-24T20:48:56.24Z" },
    { url = "https://files.pythonhosted.org/packages/e9/ed/13542dd59c104d5e654dfa2ac282c199ba64846a74c2c4bcdbc3a0f75df1/numpy-2.3.2-cp313-cp313t-win_arm64.whl", hash = "sha256:72c6df2267e926a6d5286b0a6d556ebe49eae261062059317837fda12ddf0c1a", size = 10262935, upload-time = "2025-07-24T20:49:13.136Z" },
]

[[package]]
name = "numpy"
version = "2.3.2"
source = { registry = "." }
resolution-markers = [
    "platform_machine == 'x86_64'",
]
wheels = [
    { path = "numpy-2.3.2-cp313-cp313-manylinux_2_27_x86_64.manylinux_2_28_x86_64.whl" },
]
```

---

_Comment by @cwiede on 2025-08-04 12:24_

Thanks for the quick response!

Indeed I have missed the `format="flat"` part. Now in principle I can get this to work, but now I see that relative paths are converted to absolute paths in the lock file (see also the /home/konsti part above), which is in contrast to the paths given by `find-links`; this is undesired for our use case.

I also played around to select a wheel explicitely with the `path` setting in [tool.uv.sources] instead of a flat index, and this seems to be the way to go at the moment (even though a flat relative index would be less redundant). I.e.:

```
[tool.uv.sources]
pyside6 = [
    {path = "./PySide6-6.8.3-cp39-abi3-manylinux_2_31_aarch64.whl", marker = "platform_machine == 'aarch64'"},
    {index = "nexus", marker = "platform_machine != 'aarch64'"},
]
```

---

_Renamed from "Wheel for one platform from a local dir, other platforms from index" to "Relative indexes are stored as absolute in the lockfile" by @konstin on 2025-08-04 13:08_

---

_Label `question` removed by @konstin on 2025-08-04 13:09_

---

_Label `bug` added by @konstin on 2025-08-04 13:09_

---

_Label `good first issue` added by @konstin on 2025-08-04 18:03_

---

_Comment by @konstin on 2025-08-04 18:05_

We should make flat index paths relative in the lockfile in the same way that we do for all other relative paths in the lockfile, this is an oversight. With that fix `format = "flat"` should work just like using `path` directly.

---

_Assigned to @jtfmumm by @jtfmumm on 2025-08-08 12:28_

---

_Unassigned @jtfmumm by @konstin on 2025-09-12 13:38_

---

_Referenced in [astral-sh/uv#15870](../../astral-sh/uv/pulls/15870.md) on 2025-09-15 14:08_

---

_Assigned to @konstin by @konstin on 2025-09-25 13:40_

---

_Comment by @peterchristofferholm on 2026-01-06 15:16_

Ran into this as well. I'm using a relative path to a local wheelhouse in my pyproject.toml, but the lockfile still ends up with the absolute path resolved at generation time. When running `uv sync --locked` in Docker (where the wheelhouse is mounted at a different absolute path), it fails with "mismatched requirements" even though the packages and versions are identical. I can see that there is a practically complete PR waiting to get merged, any progress on getting that in? 

---

_Comment by @nooscraft on 2026-01-07 01:35_

@konstin are you working on this? If not I can have another look at this

---

_Unassigned @konstin by @konstin on 2026-01-07 08:39_

---

_Comment by @konstin on 2026-01-07 08:39_

I'm not currently working on this.

---

_Comment by @nooscraft on 2026-01-07 10:21_

> I'm not currently working on this.

What about the PR?

---

_Comment by @konstin on 2026-01-07 10:40_

That's stuck on https://github.com/astral-sh/uv/pull/15870/changes#r2514491656, the logic seems to be having some issues. It's not something where we can use an approximate logic, we need to make sure all cases across operating systems.

---
