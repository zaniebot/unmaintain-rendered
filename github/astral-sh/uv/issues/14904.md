---
number: 14904
title: "`environments` setting ignored in uv.toml?"
type: issue
state: closed
author: dpprdan
labels:
  - bug
assignees: []
created_at: 2025-07-25T19:34:08Z
updated_at: 2025-07-25T21:07:49Z
url: https://github.com/astral-sh/uv/issues/14904
synced_at: 2026-01-07T12:31:16-06:00
---

# `environments` setting ignored in uv.toml?

---

_Issue opened by @dpprdan on 2025-07-25 19:34_

### Summary

It seems that `environments` setting in `uv.toml` is ignored when writing uv.lock.

MWE: 
In an empty directory in a linux environment execute:

```bash
cat << EOF > uv.toml
environments = ["sys_platform == 'linux'"]
EOF

uv init
uv add ruff

grep win uv.lock
```

Output:

```text
Initialized project `test-uv`
Using CPython 3.13.1
Creating virtual environment at: .venv
Resolved 2 packages in 73ms
Installed 1 package in 86ms
 + ruff==0.12.5
    { url = "https://files.pythonhosted.org/packages/3e/b9/053d6445dc7544fb6594785056d8ece61daae7214859ada4a152ad56b6e0/ruff-0.12.5-py3-none-win32.whl", hash = "sha256:dfeb2627c459b0b78ca2bbdc38dd11cc9a0a88bf91db982058b26ce41714ffa9", size = 11751575, upload-time = "2025-07-24T13:26:30.835Z" },
    { url = "https://files.pythonhosted.org/packages/bc/0f/ab16e8259493137598b9149734fec2e06fdeda9837e6f634f5c4e35916da/ruff-0.12.5-py3-none-win_amd64.whl", hash = "sha256:ae0d90cf5f49466c954991b9d8b953bd093c32c27608e409ae3564c63c5306a5", size = 12882273, upload-time = "2025-07-24T13:26:32.929Z" },
    { url = "https://files.pythonhosted.org/packages/00/db/c376b0661c24cf770cb8815268190668ec1330eba8374a126ceef8c72d55/ruff-0.12.5-py3-none-win_arm64.whl", hash = "sha256:48cdbfc633de2c5c37d9f090ba3b352d1576b0015bfc3bc98eaf230275b7e805", size = 11951564, upload-time = "2025-07-24T13:26:34.994Z" },
```

Compare to adding the same `environments` setting to pyproject.toml

```bash
cat << EOF >> pyproject.toml
[tool.uv]
environments = ["sys_platform == 'linux'"]
EOF

uv sync

grep win uv.lock
```

Output: 

```
warning: Found both a `uv.toml` file and a `[tool.uv]` section in an adjacent `pyproject.toml`. The following fields from `[tool.uv]` will be ignored in favor of the `uv.toml` file:
- environments
Resolved 2 packages in 177ms
Audited 1 package in 0.59ms
```

I.e. there aren't any dependencies for Windows present in uv.lock, anymore. 

The `warning` is also not entirely correct in this case, as `uv` apparently uses the setting in pyproject.toml. 
The same warning is shown, when the `environments` setting is only present in pyproject.toml, so it cannot really be ignored in favor of the uv.toml file, obviously.

Is this a bug or a mistake on my part?

### Platform

Ubuntu 24.04.2 x86_64 (WSL)

### Version

uv 0.8.3

### Python version

Python 3.13.1

---

_Label `bug` added by @dpprdan on 2025-07-25 19:34_

---

_Comment by @zanieb on 2025-07-25 19:37_

Settings that affect project metadata aren't allowed in the `uv.toml`.

Sorry the warning is confusing. I thought we fixed this in https://github.com/astral-sh/uv/pull/14325

---

_Comment by @charliermarsh on 2025-07-25 19:40_

It looks like the warning might just be inverted. I believe we respect the `pyproject.toml`, yeah.

> The same warning is shown, when the environments setting is only present in pyproject.toml, so it cannot really be ignored in favor of the uv.toml file, obviously.

I think it's very likely that you still had a `uv.toml` file around if you're still seeing this.

---

_Comment by @charliermarsh on 2025-07-25 19:42_

Yeah, I can't reproduce this if I remove the `uv.toml`. Maybe you removed your `uv.lock` by accident instead?

---

_Comment by @zanieb on 2025-07-25 19:43_

The warning seems inverted, yeah.

---

_Comment by @zanieb on 2025-07-25 19:44_

It's weird we warn here though, we should just error when `uv.toml` contains `environments`?

---

_Comment by @zanieb on 2025-07-25 19:44_

Which I thought was in https://github.com/astral-sh/uv/pull/14322

---

_Comment by @charliermarsh on 2025-07-25 19:45_

I don't see environments in https://github.com/astral-sh/uv/pull/14322.

---

_Referenced in [astral-sh/uv#14905](../../astral-sh/uv/pulls/14905.md) on 2025-07-25 19:50_

---

_Comment by @dpprdan on 2025-07-25 19:52_

Uhm, then let me vote for allowing environments in uv.toml, if I may.

> Settings that affect project metadata aren't allowed in the uv.toml.

There's probably a very good reason for that, but IMHO the line between project metadata and config settings is bit blurry. E.g. (maybe not the best example) you might want to set different `link-mode`s per environment. Or if you're developing in some container based setup where you don't really have "machine" configs. Here I'd like to copy just the uv.toml with my settings (including `environments`) and then just manage the pyproject.toml with `uv init`, `uv add` etc.

---

_Comment by @dpprdan on 2025-07-25 19:53_

> I think it's very likely that you still had a `uv.toml` file around if you're still seeing this.

> Yeah, I can't reproduce this if I remove the `uv.toml`. Maybe you removed your `uv.lock` by accident instead?

As hinted at in the post above, I do have other settings in uv.toml, so that is and will be present still.

---

_Comment by @dpprdan on 2025-07-25 20:07_

> It's weird we warn here though, we should just error when `uv.toml` contains `environments`?

Thinking about this a little further, I wonder: Setting e.g. `environments = ["sys_platform == 'linux'"]` at the user or system level might be a little odd, but is it that bad as to prohibit it altogether?

And then there's the case where `uv.toml` is in the project directory. It's not really clear to me, why some settings would be mandatory to be set in pyproject.toml whereas others could be in both, I guess? 



---

_Comment by @dpprdan on 2025-07-25 20:11_

> It looks like the warning might just be inverted. 

The warning does make sense from the ["`uv.toml` files take precedence over `pyproject.toml` files"](https://docs.astral.sh/uv/concepts/configuration-files/#configuration-files) point of view though.

---

_Comment by @zanieb on 2025-07-25 20:15_

> Setting e.g. environments = ["sys_platform == 'linux'"] at the user or system level might be a little odd, but is it that bad as to prohibit it altogether?

In our current model, we prohibit other settings like this so we'd need to reconsider the model more broadly to allow it.

>  It's not really clear to me, why some settings would be mandatory to be set in pyproject.toml whereas others could be in both, I guess?

It's... complicated. It seems a little weird to special-case `uv.toml` files that are in project directories though?

---

_Closed by @zanieb on 2025-07-25 20:19_

---

_Comment by @zanieb on 2025-07-25 20:20_

(Happy to continue chatting, but the validation bug is fixed)

---

_Comment by @dpprdan on 2025-07-25 20:54_

> (Happy to continue chatting, but the validation bug is fixed)

Thanks, I appreciate it!

Again, you probably have good reasons for it. I just cannot entirely wrap my head around it ATM and from my perspective it seems somewhat confusing. I guess I'd need to hear those reasons to be able to understand it?

> It's... complicated. It seems a little weird to special-case `uv.toml` files that are in project directories though?

I'd tend to agree at first. However, from my perspective there is a lot of precedence of other tools allowing either settings under the [tool] header in pyproject.toml or in tool.toml. I don't think I've seen a "this setting has to live in pyproject.toml, but you can put others in tool.toml". With that in mind, special-casing project-level `uv.toml` files seems less weird than this alternative.

I'd also like to stress this again:

> developing in some container based setup where you don't really have "machine" configs.

E.g. using a GitHub template repo to bootstrap setting up new projects. These can contain a uv.toml file with all settings relevant to the environment and serve as a de-facto system-level config file which just happen to live in the project directory because there is only one project per machine (i.e. container). In that setting, `environments = ["sys_platform == 'linux'"]` , is really more of a system-level than a project-level setting, because you're only developing in linux containers anyway. 

It would be a bit clumsy for these templates to already contain a rudimentary pyproject.toml as you e.g. wouldn't be able to `uv init` the project.

I understand the requirement to not allow definite project level settings on the user- or system-level, but like I said, for some settings the lines are blurrier than others. I would probably add `default-groups`, `index`, `sources`, possibly `build-backend` in the blurry category.

---

_Comment by @zanieb on 2025-07-25 21:07_

Here's a dedicated issue to discuss this https://github.com/astral-sh/uv/issues/14908

---

_Referenced in [astral-sh/uv#14908](../../astral-sh/uv/issues/14908.md) on 2025-07-25 21:08_

---
