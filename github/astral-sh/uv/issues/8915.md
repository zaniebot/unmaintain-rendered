---
number: 8915
title: "Platform-Specific Dependencies in requirements.in Not Working as Expected with `--universal`"
type: issue
state: closed
author: ewianda
labels:
  - bug
assignees: []
created_at: 2024-11-08T03:52:09Z
updated_at: 2025-04-14T12:31:45Z
url: https://github.com/astral-sh/uv/issues/8915
synced_at: 2026-01-07T12:31:15-06:00
---

# Platform-Specific Dependencies in requirements.in Not Working as Expected with `--universal`

---

_Issue opened by @ewianda on 2024-11-08 03:52_

**Description**:  
When specifying platform-specific dependencies in `requirements.in` for `optimum[onnxruntime]` and `optimum[onnxruntime-gpu]`, the generated `requirements.txt` file consolidates dependencies inappropriately. Specifically, `optimum[onnxruntime-gpu]; sys_platform == 'linux'` and `optimum[onnxruntime]; sys_platform == 'darwin'` results in `optimum[onnxruntime,onnxruntime]==1.18; sys_platform == 'linux'` in the output `requirements.txt`, which causes the Darwin platform dependency to be ignored.

**Steps to Reproduce**:
1. Create a `requirements.in` file with the following lines:
    ```plaintext
    optimum[onnxruntime-gpu]; sys_platform == 'linux'
    optimum[onnxruntime]; sys_platform == 'darwin'
    ```
2. Run `uv pip compile --universal requirements.in` to generate `requirements.txt`.
3. Open the resulting `requirements.txt`.

**Expected Behavior**:
`requirements.txt` should list both platform-specific dependencies separately, like:
```plaintext
optimum[onnxruntime-gpu]==1.18; sys_platform == 'linux'
optimum[onnxruntime]==1.18; sys_platform == 'darwin'
```

**Actual Behavior**:
The generated `requirements.txt` incorrectly merges dependencies, resulting in:
```plaintext
optimum[onnxruntime,onnxruntime-gpu]==1.18; sys_platform == 'linux'
```
This line omits the macOS (Darwin) dependency entirely.

**Environment**:
- `uv` version: 0.4.30
 
- Operating System: Linux


---

_Label `bug` added by @charliermarsh on 2024-11-08 03:54_

---

_Comment by @charliermarsh on 2024-11-08 03:55_

I can guess at what's going on here, thanks.

---

_Assigned to @charliermarsh by @charliermarsh on 2024-11-08 13:37_

---

_Referenced in [astral-sh/uv#8960](../../astral-sh/uv/pulls/8960.md) on 2024-11-08 23:03_

---

_Closed by @charliermarsh on 2024-11-08 23:22_

---

_Closed by @charliermarsh on 2024-11-08 23:22_

---

_Comment by @ewianda on 2024-11-12 15:41_

Hi @charliermarsh , I just tested the fix, and it works, but for one anomaly.

```bash
 echo -e "optimum[onnxruntime]; sys_platform == 'darwin'\noptimum[onnxruntime-gpu]; sys_platform == 'linux'" | cargo run --  pip compile --universal --no-strip-extras  - | grep optimum
    Finished `dev` profile [unoptimized + debuginfo] target(s) in 0.34s
     Running `target/debug/uv pip compile --universal --no-strip-extras -`
 
optimum==1.23.3 ; sys_platform == 'darwin' or sys_platform == 'linux'
optimum[onnxruntime]==1.23.3 ; sys_platform == 'darwin'
optimum[onnxruntime-gpu]==1.23.3 ; sys_platform == 'linux'  
```


The extra `optimum==1.23.3 ; sys_platform == 'darwin' or sys_platform == 'linux'`  seems unnecessary

---

_Comment by @charliermarsh on 2024-11-12 17:14_

I saw that, but I think it's acceptable personally.

---

_Comment by @ewianda on 2025-04-14 04:51_

Hi @charliermarsh 

>optimum==1.23.3 ; sys_platform == 'darwin' or sys_platform == 'linux'
optimum[onnxruntime]==1.23.3 ; sys_platform == 'darwin'
optimum[onnxruntime-gpu]==1.23.3 ; sys_platform == 'linux'  


This has become an issue with our Bazel setup. It is now considered a duplicate, and Bazel fails to create a repository. Could this be addressed? 

Thanks

---

_Referenced in [bazel-contrib/rules_python#2766](../../bazel-contrib/rules_python/pulls/2766.md) on 2025-04-14 04:52_

---

_Comment by @charliermarsh on 2025-04-14 12:31_

@ewianda -- Do you mind filing a new issue to track it, with a repro?

---
