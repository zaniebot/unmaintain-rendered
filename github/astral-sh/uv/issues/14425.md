---
number: 14425
title: "thiserror `#[error(transparent)]` payloads get skipped in the source chain"
type: issue
state: closed
author: oconnor663
labels:
  - bug
assignees: []
created_at: 2025-07-02T16:53:15Z
updated_at: 2025-08-02T15:32:34Z
url: https://github.com/astral-sh/uv/issues/14425
synced_at: 2026-01-07T12:31:16-06:00
---

# thiserror `#[error(transparent)]` payloads get skipped in the source chain

---

_Issue opened by @oconnor663 on 2025-07-02 16:53_

This is a hypothetical bug without an observed smoking gun. (I've only been able to [trigger it artificially](https://github.com/astral-sh/uv/issues/14171#issuecomment-3014580701), not with e.g. a real connection reset on the real network.) Here's some code that might be vulnerable to skipping an IO error, depending on how exactly that error is wrapped: https://github.com/astral-sh/uv/blob/87e9ccfb92e2761433bebddbdd68895de0e20abd/crates/uv-client/src/base_client.rs#L898-L908

The reason this is vulnerable is because of a bad/unexpected interaction between `thiserror`'s `#[error(transparent)]` marker and a `downcast` loop that walks the `.source()` chain. [Here's a Playground demo.](https://play.rust-lang.org/?version=stable&mode=debug&edition=2024&gist=be02dbdc58332cea46ab7b93157036fc) The `io::Error` is skipped in that case, because `transparent` _forwards_ the `.source()` call to the wrapped error (which returns `None` in that demo, but it's a problem either way) rather than returning the wrapped error itself. This is [documented behavior](https://docs.rs/thiserror/latest/thiserror/#details), though those docs don't discuss the interaction with `downcast`.

---

_Label `bug` added by @oconnor663 on 2025-07-02 16:53_

---

_Assigned to @charliermarsh by @charliermarsh on 2025-07-02 16:53_

---

_Comment by @charliermarsh on 2025-07-02 16:54_

I have a change that I'll at least put up for review. We might decide against it.

---

_Comment by @konstin on 2025-07-02 17:01_

The important question is: Does reqwest actually ever gives a plain IO error, or does it return an `io::Error` with `ErrorKind::Custom` with a nested reqwest error that nests an io error? Ideally, we'd have an option in thiserror to get not the error chain without transparent, though that may not be possible with the trait casting restrictions (we could do our custom derive to replace thiseorr, but that would still clash with using anyhow/miette on the top elvels). I'd be cautious about changing our error chains too much without a strong motivation.

---

_Comment by @charliermarsh on 2025-07-02 17:03_

Couldn't reqwest return basically any of our own variants, which in turn could use a transparent IO error that we'd then miss? Like, don't we often see these as "extraction errors", which is our own variant?

---

_Comment by @oconnor663 on 2025-07-02 17:36_

I have an example of what a `reqwest` error (wrapped in a tar error) looks like at the bottom of [this comment](https://github.com/astral-sh/uv/issues/14171#issuecomment-3014580701).

---

_Referenced in [astral-sh/uv#14378](../../astral-sh/uv/pulls/14378.md) on 2025-07-03 22:12_

---

_Comment by @oconnor663 on 2025-07-03 22:13_

https://github.com/astral-sh/uv/actions/runs/16060816582/job/45326189810 includes the added logging from https://github.com/astral-sh/uv/pull/14378 but does not indicate that it retried. Does that make it the smoking gun for this issue?

---

_Comment by @charliermarsh on 2025-07-03 23:18_

I'm going to get rid of the transparent variants in `uv-extract`, let's start there.

---

_Referenced in [astral-sh/uv#14450](../../astral-sh/uv/pulls/14450.md) on 2025-07-03 23:23_

---

_Comment by @konstin on 2025-07-04 09:17_

Here's the debug representation of an error if a sever the network connection mid-download:

```
[crates/uv/src/commands/python/install.rs:658:13] &err = ExtractError(
    "cpython-3.14.0b3-20250702-x86_64-unknown-linux-gnu-install_only_stripped.tar.gz",
    Io(
        Custom {
            kind: Other,
            error: TarError {
                desc: "failed to unpack `/home/konsti/.local/share/uv/python/.temp/.tmpUQWZE4/python/include/python3.14/internal/pycore_runtime_init.h`",
                io: Custom {
                    kind: Other,
                    error: TarError {
                        desc: "failed to unpack `python/include/python3.14/internal/pycore_runtime_init.h` into `/home/konsti/.local/share/uv/python/.temp/.tmpUQWZE4/python/include/python3.14/internal/pycore_runtime_init.h`",
                        io: Custom {
                            kind: Other,
                            error: reqwest::Error {
                                kind: Decode,
                                source: reqwest::Error {
                                    kind: Body,
                                    source: TimedOut,
                                },
                            },
                        },
                    },
                },
            },
        },
    ),
)
error: Failed to install cpython-3.14.0b3-linux-x86_64-gnu
  Caused by: Failed to extract archive: cpython-3.14.0b3-20250702-x86_64-unknown-linux-gnu-install_only_stripped.tar.gz
  Caused by: I/O operation failed during extraction
  Caused by: failed to unpack `/home/konsti/.local/share/uv/python/.temp/.tmpUQWZE4/python/include/python3.14/internal/pycore_runtime_init.h`
  Caused by: failed to unpack `python/include/python3.14/internal/pycore_runtime_init.h` into `/home/konsti/.local/share/uv/python/.temp/.tmpUQWZE4/python/include/python3.14/internal/pycore_runtime_init.h`
  Caused by: error decoding response body
  Caused by: request or response body error
  Caused by: operation timed out
```

---

_Referenced in [astral-sh/uv#14458](../../astral-sh/uv/pulls/14458.md) on 2025-07-04 09:26_

---

_Comment by @charliermarsh on 2025-07-04 11:20_

Did that _not_ get retried?

---

_Comment by @konstin on 2025-07-04 11:29_

The logs say this:

```
TRACE Considering retry of error: ExtractError("cpython-3.14.0b3-20250702-x86_64-unknown-linux-gnu-install_only_stripped.tar.gz", Io(Custom { kind: Other, error: TarError { desc: "failed to unpack `/home/konsti/.local/share/uv/python/.temp/.tmpqIjd9b/python/lib/python3.14/tkinter/__init__.py`", io: Custom { kind: Other, error: TarError { desc: "failed to unpack `python/lib/python3.14/tkinter/__init__.py` into `/home/konsti/.local/share/uv/python/.temp/.tmpqIjd9b/python/lib/python3.14/tkinter/__init__.py`", io: Custom { kind: Other, error: reqwest::Error { kind: Decode, source: reqwest::Error { kind: Body, source: TimedOut } } } } } } }))
TRACE Cannot retry IO error: not one of `ConnectionReset` or `UnexpectedEof`
TRACE Cannot retry IO error: not one of `ConnectionReset` or `UnexpectedEof`
TRACE Cannot retry IO error: not one of `ConnectionReset` or `UnexpectedEof`
TRACE Cannot retry error: not an IO error
```

Adding `|| io_err.kind() == io::ErrorKind::TimedOut` makes it retried:

```
error: Failed to install cpython-3.14.0b3-linux-x86_64-gnu
  Caused by: Failed to download https://github.com/astral-sh/python-build-standalone/releases/download/20250702/cpython-3.14.0b3%2B20250702-x86_64-unknown-linux-gnu-install_only_stripped.tar.gz
  Caused by: Request failed after 3 retries
  Caused by: error sending request for url (https://github.com/astral-sh/python-build-standalone/releases/download/20250702/cpython-3.14.0b3%2B20250702-x86_64-unknown-linux-gnu-install_only_stripped.tar.gz)
  Caused by: client error (Connect)
  Caused by: dns error
  Caused by: failed to lookup address information: Name or service not known
DEBUG Released lock at `/home/konsti/.local/share/uv/python/.lock`
```

idk if we need to retry that, I just wanted to test the logging.

---

_Closed by @charliermarsh on 2025-08-02 15:32_

---

_Comment by @charliermarsh on 2025-08-02 15:32_

Closing for now as we resolved the proximate symptom.

---
