---
number: 10609
title: Problem adding external indexes
type: issue
state: open
author: duducp
labels:
  - question
assignees: []
created_at: 2025-01-14T18:39:28Z
updated_at: 2025-02-07T12:00:35Z
url: https://github.com/astral-sh/uv/issues/10609
synced_at: 2026-01-07T12:31:15-06:00
---

# Problem adding external indexes

---

_Issue opened by @duducp on 2025-01-14 18:39_

I recently opened this issue https://github.com/astral-sh/uv/issues/10251 reporting a problem mapping an external pypi package. The problem itself was fixed, but I found a few other bugs related to it.

When executing the command `uv add mercadobitcoin-metrics --index mb=https://pypi.dev.my-domain.com/simple` the index data `[[tool.uv.index]]` and the package are correctly added to pyproject. The problem is in `uv.lock` and in the `export` command.

The `uv.lock` in turn is adding the AWS download URL along with the authentication query params. Example:

```
# uv.lock

[[package]]
name = "mercadobitcoin-metrics"
version = "1.0.4"
source = { registry = "https://pypi.dev.my-domain.com/simple" }
dependencies = [
    { name = "statsd" },
]
sdist = { url = "https://pypicloud-packages.s3.amazonaws.com/bf2b/mercadobitcoin-metrics/mercadobitcoin_metrics-1.0.4.tar.gz?AWSAccessKeyId=<key-id>&Signature=<signature>&Expires=1736860167" }


[package.metadata]
requires-dist = [
   ...
   { name = "mercadobitcoin-metrics", specifier = "==1.0.4", index = "https://pypi.dev.my-domain.com/simple" },
   ...
]
```

Note that in the **sdist** command I replaced the signature and accessKeyId.

In this case, after a certain time I can no longer install the lib because the AWS download URL will have expired. The correct thing would be to not map the AWS URL and every time you run the `uv sync --all-extras` command, it will download the lib "normally".

Another point I noticed is that when I run the command `uv export -q --no-dev --all-extras --format requirements-txt --output-file requirements.txt` it generates something similar to this:


```
# requirements.txt

-e .
mercadobitcoin-metrics==1.0.4
...
```

If I try to run the command `pip install -r requirements.txt` I get the following error:

```
Obtaining file:///Users/cdorneles/Projects/staking-utils (from -r requirements.txt (line 3))
ERROR: The editable requirement file:///Users/cdorneles/Projects/staking-utils (from -r requirements.txt (line 3)) cannot be installed when requiring hashes, because there is no single file to hash.
```

I don't know the reason for `-e .` but I believe it should be `--extra-index-url https://pypi.dev.mercadolitecoin.com.br/simple` instead, since there are dependencies on index in the project external. Another point is that the dependency is without the hash while the others have the hash. In this case it would look like this:

```
# requirements.txt

--extra-index-url https://pypi.dev.mercadolitecoin.com.br/simple
mercadobitcoin-metrics==1.0.4 \
    --hash=sha256:84008a41e51615a49fc9966191ff91509e3c40b939176e643fd50a5c2196b8f8 \
    --hash=sha256:bb413d29f5eea38f31dd4754dd7377d4465116fb207585f97bf925588687c1ba
...
```



---

_Comment by @charliermarsh on 2025-01-14 18:46_

> In this case, after a certain time I can no longer install the lib because the AWS download URL will have expired. The correct thing would be to not map the AWS URL and every time you run the uv sync --all-extras command, it will download the lib "normally".

Can you explain what you mean by this?

(The export behavior is all intended. We include the project itself. You can omit it if you want with `--no-emit-project`. It's entirely unrelated to `--extra-index-url`, which you should configure yourself -- it's intentionally not part of the export output.)

---

_Label `question` added by @charliermarsh on 2025-01-15 16:33_

---

_Comment by @thehesiod on 2025-01-22 05:45_

@charliermarsh I just ran into this as well.  This issue comes from pypi servers which allow you to host the binaries on s3 (like [pypicloud](https://github.com/stevearc/pypicloud)).  The way they work is that when you request a module download URL it creates an s3 [presigned url](https://docs.aws.amazon.com/AmazonS3/latest/userguide/ShareObjectPreSignedURL.html) which has a limited life (X hours).  After which that URL is invalid.  pipenv solves this by not storing the urls of the modules, and instead storing the name of the module, the index it belongs to, the version, and the allowed hashes.  Without uv resolving this we can't switch over :(

---

_Comment by @thehesiod on 2025-01-22 05:50_

btw the other issue is that sometimes the server doesn't return back a hash, so theoretically uv would have to calculate it locally

---

_Comment by @amchelmer on 2025-01-27 11:41_

Having the same issue here with a private Pypi index. The urls on the `uv.lock` file contain the access signature. So running `uv sync` immediately after `uv lock` works fine, but if you run `uv sync` with a few day old lockfile, I get 400 (bad request) responses for the packages on the private index.

Problematic package entry from lock file:

```
[[package]]
name = "my_private_package"
version = "1.4.0"
source = { registry = "http://10.0.15.171:8080/simple" }
dependencies = [
    { name = "kubernetes" },
]
sdist = { url = "https://storage.googleapis.com/pypi.gitlab.example.com/5437/my_private_package/my_private_package-1.4.0.tar.gz?Expires=1737980596&GoogleAccessId=pypi-server%40example.iam.gserviceaccount.com&Signature=XYZ" }
wheels = [
    { url = "https://storage.googleapis.com/pypi.gitlab.example.com/0430/my_private_package/my_private_package-1.4.0-py3-none-any.whl?Expires=1737980596&GoogleAccessId=pypi-server%example.iam.gserviceaccount.com&Signature=XYZ" },
]
```

---

_Comment by @carlosdorneles-mb on 2025-02-07 12:00_

@charliermarsh  is there a possible solution for the uv.lock file that is recording the pre-signed key from Amazon? Since the key expires, this causes problems when trying to install dependencies in the future.

---
