---
number: 6640
title: "Don't enable pre-releases when `!=` is used with pre-release specifier"
type: issue
state: closed
author: Czaki
labels:
  - good first issue
  - help wanted
  - question
  - compatibility
assignees: []
created_at: 2024-08-26T09:03:21Z
updated_at: 2024-10-21T18:25:25Z
url: https://github.com/astral-sh/uv/issues/6640
synced_at: 2026-01-07T12:31:14-06:00
---

# Don't enable pre-releases when `!=` is used with pre-release specifier

---

_Issue opened by @Czaki on 2024-08-26 09:03_

In napari project, we use uv to provide constraints files in automatic jobs 

https://github.com/napari/napari/blob/35a99366f2a8ef5bcdbd6e1f874f5ca2a7572582/.github/workflows/upgrade_test_constraints.yml

In the last run, the output contained bumping zarr to prerelease version

![obraz](https://github.com/user-attachments/assets/c6865750-db80-431b-948f-4470e5c8a72b)

even if we specify only lower bound constraint without any prerelease version: https://github.com/napari/napari/blob/35a99366f2a8ef5bcdbd6e1f874f5ca2a7572582/pyproject.toml#L143

The whole command used for compilation is:

```
uv pip compile --python-version 3.12 --output-file napari_repo/resources/constraints/constraints_py3.12.txt napari_repo/pyproject.toml napari_repo/resources/constraints/version_denylist.txt --extra pyqt5 --extra pyqt6 --extra pyside2 --extra pyside6_experimental --extra testing --extra testing_extra --extra optional
```

Commit showing problem is here [napari/napari@`c81b0d0` (#7212)](https://github.com/napari/napari/pull/7212/commits/c81b0d029abcf654897e0f94f0ed8cd98b3dcb72) 
And problematic line here [napari/napari@`c81b0d0` (#7212)](https://github.com/napari/napari/pull/7212/commits/c81b0d029abcf654897e0f94f0ed8cd98b3dcb72#diff-9a3fb85151bc0704510dd99c7b9ada03b52f6f0f99a44bb34259af2089e2dc8bL549)

---

_Referenced in [napari/napari#7212](../../napari/napari/pulls/7212.md) on 2024-08-26 11:19_

---

_Comment by @charliermarsh on 2024-08-26 12:16_

Thanks, we'll take a look!

---

_Assigned to @charliermarsh by @charliermarsh on 2024-08-26 12:30_

---

_Label `bug` added by @charliermarsh on 2024-08-26 12:30_

---

_Comment by @charliermarsh on 2024-08-26 12:32_

So, I think the problem is that `zarr!=3.0.0a0` is causing uv to think that pre-releases are acceptable for `zarr`, so it's then picking the newest version of `zarr`, which is `3.0.0a1`.

---

_Comment by @charliermarsh on 2024-08-26 12:33_

If I remove that line from `napari_repo/resources/constraints/version_denylist.txt`, it works as expected... (Also make sure you remove `resources/constraints/constraints_py3.12.txt` if it exists, since if _that_ contains a pre-release, we'll continue using that pinned version.)

---

_Comment by @Czaki on 2024-08-26 14:22_

> So, I think the problem is that `zarr!=3.0.0a0` is causing uv to think that pre-releases are acceptable for `zarr`, so it's then picking the newest version of `zarr`, which is `3.0.0a1`.

oh. We are using this file also in pre-release tests. 

I there, any option to provide constraints, but without allowing to enable pre-release? to have a single source of problematic versions? 

---

_Comment by @zanieb on 2024-08-26 17:41_

Does `--prereleases disallow` work? The default is `if-necessary-or-explicit` and these are "explicit" specifiers.

https://docs.astral.sh/uv/reference/settings/#prerelease

---

_Comment by @charliermarsh on 2024-08-26 17:58_

Yeah I think `--prerelease disallow` (or `UV_PRERELEASE`, or in your `pyproject.toml`) would be the recommended solution.

---

_Label `bug` removed by @charliermarsh on 2024-08-26 17:58_

---

_Label `question` added by @charliermarsh on 2024-08-26 17:58_

---

_Comment by @notatallshaw on 2024-08-26 18:44_

> So, I think the problem is that `zarr!=3.0.0a0` is causing uv to think that pre-releases are acceptable for `zarr`, so it's then picking the newest version of `zarr`, which is `3.0.0a1`.

FYI, the intent of the spec author is that `!=` should never imply a pre-release. 

I have a PR for packaging to match uv's behavior on `<` and `>`, which is part of the spec, but also explicitly test `!=` to not imply a pre-release: https://github.com/pypa/packaging/pull/794

---

_Comment by @charliermarsh on 2024-08-26 18:45_

Interesting, ok, we could change that. What do you think @zanieb? Seems reasonable to me.

---

_Comment by @zanieb on 2024-08-26 18:46_

I think that's reasonable too, but low priority to change.

---

_Label `compatibility` added by @zanieb on 2024-08-26 18:46_

---

_Label `help wanted` added by @charliermarsh on 2024-08-26 18:46_

---

_Unassigned @charliermarsh by @charliermarsh on 2024-08-26 18:46_

---

_Renamed from "`uv pip compile` result in prerelease version of package " to "Don't enable pre-releases when `!=` is used with pre-release specifier" by @charliermarsh on 2024-08-26 18:46_

---

_Comment by @charliermarsh on 2024-08-26 18:47_

Retitled the issue and added `help-wanted`.

---

_Referenced in [pypa/packaging#794](../../pypa/packaging/pulls/794.md) on 2024-08-26 23:45_

---

_Label `good first issue` added by @charliermarsh on 2024-08-27 02:08_

---

_Referenced in [napari/napari#7217](../../napari/napari/pulls/7217.md) on 2024-08-31 11:41_

---

_Referenced in [napari/napari#7305](../../napari/napari/pulls/7305.md) on 2024-09-30 08:24_

---

_Referenced in [astral-sh/uv#7974](../../astral-sh/uv/pulls/7974.md) on 2024-10-07 15:08_

---

_Closed by @charliermarsh on 2024-10-21 18:25_

---
