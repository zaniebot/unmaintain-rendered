---
number: 15984
title: "`uv tool install` with flash-attn + aug build deps fails while `uv run` succeeds"
type: issue
state: open
author: yondonfu
labels:
  - bug
  - needs-design
assignees: []
created_at: 2025-09-22T15:29:18Z
updated_at: 2025-09-22T20:22:49Z
url: https://github.com/astral-sh/uv/issues/15984
synced_at: 2026-01-07T12:31:16-06:00
---

# `uv tool install` with flash-attn + aug build deps fails while `uv run` succeeds

---

_Issue opened by @yondonfu on 2025-09-22 15:29_

### Summary

I'm following the docs on [augmenting build deps](https://docs.astral.sh/uv/concepts/projects/config/#augmenting-build-dependencies) to include flash-attn as a dep.

In my [minimal repro project](https://github.com/yondonfu/flash-attn-repro/tree/main), I have this as my `pyproject.toml`:

```
[project]
name = "flash-attn-repro"
version = "0.1.0"
description = "Add your description here"
readme = "README.md"
requires-python = ">=3.10.12"
dependencies = [
  "torch==2.8.0",
  "flash-attn==2.8.3; sys_platform == 'linux' or sys_platform == 'win32'",
]

[tool.uv.extra-build-dependencies]
flash-attn = [{ requirement = "torch", match-runtime = true, marker = "sys_platform == 'linux' or sys_platform == 'win32'" }]

[tool.uv.extra-build-variables]
flash-attn = { FLASH_ATTENTION_SKIP_CUDA_BUILD = "TRUE" }

[tool.uv.sources]
torch = [
    { index = "pytorch-cu128", marker = "sys_platform == 'linux' or sys_platform == 'win32'" },
]
torchvision = [
    { index = "pytorch-cu128", marker = "sys_platform == 'linux' or sys_platform == 'win32'" },
]

[[tool.uv.index]]
name = "pytorch-cu128"
url = "https://download.pytorch.org/whl/cu128"
explicit = true

[project.scripts]
flash-attn-repro = "flash_attn_repro.main:main"
```

If I run `uv run -m flash_attn_repro.main`, everything installs and runs fine:

```
Using CPython 3.10.12 interpreter at: /usr/bin/python3.10
Creating virtual environment at: .venv
warning: The `extra-build-dependencies` option is experimental and may change without warning. Pass `--preview-features extra-build-dependencies` to disable this warning.
░░░░░░░░░░░░░░░░░░░░ [0/27] Installing wheels...                                                                                                                                                                     
warning: Failed to hardlink files; falling back to full copy. This may lead to degraded performance.
         If the cache and target directories are on different filesystems, hardlinking may not be supported.
         If this is intentional, set `export UV_LINK_MODE=copy` or use `--link-mode=copy` to suppress this warning.
Installed 27 packages in 5.25s
Hello from flash-attn-repro!
```

However, if I run `uv tool install --python 3.10.12 .`, I get this:

```
Resolved 28 packages in 558ms
  × Failed to build `flash-attn==2.8.3`
  ├─▶ The build backend returned an error
  ╰─▶ Call to `setuptools.build_meta:__legacy__.build_wheel` failed (exit status: 1)

      [stderr]
      Traceback (most recent call last):
        File "<string>", line 14, in <module>
        File "/root/.cache/uv/builds-v0/.tmpDR4kI5/lib/python3.10/site-packages/setuptools/build_meta.py", line 331, in get_requires_for_build_wheel
          return self._get_build_requires(config_settings, requirements=[])
        File "/root/.cache/uv/builds-v0/.tmpDR4kI5/lib/python3.10/site-packages/setuptools/build_meta.py", line 301, in _get_build_requires
          self.run_setup()
        File "/root/.cache/uv/builds-v0/.tmpDR4kI5/lib/python3.10/site-packages/setuptools/build_meta.py", line 512, in run_setup
          super().run_setup(setup_script=setup_script)
        File "/root/.cache/uv/builds-v0/.tmpDR4kI5/lib/python3.10/site-packages/setuptools/build_meta.py", line 317, in run_setup
          exec(code, locals())
        File "<string>", line 22, in <module>
      ModuleNotFoundError: No module named 'torch'

      hint: This error likely indicates that `flash-attn@2.8.3` depends on `torch`, but doesn't declare it as a build dependency. If `flash-attn` is a first-party package, consider adding `torch` to its
      `build-system.requires`. Otherwise, either add it to your `pyproject.toml` under:

      [tool.uv.extra-build-dependencies]
      flash-attn = ["torch"]

      or `uv pip install torch` into the environment and re-run with `--no-build-isolation`.
  help: `flash-attn` (v2.8.3) was included because `flash-attn-repro` (v0.1.0) depends on `flash-attn`
```

I'm able to workaround this by specifying a specific prebuilt wheel to use for flash-attn by adding this under `[tool.uv.sources]` in the `pyproject.toml` file:

```
flash-attn = [
    # Prebuilt Linux wheels from https://github.com/Dao-AILab/flash-attention
    { url = "https://github.com/Dao-AILab/flash-attention/releases/download/v2.8.3/flash_attn-2.8.3+cu12torch2.8cxx11abiFALSE-cp310-cp310-linux_x86_64.whl", marker = "sys_platform == 'linux'" },
]
```

Then, when I run `uv tool install --python 3.10.12 .` again everything installs and runs fine:

```
Resolved 28 packages in 1m 56s
      Built flash-attn-repro @ file:///workspace/flash-attn-repro
Prepared 2 packages in 2.72s
Uninstalled 1 package in 1ms
Installed 3 packages in 8ms
 + einops==0.8.1
 + flash-attn==2.8.3+cu12torch2.8cxx11abifalse (from https://github.com/Dao-AILab/flash-attention/releases/download/v2.8.3/flash_attn-2.8.3+cu12torch2.8cxx11abiFALSE-cp310-cp310-linux_x86_64.whl)
 ~ flash-attn-repro==0.1.0 (from file:///workspace/flash-attn-repro)
Installed 1 executable: flash-attn-repro
```

And after running `flash-attn-repro `:

```
Hello from flash-attn-repro!
```

### Platform

Linux 6.8.0-65-generic x86_64 GNU/Linux

### Version

uv 0.8.19

### Python version

Python 3.10.12

---

_Label `bug` added by @yondonfu on 2025-09-22 15:29_

---

_Comment by @zanieb on 2025-09-22 16:07_

I don't think we read those fields when doing `uv tool install`, we just read the metadata that is not-specific to uv.

---

_Comment by @yondonfu on 2025-09-22 18:42_

@zanieb Ah got it. Is there a recommended best practice for building tools that depend on torch, flash-attn deps which have more complex build processes? Or are the uv specific enhancements for these types of build processes only planned for `uv run` right now? For context, I'm interested in doing a `uv tool install ...` that handles the torch, flash-attn installation the same way that `uv run` would.

---

_Comment by @zanieb on 2025-09-22 20:22_

I think the long-term solution would be to have `flash-attn` itself declare this metadata, as explored in https://github.com/astral-sh/uv/pull/15568

I'm not sure I have a good recommendation for you in the meantime. I think the use-case makes a lot of sense, we're just going to have to figure out a way to do it without adding a bunch of complexity. I think I'm broadly supportive of `uv tool install` reading uv settings from source trees (e.g., local directories or Git repositories), but I'm not sure what problems it will cause.

---

_Label `needs-design` added by @zanieb on 2025-09-22 20:22_

---
