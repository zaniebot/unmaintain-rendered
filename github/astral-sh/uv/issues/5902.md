---
number: 5902
title: "`uv lock --locked` false positive"
type: issue
state: closed
author: tpgillam
labels:
  - bug
  - preview
assignees: []
created_at: 2024-08-08T08:57:08Z
updated_at: 2024-08-12T14:31:09Z
url: https://github.com/astral-sh/uv/issues/5902
synced_at: 2026-01-07T12:31:14-06:00
---

# `uv lock --locked` false positive

---

_Issue opened by @tpgillam on 2024-08-08 08:57_

Using uv `0.2.34`. A potentially similar issue to #5851 

Consider the following `pyproject.toml`:

```toml
[project]
name = "moo"
version = "0.1.0"
dependencies = ["pyelmer ~=1.2", "pymongo[srv] ~=4.3.3"]
requires-python = ">=3.11"
```

I then can run the following in an otherwise empty directory (`rm uv.lock` just lets me re-run quickly):
```bash
rm uv.lock && uv lock && cp uv.lock ref_uv.lock && uv lock && diff ref_uv.lock uv.lock && uv lock --locked
```

and get the output:
```
warning: `uv lock` is experimental and may change without warning
Using Python 3.11.9
Resolved 21 packages in 31ms
warning: `uv lock` is experimental and may change without warning
Using Python 3.11.9
Resolved 21 packages in 33ms
warning: `uv lock` is experimental and may change without warning
Using Python 3.11.9
Resolved 21 packages in 35ms
error: The lockfile at `uv.lock` needs to be updated, but `--locked` was provided. To update the lockfile, run `uv lock`.
```

So `uv.lock` wouldn't have actually changed, but `uv` fails because it think it would have done.

A few assorted things I've noticed:

- The `srv` extra in pymongo exists in 4.3.3, but not in the latest version. In 4.3.3 it's actually [an empty set of pacakges](https://github.com/mongodb/mongo-python-driver/blob/3d032768a0c617e4c594cb3f971df1cd06b3e0d4/setup.py#L289). In the `uv.lock`, we never actually get an `extra = "srv"` entry under pymongo - presumably because it finds that its empty. But possibly this is undesired.

- If I remove the `pyelmer` dependency then there isn't a problem. In this simpler case, the `uv.lock` does not contain an `environment-markers` section.

- If I remove the `[srv]` extra from pymongo there also isn't a problem.


- If I replace the `[srv]` extra with `[encryption]`, which is a non-empty set, then we have a slightly different scenario that doesn't fail per-se, but also seems fishy:

```bash
rm uv.lock && uv lock && cp uv.lock ref_uv.lock && uv lock && diff ref_uv.lock uv.lock || uv lock --locked
```

```
warning: `uv lock` is experimental and may change without warning
Using Python 3.11.9
Resolved 38 packages in 37ms
warning: `uv lock` is experimental and may change without warning
Using Python 3.11.9
Resolved 38 packages in 15ms
43c43
<     { name = "urllib3" },
---
>     { name = "urllib3", marker = "python_version == '3.11' or python_version >= '3.12' or (python_version < '3.12' and (python_version < '3.11' or python_version > '3.11'))" },
warning: `uv lock` is experimental and may change without warning
Using Python 3.11.9
Resolved 38 packages in 14ms
```

namely that the second call to `uv lock` does actually now change the lock file. This is probably a separate issue, and maybe not really a problem (I'm not sure how strong an idempotency guarantee on `uv lock` there is?)

---

_Label `preview` added by @konstin on 2024-08-08 08:58_

---

_Label `bug` added by @konstin on 2024-08-08 08:59_

---

_Assigned to @charliermarsh by @charliermarsh on 2024-08-08 12:20_

---

_Unassigned @charliermarsh by @charliermarsh on 2024-08-08 12:21_

---

_Comment by @charliermarsh on 2024-08-08 12:21_

@konstin -- Do you expect this one to be fixed either by your work or @ibraheemdev's?

---

_Comment by @konstin on 2024-08-08 12:45_

Yes, the new markers will probably fix this

---

_Assigned to @ibraheemdev by @charliermarsh on 2024-08-09 14:25_

---

_Comment by @ibraheemdev on 2024-08-12 12:24_

After https://github.com/astral-sh/uv/pull/5898, `uv lock` actually produces an invalid lockfile:
```
[[package]]
name = "moo"
version = "0.1.0"
source = { editable = "." }
dependencies = [
    { name = "pyelmer" },
    { name = "pymongo" },
    { name = "pymongo" },
]
```

Investigating further.

---

_Comment by @charliermarsh on 2024-08-12 12:55_

I think this may need one of Andrew’s changes…? Is that plausible?

---

_Comment by @ibraheemdev on 2024-08-12 13:35_

I think there's a simpler issue here.

---

_Referenced in [astral-sh/uv#6035](../../astral-sh/uv/pulls/6035.md) on 2024-08-12 13:53_

---

_Closed by @ibraheemdev on 2024-08-12 14:31_

---

_Closed by @ibraheemdev on 2024-08-12 14:31_

---
