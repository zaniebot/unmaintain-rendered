---
number: 16034
title: "Windows: uv run hg fails with abort: failed to load Python DLL python312.dll while uv run python -m mercurial works"
type: issue
state: closed
author: Stefanhg
labels:
  - bug
  - external
assignees: []
created_at: 2025-09-26T07:12:58Z
updated_at: 2025-12-16T16:00:47Z
url: https://github.com/astral-sh/uv/issues/16034
synced_at: 2026-01-07T12:31:16-06:00
---

# Windows: uv run hg fails with abort: failed to load Python DLL python312.dll while uv run python -m mercurial works

---

_Issue opened by @Stefanhg on 2025-09-26 07:12_

### Summary

Hello, after a long debug session with ChatGpt I have hopefully been able to narrow down the root cause of the issue. Note i made ChatGpt generate bug report so if something is wrong or missing please let me know!

**Summary**

On Windows 11, installing Mercurial into a uv venv results in an hg.exe that immediately aborts:

abort: failed to load Python DLL python312.dll


The same environment runs Mercurial fine when invoked as a module:

uv run python -m mercurial --version   # works
uv run hg --version                    # fails


This does not reproduce in a “normal” venv on other machines.

**Environment**

Python in venv: 3.12.11 (managed by uv)
Native Python: 3.10.6

Mercurial: 7.0.2 (from uv logs)

Other packages present: distlib==0.3.8, setuptools==80.9.0, wheel==0.45.1

Index: internal mirror of PyPI (<redacted>)

**Steps to reproduce (cmd.exe)**
:: in a new empty directory
uv venv --python 3.12
uv pip install mercurial

uv run python -m mercurial --version    :: ✅ works
uv -v -v run hg --version               :: ❌ abort: failed to load Python DLL python312.dll

**Actual result (key log lines)**
DEBUG Using Python 3.12.11 interpreter at: D:\temp\test_uv\.venv\Scripts\python.exe
DEBUG Running `hg --version`
abort: failed to load Python DLL python312.dll
DEBUG Command exited with code: 255


where (from the same shell) shows a global TortoiseHg present, but uv’s log clearly indicates it runs the venv copy:

where hg
C:\Program Files\TortoiseHg\hg.exe

where hg.exe
C:\Program Files\TortoiseHg\hg.exe


Venv Scripts contents include both small hg.exe and a text hg:

... 
1,516  hg
14,336 hg.exe
257,536 python.exe
245,760 pythonw.exe
41,443 wheel.exe
...

**Diagnostics**

The venv hg.exe contains strings typical of a frozen Windows bootstrapper, not a distlib console-script wrapper:

\hg-python\python312.dll
failed to load private Python DLL python312.dll
Py_SetPythonHome
Py_Main
python313.dll


A ProcMon trace shows DLL lookup attempts against unrelated PATH entries (e.g., C:\Program Files (x86)\Nmap\python313.dll → NAME NOT FOUND) before aborting — suggesting the exe calls LoadLibrary("python3xx.dll") without a full path and relies on the Windows loader search order.

Importantly, invoking as a module always works:

uv run python -m mercurial --version   :: OK

**Expected**

uv run hg … should use the venv interpreter (same behavior as python -m mercurial), not rely on a PE bootstrapper that looks for python3xx.dll via PATH.

**Workarounds tried (uv-only)**

Prepending the real Python …\Python312 and …\DLLs to PATH → still fails.

Removing third-party PATH segments for the session → still fails.

uv cache clean + reinstall (including --no-binary mercurial --no-cache) → still fails on this machine.

Replacing hg.exe with a .cmd that runs python -m mercurial → works (manual per-venv workaround).

**Probable cause (from reading uv’s behavior & docs)**

On Windows, uv copies executables provided by a wheel into the venv Scripts directory; it does not regenerate or wrap arbitrary .exe launchers. Special handling exists for legacy script files (.cmd/.bat/.ps1), but not for PE bootstrappers.

Mercurial’s Windows wheel ships a custom hg.exe bootstrapper that tries to LoadLibrary("python3xx.dll"). When that DLL isn’t co-located, the OS loader searches PATH; if it can’t find a suitable DLL (or finds the wrong one), the exe aborts before Python starts.

Because uv installed (copied) that PE into .\.venv\Scripts, uv run hg executes it directly, triggering the early abort. Meanwhile uv run python -m mercurial bypasses the exe and succeeds.

**Proposed changes / requests**

Prefer console-script entry points on Windows (when available):
If a wheel provides both entry points and a same-name .exe, generate a standard console-script wrapper targeting the venv’s python.exe, and either do not install the PE or make the wrapper take precedence.

Guardrail for PE bootstrappers:
When installing a .exe into Scripts, detect likely Python bootstrapper patterns (embedded python3..dll, Py_SetPythonHome, etc.) and:

emit a warning that the exe depends on PATH/DLL search, and/or

auto-generate a sibling *.cmd that runs python -m <module> and make uv run prefer that wrapper.

**Diagnostics:**
Enhance uv -vv run to explicitly state whether the resolved “hg” is a copied PE or a generated console script, and print the full file path being executed. This would help users and maintainers triage PATH/DLL loader issues quickly.

**Documentation note:**
Call out that wheels shipping Windows PE launchers may be sensitive to PATH/DLL layout; suggest python -m … or a uv option (e.g., prefer-console-scripts=true) as a mitigation.

**Additional data available on request**

Full uv -v -v run hg --version output (included above).

strings/hex dump of .\.venv\Scripts\hg.exe (shows python3xx.dll references).

Minimal ProcMon trace demonstrating the DLL lookup attempts.

uv.lock and directory listing of .\.venv\Scripts.

uv -v -v run hg --version
DEBUG Using Python 3.12.11 interpreter at: D:\temp\test_uv\.venv\Scripts\python.exe
DEBUG Running `hg --version`
abort: failed to load Python DLL python312.dll
DEBUG Command exited with code: 255

where hg
C:\Program Files\TortoiseHg\hg.exe

where hg.exe
C:\Program Files\TortoiseHg\hg.exe

 Directory of D:\temp\test_uv\.venv\Scripts
...
25/09/2025  17.16           1,516  hg
25/09/2025  17.01          14,336  hg.exe
08/08/2025  08.19         257,536  python.exe
08/08/2025  08.19         245,760  pythonw.exe
25/09/2025  17.16          41,443  wheel.exe
...

### Platform

Windows 11 Enterprise 10.0.26100 (Build 26100)

### Version

uv 0.8.22 (ade2bdbd2 2025-09-23)

### Python version

Python 3.10.6

---

_Label `bug` added by @Stefanhg on 2025-09-26 07:12_

---

_Comment by @konstin on 2025-09-26 13:04_

This seems to be an upstream bug: https://foss.heptapod.net/mercurial/mercurial-devel/-/issues/6635.

Probably the same as #13408.

---

_Label `external` added by @konstin on 2025-09-26 13:04_

---

_Comment by @Stefanhg on 2025-09-29 07:02_

@konstin Thank you for this, I was searching around with no luck to find anything that relates.
I'll close the issue here and hope mercurial resolves it, but seems like a issue that will never get resolved.

---

_Closed by @Stefanhg on 2025-09-29 07:02_

---

_Comment by @misery on 2025-12-16 15:06_

Is it really a mercurial problem? If we add that "work-around" to the `.dll` file it works.
```
uv venv $env:VIRTUAL_ENV --python 3.12
'& "$env:VIRTUAL_ENV/Scripts/activate.ps1"'
uv pip install mercurial==7.1.2
$env:PATH = "$env:PATH;$env:VIRTUAL_ENV/Lib/site-packages"
hg clone ...
```

---

_Comment by @konstin on 2025-12-16 16:00_

Yes, this only happens with mercurial and is tracked in https://foss.heptapod.net/mercurial/mercurial-devel/-/issues/6635

---
