---
number: 3518
title: Invalidate cache entries for same-version packages that have newer timestamps when also found externally (via --find-links)
type: issue
state: open
author: charlesnicholson
labels:
  - bug
  - cache
assignees: []
created_at: 2024-05-10T21:12:01Z
updated_at: 2025-01-07T19:21:35Z
url: https://github.com/astral-sh/uv/issues/3518
synced_at: 2026-01-07T12:31:14-06:00
---

# Invalidate cache entries for same-version packages that have newer timestamps when also found externally (via --find-links)

---

_Issue opened by @charlesnicholson on 2024-05-10 21:12_

Maybe this is too far afield for `uv`, but I have an interesting case-

During development, we don't change the version of our packages, so we'll create distribution packages that look like, say, `company.foo-0.0.1-py3-none-any.whl`. Our CI system sends these to a test runner computer, which uses `uv` to prepare a venv and install these wheels. These wheels go into a subdirectory called `wheels`, and then we run:

```
uv pip install -q --upgrade -p venv/bin/python company.foo-0.0.1-py3-none-any.whl --find-links=wheels
```

The problem comes when package `foo` depends on `bar`- `company.bar-0.0.1-py3-none-any.whl` exists in `wheels`, but an "older" version (also at 0.0.1) already exists in the `uv` cache, and that one is chosen. But, the PR we're testing might also have important improvements to `bar`! In that case, our tests fail because `uv` found and installed the old `bar` package from its cache.

One solution would be to bump the version numbers any time we make any change to a package, but it would be simpler if we could say "Hey, `uv`, please prefer whatever you find in the `--find-links` location to the cache, but if you want, feel free to update the cache with what you found afterwards." 

That way big expensive third-party wheels would live in the cache for `uv`, but our first-party wheels would always be preferred.

Sorry if this is too esoteric of a use case to be interesting, or if there's another more elegant way to solve this; my current workaround is just to pass `-n` to `uv` but of course that slows everything down a ton. I'd happily just delete all of our first-party packages from the uv cache before running anything instead, if that's a better option, but then it would be really nice to have wildcard support: `uv cache clear "company\.*"` or something.

Anyway, thanks for reading!

---

_Comment by @charliermarsh on 2024-05-10 21:21_

This does make sense... I'm curious if @konstin has thoughts on how we could support it.

---

_Label `needs-design` added by @charliermarsh on 2024-05-10 21:22_

---

_Comment by @zanieb on 2024-05-11 02:10_

From an interface perspective... adding a `--wheel-strategy <kind>` to specify this makes sense to me? It could subsume the `--no-binary` flag (although we wouldn't remove it for compatibility).

---

_Comment by @charliermarsh on 2024-05-11 02:13_

Personally I see this more about determining index priority (similar to our index strategy flag) rather than about wheels vs. source distributions. I assume that if this were set, youâ€™d also want source distributions in the find-links to take precedence over wheels in the index, since the intent is that any local distributions should be preferred.

---

_Comment by @zanieb on 2024-05-11 02:16_

Fair that makes sense to me. Why is this not just an index strategy like "prefer-find-links" then?

---

_Comment by @charlesnicholson on 2024-05-12 17:07_

Related: it would be nice if there was a way to tell `uv` never to cache specific packages; in my case it would be `company.*`; they just take up space, they're unstable development versions in flux, and it's always an error for `uv` to ever pick them for anything.

(This might be 3 issues: index preference, wildcard cache deletions, and "don't ever cache" this; LMK if there's enough interest to separate issues for the latter two)

---

_Comment by @konstin on 2024-05-13 08:46_

I think it would make sense to check the timestamp of `company.bar-0.0.1-py3-none-any.whl` and invalidate the cache accordingly, i think this should handle the use case?

---

_Comment by @charlesnicholson on 2024-05-13 13:19_

Also, I didn't investigate this deeply but this only started happening after moving to `uv` after ~1.5 years of this strategy working with vanilla pip, so it's possible that pip has something in place for this?

This is just an observation and not a claim; but I'm guessing we'd have seen this error at least a few times pre-uv.

---

_Comment by @charlesnicholson on 2024-06-18 00:22_

Hello! Just checking in on this issue and seeing if anyone has any appetite for looking at it :) 

This issue is still flagged as "needs-design" but @konstin's suggestion sounded pretty reasonable from my POV as a user. Are there other blockers / prioritization issues that keep this one from getting attention? The divergence from pip makes it seem like it's possibly a regression from pip's behavior, in addition to just being a nice-to-have for me...

---

_Comment by @zanieb on 2024-06-18 00:37_

That seems pretty reasonable to me as well. It's just a matter of prioritization, I think. I'm happy to review a change.

---

_Label `needs-design` removed by @zanieb on 2024-06-18 00:37_

---

_Label `bug` added by @zanieb on 2024-06-18 00:37_

---

_Label `cache` added by @zanieb on 2024-06-18 00:37_

---

_Comment by @kidrahahjo on 2024-06-18 02:14_

Hi from what I understood from this discussion, I tried to replicate this issue where my package relied on a specific version of `protobuf`. While trying to install my package from a wheel, I also placed the `protobuf` wheel in the same directory but uv ignored that. It either got installed from pypi, or from the cache. However we want to provide an API to prefer the links. Please feel free to correct me if I misunderstood.

Referring to what the maintainers suggested in terms of having a concrete API, would it make sense to have a flag called `--resolution-strategy` where it could take the following values:

1. `prefer-cache` (default) -> Check in cache and install from there instead (for backwards compatibility), fall back to indexes
2. `prefer-links` -> Check for links, fall back to `prefer-cache`.
3. `links-only` -> Don't try to resolve from indexes or caches.

We'd invalidate the cache in case of timestamp mismatch.

If it seems like a good first issue, I am happy to take this up.

---

_Comment by @charlesnicholson on 2024-06-18 23:11_

@kidrahahjo I'm just a user, but @konstin's approach seemed like it didn't need any new flags or anything; resolving would simply check for the existence of a distribution package file in the `--find-links` directory, and if it's there at the same version as the venv source, would simply fall back to a timestamp check. If the distribution package file is newer, it would be preferred. If it's <= the venv timestamp, then the venv package is fine.

(I don't have a strong opinion, just here to observe that your writeup doesn't seem to incorporate what @konstin wrote)

---

_Renamed from "Option for "Prefer wheels from "--find-links" directory to whatever's in the cache"?" to "uv should use timestamps as same-version tiebreakers between packages from the uv cache and from --find-links directories" by @charlesnicholson on 2024-09-27 20:37_

---

_Comment by @charlesnicholson on 2024-09-27 20:37_

(renamed bug issue to match @konstin's comment)

---

_Renamed from "uv should use timestamps as same-version tiebreakers between packages from the uv cache and from --find-links directories" to "Use timestamps as same-version tiebreakers between cache packages and  --find-links packages" by @charlesnicholson on 2024-12-16 03:19_

---

_Renamed from "Use timestamps as same-version tiebreakers between cache packages and  --find-links packages" to "Invalidate cache entries for same-version packages that have newer timestamps when also found externally (via --find-links)" by @charlesnicholson on 2025-01-07 19:21_

---

_Referenced in [astral-sh/uv#5731](../../astral-sh/uv/issues/5731.md) on 2025-06-20 15:21_

---
