---
number: 16719
title: "`uv add` also performs unprompted (and unrelated) toml formatting"
type: issue
state: closed
author: neutrinoceros
labels:
  - bug
assignees: []
created_at: 2025-11-13T11:53:24Z
updated_at: 2025-11-20T19:15:28Z
url: https://github.com/astral-sh/uv/issues/16719
synced_at: 2026-01-07T12:31:16-06:00
---

# `uv add` also performs unprompted (and unrelated) toml formatting

---

_Issue opened by @neutrinoceros on 2025-11-13 11:53_

### Summary

This is one ((or possibly two) minor) bug(s) I frequently encounter when working on `astropy`, reproduced here with a minimal example.
Both of these are small sources of friction in my workflow, but I hit them frequently enough that I decided to report them any way.

Starting from the following `pyproject.toml` contents:
```toml
[project]
name = "test-uv"
version = "0.1.0"
requires-python = ">=3.10"
dependencies = [
    "attrs>=25.4.0",     # perhaps weirdly comment formatted comment
]

[build-system]
requires = ["uv_build>=0.9.9,<0.10.0"]
build-backend = "uv_build"

[tool.ruff]
lint.extend-select = []
exclude = []
lint.ignore = []
```

And using, for instance
```
uv add pytest
```

produces the following patch
```patch
diff --git a/pyproject.toml b/pyproject.toml
index a2b9bad..82d55d1 100644
--- a/pyproject.toml
+++ b/pyproject.toml
@@ -3,7 +3,8 @@ name = "test-uv"
 version = "0.1.0"
 requires-python = ">=3.10"
 dependencies = [
-    "attrs>=25.4.0",     # perhaps weirdly comment formatted comment
+    "attrs>=25.4.0", # perhaps weirdly comment formatted comment
+    "pytest>=9.0.1",
 ]
 
 [build-system]
@@ -12,5 +13,5 @@ build-backend = "uv_build"
 
 [tool.ruff]
 lint.extend-select = []
-exclude = []
 lint.ignore = []
+exclude = []
```

The problems should be evident, but let's list them anyway:
- a comment from an unrelated (albeit adjadent) line is moved
- a completely unrelated table (here, `tool.ruff`) is re-formatted

At least no actual data is lost, but having larger than strictly needed footprints means that I can't just commit the result of a `uv add` invoke, and must resort to manual editing to only commit the bits I want.

### Platform

Darwin 24.6.0 arm64

### Version

uv 0.9.9 (4fac4cb7e 2025-11-12)

### Python version

Python 3.14.0 (shouldn't be relevant though)

---

_Label `bug` added by @neutrinoceros on 2025-11-13 11:53_

---

_Comment by @konstin on 2025-11-13 12:00_

The first change is a bug in how we handle comments, we should fix that in uv.

The second change is this upstream bug: https://github.com/toml-rs/toml/issues/163



---

_Referenced in [astropy/astropy#18905](../../astropy/astropy/pulls/18905.md) on 2025-11-13 16:00_

---

_Referenced in [astral-sh/uv#16734](../../astral-sh/uv/pulls/16734.md) on 2025-11-14 08:47_

---

_Closed by @konstin on 2025-11-20 19:15_

---
