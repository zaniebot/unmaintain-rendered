---
number: 14495
title: How to most efficiently use uv in a Gitlab CI environment?
type: issue
state: closed
author: alechouse97
labels:
  - question
assignees: []
created_at: 2025-07-07T20:41:09Z
updated_at: 2025-07-08T17:39:33Z
url: https://github.com/astral-sh/uv/issues/14495
synced_at: 2026-01-07T12:31:16-06:00
---

# How to most efficiently use uv in a Gitlab CI environment?

---

_Issue opened by @alechouse97 on 2025-07-07 20:41_

### Question

I work on a project that is using uv in a Gitlab CI/CD environment. We test across a number of python versions and have a separate stage run for each version. However, the dependency download step for each stage takes longer than the running of the tests themselves, so the full pipeline spends the majority of its time just downloading dependencies.

I have tried creating a stage that installs the package (on one python version), caches the uv cache directory, and then has all the test stages pull from this cache. This is much faster since the gitlab cache push and pull is faster than downloading all the deps again, but as expected, only the stage that is testing on the same version the cache was populated with can effectively use the cache. All other versions end up downloading other versions of the dependencies.

What else on the uv side could be done to speed this process up? Some things I have thought of but not tried yet:
  - supply the `--python-version` argument with the lowest supported version to the `uv pip install` step of the stage that caches the uv cache?
  - lock down dependency versions so only one version can be pulled?

Any help is appreciated!

### Platform

_No response_

### Version

_No response_

---

_Label `question` added by @alechouse97 on 2025-07-07 20:41_

---

_Comment by @zanieb on 2025-07-07 22:21_

Can you not create a separate cache entry for each Python version?

---

_Comment by @zanieb on 2025-07-07 22:22_

You could use `--fork-strategy fewest` (see https://docs.astral.sh/uv/concepts/resolution/#multi-version-resolution)

---

_Comment by @alechouse97 on 2025-07-07 22:54_

> You could use `--fork-strategy fewest` (see https://docs.astral.sh/uv/concepts/resolution/#multi-version-resolution)

This looks like a promising option, I will give this a try. Thank you!

---

_Comment by @alechouse97 on 2025-07-07 22:55_

> Can you not create a separate cache entry for each Python version?

Yeah I could definitely do this, I'll see how this works too!

---

_Comment by @alechouse97 on 2025-07-08 17:38_

For those that come across this later, after playing around with it, this is the best solution I have found. Below is a job that installs the package and runs the tests across multiple python versions. A different cache exists for each python version and `pyproject.toml`. Importantly, it also checks to see if the uv cache was pulled by gitlab. If so, we set `RM_CACHE=1`. At the end of the job, if `RM_CACHE=1,` we remove the uv cache dir. Gitlab will throw a warning, but it will simply skip the caching step! Pulled the cache "checking" from [this discussion](https://gitlab.com/gitlab-org/gitlab/-/issues/226068#note_2490000160).

Thanks to uv, the actual install of all the packages is incredibly fast!

```yaml
.test-base:
  stage: test
  image: ${IMAGE}
  needs:
    - job: build-whl
      artifacts: true
  cache:
    policy: pull-push
    key:
      files: ["pyproject.toml"]
      prefix: $PYTHON_VERSION
    paths: [$UV_CACHE_DIR]
  variables:
    GIT_STRATEGY: none
  before_script:
    - >
      if [[ -d $UV_CACHE_DIR ]]; then
        echo "cache exists, will remove at end of job to avoid re-caching"
        export RM_CACHE=1;
      else
        echo "cache does not exist, so it will be pushed at end of job"
        export RM_CACHE=0;
      fi
  script:
    - uv pip install artifacts/*.whl --torch-backend=cpu
    - pytest
    - >
      if [[ $RM_CACHE -eq 1 ]]; then
        echo "removing cache target to avoid re-cache..."
        rm -rf $UV_CACHE_DIR
      fi

python-3.9:
  extends: .test-base
  variables:
    PYTHON_VERSION: "3.9"

python-3.10:
  extends: .test-base
  variables:
    PYTHON_VERSION: "3.10"

python-3.11:
  extends: .test-base
  variables:
    PYTHON_VERSION: "3.11"

python-3.12:
  extends: .test-base
  variables:
    PYTHON_VERSION: "3.12"

python-3.13:
  extends: .test-base
  variables:
    PYTHON_VERSION: "3.13"
```


---

_Closed by @alechouse97 on 2025-07-08 17:38_

---
