---
number: 15978
title: "Even Better TOML crashes on `ruff.toml` due to `allOf` usage"
type: issue
state: closed
author: DavisVaughan
labels:
  - bug
  - configuration
assignees: []
created_at: 2025-02-05T19:31:23Z
updated_at: 2025-02-06T15:00:52Z
url: https://github.com/astral-sh/ruff/issues/15978
synced_at: 2026-01-07T12:31:13-06:00
---

# Even Better TOML crashes on `ruff.toml` due to `allOf` usage

---

_Issue opened by @DavisVaughan on 2025-02-05 19:31_

### Description

Not sure if you all know this yet, but Even Better TOML in VS Code crashes for me on any `ruff.toml`, it looks like this:

https://github.com/user-attachments/assets/507bcd9e-562f-4c87-88af-7e1d8f603100

I manually bisect-ed my way through your schema file and figured out it has to do with usage of `allOf` in these two spots:
https://github.com/astral-sh/ruff/blob/c8165427048fe04de1a046544ff861f7ab79b121/ruff.schema.json#L882-L890

It is nothing ruff is doing wrong, and in fact there is a PR on the taplo side that does fix this exact issue (I confirmed by installing the PR rebased on master and trying again). But it is quite old and we probably need to remind them about it. https://github.com/tamasfe/taplo/pull/644

Feel free to close since there is probably nothing actionable on y'alls part, but I didn't see any issues about this and figured you might want to know. 

(Side note that taplo / even better toml is in an interesting spot, as it needs a new active maintainer, but is extremely useful for TOML autocompletion and I'd hate to see that extension die)

---

_Comment by @MichaReiser on 2025-02-06 11:21_

Thanks for the report. We weren't aware that even better TOML crashes on the schema and I can confirm that it is due to the use of `allOf`. Removing the Schema visitor that moves all `$ref` into an `allOf` when generating the schema fixes the crash

```
    let gen = schemars::gen::SchemaGenerator::new(
        schemars::gen::SchemaSettings::draft07().with(|config| config.visitors.clear()),
    );
```


However, this now leads to an invalid schema because all other properties on an object are ignored if it has a `$ref` property. But we could consider using `oneOf` instead of `allOf` 

---

_Label `bug` added by @MichaReiser on 2025-02-06 11:29_

---

_Label `configuration` added by @MichaReiser on 2025-02-06 11:29_

---

_Comment by @MichaReiser on 2025-02-06 11:47_

Hmm, or not. I'm confused. I can still reproduce that even better toml crashes whenever I add a new `[` (individual settings is fine) but even removing the `allOf` won't help. 

---

_Comment by @MichaReiser on 2025-02-06 11:56_

Okay, I had to set the even better TOML cache timeouts to a low value or it just keeps the schemas cached

```json
    "evenBetterToml.schema.cache.memoryExpiration": 5,
    "evenBetterToml.schema.cache.diskExpiration": 5
```

---

_Referenced in [astral-sh/ruff#15992](../../astral-sh/ruff/pulls/15992.md) on 2025-02-06 12:02_

---

_Closed by @MichaReiser on 2025-02-06 15:00_

---

_Closed by @MichaReiser on 2025-02-06 15:00_

---

_Referenced in [tamasfe/taplo#644](../../tamasfe/taplo/pulls/644.md) on 2025-02-06 16:59_

---
