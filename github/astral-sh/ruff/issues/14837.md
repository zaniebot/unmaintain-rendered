---
number: 14837
title: Stack overflow, when checking 1000 files at once
type: issue
state: open
author: qarmin
labels:
  - bug
assignees: []
created_at: 2024-12-08T16:52:23Z
updated_at: 2024-12-10T07:14:19Z
url: https://github.com/astral-sh/ruff/issues/14837
synced_at: 2026-01-07T12:31:13-06:00
---

# Stack overflow, when checking 1000 files at once

---

_Issue opened by @qarmin on 2024-12-08 16:52_

ruff 269e47be961d3eb95c0351e8f7006b71e083a6a4

When running command `timeout -v 300 ruff check FILE.py --select ALL --preview --output-format concise --no-cache --fix --unsafe-fixes --isolated` on folder with 1000 files, I'm having stack overflow.
The problem not happens, when I check files one by one(this may be a bug in fuzzer, but it is quite unlikely)
Currently I'm trying to create reproduction project, because this is bug quite hard to catch 

stack trace
```
AddressSanitizer:DEADLYSIGNAL
=================================================================
==32595==ERROR: AddressSanitizer: stack-overflow on address 0x7fd7c93fcfe0 (pc 0x5613ca9cc817 bp 0x7fd7c93fe270 sp 0x7fd7c93fcfe0 T5)
    #0 0x5613ca9cc817 in _$LT$ruff_python_ast..comparable..ComparableExpr$u20$as$u20$core..convert..From$LT$$RF$ruff_python_ast..nodes..Expr$GT$$GT$::from::h66c27c4cde345c20 /home/runner/work/Automated-Fuzzer/Automated-Fuzzer/ruff/crates/ruff_python_ast/src/comparable.rs:964
    #1 0x5613ca9cd6b0 in _$LT$T$u20$as$u20$core..convert..Into$LT$U$GT$$GT$::into::hbfb71b9829e5f4c0 /home/runner/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/core/src/convert/mod.rs:759:9
    #2 0x5613ca9cd6b0 in ruff_python_ast::comparable::_$LT$impl$u20$core..convert..From$LT$$RF$alloc..boxed..Box$LT$ruff_python_ast..nodes..Expr$GT$$GT$$u20$for$u20$alloc..boxed..Box$LT$ruff_python_ast..comparable..ComparableExpr$GT$$GT$::from::he792be5cda805282 /home/runner/work/Automated-Fuzzer/Automated-Fuzzer/ruff/crates/ruff_python_ast/src/comparable.rs:953:34
    #3 0x5613ca9cd6b0 in _$LT$T$u20$as$u20$core..convert..Into$LT$U$GT$$GT$::into::ha5cfddb1241be6ab /home/runner/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/core/src/convert/mod.rs:759:9
    #4 0x5613ca9cd6b0 in _$LT$ruff_python_ast..comparable..ComparableExpr$u20$as$u20$core..convert..From$LT$$RF$ruff_python_ast..nodes..Expr$GT$$GT$::from::h66c27c4cde345c20 /home/runner/work/Automated-Fuzzer/Automated-Fuzzer/ruff/crates/ruff_python_ast/src/comparable.rs:988:28
    #5 0x5613ca9cd6b0 in _$LT$T$u20$as$u20$core..convert..Into$LT$U$GT$$GT$::into::hbfb71b9829e5f4c0 /home/runner/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/core/src/convert/mod.rs:759:9
    #6 0x5613ca9cd6b0 in ruff_python_ast::comparable::_$LT$impl$u20$core..convert..From$LT$$RF$alloc..boxed..Box$LT$ruff_python_ast..nodes..Expr$GT$$GT$$u20$for$u20$alloc..boxed..Box$LT$ruff_python_ast..comparable..ComparableExpr$GT$$GT$::from::he792be5cda805282 /home/runner/work/Automated-Fuzzer/Automated-Fuzzer/ruff/crates/ruff_python_ast/src/comparable.rs:953:34
    #7 0x5613ca9cd6b0 in _$LT$T$u20$as$u20$core..convert..Into$LT$U$GT$$GT$::into::ha5cfddb1241be6ab /home/runner/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/core/src/convert/mod.rs:759:9
    #8 0x5613ca9cd6b0 in _$LT$ruff_python_ast..comparable..ComparableExpr$u20$as$u20$core..convert..From$LT$$RF$ruff_python_ast..nodes..Expr$GT$$GT$::from::h66c27c4cde345c20 /home/runner/work/Automated-Fuzzer/Automated-Fuzzer/ruff/crates/ruff_python_ast/src/comparable.rs:988:28
    #9 0x5613ca9cd6b0 in _$LT$T$u20$as$u20$core..convert..Into$LT$U$GT$$GT$::into::hbfb71b9829e5f4c0 /home/runner/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/core/src/convert/mod.rs:759:9
    #10 0x5613ca9cd6b0 in ruff_python_ast::comparable::_$LT$impl$u20$core..convert..From$LT$$RF$alloc..boxed..Box$LT$ruff_python_ast..nodes..Expr$GT$$GT$$u20$for$u20$alloc..boxed..Box$LT$ruff_python_ast..comparable..ComparableExpr$GT$$GT$::from::he792be5cda805282 /home/runner/work/Automated-Fuzzer/Automated-Fuzzer/ruff/crates/ruff_python_ast/src/comparable.rs:953:34
    #11 0x5613ca9cd6b0 in _$LT$T$u20$as$u20$core..convert..Into$LT$U$GT$$GT$::into::ha5cfddb1241be6ab /home/runner/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/core/src/convert/mod.rs:759:9


...

    #969 0x5613ca9cd6b0 in _$LT$T$u20$as$u20$core..convert..Into$LT$U$GT$$GT$::into::hbfb71b9829e5f4c0 /home/runner/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/core/src/convert/mod.rs:759:9
    #970 0x5613ca9cd6b0 in ruff_python_ast::comparable::_$LT$impl$u20$core..convert..From$LT$$RF$alloc..boxed..Box$LT$ruff_python_ast..nodes..Expr$GT$$GT$$u20$for$u20$alloc..boxed..Box$LT$ruff_python_ast..comparable..ComparableExpr$GT$$GT$::from::he792be5cda805282 /home/runner/work/Automated-Fuzzer/Automated-Fuzzer/ruff/crates/ruff_python_ast/src/comparable.rs:953:34
    #971 0x5613ca9cd6b0 in _$LT$T$u20$as$u20$core..convert..Into$LT$U$GT$$GT$::into::ha5cfddb1241be6ab /home/runner/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/core/src/convert/mod.rs:759:9
    #972 0x5613ca9cd6b0 in _$LT$ruff_python_ast..comparable..ComparableExpr$u20$as$u20$core..convert..From$LT$$RF$ruff_python_ast..nodes..Expr$GT$$GT$::from::h66c27c4cde345c20 /home/runner/work/Automated-Fuzzer/Automated-Fuzzer/ruff/crates/ruff_python_ast/src/comparable.rs:988:28
    #973 0x5613ca9cd6b0 in _$LT$T$u20$as$u20$core..convert..Into$LT$U$GT$$GT$::into::hbfb71b9829e5f4c0 /home/runner/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/core/src/convert/mod.rs:759:9
    #974 0x5613ca9cd6b0 in ruff_python_ast::comparable::_$LT$impl$u20$core..convert..From$LT$$RF$alloc..boxed..Box$LT$ruff_python_ast..nodes..Expr$GT$$GT$$u20$for$u20$alloc..boxed..Box$LT$ruff_python_ast..comparable..ComparableExpr$GT$$GT$::from::he792be5cda805282 /home/runner/work/Automated-Fuzzer/Automated-Fuzzer/ruff/crates/ruff_python_ast/src/comparable.rs:953:34
    #975 0x5613ca9cd6b0 in _$LT$T$u20$as$u20$core..convert..Into$LT$U$GT$$GT$::into::ha5cfddb1241be6ab /home/runner/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/core/src/convert/mod.rs:759:9
    #976 0x5613ca9cd6b0 in _$LT$ruff_python_ast..comparable..ComparableExpr$u20$as$u20$core..convert..From$LT$$RF$ruff_python_ast..nodes..Expr$GT$$GT$::from::h66c27c4cde345c20 /home/runner/work/Automated-Fuzzer/Automated-Fuzzer/ruff/crates/ruff_python_ast/src/comparable.rs:988:28
    #977 0x5613ca9cd6b0 in _$LT$T$u20$as$u20$core..convert..Into$LT$U$GT$$GT$::into::hbfb71b9829e5f4c0 /home/runner/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/core/src/convert/mod.rs:759:9
    #978 0x5613ca9cd6b0 in ruff_python_ast::comparable::_$LT$impl$u20$core..convert..From$LT$$RF$alloc..boxed..Box$LT$ruff_python_ast..nodes..Expr$GT$$GT$$u20$for$u20$alloc..boxed..Box$LT$ruff_python_ast..comparable..ComparableExpr$GT$$GT$::from::he792be5cda805282 /home/runner/work/Automated-Fuzzer/Automated-Fuzzer/ruff/crates/ruff_python_ast/src/comparable.rs:953:34
    #979 0x5613ca9cd6b0 in _$LT$T$u20$as$u20$core..convert..Into$LT$U$GT$$GT$::into::ha5cfddb1241be6ab /home/runner/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/core/src/convert/mod.rs:759:9
    #980 0x5613ca9cd6b0 in _$LT$ruff_python_ast..comparable..ComparableExpr$u20$as$u20$core..convert..From$LT$$RF$ruff_python_ast..nodes..Expr$GT$$GT$::from::h66c27c4cde345c20 /home/runner/work/Automated-Fuzzer/Automated-Fuzzer/ruff/crates/ruff_python_ast/src/comparable.rs:988:28
    #981 0x5613ca9cd6b0 in _$LT$T$u20$as$u20$core..convert..Into$LT$U$GT$$GT$::into::hbfb71b9829e5f4c0 /home/runner/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/core/src/convert/mod.rs:759:9
    #982 0x5613ca9cd6b0 in ruff_python_ast::comparable::_$LT$impl$u20$core..convert..From$LT$$RF$alloc..boxed..Box$LT$ruff_python_ast..nodes..Expr$GT$$GT$$u20$for$u20$alloc..boxed..Box$LT$ruff_python_ast..comparable..ComparableExpr$GT$$GT$::from::he792be5cda805282 /home/runner/work/Automated-Fuzzer/Automated-Fuzzer/ruff/crates/ruff_python_ast/src/comparable.rs:953:34
    #983 0x5613ca9cd6b0 in _$LT$T$u20$as$u20$core..convert..Into$LT$U$GT$$GT$::into::ha5cfddb1241be6ab /home/runner/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/core/src/convert/mod.rs:759:9
    #984 0x5613ca9cd6b0 in _$LT$ruff_python_ast..comparable..ComparableExpr$u20$as$u20$core..convert..From$LT$$RF$ruff_python_ast..nodes..Expr$GT$$GT$::from::h66c27c4cde345c20 /home/runner/work/Automated-Fuzzer/Automated-Fuzzer/ruff/crates/ruff_python_ast/src/comparable.rs:988:28

SUMMARY: AddressSanitizer: stack-overflow /home/runner/work/Automated-Fuzzer/Automated-Fuzzer/ruff/crates/ruff_python_ast/src/comparable.rs:964 in _$LT$ruff_python_ast..comparable..ComparableExpr$u20$as$u20$core..convert..From$LT$$RF$ruff_python_ast..nodes..Expr$GT$$GT$::from::h66c27c4cde345c20
Thread T5 created by T0 here:
    #0 0x5613c8dd30e1 in pthread_create /rustc/llvm/src/llvm-project/compiler-rt/lib/asan/asan_interceptors.cpp:250:3
    #1 0x5613cb4f3341 in std::sys::pal::unix::thread::Thread::new::h696077f6f646fc80 /rustc/9c707a8b769523bb6768bf58e74fa2c39cc24844/library/std/src/sys/pal/unix/thread.rs:84:19
    #2 0x5613c955e198 in std::thread::Builder::spawn_unchecked_::h4ca8dec76eab4718 /home/runner/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std/src/thread/mod.rs:600:30
    #3 0x5613c955e198 in std::thread::Builder::spawn_unchecked::he49e158e1ded39f9 /home/runner/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std/src/thread/mod.rs:467:32
    #4 0x5613c955675d in std::thread::Builder::spawn::hec608a94401a4a21 /home/runner/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std/src/thread/mod.rs:400:18
    #5 0x5613c955675d in _$LT$rayon_core..registry..DefaultSpawn$u20$as$u20$rayon_core..registry..ThreadSpawn$GT$::spawn::h5ece714eae561931 /home/runner/.cargo/registry/src/index.crates.io-6f17d22bba15001f/rayon-core-1.12.1/src/registry.rs:98:11
    #6 0x5613c9557c7e in rayon_core::registry::Registry::new::hd2811720523aad2c /home/runner/.cargo/registry/src/index.crates.io-6f17d22bba15001f/rayon-core-1.12.1/src/registry.rs:304:29
    #7 0x5613c95536b1 in rayon_core::registry::default_global_registry::h36b0004846f73a0b /home/runner/.cargo/registry/src/index.crates.io-6f17d22bba15001f/rayon-core-1.12.1/src/registry.rs:201:18
    #8 0x5613c95536b1 in core::ops::function::FnOnce::call_once::hd41421ebfbd1a9b6 /home/runner/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/core/src/ops/function.rs:250:5
    #9 0x5613c95536b1 in rayon_core::registry::set_global_registry::_$u7b$$u7b$closure$u7d$$u7d$::h61e90467babfe76c /home/runner/.cargo/registry/src/index.crates.io-6f17d22bba15001f/rayon-core-1.12.1/src/registry.rs:193:18
    #10 0x5613c95536b1 in std::sync::once::Once::call_once::_$u7b$$u7b$closure$u7d$$u7d$::hff3dc7240dd84ba3 /home/runner/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std/src/sync/once.rs:158:41
    #11 0x5613cb4f9473 in std::sys::sync::once::futex::Once::call::h6ee9c9cf40a5f0ca /rustc/9c707a8b769523bb6768bf58e74fa2c39cc24844/library/std/src/sys/sync/once/futex.rs:176:21
    #12 0x5613c9556bfe in std::sync::once::Once::call_once::hf50a832cf7d543e3 /home/runner/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std/src/sync/once.rs:158:9
    #13 0x5613c9556bfe in rayon_core::registry::set_global_registry::h1c9af69e85e417e8 /home/runner/.cargo/registry/src/index.crates.io-6f17d22bba15001f/rayon-core-1.12.1/src/registry.rs:192:5
    #14 0x5613c9556bfe in rayon_core::registry::global_registry::h717071e20c070d8a /home/runner/.cargo/registry/src/index.crates.io-6f17d22bba15001f/rayon-core-1.12.1/src/registry.rs:166:5
    #15 0x5613c998fc76 in rayon_core::registry::Registry::current_num_threads::hc8e564d463aa7852 /home/runner/.cargo/registry/src/index.crates.io-6f17d22bba15001f/rayon-core-1.12.1/src/registry.rs:334:17
    #16 0x5613c998fc76 in rayon_core::current_num_threads::h79ed106cc24f1cd7 /home/runner/.cargo/registry/src/index.crates.io-6f17d22bba15001f/rayon-core-1.12.1/src/lib.rs:144:5
    #17 0x5613c998fc76 in rayon::iter::plumbing::Splitter::new::hae20c6bb90277ded /home/runner/.cargo/registry/src/index.crates.io-6f17d22bba15001f/rayon-1.10.0/src/iter/plumbing/mod.rs:266:21
    #18 0x5613c998fc76 in rayon::iter::plumbing::LengthSplitter::new::hbe9c9e58ca24c72b /home/runner/.cargo/registry/src/index.crates.io-6f17d22bba15001f/rayon-1.10.0/src/iter/plumbing/mod.rs:314:20
    #19 0x5613c998fc76 in rayon::iter::plumbing::bridge_producer_consumer::h65f3b0fd7fb0d5df /home/runner/.cargo/registry/src/index.crates.io-6f17d22bba15001f/rayon-1.10.0/src/iter/plumbing/mod.rs:395:20
    #20 0x5613c998fc76 in _$LT$rayon..iter..plumbing..bridge..Callback$LT$C$GT$$u20$as$u20$rayon..iter..plumbing..ProducerCallback$LT$I$GT$$GT$::callback::h0bf48367e2cd0f0c /home/runner/.cargo/registry/src/index.crates.io-6f17d22bba15001f/rayon-1.10.0/src/iter/plumbing/mod.rs:372:13
    #21 0x5613c999b29d in _$LT$rayon..slice..Iter$LT$T$GT$$u20$as$u20$rayon..iter..IndexedParallelIterator$GT$::with_producer::h03ccf7c73b438ddd /home/runner/.cargo/registry/src/index.crates.io-6f17d22bba15001f/rayon-1.10.0/src/slice/mod.rs:826:9
    #22 0x5613c999b29d in rayon::iter::plumbing::bridge::hf3d162ca101d0547 /home/runner/.cargo/registry/src/index.crates.io-6f17d22bba15001f/rayon-1.10.0/src/iter/plumbing/mod.rs:356:12
    #23 0x5613c9b48747 in _$LT$rayon..slice..Iter$LT$T$GT$$u20$as$u20$rayon..iter..ParallelIterator$GT$::drive_unindexed::h494f7a8056defb34 /home/runner/.cargo/registry/src/index.crates.io-6f17d22bba15001f/rayon-1.10.0/src/slice/mod.rs:802:9
    #24 0x5613c9b48747 in _$LT$rayon..iter..filter_map..FilterMap$LT$I$C$P$GT$$u20$as$u20$rayon..iter..ParallelIterator$GT$::drive_unindexed::h16a71007ba270295 /home/runner/.cargo/registry/src/index.crates.io-6f17d22bba15001f/rayon-1.10.0/src/iter/filter_map.rs:46:9
    #25 0x5613c9b48747 in _$LT$rayon..iter..fold..Fold$LT$I$C$ID$C$F$GT$$u20$as$u20$rayon..iter..ParallelIterator$GT$::drive_unindexed::hdebb42992b93d878 /home/runner/.cargo/registry/src/index.crates.io-6f17d22bba15001f/rayon-1.10.0/src/iter/fold.rs:59:9
    #26 0x5613c9ae4de5 in rayon::iter::reduce::reduce::hbfaaf42237a96efb /home/runner/.cargo/registry/src/index.crates.io-6f17d22bba15001f/rayon-1.10.0/src/iter/reduce.rs:15:5
    #27 0x5613c9ae4de5 in rayon::iter::ParallelIterator::reduce::h5614e61465fd466b /home/runner/.cargo/registry/src/index.crates.io-6f17d22bba15001f/rayon-1.10.0/src/iter/mod.rs:998:9
    #28 0x5613c9ae4de5 in ruff::commands::check::check::h15fbf2538e95a305 /home/runner/work/Automated-Fuzzer/Automated-Fuzzer/ruff/crates/ruff/src/commands/check.rs:166:10
    #29 0x5613c9a1cc82 in ruff::check::h9a87db039818b718 /home/runner/work/Automated-Fuzzer/Automated-Fuzzer/ruff/crates/ruff/src/lib.rs:424:13
    #30 0x5613c9a197a1 in ruff::run::h7c3326f307f68efc /home/runner/work/Automated-Fuzzer/Automated-Fuzzer/ruff/crates/ruff/src/lib.rs:196:33
    #31 0x5613c9c1d72f in ruff::main::ha3368c91f5987eb8 /home/runner/work/Automated-Fuzzer/Automated-Fuzzer/ruff/crates/ruff/src/main.rs:44:11
    #32 0x5613c9c29642 in core::ops::function::FnOnce::call_once::h6ad5a361e8430ac1 /home/runner/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/core/src/ops/function.rs:250:5
    #33 0x5613c9c29642 in std::sys::backtrace::__rust_begin_short_backtrace::h250adf2496557c04 /home/runner/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std/src/sys/backtrace.rs:152:18
    #34 0x5613c9c2828b in std::rt::lang_start::hff9f9d4f34115992 /home/runner/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std/src/rt.rs:194:17
    #35 0x7fd7cd029d8f  (/lib/x86_64-linux-gnu/libc.so.6+0x29d8f) (BuildId: 490fef8403240c91833978d494d39e537409b92e)
```

points at this line 

https://github.com/astral-sh/ruff/blob/269e47be961d3eb95c0351e8f7006b71e083a6a4/crates/ruff_python_ast/src/comparable.rs#L988

---

_Comment by @MichaReiser on 2024-12-08 17:38_

I suspect that ruff ends up generating a very nested binary expression that now results in `ComparableExpr` to overlfow.

---

_Label `bug` added by @MichaReiser on 2024-12-08 17:43_

---

_Label `needs-mre` added by @MichaReiser on 2024-12-08 17:43_

---

_Comment by @qarmin on 2024-12-10 07:04_

Finally I found problematic file - [297.py.zip](https://github.com/user-attachments/files/18074386/297.py.zip)

I'm not sure why this issue didn't always occur for me.

AddressSanitizer detected this file even with ~1000 lines, even though a normally compiled ruff worked correctly (this file comes from a real project and, as far as I recall, was used for testing).

Probably because AddressSanitizer takes more stack space by default.
After increasing it to 4000 lines, the regular ruff crashes as well.

---

_Comment by @MichaReiser on 2024-12-10 07:14_

Yeah. That's roughly what I expected. There are two options:

a) Unroll binary-like expressions during visiting using a loop. This probably requires special handling in every visitor. 
b) Use [stacker](https://crates.io/crates/stacker)

---

_Label `needs-mre` removed by @MichaReiser on 2024-12-10 07:14_

---
