---
number: 5777
title: Generator always parenthesizes element in list comprehension
type: issue
state: closed
author: dhruvmanila
labels:
  - bug
  - fixes
  - help wanted
assignees: []
created_at: 2023-07-15T13:29:04Z
updated_at: 2023-07-31T15:26:44Z
url: https://github.com/astral-sh/ruff/issues/5777
synced_at: 2026-01-07T12:31:12-06:00
---

# Generator always parenthesizes element in list comprehension

---

_Issue opened by @dhruvmanila on 2023-07-15 13:29_

Yeah, this seems like a bug:

```rust
assert_round_trip!("[i*2 for i in range(5)]");
// thread 'source_code::generator::tests::tmp_test' panicked at 'assertion failed: `(left == right)`
//  left: `"[(i * 2) for i in range(5)]"`,
// right: `"[i*2 for i in range(5)]"`', crates/ruff_python_ast/src/source_code/generator.rs:1491:9
// note: run with `RUST_BACKTRACE=1` environment variable to display a backtrace
// test source_code::generator::tests::tmp_test ... FAILED
```

_Originally posted by @dhruvmanila in https://github.com/astral-sh/ruff/pull/4880#discussion_r1262118517_
            

---

_Comment by @dhruvmanila on 2023-07-15 13:30_

Omg, too much macro use in our `Generator`. This is a precedence issue that's probably worth opening an issue for.

This code decides whether to parenthesize an expression or not 

https://github.com/astral-sh/ruff/blob/58a79c1392003ec63904fe20a33e7b62857c3db1/crates/ruff_python_ast/src/source_code/generator.rs#L874-L881

The `oprec` macro took me a while to understand but precedence either gets assigned the `AND` (33) or `OR` (31) precedence (the same is true for bin op, it's just that they use slightly different values for the precedence)

Now, the generator adds parentheses if the parent's precedence is higher. We use the `MAX` precedence for the list comprehension, which means all expressions get parenthesized

https://github.com/astral-sh/ruff/blob/58a79c1392003ec63904fe20a33e7b62857c3db1/crates/ruff_python_ast/src/source_code/generator.rs#L1010-L1019

The fix requires identifying the right precedence and passing it through. A second (unrelated) refactor could be to use an enum for the precedence instead of an `u8`.

_Originally posted by @MichaReiser in https://github.com/astral-sh/ruff/pull/4880#discussion_r1263349374_

---

_Label `bug` added by @dhruvmanila on 2023-07-15 13:30_

---

_Label `autofix` added by @dhruvmanila on 2023-07-15 13:30_

---

_Referenced in [astral-sh/ruff#4880](../../astral-sh/ruff/pulls/4880.md) on 2023-07-15 13:42_

---

_Label `help wanted` added by @MichaReiser on 2023-07-20 09:23_

---

_Referenced in [astral-sh/ruff#6198](../../astral-sh/ruff/pulls/6198.md) on 2023-07-31 15:09_

---

_Closed by @dhruvmanila on 2023-07-31 15:26_

---
