---
number: 1514
title: False positive in F541 (f-string without placeholders) after v0.0.204
type: issue
state: closed
author: tlambert03
labels:
  - bug
assignees: []
created_at: 2022-12-31T16:10:36Z
updated_at: 2023-01-01T05:10:43Z
url: https://github.com/astral-sh/ruff/issues/1514
synced_at: 2026-01-07T12:31:12-06:00
---

# False positive in F541 (f-string without placeholders) after v0.0.204

---

_Issue opened by @tlambert03 on 2022-12-31 16:10_

not sure if it's #1494 or a different PR... but a F541 "f-string without placeholders" false positive is now appearing in v0.0.204 when using format specifiers in f-strings:

```python
v = 23.234234
f"{v:0.2f}"  # error
```

---

_Comment by @charliermarsh on 2022-12-31 16:21_

Thank you for filing.

---

_Label `bug` added by @charliermarsh on 2022-12-31 16:21_

---

_Comment by @charliermarsh on 2022-12-31 16:24_

@harupy - Do you have any thoughts on the correct fix here?

The AST looks like this:

```
Expr {
    value: Located {
        location: Location {
            row: 2,
            column: 0,
        },
        end_location: Some(
            Location {
                row: 2,
                column: 11,
            },
        ),
        custom: (),
        node: JoinedStr {
            values: [
                Located {
                    location: Location {
                        row: 2,
                        column: 0,
                    },
                    end_location: Some(
                        Location {
                            row: 2,
                            column: 11,
                        },
                    ),
                    custom: (),
                    node: FormattedValue {
                        value: Located {
                            location: Location {
                                row: 2,
                                column: 3,
                            },
                            end_location: Some(
                                Location {
                                    row: 2,
                                    column: 4,
                                },
                            ),
                            custom: (),
                            node: Name {
                                id: "v",
                                ctx: Load,
                            },
                        },
                        conversion: 0,
                        format_spec: Some(
                            Located {
                                location: Location {
                                    row: 2,
                                    column: 0,
                                },
                                end_location: Some(
                                    Location {
                                        row: 2,
                                        column: 11,
                                    },
                                ),
                                custom: (),
                                node: JoinedStr {
                                    values: [
                                        Located {
                                            location: Location {
                                                row: 2,
                                                column: 0,
                                            },
                                            end_location: Some(
                                                Location {
                                                    row: 2,
                                                    column: 11,
                                                },
                                            ),
                                            custom: (),
                                            node: Constant {
                                                value: Str(
                                                    "0.2f",
                                                ),
                                                kind: None,
                                            },
                                        },
                                    ],
                                },
                            },
                        ),
                    },
                },
            ],
        },
    }
}
```

So the format spec itself is an "empty" `JoinedStr`.

---

_Comment by @charliermarsh on 2022-12-31 16:30_

I was gonna say we could ignore `format_spec` but... this may require a fix in RustPython, since we _do_ want to flag the latter case:

```py
v = 23.234234
f"{v:0.2f}"
f"{v:{f'0.2f'}}"
```

---

_Comment by @AA-Turner on 2022-12-31 17:32_

Another reproducer:

```
(sphinx) PS S:\Development\sphinx> type bug.py                
f' style="vertical-align: {-0:d}px"'
(sphinx) PS S:\Development\sphinx> pip install "ruff==0.0.203" --quiet
(sphinx) PS S:\Development\sphinx> ruff -V
ruff 0.0.203
(sphinx) PS S:\Development\sphinx> ruff --select F bug.py             
(sphinx) PS S:\Development\sphinx> pip install "ruff==0.0.204" --quiet
(sphinx) PS S:\Development\sphinx> ruff -V                            
ruff 0.0.204
(sphinx) PS S:\Development\sphinx> ruff --select F bug.py             
bug.py:1:1: F541 f-string without any placeholders
Found 1 error(s).
```

A

---

_Comment by @charliermarsh on 2022-12-31 17:42_

I can probably get something out quick-ish to resolve these cases (at the cost of some rare false-negatives).

---

_Comment by @charliermarsh on 2022-12-31 18:27_

This does feel like a RustPython bug though. \cc @harupy just for visibility.

---

_Comment by @harupy on 2022-12-31 18:30_

I checked python's AST for `f"{v:0.2}"`:

```
>>> print(ast.dump(ast.parse('f"{v:0.2}"'), include_attributes=True, indent=2))
Module(
  body=[
    Expr(
      value=JoinedStr(
        values=[
          FormattedValue(
            value=Name(
              id='v',
              ctx=Load(),
              lineno=1,
              col_offset=3,
              end_lineno=1,
              end_col_offset=4),
            conversion=-1,
            format_spec=JoinedStr(
              values=[
                Constant(
                  value='0.2',
                  lineno=1,
                  col_offset=0,
                  end_lineno=1,
                  end_col_offset=10)],
              lineno=1,
              col_offset=0,
              end_lineno=1,
              end_col_offset=10),
            lineno=1,
            col_offset=0,
            end_lineno=1,
            end_col_offset=10)],
        lineno=1,
        col_offset=0,
        end_lineno=1,
        end_col_offset=10),
      lineno=1,
      col_offset=0,
      end_lineno=1,
      end_col_offset=10)],
  type_ignores=[])
```

---

_Comment by @charliermarsh on 2022-12-31 18:31_

Oh nice, so it's the same?

---

_Comment by @harupy on 2022-12-31 18:31_

It looks the same.

---

_Comment by @charliermarsh on 2022-12-31 18:32_

It looks like Pyflakes doesn't check nested f-strings:

```py
_in_fstring = False

def JOINEDSTR(self, node):
    if (
            # the conversion / etc. flags are parsed as f-strings without
            # placeholders
            not self._in_fstring and
            not any(isinstance(x, ast.FormattedValue) for x in node.values)
    ):
        self.report(messages.FStringMissingPlaceholders, node)

    self._in_fstring, orig = True, self._in_fstring
    try:
        self.handleChildren(node)
    finally:
        self._in_fstring = orig
```

---

_Comment by @charliermarsh on 2022-12-31 18:33_

Probably the best we can do then? I can fix.

---

_Comment by @charliermarsh on 2022-12-31 18:33_

I did suspect that `0.2` part would at least have a different location though. It looks like it uses the same location as the surrounding f-string. If it had a different location, I could extract the raw text and manually confirm that it's not a "real" f-string.

---

_Referenced in [astral-sh/ruff#1516](../../astral-sh/ruff/pulls/1516.md) on 2022-12-31 18:39_

---

_Closed by @charliermarsh on 2022-12-31 18:41_

---

_Comment by @tlambert03 on 2022-12-31 18:45_

thanks as always for the blazing fast response

---

_Comment by @harupy on 2022-12-31 18:47_

@charliermarsh Thanks for the fix. Here's my attempt to fix this issue:

```diff
diff --git a/src/checkers/ast.rs b/src/checkers/ast.rs
index 8629bae..0079d8b 100644
--- a/src/checkers/ast.rs
+++ b/src/checkers/ast.rs
@@ -2151,7 +2151,20 @@ where
                 }
             }
             ExprKind::JoinedStr { values } => {
-                if self.settings.enabled.contains(&CheckCode::F541) {
+                let is_format_spec = match self.current_expr_parent() {
+                    Some(parent) => match &parent.0.node {
+                        ExprKind::FormattedValue { format_spec, .. } => match format_spec {
+                            Some(format_spec) => {
+                                format_spec.location == expr.location
+                                    && format_spec.end_location == expr.end_location
+                            }
+                            None => false,
+                        },
+                        _ => false,
+                    },
+                    None => false,
+                };
+                if !is_format_spec && self.settings.enabled.contains(&CheckCode::F541) {
                     if !values
                         .iter()
                         .any(|value| matches!(value.node, ExprKind::FormattedValue { .. }))
```

This yields:

```
> cargo run -- --no-cache a.py --show-source
   Compiling ruff v0.0.204 (/home/haru/Desktop/repositories/ruff)
    Finished dev [unoptimized + debuginfo] target(s) in 7.60s
     Running `target/debug/ruff --no-cache a.py --show-source`
a.py:6:5: F541 f-string without any placeholders
  |
6 | c = f"def"
  |     ^^^^^^ F541
  |

a.py:7:5: F541 f-string without any placeholders
  |
7 | d = f"def" + "ghi"
  |     ^^^^^^ F541
  |

a.py:9:5: F541 f-string without any placeholders
  |
9 |     f"def" +
  |     ^^^^^^ F541
  |

a.py:17:5: F541 f-string without any placeholders
   |
17 | h = "x" "y" f"z"
   |     ^^^^^^^^^^^^ F541
   |

a.py:25:7: F541 f-string without any placeholders
   |
25 | f"{v:{f'0.2f'}}"
   |       ^^^^^^^ F541
   |

a.py:26:4: F541 f-string without any placeholders
   |
26 | f"{f''}"
   |    ^^^ F541
   |

Found 6 error(s).
```

---

_Comment by @charliermarsh on 2022-12-31 18:54_

Oh nice. @harupy do you want to PR that? At your convenience. It's not urgent. That first fix is building now in [v0.0.205](https://github.com/charliermarsh/ruff/releases/tag/v0.0.205) anyway.

---

_Comment by @harupy on 2022-12-31 19:02_

Yes, I'd be happy to PR that.

---

_Comment by @harupy on 2023-01-01 04:37_

@charliermarsh I came up with a different approach. The diff looks like this:

```diff
diff --git a/src/ast/visitor.rs b/src/ast/visitor.rs
index f531bba..9bcefd0 100644
--- a/src/ast/visitor.rs
+++ b/src/ast/visitor.rs
@@ -387,7 +387,16 @@ pub fn walk_expr<'a, V: Visitor<'a> + ?Sized>(visitor: &mut V, expr: &'a Expr) {
         ExprKind::FormattedValue {
            value, format_spec, ..
         } => {
             visitor.visit_expr(value);
             if let Some(expr) = format_spec {
-                visitor.visit_expr(expr);
+                match &expr.node {
+                    // Conversion flags are parsed as f-strings without placeholders,
+                    // which would lead to false positives for F541 (FStringMissingPlaceholders).
+                    ExprKind::JoinedStr { values } => {
+                        for value in values {
+                            visitor.visit_expr(value);
+                        }
+                    }
+                    _ => visitor.visit_expr(expr),
+                }
             }
         }
         ExprKind::JoinedStr { values } => {
```

The idea is "do not visit format_spec JoinedStr".

This approach yields:

```
> cargo run -- --no-cache --show-source resources/test/fixtures/pyflakes/F541.py
resources/test/fixtures/pyflakes/F541.py:6:5: F541 f-string without any placeholders
  |
6 | c = f"def"
  |     ^^^^^^ F541
  |

resources/test/fixtures/pyflakes/F541.py:7:5: F541 f-string without any placeholders
  |
7 | d = f"def" + "ghi"
  |     ^^^^^^ F541
  |

resources/test/fixtures/pyflakes/F541.py:9:5: F541 f-string without any placeholders
  |
9 |     f"def" +
  |     ^^^^^^ F541
  |

resources/test/fixtures/pyflakes/F541.py:17:5: F541 f-string without any placeholders
   |
17 | h = "x" "y" f"z"
   |     ^^^^^^^^^^^^ F541
   |

resources/test/fixtures/pyflakes/F541.py:26:7: F541 f-string without any placeholders
   |
26 | f"{v:{f'0.2f'}}"
   |       ^^^^^^^ F541
   |

resources/test/fixtures/pyflakes/F541.py:27:4: F541 f-string without any placeholders
   |
27 | f"{f''}"
   |    ^^^ F541
   |

Found 6 error(s).
```

I believe this is simpler than https://github.com/charliermarsh/ruff/issues/1514#issuecomment-1368264538 and allows us to avoid inspecting the parent expression every time we encounter `JoinedStr`. What do you think?

---

_Referenced in [astral-sh/ruff#1528](../../astral-sh/ruff/pulls/1528.md) on 2023-01-01 09:55_

---
