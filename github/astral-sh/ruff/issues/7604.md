---
number: 7604
title: "Formatter instability: lines after comment at module level"
type: issue
state: closed
author: charliermarsh
labels:
  - bug
  - formatter
assignees: []
created_at: 2023-09-22T16:20:04Z
updated_at: 2023-09-22T17:49:41Z
url: https://github.com/astral-sh/ruff/issues/7604
synced_at: 2026-01-07T12:31:12-06:00
---

# Formatter instability: lines after comment at module level

---

_Issue opened by @charliermarsh on 2023-09-22 16:20_

Given:

```python
import random;

# Defaults for arguments are defined here
# args.threshold = None;


logger = logging.getLogger("FastProject");

```

We're reformatting as:

```python
# -*- coding: utf-8 -*-
import random

# Defaults for arguments are defined here
# args.threshold = None;


logger = logging.getLogger("FastProject")
```

Formatted twice:

```python
import random

# Defaults for arguments are defined here
# args.threshold = None;

logger = logging.getLogger("FastProject")
```

```diff
--- Formatted once
+++ Formatted twice
@@ -3,5 +3,4 @@
 # Defaults for arguments are defined here
 # args.threshold = None;
 
-
 logger = logging.getLogger("FastProject")
```

(That is: removing a newline before `logger =`.)

This leads to an instability.

Sourced from https://github.com/astral-sh/ruff/issues/7590 (`A_3703355012074323529.py`).

---

_Label `bug` added by @charliermarsh on 2023-09-22 16:20_

---

_Label `formatter` added by @charliermarsh on 2023-09-22 16:20_

---

_Added to milestone `Formatter: Beta` by @charliermarsh on 2023-09-22 16:20_

---

_Comment by @charliermarsh on 2023-09-22 16:20_

For posterity, the original source code here (which doesn't strip the newline) is:

```python
# -*- coding: utf-8 -*-
"""Contains information that is useful to share
across all modules.

Right now, mainly command-line arguments, logging
and resource locations.
"""
from __future__ import absolute_import, print_function, division;
import logging;
import sys
import os
import random;

# Defaults for arguments are defined here
# These are all overwritten if called from the command line
# However, by putting defaults here, it makes it easier to
#    call FastProject from within other scripts
# These should be kept in sync with arguments in __main__.py
# args = namedtuple("defalt_args",  ["data_file",  "housekeeping",
#                                    "signatures",  "precomputed",  "output",
#                                    "nofilter",  "nomodel",  "pca_filter",
#                                    "qc",  "subsample_size",
#                                    "min_signature_genes",  "projections",
#                                    "weights",  "threshold"]);
# 
# args.data_file = "";
# args.housekeeping = "";
# args.signatures = [];
# args.precomputed = [];
# args.output = "";
# args.nofilter = False;
# args.nomodel = False;
# args.pca_filter = False;
# args.qc = False;
# args.subsample_size = None;
# args.min_signature_genes = 5;
# args.projections = [];
# args.weights = "";
# args.threshold = None;


logger = logging.getLogger("FastProject");
```

So everything is suffixed with a semicolon.

---

_Comment by @MichaReiser on 2023-09-22 16:53_

This seems to be fixed on main (creating a snapshot test and running our test suite passes without an instability error)

---

_Closed by @MichaReiser on 2023-09-22 16:53_

---

_Reopened by @MichaReiser on 2023-09-22 16:58_

---

_Comment by @MichaReiser on 2023-09-22 16:59_

Okay, the case with semicolons isn't fixed ;)

---

_Referenced in [astral-sh/ruff#7607](../../astral-sh/ruff/pulls/7607.md) on 2023-09-22 17:29_

---

_Assigned to @charliermarsh by @charliermarsh on 2023-09-22 17:29_

---

_Closed by @charliermarsh on 2023-09-22 17:49_

---
