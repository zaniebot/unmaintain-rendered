---
number: 4277
title: "[Autofix error] My File: pandas\\tests\\groupby\\test_apply.py"
type: issue
state: closed
author: FishAlchemist
labels:
  - bug
assignees: []
created_at: 2023-05-08T10:46:50Z
updated_at: 2023-05-08T18:24:29Z
url: https://github.com/astral-sh/ruff/issues/4277
synced_at: 2026-01-07T12:31:12-06:00
---

# [Autofix error] My File: pandas\tests\groupby\test_apply.py

---

_Issue opened by @FishAlchemist on 2023-05-08 10:46_

## Version(ruff --version)
**ruff 0.0.265**
## Command(Powershell)
```powershell
 ruff check --select=ALL  .\test_apply.py
```
**If you add --isolated , there will be no problem about Autofix error**
## Terminal Content
```powershell
warning: `one-blank-line-before-class` (D203) and `no-blank-line-before-class` (D211) are incompatible. Ignoring `one-blank-line-before-class`.
warning: `multi-line-summary-first-line` (D212) and `multi-line-summary-second-line` (D213) are incompatible. Ignoring `multi-line-summary-second-line`.

error: Autofix introduced a syntax error. Reverting all changes.

This indicates a bug in `ruff`. If you could open an issue at:

    https://github.com/charliermarsh/ruff/issues/new?title=%5BAutofix%20error%5D

...quoting the contents of `test_apply.py`, along with the `pyproject.toml` settings and executed command, we'd be very appreciative!

test_apply.py:1:1: D100 Missing docstring in public module
test_apply.py:1:1: I001 Import block is un-sorted or un-formatted
test_apply.py:22:5: ANN201 Missing return type annotation for public function `test_apply_issues`
test_apply.py:22:5: D103 Missing docstring in public function
test_apply.py:38:5: PD901 `df` is a bad variable name. Be kinder to your future self.
.....(Hide more)
```
[full_terminal_content.txt](https://github.com/charliermarsh/ruff/files/11420281/full_terminal_content.txt)
### Command(Powershell): --isolated
```powershell
ruff check --select=ALL --isolated .\test_apply.py
```
[full_terminal_content_isolated.txt](https://github.com/charliermarsh/ruff/files/11420301/full_terminal_content_isolated.txt)
## Python Code
**Please change the file extension from txt to py**
[test_apply.txt](https://github.com/charliermarsh/ruff/files/11420307/test_apply.txt)
## pyproject.toml
**Please change the file extension from txt to toml**
[pyproject.txt](https://github.com/charliermarsh/ruff/files/11420318/pyproject.txt)



---

_Comment by @MichaReiser on 2023-05-08 12:26_

This is a bug in the fix of PD002

It creates an invalid fix for 

```py
def test_apply_no_name_column_conflict():
    df = DataFrame(
        {
            "name": [1, 1, 1, 1, 1, 1, 2, 2, 2, 2],
            "name2": [0, 0, 0, 1, 1, 1, 0, 0, 1, 1],
            "value": range(9, -1, -1),
        }
    )

    # it works! #2605
    grouped = df.groupby(["name", "name2"])
    grouped.apply(lambda x: x.sort_values("value", inplace=True))
```

Suggested fixes

```
PD002.py:36:31: E999 SyntaxError: invalid syntax. Got unexpected token '='
   |
36 |     # it works! #2605
37 |     grouped = df.groupby(["name", "name2"])
38 |     grouped.apply(lambda x: x = x.sort_values("value"))
   |                               ^ E999
   |


Last generated fixes:
PD002.py:5:23: PD002 [*] `inplace=True` should be avoided; it has inconsistent behavior
  |
5 | x = pd.DataFrame()
6 | 
7 | x.drop(["a"], axis=1, inplace=True)
  |                       ^^^^^^^^^^^^ PD002
8 | 
9 | x.drop(["a"], axis=1, inplace=True)
  |
  = help: Assign to variable; remove `inplace` arg

ℹ Suggested fix
2 2 | 
3 3 | x = pd.DataFrame()
4 4 | 
5   |-x.drop(["a"], axis=1, inplace=True)
  5 |+x = x.drop(["a"], axis=1)
6 6 | 
7 7 | x.drop(["a"], axis=1, inplace=True)
8 8 | 

PD002.py:7:23: PD002 [*] `inplace=True` should be avoided; it has inconsistent behavior
   |
 7 | x.drop(["a"], axis=1, inplace=True)
 8 | 
 9 | x.drop(["a"], axis=1, inplace=True)
   |                       ^^^^^^^^^^^^ PD002
10 | 
11 | x.drop(
   |
   = help: Assign to variable; remove `inplace` arg

ℹ Suggested fix
4 4 | 
5 5 | x.drop(["a"], axis=1, inplace=True)
6 6 | 
7   |-x.drop(["a"], axis=1, inplace=True)
  7 |+x = x.drop(["a"], axis=1)
8 8 | 
9 9 | x.drop(
10 10 |     inplace=True,

PD002.py:10:5: PD002 [*] `inplace=True` should be avoided; it has inconsistent behavior
   |
10 | x.drop(
11 |     inplace=True,
   |     ^^^^^^^^^^^^ PD002
12 |     columns=["a"],
13 |     axis=1,
   |
   = help: Assign to variable; remove `inplace` arg

ℹ Suggested fix
6  6  | 
7  7  | x.drop(["a"], axis=1, inplace=True)
8  8  | 
9     |-x.drop(
10    |-    inplace=True,
   9  |+x = x.drop(
11 10 |     columns=["a"],
12 11 |     axis=1,
13 12 | )

PD002.py:17:9: PD002 [*] `inplace=True` should be avoided; it has inconsistent behavior
   |
17 | if True:
18 |     x.drop(
19 |         inplace=True,
   |         ^^^^^^^^^^^^ PD002
20 |         columns=["a"],
21 |         axis=1,
   |
   = help: Assign to variable; remove `inplace` arg

ℹ Suggested fix
13 13 | )
14 14 | 
15 15 | if True:
16    |-    x.drop(
17    |-        inplace=True,
   16 |+    x = x.drop(
18 17 |         columns=["a"],
19 18 |         axis=1,
20 19 |     )

PD002.py:22:33: PD002 [*] `inplace=True` should be avoided; it has inconsistent behavior
   |
22 |     )
23 | 
24 | x.drop(["a"], axis=1, **kwargs, inplace=True)
   |                                 ^^^^^^^^^^^^ PD002
25 | x.drop(["a"], axis=1, inplace=True, **kwargs)
26 | f(x.drop(["a"], axis=1, inplace=True))
   |
   = help: Assign to variable; remove `inplace` arg

ℹ Suggested fix
19 19 |         axis=1,
20 20 |     )
21 21 | 
22    |-x.drop(["a"], axis=1, **kwargs, inplace=True)
   22 |+x = x.drop(["a"], axis=1, **kwargs)
23 23 | x.drop(["a"], axis=1, inplace=True, **kwargs)
24 24 | f(x.drop(["a"], axis=1, inplace=True))
25 25 | 

PD002.py:23:23: PD002 `inplace=True` should be avoided; it has inconsistent behavior
   |
23 | x.drop(["a"], axis=1, **kwargs, inplace=True)
24 | x.drop(["a"], axis=1, inplace=True, **kwargs)
   |                       ^^^^^^^^^^^^ PD002
25 | f(x.drop(["a"], axis=1, inplace=True))
   |

PD002.py:24:25: PD002 `inplace=True` should be avoided; it has inconsistent behavior
   |
24 | x.drop(["a"], axis=1, **kwargs, inplace=True)
25 | x.drop(["a"], axis=1, inplace=True, **kwargs)
26 | f(x.drop(["a"], axis=1, inplace=True))
   |                         ^^^^^^^^^^^^ PD002
   |

PD002.py:38:52: PD002 [*] `inplace=True` should be avoided; it has inconsistent behavior
   |
38 |     # it works! #2605
39 |     grouped = df.groupby(["name", "name2"])
40 |     grouped.apply(lambda x: x.sort_values("value", inplace=True))
   |                                                    ^^^^^^^^^^^^ PD002
   |
   = help: Assign to variable; remove `inplace` arg

ℹ Suggested fix
35 35 | 
36 36 |     # it works! #2605
37 37 |     grouped = df.groupby(["name", "name2"])
38    |-    grouped.apply(lambda x: x.sort_values("value", inplace=True))
   38 |+    grouped.apply(lambda x: x = x.sort_values("value"))
```

Source with fixes applied

```py
def test_apply_no_name_column_conflict():
    df = DataFrame(
        {
            "name": [1, 1, 1, 1, 1, 1, 2, 2, 2, 2],
            "name2": [0, 0, 0, 1, 1, 1, 0, 0, 1, 1],
            "value": range(9, -1, -1),
        }
    )

    # it works! #2605
    grouped = df.groupby(["name", "name2"])
    grouped.apply(lambda x: x = x.sort_values("value"))
```

---

_Label `bug` added by @MichaReiser on 2023-05-08 12:26_

---

_Comment by @dhruvmanila on 2023-05-08 12:58_

Right! `lambda` expressions can't have assignment statements. This should be an easy fix :)

---

_Comment by @charliermarsh on 2023-05-08 12:59_

We definitely have guards against this somewhere else (to avoid fixes that convert expressions-to-statements when within an expression)... Maybe the rule that converts lambdas to function definitions, in Pyflakes?

---

_Comment by @dhruvmanila on 2023-05-08 13:04_

My first thought was to _just_ remove the `inplace = True` and _not_ add the assignment when inside a `lambda` scope. The reason being that when `inplace` is `True` the function will return `None`, while in the other case it'll return a new object. As `lambda` expressions return whatever they evaluate, I thought the above solution would make sense.

Do we want to continue with that or just avoid to fix?

---

_Comment by @charliermarsh on 2023-05-08 14:11_

I think we should just avoid the fix, since merely removing `inplace = True` could lead to unintended changes in code behavior.

---

_Referenced in [astral-sh/ruff#4286](../../astral-sh/ruff/pulls/4286.md) on 2023-05-08 14:58_

---

_Closed by @charliermarsh on 2023-05-08 18:24_

---
