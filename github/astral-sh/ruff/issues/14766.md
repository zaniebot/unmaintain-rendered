---
number: 14766
title: "[`ruff`] Formatting hex codes changes output with f-string debug"
type: issue
state: closed
author: MeGaGiGaGon
labels:
  - bug
  - formatter
assignees: []
created_at: 2024-12-04T07:43:41Z
updated_at: 2025-01-07T13:32:30Z
url: https://github.com/astral-sh/ruff/issues/14766
synced_at: 2026-01-07T12:31:13-06:00
---

# [`ruff`] Formatting hex codes changes output with f-string debug

---

_Issue opened by @MeGaGiGaGon on 2024-12-04 07:43_

I had this idea while reading https://github.com/psf/black/issues/4522 when @MichaReiser said ruff had already stabilized hex code formatting.

I don't actively use ruff/am not familiar with it, but I assume that just like black formatting code should not have an observable runtime effect.

[playground link](https://play.ruff.rs/de93de37-677a-4e26-a125-d2a3b2504a62) formatting `f"{r'\xFF'=}"` gives `f"{r'\xff'=}"`
```pycon
>>> f"{r"\xFF"=}"
'r"ÿ"=\'\\\\xFF\''
>>> f"{r"\xff"=}"
'r"ÿ"=\'\\\\xff\''
```

---

_Comment by @MichaReiser on 2024-12-04 07:48_

Oh that's a nice find! 

Funny enough, this is fixed in the new preview style [playground](https://play.ruff.rs/b59dbaa9-f6a8-402d-8b99-a8b5be707c26)

---

_Label `bug` added by @MichaReiser on 2024-12-04 07:50_

---

_Label `formatter` added by @MichaReiser on 2024-12-04 07:50_

---

_Referenced in [astral-sh/ruff#13371](../../astral-sh/ruff/issues/13371.md) on 2024-12-04 07:51_

---

_Referenced in [astral-sh/ruff#14926](../../astral-sh/ruff/issues/14926.md) on 2024-12-11 21:22_

---

_Comment by @dhruvmanila on 2024-12-12 06:00_

Is this a bug in the CPython parser? Why does it parse the hex code even though it is a raw string?

```
❯ uv run --python=3.12 python
>>> import ast

>>> f"{r"\xFF"=}"
'r"ÿ"=\'\\\\xFF\''

>>> print(ast.dump(ast.parse(r'f"{r"\xFF"=}"'), indent=2))
Module(
  body=[
    Expr(
      value=JoinedStr(
        values=[
          Constant(value='r"ÿ"='),
          FormattedValue(
            value=Constant(value='\\xFF'),
            conversion=114)]))],
  type_ignores=[])

>>> r"\xFF"
'\\xFF'
```

---

_Comment by @MichaReiser on 2024-12-12 06:55_

You mean why the hex code is interpreted in the debug expression? I don't know. It is surprising and I couldn't find anything in the [f-string lexing section](https://docs.python.org/3/reference/lexical_analysis.html#formatted-string-literals) indicating why it should (it only says that it calls `repr(expr)` 

I somewhat suspect that python parses everything before the `=` as a regular string and uses that in the debug expression because Python can't go back to the source for an expression, unlike we can.

---

_Comment by @dhruvmanila on 2024-12-12 07:16_

> You mean why the hex code is interpreted in the debug expression?

Yes

> I somewhat suspect that python parses everything before the `=` as a regular string and uses that in the debug expression because Python can't go back to the source for an expression, unlike we can.

Yeah, that's what I thought as well but it's a bit surprising.

---

_Comment by @MichaReiser on 2024-12-12 08:03_

> Yeah, that's what I thought as well but it's a bit surprising.

Definitely. It's not what I expected. 

---

_Comment by @dhruvmanila on 2024-12-12 09:09_

Should this be closed as it's "resolved" on `main` ?

---

_Comment by @MichaReiser on 2024-12-12 09:11_

We could. I kept it open to make it clear it's part of the Ruff 2025 style guide and it requires fixing if we, for whatever reason, decide not to stabilize f-string formatting. 

---

_Comment by @MichaReiser on 2024-12-12 09:11_

Let me add a test for this :)

---

_Referenced in [astral-sh/ruff#14929](../../astral-sh/ruff/pulls/14929.md) on 2024-12-12 09:28_

---

_Comment by @dscorbett on 2024-12-12 13:02_

> Is this a bug in the CPython parser?

I think so: I opened https://github.com/python/cpython/issues/124363.

---

_Comment by @MichaReiser on 2025-01-07 13:32_

I'll close this because we're about to release the new style guide and I'm sure I forget to close it otherwise. Look out for the 0.9 release ;)

---

_Closed by @MichaReiser on 2025-01-07 13:32_

---

_Referenced in [Homebrew/homebrew-core#203745](../../Homebrew/homebrew-core/pulls/203745.md) on 2025-01-09 17:12_

---
