---
number: 21890
title: PERF403 update suggestion will make code slower
type: issue
state: open
author: hauntsaninja
labels:
  - bug
  - rule
assignees: []
created_at: 2025-12-10T09:21:20Z
updated_at: 2025-12-15T17:54:52Z
url: https://github.com/astral-sh/ruff/issues/21890
synced_at: 2026-01-07T12:31:14-06:00
---

# PERF403 update suggestion will make code slower

---

_Issue opened by @hauntsaninja on 2025-12-10 09:21_

### Summary

Was looking at PERF rules, noticed one of the transformations it suggests will make code like 1.4x slower

```python
import timeit


def main1():
    d = {}
    for x in range(8):
        for i, j in zip(range(x), range(x)):
            d[i] = j


def main2():
    d = {}
    for x in range(8):
        d.update({i: j for i, j in zip(range(x), range(x))})


if __name__ == "__main__":
    print(timeit.timeit(main1, number=10_000))
    print(timeit.timeit(main2, number=10_000))
```

```
λ python test.py
0.01902620808687061
0.026080582989379764
```

### Version

_No response_

---

_Referenced in [astral-sh/ruff#21891](../../astral-sh/ruff/issues/21891.md) on 2025-12-10 09:37_

---

_Label `rule` added by @ntBre on 2025-12-10 16:26_

---

_Label `needs-decision` added by @ntBre on 2025-12-10 16:26_

---

_Comment by @amyreese on 2025-12-10 20:06_

It's also a verbose fix, and at least in this case a much better fix should just be:

```py
def main3():
    d = {}
    for x in range(8):
        d.update(zip(range(x), range(x)))
```

When run on my machine with 3.14, it beats the first two versions:

```
0.01532745803706348
0.019240333000198007
0.012530624982900918
```


---

_Comment by @hauntsaninja on 2025-12-10 21:04_

Yup! In this and https://github.com/astral-sh/ruff/issues/21891 , the things that trigger my "this rule is probably counterproductive" sense are 1) creating generators where none existed previously, 2) instantiating temporary dicts/lists

---

_Comment by @AlexWaygood on 2025-12-10 21:18_

To me this and https://github.com/astral-sh/ruff/issues/21891 seem like pretty clear bugs. I don't think `PERF` autofixes or recommendations should ever make your code slower — if the motivation for a rule is more "stylistic consistency" rather than "micro-optimisations", then I don't think the rule belongs in the `PERF` category at all. Even if we decide we don't want to make any changes here to how the rule works, at the very least I think we should document that the rule sometimes makes suggestions that can lead to slowdowns — as a Ruff user, that's not at all what I'd expect a `PERF` rule to ever do

---

_Label `needs-decision` removed by @MichaReiser on 2025-12-11 08:43_

---

_Label `bug` added by @MichaReiser on 2025-12-11 08:43_

---

_Comment by @dylwil3 on 2025-12-15 16:31_

A general issue with the `PERF` rules is that most of them seem dependent on CPython internals. It may very well be version specific whether these suggestions reliably give a speedup or not (e.g. https://docs.astral.sh/ruff/rules/try-except-in-loop/ where we end up skipping the rule in version 3.11+). Not sure the best way to handle this. Maybe we should be adding micro-benchmarks that get checked periodically on various Python versions? (seems a little unwieldy)

---

_Comment by @ntBre on 2025-12-15 17:54_

Yeah, that's why I didn't immediately consider these to be bugs. I found at least one case in #21891 where the `extend` version is actually faster. Assuming we don't want to maintain such a list of microbenchmarks, I would probably lean toward framing these rules as stylistic rather than performance-oriented, as Alex mentioned (and some day moving them out of a `PERF` or `performance` category entirely).

On the other hand, it also seems reasonable to me to drop the `extend`/`update` parts of the rules. Those intuitively feel like they would be slower and also don't feel like as much of a stylistic improvement to me as replacing a whole loop with a single comprehension.

---
