---
number: 5794
title: "Does `crates/ruff/resources/test/fixtures/pyupgrade/UP014.py` contain incorrect `NamedTuple` calls?"
type: issue
state: closed
author: harupy
labels: []
assignees: []
created_at: 2023-07-16T02:43:00Z
updated_at: 2023-07-17T01:31:55Z
url: https://github.com/astral-sh/ruff/issues/5794
synced_at: 2026-01-07T12:31:12-06:00
---

# Does `crates/ruff/resources/test/fixtures/pyupgrade/UP014.py` contain incorrect `NamedTuple` calls?

---

_Issue opened by @harupy on 2023-07-16 02:43_

<!--
Thank you for taking the time to report an issue! We're glad to have you involved with Ruff.

If you're filing a bug report, please consider including the following information:

* A minimal code snippet that reproduces the bug.
* The command you invoked (e.g., `ruff /path/to/file.py --fix`), ideally including the `--isolated` flag.
* The current Ruff settings (any relevant sections from your `pyproject.toml`).
* The current Ruff version (`ruff --version`).
-->

https://github.com/astral-sh/ruff/blob/f012ed2d77272bfdd75f6988c2658e36fbf63102/crates/ruff/resources/test/fixtures/pyupgrade/UP014.py#L7-L12

Is this a valid `NamedTuple` call?


```
> python3 --version
Python 3.11.4

> cat a.py
from typing import NamedTuple

MyType = NamedTuple(
    "MyType",
    [("a", int), ("b", str), ("c", list[bool])],
    defaults=["foo", [True]],
)

> python a.py
Traceback (most recent call last):
  File "/home/haru/Desktop/repositories/ruff/a.py", line 3, in <module>
    MyType = NamedTuple(
             ^^^^^^^^^^^
  File "/home/haru/miniconda3/envs/py311/lib/python3.11/typing.py", line 2916, in NamedTuple
    raise TypeError("Either list of fields or keywords"
TypeError: Either list of fields or keywords can be provided to NamedTuple, not both
```

---

_Renamed from "Does `crates/ruff/resources/test/fixtures/pyupgrade/UP014.py` contains incorrect `NamedTuple` calls?" to "Does `crates/ruff/resources/test/fixtures/pyupgrade/UP014.py` contain incorrect `NamedTuple` calls?" by @harupy on 2023-07-16 02:43_

---

_Comment by @harupy on 2023-07-16 03:21_

or is this intended?

---

_Comment by @cnpryer on 2023-07-16 03:22_

> Is this a valid NamedTuple call?

If I understand this function signature correctly, no, right?

https://github.com/python/cpython/blob/8c177294899b621fe04ae755abd41b4d319dd4b5/Lib/typing.py#L2770

```py
def NamedTuple(typename, fields=_sentinel, /, **kwargs):
```

edit: [it's recently changed](https://github.com/python/cpython/pull/105609/files#diff-ddb987fca5f5df0c9a2f5521ed687919d70bb3d64eaeb8021f98833a2a716887)

---

_Comment by @cnpryer on 2023-07-16 03:25_

> or is this intended?

Is this what you saw?

```py
from typing import NamedTuple
 
MyType = NamedTuple(
    "MyType",
    [("a", int), ("b", str), ("c", list[bool])],
    defaults=["foo", [True]],
)
```
```
crates/ruff_python_formatter/scratch.py:6:16: F821 Undefined name `foo`
Found 1 error.
```

---

_Comment by @harupy on 2023-07-16 03:31_

I saw that, and then found this issue. What I meant by `is this intended` was:

```python
MyType = NamedTuple(
    "MyType",
    [("a", int), ("b", str), ("c", list[bool])],
    defaults=[1, "foo", [True]],
)
```

is an invalid `NamedTuple` call, but syntactically correct. It could be useful if ruff automatically fixes this to:

```python
class MyType(NamedTuple):
    a: int = 1
    b: str = "foo"
    c: list[bool] = [True]
```

Ruff currently does.

---

_Comment by @charliermarsh on 2023-07-16 04:18_

I think it's intended, just to see how we would handle that case, even if it's not valid at runtime.

---

_Comment by @harupy on 2023-07-16 04:29_

Makes sense. Is F821 on `foo` unintended (https://github.com/astral-sh/ruff/issues/5794#issuecomment-1636970152)?

---

_Comment by @charliermarsh on 2023-07-16 04:49_

Is passing `defaults` as a list supported at all? I wonder why we support that at all? (Maybe that's why you opened the issue and I just misunderstood.)

---

_Comment by @charliermarsh on 2023-07-16 04:50_

(I assumed there was some case in which passing a list of defaults was supported, just that you couldn't mix it with specifying the fields that way.)

---

_Comment by @harupy on 2023-07-16 04:56_

```python
from typing import NamedTuple

# valid
MyType = NamedTuple(
    "MyType",
    defaults=str,
)

# valid
MyType = NamedTuple(
    "MyType",
    defaults=list[str],
)

# invalid, doesn't throw but doesn't make sense because `[str]` is not a valid type annotation
MyType = NamedTuple(
    "MyType",
    defaults=[str],
)

# invalid, throws `TypeError: Either list of fields or keywords can be provided to NamedTuple, not both`
MyType = NamedTuple(
    "MyType",
    [("a", int), ("b", str), ("c", list[bool])],
    defaults=[1, "foo", [True]],
)
```

You can pass a list to `defaults` as the third example does, but that makes no sense (it would make sense if `[str]` was an alias for `list[str]`).

---

_Comment by @charliermarsh on 2023-07-16 05:07_

In each case, `defaults` is just treated as a standard field though, right? I feel like UP014 is under the mistaken impression that you can provide a list of default values via `defaults`... If so, we should remove that.

---

_Comment by @charliermarsh on 2023-07-16 05:08_

Yeah, we should remove all the special-casing around `defaults`.

---

_Comment by @charliermarsh on 2023-07-16 05:10_

E.g., this and related code seems unnecessary:

```rust
/// Match the `defaults` keyword in a `NamedTuple(...)` call.
fn match_defaults(keywords: &[Keyword]) -> Result<&[Expr]> {
    let defaults = keywords.iter().find(|keyword| {
        if let Some(arg) = &keyword.arg {
            arg == "defaults"
        } else {
            false
        }
    });
    match defaults {
        Some(defaults) => match &defaults.value {
            Expr::List(ast::ExprList { elts, .. }) => Ok(elts),
            Expr::Tuple(ast::ExprTuple { elts, .. }) => Ok(elts),
            _ => bail!("Expected defaults to be `Expr::List` | `Expr::Tuple`"),
        },
        None => Ok(&[]),
    }
}
```

---

_Comment by @harupy on 2023-07-16 05:12_

I agree.

> In each case, defaults is just treated as a standard field though, right?

`defaults` is visited as a type annotation:

https://github.com/astral-sh/ruff/blob/d692ed08961cbdc56a9f254fba906bd6d3b711d8/crates/ruff/src/checkers/ast/mod.rs#L3690-L3695


Ruff thinks `"foo"` is a forward ref, but no `foo` exists, F821 is thrown on it.

---

_Comment by @harupy on 2023-07-16 05:23_

Happy to file a PR.

---

_Referenced in [astral-sh/ruff#5799](../../astral-sh/ruff/pulls/5799.md) on 2023-07-16 05:35_

---

_Closed by @charliermarsh on 2023-07-17 01:31_

---
