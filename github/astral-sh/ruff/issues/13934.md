---
number: 13934
title: TCH auto-quoting is invalid for strings containing quotation marks 
type: issue
state: closed
author: dscorbett
labels:
  - bug
  - help wanted
assignees: []
created_at: 2024-10-25T22:18:25Z
updated_at: 2024-11-15T11:11:48Z
url: https://github.com/astral-sh/ruff/issues/13934
synced_at: 2026-01-07T12:31:13-06:00
---

# TCH auto-quoting is invalid for strings containing quotation marks 

---

_Issue opened by @dscorbett on 2024-10-25 22:18_

The automated fixes for TCH001, TCH002, and TCH003 do not correctly handle string literals containing quotation marks. In the following example, running Ruff introduces an invalid type annotation, which mypy reports.

```console
$ ruff --version
ruff 0.7.1

$ cat tch.py
from collections.abc import Sequence
from typing import Literal
def f(x: Sequence[Literal["'"]]) -> None:
    pass

$ mypy tch.py
Success: no issues found in 1 source file

$ ruff check --isolated --config 'lint.flake8-type-checking.quote-annotations = true' --select TCH tch.py --unsafe-fixes --fix
Found 1 error (1 fixed, 0 remaining).

$ cat tch.py
from typing import Literal, TYPE_CHECKING

if TYPE_CHECKING:
    from collections.abc import Sequence
def f(x: "Sequence[Literal[''']]") -> None:
    pass

$ mypy tch.py
tch.py:5: error: Invalid type comment or annotation  [valid-type]
Found 1 error in 1 file (checked 1 source file)
```

---

_Label `bug` added by @MichaReiser on 2024-10-26 07:59_

---

_Label `help wanted` added by @MichaReiser on 2024-10-26 07:59_

---

_Comment by @MichaReiser on 2024-10-26 08:01_

As with other string related fixes, we could consider disabling the fix if the string contains nested quotes. Ideally we would be somewhat clever about it to only disable it when running the fix creates invalid syntax because the use of `Literal["Test"]` is common

---

_Comment by @dhruvmanila on 2024-10-28 07:36_

> Ideally we would be somewhat clever about it to only disable it when running the fix creates invalid syntax because the use of `Literal["Test"]` is common

I'm not sure what do you mean here because we do fix this correctly by flipping the quotes but we don't consider nested quotes inside another existing string literal (https://play.ruff.rs/fc94efc6-2ccf-4b20-b053-f810a7d06c2f). I think we should avoid generating the fix for this case.

cc @Glyphack if you're interested

---

_Comment by @MichaReiser on 2024-10-28 07:51_

> I'm not sure what do you mean here because we do fix this correctly by flipping the quotes but we don't consider nested quotes inside another existing string literal ([play.ruff.rs/fc94efc6-2ccf-4b20-b053-f810a7d06c2f](https://play.ruff.rs/fc94efc6-2ccf-4b20-b053-f810a7d06c2f)).

That's what I mean. We can't just naively test if the annotation contains any quotes. Instead, we have to search for nested quotes. 

---

_Comment by @Glyphack on 2024-10-28 08:10_

Thanks I like to spend some time on this. I think the simplest fix would be to check if the StringLiteral contains any quotes inside and don't apply the fix or check if the inner quotes will be a problem and then don't apply the fix.

---

_Comment by @dscorbett on 2024-10-28 16:56_

Other characters to beware of are backslashes and newlines.

---

_Referenced in [astral-sh/ruff#14132](../../astral-sh/ruff/issues/14132.md) on 2024-11-06 13:19_

---

_Referenced in [astral-sh/ruff#14285](../../astral-sh/ruff/pulls/14285.md) on 2024-11-11 18:48_

---

_Closed by @dhruvmanila on 2024-11-15 11:11_

---

_Closed by @dhruvmanila on 2024-11-15 11:11_

---
