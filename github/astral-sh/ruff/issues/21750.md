---
number: 21750
title: "`F704` wrong \"await outside of a function\" when using generators"
type: issue
state: closed
author: PabloRuizCuevas
labels:
  - bug
assignees: []
created_at: 2025-12-02T10:55:27Z
updated_at: 2025-12-02T21:02:03Z
url: https://github.com/astral-sh/ruff/issues/21750
synced_at: 2026-01-07T12:31:14-06:00
---

# `F704` wrong "await outside of a function" when using generators

---

_Issue opened by @PabloRuizCuevas on 2025-12-02 10:55_

### Summary

### Describe the Bug
Await can be outside of a function if is in code that won't be executed automatically (ex: async generators).

> `await` statement outside of a function

This code is correct, yet ruff complains:

```python
import asyncio

async def test2():
    return "test"

async def a_gen():
    for i in range(3):
        yield test2()

a = (await cor async for cor in a_gen()) # `await` statement outside of a function F704

async def main():
    async for i in a:
        print(i)

if __name__ == "__main__":
    asyncio.run(main())
```

I suggest changing F704  so awaits are ok inside async generators that are basically syntax sugar of a function.

of course for now we can do the equivalent:

```python
async def a():
    for cor in a_gen():
        yield await cor
```

### Version

_No response_

---

_Renamed from "F704 wrong "await outside of a function" when using generators" to "`PLE1142` wrong "await outside of a function" when using generators" by @MichaReiser on 2025-12-02 13:08_

---

_Renamed from "`PLE1142` wrong "await outside of a function" when using generators" to "`F704` wrong "await outside of a function" when using generators" by @MichaReiser on 2025-12-02 13:09_

---

_Label `bug` added by @MichaReiser on 2025-12-02 13:10_

---

_Comment by @MichaReiser on 2025-12-02 13:11_

Thanks. I consider this a bug in our semantic rules. I'm a bit surprised that `F704` flags awaits, given that we also have `PLE1142` (which correctly detects that we shouldn't flag this await usage).



---

_Comment by @ntBre on 2025-12-02 14:01_

I think we'll just need to update our `in_await_allowed_context` methods to return true for async generators:

https://github.com/astral-sh/ruff/blob/0e651b50b7d0c2614c5958e78525213e759e5b41/crates/ruff_linter/src/checkers/ast/mod.rs#L777-L782

It looks like I just missed this case in #17298.

---

_Comment by @MichaReiser on 2025-12-02 15:56_

Might be worth a bug fix PR if that's indeed all that's necessary

---

_Assigned to @ntBre by @ntBre on 2025-12-02 18:34_

---

_Referenced in [astral-sh/ruff#21763](../../astral-sh/ruff/pulls/21763.md) on 2025-12-02 19:57_

---

_Closed by @ntBre on 2025-12-02 21:02_

---
