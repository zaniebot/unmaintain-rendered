---
number: 11246
title: "Can't run ruff when installed with pip target dir option"
type: issue
state: closed
author: nunoh
labels:
  - question
assignees: []
created_at: 2024-05-02T11:45:23Z
updated_at: 2024-08-15T11:27:18Z
url: https://github.com/astral-sh/ruff/issues/11246
synced_at: 2026-01-07T12:31:13-06:00
---

# Can't run ruff when installed with pip target dir option

---

_Issue opened by @nunoh on 2024-05-02 11:45_

Can't run ruff when installed with pip [target dir option](https://pip.pypa.io/en/stable/cli/pip_install/#cmdoption-t) `pip install ruff -t lib`

MRE
```bash
pip install -t ruff lib
PYTHONPATH=lib python -m ruff --help
```
breaks with 
```
Traceback (most recent call last):
  File "<frozen runpy>", line 198, in _run_module_as_main
  File "<frozen runpy>", line 88, in _run_code
  File "xxxxxxxxxxxxxx/lib/ruff/__main__.py", line 32, in <module>
    ruff = os.fsdecode(find_ruff_bin())
                       ^^^^^^^^^^^^^^^
  File "xxxxxxxxxxxxxx/lib/ruff/__main__.py", line 28, in find_ruff_bin
    raise FileNotFoundError(path)
FileNotFoundError: /xxxxx/.local/bin/ruff
```

Versions:
- ruff: 0.4.2
- pip:  23.2.1
- python: 3.11.7


---

_Comment by @charliermarsh on 2024-05-02 14:27_

This is really a problem with and limitation of `--target`, not Ruff. `--target` isn't intended to install binaries, and binaries installed with target often may not work (e.g., any Python scripts will have the current interpreter encoded in the shebang, but `--target` is designed for zipapp-like use cases whereby you relocate the directory, and none of those shebangs will be correct in those cases). I suggest either _not_ using target, or invoking the Ruff binary directly. There's just no way for `python -m ruff` to know where to look when installed with `--target`.


---

_Label `question` added by @charliermarsh on 2024-05-02 14:28_

---

_Comment by @nunoh on 2024-05-02 15:09_

I tried the same MRE with different libraries without an issue, but now with your explanation I understand why it doesn't work for ruff. I just defaulted to invoking the binary directly rather. Thank you for taking the time to provide the info and congrats on such a great tool! Cheers

---

_Closed by @MichaReiser on 2024-05-02 15:37_

---

_Referenced in [businho/pytest-ruff#21](../../businho/pytest-ruff/issues/21.md) on 2024-05-16 13:50_

---

_Comment by @jaraco on 2024-05-16 13:57_

I have this issue also, and it affects Python environments created by [pip-run](https://github.com/jaraco/pip-run). `pip-run` uses `pip install --target` for its simplicity and ability to compose with other environments.

```
 @ pip-run ruff -- -m ruff
Traceback (most recent call last):
  File "<frozen runpy>", line 198, in _run_module_as_main
  File "<frozen runpy>", line 88, in _run_code
  File "/var/folders/f2/2plv6q2n7l932m2x004jlw340000gn/T/pip-run-jj5jhwxq/ruff/__main__.py", line 32, in <module>
    ruff = os.fsdecode(find_ruff_bin())
                       ^^^^^^^^^^^^^^^
  File "/var/folders/f2/2plv6q2n7l932m2x004jlw340000gn/T/pip-run-jj5jhwxq/ruff/__main__.py", line 28, in find_ruff_bin
    raise FileNotFoundError(path)
FileNotFoundError: /Users/jaraco/Library/Python/3.12/bin/ruff
```

In any case, shouldn't `find_ruff_binary` fail if it cannot reliably locate the binary? Before I re-write pytest-ruff not to use `ruff.find_ruff_binary`, would you consider some alternative approaches?

- Add support for `--target` installs by searching in a `bin` directory in the package root where `ruff` is installed (works even on Windows).
- Check that the "found" binary exists and if not, fall back to a PATH search (i.e. `shutil.which('ruff')`). Such a search would not find the binary in the `target` unless the user had also added the `bin` directory to the PATH.
- ~~Simply error when the "found" binary doesn't exist.~~

---

_Comment by @jaraco on 2024-05-16 14:57_

I see now that ruff does actually raise a `FileNotFoundError` if the "found" binary isn't present. I missed that nuance when looking at `pytest-ruff`.

I would have expected/hoped that `pip-run ruff -- !ruff` (binary invocation) would have worked, because it would bypass the Python shim, ~~but it does not~~:

```
 draft @ pip-run ruff -- !ruff
/opt/homebrew/Cellar/python@3.12/3.12.3/Frameworks/Python.framework/Versions/3.12/Resources/Python.app/Contents/MacOS/Python: can't open file '/Users/jaraco/draft/ruff': [Errno 2] No such file or directory
```

~~That may just be a bug in pip-run, though, where it may not be resolving the `ruff` binary in the PATH.~~

Edit: I was holding it wrong. In my shell, the `!` needs to be escaped, whereafter the binary invocation does work as expected:

```
 ~ @ pip-run ruff -- '!ruff' --version
ruff 0.4.4
```

---

_Referenced in [astral-sh/ruff#11450](../../astral-sh/ruff/pulls/11450.md) on 2024-05-16 15:32_

---

_Comment by @kserhii on 2024-08-15 11:26_

I also caught `FileNotFoundError`, but in my case it was related to the usage of `ruff` in docker container. 

In Dockerfile I am installing requirements under root user and then switching to another user.
In that case `ruff` binary is placed in `/usr/local/bin`, while `find_ruff_bin` gives me `/home/user/.local/bin` folder.
The quick fix is to add environment variable `PYTHONUSERBASE=/usr/local`.

---
