---
number: 16071
title: "Unify `OperatorPrecedence` enums"
type: issue
state: closed
author: MichaReiser
labels:
  - internal
  - help wanted
assignees: []
created_at: 2025-02-10T08:56:00Z
updated_at: 2025-03-21T13:23:01Z
url: https://github.com/astral-sh/ruff/issues/16071
synced_at: 2026-01-07T12:31:13-06:00
---

# Unify `OperatorPrecedence` enums

---

_Issue opened by @MichaReiser on 2025-02-10 08:56_

### Description

There are now 3 `OperatorPrecedence` structs in ruff

* Formatter (only the expression one, the pattern one is different)
* Linter
* Parser

1. [x] Move the Linter `OperatorPrecedence` struct into ruff-python-ast and expose a `precedence()` method on `Expr` (and `ExpressionRef) and ideally on each Expression node. 
2. [ ] Try to replace some of the other `OperatorPrecedence` structs with the one now defined in the AST crate

Ideally, these would be two separate PRs

---

_Label `internal` added by @MichaReiser on 2025-02-10 08:56_

---

_Referenced in [astral-sh/ruff#15919](../../astral-sh/ruff/pulls/15919.md) on 2025-02-10 08:56_

---

_Label `help wanted` added by @MichaReiser on 2025-02-10 08:58_

---

_Comment by @junhsonjb on 2025-02-13 03:53_

I can take this on, I have a few questions though 
- what is the `ExpressionRef` type? I'm grepping around and I only see `LiteralExpressionRef`, is that what you're referring to?
- when you say "Expression node", are you referring to the `Expr` struct that's implemented in `ruff_python_linter/src/nodes.rs`?

---

_Comment by @MichaReiser on 2025-02-13 08:06_

> what is the ExpressionRef type? I'm g

Oh, I forgot that it was renamed. It's [`ExprRef`](https://github.com/astral-sh/ruff/blob/ef85c682bdd76ed63457bdfbec72e09424ac20ab/crates/ruff_python_ast/src/generated.rs#L1738).

 
> when you say "Expression node", are you referring to the Expr struct that's implemented in ruff_python_linter/src/nodes.rs?

Yes, but the file is in the `ruff_python_ast` crate ([source](https://github.com/astral-sh/ruff/blob/ef85c682bdd76ed63457bdfbec72e09424ac20ab/crates/ruff_python_ast/src/generated.rs#L271))



---

_Comment by @InSyncWithFoo on 2025-02-14 08:50_

This needs some good design. The fix results in #15919 weren't as nice as I'd want them to be. I found no easy way to avoid parenthesizing when unnecessary:

```python
  2 ** -2  # Intended result: 0.25
# ^^^^^^^ This doesn't need parentheses

  -2 ** 2  # Intended result: 4
# ^^ This does
```

The newest `OperatorPrecedence` accepts an expression and output the precedence of the operator that expression represents, but it doesn't consider the context.

```python
# This entire subscript resolves to the precedence of the subscript operator,
# while its slice resolves to that of the unary `-`.
lorem[-ipsum]

# `[]` binds more tightly than `-`,
# so a simple precedence comparison would result in the expected output for this case,
# where `-` is supposed to apply to `lorem` alone:
(-lorem)[ipsum]  # Necessary

# On the other hand, the slice expression doesn't need parenthesizing.
# The comparison result alone isn't enough to avoid this:
lorem[(-ipsum)]  # Unnecessary
```

A more complex example:

```python
  (a + 1)(
# ^^^^^^^ This needs extra parentheses, as binary `+` binds less tightly than `()`
      a + 1,
#     ^^^^^ This doesn't, as it is an argument
      b := 0,
#     ^^^^^^ This also doesn't; bare named expressions can be passed positionally.
      c = (d := -1)
#         ^^^^^^^^^ But this does.
  )
```


---

_Referenced in [astral-sh/ruff#16162](../../astral-sh/ruff/pulls/16162.md) on 2025-02-14 14:26_

---

_Comment by @junhsonjb on 2025-02-14 14:29_

Just sent out a [PR](https://github.com/astral-sh/ruff/pull/16162). I wrote most of the code before @InSyncWithFoo's comment. It doesn't attempt to address the problems with parenthesizing yet but I think may still be a good step towards unifying the many definitions of `OperatorPrecedence` ðŸ™‚ 

---

_Closed by @MichaReiser on 2025-02-14 14:55_

---

_Closed by @MichaReiser on 2025-02-14 14:55_

---

_Reopened by @MichaReiser on 2025-02-14 14:55_

---

_Comment by @junhsonjb on 2025-02-14 23:07_

I can get started on the second PR for this issue soon. Should be interesting to see how nicely the other versions of `OperatorPrecedence` play with each other ðŸ‘€ 

In regards to the parenthesizing issue, I think that should either be a third PR on this issue or a separate issue -- would you agree @InSyncWithFoo? To be honest, I have no idea how to even approach the problem yet but it seems like a really cool learning opportunity, especially if I can be pointed in the right direction ðŸ™‚ 

---

_Comment by @InSyncWithFoo on 2025-02-14 23:59_

@junhsonjb The parenthesizing problem is indeed big and deserves its own PR. That said, I also don't have a good idea of what the logic should be.

---

_Referenced in [astral-sh/ruff#16747](../../astral-sh/ruff/pulls/16747.md) on 2025-03-14 13:36_

---

_Comment by @junhsonjb on 2025-03-14 13:40_

Sorry about the delay here ðŸ™‚ This PR only makes the changes for `ruff_python_parser` -- I thought it might be a good idea to keep things simple and separate the changes for each crate

---

_Comment by @MichaReiser on 2025-03-14 13:58_

@junhsonjb no worries. We'll take a look in the next few days. I noticed that you mentioned that you plan on doing the formatter next. For me, the formatter has the lowest priority because it has some more bespoke behavior around it and I'm not 100% if we should unify it with the other enums. Maybe start with the linter enum next?

---

_Comment by @junhsonjb on 2025-03-17 13:06_

@MichaReiser Thanks! That sounds fine about the formatter. The linter's version of the enum is the one that was moved into `ruff_python_ast` to become the general `OperatorPrecedence`. This was done in the first PR for this issue, so I think it might be safe to close this issue for now

---

_Referenced in [astral-sh/ruff#16844](../../astral-sh/ruff/pulls/16844.md) on 2025-03-19 13:19_

---

_Closed by @dhruvmanila on 2025-03-21 04:10_

---

_Closed by @dhruvmanila on 2025-03-21 04:10_

---

_Reopened by @dhruvmanila on 2025-03-21 04:11_

---

_Comment by @dhruvmanila on 2025-03-21 04:11_

I think the one in the formatter is still remaining.

---

_Comment by @junhsonjb on 2025-03-21 12:35_

Do we still want to do the formatter? Micha [mentioned](https://github.com/astral-sh/ruff/issues/16071#issuecomment-2724788995) that we may not want to do work on the formatter:

> For me, the formatter has the lowest priority because it has some more bespoke behavior around it and I'm not 100% if we should unify it with the other enums. Maybe start with the linter enum next?

---

_Comment by @MichaReiser on 2025-03-21 12:47_

@junhsonjb we can give it a try if the variants line up. We can't do it if either enum as fewer or more variants (or if they differ)

---

_Comment by @junhsonjb on 2025-03-21 13:12_

`ruff_python_ast::OperatorPrecedence` has 21 variants, the one in the formatter (specifically the expression one) has 13. 

It may also be worth noting that the formatter's version is reversed -- the higher precedence variants are at the top, this could complicate things further. 

So we likely can't do it, then. 

---

_Comment by @MichaReiser on 2025-03-21 13:23_

That makes sense and roughly matches what I remember when I implemented it. The formatter precedence isn't an exact match of Python's parsing precedence. It's more: Users expect expressions with these operations to be grouped together.

Thanks for working on this and making ruff better!

---

_Closed by @MichaReiser on 2025-03-21 13:23_

---
