---
number: 14293
title: Explore comment and formatting preserving source code generator
type: issue
state: open
author: MichaReiser
labels:
  - core
  - needs-design
assignees: []
created_at: 2024-11-12T10:09:00Z
updated_at: 2025-05-27T13:52:10Z
url: https://github.com/astral-sh/ruff/issues/14293
synced_at: 2026-01-07T12:31:13-06:00
---

# Explore comment and formatting preserving source code generator

---

_Issue opened by @MichaReiser on 2024-11-12 10:09_

Explore if it's possible to preserve most comments and the source formatting in `Generator`. See [`recast`](https://github.com/benjamn/recast#source-maps).

---

_Label `core` added by @MichaReiser on 2024-11-12 10:09_

---

_Label `needs-design` added by @MichaReiser on 2024-11-12 10:09_

---

_Comment by @MichaReiser on 2024-12-21 20:53_

A few additional notes:

One concept I found useful from Roslyn (c# and VB compiler) is the idea of leading and trailing trivia. Every token has leading and trailing trivia and the rules for what's leading and trailing are. The following is from [biomejs' documentation](https://biomejs.dev/internals/architecture/)

* Every trivia up to the token/keyword (including line breaks) will be the leading trivia;
* Everything until the next linebreak (but not including it) will be the trailing trivia;

```js
const a = "foo"; // comment 1
// comment 2
const b = "bar";
```

The parts in `[]` is the trivia where the first `[]` is the leading trivia and the second `[]` is the trailing trivia.

```
0: JS_MODULE@0..55
    ...
      1: SEMICOLON@15..27 ";" [] [Whitespace(" "), Comments("// comment 1")]
    1: JS_VARIABLE_STATEMENT@27..55
        ...
        1: CONST_KW@27..45 "const" [Newline("\n"), Comments("// comment 2"), Newline("\n")] [Whitespace(" ")]
  3: EOF@55..55 "" [] []
```

What's nice about this approach is that if you move the `const` keyword (or the variable statement) is that it also moves the relevant comments. The same is true for when you move the `;` (or `a`s declaration). 


This [paper](https://www.researchgate.net/profile/Guoqiang-Li-22/publication/282833288_Constructing_format-preserving_printing_from_syntax-directed_definitions/links/5730f61408ae08415e6a835d/Constructing-format-preserving-printing-from-syntax-directed-definitions.pdf?origin=publication_detail&_tp=eyJjb250ZXh0Ijp7ImZpcnN0UGFnZSI6InB1YmxpY2F0aW9uIiwicGFnZSI6InB1YmxpY2F0aW9uRG93bmxvYWQiLCJwcmV2aW91c1BhZ2UiOiJwdWJsaWNhdGlvbiJ9fQ) and also [this paper](https://eelcovisser.org/publications/2011/JongeV11.pdf) might be worth reading. The papers also reference many other papers that could be worth checking out

---

_Comment by @MichaReiser on 2025-04-28 20:42_

@dcreager do you know any relevant research in this area?

---

_Referenced in [astral-sh/ruff#17683](../../astral-sh/ruff/issues/17683.md) on 2025-04-28 20:43_

---

_Comment by @MichaReiser on 2025-05-26 16:34_

Exploration from @dylwil3 https://github.com/astral-sh/ruff/pull/14886

---

_Comment by @dcreager on 2025-05-27 13:52_

> do you know any relevant research in this area?

Whoops, sorry I missed this!

The de Jonge paper is a good one, and there's also [Sommerlad et al](https://dl.acm.org/doi/abs/10.1145/1449814.1449817) that describes how the Eclipse implementation works. (de Jonge mentions Eclipse in related work but only cites the documentation, not the earlier paper.)

The proposed data-oriented AST representation (https://github.com/astral-sh/ruff/issues/15657) could also help here, as a way to store your suggested CST trivia alongside the existing AST structure.

---
