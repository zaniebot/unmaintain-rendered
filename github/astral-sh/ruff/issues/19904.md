---
number: 19904
title: Support load_dotenv as an exception to E402
type: issue
state: open
author: waldyrious
labels:
  - rule
  - needs-decision
assignees: []
created_at: 2025-08-13T22:01:38Z
updated_at: 2025-08-20T21:33:12Z
url: https://github.com/astral-sh/ruff/issues/19904
synced_at: 2026-01-07T12:31:13-06:00
---

# Support load_dotenv as an exception to E402

---

_Issue opened by @waldyrious on 2025-08-13 22:01_

### Summary

Currently, [E402](https://docs.astral.sh/ruff/rules/module-import-not-at-top-of-file/) (`module-import-not-at-top-of-file`) has a few exceptions for when one might legitimately need to put some code before imports. One such exception is `os.environ` modifications, introduced in #10059 / #10066 / #12047.
 
It's been raised in #9091 that `load_dotenv()`, which is used to load environment variables from a `.env` file, could also get a similar special case, for the same reasons as those that justify the `os.environ` exception.

This means one would then be able to do things like:

```python
from dotenv import load_dotenv

load_dotenv()

import foobar
```

...without triggering an E402 error, similar to what's [already the case today](https://github.com/astral-sh/ruff/blob/main/crates/ruff_linter/resources/test/fixtures/pycodestyle/E402_2.py) for `os.environ`.

---

_Comment by @ntBre on 2025-08-14 13:24_

Thanks for opening the issue and finding all the related PRs!

I'll add the `needs-decision` label to give others a chance to weigh in, but this makes sense to me. Instead of adding more special cases, we may also want to consider introducing a configuration option where users can specify their own exceptions.

---

_Label `rule` added by @ntBre on 2025-08-14 13:24_

---

_Label `needs-decision` added by @ntBre on 2025-08-14 13:24_

---

_Comment by @MichaReiser on 2025-08-15 06:41_

This does make sense to me. The only thing that seems worth balancing here is that we don't want to add every possible exception and using a noqa comment in this case seems fine to me. 

I could also see cases where the `load_dotenv` call doesn't have to come before any import, in which case I would want E402 to flag your example because I placed the `foobar` call accidentally after `load_dotenv`. Because of that, I don't think we should add the exception and I'd prefer a precisely placed noqa with an explanation of why `load_dotenv` needs to be loaded before `foobar` if it were my code.



---

_Comment by @waldyrious on 2025-08-15 13:05_

Oh, that's a good point, @MichaReiser. That is indeed the case for the particular module that I was using when I bumped into the E402 errors.

However, wouldn't that argument also apply to when using `os.environ`? I wouldn't have a strong preference to add the exception if it were to open a precedent, but in this case I would argue that it makes sense to add `load_dotenv` for consistency.

---

_Referenced in [astral-sh/ruff#19928](../../astral-sh/ruff/issues/19928.md) on 2025-08-15 15:48_

---

_Comment by @JimDabell on 2025-08-15 15:51_

Just chipping in here to point out the related #19928, which is the same thing, but configuring logging before importing a module.


---

_Comment by @MichaReiser on 2025-08-15 15:55_

Yeah, the argument with `os.environ` makes sense. Where I see the tension is in distinguishing between intentional and unintentional cases, and in the frequency of false positives.  I don't have a good answer to this, but it seems we're adding more and more exceptions where a simple noqa comment might be the perfect balance of flagging the "intentional" cases.

---

_Comment by @waldyrious on 2025-08-17 16:08_

Just to reiterate my point: I wouldn't consider this an addition of a new exception, at least in semantic terms — just the generalization of an existing one. In fact. I would go as far as to propose modifying the existing `is_os_environ_modification` test in [`imports.rs`](https://github.com/astral-sh/ruff/blob/main/crates/ruff_python_semantic/src/analyze/imports.rs), instead of adding a separate one.

That said, if it is decided that environment variable modifications (and, for that matter, logging setup) should not be unconditionally excepted from the imports sorting check, then I suppose the solution would entail removing the existing `os.environ` — is that a possibility that's on the table, considering that it's been already stabilized?

---

_Comment by @dancollins on 2025-08-20 00:22_

> This does make sense to me. The only thing that seems worth balancing here is that we don't want to add every possible exception and using a noqa comment in this case seems fine to me.
> 
> I could also see cases where the `load_dotenv` call doesn't have to come before any import, in which case I would want E402 to flag your example because I placed the `foobar` call accidentally after `load_dotenv`. Because of that, I don't think we should add the exception and I'd prefer a precisely placed noqa with an explanation of why `load_dotenv` needs to be loaded before `foobar` if it were my code.

This sounds reasonable, but it either doesn't work for me or I've missed what you mean. Here's some example code from my codebase:

```python
from dotenv import load_dotenv

load_dotenv()  # noqa: E402

import os
from contextlib import asynccontextmanager

from fastapi import FastAPI
```

 The `#noqa: E402` isn't actually suppressing anything here, as the warnings are actually for the following lines (i.e. `import os` and `from contextlib import asynccontextmanager`). It's annoying to need to add the noqa to subsequent lines when what I want to do is tell Ruff to ignore that specific error as a result of the line `load_dotenv()`.


---

_Comment by @ntBre on 2025-08-20 14:05_

I think something more like this would be in line with what Micha was saying:

```py
import os
from contextlib import asynccontextmanager

from dotenv import load_dotenv

load_dotenv()

from fastapi import FastAPI  # noqa: E402
```

I could be missing something, but I'm assuming `os` and `contextlib` don't read anything loaded by `load_dotenv`, so something like this isolates the issue to the import that actually needs to be after `load_dotenv` and E402 can still be enforced for more imports.

---

_Comment by @dancollins on 2025-08-20 21:33_

Yes that's a very good point - and it also helps show which modules depend on the .env along with the justification comments. Thanks! I hadn't considered just re-ordering like that :)

---

_Referenced in [astral-sh/ruff#20288](../../astral-sh/ruff/issues/20288.md) on 2025-09-08 19:45_

---

_Referenced in [astral-sh/ruff#21040](../../astral-sh/ruff/issues/21040.md) on 2025-10-23 18:45_

---
