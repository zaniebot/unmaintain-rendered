---
number: 4972
title: Use ruff_fix_validity to catch regressions in CI not detected by unit tests
type: issue
state: open
author: addisoncrump
labels: []
assignees: []
created_at: 2023-06-08T19:55:50Z
updated_at: 2024-06-13T00:07:49Z
url: https://github.com/astral-sh/ruff/issues/4972
synced_at: 2026-01-07T12:31:12-06:00
---

# Use ruff_fix_validity to catch regressions in CI not detected by unit tests

---

_Issue opened by @addisoncrump on 2023-06-08 19:55_

The fuzzers added in #4822 can be used to catch regressions for which there exists no unit tests (see: #4863 as an example of this; caught by `ruff_fix_validity` within ~30 seconds). PRs should include a short fuzz run (5-10m) before merging. Failure cases can then be added to the unit test suite.

Before that happens, the following issues (discovered by fuzzing currently and will cause this CI step to fail) should be resolved:

- [x] #4823 
- [x] #4825 
- [x] #4826 
- [x] #4827 
- [x] #4828 
- [x] #4863 
- [x] #4865 
- [x] #4892 
- [x] #4897 
- [x] #4899 
- [x] #4901 
- [ ] #4924 
- [x] #4925
- [x] #4973 
- [x] #4975 
- [x] #4991 
- [ ] https://github.com/RustPython/Parser/issues/89
- [x] #5004 
- [x] #5154 
- [x] #5156 
- [x] #6213 
- [x] #6214 
- [x] #9374 
- [x] #9379 

This change should include the following:
- Caching of the fuzzer corpus, `fuzz/corpus/ruff_fix_validity` (~20MB)
- Initialisation of the fuzzer corpus if not present (I will provide an initial corpus)
- Execution of `timeout 10m cargo fuzz run -s none ruff_fix_validity -- -timeout=5 || [[ $? -eq 124 ]]` after the `fuzz build` step

In the future, when parser idempotency is more stable or new fuzzers exist (such as for formatting), this should be included as well.

---

_Comment by @addisoncrump on 2023-06-08 20:00_

I am happy to craft these changes. :slightly_smiling_face: I just want to make sure that this implementation is sane for the maintainers.

---

_Referenced in [google/oss-fuzz#11471](../../google/oss-fuzz/pulls/11471.md) on 2024-01-10 11:39_

---

_Comment by @T-256 on 2024-06-12 23:47_

- I think this issued could be close since https://github.com/RustPython/Parser/issues/89 is solved by Ruff's internal parser at some point and https://github.com/astral-sh/ruff/issues/4924 is the only remained item which can tracking it separately.

---

_Comment by @addisoncrump on 2024-06-12 23:52_

The list here is now very old. There are likely new bugs caught by this beyond what is tracked; the issue is about making sure that the fuzzer is not enabled constantly unnecessarily.

---

_Comment by @T-256 on 2024-06-13 00:01_

Correct, sorry for misreading discription.

> PRs should include a short fuzz run (5-10m) before merging. Failure cases can then be added to the unit test suite.

I think it's better to use cron jobs workflow instead.

---

_Comment by @addisoncrump on 2024-06-13 00:07_

As in, a scheduled workflow? Makes sense.

---

_Referenced in [astral-sh/ruff#12785](../../astral-sh/ruff/issues/12785.md) on 2024-08-09 13:21_

---
