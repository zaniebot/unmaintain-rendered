---
number: 2382
title: "Union is upgraded to \"|\" pipe character even though target version is Python 3.9"
type: issue
state: closed
author: KelSolaar
labels:
  - question
assignees: []
created_at: 2023-01-31T07:51:52Z
updated_at: 2023-02-01T06:24:40Z
url: https://github.com/astral-sh/ruff/issues/2382
synced_at: 2026-01-07T12:31:12-06:00
---

# Union is upgraded to "|" pipe character even though target version is Python 3.9

---

_Issue opened by @KelSolaar on 2023-01-31 07:51_

<!--
Thank you for taking the time to report an issue! We're glad to have you involved with Ruff.

If you're filing a bug report, please consider including the following information:

- A minimal code snippet that reproduces the bug.
- The command you invoked (e.g., `ruff /path/to/file.py --fix`), ideally including the `--isolated` flag.
- The current Ruff settings (any relevant sections from your `pyproject.toml`).
- The current Ruff version (`ruff --version`).
-->

Hi,

This only happens when `from __future__ import annotations` is used:

Given `target-version = "py39"` and the following snippet:

```python
from __future__ import annotations

from typing import Literal, Union


def foo(bar: Union[Literal["John", "Wayne"], str] = "John"):
    ...
```

The snippet is upgraded:

```python
from __future__ import annotations

from typing import Literal


def foo(bar: Literal["John", "Wayne"] | str = "John"):
    ...
```

- Ruff 0.0.237



---

_Comment by @burgholzer on 2023-01-31 08:14_

Could it be that you copied the same snippet twice by accident?

The rewrite is perfectly valid for Python 3.7+ whenever `from __future__ import annotations` is present due to postponed evaluation of annotations (see https://peps.python.org/pep-0563/).

See also the original `pyupgrade` implementation: https://github.com/asottile/pyupgrade/blob/97ed6fb3cf2e650d4f762ba231c3f04c41797710/pyupgrade/_plugins/typing_pep604.py#L118-L126

---

_Comment by @tmke8 on 2023-01-31 10:51_

You can turn this behavior off with

```toml
[tool.ruff.pyupgrade]
# Preserve types, even if a file imports `from __future__ import annotations`.
keep-runtime-typing = true
```

---

_Label `question` added by @charliermarsh on 2023-01-31 12:30_

---

_Comment by @KelSolaar on 2023-01-31 17:57_

> Could it be that you copied the same snippet twice by accident?

Yes! Copy-paste fail, just fixed.

> See also the original pyupgrade implementation: https://github.com/asottile/pyupgrade/blob/97ed6fb3cf2e650d4f762ba231c3f04c41797710/pyupgrade/_plugins/typing_pep604.py#L118-L126

So this is interesting because I'm using `pyupgrade` and it does not update them which is why I was surprised that they were in the first place. Looking `pyupgrade`, `keep_runtime_typing` attribute is off by default: https://github.com/asottile/pyupgrade/blob/97ed6fb3cf2e650d4f762ba231c3f04c41797710/pyupgrade/_data.py#L31 which evaluates to `True` in the code that uses it, i.e. `not state.settings.keep_runtime_typing`.



---

_Comment by @charliermarsh on 2023-01-31 20:16_

@KelSolaar - Just trying to keep up -- does this seem to be working as intended, or na?

---

_Comment by @KelSolaar on 2023-01-31 20:17_

Sorry, yes it does perfectly, the default behaviour is different compared to `pyupgrade`, unsure if it needs to be the same or documented or both.

---

_Comment by @charliermarsh on 2023-01-31 21:22_

I think the default behavior is maybe the same? If I run `pyupgrade foo.py --py39` over that code, it does upgrade it. I have to run `pyupgrade foo.py --py39 --keep-runtime-typing` to avoid the upgrade.

With Ruff, if I run `ruff --fix` over that file with `target-version = "py39"`, it also fixes it. If I add this to my `pyproject.toml`, it doesn't:

```toml
[tool.ruff.pyupgrade]
keep-runtime-typing = true
```

So I think in either case, you have to enable that setting? But maybe I'm just misunderstanding :) Going to close for now though!


---

_Closed by @charliermarsh on 2023-01-31 21:22_

---

_Comment by @KelSolaar on 2023-02-01 06:24_

Thanks, maybe it is a default when used with the precommit hooks but we never specified this parameter and it never upgraded for us. It does not really matter anyway as we will be using Ruff from now on! :D

---

_Referenced in [sphinx-doc/sphinx#11165](../../sphinx-doc/sphinx/pulls/11165.md) on 2023-02-03 23:09_

---
