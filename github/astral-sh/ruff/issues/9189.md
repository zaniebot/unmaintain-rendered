---
number: 9189
title: "Unexpected token '>>' when linting Jupyter notebook with doctest/interpreter snippet"
type: issue
state: open
author: mattharrison
labels:
  - formatter
  - linter
  - notebook
assignees: []
created_at: 2023-12-18T16:37:51Z
updated_at: 2025-04-23T15:28:48Z
url: https://github.com/astral-sh/ruff/issues/9189
synced_at: 2026-01-07T12:31:12-06:00
---

# Unexpected token '>>' when linting Jupyter notebook with doctest/interpreter snippet

---

_Issue opened by @mattharrison on 2023-12-18 16:37_

I'm trying to lint notebooks that have interactive snippets in the cells.

To recreate, simple make a notebook with something like this in the cell

```pycon
>>> def function(a,b):
...    return a+b
>>> function(1,2)
```

Ruff (v 0.1.8) fails with this error:

```
% ruff foo.ipynb
error: Failed to parse foo.ipynb:cell 1:1:1: Unexpected token '>>'
foo.ipynb:cell 1:1:1: E999 SyntaxError: Unexpected token '>>'
Found 1 error.
```


---

_Comment by @dhruvmanila on 2023-12-18 16:51_

Can you expand on what does "interactive snippets" mean? Is the code snippet you've mentioned to be pasted as it is including the prompt `>>>` and `...`?

---

_Comment by @mattharrison on 2023-12-18 16:58_

Yes, it means writing code in a doctest style. Jupyter supports this style of code and I would love to be able to format it. Here's a screenshot of my notebook, it is literally a cell with the code I pasted above.


<img width="497" alt="Screen Shot 2023-12-18 at 9 56 19 AM" src="https://github.com/astral-sh/ruff/assets/119405/968837ef-abfa-41f9-9518-1d323c26c280">


---

_Comment by @dhruvmanila on 2023-12-19 16:55_

TIL, thanks for providing the context. Can you further expand on your use-case for this? I might be misunderstanding you or missing some context but wouldn't using the interactive cells of the notebook itself be better instead? So, what I mean is the following:

<img width="478" alt="Screenshot 2023-12-19 at 10 54 35" src="https://github.com/astral-sh/ruff/assets/67177269/b69b9464-e416-4fe9-970c-bcebb4d81c8b">



---

_Comment by @mattharrison on 2023-12-19 20:43_

My use case is I write books in Jupyter and want to format the code. As to
why I use interpreter snippets? So the reader can distinguish between code
and output. (And so I can test the code in my book.)

On Tue, Dec 19, 2023, 9:55 AM Dhruv Manilawala ***@***.***>
wrote:

> TIL, thanks for providing the context. Can you further expand on your
> use-case for this? I might be misunderstanding you or missing some context
> but wouldn't using the interactive cells of the notebook itself be better
> instead? So, what I mean is the following:
> Screenshot.2023-12-19.at.10.54.35.png (view on web)
> <https://github.com/astral-sh/ruff/assets/67177269/b69b9464-e416-4fe9-970c-bcebb4d81c8b>
>
> —
> Reply to this email directly, view it on GitHub
> <https://github.com/astral-sh/ruff/issues/9189#issuecomment-1863136231>,
> or unsubscribe
> <https://github.com/notifications/unsubscribe-auth/AAA5E3K2DTEOAAATAQMPW4TYKHBIFAVCNFSM6AAAAABAZZ3QSKVHI2DSMVQWIX3LMV43OSLTON2WKQ3PNVWWK3TUHMYTQNRTGEZTMMRTGE>
> .
> You are receiving this because you authored the thread.Message ID:
> ***@***.***>
>


---

_Comment by @dhruvmanila on 2023-12-20 00:01_

Thanks for providing this information! I think it can be compared to the way Python's official tutorials are written (for example https://docs.python.org/3/tutorial/controlflow.html#if-statements) where the text would be a markdown block while the code snippets would be a code block. 

As for the implementation side, maybe we could utilize some parts of the new docstring formatter to get the code part from the interactive snippets (cc @BurntSushi). We could check if the first line begins with the `>>>` prompt and use an intermediary step to extract the code parts. I can look into it sometime next year (after my Christmas / New Year break) ;)

And, this would work for both the linter and the formatter once implemented.

---

_Label `linter` added by @dhruvmanila on 2023-12-20 00:02_

---

_Label `formatter` added by @dhruvmanila on 2023-12-20 00:02_

---

_Label `notebook` added by @dhruvmanila on 2024-02-06 12:23_

---

_Comment by @SergejsKims on 2024-05-28 10:50_

I have similar behavior with Databricks Notebooks. In Databricks it is normal to define `%pip install ...`, but in this case Ruff fails with `Unexpected token '%'`, At least, would be good to Skip such line.

---

_Comment by @dhruvmanila on 2024-05-28 11:59_

What's the difference between a Databricks Notebook and a Jupyter Notebook? Do they have different file extension? If it's `.ipynb`, then Ruff does support parsing those magic commands (`%pip install ...`).

---

_Comment by @SergejsKims on 2024-05-28 13:24_

Databricks Notebook has "*.py" extension.

---

_Comment by @dhruvmanila on 2024-06-03 11:26_

Ruff uses the file extension to determine the expected syntax. If it's a `.py` file, it'll expect a Python source code and similarly, if it's `.ipynb` it expects a JSON encoded Notebook source. I'm not sure why does it uses `.py` extension because any Python parser would fail to parse such files.

---

_Referenced in [astral-sh/ruff#15650](../../astral-sh/ruff/issues/15650.md) on 2025-01-21 17:11_

---

_Comment by @bthorsted on 2025-04-23 10:35_

@dhruvmanila Databricks use `.py` because the contents are not JSON encoded, but rather plain text python code with some magic comments to escape features like `%pip install` and to mark cell boundaries.

I assume they made that design choice to make it more git-friendly while still having the benefits of a notebook-style interface.

The magic comments are parsed and rendered by the databricks web interface, so the user won't see that cells are defined by a header-style magic comment: `# COMMAND ----------`.
Lines beginning with `%` in the web editor will be stored as `# MAGIC %` in the raw `.py` file.

---

_Comment by @dhruvmanila on 2025-04-23 15:28_

Thanks for the context!

> Lines beginning with `%` in the web editor will be stored as `# MAGIC %` in the raw `.py` file.

If this is the case, then it shouldn't create an issue with Ruff as it's just a Python comment. As such, this is different than what the author of this issue is facing.

---
