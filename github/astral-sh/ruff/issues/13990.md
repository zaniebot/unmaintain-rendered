---
number: 13990
title: "[red-knot] Union incorrectly reported as not iterable"
type: issue
state: closed
author: MichaReiser
labels:
  - bug
  - ty
assignees: []
created_at: 2024-10-30T10:06:56Z
updated_at: 2024-10-30T11:54:17Z
url: https://github.com/astral-sh/ruff/issues/13990
synced_at: 2026-01-07T12:31:13-06:00
---

# [red-knot] Union incorrectly reported as not iterable

---

_Issue opened by @MichaReiser on 2024-10-30 10:06_

Given:

```py

class TestIter:
    def __next__(self) -> str:
        return "abcd"


class Test:
    def __iter__(self) -> TestIter:
        return TestIter()


def bool_instance() -> bool:
    return True


flag = bool_instance()

if flag:
    a = "123"
else:
    a = Test()

x = "fallback"
for x in a:
    ...

reveal_type(x)
``` 

**Actual output**

```
ERROR /home/micha/astral/test/src/test.py:26:10: Object of type `Literal["123"] | Test` is not iterable
ERROR /home/micha/astral/test/src/test.py:29:1: Revealed type is `Literal["fallback"] | Unknown`
```

**Expected output**

```
ERROR /home/micha/astral/test/src/test.py:29:1: Revealed type is `Literal["fallback"] | str`
```

As part of this, we should also revisit if passing `self` here is correct because the first argument to `next` in this example isn't `Test` but `TestIter`

https://github.com/astral-sh/ruff/blob/1607d88c2253473a116155176effa4ab14eafcce/crates/red_knot_python_semantic/src/types.rs#L1115-L1121



---

_Label `red-knot` added by @MichaReiser on 2024-10-30 10:06_

---

_Comment by @AlexWaygood on 2024-10-30 11:26_

Here's a slightly more self-contained example (because it doesn't involve any special understanding of the fact that e.g. a string literal is iterable), that makes it very obvious that the issue is the union type, as you say:

```py
from typing_extensions import reveal_type

class TestIter:
    def __next__(self) -> int:
        return 42

class Test:
    def __iter__(self) -> TestIter:
        return TestIter()

class Test2:
    def __iter__(self) -> TestIter:
        return TestIter()

def bool_instance() -> bool:
    return True

flag = bool_instance()
x = y = "fallback"

for x in Test():
    ...

for y in (Test() if flag else Test2()):
    ...

reveal_type(x)
reveal_type(y)
```

red-knot reports:

```
ERROR /Users/alexw/dev/experiment/foo.py:28:11: Object of type `Test | Test2` is not iterable
ERROR /Users/alexw/dev/experiment/foo.py:31:1: Revealed type is `Literal["fallback"] | int`
ERROR /Users/alexw/dev/experiment/foo.py:32:1: Revealed type is `Literal["fallback"] | Unknown`
```

---

_Label `bug` added by @AlexWaygood on 2024-10-30 11:26_

---

_Assigned to @AlexWaygood by @AlexWaygood on 2024-10-30 11:30_

---

_Referenced in [astral-sh/ruff#13992](../../astral-sh/ruff/pulls/13992.md) on 2024-10-30 11:40_

---

_Closed by @AlexWaygood on 2024-10-30 11:54_

---
