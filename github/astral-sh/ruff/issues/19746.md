---
number: 19746
title: "UP045 fixes Optional[Optional[x]] to x | None | None"
type: issue
state: closed
author: johncassil
labels:
  - bug
  - fixes
  - help wanted
assignees: []
created_at: 2025-08-04T18:11:18Z
updated_at: 2025-08-19T22:12:16Z
url: https://github.com/astral-sh/ruff/issues/19746
synced_at: 2026-01-07T12:31:13-06:00
---

# UP045 fixes Optional[Optional[x]] to x | None | None

---

_Issue opened by @johncassil on 2025-08-04 18:11_

### Summary

Nesting is not taken care of in the conversion:

`Optional[Optional[str]]` yields  `str | None | None`

This might be related to https://github.com/astral-sh/ruff/issues/18508 


### Version

ruff 0.12.1 (32c54189c 2025-06-26)

---

_Comment by @ntBre on 2025-08-04 19:24_

Hmm, I thought #18508 was supposed to be closed by https://github.com/astral-sh/ruff/pull/18572, which came out the day after 0.12.1, but I can still reproduce this on 0.12.7, regardless. Thanks for the report!

---

_Label `bug` added by @ntBre on 2025-08-04 19:24_

---

_Label `fixes` added by @ntBre on 2025-08-04 19:24_

---

_Label `help wanted` added by @ntBre on 2025-08-04 19:24_

---

_Comment by @ntBre on 2025-08-04 20:50_

I guess this isn't quite as catastrophic as `None | None` alone:

```pycon
>>> None | None
Traceback (most recent call last):
  File "<stdin>", line 1, in <module>
TypeError: unsupported operand type(s) for |: 'NoneType' and 'NoneType'
>>> int | None | None
int | None
```

But I think we handle nesting in these rules in other cases, so it may still be worth handling here.

---

_Referenced in [astral-sh/ruff#19770](../../astral-sh/ruff/pulls/19770.md) on 2025-08-05 19:07_

---

_Closed by @ntBre on 2025-08-19 22:12_

---
