---
number: 5434
title: "UP007 problems with pydantic and `from __future__ import annotations`"
type: issue
state: closed
author: Mr-Pepe
labels:
  - configuration
assignees: []
created_at: 2023-06-29T05:59:13Z
updated_at: 2023-07-03T02:11:33Z
url: https://github.com/astral-sh/ruff/issues/5434
synced_at: 2026-01-07T12:31:12-06:00
---

# UP007 problems with pydantic and `from __future__ import annotations`

---

_Issue opened by @Mr-Pepe on 2023-06-29 05:59_

<!--
Thank you for taking the time to report an issue! We're glad to have you involved with Ruff.

If you're filing a bug report, please consider including the following information:

* A minimal code snippet that reproduces the bug.
* The command you invoked (e.g., `ruff /path/to/file.py --fix`), ideally including the `--isolated` flag.
* The current Ruff settings (any relevant sections from your `pyproject.toml`).
* The current Ruff version (`ruff --version`).
-->

Consider the following file, written for Python3.9+.

```Python
# tmp.py
from __future__ import annotations

from typing import Union

from pydantic import BaseModel

x: Union[int, str] = 5


class A(BaseModel):
    y: Union[int, str] = 5
```

Running `ruff check tmp.py --target-version py39 --select UP --fix` with Ruff version `0.0.275` yields:

```Python 
from __future__ import annotations

from typing import Union

from pydantic import BaseModel

x: int | str = 5


class A(BaseModel):
    y: int | str = 5
```

Running the script results in the following error:

```
Traceback (most recent call last):
  File "/home/felipe/Projects/voraus-vtest/tmp.py", line 10, in <module>
    class A(BaseModel):
  File "pydantic/main.py", line 178, in pydantic.main.ModelMetaclass.__new__
  File "pydantic/typing.py", line 400, in pydantic.typing.resolve_annotations
    
  File "/home/felipe/.pyenv/versions/3.9.13/lib/python3.9/typing.py", line 292, in _eval_type
    return t._evaluate(globalns, localns, recursive_guard)
  File "/home/felipe/.pyenv/versions/3.9.13/lib/python3.9/typing.py", line 554, in _evaluate
    eval(self.__forward_code__, globalns, localns),
  File "<string>", line 1, in <module>
TypeError: unsupported operand type(s) for |: 'type' and 'type'
```

The module-level x seems to work fine (because of the `__future__` import?). Should Ruff maybe not change the type annotation if `from __future__ import annotations` is present? The type annotation might be evaluated in a different context where the import is not available.

---

_Comment by @tmke8 on 2023-06-29 10:04_

Yeah, the problem stems from the fact that pydantic evaluates the type annotations at runtime. I've had similar problems with [hydra](https://github.com/facebookresearch/hydra) which also evaluates type annotations in order to do type validation at runtime.

Also note that `from __future__ import annotations` is generally problematic in pydantic: https://github.com/pydantic/pydantic/issues/2678 which is why the Python steering council has not made it the default in Python 3.10 as originally planned, and instead has decided on the alternative mechanism proposed in [PEP 649](https://peps.python.org/pep-0649/).

Ruff could check for these libraries and exempt them from UP007 but that would be a lot of special casing because I don't think you can in general tell whether a type annotation will be evaluated at runtime without knowing what the library does internally.

---

_Comment by @eli-schwartz on 2023-06-30 00:10_

While it's true ruff can special case imports of pydantic and just assume *all* annotations aren't safe to apply UP007 to, it's also true that UP007 is quite narrowly scoped and should arguably be disabled entirely in codebases that both support older versions of python, and use pydantic in some form.

A dedicated config setting for "i-use-runtime-annotations-please-dont-break-that = true" would allow UP007 to smartly detect when the minimum required python is updated and automatically re-enable itself.

---

_Comment by @charliermarsh on 2023-06-30 02:13_

Yeah, I generally recommend against using `from __future__ import annotations` with Pydantic for the above reasons (or disabling `UP007`).

We actually used to have a `keep-runtime-typing` flag, similar to Pyupgrade, but the way it was implemented meant that it was equivalent to disabling `UP006` and `UP007` entirely. I ended up deprecating it (https://github.com/astral-sh/ruff/pull/4427), since it felt odd to have special configuration that was exactly equivalent to just specifying the rules in an `ignore`, but I think I made a mistake (\cc @layday). We should've kept that flag, but fixed the semantics, such that it only disabled those rules for cases in which the syntax is not yet supported at runtime (i.e., < Python 3.9 or Python 3.10 depending on the rule). IMO we should restore it with those semantics.


---

_Label `configuration` added by @charliermarsh on 2023-06-30 02:38_

---

_Comment by @charliermarsh on 2023-06-30 02:39_

I'm going to use this Issue as an opportunity to reintroduce that `keep-runtime-typing` setting.

---

_Comment by @layday on 2023-06-30 11:09_

My suggestion would be to actually reverse the flag, so that people don't break things by accident.

---

_Assigned to @charliermarsh by @charliermarsh on 2023-07-03 00:18_

---

_Referenced in [astral-sh/ruff#5470](../../astral-sh/ruff/pulls/5470.md) on 2023-07-03 02:03_

---

_Closed by @charliermarsh on 2023-07-03 02:11_

---
