---
number: 10508
title: "Strange autofix for PYI025 if `\"Set\"` is included in `__all__`"
type: issue
state: closed
author: AlexWaygood
labels:
  - bug
  - fixes
  - linter
assignees: []
created_at: 2024-03-21T11:23:49Z
updated_at: 2024-03-22T20:06:36Z
url: https://github.com/astral-sh/ruff/issues/10508
synced_at: 2026-01-07T12:31:13-06:00
---

# Strange autofix for PYI025 if `"Set"` is included in `__all__`

---

_Issue opened by @AlexWaygood on 2024-03-21 11:23_

The following snippet correctly causes Ruff to emit PYI025:

```py
from collections.abc import Set as Set

__all__ = ["Set"]
```

But if you apply the autofix, it "fixes" it to this, which is... not correct:

```py
from collections.abc import Set as AbstractSet

AbstractSet = ["Set"]
```


---

_Label `bug` added by @AlexWaygood on 2024-03-21 11:23_

---

_Label `fixes` added by @AlexWaygood on 2024-03-21 11:23_

---

_Label `linter` added by @AlexWaygood on 2024-03-21 11:23_

---

_Comment by @MichaReiser on 2024-03-21 11:28_

What's the correct fix in your view or should the rule not emit a fix if it's a module scoped variable named `__all__`?

---

_Comment by @AlexWaygood on 2024-03-21 11:37_

Including the name `"Set"` in `__all__` marks the symbol as being publicly exported from the module, but it doesn't create a binding in and of itself -- the `Set` binding is created via the import. So we definitely shouldn't be removing the `__all__` variable from the module here.

If we stipulate that it's correct for us to emit the violation here at all, the correct fix would be to modify the original snippet to

```py
from collections.abc import Set as AbstractSet

__all__ = ["AbstractSet"]
```

rather than what we currently do, which is to modify the snippet to this:

```py
from collections.abc import Set as AbstractSet

AbstractSet = ["Set"]
```

This is an edge case that's unlikely to come up. However, I'm somewhat concerned that it points to a broader issue with the autofix machinery that could also impact other rules.

## Should we be emitting PYI025 on this snippet at all?

This is debatable. However, I think it's fine to emit PYI025 even if the `"Set"` symbol appears in `__all__`, since that's very much an edge case that's extremely unlikely to actually come up. I'm not really concerned about this.

---

_Comment by @AlexWaygood on 2024-03-21 11:40_

Note that the code will actually trigger F811 after being "autofixed" for PYI025:

```py
from collections.abc import Set as AbstractSet

AbstractSet = ["Set"]  # F811: Redefinition of unused `AbstractSet` from line 1
```

---

_Assigned to @charliermarsh by @AlexWaygood on 2024-03-21 15:02_

---

_Unassigned @charliermarsh by @AlexWaygood on 2024-03-21 15:18_

---

_Comment by @AlexWaygood on 2024-03-22 11:58_

The autofix is done using the renamer here:

https://github.com/astral-sh/ruff/blob/4f06d59ff6f58f2d13c2f8fcfe375b81058f87c3/crates/ruff_linter/src/rules/flake8_pyi/rules/unaliased_collections_abc_set_import.rs#L80

The issue in the renamer is here where, after renaming the binding itself (`from collections.abc import Set`), we then proceed to try to rename all _references_ to the binding that we've just renamed:

https://github.com/astral-sh/ruff/blob/4f06d59ff6f58f2d13c2f8fcfe375b81058f87c3/crates/ruff_linter/src/renamer.rs#L202-L206

The renamer correctly recognises that `__all__ = ["Set"]` counts as a resolved reference to the `Set` symbol that we've just renamed. But it then incorrectly renames the target of the assignment rather than the string in the assignment's value.

---

_Comment by @AlexWaygood on 2024-03-22 12:20_

Adding this debug print:

```diff
diff --git a/crates/ruff_linter/src/renamer.rs b/crates/ruff_linter/src/renamer.rs
index 8571d7f53..e8f4d1295 100644
--- a/crates/ruff_linter/src/renamer.rs
+++ b/crates/ruff_linter/src/renamer.rs
@@ -202,6 +202,7 @@ impl Renamer {
                 // Rename the references to the binding.
                 edits.extend(binding.references().map(|reference_id| {
                     let reference = semantic.reference(reference_id);
+                    dbg!(reference);
                     Edit::range_replacement(target.to_string(), reference.range())
                 }));
```

reveals that the range of the `ResolvedReference` is `33..40`, which is the range of `__all__` in the expression `__all__ = ["Set"]`, rather than the range of `"Set"`. The incorrect range is then what causes the renamer to change `__all__ = ["Set"]` to `AbstractSet = ["Set"]` rather than to `__all__ = ["AbstractSet"]`.

This TODO comment looks relevant @charliermarsh ;)

https://github.com/astral-sh/ruff/blob/4f06d59ff6f58f2d13c2f8fcfe375b81058f87c3/crates/ruff_linter/src/checkers/ast/mod.rs#L2114-L2120




---

_Assigned to @AlexWaygood by @AlexWaygood on 2024-03-22 12:27_

---

_Referenced in [astral-sh/ruff#10525](../../astral-sh/ruff/pulls/10525.md) on 2024-03-22 13:23_

---

_Referenced in [astral-sh/ruff#10527](../../astral-sh/ruff/pulls/10527.md) on 2024-03-22 17:54_

---

_Closed by @AlexWaygood on 2024-03-22 20:06_

---

_Referenced in [astral-sh/ruff#10547](../../astral-sh/ruff/pulls/10547.md) on 2024-03-24 14:55_

---
