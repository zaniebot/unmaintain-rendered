---
number: 20701
title: "add custom source roots or namespace packages to `analyze graph`?"
type: issue
state: closed
author: gwdekker
labels:
  - question
  - great writeup
assignees: []
created_at: 2025-10-05T10:56:57Z
updated_at: 2025-10-07T06:47:06Z
url: https://github.com/astral-sh/ruff/issues/20701
synced_at: 2026-01-07T12:31:13-06:00
---

# add custom source roots or namespace packages to `analyze graph`?

---

_Issue opened by @gwdekker on 2025-10-05 10:56_

`ruff analyze graph` is a great potential way to quickly get a projects' dependency tree which could be very useful in many different ways.

I found that in my monorepo, using the `polylith` setup, it is not able to find the dependencies correctly.

This is due to the fact that the structure is non-standard - it uses custom source roots `bases` and `components`, which are not detected correctly by `ruff`for this use case. 

More precisely, the `polylith` setup builds the package in a special way, and the imports I have across my code are of the type `from monorepo_name.component_name import X`. This is not recognized by `ruff analyze` to be an internal dependency it seems, so it does not list this as a dependency.

Curious to hear if this is something that is easily fixable?

---

_Comment by @MichaReiser on 2025-10-05 20:06_

I'm not sure I follow the project structure. Could you list your project structure with a few example files (and what imports they contain)

---

_Comment by @gwdekker on 2025-10-06 06:24_

Thanks for you quick answer! Apologies for the unclarity - in hindsight i could have seen that that was not the clearest explanation.

I made a little example for you attached. More information is also in its readme. Hope this helps!

[ruff_example.zip](https://github.com/user-attachments/files/22715955/ruff_example.zip)




---

_Label `great writeup` added by @MichaReiser on 2025-10-06 06:40_

---

_Label `question` added by @MichaReiser on 2025-10-06 06:48_

---

_Comment by @MichaReiser on 2025-10-06 06:53_

Thank you. This was super helpful.

Setting `namespace-packages = ["components/flint", "bases/flint"]` makes Ruff recognize some imports (I'm not sure if it's all, you'll have a better sense for that)

```
{
  "bases/flint/base_one/__init__.py": [],
  "bases/flint/base_one/core.py": [
    "components/flint/api_client/__init__.py",
    "components/flint/constants/__init__.py"
  ],
  "components/flint/api_client/__init__.py": [],
  "components/flint/api_client/core.py": [
    "components/flint/constants/__init__.py",
    "components/flint/time_series_standards/__init__.py"
  ],
  "components/flint/constants/__init__.py": [
    "components/flint/constants/api_constants.py"
  ],
  "components/flint/constants/api_constants.py": [],
  "components/flint/time_series_standards/__init__.py": [
    "components/flint/time_series_standards/core.py"
  ],
  "components/flint/time_series_standards/core.py": []
}
```

Ruff adds the root of all the packages that it detects as search path to `analyze graph`. Without setting `namespace-pacakges`, the package roots are:

```
[crates/ruff/src/commands/analyze_graph.rs:70:5] &src_roots = [
    "/Users/micha/Downloads/ruff_example/components/flint",
    "/Users/micha/Downloads/ruff_example/components/flint",
    "/Users/micha/Downloads/ruff_example/bases/flint",
    "/Users/micha/Downloads/ruff_example/components/flint",
]
```

Note how Ruff adds `components/flint`. The issue with `components/flint` is that the import path becomes `api_client` (and not `flint.api_client`), breaking all import statements. 

Setting `namespace-packages` ensures that Ruff detects that `components/flint` is a package and it should add the entire directory to its search paths, so that `flint.api_client` can be resolved

---

_Comment by @gwdekker on 2025-10-06 07:16_

Amazing, thanks! I will try this on the full repo and report back if this indeed solves the full problem.

---

_Comment by @gwdekker on 2025-10-06 07:21_

btw - how stable would you say this command is for now? Is there a real possibility it might disappear or change fundamentally?  (not afraid of minor changes, but it would be sad to learn it would become totally unsupported/would disappear).

---

_Comment by @MichaReiser on 2025-10-06 07:44_

> btw - how stable would you say this command is for now? Is there a real possibility it might disappear or change fundamentally? (not afraid of minor changes, but it would be sad to learn it would become totally unsupported/would disappear).

The command is used by many users. We don't expect it to go away. The only reason it's under preview is because there are a few cases where Ruff might miss dependencies (I think star imports are one such case)

---

_Comment by @gwdekker on 2025-10-07 06:00_

This works like a charm! I now can also on my full monorepo basically recreate the dependency graph that `tach` gives me in `tach.toml` against what I get from `ruff analyze`. 

Two minor issues I found in the process:
1. `tach` gives me also the line number(s) if it finds an import in the code that's not in `tach.toml`. Would you consider adding line numbers to the output of `ruff analyze graph`? 
2. `tach` by default ignores dependencies if the import statement is wrapped by `if TYPE_CHECKING:`. Is that something that is possible with `ruff analyze graph` as well, and would you consider adding it if not yet possible? (from another thread on the issue tracker I found [Grimp](https://grimp.readthedocs.io/en/stable/usage.html), which supports this with `graph = grimp.build_graph('mypackage', exclude_type_checking_imports=True)`. 

Thanks again for your help! I wanted to mention that @charliermarsh 's recent mentions in the recent podcast about wanting to be super responsive in the issue tracker and to build a supportive community that way still holds - which is impressive given the sheer size of the projects!

I will for findability/traceability add the two issues as feature requests to the issue tracker.

---

_Referenced in [astral-sh/ruff#20736](../../astral-sh/ruff/issues/20736.md) on 2025-10-07 06:40_

---

_Referenced in [astral-sh/ruff#20737](../../astral-sh/ruff/issues/20737.md) on 2025-10-07 06:43_

---

_Closed by @gwdekker on 2025-10-07 06:47_

---
