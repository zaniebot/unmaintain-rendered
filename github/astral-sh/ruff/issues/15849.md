---
number: 15849
title: "Panic in `PYI019` autofix"
type: issue
state: closed
author: AlexWaygood
labels:
  - bug
  - rule
assignees: []
created_at: 2025-01-31T12:40:00Z
updated_at: 2025-01-31T14:19:37Z
url: https://github.com/astral-sh/ruff/issues/15849
synced_at: 2026-01-07T12:31:13-06:00
---

# Panic in `PYI019` autofix

---

_Issue opened by @AlexWaygood on 2025-01-31 12:40_

### Description

Running `ruff check --select=PYI019 --preview foo.pyi` triggers a panic if `foo.pyi` has this contents:

```py
class F:
    @classmethod
    def m[S](cls: type[S], /) -> S[int]: ...
```

The panic occurs at this line here:

https://github.com/astral-sh/ruff/blob/59be5f5278d78e42a46b9e7c9306a93a3892ab29/crates/ruff_linter/src/rules/flake8_pyi/rules/custom_type_var_return_type.rs#L295-L297

And the reason is that, contrary to what the comment says, `uses_custom_typevar` does _not_ guarantee that the return `Expr` will be an `ExprName`, due to the `map_subscript` call here: https://github.com/astral-sh/ruff/blob/59be5f5278d78e42a46b9e7c9306a93a3892ab29/crates/ruff_linter/src/rules/flake8_pyi/rules/custom_type_var_return_type.rs#L187-L189

(The `map_subscript` call also looks buggy, FWIW.)

We should switch to a more type-safe code pattern here. Note that although the panic occurs in autofix logic, the panic occurs even if you run Ruff without `--fix`, since we create fixes for diagnostics even if `--fix` is not specified.

---

_Label `bug` added by @AlexWaygood on 2025-01-31 12:40_

---

_Label `rule` added by @AlexWaygood on 2025-01-31 12:40_

---

_Assigned to @AlexWaygood by @AlexWaygood on 2025-01-31 12:40_

---

_Referenced in [astral-sh/ruff#15821](../../astral-sh/ruff/pulls/15821.md) on 2025-01-31 12:41_

---

_Comment by @AlexWaygood on 2025-01-31 13:05_

This also triggers a panic at the same location in the Rust code:

```py
class F:
    def m[S](self: S) -> S[int]: ...
```

Because there's another `map_subscript` call here, which is also incorrect:

https://github.com/astral-sh/ruff/blob/59be5f5278d78e42a46b9e7c9306a93a3892ab29/crates/ruff_linter/src/rules/flake8_pyi/rules/custom_type_var_return_type.rs#L217-L222

---

_Referenced in [astral-sh/ruff#15851](../../astral-sh/ruff/pulls/15851.md) on 2025-01-31 13:34_

---

_Closed by @AlexWaygood on 2025-01-31 14:19_

---
