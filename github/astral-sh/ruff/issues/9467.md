---
number: 9467
title: Quoted annotations should be parsed as if parenthesized
type: issue
state: closed
author: charliermarsh
labels:
  - bug
  - help wanted
  - parser
assignees: []
created_at: 2024-01-11T13:50:44Z
updated_at: 2025-01-16T06:08:17Z
url: https://github.com/astral-sh/ruff/issues/9467
synced_at: 2026-01-07T12:31:13-06:00
---

# Quoted annotations should be parsed as if parenthesized

---

_Issue opened by @charliermarsh on 2024-01-11 13:50_

It was recently agreed that quoted annotations should be parsed as if they were implicitly wrapped in parentheses. So, e.g., they can contain otherwise-invalid indentation, newlines within binary operators, etc.

See: https://github.com/microsoft/pyright/issues/6940#issuecomment-1886272420

---

_Label `parser` added by @charliermarsh on 2024-01-11 13:50_

---

_Label `bug` added by @charliermarsh on 2024-01-29 03:59_

---

_Comment by @Glyphack on 2024-02-01 19:31_

Should this be implemented in the parser layer or [here](https://github.com/astral-sh/ruff/blob/master/crates/ruff_linter/src/checkers/ast/mod.rs#L1860) where we emit the warning?

---

_Comment by @dhruvmanila on 2024-03-29 02:55_

I think it should be implemented in the `parse_type_annotation` function which is used by the AST checker to report an error if found:

https://github.com/astral-sh/ruff/blob/a0263ab472f824b0673a46f6923abe012ba3b374/crates/ruff_python_parser/src/typing.rs#L22-L44

I would also suggest to look at other references of `parse_type_annotation` function to make sure they aren't affected in any way with this change. They shouldn't be but just to make sure :)

---

_Comment by @Glyphack on 2024-03-29 16:23_

Nice, I can work on this.

---

_Referenced in [astral-sh/ruff#10742](../../astral-sh/ruff/pulls/10742.md) on 2024-04-02 21:05_

---

_Comment by @MichaReiser on 2025-01-08 17:06_

An easy fix here would probably be adding new `parse_parenthesized_expression` methods or to extend `parse_expression` with an argument whether it is parenthesized and then funneling that information to the lexer. 

---

_Comment by @carljm on 2025-01-08 17:07_

At this point, we'll want the fix here to apply to both ruff and red-knot.

---

_Label `help wanted` added by @MichaReiser on 2025-01-08 17:15_

---

_Comment by @dhruvmanila on 2025-01-09 04:56_

> At this point, we'll want the fix here to apply to both ruff and red-knot.

Agreed. Both ruff and red knot utilizes the `parse_expression_range` function from the parser:

https://github.com/astral-sh/ruff/blob/21aa12a073091e31fd9ca5fc47a869a257e40df2/crates/ruff_python_parser/src/lib.rs#L157-L167

So, as Micha suggested, we could add a `parse_parenthesized_expression_range` function. I'd suggest adding a new `Mode::ParenthesizedExpression` and initiating the `Lexer` with a `nesting` value of 1 which I think should solve this. It might require some testing. 

---

_Referenced in [astral-sh/ruff#15387](../../astral-sh/ruff/pulls/15387.md) on 2025-01-09 23:37_

---

_Closed by @dhruvmanila on 2025-01-16 06:08_

---

_Closed by @dhruvmanila on 2025-01-16 06:08_

---
