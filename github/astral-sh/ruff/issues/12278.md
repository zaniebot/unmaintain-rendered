---
number: 12278
title: "[red-knot] Module resolver has incorrect behaviour if a single-file module and potential namespace package coexist"
type: issue
state: closed
author: AlexWaygood
labels:
  - bug
  - ty
assignees: []
created_at: 2024-07-10T15:44:31Z
updated_at: 2024-09-06T11:14:27Z
url: https://github.com/astral-sh/ruff/issues/12278
synced_at: 2026-01-07T12:31:13-06:00
---

# [red-knot] Module resolver has incorrect behaviour if a single-file module and potential namespace package coexist

---

_Issue opened by @AlexWaygood on 2024-07-10 15:44_

The following test should pass, but fails:

```diff
diff --git a/crates/red_knot_module_resolver/src/resolver.rs b/crates/red_knot_module_resolver/src/resolver.rs
index 71b807871..5decee0c6 100644
--- a/crates/red_knot_module_resolver/src/resolver.rs
+++ b/crates/red_knot_module_resolver/src/resolver.rs
@@ -1140,4 +1140,21 @@ mod tests {
             system_path_to_file(&db, stdlib.join("functools.pyi"))
         );
     }
+
+    #[test]
+    fn single_file_takes_priority_over_namespace_package() {
+        const SRC: &[FileSpec] = &[("foo.py", "x = 1"), ("foo/bar.py", "x = 2")];
+
+        let TestCase { db, src, .. } = TestCaseBuilder::new().with_src_files(SRC).build();
+
+        let foo_module_name = ModuleName::new_static("foo").unwrap();
+        let foo_bar_module_name = ModuleName::new_static("foo.bar").unwrap();
+
+        // `foo.py` takes priority over the `foo` directory;
+        // `foo.bar` isn't recognised as a module:
+        let foo_module = resolve_module(&db, foo_module_name.clone()).unwrap();
+        let foo_path = src.join("foo.py");
+        assert_eq!(&foo_path, foo_module.file().path(&db));
+        assert_eq!(resolve_module(&db, foo_bar_module_name.clone()), None);
+    }
 }
```

At runtime, Python considers that a `foo` module exists and considers that a `foo.bar` module does not exist (it does not view the `foo` module as a package, as the `foo.py` file takes priority over the `foo` directory). The red-knot module resolver currently has the opposite understanding: it believes that there is no module `foo`, and that there _is_ a module `foo.bar`.

---

_Label `bug` added by @AlexWaygood on 2024-07-10 15:44_

---

_Label `red-knot` added by @AlexWaygood on 2024-07-10 15:44_

---

_Assigned to @AlexWaygood by @AlexWaygood on 2024-07-10 15:44_

---

_Referenced in [astral-sh/ruff#11653](../../astral-sh/ruff/issues/11653.md) on 2024-07-10 15:44_

---

_Referenced in [astral-sh/ruff#13254](../../astral-sh/ruff/pulls/13254.md) on 2024-09-05 15:58_

---

_Closed by @AlexWaygood on 2024-09-06 11:14_

---
