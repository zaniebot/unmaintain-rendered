---
number: 4491
title: Rule C416 broke some pandas code
type: issue
state: open
author: wlach
labels:
  - bug
assignees: []
created_at: 2023-05-18T13:19:19Z
updated_at: 2023-05-18T19:09:16Z
url: https://github.com/astral-sh/ruff/issues/4491
synced_at: 2026-01-07T12:31:12-06:00
---

# Rule C416 broke some pandas code

---

_Issue opened by @wlach on 2023-05-18 13:19_

<!--
Thank you for taking the time to report an issue! We're glad to have you involved with Ruff.

If you're filing a bug report, please consider including the following information:

* A minimal code snippet that reproduces the bug.
* The command you invoked (e.g., `ruff /path/to/file.py --fix`), ideally including the `--isolated` flag.
* The current Ruff settings (any relevant sections from your `pyproject.toml`).
* The current Ruff version (`ruff --version`).
-->

This snippit:

```
import pandas as pd
obj = { k: v for k,v in pd.DataFrame.from_records([], columns=["foo", "bar", "baz"]).groupby("foo")}
```

Is rewritten to the following using the [C416](https://beta.ruff.rs/docs/rules/unnecessary-comprehension/) rule (no unnecessary comprehensions):

```
import pandas pd
obj = dict(pd.DataFrame.from_records([], columns=["foo", "bar", "baz"]).groupby("foo"))
```

However that generates a TypeError when I run it. I filed a bug about this upstream (see pandas-dev/pandas#53287) but it makes me wonder if this rule is safe to apply. Current using ruff 0.0.262.

---

_Comment by @charliermarsh on 2023-05-18 13:23_

Huh, interesting. It's not immediately clear to me why / how those are different.

---

_Label `bug` added by @charliermarsh on 2023-05-18 13:23_

---

_Comment by @edgarrmondragon on 2023-05-18 15:18_

FWIW it's fixed by wrapping the `DataFrameGroupBy` object with `iter`:

```python
import pandas as pd
obj = dict(iter(pd.DataFrame.from_records([], columns=["foo", "bar", "baz"]).groupby("foo")))
```

or using the splat `*` operator

```python
import pandas as pd
obj = dict(*pd.DataFrame.from_records([], columns=["foo", "bar", "baz"]).groupby("foo"))
```


---

_Comment by @Charlie-XIAO on 2023-05-18 17:14_

The splat `*` operator does not work in general (only works when empty). `iter()` works because `DataFrameGroupBy.__iter__()` is a public method that returns a generator yielding sequence of `(name, subsetted object)` for each group.

---

_Comment by @zanieb on 2023-05-18 17:30_

Interesting...

> Thanks for reporting this issue. I looked online and apparently Python's dict() method checks for existence of the .keys() method.
>
> https://stackoverflow.com/questions/40667093/what-is-a-mapping-object-according-to-dict-type
>
> Unfortunately, in this case obj.keys returns a str, which is not callable.

ref https://github.com/pandas-dev/pandas/issues/53287#issuecomment-1553294794

---

_Referenced in [astral-sh/ruff#14909](../../astral-sh/ruff/pulls/14909.md) on 2024-12-19 20:41_

---
