---
number: 15948
title: "[red-knot] add `Type::SubclassOf` support to `Type::try_call`"
type: issue
state: closed
author: carljm
labels:
  - help wanted
  - ty
assignees: []
created_at: 2025-02-04T20:35:44Z
updated_at: 2025-05-07T15:21:40Z
url: https://github.com/astral-sh/ruff/issues/15948
synced_at: 2026-01-07T12:31:13-06:00
---

# [red-knot] add `Type::SubclassOf` support to `Type::try_call`

---

_Issue opened by @carljm on 2025-02-04 20:35_

### Description

Existing type checkers (and the typing spec) allow calling an object of type `type[C]` (in red-knot, `Type::SubclassOf(<Class C>)`), with the result of the call being an object of type `C` (in red-knot, `Type::Instance(<Class C>)`).

This is not actually sound, because Liskov compatibility is not enforced on type constructor methods (`__init__` and `__new__`) when subclassing, so you can't be sure that a constructor call that works for a class `C` will actually work for a subclass of `C`. But it's widely relied on, and we will have to support it.

I would like to have an opt-in diagnostic emitted whenever you call an object of `type[C]`, so users who want to avoid this unsoundness have that option.

---

_Label `red-knot` added by @carljm on 2025-02-04 20:35_

---

_Label `help wanted` added by @carljm on 2025-02-04 20:35_

---

_Referenced in [astral-sh/ruff#15843](../../astral-sh/ruff/pulls/15843.md) on 2025-02-04 20:37_

---

_Comment by @carljm on 2025-02-04 20:47_

On second thought, it may be best to hold off on this issue (or at least the new-diagnostic part of it) until after @AlexWaygood completes an in-progress refactor of `CallOutcome`, since this diagnostic would likely imply adding a new outcome variant to `CallOutcome`?

---

_Comment by @mishamsk on 2025-02-04 23:14_

I can take it whenever @AlexWaygood is ready since I've triggered the issue in the first place. Not sure how you manage blocked issues, but feel free to assign this one to me and I'll monitor the comments

---

_Assigned to @mishamsk by @carljm on 2025-02-04 23:15_

---

_Referenced in [astral-sh/ruff#16121](../../astral-sh/ruff/pulls/16121.md) on 2025-02-19 13:32_

---

_Comment by @mishamsk on 2025-02-28 19:55_

@AlexWaygood I believe this one is unblocked now? Also see another comment related to analyzing `__init__` signatures for class literals:

```
// TODO annotated return type on `__new__` or metaclass `__call__`
            // TODO check call vs signatures of `__new__` and/or `__init__`
```

which may or may not be tackled together...

---

_Comment by @AlexWaygood on 2025-02-28 19:57_

> [@AlexWaygood](https://github.com/AlexWaygood) I believe this one is unblocked now?

Should be, yup!

Those other todos should be tackled in separate PRs, I think; they're pretty separate issues

---

_Referenced in [astral-sh/ty#186](../../astral-sh/ty/issues/186.md) on 2025-03-05 03:14_

---

_Renamed from "[red-knot] add Type::SubclassOf support to Type::call and Type::call_unbound" to "[red-knot] add `Type::SubclassOf` support to `Type::try_call`" by @sharkdp on 2025-03-10 10:45_

---

_Referenced in [astral-sh/ruff#16597](../../astral-sh/ruff/pulls/16597.md) on 2025-03-10 10:46_

---

_Comment by @sharkdp on 2025-03-10 12:25_

The core functionality was added in astral-sh/ruff#16597, but the diagnostic has not been implemented. Also, those calls will really only be properly checked when astral-sh/ty#186 is also implemented.

---

_Comment by @mishamsk on 2025-03-10 13:18_

I think the full implementation of the `Subclass` arm will be pretty involved, but may be out of scope here. I was going to ask related question this week.

What I was thinking about is `Self`. When we handle plain class literals (#16511 case) we can avoid properly handling `Self` since `class.to_instance()` will return the correct type in all realistic scenarios. But with `type[C]`, in ideal world we would record a stronger typing relationship - due to the free type variable... so fully model this:

```py
T = TypeVar("T", bound="Base")

class Base:
    pass

class Sub(Base):
    pass

def get_instance(clz: type[T]) -> T:
    return clz()

instance = get_instance(Sub)
reveal_type(instance) # Sub, not Base
```

but for constructors.

and AFAIK there is no machinery for that currently. 

Anyways, that's for the future. I hope I'll close astral-sh/ty#186 this week, and we can decide whether it makes sense to do a small PR to add the diagnostic here or dive into `Self` support

---

_Comment by @AlexWaygood on 2025-03-10 13:23_

> But with `type[C]`, in ideal world we would record a stronger typing relationship - due to the free type variable... so fully model this:
> 
> T = TypeVar("T", bound="Base")
> 
> class Base:
>     pass
> 
> class Sub(Base):
>     pass
> 
> def get_instance(clz: type[T]) -> T:
>     return clz()
> 
> instance = get_instance(Sub)
> reveal_type(instance) # Sub, not Base
> 
> but for constructors.
> 
> and AFAIK there is no machinery for that currently.

This example involves generic functions, which aren't yet modeled by red-knot at all -- @dcreager is currently working on that. It's quite a large topic, and I'd definitely consider it out of scope for this issue! :-)

---

_Comment by @mishamsk on 2025-03-10 14:02_

yeah, I thought so. Is there an issue I could track to see the progress related to type variables / generics?

---

_Comment by @AlexWaygood on 2025-03-10 14:28_

> yeah, I thought so. Is there an issue I could track to see the progress related to type variables / generics?

(Sent you an invite to our internal design doc around this!)

---

_Comment by @mishamsk on 2025-03-10 15:12_

thanks a lot! fascinating read. I'll keep an eye on the roadmap, maybe I'll find a non-impending way to positively slot in a PR or smth. somewhere along the way!

---

_Added to milestone `Red Knot Q1 2025` by @carljm on 2025-03-27 18:33_

---

_Removed from milestone `Red Knot Q1 2025` by @carljm on 2025-03-27 18:33_

---

_Added to milestone `Red Knot Alpha` by @carljm on 2025-03-27 18:33_

---

_Comment by @AlexWaygood on 2025-03-31 11:26_

I'm going to close this now, since the core functionality was implemented in https://github.com/astral-sh/ruff/pull/16597. Diagnostics for invalid calls are not yet implemented, and are very important, but should be naturally solved at the same time as https://github.com/astral-sh/ty/issues/186 due to the fact that our implementation of `Type::call()` for `Type::SubclassOf` variants just delegates to our `Type::call()` implementation for `Type::ClassLiteral` variants. Implementing diagnostics for invalid calls to `type[]` types is also not _so_ critical that it needs to be prioritised before the planned alpha release.

As @mishamsk points out, we do not yet handle generic arguments to `type[]`, but this is a much bigger issue that will be tackled as part of our upcoming work on generics.

> I would like to have an opt-in diagnostic emitted whenever you call an object of type[C], so users who want to avoid this unsoundness have that option.

I think this comment by @carljm is the only part of this issue that is not yet covered by things already implemented or things tracked by other issues. I'll open a followup issue to track this specifically.

---

_Closed by @AlexWaygood on 2025-03-31 11:26_

---

_Referenced in [astral-sh/ty#145](../../astral-sh/ty/issues/145.md) on 2025-03-31 11:37_

---

_Comment by @AlexWaygood on 2025-03-31 11:39_

> > I would like to have an opt-in diagnostic emitted whenever you call an object of type[C], so users who want to avoid this unsoundness have that option.
> 
> I think this comment by [@carljm](https://github.com/carljm?rgh-link-date=2025-03-31T11%3A26%3A03.000Z) is the only part of this issue that is not yet covered by things already implemented or things tracked by other issues. I'll open a followup issue to track this specifically.

I wroteup https://github.com/astral-sh/ty/issues/145 for this feature

---
