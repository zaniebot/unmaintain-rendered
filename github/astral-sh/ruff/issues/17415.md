---
number: 17415
title: "[red-knot] is it OK for `TypeVarInstance` to directly hold its `Definition`?"
type: issue
state: closed
author: carljm
labels:
  - ty
assignees: []
created_at: 2025-04-15T21:27:42Z
updated_at: 2025-04-23T18:24:54Z
url: https://github.com/astral-sh/ruff/issues/17415
synced_at: 2026-01-07T12:31:13-06:00
---

# [red-knot] is it OK for `TypeVarInstance` to directly hold its `Definition`?

---

_Issue opened by @carljm on 2025-04-15 21:27_

Or does this lead to AST dependence and over-invalidation if a typevar is imported and the source module has unrelated changes?

We only use `TypeVarInstance::definition` to support goto-type-definition on typevars.

---

_Label `red-knot` added by @carljm on 2025-04-15 21:27_

---

_Comment by @carljm on 2025-04-15 21:51_

This was added in https://github.com/astral-sh/ruff/pull/16901 but I don't think there was discussion there specifically about the AST-dependence consequences.

---

_Comment by @MichaReiser on 2025-04-22 08:27_

Using a `Definition` is fine because its identity is defined by all fields except `kind`. That means, the `Definition`'s ID remains unchanged for as long as its file, scope, symbol, and re-export remain the same. 

A single change in the AST file won't invalidate the `Definition` but the following changes could:

* A new scope is introduced before the definition's scope
* A new symbol is introduced in the definition's scope and comes before the definition's symbol
* The definition's re-export convention is changed. 

However, there's a possible issue related to persistent caching where deserializing a `TypeVarInstance` now requires deserializing its `Definition` which, in turn, requires eager deserialization of the AST node. 

Now, whether this is a problem long-term depends on if we're going to change our `AstNodeRef` representation to something that hold a a weak pointer that can be deserialized lazily to reduce red knot's memory footprint.



---

_Comment by @carljm on 2025-04-23 18:24_

Makes sense. Closing this issue for now until/unless we see problems from this that we need to fix.

---

_Closed by @carljm on 2025-04-23 18:24_

---
