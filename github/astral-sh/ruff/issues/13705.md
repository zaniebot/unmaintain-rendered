---
number: 13705
title: detect if a regex escape is needed in a pytest match statement
type: issue
state: closed
author: nstarman
labels:
  - rule
assignees: []
created_at: 2024-10-10T14:59:25Z
updated_at: 2024-12-18T11:53:49Z
url: https://github.com/astral-sh/ruff/issues/13705
synced_at: 2026-01-07T12:31:13-06:00
---

# detect if a regex escape is needed in a pytest match statement

---

_Issue opened by @nstarman on 2024-10-10 14:59_

Sometimes `re.escape` are needed in pytest for `match=...` arguments.
Then the string is modified and the regex escape is no longer needed.
It would be great if ruff could detect this and remove the unneeded `re.escape`.

M~WE:

```python
import pytest, re

with pytest.raises(Exception, match=re.escape("regexnotneeded")):
    ...
```

---

_Referenced in [astropy/astropy#16847](../../astropy/astropy/pulls/16847.md) on 2024-10-10 14:59_

---

_Label `rule` added by @MichaReiser on 2024-10-22 06:42_

---

_Referenced in [astral-sh/ruff#14746](../../astral-sh/ruff/pulls/14746.md) on 2024-12-03 00:41_

---

_Comment by @MichaReiser on 2024-12-10 12:34_

@InSyncWithFoo was so kind to implement the rule and we looked through the ecosystem changes. After seeing the changes, I don't think we should add this rule to ruff. While it's true that the `re.escape` call is unnecessary, it does train people not to use `re.escape` and they might then forget using it in cases where they actually should. 

It makes me wonder if we could create ar ule that warns about `match` parameters that would need escaping. Are there heuristics that would allow us to detect correctly escaped from incorrectly escaped strings?

---

_Comment by @nstarman on 2024-12-10 14:19_

Easier for escaped that don't need to be, much harder for not-escaped that should to be. Pytest matches can work with regex, so it would be very hard to figure out if a string that looks like a regex isn't and should be escaped.

---

_Comment by @AlexWaygood on 2024-12-10 16:45_

If you have a string passed to `pytest.raises()` that is:
1. Not a raw string
2. Not surrounded by `re.escape()` and
3. contains a regex metacharacter

Then I think it's reasonable to say that the string should _either_ be a raw string (if it's meant to be a regex) _or_ should be surrounded by `re.escape()` (if it's not meant to be a regex). That might possibly be a useful rule to add? What do we think?

---

_Comment by @InSyncWithFoo on 2024-12-10 17:11_

> Then I think it's reasonable to say that the string should _either_ be a raw string (if it's meant to be a regex) _or_ should be surrounded by `re.escape()` (if it's not meant to be a regex).

Sounds good to me. This also goes well with [`unraw-re-pattern`](https://docs.astral.sh/ruff/rules/unraw-re-pattern/).

---

_Comment by @nstarman on 2024-12-10 20:29_

And the reverse — if a string is surrounded by `re.escape` but doesn't have any regex in it?

---

_Comment by @AlexWaygood on 2024-12-10 20:32_

> And the reverse — if a string is surrounded by `re.escape` but doesn't have any regex in it?

We already considered and rejected that check in https://github.com/astral-sh/ruff/pull/14746, as Micha stated above in https://github.com/astral-sh/ruff/issues/13705#issuecomment-2531517937 I agree with his rationale. 

---

_Comment by @InSyncWithFoo on 2024-12-10 22:11_

I suppose I can go ahead and implement the new rule then? A PR should be ready sometime later this week.

---

_Referenced in [astral-sh/ruff#14966](../../astral-sh/ruff/pulls/14966.md) on 2024-12-14 00:27_

---

_Closed by @AlexWaygood on 2024-12-18 11:53_

---
