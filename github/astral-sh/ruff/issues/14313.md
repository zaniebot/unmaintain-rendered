---
number: 14313
title: "[red-knot] Double-store assertions when encountering invalid syntax"
type: issue
state: closed
author: sharkdp
labels:
  - bug
  - ty
assignees: []
created_at: 2024-11-13T10:57:55Z
updated_at: 2024-11-13T13:35:55Z
url: https://github.com/astral-sh/ruff/issues/14313
synced_at: 2026-01-07T12:31:13-06:00
---

# [red-knot] Double-store assertions when encountering invalid syntax

---

_Issue opened by @sharkdp on 2024-11-13 10:57_

During type inference on some invalid syntax examples, we encounter situations where the exact same expression appears in multiple places inside the AST. The smallest example I could find is this:
```py
for
```
When parsing it, we get the following AST. Note that the same `Name(…)` expression (same range) appears both as `target` and as `iter` field on `StmtFor`, once with `Store` context, once with `Invalid` context:
```
Module(
    ModModule {
        range: 0..3,
        body: [
            For(
                StmtFor {
                    range: 0..3,
                    is_async: false,
                    target: Name(
                        ExprName {
                            range: 3..3,
                            id: Name(""),
                            ctx: Store,
                        },
                    ),
                    iter: Name(
                        ExprName {
                            range: 3..3,
                            id: Name(""),
                            ctx: Invalid,
                        },
                    ),
                    body: [],
                    orelse: [],
                },
            ),
        ],
    },
)
```

This leads to a subsequent failing double-store assertion in `store_expression_type` because we infer types for both the `target` and the `iter` expressions:

https://github.com/astral-sh/ruff/blob/f789b12705048a4f75cddeceb843fd4afbe783f1/crates/red_knot_python_semantic/src/types/infer.rs#L2176-L2184

I'm not sure how to fix this.

Skipping storage when encountering expressions with `Invalid` context would work for this example, but there are other cases (`:x=`) where such an invalid expression is not "backed up" by a second valid expression.

Ignoring double-storage for `Invalid` expressions is also not an option, since in this example here, we run inference on `iter` first.

---

_Label `bug` added by @sharkdp on 2024-11-13 10:57_

---

_Label `red-knot` added by @sharkdp on 2024-11-13 10:57_

---

_Comment by @MichaReiser on 2024-11-13 11:06_

Hmm, this is interesting. We could consider using the ptr address instead of `Range` + `Kind`

---

_Comment by @sharkdp on 2024-11-13 11:54_

A similar example is
```py
x if $z
```
Mentioning it here because it leads to a slightly different panic (*Calling `self.infer_expression` on a standalone-expression is not allowed…*). But the underlying issue is the same, I believe.

---

_Referenced in [astral-sh/ruff#14317](../../astral-sh/ruff/pulls/14317.md) on 2024-11-13 12:28_

---

_Assigned to @sharkdp by @sharkdp on 2024-11-13 12:48_

---

_Closed by @sharkdp on 2024-11-13 13:35_

---
