---
number: 17203
title: Use new diagnostic functionality
type: issue
state: open
author: ntBre
labels:
  - tracking
  - diagnostics
assignees: []
created_at: 2025-04-04T12:56:51Z
updated_at: 2025-12-31T15:54:20Z
url: https://github.com/astral-sh/ruff/issues/17203
synced_at: 2026-01-07T12:31:13-06:00
---

# Use new diagnostic functionality

---

_Issue opened by @ntBre on 2025-04-04 12:56_

## Background

Our new diagnostic system has the ability to attach additional information to the main diagnostic. The two main types of additional information are:
- Secondary annotations
  These are rendered as additional underlined ranges in the snippet for the main diagnostic:

	```
	PLC0206 Extracting value from dictionary without calling `.items()`
	  --> dict_index_missing_items.py:59:5
	   |
	58 |
	59 | for instrument in ORCHESTRA:
	   |     ^^^^^^^^^^^^^^^^^^^^^^^  <- primary diagnostic range
	60 |     data = json.dumps(
	61 |         {
	62 |             "instrument": instrument,
	63 |             "section": ORCHESTRA[instrument],
	   |                        ---------------------  <- secondary annotation
	64 |         }
	65 |     )
	help: Use `for instrument, value in ORCHESTRA.items()` instead
	```

	and can be added in most lint rules via the [`DiagnosticGuard::secondary_annotation`](https://github.com/astral-sh/ruff/blob/25e480bbce6596a1d62e5243306a707aa426b5b5/crates/ruff_linter/src/checkers/ast/mod.rs#L3557) helper.

	The example above is from #22312.

- Sub-diagnostics
  The `help: ...` line above is actually a simple example of a sub-diagnostic without its own code snippet. For simple messages, you can use the [`Diagnostic::info`](https://github.com/astral-sh/ruff/blob/25e480bbce6596a1d62e5243306a707aa426b5b5/crates/ruff_db/src/diagnostic/mod.rs#L129) or [`Diagnostic::help`](https://github.com/astral-sh/ruff/blob/25e480bbce6596a1d62e5243306a707aa426b5b5/crates/ruff_db/src/diagnostic/mod.rs#L136) methods via the `DiagnosticGuard` deref implementation.

	Sub-diagnostics can, however, include almost all of the kinds of information as a primary diagnostic. We don't have any examples of this in Ruff yet, but you can find some in [ty](https://github.com/astral-sh/ruff/blob/25e480bbce6596a1d62e5243306a707aa426b5b5/crates/ty_python_semantic/resources/mdtest/snapshots/union_call.md_-_Calling_a_union_of_f%E2%80%A6_-_Try_to_cover_all_pos%E2%80%A6_-_Cover_non-keyword_re%E2%80%A6_%28707b284610419a54%29.snap#L125-L141).
	
	I think we'll mostly be okay with secondary annotations or simple sub-diagnostics in Ruff, but it's possible to produce these if needed.

## Places to use new diagnostics

This is a list of places we've thought about using the new diagnostics. Note that most of these are follow-up comments on merged PRs, so the fact that they're merged doesn't mean that the diagnostics have been updated.

- [ ] https://github.com/astral-sh/ruff/pull/17121#discussion_r2022946393
- [ ] https://github.com/astral-sh/ruff/pull/17129#discussion_r2024242987
- [ ] https://github.com/astral-sh/ruff/pull/17138#discussion_r2026698681
- [ ] https://github.com/astral-sh/ruff/pull/15888#issuecomment-2631264843
- [ ] https://github.com/astral-sh/ruff/pull/18541#discussion_r2139246087
- [ ] https://github.com/astral-sh/ruff/issues/16490#issuecomment-3700255982
  I've already done some of the scouting work here, so it could be a great place to start :)
- [ ] https://github.com/astral-sh/ruff/issues/22188#issuecomment-3691531001

## Examples

Here are a couple of example PRs showing how to use secondary annotations:

- https://github.com/astral-sh/ruff/pull/22312
- https://github.com/astral-sh/ruff/pull/19900

One thing to watch out for is that changing the _primary_ diagnostic range can easily be a breaking change, so for the most part we only want to add new annotations here, not change the existing ones.

---

_Label `tracking` added by @ntBre on 2025-04-04 12:57_

---

_Label `diagnostics` added by @dhruvmanila on 2025-04-04 13:00_

---

_Referenced in [astral-sh/ruff#18516](../../astral-sh/ruff/pulls/18516.md) on 2025-06-09 21:23_

---

_Referenced in [astral-sh/ruff#18541](../../astral-sh/ruff/pulls/18541.md) on 2025-06-11 10:18_

---

_Renamed from "Multi-span diagnostics" to "Use new diagnostic functionality" by @ntBre on 2025-08-01 15:13_

---

_Referenced in [astral-sh/ruff#19690](../../astral-sh/ruff/issues/19690.md) on 2025-08-01 15:16_

---

_Assigned to @ntBre by @ntBre on 2025-08-12 21:14_

---

_Referenced in [astral-sh/ruff#19886](../../astral-sh/ruff/pulls/19886.md) on 2025-08-12 21:40_

---

_Comment by @Avasam on 2025-09-16 01:16_

- https://github.com/astral-sh/ruff/pull/17003#discussion_r2030543917 also seems to be on hold waiting for multi-span diagnostics

---

_Referenced in [astral-sh/ruff#17003](../../astral-sh/ruff/pulls/17003.md) on 2025-09-16 01:20_

---

_Comment by @ntBre on 2025-09-22 22:04_

While reviewing #20178, I realized that [builtin-attribute-shadowing (A003)](https://docs.astral.sh/ruff/rules/builtin-attribute-shadowing/#builtin-attribute-shadowing-a003) might be another good candidate here. We currently emit diagnostics like this:

```
A003 Python builtin is shadowed by method `str` from line 14
  --> A003.py:17:31
   |
15 |         pass
16 |
17 |     def method_usage(self) -> str:
   |                               ^^^
18 |         pass
   |
```

underlining the _use_ of the shadowed name and pointing back to the location in the message. We could now add a secondary annotation where the shadowing takes place, on line 14 in this case.

---

_Referenced in [astral-sh/ruff#20868](../../astral-sh/ruff/pulls/20868.md) on 2025-12-16 20:11_

---
