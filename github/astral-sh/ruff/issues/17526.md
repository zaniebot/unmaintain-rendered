---
number: 17526
title: Expand semantic syntax error test coverage
type: issue
state: closed
author: ntBre
labels:
  - internal
  - help wanted
  - tracking
assignees: []
created_at: 2025-04-21T17:07:05Z
updated_at: 2025-05-09T18:56:48Z
url: https://github.com/astral-sh/ruff/issues/17526
synced_at: 2026-01-07T12:31:13-06:00
---

# Expand semantic syntax error test coverage

---

_Issue opened by @ntBre on 2025-04-21 17:07_

## Summary

Currently, the semantic/compile-time syntax errors are tested through a combination of inline parser tests and separate integration tests in ruff and red-knot. As suggested [here](https://github.com/astral-sh/ruff/pull/17463#discussion_r2052629444), it could be good to expand the integration tests to cover all of the semantic error variants to ensure that changes to the semantic models don't affect error reporting.

The errors correspond to variants of [`SemanticSyntaxErrorKind`](https://github.com/astral-sh/ruff/blob/main/crates/ruff_python_parser/src/semantic_errors.rs#L891), and each variant should have documentation with examples of errors. These are a great starting point for the new tests, and in some cases they might be sufficient on their own.

A great first step here would be to fill in the `Status` table below by identifying which variants are currently tested.

## Ruff

In ruff, the current integration tests are in [`linter.rs`](https://github.com/astral-sh/ruff/blob/main/crates/ruff_linter/src/linter.rs#L962). For semantic errors that correspond to existing ruff rules, more `test_case`s can simply be added to the `test_syntax_errors` function, while standalone errors will need to be handled separately. It might be best to refactor `test_async_comprehension_in_sync_comprehension` into a more general test function that can run these cases.

## Red Knot

In red-knot, the integration mdtests are in [`semantic_syntax_errors.md`](https://github.com/astral-sh/ruff/blob/main/crates/red_knot_python_semantic/resources/mdtest/diagnostics/semantic_syntax_errors.md?plain=1#L1). Each level 2 heading corresponds to a single semantic syntax error, so we just need new sections  with examples for each of the missing variants.

## Status

| Rule                                     | Ruff | Red Knot |
|------------------------------------------|------|----------|
| `LateFutureImport`                       |   [✅](https://github.com/astral-sh/ruff/pull/17612)    |     ✅     |
| `ReboundComprehensionVariable`           |   [✅](https://github.com/astral-sh/ruff/pull/17725)   |   [✅](https://github.com/astral-sh/ruff/pull/17725)       |
| `DuplicateTypeParameter`                 |   [✅](https://github.com/astral-sh/ruff/pull/17725)   |      [✅](https://github.com/astral-sh/ruff/pull/17725)    |
| `MultipleCaseAssignment`                 |   [✅](https://github.com/astral-sh/ruff/pull/17725)   |     [✅](https://github.com/astral-sh/ruff/pull/17725)     |
| `IrrefutableCasePattern`                 |   [✅](https://github.com/astral-sh/ruff/pull/17748)   |      [✅](https://github.com/astral-sh/ruff/pull/17748)     |
| `SingleStarredAssignment`                |   [✅](https://github.com/astral-sh/ruff/pull/17748)    |       [✅](https://github.com/astral-sh/ruff/pull/17748)    |
| `WriteToDebug`                           |   [✅](https://github.com/astral-sh/ruff/pull/17748)    |       [✅](https://github.com/astral-sh/ruff/pull/17748)    |
| `InvalidExpression`                      |   [✅](https://github.com/astral-sh/ruff/pull/17748)    |     [✅](https://github.com/astral-sh/ruff/pull/17748)      |
| `DuplicateMatchKey`                      |   [✅](https://github.com/astral-sh/ruff/pull/17754)   |    ✅      |
| `DuplicateMatchClassAttribute`           |    [✅](https://github.com/astral-sh/ruff/pull/17754)  |    [✅](https://github.com/astral-sh/ruff/pull/17754)      |
| `LoadBeforeGlobalDeclaration`            |   [✅](https://github.com/astral-sh/ruff/pull/17592)   |     ✅     |
| `InvalidStarExpression`                  |   [✅](https://github.com/astral-sh/ruff/pull/17754)   |     [✅](https://github.com/astral-sh/ruff/pull/17754)     |
| `AsyncComprehensionInSyncComprehension` |   ✅   |      ✅    |
| `YieldOutsideFunction`                   |  ✅ |     ✅  |
| `ReturnOutsideFunction`                  |  ✅ |   ✅    |
| `AwaitOutsideAsyncFunction`              | [✅](https://github.com/astral-sh/ruff/pull/17785)  |   ✅    |


---

_Label `help wanted` added by @ntBre on 2025-04-21 17:07_

---

_Label `internal` added by @ntBre on 2025-04-21 17:07_

---

_Label `tracking` added by @ntBre on 2025-04-21 17:10_

---

_Comment by @VascoSch92 on 2025-04-23 18:47_

I believe for the **Ruff linter** the `ReturnOutsideFunction` and `YieldOutsideFunction` are already tested, see [here](https://github.com/astral-sh/ruff/blob/main/crates/ruff_linter/resources/test/fixtures/syntax_errors/yield_scope.py) and [here](https://github.com/astral-sh/ruff/blob/main/crates/ruff_linter/resources/test/fixtures/syntax_errors/return_outside_function.py), respectively

PS: the link `semantic_syntax_error.md` seems to be broken (at least for me). This is the correct one [[link]](https://github.com/astral-sh/ruff/blob/main/crates/red_knot_python_semantic/resources/mdtest/diagnostics/semantic_syntax_errors.md)

---

_Referenced in [astral-sh/ruff#17592](../../astral-sh/ruff/pulls/17592.md) on 2025-04-23 19:12_

---

_Referenced in [astral-sh/ruff#17612](../../astral-sh/ruff/pulls/17612.md) on 2025-04-24 16:49_

---

_Comment by @maxmynter on 2025-04-24 16:51_

I'm unsure if I totally get  believe the `LateFutureImport` is tested as part of pyflakes `F404` in https://github.com/astral-sh/ruff/blob/8d2c79276d167fcfcf9143a2bc1b328bb9d0f876/crates/ruff_linter/resources/test/fixtures/pyflakes/F404_0.py#L1-L8 and https://github.com/astral-sh/ruff/blob/8d2c79276d167fcfcf9143a2bc1b328bb9d0f876/crates/ruff_linter/resources/test/fixtures/pyflakes/F404_1.py#L1-L5

If not, I have added a test along the lines of what @VascoSch92 proposed for `LoadBeforeGlobalDeclaration` it in [17612](https://github.com/astral-sh/ruff/pull/17612).

Happy to help with more tests. Let me know if that is on the right track.


---

_Referenced in [astral-sh/ruff#17725](../../astral-sh/ruff/pulls/17725.md) on 2025-04-29 22:50_

---

_Comment by @maxmynter on 2025-04-29 22:52_

Added a PR (#17725) with a refactor of  `test_async_comprehension_in_sync_comprehension` and test cases for `ReboundComprehensionVariable`, `DuplicateTypeParameter`, and `MultipleCaseAssignment`.

Let me know if we should add more tests there or merge it so the refactor becomes available for others on `main`.

---

_Comment by @ntBre on 2025-04-30 14:18_

Thanks for your work on this! I'll just paste what I commented on #17725 for visibility:

> I think it makes sense to batch a few of them like you did here, though, instead of necessarily one PR per error, at least if the tests are pretty straightforward.

One PR per error is fine too, that's what I pictured initially. But feel free to batch them if you want to tackle a handful at once!

---

_Referenced in [astral-sh/ruff#17748](../../astral-sh/ruff/pulls/17748.md) on 2025-04-30 21:04_

---

_Comment by @maxmynter on 2025-04-30 21:07_

Added propositions for `IrrefutableCasePattern`, `SingleStarredAssignment`, `WriteToDebug`, and `InvalidExpression` in #17748 .

Added propositions for `InvalidStarExpression`, `DuplicateMatchKey`, and `DuplicateMatchClassAttribue` in #17754 .

Going forward, I will add a comment here when writing tests for rules so we can avoid duplicate work.

---

_Referenced in [astral-sh/ruff#17754](../../astral-sh/ruff/pulls/17754.md) on 2025-05-01 03:32_

---

_Comment by @maxmynter on 2025-05-01 04:12_

In `crates/red_knot_python_semantic/resources/mdtest/diagnostics/semantic_syntax_errors.md` lines 211-end, there is already a test for load before global declaration, albeit with a todo. 
https://github.com/astral-sh/ruff/blob/03d8679adff964ddb4d2945d5b39665bead72755/crates/red_knot_python_semantic/resources/mdtest/diagnostics/semantic_syntax_errors.md?plain=1#L211-L221



Unsure what to do here.


---

_Comment by @ntBre on 2025-05-01 15:34_

I'll go ahead and mark that one covered for the sake of this issue. I'm working on that now since it requires some more extensive changes in red-knot: https://github.com/astral-sh/ruff/pull/17637

---

_Referenced in [astral-sh/ruff#17785](../../astral-sh/ruff/pulls/17785.md) on 2025-05-02 02:08_

---

_Comment by @maxmynter on 2025-05-02 02:20_

Added tests for `AsyncComprehensionOutsideAsyncFunction` and `AwaitOutsideAsync` in #17785. Then all cases from the Issue are covered once the associated PR's are merged. 

---

_Referenced in [astral-sh/ruff#17804](../../astral-sh/ruff/pulls/17804.md) on 2025-05-04 13:31_

---

_Comment by @ntBre on 2025-05-09 18:56_

Looks like these are all covered now. Thanks for all the help!

---

_Closed by @ntBre on 2025-05-09 18:56_

---
