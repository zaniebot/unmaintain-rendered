---
number: 6586
title: B018 false positive for notebooks
type: issue
state: closed
author: david-waterworth
labels:
  - bug
  - accepted
assignees: []
created_at: 2023-08-15T04:34:49Z
updated_at: 2023-11-14T04:37:38Z
url: https://github.com/astral-sh/ruff/issues/6586
synced_at: 2026-01-07T12:31:12-06:00
---

# B018 false positive for notebooks

---

_Issue opened by @david-waterworth on 2023-08-15 04:34_

Commonly with notebooks the `result` of a calculation is often implicitly printed, i.e.

```
x = 1 + 2
x
```

I believe x.\_\_repl\_\_() is called.

`ruff` reports `B018: useless-expression`. I'm not sure this is easy to detect as it doesn't have to be the last statement of a cell - i.e. the output of the following is to print x and ignore y.

```
x = 1 + 2
x
y = x + 2
y
```

---

_Comment by @charliermarsh on 2023-08-15 13:02_

I think this is a case where I'd likely recommend disabling the rule for notebooks. @dhruvmanila, any idea if we could detect whether the expression is the last line in a cell? I know we have the splits for import sorting, but not sure how accessible they are...


---

_Comment by @dhruvmanila on 2023-08-15 13:12_

I would recommend disabling as well. Otherwise, what could be done is using the [`cell_offsets`](https://github.com/astral-sh/ruff/blob/81b1176f9928ca146f4f6a3ab32804e5fcc00c75/crates/ruff/src/jupyter/notebook.rs#L403-L406) (aka the cell boundaries) which can be used to detect the last non-empty line of the cell. This would be limited as pointed out by @david-waterworth in the second example where these expressions are present in the middle of the cell.

---

_Comment by @charliermarsh on 2023-08-16 03:48_

Given:

```python
x = 1 + 2
x
y = x + 2
y
```

I would assume we want to flag `x` (second line) as useless but not `y` (fourth line), but it sounds like neither should be flagged. Why is that?

---

_Comment by @dhruvmanila on 2023-08-16 03:57_

Oh yes, you're correct. I just verified that the value of `x` won't be printed. So, I think it's safe to avoid checking for unused expressions for the last non-empty line i.e., basically if there's an expression before the cell boundary avoid flagging `B018` for it.

---

_Comment by @charliermarsh on 2023-08-16 03:58_

@david-waterworth - Does that make sense to you? Your initial message said "it doesn't have to be the last statement of a cell".

---

_Label `waiting-on-author` added by @charliermarsh on 2023-08-16 03:59_

---

_Comment by @david-waterworth on 2023-08-16 04:23_

@charliermarsh yes you're correct - I thought it printed the first statement but I checked and it prints the last.

Also

```
x = 1
x

for i in range(10):
    i
```

Doesn't print anything so not really sure how exactly it works and I've not been able to find a definitive description. But it seems to print the value of the last statement but only if it's not indented.

---

_Comment by @dhruvmanila on 2023-08-16 04:59_

> Doesn't print anything so not really sure how exactly it works and I've not been able to find a definitive description. But it seems to print the value of the last statement but only if it's not indented.

I think it's because the entire `for` loop is a single statement in the AST. The `i` expression is part of the top level `for` loop (child node):
```python
for i in range(10):
    i
```

while in the previous example, the last node is an expression:
```python
x
```

Expressions evaluate to a value while statements do not and that's why the second example prints the value of `x` while the first example (`for` loop) doesn't.

---

_Comment by @dhruvmanila on 2023-08-16 05:09_

We might want to ignore `B015` (useless-comparison) as well.

---

_Label `waiting-on-author` removed by @charliermarsh on 2023-08-23 03:40_

---

_Label `accepted` added by @charliermarsh on 2023-08-23 03:40_

---

_Label `bug` added by @charliermarsh on 2023-08-23 03:40_

---

_Referenced in [astral-sh/ruff#7300](../../astral-sh/ruff/issues/7300.md) on 2023-09-12 10:55_

---

_Comment by @dhruvmanila on 2023-11-14 04:37_

(Merging this with a general tracking issue: https://github.com/astral-sh/ruff/issues/8669)

---

_Closed by @dhruvmanila on 2023-11-14 04:37_

---
