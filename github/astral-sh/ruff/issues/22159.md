---
number: 22159
title: "[Fix error, FAST002] \"Fix introduced a syntax error. Reverting all changes\""
type: issue
state: open
author: tuttle
labels:
  - bug
  - fixes
assignees: []
created_at: 2025-12-23T10:55:27Z
updated_at: 2026-01-05T10:14:19Z
url: https://github.com/astral-sh/ruff/issues/22159
synced_at: 2026-01-07T12:31:14-06:00
---

# [Fix error, FAST002] "Fix introduced a syntax error. Reverting all changes"

---

_Issue opened by @tuttle on 2025-12-23 10:55_

**Rule:** FAST002 FastAPI dependency without `Annotated`

**Ruff version:** 0.14.10

**Py module:** Unfortunately, I cannot share proprietary source code publicly, but I would be happy to help solve this problem because Ruff is such a fantastic tool.

I attempted to create a minimal reproduction by stripping down the module (removing endpoints and function bodies), but the syntax error disappeared in the process. It seems the full module is necessary to trigger the bug.

Since GitHub doesn't support private attachments, **is there an email address where I can send the file**?

Thank you.

---

_Comment by @harupy on 2025-12-23 11:34_

This might be completely unrelated but `FAST002` doesn't seem check positional-only parameters. This leads to a fix that would cause a syntax error:

https://github.com/astral-sh/ruff/blob/5ea30c4c53894dc35fa5af2ca84757ec24f3f7d0/crates/ruff_linter/src/rules/fastapi/rules/fastapi_non_annotated_dependency.rs#L116-L125

---

Never mind this. FastAPI doesn't support positional-only parameters.

```python
from fastapi import FastAPI
from fastapi.testclient import TestClient

app = FastAPI()

@app.get('/')
def f(a: str = '', /, b: str = ''):
    return {'a': a, 'b': b}

client = TestClient(app)
print(client.get('/?a=x&b=y').json())
```

throws:

```
TypeError: f() got some positional-only arguments passed as keyword arguments: 'a'
```

---

_Label `bug` added by @AlexWaygood on 2025-12-23 14:52_

---

_Label `fixes` added by @AlexWaygood on 2025-12-23 14:52_

---

_Comment by @ntBre on 2025-12-23 20:42_

Thanks for the report! And thanks @harupy for looking into it!

You can email me at brent@astral.sh if you want me to take a look! I think we'll need a minimal example to fix this, but I'm happy to try minimizing and anonymizing yours if you can share it.

---

_Comment by @ntBre on 2025-12-31 15:07_

I minimized the example down to this code:

```py
from fastapi import APIRouter, Depends

router = APIRouter()


@router.get("/{a}/{b}/{c}")  # noqa: FAST003
def foo(a: str, b: str): ...


@router.get("/{baz}")
def bar(d: D = Depends(get_one), e: E = Depends(get_two)): ...
```

and this command:

```shell
ruff check app.py --fix --unsafe-fixes --select FAST002,FAST003
```

But I still don't really understand what's going on. Deleting nearly anything else here prevents the syntax error, and selecting either of the two rules on its own also prevents the syntax error. I think the noqa comment must be involved somehow. At least we have an example to work with now.

Thank you very much again @tuttle for opening this and sharing the code for me to minimize!

---

_Comment by @harupy on 2025-12-31 16:31_

I had Claude Code investigate the cause

## Cause Analysis

Each FAST002 fix contains two edits:
1. An import edit at position ~0 (adds `from typing import Annotated`)
2. A parameter replacement edit at the parameter's position

The bug occurred in `apply_fixes` (`crates/ruff_linter/src/fix/mod.rs`):

1. Fixes were sorted by `min_start()` which returns the position of the first edit (the import edit at position 0)
2. Both fixes had the same `min_start()`, ~making their relative order non-deterministic~
3. If the fix for the **later** parameter (`e` at position ~190) was applied first:
   - Import edit applied, added to `applied` set
   - Parameter edit for `e` applied
   - `last_pos` set to end of `e` parameter (~213)
4. When the fix for the **earlier** parameter (`d` at position ~165) was processed:
   - Import edit filtered out (already in `applied` set)
   - First remaining edit is parameter edit for `d` at position ~165
   - Overlap check: `last_pos (213) >= first.start() (165)` â†’ **TRUE**
   - Fix for `d` incorrectly **skipped** due to apparent overlap

Result: Only `e` was converted, leaving `d` with its default value, creating the syntax error.

---

_Comment by @ntBre on 2025-12-31 16:54_

Interesting, thanks! That sounds plausible. 

Ahhh, I bet this `swap_remove` is the reason the `noqa` comment has an effect:

https://github.com/astral-sh/ruff/blob/25e480bbce6596a1d62e5243306a707aa426b5b5/crates/ruff_linter/src/linter.rs#L346-L350

All of our other sorts should be stable, so I don't think it's non-deterministic, and without this swap, the first fix we emit should stay sorted first.

So a very simple fix could be using `remove` here instead, but I think we should re-examine the FAST002 fixes. I don't think they should have such a delicate interdependence. We may just be able to apply an [`IsolationLevel`](https://github.com/astral-sh/ruff/blob/25e480bbce6596a1d62e5243306a707aa426b5b5/crates/ruff_diagnostics/src/fix.rs#L168)?

---

_Comment by @harupy on 2026-01-01 06:38_

@ntBre Thanks for digging further!

---

_Comment by @harupy on 2026-01-04 10:42_

Can we adjust `cmp_fix` to break ties with the last edit (the parameter fix for FAST0002) in a fix?

https://github.com/astral-sh/ruff/blob/8464aca795bc3580ca15fcb52b21616939cea9a9/crates/ruff_linter/src/fix/mod.rs#L128

---

_Comment by @MichaReiser on 2026-01-04 17:15_

> So a very simple fix could be using remove here instead, but I think we should re-examine the FAST002 fixes. I don't think they should have such a delicate interdependence. We may just be able to apply an [IsolationLevel](https://github.com/astral-sh/ruff/blob/25e480bbce6596a1d62e5243306a707aa426b5b5/crates/ruff_diagnostics/src/fix.rs#L168)?

Relying on the order in which diagnostics are emitted seems very fragile. I'd prefer a fix by using the isolation level or accounting for the overlap in `cmp_fix`

---
