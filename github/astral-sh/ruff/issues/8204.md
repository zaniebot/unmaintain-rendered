---
number: 8204
title: "Failed to format notebook: source contains syntax errors: ParseError"
type: issue
state: closed
author: Jonas1312
labels:
  - bug
  - formatter
assignees: []
created_at: 2023-10-25T07:13:55Z
updated_at: 2023-10-26T02:42:16Z
url: https://github.com/astral-sh/ruff/issues/8204
synced_at: 2026-01-07T12:31:12-06:00
---

# Failed to format notebook: source contains syntax errors: ParseError

---

_Issue opened by @Jonas1312 on 2023-10-25 07:13_

<!--
Thank you for taking the time to report an issue! We're glad to have you involved with Ruff.

If you're filing a bug report, please consider including the following information:

* A minimal code snippet that reproduces the bug.
* The command you invoked (e.g., `ruff /path/to/file.py --fix`), ideally including the `--isolated` flag.
* The current Ruff settings (any relevant sections from your `pyproject.toml`).
* The current Ruff version (`ruff --version`).
-->
Hi,

I tried the new ruff formatter on my notebooks through a pre-commit config:

```yaml
  - repo: https://github.com/astral-sh/ruff-pre-commit
    rev: v0.1.2
    hooks:
      - id: ruff
        types_or: [python, pyi, jupyter]
        args:
            - --fix-only 
            - --exit-non-zero-on-fix
      - id: ruff-format
        types_or: [python, pyi, jupyter]

```
But I get these errors:

```text
error: Failed to format recipes/basic_project_setup.ipynb: source contains syntax errors: ParseError { error: UnrecognizedToken(Percent, None), offset: 0, source_path: "<filename>" }
error: Failed to format recipes/counterfactual_data_augmentation.ipynb: source contains syntax errors: ParseError { error: UnrecognizedToken(Percent, None), offset: 18, source_path: "<filename>" }
error: Failed to format recipes/export_a_kili_project.ipynb: source contains syntax errors: ParseError { error: UnrecognizedToken(Percent, None), offset: 0, source_path: "<filename>" }
error: Failed to format recipes/finetuning_dinov2.ipynb: source contains syntax errors: ParseError { error: UnrecognizedToken(Percent, None), offset: 0, source_path: "<filename>" }
error: Failed to format recipes/finetuning_openai.ipynb: source contains syntax errors: ParseError { error: UnrecognizedToken(Percent, None), offset: 0, source_path: "<filename>" }
error: Failed to format recipes/finetuning_openai_summaries.ipynb: source contains syntax errors: ParseError { error: UnrecognizedToken(Exclamation, None), offset: 0, source_path: "<filename>" }
error: Failed to format recipes/frame_dicom_data.ipynb: source contains syntax errors: ParseError { error: UnrecognizedToken(Percent, None), offset: 0, source_path: "<filename>" }
error: Failed to format recipes/geojson.ipynb: source contains syntax errors: ParseError { error: UnrecognizedToken(Percent, None), offset: 0, source_path: "<filename>" }
error: Failed to format recipes/import_text_assets.ipynb: source contains syntax errors: ParseError { error: UnrecognizedToken(Percent, None), offset: 0, source_path: "<filename>" }
error: Failed to format recipes/importing_assets_and_metadata.ipynb: source contains syntax errors: ParseError { error: UnrecognizedToken(Percent, None), offset: 0, source_path: "<filename>" }
error: Failed to format recipes/importing_coco.ipynb: source contains syntax errors: ParseError { error: UnrecognizedToken(Percent, None), offset: 0, source_path: "<filename>" }
error: Failed to format recipes/importing_labels.ipynb: source contains syntax errors: ParseError { error: UnrecognizedToken(Percent, None), offset: 0, source_path: "<filename>" }
error: Failed to format recipes/importing_pdf_assets.ipynb: source contains syntax errors: ParseError { error: UnrecognizedToken(Percent, None), offset: 0, source_path: "<filename>" }
error: Failed to format recipes/importing_video_assets.ipynb: source contains syntax errors: ParseError { error: UnrecognizedToken(Percent, None), offset: 0, source_path: "<filename>" }
error: Failed to format recipes/inference_labels.ipynb: source contains syntax errors: ParseError { error: UnrecognizedToken(Percent, None), offset: 0, source_path: "<filename>" }
error: Failed to format recipes/label_parsing.ipynb: source contains syntax errors: ParseError { error: UnrecognizedToken(Percent, None), offset: 0, source_path: "<filename>" }
error: Failed to format recipes/medical_imaging.ipynb: source contains syntax errors: ParseError { error: UnrecognizedToken(Percent, None), offset: 0, source_path: "<filename>" }
error: Failed to format recipes/ner_pre_annotations_openai.ipynb: source contains syntax errors: ParseError { error: UnrecognizedToken(Percent, None), offset: 0, source_path: "<filename>" }
error: Failed to format recipes/ocr_pre_annotations.ipynb: source contains syntax errors: ParseError { error: UnrecognizedToken(Percent, None), offset: 0, source_path: "<filename>" }
error: Failed to format recipes/pixel_level_masks.ipynb: source contains syntax errors: ParseError { error: UnrecognizedToken(Percent, None), offset: 0, source_path: "<filename>" }
error: Failed to format recipes/plugins_development.ipynb: source contains syntax errors: ParseError { error: UnrecognizedToken(Percent, None), offset: 0, source_path: "<filename>" }
error: Failed to format recipes/plugins_example.ipynb: source contains syntax errors: ParseError { error: UnrecognizedToken(Percent, None), offset: 0, source_path: "<filename>" }
error: Failed to format recipes/plugins_example_document.ipynb: source contains syntax errors: ParseError { error: UnrecognizedToken(Percent, None), offset: 0, source_path: "<filename>" }
error: Failed to format recipes/set_up_workflows.ipynb: source contains syntax errors: ParseError { error: UnrecognizedToken(Percent, None), offset: 0, source_path: "<filename>" }
error: Failed to format recipes/tagtog_to_kili.ipynb: source contains syntax errors: ParseError { error: UnrecognizedToken(Percent, None), offset: 0, source_path: "<filename>" }
error: Failed to format recipes/webhooks_example.ipynb: source contains syntax errors: ParseError { error: UnrecognizedToken(Percent, None), offset: 0, source_path: "<filename>" }
```

Here is the pyproject.toml:

```toml

[tool.ruff]
select = ["ALL"]
src = ["src"]
line-length = 100
target-version = "py38"

[tool.ruff.pydocstyle]
convention = "google"

[tool.ruff.format]
line-ending = "lf"

[tool.ruff.isort]
known-first-party = ["src", "tests"]
```

And the notebooks: https://github.com/kili-technology/kili-python-sdk/tree/main/recipes

Thanks a lot!

---

_Comment by @MichaReiser on 2023-10-25 07:17_

Can you try adding the notebook extensions to `extend-include` ([doc](https://docs.astral.sh/ruff/configuration/#jupyter-notebook-discovery))

```toml
[tool.ruff]
extend-include = ["*.ipynb"]
```

---

_Label `question` added by @MichaReiser on 2023-10-25 07:18_

---

_Label `formatter` added by @MichaReiser on 2023-10-25 07:18_

---

_Comment by @Jonas1312 on 2023-10-25 07:19_

> Can you try adding the notebook extensions to `extend-include` ([doc](https://docs.astral.sh/ruff/configuration/#jupyter-notebook-discovery))
> 
> ```toml
> [tool.ruff]
> extend-include = ["*.ipynb"]
> ```

```text
ruff.....................................................................Passed
ruff-format..............................................................Failed
- hook id: ruff-format
- exit code: 2

warning: The following rules may cause conflicts when used with the formatter: 'COM819', 'D206', 'ISC001', 'Q000', 'Q001', 'Q002', 'Q003', 'W191'. To avoid unexpected behavior, we recommend disabling these rules, either by removing them from the `select` or `extend-select` configuration, or adding then to the `ignore` configuration.
warning: The following rules may cause conflicts when used with the formatter: 'COM819', 'D206', 'ISC001', 'Q000', 'Q001', 'Q002', 'Q003', 'W191'. To avoid unexpected behavior, we recommend disabling these rules, either by removing them from the `select` or `extend-select` configuration, or adding then to the `ignore` configuration.
error: Failed to format recipes/basic_project_setup.ipynb: source contains syntax errors: ParseError { error: UnrecognizedToken(Percent, None), offset: 0, source_path: "<filename>" }
error: Failed to format recipes/counterfactual_data_augmentation.ipynb: source contains syntax errors: ParseError { error: UnrecognizedToken(Percent, None), offset: 18, source_path: "<filename>" }
error: Failed to format recipes/export_a_kili_project.ipynb: source contains syntax errors: ParseError { error: UnrecognizedToken(Percent, None), offset: 0, source_path: "<filename>" }
error: Failed to format recipes/finetuning_dinov2.ipynb: source contains syntax errors: ParseError { error: UnrecognizedToken(Percent, None), offset: 0, source_path: "<filename>" }
error: Failed to format recipes/finetuning_openai.ipynb: source contains syntax errors: ParseError { error: UnrecognizedToken(Percent, None), offset: 0, source_path: "<filename>" }
error: Failed to format recipes/finetuning_openai_summaries.ipynb: source contains syntax errors: ParseError { error: UnrecognizedToken(Exclamation, None), offset: 0, source_path: "<filename>" }
error: Failed to format recipes/frame_dicom_data.ipynb: source contains syntax errors: ParseError { error: UnrecognizedToken(Percent, None), offset: 0, source_path: "<filename>" }
error: Failed to format recipes/geojson.ipynb: source contains syntax errors: ParseError { error: UnrecognizedToken(Percent, None), offset: 0, source_path: "<filename>" }
error: Failed to format recipes/import_text_assets.ipynb: source contains syntax errors: ParseError { error: UnrecognizedToken(Percent, None), offset: 0, source_path: "<filename>" }
error: Failed to format recipes/importing_assets_and_metadata.ipynb: source contains syntax errors: ParseError { error: UnrecognizedToken(Percent, None), offset: 0, source_path: "<filename>" }
error: Failed to format recipes/importing_coco.ipynb: source contains syntax errors: ParseError { error: UnrecognizedToken(Percent, None), offset: 0, source_path: "<filename>" }
error: Failed to format recipes/importing_labels.ipynb: source contains syntax errors: ParseError { error: UnrecognizedToken(Percent, None), offset: 0, source_path: "<filename>" }
error: Failed to format recipes/importing_pdf_assets.ipynb: source contains syntax errors: ParseError { error: UnrecognizedToken(Percent, None), offset: 0, source_path: "<filename>" }
error: Failed to format recipes/importing_video_assets.ipynb: source contains syntax errors: ParseError { error: UnrecognizedToken(Percent, None), offset: 0, source_path: "<filename>" }
error: Failed to format recipes/inference_labels.ipynb: source contains syntax errors: ParseError { error: UnrecognizedToken(Percent, None), offset: 0, source_path: "<filename>" }
error: Failed to format recipes/label_parsing.ipynb: source contains syntax errors: ParseError { error: UnrecognizedToken(Percent, None), offset: 0, source_path: "<filename>" }
error: Failed to format recipes/medical_imaging.ipynb: source contains syntax errors: ParseError { error: UnrecognizedToken(Percent, None), offset: 0, source_path: "<filename>" }
error: Failed to format recipes/ner_pre_annotations_openai.ipynb: source contains syntax errors: ParseError { error: UnrecognizedToken(Percent, None), offset: 0, source_path: "<filename>" }
error: Failed to format recipes/ocr_pre_annotations.ipynb: source contains syntax errors: ParseError { error: UnrecognizedToken(Percent, None), offset: 0, source_path: "<filename>" }
error: Failed to format recipes/pixel_level_masks.ipynb: source contains syntax errors: ParseError { error: UnrecognizedToken(Percent, None), offset: 0, source_path: "<filename>" }
error: Failed to format recipes/plugins_development.ipynb: source contains syntax errors: ParseError { error: UnrecognizedToken(Percent, None), offset: 0, source_path: "<filename>" }
error: Failed to format recipes/plugins_example.ipynb: source contains syntax errors: ParseError { error: UnrecognizedToken(Percent, None), offset: 0, source_path: "<filename>" }
error: Failed to format recipes/plugins_example_document.ipynb: source contains syntax errors: ParseError { error: UnrecognizedToken(Percent, None), offset: 0, source_path: "<filename>" }
error: Failed to format recipes/set_up_workflows.ipynb: source contains syntax errors: ParseError { error: UnrecognizedToken(Percent, None), offset: 0, source_path: "<filename>" }
error: Failed to format recipes/tagtog_to_kili.ipynb: source contains syntax errors: ParseError { error: UnrecognizedToken(Percent, None), offset: 0, source_path: "<filename>" }
error: Failed to format recipes/webhooks_example.ipynb: source contains syntax errors: ParseError { error: UnrecognizedToken(Percent, None), offset: 0, source_path: "<filename>" }
401 files left unchanged
```

---

_Comment by @MichaReiser on 2023-10-25 07:58_

Interesting. @dhruvmanila any ideas? Could it be that we don't correctly set the parsing mode?

---

_Comment by @dhruvmanila on 2023-10-25 08:42_

Yeah, that's correct. Let me send in a patch quickly.

---

_Assigned to @dhruvmanila by @dhruvmanila on 2023-10-25 08:42_

---

_Label `question` removed by @MichaReiser on 2023-10-25 08:48_

---

_Label `bug` added by @MichaReiser on 2023-10-25 08:48_

---

_Label `question` added by @MichaReiser on 2023-10-25 08:48_

---

_Added to milestone `Formatter: Stable` by @MichaReiser on 2023-10-25 08:48_

---

_Referenced in [astral-sh/ruff#8205](../../astral-sh/ruff/pulls/8205.md) on 2023-10-25 08:55_

---

_Label `question` removed by @dhruvmanila on 2023-10-25 09:00_

---

_Referenced in [astral-sh/ruff#8207](../../astral-sh/ruff/pulls/8207.md) on 2023-10-25 13:49_

---

_Closed by @dhruvmanila on 2023-10-25 14:01_

---

_Comment by @dhruvmanila on 2023-10-25 14:08_

Thanks for opening this issue! It's fixed and will be available in the next release.

---

_Comment by @harupy on 2023-10-26 01:57_

@dhruvmanila Thanks for fixing this! I'm curious when the the next release will be available.

---

_Comment by @charliermarsh on 2023-10-26 02:42_

I can probably cut a release tomorrow.

---

_Referenced in [astral-sh/ruff#8254](../../astral-sh/ruff/issues/8254.md) on 2023-10-26 16:07_

---
