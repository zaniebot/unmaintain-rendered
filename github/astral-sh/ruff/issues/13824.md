---
number: 13824
title: "F821 (Undefined name) and F722 (bad forward annotation) can trigger on `@no_type_check`-ed annotations"
type: issue
state: closed
author: Wuestengecko
labels:
  - rule
  - help wanted
assignees: []
created_at: 2024-10-19T17:37:57Z
updated_at: 2025-01-03T09:05:46Z
url: https://github.com/astral-sh/ruff/issues/13824
synced_at: 2026-01-07T12:31:13-06:00
---

# F821 (Undefined name) and F722 (bad forward annotation) can trigger on `@no_type_check`-ed annotations

---

_Issue opened by @Wuestengecko on 2024-10-19 17:37_

<!--
Thank you for taking the time to report an issue! We're glad to have you involved with Ruff.

If you're filing a bug report, please consider including the following information:

* List of keywords you searched for before creating this issue. Write them down here so that others can find this issue more easily and help provide feedback.
  e.g. "RUF001", "unused variable", "Jupyter notebook"
* A minimal code snippet that reproduces the bug.
* The command you invoked (e.g., `ruff /path/to/file.py --fix`), ideally including the `--isolated` flag.
* The current Ruff settings (any relevant sections from your `pyproject.toml`).
* The current Ruff version (`ruff --version`).
-->

Hi! I found that F821 ("Undefined name") and F722 ("Syntax error in forward annotation") can erroneously trigger on functions that marked `@no_type_check`, if they happen to either use names that aren't in scope, or aren't even valid Python.

Consider the following example file:

```python
from typing import no_type_check

@no_type_check
def f821(arg: "A") -> "R":
    pass

@no_type_check
def f722(arg: "this isn't python") -> "this isn't python either":
    pass
```

Save it as "demo.py" and run ruff with:

    ruff check --isolated --select=F722,F821 demo.py --output-format concise

This will emit the following errors, which are all false-positives:

```
demo.py:4:16: F821 Undefined name `A`
demo.py:4:24: F821 Undefined name `R`
demo.py:8:15: F722 Syntax error in forward annotation: `this isn't python`
demo.py:8:39: F722 Syntax error in forward annotation: `this isn't python either`
Found 4 errors.
```

I'm presuming (but haven't tested) that this could apply to other rules that inspect annotations as well. Ruff should treat these annotations as opaque strings without any meaning. As per [PEP-484](https://peps.python.org/pep-0484/#the-meaning-of-annotations):

>  Functions with the `@no_type_check` decorator should be treated as having no annotations.

---

**ruff --version**: 0.7.0
**settings**: no config file exists

---

_Label `rule` added by @MichaReiser on 2024-10-19 19:06_

---

_Comment by @MichaReiser on 2024-10-19 19:06_

Thanks for reporting. Suppressing some rules annotated with `@no_type_check` makes sense to me. 

---

_Comment by @AlexWaygood on 2024-10-19 22:43_

This seems reasonable to me too

---

_Label `help wanted` added by @AlexWaygood on 2024-10-19 22:43_

---

_Comment by @charliermarsh on 2024-11-09 19:36_

Should we just skip visiting them altogether when in a `@no_type_check` context? 

---

_Comment by @AlexWaygood on 2024-11-11 13:12_

> Should we just skip visiting them altogether when in a `@no_type_check` context?

That might make sense, yeah

---

_Comment by @MichaReiser on 2024-11-11 13:48_

> Should we just skip visiting them altogether when in a @no_type_check context?

Are you suggesting skipping such functions only for `F821` and `F722` or all rules?

---

_Comment by @charliermarsh on 2024-11-11 13:49_

I'm suggesting skipping looking at those nodes entirely, for all rules.

---

_Comment by @charliermarsh on 2024-11-11 13:53_

Alternatively, we could visit them as strings (so enforce rules like implicit concat -- weird but possible) but skip parsing them and visiting the _content_.

---

_Comment by @MichaReiser on 2024-11-11 13:58_

To clarify, with all nodes you mean skipping the entire function or only the type annotations? I'm somewhat fine skipping the annotations but would find it a stretch if we skip the entire function

---

_Comment by @charliermarsh on 2024-11-11 14:02_

Just the annotations. The rest of the function would be unchanged.

---

_Referenced in [astral-sh/ruff#14615](../../astral-sh/ruff/pulls/14615.md) on 2024-11-26 17:45_

---

_Comment by @InSyncWithFoo on 2024-11-27 09:31_

This seems to have been resolved by #14615.

---

_Closed by @MichaReiser on 2024-11-27 10:05_

---

_Reopened by @MichaReiser on 2024-12-02 12:20_

---

_Comment by @MichaReiser on 2024-12-02 12:20_

We'll probably [revert this change](https://github.com/astral-sh/ruff/pull/14726). It's a bit more involved, see https://github.com/astral-sh/ruff/issues/14698

---

_Referenced in [astral-sh/ruff#15215](../../astral-sh/ruff/pulls/15215.md) on 2025-01-02 00:12_

---

_Closed by @MichaReiser on 2025-01-03 09:05_

---
