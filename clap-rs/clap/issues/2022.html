<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Obscure panic with heading and default value - clap-rs/clap #2022</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Obscure panic with heading and default value</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/clap-rs/clap/issues/2022">#2022</a>
        opened by <a href="https://github.com/CertainLach">@CertainLach</a>
        on 2020-07-18 14:40
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/CertainLach">@CertainLach</a> on 2020-07-18 14:40</div>
            <div class="timeline-body"><h3>Make sure you completed the following tasks</h3>
<ul>
<li>[x] Searched the <a href="https://github.com/clap-rs/clap/discussions">discussions</a></li>
<li>[x] Searched the closes issues</li>
</ul>
<h3>Code</h3>
<pre><code class="language-rust">use clap::Clap;

fn main() {
	#[derive(Clap)]
	#[clap(help_heading = &quot;HEAD&quot;)]
	struct Opt2 {
		#[clap(long, name = &quot;size&quot;)]
		pub b: Option&lt;usize&gt;,
	}
	#[derive(Clap)]
	struct Opt {
		#[clap(flatten)]
		opt2: Opt2,

		#[clap(long, default_value = &quot;32&quot;)]
		a: i32,
	}
	Opt::parse_from(&amp;[&quot;test&quot;]);
}
</code></pre>
<h3>Steps to reproduce the issue</h3>
<ol>
<li>Run <code>cargo run</code></li>
</ol>
<h3>Version</h3>
<ul>
<li><strong>Rust</strong>: rustc 1.46.0-nightly (346aec9b0 2020-07-11)</li>
<li><strong>Clap</strong>: master at 48d308a8ab9e96d4b21336e428feee420dbac51d</li>
</ul>
<h3>Actual Behavior Summary</h3>
<p>Code is panicking with</p>
<pre><code>thread 'auto_default_value' panicked at 'called `Option::unwrap()` on a `None` value', clap_derive/tests/default_arg_value.rs:18:12
...
  13: core::panicking::panic
             at src/libcore/panicking.rs:50
  14: core::option::Option&lt;T&gt;::unwrap
             at /home/lach/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/src/libcore/macros/mod.rs:10
  15: &lt;default_arg_value::auto_default_value::Opt as clap::derive::FromArgMatches&gt;::from_arg_matches
             at clap_derive/tests/default_arg_value.rs:18
  16: clap::derive::Clap::parse_from
             at /home/lach/jsonnet-rs/clap/src/derive.rs:29
  17: default_arg_value::auto_default_value
             at clap_derive/tests/default_arg_value.rs:20
  18: default_arg_value::auto_default_value::{{closure}}
             at clap_derive/tests/default_arg_value.rs:5
  19: core::ops::function::FnOnce::call_once
             at /home/lach/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/src/libcore/ops/function.rs:233
  20: &lt;alloc::boxed::Box&lt;F&gt; as core::ops::function::FnOnce&lt;A&gt;&gt;::call_once
             at /rustc/346aec9b02f3c74f3fce97fd6bda24709d220e49/src/liballoc/boxed.rs:1081
  21: &lt;std::panic::AssertUnwindSafe&lt;F&gt; as core::ops::function::FnOnce&lt;()&gt;&gt;::call_once
             at /rustc/346aec9b02f3c74f3fce97fd6bda24709d220e49/src/libstd/panic.rs:318
  22: std::panicking::try::do_call
             at /rustc/346aec9b02f3c74f3fce97fd6bda24709d220e49/src/libstd/panicking.rs:348
  23: std::panicking::try
             at /rustc/346aec9b02f3c74f3fce97fd6bda24709d220e49/src/libstd/panicking.rs:325
  24: std::panic::catch_unwind
             at /rustc/346aec9b02f3c74f3fce97fd6bda24709d220e49/src/libstd/panic.rs:394
  25: test::run_test_in_process
             at src/libtest/lib.rs:541
  26: test::run_test::run_test_inner::{{closure}}
             at src/libtest/lib.rs:450
</code></pre>
<p><strong>If a project of yours is blocked due to this bug, please, mention it explicitly.</strong></p>
<p>Found this while extracting argument parsing from main crate in https://github.com/CertainLach/jsonnet-rs</p>
<h3>Expected Behavior Summary</h3>
<p>It shouldn't panic, and successfully parse input</p>
<h3>Additional context</h3>
<p><code>default_arg_value.rs:18:12</code> points at <code>a: i32</code> line</p>
<p>With no <code>default_value</code> on <code>a: i32</code>, or  without <code>help_heading</code> on <code>Opt2</code> struct it works as expected</p>
<h3>Debug output</h3>
<p>Compile clap with <code>debug</code> feature:</p>
<pre><code class="language-toml">[dependencies]
clap = { version = &quot;*&quot;, features = [&quot;debug&quot;] }
</code></pre>
<p>The output may be very long, so feel free to link to a gist or attach a text file</p>
<details>
<summary> Debug Output </summary>
<pre>
<code>
[            clap::build::app]  App::_do_parse
[            clap::build::app]  App::_build
[            clap::build::app]  App::_derive_display_order:clap_derive
[            clap::build::app]  App::_create_help_and_version
[            clap::build::app]  App::_create_help_and_version: Building --help
[            clap::build::app]  App::_create_help_and_version: Building --version
[            clap::build::app]  App::_debug_asserts
[            clap::build::arg]  Arg::_debug_asserts:size
[            clap::build::arg]  Arg::_debug_asserts:a
[            clap::build::arg]  Arg::_debug_asserts:help
[            clap::build::arg]  Arg::_debug_asserts:version
[         clap::parse::parser]  Parser::get_matches_with
[         clap::parse::parser]  Parser::_build
[         clap::parse::parser]  Parser::_verify_positionals
[         clap::parse::parser]  Parser::remove_overrides
[      clap::parse::validator]  Validator::validate
[         clap::parse::parser]  Parser::add_defaults
[      clap::parse::validator]  Validator::validate_conflicts
[      clap::parse::validator]  Validator::validate_exclusive
[      clap::parse::validator]  Validator::gather_conflicts
[      clap::parse::validator]  Validator::validate_required: required=ChildGraph([])
[      clap::parse::validator]  Validator::gather_requirements
[      clap::parse::validator]  Validator::validate_required_unless
[      clap::parse::validator]  Validator::validate_matched_args
[    clap::parse::arg_matcher]  ArgMatcher::get_global_values: global_arg_vec=[]
</code>
</pre>
</details>

</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">T: bug</span> added by @CertainLach on 2020-07-18 14:40</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone "3.0" by @pksunkara on 2020-07-19 10:50</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/pksunkara">@pksunkara</a> on 2020-08-28 04:09</div>
            <div class="timeline-body"><p>Equivalent code is:</p>
<pre><code class="language-rust">fn main() {
    let result = App::new(&quot;opt&quot;)
        .help_heading(&quot;HEAD&quot;)
        .arg(Arg::new(&quot;size&quot;).long(&quot;b&quot;))
        .arg(Arg::new(&quot;a&quot;).long(&quot;a&quot;).default_value(&quot;32&quot;))
        .get_matches();

    eprintln!(&quot;{:#?}&quot;, result);
}
</code></pre>
<p>That is not failing though. Looks like a bug in derive specifically.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">C: derive macros</span> added by @pksunkara on 2020-08-28 04:10</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">:money_with_wings: $5</span> added by @pksunkara on 2020-10-09 16:38</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/CertainLach">@CertainLach</a> on 2020-10-09 17:34</div>
            <div class="timeline-body"><p>It isn't derive failure, cargo expand shows this as only difference</p>
<pre><code class="language-diff">--- broken      2020-10-09 22:31:31.044705144 +0500
+++ working     2020-10-09 22:32:18.833176354 +0500
@@ -680,7 +680,6 @@
     testfn: test::StaticTestFn(|| test::assert_test_result(issue_2022())),
 };
 fn issue_2022() {
-    #[clap(help_heading = &quot;HEAD&quot;)]
     struct Opt2 {
         #[clap(long, name = &quot;size&quot;)]
         pub b: Option&lt;usize&gt;,
@@ -704,7 +703,7 @@
         }
         fn augment_clap&lt;'b&gt;(app: ::clap::App&lt;'b&gt;) -&gt; ::clap::App&lt;'b&gt; {
             {
-                let app = app.help_heading(&quot;HEAD&quot;);
+                let app = app;
                 let app = app.arg(
                     ::clap::Arg::new(&quot;size&quot;)
                         .takes_value(true)
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/pksunkara">@pksunkara</a> on 2020-10-09 17:37</div>
            <div class="timeline-body"><p>@CertainLach What do you mean? Does the example you gave in the first post doesn't fail anymore? Or do you mean that the line <code>#[clap(help_heading = &quot;HEAD&quot;)]</code> is the one causing failure because the code passes if we remove the line?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/CertainLach">@CertainLach</a> on 2020-10-09 17:40</div>
            <div class="timeline-body"><p>Code still panics in expanded form:</p>
<pre><code class="language-rust">#[test]
fn issue_2022() {
    struct Opt2 {
        pub b: Option&lt;usize&gt;,
    }
    impl ::clap::Clap for Opt2 {}
    #[allow(dead_code, unreachable_code, unused_variables)]
    #[allow(
        clippy::style,
        clippy::complexity,
        clippy::pedantic,
        clippy::restriction,
        clippy::perf,
        clippy::deprecated,
        clippy::nursery,
        clippy::cargo
    )]
    #[deny(clippy::correctness)]
    impl ::clap::IntoApp for Opt2 {
        fn into_app&lt;'b&gt;() -&gt; ::clap::App&lt;'b&gt; {
            Self::augment_clap(::clap::App::new(&quot;clap_derive&quot;))
        }
        fn augment_clap&lt;'b&gt;(app: ::clap::App&lt;'b&gt;) -&gt; ::clap::App&lt;'b&gt; {
            {
                let app = app.help_heading(&quot;HEAD&quot;);
                let app = app.arg(
                    ::clap::Arg::new(&quot;size&quot;)
                        .takes_value(true)
                        .validator(|s| {
                            ::std::str::FromStr::from_str(s)
                                .map(|_: usize| ())
                                .map_err(|e| e.to_string())
                        })
                        .long(&quot;b&quot;),
                );
                app
            }
        }
    }
    #[allow(dead_code, unreachable_code, unused_variables)]
    #[allow(
        clippy::style,
        clippy::complexity,
        clippy::pedantic,
        clippy::restriction,
        clippy::perf,
        clippy::deprecated,
        clippy::nursery,
        clippy::cargo
    )]
    #[deny(clippy::correctness)]
    impl ::clap::FromArgMatches for Opt2 {
        fn from_arg_matches(matches: &amp;::clap::ArgMatches) -&gt; Self {
            Opt2 {
                b: matches
                    .value_of(&quot;size&quot;)
                    .map(|s| ::std::str::FromStr::from_str(s).unwrap()),
            }
        }
    }
    struct Opt {
        opt2: Opt2,
        a: i32,
    }
    impl ::clap::Clap for Opt {}
    #[allow(dead_code, unreachable_code, unused_variables)]
    #[allow(
        clippy::style,
        clippy::complexity,
        clippy::pedantic,
        clippy::restriction,
        clippy::perf,
        clippy::deprecated,
        clippy::nursery,
        clippy::cargo
    )]
    #[deny(clippy::correctness)]
    impl ::clap::IntoApp for Opt {
        fn into_app&lt;'b&gt;() -&gt; ::clap::App&lt;'b&gt; {
            Self::augment_clap(::clap::App::new(&quot;clap_derive&quot;))
        }
        fn augment_clap&lt;'b&gt;(app: ::clap::App&lt;'b&gt;) -&gt; ::clap::App&lt;'b&gt; {
            {
                let app = app;
                let app = &lt;Opt2 as ::clap::IntoApp&gt;::augment_clap(app);
                let app = app.arg(
                    ::clap::Arg::new(&quot;a&quot;)
                        .takes_value(true)
                        .required(false)
                        .validator(|s| {
                            ::std::str::FromStr::from_str(s)
                                .map(|_: i32| ())
                                .map_err(|e| e.to_string())
                        })
                        .long(&quot;a&quot;)
                        .default_value(&quot;32&quot;),
                );
                app
            }
        }
    }
    #[allow(dead_code, unreachable_code, unused_variables)]
    #[allow(
        clippy::style,
        clippy::complexity,
        clippy::pedantic,
        clippy::restriction,
        clippy::perf,
        clippy::deprecated,
        clippy::nursery,
        clippy::cargo
    )]
    #[deny(clippy::correctness)]
    impl ::clap::FromArgMatches for Opt {
        fn from_arg_matches(matches: &amp;::clap::ArgMatches) -&gt; Self {
            Opt {
                opt2: ::clap::FromArgMatches::from_arg_matches(matches),
                a: matches
                    .value_of(&quot;a&quot;)
                    .map(|s| ::std::str::FromStr::from_str(s).unwrap())
                    .unwrap(),
            }
        }
    }
    Opt::parse_from(&amp;[&quot;test&quot;]);
}
</code></pre>
<p>And works fine if i remove <code>.help_heading(&quot;HEAD&quot;)</code> call in them</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/pksunkara">@pksunkara</a> on 2020-10-09 17:43</div>
            <div class="timeline-body"><p>Yeah, it means we have a bug in derive because the code shouldn't be expanded like that so that it panics.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/CertainLach">@CertainLach</a> on 2020-10-09 17:58</div>
            <div class="timeline-body"><p>Well, i was able to reduce this to</p>
<pre><code class="language-rust">// Panics
#[test]
fn issue_2022_heading() {
    let app = App::new(&quot;test&quot;).help_heading(&quot;HEAD&quot;).arg(
        Arg::new(&quot;a&quot;)
            .takes_value(true)
            .required(false)
            .validator(|s| {
                FromStr::from_str(s)
                    .map(|_: i32| ())
                    .map_err(|e| e.to_string())
            })
            .long(&quot;a&quot;)
            .default_value(&quot;32&quot;),
    );
    let matches = app.get_matches_from(&amp;[&quot;test&quot;]);
    let _: i32 = matches
        .value_of(&quot;a&quot;)
        .map(|s| FromStr::from_str(s).unwrap())
        .unwrap();
}

// Works as intended
#[test]
fn issue_2022() {
    let app = App::new(&quot;test&quot;).arg(
        Arg::new(&quot;a&quot;)
            .takes_value(true)
            .required(false)
            .validator(|s| {
                FromStr::from_str(s)
                    .map(|_: i32| ())
                    .map_err(|e| e.to_string())
            })
            .long(&quot;a&quot;)
            .default_value(&quot;32&quot;),
    );
    let matches = app.get_matches_from(&amp;[&quot;test&quot;]);
    let _: i32 = matches
        .value_of(&quot;a&quot;)
        .map(|s| FromStr::from_str(s).unwrap())
        .unwrap();
}
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/pksunkara">@pksunkara</a> on 2020-10-09 18:00</div>
            <div class="timeline-body"><p>Can you try to remove stuff from the first test to get a more minimal example?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/2161.html">clap-rs/clap#2161</a> on 2020-10-09 18:25</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @bors[bot] on 2020-10-11 09:27</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/2179.html">clap-rs/clap#2179</a> on 2020-10-19 15:56</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../CertainLach/jrsonnet/pulls/18.html">CertainLach/jrsonnet#18</a> on 2020-10-19 16:23</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 01:34:18 UTC
    </footer>
</body>
</html>
