```yaml
number: 6160
title: Order of global arg usage changes behaviour with conflicts_with on Command arg
type: issue
state: open
author: merc1031
labels:
  - C-bug
  - A-parsing
  - A-validators
  - S-triage
assignees: []
created_at: 2025-10-24T01:45:07Z
updated_at: 2025-10-24T15:11:09Z
url: https://github.com/clap-rs/clap/issues/6160
synced_at: 2026-01-10T01:57:49Z
```

# Order of global arg usage changes behaviour with conflicts_with on Command arg

---

_Issue opened by @merc1031 on 2025-10-24 01:45_

### Please complete the following tasks

- [x] I have searched the [discussions](https://github.com/clap-rs/clap/discussions)
- [x] I have searched the [open](https://github.com/clap-rs/clap/issues) and [rejected](https://github.com/clap-rs/clap/issues?q=is%3Aissue+label%3AS-wont-fix+is%3Aclosed) issues

### Rust Version

rustc 1.88.0 (6b00bc388 2025-06-23)

### Clap Version

4.5.47

### Minimal reproducible code

Also tested on rustplayground 1.90.0 https://play.rust-lang.org/?version=stable&mode=debug&edition=2024&gist=72c2c207bad9a0430a2c8b4ba331c4a8

```rust
use std::path::PathBuf;
use clap::{Parser};

#[derive(Parser, Debug)]
pub struct Args {
    #[clap(conflicts_with = "root")]
    pub path: Option<PathBuf>,
}

#[derive(Parser, Debug)]
enum Commands {
    Do(Args)
}

#[derive(Parser, Debug)]
pub struct Cli {
    #[command(subcommand)]
    pub command: Commands,
    #[arg(long, global = true)]
    pub root: Option<PathBuf>,
}


fn main() {
    let res  = Cli::try_parse_from(["app", "--root", ".",  "do", "."]);
    println!("{res:?}");
    let res  = Cli::try_parse_from(["app", "do", "--root", ".", "."]);
    println!("{res:?}");

}

```


### Steps to reproduce the bug with the above code

Just run the playground https://play.rust-lang.org/?version=stable&mode=debug&edition=2024&gist=72c2c207bad9a0430a2c8b4ba331c4a8

### Actual Behaviour

`--root . do .` Does not obey the conflicts_with
`do --root . .` Does  obey the conflicts_with

```
Ok(Cli { command: Do(Args { path: Some(".") }), root: Some(".") })
Err(ErrorInner { kind: ArgumentConflict, context: FlatMap { keys: [InvalidArg, PriorArg, Usage], values: [String("--root <ROOT>"), String("[PATH]"), StyledStr(StyledStr("\u{1b}[1m\u{1b}[4mUsage:\u{1b}[0m \u{1b}[1mapp do\u{1b}[0m \u{1b}[1m--root\u{1b}[0m <ROOT> [PATH]"))] }, message: None, source: None, help_flag: Some("--help"), styles: Styles { header: Style { fg: None, bg: None, underline: None, effects: Effects(BOLD | UNDERLINE) }, error: Style { fg: Some(Ansi(Red)), bg: None, underline: None, effects: Effects(BOLD) }, usage: Style { fg: None, bg: None, underline: None, effects: Effects(BOLD | UNDERLINE) }, literal: Style { fg: None, bg: None, underline: None, effects: Effects(BOLD) }, placeholder: Style { fg: None, bg: None, underline: None, effects: Effects() }, valid: Style { fg: Some(Ansi(Green)), bg: None, underline: None, effects: Effects() }, invalid: Style { fg: Some(Ansi(Yellow)), bg: None, underline: None, effects: Effects() }, context: Style { fg: None, bg: None, underline: None, effects: Effects() }, context_value: None }, color_when: Auto, color_help_when: Auto, backtrace: None })
```

### Expected Behaviour

`--root . do .` Does  obey the conflicts_with
`do --root . .` Does  obey the conflicts_with

```
Err(ErrorInner { kind: ArgumentConflict, context: FlatMap { keys: [InvalidArg, PriorArg, Usage], values: [String("--root <ROOT>"), String("[PATH]"), StyledStr(StyledStr("\u{1b}[1m\u{1b}[4mUsage:\u{1b}[0m \u{1b}[1mapp do\u{1b}[0m \u{1b}[1m--root\u{1b}[0m <ROOT> [PATH]"))] }, message: None, source: None, help_flag: Some("--help"), styles: Styles { header: Style { fg: None, bg: None, underline: None, effects: Effects(BOLD | UNDERLINE) }, error: Style { fg: Some(Ansi(Red)), bg: None, underline: None, effects: Effects(BOLD) }, usage: Style { fg: None, bg: None, underline: None, effects: Effects(BOLD | UNDERLINE) }, literal: Style { fg: None, bg: None, underline: None, effects: Effects(BOLD) }, placeholder: Style { fg: None, bg: None, underline: None, effects: Effects() }, valid: Style { fg: Some(Ansi(Green)), bg: None, underline: None, effects: Effects() }, invalid: Style { fg: Some(Ansi(Yellow)), bg: None, underline: None, effects: Effects() }, context: Style { fg: None, bg: None, underline: None, effects: Effects() }, context_value: None }, color_when: Auto, color_help_when: Auto, backtrace: None })
Err(ErrorInner { kind: ArgumentConflict, context: FlatMap { keys: [InvalidArg, PriorArg, Usage], values: [String("--root <ROOT>"), String("[PATH]"), StyledStr(StyledStr("\u{1b}[1m\u{1b}[4mUsage:\u{1b}[0m \u{1b}[1mapp do\u{1b}[0m \u{1b}[1m--root\u{1b}[0m <ROOT> [PATH]"))] }, message: None, source: None, help_flag: Some("--help"), styles: Styles { header: Style { fg: None, bg: None, underline: None, effects: Effects(BOLD | UNDERLINE) }, error: Style { fg: Some(Ansi(Red)), bg: None, underline: None, effects: Effects(BOLD) }, usage: Style { fg: None, bg: None, underline: None, effects: Effects(BOLD | UNDERLINE) }, literal: Style { fg: None, bg: None, underline: None, effects: Effects(BOLD) }, placeholder: Style { fg: None, bg: None, underline: None, effects: Effects() }, valid: Style { fg: Some(Ansi(Green)), bg: None, underline: None, effects: Effects() }, invalid: Style { fg: Some(Ansi(Yellow)), bg: None, underline: None, effects: Effects() }, context: Style { fg: None, bg: None, underline: None, effects: Effects() }, context_value: None }, color_when: Auto, color_help_when: Auto, backtrace: None })
```

### Additional Context

_No response_

### Debug Output

_No response_

---

_Label `C-bug` added by @merc1031 on 2025-10-24 01:45_

---

_Label `S-triage` added by @merc1031 on 2025-10-24 01:45_

---

_Label `A-validators` added by @epage on 2025-10-24 15:09_

---

_Label `A-parsing` added by @epage on 2025-10-24 15:10_

---

_Referenced in [clap-rs/clap#5977](../../clap-rs/clap/issues/5977.md) on 2025-10-24 15:10_

---

_Comment by @epage on 2025-10-24 15:11_

In general, validation with global is a bit off, see #1546, particularly https://github.com/clap-rs/clap/issues/1546#issuecomment-1198809765

I'll keep this open to make sure we test and fix this case along with the others

---
