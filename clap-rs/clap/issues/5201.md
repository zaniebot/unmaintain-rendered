```yaml
number: 5201
title: "panic when using tracing::Level and PathBuf with value of \"-\""
type: issue
state: closed
author: AndreasBackx
labels:
  - C-bug
assignees: []
created_at: 2023-11-08T00:13:22Z
updated_at: 2023-11-08T00:43:09Z
url: https://github.com/clap-rs/clap/issues/5201
synced_at: 2026-01-10T01:57:49Z
```

# panic when using tracing::Level and PathBuf with value of "-"

---

_Issue opened by @AndreasBackx on 2023-11-08 00:13_

### Please complete the following tasks

- [X] I have searched the [discussions](https://github.com/clap-rs/clap/discussions)
- [X] I have searched the [open](https://github.com/clap-rs/clap/issues) and [rejected](https://github.com/clap-rs/clap/issues?q=is%3Aissue+label%3AS-wont-fix+is%3Aclosed) issues

### Rust Version

rustc 1.73.0 (cc66ad468 2023-10-03)

### Clap Version

4.4.7

### Minimal reproducible code

```rust
use std::path::PathBuf;

use clap::arg;

use clap::Parser;

#[derive(Parser)]
#[command(version, about)]
pub struct Cli {
    /// Log level to be used for printing to stderr
    #[arg(long, default_value = "info", value_parser = ["trace", "debug", "info", "warn", "error"])]
    pub log_level: tracing::Level,

    /// Where to save the screenshot
    #[arg(value_name = "OUTPUT")]
    pub file: PathBuf,
}

fn main() {
    let cli = Cli::parse();

    tracing_subscriber::fmt()
        .with_max_level(cli.log_level)
        .with_writer(std::io::stderr)
        .init();
}
```

```toml
[package]
name = "clap-bug"
version = "0.1.0"
edition = "2021"

[dependencies]
clap = { version = "4.4.7", features = ["derive"]}

tracing = "0.1.37"
tracing-subscriber = "0.3.17"
```


### Steps to reproduce the bug with the above code

```
cargo run -- -
```

### Actual Behaviour

```
➜ cargo run -- -                    
    Finished dev [unoptimized + debuginfo] target(s) in 0.01s
     Running `target/debug/clap-bug -`
thread 'main' panicked at src/main.rs:12:20:
Mismatch between definition and access of `log_level`. Could not downcast to tracing_core::metadata::Level, need to downcast to alloc::string::String

note: run with `RUST_BACKTRACE=1` environment variable to display a backtrace
```

### Expected Behaviour

I was experimenting with the default behaviour and was going to implement stdout "-" support, but was facing a panic which should be regardless of it being correct or not, undesired.

### Additional Context

_No response_

### Debug Output

```
➜ RUST_BACKTRACE=full cargo run -- -
    Finished dev [unoptimized + debuginfo] target(s) in 0.01s
     Running `target/debug/clap-bug -`
[clap_builder::builder::command]Command::_do_parse
[clap_builder::builder::command]Command::_build: name="clap-bug"
[clap_builder::builder::command]Command::_propagate:clap-bug
[clap_builder::builder::command]Command::_check_help_and_version:clap-bug expand_help_tree=false
[clap_builder::builder::command]Command::long_help_exists
[clap_builder::builder::command]Command::_check_help_and_version: Building default --help
[clap_builder::builder::command]Command::_check_help_and_version: Building default --version
[clap_builder::builder::command]Command::_propagate_global_args:clap-bug
[clap_builder::builder::debug_asserts]Command::_debug_asserts
[clap_builder::builder::debug_asserts]Arg::_debug_asserts:log_level
[clap_builder::builder::debug_asserts]Arg::_debug_asserts:file
[clap_builder::builder::debug_asserts]Arg::_debug_asserts:help
[clap_builder::builder::debug_asserts]Arg::_debug_asserts:version
[clap_builder::builder::debug_asserts]Command::_verify_positionals
[clap_builder::parser::parser]Parser::get_matches_with
[clap_builder::parser::parser]Parser::get_matches_with: Begin parsing '"-"'
[clap_builder::parser::parser]Parser::possible_subcommand: arg=Ok("-")
[clap_builder::parser::parser]Parser::get_matches_with: sc=None
[clap_builder::parser::parser]Parser::get_matches_with: Positional counter...1
[clap_builder::parser::parser]Parser::get_matches_with: Low index multiples...false
[clap_builder::parser::parser]Parser::resolve_pending: id="file"
[clap_builder::parser::parser]Parser::react action=Set, identifier=Some(Index), source=CommandLine
[clap_builder::parser::parser]Parser::remove_overrides: id="file"
[clap_builder::parser::arg_matcher]ArgMatcher::start_custom_arg: id="file", source=CommandLine
[clap_builder::builder::command]Command::groups_for_arg: id="file"
[clap_builder::parser::arg_matcher]ArgMatcher::start_custom_arg: id="Cli", source=CommandLine
[clap_builder::parser::parser]Parser::push_arg_values: ["-"]
[clap_builder::parser::parser]Parser::add_single_val_to_arg: cur_idx:=1
[clap_builder::parser::arg_matcher]ArgMatcher::needs_more_vals: o=file, pending=0
[clap_builder::parser::arg_matcher]ArgMatcher::needs_more_vals: expected=1, actual=0
[clap_builder::parser::parser]Parser::react not enough values passed in, leaving it to the validator to complain
[clap_builder::parser::parser]Parser::add_defaults
[clap_builder::parser::parser]Parser::add_defaults:iter:log_level:
[clap_builder::parser::parser]Parser::add_default_value: doesn't have conditional defaults
[clap_builder::parser::parser]Parser::add_default_value:iter:log_level: has default vals
[clap_builder::parser::parser]Parser::add_default_value:iter:log_level: wasn't used
[clap_builder::parser::parser]Parser::react action=Set, identifier=None, source=DefaultValue
[clap_builder::parser::arg_matcher]ArgMatcher::start_custom_arg: id="log_level", source=DefaultValue
[clap_builder::parser::parser]Parser::push_arg_values: ["info"]
[clap_builder::parser::parser]Parser::add_single_val_to_arg: cur_idx:=2
[clap_builder::parser::arg_matcher]ArgMatcher::needs_more_vals: o=log_level, pending=0
[clap_builder::parser::arg_matcher]ArgMatcher::needs_more_vals: expected=1, actual=0
[clap_builder::parser::parser]Parser::react not enough values passed in, leaving it to the validator to complain
[clap_builder::parser::parser]Parser::add_defaults:iter:file:
[clap_builder::parser::parser]Parser::add_default_value: doesn't have conditional defaults
[clap_builder::parser::parser]Parser::add_default_value:iter:file: doesn't have default vals
[clap_builder::parser::parser]Parser::add_defaults:iter:help:
[clap_builder::parser::parser]Parser::add_default_value: doesn't have conditional defaults
[clap_builder::parser::parser]Parser::add_default_value:iter:help: doesn't have default vals
[clap_builder::parser::parser]Parser::add_defaults:iter:version:
[clap_builder::parser::parser]Parser::add_default_value: doesn't have conditional defaults
[clap_builder::parser::parser]Parser::add_default_value:iter:version: doesn't have default vals
[clap_builder::parser::validator]Validator::validate
[clap_builder::builder::command]Command::groups_for_arg: id="file"
[clap_builder::parser::validator]Conflicts::gather_direct_conflicts id="file", conflicts=[]
[clap_builder::parser::validator]Conflicts::gather_direct_conflicts id="Cli", conflicts=[]
[clap_builder::parser::validator]Validator::validate_conflicts
[clap_builder::parser::validator]Validator::validate_exclusive
[clap_builder::parser::validator]Validator::validate_conflicts::iter: id="file"
[clap_builder::parser::validator]Conflicts::gather_conflicts: arg="file"
[clap_builder::parser::validator]Conflicts::gather_conflicts: conflicts=[]
[clap_builder::parser::validator]Validator::validate_required: required=ChildGraph([Child { id: "file", children: [] }])
[clap_builder::parser::validator]Validator::gather_requires
[clap_builder::parser::validator]Validator::gather_requires:iter:"file"
[clap_builder::parser::validator]Validator::gather_requires:iter:"Cli"
[clap_builder::parser::validator]Validator::gather_requires:iter:"Cli":group
[clap_builder::parser::validator]Validator::validate_required: is_exclusive_present=false
[clap_builder::parser::arg_matcher]ArgMatcher::get_global_values: global_arg_vec=[]
thread 'main' panicked at src/main.rs:12:20:
Mismatch between definition and access of `log_level`. Could not downcast to tracing_core::metadata::Level, need to downcast to alloc::string::String

stack backtrace:
   0:     0x55def6033e9c - std::backtrace_rs::backtrace::libunwind::trace::he43a6a3949163f8c
                               at /rustc/cc66ad468955717ab92600c770da8c1601a4ff33/library/std/src/../../backtrace/src/backtrace/libunwind.rs:93:5
   1:     0x55def6033e9c - std::backtrace_rs::backtrace::trace_unsynchronized::h50db52ca99f692e7
                               at /rustc/cc66ad468955717ab92600c770da8c1601a4ff33/library/std/src/../../backtrace/src/backtrace/mod.rs:66:5
   2:     0x55def6033e9c - std::sys_common::backtrace::_print_fmt::hd37d595f2ceb2d3c
                               at /rustc/cc66ad468955717ab92600c770da8c1601a4ff33/library/std/src/sys_common/backtrace.rs:67:5
   3:     0x55def6033e9c - <std::sys_common::backtrace::_print::DisplayBacktrace as core::fmt::Display>::fmt::h678bbcf9da6d7d75
                               at /rustc/cc66ad468955717ab92600c770da8c1601a4ff33/library/std/src/sys_common/backtrace.rs:44:22
   4:     0x55def6058e9c - core::fmt::rt::Argument::fmt::h3a159adc080a6fc9
                               at /rustc/cc66ad468955717ab92600c770da8c1601a4ff33/library/core/src/fmt/rt.rs:138:9
   5:     0x55def6058e9c - core::fmt::write::hb8eaf5a8e45a738e
                               at /rustc/cc66ad468955717ab92600c770da8c1601a4ff33/library/core/src/fmt/mod.rs:1094:21
   6:     0x55def603162e - std::io::Write::write_fmt::h9663fe36b2ee08f9
                               at /rustc/cc66ad468955717ab92600c770da8c1601a4ff33/library/std/src/io/mod.rs:1714:15
   7:     0x55def6033c84 - std::sys_common::backtrace::_print::hcd4834796ee88ad2
                               at /rustc/cc66ad468955717ab92600c770da8c1601a4ff33/library/std/src/sys_common/backtrace.rs:47:5
   8:     0x55def6033c84 - std::sys_common::backtrace::print::h1360e9450e4f922a
                               at /rustc/cc66ad468955717ab92600c770da8c1601a4ff33/library/std/src/sys_common/backtrace.rs:34:9
   9:     0x55def6035243 - std::panicking::default_hook::{{closure}}::h2609fa95cd5ab1f4
                               at /rustc/cc66ad468955717ab92600c770da8c1601a4ff33/library/std/src/panicking.rs:270:22
  10:     0x55def6034f5c - std::panicking::default_hook::h6d75f5747cab6e8d
                               at /rustc/cc66ad468955717ab92600c770da8c1601a4ff33/library/std/src/panicking.rs:290:9
  11:     0x55def60357c9 - std::panicking::rust_panic_with_hook::h57e78470c47c84de
                               at /rustc/cc66ad468955717ab92600c770da8c1601a4ff33/library/std/src/panicking.rs:707:13
  12:     0x55def60356c7 - std::panicking::begin_panic_handler::{{closure}}::h3dfd2453cf356ecb
                               at /rustc/cc66ad468955717ab92600c770da8c1601a4ff33/library/std/src/panicking.rs:599:13
  13:     0x55def60343c6 - std::sys_common::backtrace::__rust_end_short_backtrace::hdb177d43678e4d7e
                               at /rustc/cc66ad468955717ab92600c770da8c1601a4ff33/library/std/src/sys_common/backtrace.rs:170:18
  14:     0x55def6035412 - rust_begin_unwind
                               at /rustc/cc66ad468955717ab92600c770da8c1601a4ff33/library/std/src/panicking.rs:595:5
  15:     0x55def5cfc3f3 - core::panicking::panic_fmt::hd1e971d8d7c78e0e
                               at /rustc/cc66ad468955717ab92600c770da8c1601a4ff33/library/core/src/panicking.rs:67:14
  16:     0x55def5d05cd2 - clap_builder::parser::error::MatchesError::unwrap::h49d1d71fde798a90
                               at /home/andreas/.local/share/cargo/registry/src/index.crates.io-6f17d22bba15001f/clap_builder-4.4.7/src/parser/error.rs:32:9
  17:     0x55def5d08bff - clap_builder::parser::matches::arg_matches::ArgMatches::remove_one::hce0673a51f35d893
                               at /home/andreas/.local/share/cargo/registry/src/index.crates.io-6f17d22bba15001f/clap_builder-4.4.7/src/parser/matches/arg_matches.rs:405:9
  18:     0x55def5d04f4e - <clap_bug::Cli as clap_builder::derive::FromArgMatches>::from_arg_matches_mut::hf6b5c3bd9befc1c4
                               at /home/andreas/dev/clap-bug/src/main.rs:7:10
  19:     0x55def5d086c8 - clap_builder::derive::Parser::parse::h94f42a08efee0962
                               at /home/andreas/.local/share/cargo/registry/src/index.crates.io-6f17d22bba15001f/clap_builder-4.4.7/src/derive.rs:28:19
  20:     0x55def5d04e1f - clap_bug::main::ha195e332364b10a2
                               at /home/andreas/dev/clap-bug/src/main.rs:20:15
  21:     0x55def5d0f19b - core::ops::function::FnOnce::call_once::hd80ec5820bd6d8db
                               at /rustc/cc66ad468955717ab92600c770da8c1601a4ff33/library/core/src/ops/function.rs:250:5
  22:     0x55def5cfcc8e - std::sys_common::backtrace::__rust_begin_short_backtrace::h312b34c0089467a0
                               at /rustc/cc66ad468955717ab92600c770da8c1601a4ff33/library/std/src/sys_common/backtrace.rs:154:18
  23:     0x55def5cfcd01 - std::rt::lang_start::{{closure}}::ha33404b30517aba5
                               at /rustc/cc66ad468955717ab92600c770da8c1601a4ff33/library/std/src/rt.rs:166:18
  24:     0x55def602cf2b - core::ops::function::impls::<impl core::ops::function::FnOnce<A> for &F>::call_once::hbcc4f8a3f5ada78c
                               at /rustc/cc66ad468955717ab92600c770da8c1601a4ff33/library/core/src/ops/function.rs:284:13
  25:     0x55def602cf2b - std::panicking::try::do_call::he5f117a9e13dadde
                               at /rustc/cc66ad468955717ab92600c770da8c1601a4ff33/library/std/src/panicking.rs:502:40
  26:     0x55def602cf2b - std::panicking::try::h2f3af9afce3a0443
                               at /rustc/cc66ad468955717ab92600c770da8c1601a4ff33/library/std/src/panicking.rs:466:19
  27:     0x55def602cf2b - std::panic::catch_unwind::h6d6c387f38ef05ea
                               at /rustc/cc66ad468955717ab92600c770da8c1601a4ff33/library/std/src/panic.rs:142:14
  28:     0x55def602cf2b - std::rt::lang_start_internal::{{closure}}::h6ca09d5905711415
                               at /rustc/cc66ad468955717ab92600c770da8c1601a4ff33/library/std/src/rt.rs:148:48
  29:     0x55def602cf2b - std::panicking::try::do_call::ha9fd18ea06654a4b
                               at /rustc/cc66ad468955717ab92600c770da8c1601a4ff33/library/std/src/panicking.rs:502:40
  30:     0x55def602cf2b - std::panicking::try::hda5c2a4432362341
                               at /rustc/cc66ad468955717ab92600c770da8c1601a4ff33/library/std/src/panicking.rs:466:19
  31:     0x55def602cf2b - std::panic::catch_unwind::h440f731b142bc235
                               at /rustc/cc66ad468955717ab92600c770da8c1601a4ff33/library/std/src/panic.rs:142:14
  32:     0x55def602cf2b - std::rt::lang_start_internal::hc0b4e50f058f62ce
                               at /rustc/cc66ad468955717ab92600c770da8c1601a4ff33/library/std/src/rt.rs:148:20
  33:     0x55def5cfccda - std::rt::lang_start::h32745d78f2564536
                               at /rustc/cc66ad468955717ab92600c770da8c1601a4ff33/library/std/src/rt.rs:165:17
  34:     0x55def5d059be - main
  35:     0x7f890e4c5cd0 - <unknown>
  36:     0x7f890e4c5d8a - __libc_start_main
  37:     0x55def5cfcba5 - _start
  38:                0x0 - <unknown>
```

---

_Label `C-bug` added by @AndreasBackx on 2023-11-08 00:13_

---

_Comment by @AndreasBackx on 2023-11-08 00:28_

Seems to replicate with `String` instead of `PathBuf` as well. Seems like the combination of the positional and log-level argument is the culprit.

---

_Comment by @epage on 2023-11-08 00:42_

This is all in the log level. The assert is because your value parsers type is `String` while the field expects a `Level`. You need to use `map` on the value parser to convert it to a Level.

As this is expected behavior to report on a development-time bug, I'm closing this.

---

_Closed by @epage on 2023-11-08 00:42_

---

_Comment by @AndreasBackx on 2023-11-08 00:43_

Was about to comment and close and you were ahead. Thanks for the proper explanation!

---
