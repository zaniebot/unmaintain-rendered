<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>4.0 regression: dashes are not accepted any more - clap-rs/clap #4869</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>4.0 regression: dashes are not accepted any more</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/clap-rs/clap/issues/4869">#4869</a>
        opened by <a href="https://github.com/est31">@est31</a>
        on 2023-04-28 20:02
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/est31">@est31</a></div>
            <div class="timeline-body">Please complete the following tasks
<ul>
<li>[X] I have searched the <a href="https://github.com/clap-rs/clap/discussions">discussions</a></li>
<li>[X] I have searched the <a href="https://github.com/clap-rs/clap/issues">open</a> and <a href="https://github.com/clap-rs/clap/issues?q=is%3Aissue+label%3AS-wont-fix+is%3Aclosed">rejected</a> issues</li>
</ul>
Rust Version
<ul>
<li></li>
</ul>
Clap Version
<p>4.0</p>
Minimal reproducible code
<pre><code>use clap::Parser;
use clap::CommandFactory;

fn main() {
    let matches = OptFoo::command().try_get_matches_from(std::env::args()).unwrap();

    println!(&quot;matches foo-bar: {:?}&quot;, matches.try_get_one::&lt;bool&gt;(&quot;foo-bar&quot;));
    println!();
    println!(&quot;matches someflag: {:?}&quot;, matches.try_get_one::&lt;bool&gt;(&quot;someflag&quot;));
}

#[derive(Parser, Debug)]
#[allow(dead_code)]
struct OptFoo {
	#[clap(long, action)]
	foo_bar: bool,
	#[clap(long, action)]
	someflag: bool,
}
</code></pre>
Steps to reproduce the bug with the above code
<p>Do <code>cargo run -- --foo-bar --someflag</code></p>
Actual Behaviour
<p>It prints:</p>
<pre><code>matches foo-bar: Err(UnknownArgument)

matches someflag: Ok(Some(true))
</code></pre>
Expected Behaviour
<p>It prints:</p>
<pre><code>matches foo-bar: Ok(Some(true))

matches someflag: Ok(Some(true))
</code></pre>
<p>This is what Clap 3.0 did, you can confirm this by running the example with Clap 3.0, i&#x27;ve written it to compile fine there as well. This, this is a regression of 4.0.0.</p>
Additional Context
<p>This caused <a href="https://github.com/est31/cargo-udeps/issues/151">est31/cargo-udeps#151</a> where I list all the <code>cargo check</code> flags in a struct that derives <code>Parser</code>, so that they can be passed on to cargo, but where cargo internally does the equivalent of <code>arg_matches.try_get_one::&lt;bool&gt;(&quot;all-targets&quot;)</code> (it does it via an extension trait on ArgMatches, via a <code>fn flag(&amp;self, name: &amp;str) -&gt; bool</code> function).</p>
Debug Output
<p><em>No response</em></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">C-bug</span> added by <a href="https://github.com/est31">@est31</a> on 2023-04-28 20:02</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from &quot;4.0 regression: underscores are not accepted any more&quot; to &quot;4.0 regression: dashes are not accepted any more&quot; by <a href="https://github.com/est31">@est31</a> on 2023-04-28 20:05</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/est31">@est31</a> on 2023-04-28 20:05</div>
            <div class="timeline-body"><p>A workaround is to add <code>name = &quot;thing-without-underscores-but-dashes&quot;</code> as an attribute, <a href="https://github.com/est31/cargo-udeps/commit/0d4889b18b9fa743c6618bf76d116fa39537606e">which I did in cargo-udeps</a>. It&#x27;s not really nice though that you have to go through the entire list and check for names with <code>_</code> inside.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a>est31/cargo-udeps#151</a> on 2023-04-28 20:08</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2023-04-28 20:26</div>
            <div class="timeline-body"><p>We called this change out in the breaking changes for 4.0 under the &quot;subtle&quot; section, meaning these were the high priority ones to review when upgrading</p>
<blockquote>
<p>(derive) Leave Arg::id as verbatim casing, requiring updating of string references to other args like in conflicts_with or requires (#3282)</p>
</blockquote>
<p>As for the workaroumd, it is better to use <code>id</code> rather than <code>name</code>.  Its an accident that <code>name</code>i is allowed and we&#x27;ll be removing it in clap v5</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/est31">@est31</a> on 2023-04-28 20:42</div>
            <div class="timeline-body"><p>Note, that changelog line is very terse and unless you know clap&#x27;s internals, or you have been pointed towards it, you won&#x27;t really be able to derive actionable advice from it.</p>
<p>Also, even if it is pointed out, maybe it&#x27;s not the best idea to have that change, given it makes such hybrid uses harder.</p>
<blockquote>
<p>it is better to use <code>id</code> rather than <code>name</code>.</p>
</blockquote>
<p>Thanks, will do!</p>
<p>Question: if #3709 is implemented, will I be able to just specify that?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2023-04-28 21:03</div>
            <div class="timeline-body"><blockquote>
<p>Also, even if it is pointed out, maybe it&#x27;s not the best idea to have that change, given it makes such hybrid uses harder.</p>
</blockquote>
<p>The change was made to improve the pure-derive workflow.  If you want to declare an arg to conflict with another arg, you now refer to it by the field&#x27;s name, not what the long name or the value name would be, if it exists.  This improves discoverability of the behavior.</p>
<blockquote>
<p>Question: if <a href="https://github.com/clap-rs/clap/issues/3709">clap-rs/clap#3709</a> is implemented, will I be able to just specify that?</p>
</blockquote>
<p>We have no plans for controlling naming of <code>id</code>, for the reason given above.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/est31">@est31</a> on 2023-04-29 00:57</div>
            <div class="timeline-body"><p>Thanks for informing me, and thanks for the advice. I guess it&#x27;s a tradeoff decision in the end, although of course I&#x27;m not happy that the only way to use arguments both in cargo and cargo-udeps is to either make cargo-udeps not use derives, or to put an explicit <code>id</code> attribute everywhere. The bug in cargo-udeps was especially hard to debug because i didn&#x27;t know if the bug was in cargo, cargo-udeps or clap. I guess most projects have it easier, given that most projects probably only expose a CLI API surface in a fraction of the size that cargo uses.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/est31">@est31</a> on 2023-04-29 00:57</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2023-04-29 01:14</div>
            <div class="timeline-body"><p>For my own projects, I recreate the cargo CLI, rather than reuse it (see <code>clap-cargo</code>).  Granted, if you are using cargo-as-a-library for other things then that might make sense.  I tend to avoid that as its not a well supported workflow (intentionally at the moment)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a>bbusse/waystream#2</a> on 2023-07-11 06:01</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:59:45 UTC
    </footer>
</body>
</html>
