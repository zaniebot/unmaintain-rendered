```yaml
number: 28
title: Requiring version string have static lifetime makes for awkward code
type: issue
state: closed
author: jhelwig
labels: []
assignees: []
created_at: 2015-03-23T04:18:38Z
updated_at: 2018-08-02T03:29:36Z
url: https://github.com/clap-rs/clap/issues/28
synced_at: 2026-01-10T01:57:39Z
```

# Requiring version string have static lifetime makes for awkward code

---

_Issue opened by @jhelwig on 2015-03-23 04:18_

In trying to get the version string to automatically populate based on the version I specify in my `Cargo.toml` using something like:

``` Rust
...
    let version = format!("{}.{}.{}{}",
                          env!("CARGO_PKG_VERSION_MAJOR"),
                          env!("CARGO_PKG_VERSION_MINOR"),
                          env!("CARGO_PKG_VERSION_PATCH"),
                          option_env!("CARGO_PKG_VERSION_PRE").unwrap_or(""));

    let matches = App::new("signing-participants")
        .version(&version[..])
...
```

However, this fails with:

```
% cargo build
   Compiling signing-participants v0.0.1 (file:///Users/jacobhelwig/btsync/projects/signing-participants)
src/main.rs:27:19: 27:26 error: `version` does not live long enough
src/main.rs:27         .version(&version[..])
                                 ^~~~~~~
note: reference must be valid for the static lifetime...
src/main.rs:24:78: 93:2 note: ...but borrowed value is only valid for the block suffix following statement 1 at 24:77
src/main.rs:24                           option_env!("CARGO_PKG_VERSION_PRE").unwrap_or(""));
src/main.rs:25
src/main.rs:26     let matches = App::new("signing-participants")
src/main.rs:27         .version(&version[..])
src/main.rs:28         .author("Jacob Helwig <jacob@technosorcery.net")
src/main.rs:29         .about("Generate a list for key-signing parties")
               ...
error: aborting due to previous error
Could not compile `signing-participants`.

To learn more, run the command again with --verbose.
```

I can get it to work if I don't care about the prerelease marker, and switch to `concat!` (haven't been able to get `concat!` to play nicely with `option_env!`):

``` Rust

    let version = concat!(env!("CARGO_PKG_VERSION_MAJOR"), ".",
                          env!("CARGO_PKG_VERSION_MINOR"), ".",
                          env!("CARGO_PKG_VERSION_PATCH"));

    let matches = App::new("signing-participants")
        .version(&version)
```

```
% cargo run -- --version
   Compiling signing-participants v0.0.1 (file:///Users/jacobhelwig/btsync/projects/signing-participants)
     Running `target/debug/signing-participants --version`
signing-participants 0.0.1
```

Sticking with `format!` so I can use `option_env!` is really not nice (as it involves [unsafe code provided by dougxxx in the #rust IRC channel](https://play.rust-lang.org/?code=%23!%5Bfeature%28collections%29%5D%0Ause%20std%3A%3Amem%3A%3Aforget%3B%0Ause%20std%3A%3Amem%3A%3Atransmute%3B%0A%0Aunsafe%20fn%20as_static%28v%3A%26str%29%20-%3E%20%26%27static%20str%20%7B%0A%20%20let%20tmp%20%3D%20String%3A%3Afrom_str%28v%29%3B%0A%20%20let%20boxed%20%3D%20Box%3A%3Anew%28tmp%29%3B%0A%20%20let%20rtn%3A%20*const%20str%20%3D%20%26**boxed%20as%20*const%20str%3B%20%0A%20%20forget%28boxed%29%3B%0A%20%20return%20transmute%28rtn%29%3B%0A%7D%0A%0Afn%20awkward_function%28v%3A%26%27static%20str%29%20%7B%0A%20%20println!%28%22%7B%7D%22%2C%20v%29%3B%0A%7D%0A%0Afn%20main%28%29%20%7B%0A%20%20let%20foo%20%3D%20String%3A%3Afrom_str%28%22Hello%20World%22%29%3B%0A%20%20unsafe%20%7B%20awkward_function%28as_static%28%26*foo%29%29%3B%20%7D%0A%7D)):

``` Rust
#![feature(collections)]
use std::mem::forget;
use std::mem::transmute;

unsafe fn as_static(v:&str) -> &'static str {
  let tmp = String::from_str(v);
  let boxed = Box::new(tmp);
  let rtn: *const str = &**boxed as *const str; 
  forget(boxed);
  return transmute(rtn);
}

fn awkward_function(v:&'static str) {
  println!("{}", v);
}

fn main() {
  let foo = String::from_str("Hello World");
  unsafe { awkward_function(as_static(&*foo)); }
}
```

Is there a way the elements of the App struct could be changed to not require static lifetimes on its elements?  I haven't looked at what the implications of this would be with the rest of the code, but allowing the `format!` trick I initially tried for defining the version seems like reasonable usage of the library.


---

_Renamed from "Requiring version string be static makes for awkward code" to "Requiring version string have static lifetime makes for awkward code" by @jhelwig on 2015-03-23 04:19_

---

_Comment by @kbknapp on 2015-03-23 20:20_

I'll take a look at this tonight and report back. Thanks for the detailed write up!


---

_Comment by @jhelwig on 2015-03-23 20:42_

Thanks for taking a look! This library has been working really well for me so far. :)


---

_Closed by @kbknapp on 2015-03-24 02:38_

---

_Comment by @kbknapp on 2015-03-24 02:43_

I got it working in a backwards compat way allowing lifetimes other than 'static. 0.4.14 on crates.io (or master branch here) should be working for you now. Let me know if that fixed what you needed. And I like your example for auto-generating the version from the Cargo.toml, I'm gonna throw that in the examples dir. Thanks again :+1: 


---

_Comment by @jhelwig on 2015-03-24 03:29_

Yup, works like a charm.  Thank you!


---

_Referenced in [clap-rs/clap#34](../../clap-rs/clap/issues/34.md) on 2015-03-26 22:56_

---

_Referenced in [Shopify/shadowenv#10](../../Shopify/shadowenv/pulls/10.md) on 2019-02-20 22:07_

---
