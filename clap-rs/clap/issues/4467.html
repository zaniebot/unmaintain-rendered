<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clap panics on positional bools in debug builds - clap-rs/clap #4467</title>
    <link rel="stylesheet" href="../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../index.html">Back to index</a>
    </div>

    <h1>Clap panics on positional bools in debug builds</h1>

    <div class="meta">
        <span class="state state-closed">Closed</span>
        <a href="https://github.com/clap-rs/clap/issues/4467">#4467</a>
        opened by <a href="https://github.com/therealprof">@therealprof</a>
        on 2022-11-08 12:26
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/therealprof">@therealprof</a> on 2022-11-08 12:26</div>
            <div class="timeline-body"><h3>Please complete the following tasks</h3>
<ul>
<li>[X] I have searched the <a href="https://github.com/clap-rs/clap/discussions">discussions</a></li>
<li>[X] I have searched the <a href="https://github.com/clap-rs/clap/issues">open</a> and <a href="https://github.com/clap-rs/clap/issues?q=is%3Aissue+label%3AS-wont-fix+is%3Aclosed">rejected</a> issues</li>
</ul>
<h3>Rust Version</h3>
<p>rustc 1.64.0 (a55dd71d5 2022-09-19)</p>
<h3>Clap Version</h3>
<p>4.0.22</p>
<h3>Minimal reproducible code</h3>
<pre><code class="language-rust">use clap::{Parser, Subcommand};

#[derive(Parser)]
#[clap(author, version, name = &quot;test&quot;)]
struct Test {
    #[clap(subcommand)]
    action: Action,
}

#[derive(Subcommand)]
enum Action {
    #[clap(name = &quot;encode_msg&quot;)]
    EncodeMsg {
        msgid: String,
        #[clap(subcommand)]
        typ: MsgType,
    },
}

#[derive(Parser)]
enum MsgType {
    #[clap(name = &quot;Notify&quot;)]
    USPNotify {
        sub_id: String,
        send_resp: bool,
        #[clap(subcommand)]
        typ: NotifyType,
    },
}

#[derive(Parser)]
pub enum NotifyType {
    Request { oui: String },
}

fn main() -&gt; () {
    Test::parse();
}
</code></pre>
<h3>Steps to reproduce the bug with the above code</h3>
<pre><code># cargo run --release encode_msg Foo Notify foo false request foo
</code></pre>
<h3>Actual Behaviour</h3>
<pre><code>error: The argument '[SEND_RESP]' requires 0 values, but 1 was provided

Usage: test encode_msg &lt;MSGID&gt; Notify &lt;SUB_ID&gt; [SEND_RESP] &lt;COMMAND&gt;

For more information try '--help'
</code></pre>
<h3>Expected Behaviour</h3>
<p><code>send_resp</code> shouldn't be rendered as an optional argument in the synopsis and if supplied should result in the parsed variable to be false.</p>
<h3>Additional Context</h3>
<p>As a bonus bug:</p>
<p>If run like this, the synopsis changes:</p>
<pre><code># cargo run --release encode_msg Foo Notify foo --send_resp Bar
    Finished release [optimized] target(s) in 0.04s
     Running `target/release/test encode_msg Foo Notify foo --send_resp Bar`
error: Found argument '--send_resp' which wasn't expected, or isn't valid in this context

  If you tried to supply '--send_resp' as a value rather than a flag, use '-- --send_resp'

Usage: test encode_msg &lt;MSGID&gt; Notify &lt;SUB_ID|SEND_RESP&gt; &lt;COMMAND&gt;
</code></pre>
<p>And in dev mode it panics:</p>
<pre><code># cargo run encode_msg Foo Notify foo false request foo
    Finished dev [unoptimized + debuginfo] target(s) in 0.05s
     Running `target/debug/test encode_msg Foo Notify foo false request foo`
thread 'main' panicked at 'Argument 'send_resp` is positional, it must take a value', /Users/egger/.cargo/registry/src/github.com-1ecc6299db9ec823/clap-4.0.22/src/builder/debug_asserts.rs:740:9
note: run with `RUST_BACKTRACE=1` environment variable to display a backtrace
</code></pre>
<h3>Debug Output</h3>
<p><em>No response</em></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">C-bug</span> added by @therealprof on 2022-11-08 12:26</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2022-11-10 04:03</div>
            <div class="timeline-body"><p><code>bool</code> is defined in the reference to <a href="https://docs.rs/clap/latest/clap/_derive/index.html#arg-types">default to flag-like behavior</a> and you need to override what clap is doing implicitly.</p>
<p>That said, we can look into detecting if its positional (no shorts or longs) and skip that.  I have some hesitance around this as we might not have all of the information we need in all of the right places.</p>
<p>I also think we should have a debug_assert about a positional argument taking 0 values to help catch this earlier.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">A-derive</span> added by @epage on 2022-11-10 04:04</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">S-waiting-on-decision</span> added by @epage on 2022-11-10 04:04</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/4471.html">clap-rs/clap#4471</a> on 2022-11-10 04:11</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2022-11-10 04:12</div>
            <div class="timeline-body"><p>It looks like we do have an existing assert for this.  For me, in debug builds, I get a panic.</p>
<p>We generally recommend having a test that does</p>
<pre><code class="language-rust">use clap::CommandFactory;
Test::command().debug_assert()
</code></pre>
<p>to help catch these</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/therealprof">@therealprof</a> on 2022-11-10 12:42</div>
            <div class="timeline-body"><blockquote>
<p>It looks like we do have an existing assert for this. For me, in debug builds, I get a panic.</p>
</blockquote>
<p>Yes, this is mentioned in the bug report above.</p>
<p>I used your <code>debug_assert()</code> but it doesn't seem to change anything in the output.</p>
<pre><code># cargo run encode_msg Foo Notify foo --send_resp Bar
    Finished dev [unoptimized + debuginfo] target(s) in 0.07s
     Running `target/debug/test encode_msg Foo Notify foo --send_resp Bar`
thread 'main' panicked at 'Argument 'send_resp` is positional, it must take a value', /Users/egger/.cargo/registry/src/github.com-1ecc6299db9ec823/clap-4.0.22/src/builder/debug_asserts.rs:740:9
note: run with `RUST_BACKTRACE=1` environment variable to display a backtrace
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/therealprof">@therealprof</a> on 2022-11-10 12:54</div>
            <div class="timeline-body"><blockquote>
<p><code>bool</code> is defined in the reference to <a href="https://docs.rs/clap/latest/clap/_derive/index.html#arg-types">default to flag-like behavior</a> and you need to override what clap is doing implicitly.</p>
</blockquote>
<p>Not sure I understand. I do want that describe behaviour, don't I? However it is not what actually seems to happen, when I execute the command as described <strong>without</strong> supplying a <code>send_resp</code> flag or boolean value, the actual value of the variable after parsing is always false. That's how I found the bug in the first place since I <strong>do</strong> want it to be <code>true</code> and failed to change it from the command line.</p>
<blockquote>
<p>I also think we should have a debug_assert about a positional argument taking 0 values to help catch this earlier.</p>
</blockquote>
<p>I do think this assert is rather useless since we're talking about a command line parsing library here and the only people who'd even have a remote chance of catching this are the developers who're doing the <code>cargo run</code> dance which is a bit annoying since <code>cargo</code> interferes with command line parsing quite a bit; to test things I'm pretty much always using <code>cargo install --path .</code> instead to get the end-user POV, however that uses <code>--release</code> mode so I don't get the assert.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2022-11-10 13:09</div>
            <div class="timeline-body"><blockquote>
<p>Not sure I understand. I do want that describe behaviour, don't I? However it is not what actually seems to happen, when I execute the command as described without supplying a send_resp flag or boolean value, the actual value of the variable after parsing is always false. That's how I found the bug in the first place since I do want it to be true and failed to change it from the command line.</p>
</blockquote>
<p>Are you wanting a flag or a positional value?</p>
<p>For a flag, you also need to opt-in to <code>#[arg(short)]</code> and/or <code>#[arg(long)]</code> (<a href="https://docs.rs/clap/latest/clap/_derive/_tutorial/index.html#flags">tutorial</a>)</p>
<p>For a positional, you need to override the default <code>ArgAction::SetTrue</code> (doesn't accept values) to <code>ArgAction::Set</code> (accepts values, picking parser based on the field type), like <code>#[arg(action = clap::ArgAction::Set)]</code>.</p>
<blockquote>
<p>I do think this assert is rather useless since we're talking about a command line parsing library here and the only people who'd even have a remote chance of catching this are the developers who're doing the cargo run dance which is a bit annoying since cargo interferes with command line parsing quite a bit; to test things I'm pretty much always using cargo install --path . instead to get the end-user POV, however that uses --release mode so I don't get the assert.</p>
</blockquote>
<ul>
<li>In my comment, I called out that we recommend having a test explicitly activate these.  The tutorial includes <a href="https://docs.rs/clap/latest/clap/_derive/_tutorial/index.html#testing">an example</a></li>
<li>Ideally, you'd have end-to-end tests.   I use a mixture of <a href="https://docs.rs/snapbox/latest/snapbox/">snapbox</a> and <a href="https://docs.rs/trycmd">trycmd</a> for mine</li>
<li>I've never had problems with <code>cargo run</code>.   In fact, I have all of my own personal CLIs wrapped in shell scripts that are in PATH that invoke them via <code>cargo run</code> so that I am always testing HEAD.  Are you escaping your args with <code>--</code>, for example <code>cargo run --manifest-path ~/src/personal/cargo-release/Cargo.toml -- &quot;$@&quot;</code></li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/therealprof">@therealprof</a> on 2022-11-10 13:27</div>
            <div class="timeline-body"><blockquote>
<p>Are you wanting a flag or a positional value?</p>
</blockquote>
<p>I don't really care, I was hoping for a positional (the documentation in https://docs.rs/clap/latest/clap/_derive/index.html#arg-types does call the effect a flag though -- might want to straighten out terminology a bit) but the synopsis indicated that this was somehow optional. Then I played around with specifying it as flag, suddently changing the synopsis to something completely different.
(cf. above):
<code>Usage: test encode_msg &lt;MSGID&gt; Notify &lt;SUB_ID&gt; [SEND_RESP] &lt;COMMAND&gt;</code>
vs.
<code>Usage: test encode_msg &lt;MSGID&gt; Notify &lt;SUB_ID|SEND_RESP&gt; &lt;COMMAND&gt;</code></p>
<p>I don't really understand why the default action is a non-working <code>.action(ArgAction::SetTrue)</code>, if it's not specified I would definitely expect to see the value coming out as <code>true</code>.</p>
<p><code>ArgAction::Set</code> works a treat, but it's totally not obvious that this is what needs doing to get a positional boolean going. And it's also not obvious why the <code>bool</code> parameter is implicitly treated as optional; if I had wanted an optional positional parameter I'd have tried <code>Option&lt;bool&gt;</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2022-11-10 14:09</div>
            <div class="timeline-body"><p>All of what you saw comes back to the general assumption that <code>bool</code> will be used as a flag and that the caller will set <code>short</code> and/or <code>long</code>.  As I mentioned earlier, we can look into making the default smarter by checking if its being used without <code>short</code> or <code>long</code> and instead using <code>Set</code>.  My only concern is piping the information through for that to happen which, looking back, might not be too bad.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/therealprof">@therealprof</a> on 2022-11-10 14:20</div>
            <div class="timeline-body"><p>I think at least the documentation could be clarified to point out that pitfall and maybe provide an example for positional bool.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/DoumanAsh">@DoumanAsh</a> on 2023-05-08 10:59</div>
            <div class="timeline-body"><blockquote>
<p>bool is defined in the reference to default to flag-like behavior and you need to override what clap is doing implicitly.</p>
</blockquote>
<p>It should not be the case, this generated broken parser</p>
<pre><code>use clap::Parser;

#[derive(Parser, Debug)]
struct RetardedArgs {
    #[clap(value_parser)]
    enabled: bool,
}
fn main() {
    let result = RetardedArgs::parse();
    println!(&quot;result={:?}&quot;, result);
}
</code></pre>
<p>And you do not generate compile error, even though this parser never going to work
Why are you doing this?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2023-05-08 11:55</div>
            <div class="timeline-body"><blockquote>
<p>And you do not generate compile error, even though this parser never going to work
Why are you doing this?</p>
</blockquote>
<p>#3864 is a similar case where we could move the error to be at compile time.  #3133 represents the case where this is a lot more difficult.</p>
<p>Downsides to moving things to compile errors</p>
<ul>
<li>It won't cover everything in <code>Command::debug_assert</code> and people will get a false sense of security.  You still need to be creating the tests.  We are discussing creating the test automatically in #4838</li>
<li>We are duplicating the logic and will need to duplicate the tests, increasing the maintenance burden and risk of not keeping them in sync with each other</li>
<li>We would be slowing down compile times for people (time to build <code>clap_derive</code>, time to run <code>clap_derive</code>).  Unsure how noticeable this would be but our primary focus right now is on compile times.</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/4895.html">clap-rs/clap#4895</a> on 2023-05-08 12:15</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/DoumanAsh">@DoumanAsh</a> on 2023-05-08 12:15</div>
            <div class="timeline-body"><p>Then do not force flag behavior for boolean, it is simple as that.</p>
<p>You do not slow compile times.
It is already slow because cargo cannot comprehend that it needs to build proc macros in release mode always
So you don't need to worry about that.</p>
<p>Please see example solution
https://github.com/clap-rs/clap/pull/4895</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2023-05-08 12:26</div>
            <div class="timeline-body"><blockquote>
<p>Then do not force flag behavior for boolean, it is simple as that.</p>
</blockquote>
<p>That is not what people will generally want with <code>bool</code> though.  Positional bools should also be relatively rare because the intent is unclear from their position.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/DoumanAsh">@DoumanAsh</a> on 2023-05-08 12:29</div>
            <div class="timeline-body"><p>It depends on your use case.
But boolean default behavior should be dependent on context (whether it is flag or positional) as with any other type
You should not specialize boolean just because most people use it as flag.</p>
<p>Rejecting good UX just because you want to force your opinion about boolean on others is not good</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/5135.html">clap-rs/clap#5135</a> on 2023-09-25 11:59</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "Clap seems easily confused by boolean arguments" to "Clap panics on positional bools in debug builds" by @epage on 2023-09-25 12:01</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">S-waiting-on-decision</span> removed by @epage on 2025-08-15 13:39</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">S-wont-fix</span> added by @epage on 2025-08-15 13:39</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">M-breaking-change</span> added by @epage on 2025-08-15 13:39</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2025-08-15 13:42</div>
            <div class="timeline-body"><p>In reviewing this, the only solution would be to change the derive for <code>bool</code> to not imply <code>SetTrue</code>.  This would be a breaking change and would have to wait until v5.  The question is this change is worth it on its own and worth the user migration.  I suspect not as I feel the majority of users expect bools to be flags.  The behavior is documented, mistakes caught with a debug assert, we plan to elevate that debug assert in derives to ensure more people see it, and this is easily worked around.  As such, I lean towards closing this.  If there is a reason for us to re-evaluate, let us know!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @epage on 2025-08-15 13:42</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:28:34 UTC
    </footer>
</body>
</html>
