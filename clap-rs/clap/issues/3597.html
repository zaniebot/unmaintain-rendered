<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Required arg with &lt;TYPE&gt; tag and default value always errors in debug build but never in release - clap-rs/clap #3597</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Required arg with &lt;TYPE&gt; tag and default value always errors in debug build but never in release</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/clap-rs/clap/issues/3597">#3597</a>
        opened by <a href="https://github.com/nbvdkamp">@nbvdkamp</a>
        on 2022-03-31 21:45
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/nbvdkamp">@nbvdkamp</a> on 2022-03-31 21:45</div>
            <div class="timeline-body"><h3>Please complete the following tasks</h3>
<ul>
<li>[X] I have searched the <a href="https://github.com/clap-rs/clap/discussions">discussions</a></li>
<li>[X] I have searched the <a href="https://github.com/clap-rs/clap/issues">open</a> and <a href="https://github.com/clap-rs/clap/issues?q=is%3Aissue+label%3AS-wont-fix+is%3Aclosed">rejected</a> issues</li>
</ul>
<h3>Rust Version</h3>
<p>rustc 1.59.0 (9d1b2106e 2022-02-23)</p>
<h3>Clap Version</h3>
<p>3.1.6</p>
<h3>Minimal reproducible code</h3>
<pre><code class="language-rust">use clap::{arg, Command};

fn main() {
    let matches = Command::new(&quot;&quot;)
            .arg(arg!(--foo &lt;FOO&gt;)
                    .default_value(&quot;default&quot;)
            ).get_matches();
    
    println!(&quot;{}&quot;, matches.value_of(&quot;foo&quot;).unwrap());
}
</code></pre>
<h3>Steps to reproduce the bug with the above code</h3>
<p>These
<code>cargo run -- --foo bar</code>
<code>cargo run --release -- --foo bar</code>
give differing results</p>
<h3>Actual Behaviour</h3>
<p>Running a debug build <code>cargo run -- --foo bar</code> or  <code>cargo run</code> results in:
<code>thread 'main' panicked at 'Argument 'foo' is required and can't have a default value'</code></p>
<p>But running a release build with the flag set <code>cargo run --release -- --foo bar</code> results in:
<code>bar</code>
And leaving the flag out <code>cargo run --release</code> results in:
<code>default</code></p>
<h3>Expected Behaviour</h3>
<p>When running with the flag it should never error. When leaving out the flag I am not certain what the correct behaviour is but it should be consistent between debug and release builds.</p>
<h3>Additional Context</h3>
<p><em>No response</em></p>
<h3>Debug Output</h3>
<p>For <code>cargo run -- --foo bar</code>:</p>
<pre><code>[        clap::build::command]  App::_do_parse
[        clap::build::command]  App::_build
[        clap::build::command]  App::_propagate:
[        clap::build::command]  App::_check_help_and_version:
[        clap::build::command]  App::_check_help_and_version: Removing generated version
[        clap::build::command]  App::_propagate_global_args:
[        clap::build::command]  App::_derive_display_order:
[  clap::build::debug_asserts]  Command::_debug_asserts
[  clap::build::debug_asserts]  Arg::_debug_asserts:help
[  clap::build::debug_asserts]  Arg::_debug_asserts:foo
thread 'main' panicked at 'Argument 'foo' is required and can't have a default value'
</code></pre>
<p>For <code>cargo run --release -- --foo bar</code>:</p>
<pre><code>[        clap::build::command]  App::_do_parse
[        clap::build::command]  App::_build
[        clap::build::command]  App::_propagate:
[        clap::build::command]  App::_check_help_and_version:
[        clap::build::command]  App::_check_help_and_version: Removing generated version
[        clap::build::command]  App::_propagate_global_args:
[        clap::build::command]  App::_derive_display_order:
[         clap::parse::parser]  Parser::get_matches_with
[         clap::parse::parser]  Parser::get_matches_with: Begin parsing 'RawOsString(&quot;--foo&quot;)' ([45, 45, 102, 111, 111])
[         clap::parse::parser]  Parser::get_matches_with: Positional counter...1
[         clap::parse::parser]  Parser::get_matches_with: Low index multiples...false
[         clap::parse::parser]  Parser::possible_subcommand: arg=RawOsStr(&quot;--foo&quot;)
[         clap::parse::parser]  Parser::get_matches_with: sc=None
[         clap::parse::parser]  Parser::parse_long_arg
[         clap::parse::parser]  Parser::parse_long_arg: cur_idx:=1
[         clap::parse::parser]  Parser::parse_long_arg: Does it contain '='...
[         clap::parse::parser]  No
[         clap::parse::parser]  Parser::parse_long_arg: Found valid opt or flag '--foo &lt;FOO&gt;'
[         clap::parse::parser]  Parser::parse_long_arg: Found an opt with value 'None'
[         clap::parse::parser]  Parser::parse_opt; opt=foo, val=None
[         clap::parse::parser]  Parser::parse_opt; opt.settings=ArgFlags(REQUIRED | TAKES_VAL)
[         clap::parse::parser]  Parser::parse_opt; Checking for val...
[         clap::parse::parser]  Parser::parse_opt: More arg vals required...
[         clap::parse::parser]  Parser::remove_overrides: id=[hash: 41CB8A11A30AC4B8]
[    clap::parse::arg_matcher]  ArgMatcher::inc_occurrence_of_arg: id=[hash: 41CB8A11A30AC4B8]
[        clap::build::command]  App::groups_for_arg: id=[hash: 41CB8A11A30AC4B8]
[        clap::build::command]  App::groups_for_arg: id=[hash: 41CB8A11A30AC4B8]
[         clap::parse::parser]  Parser::get_matches_with: After parse_long_arg Opt([hash: 41CB8A11A30AC4B8])
[         clap::parse::parser]  Parser::get_matches_with: Begin parsing 'RawOsString(&quot;bar&quot;)' ([98, 97, 114])
[         clap::parse::parser]  Parser::get_matches_with: Positional counter...1
[         clap::parse::parser]  Parser::get_matches_with: Low index multiples...false
[         clap::parse::parser]  Parser::add_val_to_arg; arg=foo, val=RawOsStr(&quot;bar&quot;)
[         clap::parse::parser]  Parser::add_val_to_arg; trailing_values=false, DontDelimTrailingVals=false
[         clap::parse::parser]  Parser::add_single_val_to_arg: adding val...&quot;bar&quot;
[         clap::parse::parser]  Parser::add_single_val_to_arg: cur_idx:=2
[        clap::build::command]  App::groups_for_arg: id=[hash: 41CB8A11A30AC4B8]
[    clap::parse::arg_matcher]  ArgMatcher::needs_more_vals: o=foo
[      clap::parse::validator]  Validator::validate
[         clap::parse::parser]  Parser::add_defaults
[         clap::parse::parser]  Parser::add_defaults:iter:foo:
[         clap::parse::parser]  Parser::add_value: doesn't have conditional defaults
[         clap::parse::parser]  Parser::add_value:iter:foo: has default vals
[         clap::parse::parser]  Parser::add_value:iter:foo: was used
[         clap::parse::parser]  Parser::add_value:iter:foo: doesn't have default missing vals
[      clap::parse::validator]  Validator::validate_conflicts
[      clap::parse::validator]  Validator::validate_exclusive
[      clap::parse::validator]  Validator::validate_exclusive:iter:[hash: 41CB8A11A30AC4B8]
[      clap::parse::validator]  Validator::validate_conflicts::iter: id=[hash: 41CB8A11A30AC4B8]
[      clap::parse::validator]  Conflicts::gather_conflicts
[      clap::parse::validator]  Validator::validate_required: required=ChildGraph([Child { id: [hash: 41CB8A11A30AC4B8], children: [] }])
[      clap::parse::validator]  Validator::gather_requires
[      clap::parse::validator]  Validator::gather_requires:iter:[hash: 41CB8A11A30AC4B8]
[      clap::parse::validator]  Validator::validate_required_unless
[      clap::parse::validator]  Validator::validate_matched_args
[      clap::parse::validator]  Validator::validate_matched_args:iter:[hash: 41CB8A11A30AC4B8]: vals=Flatten {
    inner: FlattenCompat {
        iter: Fuse {
            iter: Some(
                Iter(
                    [
                        [
                            &quot;bar&quot;,
                        ],
                    ],
                ),
            ),
        },
        frontiter: None,
        backiter: None,
    },
}
[      clap::parse::validator]  Validator::validate_arg_num_vals
[      clap::parse::validator]  Validator::validate_arg_values: arg=&quot;foo&quot;
[      clap::parse::validator]  Validator::validate_arg_num_occurs: &quot;foo&quot;=1
[    clap::parse::arg_matcher]  ArgMatcher::get_global_values: global_arg_vec=[[hash: 59636393CFFBFE5F]]
bar
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">C-bug</span> added by @nbvdkamp on 2022-03-31 21:45</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2022-04-01 01:33</div>
            <div class="timeline-body"><p>As long as the assert is happening in debug mode regardless of what flags get passed in, this is expected behavior.</p>
<p>Asserts are generally a technique for communicating a development error as opposed to a runtime error so long as they are exclusively a development error and don't get in the way of delivering mission critical software.</p>
<p>Debug-only asserts are something done to ensure the development-only assets do not impact end-user performance so long as testing is able to ensure they are never hit or that the release code can handle them not asserting.</p>
<p>Clap has been using debug asserts for a while but to help developers get quicker feedback on these, we added <code>Command::debug_assert</code> for running in tests for clap v3 and put it in our migration guide and in the <a href="https://github.com/clap-rs/clap/blob/v3.1.7/examples/tutorial_builder/README.md#tips">tutorial</a>.</p>
<p>As this is expected behavior, I'm going to go ahead and close.  If my assumption earlier is wrong or if there is something I missed, feel free to let us know!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @epage on 2022-04-01 01:33</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/nbvdkamp">@nbvdkamp</a> on 2022-04-01 12:16</div>
            <div class="timeline-body"><p>Oh I see now, I was developing my app in release builds because testing it is too slow in debug and assumed that this was a bug because it only showed up when I went to debug something and worked as I expected before. Thanks for the quick response.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 01:34:58 UTC
    </footer>
</body>
</html>
