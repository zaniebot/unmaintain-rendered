<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Possible bug with enum fields - clap-rs/clap #4865</title>
    <link rel="stylesheet" href="../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../index.html">Back to index</a>
    </div>

    <h1>Possible bug with enum fields</h1>

    <div class="meta">
        <span class="state state-closed">Closed</span>
        <a href="https://github.com/clap-rs/clap/issues/4865">#4865</a>
        opened by <a href="https://github.com/nerdo">@nerdo</a>
        on 2023-04-27 19:32
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/nerdo">@nerdo</a> on 2023-04-27 19:32</div>
            <div class="timeline-body"><h3>Please complete the following tasks</h3>
<ul>
<li>[X] I have searched the <a href="https://github.com/clap-rs/clap/discussions">discussions</a></li>
<li>[X] I have searched the <a href="https://github.com/clap-rs/clap/issues">open</a> and <a href="https://github.com/clap-rs/clap/issues?q=is%3Aissue+label%3AS-wont-fix+is%3Aclosed">rejected</a> issues</li>
</ul>
<h3>Rust Version</h3>
<p>1.6.9</p>
<h3>Clap Version</h3>
<p>4.2.1</p>
<h3>Minimal reproducible code</h3>
<pre><code class="language-rust">// https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2021&amp;gist=0ba3a366598032fb8252f66cc8b11851
// This could probably be more concise, but I pulled it out of a real-world example and kept the fields in
// because I think it has something to do with dependencies between fields. Demo on the rust playground link above.

use clap::{Parser, ValueEnum}; // 4.2.3

fn main() -&gt; Result&lt;(), anyhow::Error&gt; {
    // This prints out the help as expected because not enough args.
    // let ok1 = [&quot;--dry-run&quot;, &quot;--save-config&quot;];
    // let a1 = EtlConfig::parse_from(ok1.iter());
    // dbg!(&quot;a1 = {?:}&quot;, a1);
    
    // This prints out the help as expected because not enough args.
    // let ok2 = [&quot;--dry-run&quot;, &quot;--save-config&quot;, &quot;--mysql-host&quot;, &quot;localhost&quot;];
    // let a2 = EtlConfig::parse_from(ok2.iter());
    // dbg!(&quot;a2 = {?:}&quot;, a2);
    
    // This panics! --target is required, and is missing here, 
    // but rather than print the help, it panics.
    let panicking_args = [&quot;--dry-run&quot;, &quot;--save-config&quot;, &quot;--mysql-host&quot;, &quot;127.0.0.1&quot;, &quot;--mongo-host&quot;, &quot;127.0.0.1&quot;];
    EtlConfig::parse_from(panicking_args.iter());
    
    Ok(())
}

#[derive(Debug, Copy, Clone, PartialEq, Eq, PartialOrd, Ord, ValueEnum)]
enum TargetDatabase {
    /// MongoDB
    MongoDB,

    /// SurrealDB
    SurrealDB,
}

/// Configuration.
#[derive(Debug, Parser, Clone)]
struct EtlConfig {
    /// Save the configuration.
    ///
    /// If the --config-file option is not set, it will output to STDOUT.
    #[arg(long)]
    save_config: bool,

    /// Load configuration from file.
    ///
    /// If the --config-file option is not set, it will read from STDIN.
    #[arg(long)]
    load_config: bool,

    /// Configuration file to save to or load from.
    #[arg(long)]
    config_file: Option&lt;String&gt;,

    /// Start by resetting the new database and starting from scratch.
    #[arg(long)]
    reset: bool,

    /// Do a dry-run: Don't write to the new database, but do everything else (as much as possible).
    #[arg(long)]
    dry_run: bool,

    /// Target database system.
    #[arg(long, value_enum)]
    target: TargetDatabase,

    /// MySQL (Chili) connection configuration.
    #[command(flatten)]
    mysql: MySqlConfig,

    /// MongoDB connection configuration.
    #[command(flatten)]
    mongo: Option&lt;MongoDbConfig&gt;,

    /// SurrealDB connection configuration.
    #[command(flatten)]
    surreal: Option&lt;SurrealDbConfig&gt;,
}


/// MySql (Chili) Configuration.
#[derive(Debug, Parser,  Clone)]
#[group(multiple = false)]
struct MySqlConfig {
    /// MySQL username.
    #[arg(long, default_value_t = String::from(&quot;chili&quot;))]
    mysql_username: String,

    /// MySQL password.
    #[arg(long, default_value_t = String::from(&quot;chili&quot;))]
    mysql_password: String,

    /// MySQL server host name.
    #[arg(long, default_value_t = String::from(&quot;localhost&quot;))]
    mysql_host: String,

    /// MySQL port.
    #[arg(long, default_value_t = 3306, value_parser = clap::value_parser!(u16).range(1..))]
    mysql_port: u16,

    /// MySQL database.
    #[arg(long, default_value_t = String::from(&quot;chili&quot;))]
    mysql_database: String,
}

/// MongoDB Configuration.
#[derive(Debug, Parser,  Clone)]
#[group(multiple = false, requires(&quot;mongo-db&quot;))]
struct MongoDbConfig {
    /// MongoDB username.
    #[arg(long, default_value_t = String::from(&quot;root&quot;))]
    mongo_username: String,

    /// MongoDB password.
    #[arg(long, default_value_t = String::from(&quot;root&quot;))]
    #[arg(requires_if(&quot;mongo-db&quot;, &quot;target&quot;))]
    mongo_password: String,

    /// MongoDB server host name.
    #[arg(long, default_value_t = String::from(&quot;localhost&quot;))]
    #[arg(requires_if(&quot;mongo-db&quot;, &quot;target&quot;))]
    mongo_host: String,

    /// MongoDB port.
    #[arg(long, default_value_t = 27017, value_parser = clap::value_parser!(u16).range(1..))]
    #[arg(requires_if(&quot;mongo-db&quot;, &quot;target&quot;))]
    mongo_port: u16,

    /// MongoDB database.
    #[arg(long, default_value_t = String::from(&quot;reaper&quot;))]
    #[arg(requires_if(&quot;mongo-db&quot;, &quot;target&quot;))]

    mongo_database: String,
}

/// SurrealDB Configuration.
#[derive(Debug, Parser,  Clone)]
#[group(multiple = false, requires(&quot;surreal-db&quot;))]
struct SurrealDbConfig {
    /// SurrealDB username.
    #[arg(long, default_value_t = String::from(&quot;root&quot;))]

    surreal_username: String,

    /// SurrealDB password.
    #[arg(long, default_value_t = String::from(&quot;root&quot;))]
    #[arg(requires_if(&quot;surreal-db&quot;, &quot;target&quot;))]

    surreal_password: String,

    /// SurrealDB server host name.
    #[arg(long, default_value_t = String::from(&quot;localhost&quot;))]
    #[arg(requires_if(&quot;surreal-db&quot;, &quot;target&quot;))]

    surreal_host: String,

    /// SurrealDB port.
    #[arg(long, default_value_t = 8000, value_parser = clap::value_parser!(u16).range(1..))]
    #[arg(requires_if(&quot;surreal-db&quot;, &quot;target&quot;))]

    surreal_port: u16,

    /// SurrealDB namespace.
    #[arg(long, default_value_t = String::from(&quot;reaper&quot;))]
    #[arg(requires_if(&quot;surreal-db&quot;, &quot;target&quot;))]

    surreal_namespace: String,

    /// SurrealDB database.
    #[arg(long, default_value_t = String::from(&quot;reaper&quot;))]
    #[arg(requires_if(&quot;surreal-db&quot;, &quot;target&quot;))]

    surreal_database: String,
}
</code></pre>
<h3>Steps to reproduce the bug with the above code</h3>
<p>Run the code in the playground.</p>
<p>There are some commented out sections of code, with descriptions to illustrate other behavior. This ticket documents the code as it currently stands, though.</p>
<h3>Actual Behaviour</h3>
<p>Code panics and crashes during parsing.</p>
<h3>Expected Behaviour</h3>
<p>I expected to see the help screen saying that --target is a required field.</p>
<h3>Additional Context</h3>
<p><em>No response</em></p>
<h3>Debug Output</h3>
<p><em>No response</em></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">C-bug</span> added by @nerdo on 2023-04-27 19:32</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/4867.html">clap-rs/clap#4867</a> on 2023-04-27 23:45</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2023-04-27 23:49</div>
            <div class="timeline-body"><p>The application bug is the following two lines:</p>
<pre><code class="language-rust">#[group(multiple = false, requires(&quot;mongo-db&quot;))]
// ...
#[group(multiple = false, requires(&quot;surreal-db&quot;))]
// ...
</code></pre>
<p>The <code>MongoDbConfig</code> is requiring that a group or argument named <code>mongo-db</code> to be present but nothing exists with that ID.  The same with <code>surreal-db</code>.</p>
<p>I have a PR up for improving the error messages for this</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @epage on 2023-04-27 23:57</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/nerdo">@nerdo</a> on 2023-04-28 13:36</div>
            <div class="timeline-body"><p>Ah, I think I wrote that in attempt to make those fields required if surreal or mongo were selected as the target respectively, but I obviously did it wrong - and honestly, forgot I even had that there. Thanks for the feedback. And thanks for adding the PR improving the error message. I had no idea what the issue was.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:28:34 UTC
    </footer>
</body>
</html>
