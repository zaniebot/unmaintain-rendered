```yaml
number: 2893
title: "derive: env! doesn't work with custom build variables"
type: issue
state: closed
author: ajeetdsouza
labels:
  - C-bug
  - A-derive
assignees: []
created_at: 2021-10-16T12:12:09Z
updated_at: 2021-10-16T20:51:46Z
url: https://github.com/clap-rs/clap/issues/2893
synced_at: 2026-01-10T01:57:45Z
```

# derive: env! doesn't work with custom build variables

---

_Issue opened by @ajeetdsouza on 2021-10-16 12:12_

### Please complete the following tasks

- [X] I have searched the [discussions](https://github.com/clap-rs/clap/discussions)
- [X] I have searched the existing issues

### Rust Version

rustc 1.55.0 (c8dfcfe04 2021-09-06)

### Clap Version

3.0.0-beta.4

### Minimal reproducible code

Set `APP_VERSION` in `build.rs`:

```rust
println!("cargo:rustc-env=APP_VERSION={}", version);
```

Now create an app in `main.rs`:

```rust
#[derive(Clap, Debug)]
#[clap(version = env!("APP_VERSION")]
struct App {}
```

### Steps to reproduce the bug with the above code

`cargo run`

### Actual Behaviour

You get an error: `environment variable `APP_VERSION` not defined

### Expected Behaviour

Try `env!("APP_VERSION")` in your `main.rs` and it works. So it should also work in clap.

### Additional Context

_No response_

### Debug Output

_No response_

---

_Label `T: bug` added by @ajeetdsouza on 2021-10-16 12:12_

---

_Comment by @pksunkara on 2021-10-16 12:46_

Does it work with normal clap builder?

---

_Label `C: derive macros` added by @pksunkara on 2021-10-16 12:46_

---

_Comment by @epage on 2021-10-16 15:16_

I can't reproduce this

`Cargo.toml`
```toml
[package]
name = "test-clap"
version = "0.1.0"
edition = "2018"

# See more keys and their definitions at https://doc.rust-lang.org/cargo/reference/manifest.html

[dependencies]
clap = { path = "../clap", features = [] }
#clap = { path = "../clap", features = ["debug"] }
#clap = { version = "2" }
clap_generate = { path = "../clap/clap_generate", features = [] }
```

`build.rs`
```rust
fn main() {
    let version = "200";
    println!("cargo:rustc-env=APP_VERSION={}", version);
}
```

`src/main.rs`
```rust
use clap::{Args, Parser};

#[derive(Parser, PartialEq, Debug)]
#[clap(version = std::env!("APP_VERSION"))]
struct Opt {
    #[clap(flatten)]
    common: Common,
}

#[derive(Args, PartialEq, Debug)]
struct Common {
    arg: i32,
}

fn main() {
    dbg!(std::env!("APP_VERSION"));
    Opt::parse();
}
```

```
‚ùØ cargo run -- --help
   Compiling test-clap v0.1.0 (/home/epage/src/personal/test-clap)
    Finished dev [unoptimized + debuginfo] target(s) in 0.70s
     Running `target/debug/test-clap --help`
[src/main.rs:16] std::env!("APP_VERSION") = "200"
test-clap 200

USAGE:
    test-clap <ARG>

ARGS:
    <ARG>    

OPTIONS:
    -h, --help       Print help information
    -V, --version    Print version information
```

---

_Closed by @pksunkara on 2021-10-16 15:27_

---

_Comment by @ajeetdsouza on 2021-10-16 20:51_

Figured out why this was happening. I'm importing the same module into my `build.rs` in order to generate completions. Since the environment variable set by `build.rs` itself is obviously not available to it at compile time, it throws an error.

I've replaced it with `version = option_env!("APP_VERSION").unwrap_or_default()`, since completions don't really require a version anyway. Thanks!

---

_Referenced in [clap-rs/clap#3175](../../clap-rs/clap/pulls/3175.md) on 2021-12-14 16:30_

---
