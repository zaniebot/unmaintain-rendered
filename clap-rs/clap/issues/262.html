<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clap panics on argument in invalid unicode - clap-rs/clap #262</title>
    <link rel="stylesheet" href="../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../index.html">Back to index</a>
    </div>

    <h1>Clap panics on argument in invalid unicode</h1>

    <div class="meta">
        <span class="state state-closed">Closed</span>
        <a href="https://github.com/clap-rs/clap/issues/262">#262</a>
        opened by <a href="https://github.com/remram44">@remram44</a>
        on 2015-09-21 14:24
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/remram44">@remram44</a> on 2015-09-21 14:24</div>
            <div class="timeline-body"><p>I can understand your library not being designed to handle arguments that are not valid unicode (which are possible on UNIX, and can be valid filenames, but heh), however having your library panic the calling thread is not cool. Please consider using Result instead of crashing.</p>
<p>Reproduce:</p>
<pre><code>echo -e 'r\xE9mi' | xargs target/debug/myprogramusingclap
</code></pre>
<p>(note that you can't use <code>cargo run</code>, it can't handle unicode either (but at least it doesn't panic))</p>
<p>Similar to https://github.com/rust-lang/getopts/pull/30; I'm still looking for a safe argument-parsing library :cry:</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">T: bug</span> added by @sru on 2015-09-21 14:27</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">C: args</span> added by @sru on 2015-09-21 14:27</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sru">@sru</a> on 2015-09-21 15:01</div>
            <div class="timeline-body"><p>Caused by <a href="http://doc.rust-lang.org/std/env/fn.args.html"><code>std::env::Args</code></a>.</p>
<p>Using <code>std::env::ArgsOs</code> does not solve this issue because the <code>get_matches_*</code> functions take <code>AsRef&lt;str&gt;</code>, not <code>AsRef&lt;OsStr&gt;</code>. I tried to change all of them to <code>AsRef&lt;OsStr&gt;</code>, but it did not work.</p>
<p>One solution could be: If the argument passed is not valid unicode, we could first check if it is a valid directory or file. If it isn't, then produce error.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/WildCryptoFox">@WildCryptoFox</a> on 2015-09-21 16:28</div>
            <div class="timeline-body"><p>@remram44 Would you be okay with <code>OsStr::to_string_lossy</code>?</p>
<blockquote>
<p>Any non-Unicode sequences are replaced with U+FFFD REPLACEMENT CHARACTER.</p>
</blockquote>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/remram44">@remram44</a> on 2015-09-21 17:16</div>
            <div class="timeline-body"><p>I think it's kind of weird -- in the Rust stdlib, lossy functions are clearly marked as such, and that is not the case of <code>get_matches()</code>. If a filename is mangled this way, the application will not access the correct pass, and thus fail with a surprising &quot;file not found&quot; or worse, go on creating the wrong file (with a replacement character in it). On the other hand you can't easily change your API at this point, and this behavior is better than panicking(?)</p>
<p>Another option is to make <a href="http://kbknapp.github.io/clap-rs/clap/struct.App.html#method.get_matches_safe">get_matches_safe()</a> return an error (not panic) on invalid unicode, and get_matches() print out a readable error message instead of the default panic text.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/WildCryptoFox">@WildCryptoFox</a> on 2015-09-21 17:22</div>
            <div class="timeline-body"><blockquote>
<p>On the other hand you can't easily change your API at this point</p>
</blockquote>
<p>@remram44 <em>cough</em> I'm rewriting the entire clap-rs in #259, I'm open for changes like this. I am however, so far having lifetime issues when trying to use <code>OsStr</code>. ;-)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/WildCryptoFox">@WildCryptoFox</a> on 2015-09-21 17:44</div>
            <div class="timeline-body"><p>@remram44 Partly tested (compiles; no tests for invalid Unicode chars yet) I have <code>to_string_lossy</code> working in my code. Now we can use <code>OsArgs</code>. <strong>Note</strong>: This is for my <code>2.0</code> rewrite <strong>NOT</strong> <code>1.4</code>.</p>
<p>I might take an attempt to porting it over to <code>clap1.4</code> tomorrow.</p>
<p>Snapshot of current code for <code>2.0</code>: https://gist.github.com/7897c09aab4186186576</p>
<ul>
<li>Lossy matching prevents flags and positional arguments from containing the invalid Unicode (in raw form). While in <code>--foo &lt;arg&gt;</code>, arg may contain invalid Unicode.</li>
</ul>
<hr />
<p>I'm out for the night. zzZZZ</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/259.html">clap-rs/clap#259</a> on 2015-09-21 17:52</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/kbknapp">@kbknapp</a> on 2015-09-21 23:35</div>
            <div class="timeline-body"><p>@remram44 Returning a Result on invalid unicode should be an easy addition. If this works for you we can probably have this added by tomorrow with a new version out to crates.io</p>
<p>It would also be easy to add a <code>*_lossy()</code> version to the <code>get_matches()</code> family. We're also open for some discussion on what <code>clap2x</code>'s unicode handling will look like as stated by @james-darkfox</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">T: enhancement</span> added by @kbknapp on 2015-09-21 23:36</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">D: easy</span> added by @kbknapp on 2015-09-21 23:36</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">P3: want to have</span> added by @kbknapp on 2015-09-21 23:36</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sru">@sru</a> on 2015-09-22 01:54</div>
            <div class="timeline-body"><p>@kbknapp If we were to add this, we have to change the function signature of <code>get_matches</code> families to take iterator of <code>AsRef&lt;OsStr&gt;</code>. Is that okay?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/265.html">clap-rs/clap#265</a> on 2015-09-22 02:08</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/kbknapp">@kbknapp</a> on 2015-09-22 02:18</div>
            <div class="timeline-body"><p>@sru Yep that's exactly what I did in #265 which doesn't affect things too heavily. I compared benches before and after, and no tests had to be changed to accommodate.</p>
<p>I've heard it said that, &quot;All <code>str</code>s are <code>OsStr</code>s, but not all <code>OsStr</code>s are <code>str</code>s&quot;...if you like logic questions :wink:</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/kbknapp">@kbknapp</a> on 2015-09-22 02:23</div>
            <div class="timeline-body"><p>@remram44 #265 allows returning a Result <code>Err</code> on invalid unicode chars, or an optional lossy version. Granted this doesn't help with things like path/file names which have invalid unicode, but it's better than the current state of <code>clap</code> because it won't <code>panic!</code> unless you don't care about it or want it to <code>panic!</code> on invalid unicode.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/WildCryptoFox">@WildCryptoFox</a> on 2015-09-22 05:00</div>
            <div class="timeline-body"><p>@kbknapp Just a tip: <code>str</code> and <code>OsStr</code> both implement <code>AsRef&lt;OsStr&gt;</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/remram44">@remram44</a> on 2015-09-22 05:02</div>
            <div class="timeline-body"><p><code>OsStr</code> doesn't implement <code>AsRef&lt;str&gt;</code>, no.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/WildCryptoFox">@WildCryptoFox</a> on 2015-09-22 05:20</div>
            <div class="timeline-body"><p>Oops. My haste. Sorry. <em>edited previous comment</em> Thanks.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/kbknapp">@kbknapp</a> on 2015-09-22 12:28</div>
            <div class="timeline-body"><p>@remram44 try the latest master and let us know if it works for your use case. If so, we'll publish a new version to crates.io, close this issue, and open a more general unicode handling tracking issue.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/kbknapp">@kbknapp</a> on 2015-09-22 17:52</div>
            <div class="timeline-body"><p>@remram44 v1.4.1 is out on crates.io now which adds the safer <code>*_safe()</code> methods and <code>*_lossy()</code> version of the <code>get_matches</code> family.</p>
<p>See #269 for general invalid unicode discussion for the future</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @kbknapp on 2015-09-25 23:18</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:28:31 UTC
    </footer>
</body>
</html>
