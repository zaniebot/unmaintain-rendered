<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Can we have a `Arg::validate_with(self, Box&lt;Validator&gt;) -&gt; Self` function? - clap-rs/clap #572</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Can we have a <code>Arg::validate_with(self, Box&lt;Validator&gt;) -&gt; Self</code> function?</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/clap-rs/clap/issues/572">#572</a>
        opened by <a href="https://github.com/matthiasbeyer">@matthiasbeyer</a>
        on 2016-07-06 13:13
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/matthiasbeyer">@matthiasbeyer</a> on 2016-07-06 13:13</div>
            <div class="timeline-body"><p>I have a use-case where it would be nice to be able to pass custom data to the validator (mainly for passing the error message).</p>
<p>My use-case is: I want to write a validator which checks an argument for whether it is a path and whether this path exists. If the path does not exist, is not readable ... etc, I want to return an appropriate error message.
I want to implement this functionality in a sub-crate of my project and I want to do it generically, so one has only to construct an object and tell it &quot;if the validation fails, use this error message: 'someerrorhappened'&quot;. I could then use this type to tell clap &quot;Hey, use this as validator&quot;. I would have the benefit that I would write the validation function once, but still have a bit of dynamic in creating my error messages.</p>
<hr />
<p>I propose a trait</p>
<pre><code class="language-rust">pub trait Validator {
    fn (&amp;self, String) -&gt; Result&lt;(), String&gt;;
}
</code></pre>
<p>and a function on <code>Arg</code>:</p>
<pre><code class="language-rust">pub fn validate_with(self, Box&lt;Validator&gt;) -&gt; Self;
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/573.html">clap-rs/clap#573</a> on 2016-07-06 13:13</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/kbknapp">@kbknapp</a> on 2016-07-23 18:42</div>
            <div class="timeline-body"><p>Apologies for how long it's taken me to get to this, I've been travelling.</p>
<p>I might be misunderstanding what you're trying to do, but the current implementation should allow for that already unless you're talking about not knowing the function beforehand. i.e. the difference in what you're proposing, is using dynamic dispatch of a trait object instead of statically dispatching to a particular function. If it's something other than this, please elaborate.</p>
<p>If using dynamic dispatch is truly what you're wanting to do, I'm not opposed to adding that, but I'd want to name it something less...overlapping? Or we'd have to really document well what the difference is and when to use each.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/matthiasbeyer">@matthiasbeyer</a> on 2016-07-24 11:26</div>
            <div class="timeline-body"><p>The point is simply to be able to pass context to the validator function.</p>
<p>For example, if I have an argument which gets a path, I might want to check whether this path exists. But I also might want to check whether this is a file, is readable, is not longer than 100kloc, etc. This could all be done by one validator function, yes. But if my App runs in different states, I might not mind if the file is above 100kloc or even readable (for example if I have a <code>--dry-run</code> where I do not touch external files at all).</p>
<p>One way how to solve the problem from above is using several validator functions, each function for one of the requirements. Another one would be to be able to pass state to the validator function.</p>
<p>I thought the latter would be a bit nicer, so I started to implement it in #573. I hope I did not overlook an already existing functionality with this! :smile:</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ssokolow">@ssokolow</a> on 2017-02-12 01:07</div>
            <div class="timeline-body"><p>I was actually about to open an issue with a similar goal.</p>
<p>In my case, I have some validators which could be generic (things like &quot;path is readable&quot;) but they're not because I need my error messages to indicate which argument is failing validation. (And I don't care how it's achieved, as long as the result is acceptably easy for users to understand.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">T: enhancement</span> added by @kbknapp on 2018-07-22 00:52</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">P4: nice to have</span> added by @kbknapp on 2018-07-22 00:52</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">D: intermediate</span> added by @kbknapp on 2018-07-22 00:52</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">W: 3.x</span> added by @kbknapp on 2018-07-22 00:52</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">C: validators</span> added by @kbknapp on 2018-07-22 00:52</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone "3.1" by @pksunkara on 2020-02-05 08:36</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/pksunkara">@pksunkara</a> on 2020-04-09 06:46</div>
            <div class="timeline-body"><p>Related to #1471</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/bradwood">@bradwood</a> on 2020-06-25 21:10</div>
            <div class="timeline-body"><p>FWIW, I'm quite keen on this feature as well. Not so much dynamic dispatch per se, but more simply the ability to be able to pass in a parameter of my own choosing to the validator <em>in addition</em> to the what clap itself passes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/CreepySkeleton">@CreepySkeleton</a> on 2020-06-25 22:12</div>
            <div class="timeline-body"><p>I see that we've got <em>two</em> different questions on the table here:</p>
<ol>
<li><p>Using trait objects vs using multiple functions</p>
<pre><code class="language-rust">// -------------
// Multiple fns

fn path_exists(s: &amp;str);

fn do_nothing(s: &amp;str);

if dry_run {
    app.validator(do_nothing)
} else {
    app.validator(path_exists)
}

// --------------
// Trait objects

struct PathExists;
struct DoNothing;

impl clap::Validator for PathExists {}
impl clap::Validator for DoNothing {}

if dry_run {
    app.validator(Box::new(DoNothing))
} else {
    app.validator(Box::new(PathExists))
}
</code></pre>
<p>I don't see <em>any</em> difference. Arguably, multiple fns are better.</p>
</li>
<li><p>Ability to pass some user-defined context to the validator. Guys, maybe I'm missing something and is about to say something stupid again, but why can't you just... <em>capture the context</em>???</p>
<pre><code class="language-rust">let context = Something;

app.validator(move |arg| {
    // context has been moved here 
    println!(&quot;{}&quot;, context);
})
</code></pre>
</li>
</ol>
<p>Maybe we could add <code>validator_mut(FnMut() -&gt; Result)</code> if somebody out there needs to <em>mutate</em> the context data, but otherwise I see this as a completely made up problem.</p>
<p>@ssokolow @bradwood @matthiasbeyer To avoid haunting ghosts, can somebody supply a code snippet that is of an issue? Something that you'd like to do, but it's either currently impossible or possible but too cumbersome? The snippet should also reveal how trait objects could have solved the issue.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ssokolow">@ssokolow</a> on 2020-06-25 22:28</div>
            <div class="timeline-body"><p>It's been over three years and I can't remember what situation I specifically needed this for, given that the simple case is adequately satisfied by how Clap prefixes the validator-returned message with <code>Invalid value for '&lt;placeholder name&gt;':</code></p>
<p>Heck, given that I've moved to StructOpt (and am about to test out Clap 3.x's derive API), it'd probably be a good idea to think up a more declarative-API-friendly solution to custom messages for generic validators anyway if such a feature comes to pass.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/CreepySkeleton">@CreepySkeleton</a> on 2020-06-25 22:52</div>
            <div class="timeline-body"><blockquote>
<p>generic validators</p>
</blockquote>
<p>I suppose your understanding of what &quot;generic validators&quot; being is different from mine. Could you elaborate? Preferably with (pseudo) code examples.</p>
<p>Why and in what do you see validators being not flexible or friendly enough for the derive?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ssokolow">@ssokolow</a> on 2020-06-26 00:01</div>
            <div class="timeline-body"><p>By &quot;generic validators&quot;, I mean things like <code>path_readable_file</code> in the <a href="https://github.com/ssokolow/rust-cli-boilerplate/blob/master/template/src/validators.rs"><code>validators.rs</code></a> from my rust-cli-boilerplate. Reusable validators designed for recurring roles.</p>
<p>(Once I've got things cleaned up, I want to flesh that out into a collection of them and split it out into a crate for others to use independent of my project boilerplate.)</p>
<p>For example, I might have a script which takes two or three positional arguments and want more than just the <code>&lt;metavar&gt;</code> in the clap-provided error prefix to clarify what the value should be.</p>
<p>In that context, I envision defining a wrapper for each validator assignment, just to alter the error message, will result in both a cluttered <code>.rs</code> file and cluttered <code>cargo doc</code> output.</p>
<p>(Also, please excuse the mess in <code>validators.rs</code>. I let rust-cli-boilerplate languish for a while and I've only started to clean it up now.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/CreepySkeleton">@CreepySkeleton</a> on 2020-06-30 09:27</div>
            <div class="timeline-body"><blockquote>
<p>For example, I might have a script which takes two or three positional arguments and want more than just the <metavar> in the clap-provided error prefix to clarify what the value should be.</p>
</blockquote>
<p>And that's a <em>third</em> question on the table, and I think it's quite irrelevant to trait objects - clap would use it's own prefix indefinitely. I suggest you to open a separate issue for that.</p>
<p>From what I've picked from <code>validators.rs</code>, I can see you use the &quot;multiple fns&quot; approach, but I really fail to see how trait objects could help you there. (Frankly, I don't really get what you need help with...)</p>
<p>OK, let's wait a bit for the other participants supply their input. Otherwise I'll proceed to closing this issue as &quot;maintainers don't get what the request is&quot;.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ssokolow">@ssokolow</a> on 2020-07-01 21:18</div>
            <div class="timeline-body"><p>I wasn't specifically talking about trait objects. I was explaining a use case which, ideally, shouldn't require that a second feature be implemented, given the overlap. (Both involve the desire to specify a custom error message for a specific use of a general-purpose validator.)</p>
<p>If anything, it was an argument to not settle on the idea of using trait objects too quickly.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/CreepySkeleton">@CreepySkeleton</a> on 2020-07-01 22:23</div>
            <div class="timeline-body"><p>@ssokolow Here's your problem as I perceive it:</p>
<p>Clap validators don't have the full control over the error message displayed. The message consists of two parts: the <code>Invalid value for &lt;arg_name&gt;: </code> prefix, and the string returned from the validator as <code>Err</code>. Validators have full control over the latter - they produce it, but they have no control over the prefix which is displayed no matter what.</p>
<p>Your desire is to modify (or just omit) the prefix. Is my understanding correct? If so, this is unrelated to the issue (which is totally about trait objects that can't possibly help you with it), and I urge you to open a separate issue for that if you want it to be addressed.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ssokolow">@ssokolow</a> on 2020-07-02 03:27</div>
            <div class="timeline-body"><blockquote>
<p>Your desire is to modify (or just omit) the prefix. Is my understanding correct?</p>
</blockquote>
<p>No, my desire is to minimize the boilerplate involved in per-field customization of failure messages on fields that share the same stock validator.</p>
<p>I mentioned it here because the initial poster's rationale is:</p>
<blockquote>
<p>I have a use-case where it would be nice to be able to pass custom data to the validator (mainly for passing the error message).</p>
</blockquote>
<p>...and that's how I'd have accomplished it in Python.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/1998.html">clap-rs/clap#1998</a> on 2020-07-02 03:35</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/CreepySkeleton">@CreepySkeleton</a> on 2020-07-02 03:40</div>
            <div class="timeline-body"><blockquote>
<p>I have a use-case where it would be nice to be able to pass custom data to the validator (mainly for passing the error message).</p>
</blockquote>
<p>And then we're back to the question of why you can't just capture the &quot;custom data&quot; in the closure. I took a closer look and found that the validator fns have <code>'static</code> restraint, thus making captures virtually useless. In the linked PR above, I tried to address the issue, and from now on you should be able to just use closures. I'll add an example shortly.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/CreepySkeleton">@CreepySkeleton</a> on 2020-07-02 03:50</div>
            <div class="timeline-body"><p>@ssokolow Do you need the ability to mutate the context? Is <code>impl Fn</code> enough or you need <code>FnMut</code>? I'm asking because mutable would conflict with <code>Send + Sync</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/CreepySkeleton">@CreepySkeleton</a> on 2020-07-02 03:57</div>
            <div class="timeline-body"><p>Ugh, I'm struggling to come up with a meaningful example. @ssokolow Could use your help here.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ssokolow">@ssokolow</a> on 2020-07-02 06:25</div>
            <div class="timeline-body"><p>Assuming you want something minimal enough that a working example could be presented in compact form, you could do a generic &quot;positive, non-zero integer&quot; validator where the failure message is overridden to something specific like &quot;Number of archive volumes must be a positive integer&quot;.</p>
<p>It's most useful when the placeholder from <code>--help</code> that clap automatically adds to the message prefix is required to be somewhat opaque or vague in the name of conciseness.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/CreepySkeleton">@CreepySkeleton</a> on 2020-07-02 08:34</div>
            <div class="timeline-body"><p>I mean something that would demonstrate usefulness of the context, I can't come up with an example that doesn't look made up. Since you were asking for the context passing ability, I assume you have a good idea of what the example might be. It doesn't have to be too concise, 50 (or maybe even 100) LOC will do.</p>
<p>And what about the mutability problem? Right now, you can only have an immutable (shared) reference to the captured context, and it doesn't allow you to mutate anything. Interior mutability won't help you too, because the validator has to be <code>Send + Sync</code>. I'm actively working on it ATM and I think this can be solved with a mutex, but I'd rather like to avoid over-engineering if it isn't really needed.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ssokolow">@ssokolow</a> on 2020-07-04 11:05</div>
            <div class="timeline-body"><p>I'll see what I can do, but life has been busy the last few days and I haven't even been able to get to things I specifically chose to take on in as timely a fashion as I expected.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ssokolow">@ssokolow</a> on 2020-07-17 09:23</div>
            <div class="timeline-body"><p>Sorry for going silent. One of my hard drives started to give signs that it may fail soon, and I'm due for a bunch of hardware replacement anyway (eg. can you believe I still don't have an SSD?), so, I've been busy double-checking my backups and preparing for an all-at-once large-scale system upgrade when the new hardware arrives.</p>
<p>I'll let you know once I'm ready to give you something.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/CreepySkeleton">@CreepySkeleton</a> on 2020-07-17 16:48</div>
            <div class="timeline-body"><blockquote>
<p>can you believe I still don't have an SSD</p>
</blockquote>
<p>Mate, I found you. We should unite and start a new brand movement &quot;weirdos who don't upgrade hardware while it works fine&quot;. Affiliate it with bitcoin and bigdata and the world will succumb!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ssokolow">@ssokolow</a> on 2020-07-17 19:21</div>
            <div class="timeline-body"><p>*chuckle* I wouldn't say &quot;works fine&quot;. It's quite annoying when my nightly backups push everything out of the disk cache and the system then chugs as I have to deal with the consequences of having so many of my applications depending on a forest of small files that need to be seek-time'd back into the cache from all around the platter.</p>
<p>That, and I have another drive from the same production run in one of my machines that started to get bad sectors, so no need to play chicken with it and risk losing data added since the last nightly incremental. (They've both been running more or less 24/7 since 2007.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/CreepySkeleton">@CreepySkeleton</a> on 2020-09-15 09:26</div>
            <div class="timeline-body"><p>Well, I think the &quot; be able to pass context to the validator function.&quot; is solved now.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @CreepySkeleton on 2020-09-15 09:26</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 12:31:38 UTC
    </footer>
</body>
</html>
