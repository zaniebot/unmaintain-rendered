<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>With derive(ValueEnum), the rename_all attribute is silently ignored when the value is not a string literal - clap-rs/clap #3907</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>With derive(ValueEnum), the rename_all attribute is silently ignored when the value is not a string literal</h1>

    <div class="meta">
        <span class="state state-closed">Closed</span>
        <a href="https://github.com/clap-rs/clap/issues/3907">#3907</a>
        opened by <a href="https://github.com/jturner314-nrl">@jturner314-nrl</a>
        on 2022-07-11 21:48
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/jturner314-nrl">@jturner314-nrl</a> on 2022-07-11 21:48</div>
            <div class="timeline-body"><h3>Please complete the following tasks</h3>
<ul>
<li>[X] I have searched the <a href="https://github.com/clap-rs/clap/discussions">discussions</a></li>
<li>[X] I have searched the <a href="https://github.com/clap-rs/clap/issues">open</a> and <a href="https://github.com/clap-rs/clap/issues?q=is%3Aissue+label%3AS-wont-fix+is%3Aclosed">rejected</a> issues</li>
</ul>
<h3>Rust Version</h3>
<p>rustc 1.62.0 (a8314ef7d 2022-06-27)</p>
<h3>Clap Version</h3>
<p>3.2.8</p>
<h3>Minimal reproducible code</h3>
<pre><code class="language-rust">use clap::ValueEnum;

#[derive(Clone, Debug, ValueEnum)]
#[clap(rename_all = verbatim)]
pub enum Enum {
    Var1,
    Var2,
}

fn main() {
    assert_eq!(
        vec![&quot;Var1&quot;, &quot;Var2&quot;],
        Enum::value_variants()
            .iter()
            .map(|var| var.to_possible_value().unwrap().get_name())
            .collect::&lt;Vec&lt;_&gt;&gt;()
    );
    println!(&quot;hi&quot;);
}
</code></pre>
<p>(<a href="https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2021&amp;gist=8b4b96852b4c67d7eb714dcace64981a">Rust Playground</a>)</p>
<h3>Steps to reproduce the bug with the above code</h3>
<p><code>cargo run</code></p>
<h3>Actual Behaviour</h3>
<p>The <code>#[clap(rename_all = verbatim)]</code> attribute is silently ignored, so <code>clap</code> uses the default <code>kebab-case</code> instead, and the program panics:</p>
<pre><code>thread 'main' panicked at 'assertion failed: `(left == right)`
  left: `[&quot;Var1&quot;, &quot;Var2&quot;]`,
 right: `[&quot;var1&quot;, &quot;var2&quot;]`', src/main.rs:11:5
note: run with `RUST_BACKTRACE=1` environment variable to display a backtrace
</code></pre>
<h3>Expected Behaviour</h3>
<p>There should be a compilation error/warning to notify the user that <code>clap</code> doesn't understand the attribute and is ignoring it. In general, <code>clap</code> should warn the user about anything in <code>#[clap(...)]</code> which it doesn't understand.</p>
<h3>Additional Context</h3>
<p>The user can fix the issue in this particular example by replacing <code>verbatim</code> with <code>&quot;verbatim&quot;</code>, but:</p>
<ul>
<li>The user may not even realize that the attribute is ignored until they try running the program and using the enum.</li>
<li>It's not obvious what the problem is, since there's no warning/error. Additionally, the <a href="https://github.com/clap-rs/clap/blob/v3.2.8/examples/derive_ref/README.md">derive reference</a> doesn't make it very obvious that quotes are needed, aside from saying that the right side of the <code>=</code> is an <code>&lt;expr&gt;</code>. (I'm about to create a PR to clarify the reference in this area.)</li>
</ul>
<h3>Debug Output</h3>
<p>Adding the <code>debug</code> feature has no effect.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">C-bug</span> added by @jturner314-nrl on 2022-07-11 21:48</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/3908.html">clap-rs/clap#3908</a> on 2022-07-11 21:50</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2022-07-11 21:57</div>
            <div class="timeline-body"><p>So <code>rename_all</code> only accepts literals.  Otherwise, we turn it into a method call.  For <code>ValueEnum</code>, we apparently don't call the methods, causing this to fail silently.</p>
<p>Always a weird one on when to consider a bug a breaking change.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">E-easy</span> added by @epage on 2022-07-11 21:57</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">A-derive</span> added by @epage on 2022-07-11 21:57</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">E-help-wanted</span> added by @epage on 2022-09-20 14:30</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/anshulrgoyal">@anshulrgoyal</a> on 2022-09-24 22:39</div>
            <div class="timeline-body"><p>@epage Adding something like this should work for compilation error for <code>renam_all</code>.</p>
<pre><code class="language-rust"> match input.parse::&lt;Expr&gt;() {
                    Ok(expr) =&gt; match &amp;*name_str {
                        &quot;skip&quot; =&gt; Ok(Skip(name, Some(expr))),
                        &quot;default_value_t&quot; =&gt; Ok(DefaultValueT(name, Some(expr))),
                        &quot;default_values_t&quot; =&gt; Ok(DefaultValuesT(name, expr)),
                        &quot;default_value_os_t&quot; =&gt; Ok(DefaultValueOsT(name, Some(expr))),
                        &quot;default_values_os_t&quot; =&gt; Ok(DefaultValuesOsT(name, expr)),
                        &quot;next_display_order&quot; =&gt; Ok(NextDisplayOrder(name, expr)),
                        &quot;next_help_heading&quot; =&gt; Ok(NextHelpHeading(name, expr)),
                        &quot;help_heading&quot; =&gt; Ok(HelpHeading(name, expr)),
                        &quot;rename_all&quot; =&gt; abort!(assign_token,&quot;expected `string literal` for rename_all&quot;),
                        _ =&gt; Ok(NameExpr(name, expr)),
                    },

                    Err(_) =&gt; abort! {
                        assign_token,
                        &quot;expected `string literal` or `expression` after `=`&quot;
                    },
                }

</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2022-09-26 12:00</div>
            <div class="timeline-body"><p>Forgot about this issue; it was fixed along with some clap v4 changes</p>
<ul>
<li>https://github.com/clap-rs/clap/blob/master/clap_derive/src/item.rs#L790 to ensure we only accept string literals</li>
<li>https://github.com/clap-rs/clap/blob/master/clap_derive/src/item.rs#L106 to ensure <code>#[value(...)]</code> attributes aren't accepted on the enum itself.</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @epage on 2022-09-26 12:00</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/anshulrgoyal">@anshulrgoyal</a> on 2022-09-26 12:13</div>
            <div class="timeline-body"><p>Shouldn't we add a check for v3 since not everyone will update to v4 immediately.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2022-09-26 12:52</div>
            <div class="timeline-body"><p>As we are on the cusp of the v4 release, v3 is going into maintenance mode.  At the moment, the policy will be only trivial backports.  This is not a trivial back port but would require a re-implementation, even if trivial.  Besides reducing maintenance work, this also helps lower risk for clap 3 users.  For example, I already brought up in this thread that I was unsure whether to consider this a breaking change because we'd be taking a working case to a failing case.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../yurikrupnik/lili1/pulls/10.html">yurikrupnik/lili1#10</a> on 2025-08-10 18:28</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:35:08 UTC
    </footer>
</body>
</html>
