<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>What is the correct way to do cargo subcommands? - clap-rs/clap #937</title>
    <link rel="stylesheet" href="../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../index.html">Back to index</a>
    </div>

    <h1>What is the correct way to do cargo subcommands?</h1>

    <div class="meta">
        <span class="state state-closed">Closed</span>
        <a href="https://github.com/clap-rs/clap/issues/937">#937</a>
        opened by <a href="https://github.com/golddranks">@golddranks</a>
        on 2017-04-21 05:22
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/golddranks">@golddranks</a> on 2017-04-21 05:22</div>
            <div class="timeline-body"><p>I have a crate <code>cargo-flamegraph</code> for which I'm trying to implement the command line argument parsing. It is used like this:</p>
<pre><code>cargo flamegraph [binary name] [-- &lt;user arguments&gt;...]</code></pre>
<p>I set the bin_name as &quot;cargo&quot;, but after that I'm in troubles. If I go directly as the binary name as the first argument, it takes &quot;flamegraph&quot; as the first argument. If I set the bin_name as &quot;cargo flamegraph&quot; it does the same. If I set the bin_name as &quot;cargo&quot; and &quot;flamegraph&quot; as a subcommand, it doesn't for some reason capture the first argument, binary name.</p>
<p>It only works if I set &quot;flamegraph&quot; as the first argument and &quot;binary_name&quot; as the second. But in this case, the usage is shown like this:</p>
<pre><code>cargo [flamegraph] [binary name] [-- &lt;user arguments&gt;...]</code></pre>
<p>Is there a bug with capturing the argument when &quot;flamegraph&quot; is set as the subcommand? Btw., my code in that case is like this:</p>
<pre><code>let matches = App::new(&quot;cargo flamegraph&quot;)
    .version(&quot;0.1&quot;)
    .bin_name(&quot;cargo&quot;)
    .about(&quot;Profiles your program and draws a nice flamegraph!&quot;)
    .author(&quot;Pyry Kontio&quot;)
    .setting(AppSettings::TrailingVarArg)
    .subcommand(SubCommand::with_name(&quot;flamegraph&quot;)
        .arg(Arg::with_name(&quot;binary name&quot;))
        .arg(Arg::with_name(&quot;user arguments&quot;)
            .last(true)
            .multiple(true)
        )
    )
    .get_matches();</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/golddranks">@golddranks</a> on 2017-04-21 06:03</div>
            <div class="timeline-body"><p>Ah, wait a minute, should I specify <code>.takes_value(true)</code> for positional arguments too to be able to get what was typed there?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/golddranks">@golddranks</a> on 2017-04-21 06:09</div>
            <div class="timeline-body"><p>Ugh, after adding some short-flag options this is getting even uglier:</p>
<pre><code>USAGE:
    cargo [OPTIONS] [flamegraph] [bin name] [-- &lt;pass through args&gt;...]</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/kbknapp">@kbknapp</a> on 2017-04-21 14:36</div>
            <div class="timeline-body"><p>Your first example is correct. Add a dummy subcommand called &quot;flamegraph&quot; and all your args under this subcommand.</p>
<pre><code class="language-rust">let matches = App::new(&quot;cargo-flamegraph&quot;)
    .version(&quot;0.1&quot;)
    .bin_name(&quot;cargo&quot;)
    .about(&quot;Profiles your program and draws a nice flamegraph!&quot;)
    .author(&quot;Pyry Kontio&quot;)
    .setting(AppSettings::TrailingVarArg)
    .subcommand(SubCommand::with_name(&quot;flamegraph&quot;)
        .arg(Arg::with_name(&quot;binary name&quot;))
        .arg(Arg::with_name(&quot;user arguments&quot;)
            .last(true)
            .multiple(true)
        )
    )
    .get_matches();
</code></pre>
<hr />
<blockquote>
<p>If I go directly as the binary name as the first argument, it takes &quot;flamegraph&quot; as the first argument.</p>
</blockquote>
<p>Do you mean you <em>also</em> want to be able to run <code>$ ./cargo-flamegraph [bin name] [-- &lt;user args&gt;...]</code>? If that's the case you need to go about it a different way and use a dummy <em>positional argument</em> that only accepts the value &quot;flamegraph&quot; and isn't required instead of a dummy subcommand.</p>
<pre><code class="language-rust">let matches = App::new(&quot;cargo-flamegraph&quot;)
    .version(&quot;0.1&quot;)
    .about(&quot;Profiles your program and draws a nice flamegraph!&quot;)
    .author(&quot;Pyry Kontio&quot;)
    .setting(AppSettings::TrailingVarArg)
    .arg(Arg::with_name(&quot;dummy&quot;)
        .hidden(true)
        .possible_value(&quot;flamegraph&quot;))
    .arg(Arg::with_name(&quot;binary name&quot;))
    .arg(Arg::with_name(&quot;user arguments&quot;)
            .last(true)
            .multiple(true)
        )
    )
    .get_matches();
</code></pre>
<p>If that's not what you mean, I may be misunderstanding your question.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">T: RFC / question</span> added by @kbknapp on 2017-04-21 14:41</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/kbknapp">@kbknapp</a> on 2017-04-21 15:49</div>
            <div class="timeline-body"><blockquote>
<p>Ugh, after adding some short-flag options this is getting even uglier</p>
</blockquote>
<p>@golddranks Note you can also <a href="https://docs.rs/clap/2.23.3/clap/struct.App.html#method.usage">set the usage string manually</a> to whatever you'd like. This doesn't affect functionality, only how the usage string gets displayed to the user. You can even do <a href="https://github.com/BurntSushi/ripgrep/blob/362abed44a000da3b31e5dd027e16eb4e36e1bed/src/app.rs#L16-L20">multi-line usage strings</a> if you like.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/golddranks">@golddranks</a> on 2017-04-24 03:51</div>
            <div class="timeline-body"><p>I am not trying to get <code>$ ./cargo-flamegraph [bin name] [-- &lt;user args&gt;...]</code> to work, just <code>$ cargo flamegraph [bin name] [-- &lt;user args&gt;...]</code>.</p>
<p>Here's an updated version:</p>
<pre><code>let matches = App::new(&quot;cargo flamegraph&quot;)
    .version(&quot;0.1&quot;)
    .bin_name(&quot;cargo&quot;)
    .about(&quot;Profiles your program and draws a nice flamegraph!&quot;)
    .author(&quot;Pyry Kontio&quot;)
    .setting(AppSettings::TrailingVarArg)
    .subcommand(SubCommand::with_name(&quot;flamegraph&quot;)
        .arg(Arg::with_name(&quot;verbose&quot;)
            .help(&quot;Prints out more stuff.&quot;)
            .short(&quot;v&quot;)
            .multiple(true)
        )
        .arg(Arg::with_name(&quot;timeout&quot;)
            .help(&quot;Timeout in seconds. By default, there is no timeout.&quot;)
            .short(&quot;t&quot;)
            .takes_value(true)
        )
        .arg(Arg::with_name(&quot;frequency&quot;)
            .help(&quot;The sampling frequency. By default, this is 99 Hz.&quot;)
            .short(&quot;f&quot;)
            .takes_value(true)
        )
        .arg(Arg::with_name(&quot;bin name&quot;)
            .help(&quot;The path of the binary to be profiled. If empty, Cargo.toml is searched for a binary.&quot;)
            .takes_value(true)
        )
        .arg(Arg::with_name(&quot;pass through args&quot;)
            .help(&quot;Any arguments you wish to pass to the binary being profiled.&quot;)
            .last(true)
            .multiple(true)
        )
    )
    .get_matches();

let binary_name = matches.value_of_os(&quot;bin name&quot;);
println!(&quot;Binary name: {:?}&quot;, binary_name);</code></pre>
<p>When I install this as a cargo subcommand and call it with this: <code>cargo flamegraph test</code>, it prints out:</p>
<pre><code>Binary name: None</code></pre>
<p>So it seems like a bug, or then there's something in the settings I'm overlooking. Setting <code>.takes_value(true)</code> for <code>Arg::with_name(&quot;bin name&quot;)</code> didn't help.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/kbknapp">@kbknapp</a> on 2017-04-24 04:20</div>
            <div class="timeline-body"><p>This is because the matches are a <a href="https://docs.rs/clap/2.23.3/clap/struct.ArgMatches.html#method.subcommand_name">recursive tree-like hierarchy</a> to allow multiple child subcommands to contain args with the same name. If they all existed in a flat namespace there would be conflicts.</p>
<p>This code should work:</p>
<pre><code class="language-rust">let matches = App::new(&quot;cargo flamegraph&quot;)
    .version(&quot;0.1&quot;)
    .bin_name(&quot;cargo&quot;)
    .about(&quot;Profiles your program and draws a nice flamegraph!&quot;)
    .author(&quot;Pyry Kontio&quot;)
    .setting(AppSettings::TrailingVarArg)
    .subcommand(SubCommand::with_name(&quot;flamegraph&quot;)
        .arg(Arg::with_name(&quot;verbose&quot;)
            .help(&quot;Prints out more stuff.&quot;)
            .short(&quot;v&quot;)
            .multiple(true)
        )
        .arg(Arg::with_name(&quot;timeout&quot;)
            .help(&quot;Timeout in seconds. By default, there is no timeout.&quot;)
            .short(&quot;t&quot;)
            .takes_value(true)
        )
        .arg(Arg::with_name(&quot;frequency&quot;)
            .help(&quot;The sampling frequency. By default, this is 99 Hz.&quot;)
            .short(&quot;f&quot;)
            .takes_value(true)
        )
        .arg(Arg::with_name(&quot;bin name&quot;)
            .help(&quot;The path of the binary to be profiled. If empty, Cargo.toml is searched for a binary.&quot;)
            .takes_value(true)
        )
        .arg(Arg::with_name(&quot;pass through args&quot;)
            .help(&quot;Any arguments you wish to pass to the binary being profiled.&quot;)
            .last(true)
            .multiple(true)
        )
    )
    .get_matches();

// matches refers to the top-level &quot;cargo flamegraph&quot; App's matches. We want &quot;flamegraph&quot;'s matches
let fg_matches = matches.subcommand_matches(&quot;flamegraph&quot;).unwrap();

let binary_name = fg_matches.value_of_os(&quot;bin name&quot;);
println!(&quot;Binary name: {:?}&quot;, binary_name);
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/golddranks">@golddranks</a> on 2017-04-24 04:24</div>
            <div class="timeline-body"><p>Ah, that explains it! Fixed and problem solved. Thank you.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @golddranks on 2017-04-24 04:24</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/kbknapp">@kbknapp</a> on 2017-04-24 04:25</div>
            <div class="timeline-body"><p>No problem :-)</p>
<p>On Apr 24, 2017 12:24 AM, &quot;Pyry Kontio&quot; <a href="mailto:notifications@github.com">notifications@github.com</a> wrote:</p>
<blockquote>
<p>Ah, that explains it! Fixed and problem solved. Thank you.</p>
<p>â€”
You are receiving this because you commented.
Reply to this email directly, view it on GitHub
<a href="https://github.com/kbknapp/clap-rs/issues/937#issuecomment-296521955">https://github.com/kbknapp/clap-rs/issues/937#issuecomment-296521955</a>,
or mute the thread
<a href="https://github.com/notifications/unsubscribe-auth/AGntttG_ymzr5hbBhvjqIajbTaAXUAIHks5rzCQGgaJpZM4ND4AK">https://github.com/notifications/unsubscribe-auth/AGntttG_ymzr5hbBhvjqIajbTaAXUAIHks5rzCQGgaJpZM4ND4AK</a>
.</p>
</blockquote>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/1422.html">clap-rs/clap#1422</a> on 2019-02-28 11:07</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../regexident/cargo-modules/issues/70.html">regexident/cargo-modules#70</a> on 2021-02-18 16:08</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/mimoo">@mimoo</a> on 2022-02-28 16:55</div>
            <div class="timeline-body"><p>It's not clear how to handle these today. I've tried the following but it still doesn't work:</p>
<pre><code class="language-rust">#[derive(Debug, Parser)]
#[clap(author, version, about, bin_name = &quot;cargo&quot;)]
struct Cli {
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2022-02-28 17:18</div>
            <div class="timeline-body"><p>We now have derive and builder examples for cargo subcommands.  See https://github.com/clap-rs/clap/blob/master/examples/README.md</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2022-12-28 20:06</div>
            <div class="timeline-body"><p>@blyxyas any reason you went that route  rather than the example that I linked above that is also linked <a href="https://docs.rs/clap/latest/clap/_derive/_cookbook/index.html">from the cookbook</a>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/blyxyas">@blyxyas</a> on 2022-12-28 20:09</div>
            <div class="timeline-body"><p>@epage I removed the comment.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../PhilippPolterauer/cargo-samply/pulls/7.html">PhilippPolterauer/cargo-samply#7</a> on 2025-03-18 14:50</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:28:32 UTC
    </footer>
</body>
</html>
