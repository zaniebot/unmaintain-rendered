<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>derive: env! doesn't work with custom build variables - clap-rs/clap #2893</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>derive: env! doesn't work with custom build variables</h1>

    <div class="meta">
        <span class="state state-closed">Closed</span>
        <a href="https://github.com/clap-rs/clap/issues/2893">#2893</a>
        opened by <a href="https://github.com/ajeetdsouza">@ajeetdsouza</a>
        on 2021-10-16 12:12
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/ajeetdsouza">@ajeetdsouza</a> on 2021-10-16 12:12</div>
            <div class="timeline-body"><h3>Please complete the following tasks</h3>
<ul>
<li>[X] I have searched the <a href="https://github.com/clap-rs/clap/discussions">discussions</a></li>
<li>[X] I have searched the existing issues</li>
</ul>
<h3>Rust Version</h3>
<p>rustc 1.55.0 (c8dfcfe04 2021-09-06)</p>
<h3>Clap Version</h3>
<p>3.0.0-beta.4</p>
<h3>Minimal reproducible code</h3>
<p>Set <code>APP_VERSION</code> in <code>build.rs</code>:</p>
<pre><code class="language-rust">println!(&quot;cargo:rustc-env=APP_VERSION={}&quot;, version);
</code></pre>
<p>Now create an app in <code>main.rs</code>:</p>
<pre><code class="language-rust">#[derive(Clap, Debug)]
#[clap(version = env!(&quot;APP_VERSION&quot;)]
struct App {}
</code></pre>
<h3>Steps to reproduce the bug with the above code</h3>
<p><code>cargo run</code></p>
<h3>Actual Behaviour</h3>
<p>You get an error: <code>environment variable </code>APP_VERSION` not defined</p>
<h3>Expected Behaviour</h3>
<p>Try <code>env!(&quot;APP_VERSION&quot;)</code> in your <code>main.rs</code> and it works. So it should also work in clap.</p>
<h3>Additional Context</h3>
<p><em>No response</em></p>
<h3>Debug Output</h3>
<p><em>No response</em></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">T: bug</span> added by @ajeetdsouza on 2021-10-16 12:12</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/pksunkara">@pksunkara</a> on 2021-10-16 12:46</div>
            <div class="timeline-body"><p>Does it work with normal clap builder?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">C: derive macros</span> added by @pksunkara on 2021-10-16 12:46</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2021-10-16 15:16</div>
            <div class="timeline-body"><p>I can't reproduce this</p>
<p><code>Cargo.toml</code></p>
<pre><code class="language-toml">[package]
name = &quot;test-clap&quot;
version = &quot;0.1.0&quot;
edition = &quot;2018&quot;

# See more keys and their definitions at https://doc.rust-lang.org/cargo/reference/manifest.html

[dependencies]
clap = { path = &quot;../clap&quot;, features = [] }
#clap = { path = &quot;../clap&quot;, features = [&quot;debug&quot;] }
#clap = { version = &quot;2&quot; }
clap_generate = { path = &quot;../clap/clap_generate&quot;, features = [] }
</code></pre>
<p><code>build.rs</code></p>
<pre><code class="language-rust">fn main() {
    let version = &quot;200&quot;;
    println!(&quot;cargo:rustc-env=APP_VERSION={}&quot;, version);
}
</code></pre>
<p><code>src/main.rs</code></p>
<pre><code class="language-rust">use clap::{Args, Parser};

#[derive(Parser, PartialEq, Debug)]
#[clap(version = std::env!(&quot;APP_VERSION&quot;))]
struct Opt {
    #[clap(flatten)]
    common: Common,
}

#[derive(Args, PartialEq, Debug)]
struct Common {
    arg: i32,
}

fn main() {
    dbg!(std::env!(&quot;APP_VERSION&quot;));
    Opt::parse();
}
</code></pre>
<pre><code>‚ùØ cargo run -- --help
   Compiling test-clap v0.1.0 (/home/epage/src/personal/test-clap)
    Finished dev [unoptimized + debuginfo] target(s) in 0.70s
     Running `target/debug/test-clap --help`
[src/main.rs:16] std::env!(&quot;APP_VERSION&quot;) = &quot;200&quot;
test-clap 200

USAGE:
    test-clap &lt;ARG&gt;

ARGS:
    &lt;ARG&gt;    

OPTIONS:
    -h, --help       Print help information
    -V, --version    Print version information
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @pksunkara on 2021-10-16 15:27</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ajeetdsouza">@ajeetdsouza</a> on 2021-10-16 20:51</div>
            <div class="timeline-body"><p>Figured out why this was happening. I'm importing the same module into my <code>build.rs</code> in order to generate completions. Since the environment variable set by <code>build.rs</code> itself is obviously not available to it at compile time, it throws an error.</p>
<p>I've replaced it with <code>version = option_env!(&quot;APP_VERSION&quot;).unwrap_or_default()</code>, since completions don't really require a version anyway. Thanks!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/3175.html">clap-rs/clap#3175</a> on 2021-12-14 16:30</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:35:08 UTC
    </footer>
</body>
</html>
