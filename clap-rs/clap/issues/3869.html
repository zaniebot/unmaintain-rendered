<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>clap_mangen can't handle subcommands with arguments that conflict with global opts - clap-rs/clap #3869</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>clap_mangen can&#x27;t handle subcommands with arguments that conflict with global opts</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/clap-rs/clap/issues/3869">#3869</a>
        opened by <a href="https://github.com/sunshowers">@sunshowers</a>
        on 2022-06-25 20:37
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sunshowers">@sunshowers</a></div>
            <div class="timeline-body">Please complete the following tasks
<ul>
<li>[X] I have searched the <a href="https://github.com/clap-rs/clap/discussions">discussions</a></li>
<li>[X] I have searched the <a href="https://github.com/clap-rs/clap/issues">open</a> and <a href="https://github.com/clap-rs/clap/issues?q=is%3Aissue+label%3AS-wont-fix+is%3Aclosed">rejected</a> issues</li>
</ul>
Rust Version
<p>rustc 1.61.0 (fe5b13d68 2022-05-18)</p>
Clap Version
<p>3.2.6</p>
Minimal reproducible code
<pre><code>//# clap = { version = &quot;3.2.6&quot;, features = [&quot;derive&quot;] }
//# clap_mangen = &quot;0.1.6&quot;

use clap::{CommandFactory, Parser, Subcommand};
use clap_mangen::Man;

#[derive(Debug, Parser)]
struct MyApp {
    #[clap(long)]
    myflag: bool,
    #[clap(subcommand)]
    subcommand: MyCommand,
}

#[derive(Debug, Subcommand)]
enum MyCommand {
    MySubcommand {
        #[clap(long, conflicts_with = &quot;myflag&quot;)]
        subcommand_flag: bool,
    },
}

fn main() {
    let command = MyApp::command();

    let man = Man::new(command.clone());
    let mut buf = Vec::new();
    man.render(&amp;mut buf).expect(&quot;rendering main page worked&quot;);

    for subcommand in command.get_subcommands() {
        let man = Man::new(subcommand.clone());
        let mut buf = Vec::new();
        man.render(&amp;mut buf).expect(&quot;rendering subcommand worked&quot;);
    }
}
</code></pre>
Steps to reproduce the bug with the above code
<p><code>cargo run</code> (I use <code>cargo-play</code>)</p>
Actual Behaviour
<pre><code>thread &#x27;main&#x27; panicked at &#x27;Command my-subcommand: Argument or group &#x27;myflag&#x27; specified in &#x27;conflicts_with*&#x27; for &#x27;subcommand-flag&#x27; does not exist&#x27;, /opt/cargo/registry/src/github.com-1ecc6299db9ec823/clap-3.2.6/src/builder/debug_asserts.rs:237:13
stack backtrace:
   0: rust_begin_unwind
             at /rustc/fe5b13d681f25ee6474be29d748c65adcd91f69e/library/std/src/panicking.rs:584:5
   1: core::panicking::panic_fmt
             at /rustc/fe5b13d681f25ee6474be29d748c65adcd91f69e/library/core/src/panicking.rs:143:14
   2: clap::builder::debug_asserts::assert_app
             at /opt/cargo/registry/src/github.com-1ecc6299db9ec823/clap-3.2.6/src/builder/debug_asserts.rs:237:13
   3: clap::builder::command::App::_build_self
             at /opt/cargo/registry/src/github.com-1ecc6299db9ec823/clap-3.2.6/src/builder/command.rs:4256:13
   4: clap::builder::command::App::_build_recursive
             at /opt/cargo/registry/src/github.com-1ecc6299db9ec823/clap-3.2.6/src/builder/command.rs:4173:9
   5: clap::builder::command::App::_build_recursive
             at /opt/cargo/registry/src/github.com-1ecc6299db9ec823/clap-3.2.6/src/builder/command.rs:4175:13
   6: clap::builder::command::App::build
             at /opt/cargo/registry/src/github.com-1ecc6299db9ec823/clap-3.2.6/src/builder/command.rs:4168:9
   7: clap_mangen::Man::new
             at /opt/cargo/registry/src/github.com-1ecc6299db9ec823/clap_mangen-0.1.9/src/lib.rs:29:9
   8: pdyve54v1gmc8ygblwcr3ndpfy4e::main
             at /tmp/cargo-play.DYVe54V1GMC8ygbLwcr3nDPfY4e/src/main.rs:26:15
   9: core::ops::function::FnOnce::call_once
             at /rustc/fe5b13d681f25ee6474be29d748c65adcd91f69e/library/core/src/ops/function.rs:227:5
</code></pre>
Expected Behaviour
<p>The man pages render correctly.</p>
Additional Context
<p>Seems like maybe there should be a way to disable the <code>build</code> method call that happens at the top of <code>Man::new</code>.</p>
Debug Output
<pre><code>[      clap::builder::command]    Command::_build: name=&quot;pdyve54v1gmc8ygblwcr3ndpfy4e&quot;
[      clap::builder::command]         Command::_propagate:pdyve54v1gmc8ygblwcr3ndpfy4e
[      clap::builder::command]         Command::_check_help_and_version: pdyve54v1gmc8ygblwcr3ndpfy4e
[      clap::builder::command]         Command::_check_help_and_version: Removing generated version
[      clap::builder::command]         Command::_check_help_and_version: Building help subcommand
[      clap::builder::command]         Command::_propagate_global_args:pdyve54v1gmc8ygblwcr3ndpfy4e
[      clap::builder::command]         Command::_propagate removing my-subcommand&#x27;s help
[      clap::builder::command]         Command::_propagate pushing help to my-subcommand
[      clap::builder::command]         Command::_propagate removing help&#x27;s help
[      clap::builder::command]         Command::_propagate pushing help to help
[      clap::builder::command]         Command::_derive_display_order:pdyve54v1gmc8ygblwcr3ndpfy4e
[      clap::builder::command]         Command::_derive_display_order:my-subcommand
[      clap::builder::command]         Command::_derive_display_order:help
[clap::builder::debug_asserts]         Command::_debug_asserts
[clap::builder::debug_asserts]         Arg::_debug_asserts:help
[clap::builder::debug_asserts]         Arg::_debug_asserts:myflag
[clap::builder::debug_asserts]         Command::_verify_positionals
[      clap::builder::command]         Command::_build: name=&quot;my-subcommand&quot;
[      clap::builder::command]         Command::_propagate:my-subcommand
[      clap::builder::command]         Command::_check_help_and_version: my-subcommand
[      clap::builder::command]         Command::_check_help_and_version: Removing generated version
[      clap::builder::command]         Command::_propagate_global_args:my-subcommand
[      clap::builder::command]         Command::_derive_display_order:my-subcommand
[clap::builder::debug_asserts]         Command::_debug_asserts
[clap::builder::debug_asserts]         Arg::_debug_asserts:subcommand-flag
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">C-bug</span> added by <a href="https://github.com/sunshowers">@sunshowers</a> on 2022-06-25 20:37</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a>nextest-rs/nextest#312</a> on 2022-06-25 20:40</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a>clap-rs/clap#3365</a> on 2022-06-25 20:46</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2022-07-11 20:12</div>
            <div class="timeline-body"><p>This is more general than just <code>clap_mangen</code></p>
<pre><code>#!/usr/bin/env -S rust-script --debug

//! ```cargo
//! [dependencies]
//! clap = { version = &quot;3.2.8&quot;, features = [&quot;env&quot;, &quot;derive&quot;] }
//! ```

use clap::{CommandFactory, Parser, Subcommand};

#[derive(Debug, Parser)]
struct MyApp {
    #[clap(long)]
    myflag: bool,
    #[clap(subcommand)]
    subcommand: MyCommand,
}

#[derive(Debug, Subcommand)]
enum MyCommand {
    MySubcommand {
        #[clap(long, conflicts_with = &quot;myflag&quot;)]
        subcommand_flag: bool,
    },
}

fn main() {
    let command = MyApp::command();
    command.debug_assert();
}
</code></pre>
<pre><code>thread &#x27;main&#x27; panicked at &#x27;Command my-subcommand: Argument or group &#x27;myflag&#x27; specified in &#x27;conflicts_with*&#x27; for &#x27;subcommand-flag&#x27; does not exist&#x27;, /home/epage/.cargo/registry/src/github.com-1ecc6299db9ec823/clap-3.2.8/src/builder/debug_asserts.rs:237:13
note: run with `RUST_BACKTRACE=1` environment variable to display a backtrace
</code></pre>
<p>or if you want to verify this happen in regular code</p>
<pre><code>#!/usr/bin/env -S rust-script --debug

//! ```cargo
//! [dependencies]
//! clap = { version = &quot;3.2.8&quot;, features = [&quot;env&quot;, &quot;derive&quot;] }
//! ```

use clap::{Parser, Subcommand};

#[derive(Debug, Parser)]
struct MyApp {
    #[clap(long)]
    myflag: bool,
    #[clap(subcommand)]
    subcommand: MyCommand,
}

#[derive(Debug, Subcommand)]
enum MyCommand {
    MySubcommand {
        #[clap(long, conflicts_with = &quot;myflag&quot;)]
        subcommand_flag: bool,
    },
}

fn main() {
    MyApp::parse();
}
</code></pre>
<pre><code>$ ./clap-3869.rs  my-subcommand
thread &#x27;main&#x27; panicked at &#x27;Command my-subcommand: Argument or group &#x27;myflag&#x27; specified in &#x27;conflicts_with*&#x27; for &#x27;subcommand-flag&#x27; does not exist&#x27;, /home/epage/.cargo/registry/src/github.com-1ecc6299db9ec823/clap-3.2.8/src/builder/debug_asserts.rs:237:13
note: run with `RUST_BACKTRACE=1` environment variable to display a backtrace
</code></pre>
<p>Depending on what your intent is, you can either</p>
<ul>
<li>Mark <code>myflag</code> with <code>global = true</code> attribute</li>
<li>Set <code>args_conflicts_with_subcommands = true</code> attribute on the command</li>
</ul>
<p>If you actually need top-level arguments to conflict with a subxcommand&#x27;s arguments, then that will unlikely be supported in clap directly (if nothing else, argument ids only exist for the current command level).  However, this can be checked manually or we are looking at more general validation plugins, see <a href="https://github.com/clap-rs/clap/issues/3008">clap-rs/clap#3008</a>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/epage">@epage</a> on 2022-07-11 20:12</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:59:04 UTC
    </footer>
</body>
</html>
