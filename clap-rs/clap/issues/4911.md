```yaml
number: 4911
title: "panics with error incomprehensible to `#[derive(..)]` user"
type: issue
state: open
author: rukai
labels:
  - C-bug
assignees: []
created_at: 2023-05-16T12:07:32Z
updated_at: 2023-05-17T21:35:44Z
url: https://github.com/clap-rs/clap/issues/4911
synced_at: 2026-01-10T01:57:48Z
```

# panics with error incomprehensible to `#[derive(..)]` user

---

_Issue opened by @rukai on 2023-05-16 12:07_

### Please complete the following tasks

- [X] I have searched the [discussions](https://github.com/clap-rs/clap/discussions)
- [X] I have searched the [open](https://github.com/clap-rs/clap/issues) and [rejected](https://github.com/clap-rs/clap/issues?q=is%3Aissue+label%3AS-wont-fix+is%3Aclosed) issues

### Rust Version

rustc 1.69.0 (84c898d65 2023-04-16)

### Clap Version

4.2.7

### Minimal reproducible code

```rust
use clap::{Parser, Subcommand};

fn main() {
    Args::parse();
}

#[derive(Subcommand)]
pub enum Mode {
    Orchestrator {
        domains: Vec<String>,
        email: Option<String>,
    },
    Other,
}

#[derive(Parser)]
pub struct Args {
    #[command(subcommand)]
    pub mode: Mode,
}
```

### Steps to reproduce the bug with the above code

cargo run -- orchestrator --help

### Actual Behaviour

It gives the panic message:
```
thread 'main' panicked at 'When using a positional argument with `.num_args(1..)` that is *not the last* positional argument, the last positional argument (i.e. the one with the highest index) *must* have .required(true) or .last(true) set.', /home/rukai/.cargo/registry/src/github.com-1ecc6299db9ec823/clap_builder-4.2.7/src/builder/debug_asserts.rs:587:9
stack backtrace:
```

### Expected Behaviour

I've observed that swapping the order of `email` and `domains` fixes the panic but:

I expect the error to explain how to fix the issue.
Maybe the error makes sense to someone that is familiar with the builder API but I have only ever used the #[derive()] API.

Can you maybe detect that the user is using #[derives] so that you can give an error that makes sense to them?

### Additional Context

_No response_

### Debug Output

_No response_

---

_Label `C-bug` added by @rukai on 2023-05-16 12:07_

---

_Referenced in [clap-rs/clap#4912](../../clap-rs/clap/pulls/4912.md) on 2023-05-17 21:34_

---

_Comment by @epage on 2023-05-17 21:35_

#4912 clarify the wording a bit

> Can you maybe detect that the user is using #[derives] so that you can give an error that makes sense to them?

We could switch the behavior based on the `derive` feature but that could be coming in through a dependency, so I'd rather not do that.

In general, the error isn't that great.  It especially should say which args / fields are involved.

---
