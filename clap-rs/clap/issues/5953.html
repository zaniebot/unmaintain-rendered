<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Completing of unbound positionals doesn't allow completing of flags - clap-rs/clap #5953</title>
    <link rel="stylesheet" href="../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../index.html">Back to index</a>
    </div>

    <h1>Completing of unbound positionals doesn't allow completing of flags</h1>

    <div class="meta">
        <span class="state state-closed">Closed</span>
        <a href="https://github.com/clap-rs/clap/issues/5953">#5953</a>
        opened by <a href="https://github.com/krobelus">@krobelus</a>
        on 2025-03-18 18:11
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/krobelus">@krobelus</a> on 2025-03-18 18:11</div>
            <div class="timeline-body"><h3>Please complete the following tasks</h3>
<ul>
<li>[x] I have searched the <a href="https://github.com/clap-rs/clap/discussions">discussions</a></li>
<li>[x] I have searched the <a href="https://github.com/clap-rs/clap/issues">open</a> and <a href="https://github.com/clap-rs/clap/issues?q=is%3Aissue+label%3AS-wont-fix+is%3Aclosed">rejected</a> issues</li>
</ul>
<h3>Rust Version</h3>
<p>stable</p>
<h3>Clap Version</h3>
<p>master</p>
<h3>Minimal reproducible code</h3>
<pre><code class="language-rust">fn main() {
    let cmd = clap::Command::new(&quot;foo&quot;)
        .arg(
            clap::Arg::new(&quot;positional&quot;)
                .value_parser([&quot;pos_1&quot;, &quot;pos_2&quot;])
                .index(1)
                .num_args(1..),
        )
        .arg(
            clap::Arg::new(&quot;--format&quot;)
                .long(&quot;format&quot;)
                .short('F')
                .value_parser([&quot;json&quot;, &quot;yaml&quot;, &quot;toml&quot;]),
        );
    if std::env::var_os(&quot;COMPLETE&quot;).is_some() {
        let _ = clap_complete::CompleteEnv::with_factory(|| cmd.clone())
            .try_complete(std::env::args_os(), None);
    }
}
</code></pre>
<h3>Steps to reproduce the bug with the above code</h3>
<p><code>cargo b &amp;&amp; COMPLETE=fish target/debug/foo -- target/debug/foo pos_1 --</code></p>
<h3>Actual Behaviour</h3>
<p>outputs nothing</p>
<h3>Expected Behaviour</h3>
<p>output option completion:</p>
<pre><code>--format
--help	Print help
</code></pre>
<h3>Additional Context</h3>
<p>Regressed in f0bd4750 (feat(clap_complete): Support multi-values of positional argument with <code>num_arg(N)</code>, 2024-07-26)</p>
<p>Some work at https://github.com/clap-rs/clap/pull/5949
Sorry for creating faulty PR without discussing beforehand.</p>
<h3>Debug Output</h3>
<pre><code>[clap_builder::builder::command]Command::_build: name=&quot;foo&quot;
[clap_builder::builder::command]Command::_propagate:foo
[clap_builder::builder::command]Command::_check_help_and_version:foo expand_help_tree=true
[clap_builder::builder::command]Command::long_help_exists
[clap_builder::builder::command]Command::_check_help_and_version: Building default --help
[clap_builder::builder::command]Command::_propagate_global_args:foo
[clap_builder::builder::debug_asserts]Command::_debug_asserts
[clap_builder::builder::debug_asserts]Arg::_debug_asserts:positional
[clap_builder::builder::debug_asserts]Arg::_debug_asserts:--format
[clap_builder::builder::debug_asserts]Arg::_debug_asserts:help
[clap_builder::builder::debug_asserts]Command::_verify_positionals
[clap_builder::builder::command]Command::_build_bin_names
[ clap_builder::output::usage]Usage::get_required_usage_from: incls=[], matcher=false, incl_last=true
[ clap_builder::output::usage]Usage::get_required_usage_from: unrolled_reqs=[]
[ clap_builder::output::usage]Usage::get_required_usage_from: ret_val=[]
[clap_complete::engine::complete] 	complete: args=[&quot;target/debug/foo&quot;, &quot;--&quot;], arg_index=1, current_dir=None
[clap_builder::builder::command]Command::_build: name=&quot;foo&quot;
[clap_builder::builder::command]Command::_build: already built
[clap_builder::builder::command]Command::_build_bin_names
[clap_builder::builder::command]Command::_build_bin_names: already built
[clap_complete::engine::complete] 	complete: target_cursor=ArgCursor { cursor: 2 }
[clap_complete::engine::complete] 	complete::next: arg=&quot;--&quot;, current_state=ValueDone, cursor=ArgCursor { cursor: 2 }
[clap_complete::engine::complete] 	complete_arg: arg=ParsedArg { inner: &quot;--&quot; }, cmd=&quot;foo&quot;, current_dir=None, pos_index=1, state=ValueDone
[clap_complete::engine::complete] 	complete_subcommand: cmd=&quot;foo&quot;, value=&quot;--&quot;
[clap_complete::engine::complete] 	subcommands: name=foo
[clap_complete::engine::complete] 	subcommands: Has subcommands...false
[clap_complete::engine::complete] 	complete_arg_value: arg=Arg { id: &quot;positional&quot;, help: None, long_help: None, action: Some(Append), value_parser: Some(ValueParser::other(alloc::string::String)), blacklist: [], settings: ArgFlags(0), overrides: [], groups: [], requires: [], r_ifs: [], r_unless: [], short: None, long: None, aliases: [], short_aliases: [], disp_ord: None, val_names: [], num_vals: Some(1..), val_delim: None, default_vals: [], default_vals_ifs: [], terminator: None, index: Some(1), help_heading: Some(None), default_missing_vals: [], ext: Extensions { extensions: FlatMap { keys: [], values: [] } } }, value=Ok(&quot;--&quot;)
[clap_complete::engine::complete] 	longs: name=foo
[clap_complete::engine::complete] 	longs: name=foo
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">C-bug</span> added by @krobelus on 2025-03-18 18:11</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">A-completion</span> added by @epage on 2025-03-19 12:42</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "Regression causing missing option completion inside multi-arg options" to "Completing of unbound positionals doesn't allow completing of flags" by @epage on 2025-03-19 12:42</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">E-medium</span> added by @epage on 2025-03-19 12:42</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2025-03-19 12:43</div>
            <div class="timeline-body"><p>From https://github.com/clap-rs/clap/pull/5949#discussion_r1999671613</p>
<blockquote>
<p>imo the crux of this problem is that for variable <code>num_args</code>, it is both valid to have a positional <em>and</em> a flag. <code>complete_arg</code>s <a href="https://github.com/clap-rs/clap/blob/master/clap_complete/src/engine/complete.rs#L248-L255"><code>ParseState::Pos</code></a> should take that into account. Just copying the code over could end up making things messy, so a separate refactor of some kind should probably done first once we understand what the final state of the function should look like.</p>
</blockquote>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2025-03-19 21:00</div>
            <div class="timeline-body"><p>See #5949</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @epage on 2025-03-19 21:00</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:28:35 UTC
    </footer>
</body>
</html>
