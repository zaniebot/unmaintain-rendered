<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Large `Args` struct causes stack overflow on Intel SGX - clap-rs/clap #4516</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Large `Args` struct causes stack overflow on Intel SGX</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/clap-rs/clap/issues/4516">#4516</a>
        opened by <a href="https://github.com/trevor-crypto">@trevor-crypto</a>
        on 2022-11-28 18:57
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/trevor-crypto">@trevor-crypto</a> on 2022-11-28 18:57</div>
            <div class="timeline-body"><h3>Please complete the following tasks</h3>
<ul>
<li>[X] I have searched the <a href="https://github.com/clap-rs/clap/discussions">discussions</a></li>
<li>[X] I have searched the <a href="https://github.com/clap-rs/clap/issues">open</a> and <a href="https://github.com/clap-rs/clap/issues?q=is%3Aissue+label%3AS-wont-fix+is%3Aclosed">rejected</a> issues</li>
</ul>
<h3>Rust Version</h3>
<p>rustc 1.67.0-nightly (a28f3c88e 2022-11-20)</p>
<h3>Clap Version</h3>
<p>4.0.27</p>
<h3>Minimal reproducible code</h3>
<p>Too large to show paste:
https://gist.github.com/rust-play/708d645d1c26354657fb8df945718ccc</p>
<p><code>.cargo/config</code> :</p>
<pre><code>[target.x86_64-fortanix-unknown-sgx]
runner = &quot;ftxsgx-runner-cargo&quot;
[build]
target = &quot;x86_64-fortanix-unknown-sgx&quot;
</code></pre>
<p><code>Cargo.toml</code>:</p>
<pre><code>[dependencies]
clap = { version = &quot;4.0.27&quot;, default-features = false,  features = [&quot;std&quot;, &quot;derive&quot;, &quot;help&quot;, &quot;usage&quot;, &quot;error-context&quot;] }

[package.metadata.fortanix-sgx]
heap-size = 0x10000000
stack-size = 0x100000
</code></pre>
<h3>Steps to reproduce the bug with the above code</h3>
<ol>
<li>Have a working environment to compile and run against the <code>x86_64-fortanix-unknown-sgx</code> target</li>
<li><code>cargo run -- --help</code> using the minimal reproducible code above</li>
<li>Notice the SIGBUS triggered</li>
<li>Now try <code>cargo run --release -- --help</code></li>
<li>Notice all is normal (help is shown)</li>
</ol>
<h3>Actual Behaviour</h3>
<pre><code class="language-shell">     Running `ftxsgx-runner-cargo target/x86_64-fortanix-unknown-sgx/debug/clap-test`
SIGBUS triggered: likely caused by stack overflow in enclave.
ERROR: while running &quot;ftxsgx-runner&quot; &quot;target/x86_64-fortanix-unknown-sgx/debug/clap-test.sgxs&quot; got signal: 7
</code></pre>
<h3>Expected Behaviour</h3>
<p>The <code>--debug</code> profile should work correctly, as <code>--release</code> does, and not trigger a stack overflow.</p>
<h3>Additional Context</h3>
<p>I know this is an obscure issue due to the fact that the amount of args is insanely large, but I actually have a use-case that is similar to this since with Fortanix Intel SGX, you do not have I/O for a config file, or the ability to use environment variables. I have already increased <code>stack-size</code>, but it doesn't seem to help after a certain point.</p>
<p><strong>I don't expect this to be addressed, so it would be great to just have some insight into how to &quot;please&quot; <code>clap</code> (clap's parser?) so that it doesn't stack overflow.</strong></p>
<h3>Debug Output</h3>
<p>None, unfortunately.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">C-bug</span> added by @trevor-crypto on 2022-11-28 18:57</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2022-11-29 02:23</div>
            <div class="timeline-body"><p>Happen to be able to get a crash dump?  I'm curious which code hits a stack overflow.</p>
<p><code>clap::Arg</code> is fairly big.  I hope to shrink it as part of https://github.com/clap-rs/clap/discussions/3476.</p>
<p>rustc and llvm don't do an efficient job with removing stack copies, like with types like <code>clap::Arg</code>: https://arewestackefficientyet.com/</p>
<p>If this is when we read <code>ArgMatches</code> to populate the struct, then I have no idea what could be improved about that.</p>
<p>EDIT: I tried to reproduce this on x64 Linux but the compile times for hundreds of args was just becoming too much for me.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2022-11-29 02:24</div>
            <div class="timeline-body"><p>I suspect a workaround would be to break the <code>Args</code> up into multiple structs and use <code>#[command(flatten)]</code>.  That should force stack space to get reclaimed.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">A-derive</span> added by @epage on 2022-11-29 02:24</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">S-waiting-on-design</span> added by @epage on 2022-11-29 02:26</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/trevor-crypto">@trevor-crypto</a> on 2022-11-29 07:35</div>
            <div class="timeline-body"><p>Thanks for the quick response @epage. I will try your suggestion of breaking up the args into structs then flattening.</p>
<p>Here is a stacktrace:</p>
<pre><code class="language-gdb">(gdb) bt
#0  0x00007fffc00b2456 in clap_test::{impl#5}::augment_args (__clap_app=...) at src/main.rs:3
#1  0x00007fffc0073629 in clap_test::{impl#3}::command () at src/main.rs:3
#2  0x00007fffc0061010 in clap::derive::Parser::parse&lt;clap_test::A&gt; ()
    at ~/.cargo/registry/src/github.com-1ecc6299db9ec823/clap-4.0.27/src/derive.rs:82
#3  0x00007fffc0070cb1 in clap_test::main () at src/main.rs:349
</code></pre>
<p>Seems like it comes from <code>clap::Args</code> derive macro generation of <code>augment_args</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2022-11-29 13:04</div>
            <div class="timeline-body"><p>Huh, so it is <code>augment_args</code>.  Nothing is being created on the stack.  We do have temporaries being created for passing into functions.  There are likely also a <strong>lot</strong> of moves happening.</p>
<p>I wonder if there is a way to restructure things to reduce all of this.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/trevor-crypto">@trevor-crypto</a> on 2022-11-29 16:27</div>
            <div class="timeline-body"><blockquote>
<p>I wonder if there is a way to restructure things to reduce all of this.</p>
</blockquote>
<p>I will try to restructure the giant struct and get back to you.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/trevor-crypto">@trevor-crypto</a> on 2022-12-20 11:37</div>
            <div class="timeline-body"><p>I was able to split the args struct and the issue goes away, as you suspected. Albeit successful, the parsing actually takes quite a while compared to <code>argh</code> (which we're currently using with a massive config struct).</p>
<p><a href="https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2021&amp;gist=e3825e9961c6a07b67203d8b546d4835">Updated playground</a> with broken code</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2022-12-20 12:57</div>
            <div class="timeline-body"><p>How much is the performance off between the two?</p>
<p>What is the performance situation?  Large number of argument definitions with very few present?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/trevor-crypto">@trevor-crypto</a> on 2022-12-20 14:00</div>
            <div class="timeline-body"><p>Just ran a quick test a few times, with all of the arguments present: (debug build)</p>
<pre><code>clap parse duration: 6.765064496s
argh parse duration: 58.132469ms
</code></pre>
<p>You can see the massive arg struct here, where <code>clap</code> is split up and flattened, and <code>argh</code> has it fully inline.</p>
<p><a href="https://github.com/trevor-crypto/sgx-clap-test/blob/e08a9a41292e20f970c8b04939da234516911011/src/main.rs#L60-L69">Here is the full example in a repo</a></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2022-12-20 15:31</div>
            <div class="timeline-body"><p>For reference, on a laptop, I'm getting</p>
<pre><code>clap parse duration: 12.344762ms
argh parse duration: 1.14286ms
</code></pre>
<p>EDIT: Updated for release build</p>
<p>Either way, something for me to look into.'</p>
<p>btw if you want something inbetween argh and clap., <code>bpaf</code> might be something to try.  My biggest concern over it is some usability aspects due to its functional heritage.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2022-12-20 16:15</div>
            <div class="timeline-body"><p>According to callgrind, most of the time is spend in memcmp's (40+%).  This makes sense because in clap v4, we switched to some naiive data types for lower binary overhead with the assumption that there weren't a lot of unique arguments but instead a large argv would be taken up with a single positional argument passed in from xargs.  In general, this is a use case that clap's dynamic design can't compete against parsers with a more static design (as confirmed by callgrind below).  Something I want to explore is more hybrid approach for clap so it can be dynamic where needed and static elsewhere.</p>
<p>Switching to clap HEAD (which <strong>shouldn't</strong> matter), I'm getting</p>
<pre><code>clap parse duration: 10.297272ms
argh parse duration: 1.216893ms
</code></pre>
<p>Switching out for <code>HashMap</code> with the default hasher, I'm getting</p>
<pre><code>clap parse duration: 4.226175ms
argh parse duration: 1.198631ms
</code></pre>
<p>We could possibly put that behind a feature flag.  It will require some breaking changes though and can't be done until 5.0.</p>
<p>With that, callgrind is saying the biggest higher up functions are</p>
<ul>
<li>55% validate (1x)<ul>
<li>51% gather_conflicts (170x)<ul>
<li>32% gather_direct_conflicts (58,140x)<ul>
<li>28% hash map entry (58,140x)<ul>
<li>28% hash_one</li>
</ul>
</li>
</ul>
</li>
<li>15% check-explicit (29,240x)</li>
</ul>
</li>
</ul>
</li>
<li>36% parse_opt_value (170x)<ul>
<li>36% react (170x)<ul>
<li>36% start_custom_arg (170x)</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>From another slice of the problem, 27% of the time is still spent in memcmp</p>
<p>This seems to just be the overhead of a more dynamic design (storing things in a hashmap) compared to a more static design (knowing all arguments at compile time).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/trevor-crypto">@trevor-crypto</a> on 2022-12-21 06:10</div>
            <div class="timeline-body"><p>Thanks for looking into this @epage !</p>
<p>I forgot to run my tests in <code>--release</code>, so that is probably why the perf seemed so different. I updated my comment to show that it was a debug build.</p>
<p>In regards to the main issue of the stack overflowing (on SGX and maybe other low mem systems) when there is a massive arg struct, is there any way to offload the parsing to heapspace?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2022-12-21 13:59</div>
            <div class="timeline-body"><p>The stack overflow isn't in the parsing but in our defining of the command line.  We are creating a lot of temporaries.  I'm unsure why its not reclaiming stack space during that and what we can do to force it to clean up stack space.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/4572.html">clap-rs/clap#4572</a> on 2022-12-22 18:18</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2022-12-22 18:42</div>
            <div class="timeline-body"><p>While looking at another issue, I found an optimization that I could make that took the test case from ~10ms on my machine to ~3ms.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/3524.html">clap-rs/clap#3524</a> on 2023-01-06 16:25</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/5134.html">clap-rs/clap#5134</a> on 2023-09-23 17:56</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 01:35:16 UTC
    </footer>
</body>
</html>
