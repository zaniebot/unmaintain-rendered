<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fatal Internal Error when derive ArgGroup with flag that doesn't exist in separate crate - clap-rs/clap #5793</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Fatal Internal Error when derive ArgGroup with flag that doesn&#x27;t exist in separate crate</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/clap-rs/clap/issues/5793">#5793</a>
        opened by <a href="https://github.com/JulianKnodt">@JulianKnodt</a>
        on 2024-10-29 06:45
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/JulianKnodt">@JulianKnodt</a></div>
            <div class="timeline-body">Please complete the following tasks
<ul>
<li>[X] I have searched the <a href="https://github.com/clap-rs/clap/discussions">discussions</a></li>
<li>[X] I have searched the <a href="https://github.com/clap-rs/clap/issues">open</a> and <a href="https://github.com/clap-rs/clap/issues?q=is%3Aissue+label%3AS-wont-fix+is%3Aclosed">rejected</a> issues</li>
</ul>
Rust Version
<p>rustc 1.83.0-nightly (52fd99839 2024-10-10)</p>
Clap Version
<p>4.5.7 w/ Derive</p>
Minimal reproducible code
<p>This example requires two separate files. I believe the <code>bin</code> file is counted as a separate crate.</p>
<p>src/lib.rs:</p>
<pre><code>use clap::Parser;
#[derive(Parser)]
#[clap(group(
    clap::ArgGroup::new(&quot;example&quot;)
        .required(true)
        .args(&amp;[&quot;noexists&quot;])
))]
pub struct Args {
}
</code></pre>
<p>src/bin/main.rs:</p>
<pre><code>use clap::Parser;

pub fn main() {
  let _args = clap_repro::Args::parse();
}

</code></pre>
<p>Maybe this is because there&#x27;s some difference between structs defined in the same crate vs</p>
Steps to reproduce the bug with the above code
<p><code>cargo run --release</code> with no commands.</p>
Actual Behaviour
<img alt="image" src="https://github.com/user-attachments/assets/ae4d2ee6-e57b-44f8-8a87-1e4b753c5b99">

<p>If I pass an arg that exists in the ArgGroup it works silently.</p>
Expected Behaviour
<p>It should error that the arg doesn&#x27;t exist and exit, regardless of other flags.</p>
Additional Context
<p><em>No response</em></p>
Debug Output
<p><em>No response</em></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">C-bug</span> added by <a href="https://github.com/JulianKnodt">@JulianKnodt</a> on 2024-10-29 06:45</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2024-10-29 14:24</div>
            <div class="timeline-body"><p>For me, I see this whether you have everything in the bin or split between bin and lib.</p>
<p>When you run without <code>--release</code>, the root cause is exposed:</p>
<pre><code>thread &#x27;main&#x27; panicked at /home/epage/.cargo/registry/src/index.crates.io-6f17d22bba15001f/clap_builder-4.5.20/src/bui
lder/debug_asserts.rs:292:13:
Command clap_repro: Argument group &#x27;example&#x27; contains non-existent argument &#x27;noexists&#x27;
note: run with `RUST_BACKTRACE=1` environment variable to display a backtrace
</code></pre>
<p>As this assert is caused by a development time bug that we report in dev builds, I&#x27;m inclined to close this.  If there is a reason for us to keep this open, let us know!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/epage">@epage</a> on 2024-10-29 14:24</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/JulianKnodt">@JulianKnodt</a> on 2024-10-29 17:27</div>
            <div class="timeline-body"><p>Hm, is it possible to indicate that the problem can be seen during a dev build? I only build my actual use case in release, so I was quite confused when I saw the fatal error.</p>
<p>If that&#x27;s not something y&#x27;all would like to change that&#x27;s fine</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2024-10-29 18:11</div>
            <div class="timeline-body"><p>We only build the more specialized assertions in dev builds that hit before these internal ones.  This is for build times, binary size, and runtime performance.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 20:00:21 UTC
    </footer>
</body>
</html>
