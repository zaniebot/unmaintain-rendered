<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>clap_generate: zsh broken with two multi length arguments - clap-rs/clap #3022</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>clap_generate: zsh broken with two multi length arguments</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/clap-rs/clap/issues/3022">#3022</a>
        opened by <a href="https://github.com/Morganamilo">@Morganamilo</a>
        on 2021-11-13 22:47
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Morganamilo">@Morganamilo</a></div>
            <div class="timeline-body">Please complete the following tasks
<ul>
<li>[X] I have searched the <a href="https://github.com/clap-rs/clap/discussions">discussions</a></li>
<li>[X] I have searched the existing issues</li>
</ul>
Rust Version
<p>rustc 1.58.0-nightly (8b09ba6a5 2021-11-09)</p>
Clap Version
<p>3.0.0-beta.5</p>
Minimal reproducible code
<pre><code>use clap::{App, IntoApp, Parser};
use clap_generate::{generate, Shell};
use std::io::stdout;

#[derive(Parser)]
pub struct Args {
    pub targets: Vec&lt;String&gt;,
    #[clap(required = true, raw = true)]
    pub files: Vec&lt;String&gt;,
}

fn main() {
    let mut app: App = Args::into_app();
    generate(Shell::Zsh, &amp;mut app, &quot;bug&quot;, &amp;mut stdout());
}
</code></pre>
Steps to reproduce the bug with the above code
<p>With the completion installed:</p>
<pre><code>% command &lt;tab&gt;
_arguments:comparguments:325: doubled rest argument definition: *::file -- Files to search for:
</code></pre>
Actual Behaviour
<p>So I have a program that has a usage like this: <code>program: &lt;targets&gt;... -- &lt;files&gt;...</code></p>
<p>The zsh completion seems to really not like this and spits out an error when tab is hit:</p>
<p><code>_arguments:comparguments:325: doubled rest argument definition: *::file -- Files to search for:</code></p>
<p>The completion generated is:</p>
<pre><code>#compdef bug

autoload -U is-at-least

_bug() {
    typeset -A opt_args
    typeset -a _arguments_options
    local ret=1

    if is-at-least 5.2; then
        _arguments_options=(-s -S -C)
    else
        _arguments_options=(-s -C)
    fi

    local context curcontext=&quot;$curcontext&quot; state line
    _arguments &quot;${_arguments_options[@]}&quot; \
&#x27;-h[Print help information]&#x27; \
&#x27;--help[Print help information]&#x27; \
&#x27;*::targets:&#x27; \
&#x27;*::files:&#x27; \
&amp;&amp; ret=0
}

(( $+functions[_bug_commands] )) ||
_bug_commands() {
    local commands; commands=()
    _describe -t commands &#x27;bug commands&#x27; commands &quot;$@&quot;
}

_bug &quot;$@&quot;%
</code></pre>
Expected Behaviour
<p>Don&#x27;t be broken</p>
Additional Context
<p><em>No response</em></p>
Debug Output
<p><em>No response</em></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">T: bug</span> added by <a href="https://github.com/Morganamilo">@Morganamilo</a> on 2021-11-13 22:47</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">C: generator</span> added by <a href="https://github.com/pksunkara">@pksunkara</a> on 2021-11-14 00:33</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2021-11-14 01:52</div>
            <div class="timeline-body"><p>Thanks for reporting this!</p>
<p>One challenge with completions is we have to effectively re-implement clap&#x27;s argument parsing for each shell we support.  Example of other issues that look like they stem from this:</p>
<ul>
<li>https://github.com/clap-rs/clap/issues/2729</li>
<li>https://github.com/clap-rs/clap/issues/2750</li>
<li>https://github.com/clap-rs/clap/issues/2145</li>
<li>https://github.com/clap-rs/clap/issues/1822</li>
<li>https://github.com/clap-rs/clap/issues/1764</li>
</ul>
<p>This is making me think that <a href="https://github.com/clap-rs/clap/issues/1232">clap-rs/clap#1232</a> is even more important so we can share parsing logic between different shells <em>and</em> clap and more easily test it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/pksunkara">@pksunkara</a> on 2021-11-14 02:41</div>
            <div class="timeline-body"><p>To be more explicitly clear, it&#x27;s not the parsing logic we need to share but rather the parsing requirements.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a>clap-rs/clap#1232</a> on 2021-11-15 14:31</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a>epage/clapng#238</a> on 2021-12-06 22:24</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a>clap-rs/clap#3166</a> on 2021-12-13 17:55</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">E-medium</span> added by <a href="https://github.com/epage">@epage</a> on 2021-12-13 22:13</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a>denoland/deno#13702</a> on 2022-02-17 13:27</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a>clap-rs/clap#3508</a> on 2022-04-24 14:34</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/drahnr">@drahnr</a> on 2022-04-24 15:08</div>
            <div class="timeline-body"><p>The same issue arises with a more common pattern too (see https://github.com/drahnr/clap-completion-zoink/blob/84a3eb106309d066e80645f60a3065525d18c5a4 for a full working example):</p>
<pre><code>#[derive(Debug, PartialEq, Eq, clap::Parser)]
#[clap(rename_all = &quot;kebab-case&quot;)]
struct Common {
    pub paths: Vec&lt;PathBuf&gt;,
}

#[derive(Debug, PartialEq, Eq, clap::Subcommand)]
#[clap(rename_all = &quot;kebab-case&quot;)]
enum Sub {
    Comp {
        #[clap(long)]
        shell: Shell,
    },
// imagine more subcommands here
}

#[derive(clap::Parser, Debug)]
#[clap(author, version, about, long_about = None)]
#[clap(rename_all = &quot;kebab-case&quot;)]
struct Args {
    #[clap(flatten)]
    pub common: Common,

    #[clap(subcommand)]
    pub command: Sub,
}
</code></pre>
<p>On tab completion results in</p>
<pre><code>./target/debug/clap-completion-zoink 
_arguments:comparguments:325: doubled rest argument definition: *::: :-&gt;clap-completion-zoink
</code></pre>
<pre><code>#compdef clap-completion-zoink

autoload -U is-at-least

_clap-completion-zoink() {
    typeset -A opt_args
    typeset -a _arguments_options
    local ret=1

    if is-at-least 5.2; then
        _arguments_options=(-s -S -C)
    else
        _arguments_options=(-s -C)
    fi

    local context curcontext=&quot;$curcontext&quot; state line
    _arguments &quot;${_arguments_options[@]}&quot; \
&#x27;-h[Print help information]&#x27; \
&#x27;--help[Print help information]&#x27; \
&#x27;-V[Print version information]&#x27; \
&#x27;--version[Print version information]&#x27; \
&#x27;*::paths:&#x27; \
&quot;:: :_clap-completion-zoink_commands&quot; \
&quot;*::: :-&gt;clap-completion-zoink&quot; \
&amp;&amp; ret=0
    case $state in
    (clap-completion-zoink)
        words=($line[2] &quot;${words[@]}&quot;)
        (( CURRENT += 1 ))
        curcontext=&quot;${curcontext%:*:*}:clap-completion-zoink-command-$line[2]:&quot;
        case $line[2] in
            (comp)
_arguments &quot;${_arguments_options[@]}&quot; \
&#x27;--shell=[]:SHELL: &#x27; \
&#x27;-h[Print help information]&#x27; \
&#x27;--help[Print help information]&#x27; \
&amp;&amp; ret=0
;;
(help)
_arguments &quot;${_arguments_options[@]}&quot; \
&#x27;*::subcommand -- The subcommand whose help message to display:&#x27; \
&amp;&amp; ret=0
;;
        esac
    ;;
esac
}

(( $+functions[_clap-completion-zoink_commands] )) ||
_clap-completion-zoink_commands() {
    local commands; commands=(
&#x27;comp:&#x27; \
&#x27;help:Print this message or the help of the given subcommand(s)&#x27; \
    )
    _describe -t commands &#x27;clap-completion-zoink commands&#x27; commands &quot;$@&quot;
}
(( $+functions[_clap-completion-zoink__comp_commands] )) ||
_clap-completion-zoink__comp_commands() {
    local commands; commands=()
    _describe -t commands &#x27;clap-completion-zoink comp commands&#x27; commands &quot;$@&quot;
}
(( $+functions[_clap-completion-zoink__help_commands] )) ||
_clap-completion-zoink__help_commands() {
    local commands; commands=()
    _describe -t commands &#x27;clap-completion-zoink help commands&#x27; commands &quot;$@&quot;
}

_clap-completion-zoink &quot;$@&quot;
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/TD-Sky">@TD-Sky</a> on 2022-11-10 08:39</div>
            <div class="timeline-body"><p>I meet the same bug.</p>
<p>clap version:</p>
<ul>
<li>clap-4.0.22</li>
<li>clap_complete-4.0.5</li>
</ul>
<p>The <code>Cli</code>: <a href="https://github.com/TD-Sky/conceal/blob/zsh-complete/src/cli.rs">cli.rs</a></p>
<p>The code to generate completions: <a href="https://github.com/TD-Sky/conceal/blob/zsh-complete/build.rs">build.rs</a></p>
<p>The zsh completion script: <a href="https://github.com/TD-Sky/conceal/blob/zsh-complete/completions/_cnc">_cnc.rs</a></p>
Error
<pre><code>_arguments:comparguments:327: doubled rest argument definition: *::: :-&gt;cnc
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a>oberblastmeister/trashy#57</a> on 2022-11-27 09:25</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a>garden-rs/garden#10</a> on 2023-01-08 04:22</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a>clap-rs/clap#4612</a> on 2023-01-09 10:58</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/davvid">@davvid</a> on 2023-01-09 11:01</div>
            <div class="timeline-body"><p>I believe <a href="https://github.com/clap-rs/clap/pull/4612">clap-rs/clap#4612</a> may resolve this issue. I ran into this while creating https://github.com/davvid/garden so I figured we might as well fix it (rather than <a href="https://davvid.github.io/garden/commands.html#zsh">workaround it</a>).</p>
<p>Kindly test it out and let me know if it works for y&#x27;all as well.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/TD-Sky">@TD-Sky</a> on 2023-01-11 07:48</div>
            <div class="timeline-body"><blockquote>
<p>I believe #4612 may resolve this issue. I ran into this while creating https://github.com/davvid/garden so I figured we might as well fix it (rather than <a href="https://davvid.github.io/garden/commands.html#zsh">workaround it</a>).</p>
<p>Kindly test it out and let me know if it works for y&#x27;all as well.</p>
</blockquote>
<p>Have you not fully fixed this feature yet? The completion doesn&#x27;t break now, but it also does nothing.</p>
<p>Here are the Cargo.toml and the completion script: https://gist.github.com/TD-Sky/59eb28d92f8dae38129182e66da6b00c</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/davvid">@davvid</a> on 2023-01-13 06:56</div>
            <div class="timeline-body"><p>@TD-Sky I spent some minutes trying to compile your project and looking into what might be u. It doesn&#x27;t look like the project you shared (conceal) compiles in the two branches I tried -- main and zsh-complete.</p>
<p>If you have a working branch that that is made worse by these changes then please share the details.</p>
<p>Feel free to take a look at how I&#x27;m setting up the subcommands but we probably shouldn&#x27;t clutter this issue with too many project-specific details. Anyways, here&#x27;s some working examples if you want to see them:</p>
<p>This is the top-level parser:
https://github.com/davvid/garden/blob/main/src/cli.rs#L50</p>
<p>And this is where the sub-commands are defined:
https://github.com/davvid/garden/blob/main/src/cli.rs#L94</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/TD-Sky">@TD-Sky</a> on 2023-01-16 08:34</div>
            <div class="timeline-body"><blockquote>
<p>@TD-Sky I spent some minutes trying to compile your project and looking into what might be u. It doesn&#x27;t look like the project you shared (conceal) compiles in the two branches I tried -- main and zsh-complete.</p>
<p>If you have a working branch that that is made worse by these changes then please share the details.</p>
<p>Feel free to take a look at how I&#x27;m setting up the subcommands but we probably shouldn&#x27;t clutter this issue with too many project-specific details. Anyways, here&#x27;s some working examples if you want to see them:</p>
<p>This is the top-level parser: https://github.com/davvid/garden/blob/main/src/cli.rs#L50</p>
<p>And this is where the sub-commands are defined: https://github.com/davvid/garden/blob/main/src/cli.rs#L94</p>
</blockquote>
<p>I have tried to compile with your patches in the local part of <code>conceal</code> branch <code>zsh-complete</code> and shared the Cargo.toml and completion script on gist. Should I push the patched version so you can try again?</p>
<p>I have read the code your arguments parser. But you don&#x27;t use <code>flatten</code> as I did. Is it possible there are two different bugs cause your patches don&#x27;t work for me?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/epage">@epage</a> on 2023-02-23 17:55</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:58:28 UTC
    </footer>
</body>
</html>
