<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>assert_defaults assumes parsers are stateless (e.g. don't check file system for a files existence) - clap-rs/clap #4643</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>assert_defaults assumes parsers are stateless (e.g. don't check file system for a files existence)</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/clap-rs/clap/issues/4643">#4643</a>
        opened by <a href="https://github.com/kmanc">@kmanc</a>
        on 2023-01-15 19:04
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/kmanc">@kmanc</a></div>
            <div class="timeline-body"><h3>Please complete the following tasks</h3>
<ul>
<li>[X] I have searched the <a href="https://github.com/clap-rs/clap/discussions">discussions</a></li>
<li>[X] I have searched the <a href="https://github.com/clap-rs/clap/issues">open</a> and <a href="https://github.com/clap-rs/clap/issues?q=is%3Aissue+label%3AS-wont-fix+is%3Aclosed">rejected</a> issues</li>
</ul>
<h3>Rust Version</h3>
<p>1.66.0</p>
<h3>Clap Version</h3>
<p>4.1.1</p>
<h3>Minimal reproducible code</h3>
<pre><code>use clap::{self, Arg, Command, ValueHint};
use std::path::Path;

fn main() -&gt; () {
    let app = cli();
    let matches = app.get_matches();
    let wordlist = matches.get_one::&lt;String&gt;(&quot;wordlist&quot;).unwrap().to_string();
}

fn cli() -&gt; Command {
    let app = clap::Command::new(clap::crate_name!())
        .version(clap::crate_version!())
        .author(clap::crate_authors!())
        .about(clap::crate_description!());

    app.arg(
        Arg::new(&quot;wordlist&quot;)
            .short('w')
            .value_name(&quot;WORDLIST&quot;)
            .num_args(1)
            .value_hint(ValueHint::FilePath)
            .default_value(&quot;/usr/share/wordlists/seclists/raft-medium-directories.txt&quot;)
            .value_parser(clap::builder::ValueParser::new(wordlist_parse_wrap))
            .help(&quot;Wordlist for web discovery&quot;),
    )
}

fn wordlist_parse_wrap(wordlist: &amp;str) -&gt; Result&lt;String, clap::Error&gt; {
    if !Path::new(&amp;wordlist).exists() {
        return Err(clap::Error::raw(
            clap::error::ErrorKind::ValueValidation,
            &quot;File does not exist&quot;,
        ));
    }
    Ok(wordlist.to_string())
}

</code></pre>
<h3>Steps to reproduce the bug with the above code</h3>
<p>cargo run</p>
<h3>Actual Behaviour</h3>
<p>thread 'main' panicked at 'Argument <code>wordlist</code>'s default_value=&quot;/usr/share/wordlists/seclists/raft-medium-directories.txt&quot; failed validation: error: invalid value '/usr/share/wordlists/seclists/raft-medium-directories.txt' for '-w <WORDLIST>': error: File does not exist</p>
<h3>Expected Behaviour</h3>
<p>error: invalid value '/usr/share/wordlists/seclists/raft-medium-directories.txt' for '-w <WORDLIST>': error: File does not exist</p>
<h3>Additional Context</h3>
<p>I know the <a href="https://docs.rs/clap/latest/clap/builder/struct.Command.html#method.debug_assert">documentation</a> states</p>
<blockquote>
<p>Most error states are handled as asserts under the assumption they are programming mistake and not something to handle at runtime</p>
</blockquote>
<p>But in this case it isn't a programmer mistake. The default value may or may not be valid in this case, but programmer mistakes should be catchable at compile time rather than runtime. Obviously the validity of the arg isn't knowable at compile time and can't be checked, but as a result a normal failure is more appropriate than a panic.</p>
<p>The two potential solutions that come to mind are:</p>
<ol>
<li>Completely remove the <a href="https://github.com/clap-rs/clap/blob/master/src/builder/debug_asserts.rs#L855">assert_default function</a></li>
<li>Create a new flag that can disable its use</li>
</ol>
<p>Option 1 seems like less work, but there may be valid uses of the function (I haven't come across one but I'm sure there's good reason for its existence). Option 2 would probably be more work, but it is more explicit and allows for the programmer to opt in to the unvalidated defaults.</p>
<h3>Debug Output</h3>
<p><em>No response</em></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">C-bug</span> added by @kmanc on 2023-01-15 19:04</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "assert_defaults panic instead of graceful failure" to "assert_defaults assumes parsers are stateless (e.g. don't check file system for a files existence)" by @epage on 2023-01-16 16:34</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2023-01-16 16:46</div>
            <div class="timeline-body"><p>I've clarified the title to what I see as the root issue.</p>
<p>The old title implied a third solution of having <code>Command::build</code> return an error which would not help in your situation as it still prevents you from parsing.</p>
<blockquote>
<p>but programmer mistakes should be catchable at compile time rather than runtime. Obviously the validity of the arg isn't knowable at compile time and can't be checked, but as a result a normal failure is more appropriate than a panic.</p>
</blockquote>
<p>Not all programmer mistakes can be.  We also regularly encourage people to <a href="https://docs.rs/clap/latest/clap/_derive/_tutorial/index.html#testing">add a test to help catch these asserts</a> so they are caught at test-time rather than in-prod.</p>
<p>However, seems irrelevant to the actual problem at hand.  Your parser is dependent on the state of the system and so asserting on the status of the parser can fail.</p>
<blockquote>
<p>there may be valid uses of the function (I haven't come across one but I'm sure there's good reason for its existence).</p>
</blockquote>
<p>When a user sets a raw default (ie a string) it might not be valid.  To catch this, the user needs to exhaustively test their application.  By adding an assert, we guaranteed that people will catch these bugs so long as they activate the debug asserts in a test.  See #3202.</p>
<blockquote>
<p>Create a new flag that can disable its use</p>
</blockquote>
<p>Flags come with API complexity and extra build time, both things that we are working on reducing.</p>
<p>#1695 is another route to resolving this.</p>
<p>Another option is for the application's file existence check to not be done within clap but to be done afterwards.</p>
<p>In deciding what route to go, something we should keep in mind is that this will also affect #4074.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/kmanc">@kmanc</a> on 2023-01-16 17:14</div>
            <div class="timeline-body"><p>That all makes sense, thanks for the explanations!</p>
<p>Specific to the following, I admit I hadn't considered the obvious, but as I think of it, surely I'm not the only one who has done something like this before. How do others usually tackle the problem of accepting a file as an argument? If there's a best practice around that I certainly don't know it but would like to!</p>
<blockquote>
<p>Another option is for the application's file existence check to not be done within clap but to be done afterwards.</p>
</blockquote>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2023-01-20 02:44</div>
            <div class="timeline-body"><blockquote>
<p>How do others usually tackle the problem of accepting a file as an argument? If there's a best practice around that I certainly don't know it but would like to!</p>
</blockquote>
<p>In my applications I pass the Patrh around and let the failure happen naturally on access.  For better error messages, some people use crates like <a href="https://crates.io/crates/fs-err">fs-err</a></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/kmanc">@kmanc</a> on 2023-01-21 22:43</div>
            <div class="timeline-body"><p>It feels a little weird to be able to validate <em>some</em> but not <em>all</em> arguments though doesn't it?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2023-01-24 15:41</div>
            <div class="timeline-body"><p>I doubt clap  will ever support validation of every case.  For example, an argument might depend on the value of another argument.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/kmanc">@kmanc</a> on 2023-02-12 18:08</div>
            <div class="timeline-body"><p>Reviewing this issue, I think it may be miscategorized. The real issue here is that a default argument that doesn't pass validation is <em>panicking</em> when it should more gracefully exit through https://github.com/clap-rs/clap/blob/master/src/error/format.rs#L313.</p>
<p>The valueparser shouldn't be responsible for managing state as you've mentioned, but it also shouldn't cause a panic when the mechanism for explaining that a value doesn't pass validation already exists</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2023-02-13 15:13</div>
            <div class="timeline-body"><p>This is categorized correctly</p>
<p>We were previously deferring all default parse errors to parse-time which made error reporting dependent on a specific command line and for the developer/user to be able to distinguish this as a development-time error.  We found people were mistyping their defaults and wanted to move this from &quot;test the right combination of command lines&quot; to a part of the process that will always catch this, our debug asserts.  This is what #3202 is about which I linked earlier.</p>
<p>Maybe you meant that programmer errors should pass up as errors, rather than panic.</p>
<ul>
<li>This won't help in your case because it will prevent parsing the command line</li>
<li>This would require having a failable builder.  Currently, for large trees of subcommands, we build only what is needed.  With a failable builder, we could force building all, slowing down those applications and hurting ergonomics by requiring an explicit build step, or we could mix it into the user error when doing a parse.  The derive API does this in some cases and is a frequent source of support issues.</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/kmanc">@kmanc</a> on 2023-02-13 16:08</div>
            <div class="timeline-body"><blockquote>
<p>Maybe you meant that programmer errors should pass up as errors, rather than panic.</p>
</blockquote>
<p>That is correct, and what I said in the original post. If that's not a change you intend to make that's fine, but the intuitiveness of clap suffers greatly as a result</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2023-02-13 16:45</div>
            <div class="timeline-body"><p>From experience in supporting clap users, we've had to support people more from problems with reporting developer errors through <code>Result</code> than where we do it through <code>panic</code>.</p>
<p>Even this issue, so far I've seen nothing that would have been helped by reporting this through <code>Result</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/kmanc">@kmanc</a> on 2023-02-14 07:02</div>
            <div class="timeline-body"><p>The difference is the user experience of a panic vs a graceful exit as if they had typed in any other non-valid value. If the default is a file they don't have on their machine because they prefer to use another they shouldn't get a panic without the opportunity to provide their own value</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2023-02-14 14:41</div>
            <div class="timeline-body"><blockquote>
<p>The difference is the user experience of a panic vs a graceful exit as if they had typed in any other non-valid value.</p>
</blockquote>
<p>From my experience in my own apps and supporting other people's apps, our panics are a better user experience for development-time bugs.</p>
<blockquote>
<p>If the default is a file they don't have on their machine because they prefer to use another they shouldn't get a panic without the opportunity to provide their own value</p>
</blockquote>
<p>Yes, I recognize that our current approach does not support parsers that are dependent on state, like the filesystem.  That is why this issue is still open.  I was not objecting to that but to trying to re-categegorize this.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../aj-bagwell/clio/issues/23.html">aj-bagwell/clio#23</a> on 2023-07-18 10:25</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/aj-bagwell">@aj-bagwell</a> on 2023-07-18 12:50</div>
            <div class="timeline-body"><p>I ran into this with <a href="https://github.com/aj-bagwell/clio">clio</a> where I was trying to set the default directory to './' which was panicing when the current working directory did not exist.</p>
<p>After I worked out that the asserts are only included in debug builds so won't affect real users, I decided that it was not that big an issue for me.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2023-07-18 19:04</div>
            <div class="timeline-body"><p>But it means users of clio wouldn't be able to run / test debug builds.</p>
<p>In weighing this vs #3202, I'm considering reverting the fix for #3202 and re-opening it.  We offer higher-level ways of doing most things that prevent bugs like that happening (<code>default_value_t</code>, <code>#[derive(ValueEum)]</code>)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/5017.html">clap-rs/clap#5017</a> on 2023-07-18 19:12</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @epage on 2023-07-18 20:00</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/3202.html">clap-rs/clap#3202</a> on 2023-07-18 20:01</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:48:59 UTC
    </footer>
</body>
</html>
