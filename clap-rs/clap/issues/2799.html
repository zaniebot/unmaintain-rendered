<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Can `ArgEnum` be both more general and performant? - clap-rs/clap #2799</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Can <code>ArgEnum</code> be both more general and performant?</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/clap-rs/clap/issues/2799">#2799</a>
        opened by <a href="https://github.com/epage">@epage</a>
        on 2021-10-01 13:46
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/epage">@epage</a></div>
            <div class="timeline-body"><p>#2762 initially had common API calls for <code>ArgValue</code> allocating a <code>Vec</code>.  We instead dropped that at the cost of adding the <code>Clone</code> super trait.</p>
<p>Can we do better?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">T: enhancement</span> added by @epage on 2021-10-01 13:46</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">E: breaking change</span> added by @epage on 2021-10-01 13:46</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone "3.0" by @epage on 2021-10-01 13:46</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ModProg">@ModProg</a> on 2021-10-01 14:31</div>
            <div class="timeline-body"><p>not <code>ArgValue</code> but <code>ArgEnum</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ModProg">@ModProg</a> on 2021-10-01 14:32</div>
            <div class="timeline-body"><p>One possible soluion would be returning an array using const generics and using the 2021 edition <code>into_iter</code> to be able to return the actual value of the array without a need to clone.</p>
<p>At least in theorie.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "Can `ArgValue` be both more general and performant?" to "Can `ArgEnum` be both more general and performant?" by @epage on 2021-10-01 15:23</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2021-10-01 15:24</div>
            <div class="timeline-body"><p>@pksunkara posted the following snippet as one idea</p>
<pre><code class="language-rust">trait ArgEnum&lt;const COUNT: usize&gt;: Sized {
    fn variants() -&gt; [Self; COUNT];
}

enum E {
    One,
    Two,
}

impl ArgEnum&lt;2&gt; for E {
    fn variants() -&gt; [Self; 2] {
        [Self::One, Self::Two]
    }
}

fn main() {}
</code></pre>
<p>https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=8ccbfd753fb15dab675ba0491c7f48a3</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2021-10-01 15:29</div>
            <div class="timeline-body"><p>@ModProg are you referring to using <code>trait ArgEnum&lt;const COUNT:usize&gt;</code>?</p>
<p>I see this is a trade off of making the trait harder to use vs requiring <code>Clone</code>.</p>
<p>Personally, I feel the <code>Clone</code> requirement is fairly minimal.  Probably 99% of <code>ArgEnum</code>s will be able to be <code>Copy</code>.  On some occasions, someone will have a <code>hidden</code> variant.  Among those using a <code>hidden</code> variant, what is the likelihood the type won't be <code>Clone</code>?  My guess is fairly small.    This is a niche of a niche that doesn't seem worth supporting.  Releasing as-is, we can see what feedback we end up getting and re-examine this for clap4.</p>
<p>I recommend we close this, creating a new issue based on specific user feedback if it comes in.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ModProg">@ModProg</a> on 2021-10-01 15:52</div>
            <div class="timeline-body"><blockquote>
<p>@ModProg are you referring to using <code>trait ArgEnum&lt;const COUNT:usize&gt;</code>?</p>
</blockquote>
<p>yes.</p>
<blockquote>
<p>I see this is a trade off of making the trait harder to use vs requiring Clone.</p>
</blockquote>
<p>The only thing about this that makes me consider it is, that most people will only derive but never implement it, so this only affects a small number of people. And while the <code>Clone</code> is only a minor inconvenience it affects a lot more, who probably don't even use most of the features provided by my new implementation.</p>
<p>But I also see another implementation that just moves the <code>to_string</code> implementation back to the derive macro, that way we don't need either the <code>Clone</code> nor const generics.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/pksunkara">@pksunkara</a> on 2021-10-01 16:06</div>
            <div class="timeline-body"><p>I agree with @ModProg regarding the estimates of how many use what kind of implementation.</p>
<blockquote>
<p>But I also see another implementation that just moves the to_string implementation back to the derive macro, that way we don't need either the Clone nor const generics.</p>
</blockquote>
<p>Do we have a clear example on how to achieve this?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ModProg">@ModProg</a> on 2021-10-01 16:22</div>
            <div class="timeline-body"><p>This was the way it was done before, it was changed here:
https://github.com/clap-rs/clap/pull/2762/commits/480035ac9c36490c4cccbf09e71b0ae84a6d527b#diff-1ea1dfdc52ed49bd532e4bd309c902a621e3bf02709b1fea86466c47fc7df7d9L118-L122</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2021-10-01 16:23</div>
            <div class="timeline-body"><p>To clarify, I'm not concerned about the implementer. With that said, I have a PR out for one hand-written <code>ArgEnum</code> and expect to create another,.  I also see more being written by crates that provide re-usable clap logic.  Updating a length as code changes feels like busy work and is a breaking change for those crates.  One the other hand, the cost of adding a <code>#[derive(Clone)]</code> is small, especially since people will most likely use it anyways.</p>
<p>However, creating a trait that can only be used in very specific ways because of the way the generic parameter is defined, severely limits our ability to evolve clap.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2021-10-01 16:26</div>
            <div class="timeline-body"><p>@ModProg, I thought the inherent <code>from_str</code> was a side benefit to us having to already make this change so that <code>arg_values</code> wouldn't return a <code>Vec</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ModProg">@ModProg</a> on 2021-10-01 16:31</div>
            <div class="timeline-body"><blockquote>
<p>@ModProg, I thought the inherent <code>from_str</code> was a side benefit to us having to already make this change so that <code>arg_values</code> wouldn't return a <code>Vec</code>.</p>
</blockquote>
<p>It is, but it more enables the inherent <code>from_str</code> than requiring it.</p>
<p>The problem with the &quot;generated&quot; form is that we have to create the ArgValue for each call. tho I don't know if there is some optimazation happening because it technicly is a constant value even tho due to alias being a Vec we cannot declare it as const.</p>
<p>Another though is, we could also create the actual ArgValue during deriving, call <code>get_name_and_aliases</code> on it and put that value in the derived implementation. So it really is a constant array/slice for every variant.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ModProg">@ModProg</a> on 2021-10-01 16:33</div>
            <div class="timeline-body"><p>The advantage to using the <code>matches</code> on ArgValue is, that it makes sure we use the same implementation in both the derived and build.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/kbknapp">@kbknapp</a> on 2021-10-05 01:01</div>
            <div class="timeline-body"><p>I've only skimmed this issue, but in general I don't believe adding a const generic type argument to <code>ArgEnum</code> is worth the performance gain by not allocating a small <code>Vec</code>. My reasoning is <code>clap</code> still allocates, so it's not like we're removing all allocations. Additionally, <code>Enum::values()</code> would most likely only be called when either generating the help message, or other &quot;generating&quot; operation such as completion script, etc. I.e. it should not be allocating in the happy path of standard parsing. And even if it <em>does</em> we're still only talking a small <code>Vec</code> since allocation.</p>
<p>The cost however is a generic argument that's not entirely clear at first glance what it's for: <code>Enum&lt;3&gt;</code> doesn't mean a whole ton when the enum's variants are <code>Foo</code>, <code>Bar</code>, and <code>Baz</code> and it turns out that generic argument just so we can return an array size hint.</p>
<p>I would like to see improvement around ArgEnum for sure, but I think this is one of those issues that we can place on the back burner and garner some good ideas as v3 fleshes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2021-10-05 14:06</div>
            <div class="timeline-body"><p>For comparison purposes</p>
<h3>Original</h3>
<pre><code class="language-rust">pub trait ArgEnum: Sized {
    const VARIANTS: &amp;'static [&amp;'static str];
    fn from_str(input: &amp;str, case_insensitive: bool) -&gt; Result&lt;Self, String&gt;;
    fn as_arg(&amp;self) -&gt; Option&lt;&amp;'static str&gt;;
}
</code></pre>
<ul>
<li>Wanted to add <code>ArgValue</code> support for native alias, hidden support, etc</li>
</ul>
<h3>Current Solution</h3>
<pre><code class="language-rust">pub trait ArgEnum: Sized + Clone {
    fn value_variants&lt;'a&gt;() -&gt; &amp;'a [Self];
    fn from_str(input: &amp;str, case_insensitive: bool) -&gt; Result&lt;Self, String&gt;;
    fn to_arg_value&lt;'a&gt;(&amp;self) -&gt; Option&lt;ArgValue&lt;'a&gt;&gt;;
}
</code></pre>
<ul>
<li>Forces <code>Clone</code><ul>
<li>Most arg enums would work as <code>Copy</code></li>
<li>A few use <code>hidden</code>, and of those, they mostly likely support <code>Clone</code>, making the impact very small</li>
</ul>
</li>
</ul>
<h3><code>Vec</code> Solution</h3>
<pre><code class="language-rust">pub trait ArgEnum: Sized {
    fn variants() -&gt; Vec&lt;ArgValue&lt;'static&gt;&gt;;
    fn from_str(input: &amp;str, case_insensitive: bool) -&gt; Result&lt;Self, String&gt;;
    fn as_arg(&amp;self) -&gt; Option&lt;ArgValue&lt;'static&gt;&gt;;
}
</code></pre>
<ul>
<li><code>Arg::new(&quot;foo&quot;).possible_values(arg_enum.variants())</code> does a throw-away allocation when building</li>
<li>An inherent implementation for <code>from_str</code> would cause an allocation for parsing as well, since it'd call <code>variants</code></li>
</ul>
<h3><code>const</code> Solution</h3>
<pre><code class="language-rust">trait ArgEnum&lt;const COUNT: usize&gt;: Sized {
    fn variants() -&gt; [Self; COUNT];
    fn from_str(input: &amp;str, case_insensitive: bool) -&gt; Result&lt;Self, String&gt;;
    fn as_arg(&amp;self) -&gt; Option&lt;ArgValue&lt;'static&gt;&gt;;
}
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/pksunkara">@pksunkara</a> on 2021-10-09 01:48</div>
            <div class="timeline-body"><p>I am happy with where it is for 3.0, but we can keep this open for future. Removing the milestone.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Removed from milestone "3.0" by @pksunkara on 2021-10-09 01:48</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../epage/clapng/issues/209.html">epage/clapng#209</a> on 2021-12-06 22:13</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">A-builder</span> added by @epage on 2021-12-13 19:22</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">S-waiting-on-design</span> added by @epage on 2021-12-13 19:22</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2022-02-08 23:57</div>
            <div class="timeline-body"><p>I feel like our current option is &quot;good enough&quot; until we get real world use cases with problems.  Closing for now</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @epage on 2022-02-08 23:57</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">S-waiting-on-design</span> removed by @epage on 2022-02-08 23:57</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">S-wont-fix</span> added by @epage on 2022-02-08 23:57</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/3911.html">clap-rs/clap#3911</a> on 2022-07-12 14:45</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:48:05 UTC
    </footer>
</body>
</html>
