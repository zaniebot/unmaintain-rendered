<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Allow access to previous args in completion function for context-sensitive completions - clap-rs/clap #5784</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Allow access to previous args in completion function for context-sensitive completions</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/clap-rs/clap/issues/5784">#5784</a>
        opened by <a href="https://github.com/LucasPickering">@LucasPickering</a>
        on 2024-10-21 12:10
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/LucasPickering">@LucasPickering</a></div>
            <div class="timeline-body">Please complete the following tasks
<ul>
<li>[X] I have searched the <a href="https://github.com/clap-rs/clap/discussions">discussions</a></li>
<li>[X] I have searched the <a href="https://github.com/clap-rs/clap/issues">open</a> and <a href="https://github.com/clap-rs/clap/issues?q=is%3Aissue+label%3AS-wont-fix+is%3Aclosed">rejected</a> issues</li>
</ul>
Clap Version
<p>clap 4.4.2, clap_complete 4.5.29</p>
Describe your use case
<p>In a <a href="https://docs.rs/clap_complete/latest/clap_complete/engine/struct.ArgValueCompleter.html">ArgValueCompleter</a> function, it would be nice to have access to what has been parsed so far when generating completions. My use case is that I&#x27;m loading the arguments from a YAML file, but the file to load from can be overridden by a prior <code>-f</code> argument. Another identical example is <a href="https://docs.docker.com/reference/cli/docker/compose/run/">docker-compose run</a>: You can run <code>docker-compose run &lt;service&gt;</code> in which case it will load services from <code>docker-compose.yml</code>, or you can do <code>docker-compose -f different/compose/file.yml run &lt;service&gt;</code>, in which case it should load from <code>different/compose/file.yml</code>.</p>
Describe the solution you&#x27;d like
<p>Access to what has already been parsed as an argument to the <code>ArgValueCompleter</code> function. This would most likely be a breaking change because it requires adding an argument to <a href="https://docs.rs/clap_complete/latest/clap_complete/engine/trait.ValueCompleter.html">ValueCompleter::complete</a>. The user impact could be mitigated though by keeping the blanket impl on <code>fn(&amp;OsStr) -&gt; Vec&lt;CompletionCandidate&gt;</code>. I imagine most users are not implementing <code>ValueCompleter</code> themselves.</p>
<p>The best I can think of is the additional argument is just a <code>&amp;[&amp;OsStr]</code> containing what&#x27;s already been parsed. The completer would then be responsible for iterating over that and figuring out the semantic meaning. It&#x27;d be great if we could get the prior arguments in a more structured form, but doing that without the full command present is probably not possible. So an example completion function for something like <code>docker-compose run</code> would look like:</p>
<pre><code>fn complete_service(current: &amp;OsStr, previous: &amp;[&amp;OsStr]) -&gt; Vec&lt;CompletionCandidate&gt; {
    let file_arg_index = previous.iter().position(|arg| arg == &quot;-f&quot; || arg == &quot;--file&quot;);
    let path = if let Some(file_index) = file_arg_index {
        previous[file_arg_index + 1]
    } else {
        &quot;docker-compose.yml&quot;
    };
    let Ok(config) = load_config(path) else {return vec![]};
    config
        .services
        .into_iter()
        .map(|service| CompletionCandidate::new(service.name))
        .collect()
}
</code></pre>
<p>(this is pseudocode, I&#x27;m sure it doesn&#x27;t actually compile but it should get the idea across)</p>
Alternatives, if applicable
<ul>
<li>Manually parse <code>std::env::args</code> and look for <code>-f</code> or <code>--file</code>. This requires you to manually skip over the first few items to get to where the arguments start, which is fragile</li>
<li>Use my app&#x27;s <code>Command</code> struct to parse <code>std::env::args</code>, but this requires everything already present to constitute a valid command, i.e. it can&#x27;t be used to complete a required argument (unless at least one character has already been typed)</li>
</ul>
Additional Context
<ul>
<li>Related to #3166</li>
<li>My completion functions are <a href="https://github.com/LucasPickering/slumber/blob/adcca444904a64ffd097ff38b5d1d0883314f1bc/crates/cli/src/completions.rs">here</a></li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">C-enhancement</span> added by <a href="https://github.com/LucasPickering">@LucasPickering</a> on 2024-10-21 12:10</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">A-completion</span> added by <a href="https://github.com/epage">@epage</a> on 2024-10-21 23:50</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2024-10-21 23:57</div>
            <div class="timeline-body"><p>Huh, I thought we had an issue for this but can&#x27;t find one. Passing in an <code>OsStr</code> slice wouldn&#x27;t be ideal as people would have to hack-in their own parsing. We&#x27;d likely want â€˜ArgMatches<code>or something like it. The challenge with</code>ArgMatches` is we&#x27;ve not exposed the API for making one. More generally, #5515 is a good intermediate step.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">S-waiting-on-design</span> added by <a href="https://github.com/epage">@epage</a> on 2024-10-21 23:58</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/LucasPickering">@LucasPickering</a> on 2024-10-22 00:46</div>
            <div class="timeline-body"><p>Yes <code>ArgMatches</code> seems perfect. Is there a need to expose the construction of it? I would think the completion engine could construct the <code>ArgMatches</code> then pass it into the user&#x27;s completer functions.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2024-10-22 15:46</div>
            <div class="timeline-body"><p><code>ArgMatches</code> lives in <code>clap</code> and so the constructor would need to be exposed so <code>clap_complete</code> could make one and pass it to the users completer.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/LucasPickering">@LucasPickering</a> on 2024-10-23 01:48</div>
            <div class="timeline-body"><p>Ah of course. What can I do to help with this? I don&#x27;t have a ton of time to dedicate to it but I&#x27;d like to help if possible.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2024-10-23 01:57</div>
            <div class="timeline-body"><p>This is one of the lower priority tasks as we are focusing on</p>
<ul>
<li>feature parity with existing completion generator</li>
<li>feature parity with cargo&#x27;s hand written completions as that is our primary test case for the design</li>
</ul>
<p>As such, I&#x27;m not going to be setting aside the time to help drive the design of this forward for this to be resolved atm.</p>
<p>Previously, I said that #5784 might be initial step but I just realized that there is some extra complexity to that that I had overlooked.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a>jj-vcs/jj#4823</a> on 2024-11-12 01:40</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a>jj-vcs/jj#4887</a> on 2024-11-21 08:52</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from &quot;clap_complete: Allow access to previous args in completion function&quot; to &quot;Allow access to previous args in completion function for context-sensitive completions&quot; by <a href="https://github.com/epage">@epage</a> on 2025-01-20 15:28</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a>clap-rs/clap#5884</a> on 2025-01-20 15:31</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 20:00:21 UTC
    </footer>
</body>
</html>
