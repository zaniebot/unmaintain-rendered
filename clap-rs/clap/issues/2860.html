<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shell completions include `--version` on subcommands despite no version set - clap-rs/clap #2860</title>
    <link rel="stylesheet" href="../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../index.html">Back to index</a>
    </div>

    <h1>Shell completions include `--version` on subcommands despite no version set</h1>

    <div class="meta">
        <span class="state state-closed">Closed</span>
        <a href="https://github.com/clap-rs/clap/issues/2860">#2860</a>
        opened by <a href="https://github.com/epage">@epage</a>
        on 2021-10-12 17:01
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/epage">@epage</a> on 2021-10-12 17:01</div>
            <div class="timeline-body"><h3>Please complete the following tasks</h3>
<ul>
<li>[X] I have searched the <a href="https://github.com/clap-rs/clap/discussions">discussions</a></li>
<li>[X] I have searched the existing issues</li>
</ul>
<h3>Rust Version</h3>
<p>rustc 1.55.0 (c8dfcfe04 2021-09-06)</p>
<h3>Clap Version</h3>
<p>master</p>
<h3>Minimal reproducible code</h3>
<p>This snippet is using the API the generators used, so it can demonstrate the problem</p>
<pre><code class="language-rust">fn main() {
    use clap::*;
    let mut app = App::new(&quot;fig&quot;)
        .about(&quot;Tests completions&quot;)
        .arg(
            Arg::new(&quot;file&quot;)
                .value_hint(ValueHint::FilePath)
                .about(&quot;some input file&quot;),
        )
        .subcommand(
            App::new(&quot;test&quot;).about(&quot;tests things&quot;).arg(
                Arg::new(&quot;case&quot;)
                    .long(&quot;case&quot;)
                    .takes_value(true)
                    .about(&quot;the case to test&quot;),
            ),
        );

    app.get_matches_mut();
    for flag in clap_generate::utils::flags(&amp;app) {
        if flag.get_name() == &quot;version&quot; {
            dbg!(flag);
        }
    }

    for subcommand in app.get_subcommands() {
        for flag in clap_generate::utils::flags(&amp;subcommand) {
            if flag.get_name() == &quot;version&quot; {
                dbg!(subcommand.get_name());
                dbg!(flag);
            }
        }
    }
}

</code></pre>
<h3>Steps to reproduce the bug with the above code</h3>
<p>Run it</p>
<h3>Actual Behaviour</h3>
<p>See a <code>version</code> flag included for each subcommand</p>
<h3>Expected Behaviour</h3>
<p>No output should happen</p>
<h3>Additional Context</h3>
<p>This was found as part of #2858.</p>
<p>If I'm reading this correctly, #2831 relied on <code>fn _build</code> to remove <code>--version</code> in the call to <code>_check_help_and_version</code> <strong>but</strong> we don't recursively call <code>_build</code> on subcommands, leaving the auto-generated flag behind.</p>
<p>if this is the case, then probably a lot of subcommand behavior is broken because we'd never call <code>_build</code> on their args.</p>
<h3>Debug Output</h3>
<pre><code>[            clap::build::app]  App::_do_parse
[            clap::build::app]  App::_build
[            clap::build::app]  App::_propagate:fig
[            clap::build::app]  App::_check_help_and_version
[            clap::build::app]  App::_check_help_and_version: Removing generated version
[            clap::build::app]  App::_check_help_and_version: Building help subcommand
[            clap::build::app]  App::_propagate_global_args:fig
[            clap::build::app]  App::_derive_display_order:fig
[            clap::build::app]  App::_derive_display_order:test
[            clap::build::app]  App::_derive_display_order:help
[clap::build::app::debug_asserts]       App::_debug_asserts
[clap::build::arg::debug_asserts]       Arg::_debug_asserts:help
[clap::build::arg::debug_asserts]       Arg::_debug_asserts:file
[         clap::parse::parser]  Parser::get_matches_with
[         clap::parse::parser]  Parser::_build
[         clap::parse::parser]  Parser::_verify_positionals
[         clap::parse::parser]  Parser::remove_overrides
[      clap::parse::validator]  Validator::validate
[         clap::parse::parser]  Parser::add_env: Checking arg `--help`
[         clap::parse::parser]  Parser::add_env: Checking arg `&lt;file&gt;`
[         clap::parse::parser]  Parser::add_defaults
[         clap::parse::parser]  Parser::add_defaults:iter:file:
[         clap::parse::parser]  Parser::add_value: doesn't have conditional defaults
[         clap::parse::parser]  Parser::add_value:iter:file: doesn't have default vals
[         clap::parse::parser]  Parser::add_value:iter:file: doesn't have default missing vals
[      clap::parse::validator]  Validator::validate_conflicts
[      clap::parse::validator]  Validator::validate_exclusive
[      clap::parse::validator]  Validator::gather_conflicts
[      clap::parse::validator]  Validator::validate_required: required=ChildGraph([])
[      clap::parse::validator]  Validator::gather_requirements
[      clap::parse::validator]  Validator::validate_required_unless
[      clap::parse::validator]  Validator::validate_matched_args
[    clap::parse::arg_matcher]  ArgMatcher::get_global_values: global_arg_vec=[help]
</code></pre>
<p>Note the single logged <code>App::_build</code>, rather than one-per-subcommand.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">T: bug</span> added by @epage on 2021-10-12 17:01</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">C: generator</span> added by @epage on 2021-10-12 17:01</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone "3.0" by @epage on 2021-10-12 17:01</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/pksunkara">@pksunkara</a> on 2021-10-12 17:11</div>
            <div class="timeline-body"><p>Oof, I forgot about tracking this issue. The context is:</p>
<p>We do lazy building of the subcommand to improve performance in our parser once we match a subcommand. But generators need all the subcommands to be built. I have a <code>TODO</code> marked <a href="https://github.com/clap-rs/clap/blob/master/clap_generate/src/lib.rs#L253">here</a> about this.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2021-10-12 17:15</div>
            <div class="timeline-body"><p>Thanks for the pointer!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @epage by @epage on 2021-10-12 17:16</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/2863.html">clap-rs/clap#2863</a> on 2021-10-12 20:19</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @bors[bot] on 2021-10-12 22:31</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:28:33 UTC
    </footer>
</body>
</html>
