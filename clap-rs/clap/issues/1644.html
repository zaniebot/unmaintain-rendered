<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fatal internal error when arg requirement doesn't exist - clap-rs/clap #1644</title>
    <link rel="stylesheet" href="../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../index.html">Back to index</a>
    </div>

    <h1>Fatal internal error when arg requirement doesn't exist</h1>

    <div class="meta">
        <span class="state state-closed">Closed</span>
        <a href="https://github.com/clap-rs/clap/issues/1644">#1644</a>
        opened by <a href="https://github.com/sharnoff">@sharnoff</a>
        on 2020-01-26 19:39
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/sharnoff">@sharnoff</a> on 2020-01-26 19:39</div>
            <div class="timeline-body"><h3>Rust Version</h3>
<p><code>rustc 1.40.0 (73528e339 2019-12-16)</code></p>
<h3>Affected Version of clap</h3>
<p>Both <code>2.33.0</code> and <code>3.0.0-beta.1</code> (from git)</p>
<h3>Expected Behavior Summary</h3>
<p>Clap should complain (to the writer of the app - not the end user of the interface) that one of the arguments requires an <code>Arg</code> that does not exist - i.e. has not been added to the <code>App</code>.</p>
<h3>Actual Behavior Summary</h3>
<p>Fatal internal error.</p>
<h3>Steps to Reproduce the issue</h3>
<p>See sample code below.</p>
<h3>Sample Code or Link to Sample Code</h3>
<pre><code class="language-rust">fn main() {
    // The issue also persists when loading from yaml (where I originally found it)
    // the only difference is that if we don't give a name for the App, it doesn't
    // panic.
    let app = clap::App::new(&quot;clap-issue-1644&quot;)
        .arg(clap::Arg::with_name(&quot;foo&quot;)
                // It doesn't matter whether we use a short or long value here;
                // clap still crashes
                .long(&quot;foo&quot;)
                .requires(&quot;missing-arg&quot;));

    app.get_matches();
}
</code></pre>
<h3>Debug output</h3>
<details>
<summary> Debug Output (v2.33.0) </summary>
<pre>
<code>
DEBUG:clap:Parser::propagate_settings: self=clap-issue-1644, g_settings=AppFlags(
    (empty),
)
DEBUG:clap:Parser::get_matches_with;
DEBUG:clap:Parser::create_help_and_version;
DEBUG:clap:Parser::create_help_and_version: Building --help
DEBUG:clap:Parser::create_help_and_version: Building --version
DEBUG:clap:Parser::get_matches_with: Begin parsing '"--foo"' ([45, 45, 102, 111, 111])
DEBUG:clap:Parser::is_new_arg:"--foo":NotFound
DEBUG:clap:Parser::is_new_arg: arg_allows_tac=false
DEBUG:clap:Parser::is_new_arg: -- found
DEBUG:clap:Parser::is_new_arg: starts_new_arg=true
DEBUG:clap:Parser::possible_subcommand: arg="--foo"
DEBUG:clap:Parser::get_matches_with: possible_sc=false, sc=None
DEBUG:clap:ArgMatcher::process_arg_overrides:None;
DEBUG:clap:Parser::parse_long_arg;
DEBUG:clap:Parser::parse_long_arg: Does it contain '='...No
DEBUG:clap:Parser::parse_long_arg: Found valid flag '--foo'
DEBUG:clap:Parser::check_for_help_and_version_str;
DEBUG:clap:Parser::check_for_help_and_version_str: Checking if --foo is help or version...Neither
DEBUG:clap:Parser::parse_flag;
DEBUG:clap:ArgMatcher::inc_occurrence_of: arg=foo
DEBUG:clap:ArgMatcher::inc_occurrence_of: first instance
DEBUG:clap:Parser::groups_for_arg: name=foo
DEBUG:clap:Parser::groups_for_arg: No groups defined
DEBUG:clap:Parser:get_matches_with: After parse_long_arg Flag
DEBUG:clap:ArgMatcher::process_arg_overrides:Some("foo");
DEBUG:clap:Parser::remove_overrides:[];
DEBUG:clap:Validator::validate;
DEBUG:clap:Parser::add_defaults;
DEBUG:clap:Validator::validate_blacklist;
DEBUG:clap:Validator::validate_blacklist:iter:foo;
DEBUG:clap:Parser::groups_for_arg: name=foo
DEBUG:clap:Parser::groups_for_arg: No groups defined
DEBUG:clap:Validator::validate_required: required=[];
DEBUG:clap:Validator::validate_matched_args;
DEBUG:clap:Validator::validate_matched_args:iter:foo: vals=[]
DEBUG:clap:Validator::validate_arg_requires:foo;
DEBUG:clap:Validator::missing_required_error: extra=Some("mising-arg")
DEBUG:clap:Parser::color;
DEBUG:clap:Parser::color: Color setting...Auto
DEBUG:clap:is_a_tty: stderr=true
DEBUG:clap:Validator::missing_required_error: reqs=[
    "mising-arg",
]
DEBUG:clap:usage::get_required_usage_from: reqs=["mising-arg"], extra=Some("mising-arg")
DEBUG:clap:usage::get_required_usage_from: after init desc_reqs=["mising-arg"]
DEBUG:clap:usage::get_required_usage_from: no more children
DEBUG:clap:usage::get_required_usage_from: final desc_reqs=["mising-arg"]
DEBUG:clap:usage::get_required_usage_from: args_in_groups=[]
DEBUG:clap:usage::get_required_usage_from:iter:mising-arg:
thread 'main' panicked at 'Fatal internal error. Please consider filing a bug report at https://github.com/clap-rs/clap/issues', src/libcore/option.rs:1185:5
note: run with `RUST_BACKTRACE=1` environment variable to display a backtrace.
</code>
</pre>
</details>

<details>
<summary> Debug Output (v3.0.0-beta.1) </summary>
<pre>
<code>
DEBUG:clap:App::_do_parse;
DEBUG:clap:App::_build;
DEBUG:clap:App::_derive_display_order:clap-issue-1644
DEBUG:clap:App::_create_help_and_version;
DEBUG:clap:App::_create_help_and_version: Building --help
DEBUG:clap:App::_create_help_and_version: Building --version
DEBUG:clap:App::_arg_debug_asserts:foo
DEBUG:clap:App::_arg_debug_asserts:help
DEBUG:clap:App::_arg_debug_asserts:version
DEBUG:clap:App::_app_debug_asserts;
DEBUG:clap:Parser::get_matches_with;
DEBUG:clap:Parser::_build;
DEBUG:clap:Parser::_verify_positionals;
DEBUG:clap:Parser::get_matches_with: Begin parsing '"--foo"' ([45, 45, 102, 111, 111])
DEBUG:clap:Parser::is_new_arg:"--foo":NotFound
DEBUG:clap:Parser::is_new_arg: arg_allows_tac=false
DEBUG:clap:Parser::is_new_arg: -- found
DEBUG:clap:Parser::is_new_arg: starts_new_arg=true
DEBUG:clap:Parser::possible_subcommand: arg="--foo"
DEBUG:clap:Parser::get_matches_with: possible_sc=false, sc=None
DEBUG:clap:Parser::parse_long_arg;
DEBUG:clap:Parser::parse_long_arg: Does it contain '='...No
DEBUG:clap:Parser::parse_long_arg: Found valid opt or flag '--foo'
DEBUG:clap:Parser::check_for_help_and_version_str;
DEBUG:clap:Parser::check_for_help_and_version_str: Checking if --foo is help or version...Neither
DEBUG:clap:Parser::parse_flag;
DEBUG:clap:ArgMatcher::inc_occurrence_of: arg=4741034841092048056
DEBUG:clap:ArgMatcher::inc_occurrence_of: first instance
DEBUG:clap:Parser::groups_for_arg: name=4741034841092048056
DEBUG:clap:Parser:get_matches_with: After parse_long_arg Flag
DEBUG:clap:Parser::remove_overrides;
DEBUG:clap:Parser::remove_overrides:iter:4741034841092048056;
DEBUG:clap:Validator::validate;
DEBUG:clap:Parser::add_defaults;
DEBUG:clap:Validator::validate_conflicts;
DEBUG:clap:Validator::validate_conflicts_with_everything;
DEBUG:clap:Validator::validate_conflicts_with_everything:iter:4741034841092048056;
DEBUG:clap:Validator::gather_conflicts;
DEBUG:clap:Validator::gather_conflicts:iter:4741034841092048056;
DEBUG:clap:Parser::groups_for_arg: name=4741034841092048056
DEBUG:clap:Validator::validate_required: required=ChildGraph([]);
DEBUG:clap:Validator::gather_requirements;
DEBUG:clap:Validator::gather_requirements:iter:4741034841092048056;
DEBUG:clap:Validator::validate_required:iter:aog=18152889946298061510;
DEBUG:clap:Validator::validate_required_unless;
DEBUG:clap:Validator::validate_matched_args;
DEBUG:clap:Validator::validate_matched_args:iter:4741034841092048056: vals=[]
DEBUG:clap:Validator::validate_arg_num_vals;
DEBUG:clap:Validator::validate_arg_values: arg="foo"
DEBUG:clap:Validator::validate_arg_requires:foo;
DEBUG:clap:Validator::missing_required_error; incl=Some(18152889946298061510)
DEBUG:clap:App::color;
DEBUG:clap:App::color: Color setting...Auto
DEBUG:clap:is_a_tty: stderr=true
DEBUG:clap:Validator::missing_required_error: reqs=ChildGraph([Child { id: 18152889946298061510, children: None }])
DEBUG:clap:Usage::get_required_usage_from: incls=[18152889946298061510], matcher=true, incl_last=true
DEBUG:clap:Usage::get_required_usage_from:iter:18152889946298061510:
thread 'main' panicked at 'Fatal internal error. Please consider filing a bug report at https://github.com/kbknapp/clap-rs/issues', src/libcore/option.rs:1185:5
note: run with `RUST_BACKTRACE=1` environment variable to display a backtrace.
</code>
</pre>
</details>

</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/CreepySkeleton">@CreepySkeleton</a> on 2020-02-01 10:16</div>
            <div class="timeline-body"><p>I think that panicking is exactly what we need to do here, this <em>is</em> the way to inform developer of problems like this one.</p>
<p>But we do need to rework panic messages in debug builds.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone "v3.0.0-alpha.3" by @CreepySkeleton on 2020-02-01 10:46</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">C: errors</span> added by @CreepySkeleton on 2020-02-01 10:47</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">D: easy</span> added by @CreepySkeleton on 2020-02-01 10:47</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">help wanted</span> added by @CreepySkeleton on 2020-02-01 10:47</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/1479.html">clap-rs/clap#1479</a> on 2020-02-01 13:37</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/pksunkara">@pksunkara</a> on 2020-02-01 22:36</div>
            <div class="timeline-body"><p>Looks similar to #990</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/CreepySkeleton">@CreepySkeleton</a> on 2020-02-02 02:21</div>
            <div class="timeline-body"><p>First, the <code> Please consider filing a bug report</code> part should be omitted in debug builds, this message is aimed at users but not developers.</p>
<p>Second, the backtrace is good, but the error should be more descriptive in my opinion.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Dylan-DPC-zz">@Dylan-DPC-zz</a> on 2020-02-02 14:59</div>
            <div class="timeline-body"><blockquote>
<p>First, the Please consider filing a bug report part should be omitted in debug builds, this message is aimed at users but not developers.</p>
</blockquote>
<p>For debug build, our users are our developers ðŸ˜„</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/CreepySkeleton">@CreepySkeleton</a> on 2020-02-09 10:47</div>
            <div class="timeline-body"><p>Here's one another example why we need more descriptive messages https://github.com/TeXitoi/structopt/issues/348</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sharnoff">@sharnoff</a> on 2020-02-09 12:02</div>
            <div class="timeline-body"><p>Is there a rough idea of what should be done here? If so, I'd be happy write up a pull request</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/CreepySkeleton">@CreepySkeleton</a> on 2020-02-09 14:35</div>
            <div class="timeline-body"><p>This is complicated.</p>
<p>People who encounter an error originating from <code>clap</code> can be divided into two groups:</p>
<ul>
<li>Developers who use clap to build their own programs, e.g people who use clap as library. Let's call them <code>developers</code>.</li>
<li>End users who use programs written by <code>developers</code>, let's call them <code>users</code>.</li>
</ul>
<p>There are three types of errors:</p>
<ul>
<li>Bugs in <code>clap</code> itself, <code>clap-bug</code></li>
<li>Bugs in programs written by <code>developers</code>, <code>prog-bug</code>.</li>
<li>Malformed input from <code>users</code>, <code>input</code>.</li>
</ul>
<p><code>developers</code> are interested in seeing good descriptive panics (and not just &quot;BOOM, program panicked with clap internal error&quot;) when it comes to <code>prog-bug</code> errors; besides, it would be good to direct them to clap bugtracker in case they encounter <code>clap-bug</code>.</p>
<p><code>users</code> don't want to think about it, they only need a link to bugtracker. I think we should give <code>developers</code> a way to specify their own bugtracker so <code>users</code> would go there.</p>
<p>Something like this:</p>
<p>|                   | <code>clap-bug</code>                   | <code>prog-bug</code> | <code>input</code>
| -- | -- | -- | -- |
| <code>developers</code> | <code>panic</code> with  backtrace + link to <code>clap</code> bugtracker | <code>panic</code> with backtrace and detailed error description | N/A
| <code>users</code> | <code>panic</code> with backtrace + link to <code>clap</code> bugtracker | <code>panic</code> with backtrace and link to <code>developer</code>-specified bugtracker |  <code>exit(2)</code> + print error  |</p>
<p>cc @clap-rs/admins @clap-rs/cli-wg  thoughts?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/pksunkara">@pksunkara</a> on 2020-03-13 11:56</div>
            <div class="timeline-body"><p>So, I think <code>clap-bug</code> is completely covered as of now in our codebase. We can cover <code>prog-bug</code> of <code>developers</code> by doing <code>compile_error</code> when building the app using <code>_build</code>. Finding out <code>prog-bug</code> of <code>users</code> is a difficult thing here. We can't differentiate. I don't think we should be using <code>debug</code> for providing any errors. It should be more about how the program is working.</p>
<p>For example, if the developer writes an argument that is conflicting with itself, we should emit a compilation error, that way they would realize it is not correct code.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/CreepySkeleton">@CreepySkeleton</a> on 2020-03-13 13:44</div>
            <div class="timeline-body"><blockquote>
<p>We can cover prog-bug of developers by doing compile_error when building the app using _build</p>
</blockquote>
<p>You're apparently misunderstanding how it works. <code>compile_error!</code> aborts the compilation whenever it ends up present in the code after <code>cfg</code>s has been expanded. <a href="https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=ce3774f3c074e7b02fb6857b815e5a74">Example</a>. You can't do &quot;if some condition is not met - emit compilation error&quot;.</p>
<p>It has to be panic because nothing else is available.</p>
<blockquote>
<p>Finding out prog-bug of users is a difficult thing here. We can't differentiate.</p>
</blockquote>
<p>In general case - no, we cant. In <em>most</em> cases, like <a href="https://github.com/clap-rs/clap/issues/1743">that one</a> - yes, we very well can.</p>
<blockquote>
<p>I don't think we should be using debug for providing any errors. It should be more about how the program is working.</p>
</blockquote>
<p>You mean, get rid of the &quot;debug&quot; feature?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/pksunkara">@pksunkara</a> on 2020-03-13 13:51</div>
            <div class="timeline-body"><blockquote>
<p>It has to be panic because nothing else is available.</p>
</blockquote>
<p>My bad then. Yeah, we should panic.</p>
<blockquote>
<p>In general case - no, we cant. In most cases, like that one - yes, we very well can.</p>
</blockquote>
<p>That's actually a prog-bug developer. Not prog-bug user.</p>
<blockquote>
<p>You mean, get rid of the &quot;debug&quot; feature?</p>
</blockquote>
<p>No. I am saying the above mentioned panics should always happen instead of only happening when debug is present. Basically, prog-bug developer and debug are separate things.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/CreepySkeleton">@CreepySkeleton</a> on 2020-03-13 14:05</div>
            <div class="timeline-body"><blockquote>
<p>That's actually a prog-bug developer. Not prog-bug user.</p>
</blockquote>
<p>There's no such distinction. It's always one of the two:</p>
<ul>
<li>We made an error in clap itself (<code>clap-bug</code>)</li>
<li>A developer made an error in they're own program (<code>prog-bug</code>)</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/pksunkara">@pksunkara</a> on 2020-03-13 14:09</div>
            <div class="timeline-body"><p>I agree. I was just trying to distinguish things a bit more based on <a href="https://github.com/clap-rs/clap/issues/1644#issuecomment-583852176">this</a> comment and we don't really need that.</p>
<p>We agree on panicking during app building, right?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/CreepySkeleton">@CreepySkeleton</a> on 2020-03-13 14:11</div>
            <div class="timeline-body"><p>Right</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Removed from milestone "3.0.0-beta.2" by @pksunkara on 2020-04-07 13:59</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone "3.0" by @pksunkara on 2020-04-07 13:59</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">C: asserts</span> added by @pksunkara on 2020-04-09 08:14</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @bors[bot] on 2020-04-10 02:00</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:28:32 UTC
    </footer>
</body>
</html>
