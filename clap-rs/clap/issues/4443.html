<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generated man pages still claim that flag options take values - clap-rs/clap #4443</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Generated man pages still claim that flag options take values</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/clap-rs/clap/issues/4443">#4443</a>
        opened by <a href="https://github.com/bgilbert">@bgilbert</a>
        on 2022-11-02 18:37
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/bgilbert">@bgilbert</a> on 2022-11-02 18:37</div>
            <div class="timeline-body"><h3>Please complete the following tasks</h3>
<ul>
<li>[X] I have searched the <a href="https://github.com/clap-rs/clap/discussions">discussions</a></li>
<li>[X] I have searched the <a href="https://github.com/clap-rs/clap/issues">open</a> and <a href="https://github.com/clap-rs/clap/issues?q=is%3Aissue+label%3AS-wont-fix+is%3Aclosed">rejected</a> issues</li>
</ul>
<h3>Rust Version</h3>
<p>rustc 1.64.0 (Fedora 1.64.0-1.fc36)</p>
<h3>Clap Version</h3>
<p>4.0.18, clap_mangen 0.2.4</p>
<h3>Minimal reproducible code</h3>
<pre><code class="language-rust">use clap::{CommandFactory, Parser};

#[derive(Parser)]
/// Command to do things
pub struct Cmd {
    /// Do thing
    #[clap(long)]
    thing: bool,
}

fn main() {
    Cmd::parse();
    clap_mangen::Man::new(Cmd::command())
        .render(&amp;mut std::io::stdout())
        .unwrap();
}
</code></pre>
<p>Cargo.toml:</p>
<pre><code class="language-toml">[package]
name = &quot;clap-man&quot;
version = &quot;0.0.0&quot;
edition = &quot;2021&quot;

[dependencies]
clap = { version = &quot;4&quot;, features = [&quot;derive&quot;] }
clap_mangen = &quot;0.2&quot;
</code></pre>
<h3>Steps to reproduce the bug with the above code</h3>
<pre><code class="language-command">cargo run | man -l -
</code></pre>
<h3>Actual Behaviour</h3>
<p>The option description for <code>--thing</code> claims that it takes an argument:</p>
<pre><code>clap-man(1)                 General Commands Manual                clap-man(1)

NAME
       clap-man - Command to do things

SYNOPSIS
       clap-man [--thing] [-h|--help]

DESCRIPTION
       Command to do things

OPTIONS
       --thing=THING
              Do thing

       -h, --help
              Print help information

                                   clap-man                        clap-man(1)
</code></pre>
<p>It doesn't:</p>
<pre><code class="language-command">$ cargo run -- --thing=true
    Finished dev [unoptimized + debuginfo] target(s) in 0.04s
     Running `target/debug/clap-man --thing=true`
error: The value 'true' was provided to '--thing' but it wasn't expecting any more values

Usage: clap-man --thing

For more information try '--help'
</code></pre>
<h3>Expected Behaviour</h3>
<p>The man page lists the option without any argument, as it did in clap 3.2 / clap_mangen 0.1:</p>
<pre><code>clap-man(1)                 General Commands Manual                clap-man(1)

NAME
       clap-man - Command to do things

SYNOPSIS
       clap-man [--thing] [-h|--help]

DESCRIPTION
       Command to do things

OPTIONS
       --thing
              Do thing

       -h, --help
              Print help information

                                   clap-man                        clap-man(1)
</code></pre>
<h3>Additional Context</h3>
<p>This is a followup to https://github.com/clap-rs/clap/issues/4410.  clap_mangen 0.2.4 improved the situation but didn't fix it.</p>
<h3>Debug Output</h3>
<p><em>No response</em></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">C-bug</span> added by @bgilbert on 2022-11-02 18:37</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">E-easy</span> added by @epage on 2022-11-02 21:36</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">A-man</span> added by @epage on 2022-11-02 21:36</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">E-help-wanted</span> added by @epage on 2022-11-02 21:36</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/4506.html">clap-rs/clap#4506</a> on 2022-11-23 21:13</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2022-11-25 01:34</div>
            <div class="timeline-body"><p>As pointed out in #4506, #4432 highlights output where this is working and we have tests highlighting this working.</p>
<p>@Calder-Ty pointed out regarding #4506</p>
<blockquote>
<p>It's strange because the change definitely does work on the example provided in the bug report</p>
</blockquote>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Calder-Ty">@Calder-Ty</a> on 2022-11-25 01:42</div>
            <div class="timeline-body"><p>I want to clarify that it is the proposed change in #4506 that brought a fix for the given examples above. However as pointed out, in the PR the change doesn't affect existing tests, which we should expect it to. I'm still trying to dig up what changed between #4432 and now, as i'm able to replicate the issue in the report.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2022-11-25 01:43</div>
            <div class="timeline-body"><p>The one big difference I notice this Issue is using the derive API and the existing tests are using the builder API.  Since #4506 fixes this, it implies that a value name is being set for flags in the derive.</p>
<p>It looks like we always set value_name in the derive: https://github.com/clap-rs/clap/blob/master/clap_derive/src/derives/args.rs#L232</p>
<p>Normally, we verify the relationship between num_args and value_names but apparently we skip it for empty value names to make the derive easier: https://github.com/clap-rs/clap/blob/master/src/builder/debug_asserts.rs#L757</p>
<p>So the question is if we should fix this in the derive or in the callers.</p>
<p>I will point out that clap_mangen is a bit simple in its rendering of values; <code>--help</code> has a bit more complex of rendering: https://github.com/clap-rs/clap/blob/master/src/builder/arg.rs#L4148</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2022-11-25 01:49</div>
            <div class="timeline-body"><p>One option would be for us to expose an <code>Arg::render</code> function that calls <code>Arg::stylized(None)</code>.  The only public way to access the styling is with <code>StyledStr::ansi().to_string()</code> and it will remain that way.  I've been considering writing an ansi code to roff converter.</p>
<p>If someone wants to step up and write the ansi to roff converter as I won't be getting to it immediately, that'd be great.  I have notes to help prepare for it in the issues at https://github.com/epage/anstyle/issues.</p>
<p>However, that is a big ask and people likely don't want to wait that long.  I can understand just duplicating the code into clap_mangen until then.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Calder-Ty">@Calder-Ty</a> on 2022-11-25 02:07</div>
            <div class="timeline-body"><p>@epage, I don't mind working getting a workaround you describe setup for now. I don't know if i'm up to the ANSI conversion, would have to look into that more.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Calder-Ty">@Calder-Ty</a> on 2022-12-16 23:27</div>
            <div class="timeline-body"><p>@epage Sorry for leaving this alone for so long. I've been looking into ways to make a quick workaround
for this in a way that is robust. After looking into it I think the best solution is just to go forwards
with creating the ANSI-Roff converter.</p>
<p>Adding an Arg::Render function is feasible, but it also generates styles that would be noticeably different
from the current manpage styling. I'm not sure how &quot;in stone&quot; those need to be, but want to err on
the conservative side.</p>
<p>Copying the code into clap_mangen is a lot of reduplication, as there are a lot of private dependencies
that would need to be copied over as well.</p>
<hr />
<p>I wouldn't mind working on writing an ANSI to Roff converter, but I would like to have
a better idea of what you are imagining that looking like, perhaps in another discussion. For
now I have added some tests to #4506 that demonstrate some parity between Derive and Builder commands,
and that they both show flag options appropriately.</p>
<p>As an aside, when testing these different API's I found some other cosmetic disparities between
Derive and Builder API's that I will write up another ticket for. However it probably would be better
to get the ansi-roff converter done first as that will probably clear up the differences.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2022-12-17 01:17</div>
            <div class="timeline-body"><blockquote>
<p>I wouldn't mind working on writing an ANSI to Roff converter, but I would like to have
a better idea of what you are imagining that looking like</p>
</blockquote>
<p>In https://github.com/epage/anstyle/issues/4, I contrast different ANSI parsing libraries.  For a first round, feel free to use what is easiest as long as it as a good license.  I'm less concerned about <code>clap_mangen</code>s build times.  We can then iterate on it as clap needs to adopt an ANSI parser.</p>
<p>anstyle is where I'm housing these different integrations, e.g. you can see what it supports today in the <a href="https://github.com/epage/anstyle#readme">README</a>.</p>
<blockquote>
<p>Adding an Arg::Render function is feasible, but it also generates styles that would be noticeably different
from the current manpage styling. I'm not sure how &quot;in stone&quot; those need to be, but want to err on
the conservative side.</p>
</blockquote>
<p><code>clap_mangen</code> is in its very early stages; nothing is set in stone.  I wasn't going to get started on it until we could reuse more help generation logic but some others were wanting it sooner and wrote most of the code.  It still has a ways to go.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../coreos/coreos-installer/pulls/1021.html">coreos/coreos-installer#1021</a> on 2023-01-03 23:56</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/4645.html">clap-rs/clap#4645</a> on 2023-01-16 16:06</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/bgilbert">@bgilbert</a> on 2023-01-16 16:12</div>
            <div class="timeline-body"><p>Pending the broader refactor, I've submitted a localized fix in https://github.com/clap-rs/clap/pull/4645.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @epage on 2023-02-22 22:14</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 01:35:15 UTC
    </footer>
</body>
</html>
