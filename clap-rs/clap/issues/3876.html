<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Backwards incompatibility for ArgMatches and UnwindSafe - clap-rs/clap #3876</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Backwards incompatibility for ArgMatches and UnwindSafe</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/clap-rs/clap/issues/3876">#3876</a>
        opened by <a href="https://github.com/doivosevic">@doivosevic</a>
        on 2022-06-27 17:50
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/doivosevic">@doivosevic</a></div>
            <div class="timeline-body">Please complete the following tasks
<ul>
<li>[X] I have searched the <a href="https://github.com/clap-rs/clap/discussions">discussions</a></li>
<li>[X] I have searched the <a href="https://github.com/clap-rs/clap/issues">open</a> and <a href="https://github.com/clap-rs/clap/issues?q=is%3Aissue+label%3AS-wont-fix+is%3Aclosed">rejected</a> issues</li>
</ul>
Rust Version
<p>1.60</p>
Clap Version
<p>between 3.1.18 and 3.2.6</p>
Minimal reproducible code
<pre><code>

fn a(a: ArgMatches) {
    b(a)
}

fn b&lt;T: UnwindSafe&gt;(b: T) {
    
}
</code></pre>
Steps to reproduce the bug with the above code
<p>cargo check</p>
Actual Behaviour
<p>Compile should pass</p>
Expected Behaviour
<p>Compile fails</p>
Additional Context
<p>This looks like a backwards incompatibility</p>
Debug Output
<pre><code>
error[E0277]: the type `(dyn std::any::Any + Sync + std::marker::Send + &#x27;static)` may contain interior mutability and a reference may not be safely transferrable across a catch_unwind boundary
  --&gt; index/src/utils.rs:31:7
   |
31 |     b(a)
   |     - ^ `(dyn std::any::Any + Sync + std::marker::Send + &#x27;static)` may contain interior mutability and a reference may not be safely transferrable across a catch_unwind boundary
   |     |
   |     required by a bound introduced by this call
   |
   = help: the trait `RefUnwindSafe` is not implemented for `(dyn std::any::Any + Sync + std::marker::Send + &#x27;static)`
   = note: required because of the requirements on the impl of `UnwindSafe` for `Arc&lt;(dyn std::any::Any + Sync + std::marker::Send + &#x27;static)&gt;`
   = note: required because it appears within the type `parser::matches::any_value::AnyValue`
   = note: required because of the requirements on the impl of `UnwindSafe` for `Unique&lt;parser::matches::any_value::AnyValue&gt;`
   = note: required because it appears within the type `alloc::raw_vec::RawVec&lt;parser::matches::any_value::AnyValue&gt;`
   = note: required because it appears within the type `Vec&lt;parser::matches::any_value::AnyValue&gt;`
   = note: required because of the requirements on the impl of `UnwindSafe` for `Unique&lt;Vec&lt;parser::matches::any_value::AnyValue&gt;&gt;`
   = note: required because it appears within the type `alloc::raw_vec::RawVec&lt;Vec&lt;parser::matches::any_value::AnyValue&gt;&gt;`
   = note: required because it appears within the type `Vec&lt;Vec&lt;parser::matches::any_value::AnyValue&gt;&gt;`
   = note: required because it appears within the type `parser::matches::matched_arg::MatchedArg`
   = note: required because it appears within the type `indexmap::Bucket&lt;clap::util::id::Id, parser::matches::matched_arg::MatchedArg&gt;`
   = note: required because of the requirements on the impl of `UnwindSafe` for `Unique&lt;indexmap::Bucket&lt;clap::util::id::Id, parser::matches::matched_arg::MatchedArg&gt;&gt;`
   = note: required because it appears within the type `alloc::raw_vec::RawVec&lt;indexmap::Bucket&lt;clap::util::id::Id, parser::matches::matched_arg::MatchedArg&gt;&gt;`
   = note: required because it appears within the type `Vec&lt;indexmap::Bucket&lt;clap::util::id::Id, parser::matches::matched_arg::MatchedArg&gt;&gt;`
   = note: required because it appears within the type `indexmap::map::core::IndexMapCore&lt;clap::util::id::Id, parser::matches::matched_arg::MatchedArg&gt;`
   = note: required because it appears within the type `indexmap::map::IndexMap&lt;clap::util::id::Id, parser::matches::matched_arg::MatchedArg&gt;`
   = note: required because it appears within the type `ArgMatches`
note: required by a bound in `b`
  --&gt; index/src/utils.rs:34:9
   |
34 | fn b&lt;T: UnwindSafe&gt;(b: T) {
   |         ^^^^^^^^^^ required by this bound in `b`
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">C-bug</span> added by <a href="https://github.com/doivosevic">@doivosevic</a> on 2022-06-27 17:50</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2022-06-27 19:39</div>
            <div class="timeline-body"><p>I&#x27;m curious, how did you find this?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">A-parsing</span> added by <a href="https://github.com/epage">@epage</a> on 2022-06-27 19:39</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">S-waiting-on-decision</span> added by <a href="https://github.com/epage">@epage</a> on 2022-06-27 19:39</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/doivosevic">@doivosevic</a> on 2022-06-27 19:40</div>
            <div class="timeline-body"><p>I had code which was working which is let&#x27;s say a wrapper for executing binaries on worker machines and when someone from my org bumped clap in develop my code broke after rebasing</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2022-06-27 19:40</div>
            <div class="timeline-body"><p>Note: I&#x27;m assuming we&#x27;d need to add another trait bound.  It gets a little awkward making a breaking change to fix a breaking change but this would be unlikely to break someone.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a>clap-rs/clap#3877</a> on 2022-06-28 01:27</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a>clap-rs/clap#3878</a> on 2022-06-28 02:07</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2022-06-28 02:12</div>
            <div class="timeline-body"><p>Some thoughts in working on a fix (#3878)</p>
<ul>
<li>Auto-traits are a weird lot for ensuring compatibility on.  Ideally, we could say what auto-traits are assumed and which aren&#x27;t in a user-facing way.  Instead we have to add compile-time tests for what auto traits we implement and don&#x27;t.  The big concern is accidentally implementing an auto-trait that we don&#x27;t provide a guarantee for.</li>
<li>Its hard to decide whether we should intend a guarantee on this long term</li>
<li>I seem to be stuck in the implementation with parts dealing with <code>Arc&lt;dyn&gt;</code>.  If we can&#x27;t implement a fix for this, that puts us in an awkward space of either pulling the entire 3.2 release and breaking people or leaving it and letting this breakage continue (if we consider it a breakage).</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/doivosevic">@doivosevic</a> on 2022-06-28 08:12</div>
            <div class="timeline-body"><p>Can we then get an interface to get all the args from ArgMatches instead so that we can pass the args in some other format across this boundary?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2022-07-16 02:46</div>
            <div class="timeline-body"><p>That most likely is blocked on breaking changes, see <a href="https://github.com/clap-rs/clap/issues/1206">clap-rs/clap#1206</a></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a>rust-lang/cargo#374</a> on 2022-07-25 12:40</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a>obi1kenobi/cargo-semver-checks#32</a> on 2022-08-07 02:31</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a>obi1kenobi/cargo-semver-checks#33</a> on 2022-08-07 03:05</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a>rust-lang/rust#100252</a> on 2022-08-08 00:21</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2022-10-04 15:28</div>
            <div class="timeline-body"><p>As clap v4 is now out, I&#x27;m going ahead and closing this.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/epage">@epage</a> on 2022-10-04 15:28</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a>clap-rs/clap#4347</a> on 2022-10-04 15:32</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a>libp2p/rust-libp2p#3312</a> on 2023-02-25 02:52</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:59:05 UTC
    </footer>
</body>
</html>
