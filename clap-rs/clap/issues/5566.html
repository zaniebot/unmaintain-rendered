<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panic in `Arg`'s `fmt::Display` implementation when `num_args` is not explicitly set - clap-rs/clap #5566</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Panic in `Arg`'s `fmt::Display` implementation when `num_args` is not explicitly set</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/clap-rs/clap/issues/5566">#5566</a>
        opened by <a href="https://github.com/chenxiaolong">@chenxiaolong</a>
        on 2024-07-05 20:00
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/chenxiaolong">@chenxiaolong</a> on 2024-07-05 20:00</div>
            <div class="timeline-body"><h3>Please complete the following tasks</h3>
<ul>
<li>[X] I have searched the <a href="https://github.com/clap-rs/clap/discussions">discussions</a></li>
<li>[X] I have searched the <a href="https://github.com/clap-rs/clap/issues">open</a> and <a href="https://github.com/clap-rs/clap/issues?q=is%3Aissue+label%3AS-wont-fix+is%3Aclosed">rejected</a> issues</li>
</ul>
<h3>Rust Version</h3>
<p>rustc 1.79.0 (129f3b996 2024-06-10) (Fedora 1.79.0-3.fc40)</p>
<h3>Clap Version</h3>
<p>4.5.8</p>
<h3>Minimal reproducible code</h3>
<pre><code class="language-rust">use clap::{CommandFactory, Parser};

#[derive(Debug, Parser)]
struct Cli {
    #[clap(long, num_args = 1)]
    does_not_panic: String,

    #[clap(long)]
    does_panic: String,
}

fn main() {
    let command = Cli::command();

    for arg in command.get_arguments() {
        println!(&quot;{arg}&quot;);
    }
}
</code></pre>
<h3>Steps to reproduce the bug with the above code</h3>
<pre><code>RUST_BACKTRACE=1 cargo run
</code></pre>
<h3>Actual Behaviour</h3>
<pre><code>     Running `target/debug/clap-panic`
--does-not-panic &lt;DOES_NOT_PANIC&gt;
thread 'main' panicked at /home/chenxiaolong/.cargo/registry/src/index.crates.io-6f17d22bba15001f/clap_builder-4.5.8/src/builder/arg.rs:3986:29:
Fatal internal error. Please consider filing a bug report at https://github.com/clap-rs/clap/issues
stack backtrace:
   0: rust_begin_unwind
             at /builddir/build/BUILD/rustc-1.79.0-src/library/std/src/panicking.rs:652:5
   1: core::panicking::panic_fmt
             at /builddir/build/BUILD/rustc-1.79.0-src/library/core/src/panicking.rs:72:14
   2: core::panicking::panic_display
             at /builddir/build/BUILD/rustc-1.79.0-src/library/core/src/panicking.rs:263:5
   3: core::option::expect_failed
             at /builddir/build/BUILD/rustc-1.79.0-src/library/core/src/option.rs:1994:5
   4: core::option::Option&lt;T&gt;::expect
             at /builddir/build/BUILD/rustc-1.79.0-src/library/core/src/option.rs:895:21
   5: clap_builder::builder::arg::Arg::get_min_vals
             at /home/chenxiaolong/.cargo/registry/src/index.crates.io-6f17d22bba15001f/clap_builder-4.5.8/src/builder/arg.rs:3986:9
   6: clap_builder::builder::arg::Arg::stylize_arg_suffix
             at /home/chenxiaolong/.cargo/registry/src/index.crates.io-6f17d22bba15001f/clap_builder-4.5.8/src/builder/arg.rs:4309:35
   7: clap_builder::builder::arg::Arg::stylized
             at /home/chenxiaolong/.cargo/registry/src/index.crates.io-6f17d22bba15001f/clap_builder-4.5.8/src/builder/arg.rs:4297:29
   8: &lt;clap_builder::builder::arg::Arg as core::fmt::Display&gt;::fmt
             at /home/chenxiaolong/.cargo/registry/src/index.crates.io-6f17d22bba15001f/clap_builder-4.5.8/src/builder/arg.rs:4437:9
   9: &lt;&amp;T as core::fmt::Display&gt;::fmt
             at /builddir/build/BUILD/rustc-1.79.0-src/library/core/src/fmt/mod.rs:2343:62
  10: core::fmt::rt::Argument::fmt
             at /builddir/build/BUILD/rustc-1.79.0-src/library/core/src/fmt/rt.rs:165:63
  11: core::fmt::write
             at /builddir/build/BUILD/rustc-1.79.0-src/library/core/src/fmt/mod.rs:1157:21
  12: std::io::Write::write_fmt
             at /builddir/build/BUILD/rustc-1.79.0-src/library/std/src/io/mod.rs:1832:15
  13: &lt;&amp;std::io::stdio::Stdout as std::io::Write&gt;::write_fmt
             at /builddir/build/BUILD/rustc-1.79.0-src/library/std/src/io/stdio.rs:787:9
  14: &lt;std::io::stdio::Stdout as std::io::Write&gt;::write_fmt
             at /builddir/build/BUILD/rustc-1.79.0-src/library/std/src/io/stdio.rs:761:9
  15: std::io::stdio::print_to
             at /builddir/build/BUILD/rustc-1.79.0-src/library/std/src/io/stdio.rs:1117:21
  16: std::io::stdio::_print
             at /builddir/build/BUILD/rustc-1.79.0-src/library/std/src/io/stdio.rs:1194:5
  17: clap_panic::main
             at ./src/main.rs:16:9
  18: core::ops::function::FnOnce::call_once
             at /builddir/build/BUILD/rustc-1.79.0-src/library/core/src/ops/function.rs:250:5
note: Some details are omitted, run with `RUST_BACKTRACE=full` for a verbose backtrace.
</code></pre>
<h3>Expected Behaviour</h3>
<p>The <code>fmt::Display</code> implementation shouldn't panic.</p>
<h3>Additional Context</h3>
<p>This is the simplest reproducer I could find. My actual goal is being able to obtain the <code>--arg &lt;ARG&gt;</code> string for printing custom errors.</p>
<h3>Debug Output</h3>
<p>This produces no additional output because the example is only looking at <code>Command::get_arguments()</code> and does not actually run the parser.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">C-bug</span> added by @chenxiaolong on 2024-07-05 20:00</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2024-07-05 20:51</div>
            <div class="timeline-body"><p>In this case, its because the args need to be built first (<code>command.build()</code>).  Is there a reason that they are being printed without being built?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/chenxiaolong">@chenxiaolong</a> on 2024-07-05 21:17</div>
            <div class="timeline-body"><p>Thanks! I completely overlooked that <code>Command::build()</code> existed. Looking at the docs for that function, it sounds like this behavior is intended, so I'll close out the issue. Sorry for the noise!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @chenxiaolong on 2024-07-05 21:17</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../hermit-os/uhyve/pulls/1048.html">hermit-os/uhyve#1048</a> on 2025-08-08 00:12</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 01:35:37 UTC
    </footer>
</body>
</html>
