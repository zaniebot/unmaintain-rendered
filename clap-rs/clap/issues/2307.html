<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Validate `conflicts_with` - clap-rs/clap #2307</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Validate `conflicts_with`</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/clap-rs/clap/issues/2307">#2307</a>
        opened by <a href="https://github.com/HalfVoxel">@HalfVoxel</a>
        on 2021-01-22 15:06
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/HalfVoxel">@HalfVoxel</a> on 2021-01-22 15:06</div>
            <div class="timeline-body"><h3>Make sure you completed the following tasks</h3>
<ul>
<li>[x] Searched the <a href="https://github.com/clap-rs/clap/discussions">discussions</a></li>
<li>[x] Searched the closed issues</li>
</ul>
<h3>Describe your use case</h3>
<p>Currently, it can sometimes be tricky to know which name to give to <code>conflicts_with</code>, in particular in combination with <code>structopt</code>.
Take a look at this issue for context: https://github.com/TeXitoi/structopt/issues/459</p>
<p>Clap currently doesn't seem to care if <code>conflicts_with</code> is given a name which isn't even a valid field.</p>
<h3>Describe the solution you'd like</h3>
<p>Clap validates that the field <code>conflicts_with</code> is given actually exists.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">T: new feature</span> added by @HalfVoxel on 2021-01-22 15:06</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/pksunkara">@pksunkara</a> on 2021-01-22 18:46</div>
            <div class="timeline-body"><p>Have you checked this with master? And also please provide a minimal sample code so it's easier for everyone.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/HalfVoxel">@HalfVoxel</a> on 2021-01-22 18:57</div>
            <div class="timeline-body"><p>I have not yet, my testing was done with clap v2.33.3 which is the latest stable version afaik (though I see that there's a 3.0 beta now).</p>
<p>I use structopt so that generates most of the code for me. You can find an example of that in the linked issue.</p>
<p>Here is the code that structopt generates which corresponds to this issue:</p>
<pre><code class="language-rust">let app = app.about(&quot;Runs a module&quot;);
let app = app.arg(
    ::structopt::clap::Arg::with_name(&quot;module-name&quot;)
        .takes_value(true)
        .multiple(false)
        .validator(|s| {
            ::std::str::FromStr::from_str(s.as_str())
                .map(|_: String| ())
                .map_err(|e| e.to_string())
        })
        .help(&quot;Name of the cmdlet module to run&quot;)
        .short(&quot;n&quot;)
        .long(&quot;name&quot;),
);
let app = app.arg(
    ::structopt::clap::Arg::with_name(&quot;module-cid&quot;)
        .takes_value(true)
        .multiple(false)
        .validator(|s| {
            ::std::str::FromStr::from_str(s.as_str())
                .map(|_: Cid| ())
                .map_err(|e| e.to_string())
        })
        .help(&quot;CID of the cmdlet module to run&quot;)
        .short(&quot;c&quot;)
        .long(&quot;cid&quot;)
        .conflicts_with(&quot;module_name&quot;),
);
app.version(&quot;0.1.0&quot;)
</code></pre>
<p>Note that <code>conflicts_with</code> is given the name <code>module_name</code> while the generated name is actually <code>module-name</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/pksunkara">@pksunkara</a> on 2021-01-22 19:17</div>
            <div class="timeline-body"><p>Can you please test it on clap master and report back?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/HalfVoxel">@HalfVoxel</a> on 2021-01-25 15:58</div>
            <div class="timeline-body"><p>Hi</p>
<p>I can confirm that this still happens with master.</p>
<pre><code class="language-toml">[dependencies]
clap = { git = &quot;https://github.com/clap-rs/clap.git&quot;, rev= &quot;d7f6748&quot; }
</code></pre>
<pre><code class="language-rust">use clap::{App, Arg};

fn main() {
    let app = App::new(&quot;My Super Program&quot;)
        .about(&quot;Runs a module&quot;)
        .arg(
            Arg::new(&quot;module-name&quot;)
                .takes_value(true)
                .multiple(false)
                .short('n')
                .long(&quot;name&quot;),
        )
        .arg(
            Arg::new(&quot;module-cid&quot;)
                .takes_value(true)
                .multiple(false)
                .short('c')
                .long(&quot;cid&quot;)
                .conflicts_with(&quot;module_name&quot;),
        )
        .version(&quot;0.1.0&quot;);

    let matches = app.get_matches();
    println!(&quot;{:#?}&quot;, matches);
}
</code></pre>
<pre><code> ~/p/e/t/claptest (master) [2]&gt; cargo run --release -- --name=NAME --cid=CID                                   (base)
   Compiling claptest v0.1.0 (/home/arong/projects/embark/test/claptest)
    Finished release [optimized] target(s) in 0.40s
     Running `target/release/claptest --name=NAME --cid=CID`
ArgMatches {
    args: {
        [hash: 49BCF4FC57DA0A4]: MatchedArg {
            occurs: 1,
            ty: CommandLine,
            indices: [
                1,
            ],
            vals: [],
        },
        [hash: 110F162FD0016129]: MatchedArg {
            occurs: 1,
            ty: CommandLine,
            indices: [
                2,
            ],
            vals: [],
        },
    },
    subcommand: None,
}
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone "3.1" by @pksunkara on 2021-01-26 18:18</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">T: new feature</span> removed by @pksunkara on 2021-01-26 18:19</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">:money_with_wings: $5</span> added by @pksunkara on 2021-01-26 18:19</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">C: asserts</span> added by @pksunkara on 2021-01-26 18:19</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">D: easy</span> added by @pksunkara on 2021-01-26 18:19</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">T: enhancement</span> added by @pksunkara on 2021-01-26 18:19</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../epage/clapng/issues/174.html">epage/clapng#174</a> on 2021-12-06 20:20</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">C: asserts</span> removed by @epage on 2021-12-08 19:59</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">A-builder</span> added by @epage on 2021-12-08 19:59</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2021-12-13 15:48</div>
            <div class="timeline-body"><p>This has since been resolved</p>
<p>We have an existing test <code>conflicts_with_invalid_arg</code> but I turned the above example code into a test to double check</p>
<pre><code class="language-rust">#[cfg(debug_assertions)]
#[test]
#[should_panic]
fn non_existent_conflict_asserts() {
    App::new(&quot;My Super Program&quot;)
        .about(&quot;Runs a module&quot;)
        .arg(
            Arg::new(&quot;module-name&quot;)
                .takes_value(true)
                .multiple(false)
                .short('n')
                .long(&quot;name&quot;),
        )
        .arg(
            Arg::new(&quot;module-cid&quot;)
                .takes_value(true)
                .multiple(false)
                .short('c')
                .long(&quot;cid&quot;)
                .conflicts_with(&quot;module_name&quot;),
        )
        .version(&quot;0.1.0&quot;)
        .debug_assert();
}
</code></pre>
<p>And it passes on 3.0.0-rc.4</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @epage on 2021-12-13 15:48</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 01:34:24 UTC
    </footer>
</body>
</html>
