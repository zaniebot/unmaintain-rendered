<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Path completions don't work across symlinks - clap-rs/clap #6201</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Path completions don't work across symlinks</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/clap-rs/clap/issues/6201">#6201</a>
        opened by <a href="https://github.com/devjgm">@devjgm</a>
        on 2025-12-26 21:18
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/devjgm">@devjgm</a></div>
            <div class="timeline-body"><h3>Please complete the following tasks</h3>
<ul>
<li>[x] I have searched the <a href="https://github.com/clap-rs/clap/discussions">discussions</a></li>
<li>[x] I have searched the <a href="https://github.com/clap-rs/clap/issues">open</a> and <a href="https://github.com/clap-rs/clap/issues?q=is%3Aissue+label%3AS-wont-fix+is%3Aclosed">rejected</a> issues</li>
</ul>
<h3>Rust Version</h3>
<p>rustc 1.91.0 (f8297e351 2025-10-28)</p>
<h3>Clap Version</h3>
<p>clap = { version = &quot;4.5.53&quot;, features = [&quot;derive&quot;] } clap_complete = { version = &quot;4.5.62&quot;, features = [&quot;unstable-dynamic&quot;] }</p>
<h3>Minimal reproducible code</h3>
<p><code>Cargo.toml</code>:</p>
<pre><code class="language-toml">[package]
name = &quot;mycomp&quot;
version = &quot;0.1.0&quot;
edition = &quot;2024&quot;

[dependencies]
clap = { version = &quot;4.5.53&quot;, features = [&quot;derive&quot;] }
clap_complete = { version = &quot;4.5.62&quot;, features = [&quot;unstable-dynamic&quot;] }
</code></pre>
<p><code>src/main.rs</code>:</p>
<pre><code class="language-rust">use clap::{CommandFactory, Parser};

#[derive(Parser, Debug, PartialEq)]
#[command(name = &quot;mycomp&quot;)]
struct Opt {
    #[arg(short, long, value_hint = clap::ValueHint::FilePath)]
    file: Option&lt;std::path::PathBuf&gt;,
}

fn main() {
    clap_complete::CompleteEnv::with_factory(|| Opt::command()).complete();
    let opt = Opt::parse();

    println!(&quot;{opt:#?}&quot;);
}
</code></pre>
<pre><code class="language-console">$ cargo build
    Finished `dev` profile [unoptimized + debuginfo] target(s) in 0.07s

$ source &lt;(COMPLETE=bash ./target/debug/mycomp)

$ ls -ld /home /Users/
drwxr-xr-x  5 root  admin  160 Nov  6 11:09 /Users/
lrwxr-xr-x  1 root  wheel   25 Dec 13 13:37 /home -&gt; /System/Volumes/Data/home

$ ./target/debug/mycomp -f /Users/ # TAB completion works üëç 

$ ./target/debug/mycomp -f /ho&lt;TAB&gt;  # Does not work ‚ùå 
</code></pre>
<h3>Steps to reproduce the bug with the above code</h3>
<p>Create a symlink to some directory, and try to use clap completion to complete through the symlink. On macOS this is common due to <code>/home -&gt; /Users</code>, and <code>/tmp -&gt; /private/tmp</code></p>
<h3>Actual Behaviour</h3>
<p>Trying to tab completion does not seem to work through a symlink.</p>
<h3>Expected Behaviour</h3>
<p>Tab completion should complete symlinks, just like regular path components.</p>
<h3>Additional Context</h3>
<p><em>No response</em></p>
<h3>Debug Output</h3>
<pre><code class="language-console">$ ./target/debug/mycomp -f /ho&lt;TAB&gt;
[clap_builder::builder::command]Command::_build: name=&quot;mycomp&quot;
[clap_builder::builder::command]Command::_propagate:mycomp
[clap_builder::builder::command]Command::_check_help_and_version:mycomp expand_help_tree=true
[clap_builder::builder::command]Command::long_help_exists
[clap_builder::builder::command]Command::_check_help_and_version: Building default --help
[clap_builder::builder::command]Command::_propagate_global_args:mycomp
[clap_builder::builder::debug_asserts]Command::_debug_asserts
[clap_builder::builder::debug_asserts]Arg::_debug_asserts:file
[clap_builder::builder::debug_asserts]Arg::_debug_asserts:help
[clap_builder::builder::debug_asserts]Command::_verify_positionals
[clap_builder::builder::command]Command::_build_bin_names
[ clap_builder::output::usage]Usage::get_required_usage_from: incls=[], matcher=false, incl_last=true
[ clap_builder::output::usage]Usage::get_required_usage_from: unrolled_reqs=[]
[ clap_builder::output::usage]Usage::get_required_usage_from: ret_val=[]
[clap_builder::builder::command]Command::_build: name=&quot;mycomp&quot;
[clap_builder::builder::command]Command::_build: already built
[clap_builder::builder::command]Command::_build_bin_names
[clap_builder::builder::command]Command::_build_bin_names: already built

</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">C-bug</span> added by @devjgm on 2025-12-26 21:18</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">S-triage</span> added by @devjgm on 2025-12-26 21:18</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">A-completion</span> added by @epage on 2025-12-26 21:20</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">S-triage</span> removed by @epage on 2025-12-26 21:20</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">E-help-wanted</span> added by @epage on 2025-12-26 21:20</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">E-easy</span> added by @epage on 2025-12-26 21:20</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2025-12-26 21:21</div>
            <div class="timeline-body"><p>Seems reasonable.  The main consideration is preserving the use of the symlink when reporting the path to the user.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/cooronx">@cooronx</a> on 2025-12-27 09:56</div>
            <div class="timeline-body"><p>@devjgm it seems work fine to me (Ubuntu 24.04.3 LTS with bash)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/6202.html">clap-rs/clap#6202</a> on 2025-12-27 10:25</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/iepathos">@iepathos</a> on 2025-12-27 10:59</div>
            <div class="timeline-body"><p>Hi,</p>
<p>Opened a PR for this issue here https://github.com/clap-rs/clap/pull/6202</p>
<p>On Unix, https://doc.rust-lang.org/std/fs/struct.DirEntry.html#method.metadata is equivalent to symlink_metadata(), which returns metadata about the symlink itself rather than its target. This causes is_dir() to return false for symlinks pointing to directories, so they never appear in completions.</p>
<p>The fix implemented in the PR is to use Path::is_dir() which follows symlinks.</p>
<p>Tests that prove the issue in the PR (fail without fix, pass with fix):</p>
<ul>
<li>suggest_value_hint_file_path_symlink_to_dir - symlink to directory missing from completions</li>
<li>suggest_value_hint_dir_path_symlink - symlink to directory not shown for DirPath hint</li>
</ul>
<p>Please let me know if there are any adjustments I should make for the PR.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @epage on 2025-12-29 15:16</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:49:41 UTC
    </footer>
</body>
</html>
