<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>clap_derive Arg methods with flattened - clap-rs/clap #3269</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>clap_derive Arg methods with flattened</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/clap-rs/clap/issues/3269">#3269</a>
        opened by <a href="https://github.com/pinkforest">@pinkforest</a>
        on 2022-01-08 03:15
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/pinkforest">@pinkforest</a></div>
            <div class="timeline-body">Please complete the following tasks
<ul>
<li>[X] I have searched the <a href="https://github.com/clap-rs/clap/discussions">discussions</a></li>
<li>[X] I have searched the existing issues</li>
</ul>
Clap Version
<p>3.0.5</p>
Describe your use case
<p>I got two example use-cases</p>
<p>I came across this initially at <a href="https://github.com/crate-ci/clap-cargo/issues/27">cargo-clap/issues/27</a> and since it&#x27;s use requires the use of flattened this should have some consideration what might be supported and document them for the future reference.</p>
global on Enum Subcommand
<p>Allow using <a href="https://docs.rs/clap/latest/clap/struct.Arg.html#method.global">global</a> to reduce amount of code e.g. in enum Subcommand</p>
<pre><code>#[derive(Subcommand)]
#[clap(setting(AppSettings::DeriveDisplayOrder))]
pub enum GeigerCommands {
    /// Geiger with build tree
    Build {
        #[clap(flatten)]
        workspace: clap_cargo::Workspace,
    },
    /// Geiger with test tree
    Test {
        #[clap(flatten)]
        workspace: clap_cargo::Workspace,
    }
}
</code></pre>
Override members of pre-flattened arguments
<p>Also f.ex. <a href="https://docs.rs/clap/latest/clap/struct.Arg.html#method.default_value">default_value</a> &amp; co - it would require getting rid of flattened and a way to pass &quot;overrides&quot; against members</p>
<p>e.g. cargo build to set the <a href="https://docs.rs/clap/latest/clap/struct.Arg.html#method.help">help</a> that differs between build:</p>
<pre><code>        --test &lt;NAME&gt;...             Build only the specified test target
        --tests                      Build all tests
</code></pre>
<p>and vs cargo test:</p>
<pre><code>        --test &lt;NAME&gt;...             Test only the specified test target
        --tests                      Test all tests
</code></pre>
<p>Also <a href="https://docs.rs/clap/latest/clap/struct.Arg.html#method.env">env</a> variant for this would be cool but I would think these should be hardcoded there - not sure.</p>
<p>Plus it would be nice to group workspace / manifest under their own heading with <a href="https://docs.rs/clap/latest/clap/struct.Arg.html#method.help_heading">help_heading</a></p>
Describe the solution you&#x27;d like
<p>First it would be great to get a support statement and document them in the <a href="https://github.com/clap-rs/clap/blob/master/examples/derive_ref/README.md">derive reference</a> perhaps</p>
<p>Relevant with flatten might be:</p>
<ul>
<li>[ ] - <a href="https://docs.rs/clap/latest/clap/struct.Arg.html#method.index">index</a></li>
<li>[ ] - <a href="https://docs.rs/clap/latest/clap/struct.Arg.html#method.last">last</a></li>
<li>[ ] - <a href="https://docs.rs/clap/latest/clap/struct.Arg.html#method.required">required</a></li>
<li>[ ] - <a href="https://docs.rs/clap/latest/clap/struct.Arg.html#method.requires">requires</a></li>
<li>[ ] - <a href="https://docs.rs/clap/latest/clap/struct.Arg.html#method.is_set">is_set</a></li>
<li>[ ] - <a href="https://docs.rs/clap/latest/clap/struct.Arg.html#method.is_set">setting</a></li>
<li>[ ] - <a href="https://docs.rs/clap/latest/clap/struct.Arg.html#method.is_set">unset_setting</a></li>
<li>[ ] - <a href="https://docs.rs/clap/latest/clap/struct.Arg.html#method.env">env</a></li>
<li>[ ] - <a href="https://docs.rs/clap/latest/clap/struct.Arg.html#method.help">help</a></li>
<li>[ ] - <a href="https://docs.rs/clap/latest/clap/struct.Arg.html#method.help_heading">help_heading</a></li>
<li>[ ] - <a href="https://docs.rs/clap/latest/clap/struct.Arg.html#method.hide">hide</a></li>
<li>[ ] - <a href="https://docs.rs/clap/latest/clap/struct.Arg.html#method.hide_possible_values">hide_possible_values</a></li>
<li>[ ] - <a href="https://docs.rs/clap/latest/clap/struct.Arg.html#method.hide_default_value">hide_default_value</a></li>
<li>[ ] - <a href="https://docs.rs/clap/latest/clap/struct.Arg.html#method.hide_env">hide_env</a></li>
<li>[ ] - <a href="https://docs.rs/clap/latest/clap/struct.Arg.html#method.hide_env_values">hide_env_values</a></li>
<li>[ ] - <a href="https://docs.rs/clap/latest/clap/struct.Arg.html#method.hide_short_help">hide_short_help</a></li>
<li>[ ] - <a href="https://docs.rs/clap/latest/clap/struct.Arg.html#method.hide_long_help">hide_long_help</a></li>
<li>[ ] - <a href="https://docs.rs/clap/latest/clap/struct.Arg.html#method.group">group</a></li>
<li>[ ] - <a href="https://docs.rs/clap/latest/clap/struct.Arg.html#method.groups">groups</a></li>
<li>[ ] - <a href="https://docs.rs/clap/latest/clap/struct.Arg.html#method.default_value_if">default_value_if</a></li>
<li>[ ] - <a href="https://docs.rs/clap/latest/clap/struct.Arg.html#method.default_value_if_os">default_value_if_os</a></li>
<li>[ ] - <a href="https://docs.rs/clap/latest/clap/struct.Arg.html#method.default_value_ifs">default_value_ifs</a></li>
<li>[ ] - <a href="https://docs.rs/clap/latest/clap/struct.Arg.html#method.default_value_ifs_os">default_value_ifs_os</a></li>
<li>[ ] - <a href="https://docs.rs/clap/latest/clap/struct.Arg.html#method.required_unless_present">required_unless_present</a></li>
<li>[ ] - <a href="https://docs.rs/clap/latest/clap/struct.Arg.html#method.required_unless_present_all">required_unless_present_all</a></li>
<li>[ ] - <a href="https://docs.rs/clap/latest/clap/struct.Arg.html#method.required_unless_present_any">required_unless_present_any</a></li>
<li>[ ] - <a href="https://docs.rs/clap/latest/clap/struct.Arg.html#method.required_if_eq">required_if_eq</a></li>
<li>[ ] - <a href="https://docs.rs/clap/latest/clap/struct.Arg.html#method.required_if_eq_any">required_if_eq_any</a></li>
<li>[ ] - <a href="https://docs.rs/clap/latest/clap/struct.Arg.html#method.required_if_eq_all">required_if_eq_all</a></li>
<li>[ ] - <a href="https://docs.rs/clap/latest/clap/struct.Arg.html#method.requires_if">required_if</a></li>
<li>[ ] - <a href="https://docs.rs/clap/latest/clap/struct.Arg.html#method.requires_ifs">required_ifs</a></li>
<li>[ ] - <a href="https://docs.rs/clap/latest/clap/struct.Arg.html#method.requires_all">requires_all</a></li>
<li>[ ] - <a href="https://docs.rs/clap/latest/clap/struct.Arg.html#method.conflicts_with">conflicts_with</a></li>
<li>[ ] - <a href="https://docs.rs/clap/latest/clap/struct.Arg.html#method.conflicts_with_all">conflicts_with_all</a></li>
<li>[ ] - <a href="https://docs.rs/clap/latest/clap/struct.Arg.html#method.overrides_with">overrides_with</a></li>
<li>[ ] - <a href="https://docs.rs/clap/latest/clap/struct.Arg.html#method.overrides_with_all">overrides_with_all</a></li>
</ul>
Alternatives, if applicable
<p>It would be nice if the functions get implemented for at least some in the future :)</p>
Additional Context
<p>I am migrating cargo-geiger to clap, clap-cargo and clap-cargo items require using flatten.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">C-enhancement</span> added by <a href="https://github.com/pinkforest">@pinkforest</a> on 2022-01-08 03:15</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a>crate-ci/clap-cargo#27</a> on 2022-01-08 03:16</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from &quot;Arg Methods with flattened&quot; to &quot;clap_derive Arg methods with flattened&quot; by <a href="https://github.com/pinkforest">@pinkforest</a> on 2022-01-08 03:16</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a>crate-ci/clap-cargo#28</a> on 2022-01-08 03:32</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a>clap-rs/clap#3189</a> on 2022-01-08 04:07</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2022-01-09 01:59</div>
            <div class="timeline-body"><blockquote>
<p>Allow using global to reduce amount of code e.g. in enum Subcommand
...
Relevant with flatten might be:</p>
</blockquote>
<p><em>(focusing on the &quot;apply this method to everything flattened)</em></p>
<p>The problem with this is we can&#x27;t really communicate in the derive code between these different derives (on top of people hand-implementing).  This means we have to do all of the communication through the trait at runtime.  This puts a large burden on the trait implementation (which could be quite brittle from an API stability perspective) and there s a lot of complexity to get these interactions working correctly.</p>
<p>So far we have been rejecting features dependent on this.</p>
<blockquote>
<p>Also f.ex. default_value &amp; co - it would require getting rid of flattened and a way to pass &quot;overrides&quot; against members</p>
</blockquote>
<p><em>(focusing on overriding a specific argument from a flatten)</em></p>
<p>Building this into the flatten construct has an extra level of complexity because of having to specify which argument an override applies to.</p>
<p>We do have the <code>App::mut_arg</code> method that can be used for modifying an argument.  struct-level attributes are almost all evaluated after arguments, so the ordering would work.  So you can do some level of overrides like</p>
<pre><code>#[derive(clap::Parser)]
#[clap(mut_arg(&quot;test&quot;, |arg| arg.help(&quot;Test only the specified test target&quot;))]
struct Cli {
...
}
</code></pre>
<p>One option might be to allow <code>mut_arg</code> on the flatten call so it is &quot;close&quot; to where it is needed.  We might allow other app methods in this context to help with issues like <a href="https://github.com/clap-rs/clap/issues/1807">clap-rs/clap#1807</a> though those might be <strong>before</strong> adding the flattened arguments though if we add a <code>#[clap::app()]</code> attribute, that could allow for controlling ordering.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2022-01-09 02:02</div>
            <div class="timeline-body"><p>btw customizing <code>clap-cargo</code> is something I have been thinking about.  One other thought I had is to use macros to create distinct versions of the struct but that will lead to code bloat and make it hard to interact with them the same way.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">A-derive</span> added by <a href="https://github.com/epage">@epage</a> on 2022-01-11 17:08</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">S-waiting-on-author</span> added by <a href="https://github.com/epage">@epage</a> on 2022-01-11 17:08</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/taladar">@taladar</a> on 2022-01-13 14:07</div>
            <div class="timeline-body"><p>It would be nice if this could at least be implemented for things like help_heading so we could easily group everything flattened in one spot under one help heading.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2022-01-13 15:00</div>
            <div class="timeline-body"><p><code>help_heading</code> is one of the few exceptions of what works because of how its implemented (<code>App::help_heading</code>).  See <a href="https://github.com/clap-rs/clap/blob/master/tests/derive/help.rs#L167">this test</a>.</p>
<p>The <a href="https://github.com/clap-rs/clap/blob/v3.0.7/examples/derive_ref/README.md#arg-attributes">derive reference</a> was previously updated to mention this.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2022-02-09 00:07</div>
            <div class="timeline-body"><p>It sounds like this issue boils down to</p>
<ul>
<li>&quot;apply this method to everything flattened&quot;: this is not being resolved due to derive limitations</li>
<li>&quot;focusing on overriding a specific argument from a flatten&quot;: this is possible with <code>App::mut_arg</code></li>
</ul>
<p>Did I miss anything?  If not, I&#x27;m inclined to close this issue</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2022-05-04 18:21</div>
            <div class="timeline-body"><p>Without any further updates, I&#x27;m moving forward with closing this.  If more details become available, we can re-evaluate.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/epage">@epage</a> on 2022-05-04 18:21</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:58:43 UTC
    </footer>
</body>
</html>
