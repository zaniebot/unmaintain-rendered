<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Refactor color support (+Add Windows Support) - clap-rs/clap #836</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Refactor color support (+Add Windows Support)</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/clap-rs/clap/issues/836">#836</a>
        opened by <a href="https://github.com/kbknapp">@kbknapp</a>
        on 2017-01-30 21:00
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/kbknapp">@kbknapp</a></div>
            <div class="timeline-body"><p>The formatting really needs some love, and adding Windows support would be a dream.</p>
<p>This is the tracking issues for The Great Color Formatting Refactor as it will henceforth be thou known.</p>
<p>I plan to take all cues from <a href="https://github.com/Burntsushi/ripgrep">BurntSushi/ripgrep</a>&#x27;s handling of color formatting.</p>
<hr>
<p>Another thing that&#x27;d be great to add, but is not the focus for this issue is the ability to change the colors and formats. Just something to keep in mind while working.</p>
<p>It&#x27;d also be nice to get rid of the <code>Format</code> enums and ~~use <a href="https://crates.io/crates/atty"><code>atty</code></a>~~ (Done in #862)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">C: errors</span> added by <a href="https://github.com/kbknapp">@kbknapp</a> on 2017-01-30 21:00</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">C: help message</span> added by <a href="https://github.com/kbknapp">@kbknapp</a> on 2017-01-30 21:00</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">D: hard</span> added by <a href="https://github.com/kbknapp">@kbknapp</a> on 2017-01-30 21:00</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">P3: want to have</span> added by <a href="https://github.com/kbknapp">@kbknapp</a> on 2017-01-30 21:00</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">T: enhancement</span> added by <a href="https://github.com/kbknapp">@kbknapp</a> on 2017-01-30 21:00</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">W: 2.x</span> added by <a href="https://github.com/kbknapp">@kbknapp</a> on 2017-01-30 21:00</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a>BurntSushi/ripgrep#353</a> on 2017-02-09 16:50</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/kbknapp">@kbknapp</a> on 2017-02-09 17:43</div>
            <div class="timeline-body"><p>I&#x27;ve began work on this issue - I&#x27;m hoping to have something mergable within the week.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a>clap-rs/clap#847</a> on 2017-02-09 17:43</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a>BurntSushi/ripgrep#324</a> on 2017-02-09 19:26</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/kbknapp">@kbknapp</a> on 2017-02-09 20:12</div>
            <div class="timeline-body"><p>@pkgw I don&#x27;t have a public branch yet. I&#x27;ve just been mocking it out, I literally just started messing with it today ;)</p>
<p>Moving the conversation here so as not to clog up ripgrep traffic.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone &quot;2.21.0&quot; by <a href="https://github.com/kbknapp">@kbknapp</a> on 2017-02-12 16:27</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/pkgw">@pkgw</a> on 2017-02-19 16:04</div>
            <div class="timeline-body"><p>I started taking a look at this. I&#x27;ve seen at least a few places where <code>String</code> types would need to be replaced with <code>termcolor::Buffer</code> types to get proper colorized output. This raises a question: would it be OK to have <code>clap</code> always depend on the <code>termcolor</code> crate, even when the <code>color</code> feature is turned off? If yes, life will be a bit easier for implementing the refactored color support. If it&#x27;s important for that dependency to be optional, I think the cleanest approach to the no-<code>color</code> case would be to create some dummy types that emulate those of <code>termcolor</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a>clap-rs/clap#862</a> on 2017-02-19 16:15</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2017-02-19 16:19</div>
            <div class="timeline-body"><p>@pkgw Out of curiosity, why do you need the <code>Buffer</code> type? At least as I initially envisioned it, that particular type is most useful in multithreaded contexts.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/pkgw">@pkgw</a> on 2017-02-19 16:27</div>
            <div class="timeline-body"><p>@BurntSushi There are functions in <code>clap</code> that return Strings containing buffered, colorized output ... because they bake in the assumption that you can implement colors with ANSI escape sequences. If I&#x27;m understanding the <code>termcolor</code> architecture right, <code>Buffer</code> helps in exactly this sort of situation even if you&#x27;re not threading. But I don&#x27;t know the design of <code>clap</code> very well, so perhaps it wouldn&#x27;t be hard to change these functions to print their output directly, rather than buffering things.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2017-02-19 16:29</div>
            <div class="timeline-body"><blockquote>
<p>because they bake in the assumption that you can implement colors with ANSI escape sequences</p>
</blockquote>
<p>Ah, yup, that&#x27;s the key I was missing. If that&#x27;s the case, then <code>Buffer</code> will, incidentally, help. Neat. (Short of restructuring how clap handles colors, as you say.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/kbknapp">@kbknapp</a> on 2017-02-19 18:46</div>
            <div class="timeline-body"><blockquote>
<p>would it be OK to have clap always depend on the termcolor crate, even when the color feature is turned off?</p>
</blockquote>
<p>Of course I&#x27;d <em>prefer</em> to use dummy types or work around pulling in unneeded deps in that case, but if the dep is small and doesn&#x27;t bloat a resulting binary excessively I would be willing to consider pulling it in unconditionally.</p>
<p>I guess I&#x27;d need a concrete example to really see trade-off between the pain of using dummy types and resulting binary size.</p>
<blockquote>
<p>But I don&#x27;t know the design of clap very well, so perhaps it wouldn&#x27;t be hard to change these functions to print their output directly, rather than buffering things.</p>
</blockquote>
<p>The current coloring support was built around using <code>ansi_term</code>, so if that architecture doesn&#x27;t fit anymore I&#x27;m fine with rebuilding something that fits better so long as it can be done in a non-breaking, net neutral effect way.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/pkgw">@pkgw</a> on 2017-02-19 19:05</div>
            <div class="timeline-body"><p>@kbknapp OK, well, dummy types certainly won&#x27;t be <em>that</em> painful to implement, and they&#x27;re unconditionally better once implemented, so it sounds like that&#x27;s the way to go.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/pkgw">@pkgw</a> on 2017-02-21 16:00</div>
            <div class="timeline-body"><p>Hmmm, I took more of a look at this and I think that making the change from <code>ansi_term</code> to <code>termcolor</code> would require a <em>lot</em> more knowledge of clap&#x27;s internals than I have. @kbknapp, this issue is all yours ðŸ˜„</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a>clap-rs/clap#942</a> on 2017-05-06 17:59</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a>clap-rs/clap#1037</a> on 2017-08-21 22:20</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a>clap-rs/clap#1155</a> on 2018-01-31 01:35</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Removed from milestone &quot;2.21.0&quot; by <a href="https://github.com/kbknapp">@kbknapp</a> on 2018-02-02 01:57</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone &quot;v3-alpha1&quot; by <a href="https://github.com/kbknapp">@kbknapp</a> on 2018-02-02 01:57</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a>clap-rs/clap#1246</a> on 2018-04-13 09:25</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a>clap-rs/clap#1252</a> on 2018-06-05 01:15</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">W: 3.x</span> added by <a href="https://github.com/kbknapp">@kbknapp</a> on 2018-07-22 01:06</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">W: 2.x</span> removed by <a href="https://github.com/kbknapp">@kbknapp</a> on 2018-07-22 01:06</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Removed from milestone &quot;v3-alpha.1&quot; by <a href="https://github.com/kbknapp">@kbknapp</a> on 2018-07-22 01:07</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone &quot;v3-beta.1&quot; by <a href="https://github.com/kbknapp">@kbknapp</a> on 2018-07-22 01:07</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/IssueHuntBot">@IssueHuntBot</a> on 2018-12-03 08:21</div>
            <div class="timeline-body"><p>@issuehuntfest has funded $50.00 to this issue. <a href="https://issuehunt.io/repos/31315121/issues/836">See it on IssueHunt</a></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a>denoland/deno#2025</a> on 2019-04-02 20:13</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Berrysoft">@Berrysoft</a> on 2019-05-26 08:06</div>
            <div class="timeline-body"><p>If <code>ansi_term</code> couldn&#x27;t be replaced easily, can we use <code>enable_ansi_support()</code> on Windows?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a>clap-rs/clap#1533</a> on 2019-08-23 23:40</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Removed from milestone &quot;v3-beta.1&quot; by <a href="https://github.com/pksunkara">@pksunkara</a> on 2020-02-01 07:44</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone &quot;v3.0&quot; by <a href="https://github.com/pksunkara">@pksunkara</a> on 2020-02-01 07:44</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to <a href="https://github.com/pksunkara">@pksunkara</a> by <a href="https://github.com/pksunkara">@pksunkara</a> on 2020-04-11 14:55</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/pksunkara">@pksunkara</a> on 2020-04-11 23:58</div>
            <div class="timeline-body"><p>I made a refactor attempt at https://github.com/clap-rs/clap/tree/color. Wasn&#x27;t enough.</p>
<p>@BurntSushi I am missing some functions for termcolor&#x27;s Buffer.</p>
<ul>
<li>Appending buffers to each other so that I can combine them in any way</li>
<li>Getting display width of buffer (not <code>len()</code>)</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a>clap-rs/clap#1812</a> on 2020-04-12 08:21</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">C: colorizing</span> added by <a href="https://github.com/pksunkara">@pksunkara</a> on 2020-04-12 10:16</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2020-04-12 11:41</div>
            <div class="timeline-body"><p>@pksunkara Sorry, but I don&#x27;t understand what you&#x27;re asking. Could you please say more words? Examples and context would help a lot.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/pksunkara">@pksunkara</a> on 2020-04-12 17:59</div>
            <div class="timeline-body"><p>What&#x27;s happening is, when we try to print help, currently clap treats them as ansi strings and creates severals strings and combines them later. A good example is <a href="https://github.com/clap-rs/clap/blob/333b993481396d84197bd6e5b54c526a3b04e6a1/src/output/help.rs#L439">this</a> function. If I am passing around just 1 buffer for everything to write into, this  will not work. So, I wanted to create buffers (like how the strings were created) and then combine them. I went through the termcolor docs and code and I couldn&#x27;t understand how I can achieve this. Sorry, If I missed anything.</p>
<p>Secondly, clap tries to wrap text based on terminal size. We try to check if we need to wrap based on the string that was returned. You can see an example <a href="https://github.com/clap-rs/clap/blob/333b993481396d84197bd6e5b54c526a3b04e6a1/src/output/help.rs#L296-L298">here</a>. That basically calculates the length of the colored string which is not possible with Buffer.</p>
<p>Hope I was able to give more clarity.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2020-04-13 12:20</div>
            <div class="timeline-body"><p>@pksunkara Thanks, that helps a bit. It might help for you to read the docs on the internal <code>WindowBuffer</code> type to get an idea of what <code>termcolor</code> is doing here: https://docs.rs/termcolor/1.1.0/src/termcolor/lib.rs.html#1467</p>
<p>In particular, the whole point of <code>termcolor</code> is to provide a <em>cross platform</em> API that works even with the Windows console API. When using the Windows console APIs, <code>termcolor</code> doesn&#x27;t use ANSI escape sequences at all, so you fundamentally cannot treat colorized text as just a normal string. That&#x27;s why the refactor is hard. You&#x27;ll have to re-arrange how the output works to stop passing around strings. If you can refactor your code to just write to <code>termcolor::Write</code> values instead of strings, then that should work.</p>
<blockquote>
<p>That basically calculates the length of the colored string which is not possible with Buffer.</p>
</blockquote>
<p>I&#x27;m not following why this isn&#x27;t possible. <code>Buffer</code> exposes its contents via <code>as_slice</code>. Why isn&#x27;t that sufficient?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/pksunkara">@pksunkara</a> on 2020-04-13 13:36</div>
            <div class="timeline-body"><p>Yup, I got that part from reading the code. What I was asking was basically if we can support the append somehow. Maybe refactoring the WindowsBuffer to be like:</p>
<pre><code>struct WindowsBufferItem {
    buf: Vec&lt;u8&gt;,
    colors: Vec&lt;(uszie, Option&lt;ColorSpec&gt;)&gt;,
}

struct WindowsBuffer(Vec&lt;WindowsBufferItem&gt;);
</code></pre>
<p>(basically <code>Vec&lt;current WindowsBuffer&gt;</code>). This would make it easy for us to support appending buffers to each other without recalculating the <code>colors</code> field all the time.</p>
<blockquote>
<p>I&#x27;m not following why this isn&#x27;t possible. Buffer exposes its contents via as_slice. Why isn&#x27;t that sufficient?</p>
</blockquote>
<p>Because non-windows buffer has the ansi codes in the string. When I am calculating the length, I want the plain content. We could try to make it possible by changing the <code>Ansi(_)</code> to be similar to how <code>WindowsBuffer</code> works. That way, we only add the ansi codes when printing. Hopefully I didn&#x27;t overlook anything while proposing this.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2020-04-13 13:52</div>
            <div class="timeline-body"><p>@pksunkara That&#x27;s a possibility. I&#x27;m open to PRs for that. I don&#x27;t think there should be any breaking changes. It still seems to me like you should be able to refactor the code so that you don&#x27;t append to buffers. That is, instead of:</p>
<pre><code>let buf1 = do_foo();
let buf2 = do_bar();
let buf3 = buf1 + buf2;
</code></pre>
<p>you would do</p>
<pre><code>let mut buf = String::new();
do_foo(&amp;mut buf);
do_bar(&amp;mut buf);
</code></pre>
<p>And then at that point, it should be possible to swap out <code>String</code> for <code>termcolor::Buffer</code>.</p>
<blockquote>
<p>Because non-windows buffer has the ansi codes in the string. When I am calculating the length, I want the plain content.</p>
</blockquote>
<p>Yes. But wasn&#x27;t that true before? I&#x27;m missing something here. Why wasn&#x27;t this a problem before?</p>
<p>But if you just need the buffer without ANSI codes, then it&#x27;s pretty easy to just strip them: https://github.com/BurntSushi/tabwriter/blob/2c0c9ff0d7a2bc522dfed55ab64605a0a21b23d2/src/lib.rs#L412-L420</p>
<blockquote>
<p>We could try to make it possible by changing the Ansi(_) to be similar to how WindowsBuffer works.</p>
</blockquote>
<p>I see why you might want that, but that&#x27;s definitely not possible. That&#x27;s almost certainly going to result in a noticeable loss in performance due to the extra indirection. Windows does it because it has to.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/pksunkara">@pksunkara</a> on 2020-04-13 14:00</div>
            <div class="timeline-body"><blockquote>
<p>Yes. But wasn&#x27;t that true before? I&#x27;m missing something here. Why wasn&#x27;t this a problem before?</p>
</blockquote>
<p>It is a problem currently too. I was hoping to fix it with this refactor and thats why I mentioned it originally.</p>
<p>I will give it another attempt and see if I really need the appending. Thanks for letting me bounce my thoughts with you.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2020-04-13 14:13</div>
            <div class="timeline-body"><p>@pksunkara No problem. If it ends up being impossible, then I&#x27;m open to making it possible to append <code>termcolor::Buffer</code> values.</p>
<p>Note that I would definitely recommend against using a <code>regex</code> to strip ANSI formatting because of the weight of that dependency. My link was mostly just meant as an example. I think a small hand written search routine would be best. :-) (Arguably, <code>tabwriter</code> should do the same.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/pksunkara">@pksunkara</a> on 2020-04-13 14:14</div>
            <div class="timeline-body"><p>I will probably end up building a non colored string at the same time and using it for calculation</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/CreepySkeleton">@CreepySkeleton</a> on 2020-04-13 23:18</div>
            <div class="timeline-body"><p>Whenever I see a technical dispute is going on, I can&#x27;t resist the urge to jump in, you know me.</p>
<p>I would probably end up with storing an error as <code>Vec&lt;(String, Color)&gt;</code> on both Unix and Windows instead of melding escapes into it. When the time comes and error is <em>requested</em> to be rendered, we just check where it&#x27;s being rendered to - if it&#x27;s console/TTY, we&#x27;re using coloring API/escapes, but if it a normal in-memory buffer, we&#x27;re just flushing strings into it one by one.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/bors[bot]">@bors[bot]</a> on 2020-04-16 13:14</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/IssueHuntBot">@IssueHuntBot</a> on 2020-04-17 08:21</div>
            <div class="timeline-body"><p><a href="https://issuehunt.io/u/pksunkara">@pksunkara</a> has rewarded $45.00 to <a href="https://issuehunt.io/u/pksunkara">@pksunkara</a>. <a href="https://issuehunt.io/repos/31315121/issues/836">See it on IssueHunt</a></p>
<ul>
<li>:moneybag: Total deposit: $50.00</li>
<li>:tada: Repository reward(0%): $0.00</li>
<li>:wrench: Service fee(10%): $5.00</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a>sharkdp/bat#1306</a> on 2020-12-29 08:09</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:56:45 UTC
    </footer>
</body>
</html>
