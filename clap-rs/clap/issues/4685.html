<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>`generate_help` for a subcommand doesn't include the `bin_name` - clap-rs/clap #4685</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1><code>generate_help</code> for a subcommand doesn't include the <code>bin_name</code></h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/clap-rs/clap/issues/4685">#4685</a>
        opened by <a href="https://github.com/not-my-profile">@not-my-profile</a>
        on 2023-01-30 03:54
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/not-my-profile">@not-my-profile</a></div>
            <div class="timeline-body"><pre><code class="language-rust">use clap::CommandFactory;
use clap::Parser;

#[derive(clap::Parser, Debug)]
#[command(bin_name = &quot;main-command&quot;)]
struct Args {
    #[command(subcommand)]
    cmd: Command,
}

#[derive(Debug, clap::Subcommand)]
enum Command {
    Subcommand,
}

fn main() {
    println!(
        &quot;### generate_help reports:\n{}&quot;,
        Args::command()
            .get_subcommands()
            .next()
            .unwrap()
            .clone()
            .render_help()
    );
    println!(&quot;### Args::parse() prints:\n&quot;);
    let args = Args::parse();
}
</code></pre>
<p>When running the above code with <code>cargo run help subcommand</code>, you get the following output:</p>
<pre><code>### generate_help reports:
Usage: subcommand

Options:
  -h, --help  Print help

### Args::parse() prints:

Usage: main-command subcommand

Options:
  -h, --help  Print help
</code></pre>
<p>Notice how the <code>Usage:</code> line generated by <code>generate_help</code> does not include the name (<code>bin_name</code>) of the main command (<code>main-command</code>).</p>
<p>I would expect the output of <code>generate_help</code> to match the output of the actual help clap prints when parsing arguments.</p>
<h3>Versions</h3>
<ul>
<li>rustc 1.65.0 (897e37553 2022-11-02)</li>
<li>clap v4.1.4</li>
</ul>
<h3>Debug Output</h3>
<details>
<summary>Debug output</summary>

<pre><code>    Finished dev [unoptimized + debuginfo] target(s) in 0.03s
     Running `target/debug/foo help subcommand`
[      clap::builder::command] 	Command::_build: name=&quot;subcommand&quot;
[      clap::builder::command] 	Command::_propagate:subcommand
[      clap::builder::command] 	Command::_check_help_and_version:subcommand expand_help_tree=false
[      clap::builder::command] 	Command::long_help_exists
[      clap::builder::command] 	Command::_check_help_and_version: Building default --help
[      clap::builder::command] 	Command::_propagate_global_args:subcommand
[clap::builder::debug_asserts] 	Command::_debug_asserts
[clap::builder::debug_asserts] 	Arg::_debug_asserts:help
[clap::builder::debug_asserts] 	Command::_verify_positionals
[          clap::output::help] 	write_help
[ clap::output::help_template] 	HelpTemplate::new cmd=subcommand, use_long=false
[ clap::output::help_template] 	should_show_arg: use_long=false, arg=help
[ clap::output::help_template] 	HelpTemplate::write_templated_help
[ clap::output::help_template] 	HelpTemplate::write_before_help
[         clap::output::usage] 	Usage::create_usage_no_title
[         clap::output::usage] 	Usage::create_help_usage; incl_reqs=true
[         clap::output::usage] 	Usage::needs_options_tag
[         clap::output::usage] 	Usage::needs_options_tag:iter: f=help
[         clap::output::usage] 	Usage::needs_options_tag:iter Option is built-in
[         clap::output::usage] 	Usage::needs_options_tag: [OPTIONS] not required
[         clap::output::usage] 	Usage::get_args: incls=[]
[         clap::output::usage] 	Usage::get_args: unrolled_reqs=[]
[         clap::output::usage] 	Usage::get_args: ret_val=[]
[         clap::output::usage] 	Usage::create_help_usage: usage=subcommand
[ clap::output::help_template] 	HelpTemplate::write_all_args
[ clap::output::help_template] 	should_show_arg: use_long=false, arg=help
[ clap::output::help_template] 	HelpTemplate::write_args Options
[ clap::output::help_template] 	should_show_arg: use_long=false, arg=help
[ clap::output::help_template] 	HelpTemplate::write_args: arg=&quot;help&quot; longest=6
[ clap::output::help_template] 	should_show_arg: use_long=false, arg=help
[ clap::output::help_template] 	HelpTemplate::spec_vals: a=--help
[ clap::output::help_template] 	HelpTemplate::spec_vals: a=--help
[ clap::output::help_template] 	HelpTemplate::short
[ clap::output::help_template] 	HelpTemplate::long
[ clap::output::help_template] 	HelpTemplate::align_to_about: arg=help, next_line_help=false, longest=6
[ clap::output::help_template] 	HelpTemplate::align_to_about: positional=false arg_len=6, spaces=2
[ clap::output::help_template] 	HelpTemplate::help
[ clap::output::help_template] 	HelpTemplate::help: help_width=14, spaces=10, avail=86
[ clap::output::help_template] 	HelpTemplate::write_after_help
### generate_help reports:
Usage: subcommand

Options:
  -h, --help  Print help

### Args::parse() prints:

[      clap::builder::command] 	Command::_do_parse
[      clap::builder::command] 	Command::_build: name=&quot;foo&quot;
[      clap::builder::command] 	Command::_propagate:foo
[      clap::builder::command] 	Command::_check_help_and_version:foo expand_help_tree=false
[      clap::builder::command] 	Command::long_help_exists
[      clap::builder::command] 	Command::_check_help_and_version: Building default --help
[      clap::builder::command] 	Command::_check_help_and_version: Building help subcommand
[      clap::builder::command] 	Command::_propagate_global_args:foo
[clap::builder::debug_asserts] 	Command::_debug_asserts
[clap::builder::debug_asserts] 	Arg::_debug_asserts:help
[clap::builder::debug_asserts] 	Command::_verify_positionals
[        clap::parser::parser] 	Parser::get_matches_with
[        clap::parser::parser] 	Parser::get_matches_with: Begin parsing 'RawOsStr(&quot;help&quot;)' ([104, 101, 108, 112])
[        clap::parser::parser] 	Parser::possible_subcommand: arg=Ok(&quot;help&quot;)
[        clap::parser::parser] 	Parser::get_matches_with: sc=Some(&quot;help&quot;)
[        clap::parser::parser] 	Parser::parse_help_subcommand
[         clap::output::usage] 	Usage::get_required_usage_from: incls=[], matcher=false, incl_last=true
[         clap::output::usage] 	Usage::get_required_usage_from: unrolled_reqs=[]
[         clap::output::usage] 	Usage::get_required_usage_from: ret_val=[]
[      clap::builder::command] 	Command::_build_subcommand Setting bin_name of subcommand to &quot;main-command subcommand&quot;
[      clap::builder::command] 	Command::_build_subcommand Setting display_name of subcommand to &quot;foo-subcommand&quot;
[      clap::builder::command] 	Command::_build: name=&quot;subcommand&quot;
[      clap::builder::command] 	Command::_propagate:subcommand
[      clap::builder::command] 	Command::_check_help_and_version:subcommand expand_help_tree=false
[      clap::builder::command] 	Command::long_help_exists
[      clap::builder::command] 	Command::_check_help_and_version: Building default --help
[      clap::builder::command] 	Command::_propagate_global_args:subcommand
[clap::builder::debug_asserts] 	Command::_debug_asserts
[clap::builder::debug_asserts] 	Arg::_debug_asserts:help
[clap::builder::debug_asserts] 	Command::_verify_positionals
[      clap::builder::command] 	Command::long_help_exists: false
[      clap::builder::command] 	Command::write_help_err: foo-subcommand, use_long=false
[      clap::builder::command] 	Command::long_help_exists: false
[          clap::output::help] 	write_help
[ clap::output::help_template] 	HelpTemplate::new cmd=subcommand, use_long=false
[ clap::output::help_template] 	should_show_arg: use_long=false, arg=help
[ clap::output::help_template] 	HelpTemplate::write_templated_help
[ clap::output::help_template] 	HelpTemplate::write_before_help
[         clap::output::usage] 	Usage::create_usage_no_title
[         clap::output::usage] 	Usage::create_help_usage; incl_reqs=true
[         clap::output::usage] 	Usage::needs_options_tag
[         clap::output::usage] 	Usage::needs_options_tag:iter: f=help
[         clap::output::usage] 	Usage::needs_options_tag:iter Option is built-in
[         clap::output::usage] 	Usage::needs_options_tag: [OPTIONS] not required
[         clap::output::usage] 	Usage::get_args: incls=[]
[         clap::output::usage] 	Usage::get_args: unrolled_reqs=[]
[         clap::output::usage] 	Usage::get_args: ret_val=[]
[         clap::output::usage] 	Usage::create_help_usage: usage=main-command subcommand
[ clap::output::help_template] 	HelpTemplate::write_all_args
[ clap::output::help_template] 	should_show_arg: use_long=false, arg=help
[ clap::output::help_template] 	HelpTemplate::write_args Options
[ clap::output::help_template] 	should_show_arg: use_long=false, arg=help
[ clap::output::help_template] 	HelpTemplate::write_args: arg=&quot;help&quot; longest=6
[ clap::output::help_template] 	should_show_arg: use_long=false, arg=help
[ clap::output::help_template] 	HelpTemplate::spec_vals: a=--help
[ clap::output::help_template] 	HelpTemplate::spec_vals: a=--help
[ clap::output::help_template] 	HelpTemplate::short
[ clap::output::help_template] 	HelpTemplate::long
[ clap::output::help_template] 	HelpTemplate::align_to_about: arg=help, next_line_help=false, longest=6
[ clap::output::help_template] 	HelpTemplate::align_to_about: positional=false arg_len=6, spaces=2
[ clap::output::help_template] 	HelpTemplate::help
[ clap::output::help_template] 	HelpTemplate::help: help_width=14, spaces=10, avail=86
[ clap::output::help_template] 	HelpTemplate::write_after_help
[      clap::builder::command] 	Command::color: Color setting...
[      clap::builder::command] 	Auto
[      clap::builder::command] 	Command::color: Color setting...
[      clap::builder::command] 	Auto
Usage: main-command subcommand

Options:
  -h, --help  Print help
</code></pre>
</details>

</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">C-bug</span> added by @not-my-profile on 2023-01-30 03:55</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../astral-sh/ruff/pulls/2325.html">astral-sh/ruff#2325</a> on 2023-01-30 03:56</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2023-01-30 13:12</div>
            <div class="timeline-body"><p>You need to call <code>cmd.build()</code> first.  The usage is the most obvious problem; without <code>build</code> a lot of other things might be incorrect</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2023-01-30 13:14</div>
            <div class="timeline-body"><p>To clarify,</p>
<pre><code class="language-rust">let mut cmd = Args::command();
cmd.build();
...
</code></pre>
<p>We call build for the individual subcommand but you need to call build on the top-level command.</p>
<p>We should be at least calling this out in the docs.  We might want to change the implicit build to an assert to make this more obvious.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2023-01-31 22:04</div>
            <div class="timeline-body"><p>I'm assuming that has resolved things for you.  If not, let us know!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @epage on 2023-01-31 22:04</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/not-my-profile">@not-my-profile</a> on 2023-02-01 03:21</div>
            <div class="timeline-body"><p>Yes, thanks! This indeed worked :)</p>
<p>I think ideally such methods would only be callable after invoking <code>build</code>, using the builder pattern, i.e. <code>build</code> would return another type where the methods are available ... in order to get the build-time safety Rust is famous for. But I assume this would be a bit cumbersome to implement since it would be a breaking change?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2023-02-01 16:56</div>
            <div class="timeline-body"><p>That is being tracked in #2911 which is complicated by the lazy building that clap does.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:49:00 UTC
    </footer>
</body>
</html>
