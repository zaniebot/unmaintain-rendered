<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Feature: Custom Derive for ArgEnum - clap-rs/clap #1659</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Feature: Custom Derive for ArgEnum</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/clap-rs/clap/issues/1659">#1659</a>
        opened by <a href="https://github.com/kbknapp">@kbknapp</a>
        on 2017-11-12 19:49
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/kbknapp">@kbknapp</a></div>
            <div class="timeline-body"><p><em>From @Hoverbear on November 12, 2017 18:11</em></p>
<p>Hey!</p>
<p>I had a bit of time, and a hankering to write a custom derive, so I got working on a custom derive for <code>ArgEnum</code>.</p>
<p>I&#x27;ve structured the crate so if we want to expand it, it should be easy. I think this is related to #835 but I didn&#x27;t look too deeply into what the progress is with that.</p>
<p>The crate is https://github.com/Hoverbear/clap-derives and unpublished, and I&#x27;d be more than happy to transfer you (@kbknapp) ownership. It&#x27;s a first draft and could probably use refinement.</p>
<p>You can see an example here:</p>
<pre><code>#[macro_use]
extern crate clap;
#[macro_use]
extern crate clap_derive;

use clap::{App, Arg};

#[derive(ArgEnum, Debug)]
enum ArgChoice {
    Foo,
    Bar,
    Baz,
}

fn main() {
    let matches = App::new(env!(&quot;CARGO_PKG_NAME&quot;))
            .arg(Arg::with_name(&quot;arg&quot;)
                .required(true)
                .takes_value(true)
                .possible_values(&amp;ArgChoice::variants())
            ).get_matches();
    
    let t = value_t!(matches.value_of(&quot;arg&quot;), ArgChoice)
        .unwrap_or_else(|e| e.exit());

    println!(&quot;{:?}&quot;, t);
}
</code></pre>
<p>Will derive this:</p>
<pre><code>impl ::std::str::FromStr for ArgChoice {
    type Err = String;
    fn from_str(input: &amp;str) -&gt; ::std::result::Result&lt;Self, Self::Err&gt; {
        match input {
            val if ::std::ascii::AsciiExt::eq_ignore_ascii_case(val, &quot;Foo&quot;) =&gt; Ok(ArgChoice::Foo),
            val if ::std::ascii::AsciiExt::eq_ignore_ascii_case(val, &quot;Bar&quot;) =&gt; Ok(ArgChoice::Bar),
            val if ::std::ascii::AsciiExt::eq_ignore_ascii_case(val, &quot;Baz&quot;) =&gt; Ok(ArgChoice::Baz),
            _ =&gt; Err({
                let v = [&quot;Foo&quot;, &quot;Bar&quot;, &quot;Baz&quot;];



                ::fmt::format(::std::fmt::Arguments::new_v1_formatted(
                    &amp;[&quot;valid values: &quot;],
                    &amp;match (&amp;v.join(&quot; ,&quot;),) {
                        (__arg0,) =&gt; {
                            [
                                ::std::fmt::ArgumentV1::new(__arg0, ::std::fmt::Display::fmt),
                            ]
                        }
                    },
                    &amp;[
                        ::std::fmt::rt::v1::Argument {
                            position: ::std::fmt::rt::v1::Position::At(0usize),
                            format: ::std::fmt::rt::v1::FormatSpec {
                                fill: &#x27; &#x27;,
                                align: ::std::fmt::rt::v1::Alignment::Unknown,
                                flags: 0u32,
                                precision: ::std::fmt::rt::v1::Count::Implied,
                                width: ::std::fmt::rt::v1::Count::Implied,
                            },
                        },
                    ],
                ))
            }),
        }
    }
}
impl ArgChoice {
    fn variants() -&gt; [&amp;&#x27;static str; 3usize] {
        [&quot;Foo&quot;, &quot;Bar&quot;, &quot;Baz&quot;]
    }
}
</code></pre>
<p><em>Copied from original issue: kbknapp/clap-rs#1103</em></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/kbknapp">@kbknapp</a> on 2017-11-12 19:49</div>
            <div class="timeline-body"><p>Hey!</p>
<p>cc @TeXitoi</p>
<p>Excellent! This is a great start towards my ideas for 3.x. I&#x27;ve cc&#x27;d @TeXitoi because I&#x27;d like to re-invigorate the move towards 3.x and finishing the CustomDerive piece is a big part of that movement. With my job monopolizing my time this kind of fell off in #835 but now that the <a href="https://github.com/kbknapp/clap-rs/tree/v3-master">v3-master branch</a> is coming together it&#x27;s worth working towards again.</p>
<p>The grand plan is to create a <code>clap_derive</code> crate which contains <code>#[derive(*)]</code> directives:</p>
<ul>
<li><code>ArgEnum</code> as you&#x27;ve done :heart_eyes:</li>
<li><code>IntoApp</code> which takes an arbitrary struct and creates a <code>clap::App</code> (currently implemented in <a href="https://github.com/TeXitoi/structopt"><code>structopt</code></a> which I&#x27;d like to pull into this <code>clap_derive</code> crate)</li>
<li><code>FromArgMatches</code> which takes a <code>clap::ArgMatches</code> struct and creates the arbitrary struct (also implemented in <code>structopt</code>)</li>
<li><code>ClapApp</code> which is a convenience marking and simply does <em>both</em> <code>IntoApp</code> and <code>FromArgMatches</code></li>
<li><code>ClapKey</code> (name?...maybe <code>ArgKey</code>?) which allows using an enum instead of strings to access <code>clap::Arg</code>s, <code>clap::App</code>s (formerly <code>clap::SubCommand</code>s in v2.x), and <code>clap::ArgGroup</code>s.</li>
</ul>
<p>I was tentatively planning on storing all the <code>clap_*</code> crates (I&#x27;m also moving the shell completions to <code>clap_completions</code> and macros to <code>clap_macros</code>) at the root of the clap repo, but individual repos are OK as well, although I&#x27;d like everything to versioned in lock-step which is harder in individual repos.</p>
<p>If both @Hoverbear and @TeXitoi think the design is sound/doable I&#x27;d like to make PRs against the v3-master branch, or if keeping individual repos is better, making PRs against the <code>clap_derive</code> crate. If that&#x27;s the route we go, I would like to transfer the crate to me in order to provide less confusion to the community as this would be part of the &quot;official&quot; clap crates, however I would also like to keep/add @Hoverbear and @TeXitoi as authors in the <code>Cargo.toml</code> because they the ones deserving of it. Also at that point, both would become collaborators on this repo so they could continue to work on this even when I&#x27;m busy with my day job.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/kbknapp">@kbknapp</a> on 2017-11-12 19:49</div>
            <div class="timeline-body"><p>Here are the unknowns still, and what needs to be decided</p>
Supporting Subcommands via CustomDerive
<p>We need to find out how to support a struct with arbitrary options/flags and also a subcommand, and how that gets represented via CustomDerive. I believe @TeXitoi suggested an enum, where each variant holds it&#x27;s arbitrary struct representation. I&#x27;m good with this, and we just need to work towards ironing out the details and actually implementing. I believe this would also require adding another <code>#[derive(*)]</code> directive such as <code>ClapSubCommand</code> for enums which are to represent a subcommand.</p>
<p>The hard part is how does this work ergonomically.</p>
<p>Some code examples. I want the end user result to be as close as possible to to this:</p>
<pre><code>#[derive(ClapApp)]
struct MyApp {
    flag: bool,
    subcommand: MySubCommand
}

#[derive(ClapSubCommand)]
enum MySubCommand {
    Foo(FooCommand),
    Bar(BarCommand),
}

#[derive(ClapApp)]
struct FooCommand {
    verbose: bool
}

#[derive(ClapApp)]
struct BarCommand {
    name: String
}

fn main() {
    // run with `$ myapp bar kevin`
    let app = MyApp::parse();
    match app.subcommand {
        FooCommand(foo) =&gt; println!(&quot;Verbose used?: {:?}&quot;, foo.verbose),
        BarCommand(bar) =&gt; println!(&quot;Hello {}!&quot;, bar.name),
        _ =&gt; println!(&quot;No subcommand used.&quot;),
    }
}
</code></pre>
Supporting ASCII Case Insensitive ArgEnums
<p>As @Hoverbear and I discussed briefly at RustBeltRust, we need these ArgEnums to be case insensitive, but I&#x27;d also like an opt-in version that <em>is</em> case sensitive (perhaps via a different <code>#[derive(*)]</code> directive...<code>ArgEnumCaseSenseitive</code>? To incentivise case insensitivity due to typing length?</p>
Supporting Hyphens <code>-</code> in ArgEnums
<p>There&#x27;s also discussion in #1098 about if hyphens should be ignored or allowed, etc. I&#x27;m inclined to either allow hyphens (i.e. ignore them) or require special chars such as underscore (<code>_</code>) to allow them. Bottom line is there should be a way for people to use hyphens in their <code>ArgEnum</code>s</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/kbknapp">@kbknapp</a> on 2017-11-12 19:49</div>
            <div class="timeline-body"><p><em>From @Hoverbear on November 12, 2017 19:28</em></p>
<p>@kbknapp Please be aware custom derive crates must <strong>only</strong> contain custom derives. So we&#x27;d need a <code>clap_derive</code> crate with all of them in it separate from <code>clap</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/kbknapp">@kbknapp</a> on 2017-11-12 19:49</div>
            <div class="timeline-body"><p><em>From @Hoverbear on November 12, 2017 19:29</em></p>
<p>For case sensitivity around <code>ArgEnum</code> we could have an attribute that is <code>#[case_insensitive]</code>, for example.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/kbknapp">@kbknapp</a> on 2017-11-12 19:49</div>
            <div class="timeline-body"><p><em>From @Hoverbear on November 12, 2017 19:33</em></p>
<p>@kbknapp You should have a transfer request in your inbox.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/kbknapp">@kbknapp</a> on 2017-11-12 19:49</div>
            <div class="timeline-body"><blockquote>
<p>Please be aware custom derive crates must only contain custom derives. So we&#x27;d need a clap_derive crate with all of them in it separate from clap</p>
</blockquote>
<p>Ah ok I wasn&#x27;t aware of this having not done much with CustomDerive. OK separate repos it is, I&#x27;m good with it :smile:  :+1:</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Hoverbear">@Hoverbear</a> on 2017-11-12 20:01</div>
            <div class="timeline-body"><p>clap-rs/clap_derive#4 doesn&#x27;t specify this much. Is there any remaining feature this should handle? I think expanding the examples would be a good idea as well.</p>
<ul>
<li>[x] Expand examples.</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/TeXitoi">@TeXitoi</a> on 2017-11-13 10:55</div>
            <div class="timeline-body"><p>Just to comment about 2 repos: derive crates need to be separate, but you can put several crates in a repo. And such a repo will not be independent from the rest, we need a normal crate to define the traits that will be implemented by the derive crate. (maybe not for ArgEnum as it implement <code>FromStr</code>)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/TeXitoi">@TeXitoi</a> on 2017-11-13 11:05</div>
            <div class="timeline-body"><p>About structopt, it is feature-full for me since about a week thanks to external contributors. It now support subcommands, calling any <code>App</code> and <code>Arg</code> methods, custom converters and OsStr support.</p>
<p>I will not have time to contribute by porting structopt here, but I&#x27;m available to review everything about that and giving my opinion.</p>
<p>@kbknapp if you can check the  current status of structopt. I&#x27;m very interested by your feedbacks about the interface. If you like or dislike some syntax, and if you see any critical lacking feature.</p>
<p>Note that I don&#x27;t think having 2 derives for <code>IntoApp</code> and <code>FromArgMatcher</code> is really needed as the attributes are needed in the 2 sides.</p>
<p>Maybe we can open issues to talk about all that.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/kbknapp">@kbknapp</a> on 2017-11-13 22:14</div>
            <div class="timeline-body"><p>@TeXitoi no worries, I&#x27;m low on time over the next few weeks as well due to holidays and travel. I&#x27;ll gladly take a look once I get some time :smile:</p>
<p>I&#x27;ll do some porting too once I get a little extra time. So that it&#x27;s clear too, I intend to use as much code from structopt as possible without many changes unless I happen to see something that is directly contradictory to how clap does it...which doubt I&#x27;ll find :stuck_out_tongue_winking_eye:</p>
<p>I&#x27;d also like to maintain all commit history so that @TeXitoi doesn&#x27;t lose any commits. (Just FYI in case someone else starts doing some porting, I don&#x27;t want to simply copy-paste and erase all commit history :wink:)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Hoverbear">@Hoverbear</a> on 2017-11-14 08:33</div>
            <div class="timeline-body"><p>@kbknapp Maybe we could merge this repo into that one instead of the other way around?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/pksunkara">@pksunkara</a> on 2020-02-03 09:18</div>
            <div class="timeline-body"><p>@CreepySkeleton This is possibly related to multiple traits.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone &quot;3.0&quot; by <a href="https://github.com/pksunkara">@pksunkara</a> on 2020-02-03 09:18</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">C: derive macros</span> added by <a href="https://github.com/pksunkara">@pksunkara</a> on 2020-02-03 09:18</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">W: 3.x</span> added by <a href="https://github.com/pksunkara">@pksunkara</a> on 2020-02-03 09:19</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/CreepySkeleton">@CreepySkeleton</a> on 2020-02-03 09:25</div>
            <div class="timeline-body"><p>Yeah, kind of, but it can wait until beta. The nearest milestone is alpha, just to show people the project is still alive / being resurrected.</p>
<p>I&#x27;m getting custom derives to work, anticipated time is ~5 hours from now (I&#x27;ll get to it in ~3 hours since I have some urgent stuff to do now, sorry for delay). Then we can get rid of <code>no_version</code> and start working on multiple traits approach. I drew a sketch <a href="https://gist.github.com/CreepySkeleton/3518a3d104c3e1c451be40e6a8b0032b">here</a></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">W: 3.x</span> removed by <a href="https://github.com/pksunkara">@pksunkara</a> on 2020-02-03 09:30</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a>clap-rs/clap#1661</a> on 2020-02-03 09:37</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/pksunkara">@pksunkara</a> on 2020-02-03 09:38</div>
            <div class="timeline-body"><p>Some implementation is at <a href="https://github.com/clap-rs/clap_derive/pull/15">clap-rs/clap_derive#15</a></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">C: arg enums</span> added by <a href="https://github.com/pksunkara">@pksunkara</a> on 2020-04-12 10:29</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">T: new feature</span> added by <a href="https://github.com/pksunkara">@pksunkara</a> on 2020-04-12 10:29</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/bors[bot]">@bors[bot]</a> on 2020-04-22 18:24</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/pksunkara">@pksunkara</a> on 2020-04-22 18:44</div>
            <div class="timeline-body"><p>https://github.com/clap-rs/clap/blob/master/clap_derive/tests/arg_enum.rs</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:57:36 UTC
    </footer>
</body>
</html>
