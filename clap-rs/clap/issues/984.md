```yaml
number: 984
title: takes_value does not always works
type: issue
state: closed
author: mantal
labels:
  - C-enhancement
  - A-docs
  - E-medium
  - E-easy
assignees: []
created_at: 2017-06-09T11:58:38Z
updated_at: 2020-04-12T21:56:39Z
url: https://github.com/clap-rs/clap/issues/984
synced_at: 2026-01-10T01:57:41Z
```

# takes_value does not always works

---

_Issue opened by @mantal on 2017-06-09 11:58_

```
    let matches = App::new("foo")
        .arg(Arg::with_name("a")
             .short("a")
             .takes_value(true)
             )
        .arg(Arg::with_name("b")
             .short("b")
             )
        .get_matches();
}
```
Launching this program with `-a -b` does not produce error as it should.

`clap 2.24.2` with `rustc 1.17.0`

---

_Comment by @kbknapp on 2017-06-16 15:24_

This should be:

```rust
let matches = App::new("foo")
    .arg(Arg::with_name("a")
        .short("a")
        .takes_value(true)
        .empty_values(false)   // Added this <-----    
    )
    .arg(Arg::with_name("b")
        .short("b")
    )
    .get_matches();
```
https://docs.rs/clap/2.24.2/clap/struct.Arg.html#method.empty_values

---

_Label `T: RFC / question` added by @kbknapp on 2017-06-16 15:26_

---

_Closed by @kbknapp on 2017-06-20 03:01_

---

_Comment by @mantal on 2017-06-20 10:15_

The documentation state that explicit empty values are allowed but this is implicit.
But if they are allowed too, that mean that `-b -a` incorrectly produce an error.

---

_Reopened by @kbknapp on 2017-07-21 03:44_

---

_Comment by @kbknapp on 2017-07-21 03:45_

I've re-opened this as a docs issue, but it should be moot shortly as I'm trying to fix this for 3.x :wink: 

---

_Label `C: docs` added by @kbknapp on 2017-07-21 03:45_

---

_Label `T: RFC / question` removed by @kbknapp on 2017-07-21 03:45_

---

_Added to milestone `v3-beta.1` by @kbknapp on 2018-07-22 02:27_

---

_Label `W: 3.x` added by @kbknapp on 2018-07-22 02:27_

---

_Label `T: enhancement` added by @kbknapp on 2018-07-22 02:28_

---

_Label `P4: nice to have` added by @kbknapp on 2018-07-22 02:28_

---

_Label `D: easy` added by @kbknapp on 2018-07-22 02:28_

---

_Label `M: mentored` added by @kbknapp on 2018-07-22 02:28_

---

_Label `good first issue` added by @kbknapp on 2018-07-22 02:28_

---

_Referenced in [clap-rs/clap#1339](../../clap-rs/clap/issues/1339.md) on 2018-09-13 00:19_

---

_Comment by @fvictorio on 2019-11-28 20:38_

Hi @kbknapp, I looked into this in the `v2` branch with the reproduction steps of #1339, but this is something you want to fix in v3, is that right?

Anyway, if this is still open, and you can give me some pointers, I would love to give it a try.

---

_Comment by @Dylan-DPC-zz on 2019-11-28 20:41_

@fvictorio yes, we want it preferably on v3 (which is currently master iirc). We can always backport if required. Let me know if you need any help with this 

---

_Comment by @fvictorio on 2019-11-28 21:35_

Thanks @Dylan-DPC. I added this (failing) test:

```rust

#[test]
fn issue_984_takes_value_and_default_value() {
    let m = App::new("hello")
        .arg(
            Arg::with_name("exit-code")
                .long("exit-code")
                .required(true)
                .takes_value(true)
                .default_value("0"),
        )
        .try_get_matches_from(vec!["hello", "--exit-code"]);
    assert!(m.is_err());
    assert_eq!(m.unwrap_err().kind, ErrorKind::EmptyValue);
}
```

Then I looked into the code, but I'm not really sure who should be responsible for this. The `add_defaults` method in `parser.rs` is the one that ignores the fact that the argument was specified but without a value, but it doesn't seem to return an error in any path. There's also `parse_opt` that performs some checks, but when I added one (very naively) it broke some other tests.

What function should be handling this?

---

_Removed from milestone `v3-beta.1` by @pksunkara on 2020-02-01 07:44_

---

_Added to milestone `v3.0` by @pksunkara on 2020-02-01 07:44_

---

_Label `C: asserts` added by @pksunkara on 2020-04-12 21:48_

---

_Label `C: asserts` removed by @pksunkara on 2020-04-12 21:53_

---

_Comment by @pksunkara on 2020-04-12 21:56_

The issue in the original comment has been fixed on master. `takes_value` and `default_value` situation is described in https://github.com/clap-rs/clap/issues/1545

---

_Closed by @pksunkara on 2020-04-12 21:56_

---
