<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Using of non-existing argument (or &quot;help&quot;) in `requires` leads to internal error - clap-rs/clap #1479</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Using of non-existing argument (or &quot;help&quot;) in <code>requires</code> leads to internal error</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/clap-rs/clap/issues/1479">#1479</a>
        opened by <a href="https://github.com/sphynx">@sphynx</a>
        on 2019-05-26 13:43
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sphynx">@sphynx</a></div>
            <div class="timeline-body">

Rust Version
<p>rustc 1.36-nightly</p>
Affected Version of clap
<p>2.33.0</p>
Bug or Feature Request Summary
<p>Using of undefined argument (or even &quot;help&quot;) in <code>Arg::requires</code> leads to internal error and asks for reporting it as an issue here.</p>
Expected Behavior Summary
<p>I think it should report something more friendly, like &quot;required parameter is not defined&quot; or something like that. As far as I can tell it&#x27;s not really an internal error, it&#x27;s just an error of the library user.</p>
<p>Also, I&#x27;m not sure if failing on <code>requires(&quot;help&quot;)</code> is the right approach, since this parameter is auto-generated and technically one should be allowed to require it (unless it is turned off).</p>
<p>It looks like it&#x27;s related to #990 but it seems to be closed by now.</p>
<p>I can fix the issue, I think it is caused by using <code>expected(INTERNAL_ERROR_MSG</code> in this code: https://github.com/clap-rs/clap/blob/784524f7eb193e35f81082cc69454c8c21b948f7/src/app/usage.rs#L459</p>
<p>But as far as I can see, this approach is used in many places in the code (i.e. looking for something by name and failing with <code>INTERNAL_ERROR_MSG</code> if not found), so I am not sure what&#x27;s the best way to proceed here, please let me know.</p>
Actual Behavior Summary
<pre><code>thread &#x27;main&#x27; panicked at &#x27;Fatal internal error. Please consider filing a bug report at https://github.com/clap-rs/clap/issues&#x27;, src/libcore/option.rs:1036:5
</code></pre>
Steps to Reproduce the issue
<p><code>cargo run</code></p>
Sample Code or Link to Sample Code
<pre><code>fn main() {
    let res = App::new(&quot;prog&quot;)
        .arg(
            Arg::with_name(&quot;topic&quot;)
                .takes_value(true)
                .requires(&quot;help&quot;)
                .long(&quot;topic&quot;),
        )
        .get_matches_from_safe(vec![&quot;prog&quot;, &quot;--topic&quot;, &quot;test&quot;]);

    assert!(res.is_err());
}
</code></pre>
Debug output

 Debug Output 
<pre>
<code>
DEBUG:clap:Parser::propagate_settings: self=prog, g_settings=AppFlags(
    (empty),
)
DEBUG:clap:Parser::get_matches_with;
DEBUG:clap:Parser::create_help_and_version;
DEBUG:clap:Parser::create_help_and_version: Building --help
DEBUG:clap:Parser::create_help_and_version: Building --version
DEBUG:clap:Parser::get_matches_with: Begin parsing &#x27;&quot;--topic&quot;&#x27; ([45, 45, 116, 111, 112, 105, 99])
DEBUG:clap:Parser::is_new_arg:&quot;--topic&quot;:NotFound
DEBUG:clap:Parser::is_new_arg: arg_allows_tac=false
DEBUG:clap:Parser::is_new_arg: -- found
DEBUG:clap:Parser::is_new_arg: starts_new_arg=true
DEBUG:clap:Parser::possible_subcommand: arg=&quot;--topic&quot;
DEBUG:clap:Parser::get_matches_with: possible_sc=false, sc=None
DEBUG:clap:ArgMatcher::process_arg_overrides:None;
DEBUG:clap:Parser::parse_long_arg;
DEBUG:clap:Parser::parse_long_arg: Does it contain &#x27;=&#x27;...No
DEBUG:clap:OptBuilder::fmt:topic
DEBUG:clap:Parser::parse_long_arg: Found valid opt &#x27;--topic &#x27;
DEBUG:clap:Parser::parse_opt; opt=topic, val=None
DEBUG:clap:Parser::parse_opt; opt.settings=ArgFlags(EMPTY_VALS | TAKES_VAL | DELIM_NOT_SET)
DEBUG:clap:Parser::parse_opt; Checking for val...None
DEBUG:clap:ArgMatcher::inc_occurrence_of: arg=topic
DEBUG:clap:ArgMatcher::inc_occurrence_of: first instance
DEBUG:clap:Parser::groups_for_arg: name=topic
DEBUG:clap:Parser::groups_for_arg: No groups defined
DEBUG:clap:Parser::parse_opt: More arg vals required...
DEBUG:clap:Parser:get_matches_with: After parse_long_arg Opt(&quot;topic&quot;)
DEBUG:clap:Parser::get_matches_with: Begin parsing &#x27;&quot;test&quot;&#x27; ([116, 101, 115, 116])
DEBUG:clap:Parser::is_new_arg:&quot;test&quot;:Opt(&quot;topic&quot;)
DEBUG:clap:Parser::is_new_arg: arg_allows_tac=false
DEBUG:clap:Parser::is_new_arg: probably value
DEBUG:clap:Parser::is_new_arg: starts_new_arg=false
DEBUG:clap:Parser::add_val_to_arg; arg=topic, val=&quot;test&quot;
DEBUG:clap:Parser::add_val_to_arg; trailing_vals=false, DontDelimTrailingVals=false
DEBUG:clap:Parser::add_single_val_to_arg;
DEBUG:clap:Parser::add_single_val_to_arg: adding val...&quot;test&quot;
DEBUG:clap:Parser::groups_for_arg: name=topic
DEBUG:clap:Parser::groups_for_arg: No groups defined
DEBUG:clap:ArgMatcher::needs_more_vals: o=topic
DEBUG:clap:ArgMatcher::process_arg_overrides:Some(&quot;topic&quot;);
DEBUG:clap:Parser::remove_overrides:[];
DEBUG:clap:Validator::validate;
DEBUG:clap:Parser::add_defaults;
DEBUG:clap:Parser::add_defaults:iter:topic: doesn&#x27;t have conditional defaults
DEBUG:clap:Parser::add_defaults:iter:topic: doesn&#x27;t have default vals
DEBUG:clap:Validator::validate_blacklist;
DEBUG:clap:Validator::validate_blacklist:iter:topic;
DEBUG:clap:Parser::groups_for_arg: name=topic
DEBUG:clap:Parser::groups_for_arg: No groups defined
DEBUG:clap:Validator::validate_required: required=[];
DEBUG:clap:Validator::validate_matched_args;
DEBUG:clap:Validator::validate_matched_args:iter:topic: vals=[
    &quot;test&quot;,
]
DEBUG:clap:Validator::validate_arg_num_vals:topic
DEBUG:clap:Validator::validate_arg_values: arg=&quot;topic&quot;
DEBUG:clap:Validator::validate_arg_requires:topic;
DEBUG:clap:Validator::missing_required_error: extra=Some(&quot;help&quot;)
DEBUG:clap:Parser::color;
DEBUG:clap:Parser::color: Color setting...Auto
DEBUG:clap:is_a_tty: stderr=true
DEBUG:clap:Validator::missing_required_error: reqs=[
    &quot;help&quot;,
]
DEBUG:clap:usage::get_required_usage_from: reqs=[&quot;help&quot;], extra=Some(&quot;help&quot;)
DEBUG:clap:usage::get_required_usage_from: after init desc_reqs=[&quot;help&quot;]
DEBUG:clap:usage::get_required_usage_from: no more children
DEBUG:clap:usage::get_required_usage_from: final desc_reqs=[&quot;help&quot;]
DEBUG:clap:usage::get_required_usage_from: args_in_groups=[]
DEBUG:clap:usage::get_required_usage_from:iter:help:
thread &#x27;main&#x27; panicked at &#x27;Fatal internal error. Please consider filing a bug report at https://github.com/clap-rs/clap/issues&#x27;, src/libcore/option.rs:1036:5
note: Run with `RUST_BACKTRACE=1` environment variable to display a backtrace.
</code>
</pre>


</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to <a href="https://github.com/CreepySkeleton">@CreepySkeleton</a> by <a href="https://github.com/CreepySkeleton">@CreepySkeleton</a> on 2020-02-01 13:35</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">T: bug</span> added by <a href="https://github.com/CreepySkeleton">@CreepySkeleton</a> on 2020-02-01 13:36</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">T: bug</span> removed by <a href="https://github.com/CreepySkeleton">@CreepySkeleton</a> on 2020-02-01 13:36</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/CreepySkeleton">@CreepySkeleton</a> on 2020-02-01 13:37</div>
            <div class="timeline-body"><p>I&#x27;m almost sure this is the way it should work, but the error message must be more descriptive. Closing in favor of #1644</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/CreepySkeleton">@CreepySkeleton</a> on 2020-02-01 13:37</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:57:25 UTC
    </footer>
</body>
</html>
