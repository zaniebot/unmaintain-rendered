<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Error with multiple flags and positional arguments - clap-rs/clap #3959</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Error with multiple flags and positional arguments</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/clap-rs/clap/issues/3959">#3959</a>
        opened by <a href="https://github.com/pleshevskiy">@pleshevskiy</a>
        on 2022-07-20 20:54
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/pleshevskiy">@pleshevskiy</a></div>
            <div class="timeline-body">Please complete the following tasks
<ul>
<li>[X] I have searched the <a href="https://github.com/clap-rs/clap/discussions">discussions</a></li>
<li>[X] I have searched the <a href="https://github.com/clap-rs/clap/issues">open</a> and <a href="https://github.com/clap-rs/clap/issues?q=is%3Aissue+label%3AS-wont-fix+is%3Aclosed">rejected</a> issues</li>
</ul>
Rust Version
<p>rustc 1.58.1 (db9d1b20b 2022-01-20)</p>
Clap Version
<p>3.2.13</p>
Minimal reproducible code
<pre><code>use clap::{Arg, ArgAction, Command};

fn main() {
    let matches = args().get_matches();

    println!(
        &quot;input: {:?}&quot;,
        matches
            .get_many::&lt;String&gt;(&quot;input&quot;)
            .unwrap()
            .into_iter()
            .map(String::from)
            .collect::&lt;Vec&lt;_&gt;&gt;()
    );
    println!(&quot;output: {:?}&quot;, matches.get_one::&lt;String&gt;(&quot;output&quot;).unwrap());
    println!(&quot;one: {:?}&quot;, matches.get_one::&lt;String&gt;(&quot;one&quot;));
    println!(&quot;two: {:?}&quot;, matches.get_one::&lt;String&gt;(&quot;two&quot;));
    println!(&quot;yes: {:?}&quot;, matches.get_one::&lt;bool&gt;(&quot;yes&quot;));
}

fn args&lt;&#x27;a&gt;() -&gt; clap::App&lt;&#x27;a&gt; {
    Command::new(&quot;Clap test&quot;)
        .version(&quot;1.0&quot;)
        .author(&quot;Dmitriy Pleshevskiy &lt;dmitriy@ideascup.me&gt;&quot;)
        .about(&quot;Error reproduction with multiple parameters&quot;)
        .arg(Arg::new(&quot;yes&quot;).long(&quot;yes&quot;).action(ArgAction::SetTrue))
        .arg(Arg::new(&quot;one&quot;).long(&quot;one&quot;).action(ArgAction::Set))
        .arg(Arg::new(&quot;two&quot;).long(&quot;two&quot;).action(ArgAction::Set))
        .arg(Arg::new(&quot;input&quot;).multiple_values(true).required(true))
        .arg(Arg::new(&quot;output&quot;).required(true))
}
</code></pre>
Steps to reproduce the bug with the above code
<pre><code>cargo run -- --one 1 --two 2 3 4 5 6 7 8
</code></pre>
Actual Behaviour
<pre><code>error: Found argument &#x27;4&#x27; which wasn&#x27;t expected, or isn&#x27;t valid in this context

USAGE:
    clap-multi-arg-repro [OPTIONS] &lt;input&gt;... &lt;output&gt;
</code></pre>
Expected Behaviour
<pre><code>input: [&quot;3&quot;, &quot;4&quot;, &quot;5&quot;, &quot;6&quot;, &quot;7&quot;]
output: &quot;8&quot;
one: Same(&quot;1&quot;)
two: Some(&quot;2&quot;)
yes: Some(false)
</code></pre>
Additional Context
<p>More examples in repository with error reproduction. https://github.com/pleshevskiy/clap-multi-arg-repro</p>
Debug Output
<pre><code>[      clap::builder::command] 	Command::_do_parse
[      clap::builder::command] 	Command::_build: name=&quot;Clap test&quot;
[      clap::builder::command] 	Command::_propagate:Clap test
[      clap::builder::command] 	Command::_check_help_and_version: Clap test
[      clap::builder::command] 	Command::_propagate_global_args:Clap test
[      clap::builder::command] 	Command::_derive_display_order:Clap test
[clap::builder::debug_asserts] 	Command::_debug_asserts
[clap::builder::debug_asserts] 	Arg::_debug_asserts:help
[clap::builder::debug_asserts] 	Arg::_debug_asserts:version
[clap::builder::debug_asserts] 	Arg::_debug_asserts:yes
[clap::builder::debug_asserts] 	Arg::_debug_asserts:one
[clap::builder::debug_asserts] 	Arg::_debug_asserts:two
[clap::builder::debug_asserts] 	Arg::_debug_asserts:input
[clap::builder::debug_asserts] 	Arg::_debug_asserts:output
[clap::builder::debug_asserts] 	Command::_verify_positionals
[        clap::parser::parser] 	Parser::get_matches_with
[        clap::parser::parser] 	Parser::get_matches_with: Begin parsing &#x27;RawOsStr(&quot;--one&quot;)&#x27; ([45, 45, 111, 110, 101])
[        clap::parser::parser] 	Parser::get_matches_with: Positional counter...1
[        clap::parser::parser] 	Parser::get_matches_with: Low index multiples...true
[        clap::parser::parser] 	Parser::is_new_arg: RawOsStr(&quot;1&quot;):&quot;input&quot;
[        clap::parser::parser] 	Parser::is_new_arg: value
[        clap::parser::parser] 	Parser::possible_subcommand: arg=Ok(&quot;1&quot;)
[        clap::parser::parser] 	Parser::possible_subcommand: arg=Ok(&quot;--one&quot;)
[        clap::parser::parser] 	Parser::get_matches_with: sc=None
[        clap::parser::parser] 	Parser::parse_long_arg
[        clap::parser::parser] 	Parser::parse_long_arg: Does it contain &#x27;=&#x27;...
[        clap::parser::parser] 	Parser::parse_long_arg: Found valid arg or flag &#x27;--one &lt;one&gt;&#x27;
[        clap::parser::parser] 	Parser::parse_long_arg(&quot;one&quot;): Found an arg with value &#x27;None&#x27;
[        clap::parser::parser] 	Parser::parse_opt_value; arg=one, val=None, has_eq=false
[        clap::parser::parser] 	Parser::parse_opt_value; arg.settings=ArgFlags(MULTIPLE_OCC | TAKES_VAL)
[        clap::parser::parser] 	Parser::parse_opt_value; Checking for val...
[        clap::parser::parser] 	Parser::parse_opt_value: More arg vals required...
[        clap::parser::parser] 	Parser::get_matches_with: After parse_long_arg Opt(one)
[        clap::parser::parser] 	Parser::get_matches_with: Begin parsing &#x27;RawOsStr(&quot;1&quot;)&#x27; ([49])
[        clap::parser::parser] 	Parser::get_matches_with: Positional counter...1
[        clap::parser::parser] 	Parser::get_matches_with: Low index multiples...true
[        clap::parser::parser] 	Parser::is_new_arg: RawOsStr(&quot;--two&quot;):&quot;input&quot;
[        clap::parser::parser] 	Parser::is_new_arg: --&lt;something&gt; found
[        clap::parser::parser] 	Parser::get_matches_with: Bumping the positional counter...
[        clap::parser::parser] 	Parser::split_arg_values; arg=one, val=RawOsStr(&quot;1&quot;)
[        clap::parser::parser] 	Parser::split_arg_values; trailing_values=false, DontDelimTrailingVals=false
[   clap::parser::arg_matcher] 	ArgMatcher::needs_more_vals: o=one, resolved=0, pending=1
[        clap::parser::parser] 	Parser::get_matches_with: Begin parsing &#x27;RawOsStr(&quot;--two&quot;)&#x27; ([45, 45, 116, 119, 111])
[        clap::parser::parser] 	Parser::get_matches_with: Positional counter...2
[        clap::parser::parser] 	Parser::get_matches_with: Low index multiples...false
[        clap::parser::parser] 	Parser::possible_subcommand: arg=Ok(&quot;--two&quot;)
[        clap::parser::parser] 	Parser::get_matches_with: sc=None
[        clap::parser::parser] 	Parser::parse_long_arg
[        clap::parser::parser] 	Parser::parse_long_arg: Does it contain &#x27;=&#x27;...
[        clap::parser::parser] 	Parser::parse_long_arg: Found valid arg or flag &#x27;--two &lt;two&gt;&#x27;
[        clap::parser::parser] 	Parser::parse_long_arg(&quot;two&quot;): Found an arg with value &#x27;None&#x27;
[        clap::parser::parser] 	Parser::parse_opt_value; arg=two, val=None, has_eq=false
[        clap::parser::parser] 	Parser::parse_opt_value; arg.settings=ArgFlags(MULTIPLE_OCC | TAKES_VAL)
[        clap::parser::parser] 	Parser::parse_opt_value; Checking for val...
[        clap::parser::parser] 	Parser::parse_opt_value: More arg vals required...
[        clap::parser::parser] 	Parser::resolve_pending: id=one
[        clap::parser::parser] 	Parser::react action=Set, identifier=Some(Long), source=CommandLine
[        clap::parser::parser] 	Parser::react: cur_idx:=1
[        clap::parser::parser] 	Parser::remove_overrides: id=one
[   clap::parser::arg_matcher] 	ArgMatcher::start_custom_arg: id=one, source=CommandLine
[      clap::builder::command] 	Command::groups_for_arg: id=one
[        clap::parser::parser] 	Parser::push_arg_values: [&quot;1&quot;]
[        clap::parser::parser] 	Parser::add_single_val_to_arg: cur_idx:=2
[      clap::builder::command] 	Command::groups_for_arg: id=one
[   clap::parser::arg_matcher] 	ArgMatcher::needs_more_vals: o=one, resolved=1, pending=0
[        clap::parser::parser] 	Parser::get_matches_with: After parse_long_arg Opt(two)
[        clap::parser::parser] 	Parser::get_matches_with: Begin parsing &#x27;RawOsStr(&quot;2&quot;)&#x27; ([50])
[        clap::parser::parser] 	Parser::get_matches_with: Positional counter...2
[        clap::parser::parser] 	Parser::get_matches_with: Low index multiples...false
[        clap::parser::parser] 	Parser::split_arg_values; arg=two, val=RawOsStr(&quot;2&quot;)
[        clap::parser::parser] 	Parser::split_arg_values; trailing_values=false, DontDelimTrailingVals=false
[   clap::parser::arg_matcher] 	ArgMatcher::needs_more_vals: o=two, resolved=0, pending=1
[        clap::parser::parser] 	Parser::get_matches_with: Begin parsing &#x27;RawOsStr(&quot;3&quot;)&#x27; ([51])
[        clap::parser::parser] 	Parser::get_matches_with: Positional counter...2
[        clap::parser::parser] 	Parser::get_matches_with: Low index multiples...false
[        clap::parser::parser] 	Parser::possible_subcommand: arg=Ok(&quot;3&quot;)
[        clap::parser::parser] 	Parser::get_matches_with: sc=None
[        clap::parser::parser] 	Parser::resolve_pending: id=two
[        clap::parser::parser] 	Parser::react action=Set, identifier=Some(Long), source=CommandLine
[        clap::parser::parser] 	Parser::react: cur_idx:=3
[        clap::parser::parser] 	Parser::remove_overrides: id=two
[   clap::parser::arg_matcher] 	ArgMatcher::start_custom_arg: id=two, source=CommandLine
[      clap::builder::command] 	Command::groups_for_arg: id=two
[        clap::parser::parser] 	Parser::push_arg_values: [&quot;2&quot;]
[        clap::parser::parser] 	Parser::add_single_val_to_arg: cur_idx:=4
[      clap::builder::command] 	Command::groups_for_arg: id=two
[   clap::parser::arg_matcher] 	ArgMatcher::needs_more_vals: o=two, resolved=1, pending=0
[        clap::parser::parser] 	Parser::split_arg_values; arg=output, val=RawOsStr(&quot;3&quot;)
[        clap::parser::parser] 	Parser::split_arg_values; trailing_values=false, DontDelimTrailingVals=false
[        clap::parser::parser] 	Parser::get_matches_with: Begin parsing &#x27;RawOsStr(&quot;4&quot;)&#x27; ([52])
[        clap::parser::parser] 	Parser::get_matches_with: Positional counter...3
[        clap::parser::parser] 	Parser::get_matches_with: Low index multiples...false
[        clap::parser::parser] 	Parser::possible_subcommand: arg=Ok(&quot;4&quot;)
[        clap::parser::parser] 	Parser::get_matches_with: sc=None
[        clap::parser::parser] 	Parser::resolve_pending: id=output
[        clap::parser::parser] 	Parser::react action=StoreValue, identifier=Some(Index), source=CommandLine
[        clap::parser::parser] 	Parser::remove_overrides: id=output
[   clap::parser::arg_matcher] 	ArgMatcher::start_occurrence_of_arg: id=output
[      clap::builder::command] 	Command::groups_for_arg: id=output
[        clap::parser::parser] 	Parser::push_arg_values: [&quot;3&quot;]
[        clap::parser::parser] 	Parser::add_single_val_to_arg: cur_idx:=5
[      clap::builder::command] 	Command::groups_for_arg: id=output
[   clap::parser::arg_matcher] 	ArgMatcher::needs_more_vals: o=output, resolved=1, pending=0
[         clap::output::usage] 	Usage::create_usage_with_title
[         clap::output::usage] 	Usage::create_usage_no_title
[         clap::output::usage] 	Usage::create_help_usage; incl_reqs=true
[         clap::output::usage] 	Usage::get_required_usage_from: incls=[], matcher=false, incl_last=false
[         clap::output::usage] 	Usage::get_required_usage_from: unrolled_reqs={input, output}
[         clap::output::usage] 	Usage::get_required_usage_from:push:input
[         clap::output::usage] 	Usage::get_required_usage_from:push:output
[         clap::output::usage] 	Usage::get_required_usage_from: ret_val={&quot;&lt;input&gt;...&quot;, &quot;&lt;output&gt;&quot;}
[         clap::output::usage] 	Usage::needs_options_tag
[         clap::output::usage] 	Usage::needs_options_tag:iter: f=help
[         clap::output::usage] 	Usage::needs_options_tag:iter Option is built-in
[         clap::output::usage] 	Usage::needs_options_tag:iter: f=version
[         clap::output::usage] 	Usage::needs_options_tag:iter Option is built-in
[         clap::output::usage] 	Usage::needs_options_tag:iter: f=yes
[      clap::builder::command] 	Command::groups_for_arg: id=yes
[         clap::output::usage] 	Usage::needs_options_tag:iter: [OPTIONS] required
[         clap::output::usage] 	Usage::create_help_usage: usage=clap-multi-arg-repro [OPTIONS] &lt;input&gt;... &lt;output&gt;
[      clap::builder::command] 	Command::color: Color setting...
[      clap::builder::command] 	Auto
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a>brxken128/dexios#147</a> on 2022-07-20 20:58</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2022-07-20 21:56</div>
            <div class="timeline-body"><p>One thing missing the issue is where the expectation comes from.  There is a lot of functionality to clap so its easier to lose track of and that extra context you have is helpful.  For example, is this a regression?</p>
<p>In trying to answer it myself, I first reminded myself of <a href="https://docs.rs/clap/latest/clap/struct.App.html#method.allow_missing_positional">Command::allow_missing_positional</a></p>
<p>I then gave it a try and found it interestingly inconsistent</p>
<pre><code>$  ./clap-3959.rs 1 2 3 4 5 6 7 8
input: [&quot;1&quot;, &quot;2&quot;, &quot;3&quot;, &quot;4&quot;, &quot;5&quot;, &quot;6&quot;, &quot;7&quot;]
output: &quot;8&quot;
one: None
two: None
yes: Some(false)

$  ./clap-3959.rs --one 1 2 3 4 5 6 7 8
input: [&quot;2&quot;, &quot;3&quot;, &quot;4&quot;, &quot;5&quot;, &quot;6&quot;, &quot;7&quot;]
output: &quot;8&quot;
one: Some(&quot;1&quot;)
two: None
yes: Some(false)

$  ./clap-3959.rs --one 1 --two 2 3 4 5 6 7 8
error: Found argument &#x27;4&#x27; which wasn&#x27;t expected, or isn&#x27;t valid in this context

USAGE:
    clap-3959_599c761b77b65bcdaa699e56 [OPTIONS] &lt;input&gt;... &lt;output&gt;

For more information try --help
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/pleshevskiy">@pleshevskiy</a> on 2022-07-20 22:10</div>
            <div class="timeline-body"><blockquote>
<p>I then gave it a try and found it interestingly inconsistent</p>
</blockquote>
<p>Yes, I described it in the related <a href="https://github.com/pleshevskiy/clap-multi-arg-repro">repo</a></p>
<blockquote>
<p>In trying to answer it myself, I first reminded myself of <a href="https://docs.rs/clap/latest/clap/struct.App.html#method.allow_missing_positional">Command::allow_missing_positional</a></p>
</blockquote>
<p>I&#x27;ll try other ways tomorrow</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2022-07-20 22:15</div>
            <div class="timeline-body"><blockquote>
<p>I&#x27;ll try other ways tomorrow</p>
</blockquote>
<p>I tried it and it doesn&#x27;t help</p>
<blockquote>
<p>Yes, I described it in the related <a href="https://github.com/pleshevskiy/clap-multi-arg-repro">repo</a></p>
</blockquote>
<p>For me, my expectation for a linked to repo is to be optional and all of the needed content is in the original issue.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2022-07-20 22:20</div>
            <div class="timeline-body"><p>I backported to clap 3.0.0 and its still a problem then</p>
<pre><code>#!/usr/bin/env -S rust-script --debug

//! ```cargo
//! [dependencies]
//! clap = { version = &quot;=3.0.0&quot;, features = [&quot;derive&quot;, &quot;debug&quot;] }
//! ```

use clap::{App, Arg};

fn main() {
    let matches = args().get_matches();

    println!(
        &quot;input: {:?}&quot;,
        matches
            .values_of(&quot;input&quot;)
            .unwrap_or_default()
            .collect::&lt;Vec&lt;_&gt;&gt;()
    );
    println!(&quot;output: {:?}&quot;, matches.value_of(&quot;output&quot;));
    println!(&quot;one: {:?}&quot;, matches.value_of(&quot;one&quot;));
    println!(&quot;two: {:?}&quot;, matches.value_of(&quot;two&quot;));
    println!(&quot;yes: {:?}&quot;, matches.is_present(&quot;yes&quot;));
}

fn args&lt;&#x27;a&gt;() -&gt; clap::App&lt;&#x27;a&gt; {
    App::new(&quot;Clap test&quot;)
        .version(&quot;1.0&quot;)
        .author(&quot;Dmitriy Pleshevskiy &lt;dmitriy@ideascup.me&gt;&quot;)
        .about(&quot;Error reproduction with multiple parameters&quot;)
        //.allow_missing_positional(true)
        .arg(Arg::new(&quot;yes&quot;).long(&quot;yes&quot;))
        .arg(Arg::new(&quot;one&quot;).long(&quot;one&quot;).takes_value(true))
        .arg(Arg::new(&quot;two&quot;).long(&quot;two&quot;).takes_value(true))
        .arg(Arg::new(&quot;input&quot;).multiple_values(true).required(true))
        .arg(Arg::new(&quot;output&quot;).required(true))
}
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2022-07-20 22:26</div>
            <div class="timeline-body"><p>Looking at the log, it looks like we are increasing the positional counter when we shouldn&#x27;t be.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a>clap-rs/clap#3960</a> on 2022-07-20 22:47</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/epage">@epage</a> on 2022-07-21 01:12</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/pleshevskiy">@pleshevskiy</a> on 2022-07-21 04:44</div>
            <div class="timeline-body"><p>Thanks for solving the problem so quickly!</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:59:11 UTC
    </footer>
</body>
</html>
