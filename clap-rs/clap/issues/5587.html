<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Intentionally control when a space is appended for native completions - clap-rs/clap #5587</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Intentionally control when a space is appended for native completions</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/clap-rs/clap/issues/5587">#5587</a>
        opened by <a href="https://github.com/epage">@epage</a>
        on 2024-07-19 14:25
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/epage">@epage</a> on 2024-07-19 14:25</div>
            <div class="timeline-body"><p>A trailing space signifies that there is nothing else to complete for this argument and the next argument should be started.</p>
<p>Cases where a space is appropriate</p>
<ul>
<li>long flags</li>
<li>values</li>
</ul>
<p>Cases where a space is not appropriate</p>
<ul>
<li>options that allow <code>=</code></li>
<li>short flags</li>
<li>delimiter-separated values</li>
</ul>
<p>Open questions</p>
<ul>
<li>When there is only one option left for a completion and there is &quot;something more&quot;, like <code>--opt</code> completing for <code>--option=value</code>, instead of completing to <code>--option</code> should we offer every <code>--option=value</code> possible?</li>
<li>Can we do that for <code>--option value</code> as well?</li>
<li>Should we prefer <code>--option=value</code> or <code>--option value</code>? (<code>requires_equals</code> and <code>num_args</code> being more than 1 are times when there isn't a choice)</li>
<li>When the &quot;something more&quot; is optional (using <code>num_args</code>), should we offer with space and without?</li>
</ul>
<p>Note: we might be able to defer some of these open questions as &quot;parity with stable, static <code>clap_complete</code>&quot; is the minimum bar</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">C-bug</span> added by @epage on 2024-07-19 14:25</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">A-completion</span> added by @epage on 2024-07-19 14:25</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">S-waiting-on-design</span> added by @epage on 2024-07-19 14:25</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/3166.html">clap-rs/clap#3166</a> on 2024-07-19 14:25</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/shannmu">@shannmu</a> on 2024-07-22 18:02</div>
            <div class="timeline-body"><h2>A trailing space design</h2>
<h3>What do we support now</h3>
<ul>
<li>subcommand<ul>
<li>itself</li>
<li>aliases</li>
</ul>
</li>
<li>positional argument</li>
<li>optional flags<ul>
<li>long flags</li>
<li>short flags</li>
</ul>
</li>
<li>values<ul>
<li>value hint, e.g. filepath</li>
<li>custom possible values</li>
</ul>
</li>
</ul>
<h3>Cases where we should append the trailing space</h3>
<ul>
<li>subcommand<ul>
<li>itself</li>
<li>long alias(blocked on: https://github.com/clap-rs/clap/issues/5284)</li>
</ul>
</li>
<li>positional argument</li>
<li>long flags without <code>Set</code> or <code>Append</code> action</li>
<li>long flags with <code>Set</code> or <code>Append</code> action &amp; without <code>requires_equals</code><ul>
<li>I think that if the long flags does not need the <code>=</code>, we could append the trailing space for the completion to show users that this long flags is complete.</li>
</ul>
</li>
</ul>
<h3>Cases where we should not append the trailing space</h3>
<ul>
<li>subcommand<ul>
<li>short alias(blocked on: https://github.com/clap-rs/clap/issues/5284)</li>
</ul>
</li>
<li>short flags</li>
<li>long flags with <code>Set</code> or <code>Append</code> action &amp; with <code>requires_equals</code>(blocked on: https://github.com/clap-rs/clap/issues/3923)<ul>
<li>btw, i think that we could complete the long flags with format <code>format!(&quot;--{}=&quot;, long_flag)</code> rather than <code>format!(&quot;--{}&quot;, long_flag)</code> to show the users that this long flag needs <code>=</code> and value.</li>
</ul>
</li>
</ul>
<h3>Cases that depend on the context</h3>
<h4>values</h4>
<blockquote>
<p>[!NOTE]
<strong>What is the context when completing the values of flag</strong>
At the code level, it refers to the various settings of <code>Arg</code>.</p>
<ul>
<li><code>num_args</code></li>
<li><code>value_delimiter</code></li>
<li><code>trailing_var_arg</code> refers to <code>num_args</code></li>
</ul>
<p>At the meaning of value level</p>
<ul>
<li>filepath</li>
<li>custom possible values</li>
</ul>
</blockquote>
<ul>
<li>not append the trailing space<ul>
<li>number of values are not matched the number of <code>num_arg</code>(blocked on: https://github.com/clap-rs/clap/issues/3921)<ul>
<li>In this way, users can better control whether to complete the next value.</li>
<li>Also when the number of values matches the <code>num_args</code>, we could append a trailing space to show user that the multi-values of flag are completed.</li>
</ul>
</li>
<li>number of values matches the number of <code>num_arg</code> &amp; value is a value hint(Blocked on: https://github.com/clap-rs/clap/issues/3921)<ul>
<li>We cannot be sure whether the user wants to use this filepath or create a new file based on this filepath. Other types of value hint are the same as filepath hint, because we cannot be sure whether the hint is complete.</li>
</ul>
</li>
<li>delimiter-separated values(blocked on: https://github.com/clap-rs/clap/issues/3922)<ul>
<li>It's abvious that we can't known the end of the delimiter-separated values.
<strong>NOTE: It seems that delimiter-separated values must be one raw_arg in command line. It means if the delimiter is space, we should pass the delimiter-separated values with the format <code>&quot;va1 val2 val3&quot;</code> rather than <code>val1 val2 val3</code></strong>.</li>
</ul>
</li>
</ul>
</li>
<li>append the trailing space<ul>
<li>number of values matches the number of <code>num_arg</code> &amp; value is custom possible value((blocked on: https://github.com/clap-rs/clap/issues/3921))</li>
</ul>
</li>
</ul>
<p>BTW, when checking the completion for the values of the flag, I found that we might support <code>ignore_case</code> for possible values if the arg is set with <code>ArgSettings::IgnoreCase</code>. This will also provide a great user experience.</p>
<h3>Open questions</h3>
<blockquote>
<p>When there is only one option left for a completion and there is &quot;something more&quot;, like --opt completing for --option=value, instead of completing to --option should we offer every --option=value possible?</p>
</blockquote>
<p>I think that we should not offer every --option=value possible. For example, if the completion of value comes from <code>clap::ValueHint::FilePath</code>, it may generate too many completions, which makes user confused. It would be better to let the user enter some leading prompt characters.</p>
<blockquote>
<p>When the &quot;something more&quot; is optional (using num_args), should we offer with space and without</p>
</blockquote>
<p>I think this question was mentioned above.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/shannmu">@shannmu</a> on 2024-07-22 18:16</div>
            <div class="timeline-body"><p>Only the cases of the values is relatively complex and are blocked by other issues. The cases for others are relatively certain. We could get benefit from https://github.com/clap-rs/clap/commit/67e31af334346e35a540c49ba2fec46bda5ae880, and add <code>has_space</code> to <code>CompletionCandidate</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/shannmu">@shannmu</a> on 2024-07-22 18:20</div>
            <div class="timeline-body"><p>Looking forward to your thoughts. Your feedback is really important!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2024-07-22 18:23</div>
            <div class="timeline-body"><blockquote>
<p>number of values are not matched the number of num_arg</p>
</blockquote>
<p>This isn't a question of the number being matched as <code>num_args</code> only applies to <code>1 2 3</code> and not <code>1,2,3</code>.</p>
<p>The way <code>num_args</code> ties into this is when no arguments are possible, like <code>num_args(0..=1)</code> for <code>--color</code> allowing <code>--color</code> to be a shortcut for <code>--color=always</code>.</p>
<p>So this is a distinct case from the others.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2024-07-22 18:27</div>
            <div class="timeline-body"><blockquote>
<p>I think that we should not offer every --option=value possible. For example, if the completion of value comes from clap::ValueHint::FilePath, it may generate too many completions, which makes user confused. It would be better to let the user enter some leading prompt characters.</p>
</blockquote>
<p>This is a question of framing.</p>
<p>When we have</p>
<pre><code class="language-rust">Arg::new(&quot;option&quot;)
    .value_name(&quot;value&quot;)
    .value_hint(ValueHint::FileType)
    .requires_equals(true)
</code></pre>
<p>If the user has <code>foo --opt\t</code>, do we view completion as being only for the current token or do we view completion as for the end result?</p>
<p>@ModProg would be good to get your input on this, if possible.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2024-07-22 18:29</div>
            <div class="timeline-body"><blockquote>
<p>add has_space to CompletionCandidate.</p>
</blockquote>
<p>I think I'd prefer for this to be more descriptive, like <code>incomplete</code>.  Depending on how we want to handle &quot;maybe incomplete&quot;, an <code>Option&lt;bool&gt;</code> or an enum might be needed (where <code>Incomplete</code> is just one variant)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2024-07-22 18:33</div>
            <div class="timeline-body"><blockquote>
<p>Only the cases of the values is relatively complex and are blocked by other issues.</p>
</blockquote>
<p>As mentioned in https://github.com/clap-rs/clap/issues/5587#issuecomment-2243557807, #3921 is not a blocker for this.  #3922 is a soft-blocker.  We could close this out for what is possible now and push responsibility for that case onto #3922 but I think I'd prefer to track this as a cohesive whole so we focus on what the entire user experience around this is.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ModProg">@ModProg</a> on 2024-07-23 09:23</div>
            <div class="timeline-body"><p>One thing to check is verify which shells actually support different behavior here, e.g., fish won't honer us providing the space or not, but uses a list of characters to decide (https://github.com/fish-shell/fish-shell/issues/7832).</p>
<p>The list:
https://github.com/fish-shell/fish-shell/blob/ff72080aac0263048b2a9906c34736b40994f6c2/src/reader.rs#L5589
<code>'/', '@', ':', '.', ',', '-' or a '='</code></p>
<p>In my testing, a trailing slash in the completion was actually escaped: <code>example world\ </code></p>
<p>So e.g. for an option that is <code>numargs=0..=1</code>, at least for the fish shell we should provide at least both <code>--opt</code> and <code>--opt=</code>.</p>
<blockquote>
<p>I think that we should not offer every --option=value possible.</p>
</blockquote>
<p>We could make this depend on two factors, number of possible values and whether there are other options left.</p>
<p><code>--opt\t</code>:
<code>--optimal</code>, <code>--option</code>, <code>--option=</code></p>
<p><code>--optio\t</code>:
<code>--option</code>, <code>--option=a</code>, <code>--option=b</code>, <code>--option=c</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/shannmu">@shannmu</a> on 2024-07-23 16:05</div>
            <div class="timeline-body"><p>I haven't found a way to handle fish's trailing space yet.
As for bash, zsh, elvish, and powershell, we can close the trailing space and handle trailing space in the rust native completion logic.</p>
<ul>
<li><p>bash</p>
<pre><code>complete -o nospace
</code></pre>
<pre><code>nospace Tell readline not to append a space (the default) to words completed at the end of the line.
</code></pre>
</li>
<li><p>zsh</p>
<pre><code>compadd -S &quot;&quot; -a completions
</code></pre>
<pre><code>-P prefix
This gives a string to be inserted before each match. The string given is not considered as part of the match and any shell metacharacters in it will not be quoted when the string is inserted.

-S suffix
Like -P, but gives a string to be inserted after each match.
</code></pre>
</li>
<li><p>elvish &amp; powershell
They do not append the trailing space by default.
Simple testing on:</p>
<pre><code>~/clap&gt; elvish --version
0.17.0+Ubuntu-1
</code></pre>
<pre><code>PS C:\Users\shanmu\clap&gt; $PSVersionTable

Name                           Value
----                           -----
PSVersion                      7.4.3
PSEdition                      Core
GitCommitId                    7.4.3
OS                             Microsoft Windows 10.0.22631
Platform                       Win32NT
PSCompatibleVersions           {1.0, 2.0, 3.0, 4.0â€¦}
PSRemotingProtocolVersion      2.3
SerializationVersion           1.1.0.1
WSManStackVersion              3.0
</code></pre>
</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ModProg">@ModProg</a> on 2024-07-23 19:13</div>
            <div class="timeline-body"><p>I think if we just extend <code>CompletionCandidate</code> to have a <code>should_space()</code> or <code>get_with_space()</code> don't care about the naming, the shell specifics shouldn't be an issue.</p>
<p>Though it does mean, that for lists in something like <em>fish</em>, it could make sense to offer completions with trailing commas? Either exclusively or both, producing both should probably also be limited to when there aren't too many completions on screen.</p>
<p>Either <code>--a=1,2,|</code> -&gt; <code>1</code> <code>1,</code> <code>2</code> <code>2,</code> <code>3</code> <code>3,</code> or just <code>1,</code> <code>2,</code> <code>3,</code> (I'm not sure if we support trailing commas in the argument parsing).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2024-07-23 19:17</div>
            <div class="timeline-body"><blockquote>
<p>(I'm not sure if we support trailing commas in the argument parsing).</p>
</blockquote>
<p>Looks like we just do a basic <code>split</code>:</p>
<p>https://github.com/clap-rs/clap/blob/5efa52ad4501393d50e236d10a979313a61d4929/clap_builder/src/parser/parser.rs#L1164-L1166</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/5576.html">clap-rs/clap#5576</a> on 2024-07-24 15:26</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2024-07-25 18:07</div>
            <div class="timeline-body"><p>See https://github.com/clap-rs/clap/pull/5576#discussion_r1690019695</p>
<blockquote>
<p>Should <code>-ci[TAB]</code> complete to <code>-ci&lt;file&gt;</code> or <code>-ci </code></p>
</blockquote>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ModProg">@ModProg</a> on 2024-08-01 14:28</div>
            <div class="timeline-body"><blockquote>
<p>Looks like we just do a basic split:\n\nhttps://github.com/clap-rs/clap/blob/5efa52ad4501393d50e236d10a979313a61d4929/clap_builder/src/parser/parser.rs#L1164-L1166</p>
</blockquote>
<p>so if we go the route of using trailing <code>,</code> in fish, we'd need to make the parsing ignore a trailing comma.</p>
<p>Though this would technically be a breaking change as I'd expect <code>-ax,y,</code> to produce <code>[&quot;x&quot;, &quot;y&quot;, &quot;&quot;]</code> currently. But one would need to do <code>-ax,y,,</code> to get the same if we stripped the trailing comma.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../r0gue-io/pop-cli/pulls/332.html">r0gue-io/pop-cli#332</a> on 2024-11-06 11:05</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../eclipse-ankaios/ankaios/issues/614.html">eclipse-ankaios/ankaios#614</a> on 2025-11-06 08:01</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 01:35:37 UTC
    </footer>
</body>
</html>
