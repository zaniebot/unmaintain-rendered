<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AppSettings::DeriveDisplayOrder doesn't propagate to sub commands correctly - clap-rs/clap #706</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>AppSettings::DeriveDisplayOrder doesn&#x27;t propagate to sub commands correctly</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/clap-rs/clap/issues/706">#706</a>
        opened by <a href="https://github.com/Nemo157">@Nemo157</a>
        on 2016-10-25 20:11
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Nemo157">@Nemo157</a></div>
            <div class="timeline-body"><p>Adding <code>AppSettings::DeriveDisplayOrder</code> to the global settings of an <code>App</code> doesn&#x27;t propagate down to the apps sub commands.</p>
<p>The following example defines a subcommand with two args in reverse alphabetical order, running <code>--help</code> on the subcommand prints the arguments in alphabetical order with the <code>--help</code> and <code>--version</code> arguments also interspersed.</p>
<p>Moving the <code>.global_setting(AppSettings::DeriveDisplayOrder)</code> line down to the subcommand itself results in the correct ordering of the two arguments, so the setting itself is working but for some reason not propagating down correctly.</p>
<hr>
<p>Example code</p>
<pre><code>extern crate clap;

use clap::{App, Arg, SubCommand, AppSettings};

fn main() {
    App::new(&quot;MyApp&quot;)
        .global_setting(AppSettings::DeriveDisplayOrder)
        .subcommands(vec![
            SubCommand::with_name(&quot;test&quot;)
                .args(&amp;[
                    Arg::with_name(&quot;second&quot;)
                        .long(&quot;second&quot;)
                        .help(&quot;second should come first&quot;),
                    Arg::with_name(&quot;first&quot;)
                        .long(&quot;first&quot;)
                        .help(&quot;first should come second&quot;),
                ])
        ])
        .get_matches();
}
</code></pre>
<hr>
<p>Output (saved the above example into <code>examples/derive-display-order-bug.rs</code> and run via <code>cargo run --example derive-display-order-bug -- test --help</code>)</p>
<pre><code>derive-display-order-bug-test

USAGE:
    derive-display-order-bug test [FLAGS]

FLAGS:
        --first      first should come second
    -h, --help       Prints help information
        --second     second should come first
    -V, --version    Prints version information
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Nemo157">@Nemo157</a> on 2016-10-25 20:20</div>
            <div class="timeline-body"><p>I had a quick look through the source. Seems <code>DeriveDisplayOrder</code> is applied while adding the <code>Arg</code> to the <code>Parser</code> for the <code>SubCommand</code>, which happens before even adding the sub command to the top level app and well before the global settings are propagated down just before actually parsing the incoming arguments. It appears <code>UnifiedHelpMessage</code> would likely exhibit the same issue.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Nemo157">@Nemo157</a> on 2016-10-25 20:51</div>
            <div class="timeline-body"><p>Quick WIP commit of a working solution (at least for this example): https://github.com/Nemo157/clap-rs/tree/derive_order_at_print_time_2</p>
<p>Not sure if this will handle the interaction with <code>UnifiedHelpMessage</code> or not, I think it&#x27;s pretty close to a workable solution though.</p>
<p>EDIT: Just realised this will break explicitly using the <code>display_order</code> method on args :(</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/kbknapp">@kbknapp</a> on 2016-10-26 01:33</div>
            <div class="timeline-body"><p>Thanks for such a detailed write up!</p>
<p>I see a possibly simple way to go about fixing this. Since you&#x27;ve already taken the time to check through the code and get a potential fix if you&#x27;d like, I&#x27;ll give my suggestion and answer any questions you&#x27;ve got but let you take the crack at it?</p>
<p>Add an <code>Arg.user_disp_ord</code> (default of <code>999</code>) (and to subsequent <code>*Builder</code> structs) which gets set if the user passes in a custom display order. And then otherwise <em>always</em> set the <code>disp_ord</code> number as if <code>DeriveDisplayOrder</code> was set.</p>
<p>Then upon propagating the global settings, if <code>DeriveDisplayOrder</code> <em>was</em> set, do nothing unless <code>user_disp_ord</code> was anything other than <code>999</code> in which case set <code>disp_ord</code> to <code>user_disp_ord</code>. If it <em>wasn&#x27;t</em> set, set <code>disp_ord</code> to the <code>user_disp_ord</code> no matter what.</p>
<p>This is just off the top of my head though :stuck_out_tongue_winking_eye:</p>
<p>Also, it sounds like I need to add a test to guard against this issue in the future!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">T: bug</span> added by <a href="https://github.com/kbknapp">@kbknapp</a> on 2016-10-26 01:33</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">P2: need to have</span> added by <a href="https://github.com/kbknapp">@kbknapp</a> on 2016-10-26 01:33</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">C: args</span> added by <a href="https://github.com/kbknapp">@kbknapp</a> on 2016-10-26 01:33</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">C: help message</span> added by <a href="https://github.com/kbknapp">@kbknapp</a> on 2016-10-26 01:33</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">C: subcommands</span> added by <a href="https://github.com/kbknapp">@kbknapp</a> on 2016-10-26 01:33</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">D: easy</span> added by <a href="https://github.com/kbknapp">@kbknapp</a> on 2016-10-26 01:33</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">W: 2.x</span> added by <a href="https://github.com/kbknapp">@kbknapp</a> on 2016-10-26 01:33</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">C: settings</span> added by <a href="https://github.com/kbknapp">@kbknapp</a> on 2016-10-26 01:33</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone &quot;2.16.3&quot; by <a href="https://github.com/kbknapp">@kbknapp</a> on 2016-10-26 01:34</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/kbknapp">@kbknapp</a> on 2016-10-26 01:34</div>
            <div class="timeline-body"><p>That solution would also allow the help generation code to remain unchanged.</p>
<p>I&#x27;m also open to other solutions, which I forgot to mention.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Nemo157">@Nemo157</a> on 2016-10-26 07:16</div>
            <div class="timeline-body"><p>I can see how something like that could work, I should be able to throw something together within the next day.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Nemo157">@Nemo157</a> on 2016-10-26 16:51</div>
            <div class="timeline-body"><p>New WIP commit: https://github.com/Nemo157/clap-rs/commit/2b78c9868acb0063f951311cdea40fbdfe40c501</p>
<p>Based on your suggestion but slightly different to also handle propagating <code>UnifiedHelpMessage</code> correctly. Keeps <code>disp_ord</code> on the <code>Arg</code> purely for the users setting and copies it directly to the other option/flag builders. Adds a new <code>unified_ord</code> value to the option/flag builders to keep track of the overall order between the two lists in-case it&#x27;s needed. After propagation checks whether the display order needs to be derived then uses either the <code>unified_ord</code> or just the index in the list to update the <code>disp_ord</code> if the user hasn&#x27;t customised it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Nemo157">@Nemo157</a> on 2016-10-26 16:53</div>
            <div class="timeline-body"><p>I&#x27;ll write a couple of quick tests then make a PR for this.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/kbknapp">@kbknapp</a> on 2016-10-27 02:09</div>
            <div class="timeline-body"><p>Excellent! If it passes the prior the tests and some new one(s) for this case I&#x27;m good with it! :+1:</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/homu">@homu</a> on 2016-10-27 04:48</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:56:36 UTC
    </footer>
</body>
</html>
