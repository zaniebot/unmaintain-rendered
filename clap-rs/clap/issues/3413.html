<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Not obvious how to provide multiple usage statements with `App::override_usage()` - clap-rs/clap #3413</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Not obvious how to provide multiple usage statements with `App::override_usage()`</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/clap-rs/clap/issues/3413">#3413</a>
        opened by <a href="https://github.com/jpgrayson">@jpgrayson</a>
        on 2022-02-07 21:21
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/jpgrayson">@jpgrayson</a> on 2022-02-07 21:21</div>
            <div class="timeline-body"><h3>Please complete the following tasks</h3>
<ul>
<li>[X] I have searched the <a href="https://github.com/clap-rs/clap/discussions">discussions</a></li>
<li>[X] I have searched the <a href="https://github.com/clap-rs/clap/issues">open</a> and <a href="https://github.com/clap-rs/clap/issues?q=is%3Aissue+label%3AS-wont-fix+is%3Aclosed">rejected</a> issues</li>
</ul>
<h3>Rust Version</h3>
<p>rustc 1.58.1 (db9d1b20b 2022-01-20)</p>
<h3>Clap Version</h3>
<p>3.0.14</p>
<h3>Minimal reproducible code</h3>
<pre><code class="language-rust">fn main() {
    clap::App::new(&quot;myapp&quot;)
        .override_usage(
            &quot;myapp -X [-a] [-b] &lt;file&gt;\n\
             myapp -Y [-c] &lt;file1&gt; &lt;file2&gt;\n\
             myapp -Z [-d|-e]&quot;
        )
        .get_matches_from([&quot;myapp&quot;, &quot;-h&quot;]);
}
</code></pre>
<h3>Steps to reproduce the bug with the above code</h3>
<p>Paste as <code>examples/min-usage.rs</code>.
<code>cargo run --example=min-usage</code></p>
<h3>Actual Behaviour</h3>
<pre><code>myapp 

USAGE:
    myapp -X [-a] [-b] &lt;file&gt;
myapp -Y [-c] &lt;file1&gt; &lt;file2&gt;
myapp -Z [-d|-e]

OPTIONS:
    -h, --help    Print help information
</code></pre>
<h3>Expected Behaviour</h3>
<pre><code>myapp 

USAGE:
    myapp -X [-a] [-b] &lt;file&gt;
    myapp -Y [-c] &lt;file1&gt; &lt;file2&gt;
    myapp -Z [-d|-e]

OPTIONS:
    -h, --help    Print help information
</code></pre>
<h3>Additional Context</h3>
<p>This relates to issue #1068.</p>
<p>When providing multiple usage statements on multiple lines, the help output is mis-indented.</p>
<p>The canonical workaround is for the user to indent the lines within their usage string according to the following rules:</p>
<ul>
<li>Do not indent the first usage line.</li>
<li>Indent all subsequent usage lines with four spaces.</li>
<li>The last line <em>must not</em> end with a newline.</li>
</ul>
<p>The workaround versions of the reproducing example above:</p>
<pre><code class="language-rust">fn main() {
    clap::App::new(&quot;myapp&quot;)
        .override_usage(
            &quot;myapp -X [-a] [-b] &lt;file&gt;\n    \
             myapp -Y [-c] &lt;file1&gt; &lt;file2&gt;\n    \
             myapp -Z [-d|-e]&quot;
        )
        .get_matches_from([&quot;myapp&quot;, &quot;-h&quot;]);
}
</code></pre>
<p>or</p>
<pre><code class="language-rust">fn main() {
    clap::App::new(&quot;myapp&quot;)
        .override_usage(&quot;\
    myapp -X [-a] [-b] &lt;file&gt;
    myapp -Y [-c] &lt;file1&gt; &lt;file2&gt;
    myapp -Z [-d|-e]&quot;
        )
        .get_matches_from([&quot;myapp&quot;, &quot;-h&quot;]);
}
</code></pre>
<p>The above workaround works with the current <code>DEFAULT_TEMPLATE</code> and <code>DEFAULT_NO_ARGS_TEMPLATE</code>, but is sensitive to indentation changes in those default templates. Note that in the discussion for #2002, there is a stated goal to avoid making the details of the default templates an API contract. Requiring user-indented usage strings jeopardizes the flexibility to change the default templates to some degree.</p>
<p>N.B. the workaround for this issue changed when PR #2067 was merged. Prior to that, usage strings were tab-indented. #1068 illustrates the old-style workaround. It's perhaps worth noting that users upgrading from clap 2 --&gt; 3 may bump into this issue if they have legacy multi-line usage strings with tab indentation.</p>
<h2>Possible Solutions</h2>
<h3>Document/standardize the workaround</h3>
<p>The least intrusive way to make multiple usage statements more obvious to users would be to document the required multi-line format (i.e. the above workaround) for custom usage strings. A couple additions to <code>App::override_usage()</code>'s docstring would be sufficient for this option.</p>
<h3>Handle/comprehend non-indented multi-line usage strings</h3>
<p>This approach was implemented in PR #3404. The idea was to accept user-provided usage strings where lines may or may not be indented by the user, and then use a new template tag (<code>{usage-indented}</code>) to normalize the user-provided usage lines to fit into clap's default help templates.</p>
<p>The benefits of this approach are that multi-line usage strings will Just Work(tm) both for simple newline separated usage statements as well as usage strings containing either the modern or legacy (see #1068) workarounds.</p>
<p>The key downside of this approach is the API change of adding the <code>{usage-indented}</code> template tag.</p>
<h3>Debug Output</h3>
<p><em>No response</em></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">C-bug</span> added by @jpgrayson on 2022-02-07 21:21</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2022-02-16 19:22</div>
            <div class="timeline-body"><p>This sounds contradictory to the purported change that closed #1068.  I marked #1068 as closed based on a comment in the CHANGELOG</p>
<blockquote>
<p><code>App::override_usage</code> no longer implies a leading <code>\t</code>, allowing multi lined usages</p>
</blockquote>
<p>This was copied over from before the changelog rewrite and was introduced in commit 8bd1f1a9d.  This was released in v3.0.0-beta.1 on 2020-05-03.  Looking back in the history, starting around that time, I am not finding any change to the usage code that sounds like this.</p>
<p>Looking back through <code>src/output/help.rs</code>s history, for the entire time we used a template for default help (a87320ae8), we seem to always have the fixed number of leading spaces.  We seem to have been inserting spaces between the header and the usage statement for quite a while.</p>
<p>Going to do some more digging into this.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/jpgrayson">@jpgrayson</a> on 2022-02-16 20:52</div>
            <div class="timeline-body"><p>FWIW, I also had a hard time reconciling the CHANGELOG message that prompted #1068 to be closed with any specific commit(s) that addressed #1068. AFAICT, the only difference between clap 2 and clap 3 for this issue is whether tab or space is used to indent the usage. It has always been one or the other hardwired indentation in either the procedural or templated help generation; and that change from tab to space indentation came with the template feature in a87320a (PR #2067).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone "4.0" by @epage on 2022-06-08 16:02</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Removed from milestone "4.0" by @epage on 2022-08-23 14:38</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone "5.0" by @epage on 2022-08-23 14:38</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2022-08-23 14:38</div>
            <div class="timeline-body"><p>I feel like we are hitting a cap in the number of subtle breaking changes for 4.0 and feel this should be pushed back to 5.0.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/4106.html">clap-rs/clap#4106</a> on 2022-08-23 15:26</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/jpgrayson">@jpgrayson</a> on 2022-08-23 15:29</div>
            <div class="timeline-body"><p>PR #4106 adds documentation for how to add multiple override usage lines. Regardless of whether we may want to do something more substantial with usage overrides in clap 5, this documentation will be helpful for anyone that wants multiple usage lines in clap 3 or 4.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/4191.html">clap-rs/clap#4191</a> on 2022-09-07 19:11</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">M-breaking-change</span> added by @epage on 2022-09-28 16:20</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">A-help</span> added by @epage on 2022-09-28 16:20</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">S-waiting-on-design</span> added by @epage on 2022-11-08 04:31</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 01:34:54 UTC
    </footer>
</body>
</html>
