<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AppSettings::AllowExternalSubcommands [sometimes] triggers suggestions - clap-rs/clap #1169</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>AppSettings::AllowExternalSubcommands [sometimes] triggers suggestions</h1>

    <div class="meta">
        <span class="state state-closed">Closed</span>
        <a href="https://github.com/clap-rs/clap/issues/1169">#1169</a>
        opened by <a href="https://github.com/yrashk">@yrashk</a>
        on 2018-02-08 05:05
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/yrashk">@yrashk</a> on 2018-02-08 05:05</div>
            <div class="timeline-body"><h3>Rust Version</h3>
<p>rustc 1.23.0 (766bd11c8 2018-01-01)</p>
<h3>Affected Version of clap</h3>
<p>2.29.4</p>
<h3>Expected Behavior Summary</h3>
<p>The program executions to print:</p>
<pre><code># 1
subcommand: z
# 2
subcommand: te
</code></pre>
<h3>Actual Behavior Summary</h3>
<pre><code># 1
subcommand: z
# 2
error: The subcommand 'te' wasn't recognized
	Did you mean 'test'?

If you believe you received this message in error, try re-running with 'example -- te'

USAGE:
    example [SUBCOMMAND]

For more information try --help
</code></pre>
<h3>Steps to Reproduce the issue</h3>
<p>src/main.rs:</p>
<pre><code class="language-rust">extern crate clap;

use clap::{App, AppSettings, SubCommand};

fn main() {
    let matches = App::new(&quot;My Super Program&quot;)
        .setting(AppSettings::AllowExternalSubcommands)
        .subcommand(SubCommand::with_name(&quot;test&quot;).about(&quot;controls testing features&quot;))
        .get_matches();

    if let Some(_) = matches.subcommand_matches(&quot;test&quot;) {
        println!(&quot;pre-defined subcommand: test&quot;);
    } else {
        let (command, _) = matches.subcommand();
        println!(&quot;subcommand: {}&quot;, command);
    }

}
</code></pre>
<p>Run with</p>
<pre><code># 1
cargo run -- z
# 2
cargo run -- te
</code></pre>
<h3>Debug output</h3>
<pre><code>$ cargo run -- te
   Compiling clap v2.29.4
   Compiling example v0.1.0 (file:///Users/yrashk/tmp/example)
    Finished dev [unoptimized + debuginfo] target(s) in 8.11 secs
     Running `target/debug/example te`
DEBUG:clap:Parser::add_subcommand: term_w=None, name=test
DEBUG:clap:Parser::propagate_settings: self=My Super Program, g_settings=AppFlags(
    (empty)
)
DEBUG:clap:Parser::propagate_settings: sc=test, settings=AppFlags(
    NEEDS_LONG_HELP | NEEDS_LONG_VERSION | NEEDS_SC_HELP | UTF8_NONE | COLOR_AUTO
), g_settings=AppFlags(
    (empty)
)
DEBUG:clap:Parser::propagate_settings: self=test, g_settings=AppFlags(
    (empty)
)
DEBUG:clap:Parser::get_matches_with;
DEBUG:clap:Parser::create_help_and_version;
DEBUG:clap:Parser::create_help_and_version: Building --help
DEBUG:clap:Parser::create_help_and_version: Building --version
DEBUG:clap:Parser::create_help_and_version: Building help
DEBUG:clap:Parser::get_matches_with: Begin parsing '&quot;te&quot;' ([116, 101])
DEBUG:clap:Parser::is_new_arg:&quot;te&quot;:NotFound
DEBUG:clap:Parser::is_new_arg: arg_allows_tac=false
DEBUG:clap:Parser::is_new_arg: probably value
DEBUG:clap:Parser::is_new_arg: starts_new_arg=false
DEBUG:clap:Parser::possible_subcommand: arg=&quot;te&quot;
DEBUG:clap:Parser::get_matches_with: possible_sc=false, sc=None
DEBUG:clap:usage::create_usage_with_title;
DEBUG:clap:usage::create_usage_no_title;
DEBUG:clap:usage::get_required_usage_from: reqs=[], extra=None
DEBUG:clap:usage::get_required_usage_from: after init desc_reqs=[]
DEBUG:clap:usage::get_required_usage_from: no more children
DEBUG:clap:usage::get_required_usage_from: final desc_reqs=[]
DEBUG:clap:usage::get_required_usage_from: args_in_groups=[]
DEBUG:clap:usage::needs_flags_tag;
DEBUG:clap:usage::needs_flags_tag:iter: f=hclap_help;
DEBUG:clap:usage::needs_flags_tag:iter: f=vclap_version;
DEBUG:clap:usage::needs_flags_tag: [FLAGS] not required
DEBUG:clap:usage::create_help_usage: usage=example [SUBCOMMAND]
DEBUG:clap:Parser::color;
DEBUG:clap:Parser::color: Color setting...Auto
DEBUG:clap:is_a_tty: stderr=true
DEBUG:clap:Colorizer::error;
DEBUG:clap:Colorizer::warning;
DEBUG:clap:Colorizer::good;
DEBUG:clap:Colorizer::good;
DEBUG:clap:Colorizer::good;
error: The subcommand 'te' wasn't recognized
	Did you mean 'test'?

If you believe you received this message in error, try re-running with 'example -- te'

USAGE:
    example [SUBCOMMAND]

For more information try --help
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/kbknapp">@kbknapp</a> on 2018-02-10 03:54</div>
            <div class="timeline-body"><p>Currently the fix is to not compile the <code>suggestions</code> feature.</p>
<pre><code class="language-toml">[dependencies.clap]
version = &quot;2&quot;
default-features = false
features = [&quot;color&quot;, &quot;wrap_help&quot;] # assuming one would still want the other defaults
</code></pre>
<p>This is a hard one to solve generally for the masses because clap has to match incoming arguments to <em>something</em> and if they happen to be close enough to trigger a &quot;possible subcommand&quot; there's no way for clap to know if this is what this particular use case wanted or not.</p>
<p>A future fix would be to add a <code>AppSettings::DontUseSuggestions</code> which would only apply to the current (sub)command. Possibly also narrowed down at a later date with the ability to only not suggest on flags/options or subcommands. I'll mark this as a todo, or good first issue for someone.</p>
<p>I can look at adding it in v3 if no one has knocked it out by then.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">C: parsing</span> added by @kbknapp on 2018-02-10 03:55</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">C: errors</span> added by @kbknapp on 2018-02-10 03:55</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">T: enhancement</span> added by @kbknapp on 2018-02-10 03:55</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">P4: nice to have</span> added by @kbknapp on 2018-02-10 03:55</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">D: easy</span> added by @kbknapp on 2018-02-10 03:55</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">M: mentored</span> added by @kbknapp on 2018-02-10 03:55</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">T: new setting</span> added by @kbknapp on 2018-02-10 03:55</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">good first issue</span> added by @kbknapp on 2018-02-10 03:55</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/yrashk">@yrashk</a> on 2018-02-10 15:58</div>
            <div class="timeline-body"><p>Kevin,</p>
<p>Thank you so much for the detailed explanation.</p>
<p>I suspect this might be a good solution for my use case where I'm trying
(in the absence of a matching subcommand) to see if I can execute
myprog-given-subcommand. What I was trying to accomplish was along the
lines of &quot;try to match these subcommands without suggestions first, if it
fails, try finding the external binary; if there is none, enable
suggestions and run matching again&quot;. But obviously this doesn't work well
when suggestions are enabled or disabled compile time.</p>
<p>I'll try to see if I can prepare a patch for this.</p>
<p>On Feb 10, 2018 10:54 AM, &quot;Kevin K.&quot; <a href="mailto:notifications@github.com">notifications@github.com</a> wrote:</p>
<p>Currently the fix is to not compile the suggestions feature.</p>
<p>[dependencies.clap]version = &quot;2&quot;default-features = falsefeatures =
[&quot;color&quot;, &quot;wrap_help&quot;] # assuming one would still want the other
defaults</p>
<p>This is a hard one to solve generally for the masses because clap has to
match incoming arguments to <em>something</em> and if they happen to be close
enough to trigger a &quot;possible subcommand&quot; there's no way for clap to know
if this is what this particular use case wanted or not.</p>
<p>A future fix would be to add a AppSettings::DontUseSuggestions which would
only apply to the current (sub)command. Possibly also narrowed down at a
later date with the ability to only not suggest on flags/options or
subcommands. I'll mark this as a todo, or good first issue for someone.</p>
<p>I can look at adding it in v3 if no one has knocked it out by then.</p>
<p>â€”
You are receiving this because you authored the thread.
Reply to this email directly, view it on GitHub
<a href="https://github.com/kbknapp/clap-rs/issues/1169#issuecomment-364623723">https://github.com/kbknapp/clap-rs/issues/1169#issuecomment-364623723</a>,
or mute
the thread
<a href="https://github.com/notifications/unsubscribe-auth/AAABxMeWT1w2HZukDQ_xd1TU2mefKEl0ks5tTRLqgaJpZM4R9zl2">https://github.com/notifications/unsubscribe-auth/AAABxMeWT1w2HZukDQ_xd1TU2mefKEl0ks5tTRLqgaJpZM4R9zl2</a>
.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/kbknapp">@kbknapp</a> on 2018-02-10 19:02</div>
            <div class="timeline-body"><p>Awesome! If you'd like to try this issue, I'd suggest adding a new setting (by following the examples of all other settings) in <a href="https://github.com/kbknapp/clap-rs/blob/4005d93df952510c2dec98e48eb8eefd2b6502e4/src/app/settings.rs#L49"><code>src/app/settings.rs</code></a>, then to actually <em>use</em> this setting, you'd probably check if this setting was used in <a href="https://github.com/kbknapp/clap-rs/blob/4005d93df952510c2dec98e48eb8eefd2b6502e4/src/app/parser.rs#L657"><code>src/app/parser.rs</code></a> at the start of <code>possible_subcommand</code> and just return <code>(false, None)</code> if that setting was used.</p>
<p>I'd also add some tests to <a href="https://github.com/kbknapp/clap-rs/blob/master/tests/app_settings.rs"><code>tests/app_settings.rs</code></a> to ensure it's all working correctly.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/yrashk">@yrashk</a> on 2018-04-05 14:22</div>
            <div class="timeline-body"><p>It looks like 2.31.2 solves this issue (#1215), at least to some degree. I was just able to use it the way I intended to:</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @yrashk on 2018-04-05 14:22</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:35:07 UTC
    </footer>
</body>
</html>
