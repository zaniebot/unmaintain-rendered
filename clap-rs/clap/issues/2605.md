```yaml
number: 2605
title: "Nested `updates` implemented have bugs around subcommands"
type: issue
state: closed
author: epage
labels:
  - A-derive
assignees: []
created_at: 2021-07-19T16:06:43Z
updated_at: 2021-07-27T19:19:41Z
url: https://github.com/clap-rs/clap/issues/2605
synced_at: 2026-01-10T01:57:45Z
```

# Nested `updates` implemented have bugs around subcommands

---

_Issue opened by @epage on 2021-07-19 16:06_

### Discussed in https://github.com/clap-rs/clap/discussions/2591

<div type='discussions-op-text'>

<sup>Originally posted by **epage** July 14, 2021</sup>
This was implemented in #1878 for #1837 based on #1836.

I've not dig into all of #1878's comments but at one point the thought was:
> We don't know which fields the flattened struct consists of, so we delegate to the flattened type itself - it must know how to update itself. 

This isn't always the case.  From inspection
- `SubCmd{ field: i32 }` generates an augment update
- `SubCmd(Args)` is hard coded to call augment
- `#[flatten] Subcommand(MoreCmds)` is hard coded to call augment
- `#[subcmmand] field: SubCmd` calls augment update
- `#[flatten] field: MoreArgs` is hard coded to call augment

Example generated code from `clap_derive/tests/flatten.rs` where there is a mismatch in augment vs from
```rust
        fn augment_clap_for_update<'b>(app: clap::App<'b>) -> clap::App<'b> {
            {
                let app = app;
                let app = <Common as clap::IntoApp>::augment_clap(app);
                app
            }
        }
...
        fn update_from_arg_matches(&mut self, arg_matches: &clap::ArgMatches) {
            {
                #[allow(non_snake_case)]
                let common = &mut self.common;
                clap::FromArgMatches::update_from_arg_matches(common, arg_matches);
            }
        }
```</div>

---

_Referenced in [clap-rs/clap#2606](../../clap-rs/clap/pulls/2606.md) on 2021-07-19 16:18_

---

_Added to milestone `3.0` by @pksunkara on 2021-07-25 13:30_

---

_Label `C: derive macros` added by @pksunkara on 2021-07-25 13:30_

---

_Referenced in [clap-rs/clap#2625](../../clap-rs/clap/pulls/2625.md) on 2021-07-26 15:03_

---

_Closed by @epage on 2021-07-27 19:19_

---

_Referenced in [clap-rs/clap#4974](../../clap-rs/clap/issues/4974.md) on 2023-06-19 17:18_

---
