```yaml
number: 5190
title: Bash completion emits error about invalid nosort option
type: issue
state: closed
author: gbelouze
labels:
  - C-bug
  - A-completion
assignees: []
created_at: 2023-10-30T21:13:21Z
updated_at: 2024-01-02T20:59:12Z
url: https://github.com/clap-rs/clap/issues/5190
synced_at: 2026-01-10T01:57:49Z
```

# Bash completion emits error about invalid nosort option

---

_Issue opened by @gbelouze on 2023-10-30 21:13_

### Please complete the following tasks

- [X] I have searched the [discussions](https://github.com/clap-rs/clap/discussions)
- [X] I have searched the [open](https://github.com/clap-rs/clap/issues) and [rejected](https://github.com/clap-rs/clap/issues?q=is%3Aissue+label%3AS-wont-fix+is%3Aclosed) issues

### Rust Version

rustc 1.73.0 (cc66ad468 2023-10-03)

### Clap Version

`ruff` package version `0.0.292`which specifies `clap = { version = "4.4.7", features = ["derive"] }`

### Minimal reproducible code

not relevant

### Steps to reproduce the bug with the above code

`brew install ruff`
and somewhere in your `.bash_profile` or `.bashrc`
```bash
if [ -f $(brew --prefix)/etc/bash_completion ]; then
    . $(brew --prefix)/etc/bash_completion
fi
```

### Actual Behaviour

When I open a new shell, the following error message is displayed
```bash
bash: complete: nosort: invalid option name
```

### Expected Behaviour

No error message should be displayed.

### Additional Context

Hello beautiful `clap` people. I come from [this issue](https://github.com/astral-sh/ruff/issues/8361) with the `ruff` package (plugin ? crate ? I'm not a rust person). I'll say here again the issue I described there : 
- am macOS user
- use `ruff` (which relies on `clap`) installed through `homebrew`
- use `bash_completions` for the installed homebrew packages (see *Steps to reproduce* above)
- this triggers the issue
Presumably, the issue is that the `nosort` option is supported starting from bash v4 only, while macOS still uses bash v3. See [this comment by @zanieb](https://github.com/astral-sh/ruff/issues/8361#issuecomment-1785981659) which locates where this happens in `clap`.

I'm not sure if this is a bug or if `clap` is not trying to support old bash versions. Again I'm not a `clap` nor even a rust user.

### Debug Output

_No response_

---

_Label `C-bug` added by @gbelouze on 2023-10-30 21:13_

---

_Label `A-completion` added by @epage on 2023-10-30 21:43_

---

_Comment by @epage on 2023-10-30 21:45_

Completions are mostly community maintained on a best-effort.  If there is a reasonable way to skip `nosort` for bash v3 but to keep it for v4+, I'm willing to accept for it.

---

_Comment by @gbelouze on 2023-10-31 08:40_

Thanks for the quick response. The bash version is accessible with the `${BASH_VERSINFO[0]}` variable. I'd wait for the input of someone who knows bash more than I do but I suppose something like
```diff
- complete -F _{name} -o nosort -o bashdefault -o default {name}
+ if [ ${BASH_VERSINFO[0]} -ge 4 ]; then
+     complete -F _{name} -o nosort -o bashdefault -o default {name}
+ else
+     complete -F _{name} -o bashdefault -o default {name}
+ fi
```
would be good enough.

---

_Referenced in [kanidm/kanidm#2280](../../kanidm/kanidm/issues/2280.md) on 2023-11-01 09:03_

---

_Referenced in [sharkdp/fd#1407](../../sharkdp/fd/issues/1407.md) on 2023-11-29 18:57_

---

_Comment by @tavianator on 2023-11-29 20:27_

It was added in bash 4.4, checking >= 4 isn't enough

---

_Comment by @epage on 2023-11-29 22:58_

Whats the likelihood someone is using <4.4 who isn't on Mac and using v3?

---

_Comment by @tavianator on 2023-11-29 23:47_

@epage I think CentOS 7 uses Bash 4.2, which is one of the platforms that led to https://github.com/sharkdp/fd/issues/1407.

A fully correct check is not too hard, something like

```sh
major=${BASH_VERSINFO[0]}
minor=${BASH_VERSINFO[1]}
if ((major > 4 || (major == 4 && minor >= 4))); then
    complete -F _{name} -o nosort -o bashdefault -o default {name}
else
    complete -F _{name} -o bashdefault -o default {name}
fi
```

---

_Referenced in [clap-rs/clap#5240](../../clap-rs/clap/pulls/5240.md) on 2023-12-04 18:09_

---

_Referenced in [Homebrew/homebrew-core#156448](../../Homebrew/homebrew-core/pulls/156448.md) on 2023-12-05 16:49_

---

_Comment by @mathomp4 on 2023-12-20 14:49_

> Whats the likelihood someone is using <4.4 who isn't on Mac and using v3?

FYI, I just hit this on a supercomputing cluster (via fd) which is rocking SLES12 and:
```
$ bash --version
GNU bash, version 4.3.48(1)-release (x86_64-suse-linux-gnu)
Copyright (C) 2013 Free Software Foundation, Inc.
License GPLv3+: GNU GPL version 3 or later <http://gnu.org/licenses/gpl.html>
```
So, yeah, old OSs and old bashes live out there. Though I'm apparently right at the edge :)

(NOTE: Soon we will move to SLES15 and be closer to modern day.)

---

_Comment by @epage on 2023-12-20 14:53_

Ouch :)  Enjoy the upgrade!

---

_Comment by @epage on 2023-12-20 14:54_

(btw to be clear, a PR fixing this from anyone would be welcome)

---

_Referenced in [clap-rs/clap#5278](../../clap-rs/clap/pulls/5278.md) on 2024-01-02 12:56_

---

_Closed by @epage on 2024-01-02 20:59_

---

_Referenced in [clap-rs/clap#5430](../../clap-rs/clap/issues/5430.md) on 2024-03-26 16:18_

---
