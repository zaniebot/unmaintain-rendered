<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>`clap_lex::OsStrExt` is unsound - clap-rs/clap #4800</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1><code>clap_lex::OsStrExt</code> is unsound</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/clap-rs/clap/issues/4800">#4800</a>
        opened by <a href="https://github.com/blyxxyz">@blyxxyz</a>
        on 2023-03-28 08:41
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/blyxxyz">@blyxxyz</a></div>
            <div class="timeline-body"><pre><code>use std::ffi::OsStr;

use clap_lex::OsStrExt;

fn main() {
    let s = OsStr::new(&quot;ðŸ¦€&quot;);
    dbg!(s.split_at(1));
}
</code></pre>
<p>On Windows:</p>
<pre><code>$ cargo run -q --target x86_64-pc-windows-gnu
[src/main.rs:7] s.split_at(1) = (
    &quot;ðŸ¦€[:]  = \n\0\0\0\0T\u{1a},thread &#x27;main&#x27; panicked at &#x27;index out of bounds: the len is 33 but the index is 33&#x27;, library\core\src\unicode\unicode_data.rs:80:40
</code></pre>
<p>While Unix <code>OsStr</code> can contain any byte sequence, a Windows <code>OsStr</code> has to be WTF-8, which is UTF-8-ish and has to be decoded. If the data is split in the wrong place the decoder gets confused.</p>
<p><a href="https://github.com/clap-rs/clap/blob/e36ae19d4a1464df91f866db5f2cb9580bb99910/clap_lex/src/ext.rs#L281">This use of transmute</a> also isn&#x27;t 100% sound, since <code>OsStr</code> isn&#x27;t <code>#[repr(transparent)]</code> all the way down, and <code>OsStr</code> representation just hasn&#x27;t been guaranteed in general. It works on past and current Rust versions so maybe it&#x27;ll turn out OK in the end, but it wouldn&#x27;t be unreasonable to e.g. add a &quot;known valid&quot; boolean field to Windows <code>OsStr</code> and break it. It makes me nervous.</p>
<p>So personally I&#x27;d revert #4794, or reimplement it using the existing safe APIs.</p>
<p>I don&#x27;t think <code>clap</code> itself is currently broken due to this, though.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a>clap-rs/clap#4802</a> on 2023-03-28 14:29</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2023-03-28 14:43</div>
            <div class="timeline-body"><p>Thanks</p>
<ul>
<li>I had missed that <code>OsStr</code> was not <code>transparent</code> all the way down.  However, it effectively is and I suspect they will maintain that due to being a dynamically sized type</li>
<li>Yes, I had forgotten there are invariants for <code>OsStr</code> and am documenting them and deprecating <code>OsStrExt:;split_at</code></li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/epage">@epage</a> on 2023-03-28 15:00</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:59:42 UTC
    </footer>
</body>
</html>
