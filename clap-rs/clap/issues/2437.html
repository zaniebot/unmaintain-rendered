<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>`#[clap(parse(try_from_str))]` doesn't use `try_from(&amp;str)` - clap-rs/clap #2437</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1><code>#[clap(parse(try_from_str))]</code> doesn&#x27;t use <code>try_from(&amp;str)</code></h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/clap-rs/clap/issues/2437">#2437</a>
        opened by <a href="https://github.com/TilCreator">@TilCreator</a>
        on 2021-04-09 11:02
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/TilCreator">@TilCreator</a></div>
            <div class="timeline-body">Please complete the following tasks
<p>I have searched the <a href="https://github.com/clap-rs/clap/discussions">discussions</a>
I have searched the existing issues</p>
Rust Version
<p>rustc 1.50.0 (cb75ad5db 2021-02-10)</p>
Clap Version
<p>3.0.0-beta.2</p>
Minimal reproducible code
<pre><code>use reqwest::Url;
use scraper::Selector;

/*
Available functions:
reqwest::Url::try_from(s: &amp;&#x27;a str) -&gt; Result&lt;Self, Self::Error&gt;
reqwest::Url::from_str(input: &amp;str) -&gt; Result&lt;Url, crate::ParseError&gt;
scraper::Selector::try_from(s: &amp;&#x27;i str) -&gt; Result&lt;Self, Self::Error&gt;
*/

#[derive(Clap, Debug)]
#[clap(name = env!(&quot;CARGO_PKG_NAME&quot;))]
struct Args {
    // There is no problem with parsing url. it&#x27;s just a working example
    #[clap(
        takes_value = true,
        parse(try_from_str)
    )]
    url: Url,
    #[clap(
        takes_value = true,
        parse(try_from_str),
    )]
    selector: Selector,
}

fn main() {
    let args = Args::parse().unwrap();
}
</code></pre>
Steps to reproduce the bug with the above code
<p><code>cargo run -- https://exameple.com body</code></p>
Actual Behaviour
<p>It does not compile because <code>#[clap(parse(try_from_str))]</code> doesn&#x27;t find <code>Selector::try_from(&amp;str)</code>.</p>
Expected Behaviour
<p>It compiles and finds the <code>try_from(&amp;str)</code> of <code>Selector</code>.</p>
Additional Context
<p>From the name <code>try_from_str</code> I would expect Clap to use <code>try_from(&amp;str) -&gt; Result&lt;_&gt;</code> rather than (/both) <code>from(&amp;str) -&gt; Result&lt;_&gt;</code>.
#1661</p>
Debug Output
<pre><code>[dependencies]
reqwest = &quot;0.11.2&quot;
scraper = &quot;0.12.0&quot;
clap = &quot;3.0.0-beta.2&quot;
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">T: bug</span> added by <a href="https://github.com/TilCreator">@TilCreator</a> on 2021-04-09 11:02</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from &quot;`#[clap(parse(try_from_str)]` doesn&#x27;t use `try_from(&amp;str)`&quot; to &quot;`#[clap(parse(try_from_str))]` doesn&#x27;t use `try_from(&amp;str)`&quot; by <a href="https://github.com/TilCreator">@TilCreator</a> on 2021-04-09 11:04</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone &quot;3.0&quot; by <a href="https://github.com/pksunkara">@pksunkara</a> on 2021-04-09 18:19</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a>clap-rs/clap#2683</a> on 2021-08-13 01:05</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">C: derive macros</span> added by <a href="https://github.com/pksunkara">@pksunkara</a> on 2021-10-16 18:57</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2021-10-16 19:42</div>
            <div class="timeline-body"><p>It looks like this also exists in <a href="https://docs.rs/structopt/0.3.23/structopt/#custom-string-parsers">structopt</a>.</p>
<p>The challenge is naming.  For our <code>From&lt;T&gt;</code> versions, we need to differentiate <code>T</code>, which leads to <code>from_str</code> for <code>From&lt;&amp;str&gt;</code> and <code>from_os_str</code> for <code>From&lt;&amp;OsStr&gt;</code>.  That then conflicts with using <code>from_str</code> for <code>FromStr</code>.</p>
<p>Granted, if we did auto-detection like #2298, this problem goes away except when the user wants to override for a specific case.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2021-10-16 19:47</div>
            <div class="timeline-body"><p>Forgot to add, from observation, it looks like the naming scheme has less to do with what trait is the default but describes what the function signature is when providing a version of it.</p>
<p>From that perspective, I&#x27;d be tempted to Close this as Won&#x27;t Fix.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2021-10-16 19:49</div>
            <div class="timeline-body"><p>I&#x27;ve not confirmed it but I believe the user workaround would be <code>parse(try_from_str = Url::try_from)</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Removed from milestone &quot;3.0&quot; by <a href="https://github.com/epage">@epage</a> on 2021-10-16 19:54</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/TilCreator">@TilCreator</a> on 2021-10-16 20:29</div>
            <div class="timeline-body"><p>The workaround works for most cases, but some use weird types where a wrapper is still necessary. Here are examples for both:
My original example with the workaround:</p>
<pre><code>use clap::Clap;
use reqwest::Url;
use scraper::Selector;
use std::convert::TryFrom;

/*
Available functions:
reqwest::Url::try_from(s: &amp;&#x27;a str) -&gt; Result&lt;Self, Self::Error&gt;
reqwest::Url::from_str(input: &amp;str) -&gt; Result&lt;Url, crate::ParseError&gt;
scraper::Selector::try_from(s: &amp;&#x27;i str) -&gt; Result&lt;Self, Self::Error&gt;
*/

#[derive(Clap, Debug)]
#[clap(name = env!(&quot;CARGO_PKG_NAME&quot;))]
struct Args {
    // There is no problem with parsing url. it&#x27;s just a working example (also from `try_from`)
    #[clap(
        takes_value = true,
        parse(try_from_str = Url::try_from),
    )]
    url: Url,
    #[clap( // Fails with many compile errors
        takes_value = true,
        parse(try_from_str = Selector::try_from),
    )]
    selector: Selector,
}

fn main() {
    let args = Args::parse();

    println!(&quot;{:#?}&quot;, args);
}


</code></pre>
<p>That sadly doesn&#x27;t fix it completely, because the <code>Selector</code> type doesn&#x27;t play nice.
For such cases a wrapper case can be used, here an example from one of my projects for that:
<a href="https://gitlab.com/TilCreator/rustycomicscraper/-/blob/fa7b3f0de6f96229a88d56232df483035bb25678/src/main.rs#L454-470">Wrapper definition</a>
<a href="https://gitlab.com/TilCreator/rustycomicscraper/-/blob/fa7b3f0de6f96229a88d56232df483035bb25678/src/main.rs#L377-390">Wrapper usage</a></p>
<p>If you don&#x27;t have to add anything this can be closed, thx</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/pksunkara">@pksunkara</a> on 2021-10-16 20:38</div>
            <div class="timeline-body"><p>Let&#x27;s keep this open since I have the impression of tackling this as part of #2683.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2021-10-16 20:39</div>
            <div class="timeline-body"><pre><code>    url: Url,
    #[clap( // Fails with many compile errors
        takes_value = true,
        parse(try_from_str = Selector::try_from),
    )]
    selector: Selector,*/
</code></pre>
<p>The errors have less to do with <code>TryFrom</code> vs <code>FromStr</code> and more to do with the fact that <code>scraper</code>s error type does not <code>impl Error</code>, making it incompatible with most of the Rust ecosystem.</p>
<p>Technically, you do not need a full wrapper type to resolve this.  You can do it just by defining a function and passing that in instead.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a>epage/clapng#184</a> on 2021-12-06 21:14</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2021-12-13 16:38</div>
            <div class="timeline-body"><p>Since the names are intended to convey the signature, not the trait, this is working as intended and I&#x27;m going to go ahead and close this.</p>
<p>@pksunkara if there are parts of this you want to resolve in #2683, please comment in that issue with it.</p>
<p>If there are any concerns about this, let us know!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/epage">@epage</a> on 2021-12-13 16:38</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">S-wont-fix</span> added by <a href="https://github.com/epage">@epage</a> on 2022-01-11 18:27</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a>collabora/bmap-rs#41</a> on 2022-11-09 12:09</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:58:04 UTC
    </footer>
</body>
</html>
