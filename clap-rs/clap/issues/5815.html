<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ability to customize the built-in `help` subcommand - clap-rs/clap #5815</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Ability to customize the built-in <code>help</code> subcommand</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/clap-rs/clap/issues/5815">#5815</a>
        opened by <a href="https://github.com/mr-briggs">@mr-briggs</a>
        on 2024-11-13 21:50
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/mr-briggs">@mr-briggs</a></div>
            <div class="timeline-body"><h3>Please complete the following tasks</h3>
<ul>
<li>[X] I have searched the <a href="https://github.com/clap-rs/clap/discussions">discussions</a></li>
<li>[X] I have searched the <a href="https://github.com/clap-rs/clap/issues">open</a> and <a href="https://github.com/clap-rs/clap/issues?q=is%3Aissue+label%3AS-wont-fix+is%3Aclosed">rejected</a> issues</li>
</ul>
<h3>Clap Version</h3>
<p>4.5.20</p>
<h3>Describe your use case</h3>
<p>It's currently fairly cumbersome to alter the <code>about</code> message for auto-generated help subcommands when using <code>clap-derive</code>. Consider the following example scenario:</p>
<pre><code class="language-rust">use clap::{command, CommandFactory, FromArgMatches, Parser, Subcommand};

#[derive(Parser)]
pub struct Cli {
    #[command(subcommand)]
    pub command: Option&lt;Commands&gt;,
}

#[derive(Subcommand)]
pub enum Commands {
    Subcmd,
}
</code></pre>
<p>To use the parser as-is, we can run something like:</p>
<pre><code class="language-rust">fn main() {
    let cli = Cli::parse();
    match &amp;cli.command { /* ... */ }
}
</code></pre>
<p>But if we'd like to customize the <code>about</code> message for the generated help subcommand, we can no longer use the nice <code>parse</code> methods on <code>Cli</code>, and instead need to do something like:</p>
<pre><code class="language-rust">fn main() -&gt; Result&lt;(), clap::Error&gt; {
    let mut cmd = Cli::command();
    cmd.build(); // Need to build `cmd` to generate the `help` subcommand

    let cmd = cmd.mut_subcommand(&quot;help&quot;, |help_cmd| {
        help_cmd.about(&quot;A custom help message&quot;)
    });

    // Now we need to manually do what the `parse()` method would do, since we have a modified `Command`:
    let mut matches = cmd.get_matches();
    let cli = Cli::from_arg_matches(&amp;mut matches)?;

    match &amp;cli.command { /* ... */ }

    Ok(())
}
</code></pre>
<p>And for the sake of completeness, if we now run this with <code>cargo run -- help</code>, we'd get:</p>
<pre><code>Usage: clap_example [COMMAND]

Commands:
  subcmd  
  help    A custom help message

Options:
  -h, --help  Print help
</code></pre>
<h3>Describe the solution you'd like</h3>
<p>One way to streamline this would be to provide a <code>build()</code> method on <code>Command</code> which returns <code>self</code>, so that we can directly call <code>mut_subcommand</code> in the <code>#[command()]</code> macro. For example, if <code>Command</code> had something like:</p>
<pre><code class="language-rust">#[cfg(feature = &quot;derive&quot;)]
pub fn build_for_derive(mut self) -&gt; Self {
    self.build();
    self
}
</code></pre>
<p>Then we could do the following:</p>
<pre><code class="language-rust">#[derive(Parser)]
#[command(
    build_for_derive(),
    mut_subcommand(&quot;help&quot;, |subcmd| subcmd.about(&quot;A custom help message&quot;),
)]
pub struct Cli {
    #[command(subcommand)]
    pub command: Option&lt;Commands&gt;,
}

// ... `enum Commands` elided

fn main() {
    // And now we can go back the straightforward setup:
    let cli = Cli::parse();
    match &amp;cli.command { /* ... */ }
}
</code></pre>
<p>Note that trying to use <code>build()</code> in place of the <code>build_for_derive()</code> above doesn't work, as <code>build()</code> mutates the <code>Command</code> in-place and doesn't return anything, which breaks the <code>Parser</code> derive macro.</p>
<h3>Alternatives, if applicable</h3>
<p><em>No response</em></p>
<h3>Additional Context</h3>
<p><em>No response</em></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">C-enhancement</span> added by @mr-briggs on 2024-11-13 21:50</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "Add a build method to Command which returns `self`" to "Add a build method to `Command` which returns `self`" by @mr-briggs on 2024-11-13 21:53</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2024-11-13 22:23</div>
            <div class="timeline-body"><p>Note that changing things after a <code>build</code> is undefined from the APIs perspective.  This isn't directly called out in #2911 but is related to that.</p>
<p>What we need is a way for users to get the built-in <code>help</code> behavior when they provide their own help.  Help  flags started by us auto-detecting a help flag being present (without us being told it shouldn't exist) and then keying off of that.  We then switched to the ArgAction system so you could attach a Help action to any flag.  Huh, I thought I had done some exploring on this idea but can only find #3773 which alludes to commands not being supported but thats it.</p>
<p>This could also be helpful for #1553.</p>
<p>Potentially related</p>
<ul>
<li>#5770</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "Add a build method to `Command` which returns `self`" to "Ability to customize the built-in `help` subcommand" by @epage on 2024-11-13 22:24</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">A-builder</span> added by @epage on 2024-11-13 22:24</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">S-waiting-on-design</span> added by @epage on 2024-11-13 22:24</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/mr-briggs">@mr-briggs</a> on 2024-11-14 15:06</div>
            <div class="timeline-body"><p>Oh interesting, thank you for the insight about <code>build</code>.</p>
<p>I had initially began this issue as &quot;add <code>help_about</code> and <code>version_about</code> to <code>Command</code>&quot; but after some digging, found that <a href="https://github.com/clap-rs/clap/pull/2143">they did actually briefly exist</a> back when it was called <code>App</code>. They <a href="https://github.com/clap-rs/clap/pull/2211">were removed</a> a few months later in favour of using <code>mut_arg</code> to modify them after building the <code>App</code> (see <a href="https://github.com/clap-rs/clap/pull/2211#issuecomment-767740131">this comment</a>), but I'm not sure how things have changed since then.</p>
<blockquote>
<p>What we need is a way for users to get the built-in <code>help</code> behavior when they provide their own help.</p>
</blockquote>
<p>Huh, that's probably more understandable for users, rather than modifying an auto-gen'd command that they might not even know about. One downside of specifying your own <code>help</code> command though is that it becomes a possible <code>match</code> arm (at least when deriving <code>Subcommand</code> on an <code>enum</code>) even though it's not a valid option under most circumstances (assuming the user-defined <code>help</code> would have the same behaviour of returning <code>Err(ErrorKind::DisplayHelp ...)</code>.</p>
<p>That's possibly not a major concern though, compared to the upside of being able to customize the <code>help</code> message.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/5935.html">clap-rs/clap#5935</a> on 2025-03-03 15:38</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../autobib/autobib/issues/232.html">autobib/autobib#232</a> on 2025-10-07 10:32</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:49:29 UTC
    </footer>
</body>
</html>
