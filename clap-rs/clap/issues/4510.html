<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recent minor version upgrade of clap breaks building with a wasm target. - clap-rs/clap #4510</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Recent minor version upgrade of clap breaks building with a wasm target.</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/clap-rs/clap/issues/4510">#4510</a>
        opened by <a href="https://github.com/0xForerunner">@0xForerunner</a>
        on 2022-11-25 22:10
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/0xForerunner">@0xForerunner</a> on 2022-11-25 22:10</div>
            <div class="timeline-body"><h3>Please complete the following tasks</h3>
<ul>
<li>[X] I have searched the <a href="https://github.com/clap-rs/clap/discussions">discussions</a></li>
<li>[X] I have searched the <a href="https://github.com/clap-rs/clap/issues">open</a> and <a href="https://github.com/clap-rs/clap/issues?q=is%3Aissue+label%3AS-wont-fix+is%3Aclosed">rejected</a> issues</li>
</ul>
<h3>Rust Version</h3>
<p>rustc 1.67.0-nightly (b3bc6bf31 2022-11-24)</p>
<h3>Clap Version</h3>
<p>between 4.0.22 and 4.0.27</p>
<h3>Minimal reproducible code</h3>
<pre><code class="language-rust">fn main() {}
</code></pre>
<h3>Steps to reproduce the bug with the above code</h3>
<p>just compile to wasm32-unknown-unknown and it breaks. 4.0.22 works as expected, 4.0.27 does not compile.</p>
<h3>Actual Behaviour</h3>
<pre><code>~/lending-contracts (develop) » cargo update -p clap                                                                                                                                                                                                       ewoolsey@Erics-MacBook-Pro
    Updating crates.io index
    Updating clap v4.0.22 -&gt; v4.0.27
      Adding errno v0.2.8
      Adding errno-dragonfly v0.1.2
      Adding hermit-abi v0.2.6
      Adding io-lifetimes v1.0.2
      Adding is-terminal v0.4.0
      Adding linux-raw-sys v0.1.3
      Adding rustix v0.36.3
-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
~/lending-contracts (develop*) » d b                                                                                                                                                                                              ewoolsey@Erics-MacBook-Pro
   Compiling libc v0.2.137
   Compiling io-lifetimes v1.0.2
   Compiling rustix v0.36.3
   Compiling errno v0.2.8
   Compiling neptune-authorization v0.1.0 (/Users/ewoolsey/lending-contracts/packages/neptune-auth)
error[E0583]: file not found for module `sys`
  --&gt; /Users/ewoolsey/.cargo/registry/src/github.com-1ecc6299db9ec823/errno-0.2.8/src/lib.rs:33:1
   |
33 | mod sys;
   | ^^^^^^^^
   |
   = help: to create the module `sys`, create file &quot;/Users/ewoolsey/.cargo/registry/src/github.com-1ecc6299db9ec823/errno-0.2.8/src/sys.rs&quot; or &quot;/Users/ewoolsey/.cargo/registry/src/github.com-1ecc6299db9ec823/errno-0.2.8/src/sys/mod.rs&quot;

error[E0425]: cannot find function `errno` in module `sys`
   --&gt; /Users/ewoolsey/.cargo/registry/src/github.com-1ecc6299db9ec823/errno-0.2.8/src/lib.rs:101:10
    |
101 |     sys::errno()
    |          ^^^^^ not found in `sys`

error[E0425]: cannot find function `set_errno` in module `sys`
   --&gt; /Users/ewoolsey/.cargo/registry/src/github.com-1ecc6299db9ec823/errno-0.2.8/src/lib.rs:106:10
    |
106 |     sys::set_errno(err)
    |          ^^^^^^^^^ not found in `sys`

Some errors have detailed explanations: E0425, E0583.
For more information about an error, try `rustc --explain E0425`.
error: could not compile `errno` due to 3 previous errors
warning: build failed, waiting for other jobs to finish...
process exited unsuccessfully: exit status: 101
</code></pre>
<h3>Expected Behaviour</h3>
<p>Minor version increments should not introduce breaking changes. I'm not sure exactly which version increment causes the issue but it appears to be from the inclusion of errno.</p>
<h3>Additional Context</h3>
<p><em>No response</em></p>
<h3>Debug Output</h3>
<p><em>No response</em></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">C-bug</span> added by @0xForerunner on 2022-11-25 22:10</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/0xForerunner">@0xForerunner</a> on 2022-11-25 22:20</div>
            <div class="timeline-body"><p>After fiddling a little bit I can confirm that the offender in 4.0.27 specifically. Everything works as expected on 4.0.26.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/0xForerunner">@0xForerunner</a> on 2022-11-25 22:26</div>
            <div class="timeline-body"><p>Might be useful to add a wasm build to you CI workflow to avoid accidental bugs like that.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2022-11-26 01:49</div>
            <div class="timeline-body"><p>4.0.27 saw us switch from atty to is-terminal, so that is the root cause.</p>
<p>We also do check <code>wasm32-unknown-unknown</code>  and <code>wasm32-wasi</code> in CI</p>
<ul>
<li>https://github.com/clap-rs/clap/blob/master/.github/workflows/ci.yml#L78</li>
<li>https://github.com/clap-rs/clap/blob/master/Makefile#L18</li>
</ul>
<p>This was all done in #4249 and the wams jobs definitely built is-terminal and it worked</p>
<ul>
<li>https://github.com/clap-rs/clap/actions/runs/3541494860/jobs/5945830558</li>
<li>https://github.com/clap-rs/clap/actions/runs/3541494860/jobs/5945830669</li>
</ul>
<p>So why did this work in CI but not for you?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/0xForerunner">@0xForerunner</a> on 2022-11-26 01:56</div>
            <div class="timeline-body"><blockquote>
<p>So why did this work in CI but not for you?</p>
</blockquote>
<p>That's a fantastic question. Is there any other information I can give you that might be useful? Unfortunately I'm working on a large not-yet-open-source project otherwise I'd zip my build for you. I'm working on a Mac, although I doubt that's related to the problem.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/johanhelsing">@johanhelsing</a> on 2022-11-26 07:23</div>
            <div class="timeline-body"><p>Seeing the same thing in our project as well.</p>
<p>To reproduce:</p>
<pre><code>git clone https://github.com/johanhelsing/matchbox
cd matchbox/matchbox_demo
cargo check --target wasm32-unknown-unknown
# no errors
cargo update -p clap
cargo check --target wasm32-unknown-unknown
# same error as ewoolsey
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/pinkforest">@pinkforest</a> on 2022-11-26 08:12</div>
            <div class="timeline-body"><blockquote>
<p>So why did this work in CI but not for you?</p>
</blockquote>
<p>it seems to have picked atty looking at the logs .. ?</p>
<p><code>Checking atty v0.2.14</code></p>
<p>EDIT: wasm CI doesn't include color feature which is the feature that brings is-terminal ?</p>
<p><code>cargo check --features &quot;deprecated derive cargo env unicode string unstable-replace unstable-grouped&quot; --all-targets --workspace</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/pinkforest">@pinkforest</a> on 2022-11-26 08:18</div>
            <div class="timeline-body"><p>Working on rustup default stable -&gt; 1.65.0 w/ associated w32-u-u target installed</p>
<p>So granular dep changes here were:</p>
<p>root@5d44a4311b14:/matchbox/matchbox_demo# cargo update -p clap</p>
<pre><code>    Updating crates.io index
    Updating clap v4.0.18 -&gt; v4.0.27
    Updating clap_derive v4.0.18 -&gt; v4.0.21
      Adding errno v0.2.8
      Adding errno-dragonfly v0.1.2
      Adding hermit-abi v0.2.6
      Adding io-lifetimes v1.0.2
      Adding is-terminal v0.4.0
      Adding linux-raw-sys v0.1.3
      Adding rustix v0.36.3
</code></pre>
<p>I can replicate it inside rust default docker w/ add rustup target add wasm32-u-u from scratch</p>
<p>Immediate work/around seems if one disables the <code>color</code> feature by explicitly setting the defaults:</p>
<p><code>clap = { version = &quot;4.0&quot;, default-features = false, features = [&quot;derive&quot;, &quot;std&quot;, &quot;help&quot;, &quot;usage&quot;, &quot;error-context&quot;, &quot;suggestions&quot;] }</code></p>
<p>This prevents feature color (default) being included which brings is-terminal dependency that doesn't work with wasm32-u-u</p>
<p>EDIT: Intiially I had a brainfreeze and I had written no-default-features = true which obviously doesn't work ;)</p>
<p>This would need some cfg magic I think in order for the cargo not include these crates that don't work in wasm32-u-u</p>
<p>It's probably quite involved to cfg default features with: <code>target_family = &quot;wasm&quot;, target_os = &quot;unknown&quot;</code></p>
<p>I've also asked @sunfishcode if is-terminal could stub wasm32-u-u: https://github.com/sunfishcode/is-terminal/issues/9</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/4513.html">clap-rs/clap#4513</a> on 2022-11-26 08:26</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../sunfishcode/is-terminal/issues/9.html">sunfishcode/is-terminal#9</a> on 2022-11-26 08:34</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2022-11-26 22:01</div>
            <div class="timeline-body"><blockquote>
<p>EDIT: wasm CI doesn't include color feature which is the feature that brings is-terminal ?</p>
</blockquote>
<p><code>color</code> is a default feature.</p>
<p>If you look in the linked <a href="https://github.com/clap-rs/clap/actions/runs/3541494860/jobs/5945830558">logs</a>, you see that <code>termcolor</code> and <code>is-terminal</code> are being built.  I think the question is if we are using the default target or what I thought was an overriding target.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2022-11-28 15:32</div>
            <div class="timeline-body"><p>Got a <a href="https://github.com/clap-rs/clap/pull/4515">reproduction in CI</a></p>
<p>There are two failures</p>
<ul>
<li><code>io-lifetimes</code> fails to compile with <code>wasm32-unknown-unknown</code></li>
<li>The errno issue above for wasi</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/4515.html">clap-rs/clap#4515</a> on 2022-11-28 15:35</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/4518.html">clap-rs/clap#4518</a> on 2022-11-29 03:09</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/pinkforest">@pinkforest</a> on 2022-11-29 03:16</div>
            <div class="timeline-body"><p>@sunfishcode bumped up <code>io-lifetimes</code> and <code>is-terminal</code> that fixed builds for <code>wasm32</code>  - <code>unknown</code> and <code>wasi</code> Thanks!</p>
<p>fix bump applied at https://github.com/clap-rs/clap/pull/4518 with the CI chore fix from #4515</p>
<pre><code>$ cargo build --target wasm32-unknown-unknown
    Finished dev [unoptimized + debuginfo] target(s) in 0.03s
$ cargo build --target wasm32-wasi
    Finished dev [unoptimized + debuginfo] target(s) in 0.03s
</code></pre>
<p>However testing is borked for <code>wasm32</code> -</p>
<p>Now it complains about <code>os_pipe</code> dev dependency via <code>trycmd</code> that doesn't seem to understand <code>wasm32</code></p>
<p>$ cargo tree -i os_pipe</p>
<pre><code>os_pipe v1.1.1
└── snapbox v0.4.1
    └── trycmd v0.14.3
        [dev-dependencies]
        └── clap v4.0.27 (/home/foobar/cc/clap)
    [dev-dependencies]
    └── clap v4.0.27 (/home/foobar/cc/clap)
</code></pre>
<p>https://github.com/clap-rs/clap/actions/runs/3570677150/jobs/6001871085</p>
<p>So progess I guess :)</p>
<p>It builds fine though so that is what is essential but testing needs adjustment for wasm32 targets me thinks ?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @epage on 2022-11-29 03:45</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../johanhelsing/matchbox/pulls/51.html">johanhelsing/matchbox#51</a> on 2022-11-29 04:05</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 01:35:16 UTC
    </footer>
</body>
</html>
