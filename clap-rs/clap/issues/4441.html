<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[Derive] Way to parse long_help from doc comments excluding  - clap-rs/clap #4441</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[Derive] Way to parse long_help from doc comments excluding </h1>

    <div class="meta">
        <span class="state state-closed">Closed</span>
        <a href="https://github.com/clap-rs/clap/issues/4441">#4441</a>
        opened by <a href="https://github.com/tmccombs">@tmccombs</a>
        on 2022-11-02 07:36
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/tmccombs">@tmccombs</a> on 2022-11-02 07:36</div>
            <div class="timeline-body"><h3>Please complete the following tasks</h3>
<ul>
<li>[X] I have searched the <a href="https://github.com/clap-rs/clap/discussions">discussions</a></li>
<li>[X] I have searched the <a href="https://github.com/clap-rs/clap/issues">open</a> and <a href="https://github.com/clap-rs/clap/issues?q=is%3Aissue+label%3AS-wont-fix+is%3Aclosed">rejected</a> issues</li>
</ul>
<h3>Clap Version</h3>
<p>4.0.18</p>
<h3>Describe your use case</h3>
<p>In fd, there are many options where we want to have different help messages for the &quot;short&quot; and &quot;long&quot; help. When clap parses the doc comments, it interprets the first paragraph as the short help, and the entire doc comments as the long help. This means that the long help includes the short help text as its first paragraph. There isn't a way to have a different first paragraph for the long help output than for the short help output if you use doc comments.</p>
<p>Relatedly, if you have an option with <code>hide_short_help = true</code>, then you don't need any short help from the doc comment. However, by default clap strips a trailing period off the end of the first paragraph, which may not be desirable. The only way to prevent that is to use <code>verbatim_doc_comment</code>, but then you lose the automatic wrapping and whitespace cleanup.</p>
<p>I'd like a way to specify the long_help in the documentation comment without including the short help.</p>
<h3>Describe the solution you'd like</h3>
<p>Have an attribute on the Parser struct and/or individual attributes to specify that the first paragraph in the doc comment should be passed to help and the remainder, excluding the first paragraph, should be used for the long_help. If the doc comment begins with two blank lines, then use the full comment as the long_help, and don't set a <code>help</code>:</p>
<pre><code class="language-rust">#[derive(Parser)] 
#[command(name = &quot;mycommand&quot;, distinct_doc_comment_help = true)]
pub struct Opts {
    /// This is the short help
    /// 
    /// This is the long help. 
    #[arg(short = 'a')]
    pub a: bool,
    ///
    ///
    /// This option only has a long_help.
    ///
    /// And it includes both paragraphs. The first period isn't 
    /// removed.
    #[arg(long, hide_short_help = true)]
    pub hidden_option: bool,
    /// This is in both.
    ///
    /// This option includes the first paragraph in both the short and long help messages.
    #[arg(short = 'c', distinct_doc_comment_help = false)]
    pub c: bool, 
}
</code></pre>
<p>The name of the attribute could probably be improved.</p>
<h3>Alternatives, if applicable</h3>
<ol>
<li>Change the behavior to never include the first paragraph in the long_help. This would break backwards compatibility, and might be inconvenient in the case you do want the same paragraph in both.</li>
<li>Have some kind of special syntax in the doc comment itself to indicate where to split between the short help and the long help. Possibly with some way to indicate you want to include the short help at the beginning of the long help.</li>
<li>Just stop removing the trailing period when generating <code>long_help</code>. This helps in the case where <code>hide_short_help</code> is true, but not in the more general case where you want different text for the first paragraph of the long and short help.</li>
<li>Do nothing. It is possible to work around this by passing strings to <code>help</code> and <code>long_help</code>, although that is certainly less convenient than being able to use doc coumments (this is what fd currently does).</li>
</ol>
<h3>Additional Context</h3>
<p>Something that occurred to me, although I haven't needed it yet is, what if you want multiple paragraphs in the short help? Currently I don't think you can do that with the doc comment parser, and you have to manually use the <code>help=</code> attribute.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">C-enhancement</span> added by @tmccombs on 2022-11-02 07:36</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2022-11-02 15:01</div>
            <div class="timeline-body"><blockquote>
<p>In fd, there are many options where we want to have different help messages for the &quot;short&quot; and &quot;long&quot; help. When clap parses the doc comments, it interprets the first paragraph as the short help, and the entire doc comments as the long help. This means that the long help includes the short help text as its first paragraph. There isn't a way to have a different first paragraph for the long help output than for the short help output if you use doc comments.</p>
</blockquote>
<p>Why not specify <code>#[arg(help = &quot;&quot;)]</code> and leave the doc comment only for the long help?</p>
<blockquote>
<p>Relatedly, if you have an option with hide_short_help = true, then you don't need any short help from the doc comment. However, by default clap strips a trailing period off the end of the first paragraph, which may not be desirable. The only way to prevent that is to use verbatim_doc_comment, but then you lose the automatic wrapping and whitespace cleanup.</p>
</blockquote>
<p>If short help is hidden, why does it matter what clap sets it to?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">A-help</span> added by @epage on 2022-11-02 15:01</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/tmccombs">@tmccombs</a> on 2022-11-02 15:42</div>
            <div class="timeline-body"><blockquote>
<p>Why not specify #[arg(help = &quot;&quot;)] and leave the doc comment only for the long help?</p>
</blockquote>
<p>I thought I tried that, and it didn't set the long_help at all. I could be misremembering though.</p>
<p>That does still have the problem that it strips the &quot;.&quot; off the end of the first paragraph though.</p>
<blockquote>
<p>If short help is hidden, why does it matter what clap sets it to?</p>
</blockquote>
<p>It doesn't. In this case my main issue is that it still strips the &quot;.&quot; off the end of the first paragraph (if it is there).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2022-11-02 19:00</div>
            <div class="timeline-body"><p>so if I'm understanding correctly, clap is modifying the long help?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/tmccombs">@tmccombs</a> on 2022-11-03 05:38</div>
            <div class="timeline-body"><p>Yeah, I just retried using <code>#[arg(help = &quot;...&quot;)]</code> witha doc comment, like this:</p>
<pre><code>    /// Show search results from files and directories that would otherwise be
    /// ignored by '.gitignore' files. The flag can be overridden with --ignore-vcs.
    #[arg(
        long,
        hide_short_help = true,
        help = &quot;Do not respect .gitignore files&quot;,
    )]
    pub no_ignore_vcs: bool,
</code></pre>
<p>and for the long help it shows &quot;Do not respect .gitignore files&quot; instead of what is in the doc comment.  (if I rem ove <code>hide_short_help = true</code> it shows the same thing in the short help).</p>
<p>And if I remove the <code>help = </code> line, then the long help shows:</p>
<pre><code>      --no-ignore-vcs
          Show search results from files and directories that would otherwise be ignored by
          '.gitignore' files. The flag can be overridden with --ignore-vcs
</code></pre>
<p>Note that while there is a period at the end of the text in the doc comment, it is missing in the help text. The <a href="https://docs.rs/clap/latest/clap/_derive/index.html#pre-processing">documentation for derive</a> does mention this:</p>
<blockquote>
<p>If the first paragraph ends in exactly one period, remove the trailing period (i.e. strip trailing periods but not trailing ellipses).</p>
</blockquote>
<p>If specifying a <code>help = </code> didn't impact the use of the doc comment for the long_help, and the period at the end of the first paragraph isn't removed, then that would be a pretty good solution to this as well.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2022-11-03 14:32</div>
            <div class="timeline-body"><p>Turns out that <code>help =</code> is not impacting the long help but is overriding the short help set by the doc comment.  As the doc comment looks like short help only (single &quot;line&quot;), we never set <code>long_help</code>.  Long help is visually different than short help and not every application wants long help, so we key off of the presence of <code>long_help</code> for rendering <code>--help</code> differently than <code>-h</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/tmccombs">@tmccombs</a> on 2022-11-07 07:13</div>
            <div class="timeline-body"><p>hmm, what if <code>long_help</code> was allowed without an argument in the attribute, which would force the passing the doc comment to the long_help method, even if it is a single paragraph. And then do something about the period truncation (either don't remove it if it is long help, have a separate option for it, or just get rid of it altogether).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2022-11-07 13:43</div>
            <div class="timeline-body"><p>I think that makes sense.  I would lean towards treating whatever is present as long help which means no period removal</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/4461.html">clap-rs/clap#4461</a> on 2022-11-07 15:42</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @epage on 2022-11-07 15:59</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:35:09 UTC
    </footer>
</body>
</html>
