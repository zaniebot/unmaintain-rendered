```yaml
number: 3706
title: "Allow to use `Option<T: Args>` with flatten"
type: issue
state: closed
author: Zagitta
labels:
  - C-enhancement
assignees: []
created_at: 2022-05-09T14:38:34Z
updated_at: 2022-10-05T21:52:41Z
url: https://github.com/clap-rs/clap/issues/3706
synced_at: 2026-01-10T01:57:47Z
```

# Allow to use `Option<T: Args>` with flatten

---

_Issue opened by @Zagitta on 2022-05-09 14:38_

### Please complete the following tasks

- [X] I have searched the [discussions](https://github.com/clap-rs/clap/discussions)
- [X] I have searched the [open](https://github.com/clap-rs/clap/issues) and [rejected](https://github.com/clap-rs/clap/issues?q=is%3Aissue+label%3AS-wont-fix+is%3Aclosed) issues

### Clap Version

3.1.17

### Describe your use case

We're building a rather large web service where the command line options are starting to get out of hand.
Most recently we've added a small service that we might want to conditionally run dependent on the deployment environment. This service has a couple of configuration settings that must all be there to work.
Currently, that can be achieved by something like:
```rust
#[derive(Parser)]
#[clap(group(
    clap::ArgGroup::new("slack-config")
    .args(&["a", "b", "c", "d"])
    .requires_all(&["a", "b", "c", "d"])
    .multiple(true),
))]
struct ServiceArgs {
  a: Option<String>,
  b: Option<String>,
  c: Option<String>,
  d: Option<String>,
}
#[derive(Parser)]
struct ServerArgs 
{  
  /// Server port number
  #[clap(long, short, env, default_value = "3030")]
  port: u16,
  #[clap(flatten)]
  service_args: ServiceArgs
}
```

However this is needlessly complicated when having to actually use `ServiceArgs` due to all the unwrapping.

### Describe the solution you'd like

Instead we'd like the following solution:
```rust
#[derive(Parser)]
#[clap(group(
    clap::ArgGroup::new("slack-config")
    .args(&["a", "b", "c", "d"])
    .requires_all(&["a", "b", "c", "d"])
    .multiple(true),
))]
struct ServiceArgs {
  a: String,
  b: String,
  c: String,
  d: String,
}
#[derive(Parser)]
struct ServerArgs 
{  
  /// Server port number
  #[clap(long, short, env, default_value = "3030")]
  port: u16,
  #[clap(flatten)]
  service_args: Option<ServiceArgs>
}
```

### Alternatives, if applicable

_No response_

### Additional Context

_No response_

---

_Label `C-enhancement` added by @Zagitta on 2022-05-09 14:38_

---

_Referenced in [clap-rs/clap#3707](../../clap-rs/clap/pulls/3707.md) on 2022-05-09 14:40_

---

_Comment by @epage on 2022-05-09 14:46_

Without additional work being done, the actual solution would look like
```rust
#[derive(Parser)]
#[clap(group(
    clap::ArgGroup::new("slack-config")
    .args(&["a", "b", "c", "d"])
    .requires_all(&["a", "b", "c", "d"])
    .multiple(true),
))]
struct ServiceArgs {
  #[clap(required = false)]
  a: String,
  #[clap(required = false)]
  b: String,
  #[clap(required = false)]
  c: String,
  #[clap(required = false)]
  d: String,
}
#[derive(Parser)]
struct ServerArgs 
{  
  /// Server port number
  #[clap(long, short, env, default_value = "3030")]
  port: u16,
  #[clap(flatten)]
  service_args: Option<ServiceArgs>
}
```
because `clap_derive` doesn't know to skip setting `required = true` on each arg and you need to overwrite what it sets.

---

_Comment by @epage on 2022-05-09 14:51_

Also, this appears to be a duplicate of #3123.  Closing this in favor of it.  Feel free to add any additional notes to that issue.

---

_Closed by @epage on 2022-05-09 14:51_

---

_Comment by @Zagitta on 2022-05-09 14:55_

Unfortunately the solution you propose doesn't work due to the following issue:
> error[[E0277]](https://doc.rust-lang.org/stable/error-index.html#E0277): the trait bound `Option<ServiceArgs>: FromArgMatches` is not satisfied
  [--> src/main.rs:26:12
](https://play.rust-lang.org/?version=stable&mode=debug&edition=2021&gist=40fc8323211551c233fa7b09383de785#)   |
26 |     #[clap(flatten)]
   |            ^^^^^^^ the trait `FromArgMatches` is not implemented for `Option<ServiceArgs>`

https://play.rust-lang.org/?version=stable&mode=debug&edition=2021&gist=40fc8323211551c233fa7b09383de785

---

_Comment by @epage on 2022-05-09 15:04_

Sorry, I meant with `#[clap(flatten)]` being supported for `Option<T>` but no other special handling of required / groups, then the code I showed will be needed.

---

_Comment by @epage on 2022-10-05 21:52_

This was released in v4.0.10

---
