<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ArgRequiredElseHelp is ignored if there are *any* default values - clap-rs/clap #1264</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>ArgRequiredElseHelp is ignored if there are <em>any</em> default values</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/clap-rs/clap/issues/1264">#1264</a>
        opened by <a href="https://github.com/whitfin">@whitfin</a>
        on 2018-05-01 04:59
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/whitfin">@whitfin</a> on 2018-05-01 04:59</div>
            <div class="timeline-body"><h3>Rust Version</h3>
<p>rustc 1.25.0 (84203cac6 2018-03-25)</p>
<h3>Affected Version of clap</h3>
<p>2.31.2</p>
<h3>Expected Behavior Summary</h3>
<p>If <code>ArgRequiredElseHelp</code> is enabled, you should see the help menu if an option is not provided correctly.</p>
<h3>Actual Behavior Summary</h3>
<p>If you have two arguments, and one has a default, this the help menu is not correctly printed.</p>
<h3>Steps to Reproduce the issue</h3>
<p>Run the code below in a test project via <code>cargo run</code>. It won't work (rightly so) because the &quot;second&quot; option is not provided - but you'll get an error instead of the help menu.</p>
<p>Do the same again with the default value removed from &quot;first&quot;, and you'll then see a help menu. Regardless of the default value of &quot;first&quot;, it should show the help menu both times.</p>
<pre><code class="language-rust">App::new(&quot;&quot;)
    // package metadata from cargo
    .name(env!(&quot;CARGO_PKG_NAME&quot;))
    .about(env!(&quot;CARGO_PKG_DESCRIPTION&quot;))
    .version(env!(&quot;CARGO_PKG_VERSION&quot;))

    // arguments and flag details
    .arg(Arg::with_name(&quot;second&quot;)
        .help(&quot;second option&quot;)
        .required(true))
    .arg(Arg::with_name(&quot;first&quot;)
        .help(&quot;first option&quot;)
        .default_value(&quot;something&quot;))

    // settings required for parsing
    .setting(AppSettings::ArgRequiredElseHelp)
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/whitfin">@whitfin</a> on 2018-05-01 05:04</div>
            <div class="timeline-body"><p>I think perhaps https://github.com/kbknapp/clap-rs/blob/master/src/app/validator.rs#L63 should use <code>!reqs_validated</code> instead of <code>matcher.is_empty()</code>.</p>
<p>I dropped a PR in https://github.com/kbknapp/clap-rs/pull/1265; all tests pass still and the issue appears fixed. I'm not familiar enough to know if this is the best approach, so let me know of any feedback.</p>
<p>Edit: actually that PR appears to render the help menu <em>too</em> frequently now, so closed for the time being :)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/1265.html">clap-rs/clap#1265</a> on 2018-05-01 05:13</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/kbknapp">@kbknapp</a> on 2018-06-05 01:38</div>
            <div class="timeline-body"><p>Sorry for the long wait, I've been away for a few weeks with my day job.</p>
<p>while I agree it's not optimal, a default value <em>is</em> a value and therefore clap treats it as such. I'd possibly consider adding some sort of setting such as <code>UserArgRequiredElseHelp</code> but I'm not sure it'd quite be worth it as the &quot;fix&quot; for this is to simply not provide a default and use something like, <code>matches.value_of(&quot;my-arg-that-needs-a-default&quot;).unwrap_or(&quot;default_value&quot;)</code> and just &quot;tell&quot; the user in the help text manually that there is a default value (but to <code>clap</code> there isn't).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @kbknapp on 2018-06-05 01:38</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Kayvlim">@Kayvlim</a> on 2020-07-14 14:59</div>
            <div class="timeline-body"><p>Bringing this back because I found this issue when searching before opening a new one.</p>
<p>Versions:
rustc 1.44.1 (c7087fe00 2020-06-17)
clap 3.0.0-beta.1</p>
<p>@kbknapp: if the &quot;fix&quot; is to call <code>unwrap_or</code> instead of using the mechanism already in place for default_values, this either defeats the purpose of this mechanism or the purpose of ArgRequiredElseHelp.</p>
<p>I believe <a href="https://docs.rs/clap/2.33.1/clap/enum.AppSettings.html#variant.ArgRequiredElseHelp"><code>AppSettings::ArgRequiredElseHelp</code></a> is only relevant when we want to display the help to a user that did not write any arguments in the command line. This is the typical interaction for &quot;let me see how this program works&quot;.
This behavior should not be dependent on whether there are arguments with default values. The user still did not type any argument.
I should also point out that even when no arguments are <code>.required(true)</code>, <code>ArgRequiredElseHelp</code> does the right thing <em>as long as no default_values are present</em>.</p>
<p>Is there <em>any</em> use case where <code>ArgRequiredElseHelp</code> makes sense when an <code>arg</code> with a <code>default_value</code> is present?</p>
<p>It seems to me that clap's approach to default values is equating them with the user passing them in the command line (with the exception of <code>occurrences_of</code> returning zero), but what I am expecting is that <code>is_present</code> returns true and any attempt to retrieve the value (such as calling <code>value_of</code>) returns the default_value instead of <code>None</code>, with no other behavior being affected.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/pksunkara">@pksunkara</a> on 2020-07-19 10:37</div>
            <div class="timeline-body"><p>@CreepySkeleton you were working on default stuff recently, right? Can you take a look at this last comment?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/CreepySkeleton">@CreepySkeleton</a> on 2020-07-19 15:38</div>
            <div class="timeline-body"><p>I find myself agreeing with @Kayvlim . Default values aren't ephemeral, they are very real values. Clap treats them in almost exactly the same way as any other value (barring conflict resolution which they are exempt from, or at least should have been).</p>
<blockquote>
<p>Is there any use case where ArgRequiredElseHelp makes sense when an arg with a default_value is present?</p>
</blockquote>
<p>That is a good question. My answer would be no, there aren't, and in this case we should panic if <code>ArgRequiredElseHelp</code> is set and <em>any</em> of the args has <code>default_value</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Kayvlim">@Kayvlim</a> on 2020-07-22 01:06</div>
            <div class="timeline-body"><p>@CreepySkeleton I suppose you are only agreeing with how I think clap works, but not with how I think it should be changed?</p>
<p>I don't agree that <code>ArgRequiredElseHelp</code> should panic if any arg has a <code>default_value</code>. It's a perfectly legitimate use case:</p>
<p>If the user runs my application without arguments, I want them to see the help, but if they run it with the single required argument, I want the application to run with a sensible set of default values for the arguments they <em>didn't</em> pass (or &quot;override&quot;). I shouldn't have to <code>unwrap_or</code> every non-passed argument to accomplish this when a mechanism for default values is available just because I also want to display the help when no arguments have been passed.</p>
<p>So, I think <code>ArgRequiredElseHelp</code> should do exactly the same thing it would if there were no <code>default_value</code>s whatsoever. This doesn't make default values ephemeral. Instead, it stops pretending they were passed by the user when they really weren't.</p>
<p>In other words, I don't see default values as values the user positively intended to pass to the application by omission. I see them as values the application needs to assume when the user hasn't said anything about them and <code>None</code> is not acceptable.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../tgotwig/vidmerger/issues/11.html">tgotwig/vidmerger#11</a> on 2020-07-23 14:38</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/CreepySkeleton">@CreepySkeleton</a> on 2020-07-24 03:25</div>
            <div class="timeline-body"><p>Well, let's see what we can do about that...</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Reopened by @CreepySkeleton on 2020-07-24 03:25</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dimo414">@dimo414</a> on 2021-02-05 08:05</div>
            <div class="timeline-body"><p>I was bitten by this issue myself while trying to add ArgRequiredElseHelp to a CLI. It's wholly unintuitive - both to the user and the developer - that the use of default values would be considered sufficient to bypass this check.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone "3.1" by @pksunkara on 2021-02-05 08:55</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../epage/clapng/issues/96.html">epage/clapng#96</a> on 2021-12-06 17:35</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Removed from milestone "3.1" by @epage on 2021-12-09 18:35</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">A-validators</span> added by @epage on 2021-12-09 18:36</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">C-bug</span> added by @epage on 2021-12-09 18:36</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">E-medium</span> added by @epage on 2021-12-09 18:36</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2021-12-09 18:36</div>
            <div class="timeline-body"><p>See issues linked from #3076 for other default handling issues.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone "3.x" by @epage on 2022-01-04 13:48</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Removed from milestone "3.x" by @epage on 2022-02-02 19:50</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone "3.1" by @epage on 2022-02-02 19:50</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/3421.html">clap-rs/clap#3421</a> on 2022-02-08 19:00</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @epage on 2022-02-08 20:23</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 12:31:40 UTC
    </footer>
</body>
</html>
