```yaml
number: 1142
title: Redundant code in Zsh completion when there are no subcommands
type: issue
state: closed
author: segevfiner
labels:
  - C-enhancement
  - A-completion
assignees: []
created_at: 2018-01-06T12:42:08Z
updated_at: 2018-08-02T03:30:16Z
url: https://github.com/clap-rs/clap/issues/1142
synced_at: 2026-01-10T01:57:42Z
```

# Redundant code in Zsh completion when there are no subcommands

---

_Issue opened by @segevfiner on 2018-01-06 12:42_

<!--
Please use the following template to assist with creating an issue and to ensure a speedy resolution. If an area is not applicable, feel free to delete the area or mark with `N/A`
-->

### Rust Version

`rustc 1.23.0 (766bd11c8 2018-01-01)`

### Affected Version of clap

`2.29.0`

### Expected Behavior Summary
There shouldn't be redundant code in the generated Zsh completion code.

### Actual Behavior Summary
There is some redundant code when there are no sub-commands.

**Generated from the sample:**
```zsh
#compdef clap-test

_clap-test() {
    typeset -A opt_args
    local ret=1

    local context curcontext="$curcontext" state line
    _arguments -s -S -C \
'--completions[]' \
'-h[Prints help information]' \
'--help[Prints help information]' \
'-V[Prints version information]' \
'--version[Prints version information]' \
&& ret=0
    
}

(( $+functions[_clap-test_commands] )) ||
_clap-test_commands() {
    local commands; commands=(
        
    )
    _describe -t commands 'clap-test commands' commands "$@"
}
(( $+functions[_clap-test_commands] )) ||
_clap-test_commands() {
    local commands; commands=(
        
    )
    _describe -t commands 'clap-test commands' commands "$@"
}

_clap-test "$@"
```

Notice the double `_clap-test_commands` part.

### Steps to Reproduce the issue
1. Build the sample.
2. Run `cargo run -- --completions`.
3. Check the output.

### Sample Code or Link to Sample Code
```rust
extern crate clap;

use std::io;
use clap::{App, Arg, Shell};

fn build_cli() -> App<'static, 'static> {
    App::new("clap-test")
        .arg(Arg::with_name("completions")
            .long("completions"))
}

fn main() {
    let matches = build_cli().get_matches();

    if matches.is_present("completions") {
        build_cli().gen_completions_to("clap-test", Shell::Zsh, &mut io::stdout())
    }
}
```

### Debug output
[clap-debug.txt](https://github.com/kbknapp/clap-rs/files/1608772/clap-debug.txt)


---

_Comment by @kbknapp on 2018-01-09 18:01_

@segevfiner since you're already on a roll for these completions PRs, do you want to take a swing at this one? :smile: 

---

_Label `T: enhancement` added by @kbknapp on 2018-01-09 18:01_

---

_Label `D: intermediate` added by @kbknapp on 2018-01-09 18:01_

---

_Label `P3: want to have` added by @kbknapp on 2018-01-09 18:01_

---

_Label `C: completion gen` added by @kbknapp on 2018-01-09 18:01_

---

_Comment by @segevfiner on 2018-01-10 05:58_

I probaby will ðŸ˜‰ 

---

_Referenced in [clap-rs/clap#1144](../../clap-rs/clap/pulls/1144.md) on 2018-01-10 18:36_

---

_Closed by @kbknapp on 2018-01-15 16:51_

---
