<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Error message APIs for `TypedValueParser` - clap-rs/clap #5065</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Error message APIs for <code>TypedValueParser</code></h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/clap-rs/clap/issues/5065">#5065</a>
        opened by <a href="https://github.com/9999years">@9999years</a>
        on 2023-08-03 22:50
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/9999years">@9999years</a></div>
            <div class="timeline-body"><h2>Clap Version</h2>
<p>4.3.19</p>
<h2>Describe your use case</h2>
<p>I'm implementing <code>TypedValueParser</code> and <code>ValueParserFactory</code> so that I can use <code>clap</code> to parse custom types, ideally without explicitly annotating the <code>value_parser</code> to use (most recently I'm using <a href="https://docs.rs/humantime/latest/humantime/fn.parse_duration.html"><code>humantime::parse_duration</code></a> to parse a string like <code>500ms</code> into a <code>Duration</code> value, but I have a few different implementations).</p>
<p>However, I've noticed that the error messages I return from <code>TypedValueParser::parse_ref</code> don't include the context, like when I use a function as a <code>value_parser</code>. This ultimately goes back to the fact that there's no public method on <code>clap::Error</code> to set the inner <code>source</code> error. For example, the <code>Error::raw</code> constructor sets a string message (which is not integrated into context added with <code>Error::insert</code> when formatting):</p>
<p>https://github.com/clap-rs/clap/blob/ca855c651c4fbd89accc40b20d442967f1e79942/clap_builder/src/error/mod.rs#L89</p>
<p>We can see that the (private) <code>Error::value_validation</code> constructor calls the (private) <code>Error::set_source</code> method to set the source:</p>
<p>https://github.com/clap-rs/clap/blob/ca855c651c4fbd89accc40b20d442967f1e79942/clap_builder/src/error/mod.rs#L637</p>
<p>And indeed, all of the <code>TypedValueParser</code> implementations use this and other private methods to construct their errors:</p>
<p>https://github.com/clap-rs/clap/blob/ca855c651c4fbd89accc40b20d442967f1e79942/clap_builder/src/builder/value_parser.rs#L860</p>
<p>Here's an example showing how context information is ignored in <code>clap::Error</code>'s public APIs today, and how exporting <code>Error::set_source</code> would let users construct error messages in the same style as clap's internal <code>TypedValueParser</code> implementations:</p>
<pre><code class="language-rust">use clap::Command;
use clap::Error;
use clap::error::ErrorKind;
use clap::error::ContextKind;
use clap::error::ContextValue;

// Add context and a command to an error.
fn add_context(mut err: Error) -&gt; Error {
    err.insert(ContextKind::InvalidArg, ContextValue::String(&quot;--duration&quot;.into()));
    err.insert(ContextKind::InvalidValue, ContextValue::String(&quot;0.5sec&quot;.into()));
    err.with_cmd(&amp;Command::new(&quot;my-command&quot;))
}

// Here's what's possible with clap today.
// Note how even though we add context and a command to the error message, it's
// ignored when we display the error message:
let err = Error::raw(
    ErrorKind::ValueValidation,
    &quot;Decimals are not supported in durations&quot;
);
assert_eq!(
    add_context(err).to_string(),
    &quot;error: Decimals are not supported in durations&quot;
);

// If `Error::set_source` was public, you could use it to preserve the context
// information and format error messages in the same style that clap's provided
// `TypedValueParser`s use.
//
// Note how this example includes the context information (the argument and
// value, as well as the help command).
let mut err = Error::new(ErrorKind::ValueValidation)
    .set_source(&quot;Decimals are not supported in durations&quot;.into());
assert_eq!(
    add_context(err).to_string(),
    &quot;error: invalid value '0.5sec' for '--duration': \
    Decimals are not supported in durations\n\n\
    For more information, try '--help'.\n&quot;
);
</code></pre>
<h2>Describe the solution you'd like</h2>
<p>The easiest and smallest-footprint solution would be to simply make the existing <code>Error::set_source</code> method public.</p>
<p>When searching for relevant discussions and issues I happened upon #4362, which suggests using <code>TypedValueParser::try_map</code>. Unfortunately, this is not suitable for <code>ValueParserFactory</code> implementations that automatically register a <code>TypedValueParser</code> for a given type, as the <code>TryMapValueParser</code> type returned from <code>try_map</code> is not public. I've made this type public in #5066.</p>
<h2>Alternatives, if applicable</h2>
<p>There's several other <code>Error</code> constructors that would be useful to make public for <code>TypedValueParser</code> implementers:</p>
<ul>
<li><code>Error::empty_value</code></li>
<li><code>Error::invalid_value</code></li>
<li><code>Error::value_validation</code></li>
</ul>
<p>Making these public would obviate most of the need for making <code>Error::set_source</code> public, or we could provide them separately as helper functions.</p>
<p>Additionally, we might consider updating the <code>clap::Error</code> constructors to take an <code>Option&lt;&amp;clap::Arg&gt;</code> instead of a <code>String</code> as well, because currently ~~most~~ all of the use-sites do this:</p>
<p>https://github.com/clap-rs/clap/blob/ca855c651c4fbd89accc40b20d442967f1e79942/clap_builder/src/builder/value_parser.rs#L857-L860</p>
<p>I've implemented this (along with tests and documentation) in #5067, but I'm open to alternatives if anyone has other ideas.</p>
<h2>Additional Context</h2>
<p>I'm using <code>clap</code> for a project where I implement <code>TypedValueParser</code> and <code>ValueParserFactory</code> for several types. Most recently I used <a href="https://docs.rs/humantime/latest/humantime/fn.parse_duration.html"><code>humantime::parse_duration</code></a> to parse a string like <code>500ms</code> into a <code>Duration</code> value:</p>
<details><summary><code>DurationValueParser</code> code</summary>

<pre><code class="language-rust">use std::time::Duration;

use clap::builder::StringValueParser;
use clap::builder::TypedValueParser;
use clap::builder::ValueParserFactory;
use humantime::DurationError;
use miette::LabeledSpan;
use miette::MietteDiagnostic;
use miette::Report;

/// Adapter for parsing [`Duration`] with a [`clap::builder::Arg::value_parser`].
#[derive(Default, Clone)]
pub struct DurationValueParser {
    inner: StringValueParser,
}

impl TypedValueParser for DurationValueParser {
    type Value = Duration;

    fn parse_ref(
        &amp;self,
        cmd: &amp;clap::Command,
        arg: Option&lt;&amp;clap::Arg&gt;,
        value: &amp;std::ffi::OsStr,
    ) -&gt; Result&lt;Self::Value, clap::Error&gt; {
        self.inner.parse_ref(cmd, arg, value).and_then(|str_value| {
            humantime::parse_duration(&amp;str_value).map_err(|err| {
                let diagnostic = Report::new(MietteDiagnostic {
                    // ...
                })
                .with_source_code(str_value);
                clap::Error::raw(
                    clap::error::ErrorKind::ValueValidation,
                    format!(&quot;{diagnostic:?}&quot;),
                )
                .with_cmd(cmd)
            })
        })
    }
}

struct DurationValueParserFactory;

impl ValueParserFactory for DurationValueParserFactory {
    type Parser = DurationValueParser;

    fn value_parser() -&gt; Self::Parser {
        Self::Parser::default()
    }
}
</code></pre>
</details>

<p>This works OK, but when I tested it I noticed that the error messages don't include any context, like which argument failed to validate:</p>
<pre><code class="language-ShellSession">$ ./target/release/my-bin --duration 0.5s
error:   × Invalid character
   ╭────
 1 │ 0.5s
   ·  ┬
   ·  ╰── Invalid character
   ╰────
  help: Decimals are not supported
</code></pre>
<p>In contrast, when an argument fails to validate for an <code>EnumValue</code> I get a nice error message that shows which argument failed and gives a short grammar snippet:</p>
<pre><code class="language-ShellSession">$ ./target/release/my-bin --backtrace bad_value
error: invalid value 'bad_value' for '--backtrace &lt;BACKTRACE&gt;'
  [possible values: 0, 1, full]

For more information, try '--help'.
</code></pre>
<p>We should make it possible for <code>TypedValueParser</code> implementers to create the same error messages that clap's internal <code>TypedValueParser</code> implementations take advantage of.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/5066.html">clap-rs/clap#5066</a> on 2023-08-03 22:52</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/5067.html">clap-rs/clap#5067</a> on 2023-08-03 23:33</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2023-08-04 01:06</div>
            <div class="timeline-body"><p>This issue jumps straight for solutions but to understand them, I need to understand your problems.  For example, what problem is trying to be solved with <code>TryMapValueParser</code> that can't be solved with <code>try_map</code>?  This would be covered when using the standard issue template</p>
<p>EDIT: I see that information was provided further on.  Howeverr, my time for working with these issues is limited.    Before we move forward, I would ask to switch this to the issue template.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/9999years">@9999years</a> on 2023-08-04 02:05</div>
            <div class="timeline-body"><p>Okay, I've rewritten my issue using the feature request template. Let me know if you'd like more information. The solution here feels very obvious to me — the code is already written, just not exported for third parties to use — but I'm open to other designs.</p>
<blockquote>
<p>What problem is trying to be solved with <code>TryMapValueParser</code> that can't be solved with <code>try_map</code>?</p>
</blockquote>
<p><code>try_map</code> is of limited utility in its current state because it can't be referenced in a <code>ValueParserFactory</code> implementation:</p>
<pre><code class="language-rust">struct MyValueParserFactory;

impl ValueParserFactory for MyValueParserFactory {
    // Can't write this because `TryMapValueParser` isn't public!
    type Parser = TryMapValueParser&lt;...&gt;;

    fn value_parser() -&gt; Self::Parser {
        StringValueParser::new().try_map(...)
    }
}
</code></pre>
<p><code>TryMapValueParser</code> <em>is</em> actually public in <code>value_parser.rs</code>, but <code>value_parser.rs</code> isn't public and <code>TryMapValueParser</code> isn't exported from <code>clap::builder</code>, which makes me suspect that it was intended to be made public but for whatever reason it never got exported (it's a little weird that the private-type-in-public-API check doesn't trigger on the <code>try_map</code> declaration).</p>
<p>https://github.com/clap-rs/clap/blob/ca855c651c4fbd89accc40b20d442967f1e79942/clap_builder/src/builder/value_parser.rs#L2037</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2023-08-08 01:00</div>
            <div class="timeline-body"><blockquote>
<p>try_map is of limited utility in its current state because it can't be referenced in a ValueParserFactory implementation:</p>
</blockquote>
<p>Technically, you could still use <code>TryMapValueParser</code> but its a pain.  I'm fine moving forward with #5066.  In general, I would recommend a solution to use <code>TryMapValueParser</code>.</p>
<p>I'm also fine moving forward with <code>set_source</code> as that is a gap in our API for dealing manually constructing errors.</p>
<p>However, I do not want to move make the constructors public.  That is a lot larger of a scope of an under taking and there is a lot more of the details that could evolve / change over time that I don't want to limit ourselves in how we evolve them; that is the point of the more general manual error construction API.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">C-enhancement</span> added by @epage on 2023-08-08 01:00</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">A-builder</span> added by @epage on 2023-08-08 01:00</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">E-easy</span> added by @epage on 2023-08-08 01:00</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2023-08-08 01:01</div>
            <div class="timeline-body"><p>btw #5066 said it was only a partial fix.  What is missing?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2023-08-08 01:01</div>
            <div class="timeline-body"><p>btw thank you for taking the time to communicate all of this; it was a big help to have things focusing on the core of the issue</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/9999years">@9999years</a> on 2023-08-08 03:51</div>
            <div class="timeline-body"><blockquote>
<p>btw #5066 said it was only a partial fix. What is missing?</p>
</blockquote>
<p>Nothing is missing for <code>TryMapValueParser</code>, but #5066 is only a partial fix for this issue — to me, the key feature is <code>Error::set_source</code>, which will bring user-defined <code>TypedValueParser</code>s and <code>ValueParserFactory</code>s up to parity with the built-in <code>TypedValueParser</code>s.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dacut">@dacut</a> on 2023-08-17 17:21</div>
            <div class="timeline-body"><p>I was curious if <a href="https://docs.rs/clap/latest/clap/struct.Command.html#method.error"><code>Command::error</code></a> should be used here, since <code>TypedValueParser::parse_ref()</code> has <code>&amp;Command</code> available. However, the signature doesn't work out: <code>Command:error()</code> wants <code>&amp;mut self</code> (i.e. <code>&amp;mut Command</code>) for some reason, which seems peculiar to me.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2023-08-17 17:50</div>
            <div class="timeline-body"><blockquote>
<p>However, the signature doesn't work out: Command:error() wants &amp;mut self (i.e. &amp;mut Command) for some reason, which seems peculiar to me.</p>
</blockquote>
<p>That is because <code>Command::error</code> requires the <code>Command</code> to be built which for most cases isn't guaranteed, so we build it if needed.  #2911 is for tracking how we could improve things generally.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/5288.html">clap-rs/clap#5288</a> on 2024-01-08 13:34</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Kobzol">@Kobzol</a> on 2025-08-28 08:53</div>
            <div class="timeline-body"><p>Ran into this today. I want to implement a <code>TypedValueParser</code> that can parse either <code>all</code>, <code>none</code> or a list of comma-separated values from a <code>ValueEnum</code>. So I implemented the custom <code>parse_ref</code> function, but the errors that are generated with <code>Error::new/raw</code> lack the context of the executed command. I can't style the error because it requires a mutable access to <code>Command</code>, and I can't use the more advanced <code>Error</code> constructors from <code>clap</code> as they are not public.</p>
<p>I managed to resolve it by cloning the Command though. Not the prettiest option, but works:</p>
<pre><code class="language-rust">return Err(Error::raw(ErrorKind::InvalidValue, error).format(&amp;mut cmd.clone()))
</code></pre>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:49:10 UTC
    </footer>
</body>
</html>
