<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>clap_complete: subcommands are broken in bash if the binary name is not the same as the package name - clap-rs/clap #5255</title>
    <link rel="stylesheet" href="../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../index.html">Back to index</a>
    </div>

    <h1>clap_complete: subcommands are broken in bash if the binary name is not the same as the package name</h1>

    <div class="meta">
        <span class="state state-closed">Closed</span>
        <a href="https://github.com/clap-rs/clap/issues/5255">#5255</a>
        opened by <a href="https://github.com/Serock3">@Serock3</a>
        on 2023-12-13 16:46
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/Serock3">@Serock3</a> on 2023-12-13 16:46</div>
            <div class="timeline-body"><h3>Please complete the following tasks</h3>
<ul>
<li>[X] I have searched the <a href="https://github.com/clap-rs/clap/discussions">discussions</a></li>
<li>[X] I have searched the <a href="https://github.com/clap-rs/clap/issues">open</a> and <a href="https://github.com/clap-rs/clap/issues?q=is%3Aissue+label%3AS-wont-fix+is%3Aclosed">rejected</a> issues</li>
</ul>
<h3>Rust Version</h3>
<p>rustc -V</p>
<h3>Clap Version</h3>
<p>4.4.11</p>
<h3>Minimal reproducible code</h3>
<p>Cargo.toml</p>
<pre><code class="language-toml">[package]
name = &quot;package-name&quot;
version = &quot;0.1.0&quot;
edition = &quot;2021&quot;

[[bin]]
name = &quot;bin-name&quot;
path = &quot;src/main.rs&quot;

# See more keys and their definitions at https://doc.rust-lang.org/cargo/reference/manifest.html

[dependencies]
clap = { version = &quot;4.4.11&quot;, features = [&quot;derive&quot;] }
clap_complete = { version = &quot;4.4.4&quot;}
</code></pre>
<p>main.rs</p>
<pre><code class="language-rust">use clap::{Parser, Subcommand};
use clap_complete::Shell;

pub const BIN_NAME: &amp;str = env!(&quot;CARGO_BIN_NAME&quot;);

#[derive(Debug, Parser)]
enum Cli {
    #[clap(subcommand)]
    Command(MySubcommand),
    ShellCompletions,
}

#[derive(Subcommand, Debug)]
enum MySubcommand {
    Get,
    Set,
}

fn main() {
    match Cli::parse() {
        Cli::Command(sub) =&gt; match sub {
            MySubcommand::Get =&gt; println!(&quot;get&quot;),
            MySubcommand::Set =&gt; println!(&quot;set&quot;),
        },
        Cli::ShellCompletions =&gt; {
            println!(&quot;Generating completions&quot;);
            use clap::CommandFactory;

            clap_complete::generate_to(Shell::Bash, &amp;mut Cli::command(), BIN_NAME, &quot;./&quot;)
                .unwrap();
        }
    }
}

</code></pre>
<h3>Steps to reproduce the bug with the above code</h3>
<pre><code class="language-bash">cargo run -- shell-completions

# Install completions
sudo cp bin-name.bash /usr/share/bash-completion/completions/bin-name
sudo cp target/debug/bin-name /usr/bin/
sudo chmod +x /usr/bin/bin-name
</code></pre>
<p>There will be no completions for the <code>get</code> or <code>set</code> subcommands when typing <code>bin-name command</code> and pressing tab.</p>
<h3>Actual Behaviour</h3>
<p>The completion file will refer to the package name for subcommands.  Completions for top level commands will still use the binary name, hence the user will only get top level completions.</p>
<pre><code class="language-bash">...
    for i in ${COMP_WORDS[@]}
    do
        case &quot;${cmd},${i}&quot; in
            &quot;,$1&quot;)
                cmd=&quot;bin__name&quot;
                ;;
            package__name,command)
                cmd=&quot;package__name__command&quot;
                ;;
            package__name,help)
                cmd=&quot;package__name__help&quot;
                ;;
            package__name,shell-completions)
                cmd=&quot;package__name__shell__completions&quot;
                ;;
            package__name__command,get)
                cmd=&quot;package__name__command__get&quot;
...
</code></pre>
<h3>Expected Behaviour</h3>
<p>The correct completion file looks like this:</p>
<pre><code class="language-bash">...
    for i in ${COMP_WORDS[@]}
    do
        case &quot;${cmd},${i}&quot; in
            &quot;,$1&quot;)
                cmd=&quot;bin__name&quot;
                ;;
            bin__name,command)
                cmd=&quot;bin__name__command&quot;
                ;;
            bin__name,help)
                cmd=&quot;bin__name__help&quot;
                ;;
            bin__name,shell-completions)
                cmd=&quot;bin__name__shell__completions&quot;
                ;;
            bin__name__command,get)
                cmd=&quot;bin__name__command__get&quot;
...
</code></pre>
<p>Installing that file will generate completions for e.g. <code>bin-name command get</code> .</p>
<h3>Additional Context</h3>
<p><em>No response</em></p>
<h3>Debug Output</h3>
<p><em>No response</em></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">C-bug</span> added by @Serock3 on 2023-12-13 16:46</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/5256.html">clap-rs/clap#5256</a> on 2023-12-13 16:46</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "Completions for subcommands are broken in bash if the binary name is not the same as the package name" to "clap_complete: subcommands are broken in bash if the binary name is not the same as the package name" by @Serock3 on 2023-12-14 08:17</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @epage on 2024-01-19 16:45</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../mullvad/mullvadvpn-app/pulls/5710.html">mullvad/mullvadvpn-app#5710</a> on 2024-01-22 09:26</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:28:34 UTC
    </footer>
</body>
</html>
