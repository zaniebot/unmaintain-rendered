<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>clap_complete: subcommands are broken in bash if the binary name is not the same as the package name - clap-rs/clap #5255</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>clap_complete: subcommands are broken in bash if the binary name is not the same as the package name</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/clap-rs/clap/issues/5255">#5255</a>
        opened by <a href="https://github.com/Serock3">@Serock3</a>
        on 2023-12-13 16:46
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Serock3">@Serock3</a></div>
            <div class="timeline-body">Please complete the following tasks
<ul>
<li>[X] I have searched the <a href="https://github.com/clap-rs/clap/discussions">discussions</a></li>
<li>[X] I have searched the <a href="https://github.com/clap-rs/clap/issues">open</a> and <a href="https://github.com/clap-rs/clap/issues?q=is%3Aissue+label%3AS-wont-fix+is%3Aclosed">rejected</a> issues</li>
</ul>
Rust Version
<p>rustc -V</p>
Clap Version
<p>4.4.11</p>
Minimal reproducible code
<p>Cargo.toml</p>
<pre><code>[package]
name = &quot;package-name&quot;
version = &quot;0.1.0&quot;
edition = &quot;2021&quot;

[[bin]]
name = &quot;bin-name&quot;
path = &quot;src/main.rs&quot;

# See more keys and their definitions at https://doc.rust-lang.org/cargo/reference/manifest.html

[dependencies]
clap = { version = &quot;4.4.11&quot;, features = [&quot;derive&quot;] }
clap_complete = { version = &quot;4.4.4&quot;}
</code></pre>
<p>main.rs</p>
<pre><code>use clap::{Parser, Subcommand};
use clap_complete::Shell;

pub const BIN_NAME: &amp;str = env!(&quot;CARGO_BIN_NAME&quot;);

#[derive(Debug, Parser)]
enum Cli {
    #[clap(subcommand)]
    Command(MySubcommand),
    ShellCompletions,
}

#[derive(Subcommand, Debug)]
enum MySubcommand {
    Get,
    Set,
}

fn main() {
    match Cli::parse() {
        Cli::Command(sub) =&gt; match sub {
            MySubcommand::Get =&gt; println!(&quot;get&quot;),
            MySubcommand::Set =&gt; println!(&quot;set&quot;),
        },
        Cli::ShellCompletions =&gt; {
            println!(&quot;Generating completions&quot;);
            use clap::CommandFactory;

            clap_complete::generate_to(Shell::Bash, &amp;mut Cli::command(), BIN_NAME, &quot;./&quot;)
                .unwrap();
        }
    }
}

</code></pre>
Steps to reproduce the bug with the above code
<pre><code>cargo run -- shell-completions

# Install completions
sudo cp bin-name.bash /usr/share/bash-completion/completions/bin-name
sudo cp target/debug/bin-name /usr/bin/
sudo chmod +x /usr/bin/bin-name
</code></pre>
<p>There will be no completions for the <code>get</code> or <code>set</code> subcommands when typing <code>bin-name command</code> and pressing tab.</p>
Actual Behaviour
<p>The completion file will refer to the package name for subcommands.  Completions for top level commands will still use the binary name, hence the user will only get top level completions.</p>
<pre><code>...
    for i in ${COMP_WORDS[@]}
    do
        case &quot;${cmd},${i}&quot; in
            &quot;,$1&quot;)
                cmd=&quot;bin__name&quot;
                ;;
            package__name,command)
                cmd=&quot;package__name__command&quot;
                ;;
            package__name,help)
                cmd=&quot;package__name__help&quot;
                ;;
            package__name,shell-completions)
                cmd=&quot;package__name__shell__completions&quot;
                ;;
            package__name__command,get)
                cmd=&quot;package__name__command__get&quot;
...
</code></pre>
Expected Behaviour
<p>The correct completion file looks like this:</p>
<pre><code>...
    for i in ${COMP_WORDS[@]}
    do
        case &quot;${cmd},${i}&quot; in
            &quot;,$1&quot;)
                cmd=&quot;bin__name&quot;
                ;;
            bin__name,command)
                cmd=&quot;bin__name__command&quot;
                ;;
            bin__name,help)
                cmd=&quot;bin__name__help&quot;
                ;;
            bin__name,shell-completions)
                cmd=&quot;bin__name__shell__completions&quot;
                ;;
            bin__name__command,get)
                cmd=&quot;bin__name__command__get&quot;
...
</code></pre>
<p>Installing that file will generate completions for e.g. <code>bin-name command get</code> .</p>
Additional Context
<p><em>No response</em></p>
Debug Output
<p><em>No response</em></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">C-bug</span> added by <a href="https://github.com/Serock3">@Serock3</a> on 2023-12-13 16:46</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a>clap-rs/clap#5256</a> on 2023-12-13 16:46</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from &quot;Completions for subcommands are broken in bash if the binary name is not the same as the package name&quot; to &quot;clap_complete: subcommands are broken in bash if the binary name is not the same as the package name&quot; by <a href="https://github.com/Serock3">@Serock3</a> on 2023-12-14 08:17</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/epage">@epage</a> on 2024-01-19 16:45</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a>mullvad/mullvadvpn-app#5710</a> on 2024-01-22 09:26</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 20:00:01 UTC
    </footer>
</body>
</html>
