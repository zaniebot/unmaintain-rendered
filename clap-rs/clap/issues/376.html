<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Auto generate bash completions - clap-rs/clap #376</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Auto generate bash completions</h1>

    <div class="meta">
        <span class="state state-closed">Closed</span>
        <a href="https://github.com/clap-rs/clap/issues/376">#376</a>
        opened by <a href="https://github.com/kbknapp">@kbknapp</a>
        on 2016-01-09 18:51
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/kbknapp">@kbknapp</a> on 2016-01-09 18:51</div>
            <div class="timeline-body"><p>Thanks to @kamalmarhubi for reminding me about this and making some suggestions.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">T: new feature</span> added by @kbknapp on 2016-01-09 18:51</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">P4: nice to have</span> added by @kbknapp on 2016-01-09 18:51</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">D: intermediate</span> added by @kbknapp on 2016-01-09 18:51</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">W: 1.x</span> added by @kbknapp on 2016-01-09 18:51</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/kamalmarhubi">@kamalmarhubi</a> on 2016-01-09 18:54</div>
            <div class="timeline-body"><p>Copying comments over:
@kamalmarhubi (<a href="https://github.com/kbknapp/clap-rs/issues/259#issuecomment-169474729">original comment</a>)</p>
<blockquote>
<p>Is this in the feature list? I just started using clap, and the structure seems very amenable to allowing completion. Though rather than generating an auto-completion file, I had been thinking of a special completion mode enabled by flag or env var. Completion mode would take a partial command line and offer a list of completions. The benefit is that the program can use runtime information to complete values for some args, eg drawing values out of a database.</p>
<p>Either way, I think it's a really worthwhile feature.</p>
</blockquote>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/kamalmarhubi">@kamalmarhubi</a> on 2016-01-09 18:54</div>
            <div class="timeline-body"><p>@kbknapp (<a href="https://github.com/kbknapp/clap-rs/issues/259#issuecomment-170269151">original comment</a>)</p>
<blockquote>
<p>Yes it is....although I have created anew issue to track it since it's just been on the back burner. I've thought about doing like you said but what I'm leary of is including that functionality unconditionally in programs that don't need or care about it. Perhaps only compiling in that functionality only in debug mode? I need to think on this and am open to all suggestions :)</p>
</blockquote>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sru">@sru</a> on 2016-01-09 19:14</div>
            <div class="timeline-body"><p>@kamalmarhubi I am quite confused on the &quot;completion mode&quot; that you speak of. AFAIK, shells (bash, zsh...) cannot get runtime information of programs that are not yet run. They do completion by predefined completion functions. For example, <a href="https://github.com/git/git/blob/master/contrib/completion/git-completion.bash">here is bash completion for git</a>.</p>
<p>@kbknapp Since generating completion file is one time process, it'd be more appropriate if we could do it on compile time. Nobody wants an overhead of generating completion file every time a program is run ;)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/kamalmarhubi">@kamalmarhubi</a> on 2016-01-09 19:25</div>
            <div class="timeline-body"><blockquote>
<p>I'm leary of is including that functionality unconditionally in programs that don't need or care about it. Perhaps only compiling in that functionality only in debug mode? I need to think on this and am open to all suggestions :)</p>
</blockquote>
<p>I have no idea how they work or if they're appropriate, but it sounds like a possible use for <a href="http://doc.crates.io/manifest.html#the-features-section">features</a> in the <code>Cargo.toml</code>. Disabled by default, and downstream binaries can enable it by specifying a <code>[dependencies.clap]</code> section:</p>
<pre><code>[dependencies.clap]
version = &quot;2&quot;
features = [&quot;completions&quot;]
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/kamalmarhubi">@kamalmarhubi</a> on 2016-01-09 19:27</div>
            <div class="timeline-body"><p>@sru: note that the completion file calls <code>git</code> multiple times to construct completions. I'm suggesting that a completion file for a Clap app could call the app itself with a special mode.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/kamalmarhubi">@kamalmarhubi</a> on 2016-01-10 02:57</div>
            <div class="timeline-body"><p>Equivalents from a few other languages' ecosystems:</p>
<ul>
<li>cobra (go): https://github.com/spf13/cobra/blob/master/bash_completions.md</li>
<li>click (python): http://click.pocoo.org/6/bashcomplete/</li>
<li>yargs (nodejs): https://www.npmjs.com/package/yargs#completioncmd-description-fn</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/kamalmarhubi">@kamalmarhubi</a> on 2016-01-10 04:13</div>
            <div class="timeline-body"><p>I just noticed that clap is already using features for a couple of extras: http://kbknapp.github.io/clap-rs/clap/index.html#optional-dependencies--features</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/kbknapp">@kbknapp</a> on 2016-01-10 08:31</div>
            <div class="timeline-body"><blockquote>
<p>Since generating completion file is one time process, it'd be more appropriate if we could do it on compile time. Nobody wants an overhead of generating completion file every time a program is run ;)</p>
</blockquote>
<p>@sru exactly my point :) Which is kind of my thoughts on either using some sort of syntax extension or the like to generate this at compile time, or <em>potentially</em> allowing this completion to be generated at runtime <strong>only</strong> in via features like @kamalmarhubi mentions. This would allow similar to how we run clippy, just a one time build/run to generate the completions functions, then you build without the feature enabled for actual use.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/RaitoBezarius">@RaitoBezarius</a> on 2016-03-17 16:57</div>
            <div class="timeline-body"><p>Just FYI:</p>
<blockquote>
<p>@kamalmarhubi I am quite confused on the &quot;completion mode&quot; that you speak of. AFAIK, shells (bash, zsh...) cannot get runtime information of programs that are not yet run. They do completion by predefined completion functions. For example, here is bash completion for git.</p>
</blockquote>
<p>fish is theorically able to get the documentation from the manual (<code>man</code>), I wonder if it could constitute a solution (at least for fish which <em>is</em> NON-POSIX -- don't kill me please, I like shiny stuff).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../habitat-sh/habitat/issues/602.html">habitat-sh/habitat#602</a> on 2016-06-01 08:00</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/clux">@clux</a> on 2016-06-03 21:33</div>
            <div class="timeline-body"><p>Hey. So.. I am managing a fairly decent sized clap based app that actually has a custom bash completions script. It wasn't actually to bad to write a completion script for a clap app (though still not something I'd recommend) because clap it has a quite rigid structure in how arguments and subcommands are parsed. I think my current script could have easily been generated by clap provided one or two extra instructions were added to clap.</p>
<p>Sorry for the wall of text.</p>
<h3>Suggested completion algorithm</h3>
<p>The bash side, the part that will be generated and passed to <code>complete -F</code>.</p>
<ol>
<li>if the first argument was the binary name, and the first word after that starts with dash, complete from global flags</li>
<li>if no subcommands exist in app, complete from special completions lists if it exists</li>
<li>if no subcommands have yet been provided in the current arguments, suggest the list of global subcommands</li>
<li>if a subcommand has been given and the next argument starts with a dash, complete from the subcommands' flags</li>
<li>if no subcommands exist under current subcommand, complete from special completions list if it exists</li>
</ol>
<p>And you would iterate 4 and 5 until you are at the bottom of the tree for this. Think this kind of recursion would work. I have a proof of concept up to, but not including this point (recursion), and it feels pretty great.</p>
<p>All the lists mentioned would be compiled into the bash script as variables, or as scripts to be called using extensions:</p>
<h3>Suggested Extensions</h3>
<p>Some choices to be made here to make this work. We could easily allow:</p>
<h4>Static Completions</h4>
<p>Special suggestions could be populated from a list that a user provides to clap.
E.g.:</p>
<pre><code class="language-rust">let args = App::new(&quot;foo&quot;)
    .subcommand(SubCommand::with_name(&quot;fetch&quot;)
        .arg(Arg::with_name(&quot;components&quot;)
          .completions(vec![&quot;yajl&quot;, &quot;zlib&quot;])))
</code></pre>
<p>which would be nice, easy to implement (just dump the list straight into the completion script as a variable), but it's not very flexible.</p>
<h4>Dynamic Completions</h4>
<p>A dynamic option would be more useful if if the list is dependent on some outside state that needs IO to verify. E.g., if a command like <code>fetch</code> needs to look up against a networked registry, or some local database / yaml file / directory structure.</p>
<p>I can see two options from clap's side that could provide this:</p>
<h5>1. Inline bash</h5>
<p>Easy to implement (just dump the function straight into the completion script to be eval'd), but it's not a particularly elegant solution.</p>
<pre><code class="language-rust">let args = App::new(&quot;foo&quot;)
    .subcommand(SubCommand::with_name(&quot;fetch&quot;)
        .arg(Arg::with_name(&quot;components&quot;)
            .completer(&quot;find ~/.foo/cache/ -maxdepth 1 -mindepth 1 -type d -printf \&quot;%f \&quot;&quot;)
</code></pre>
<h5>2. Allow custom functions</h5>
<p>Allow completer functions that do some computation or IO:</p>
<pre><code class="language-rust">fn fetch_completer() -&gt; Result&lt;(), Vec&lt;String&gt;&gt; {
    // provide a list from some IO operation
}

let args = App::new(&quot;foo&quot;)
    .subcommand(SubCommand::with_name(&quot;fetch&quot;)
        .arg(Arg::with_name(&quot;components&quot;)
            .completer(fetch_completer)
</code></pre>
<p>clap could then expose that function secretly as a hidden subcommand, say <code>foo __fetch_suggestions</code>, which could be eval'd in the generated completion script at the appropriate time in the algorithm.</p>
<h4>----</h4>
<p>In my current app, I am kind of using a combination of the two already:</p>
<ul>
<li>bash functions to do computation/io</li>
<li>suggestion functions listed in <code>main.rs</code> as proper clap subcommands (but would like to hide these).</li>
</ul>
<h2>----</h2>
<p>So.. Does this approach seem sensible? Anyone see better approaches?
I'd be willing to have a go trying to implement something like this in clap if there's interest.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/kbknapp">@kbknapp</a> on 2016-06-04 02:20</div>
            <div class="timeline-body"><p>Excellent! Thanks for taking the time to put all this together! I'm still on vacation for the next two days, but let me do some looking into this and I'll post back here with what I find. I'd be excited if we can get this into <code>clap</code>. Also, I've been working on the 3x branch, so this might get put in with those changes which would allow for a few changes in a breaking manner if need-be, although I'd try to err on the side of non-breaking changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">W: 3.x</span> added by @kbknapp on 2016-06-04 02:20</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">W: 1.x</span> removed by @kbknapp on 2016-06-04 02:20</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/clux">@clux</a> on 2016-06-04 20:01</div>
            <div class="timeline-body"><p>Cool. Enjoy your vacation :)</p>
<p>I have a rough prototype of something working <a href="https://github.com/clux/clap-rs/commit/4465cf7162f6e6c893277aeac30afc9694205a6f">here</a> that maybe you could have a look at when you get back. A very hacky thing, but it gets some basics done.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/kbknapp">@kbknapp</a> on 2016-06-23 04:35</div>
            <div class="timeline-body"><p>I've finally began working on this issue! The method I'm going with uses a build.rs script and outputs a completion file which from initial testing works great even with subcommands and aliases. It's not perfect as it's &quot;dumb&quot; about what positional args are left but as an initial approach I'm happy. Once I do a little more testing and tweaking I'll put in the PR.</p>
<p>Edit, to be clear this also works by only completing on the valid options for each individual subcommand ;)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone "2.7.0" by @kbknapp on 2016-06-23 13:35</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @kbknapp by @kbknapp on 2016-06-23 13:35</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">D: hard</span> added by @kbknapp on 2016-06-23 13:35</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">P3: want to have</span> added by @kbknapp on 2016-06-23 13:35</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">W: 2.x</span> added by @kbknapp on 2016-06-23 13:35</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">D: intermediate</span> removed by @kbknapp on 2016-06-23 13:35</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">P4: nice to have</span> removed by @kbknapp on 2016-06-23 13:35</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">W: 3.x</span> removed by @kbknapp on 2016-06-23 13:35</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/clux">@clux</a> on 2016-06-23 20:05</div>
            <div class="timeline-body"><p>Awesome. I had no idea how to actually generate the completion script without hooking into the arg chain at the very end when it was fully populated. Glad you have found a sensible way.</p>
<p>I'd be happy to test it out and look for some edge cases when you get it in a sensible state :smile:</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/533.html">clap-rs/clap#533</a> on 2016-06-24 00:19</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/kbknapp">@kbknapp</a> on 2016-06-28 14:47</div>
            <div class="timeline-body"><p>I went ahead and put you 2.7.0 since I had limited time to work on this over the past few days. This issue is next in the hopper.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone "2.8.0" by @kbknapp on 2016-06-28 14:48</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Removed from milestone "2.7.0" by @kbknapp on 2016-06-28 14:48</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone "2.9.0" by @kbknapp on 2016-06-30 03:29</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Removed from milestone "2.8.0" by @kbknapp on 2016-06-30 03:29</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/552.html">clap-rs/clap#552</a> on 2016-06-30 08:55</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">C: completion gen</span> added by @kbknapp on 2016-06-30 17:39</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/kbknapp">@kbknapp</a> on 2016-07-01 04:18</div>
            <div class="timeline-body"><p>I just finished implementing this. Putting in the PR now. As a sample, I built <a href="https://github.com/rust-lang-nursery/rustup.rs"><code>rustup</code></a> with this method and here's the <a href="https://gist.github.com/kbknapp/09a37f2fce306573040ea0500e3b1408">generated completion script</a>. I've tested it and it works through all subcommands and arguments. I'm quite happy with it :smile:</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/clux">@clux</a> on 2016-07-01 10:16</div>
            <div class="timeline-body"><p>Very nice. Just tested it on my app and got  400 line bash.sh that works pretty well :+1:</p>
<p>Is there a way to provide dynamic completion values to the script here? E.g. like completor fn above.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/clux">@clux</a> on 2016-07-01 10:28</div>
            <div class="timeline-body"><p>I like how it suggests positional arguments as <code>&lt;argName&gt;..</code> as you will never actually get that into your shell (provided you have at least one flag), but it provides helpful info in the completion list.</p>
<p>Found one issue:
If you type out a subcommand alias instead of the normal subcommand name, then you can't get completions for that subcommand.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/555.html">clap-rs/clap#555</a> on 2016-07-01 11:33</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @homu on 2016-07-01 11:51</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/kbknapp">@kbknapp</a> on 2016-07-01 13:19</div>
            <div class="timeline-body"><p>I plan on adding aliases and possible values next prior to updating on crates.io. There isn't a way to use a completer fn yet, but it should be addable once I have this base system complete.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/556.html">clap-rs/clap#556</a> on 2016-07-01 13:21</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/557.html">clap-rs/clap#557</a> on 2016-07-01 13:24</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/kbknapp">@kbknapp</a> on 2016-07-01 21:27</div>
            <div class="timeline-body"><p>Aliases and possible values are now completable. Once I get home tonight I'll update the version on crates.io</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/kbknapp">@kbknapp</a> on 2016-07-02 02:50</div>
            <div class="timeline-body"><p>For the curious, here's a demo for <code>rustup</code></p>
<p><img src="http://i.imgur.com/icbrIYe.gif" alt="rustup_demo" /></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/568.html">clap-rs/clap#568</a> on 2016-07-04 21:35</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/nerdrew">@nerdrew</a> on 2016-07-21 06:19</div>
            <div class="timeline-body"><p>Are there plans for zsh completion?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../rust-lang/rustup/issues/387.html">rust-lang/rustup#387</a> on 2016-07-21 06:31</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/kbknapp">@kbknapp</a> on 2016-07-23 19:54</div>
            <div class="timeline-body"><p>@nerdrew Yes there are, I just haven't had time to implement it yet. #579 adds Fish support. I'm also open to people submitting a PR for ZSH :wink:</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:35:06 UTC
    </footer>
</body>
</html>
