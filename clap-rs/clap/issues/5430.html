<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clap-generated shell completion failing on macOS /bin/bash with: conditional binary operator expected: syntax error near `IFS' - clap-rs/clap #5430</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Clap-generated shell completion failing on macOS /bin/bash with: conditional binary operator expected: syntax error near `IFS&#x27;</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/clap-rs/clap/issues/5430">#5430</a>
        opened by <a href="https://github.com/gibfahn">@gibfahn</a>
        on 2024-03-26 16:18
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/gibfahn">@gibfahn</a></div>
            <div class="timeline-body">Please complete the following tasks
<ul>
<li>[X] I have searched the <a href="https://github.com/clap-rs/clap/discussions">discussions</a></li>
<li>[X] I have searched the <a href="https://github.com/clap-rs/clap/issues">open</a> and <a href="https://github.com/clap-rs/clap/issues?q=is%3Aissue+label%3AS-wont-fix+is%3Aclosed">rejected</a> issues</li>
</ul>
Rust Version
<pre><code>❯ rustc -V
rustc 1.77.0 (aedd173a2 2024-03-17)
</code></pre>
Clap Version
<p>4.5.3</p>
Minimal reproducible code
<pre><code># Cargo.toml
[package]
name = &quot;my-app&quot;
version = &quot;0.1.0&quot;
edition = &quot;2021&quot;

[dependencies]
clap = { version = &quot;4.5.3&quot;, features = [
  &quot;debug&quot;,
  &quot;derive&quot;,
  &quot;env&quot;,
  &quot;string&quot;,
  &quot;wrap_help&quot;,
] }
clap_complete = &quot;=4.5.1&quot;
</code></pre>
<pre><code>// src/main.rs
use clap::{CommandFactory, Parser, ValueHint};
use clap_complete::{generate, Shell};
use std::path::PathBuf;

#[derive(Parser)]
struct Opt {
    #[arg(short, long, value_hint = ValueHint::FilePath)]
    file: Option&lt;PathBuf&gt;,
}

fn main() {
    generate(
        Shell::Bash,
        &amp;mut Opt::command(),
        &quot;my-app&quot;,
        &amp;mut std::io::stdout(),
    );
}
</code></pre>
Steps to reproduce the bug with the above code
<p>(on a Mac)</p>
<pre><code>cargo run | /bin/bash
</code></pre>
Actual Behaviour
<p>Output:</p>
<pre><code>❯ cargo run | /bin/bash
    Finished dev [unoptimized + debuginfo] target(s) in 0.01s
     Running `target/debug/my-app`
/bin/bash: line 30: conditional binary operator expected
/bin/bash: line 30: syntax error near `IFS&#x27;
/bin/bash: line 30: `                    if [[ -v IFS ]]; then&#x27;
</code></pre>
Expected Behaviour
<p>Output:</p>
<pre><code>❯ cargo run | /bin/bash
    Finished dev [unoptimized + debuginfo] target(s) in 0.01s
     Running `target/debug/my-app`
</code></pre>
Additional Context
<p>On clap_complete 4.4.9 this works, on 4.4.10 this fails. I <em>think</em> that this is a regression introduced by <a href="https://github.com/clap-rs/clap/pull/5336">clap-rs/clap#5336</a> . So the issue is probably the same as <a href="https://github.com/clap-rs/clap/issues/5190">clap-rs/clap#5190</a> , which was fixed by <a href="https://github.com/clap-rs/clap/pull/5278">clap-rs/clap#5278</a>.</p>
Debug Output
<pre><code>[clap_builder::builder::command]Command::_build: name=&quot;my-app&quot;
[clap_builder::builder::command]Command::_propagate:my-app
[clap_builder::builder::command]Command::_check_help_and_version:my-app expand_help_tree=true
[clap_builder::builder::command]Command::long_help_exists
[clap_builder::builder::command]Command::_check_help_and_version: Building default --help
[clap_builder::builder::command]Command::_propagate_global_args:my-app
[clap_builder::builder::debug_asserts]Command::_debug_asserts
[clap_builder::builder::debug_asserts]Arg::_debug_asserts:file
[clap_builder::builder::debug_asserts]Arg::_debug_asserts:help
[clap_builder::builder::debug_asserts]Command::_verify_positionals
[clap_builder::builder::command]Command::_build_bin_names
[ clap_builder::output::usage]Usage::get_required_usage_from: incls=[], matcher=false, incl_last=true
[ clap_builder::output::usage]Usage::get_required_usage_from: unrolled_reqs=[]
[ clap_builder::output::usage]Usage::get_required_usage_from: ret_val=[]
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">C-bug</span> added by <a href="https://github.com/gibfahn">@gibfahn</a> on 2024-03-26 16:18</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2024-03-26 16:29</div>
            <div class="timeline-body"><p>This is happening too often and I&#x27;m tempted to say bash 4 is unsupported until #3166 is the default completion system since that at least reduces the risk we&#x27;ll run into issues.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">A-completion</span> added by <a href="https://github.com/epage">@epage</a> on 2024-03-26 16:29</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">E-medium</span> added by <a href="https://github.com/epage">@epage</a> on 2024-03-26 16:30</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a>clap-rs/clap#5444</a> on 2024-04-07 14:25</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sudotac">@sudotac</a> on 2024-04-07 14:52</div>
            <div class="timeline-body"><p>Sorry for the inconvenience.
I thought <code>-v</code> was already supported on bash 4.0, but actually only available on 5.0 or later.
I submitted #5444 to fix this. Feel free to use it.</p>
<blockquote>
<p>This is happening too often and I&#x27;m tempted to say bash 4 is unsupported until <a href="https://github.com/clap-rs/clap/issues/3166">clap-rs/clap#3166</a> is the default completion system since that at least reduces the risk we&#x27;ll run into issues.</p>
</blockquote>
<p>I agree with it.
This time it&#x27;s easy to fix that, but caring about unsupported features on (very) older versions anytime is generally a hard work.</p>
<p>(By the way, I&#x27;m personally looking forward to native completion system!)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/epage">@epage</a> on 2024-04-09 17:06</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/gibfahn">@gibfahn</a> on 2024-04-17 12:34</div>
            <div class="timeline-body"><p>Thanks for fixing this!</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 20:00:07 UTC
    </footer>
</body>
</html>
