<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>`UnknownArgumentValueParser` can only be used with string value argument - clap-rs/clap #5081</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1><code>UnknownArgumentValueParser</code> can only be used with string value argument</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/clap-rs/clap/issues/5081">#5081</a>
        opened by <a href="https://github.com/weihanglo">@weihanglo</a>
        on 2023-08-19 09:40
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/weihanglo">@weihanglo</a></div>
            <div class="timeline-body">Please complete the following tasks
<ul>
<li>[X] I have searched the <a href="https://github.com/clap-rs/clap/discussions">discussions</a></li>
<li>[X] I have searched the <a href="https://github.com/clap-rs/clap/issues">open</a> and <a href="https://github.com/clap-rs/clap/issues?q=is%3Aissue+label%3AS-wont-fix+is%3Aclosed">rejected</a> issues</li>
</ul>
Rust Version
<p>rustc 1.72.0-beta.11 (7a3a43a3b 2023-08-18)</p>
Clap Version
<p>4.3.23</p>
Minimal reproducible code
<pre><code>#!/usr/bin/env -S cargo +nightly -Zscript

//! ```cargo
//! [dependencies]
//! clap = &quot;=4.3.23&quot;
//! ```

fn main() {
    let args = clap::Command::new(&quot;test&quot;)
        .args([clap::Arg::new(&quot;libtest-ignore&quot;)
            .long(&quot;ignored&quot;)
            .action(clap::ArgAction::SetTrue)
            .value_parser(
                clap::builder::UnknownArgumentValueParser::suggest_arg(&quot;-- --ignored&quot;)
                    .and_suggest(&quot;not much else to say&quot;),
            )
            .hide(true)])
        .get_matches();

    assert!(matches!(
        args.try_get_one::&lt;bool&gt;(&quot;libtest-ignore&quot;),
        Err(clap::parser::MatchesError::Downcast { .. })
    ));

    args.try_get_one::&lt;bool&gt;(&quot;libtest-ignore&quot;).unwrap();
    // thread &#x27;main&#x27; panicked at run.rs:25:48:
    // called `Result::unwrap()` on an `Err` value: Downcast { actual: alloc::string::String, expected: bool }
    // note: run with `RUST_BACKTRACE=1` environment variable to display a backtrace
}
</code></pre>
Steps to reproduce the bug with the above code
<p>Run the script above.</p>
Actual Behaviour
<p>I am not sure if this is expected. It turns out that the unknown argument must be defined as <code>--flag &lt;string&gt;</code>. Might be the result of <code>StringValueParser</code> in use.</p>
<p>Here is the current cargo integration that failed <a href="https://github.com/rust-lang/cargo/pull/12529">rust-lang/cargo#12529</a>.</p>
<p><code>keep-going</code> is <a href="https://github.com/rust-lang/cargo/blob/80eca0e58fb2ff52c1e94fc191b55b37ed73e0e4/src/cargo/util/command_prelude.rs#L586">always evaluated</a> when constructing <code>BuildConfig</code> even it is not a valid argument. Cargo <a href="https://github.com/rust-lang/cargo/blob/80eca0e58fb2ff52c1e94fc191b55b37ed73e0e4/src/cargo/util/command_prelude.rs#L794-L798">provides a default value for unknown argument</a>, which contradicts the definition of <a href="https://github.com/rust-lang/cargo/blob/80eca0e58fb2ff52c1e94fc191b55b37ed73e0e4/src/cargo/util/command_prelude.rs#L433-L435">bool <code>--keep-going</code></a>.</p>
Expected Behaviour
<p><code>UnknownArgumentValueParser</code> can use with any type of argument.</p>
Additional Context
<p>cc #5080</p>
Debug Output
<p><em>No response</em></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">C-bug</span> added by <a href="https://github.com/weihanglo">@weihanglo</a> on 2023-08-19 09:40</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a>rust-lang/cargo#12529</a> on 2023-08-19 09:40</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2023-08-21 16:22</div>
            <div class="timeline-body"><p>I had considered making the it parametrized but thought that might be too complex.</p>
<p>Maybe with a defaulted generic argument it won&#x27;t be too bad and likely won&#x27;t be a breaking change.</p>
<p>Alternatively, cargo could ignore the &quot;invalid type&quot; error since its pattern of reuse is a bit weird in of itself.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2023-08-21 16:27</div>
            <div class="timeline-body"><p>Even though in some circles, a new defaulted generic parameter is not a breaking change, for how <code>UnknownArgumentValueParser</code> is used, it is a breaking change so we can&#x27;t resolve this until clap v5.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">M-breaking-change</span> added by <a href="https://github.com/epage">@epage</a> on 2023-08-21 16:27</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">A-builder</span> added by <a href="https://github.com/epage">@epage</a> on 2023-08-21 16:27</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone &quot;5.0&quot; by <a href="https://github.com/epage">@epage</a> on 2023-08-21 16:27</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:59:53 UTC
    </footer>
</body>
</html>
