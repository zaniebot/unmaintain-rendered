```yaml
number: 2767
title: Different expected exit code with usage of ArgRequiredElseHelp between 3-beta-2 and 3-beta-4
type: issue
state: closed
author: nicolacSNPS
labels:
  - C-bug
assignees: []
created_at: 2021-09-10T16:29:45Z
updated_at: 2021-10-12T21:23:55Z
url: https://github.com/clap-rs/clap/issues/2767
synced_at: 2026-01-10T01:57:45Z
```

# Different expected exit code with usage of ArgRequiredElseHelp between 3-beta-2 and 3-beta-4

---

_Issue opened by @nicolacSNPS on 2021-09-10 16:29_

### Please complete the following tasks

- [X] I have searched the [discussions](https://github.com/clap-rs/clap/discussions)
- [X] I have searched the existing issues

### Rust Version

rustc 1.54.0 (a178d0322 2021-07-26)

### Clap Version

clap 3.0.0-beta.4

### Minimal reproducible code

```rust
use clap::{AppSettings, Clap};

#[derive(Clap)]
#[clap(setting=AppSettings::ArgRequiredElseHelp )]
pub struct Opts {
  pub parameter: String,
}


fn main() {
    let _opts: Opts = Opts::parse();
}
```


### Steps to reproduce the bug with the above code

Put this file into a binary crate (`main.rs`) and then execute it with `cargo run --`, finally print the exit code next with `echo $?`

### Actual Behaviour

The program exit with displaying the help message and an exit code of 0

### Expected Behaviour

Before in beta-2, the program also exit with displaying the help message and a **non-zero** exit code 

### Additional Context

When upgrading to beta4, I noticed that the behavior changed when arguments are missing, this seems to have been caused by the following pull request: https://github.com/clap-rs/clap/pull/2168 and the changes to the function `use_stderr`.

I wasn't really able to find anything on the issues mentioning why this change was made? Why are we now considering an incomplete command that failed to be a scenario where a success code is returned?

By comparing some tools on the CLI: If you type only `rustup`, you will be displayed the help message and then the exit code will be non-zero, but if you type only `cargo`, then the exit code will be a 0 (success). 

So was this an intentional decision? If yes, would it be possible to add some configuration to let the developers decide what do they prefer? 

### Debug Output

For beta2
```
[            clap::build::app]  App::_do_parse
[            clap::build::app]  App::_build
[            clap::build::app]  App::_propagate:hello_world
[            clap::build::app]  App::_derive_display_order:hello_world
[            clap::build::app]  App::_create_help_and_version
[            clap::build::app]  App::_create_help_and_version: Building --help
[            clap::build::app]  App::_create_help_and_version: Building --version
[clap::build::app::debug_asserts]       App::_debug_asserts
[            clap::build::arg]  Arg::_debug_asserts:parameter
[            clap::build::arg]  Arg::_debug_asserts:help
[            clap::build::arg]  Arg::_debug_asserts:version
[         clap::parse::parser]  Parser::get_matches_with
[         clap::parse::parser]  Parser::_build
[         clap::parse::parser]  Parser::_verify_positionals
[         clap::parse::parser]  Parser::remove_overrides
[      clap::parse::validator]  Validator::validate
[         clap::parse::parser]  Parser::add_defaults
[         clap::parse::parser]  Parser::add_defaults:iter:parameter:
[         clap::parse::parser]  Parser::add_value: doesn't have conditional defaults
[         clap::parse::parser]  Parser::add_value:iter:parameter: doesn't have default vals
[         clap::parse::parser]  Parser::color_help
[          clap::output::help]  Help::new
[          clap::output::help]  Help::write_help
[          clap::output::help]  Help::write_templated_help
[          clap::output::help]  Help::write_bin_name
[         clap::output::usage]  Usage::create_usage_no_title
[         clap::output::usage]  Usage::create_help_usage; incl_reqs=true
[         clap::output::usage]  Usage::get_required_usage_from: incls=[], matcher=false, incl_last=false
[         clap::output::usage]  Usage::get_required_usage_from: unrolled_reqs=[parameter]
[         clap::output::usage]  Usage::get_required_usage_from:iter:parameter
[         clap::output::usage]  Usage::get_required_usage_from: ret_val=["<parameter>"]
[         clap::output::usage]  Usage::needs_flags_tag
[         clap::output::usage]  Usage::needs_flags_tag:iter: f=help
[         clap::output::usage]  Usage::needs_flags_tag:iter: f=version
[         clap::output::usage]  Usage::needs_flags_tag: [FLAGS] not required
[         clap::output::usage]  Usage::create_help_usage: usage=hello_world <parameter>
[          clap::output::help]  Help::write_all_args
[          clap::output::help]  should_show_arg: use_long=false, arg=parameter
[          clap::output::help]  Help::write_args_unsorted
[          clap::output::help]  should_show_arg: use_long=false, arg=parameter
[          clap::output::help]  Help::write_arg
[          clap::output::help]  Help::short
[          clap::output::help]  Help::long
[          clap::output::help]  Help::val: arg=parameter
[          clap::output::help]  Help::spec_vals: a=<parameter>
[          clap::output::help]  Help::val: Has switch...
[          clap::output::help]  No, and not next_line
[          clap::output::help]  Help::write_nspaces!: num=4
[          clap::output::help]  Help::help
[          clap::output::help]  Help::help: Next Line...false
[          clap::output::help]  Help::help: Too long...
[          clap::output::help]  No
[          clap::output::help]  Help::write_args
[          clap::output::help]  should_show_arg: use_long=false, arg=help
[          clap::output::help]  Help::write_args: Current Longest...2
[          clap::output::help]  Help::write_args: New Longest...6
[          clap::output::help]  should_show_arg: use_long=false, arg=version
[          clap::output::help]  Help::write_args: Current Longest...6
[          clap::output::help]  Help::write_args: New Longest...9
[          clap::output::help]  Help::write_arg
[          clap::output::help]  Help::short
[          clap::output::help]  Help::long
[          clap::output::help]  Help::val: arg=help
[          clap::output::help]  Help::spec_vals: a=--help
[          clap::output::help]  Help::val: Has switch...
[          clap::output::help]  Yes
[          clap::output::help]  Help::val: force_next_line...false
[          clap::output::help]  Help::val: nlh...false
[          clap::output::help]  Help::val: taken...21
[          clap::output::help]  val: help_width > (width - taken)...23 > (100 - 21)
[          clap::output::help]  Help::val: longest...9
[          clap::output::help]  Help::val: next_line...
[          clap::output::help]  No
[          clap::output::help]  Help::write_nspaces!: num=7
[          clap::output::help]  Help::help
[          clap::output::help]  Help::help: Next Line...false
[          clap::output::help]  Help::help: Too long...
[          clap::output::help]  No
[          clap::output::help]  Help::write_arg
[          clap::output::help]  Help::short
[          clap::output::help]  Help::long
[          clap::output::help]  Help::val: arg=version
[          clap::output::help]  Help::spec_vals: a=--version
[          clap::output::help]  Help::val: Has switch...
[          clap::output::help]  Yes
[          clap::output::help]  Help::val: force_next_line...false
[          clap::output::help]  Help::val: nlh...false
[          clap::output::help]  Help::val: taken...21
[          clap::output::help]  val: help_width > (width - taken)...26 > (100 - 21)
[          clap::output::help]  Help::val: longest...9
[          clap::output::help]  Help::val: next_line...
[          clap::output::help]  No
[          clap::output::help]  Help::write_nspaces!: num=4
[          clap::output::help]  Help::help
[          clap::output::help]  Help::help: Next Line...false
[          clap::output::help]  Help::help: Too long...
[          clap::output::help]  No
[           clap::output::fmt]  is_a_tty: stderr=true
```

For beta4
```
[            clap::build::app]  App::_do_parse
[            clap::build::app]  App::_build
[            clap::build::app]  App::_propagate:hello_world
[            clap::build::app]  App::_check_help_and_version
[            clap::build::app]  App::_propagate_global_args:hello_world
[            clap::build::app]  App::_derive_display_order:hello_world
[clap::build::app::debug_asserts]       App::_debug_asserts
[clap::build::arg::debug_asserts]       Arg::_debug_asserts:help
[clap::build::arg::debug_asserts]       Arg::_debug_asserts:version
[clap::build::arg::debug_asserts]       Arg::_debug_asserts:parameter
[         clap::parse::parser]  Parser::get_matches_with
[         clap::parse::parser]  Parser::_build
[         clap::parse::parser]  Parser::_verify_positionals
[         clap::parse::parser]  Parser::remove_overrides
[      clap::parse::validator]  Validator::validate
[         clap::parse::parser]  Parser::add_env: Checking arg `--help`
[         clap::parse::parser]  Parser::add_env: Checking arg `--version`
[         clap::parse::parser]  Parser::add_env: Checking arg `<PARAMETER>`
[         clap::parse::parser]  Parser::add_defaults
[         clap::parse::parser]  Parser::add_defaults:iter:parameter:
[         clap::parse::parser]  Parser::add_value: doesn't have conditional defaults
[         clap::parse::parser]  Parser::add_value:iter:parameter: doesn't have default vals
[         clap::parse::parser]  Parser::add_value:iter:parameter: doesn't have default missing vals
[         clap::parse::parser]  Parser::color_help
[          clap::output::help]  Help::new
[          clap::output::help]  Help::write_help
[          clap::output::help]  should_show_arg: use_long=false, arg=parameter
[          clap::output::help]  should_show_arg: use_long=false, arg=help
[          clap::output::help]  Help::write_templated_help
[          clap::output::help]  Help::write_before_help
[          clap::output::help]  Help::write_bin_name
[         clap::output::usage]  Usage::create_usage_no_title
[         clap::output::usage]  Usage::create_help_usage; incl_reqs=true
[         clap::output::usage]  Usage::get_required_usage_from: incls=[], matcher=false, incl_last=false
[         clap::output::usage]  Usage::get_required_usage_from: unrolled_reqs=[parameter]
[         clap::output::usage]  Usage::get_required_usage_from:iter:parameter
[         clap::output::usage]  Usage::get_required_usage_from: ret_val=["<PARAMETER>"]
[         clap::output::usage]  Usage::needs_flags_tag
[         clap::output::usage]  Usage::needs_flags_tag:iter: f=help
[         clap::output::usage]  Usage::needs_flags_tag:iter: f=version
[         clap::output::usage]  Usage::needs_flags_tag: [FLAGS] not required
[         clap::output::usage]  Usage::create_help_usage: usage=hello_world <PARAMETER>
[          clap::output::help]  Help::write_all_args
[          clap::output::help]  should_show_arg: use_long=false, arg=parameter
[          clap::output::help]  should_show_arg: use_long=false, arg=help
[          clap::output::help]  should_show_arg: use_long=false, arg=version
[          clap::output::help]  Help::write_args_unsorted
[          clap::output::help]  should_show_arg: use_long=false, arg=parameter
[          clap::output::help]  should_show_arg: use_long=false, arg=parameter
[          clap::output::help]  Help::spec_vals: a=<PARAMETER>
[          clap::output::help]  Help::spec_vals: a=<PARAMETER>
[          clap::output::help]  Help::short
[          clap::output::help]  Help::long
[          clap::output::help]  Help::val: arg=parameter
[          clap::output::help]  Help::val: Has switch...
[          clap::output::help]  No, and not next_line
[          clap::output::help]  Help::help
[          clap::output::help]  Help::help: Next Line...false
[          clap::output::help]  Help::help: Too long...
[          clap::output::help]  No
[          clap::output::help]  Help::write_args
[          clap::output::help]  should_show_arg: use_long=false, arg=help
[          clap::output::help]  Help::write_args: Current Longest...2
[          clap::output::help]  Help::write_args: New Longest...6
[          clap::output::help]  should_show_arg: use_long=false, arg=version
[          clap::output::help]  Help::write_args: Current Longest...6
[          clap::output::help]  Help::write_args: New Longest...9
[          clap::output::help]  should_show_arg: use_long=false, arg=help
[          clap::output::help]  Help::spec_vals: a=--help
[          clap::output::help]  should_show_arg: use_long=false, arg=version
[          clap::output::help]  Help::spec_vals: a=--version
[          clap::output::help]  Help::spec_vals: a=--help
[          clap::output::help]  Help::short
[          clap::output::help]  Help::long
[          clap::output::help]  Help::val: arg=help
[          clap::output::help]  Help::val: Has switch...
[          clap::output::help]  Yes
[          clap::output::help]  Help::val: nlh...false
[          clap::output::help]  Help::help
[          clap::output::help]  Help::help: Next Line...false
[          clap::output::help]  Help::help: Too long...
[          clap::output::help]  No
[          clap::output::help]  Help::spec_vals: a=--version
[          clap::output::help]  Help::short
[          clap::output::help]  Help::long
[          clap::output::help]  Help::val: arg=version
[          clap::output::help]  Help::val: Has switch...
[          clap::output::help]  Yes
[          clap::output::help]  Help::val: nlh...false
[          clap::output::help]  Help::help
[          clap::output::help]  Help::help: Next Line...false
[          clap::output::help]  Help::help: Too long...
[          clap::output::help]  No
[          clap::output::help]  Help::write_after_help
[           clap::output::fmt]  is_a_tty: stderr=true
```

---

_Label `T: bug` added by @nicolacSNPS on 2021-09-10 16:29_

---

_Renamed from "ArgRequiredElseHelp" to "Different expected exit code with usage of ArgRequiredElseHelp between 3-beta-2 and 3-beta-4" by @nicolacSNPS on 2021-09-10 16:39_

---

_Added to milestone `3.0` by @pksunkara on 2021-09-10 21:43_

---

_Comment by @pksunkara on 2021-09-24 19:32_

> Actual Behaviour
> The program exit with displaying the help message and an exit code of 0
>
> Expected Behaviour
> Before in beta-2, the program also exit with displaying the help message and an exit code of 0

I don't see any difference. What exactly are you asking? Are you saying that expected behaviour should be non-zero being exit code.

---

_Comment by @nicolacSNPS on 2021-09-24 20:05_

> > Actual Behaviour
> > The program exit with displaying the help message and an exit code of 0
> > Expected Behaviour
> > Before in beta-2, the program also exit with displaying the help message and an exit code of 0
> 
> I don't see any difference. What exactly are you asking? Are you saying that expected behaviour should be non-zero being exit code.

I made a typo in the original message, before it was a non-zero exit code (failure) and now it is a zero exit code (success)

---

_Comment by @epage on 2021-10-04 19:56_

7f627fceeebf4886620e3b45d82a18b04f2e55ba broke this

---

_Comment by @epage on 2021-10-04 20:01_

https://github.com/clap-rs/clap/issues/2021 is the original issue.

I suspect the new behavior is the more correct behavior
- Return `2` for `ArgRequiredElseHelp` treats that setting as "on one specific input validation case, show all help"
- Return `0` for `ArgRequiredElseHelp` treats that setting as "`--help` is synonymous with no args"

It might be interesting to see what the precedence is for this
- `rsync` prints help with a code of 1
- Python's `argparse` has no built-in support for showing help on no args

(more to be added over time)

---

_Comment by @epage on 2021-10-04 20:17_

If we decide to revert #2168 , its easy for people to work around this on their side, without relying on `ErrorKind`, for example
```rust
use clap::{AppSettings, Clap, IntoApp, Subcommand};

#[derive(Clap)]
pub struct Opts {
    #[clap(subcommand)]
    sub: Option<Sub>,
}

#[derive(Subcommand)]
enum Sub {
    Foo,
    Bar,
}

fn main() {
    let opts: Opts = Opts::parse();
    if opts.sub.is_none() {
        println!("Custom!\n");
        Opts::into_app().print_help();
    }
}
```

---

_Comment by @epage on 2021-10-04 20:25_

@pksunkara  what was the thought process for deciding what the expected behavior should be in https://github.com/clap-rs/clap/issues/2021?

Someone brought up that it broke them (https://github.com/clap-rs/clap/issues/2767).  I'm also trying to find precedence one way or the other but so far have only found `rsync` to show help on no args, so not a very good sample size.

---

_Comment by @nicolacSNPS on 2021-10-04 20:36_

> @pksunkara what was the thought process for deciding what the expected behavior should be in #2021?
> 
> Someone brought up that it broke them (#2767). I'm also trying to find precedence one way or the other but so far have only found `rsync` to show help on no args, so not a very good sample size.

Personally I think that displaying help on a missing argument is useful, the part that I have more of an issue with is the change of behavior on the exit code. Having a non-zero exit code on a invalid command (because of a missing argument) was useful for scripting and/or CI/CD. With the new behavior, a CLI tool made with clap and used in a script could be incorrectly used and the script would still continue thinking that the CLI tool did its job because it didn't throw an error code. 

---

_Comment by @kbknapp on 2021-10-05 01:13_

Originally the thought process was if someone manually requested `--help`, then printing the help message and exiting was a successful run (exit 0) for that binary. However, the help message was presented as result of an error (i.e. no args present, etc.) that is an *unsuccessful* run, hence exit 1 (or other non-zero).

---

_Comment by @joshtriplett on 2021-10-11 09:28_

I personally would expect the no-arguments help case to return an error code, to avoid silent failures.

I do think --help should return 0: it successfully showed help.

---

_Referenced in [clap-rs/clap#2859](../../clap-rs/clap/pulls/2859.md) on 2021-10-12 16:17_

---

_Comment by @pksunkara on 2021-10-12 16:28_

The original intention was that since the author provided a fallback strategy, that means we should not give exit code.

I don't mind either way, but just wanted to provide some context on the original commit

---

_Closed by @bors[bot] on 2021-10-12 21:23_

---

_Referenced in [PRQL/prql#5133](../../PRQL/prql/pulls/5133.md) on 2025-01-30 13:20_

---
