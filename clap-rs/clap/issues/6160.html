<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Order of global arg usage changes behaviour with conflicts_with on Command arg - clap-rs/clap #6160</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Order of global arg usage changes behaviour with conflicts_with on Command arg</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/clap-rs/clap/issues/6160">#6160</a>
        opened by <a href="https://github.com/merc1031">@merc1031</a>
        on 2025-10-24 01:45
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/merc1031">@merc1031</a> on 2025-10-24 01:45</div>
            <div class="timeline-body"><h3>Please complete the following tasks</h3>
<ul>
<li>[x] I have searched the <a href="https://github.com/clap-rs/clap/discussions">discussions</a></li>
<li>[x] I have searched the <a href="https://github.com/clap-rs/clap/issues">open</a> and <a href="https://github.com/clap-rs/clap/issues?q=is%3Aissue+label%3AS-wont-fix+is%3Aclosed">rejected</a> issues</li>
</ul>
<h3>Rust Version</h3>
<p>rustc 1.88.0 (6b00bc388 2025-06-23)</p>
<h3>Clap Version</h3>
<p>4.5.47</p>
<h3>Minimal reproducible code</h3>
<p>Also tested on rustplayground 1.90.0 https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2024&amp;gist=72c2c207bad9a0430a2c8b4ba331c4a8</p>
<pre><code class="language-rust">use std::path::PathBuf;
use clap::{Parser};

#[derive(Parser, Debug)]
pub struct Args {
    #[clap(conflicts_with = &quot;root&quot;)]
    pub path: Option&lt;PathBuf&gt;,
}

#[derive(Parser, Debug)]
enum Commands {
    Do(Args)
}

#[derive(Parser, Debug)]
pub struct Cli {
    #[command(subcommand)]
    pub command: Commands,
    #[arg(long, global = true)]
    pub root: Option&lt;PathBuf&gt;,
}


fn main() {
    let res  = Cli::try_parse_from([&quot;app&quot;, &quot;--root&quot;, &quot;.&quot;,  &quot;do&quot;, &quot;.&quot;]);
    println!(&quot;{res:?}&quot;);
    let res  = Cli::try_parse_from([&quot;app&quot;, &quot;do&quot;, &quot;--root&quot;, &quot;.&quot;, &quot;.&quot;]);
    println!(&quot;{res:?}&quot;);

}

</code></pre>
<h3>Steps to reproduce the bug with the above code</h3>
<p>Just run the playground https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2024&amp;gist=72c2c207bad9a0430a2c8b4ba331c4a8</p>
<h3>Actual Behaviour</h3>
<p><code>--root . do .</code> Does not obey the conflicts_with
<code>do --root . .</code> Does  obey the conflicts_with</p>
<pre><code>Ok(Cli { command: Do(Args { path: Some(&quot;.&quot;) }), root: Some(&quot;.&quot;) })
Err(ErrorInner { kind: ArgumentConflict, context: FlatMap { keys: [InvalidArg, PriorArg, Usage], values: [String(&quot;--root &lt;ROOT&gt;&quot;), String(&quot;[PATH]&quot;), StyledStr(StyledStr(&quot;\u{1b}[1m\u{1b}[4mUsage:\u{1b}[0m \u{1b}[1mapp do\u{1b}[0m \u{1b}[1m--root\u{1b}[0m &lt;ROOT&gt; [PATH]&quot;))] }, message: None, source: None, help_flag: Some(&quot;--help&quot;), styles: Styles { header: Style { fg: None, bg: None, underline: None, effects: Effects(BOLD | UNDERLINE) }, error: Style { fg: Some(Ansi(Red)), bg: None, underline: None, effects: Effects(BOLD) }, usage: Style { fg: None, bg: None, underline: None, effects: Effects(BOLD | UNDERLINE) }, literal: Style { fg: None, bg: None, underline: None, effects: Effects(BOLD) }, placeholder: Style { fg: None, bg: None, underline: None, effects: Effects() }, valid: Style { fg: Some(Ansi(Green)), bg: None, underline: None, effects: Effects() }, invalid: Style { fg: Some(Ansi(Yellow)), bg: None, underline: None, effects: Effects() }, context: Style { fg: None, bg: None, underline: None, effects: Effects() }, context_value: None }, color_when: Auto, color_help_when: Auto, backtrace: None })
</code></pre>
<h3>Expected Behaviour</h3>
<p><code>--root . do .</code> Does  obey the conflicts_with
<code>do --root . .</code> Does  obey the conflicts_with</p>
<pre><code>Err(ErrorInner { kind: ArgumentConflict, context: FlatMap { keys: [InvalidArg, PriorArg, Usage], values: [String(&quot;--root &lt;ROOT&gt;&quot;), String(&quot;[PATH]&quot;), StyledStr(StyledStr(&quot;\u{1b}[1m\u{1b}[4mUsage:\u{1b}[0m \u{1b}[1mapp do\u{1b}[0m \u{1b}[1m--root\u{1b}[0m &lt;ROOT&gt; [PATH]&quot;))] }, message: None, source: None, help_flag: Some(&quot;--help&quot;), styles: Styles { header: Style { fg: None, bg: None, underline: None, effects: Effects(BOLD | UNDERLINE) }, error: Style { fg: Some(Ansi(Red)), bg: None, underline: None, effects: Effects(BOLD) }, usage: Style { fg: None, bg: None, underline: None, effects: Effects(BOLD | UNDERLINE) }, literal: Style { fg: None, bg: None, underline: None, effects: Effects(BOLD) }, placeholder: Style { fg: None, bg: None, underline: None, effects: Effects() }, valid: Style { fg: Some(Ansi(Green)), bg: None, underline: None, effects: Effects() }, invalid: Style { fg: Some(Ansi(Yellow)), bg: None, underline: None, effects: Effects() }, context: Style { fg: None, bg: None, underline: None, effects: Effects() }, context_value: None }, color_when: Auto, color_help_when: Auto, backtrace: None })
Err(ErrorInner { kind: ArgumentConflict, context: FlatMap { keys: [InvalidArg, PriorArg, Usage], values: [String(&quot;--root &lt;ROOT&gt;&quot;), String(&quot;[PATH]&quot;), StyledStr(StyledStr(&quot;\u{1b}[1m\u{1b}[4mUsage:\u{1b}[0m \u{1b}[1mapp do\u{1b}[0m \u{1b}[1m--root\u{1b}[0m &lt;ROOT&gt; [PATH]&quot;))] }, message: None, source: None, help_flag: Some(&quot;--help&quot;), styles: Styles { header: Style { fg: None, bg: None, underline: None, effects: Effects(BOLD | UNDERLINE) }, error: Style { fg: Some(Ansi(Red)), bg: None, underline: None, effects: Effects(BOLD) }, usage: Style { fg: None, bg: None, underline: None, effects: Effects(BOLD | UNDERLINE) }, literal: Style { fg: None, bg: None, underline: None, effects: Effects(BOLD) }, placeholder: Style { fg: None, bg: None, underline: None, effects: Effects() }, valid: Style { fg: Some(Ansi(Green)), bg: None, underline: None, effects: Effects() }, invalid: Style { fg: Some(Ansi(Yellow)), bg: None, underline: None, effects: Effects() }, context: Style { fg: None, bg: None, underline: None, effects: Effects() }, context_value: None }, color_when: Auto, color_help_when: Auto, backtrace: None })
</code></pre>
<h3>Additional Context</h3>
<p><em>No response</em></p>
<h3>Debug Output</h3>
<p><em>No response</em></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">C-bug</span> added by @merc1031 on 2025-10-24 01:45</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">S-triage</span> added by @merc1031 on 2025-10-24 01:45</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">A-validators</span> added by @epage on 2025-10-24 15:09</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">A-parsing</span> added by @epage on 2025-10-24 15:10</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/5977.html">clap-rs/clap#5977</a> on 2025-10-24 15:10</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2025-10-24 15:11</div>
            <div class="timeline-body"><p>In general, validation with global is a bit off, see #1546, particularly https://github.com/clap-rs/clap/issues/1546#issuecomment-1198809765</p>
<p>I'll keep this open to make sure we test and fix this case along with the others</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 01:36:27 UTC
    </footer>
</body>
</html>
