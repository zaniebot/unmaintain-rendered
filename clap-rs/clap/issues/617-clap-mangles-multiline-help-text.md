```yaml
number: 617
title: Clap mangles multiline help text
type: issue
state: closed
author: vks
labels:
  - C-enhancement
  - A-help
assignees: []
created_at: 2016-08-12T10:22:50Z
updated_at: 2018-08-02T03:29:52Z
url: https://github.com/clap-rs/clap/issues/617
synced_at: 2026-01-12T16:14:09Z
```

# Clap mangles multiline help text

---

_@vks_

Consider this example:

``` rust
extern crate clap;

use clap::*;

static TYPE_HELP: &'static str =
"x, max, maximum   20 characters, contains symbols.{n}\
l, long           Copy-friendly, 14 characters, contains symbols.{n}\
m, med, medium    Copy-friendly, 8 characters, contains symbols.{n}\
b, basic          8 characters, no symbols.{n}\
s, short          Copy-friendly, 4 characters, no symbols.{n}\
i, pin            4 numbers.{n}\
n, name           9 letter name.{n}\
p, phrase         20 character sentence.";

fn main() {
    let matches = App::new("")
        .arg(Arg::with_name("type")
             .help(TYPE_HELP)
             .next_line_help(true))
        .get_matches();
}
```

The following help will be printed:

```
        x, max, maximum   20 characters, contains symbols.
        l, long          
        Copy-friendly, 14 characters, contains symbols.
        m, med, medium    Copy-friendly,
        8 characters, contains symbols.
        b, basic          8 characters, no symbols.
        s,
        short          Copy-friendly, 4 characters, no symbols.
        i, pin            4
        numbers.
        n, name           9 letter name.
        p, phrase         20 character
        sentence.
```

It seems like clap randomly inserts newlines. Increasing the terminal size does not change anything.


---

_Comment by @kbknapp on 2016-08-20 22:11_

For your case, I believe using the default `\n` will work. As the the `{n}` is only used when you want to be able to re-align long help text, but that's not what you're doing. Try:

```
static TYPE_HELP: &'static str =
"x, max, maximum   20 characters, contains symbols.\n\
l, long           Copy-friendly, 14 characters, contains symbols.\n\
m, med, medium    Copy-friendly, 8 characters, contains symbols.\n\
b, basic          8 characters, no symbols.\n\
s, short          Copy-friendly, 4 characters, no symbols.\n\
i, pin            4 numbers.\n\
n, name           9 letter name.\n\
p, phrase         20 character sentence.";
```


---

_Label `T: RFC / question` added by @kbknapp on 2016-08-20 22:12_

---

_Label `C: completion gen` added by @kbknapp on 2016-08-20 22:12_

---

_Label `C: completion gen` removed by @kbknapp on 2016-08-20 22:12_

---

_Comment by @vks on 2016-08-21 20:40_

This looks a bit better, however there are still strange newlines:

```
        x, max, maximum   20 characters, contains symbols.
l, long           Copy-friendly, 14 characters, contains symbols.
m, med,
        medium    Copy-friendly, 8 characters, contains symbols.
b, basic          8 characters, no symbols.
s, short         
        Copy-friendly, 4 characters, no symbols.
i, pin            4 numbers.
n, name           9 letter name.
p, phrase         20
        character sentence.
```


---

_Comment by @kbknapp on 2016-08-26 15:27_

I think this is a product of the 120 default term width. Try setting `set_term_width(0)` on your `App` instance and see if that fixes it.


---

_Comment by @vks on 2016-08-29 07:44_

I get an 'attempt to subtract with overflow' panic at `clap-2.10.2/src/app/help.rs:446` if I do that.

How can it be related to the default term width? The lines are much shorter than that. Does clap ignore `\n` when breaking lines?

_Edit:_ Updating to clap 2.11 fixes the panic and does indeed work. (However, some of the autogenerated text is too long.) The line wraps still don't make sense to me if the term width is not set to 0.


---

_Comment by @kbknapp on 2016-09-05 17:44_

@vks can you post what it looks like when not set to 0? If there are hard newlines in the help text, clap counts those simply as bytes, and not as newlines which restart the count until the next wrap. This can cause  there to be two newlines, the hard one and the one that clap counts and inserts at.


---

_Comment by @vks on 2016-09-06 21:33_

@kbknapp Now with the new clap version and default term width I'm getting

```
            x, max, maximum   20
            characters, contains symbols.
            l, long           Copy-friendly,
            14 characters, contains symbols.
            m, med, medium   
            Copy-friendly, 8 characters, contains symbols.
            b, basic       
              8 characters, no symbols.
            s, short          Copy-friendly, 4
            characters, no symbols.
            i, pin            4 numbers.
            n, name
                      9 letter name.
            p, phrase         20 character sentence.
```

with `{n}\` and

```
x, max, maximum   20 characters,
            contains symbols.
l, long           Copy-friendly, 14 characters,
            contains symbols.
m, med, medium    Copy-friendly, 8 characters,
            contains symbols.
b, basic          8 characters, no symbols.
s,
            short          Copy-friendly, 4 characters, no symbols.
i, pin   
                    4 numbers.
n, name           9 letter name.
p, phrase     
               20 character sentence.
```

with `\n\`.

> If there are hard newlines in the help text, clap counts those simply as bytes, and not as newlines which restart the count until the next wrap. 

Why can't clap just look for newlines and treat them accordingly?


---

_Comment by @kbknapp on 2016-09-06 22:46_

@vks when I run the example you posted and add `set_term_width(0)` this what I see:

```
kevin@karch: ~/Projects/fake-rs 
➜ ./target/debug/fake-rs -h                                     ✓ [git: master]


USAGE:
    fake-rs [type]

FLAGS:
    -h, --help       Prints help information
    -V, --version    Prints version information

ARGS:
    <type>
            x, max, maximum   20 characters, contains symbols.
            l, long           Copy-friendly, 14 characters, contains symbols.
            m, med, medium    Copy-friendly, 8 characters, contains symbols.
            b, basic          8 characters, no symbols.
            s, short          Copy-friendly, 4 characters, no symbols.
            i, pin            4 numbers.
            n, name           9 letter name.
            p, phrase         20 character sentence.
```


---

_Comment by @kbknapp on 2016-09-06 22:50_

> Why can't clap just look for newlines and treat them accordingly?

They get printed accordingly, but `clap` doesn't reset the count until it _inserts_ the next newline. This _may_ be possible to add, but I haven't tried it yet.


---

_Comment by @vks on 2016-09-06 23:00_

@kbknapp Setting the term width to 0 works for me as well, as mentioned in my previous comment. This is a possible workaround, but you lose wrapping. You can just limit the help text to 80 characters and it should look fine on most terminal sizes. However, you have no control over wrapping for example the list of allowed values, which is generated by clap. You can disable its generation and create the list manually though.

Only the automatic wrapping of multiline help text is completely broken for me.


---

_Comment by @kbknapp on 2016-09-06 23:23_

@vks I understand. I'm working the issue as we speak, since this is also an issue for `rustup` :smile:


---

_Comment by @kbknapp on 2016-09-07 01:47_

@vks Ok, so I've got it to where upon having enough space (i.e. term width is big enough) it will simply ignore the new lines:

```
USAGE:
    fake-rs [type]

FLAGS:
    -h, --help       Prints help information
    -V, --version    Prints version information

ARGS:
    <type>
            x, max, maximum   20 characters, contains symbols.
            l, long           Copy-friendly, 14 characters, contains symbols.
            m, med, medium    Copy-friendly, 8 characters, contains symbols.
            b, basic          8 characters, no symbols.
            s, short          Copy-friendly, 4 characters, no symbols.
            i, pin            4 numbers.
            n, name           9 letter name.
            p, phrase         20 character sentence.
```

But if the term width is smaller, it will wrap.

```
USAGE:
    fake-rs [type]

FLAGS:
    -h, --help       Prints help information
    -V, --version    Prints version information

ARGS:
    <type>
            x, max, maximum   20 characters, contains symbols.
            l, long           Copy-friendly, 14 characters, contains
            symbols.
            m, med, medium    Copy-friendly, 8 characters, 
            contains symbols.
            b, basic          8 characters, no symbols.
            s, short          Copy-friendly, 4 characters, no symbols.
            i, pin            4 numbers.
            n, name           9 letter name.
            p, phrase         20 character sentence.
```


---

_Label `T: enhancement` added by @kbknapp on 2016-09-07 01:52_

---

_Label `C: help message` added by @kbknapp on 2016-09-07 01:52_

---

_Label `D: intermediate` added by @kbknapp on 2016-09-07 01:52_

---

_Label `P3: want to have` added by @kbknapp on 2016-09-07 01:52_

---

_Label `W: 2.x` added by @kbknapp on 2016-09-07 01:52_

---

_Label `T: RFC / question` removed by @kbknapp on 2016-09-07 01:52_

---

_Added to milestone `2.11.3` by @kbknapp on 2016-09-07 01:53_

---

_Comment by @vks on 2016-09-07 10:39_

@kbknapp Looks great! This is exactly what I was imagining.


---

_Comment by @kbknapp on 2016-09-07 12:42_

Just put in the PR, see #650 


---

_Comment by @kbknapp on 2016-09-07 12:43_

Note, this also removes the requirement to use `{n}` to insert a newline, you can use `\n` now. Although for backwards compatibility the `{n}` still works fine.


---

_Referenced in [rust-lang/rustup#657](../../rust-lang/rustup/issues/657.md) on 2016-09-07 12:47_

---

_Closed by @homu on 2016-09-07 15:49_

---

_Comment by @vks on 2016-09-07 16:32_

Thanks!


---

_Referenced in [mgeisler/textwrap#28](../../mgeisler/textwrap/issues/28.md) on 2017-01-29 20:48_

---

_Referenced in [clap-rs/clap#845](../../clap-rs/clap/pulls/845.md) on 2017-02-08 21:06_

---

_Referenced in [mgeisler/textwrap#48](../../mgeisler/textwrap/pulls/48.md) on 2017-05-18 21:23_

---

_Referenced in [TeXitoi/structopt#163](../../TeXitoi/structopt/issues/163.md) on 2019-01-24 21:41_

---
