<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>`requires` and `default_value` override the `required` field on the target of `requires` - clap-rs/clap #2714</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1><code>requires</code> and <code>default_value</code> override the <code>required</code> field on the target of <code>requires</code></h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/clap-rs/clap/issues/2714">#2714</a>
        opened by <a href="https://github.com/rectangular-zone">@rectangular-zone</a>
        on 2021-08-18 03:32
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/rectangular-zone">@rectangular-zone</a> on 2021-08-18 03:32</div>
            <div class="timeline-body"><h3>Please complete the following tasks</h3>
<ul>
<li>[X] I have searched the <a href="https://github.com/clap-rs/clap/discussions">discussions</a></li>
<li>[X] I have searched the existing issues</li>
</ul>
<h3>Rust Version</h3>
<p>1.54</p>
<h3>Clap Version</h3>
<p>3.0.0-beta.4</p>
<h3>Minimal reproducible code</h3>
<pre><code class="language-rust">use clap::{App, Arg};

mod flags {
    pub const OPTIONAL: &amp;str = &quot;optional&quot;;
    pub const REQUIRES_OPTIONAL: &amp;str = &quot;requires-optional&quot;;
}

fn main() {
    let _ = App::new(&quot;mwe&quot;)
        .args(&amp;[
            Arg::new(flags::OPTIONAL)
                .long(&quot;optional&quot;)
                .required(false)
                .about(&quot;This flag should be optional unless the other flag is provided&quot;),
            Arg::new(flags::REQUIRES_OPTIONAL)
                .takes_value(true)
                .required(false)
                .requires(flags::OPTIONAL)
                .default_value(&quot;some default&quot;)
                .about(&quot;This flag forces the optional field to be required if the default value is set&quot;),
        ])
        .get_matches();

    println!(&quot;Demo&quot;);
}
</code></pre>
<h3>Steps to reproduce the bug with the above code</h3>
<p><code>cargo run</code></p>
<h3>Actual Behaviour</h3>
<p>If <code>default_value</code> is set on the arg that specifies <code>requires</code>, then it forces the target of <code>requires</code> to be required, even if <code>required(false)</code> is specified, or <code>required</code> is omitted entirely.</p>
<pre><code>$ cargo run
   Compiling mwe v0.1.0 (/tmp/mwe)
    Finished dev [unoptimized + debuginfo] target(s) in 0.34s
     Running `target/debug/mwe`
error: The following required arguments were not provided:
    --optional

USAGE:
    mwe [FLAGS] --optional [requires-optional]

For more information try --help
</code></pre>
<h3>Expected Behaviour</h3>
<p>So, personally: I don't think specifying a default value should have this effect. It feels surprising, and a little un-intuitive. That said, it also makes a kind of sense. If the response here is, &quot;no, that works correctly,&quot; that's cool! Maybe y'all could point me at a place I could PR a docs update then, make sure this is written down somewhere? (Or! Maybe I'm going to be incredibly sheepish when y'all point out where it's already documented.)</p>
<p>What I'm going for is: if you specify <code>b</code>, then <code>a</code> must also be specified, while if <code>a</code> is specified, <code>b</code> gets a sensible default.</p>
<h3>Additional Context</h3>
<p>Nope! Clap is an amazing project, I'm thrilled to be able to use it.</p>
<h3>Debug Output</h3>
<p>[            clap::build::app] 	App::_do_parse
[            clap::build::app] 	App::_build
[            clap::build::app] 	App::_propagate:mwe
[            clap::build::app] 	App::_check_help_and_version
[            clap::build::app] 	App::_propagate_global_args:mwe
[            clap::build::app] 	App::_derive_display_order:mwe
[clap::build::app::debug_asserts] 	App::_debug_asserts
[clap::build::arg::debug_asserts] 	Arg::_debug_asserts:help
[clap::build::arg::debug_asserts] 	Arg::_debug_asserts:version
[clap::build::arg::debug_asserts] 	Arg::_debug_asserts:optional
[clap::build::arg::debug_asserts] 	Arg::_debug_asserts:requires-optional
[         clap::parse::parser] 	Parser::get_matches_with
[         clap::parse::parser] 	Parser::_build
[         clap::parse::parser] 	Parser::_verify_positionals
[         clap::parse::parser] 	Parser::remove_overrides
[      clap::parse::validator] 	Validator::validate
[         clap::parse::parser] 	Parser::add_env: Checking arg <code>--help</code>
[         clap::parse::parser] 	Parser::add_env: Checking arg <code>--version</code>
[         clap::parse::parser] 	Parser::add_env: Checking arg <code>--optional</code>
[         clap::parse::parser] 	Parser::add_env: Checking arg <code>&lt;requires-optional&gt;</code>
[         clap::parse::parser] 	Parser::add_defaults
[         clap::parse::parser] 	Parser::add_defaults:iter:requires-optional:
[         clap::parse::parser] 	Parser::add_value: doesn't have conditional defaults
[         clap::parse::parser] 	Parser::add_value:iter:requires-optional: has default vals
[         clap::parse::parser] 	Parser::add_value:iter:requires-optional: wasn't used
[            clap::build::app] 	App::groups_for_arg: id=requires-optional
[         clap::parse::parser] 	Parser::add_single_val_to_arg: adding val...&quot;some default&quot;
[         clap::parse::parser] 	Parser::add_single_val_to_arg: cur_idx:=1
[            clap::build::app] 	App::groups_for_arg: id=requires-optional
[         clap::parse::parser] 	Parser::add_value:iter:requires-optional: doesn't have default missing vals
[      clap::parse::validator] 	Validator::validate_conflicts
[      clap::parse::validator] 	Validator::validate_exclusive
[      clap::parse::validator] 	Validator::validate_exclusive:iter:requires-optional
[      clap::parse::validator] 	Validator::gather_conflicts
[      clap::parse::validator] 	Validator::gather_conflicts:iter: id=requires-optional
[      clap::parse::validator] 	Validator::gather_conflicts:iter: This is default value, skipping.
[      clap::parse::validator] 	Validator::validate_required: required=ChildGraph([])
[      clap::parse::validator] 	Validator::gather_requirements
[      clap::parse::validator] 	Validator::gather_requirements:iter:requires-optional
[      clap::parse::validator] 	Validator::validate_required:iter:aog=optional
[      clap::parse::validator] 	Validator::validate_required:iter: This is an arg
[      clap::parse::validator] 	Validator::is_missing_required_ok: optional
[      clap::parse::validator] 	Validator::validate_arg_conflicts: a=&quot;optional&quot;
[      clap::parse::validator] 	Validator::missing_required_error; incl=[]
[      clap::parse::validator] 	Validator::missing_required_error: reqs=ChildGraph([Child { id: optional, children: [] }])
[         clap::output::usage] 	Usage::get_required_usage_from: incls=[], matcher=true, incl_last=true
[         clap::output::usage] 	Usage::get_required_usage_from: unrolled_reqs=[optional]
[         clap::output::usage] 	Usage::get_required_usage_from:iter:optional
[         clap::output::usage] 	Usage::get_required_usage_from: ret_val=[&quot;--optional&quot;]
[      clap::parse::validator] 	Validator::missing_required_error: req_args=[
&quot;--optional&quot;,
]
[         clap::output::usage] 	Usage::create_usage_with_title
[         clap::output::usage] 	Usage::create_usage_no_title
[         clap::output::usage] 	Usage::create_help_usage; incl_reqs=true
[         clap::output::usage] 	Usage::get_required_usage_from: incls=[], matcher=false, incl_last=false
[         clap::output::usage] 	Usage::get_required_usage_from: unrolled_reqs=[optional]
[         clap::output::usage] 	Usage::get_required_usage_from:iter:optional
[         clap::output::usage] 	Usage::get_required_usage_from: ret_val=[&quot;--optional&quot;]
[         clap::output::usage] 	Usage::needs_flags_tag
[         clap::output::usage] 	Usage::needs_flags_tag:iter: f=help
[         clap::output::usage] 	Usage::needs_flags_tag:iter: f=version
[         clap::output::usage] 	Usage::needs_flags_tag:iter: f=optional
[            clap::build::app] 	App::groups_for_arg: id=optional
[         clap::output::usage] 	Usage::needs_flags_tag:iter: [FLAGS] required
[         clap::output::usage] 	Usage::get_args_tag; incl_reqs = true
[         clap::output::usage] 	Usage::get_args_tag:iter:requires-optional
[            clap::build::app] 	App::groups_for_arg: id=requires-optional
[         clap::output::usage] 	Usage::get_args_tag:iter: 1 Args not required or hidden
[            clap::build::app] 	App::groups_for_arg: id=requires-optional
[         clap::output::usage] 	Usage::get_args_tag:iter: Exactly one, returning 'requires-optional'
[            clap::build::arg] 	Arg::name_no_brackets:requires-optional
[            clap::build::arg] 	Arg::name_no_brackets: just name
[         clap::output::usage] 	Usage::create_help_usage: usage=mwe [FLAGS] --optional [requires-optional]
[            clap::build::app] 	App::color: Color setting...
[            clap::build::app] 	Auto
[           clap::output::fmt] 	is_a_tty: stderr=true</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">T: bug</span> added by @rectangular-zone on 2021-08-18 03:32</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2021-08-18 14:40</div>
            <div class="timeline-body"><p>Related symptom with presumably the same root cause:  https://github.com/clap-rs/clap/issues/1586</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone "3.0" by @pksunkara on 2021-08-18 14:55</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">C: arg groups</span> added by @pksunkara on 2021-08-18 14:55</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/kbknapp">@kbknapp</a> on 2021-10-05 01:23</div>
            <div class="timeline-body"><p>While this is working as intended, I also can understand that it's surprising and perhaps not the best approach. Perhaps what needs to happen is we need to re-work <a href="https://docs.rs/clap/3.0.0-beta.4/clap/struct.Arg.html#method.requires_if"><code>Arg::requires_if</code></a> to take a closure that determines if the other argument is required or not instead of just a <code>val == some_val</code> constraint.</p>
<p>I'm not sure that I can get on board with going all the way that this behavior should be changed <em>by default</em> though. If the default worked as expected here then implementing a closure style <code>requires_if</code> would be much more difficult.</p>
<p>I would however be very on board with calling this edge case out in the docs though for the the <code>Arg:;requires</code> (and current <code>Arg::requires_if</code>) saying that when used with a default value, the default value counts as the argument being used.</p>
<p>A (temporary) workaround would be to <em>not</em> have a default value, and instead do the default value manually:</p>
<pre><code class="language-rust">use clap::{App, Arg};

mod flags {
    pub const OPTIONAL: &amp;str = &quot;optional&quot;;
    pub const REQUIRES_OPTIONAL: &amp;str = &quot;requires-optional&quot;;
}

fn main() {
    let m = App::new(&quot;mwe&quot;)
        .args(&amp;[
            Arg::new(flags::OPTIONAL)
                .long(&quot;optional&quot;)
                .required(false)
                .about(&quot;This flag should be optional unless the other flag is provided&quot;),
            Arg::new(flags::REQUIRES_OPTIONAL)
                .takes_value(true)
                .required(false)
                .requires(flags::OPTIONAL)
                .about(&quot;This flag forces the optional field to be required if the default value is set&quot;),
        ])
        .get_matches();

    println!(&quot;Default: {}&quot;, m.value_of(flags::REQUIRES_OPTIONAL).unwrap_or(&quot;some_default&quot;));
}
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/2896.html">clap-rs/clap#2896</a> on 2021-10-16 18:47</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2021-10-16 18:54</div>
            <div class="timeline-body"><p>@kbknapp I just wanted to double check, do you feel the documentation update (#2896) resolves this or just lowers the urgency so it doesn't need to be in 3.0?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/kbknapp">@kbknapp</a> on 2021-10-16 19:01</div>
            <div class="timeline-body"><p>@epage yes I think the documentation note is good enough to resolve this issue being that it's currently working as intended (even if there are <em>potentially</em> better ways to go about this). If we want to go for a more complete or closure based approach I suggest we open a new issue for that, and it will happen post-v3.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @kbknapp on 2021-10-16 19:02</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/pksunkara">@pksunkara</a> on 2021-10-16 19:07</div>
            <div class="timeline-body"><p>As mentioned in the PR, can we keep this open to look at the design once again?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/pksunkara">@pksunkara</a> on 2021-10-16 19:08</div>
            <div class="timeline-body"><blockquote>
<p>closure based approach</p>
</blockquote>
<p>What's that?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2021-10-16 19:27</div>
            <div class="timeline-body"><p>Personally, I'm ok with either closing this or leaving it open.  I do feel the documentation resolution is good enough for now though.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/pksunkara">@pksunkara</a> on 2021-10-16 19:30</div>
            <div class="timeline-body"><p>Okay, I am reopening this then but removing 3.0 milestone.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Reopened by @pksunkara on 2021-10-16 19:30</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Removed from milestone "3.0" by @pksunkara on 2021-10-16 19:30</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/1586.html">clap-rs/clap#1586</a> on 2021-10-16 19:38</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/2897.html">clap-rs/clap#2897</a> on 2021-10-16 19:48</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/rectangular-zone">@rectangular-zone</a> on 2021-10-18 15:37</div>
            <div class="timeline-body"><p>Thanks y'all -- appreciate the time and help! FWIW, the documentation resolution works great for me :+1:</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @bors[bot] on 2021-10-27 21:31</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../epage/clapng/issues/10.html">epage/clapng#10</a> on 2021-11-17 21:58</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/3076.html">clap-rs/clap#3076</a> on 2021-12-07 21:56</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 12:31:44 UTC
    </footer>
</body>
</html>
