<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>failure to parse invalid Unicode on Windows in v2.33.0 (but not master) - clap-rs/clap #1905</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>failure to parse invalid Unicode on Windows in v2.33.0 (but not master)</h1>

    <div class="meta">
        <span class="state state-closed">Closed</span>
        <a href="https://github.com/clap-rs/clap/issues/1905">#1905</a>
        opened by <a href="https://github.com/oconnor663">@oconnor663</a>
        on 2020-05-05 06:12
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/oconnor663">@oconnor663</a> on 2020-05-05 06:12</div>
            <div class="timeline-body"><p>The following is for the current release version of Clap, v2.33.0. (The bug does not appear to repro in Clap <code>master</code>. More on that below.) I've set up a repository containing a minimal repro of this problem: https://github.com/oconnor663/clap_unicode_test. You can see a CI run demonstrating the failure here: https://github.com/oconnor663/clap_unicode_test/runs/645077320. To repro the failure yourself, run <code>cargo test</code> in that repository.</p>
<p>The issue is that passing invalid Unicode on the command line to a Clap binary causes an &quot;unexpected invalid UTF-8 code point&quot; error, but only on Windows. Here's the <code>main.rs</code>:</p>
<pre><code class="language-rust">use clap::{App, Arg};

fn main() {
    let matches = App::new(&quot;test&quot;)
        .arg(Arg::with_name(&quot;ARG&quot;).multiple(true))
        .get_matches();
    if let Some(args) = matches.values_of_os(&quot;ARG&quot;) {
        for arg in args {
            if arg.to_str().is_some() {
                println!(&quot;{:?} (valid Unicode)&quot;, arg);
            } else {
                println!(&quot;{:?} (INVALID Unicode!!!)&quot;, arg);
            }
        }
    }
}
</code></pre>
<p>Here's the test that runs on Linux and macOS. This one passes:</p>
<pre><code class="language-rust">#[test]
#[cfg(unix)]
fn test_invalid_unicode_on_unix() {
    use std::os::unix::ffi::OsStringExt;
    let mut cmd = Command::new(env!(&quot;CARGO_BIN_EXE_test&quot;));
    cmd.arg(&quot;abcdef&quot;);
    cmd.arg(OsString::from_vec(b&quot;abc\xffdef&quot;.to_vec()));
    let status = cmd.status().unwrap();
    assert!(status.success());
}
</code></pre>
<p>In that case, the actual output of the (successful) binary is:</p>
<pre><code>&quot;abcdef&quot; (valid Unicode)
&quot;abc\xFFdef&quot; (INVALID Unicode!!!)
</code></pre>
<p>And here's the test that fails on Windows:</p>
<pre><code class="language-rust">#[test]
#[cfg(windows)]
fn test_invalid_unicode_on_windows() {
    use std::os::windows::ffi::OsStringExt;
    let mut cmd = Command::new(env!(&quot;CARGO_BIN_EXE_test&quot;));
    cmd.arg(&quot;abcdef&quot;);
    let surrogate_char = 0xDC00;
    let bad_unicode_wchars = [
        'a' as u16,
        'b' as u16,
        'c' as u16,
        surrogate_char,
        'd' as u16,
        'e' as u16,
        'f' as u16,
    ];
    let bad_osstring = OsString::from_wide(&amp;bad_unicode_wchars);
    cmd.arg(bad_osstring);
    let status = cmd.status().unwrap();
    assert!(status.success());
}
</code></pre>
<p>In this one, the binary crashes in the <code>clap::App::get_matches</code> call.</p>
<p>The tests are different between Unix and Windows because the way to construct an invalid Unicode <code>OsString</code> is different. On Unix, we just insert a non-UTF-8 byte into a byte slice. On Windows, we need to insert a unpaired surrogate character into a slice of <code>u16</code>. Other than that, the tests are effectively the same.</p>
<p>When I try the master branch of Clap (see <a href="https://github.com/oconnor663/clap_unicode_test/tree/clap_master">the <code>clap_master</code> branch of my repository</a> and <a href="github.com/oconnor663/clap_unicode_test/runs/645103446">this CI run</a>), the problem appears fixed. That's awesome! However, it looks like Clap might be in the middle of a substantial refactoring, and I don't know how long it will take for these fixes to see a release. Should something be backported in the meantime?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">T: bug</span> added by @oconnor663 on 2020-05-05 06:12</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../BLAKE3-team/BLAKE3/issues/33.html">BLAKE3-team/BLAKE3#33</a> on 2020-05-05 06:13</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/pksunkara">@pksunkara</a> on 2020-05-05 08:38</div>
            <div class="timeline-body"><p>I don't think we will be backporting this fix because 2.x branch is frozen and only security fixes are going to be allowed. We are working hard on clap v3 and I am confident to say that the full release will be no more than 3 months away if we keep up the current pace of development.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/oconnor663">@oconnor663</a> on 2020-05-05 14:08</div>
            <div class="timeline-body"><p>If I was able to figure out a fix on the 2.x branch, and it didn't look too hairy, would you be willing to release it? I'm interested in fixing this for my own work (it's a blocker for properly testing <code>b3sum --check</code>), and it might be valuable for other command line apps that never bother to upgrade out of the 2.x series.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/CreepySkeleton">@CreepySkeleton</a> on 2020-05-05 14:54</div>
            <div class="timeline-body"><p>@oconnor663 I say we wouldn't because the code in question is a few years old code. The last time someone touched it was a year ago or so, nobody here (maybe short of @kbknapp) is familiar with that codebase. We simply can't review your fix and be certain that it won't break something else, even if it's just a few lines.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/kbknapp">@kbknapp</a> on 2020-05-05 15:33</div>
            <div class="timeline-body"><p>@oconnor663</p>
<p>We appreciate the very detailed bug report!</p>
<p>@pksunkara is correct, 2.x is currently frozen except security fixes. However, I'm willing to take a look at a PR to fix the issue, since I'm familiar with the codebase. I can't promise a merge if it looks to be too high a maintenance burden. Lets at least see how far reaching the fix is, since causing a crash on valid input <em>could</em> be considered a security issue if we wend the optics a bit to include remote binaries with DDoS potential.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/oconnor663">@oconnor663</a> on 2020-05-05 16:47</div>
            <div class="timeline-body"><p>Thanks for all the prompt replies. It looks like the fix can be quite targeted, essentially a one-line change to the existing <code>OsStr::starts_with</code> method, plus a new pure helper function and some tests. I haven't tried to comb the codebase for all the places where <code>OsStr</code> is assumed to be valid Unicode, but this single change at least seems to fix my use case. I want to add a couple more tests, then I'll submit a proper PR.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/kbknapp">@kbknapp</a> on 2020-05-05 16:50</div>
            <div class="timeline-body"><p>There shouldn't be many places where <code>OsStr</code> is assumed valid Unicode. Also see the potentially relevant PR #1893 the underlying code is different since its on the 3.x master branch, but deals with <code>OsStr::starts_with</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/pksunkara">@pksunkara</a> on 2020-05-05 17:39</div>
            <div class="timeline-body"><p>I think this was fixed in master because of the recent refactor done on OsStr by @dylni. It was a pretty big change (IMO).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/1907.html">clap-rs/clap#1907</a> on 2020-05-05 20:11</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/oconnor663">@oconnor663</a> on 2020-05-05 20:16</div>
            <div class="timeline-body"><p>I've submitted https://github.com/clap-rs/clap/pull/1907. Despite appearances, I think this is a targeted fix :) Most of the code in there is new tests. The meat of the change is that I've defined the <code>windows_osstr_starts_with</code> standalone function on Windows only, and I've changed <code>OsStr::starts_with</code> to call that instead on Windows. This fixes the simplest cases of invalid Unicode parsing, but it leaves panics in place for cases like <code>--arg=[invalid]</code>, which would require string splitting and therefore allocation and a broader API change. So this is not nearly as thorough as the refactoring that @pksunkara mentioned, but hopefully it's small enough that it's unlikely to introduce new bugs.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dylni">@dylni</a> on 2020-05-05 20:38</div>
            <div class="timeline-body"><p>Thanks for the ping @pksunkara. Yes, this was fixed in <a href="https://github.com/clap-rs/clap/pull/1852">this pull request</a>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/kbknapp">@kbknapp</a> on 2020-05-07 18:19</div>
            <div class="timeline-body"><blockquote>
<p>I think this was fixed in master because of the recent refactor done on OsStr by @dylni. It was a pretty big change (IMO).</p>
</blockquote>
<p>Yeah that's why I referenced the other PR (part of the refactor). I haven't had time the last day or so, but I'll look at this new PR by this weekend and see if it's something that could go on the 2.x branch with the understanding that if v2-master is currently broken, so long as we don't <em>break more</em> we're in a slightly better spot even if its not a total fix.</p>
<p>Once v3 is fully released I fully intend to EOL v2 except for hard security patches</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @pksunkara on 2020-05-11 16:42</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:35:07 UTC
    </footer>
</body>
</html>
