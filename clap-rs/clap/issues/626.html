<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panic with help wrapping at certain widths with non-English characters - clap-rs/clap #626</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Panic with help wrapping at certain widths with non-English characters</h1>

    <div class="meta">
        <span class="state state-closed">Closed</span>
        <a href="https://github.com/clap-rs/clap/issues/626">#626</a>
        opened by <a href="https://github.com/mac-book-pro">@mac-book-pro</a>
        on 2016-08-24 02:32
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/mac-book-pro">@mac-book-pro</a> on 2016-08-24 02:32</div>
            <div class="timeline-body"><p>Hello,</p>
<p>First of all, thank you for your work. This is the best-looking argument parser for Rust, and I say this because I've tried all the others.</p>
<p>Here is my problem: I am writing a program whose messages are in French, and &quot;clap&quot; has a major problem with non-English letters. When a line contains a French accent (like &quot;é&quot; in &quot;café&quot;), then <strong>the next lines will often have a missing letter and sometimes the program will even crash</strong>!</p>
<p>Steps to reproduce the problem:</p>
<ol>
<li>Take the &quot;My Super Program&quot; example in the &quot;clap&quot; documentation.</li>
<li>Replace:</li>
</ol>
<pre><code>                          .arg(Arg::with_name(&quot;config&quot;)
                               .short(&quot;c&quot;)
                               .long(&quot;config&quot;)
                               .value_name(&quot;FILE&quot;)
                               .help(&quot;Sets a custom config file&quot;)
                               .takes_value(true))
</code></pre>
<p>with:</p>
<pre><code>                          .arg(Arg::with_name(&quot;cafe&quot;)
                               .short(&quot;c&quot;)
                               .long(&quot;cafe&quot;)
                               .value_name(&quot;FILE&quot;)
                               .help(&quot;A coffeehouse, coffee shop, or café is an establishment which primarily serves hot coffee, related coffee beverages (e.g., café latte, cappuccino, espresso), tea, and other hot beverages. Some coffeehouses also serve cold beverages such as iced coffee and iced tea. Many cafés also serve some type of food, such as light snacks, muffins, or pastries.&quot;)
                               .takes_value(true))
</code></pre>
<p>Now, here is the output when I run &quot;my_super_program -h&quot;. <strong>Notice the missing letters</strong>:</p>
<pre><code>OPTIONS:
    -c, --cafe &lt;FILE&gt;    A coffeehouse, coffee shop, or café is an
                         establishment which primarily serves hot
                         coffee, related coffee beverages (e.g., caf
                          latte, cappuccino, espresso), tea, and 
                         ther hot beverages. Some coffeehouses 
                         lso serve cold beverages such as iced coffe
                          and iced tea. Many cafés also serve 
                         ome type of food, such as light snacks, 
                         uffins, or pastries.
</code></pre>
<p>If I replace all occurrences of &quot;café&quot; with &quot;cafe&quot;, then the problem disappears:</p>
<pre><code>OPTIONS:
    -c, --cafe &lt;FILE&gt;    A coffeehouse, coffee shop, or cafe is an
                         establishment which primarily serves hot
                         coffee, related coffee beverages (e.g.,
                         cafe latte, cappuccino, espresso), tea, and
                         other hot beverages. Some coffeehouses also
                         serve cold beverages such as iced coffee
                         and iced tea. Many cafes also serve some
                         type of food, such as light snacks,
                         muffins, or pastries.
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/mac-book-pro">@mac-book-pro</a> on 2016-08-24 02:51</div>
            <div class="timeline-body"><p>P.S. Crashes are more difficult to reproduce, cause they happen only with certain strings and only at certain Terminal widths. I managed to get a crash with this string:</p>
<blockquote>
<p>La culture du café est très développée dans de nombreux pays à climat chaud d'Amérique, d'Afrique et d'Asie, dans des plantations qui sont cultivées pour les marchés d'exportation. Le café est souvent une contribution majeure aux exportations des régions productrices.</p>
</blockquote>
<p>at a Terminal width of 53.</p>
<p>Here is the crash message:</p>
<blockquote>
<p>thread 'main' panicked at 'index 27 and/or 278 in <code>La culture du café est très développée dans de nombreux pays à climat chaud d'Amérique, d'Afrique et d'Asie, dans des plantations qui sont cultivées pour les marchés d'exportation. Le café est souvent une contribution majeure aux exportations des</code>[...] do not lie on character boundary', src/libcore/str/mod.rs:1694
note: Run with <code>RUST_BACKTRACE=1</code> for a backtrace.</p>
</blockquote>
<p>and here is the backtrace:</p>
<pre><code>   1:        0x108be1f0b - std::sys::backtrace::tracing::imp::write::h46e546df6e4e4fe6
   2:        0x108be39ba - std::panicking::default_hook::_$u7b$$u7b$closure$u7d$$u7d$::h077deeda8b799591
   3:        0x108be35ea - std::panicking::default_hook::heb8b6fd640571a4f
   4:        0x108bd9b18 - std::panicking::rust_panic_with_hook::hd7b83626099d3416
   5:        0x108be3f96 - std::panicking::begin_panic::h941ea76fc945d925
   6:        0x108bda418 - std::panicking::begin_panic_fmt::h30280d4dd3f149f5
   7:        0x108be3bef - rust_begin_unwind
   8:        0x108c05a00 - core::panicking::panic_fmt::h2d3cc8234dde51b4
   9:        0x108c07263 - core::str::slice_error_fail::h52e7d9a886dfadad
  10:        0x108b6a00c - core::str::traits::_&lt;impl core..ops..Index&lt;core..ops..RangeFrom&lt;usize&gt;&gt; for str&gt;::index::hae3efe4d2fd41a44
  11:        0x108b95fcc - _&lt;collections..string..String as core..ops..Index&lt;core..ops..RangeFrom&lt;usize&gt;&gt;&gt;::index::h2776c932194621d4
  12:        0x108b90be1 - clap::app::help::Help::help::h4e736e23b2bf6767
  13:        0x108b8ae36 - clap::app::help::Help::write_arg::h6b1c5590812eb874
  14:        0x108bae3e9 - clap::app::help::Help::write_args::h7f76616531e7ab78
  15:        0x108b9ed0f - clap::app::help::Help::write_all_args::hff215fca3a458728
  16:        0x108b8a385 - clap::app::help::Help::write_default_help::h1911ba4266439bc3
  17:        0x108b85f1d - clap::app::help::Help::write_help::h4ab97c1c6d787508
  18:        0x108b85af1 - clap::app::help::Help::_write_parser_help::hb389450f764af0bb
  19:        0x108b668fe - clap::app::help::Help::write_parser_help::he57c8864e7dfa953
  20:        0x108b22325 - clap::app::parser::Parser::_help::h909f2da6702da918
  21:        0x108b6649c - clap::app::parser::Parser::check_for_help_and_version_char::h4bc041acdba1d9c1
  22:        0x108b1873a - clap::app::parser::Parser::parse_short_arg::h88cdbf6fe8ff0e76
  23:        0x108af64ff - clap::app::parser::Parser::get_matches_with::h06a01c2e0bb5e937
  24:        0x108af4657 - clap::app::App::get_matches_from_safe_borrow::h7f35299f8c8987a4
  25:        0x108af2a1f - clap::app::App::get_matches_from::h79b7a634eb603528
  26:        0x108af291d - clap::app::App::get_matches::ha8c731e902ab9263
  27:        0x108ad95a5 - my_super_program::main::h55e4153564d8d093
  28:        0x108be31cd - std::panicking::try::call::hca715a47aa047c49
  29:        0x108be406b - __rust_try
  30:        0x108be4005 - __rust_maybe_catch_panic
  31:        0x108be2ff1 - std::rt::lang_start::h162055cb2e4b9fe7
  32:        0x108ae4eb9 - main
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/kbknapp">@kbknapp</a> on 2016-08-24 23:14</div>
            <div class="timeline-body"><p>Thank you for taking the time to file this and with such detail! I think I know the root cause of this and will have to play with some additional dependencies to get this right. I'll post back here with what I find or any additional questions.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">T: bug</span> added by @kbknapp on 2016-08-24 23:14</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">P2: need to have</span> added by @kbknapp on 2016-08-24 23:14</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">C: help message</span> added by @kbknapp on 2016-08-24 23:14</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">D: intermediate</span> added by @kbknapp on 2016-08-24 23:14</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">W: 2.x</span> added by @kbknapp on 2016-08-24 23:14</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/kbknapp">@kbknapp</a> on 2016-08-25 01:55</div>
            <div class="timeline-body"><p>Both of these issues are fixed with #628</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @homu on 2016-08-25 02:42</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/mac-book-pro">@mac-book-pro</a> on 2016-08-25 04:50</div>
            <div class="timeline-body"><p>Thank you for patching and for writing such complete tester functions!</p>
<p>The problem with the stripped characters has been solved in v2.10.3.</p>
<p>However, <strong>the panics continue</strong>. The tester function didn't catch them, because the panics now happen at Terminal widths different from v2.10.2.</p>
<p>Steps to reproduce the panics:</p>
<ol>
<li>Open &quot;/tests/help.rs&quot;</li>
<li>In function &quot;issue_626_panic()&quot;, replace:</li>
</ol>
<p><code>.set_term_width(53)</code></p>
<p>with:</p>
<p><code>.set_term_width(52)</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/kbknapp">@kbknapp</a> on 2016-08-25 12:03</div>
            <div class="timeline-body"><p>Interesting, thanks for letting me know!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Reopened by @kbknapp on 2016-08-25 12:03</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "Major problem with French accents" to "Panic with help wrapping at certain widths with non-English characters" by @kbknapp on 2016-08-25 21:56</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/kbknapp">@kbknapp</a> on 2016-08-25 22:52</div>
            <div class="timeline-body"><p>This should be fixed for good with #629 :wink:</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @homu on 2016-08-26 00:05</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:35:06 UTC
    </footer>
</body>
</html>
