<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>When the user specifies a global, the env variable is still validated - clap-rs/clap #5588</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>When the user specifies a global, the env variable is still validated</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/clap-rs/clap/issues/5588">#5588</a>
        opened by <a href="https://github.com/xobs">@xobs</a>
        on 2024-07-19 14:34
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/xobs">@xobs</a></div>
            <div class="timeline-body">Please complete the following tasks
<ul>
<li>[X] I have searched the <a href="https://github.com/clap-rs/clap/discussions">discussions</a></li>
<li>[X] I have searched the <a href="https://github.com/clap-rs/clap/issues">open</a> and <a href="https://github.com/clap-rs/clap/issues?q=is%3Aissue+label%3AS-wont-fix+is%3Aclosed">rejected</a> issues</li>
</ul>
Rust Version
<p>rustc 1.79.0 (129f3b996 2024-06-10)</p>
Clap Version
<p>4.5.9</p>
Minimal reproducible code
<pre><code>use clap::{Args, Parser, Subcommand};

#[derive(Parser)]
struct Cli {
    #[clap(subcommand)]
    command: Command,

    #[clap(flatten)]
    global_args: GlobalArgs,
}

#[derive(Args, Debug)]
struct GlobalArgs {
    // This fails if you run `claptest -v info`,
    // but works if you delete either `global = true` or `env = &quot;V&quot;`
    #[clap(global = true, short, env = &quot;V&quot;)]
    verbose: bool,
}

#[derive(Subcommand)]
enum Command {
    Info(InfoArgs),
}

#[derive(Args)]
pub struct InfoArgs {
}

fn main() {
    let args = std::env::args().collect::&lt;Vec&lt;String&gt;&gt;();

    if args.contains(&amp;&quot;-v&quot;.to_owned()) {
        std::env::set_var(&quot;V&quot;, &quot;1&quot;);
    }

    let cli = Cli::parse_from(args);
    if cli.global_args.verbose {
        println!(&quot;Verbose mode enabled&quot;);
    } else {
        println!(&quot;Verbose mode disabled&quot;);
    }
}
</code></pre>
Steps to reproduce the bug with the above code
<p>Cargo.toml:</p>
<pre><code>[dependencies]
clap = { version = &quot;4&quot;, features = [&quot;derive&quot;, &quot;env&quot;] }
</code></pre>
<p>Run with:</p>
<pre><code>cargo run -- -v info
</code></pre>
<p>Afterwards, remove <code>global = true</code> OR <code>env = &quot;V&quot;</code> and observe that it works.</p>
Actual Behaviour
<pre><code>$ cargo run -- -v info
   Compiling claptest v0.1.0 (E:\Code\claptest)
    Finished `dev` profile [unoptimized + debuginfo] target(s) in 0.66s
     Running `target\debug\claptest.exe -v info`
error: invalid value &#x27;1&#x27; for &#x27;-v&#x27;
  [possible values: true, false]

For more information, try &#x27;--help&#x27;.
error: process didn&#x27;t exit successfully: `target\debug\claptest.exe -v info` (exit code: 2)

$
</code></pre>
Expected Behaviour
<p>When removing <code>global = true</code> or <code>env = &quot;V&quot;</code> it works correctly:</p>
<pre><code>$ cargo run -- -v info
   Compiling claptest v0.1.0 (E:\Code\claptest)
    Finished `dev` profile [unoptimized + debuginfo] target(s) in 0.68s
     Running `target\debug\claptest.exe -v info`
Verbose mode enabled
$
</code></pre>
Additional Context
<p>The purpose of this code is to allow passing <code>V=1</code> to a function that sets up logging before clap is run. Since <code>env_logger</code> cannot change its level once it&#x27;s initialized, we need to do this odd dance.</p>
<p>The issue here is that behaviour changes with <code>env = &quot;V&quot;</code> and <code>global = true</code>. It seems to only happen when the following three things are true:</p>
<ol>
<li>The argument has <code>global = true</code> AND <code>env = &quot;V&quot;</code></li>
<li>The environment variable is 1 OR <code>-v</code> is specified</li>
<li>A subcommand is present</li>
</ol>
<p>If any condition is missing, the issue does not trigger.</p>
Debug Output
<pre><code>$ cargo run -- -v info
    Blocking waiting for file lock on package cache
   Compiling rustc-demangle v0.1.24
   Compiling cfg-if v1.0.0
   Compiling backtrace v0.3.73
   Compiling clap_builder v4.5.9
   Compiling clap v4.5.9
   Compiling claptest v0.1.0 (E:\Code\claptest)
    Finished `dev` profile [unoptimized + debuginfo] target(s) in 4.90s
     Running `target\debug\claptest.exe -v info`
[clap_builder::builder::command]Command::_do_parse
[clap_builder::builder::command]Command::_build: name=&quot;claptest&quot;
[clap_builder::builder::command]Command::_propagate:claptest
[clap_builder::builder::command]Command::_check_help_and_version:claptest expand_help_tree=false
[clap_builder::builder::command]Command::long_help_exists
[clap_builder::builder::command]Command::_check_help_and_version: Building default --help
[clap_builder::builder::command]Command::_check_help_and_version: Building help subcommand
[clap_builder::builder::command]Command::_propagate_global_args:claptest
[clap_builder::builder::command]Command::_propagate pushing &quot;verbose&quot; to info
[clap_builder::builder::debug_asserts]Command::_debug_asserts
[clap_builder::builder::debug_asserts]Arg::_debug_asserts:verbose
[clap_builder::builder::debug_asserts]Arg::_debug_asserts:help
[clap_builder::builder::debug_asserts]Command::_verify_positionals
[clap_builder::parser::parser]Parser::get_matches_with
[clap_builder::parser::parser]Parser::get_matches_with: Begin parsing &#x27;&quot;-v&quot;&#x27;
[clap_builder::parser::parser]Parser::possible_subcommand: arg=Ok(&quot;-v&quot;)
[clap_builder::parser::parser]Parser::get_matches_with: sc=None
[clap_builder::parser::parser]Parser::parse_short_arg: short_arg=ShortFlags { inner: &quot;v&quot;, utf8_prefix: CharIndices { front_offset: 0, iter: Chars([&#x27;v&#x27;]) }, invalid_suffix: None }
[clap_builder::parser::parser]Parser::parse_short_arg:iter:v
[clap_builder::parser::parser]Parser::parse_short_arg:iter:v: Found valid opt or flag
[clap_builder::parser::parser]Parser::react action=SetTrue, identifier=Some(Short), source=CommandLine
[clap_builder::parser::parser]Parser::react: has default_missing_vals
[clap_builder::parser::parser]Parser::remove_overrides: id=&quot;verbose&quot;
[clap_builder::parser::arg_matcher]ArgMatcher::start_custom_arg: id=&quot;verbose&quot;, source=CommandLine
[clap_builder::builder::command]Command::groups_for_arg: id=&quot;verbose&quot;
[clap_builder::parser::arg_matcher]ArgMatcher::start_custom_arg: id=&quot;GlobalArgs&quot;, source=CommandLine
[clap_builder::parser::parser]Parser::push_arg_values: [&quot;true&quot;]
[clap_builder::parser::parser]Parser::add_single_val_to_arg: cur_idx:=1
[clap_builder::parser::parser]Parser::get_matches_with: After parse_short_arg ValuesDone
[clap_builder::parser::parser]Parser::get_matches_with: Begin parsing &#x27;&quot;info&quot;&#x27;
[clap_builder::parser::parser]Parser::possible_subcommand: arg=Ok(&quot;info&quot;)
[clap_builder::parser::parser]Parser::get_matches_with: sc=Some(&quot;info&quot;)
[clap_builder::parser::parser]Parser::parse_subcommand
[ clap_builder::output::usage]Usage::get_required_usage_from: incls=[], matcher=false, incl_last=true
[ clap_builder::output::usage]Usage::get_required_usage_from: unrolled_reqs=[]
[ clap_builder::output::usage]Usage::get_required_usage_from: ret_val=[]
[clap_builder::builder::command]Command::_build_subcommand Setting bin_name of info to &quot;claptest.exe info&quot;
[clap_builder::builder::command]Command::_build_subcommand Setting display_name of info to &quot;claptest-info&quot;
[clap_builder::builder::command]Command::_build: name=&quot;info&quot;
[clap_builder::builder::command]Command::_propagate:info
[clap_builder::builder::command]Command::_check_help_and_version:info expand_help_tree=false
[clap_builder::builder::command]Command::long_help_exists
[clap_builder::builder::command]Command::_check_help_and_version: Building default --help
[clap_builder::builder::command]Command::_propagate_global_args:info
[clap_builder::builder::debug_asserts]Command::_debug_asserts
[clap_builder::builder::debug_asserts]Arg::_debug_asserts:verbose
[clap_builder::builder::debug_asserts]Arg::_debug_asserts:help
[clap_builder::builder::debug_asserts]Command::_verify_positionals
[clap_builder::parser::parser]Parser::parse_subcommand: About to parse sc=info
[clap_builder::parser::parser]Parser::get_matches_with
[clap_builder::parser::parser]Parser::add_env
[clap_builder::parser::parser]Parser::add_env: Checking arg `-v`
[clap_builder::parser::parser]Parser::add_env: Found an opt with value=&quot;1&quot;
[clap_builder::parser::parser]Parser::react action=SetTrue, identifier=None, source=EnvVariable
[clap_builder::parser::arg_matcher]ArgMatcher::start_custom_arg: id=&quot;verbose&quot;, source=EnvVariable
[clap_builder::builder::command]Command::groups_for_arg: id=&quot;verbose&quot;
[clap_builder::parser::parser]Parser::push_arg_values: [&quot;1&quot;]
[clap_builder::parser::parser]Parser::add_single_val_to_arg: cur_idx:=1
[clap_builder::builder::command]Command::color: Color setting...
[clap_builder::builder::command]Auto
[clap_builder::builder::command]Command::color: Color setting...
[clap_builder::builder::command]Auto
error: invalid value &#x27;1&#x27; for &#x27;-v&#x27;
  [possible values: true, false]

For more information, try &#x27;--help&#x27;.
error: process didn&#x27;t exit successfully: `target\debug\claptest.exe -v info` (exit code: 2)
$
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">C-bug</span> added by <a href="https://github.com/xobs">@xobs</a> on 2024-07-19 14:34</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2024-07-19 14:53</div>
            <div class="timeline-body"><p>I don&#x27;t think I quite understand your concern.</p>
<p>You are telling clap that <code>--verbose</code> should have a <code>V</code> environment variable associated with it.  Most of the other changes you mention seem tangential to that; the main problem seems to be about whether <code>1</code> is accepted for <code>--verbose</code>s <code>V</code>.  The default <code>value_parser</code> for <code>bool</code> is <a href="https://docs.rs/clap/latest/clap/builder/struct.BoolValueParser.html"><code>BoolValueParser</code></a>.  You might be interested in <a href="https://docs.rs/clap/latest/clap/builder/struct.BoolishValueParser.html"><code>value_parser = BoolishValueParser</code></a>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/xobs">@xobs</a> on 2024-07-19 15:02</div>
            <div class="timeline-body"><p>Isn&#x27;t it the case where <code>bool</code> types will set the value to <code>true</code> if they exist? If so, it shouldn&#x27;t matter whether the value is <code>1</code>, <code>true</code>, or something else.</p>
<p>The issue is that it does this normally, unless you have both <code>global = true</code> and <code>env = &quot;V&quot;</code>.</p>
<p>I think what happens is that with <code>global = true</code> and <code>env = &quot;V&quot;</code> it checks both the environment AND the flag, but with only one or the other it short-circuits if the <code>-v</code> argument is present.</p>
<p>The short-circuit is what was confusing me -- why would <code>global = true</code> cause it to evaluate both command line flags and environment variables, even if the command line flag exists? If that&#x27;s a known behaviour, then that explains this issue and it can be closed.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from &quot;Cryptic error: `invalid value &quot;1&quot; for -v`&quot; to &quot;When the user specifies a global, the env variable is still validated&quot; by <a href="https://github.com/epage">@epage</a> on 2024-07-19 16:05</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">A-parsing</span> added by <a href="https://github.com/epage">@epage</a> on 2024-07-19 16:05</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">S-waiting-on-design</span> added by <a href="https://github.com/epage">@epage</a> on 2024-07-19 16:05</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2024-07-19 16:06</div>
            <div class="timeline-body"><blockquote>
<p>The short-circuit is what was confusing me -</p>
</blockquote>
<p>Thanks for the clarification</p>
<p>Currently, we parse a command at a time, including</p>
<ul>
<li>applying envs</li>
<li>applying defaults</li>
<li>validating</li>
</ul>
<p>and then we process globals.</p>
<p>There are subtle aspects to this that will need care to resolve.  In particular, a solution should keep in mind some of our other issues around globals</p>
<ul>
<li>#1204</li>
<li>#1546</li>
<li>#1570</li>
<li>#3938</li>
<li>#5020</li>
</ul>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 20:00:14 UTC
    </footer>
</body>
</html>
