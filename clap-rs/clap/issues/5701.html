<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Completing a CLI with `&lt;mask&gt;... &lt;file&gt;` never offers `&lt;file&gt;` completions with Rust native completions - clap-rs/clap #5701</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Completing a CLI with <code>&lt;mask&gt;... &lt;file&gt;</code> never offers <code>&lt;file&gt;</code> completions with Rust native completions</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/clap-rs/clap/issues/5701">#5701</a>
        opened by <a href="https://github.com/windsource">@windsource</a>
        on 2024-08-26 11:18
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/windsource">@windsource</a></div>
            <div class="timeline-body">Please complete the following tasks
<ul>
<li>[X] I have searched the <a href="https://github.com/clap-rs/clap/discussions">discussions</a></li>
<li>[X] I have searched the <a href="https://github.com/clap-rs/clap/issues">open</a> and <a href="https://github.com/clap-rs/clap/issues?q=is%3Aissue+label%3AS-wont-fix+is%3Aclosed">rejected</a> issues</li>
</ul>
Rust Version
<p>rustc 1.80.1 (3f5fd8dd4 2024-08-06)</p>
Clap Version
<p>clap 4.5.16, clap_complete 4.5.23</p>
Minimal reproducible code
<pre><code>use std::ffi::OsStr;

use clap::{CommandFactory, Parser, ValueHint};
use clap_complete::{ArgValueCompleter, CompleteEnv, CompletionCandidate};

fn mask_completer(_: &amp;OsStr) -&gt; Vec&lt;CompletionCandidate&gt; {
    vec![
        CompletionCandidate::new(&quot;foo&quot;),
        CompletionCandidate::new(&quot;baz&quot;),
    ]
}

#[derive(Parser, Debug)]
#[command(name = &quot;cmdtest&quot;)]
#[command(version, about, long_about = None)]
struct Args {
    #[arg(required = true, add = ArgValueCompleter::new(mask_completer))]
    mask: Vec&lt;String&gt;,

    #[arg(required = true, value_hint = ValueHint::FilePath)]
    file: String,
}

fn main() {
    CompleteEnv::with_factory(Args::command).complete();

    let args = Args::parse();

    for m in args.mask {
        println!(&quot;Mask: {}&quot;, m);
    }
    println!(&quot;File: {}&quot;, args.file)
}

</code></pre>
Steps to reproduce the bug with the above code
<p>cmdtest foo AND PRESSING TAB</p>
Actual Behaviour
<p>As completion candidates I only get &quot;foo&quot; and &quot;baz&quot;</p>
Expected Behaviour
<p>I was expecting to &quot;foo&quot;, &quot;baz&quot; and the files in the current folder as completion candidates.</p>
Additional Context
<p>After the first argument for <code>mask</code> is passed, the next argument could either be a <code>mask</code> or a <code>file</code> so I was expecting to get completions for both but I only get completions for <code>mask</code>.</p>
<p>I am using zsh.</p>
Debug Output
<p><em>No response</em></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">C-bug</span> added by <a href="https://github.com/windsource">@windsource</a> on 2024-08-26 11:18</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a>eclipse-ankaios/ankaios#348</a> on 2024-08-26 11:20</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">E-medium</span> added by <a href="https://github.com/epage">@epage</a> on 2024-08-26 16:16</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">A-completion</span> added by <a href="https://github.com/epage">@epage</a> on 2024-08-26 16:16</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2024-08-26 16:37</div>
            <div class="timeline-body"><p>This is parsing two positionals in a row with the first positional&#x27;s length being unbounded.  This is a very complicated case in the parser that we&#x27;ve not covered yet with the new completions.  Currently, our quality bar is &quot;is it as good as the old completions&quot;.  If you happened to use the old completions before and can report back on its behavior in this scenario, that can help us prioritize this.</p>
<p>See
https://github.com/clap-rs/clap/blob/fe810907bdba9c81b980ed340addace44cefd8ff/clap_builder/src/parser/parser.rs#L288-L358</p>
<p>What will be interesting about this case is that  <code>clap</code> definitively knows when <code>mask</code> is done and <code>file</code> starts because it can peek ahead on the command-line.  While the command-line is being written, we can&#x27;t guarantee there will be anything to peek ahead to.  Effectively, we&#x27;ll need to just assume that any positional after the minimum possible is either <code>mask</code> or <code>file</code> and complete it as such.</p>
<p>To help in showing either completion, we should probably group completions by their argument by default (see #5651).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/windsource">@windsource</a> on 2024-08-27 08:25</div>
            <div class="timeline-body"><p>@epage not sure what you mean with &quot;old completions&quot;? Is there any older clap_complete release which I should try to see if the completions for my scenario work with?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2024-08-27 13:35</div>
            <div class="timeline-body"><p><code>CompleteEnv</code> is an in-work completion system that is unstable.  <a href="https://docs.rs/clap_complete/latest/clap_complete/aot/index.html"><code>clap_complete::aot</code></a> is what we have historically provided.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from &quot;Missing some completions&quot; to &quot;Completing a CLI with `&lt;mask&gt;... &lt;file&gt;` never offers `&lt;file&gt;` completions with Rust native completions&quot; by <a href="https://github.com/epage">@epage</a> on 2024-08-27 13:36</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a>eclipse-ankaios/ankaios#237</a> on 2024-09-05 14:18</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 20:00:18 UTC
    </footer>
</body>
</html>
