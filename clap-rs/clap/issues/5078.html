<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>`Option` arg cannot have `None` as default value - clap-rs/clap #5078</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1><code>Option</code> arg cannot have <code>None</code> as default value</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/clap-rs/clap/issues/5078">#5078</a>
        opened by <a href="https://github.com/justinlovinger">@justinlovinger</a>
        on 2023-08-17 19:55
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/justinlovinger">@justinlovinger</a> on 2023-08-17 19:55</div>
            <div class="timeline-body"><h3>Please complete the following tasks</h3>
<ul>
<li>[X] I have searched the <a href="https://github.com/clap-rs/clap/discussions">discussions</a></li>
<li>[X] I have searched the <a href="https://github.com/clap-rs/clap/issues">open</a> and <a href="https://github.com/clap-rs/clap/issues?q=is%3Aissue+label%3AS-wont-fix+is%3Aclosed">rejected</a> issues</li>
</ul>
<h3>Rust Version</h3>
<p>rustc 1.70.0 (90c541806 2023-05-31) (built from a source tarball)</p>
<h3>Clap Version</h3>
<p>4.3.21</p>
<h3>Minimal reproducible code</h3>
<pre><code class="language-rust">#[derive(Parser)]
struct Args {
    #[arg(long, num_args = 0..=1, default_value = &quot;[]&quot;)]
    foo: Option&lt;usize&gt;,
}

fn main() {
    let args = Args::parse();
}
</code></pre>
<h3>Steps to reproduce the bug with the above code</h3>
<p><code>cargo run</code></p>
<h3>Actual Behaviour</h3>
<p>The program exits with <code>error: invalid value '[]' for '--foo [&lt;FOO&gt;]': invalid digit found in string</code>.</p>
<h3>Expected Behaviour</h3>
<p>The program should run with <code>args.foo</code> set to <code>None</code>.</p>
<h3>Additional Context</h3>
<p><code>num_args = 0..=1</code> disables the implied <code>required = false</code> behavior of <code>Option&lt;T&gt;</code>.</p>
<p><code>--foo []</code> <em>is</em> valid if entered from the command line. It is only not valid when used as a default value.</p>
<p><code>default_value_t = None</code> fails because <code>Option</code> does not implement <code>Display</code>.</p>
<h3>Debug Output</h3>
<p>[clap_builder::builder::command]Command::_do_parse
[clap_builder::builder::command]Command::_build: name=&quot;owm&quot;
[clap_builder::builder::command]Command::_propagate:owm
[clap_builder::builder::command]Command::_check_help_and_version:owm expand_help_tree=false
[clap_builder::builder::command]Command::long_help_exists
[clap_builder::builder::command]Command::_check_help_and_version: Building default --help
[clap_builder::builder::command]Command::_propagate_global_args:owm
[clap_builder::builder::debug_asserts]Command::_debug_asserts
[clap_builder::builder::debug_asserts]Arg::_debug_asserts:foo
[clap_builder::builder::debug_asserts]Arg::_debug_asserts:help
[clap_builder::builder::debug_asserts]Command::_verify_positionals
[clap_builder::parser::parser]Parser::get_matches_with
[clap_builder::parser::parser]Parser::add_defaults
[clap_builder::parser::parser]Parser::add_defaults:iter:foo:
[clap_builder::parser::parser]Parser::add_default_value: doesn't have conditional defaults
[clap_builder::parser::parser]Parser::add_default_value:iter:foo: has default vals
[clap_builder::parser::parser]Parser::add_default_value:iter:foo: wasn't used
[clap_builder::parser::parser]Parser::react action=Set, identifier=None, source=DefaultValue
[clap_builder::parser::arg_matcher]ArgMatcher::start_custom_arg: id=&quot;foo&quot;, source=DefaultValue
[clap_builder::parser::parser]Parser::push_arg_values: [&quot;[]&quot;]
[clap_builder::parser::parser]Parser::add_single_val_to_arg: cur_idx:=1
[clap_builder::builder::command]Command::color: Color setting...
[clap_builder::builder::command]Auto
[clap_builder::builder::command]Command::color: Color setting...
[clap_builder::builder::command]Auto
error: invalid value '[]' for '--foo [<FOO>]': invalid digit found in string</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">C-bug</span> added by @justinlovinger on 2023-08-17 19:55</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2023-08-18 13:33</div>
            <div class="timeline-body"><pre><code class="language-rust">#[derive(Parser)]
struct Args {
    #[arg(long, num_args = 0..=1, default_value = &quot;[]&quot;)]
    foo: Option&lt;usize&gt;,
}
</code></pre>
<p>says to parse <code>[]</code> as a <code>usize</code></p>
<pre><code class="language-rust">#[derive(Parser)]
struct Args {
    #[arg(long, num_args = 0..=1, default_value_t = None)]
    foo: Option&lt;usize&gt;,
}
</code></pre>
<p>Recognizes <code>usize</code> as the core type and expects <code>default_value_t</code> to be for the core type.  There are other advanced features you can use to override that to make it <code>None</code> which is why this makes sense.</p>
<pre><code class="language-rust">#[derive(Parser)]
struct Args {
    #[arg(long, num_args = 0..=1, default_value_t)]
    foo: Option&lt;usize&gt;,
}
</code></pre>
<p>Says to use `Default::default</p>
<blockquote>
<p>--foo [] is valid if entered from the command line. It is only not valid when used as a default value.</p>
</blockquote>
<p>Not for me:</p>
<pre><code class="language-console">$ ./clap-5078.rs --foo []
warning: `package.edition` is unspecified, defaulting to `2021`
warning: unused variable: `args`
  --&gt; clap-5078.rs:19:9
   |
19 |     let args = Args::parse();
   |         ^^^^ help: if this is intentional, prefix it with an underscore: `_args`
   |
   = note: `#[warn(unused_variables)]` on by default

warning: `clap-5078` (bin &quot;clap-5078&quot;) generated 1 warning (run `cargo fix --bin &quot;clap-5078&quot;` to apply 1 suggestion)
    Finished dev [unoptimized + debuginfo] target(s) in 0.07s
     Running `/home/epage/.cargo/target/92/58a7b79897d359/debug/clap-5078 --foo '[]'`
error: invalid value '[]' for '--foo [&lt;FOO&gt;]': invalid digit found in string

For more information, try '--help'.
</code></pre>
<p>You might be running into shell specific logic where <code>[]</code> becomes <code>&quot;&quot;</code>.  If you do <code>'[]'</code>, then you will likely bypass shell processing and see what is actually happening when it is passed into clap.</p>
<blockquote>
<p>num_args = 0..=1 disables the implied required = false behavior of Option<T>.</p>
</blockquote>
<p>I'm not sure what this is referring to.  It doesn't do that for me.  I removed any defaulting and it runs as I would expect unless I'm missing something about what you are trying to accomplish.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/justinlovinger">@justinlovinger</a> on 2023-08-18 13:55</div>
            <div class="timeline-body"><blockquote>
<blockquote>
<p>num_args = 0..=1 disables the implied required = false behavior of Option.</p>
</blockquote>
</blockquote>
<blockquote>
<p>I'm not sure what this is referring to. It doesn't do that for me. I removed any defaulting and it runs as I would expect unless I'm missing something about what you are trying to accomplish.</p>
</blockquote>
<p>This is referring to overriding the &quot;assumed intent&quot;, <a href="https://docs.rs/clap/latest/clap/_derive/index.html#arg-types">https://docs.rs/clap/latest/clap/_derive/index.html#arg-types</a>. From my testing, it makes the core type <code>Option&lt;usize&gt;</code> instead of it being an optional <code>usize</code>. It is like <code>Option&lt;Option&lt;usize&gt;&gt;</code>, but without the extra <code>Option</code>.</p>
<blockquote>
<p>You might be running into shell specific logic where [] becomes &quot;&quot;. If you do '[]', then you will likely bypass shell processing and see what is actually happening when it is passed into clap.</p>
</blockquote>
<p>You may be right about this being shell-specific behavior. It appears equivalent to <code>--foo</code>. In which case, the core issue may be how to pass an explicit <code>None</code> value to an <code>Option</code> arg. <code>--foo &quot;&quot;</code> is not valid.</p>
<p>P.S. <code>Vec&lt;T&gt;</code> may have the same issue as I cannot find any way to pass an empty vector when using <code>value_delimiter = ','</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2023-08-18 14:11</div>
            <div class="timeline-body"><p>It might help if you stepped back and explained what you are trying to accomplish.  What behavior do you want out of <code>--foo</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/justinlovinger">@justinlovinger</a> on 2023-08-18 14:22</div>
            <div class="timeline-body"><p>I want <code>--foo</code> to either take some value, like <code>--foo 10</code>, or a &quot;none&quot; value, like <code>--foo None</code> or <code>--foo &quot;&quot;</code>.</p>
<p>For context, my application wraps a function that takes <code>max_width: Option&lt;usize&gt;</code> and <code>max_height: Option&lt;usize&gt;</code>. These can either be <code>Some(value)</code>, in which case the function will run with a max width or height, or <code>None</code>, in which case it will run with no max width or height. These values can be set with the CLI, and I am trying to reflect this behavior in the CLI.</p>
<p>Additionally, by default, the CLI sets a max width, <code>1920</code>, and no max height. The user should be able to set max width to <code>None</code> and set a value for max height. I want these clearly reflected in <code>--help</code>, so a user can look at the <code>--max-height</code> default, see it is set to &quot;no max height&quot;, understand that as a possibility, and understand they can pass the same value to <code>--max-width</code> to get the same behavior for width.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2023-08-18 14:57</div>
            <div class="timeline-body"><p>So you want to opt-out of special <code>Option</code> handling and have the <code>value_parser</code> return an <code>Option&lt;usize&gt;</code>.  Currently special handling is purely textual.  You can use <code>std::option::Option</code> or <code>type OptionUsize = Option&lt;usize&gt;</code> to work around this (see also #4626).</p>
<p>You can then do:</p>
<pre><code class="language-rust">fn parser(raw: &amp;str) -&gt; Result&lt;OptionUsize, String&gt; {
    if raw == &quot;None&quot; || raw.is_empty() {
        Ok(None)
    } else {
        raw.parse::&lt;usize&gt;().map(Some)
    }
}


...

#[derive(Parser)]
struct Args {
    #[arg(long, value_parser = parser)]
    foo: OptionUsize,
}
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/justinlovinger">@justinlovinger</a> on 2023-08-19 18:29</div>
            <div class="timeline-body"><p>That work for my case. I suppose the question then is, why does Clap not support <code>--foo &quot;&quot;</code> for <code>Option</code> types out of the box?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2023-08-20 00:14</div>
            <div class="timeline-body"><p>We don't know what the intention is for an empty string.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @epage on 2023-08-20 00:14</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 12:31:55 UTC
    </footer>
</body>
</html>
