<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Subcommand Conflicts with Argument (`derive` feature) - clap-rs/clap #5513</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Subcommand Conflicts with Argument (<code>derive</code> feature)</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/clap-rs/clap/issues/5513">#5513</a>
        opened by <a href="https://github.com/lkurcak">@lkurcak</a>
        on 2024-06-01 01:09
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/lkurcak">@lkurcak</a></div>
            <div class="timeline-body">Please complete the following tasks
<ul>
<li>[X] I have searched the <a href="https://github.com/clap-rs/clap/discussions">discussions</a></li>
<li>[X] I have searched the <a href="https://github.com/clap-rs/clap/issues">open</a> and <a href="https://github.com/clap-rs/clap/issues?q=is%3Aissue+label%3AS-wont-fix+is%3Aclosed">rejected</a> issues</li>
</ul>
Rust Version
<p>rustc 1.78.0 (9b00956e5 2024-04-29)</p>
Clap Version
<p>clap = { version = &quot;4.5.4&quot;, features = [&quot;derive&quot;] }</p>
Minimal reproducible code
<pre><code>use clap::{Parser, Subcommand};

#[derive(Debug, Parser)]
struct Cli {
    name: String,
    #[command(subcommand)]
    command: Commands,
}

#[derive(Debug, Subcommand)]
enum Commands {
    Test,
}

fn main() {
    let args = Cli::parse();

    dbg!(&amp;args);
}
</code></pre>
Steps to reproduce the bug with the above code
OK
<p>Positional name argument is <code>hello</code>, subcommand is <code>test</code>:</p>
<pre><code>cargo run -- hello test
</code></pre>
BAD
<p>Positional name argument is <code>test</code>, subcommand is <code>test</code>:</p>
<pre><code>cargo run -- test test
</code></pre>
Actual Behaviour
OK
<pre><code>cargo run -- hello test
[src\main.rs:18:5] &amp;args = Cli {
    name: &quot;hello&quot;,
    command: Test,
}
</code></pre>
BAD
<pre><code>cargo run -- test test
error: unexpected argument &#x27;test&#x27; found

Usage: testing.exe &lt;NAME&gt; test

For more information, try &#x27;--help&#x27;.
</code></pre>
Expected Behaviour
<p>Clap should parse the arguments positionally:</p>
<pre><code>cargo run -- test test
[src\main.rs:18:5] &amp;args = Cli {
    name: &quot;test&quot;,
    command: Test,
}
</code></pre>
Additional Context
<p><em>No response</em></p>
Debug Output
<p>cargo run -- test test
[clap_builder::builder::command]Command::_do_parse
[clap_builder::builder::command]Command::_build: name=&quot;testing&quot;
[clap_builder::builder::command]Command::_propagate:testing
[clap_builder::builder::command]Command::_check_help_and_version:testing expand_help_tree=false
[clap_builder::builder::command]Command::long_help_exists
[clap_builder::builder::command]Command::_check_help_and_version: Building default --help
[clap_builder::builder::command]Command::_check_help_and_version: Building help subcommand
[clap_builder::builder::command]Command::_propagate_global_args:testing
[clap_builder::builder::debug_asserts]Command::_debug_asserts
[clap_builder::builder::debug_asserts]Arg::_debug_asserts:name
[clap_builder::builder::debug_asserts]Arg::_debug_asserts:help
[clap_builder::builder::debug_asserts]Command::_verify_positionals
[clap_builder::parser::parser]Parser::get_matches_with
[clap_builder::parser::parser]Parser::get_matches_with: Begin parsing &#x27;&quot;test&quot;&#x27;
[clap_builder::parser::parser]Parser::possible_subcommand: arg=Ok(&quot;test&quot;)
[clap_builder::parser::parser]Parser::get_matches_with: sc=Some(&quot;test&quot;)
[clap_builder::parser::parser]Parser::parse_subcommand
[ clap_builder::output::usage]Usage::get_required_usage_from: incls=[], matcher=false, incl_last=true
[ clap_builder::output::usage]Usage::get_required_usage_from: unrolled_reqs=[&quot;name&quot;]
[ clap_builder::output::usage]Usage::get_required_usage_from:iter:&quot;name&quot; arg is_present=false
[ clap_builder::output::usage]Usage::get_required_usage_from: ret_val=[StyledStr(&quot;&quot;)]
[clap_builder::builder::command]Command::_build_subcommand Setting bin_name of test to &quot;testing.exe test&quot;
[clap_builder::builder::command]Command::_build_subcommand Setting display_name of test to &quot;testing-test&quot;
[clap_builder::builder::command]Command::_build: name=&quot;test&quot;
[clap_builder::builder::command]Command::_propagate:test
[clap_builder::builder::command]Command::_check_help_and_version:test expand_help_tree=false
[clap_builder::builder::command]Command::long_help_exists
[clap_builder::builder::command]Command::_check_help_and_version: Building default --help
[clap_builder::builder::command]Command::_propagate_global_args:test
[clap_builder::builder::debug_asserts]Command::_debug_asserts
[clap_builder::builder::debug_asserts]Arg::_debug_asserts:help
[clap_builder::builder::debug_asserts]Command::_verify_positionals
[clap_builder::parser::parser]Parser::parse_subcommand: About to parse sc=test
[clap_builder::parser::parser]Parser::get_matches_with
[clap_builder::parser::parser]Parser::get_matches_with: Begin parsing &#x27;&quot;test&quot;&#x27;
[clap_builder::parser::parser]Parser::possible_subcommand: arg=Ok(&quot;test&quot;)
[clap_builder::parser::parser]Parser::get_matches_with: sc=None
[clap_builder::parser::parser]Parser::get_matches_with: Positional counter...1
[clap_builder::parser::parser]Parser::get_matches_with: Low index multiples...false
[ clap_builder::output::usage]Usage::create_usage_with_title
[ clap_builder::output::usage]Usage::create_usage_no_title
[ clap_builder::output::usage]Usage::write_help_usage
[ clap_builder::output::usage]Usage::write_arg_usage; incl_reqs=true
[ clap_builder::output::usage]Usage::needs_options_tag
[ clap_builder::output::usage]Usage::needs_options_tag:iter: f=help
[ clap_builder::output::usage]Usage::needs_options_tag:iter Option is built-in
[ clap_builder::output::usage]Usage::needs_options_tag: [OPTIONS] not required
[ clap_builder::output::usage]Usage::write_args: incls=[]
[ clap_builder::output::usage]Usage::get_args: unrolled_reqs=[]
[ clap_builder::output::usage]Usage::write_subcommand_usage
[ clap_builder::output::usage]Usage::create_usage_with_title: usage=Usage: testing.exe  test
[clap_builder::builder::command]Command::color: Color setting...
[clap_builder::builder::command]Auto
[clap_builder::builder::command]Command::color: Color setting...
[clap_builder::builder::command]Auto
error: unexpected argument &#x27;test&#x27; found</p>
<p>Usage: testing.exe  test</p>
<p>For more information, try &#x27;--help&#x27;.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">C-bug</span> added by <a href="https://github.com/lkurcak">@lkurcak</a> on 2024-06-01 01:09</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">A-parsing</span> added by <a href="https://github.com/epage">@epage</a> on 2024-06-04 17:38</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">A-validators</span> added by <a href="https://github.com/epage">@epage</a> on 2024-06-04 17:38</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">S-waiting-on-design</span> added by <a href="https://github.com/epage">@epage</a> on 2024-06-04 17:38</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2024-06-04 17:44</div>
            <div class="timeline-body"><p>We have <a href="https://docs.rs/clap/latest/clap/struct.Command.html#method.subcommand_precedence_over_arg"><code>subcommand_precedence_over_arg</code></a> but that only applies to options; subcommands always have precedence over positionals today (the name makes it sounds more general).</p>
<p>Some potential routes to go</p>
<p>Do nothing, discouraging mixing of positionals being additive with subcommands.  maybe we could add some debug asserts to help with this though that can get complicated with various settings.</p>
<p>We break compatibility and default to positionals having higher precedence, controlled by <code>subcommand_precedence_over_arg</code>.</p>
<p>The parser could detect there are unsatisfied requireds and ensure give them precedene.  Like with the debug asserts for the &quot;do nothing&quot; solution, this get complicated due to the various states we can be in</p>
<p>Add a new setting to toggle control over this.  We&#x27;ve generally been working to shrinking the API, rather than growing it.  The more features we add to the API, the less value we get out of them because they become harder to discover and be used.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ZakharEl">@ZakharEl</a> on 2024-06-13 07:30</div>
            <div class="timeline-body"><p>I see no reason to do this. derive should not incur any runtime costs for unused features, only compile time. I agree with Lubomirkurcak. This makes your library unuseable for many use cases.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ZakharEl">@ZakharEl</a> on 2024-06-13 07:34</div>
            <div class="timeline-body"><p>I would agree with Epage&#x27;s case if the arg was an optional arg though.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a>feldera/feldera#2447</a> on 2024-09-08 06:27</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 20:00:10 UTC
    </footer>
</body>
</html>
