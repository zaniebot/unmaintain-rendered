<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>`clap` fails to compile if `serde_yaml` is used, because of `preserve_order` feature of `yaml-rust` - clap-rs/clap #747</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1><code>clap</code> fails to compile if <code>serde_yaml</code> is used, because of <code>preserve_order</code> feature of <code>yaml-rust</code></h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/clap-rs/clap/issues/747">#747</a>
        opened by <a href="https://github.com/emk">@emk</a>
        on 2016-11-13 17:06
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/emk">@emk</a></div>
            <div class="timeline-body"><h3>Rust Version</h3>
<p>rustc 1.14.0-nightly (cae6ab1c4 2016-11-05)</p>
<h3>Affected Version of clap</h3>
<p>2.18.0 (and <code>serde_yaml</code> 0.5.0)</p>
<h3>Expected Behavior Summary</h3>
<p>Clap should compile and link when <code>serde_yaml</code> 0.5.0 is being used in the same project.</p>
<h3>Actual Behavior Summary</h3>
<p>When <code>serde_yaml</code> and <code>clap</code> are linked into the same executable, compilation fails with the following error:</p>
<pre><code>error[E0308]: if and else have incompatible types
   --&gt; /home/emk/.cargo/registry/src/github.com-1ecc6299db9ec823/clap-2.18.0/src/args/group.rs:463:30
    |
463 |         let group_settings = if b.len() == 1 {
    |                              ^ expected struct `linked_hash_map::LinkedHashMap`, found struct `std::collections::BTreeMap`
    |
    = note: expected type `&amp;linked_hash_map::LinkedHashMap&lt;yaml_rust::Yaml, yaml_rust::Yaml&gt;`
    = note:    found type `&amp;'a std::collections::BTreeMap&lt;yaml_rust::Yaml, yaml_rust::Yaml&gt;`
</code></pre>
<p>The problem is that <code>serde_yaml</code> <a href="https://github.com/dtolnay/serde-yaml/blob/44456ddb34748fa2d40f565964961ff0515058c5/yaml/Cargo.toml#L17">configures <code>yaml-rust</code> to use the <code>preserve_order</code> feature</a>, which breaks <code>clap</code>, because <code>clap</code> doesn't expect the type of the exported <code>yaml-rust</code> APIs to change.</p>
<p>I'm going to file an issue with <code>serde_yaml</code> linking back here.</p>
<p>I'm not sure what the fix would be, but thank you for any help or advice you can provide!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../dtolnay/serde-yaml/issues/33.html">dtolnay/serde-yaml#33</a> on 2016-11-13 17:08</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../chyh1990/yaml-rust/issues/44.html">chyh1990/yaml-rust#44</a> on 2016-11-13 17:42</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Prior99">@Prior99</a> on 2016-11-14 20:18</div>
            <div class="timeline-body"><p>+1 as I am facing the exact same problem. Both clap and serde are really popular libraries which makes this a huge problem. I would be happy to help but have honestly no idea on where to start...</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/emk">@emk</a> on 2016-11-14 20:32</div>
            <div class="timeline-body"><p>@Prior99: Try downgrading your <code>serde_yaml</code> to 0.4.1 as a temporary workaround while this gets sorted out. That version is compatible with <code>clap</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/kbknapp">@kbknapp</a> on 2016-11-14 20:48</div>
            <div class="timeline-body"><p>Catching up on issues. Thanks for reporting this, I'm looking into it as well! :+1:</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">T: RFC / question</span> added by @kbknapp on 2016-11-14 20:48</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/kbknapp">@kbknapp</a> on 2016-11-14 21:05</div>
            <div class="timeline-body"><p>Ok, so I've read all the related issues and unfortunately changing clap's API to work with the <code>preserve_order</code> feature is a breaking change. So for now, pinning to <code>serde_yaml</code> 0.4.1 is the only workaround.</p>
<p>I've been toying with the idea of a 3.x for a while now, at which case I <em>could</em> change clap's API to match the <code>preserve_order</code> feature.</p>
<p>This is a very sticky situation, and I tend to agree with the cargo maintainers that features should be additive only, and not change the API at all. It also seems to me if <code>serde_yaml</code> had an option to not use the <code>preserve_order</code> feature that would solve this as well. But I don't think it's possible to selectively turn features on/off with your own features (i.e. have the same dependencies, but with different features depending on what's passed to your crate).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Prior99">@Prior99</a> on 2016-11-14 21:09</div>
            <div class="timeline-body"><p>I have a fix which I will publish after some testing. It basically uses LinkedHashMap instead of BTree for the yaml feature of clap.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/kbknapp">@kbknapp</a> on 2016-11-14 21:12</div>
            <div class="timeline-body"><p>@Prior99 I haven't looked in depth yet, since it's been quite a while since I wrote the YAML parts of clap, but I <em>think</em> you can't do that without changing the public API, making it a breaking change. I'm open to seeing what you've got though! :smile:</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Prior99">@Prior99</a> on 2016-11-14 21:21</div>
            <div class="timeline-body"><p>Couldn't this be fixed by #750? All the tests passed for me, but please make sure this works by integrating it somewhere. I currently have nothing ready to do so on my own, <strong>if</strong> this would be an acceptable fix.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/750.html">clap-rs/clap#750</a> on 2016-11-15 13:24</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../estk/log4rs/issues/35.html">estk/log4rs#35</a> on 2016-12-13 18:59</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/1037.html">clap-rs/clap#1037</a> on 2017-08-22 04:17</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/1110.html">clap-rs/clap#1110</a> on 2017-11-22 09:16</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/igor-raits">@igor-raits</a> on 2017-11-22 19:54</div>
            <div class="timeline-body"><p>@kbknapp yaml-rust 0.4 has been released and now it uses only linked-hash-map, no more btreemap. Should not we change that too?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/kbknapp">@kbknapp</a> on 2017-11-27 15:12</div>
            <div class="timeline-body"><p>@ignatenkobrain I'm not against it...however that is technically a breaking change to the public API and any code using BTreeMap (or any code using <code>Arg::from_yaml</code>) will break. I'd very much like to hear from some of the YAML users as to if this breaks anything for them (as not many people should be using <code>Arg::from_yaml</code> directly, it was meant to be only be used internally by <code>clap</code> when building out an entire YAML CLI.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/rrichardson">@rrichardson</a> on 2018-01-12 01:51</div>
            <div class="timeline-body"><p>~~FWIW -  I am running 2.29.1 and <code>cargo tree</code> tells me that my only linked yaml dependency is <code>yaml-rust : 0.3.5</code>~~
~~Loading via  <code>App::from_yaml(yaml);</code> fails in <code>Arg::from_yaml</code>.  It takes the <code>nth(0)</code> key and attempts to coerce it via <code>as_hash()</code> which fails, because the value is just <code>String(...)</code>
This <em>might</em> be the ordering problem mentioned,  but nothing in the entire vec that it is looping through has a yaml type which could be coerced via <code>as_hash()</code>~~~</p>
<p>Edit:</p>
<p>This was my mistake.. my editor auto-formatted the yaml in an incorrect way and I was not indenting each arg  under the array to become a map.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone "serde" by @kbknapp on 2018-02-02 01:55</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Removed from milestone "serde" by @kbknapp on 2018-02-02 01:55</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone "v3-alpha1" by @kbknapp on 2018-02-02 01:55</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/kbknapp">@kbknapp</a> on 2018-07-22 00:59</div>
            <div class="timeline-body"><p>This has been fixed on v3-master</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @kbknapp on 2018-07-22 00:59</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ghempton">@ghempton</a> on 2018-10-19 23:54</div>
            <div class="timeline-body"><p>I see that v3-master hasn't been updated in a while and I get a compile error if I try and reference it in my <code>cargo.toml</code>:</p>
<pre><code>error[E0308]: mismatched types
   --&gt; /Users/ghempton/.cargo/git/checkouts/clap-78dbe9b58f9073fe/eaa0700/src/build/macros.rs:82:9
    |
82  | /         $v.as_str()
83  | |             .unwrap_or_else(|| panic!(&quot;failed to convert YAML {:?} value to a string&quot;, $v))
    | |___________________________________________________________________________________________^ expected char, found &amp;str
    |
   ::: /Users/ghempton/.cargo/git/checkouts/clap-78dbe9b58f9073fe/eaa0700/src/build/arg/mod.rs:166:28
    |
166 |                   &quot;short&quot; =&gt; yaml_to_str!(a, v, short),
    |                              ------------------------- in this macro invocation
    |
    = note: expected type `char`
               found type `&amp;str`
</code></pre>
<p>Are there any plans to push v3 forward or get this back-ported into v2?</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:46:44 UTC
    </footer>
</body>
</html>
