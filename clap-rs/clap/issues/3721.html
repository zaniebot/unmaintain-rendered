<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Users can accidentally design broken CLIs when combining subcommands with unbounded positional arguments - clap-rs/clap #3721</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Users can accidentally design broken CLIs when combining subcommands with unbounded positional arguments</h1>

    <div class="meta">
        <span class="state state-open">Open</span>
        <a href="https://github.com/clap-rs/clap/issues/3721">#3721</a>
        opened by <a href="https://github.com/NickCondron">@NickCondron</a>
        on 2022-05-12 05:19
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/NickCondron">@NickCondron</a> on 2022-05-12 05:19</div>
            <div class="timeline-body"><p>Maintainer's notes:  Below is the original issue that came from misusing clap's API.  We could add a debug assert to help guide users to use the API correctly.</p>
<hr />
<h3>Please complete the following tasks</h3>
<ul>
<li>[X] I have searched the <a href="https://github.com/clap-rs/clap/discussions">discussions</a></li>
<li>[X] I have searched the <a href="https://github.com/clap-rs/clap/issues">open</a> and <a href="https://github.com/clap-rs/clap/issues?q=is%3Aissue+label%3AS-wont-fix+is%3Aclosed">rejected</a> issues</li>
</ul>
<h3>Rust Version</h3>
<p>rustc 1.60.0 (7737e0b5c 2022-04-04)</p>
<h3>Clap Version</h3>
<p>3.1.17</p>
<h3>Minimal reproducible code</h3>
<pre><code class="language-rust">use clap::{Args, Parser, Subcommand};
use std::{path};

#[derive(Debug, Parser)]
#[clap(subcommand_required=true)]
struct Cli {
    #[clap(subcommand)]
    command: Commands,

    /// files to search
    #[clap(global=true)]
    files: Vec&lt;path::PathBuf&gt;,
}

#[derive(Debug, Subcommand)]
enum Commands {
    /// Quickly filters replays based on metadata
    Filter(Filter),
    ///Search replay for something that happened
    Search(Search),
}

#[derive(Debug, Args)]
struct Filter {
    #[clap(short, long)]
    arg_filter: Option&lt;String&gt;,
}

#[derive(Debug, Args)]
struct Search {
    #[clap(short, long)]
    arg_search: Option&lt;String&gt;,
}

fn main() {
    let cli = Cli::parse();
}

</code></pre>
<h3>Steps to reproduce the bug with the above code</h3>
<p><code>$ cargo run -- -h</code></p>
<h3>Actual Behaviour</h3>
<pre><code>USAGE:
    test-clap [FILES]... &lt;SUBCOMMAND&gt;

ARGS:
    &lt;FILES&gt;...    files to search
...
</code></pre>
<h3>Expected Behaviour</h3>
<pre><code>USAGE:
    test-clap &lt;SUBCOMMAND&gt; [Files]...

ARGS:
    &lt;FILES&gt;...    files to search
...
</code></pre>
<p>OR (perhaps it's up to taste)</p>
<pre><code>USAGE:
    test-clap &lt;SUBCOMMAND&gt;

...
</code></pre>
<p>If subcommand is required then global arguments should only go after the subcommand is named.</p>
<h3>Additional Context</h3>
<p><code>$ cargo run -- help search</code> matches the expected behavior just fine</p>
<p>I also tried adding <code>args_conflicts_with_subcommands=true</code> to <code>Cli</code>, but it still doesn't produce expected behavior. It results in:</p>
<pre><code>USAGE:
    slp-search [OPTIONS] [REPLAYS]...
    slp-search &lt;SUBCOMMAND&gt;
</code></pre>
<p>which seems wrong because the first usage case doesn't require a subcommand</p>
<p>I could add the <code>files</code> argument to both <code>Filter</code> and <code>Search</code>  structs, but this seems messy, and prevents me from having access to the shared argument before matching over the subcommands.</p>
<h3>Debug Output</h3>
<p><em>No response</em></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">C-bug</span> added by @NickCondron on 2022-05-12 05:19</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2022-05-12 08:58</div>
            <div class="timeline-body"><blockquote>
<p><code>#[clap(subcommand_required=true)]</code></p>
</blockquote>
<p>That is implicit when not using an <code>Option&lt;Commands&gt;</code>.  Or more precisely, <code>#[clap(subcommand_required_else_help=true)]</code> is though we will be changing that in https://github.com/clap-rs/clap/issues/3280 so its <code>#[clap(subcommand_required = true, arg_required_else_help = true)]</code>.</p>
<blockquote>
<p>If subcommand is required then global arguments should only go after the subcommand is named.</p>
</blockquote>
<p>The usage is behaving as expected.  The command is described as having arguments that come before the subcommand, and so that is what is shown.</p>
<p>Now what might be considered a bug is that we allowed the combination of</p>
<ul>
<li>Unbounded number of positional arguments</li>
<li>Subcommands</li>
<li><code>subcommand_precedence_over_arg = false</code></li>
</ul>
<p>We might want to consider adding a debug assert for that case.</p>
<blockquote>
<p><code>$ cargo run -- help search</code> matches the expected behavior just fine</p>
</blockquote>
<p>This is because we do not show optional arguments for the parent command in the subcommand help.  We only show the required ones for the direct parent and not for all parent subcommands.</p>
<blockquote>
<p>I also tried adding args_conflicts_with_subcommands=true to Cli, but it still doesn't produce expected behavior.
...
which seems wrong because the first usage case doesn't require a subcommand</p>
</blockquote>
<p>Conflicts automatically override required arguments / subcommands.</p>
<blockquote>
<p>I could add the files argument to both Filter and Search structs, but this seems messy, and prevents me from having access to the shared argument before matching over the subcommands.</p>
</blockquote>
<p>This is the correct solution.  <code>Commands</code> could provide an accessor method that does the dispatch through the enum for you.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">E-easy</span> added by @epage on 2022-05-12 08:58</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "subcommand_required and global attributes cause bad usage" to "Users can accidentally design broken CLIs when combining subcommands with unbounded positional arguments" by @epage on 2022-05-12 08:59</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">M-breaking-change</span> added by @epage on 2022-05-12 09:00</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">A-builder</span> added by @epage on 2022-05-12 09:00</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../cucumber-rs/cucumber/issues/215.html">cucumber-rs/cucumber#215</a> on 2022-05-25 10:01</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/3889.html">clap-rs/clap#3889</a> on 2022-06-30 19:36</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/4238.html">clap-rs/clap#4238</a> on 2022-09-20 16:50</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/6001.html">clap-rs/clap#6001</a> on 2025-05-12 09:53</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:35:08 UTC
    </footer>
</body>
</html>
