```yaml
number: 2257
title: "`just run-tests` fails because of small terminal width"
type: issue
state: closed
author: nitsky
labels:
  - C-bug
  - A-help
  - S-waiting-on-mentor
assignees: []
created_at: 2020-12-15T16:09:06Z
updated_at: 2022-02-08T23:49:16Z
url: https://github.com/clap-rs/clap/issues/2257
synced_at: 2026-01-10T01:57:44Z
```

# `just run-tests` fails because of small terminal width

---

_Issue opened by @nitsky on 2020-12-15 16:09_

Running `just run-tests` fails because many tests have been written specifically for the case where the wrap_help feature is disabled.

### Make sure you completed the following tasks

- [x] Searched the [discussions](https://github.com/clap-rs/clap/discussions)
- [X] Searched the closed issues

### Steps to reproduce the issue

1. Clone the clap repo.
2. Run `just run-tests` and observe test failures.

### Version

* **Rust**: rustc 1.48.0 (7eac88abb 2020-11-16)
* **Clap**: master 4bd15c45d2a77f26235ef4207df6bb250b456442

### Actual Behavior Summary

Tests fail.

### Expected Behavior Summary

Tests pass.


---

_Label `T: bug` added by @nitsky on 2020-12-15 16:09_

---

_Comment by @pksunkara on 2020-12-15 16:14_

Could you paste some output when you say many tests are incompatible with wrap_help?

---

_Comment by @nitsky on 2020-12-15 16:18_

@pksunkara Starting from the current master, I ran `just run-tests` and got this error:

```
---- app_from_crate stdout ----
thread 'app_from_crate' panicked at 'assertion failed: `(left == right)`
  left: `"clap 3.0.0-beta.2\nKevin K. <kbknapp@gmail.com>:Clap Maintainers\nA simple to use, efficient, and full-featured Command\nLine Argument Parser\n\nUSAGE:\n    clap\n\nFLAGS:\n    -h, --help       Prints help information\n    -V, --version    Prints version information\n"`,
 right: `"clap 3.0.0-beta.2\nKevin K. <kbknapp@gmail.com>:Clap Maintainers\nA simple to use, efficient, and full-featured Command Line Argument Parser\n\nUSAGE:\n    clap\n\nFLAGS:\n    -h, --help       Prints help information\n    -V, --version    Prints version information\n"`', tests/app_from_crate.rs:22:5
note: run with `RUST_BACKTRACE=1` environment variable to display a backtrace
```

You can see that on the left, there is a newline between "Command" and "Line" but it is absent on the right. This is because the wrap_help feature is enabled.

---

_Comment by @ldm0 on 2021-01-20 16:44_

I reproduced this by shrinking terminal width :-P. 

The problem is not about justfile, it's about the terminal size. The `wrap_help` feature detects current terminal size and auto wrap help info. With small terminal size, some help output will wraps. Setting each failing tests with term_width(0) will fix this problem. But I don't thinking the problem is worth fixing.

---

_Comment by @nitsky on 2021-01-20 17:22_

> I don't thinking the problem is worth fixing.

I disagree. As a new contributor to the project, I was distressed that tests were failing after following contributing instructions due to the width of my terminal.

---

_Comment by @ldm0 on 2021-01-20 17:34_

@nitsky Sorry about the distress. Changing all of our current(and future) tests is ugly. What about hinting the user about this problem?

---

_Referenced in [clap-rs/clap#2304](../../clap-rs/clap/pulls/2304.md) on 2021-01-20 17:38_

---

_Comment by @nitsky on 2021-01-20 17:38_

I think it makes more sense to mock the terminal width for the tests. In most codebases I have encountered when tests have a dependence on the environment the value is mocked to avoid flakey test failure. This will also be an opportunity to improve the coverage of the tests by testing wrapping at different terminal widths.

---

_Comment by @ldm0 on 2021-01-20 18:24_

These tests are integration tests rather than unit tests, I don't think mocking is easy. What do you think @pksunkara . 

---

_Renamed from "`just run-tests` fails because many tests are incompatible with wrap_help feature" to "`just run-tests` fails because of small terminal width" by @ldm0 on 2021-05-08 05:06_

---

_Referenced in [epage/clapng#171](../../epage/clapng/issues/171.md) on 2021-12-06 20:19_

---

_Label `A-help` added by @epage on 2021-12-13 15:17_

---

_Assigned to @epage by @epage on 2021-12-13 15:17_

---

_Label `S-waiting-on-mentor` added by @epage on 2021-12-13 22:44_

---

_Comment by @epage on 2022-02-08 23:49_

I saw these failures locally without just but after some test changes earlier, I do not see them any more.  I'm assuming this is resolved.

---

_Closed by @epage on 2022-02-08 23:49_

---
