<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Help switches from next-line back to same-line format when name/placeholder gets *wider* - clap-rs/clap #4550</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Help switches from next-line back to same-line format when name/placeholder gets <em>wider</em></h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/clap-rs/clap/issues/4550">#4550</a>
        opened by <a href="https://github.com/gnprice">@gnprice</a>
        on 2022-12-13 06:33
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/gnprice">@gnprice</a> on 2022-12-13 06:33</div>
            <div class="timeline-body"><h3>Please complete the following tasks</h3>
<ul>
<li>[X] I have searched the <a href="https://github.com/clap-rs/clap/discussions">discussions</a></li>
<li>[X] I have searched the <a href="https://github.com/clap-rs/clap/issues">open</a> and <a href="https://github.com/clap-rs/clap/issues?q=is%3Aissue+label%3AS-wont-fix+is%3Aclosed">rejected</a> issues</li>
</ul>
<h3>Rust Version</h3>
<p>rustc 1.65.0 (897e37553 2022-11-02)</p>
<h3>Clap Version</h3>
<p>master</p>
<h3>Minimal reproducible code</h3>
<p>Same as #3300.</p>
<p>(That report is on version 3.0.5, but the same behavior is also present at master. I initially ran into it on master, but then found #3300, which provides a nice handy repro recipe.)</p>
<h3>Steps to reproduce the bug with the above code</h3>
<p>Same as #3300.</p>
<h3>Actual Behaviour</h3>
<p>The two versions of the application code in the #3300 repro differ by the presence of a <code>value_name</code> field on an argument. One version sets a concise <code>value_name</code>, so that the argument's synopsis is:
<code>--merge-conflict-theirs-diff-header-decoration-style &lt;STYLE_STRING&gt;</code>
The other version leaves out <code>value_name</code> on that argument, so that its placeholder is derived from the name and the synopsis is:
<code>--merge-conflict-theirs-diff-header-decoration-style &lt;MERGE_CONFLICT_THEIRS_DIFF_HEADER_DECORATION_STYLE&gt;</code></p>
<p>In the version with <code>STYLE_STRING</code>, the <code>-h</code> output is shown in next-line format. By default <code>-h</code> is in same-line format, but the auto-next-line-help logic kicks in: we see that the same-line format would be very wide (around 200 columns), so we switch to next-line in order to better stay within a readable width. Excerpt of the result:</p>
<pre><code>        --merge-conflict-ours-diff-header-decoration-style &lt;STYLE_STRING&gt;
            Style string for the decoration of the header above the 'ours' merge conflict diff
            [default: box]

        --merge-conflict-ours-diff-header-style &lt;STYLE_STRING&gt;
            Style string for the header above the 'ours' branch merge conflict diff [default:
            normal]

        --merge-conflict-theirs-diff-header-decoration-style &lt;STYLE_STRING&gt;
            Style string for the decoration of the header above the 'theirs' merge conflict diff
            [default: box]

        --merge-conflict-theirs-diff-header-style &lt;STYLE_STRING&gt;
            Style string for the header above the 'theirs' branch merge conflict diff [default:
            normal]
</code></pre>
<p>In the version with <code>MERGE_CONFLICT_THEIRS_DIFF_HEADER_DECORATION_STYLE</code>, the same-line format is even wider than that. But this time that even-wider output is actually the one we choose to show — we revert to same-line instead of next-line format. Excerpt:</p>
<pre><code>        --merge-conflict-ours-diff-header-decoration-style &lt;STYLE_STRING&gt;                                            Style string for the decoration of the header above the 'ours' merge conflict diff [default: box]
        --merge-conflict-ours-diff-header-style &lt;STYLE_STRING&gt;                                                       Style string for the header above the 'ours' branch merge conflict diff [default: normal]
        --merge-conflict-theirs-diff-header-decoration-style &lt;MERGE_CONFLICT_THEIRS_DIFF_HEADER_DECORATION_STYLE&gt;    Style string for the decoration of the header above the 'theirs' merge conflict diff [default: box]
        --merge-conflict-theirs-diff-header-style &lt;STYLE_STRING&gt;                                                     Style string for the header above the 'theirs' branch merge conflict diff [default: normal]
</code></pre>
<h3>Expected Behaviour</h3>
<p>When the help output in same-line format would already be so wide that we decide to switch to next-line format, and then it gets even wider still, that should cause us to stay in next-line format — not to revert back to same-line format.</p>
<h3>Additional Context</h3>
<p>The key logic is this, in <code>src/output/help_template.rs</code>, as the <code>bool</code> expression determining whether we switch automatically to next-line help format:</p>
<pre><code class="language-rs">            self.term_w &gt;= taken
                &amp;&amp; (taken as f32 / self.term_w as f32) &gt; 0.40
                &amp;&amp; h_w &gt; (self.term_w - taken)
</code></pre>
<p>Specifically, the first line says that if the width <code>taken</code> already occupied by the longest argument synopsis is itself longer than the terminal width <code>self.term_w</code>, we stay in same-line format regardless of the other conditions. Deleting that first comparison fixes this bug.</p>
<p>In #3300, the reporter @dandavison wanted same-line format always, even when very wide; so this behavior, when it applied, acted as an accidental way of getting the behavior he wanted. But, as evidenced by his filing that bug, it's a fragile and counterintuitive way of doing so. There's discussion in that thread (https://github.com/clap-rs/clap/issues/3300#issuecomment-1015578541) of a more robust way one can get that behavior today, and of possible other ways in the future.</p>
<p>This behavior has been present since the auto-next-line-format logic was first added, in b7793a2f4d back in 2016-08. (More history described by @epage at https://github.com/clap-rs/clap/issues/3300#issuecomment-1312636492.) I don't see any discussion of this quirk in the original issue thread #597, nor in the related #587.</p>
<p>It's not in the changelog entries added by that commit b7793a2f4d, either. And I don't see any documentation of the auto-next-line feature outside the changelog (e.g. at https://github.com/clap-rs/clap/blob/master/CHANGELOG.md#v2110-2016-08-28 ), so this &quot;give up when even wider&quot; behavior seems not to be documented at all.</p>
<p>As discussed at https://github.com/clap-rs/clap/issues/3300#issuecomment-1312636492 , it's not entirely clear we want this overall auto-next-line-help feature at all. But I think removing this quirk is both an improvement as long as we do keep the overall feature, and a simplifying step that makes it a bit easier to work through removing it if the decision goes in that direction.</p>
<h3>Debug Output</h3>
<p><em>No response</em></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">C-bug</span> added by @gnprice on 2022-12-13 06:33</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2022-12-13 15:26</div>
            <div class="timeline-body"><p>Could you clarify what about this needs to be a separate conversation than #3300?  I do not want to split the conversation  on the next-line-help auto-detection between two Issues.  Almost all of this issue is spent re-hashing #3300 and if there is something that is unique or different about this that needs to be a separate issue, it was buried in the details.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/4631.html">clap-rs/clap#4631</a> on 2023-01-12 14:50</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2023-01-31 22:12</div>
            <div class="timeline-body"><p>Without further details, I'm closing this out in favor of the other discussions.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @epage on 2023-01-31 22:12</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 12:31:48 UTC
    </footer>
</body>
</html>
