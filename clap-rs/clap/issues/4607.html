<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add method to parse environment variables from custom source - clap-rs/clap #4607</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Add method to parse environment variables from custom source</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/clap-rs/clap/issues/4607">#4607</a>
        opened by <a href="https://github.com/robertkiel">@robertkiel</a>
        on 2023-01-05 09:07
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/robertkiel">@robertkiel</a></div>
            <div class="timeline-body">Please complete the following tasks
<ul>
<li>[X] I have searched the <a href="https://github.com/clap-rs/clap/discussions">discussions</a></li>
<li>[X] I have searched the <a href="https://github.com/clap-rs/clap/issues">open</a> and <a href="https://github.com/clap-rs/clap/issues?q=is%3Aissue+label%3AS-wont-fix+is%3Aclosed">rejected</a> issues</li>
</ul>
Clap Version
<p>4.0.32</p>
Describe your use case
<p>Rust code might run as a standalone application as well as a WebAssembly module in the browser or in any other WebAssembly runtime.</p>
<p>This comes with the advantage that WebAssembly modules and standalone applications share the same code and benefit from the stability and safety of Rust.</p>
<p>Within WebAssembly, in most cases the execution environment cannot access process variables such as <code>argv</code> and environment variables - which are very often used for configuration - , hence they somehow need to get passed into the WebAssembly module. Fortunately, this shim functionaliy is only necessary when compiling to WebAssembly.</p>
Describe the solution you&#x27;d like
<p>Since <code>std::env::vars()</code> or <code>std::env::vars_os()</code> are not available, add a method that allows passing environment variables from a custom source into <code>clap</code>.</p>
<p>Example</p>
<pre><code>use std::env;
use std::collections::HashMap;
use clap::{Command, Arg};

let mut cmd = Command::new(&quot;myprog&quot;)
    .arg(Arg::new(&quot;data_dir&quot;)
        .long(&quot;data_dir&quot;)
        .env(&quot;MYPROG_DATA_DIR&quot;));

// not necessary, just for demonstration
env::set_var(&quot;MYPROG_DATA_DIR&quot;, &quot;/home/user/Work/clap&quot;);

// might be populated with different data
let env_vars = HashMap::from_iter(env::vars_os());
cmd.update_env_from(env_vars);

let m = cmd.get_matches_from(vec![&quot;foo&quot;]);
assert_eq!(&quot;/home/user/Work/clap&quot;, m.get_one::&lt;String&gt;(&quot;data_dir&quot;).unwrap());
</code></pre>
Alternatives, if applicable
<p><em>No response</em></p>
Additional Context
<p>See #4605 for sample implementation.</p>
<p>This functionality could be hidden by a <code>wasm</code> feature flag.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">C-enhancement</span> added by <a href="https://github.com/robertkiel">@robertkiel</a> on 2023-01-05 09:07</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a>clap-rs/clap#4605</a> on 2023-01-05 09:08</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">A-builder</span> added by <a href="https://github.com/epage">@epage</a> on 2023-01-05 14:02</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">S-waiting-on-design</span> added by <a href="https://github.com/epage">@epage</a> on 2023-01-05 14:02</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2023-01-05 14:07</div>
            <div class="timeline-body"><blockquote>
<p>Within WebAssembly, in most cases the execution environment cannot access process variables such as argv and environment variables - which are very often used for configuration - , hence they somehow need to get passed into the WebAssembly module. Fortunately, this shim functionaliy is only necessary when compiling to WebAssembly.</p>
</blockquote>
<p>Ok, so this is not wasm in the browser (where there is no environment) but embedded within a desktop application where the environment needs to be proxied.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2023-01-05 14:41</div>
            <div class="timeline-body"><blockquote>
<p>See <a href="https://github.com/clap-rs/clap/pull/4605">clap-rs/clap#4605</a> for sample implementation.</p>
</blockquote>
<p>One aspect of that that is weird to me, as an API, is that its updating the envs already stored.  I think I&#x27;d rather we set the env to use and use that instead.  As this is a special use case on top of special use case, I would want to limit the impact of this on others (note that testing would be another use case).  You mentioned limiting it to wasm but this has use outside of wasm and I tend to avoid conditional compilation (we already have too much in clap).  I have been <a href="https://github.com/clap-rs/clap/discussions/3476">exploring ideas to make new features cheaper</a> and this would be a good first use of the idea.  Buried in that page is a plugin system where a <code>Command</code> and an <code>Arg</code> support any data being put into them using something like an <code>AnyMap</code>.  I&#x27;ve been experimenting with it in one of my tools to get some experience before baking it into clap&#x27;s API (<a href="https://github.com/gitext-rs/git-stack/blob/main/src/any.rs">1</a>, <a href="https://github.com/gitext-rs/git-stack/blob/main/src/graph/mod.rs#L189">2</a>).</p>
<p>The above does require setting the env source before adding any other args.  We could re-evaluate when we read the environment to make this more flexible on when either is called.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/robertkiel">@robertkiel</a> on 2023-01-05 17:06</div>
            <div class="timeline-body"><blockquote>
<p>The above does require setting the env source before adding any other args. We could re-evaluate when we read the environment to make this more flexible on when either is called.</p>
</blockquote>
<p>It works mostly like before:</p>
<ul>
<li>while constructing instances of <code>Arg</code> are created, the environment variable names, and if present, their values get stored into <code>arg.env</code></li>
<li>in a second step, we feed in the <code>--args</code></li>
</ul>
<p>... with the only difference that first all <code>Arg</code> instances get created and then we insert the envs and then we add the <code>--args</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/robertkiel">@robertkiel</a> on 2023-01-05 17:15</div>
            <div class="timeline-body"><blockquote>
<blockquote>
<p>Within WebAssembly, in most cases the execution environment cannot access process variables such as argv and environment variables - which are very often used for configuration - , hence they somehow need to get passed into the WebAssembly module. Fortunately, this shim functionaliy is only necessary when compiling to WebAssembly.</p>
</blockquote>
<p>Ok, so this is not wasm in the browser (where there is no environment) but embedded within a desktop application where the environment needs to be proxied.</p>
</blockquote>
<p>The idea was to have one Rust source code that is normally fed with <code>argv</code> + environment variables. But when running in the browser, the browser might read some <code>.env</code> file or have it stored in its local storage and thus mimics environment variables used for configuration. In contrast, a standalone WebAssembly execution environment would just forward all <code>argv</code> values and all environment values to the WebAssembly module.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a>clap-rs/clap#4793</a> on 2023-03-27 18:20</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2023-03-27 20:57</div>
            <div class="timeline-body"><p>FYI I&#x27;ve created #4793 as an issue dedicated to that plugin system idea I mentioned.  Our plan is to move <code>Arg::env</code> support out of the core of clap.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a>clap-rs/clap#5104</a> on 2023-08-30 19:57</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Kinrany">@Kinrany</a> on 2023-11-07 13:49</div>
            <div class="timeline-body"><p>As mentioned in #5104, another use case is implementing <code>Default</code> for a type that derives <code>Parser</code> and provides default values.</p>
<p>I have to mention that I was surprised that <code>parse_from</code> does not already ignore the environment. In my model <code>env</code> adds a second source of data to be parsed in addition to CLI arguments, and I expected <code>parse_from</code> to accept an iterator that combines all the data.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a>clap-rs/clap#5569</a> on 2024-07-07 15:39</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a>clap-rs/clap#6033</a> on 2025-06-10 20:24</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/linabutler">@linabutler</a> on 2025-07-14 19:24</div>
            <div class="timeline-body"><p>Hi there, just chiming in to say that I have the same use case!</p>
<p>(The specifics are slightly differentâ€”instead of Wasm, it&#x27;s <a href="https://docs.rs/starlark/latest/starlark/">Starlark</a>[^1]â€”but the crux of the problem is the same: I&#x27;m proxying a subset of the hosting process&#x27;s environment variables to the Starlark runtime, so Starlark scripts only have access to those proxied environment variables).</p>
<p>I tried a couple of workarounds: (1) ignoring <code>required</code> for arguments that also specified an <code>env</code> fallback, and using the value of the proxied environment variable as a <code>default_value</code>, and (2) prepending the values of the proxied variables as hidden string arguments to the input, and specifying <code>.override_with</code> on those hidden argument definitions. Both of those were super kludgy, though, especially when <code>.required_if_any</code> and <code>.required_unless_present</code> get involved, so I opted not to expose environment variable defaults for arguments to Starlark for now.</p>
<p>An API as simple as the suggestions in #5569 or #6033â€”or a plugin system for attaching extra data to arguments that you mentioned in <a href="https://github.com/clap-rs/clap/issues/4607">clap-rs/clap#4607</a>#issuecomment-1372305605, @epageâ€”would be amazing, and would solve my use case perfectly.</p>
<p>(I know this is waiting on design; so no expectations at all, but I still wanted to share another use outside of Wasm, in case it&#x27;s helpful for design discussions. ðŸ˜Š)</p>
<p>Thanks!</p>
<p>[^1]: I&#x27;m wrapping Clap&#x27;s builder API in a Rust-implemented Starlark module that exposes an <a href="https://docs.python.org/3/library/argparse.html"><code>argparse.ArgumentParser</code></a>-like API to Starlark scripts.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:59:34 UTC
    </footer>
</body>
</html>
