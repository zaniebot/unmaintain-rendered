<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>`arg!(--long-arg &quot;foo&quot;)` doesn't behave in expected way - clap-rs/clap #3586</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1><code>arg!(--long-arg &quot;foo&quot;)</code> doesn&#x27;t behave in expected way</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/clap-rs/clap/issues/3586">#3586</a>
        opened by <a href="https://github.com/petrochenkov">@petrochenkov</a>
        on 2022-03-28 15:33
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/petrochenkov">@petrochenkov</a></div>
            <div class="timeline-body">Please complete the following tasks
<ul>
<li>[X] I have searched the <a href="https://github.com/clap-rs/clap/discussions">discussions</a></li>
<li>[X] I have searched the <a href="https://github.com/clap-rs/clap/issues">open</a> and <a href="https://github.com/clap-rs/clap/issues?q=is%3Aissue+label%3AS-wont-fix+is%3Aclosed">rejected</a> issues</li>
</ul>
Rust Version
<p>rustc 1.54.0</p>
Clap Version
<p>3.1.6</p>
Minimal reproducible code
<pre><code>fn main() {
    let matches = Command::new(&quot;my_command&quot;).args(&amp;[arg!(--long-option &quot;Description&quot;)]).get_matches();
}
</code></pre>
Steps to reproduce the bug with the above code
<pre><code>cargo run
</code></pre>
Actual Behaviour
<pre><code>thread &#x27;main&#x27; panicked at &#x27;assertion failed: `(left == right)`
  left: `Some(&quot;long&quot;)`,
 right: `None`: Short flags should precede long flags
</code></pre>
Expected Behaviour
<p>The code either builds an argument with long name <code>--long-option</code>, or errors at compile time.</p>
Additional Context
<p>The issue was found when migrating code from clap 2.</p>
<p>This is a footgun affecting naively ported code that cannot be detected until runtime.</p>
Debug Output
<p><em>No response</em></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">C-bug</span> added by <a href="https://github.com/petrochenkov">@petrochenkov</a> on 2022-03-28 15:33</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">A-builder</span> added by <a href="https://github.com/epage">@epage</a> on 2022-03-28 15:42</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">S-waiting-on-design</span> added by <a href="https://github.com/epage">@epage</a> on 2022-03-28 15:42</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2022-03-28 15:43</div>
            <div class="timeline-body"><p>This seems to be a limitation of macro-rules that I couldn&#x27;t find a way around.  You need to quote the long option</p>
<pre><code>fn main() {
    let matches = Command::new(&quot;my_command&quot;).args(&amp;[arg!(--&quot;long-option&quot; &quot;Description&quot;)]).get_matches();
}
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/petrochenkov">@petrochenkov</a> on 2022-03-28 15:52</div>
            <div class="timeline-body"><p>I found the <code>--&quot;long-option&quot;</code> form later, but the fact that the <code>--long-option</code> form is silently accepted while being incorrect is still a problem.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2022-03-28 16:06</div>
            <div class="timeline-body"><blockquote>
<p>but the fact that the --long-option form is silently accepted while being incorrect is still a problem.</p>
</blockquote>
<p>which is why this issue is open but I&#x27;m not aware of any good solution.</p>
<p>Also, we have resigned ourselves in general to not being able to turn every error into a compile error but backstop with debug asserts.  We encourage people to add a test that calls <code>Command::debug_asserrt()</code> to help catch issues earlier in the development process.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/evgeniy-terekhin">@evgeniy-terekhin</a> on 2022-05-07 14:02</div>
            <div class="timeline-body"><p>@epage I guess one solution could be to allow defining short and long flags only in one exact order (-f --flag)
But I guess this might and probably will break someone&#x27;s code</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2022-05-08 01:17</div>
            <div class="timeline-body"><p>@evgeniy-terekhin I think I&#x27;m missing something with your suggestion.  We do only allow one order the problem is I didn&#x27;t see a way to enforce that in macro rules without blowing up the number of cases we define and I didn&#x27;t see a way for that to allow <code>--foo-bar</code> without quotes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/evgeniy-terekhin">@evgeniy-terekhin</a> on 2022-05-08 06:54</div>
            <div class="timeline-body"><p>@epage well I duess I made this suggestion without giving it a proper thought.
Maybe converting this macro into a proc macro will enable better compile time errors.
I&#x27;ll have to experiment on this a bit.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2022-05-09 14:34</div>
            <div class="timeline-body"><blockquote>
<p>Maybe converting this macro into a proc macro will enable better compile time errors.
I&#x27;ll have to experiment on this a bit.</p>
</blockquote>
<p>Yes, my guess is that will be the only way forward for improving this macro.  While that might seem counter to one of the reasons to use the builder API over the derive (macros hurt build times),. this macro could possibly have no dependencies like <a href="https://github.com/matklad/xflags/tree/master/xflags-macros">xflags</a></p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:58:53 UTC
    </footer>
</body>
</html>
