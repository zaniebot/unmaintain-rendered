<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>`clippy::almost_swapped` check failing on latest nightly - clap-rs/clap #4733</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1><code>clippy::almost_swapped</code> check failing on latest nightly</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/clap-rs/clap/issues/4733">#4733</a>
        opened by <a href="https://github.com/rkrasiuk">@rkrasiuk</a>
        on 2023-02-27 09:26
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/rkrasiuk">@rkrasiuk</a></div>
            <div class="timeline-body"><h3>Please complete the following tasks</h3>
<ul>
<li>[X] I have searched the <a href="https://github.com/clap-rs/clap/discussions">discussions</a></li>
<li>[X] I have searched the <a href="https://github.com/clap-rs/clap/issues">open</a> and <a href="https://github.com/clap-rs/clap/issues?q=is%3Aissue+label%3AS-wont-fix+is%3Aclosed">rejected</a> issues</li>
</ul>
<h3>Rust Version</h3>
<p>rustc 1.69.0-nightly (d962ea578 2023-02-26)</p>
<h3>Clap Version</h3>
<p>4.1.4</p>
<h3>Minimal reproducible code</h3>
<pre><code class="language-rust">use clap::Parser;

#[derive(Parser, Debug)]
struct SomeArgs {
    name: Vec&lt;String&gt;,
}
</code></pre>
<h3>Steps to reproduce the bug with the above code</h3>
<p><code>cargo clippy</code></p>
<h3>Actual Behaviour</h3>
<pre><code class="language-sh">$ cargo clippy 
    Checking `&lt;project&gt;` v0.1.0 (`&lt;path&gt;`)
error: this looks like you are trying to swap `arg` and `name: Vec&lt;String&gt;`
 --&gt; src/main.rs:5:5
  |
5 |     name: Vec&lt;String&gt;,
  |     ^^^^^^^^^^^^^^^^^ help: try: `std::mem::swap(&amp;mut arg, &amp;mut name: Vec&lt;String&gt;)`
  |
  = note: or maybe you should use `std::mem::replace`?
  = help: for further information visit https://rust-lang.github.io/rust-clippy/master/index.html#almost_swapped
note: the lint level is defined here
 --&gt; src/main.rs:3:10
  |
3 | #[derive(Parser, Debug)]
  |          ^^^^^^
  = note: `#[deny(clippy::almost_swapped)]` implied by `#[deny(clippy::correctness)]`
  = note: this error originates in the derive macro `Parser` (in Nightly builds, run with -Z macro-backtrace for more info)

error: could not compile `&lt;project&gt;` due to previous error
</code></pre>
<h3>Expected Behaviour</h3>
<p>No clippy errors</p>
<h3>Additional Context</h3>
<pre><code class="language-sh">$ cargo expand
</code></pre>
<pre><code class="language-rust">#![feature(prelude_import)]
#[prelude_import]
use std::prelude::rust_2021::*;
#[macro_use]
extern crate std;
use clap::Parser;
struct SomeArgs {
    name: Vec&lt;String&gt;,
}
impl clap::Parser for SomeArgs {}
#[allow(dead_code, unreachable_code, unused_variables, unused_braces)]
#[allow(
    clippy::style,
    clippy::complexity,
    clippy::pedantic,
    clippy::restriction,
    clippy::perf,
    clippy::deprecated,
    clippy::nursery,
    clippy::cargo,
    clippy::suspicious_else_formatting,
)]
#[deny(clippy::correctness)]
impl clap::CommandFactory for SomeArgs {
    fn command&lt;'b&gt;() -&gt; clap::Command {
        let __clap_app = clap::Command::new(&quot;op-reth&quot;);
        &lt;Self as clap::Args&gt;::augment_args(__clap_app)
    }
    fn command_for_update&lt;'b&gt;() -&gt; clap::Command {
        let __clap_app = clap::Command::new(&quot;op-reth&quot;);
        &lt;Self as clap::Args&gt;::augment_args_for_update(__clap_app)
    }
}
#[allow(dead_code, unreachable_code, unused_variables, unused_braces)]
#[allow(
    clippy::style,
    clippy::complexity,
    clippy::pedantic,
    clippy::restriction,
    clippy::perf,
    clippy::deprecated,
    clippy::nursery,
    clippy::cargo,
    clippy::suspicious_else_formatting,
)]
#[deny(clippy::correctness)]
impl clap::FromArgMatches for SomeArgs {
    fn from_arg_matches(
        __clap_arg_matches: &amp;clap::ArgMatches,
    ) -&gt; ::std::result::Result&lt;Self, clap::Error&gt; {
        Self::from_arg_matches_mut(&amp;mut __clap_arg_matches.clone())
    }
    fn from_arg_matches_mut(
        __clap_arg_matches: &amp;mut clap::ArgMatches,
    ) -&gt; ::std::result::Result&lt;Self, clap::Error&gt; {
        #![allow(deprecated)]
        let v = SomeArgs {
            name: __clap_arg_matches
                .remove_many::&lt;String&gt;(&quot;name&quot;)
                .map(|v| v.collect::&lt;Vec&lt;_&gt;&gt;())
                .unwrap_or_else(Vec::new),
        };
        ::std::result::Result::Ok(v)
    }
    fn update_from_arg_matches(
        &amp;mut self,
        __clap_arg_matches: &amp;clap::ArgMatches,
    ) -&gt; ::std::result::Result&lt;(), clap::Error&gt; {
        self.update_from_arg_matches_mut(&amp;mut __clap_arg_matches.clone())
    }
    fn update_from_arg_matches_mut(
        &amp;mut self,
        __clap_arg_matches: &amp;mut clap::ArgMatches,
    ) -&gt; ::std::result::Result&lt;(), clap::Error&gt; {
        #![allow(deprecated)]
        if __clap_arg_matches.contains_id(&quot;name&quot;) {
            #[allow(non_snake_case)]
            let name = &amp;mut self.name;
            *name = __clap_arg_matches
                .remove_many::&lt;String&gt;(&quot;name&quot;)
                .map(|v| v.collect::&lt;Vec&lt;_&gt;&gt;())
                .unwrap_or_else(Vec::new);
        }
        ::std::result::Result::Ok(())
    }
}
#[allow(dead_code, unreachable_code, unused_variables, unused_braces)]
#[allow(
    clippy::style,
    clippy::complexity,
    clippy::pedantic,
    clippy::restriction,
    clippy::perf,
    clippy::deprecated,
    clippy::nursery,
    clippy::cargo,
    clippy::suspicious_else_formatting,
)]
#[deny(clippy::correctness)]
impl clap::Args for SomeArgs {
    fn group_id() -&gt; Option&lt;clap::Id&gt; {
        Some(clap::Id::from(&quot;SomeArgs&quot;))
    }
    fn augment_args&lt;'b&gt;(__clap_app: clap::Command) -&gt; clap::Command {
        {
            let __clap_app = __clap_app
                .group(
                    clap::ArgGroup::new(&quot;SomeArgs&quot;)
                        .multiple(true)
                        .args({
                            let members: [clap::Id; 1usize] = [clap::Id::from(&quot;name&quot;)];
                            members
                        }),
                );
            let __clap_app = __clap_app
                .arg({
                    #[allow(deprecated)]
                    let arg = clap::Arg::new(&quot;name&quot;)
                        .value_name(&quot;NAME&quot;)
                        .num_args(1..)
                        .value_parser({
                            use ::clap::builder::via_prelude::*;
                            let auto = ::clap::builder::_AutoValueParser::&lt;
                                String,
                            &gt;::new();
                            (&amp;&amp;&amp;&amp;&amp;&amp;auto).value_parser()
                        })
                        .action(clap::ArgAction::Append);
                    let arg = arg;
                    let arg = arg;
                    arg
                });
            __clap_app
        }
    }
    fn augment_args_for_update&lt;'b&gt;(__clap_app: clap::Command) -&gt; clap::Command {
        {
            let __clap_app = __clap_app
                .group(
                    clap::ArgGroup::new(&quot;SomeArgs&quot;)
                        .multiple(true)
                        .args({
                            let members: [clap::Id; 1usize] = [clap::Id::from(&quot;name&quot;)];
                            members
                        }),
                );
            let __clap_app = __clap_app
                .arg({
                    #[allow(deprecated)]
                    let arg = clap::Arg::new(&quot;name&quot;)
                        .value_name(&quot;NAME&quot;)
                        .num_args(1..)
                        .value_parser({
                            use ::clap::builder::via_prelude::*;
                            let auto = ::clap::builder::_AutoValueParser::&lt;
                                String,
                            &gt;::new();
                            (&amp;&amp;&amp;&amp;&amp;&amp;auto).value_parser()
                        })
                        .action(clap::ArgAction::Append);
                    let arg = arg;
                    let arg = arg.required(false);
                    arg
                });
            __clap_app
        }
    }
}
#[automatically_derived]
impl ::core::fmt::Debug for SomeArgs {
    fn fmt(&amp;self, f: &amp;mut ::core::fmt::Formatter) -&gt; ::core::fmt::Result {
        ::core::fmt::Formatter::debug_struct_field1_finish(
            f,
            &quot;SomeArgs&quot;,
            &quot;name&quot;,
            &amp;&amp;self.name,
        )
    }
}
</code></pre>
<h3>Debug Output</h3>
<p><em>No response</em></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">C-bug</span> added by @rkrasiuk on 2023-02-27 09:26</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../paradigmxyz/reth/issues/1572.html">paradigmxyz/reth#1572</a> on 2023-02-27 09:28</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "`clippy::correctness` check failing on latest nightly" to "`clippy::almost_swapped` check failing on latest nightly" by @rkrasiuk on 2023-02-27 09:32</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/4735.html">clap-rs/clap#4735</a> on 2023-02-27 09:46</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Ltrlg">@Ltrlg</a> on 2023-02-27 10:26</div>
            <div class="timeline-body"><p>There is a similar error with subcommands:</p>
<pre><code class="language-rust">#[derive(clap::Subcommand)]
enum Command {
    X
}
</code></pre>
<p>results in:</p>
<pre><code>error: this looks like you are trying to swap `__clap_subcommand` and `clap::Subcommand`
 --&gt; src/lib.rs:3:10
  |
3 | #[derive(clap::Subcommand)]
  |          ^^^^^^^^^^^^^^^^
  |
  = note: or maybe you should use `std::mem::replace`?
  = help: for further information visit https://rust-lang.github.io/rust-clippy/master/index.html#almost_swapped
note: the lint level is defined here
 --&gt; src/lib.rs:3:10
  |
3 | #[derive(clap::Subcommand)]
  |          ^^^^^^^^^^^^^^^^
  = note: `#[deny(clippy::almost_swapped)]` implied by `#[deny(clippy::correctness)]`
  = note: this error originates in the derive macro `clap::Subcommand` (in Nightly builds, run with -Z macro-backtrace for more info)
</code></pre>
<p>The relevant part of the expansion seems to be:</p>
<pre><code class="language-rust">impl clap::Subcommand for Command {
    fn augment_subcommands&lt;'b&gt;(__clap_app: clap::Command) -&gt; clap::Command {
        ;
        let __clap_app = __clap_app;
        let __clap_app =
            __clap_app.subcommand({
                    let __clap_subcommand = clap::Command::new(&quot;x&quot;);
                    let __clap_subcommand = __clap_subcommand;
                    let __clap_subcommand = __clap_subcommand;
                    __clap_subcommand
                });
        ;
        __clap_app
    }
    fn augment_subcommands_for_update&lt;'b&gt;(__clap_app: clap::Command)
        -&gt; clap::Command {
        ;
        let __clap_app = __clap_app;
        let __clap_app =
            __clap_app.subcommand({
                    let __clap_subcommand = clap::Command::new(&quot;x&quot;);
                    let __clap_subcommand = __clap_subcommand;
                    let __clap_subcommand = __clap_subcommand;
                    __clap_subcommand
                });
        ;
        __clap_app
    }
    fn has_subcommand(__clap_name: &amp;str) -&gt; bool {
        if &quot;x&quot; == __clap_name { return true }
        false
    }
}
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../ruffle-rs/ruffle/pulls/9756.html">ruffle-rs/ruffle#9756</a> on 2023-02-27 10:29</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/rkrasiuk">@rkrasiuk</a> on 2023-02-27 10:47</div>
            <div class="timeline-body"><p>@Ltrlg ty, this should be fixed in https://github.com/clap-rs/clap/pull/4735/commits/c1caf462ce40fc541066dfb2a9cccb586777a757 as well</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../candy-lang/candy/pulls/353.html">candy-lang/candy#353</a> on 2023-02-27 11:09</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../0xPolygonZero/evm-tests/pulls/15.html">0xPolygonZero/evm-tests#15</a> on 2023-02-27 18:08</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @epage on 2023-02-27 19:52</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/rkrasiuk">@rkrasiuk</a> on 2023-02-27 21:02</div>
            <div class="timeline-body"><p>@epage seems like we need to reopen this, because <code>#[deny(clippy::correctness)]</code> takes precedence over <code>#[allow(clippy::almost_swapped)]</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../rust-lang/rust-clippy/issues/10421.html">rust-lang/rust-clippy#10421</a> on 2023-02-28 04:17</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MingweiSamuel">@MingweiSamuel</a> on 2023-02-28 04:18</div>
            <div class="timeline-body"><p>Made a clippy issue: https://github.com/rust-lang/rust-clippy/issues/10421</p>
<p>Not clear to me that this should trigger clippy at all. At the very least the error message is wrong</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../hydro-project/hydro/issues/416.html">hydro-project/hydro#416</a> on 2023-02-28 04:22</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MingweiSamuel">@MingweiSamuel</a> on 2023-02-28 04:27</div>
            <div class="timeline-body"><p>Seems unnecessary to have <code>#[deny(clippy::correctness)]</code> in the first place (added in https://github.com/clap-rs/clap/commit/bfc850e99a26747de847fcc15b4786836e8dc4c0 )</p>
<p>Macros aren't really where you want clippy to be at its strictest. And really shouldn't be having clippy to catch bugs in macro code from user usage..</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/4739.html">clap-rs/clap#4739</a> on 2023-02-28 05:27</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/4740.html">clap-rs/clap#4740</a> on 2023-02-28 06:28</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../bpfman/bpfman/pulls/347.html">bpfman/bpfman#347</a> on 2023-02-28 16:20</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../ralexstokes/mev-rs/issues/89.html">ralexstokes/mev-rs#89</a> on 2023-02-28 17:19</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../bpfman/bpfman/issues/348.html">bpfman/bpfman#348</a> on 2023-02-28 18:02</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../deislabs/spiderlightning/pulls/342.html">deislabs/spiderlightning#342</a> on 2023-03-02 16:56</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../svix/svix-webhooks/pulls/866.html">svix/svix-webhooks#866</a> on 2023-03-07 22:03</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../libp2p/rust-libp2p/pulls/3509.html">libp2p/rust-libp2p#3509</a> on 2023-03-08 08:12</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../libp2p/rust-libp2p/pulls/3569.html">libp2p/rust-libp2p#3569</a> on 2023-03-08 08:24</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/blyxyas">@blyxyas</a> on 2023-03-13 18:27</div>
            <div class="timeline-body"><p>I've made a <a href="https://github.com/rust-lang/rust-clippy/pull/10499">PR to Clippy</a>, in a few days it should be fixed in Clippy itself (even without changing Clap's version).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/4849.html">clap-rs/clap#4849</a> on 2023-04-20 16:44</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../rust-lang/rust-clippy/issues/10685.html">rust-lang/rust-clippy#10685</a> on 2023-04-21 11:36</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../stellar/rs-stellar-xdr/pulls/247.html">stellar/rs-stellar-xdr#247</a> on 2023-04-21 18:53</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../ordinals/ord/pulls/2037.html">ordinals/ord#2037</a> on 2023-04-22 23:22</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../FuelLabs/forc-wallet/pulls/110.html">FuelLabs/forc-wallet#110</a> on 2023-04-24 11:32</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../stackabletech/stackablectl/pulls/253.html">stackabletech/stackablectl#253</a> on 2023-04-25 08:58</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../oxidecomputer/dice-util/issues/28.html">oxidecomputer/dice-util#28</a> on 2023-04-26 18:57</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../oxidecomputer/dice-util/pulls/29.html">oxidecomputer/dice-util#29</a> on 2023-04-26 19:02</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../solana-foundation/anchor/pulls/2474.html">solana-foundation/anchor#2474</a> on 2023-04-27 08:07</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../tembo/tembo/pulls/290.html">tembo/tembo#290</a> on 2023-04-27 14:43</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../cocogitto/cocogitto/pulls/280.html">cocogitto/cocogitto#280</a> on 2023-05-02 08:09</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../cargo-checkmate/cargo-checkmate/pulls/73.html">cargo-checkmate/cargo-checkmate#73</a> on 2023-05-09 16:03</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../MercuryTechnologies/nix-your-shell/pulls/27.html">MercuryTechnologies/nix-your-shell#27</a> on 2023-06-01 16:35</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:49:02 UTC
    </footer>
</body>
</html>
