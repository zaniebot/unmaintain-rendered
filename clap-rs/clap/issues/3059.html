<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>requires_ifs does not appear to work - clap-rs/clap #3059</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>requires_ifs does not appear to work</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/clap-rs/clap/issues/3059">#3059</a>
        opened by <a href="https://github.com/FrankC01">@FrankC01</a>
        on 2021-12-04 11:16
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/FrankC01">@FrankC01</a></div>
            <div class="timeline-body"><h3>Please complete the following tasks</h3>
<ul>
<li>[X] I have searched the <a href="https://github.com/clap-rs/clap/discussions">discussions</a></li>
<li>[X] I have searched the existing issues</li>
</ul>
<h3>Rust Version</h3>
<p>rustc 1.55.0 (c8dfcfe04 2021-09-06)</p>
<h3>Clap Version</h3>
<p>clap = &quot;2.33.3&quot;</p>
<h3>Minimal reproducible code</h3>
<pre><code class="language-rust">    #[test]
    fn test_output() {
        let res = App::new(&quot;prog&quot;)
            .arg(
                Arg::with_name(&quot;output&quot;)
                    .long(&quot;output&quot;)
                    .short(&quot;o&quot;)
                    .takes_value(true)
                    .possible_values(&amp;[&quot;csv&quot;, &quot;excel&quot;, &quot;stdout&quot;])
                    .default_value(&quot;stdout&quot;)
                    .help(&quot;Direct output to file&quot;),
            )
            .arg(
                Arg::with_name(&quot;filename&quot;)
                    .long(&quot;filename&quot;)
                    .short(&quot;f&quot;)
                    .takes_value(true)
                    // .requires_if(&quot;excel&quot;, &quot;output&quot;) 
                    // .requires_ifs(&amp;[(&quot;output&quot;, &quot;excel&quot;), (&quot;output&quot;, &quot;csv&quot;)])
                    .requires_ifs(&amp;[(&quot;excel&quot;, &quot;output&quot;), (&quot;csv&quot;, &quot;output&quot;)])
                    .help(&quot;Filename for '-o excel' or '-o csv' output&quot;),
            )
            .get_matches_from_safe(vec![&quot;prog&quot;, &quot;-o&quot;, &quot;excel&quot;]);
        println!(&quot;{:?}&quot;, res);
        // assert!(res.is_err()); // We  used -o excel so -f &lt;filename&gt; is required
        // assert_eq!(res.unwrap_err().kind, ErrorKind::MissingRequiredArgument);
    }
</code></pre>
<h3>Steps to reproduce the bug with the above code</h3>
<p>cargo test</p>
<h3>Actual Behaviour</h3>
<p>No error occurred</p>
<h3>Expected Behaviour</h3>
<p>Expected error as the <code>-f &lt;val&gt;</code> is required if <code>-o excel</code> or <code>-o csv</code> is present</p>
<h3>Additional Context</h3>
<p><em>No response</em></p>
<h3>Debug Output</h3>
<p><em>No response</em></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">T: bug</span> added by @FrankC01 on 2021-12-04 11:16</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/FrankC01">@FrankC01</a> on 2021-12-04 11:45</div>
            <div class="timeline-body"><p>This works if I change</p>
<p><code> .requires_ifs(&amp;[(&quot;output&quot;, &quot;excel&quot;), (&quot;output&quot;, &quot;csv&quot;)])</code></p>
<p>to</p>
<p><code> .required_ifs(&amp;[(&quot;output&quot;, &quot;excel&quot;), (&quot;output&quot;, &quot;csv&quot;)])</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2021-12-04 17:53</div>
            <div class="timeline-body"><p>Yes</p>
<ul>
<li>a &quot;requires&quot; relationship says <code>filename</code> cannot be present unless X conditions are met (<code>prog -f file</code> will fail without <code>-o excel</code>)</li>
<li>a &quot;required&quot; relationship says <code>filename</code> must be present if X conditions are met (<code>prog -o excel</code> will fail without <code>-f file</code>)</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2021-12-04 17:54</div>
            <div class="timeline-body"><p>And I do feel like we could do a better job clarifying that distinction</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/FrankC01">@FrankC01</a> on 2021-12-05 09:09</div>
            <div class="timeline-body"><p>However, while <code>required_ifs</code> fails if <code>-f &lt;arg&gt;</code> is not supplied with <code>-o &lt;arg&gt;</code>, it <strong><em>does not</em></strong> fail if I do <code>prog -f somefile</code></p>
<p>Basically I'm looking for a way to:</p>
<ol>
<li>If <code>-f &lt;arg&gt;</code> appears without <code>-o &lt;arg</code> <strong>then fail</strong></li>
<li>if <code>-o &lt;arg&gt;</code> appears without <code>-f &lt;arg&gt;</code> <strong>then fail</strong></li>
</ol>
<p>Am I missing some magic combo?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2021-12-06 13:00</div>
            <div class="timeline-body"><p>Could you provide code with those cases so we know which APIs you are using in which ways to try to get the behavior you are wanting that isn't working as expected?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/FrankC01">@FrankC01</a> on 2021-12-06 17:41</div>
            <div class="timeline-body"><p>Basically I want the two options to be required of each other <code>-o &lt;arg&gt; -f&lt;arg&gt;</code>
I will go through iterations of what I've tried and add them here</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../epage/clapng/issues/246.html">epage/clapng#246</a> on 2021-12-06 23:14</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/FrankC01">@FrankC01</a> on 2021-12-08 21:56</div>
            <div class="timeline-body"><p>@epage Here are the four combo's (2-required_ifs and 2-requires_ifs). I expect all to fail but only the first does:</p>
<pre><code class="language-rust">    #[test]
    fn test_requiredifs_options_without_file_fail() {
        let res = App::new(&quot;prog&quot;)
            .arg(
                Arg::with_name(&quot;output&quot;)
                    .long(&quot;output&quot;)
                    .short(&quot;o&quot;)
                    .takes_value(true)
                    .possible_values(&amp;[&quot;csv&quot;, &quot;excel&quot;, &quot;stdout&quot;])
                    .default_value(&quot;stdout&quot;)
                    .help(&quot;Direct output to file&quot;),
            )
            .arg(
                Arg::with_name(&quot;filename&quot;)
                    .long(&quot;filename&quot;)
                    .short(&quot;f&quot;)
                    .takes_value(true)
                    .required_ifs(&amp;[(&quot;output&quot;, &quot;excel&quot;), (&quot;output&quot;, &quot;csv&quot;)])
                    .help(&quot;Filename for '-o excel' or '-o csv' output&quot;),
            )
            .get_matches_from_safe(vec![&quot;prog&quot;, &quot;-o&quot;, &quot;excel&quot;]);
        assert!(res.is_err()); // We  used -o excel so -f &lt;filename&gt; is required
        assert_eq!(res.unwrap_err().kind, ErrorKind::MissingRequiredArgument);
    }
    #[test]
    fn test_requiredifs_options_without_output_should_fail() {
        let res = App::new(&quot;prog&quot;)
            .arg(
                Arg::with_name(&quot;output&quot;)
                    .long(&quot;output&quot;)
                    .short(&quot;o&quot;)
                    .takes_value(true)
                    .possible_values(&amp;[&quot;csv&quot;, &quot;excel&quot;, &quot;stdout&quot;])
                    .default_value(&quot;stdout&quot;)
                    .help(&quot;Direct output to file&quot;),
            )
            .arg(
                Arg::with_name(&quot;filename&quot;)
                    .long(&quot;filename&quot;)
                    .short(&quot;f&quot;)
                    .takes_value(true)
                    .required_ifs(&amp;[(&quot;output&quot;, &quot;excel&quot;), (&quot;output&quot;, &quot;csv&quot;)])
                    .help(&quot;Filename for '-o excel' or '-o csv' output&quot;),
            )
            .get_matches_from_safe(vec![&quot;prog&quot;, &quot;-f&quot;, &quot;filename&quot;]);
        assert!(res.is_err()); // We  used -o excel so -f &lt;filename&gt; is required
        assert_eq!(res.unwrap_err().kind, ErrorKind::MissingRequiredArgument);
    }
    #[test]
    fn test_requiresif_options_without_file_should_fail() {
        let res = App::new(&quot;prog&quot;)
            .arg(
                Arg::with_name(&quot;output&quot;)
                    .long(&quot;output&quot;)
                    .short(&quot;o&quot;)
                    .takes_value(true)
                    .possible_values(&amp;[&quot;csv&quot;, &quot;excel&quot;, &quot;stdout&quot;])
                    .default_value(&quot;stdout&quot;)
                    .help(&quot;Direct output to file&quot;),
            )
            .arg(
                Arg::with_name(&quot;filename&quot;)
                    .long(&quot;filename&quot;)
                    .short(&quot;f&quot;)
                    .takes_value(true)
                    .requires_ifs(&amp;[(&quot;output&quot;, &quot;excel&quot;), (&quot;output&quot;, &quot;csv&quot;)])
                    .help(&quot;Filename for '-o excel' or '-o csv' output&quot;),
            )
            .get_matches_from_safe(vec![&quot;prog&quot;, &quot;-o&quot;, &quot;excel&quot;]);
        assert!(res.is_err()); // We  used -o excel so -f &lt;filename&gt; is required
        assert_eq!(res.unwrap_err().kind, ErrorKind::MissingRequiredArgument);
    }
    #[test]
    fn test_requiresif_options_without_output_should_fail() {
        let res = App::new(&quot;prog&quot;)
            .arg(
                Arg::with_name(&quot;output&quot;)
                    .long(&quot;output&quot;)
                    .short(&quot;o&quot;)
                    .takes_value(true)
                    .possible_values(&amp;[&quot;csv&quot;, &quot;excel&quot;, &quot;stdout&quot;])
                    .default_value(&quot;stdout&quot;)
                    .help(&quot;Direct output to file&quot;),
            )
            .arg(
                Arg::with_name(&quot;filename&quot;)
                    .long(&quot;filename&quot;)
                    .short(&quot;f&quot;)
                    .takes_value(true)
                    .requires_ifs(&amp;[(&quot;output&quot;, &quot;excel&quot;), (&quot;output&quot;, &quot;csv&quot;)])
                    .help(&quot;Filename for '-o excel' or '-o csv' output&quot;),
            )
            .get_matches_from_safe(vec![&quot;prog&quot;, &quot;-f&quot;, &quot;somefile&quot;]);
        assert!(res.is_err()); // We  used -o excel so -f &lt;filename&gt; is required
        assert_eq!(res.unwrap_err().kind, ErrorKind::MissingRequiredArgument);
    }
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/3145.html">clap-rs/clap#3145</a> on 2021-12-10 20:25</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2021-12-10 20:38</div>
            <div class="timeline-body"><p>What you are looking for is something like</p>
<pre><code class="language-rust">use clap::{App, Arg, ErrorKind};

fn main() {}

#[test]
fn test_requiresif_options_without_output_should_fail() {
    let mut app = App::new(&quot;prog&quot;)
        .arg(
            Arg::new(&quot;output&quot;)
                .long(&quot;output&quot;)
                .short('o')
                .takes_value(true)
                .possible_values(&amp;[&quot;csv&quot;, &quot;excel&quot;, &quot;stdout&quot;])
                .requires_ifs(&amp;[(&quot;excel&quot;, &quot;filename&quot;), (&quot;csv&quot;, &quot;filename&quot;)])
                .help(&quot;Direct output to file&quot;),
        )
        .arg(
            Arg::new(&quot;filename&quot;)
                .long(&quot;filename&quot;)
                .short('f')
                .takes_value(true)
                .requires(&quot;output&quot;)
                .help(&quot;Filename for '-o excel' or '-o csv' output&quot;),
        );

    let res = app.try_get_matches_from_mut(vec![&quot;prog&quot;, &quot;-f&quot;, &quot;somefile&quot;]);
    assert!(res.is_err()); // We  used -o excel so -f &lt;filename&gt; is required
    assert_eq!(res.unwrap_err().kind, ErrorKind::MissingRequiredArgument);

    let res = app.try_get_matches_from_mut(vec![&quot;prog&quot;, &quot;-o&quot;, &quot;excel&quot;]);
    assert!(res.is_err()); // We  used -o excel so -f &lt;filename&gt; is required
    assert_eq!(res.unwrap_err().kind, ErrorKind::MissingRequiredArgument);

    let res = app.try_get_matches_from_mut(vec![&quot;prog&quot;, &quot;-o&quot;, &quot;stdout&quot;]);
    assert!(res.is_ok(), &quot;{:?}&quot;, res);

    let res = app.try_get_matches_from_mut(vec![&quot;prog&quot;, &quot;-o&quot;, &quot;excel&quot;, &quot;-f&quot;, &quot;file.xls&quot;]);
    assert!(res.is_ok(), &quot;{:?}&quot;, res);
}
</code></pre>
<p>This is written with clap3.  I've not checked to see if there are any gotchas backporting to clap2.</p>
<p>Even with clap3, I had to remove the <code>default_value</code>.  That can be added back in when we fix #3076</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/FrankC01">@FrankC01</a> on 2021-12-10 22:02</div>
            <div class="timeline-body"><p>Ok, so I had it bass-ackwards to begin with. I can work with your solution if you want to close this</p>
<p>And thanks for your help!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @epage on 2021-12-10 22:16</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:48:13 UTC
    </footer>
</body>
</html>
