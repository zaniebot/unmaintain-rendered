<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Running panicked when flatten structs which have same struct field name - clap-rs/clap #4556</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Running panicked when flatten structs which have same struct field name</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/clap-rs/clap/issues/4556">#4556</a>
        opened by <a href="https://github.com/yiv">@yiv</a>
        on 2022-12-15 12:20
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/yiv">@yiv</a></div>
            <div class="timeline-body"><h3>Please complete the following tasks</h3>
<ul>
<li>[X] I have searched the <a href="https://github.com/clap-rs/clap/discussions">discussions</a></li>
<li>[X] I have searched the <a href="https://github.com/clap-rs/clap/issues">open</a> and <a href="https://github.com/clap-rs/clap/issues?q=is%3Aissue+label%3AS-wont-fix+is%3Aclosed">rejected</a> issues</li>
</ul>
<h3>Rust Version</h3>
<p>rustc 1.65.0 (897e37553 2022-11-02)</p>
<h3>Clap Version</h3>
<p>4.0.29</p>
<h3>Minimal reproducible code</h3>
<pre><code class="language-rust">use clap::{command, Arg, Parser};

#[derive(Parser, Debug)]
#[command(author, version, about, long_about = None)]
struct AppConfig {
    #[clap(flatten)]
    redis: Option&lt;RedisConfig&gt;,
    #[clap(flatten)]
    database: Option&lt;DatabaseConfig&gt;,
}

#[derive(Parser, Debug)]
struct RedisConfig {
    #[arg(long = &quot;redis.level&quot;)]
    name: Option&lt;String&gt;,
}


#[derive(Parser, Debug)]
struct DatabaseConfig {
    #[arg(long = &quot;database.url&quot;)]
    name: Option&lt;String&gt;,
}

fn main() {
    let config = AppConfig::parse();
    println!(&quot;config {:?}&quot;, config);
}

</code></pre>
<h3>Steps to reproduce the bug with the above code</h3>
<p>cargo run</p>
<h3>Actual Behaviour</h3>
<p>pannic</p>
<pre><code class="language-shell">
warning: `tt` (bin &quot;tt&quot;) generated 1 warning
    Finished dev [unoptimized + debuginfo] target(s) in 0.11s
     Running `target/debug/tt`
thread 'main' panicked at 'Command tt: Argument names must be unique, but 'name' is in use by more than one argument or group', /Users/bytedance/.cargo/registry/src/rsproxy.cn-8f6827c7555bfaf8/clap-4.0.29/src/builder/debug_asserts.rs:95:13
stack backtrace:
   0: rust_begin_unwind
             at /rustc/897e37553bba8b42751c67658967889d11ecd120/library/std/src/panicking.rs:584:5
   1: core::panicking::panic_fmt
             at /rustc/897e37553bba8b42751c67658967889d11ecd120/library/core/src/panicking.rs:142:14
   2: clap::builder::debug_asserts::assert_app
             at /Users/bytedance/.cargo/registry/src/rsproxy.cn-8f6827c7555bfaf8/clap-4.0.29/src/builder/debug_asserts.rs:95:13
   3: clap::builder::command::Command::_build_self
             at /Users/bytedance/.cargo/registry/src/rsproxy.cn-8f6827c7555bfaf8/clap-4.0.29/src/builder/command.rs:3920:13
   4: clap::builder::command::Command::_do_parse
             at /Users/bytedance/.cargo/registry/src/rsproxy.cn-8f6827c7555bfaf8/clap-4.0.29/src/builder/command.rs:3790:9
   5: clap::builder::command::Command::try_get_matches_from_mut
             at /Users/bytedance/.cargo/registry/src/rsproxy.cn-8f6827c7555bfaf8/clap-4.0.29/src/builder/command.rs:708:9
   6: clap::builder::command::Command::get_matches_from
             at /Users/bytedance/.cargo/registry/src/rsproxy.cn-8f6827c7555bfaf8/clap-4.0.29/src/builder/command.rs:578:9
   7: clap::builder::command::Command::get_matches
             at /Users/bytedance/.cargo/registry/src/rsproxy.cn-8f6827c7555bfaf8/clap-4.0.29/src/builder/command.rs:490:9
   8: clap::derive::Parser::parse
             at /Users/bytedance/.cargo/registry/src/rsproxy.cn-8f6827c7555bfaf8/clap-4.0.29/src/derive.rs:82:27
   9: tt::main
             at ./src/main.rs:26:18
  10: core::ops::function::FnOnce::call_once
             at /rustc/897e37553bba8b42751c67658967889d11ecd120/library/core/src/ops/function.rs:248:5
note: Some details are omitted, run with `RUST_BACKTRACE=full` for a verbose backtrace.

Process finished with exit code 101
</code></pre>
<h3>Expected Behaviour</h3>
<p>should run successfully</p>
<h3>Additional Context</h3>
<p>running in release mode will succeed</p>
<pre><code>cargo run --release 
</code></pre>
<h3>Debug Output</h3>
<pre><code class="language-shell">
warning: `tt` (bin &quot;tt&quot;) generated 1 warning
    Finished dev [unoptimized + debuginfo] target(s) in 0.16s
     Running `target/debug/tt`
[      clap::builder::command] 	Command::_do_parse
[      clap::builder::command] 	Command::_build: name=&quot;tt&quot;
[      clap::builder::command] 	Command::_propagate:tt
[      clap::builder::command] 	Command::_check_help_and_version:tt expand_help_tree=false
[      clap::builder::command] 	Command::long_help_exists
[      clap::builder::command] 	Command::_check_help_and_version: Building default --help
[      clap::builder::command] 	Command::_check_help_and_version: Building default --version
[      clap::builder::command] 	Command::_propagate_global_args:tt
[clap::builder::debug_asserts] 	Command::_debug_asserts
[clap::builder::debug_asserts] 	Arg::_debug_asserts:name
thread 'main' panicked at 'Command tt: Argument names must be unique, but 'name' is in use by more than one argument or group', /Users/bytedance/.cargo/registry/src/rsproxy.cn-8f6827c7555bfaf8/clap-4.0.29/src/builder/debug_asserts.rs:95:13
stack backtrace:
   0: rust_begin_unwind
             at /rustc/897e37553bba8b42751c67658967889d11ecd120/library/std/src/panicking.rs:584:5
   1: core::panicking::panic_fmt
             at /rustc/897e37553bba8b42751c67658967889d11ecd120/library/core/src/panicking.rs:142:14
   2: clap::builder::debug_asserts::assert_app
             at /Users/bytedance/.cargo/registry/src/rsproxy.cn-8f6827c7555bfaf8/clap-4.0.29/src/builder/debug_asserts.rs:95:13
   3: clap::builder::command::Command::_build_self
             at /Users/bytedance/.cargo/registry/src/rsproxy.cn-8f6827c7555bfaf8/clap-4.0.29/src/builder/command.rs:3920:13
   4: clap::builder::command::Command::_do_parse
             at /Users/bytedance/.cargo/registry/src/rsproxy.cn-8f6827c7555bfaf8/clap-4.0.29/src/builder/command.rs:3790:9
   5: clap::builder::command::Command::try_get_matches_from_mut
             at /Users/bytedance/.cargo/registry/src/rsproxy.cn-8f6827c7555bfaf8/clap-4.0.29/src/builder/command.rs:708:9
   6: clap::builder::command::Command::get_matches_from
             at /Users/bytedance/.cargo/registry/src/rsproxy.cn-8f6827c7555bfaf8/clap-4.0.29/src/builder/command.rs:578:9
   7: clap::builder::command::Command::get_matches
             at /Users/bytedance/.cargo/registry/src/rsproxy.cn-8f6827c7555bfaf8/clap-4.0.29/src/builder/command.rs:490:9
   8: clap::derive::Parser::parse
             at /Users/bytedance/.cargo/registry/src/rsproxy.cn-8f6827c7555bfaf8/clap-4.0.29/src/derive.rs:82:27
   9: tt::main
             at ./src/main.rs:26:18
  10: core::ops::function::FnOnce::call_once
             at /rustc/897e37553bba8b42751c67658967889d11ecd120/library/core/src/ops/function.rs:248:5
note: Some details are omitted, run with `RUST_BACKTRACE=full` for a verbose backtrace.

Process finished with exit code 101
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">C-bug</span> added by @yiv on 2022-12-15 12:20</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/4557.html">clap-rs/clap#4557</a> on 2022-12-15 12:52</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2022-12-15 13:21</div>
            <div class="timeline-body"><p>Yes, at the moment, the user is expected to keep all of the names unique as those names translate are references used when parsing and allow the user to reference them for defining different forms of validation (e.g. <code>#[arg(requires = &quot;name&quot;)]</code></p>
<p>Doing this at compile-time is being tracked in #3133</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @epage on 2022-12-15 13:21</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AndreyMZ">@AndreyMZ</a> on 2023-09-09 15:55</div>
            <div class="timeline-body"><blockquote>
<p>at the moment, the user is expected to keep all of the names unique as those names translate are references used when parsing and allow the user to reference them for defining different forms of validation (e.g. #[arg(requires = &quot;name&quot;)]</p>
</blockquote>
<p>Is there plan to change this weird behavior? I would expect these fields to be referenced by <code>&quot;redis.name&quot;</code> and <code>&quot;database.name&quot;</code> similar to how they are referenced in Rust code (<code>config.redis?.name</code> and <code>config.database?.name</code>).</p>
<p>Proper naming is important part of programming. Names like <code>config.database?.name2</code> or <code>config.database?.database_name</code> are not proper. So, I propose reopening this issue as an enhancement to a future (maybe major) version of Clap.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AndreyMZ">@AndreyMZ</a> on 2023-09-09 16:16</div>
            <div class="timeline-body"><p>I have found a workaround using <a href="https://docs.rs/clap/latest/clap/struct.Arg.html#method.id"><code>Arg::id</code></a> and <a href="https://docs.rs/clap/latest/clap/struct.Arg.html#method.value_name"><code>Arg::value_name</code></a>:</p>
<pre><code class="language-rust">#[derive(Parser, Debug)]
#[command(author, version, about, long_about = None)]
struct AppConfig {
    #[clap(flatten)] redis: Option&lt;RedisConfig&gt;,
    #[clap(flatten)] database: Option&lt;DatabaseConfig&gt;,
}

#[derive(Parser, Debug)]
struct RedisConfig {
    #[arg(long = &quot;redis-name&quot;, value_name = &quot;NAME&quot;, id = &quot;redis.name&quot;)]
    name: Option&lt;String&gt;,
}

#[derive(Parser, Debug)]
struct DatabaseConfig {
    #[arg(long = &quot;database-name&quot;, value_name = &quot;NAME&quot;, id = &quot;database.name&quot;)]
    name: Option&lt;String&gt;,
}
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2023-09-10 00:10</div>
            <div class="timeline-body"><blockquote>
<p>Is there plan to change this weird behavior? I would expect these fields to be referenced by &quot;redis.name&quot; and &quot;database.name&quot; similar to how they are referenced in Rust code (config.redis?.name and config.database?.name).</p>
</blockquote>
<p>Are you asking for us to use the <code>long</code> for the <code>Arg::id</code>?  The problem with that is not everything has a long and we end up in the same situation except guessing the <code>Arg::id</code> is more difficult because its inconsistent.</p>
<p>As an alternative, we do have #4701</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AndreyMZ">@AndreyMZ</a> on 2023-09-29 18:02</div>
            <div class="timeline-body"><p>No, I would propose to use names of the variables joined with <code>.</code> for the <code>Arg::id</code> by default. However, I don't know if this is possible or not with the current macro system in Rust.</p>
<p>Anyway, given the ability to specify <code>Arg::id</code> explicitly, this would be a minor issue.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AndreyMZ">@AndreyMZ</a> on 2023-09-29 18:03</div>
            <div class="timeline-body"><p>Just in case, below is my example demonstrating this issue.</p>
<pre><code class="language-rs">use std::fs;
use std::path::PathBuf;

use clap::{Args, Parser};


#[derive(Parser, Default)]
#[command(author, version, about, long_about = None)]
struct Cli {
	#[command(flatten)] foo: CliFoo,
	#[command(flatten)] bar: CliBar,
}

#[derive(Args, Default)]
#[group(required = true, multiple = false)]
struct CliFoo{
	#[arg(long = &quot;foo&quot;,      /* value_name = &quot;TEXT&quot;, id = &quot;foo.text&quot; */)] text: Option&lt;String&gt;,
	#[arg(long = &quot;foo-file&quot;, /* value_name = &quot;PATH&quot;, id = &quot;foo.path&quot; */)] path: Option&lt;PathBuf&gt;,
}

#[derive(Args, Default)]
#[group(required = true, multiple = false)]
struct CliBar{
	#[arg(long = &quot;bar&quot;,      /* value_name = &quot;TEXT&quot;, id = &quot;bar.text&quot; */)] text: Option&lt;String&gt;,
	#[arg(long = &quot;bar-file&quot;, /* value_name = &quot;PATH&quot;, id = &quot;bar.path&quot; */)] path: Option&lt;PathBuf&gt;,
}


fn main() {
	let args = Cli::parse();
	
	let foo = match args.foo {
		CliFoo {text: Some(text), path: None} =&gt; text,
		CliFoo {text: None, path: Some(path)} =&gt; fs::read_to_string(&amp;path).unwrap(),
		_ =&gt; unreachable!(),
	};

	let bar = match args.bar {
		CliBar {text: Some(text), path: None} =&gt; text,
		CliBar {text: None, path: Some(path)} =&gt; fs::read_to_string(&amp;path).unwrap(),
		_ =&gt; unreachable!(),
	};
	
	println!(&quot;{foo}&quot;);
	println!(&quot;{bar}&quot;);
}
</code></pre>
<p>It panics while <code>value_name</code> and <code>id</code> are commented out: <a href="https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2021&amp;gist=8e64c6d2dca6a780fa0b9d33beda2406">https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2021&amp;gist=8e64c6d2dca6a780fa0b9d33beda2406</a></p>
<p>And it works OK if you uncomment them: https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2021&amp;gist=e82170868ce4e34f2d8a0331a4f20e49</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2023-09-29 18:32</div>
            <div class="timeline-body"><blockquote>
<p>No, I would propose to use names of the variables joined with . for the Arg::id by default. However, I don't know if this is possible or not with the current macro system in Rust.</p>
</blockquote>
<p>Oh, you want the name of the field that is used for flattening to be joined with the argument's field's name.</p>
<p>The derive limitation is that we can only process the information for our own derive.  This would require us to deal with this at runtime, to have the one struct pass the field name to the other struct and have it join the field names together at runtime.</p>
<ul>
<li>This runtime processing would slow things down when most cases don't need this</li>
<li>This is one of several problems where solve a derive problem by moving it to runtime but that means we are constantly revving the traits, making them unstable and complicated to deal with.  I've instead been taking the stance that we need very strong justifications for why a feature needs to be shifted to runtime.  Deriving <code>ArgGroup</code> has been one of them.</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Sytten">@Sytten</a> on 2023-11-09 16:03</div>
            <div class="timeline-body"><p>I came here for the same problem. I don't mind specifying the <code>id</code> manually though to differentiate the two fields.
You don't need to change to Parser, the Args derive also support the <code>id</code>.</p>
<pre><code class="language-rust">#[derive(Args, Clone, Debug)]
pub struct OpenAIConfiguration {
    #[clap(
        long = &quot;openai-base-url&quot;,
        env = &quot;OPENAI_BASE_URL&quot;,
        id = &quot;openai_base_url&quot;
    )]
    pub base_url: Option&lt;String&gt;,
}
</code></pre>
<p>I think what I would actually prefer is a derive arg to add a prefix to all, something like:</p>
<pre><code class="language-rust">#[derive(Args, Clone, Debug)]
#[clap(prefix = &quot;openai&quot;)]
pub struct OpenAIConfiguration {
    pub base_url: Option&lt;String&gt;,
}
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/3117.html">clap-rs/clap#3117</a> on 2023-11-09 16:06</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2023-11-09 16:11</div>
            <div class="timeline-body"><p>#4701 would automatically add &quot;a&quot; prefix to the <code>id</code> but not to other fields.</p>
<p>People have requested prefixes for more than id, like in #3513 and #3221</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/5374.html">clap-rs/clap#5374</a> on 2024-02-24 21:39</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:48:56 UTC
    </footer>
</body>
</html>
