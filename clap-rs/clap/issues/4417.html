<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>&quot;Could not downcast&quot; from `ArgAction::Count` - clap-rs/clap #4417</title>
    <link rel="stylesheet" href="../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../index.html">Back to index</a>
    </div>

    <h1>&quot;Could not downcast&quot; from `ArgAction::Count`</h1>

    <div class="meta">
        <span class="state state-closed">Closed</span>
        <a href="https://github.com/clap-rs/clap/issues/4417">#4417</a>
        opened by <a href="https://github.com/ssokolow">@ssokolow</a>
        on 2022-10-23 03:04
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/ssokolow">@ssokolow</a> on 2022-10-23 03:04</div>
            <div class="timeline-body"><h3>Please complete the following tasks</h3>
<ul>
<li>[X] I have searched the <a href="https://github.com/clap-rs/clap/discussions">discussions</a></li>
<li>[X] I have searched the <a href="https://github.com/clap-rs/clap/issues">open</a> and <a href="https://github.com/clap-rs/clap/issues?q=is%3Aissue+label%3AS-wont-fix+is%3Aclosed">rejected</a> issues</li>
</ul>
<h3>Rust Version</h3>
<p>rustc 1.64.0 (a55dd71d5 2022-09-19)</p>
<h3>Clap Version</h3>
<p>3.2.22 and 4.0.18, though output is from 3.2.22</p>
<h3>Minimal reproducible code</h3>
<pre><code class="language-rust">use clap::Parser;

#[derive(Parser)]
pub struct CliOpts {
    #[clap(short, action = clap::ArgAction::Count)]
    pub verbose: usize,
}

fn main() -&gt; () {
    let _ = CliOpts::parse();
}
</code></pre>
<p>...with <code>clap = { version = &quot;3&quot;, features = [&quot;derive&quot;] }</code></p>
<h3>Steps to reproduce the bug with the above code</h3>
<pre><code class="language-sh">cargo flamegraph -- -vvv
</code></pre>
<h3>Actual Behaviour</h3>
<pre><code>thread 'main' panicked at 'Mismatch between definition and access of `[hash: 1EC9D3D5DB2284A6]`. Could not downcast to TypeId { t: 13358953601680865708 }, need to downcast to TypeId { t: 13834754221672687376 }
', /home/ssokolow/.cargo/registry/src/github.com-1ecc6299db9ec823/clap-3.2.22/src/parser/parser.rs:1279:30
note: run with `RUST_BACKTRACE=1` environment variable to display a backtrace
[ perf record: Woken up 1 times to write data ]
[ perf record: Captured and wrote 0.062 MB perf.data (7 samples) ]
failed to sample program
</code></pre>
<h3>Expected Behaviour</h3>
<pre><code>[ perf record: Woken up 1 times to write data ]
[ perf record: Captured and wrote 0.117 MB perf.data (7 samples) ]
writing flamegraph to &quot;flamegraph.svg&quot;
</code></pre>
<p>(Or an error that's not obviously clap's version of an ICE if that's not the correct way to do what I'm aiming for.)</p>
<h3>Additional Context</h3>
<p>Testing was with flamegraph v0.6.2 (the newest <code>cargo install</code>able version at the moment I'm writing this), in case that proves relevant to reproduction.</p>
<p>While I've confirmed this is still a problem on clap 4.x, I specifically care about 3.x, because I've been using <code>@dependabot ignore this minor version</code> pending the return of proper coloured output.</p>
<p>I find monochromatic <code>--help</code> output ugly and &quot;colored&quot; output using intensity and underline to be worse and I'm waiting for support for colored output to return. (The <a href="https://no-color.org/"><code>NO_COLOR</code></a> environment variable exists for people who don't want color, as does the terminal's control panel to redefine the base 16-color palette if they have trouble with color contrast and readability.)</p>
<p>(If a security vulnerability pops up, I guess I'll have to publish a little crate to construct a <code>help_template</code> for clap 4.x by querying terminfo and the <code>NO_COLOR</code> environment variable and then hard-coding the escape codes for the colors from clap 3.x... assuming that the <code>help_template</code> syntax is versatile enough to reproduce it. I didn't actually check that. If it's not, maybe I'll publish a patched fork of clap 4.x to crates.io for them to depend on so I don't have to maintain tons of different vendored copies as these projects start to get published.)</p>
<h3>Debug Output</h3>
<pre><code>[      clap::builder::command]  Command::_do_parse
[      clap::builder::command]  Command::_build: name=&quot;clap_reproducer&quot;
[      clap::builder::command]  Command::_propagate:clap_reproducer
[      clap::builder::command]  Command::_check_help_and_version: clap_reproducer
[      clap::builder::command]  Command::_check_help_and_version: Removing generated version
[      clap::builder::command]  Command::_propagate_global_args:clap_reproducer
[      clap::builder::command]  Command::_derive_display_order:clap_reproducer
[        clap::parser::parser]  Parser::get_matches_with
[        clap::parser::parser]  Parser::get_matches_with: Begin parsing 'RawOsStr(&quot;-vvv&quot;)' ([45, 118, 118, 118])
[        clap::parser::parser]  Parser::possible_subcommand: arg=Ok(&quot;-vvv&quot;)
[        clap::parser::parser]  Parser::get_matches_with: sc=None
[        clap::parser::parser]  Parser::parse_short_arg: short_arg=ShortFlags { inner: RawOsStr(&quot;vvv&quot;), utf8_prefix: CharIndices { front_offset: 0, iter: Chars(['v', 'v', 'v']) }, invalid_suffix: None }
[        clap::parser::parser]  Parser::parse_short_arg:iter:v
[        clap::parser::parser]  Parser::parse_short_arg:iter:v: Found valid opt or flag
[        clap::parser::parser]  Parser::react action=Count, identifier=Some(Short), source=CommandLine
[        clap::parser::parser]  Parser::remove_overrides: id=[hash: 1EC9D3D5DB2284A6]
[   clap::parser::arg_matcher]  ArgMatcher::start_custom_arg: id=[hash: 1EC9D3D5DB2284A6], source=CommandLine
[      clap::builder::command]  Command::groups_for_arg: id=[hash: 1EC9D3D5DB2284A6]
[        clap::parser::parser]  Parser::push_arg_values: [&quot;1&quot;]
[        clap::parser::parser]  Parser::add_single_val_to_arg: cur_idx:=1
[      clap::builder::command]  Command::groups_for_arg: id=[hash: 1EC9D3D5DB2284A6]
[        clap::parser::parser]  Parser::parse_short_arg:iter:v
[        clap::parser::parser]  Parser::parse_short_arg:iter:v: Found valid opt or flag
[        clap::parser::parser]  Parser::react action=Count, identifier=Some(Short), source=CommandLine
thread 'main' panicked at 'Mismatch between definition and access of `[hash: 1EC9D3D5DB2284A6]`. Could not downcast to TypeId { t: 13358953601680865708 }, need to downcast to TypeId { t: 13834754221672687376 }
', /home/ssokolow/.cargo/registry/src/github.com-1ecc6299db9ec823/clap-3.2.22/src/parser/parser.rs:1279:30
note: run with `RUST_BACKTRACE=1` environment variable to display a backtrace
[ perf record: Woken up 1 times to write data ]
[ perf record: Captured and wrote 0.117 MB perf.data (7 samples) ]
failed to sample program
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">C-bug</span> added by @ssokolow on 2022-10-23 03:04</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/slonik-az">@slonik-az</a> on 2022-10-24 01:34</div>
            <div class="timeline-body"><p>Confirming the bug in the case of <code>clap-4.0.18</code>. The code above does not run at all (never mind flamegraph).</p>
<p>Trying to run it with <code>cargo run</code> panics:</p>
<pre><code>Running `target/debug/examples/flag_count_03`
thread 'main' panicked at 'assertion failed: `(left == right)`
  left: `u8`,
 right: `usize`: Argument `verbose`'s selected action Count contradicts `value_parser` (ValueParser::other(usize))',
/Users/____/.cargo/registry/src/github.com-1ecc6299db9ec823/clap-4.0.18/src/builder/debug_asserts.rs:708:9
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/3864.html">clap-rs/clap#3864</a> on 2022-10-24 01:42</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ssokolow">@ssokolow</a> on 2022-10-24 01:52</div>
            <div class="timeline-body"><blockquote>
<p>The code above does not run at all (never mind flamegraph).</p>
</blockquote>
<p>Maybe I got confused but I remember being very puzzled when it <em>was</em> working for me without <code>cargo flamegraph</code> under 3.2.22. That's why it made it into my set of reproduction instructions.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/slonik-az">@slonik-az</a> on 2022-10-24 12:08</div>
            <div class="timeline-body"><p>@ssokolow : Could you please change the title of this issue and remove flamegraph from it, for the issue you are reporint is broader than that.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from ""Could not downcast" from `ArgAction::Count` when run under `cargo flamegraph`" to ""Could not downcast" from `ArgAction::Count`" by @ssokolow on 2022-10-24 12:59</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2022-10-24 13:06</div>
            <div class="timeline-body"><blockquote>
<p>(If a security vulnerability pops up, I guess I'll have to publish a little crate to construct a help_template for clap 4.x by querying terminfo and the NO_COLOR environment variable and then hard-coding the escape codes for the colors from clap 3.x... assuming that the help_template syntax is versatile enough to reproduce it. I didn't actually check that. If it's not, maybe I'll publish a patched fork of clap 4.x to crates.io for them to depend on so I don't have to maintain tons of different vendored copies as these projects start to get published.)</p>
</blockquote>
<p>Right now, <a href="https://github.com/clap-rs/clap/blob/master/CONTRIBUTING.md#version-support-policy">v3 is in maintenance mode</a> and will receive security updates.  Even v2 is deprecated, but not obsolete, and we'll still try to resolve showstoppers if they come up.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2022-10-24 13:10</div>
            <div class="timeline-body"><p>The error message is better under debug builds than release builds.</p>
<p>This error is expected behavior and I would be more surprised by this working than not.  <code>ArgAction::Count</code> has only worked with u8's.  The old <code>parse(from_occurrences)</code> did support alternative data types.  The fix is to either change the data type to <code>u8</code> or to use <code>parse(from_occurrences)</code> though that will be unavailable in v4.  https://github.com/clap-rs/clap/issues/3912 is one potential way of allowing alternative data types.</p>
<p>As this error is expected, I'm going to go ahead and close this.  If there is something I was missing in closing this, let us know!.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @epage on 2022-10-24 13:10</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ssokolow">@ssokolow</a> on 2022-10-24 13:20</div>
            <div class="timeline-body"><p>I thought that might be the case. Could I reopen and rebadge this to be about how fish-to-the-face-ishly surprising and frustratingly confusing it is for a Rust library to giving me an error message I'd expect out of <a href="http://urwid.org/">urwid</a>? ...especially when the error message doesn't say &quot;Try again with a debug build, man.&quot;</p>
<p>(Urwid is kind of infamous for how it leans on Python's duck-typing in the worst possible way and, if you don't get the declarative UI definitons exactly in line with the schema it expects, your program dies with an <code>AttributeError</code> or <code>TypeError</code> or <code>ValueError</code> two dozen layers deep with a traceback that tells you <em>nothing</em> about what you did wrong.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ssokolow">@ssokolow</a> on 2022-10-24 13:22</div>
            <div class="timeline-body"><p>Actually, now that I think about it, I wonder if the debug/release difference is why, with 3.x, I remember getting a successful run with <code>cargo run -- -vvv</code> and that error with <code>cargo flamegraph -- -vvv</code>.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:28:34 UTC
    </footer>
</body>
</html>
