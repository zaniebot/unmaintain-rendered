<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Argument with default_values conflict when inside groups - clap-rs/clap #1906</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Argument with default_values conflict when inside groups</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/clap-rs/clap/issues/1906">#1906</a>
        opened by <a href="https://github.com/pksunkara">@pksunkara</a>
        on 2020-05-05 19:03
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/pksunkara">@pksunkara</a></div>
            <div class="timeline-body">Make sure you completed the following tasks
<ul>
<li>[x] Searched the <a href="https://github.com/clap-rs/clap/discussions">discussions</a></li>
<li>[x] Searched the closes issues</li>
</ul>
Code
<pre><code>use clap::{App, Arg};

fn main() {
    let result = App::new(&quot;conflict&quot;)
        .arg(
            Arg::with_name(&quot;opt&quot;)
                .long(&quot;opt&quot;)
                .default_value(&quot;default&quot;)
                .group(&quot;one&quot;),
        )
        .arg(Arg::with_name(&quot;flag&quot;).long(&quot;flag&quot;).conflicts_with(&quot;one&quot;))
        .get_matches_from(vec![&quot;myprog&quot;, &quot;--flag&quot;]);

    eprintln!(&quot;{:#?}&quot;, result);
}
</code></pre>
Version
<p>With <code>master</code> branch.</p>
Actual Behavior Summary
<pre><code>error: The argument &#x27;--opt &lt;opt&gt;&#x27; cannot be used with one or more of the other specified arguments

USAGE:
    myprog [FLAGS] [OPTIONS]

For more information try --help
</code></pre>
Expected Behavior Summary
<p>Should work.</p>
Additional context
<p>Related to #1605 which was recently fixed.</p>
Debug output
<p>Compile clap with <code>debug</code> feature:</p>
<pre><code>[dependencies]
clap = { version = &quot;*&quot;, features = [&quot;debug&quot;] }
</code></pre>
<p>The output may be very long, so feel free to link to a gist or attach a text file</p>

 Debug Output 
<pre>
<code>
[            clap::build::app] 	App::_do_parse
[            clap::build::app] 	App::_build
[            clap::build::app] 	App::_derive_display_order:conflict
[            clap::build::app] 	App::_create_help_and_version
[            clap::build::app] 	App::_create_help_and_version: Building --help
[            clap::build::app] 	App::_create_help_and_version: Building --version
[            clap::build::app] 	App::_debug_asserts
[            clap::build::arg] 	Arg::_debug_asserts:opt
[            clap::build::arg] 	Arg::_debug_asserts:flag
[            clap::build::arg] 	Arg::_debug_asserts:help
[            clap::build::arg] 	Arg::_debug_asserts:version
[         clap::parse::parser] 	Parser::get_matches_with
[         clap::parse::parser] 	Parser::_build
[         clap::parse::parser] 	Parser::_verify_positionals
[         clap::parse::parser] 	Parser::get_matches_with: Begin parsing &#x27;&quot;--flag&quot;&#x27; ([45, 45, 102, 108, 97, 103])
[         clap::parse::parser] 	Parser::is_new_arg: &quot;--flag&quot;:NotFound
[         clap::parse::parser] 	Parser::is_new_arg: arg_allows_tac=false
[         clap::parse::parser] 	Parser::is_new_arg: -- found
[         clap::parse::parser] 	Parser::is_new_arg: starts_new_arg=true
[         clap::parse::parser] 	Parser::possible_subcommand: arg=&quot;--flag&quot;
[         clap::parse::parser] 	Parser::get_matches_with: possible_sc=false, sc=None
[         clap::parse::parser] 	Parser::parse_long_arg
[         clap::parse::parser] 	Parser::parse_long_arg: Does it contain &#x27;=&#x27;...
[         clap::parse::parser] 	No
[         clap::parse::parser] 	Parser::parse_long_arg: Found valid opt or flag &#x27;--flag&#x27;
[         clap::parse::parser] 	Parser::check_for_help_and_version_str
[         clap::parse::parser] 	Parser::check_for_help_and_version_str: Checking if --&quot;flag&quot; is help or version...
[         clap::parse::parser] 	Neither
[         clap::parse::parser] 	Parser::parse_flag
[    clap::parse::arg_matcher] 	ArgMatcher::inc_occurrence_of: arg=flag
[    clap::parse::arg_matcher] 	ArgMatcher::inc_occurrence_of: first instance
[         clap::parse::parser] 	groups_for_arg: name=flag
[         clap::parse::parser] 	Parser::get_matches_with: After parse_long_arg Flag(flag)
[         clap::parse::parser] 	Parser::maybe_inc_pos_counter: arg = flag
[         clap::parse::parser] 	Parser::maybe_inc_pos_counter: is it positional?
[         clap::parse::parser] 	No
[         clap::parse::parser] 	groups_for_arg: name=flag
[         clap::parse::parser] 	Parser::remove_overrides
[         clap::parse::parser] 	Parser::remove_overrides:iter:flag
[      clap::parse::validator] 	Validator::validate
[         clap::parse::parser] 	Parser::add_defaults
[         clap::parse::parser] 	Parser::add_defaults:iter:opt:
[         clap::parse::parser] 	Parser::add_value: doesn&#x27;t have conditional defaults
[         clap::parse::parser] 	Parser::add_value:iter:opt: has default vals
[         clap::parse::parser] 	Parser::add_value:iter:opt: wasn&#x27;t used
[         clap::parse::parser] 	Parser::add_val_to_arg; arg=opt, val=&quot;default&quot;
[         clap::parse::parser] 	Parser::add_val_to_arg; trailing_vals=false, DontDelimTrailingVals=false
[         clap::parse::parser] 	Parser::add_single_val_to_arg: adding val...&quot;default&quot;
[         clap::parse::parser] 	groups_for_arg: name=opt
[    clap::parse::arg_matcher] 	ArgMatcher::needs_more_vals: o=opt
[      clap::parse::validator] 	Validator::validate_conflicts
[      clap::parse::validator] 	Validator::validate_exclusive
[      clap::parse::validator] 	Validator::validate_exclusive:iter:flag
[      clap::parse::validator] 	Validator::validate_exclusive:iter:opt
[      clap::parse::validator] 	Validator::validate_exclusive:iter:one
[      clap::parse::validator] 	Validator::gather_conflicts
[      clap::parse::validator] 	Validator::gather_conflicts:iter: id=flag
[      clap::parse::validator] 	groups_for_arg: name=flag
[      clap::parse::validator] 	Validator::gather_conflicts:iter: id=opt
[      clap::parse::validator] 	Validator::gather_conflicts:iter: This is default value, skipping.
[      clap::parse::validator] 	Validator::gather_conflicts:iter: id=one
[      clap::parse::validator] 	Validator::gather_conflicts:iter: This is default value, skipping.
[      clap::parse::validator] 	Validator::validate_conflicts:iter:one
[            clap::build::app] 	App::unroll_args_in_group: group=one
[            clap::build::app] 	App::unroll_args_in_group:iter: entity=opt
[            clap::build::app] 	App::unroll_args_in_group:iter: this is an arg
[      clap::parse::validator] 	Validator::build_conflict_err: name=one
[         clap::output::usage] 	Usage::create_usage_with_title
[         clap::output::usage] 	Usage::create_usage_no_title
[         clap::output::usage] 	Usage::create_help_usage; incl_reqs=true
[         clap::output::usage] 	Usage::get_required_usage_from: incls=[], matcher=false, incl_last=false
[         clap::output::usage] 	Usage::get_required_usage_from: ret_val=[]
[         clap::output::usage] 	Usage::needs_flags_tag
[         clap::output::usage] 	Usage::needs_flags_tag:iter: f=flag
[         clap::output::usage] 	groups_for_arg: name=flag
[         clap::output::usage] 	Usage::needs_flags_tag:iter: [FLAGS] required
[         clap::output::usage] 	Usage::create_help_usage: usage=myprog [FLAGS] [OPTIONS]
[            clap::build::app] 	App::unroll_args_in_group: group=one
[            clap::build::app] 	App::unroll_args_in_group:iter: entity=opt
[            clap::build::app] 	App::unroll_args_in_group:iter: this is an arg
[      clap::parse::validator] 	Validator::build_conflict_err: c_with=None:group
[            clap::build::app] 	App::color: Color setting...
[            clap::build::app] 	Auto
[           clap::output::fmt] 	is_a_tty: stderr=true
</code>
</pre>


</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">T: bug</span> added by <a href="https://github.com/pksunkara">@pksunkara</a> on 2020-05-05 19:03</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone &quot;3.0&quot; by <a href="https://github.com/pksunkara">@pksunkara</a> on 2020-05-05 19:03</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/pksunkara">@pksunkara</a> on 2020-05-05 19:04</div>
            <div class="timeline-body"><p>@CreepySkeleton You might want to look into this.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to <a href="https://github.com/CreepySkeleton">@CreepySkeleton</a> by <a href="https://github.com/CreepySkeleton">@CreepySkeleton</a> on 2020-05-05 23:37</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">C: arg groups</span> added by <a href="https://github.com/pksunkara">@pksunkara</a> on 2020-05-06 08:35</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">C: parsing</span> added by <a href="https://github.com/pksunkara">@pksunkara</a> on 2020-05-06 08:35</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/pksunkara">@pksunkara</a> on 2020-05-06 15:17</div>
            <div class="timeline-body"><p>There is one more snippet that is giving the same issue. Might be just common bug or different.</p>
<pre><code>use clap::{App, Arg};

fn main() {
    let result = App::new(&quot;conflict&quot;)
        .arg(
            Arg::with_name(&quot;opt&quot;)
                .long(&quot;opt&quot;)
                .default_value(&quot;default&quot;)
                .group(&quot;one&quot;),
        )
        .arg(
            Arg::with_name(&quot;bar&quot;)
                .long(&quot;bar&quot;)
                .default_value(&quot;foo&quot;)
                .group(&quot;one&quot;)
        )
        .arg(Arg::with_name(&quot;flag&quot;).long(&quot;flag&quot;).conflicts_with(&quot;one&quot;))
        .get_matches_from(vec![&quot;myprog&quot;, &quot;--flag&quot;]);

    eprintln!(&quot;{:#?}&quot;, result);
}
</code></pre>
<p>resulted in</p>
<pre><code>error: The argument &#x27;--opt &lt;opt&gt;&#x27; cannot be used with &#x27;--bar &lt;bar&gt;&#x27;

USAGE:
    myprog [FLAGS] [OPTIONS]

For more information try --help
</code></pre>

Debug Output
<pre><code>
[            clap::build::app] 	App::_do_parse
[            clap::build::app] 	App::_build
[            clap::build::app] 	App::_derive_display_order:conflict
[            clap::build::app] 	App::_create_help_and_version
[            clap::build::app] 	App::_create_help_and_version: Building --help
[            clap::build::app] 	App::_create_help_and_version: Building --version
[            clap::build::app] 	App::_debug_asserts
[            clap::build::arg] 	Arg::_debug_asserts:opt
[            clap::build::arg] 	Arg::_debug_asserts:bar
[            clap::build::arg] 	Arg::_debug_asserts:flag
[            clap::build::arg] 	Arg::_debug_asserts:help
[            clap::build::arg] 	Arg::_debug_asserts:version
[         clap::parse::parser] 	Parser::get_matches_with
[         clap::parse::parser] 	Parser::_build
[         clap::parse::parser] 	Parser::_verify_positionals
[         clap::parse::parser] 	Parser::get_matches_with: Begin parsing &#x27;&quot;--flag&quot;&#x27; ([45, 45, 102, 108, 97, 103])
[         clap::parse::parser] 	Parser::is_new_arg: &quot;--flag&quot;:NotFound
[         clap::parse::parser] 	Parser::is_new_arg: arg_allows_tac=false
[         clap::parse::parser] 	Parser::is_new_arg: -- found
[         clap::parse::parser] 	Parser::is_new_arg: starts_new_arg=true
[         clap::parse::parser] 	Parser::possible_subcommand: arg=&quot;--flag&quot;
[         clap::parse::parser] 	Parser::get_matches_with: possible_sc=false, sc=None
[         clap::parse::parser] 	Parser::parse_long_arg
[         clap::parse::parser] 	Parser::parse_long_arg: Does it contain &#x27;=&#x27;...
[         clap::parse::parser] 	No
[         clap::parse::parser] 	Parser::parse_long_arg: Found valid opt or flag &#x27;--flag&#x27;
[         clap::parse::parser] 	Parser::check_for_help_and_version_str
[         clap::parse::parser] 	Parser::check_for_help_and_version_str: Checking if --&quot;flag&quot; is help or version...
[         clap::parse::parser] 	Neither
[         clap::parse::parser] 	Parser::parse_flag
[    clap::parse::arg_matcher] 	ArgMatcher::inc_occurrence_of: arg=flag
[    clap::parse::arg_matcher] 	ArgMatcher::inc_occurrence_of: first instance
[         clap::parse::parser] 	groups_for_arg: name=flag
[         clap::parse::parser] 	Parser::get_matches_with: After parse_long_arg Flag(flag)
[         clap::parse::parser] 	Parser::maybe_inc_pos_counter: arg = flag
[         clap::parse::parser] 	Parser::maybe_inc_pos_counter: is it positional?
[         clap::parse::parser] 	No
[         clap::parse::parser] 	groups_for_arg: name=flag
[         clap::parse::parser] 	Parser::remove_overrides
[         clap::parse::parser] 	Parser::remove_overrides:iter:flag
[      clap::parse::validator] 	Validator::validate
[         clap::parse::parser] 	Parser::add_defaults
[         clap::parse::parser] 	Parser::add_defaults:iter:opt:
[         clap::parse::parser] 	Parser::add_value: doesn&#x27;t have conditional defaults
[         clap::parse::parser] 	Parser::add_value:iter:opt: has default vals
[         clap::parse::parser] 	Parser::add_value:iter:opt: wasn&#x27;t used
[         clap::parse::parser] 	Parser::add_val_to_arg; arg=opt, val=&quot;default&quot;
[         clap::parse::parser] 	Parser::add_val_to_arg; trailing_vals=false, DontDelimTrailingVals=false
[         clap::parse::parser] 	Parser::add_single_val_to_arg: adding val...&quot;default&quot;
[         clap::parse::parser] 	groups_for_arg: name=opt
[    clap::parse::arg_matcher] 	ArgMatcher::needs_more_vals: o=opt
[         clap::parse::parser] 	Parser::add_defaults:iter:bar:
[         clap::parse::parser] 	Parser::add_value: doesn&#x27;t have conditional defaults
[         clap::parse::parser] 	Parser::add_value:iter:bar: has default vals
[         clap::parse::parser] 	Parser::add_value:iter:bar: wasn&#x27;t used
[         clap::parse::parser] 	Parser::add_val_to_arg; arg=bar, val=&quot;foo&quot;
[         clap::parse::parser] 	Parser::add_val_to_arg; trailing_vals=false, DontDelimTrailingVals=false
[         clap::parse::parser] 	Parser::add_single_val_to_arg: adding val...&quot;foo&quot;
[         clap::parse::parser] 	groups_for_arg: name=bar
[    clap::parse::arg_matcher] 	ArgMatcher::needs_more_vals: o=bar
[      clap::parse::validator] 	Validator::validate_conflicts
[      clap::parse::validator] 	Validator::validate_exclusive
[      clap::parse::validator] 	Validator::validate_exclusive:iter:flag
[      clap::parse::validator] 	Validator::validate_exclusive:iter:opt
[      clap::parse::validator] 	Validator::validate_exclusive:iter:one
[      clap::parse::validator] 	Validator::validate_exclusive:iter:bar
[      clap::parse::validator] 	Validator::gather_conflicts
[      clap::parse::validator] 	Validator::gather_conflicts:iter: id=flag
[      clap::parse::validator] 	groups_for_arg: name=flag
[      clap::parse::validator] 	Validator::gather_conflicts:iter: id=opt
[      clap::parse::validator] 	Validator::gather_conflicts:iter: This is default value, skipping.
[      clap::parse::validator] 	Validator::gather_conflicts:iter: id=one
[      clap::parse::validator] 	Validator::gather_conflicts:iter: This is default value, skipping.
[      clap::parse::validator] 	Validator::gather_conflicts:iter: id=bar
[      clap::parse::validator] 	Validator::gather_conflicts:iter: This is default value, skipping.
[      clap::parse::validator] 	Validator::validate_conflicts:iter:one
[            clap::build::app] 	App::unroll_args_in_group: group=one
[            clap::build::app] 	App::unroll_args_in_group:iter: entity=opt
[            clap::build::app] 	App::unroll_args_in_group:iter: this is an arg
[            clap::build::app] 	App::unroll_args_in_group:iter: entity=bar
[            clap::build::app] 	App::unroll_args_in_group:iter: this is an arg
[      clap::parse::validator] 	Validator::build_conflict_err: name=one
[         clap::output::usage] 	Usage::create_usage_with_title
[         clap::output::usage] 	Usage::create_usage_no_title
[         clap::output::usage] 	Usage::create_help_usage; incl_reqs=true
[         clap::output::usage] 	Usage::get_required_usage_from: incls=[], matcher=false, incl_last=false
[         clap::output::usage] 	Usage::get_required_usage_from: ret_val=[]
[         clap::output::usage] 	Usage::needs_flags_tag
[         clap::output::usage] 	Usage::needs_flags_tag:iter: f=flag
[         clap::output::usage] 	groups_for_arg: name=flag
[         clap::output::usage] 	Usage::needs_flags_tag:iter: [FLAGS] required
[         clap::output::usage] 	Usage::create_help_usage: usage=myprog [FLAGS] [OPTIONS]
[            clap::build::app] 	App::unroll_args_in_group: group=one
[            clap::build::app] 	App::unroll_args_in_group:iter: entity=opt
[            clap::build::app] 	App::unroll_args_in_group:iter: this is an arg
[            clap::build::app] 	App::unroll_args_in_group:iter: entity=bar
[            clap::build::app] 	App::unroll_args_in_group:iter: this is an arg
[      clap::parse::validator] 	Validator::build_conflict_err: c_with=Some(&quot;--bar &quot;):group
[            clap::build::app] 	App::color: Color setting...
[            clap::build::app] 	Auto
[           clap::output::fmt] 	is_a_tty: stderr=true
</pre></code>


</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/CreepySkeleton">@CreepySkeleton</a> on 2020-05-11 08:01</div>
            <div class="timeline-body"><p>I know what the problem is but fixing it would require changes in the way how the matches stored. Actually, I&#x27;ve been looking into many bugs here, and fixing them would require changes in <code>ArgMatches</code>.</p>
<p>In short, arguments, global arguments, and groups must be stored and processed separately.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/pksunkara">@pksunkara</a> on 2020-05-11 08:12</div>
            <div class="timeline-body"><p>I think we would need to do it like that anyway to fix a few more global args bugs.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a>clap-rs/clap#1586</a> on 2021-08-09 02:10</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Removed from milestone &quot;3.0&quot; by <a href="https://github.com/epage">@epage</a> on 2021-10-16 18:13</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a>clap-rs/clap#2897</a> on 2021-10-16 19:48</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a>clap-rs/clap#2896</a> on 2021-10-24 21:55</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/bors[bot]">@bors[bot]</a> on 2021-10-27 21:31</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a>epage/clapng#10</a> on 2021-11-17 21:58</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a>clap-rs/clap#3076</a> on 2021-12-07 21:56</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:57:48 UTC
    </footer>
</body>
</html>
