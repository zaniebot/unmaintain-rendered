<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flatten structs causes &quot;Argument group name must be unique&quot; if has same name - clap-rs/clap #4279</title>
    <link rel="stylesheet" href="../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../index.html">Back to index</a>
    </div>

    <h1>Flatten structs causes &quot;Argument group name must be unique&quot; if has same name</h1>

    <div class="meta">
        <span class="state state-closed">Closed</span>
        <a href="https://github.com/clap-rs/clap/issues/4279">#4279</a>
        opened by <a href="https://github.com/repi">@repi</a>
        on 2022-09-28 20:12
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/repi">@repi</a> on 2022-09-28 20:12</div>
            <div class="timeline-body"><h3>Please complete the following tasks</h3>
<ul>
<li>[X] I have searched the <a href="https://github.com/clap-rs/clap/discussions">discussions</a></li>
<li>[X] I have searched the <a href="https://github.com/clap-rs/clap/issues">open</a> and <a href="https://github.com/clap-rs/clap/issues?q=is%3Aissue+label%3AS-wont-fix+is%3Aclosed">rejected</a> issues</li>
</ul>
<h3>Rust Version</h3>
<p>rustc 1.64.0 (a55dd71d5 2022-09-19)</p>
<h3>Clap Version</h3>
<p>4.0.1</p>
<h3>Minimal reproducible code</h3>
<pre><code class="language-rust">#[derive(clap::Parser, Debug)]
struct Config {
    #[arg(long)]
    pub value1: usize,

    #[clap(flatten)]
    pub config: sub::Config,
}

mod sub {

    #[derive(clap::Parser, Debug)]
    pub struct Config {
        #[arg(long)]
        pub value2: usize,
    }
}

fn main() {
    use clap::Parser;
    let config = Config::parse();

    println!(&quot;Hello: {config:?}&quot;);
}
</code></pre>
<h3>Steps to reproduce the bug with the above code</h3>
<p><code>cargo run</code></p>
<h3>Actual Behaviour</h3>
<p>The above causes panic on:</p>
<pre><code>Argument group name must be unique

        'Config' is already in use', /home/repi/.cargo/registry/src/github.com-1ecc6299db9ec823/clap-4.0.1/src/builder/debug_asserts.rs:284:9
note: run with `RUST_BACKTRACE=1` environment variable to display a backtrace
</code></pre>
<p>due to the two <code>Config</code> structs having the same name. Maybe caused internally by these being placed in separate argument groups but with the same argument group names instead of being merged together to a single argument group with then name &quot;Config&quot;?</p>
<p>The code</p>
<h3>Expected Behaviour</h3>
<p>Would want this to work out of the box without having to rename the types</p>
<h3>Additional Context</h3>
<p><em>No response</em></p>
<h3>Debug Output</h3>
<pre><code>[      clap::builder::command]  Command::_do_parse
[      clap::builder::command]  Command::_build: name=&quot;clap-tests&quot;
[      clap::builder::command]  Command::_propagate:clap-tests
[      clap::builder::command]  Command::_check_help_and_version:clap-tests expand_help_tree=false
[      clap::builder::command]  Command::long_help_exists
[      clap::builder::command]  Command::_check_help_and_version: Building default --help
[      clap::builder::command]  Command::_propagate_global_args:clap-tests
[clap::builder::debug_asserts]  Command::_debug_asserts
[clap::builder::debug_asserts]  Arg::_debug_asserts:value1
[clap::builder::debug_asserts]  Arg::_debug_asserts:value2
[clap::builder::debug_asserts]  Arg::_debug_asserts:help
thread 'main' panicked at 'Command clap-tests: Argument group name must be unique

        'Config' is already in use', /home/repi/.cargo/registry/src/github.com-1ecc6299db9ec823/clap-4.0.1/src/builder/debug_asserts.rs:284:9
note: run with `RUST_BACKTRACE=1` environment variable to display a backtrace
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">C-bug</span> added by @repi on 2022-09-28 20:12</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../EmbarkStudios/rust-ecosystem/issues/36.html">EmbarkStudios/rust-ecosystem#36</a> on 2022-09-28 20:12</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../alexheretic/ab-av1/pulls/52.html">alexheretic/ab-av1#52</a> on 2022-09-28 21:31</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">A-derive</span> added by @epage on 2022-09-28 22:13</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">S-blocked</span> added by @epage on 2022-09-28 22:13</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2022-09-28 22:16</div>
            <div class="timeline-body"><p>This group was added so we could implement</p>
<ul>
<li>https://github.com/clap-rs/clap/issues/3165</li>
<li>https://github.com/clap-rs/clap/issues/4211</li>
<li>https://github.com/clap-rs/clap/issues/2621</li>
</ul>
<p>When we implement https://github.com/clap-rs/clap/issues/3165, we should allow people to rename the implicit group which would be a work around for this that is less disruptive than renaming a type.</p>
<p>As for making this work automatically, I do not have any thoughts / plans for that.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/repi">@repi</a> on 2022-09-28 22:18</div>
            <div class="timeline-body"><p>Thanks. So to confirm, the only current solution is to rename the struct in the code so one doesn't have 2 or more structs with the same name if using flattening?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2022-09-28 22:20</div>
            <div class="timeline-body"><p>For now, yes.  If you  want, you can wait to upgrade until we implement #3165 to have another workaround.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ilslv">@ilslv</a> on 2022-09-30 11:56</div>
            <div class="timeline-body"><p>While <a href="https://github.com/cucumber-rs/cucumber/pull/230">upgrading to <code>0.4</code> in <code>cucumber</code> crate</a> we've stumbled into this issue, but just renaming structs doesn't work for our use case.</p>
<p>In short, we use <code>Compose</code> generic struct like:</p>
<pre><code class="language-rust">#[derive(Args, Debug)]
pub struct Compose&lt;L: Args, R: Args&gt; {
    #[clap(flatten)]
    pub left: L,
    #[clap(flatten)]
    pub right: R,
}
</code></pre>
<p>This <code>Compose</code> struct is used to fuse CLIs of different components (some of them may be user-defined). And most of those components doesn't add any new cli flags, so they use <code>Empty</code>:</p>
<pre><code class="language-rust">#[derive(Args, Clone, Copy, Debug)]
pub struct Empty;
</code></pre>
<p>So we quickly get <a href="https://github.com/cucumber-rs/cucumber/actions/runs/3158414239/jobs/5140421395#step:4:448"><code>Empty is already in use</code> panic</a>. And I don't think that https://github.com/clap-rs/clap/issues/3165 is going to help solve this problem.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../cucumber-rs/cucumber/pulls/230.html">cucumber-rs/cucumber#230</a> on 2022-09-30 11:57</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/tyranron">@tyranron</a> on 2022-09-30 12:31</div>
            <div class="timeline-body"><p>Hmmm... what if?</p>
<ol>
<li>Identify a group not by a type name, but by a <code>TypeId</code>, or at least canonical name like <code>::crate::module::Type</code>? This will auto-resolve any group naming collisions.</li>
<li>Regarding the <code>Empty</code> case, just allow collisions if a group has no args, because there can be no real collisions in this edge case. Or provide a special empty type in a <code>clap</code> crate for such purposes with the reserved group name, so the <code>clap</code> crate is aware of it.</li>
</ol>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2022-09-30 14:04</div>
            <div class="timeline-body"><p>@ilslv</p>
<blockquote>
<p>In short, we use Compose generic struct like:</p>
</blockquote>
<p>Thanks for sharing this use case!  Instead of prioritizing other group work, I think i'll focus on <code>#[group(skip)]</code> to disable it.</p>
<p>@tyranron</p>
<blockquote>
<p>Identify a group not by a type name, but by a TypeId, or at least canonical name like ::crate::module::Type? This will auto-resolve any group naming collisions.</p>
</blockquote>
<p>Users are also expected to be able to identify and use the group name which means it needs to be easily discoverable.  I'd worry that using the <code>TypeId</code> would make it too opaque</p>
<blockquote>
<p>Regarding the Empty case, just allow collisions if a group has no args, because there can be no real collisions in this edge case. Or provide a special empty type in a clap crate for such purposes with the reserved group name, so the clap crate is aware of it.</p>
</blockquote>
<p>For now, all groups are empty as I wanted to reserve the names in a breaking release for implementing #3165.  Even after that, while <code>Empty</code> would be empty, <code>Compose</code> would not and cucumber wouldn't be able to use multiple <code>Compose</code>s.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/4301.html">clap-rs/clap#4301</a> on 2022-09-30 14:16</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/3165.html">clap-rs/clap#3165</a> on 2022-09-30 14:18</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @epage on 2022-09-30 14:30</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2022-09-30 14:32</div>
            <div class="timeline-body"><p>4.0.6 is released with <code>#[group(skip)]</code> support</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/repi">@repi</a> on 2022-09-30 14:55</div>
            <div class="timeline-body"><p>big thanks! that solved our last remaining issue with clap v4</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/4307.html">clap-rs/clap#4307</a> on 2022-09-30 17:57</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../autonomys/subspace/issues/1215.html">autonomys/subspace#1215</a> on 2023-03-03 23:26</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../coreos/rpm-ostree/pulls/5273.html">coreos/rpm-ostree#5273</a> on 2025-02-05 15:09</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:28:34 UTC
    </footer>
</body>
</html>
