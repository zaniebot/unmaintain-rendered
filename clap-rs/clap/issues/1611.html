<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Empty $ENV triggers error message - clap-rs/clap #1611</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Empty $ENV triggers error message</h1>

    <div class="meta">
        <span class="state state-closed">Closed</span>
        <a href="https://github.com/clap-rs/clap/issues/1611">#1611</a>
        opened by <a href="https://github.com/ensc">@ensc</a>
        on 2019-12-23 12:22
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/ensc">@ensc</a> on 2019-12-23 12:22</div>
            <div class="timeline-body"><h3>Rust Version</h3>
<p>rustc 1.40.0 (73528e339 2019-12-16)</p>
<h3>Affected Version of clap</h3>
<p>git+https://github.com/clap-rs/clap#fc359e3c4692c2e99deaa21209259b8811c556b6</p>
<h3>Expected Behavior Summary</h3>
<p>When an option can both come command line and from env, the environment should be completely ignored when the option has been given on CLI.</p>
<h3>Actual Behavior Summary</h3>
<p>Actually, programs fails in this situation when the environment variable is empty.</p>
<h3>Steps to Reproduce the issue</h3>
<ol>
<li><p><code>env -u DB cargo --quiet run -- --database foo</code></p>
<p>is ok and works as expected.</p>
</li>
<li><p><code>env DB= cargo --quiet run -- --database foo</code></p>
<p>fails with</p>
<pre><code>error: The argument '--database &lt;database&gt;' requires a value but none was supplied
</code></pre>
</li>
</ol>
<h3>Sample Code or Link to Sample Code</h3>
<pre><code class="language-rust">extern crate clap;

fn main() {
    clap::App::new(&quot;test&quot;)
	.arg(clap::Arg::with_name(&quot;database&quot;)
	     .long(&quot;database&quot;)
	     .env(&quot;DB&quot;)
	     .takes_value(true))
	.get_matches();
}
</code></pre>
<h3>Debug output</h3>
<details>
<summary> Debug Output </summary>
<pre>
<code>
DEBUG:clap:App::_do_parse;
DEBUG:clap:App::_build;
DEBUG:clap:App::_derive_display_order:test
DEBUG:clap:App::_create_help_and_version;
DEBUG:clap:App::_create_help_and_version: Building --help
DEBUG:clap:App::_create_help_and_version: Building --version
DEBUG:clap:App::_arg_debug_asserts:database
DEBUG:clap:App::_arg_debug_asserts:help
DEBUG:clap:App::_arg_debug_asserts:version
DEBUG:clap:App::_app_debug_asserts;
DEBUG:clap:Parser::get_matches_with;
DEBUG:clap:Parser::_build;
DEBUG:clap:Parser::_verify_positionals;
DEBUG:clap:Parser::get_matches_with: Begin parsing '"--database"' ([45, 45, 100, 97, 116, 97, 98, 97, 115, 101])
DEBUG:clap:Parser::is_new_arg:"--database":NotFound
DEBUG:clap:Parser::is_new_arg: arg_allows_tac=false
DEBUG:clap:Parser::is_new_arg: -- found
DEBUG:clap:Parser::is_new_arg: starts_new_arg=true
DEBUG:clap:Parser::possible_subcommand: arg="--database"
DEBUG:clap:Parser::get_matches_with: possible_sc=false, sc=None
DEBUG:clap:Parser::parse_long_arg;
DEBUG:clap:Parser::parse_long_arg: Does it contain '='...No
DEBUG:clap:Parser::parse_long_arg: Found valid opt or flag '--database <database>'
DEBUG:clap:Parser::parse_opt; opt=database, val=None
DEBUG:clap:Parser::parse_opt; opt.settings=ArgFlags(TAKES_VAL | DELIM_NOT_SET)
DEBUG:clap:Parser::parse_opt; Checking for val...None
DEBUG:clap:ArgMatcher::inc_occurrence_of: arg=10007437080733436389
DEBUG:clap:ArgMatcher::inc_occurrence_of: first instance
DEBUG:clap:Parser::groups_for_arg: name=10007437080733436389
DEBUG:clap:Parser::parse_opt: More arg vals required...
DEBUG:clap:Parser:get_matches_with: After parse_long_arg Opt(10007437080733436389)
DEBUG:clap:Parser::get_matches_with: Begin parsing '"foo"' ([102, 111, 111])
DEBUG:clap:Parser::is_new_arg:"foo":Opt(10007437080733436389)
DEBUG:clap:Parser::is_new_arg: arg_allows_tac=false
DEBUG:clap:Parser::is_new_arg: probably value
DEBUG:clap:Parser::is_new_arg: starts_new_arg=false
DEBUG:clap:Parser::add_val_to_arg; arg=database, val="foo"
DEBUG:clap:Parser::add_val_to_arg; trailing_vals=false, DontDelimTrailingVals=false
DEBUG:clap:Parser::add_single_val_to_arg;
DEBUG:clap:Parser::add_single_val_to_arg: adding val..."foo"
DEBUG:clap:Parser::groups_for_arg: name=10007437080733436389
DEBUG:clap:ArgMatcher::needs_more_vals: o=database
DEBUG:clap:Parser::remove_overrides;
DEBUG:clap:Parser::remove_overrides:iter:10007437080733436389;
DEBUG:clap:Validator::validate;
DEBUG:clap:Parser::add_val_to_arg; arg=database, val=""
DEBUG:clap:Parser::add_val_to_arg; trailing_vals=false, DontDelimTrailingVals=false
DEBUG:clap:Parser::add_single_val_to_arg;
DEBUG:clap:Parser::add_single_val_to_arg: adding val...""
DEBUG:clap:Parser::groups_for_arg: name=10007437080733436389
DEBUG:clap:ArgMatcher::needs_more_vals: o=database
DEBUG:clap:Parser::add_defaults;
DEBUG:clap:Parser::add_defaults:iter:database: doesn't have conditional defaults
DEBUG:clap:Parser::add_defaults:iter:database: doesn't have default vals
DEBUG:clap:Validator::validate_conflicts;
DEBUG:clap:Validator::gather_conflicts;
DEBUG:clap:Validator::gather_conflicts:iter:10007437080733436389;
DEBUG:clap:Parser::groups_for_arg: name=10007437080733436389
DEBUG:clap:Validator::validate_required: required=ChildGraph([]);
DEBUG:clap:Validator::gather_requirements;
DEBUG:clap:Validator::gather_requirements:iter:10007437080733436389;
DEBUG:clap:Validator::validate_required_unless;
DEBUG:clap:Validator::validate_matched_args;
DEBUG:clap:Validator::validate_matched_args:iter:10007437080733436389: vals=[
    "foo",
    "",
]
DEBUG:clap:Validator::validate_arg_num_vals;
DEBUG:clap:Validator::validate_arg_values: arg="database"
DEBUG:clap:Validator::validate_arg_values: illegal empty val found
DEBUG:clap:usage::create_usage_with_title;
DEBUG:clap:usage::create_usage_no_title;
DEBUG:clap:Usage::create_help_usage; incl_reqs=true
DEBUG:clap:Usage::get_required_usage_from: incls=[], matcher=false, incl_last=false
DEBUG:clap:Usage::get_required_usage_from: ret_val=[]
DEBUG:clap:usage::needs_flags_tag;
DEBUG:clap:usage::needs_flags_tag:iter: f=help;
DEBUG:clap:usage::needs_flags_tag:iter: f=version;
DEBUG:clap:usage::needs_flags_tag: [FLAGS] not required
DEBUG:clap:usage::create_help_usage: usage=bin [OPTIONS]
DEBUG:clap:App::color;
DEBUG:clap:App::color: Color setting...Auto
DEBUG:clap:is_a_tty;
DEBUG:clap:Colorizer::error;
DEBUG:clap:Colorizer::warning;
DEBUG:clap:Colorizer::good;
</code>
</pre>
</details>

</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/craigpastro">@craigpastro</a> on 2020-01-07 04:53</div>
            <div class="timeline-body"><p>I tried to reproduce this, but in both cases</p>
<pre><code>env -u DB cargo --quiet run -- --database foo
env DB= cargo --quiet run -- --database foo
</code></pre>
<p>if I <code>println!</code> the following</p>
<pre><code> matches.value_of(&quot;database&quot;).unwrap()
</code></pre>
<p>I get <code>foo</code>, as expected...?</p>
<p>rustc 1.40.0
clap 2.33.0</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ensc">@ensc</a> on 2020-01-07 10:58</div>
            <div class="timeline-body"><p>@siyopao  I used 3.0.0-beta resp. recent git HEAD</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/craigpastro">@craigpastro</a> on 2020-01-08 00:29</div>
            <div class="timeline-body"><p>@ensc Ah, sorry, how silly, I should have tried that. Reproduced with git HEAD.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone "3.0" by @CreepySkeleton on 2020-02-01 10:53</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">help wanted</span> added by @CreepySkeleton on 2020-02-01 10:55</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">T: bug</span> added by @CreepySkeleton on 2020-02-01 10:55</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">W: 3.x</span> added by @CreepySkeleton on 2020-02-01 10:55</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">C: environment variable</span> added by @CreepySkeleton on 2020-02-01 10:56</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/CreepySkeleton">@CreepySkeleton</a> on 2020-04-27 08:29</div>
            <div class="timeline-body"><p>This was fixed by https://github.com/clap-rs/clap/pull/1850</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @CreepySkeleton on 2020-04-27 08:29</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:35:07 UTC
    </footer>
</body>
</html>
