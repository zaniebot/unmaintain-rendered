```yaml
number: 2659
title: Clap panics on broken pipe
type: issue
state: closed
author: epage
labels:
  - C-bug
  - ":money_with_wings: $5"
assignees: []
created_at: 2021-08-02T20:18:25Z
updated_at: 2021-08-18T16:51:02Z
url: https://github.com/clap-rs/clap/issues/2659
synced_at: 2026-01-10T01:57:45Z
```

# Clap panics on broken pipe

---

_Issue opened by @epage on 2021-08-02 20:18_

### Please complete the following tasks

- [X] I have searched the [discussions](https://github.com/clap-rs/clap/discussions)
- [X] I have searched the existing issues

### Rust Version

rustc 1.53.0 (53cb7b09b 2021-06-17)

### Clap Version

3.0.0-beta.2

### Minimal reproducible code

Any clap command

### Steps to reproduce the bug with the above code

Run a clap command with `--help | less` and quit before it finishes

### Actual Behaviour

Panics

### Expected Behaviour

Ignores the broken pipe or passes up a broken pipe error code

### Additional Context

This was inspired by ripgrep which has to [re-implement error printing](https://github.com/BurntSushi/ripgrep/blob/9f924ee187d4c62aa6ebe4903d0cfc6507a5adb5/crates/core/args.rs#L1839) to handle broken pipes correctly.  The window for having a broken pipe is relatively small but its another source of things not quite behaving as we want for user applications. 

In clap2, [`Error::exit` would swallow the broken pipe on error but paniced on success](https://github.com/clap-rs/clap/blob/v2-master/src/errors.rs#L395).

In clap3, we now [panic on both](https://github.com/clap-rs/clap/blob/master/src/parse/errors.rs#L479).

### Debug Output

_No response_

---

_Label `T: bug` added by @epage on 2021-08-02 20:18_

---

_Referenced in [artichoke/artichoke#1301](../../artichoke/artichoke/issues/1301.md) on 2021-08-05 04:21_

---

_Comment by @pksunkara on 2021-08-09 01:40_

@epage With your initial estimation, would fixing this require breaking changes? If no, I would prefer to leave it for after 3.0

---

_Label `C: errors` added by @pksunkara on 2021-08-09 01:42_

---

_Label `:money_with_wings: $5` added by @pksunkara on 2021-08-09 01:42_

---

_Label `D: easy` added by @pksunkara on 2021-08-09 01:42_

---

_Comment by @epage on 2021-08-09 13:43_

If we were changing exit codes, its murky whether to claim it a breaking change but panic to proper exit, it wouldn't be a breaking change.

There is, however, a regression from v2, so unsure how you want to prioritize that

---

_Comment by @epage on 2021-08-09 13:44_

(though i still think that regression is minor)

---

_Comment by @pksunkara on 2021-08-09 16:41_

I think that's okay. Leaving this for after 3.0

---

_Added to milestone `3.1` by @pksunkara on 2021-08-13 19:08_

---

_Referenced in [clap-rs/clap#2716](../../clap-rs/clap/pulls/2716.md) on 2021-08-18 15:18_

---

_Closed by @pksunkara on 2021-08-18 16:51_

---
