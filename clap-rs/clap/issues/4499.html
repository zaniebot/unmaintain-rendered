<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Allow short options to not accept implicitly attached values (`-sfoo`) - clap-rs/clap #4499</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Allow short options to not accept implicitly attached values (<code>-sfoo</code>)</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/clap-rs/clap/issues/4499">#4499</a>
        opened by <a href="https://github.com/zohnannor">@zohnannor</a>
        on 2022-11-21 20:44
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zohnannor">@zohnannor</a></div>
            <div class="timeline-body">Please complete the following tasks
<ul>
<li>[X] I have searched the <a href="https://github.com/clap-rs/clap/discussions">discussions</a></li>
<li>[X] I have searched the <a href="https://github.com/clap-rs/clap/issues">open</a> and <a href="https://github.com/clap-rs/clap/issues?q=is%3Aissue+label%3AS-wont-fix+is%3Aclosed">rejected</a> issues</li>
</ul>
Rust Version
<p>rustc 1.65.0 (897e37553 2022-11-02)</p>
Clap Version
<p>4.0.26</p>
Minimal reproducible code
<pre><code>/// Slightly modified pacman example: https://github.com/clap-rs/clap/blob/f5dcfc5bd92ff5bd52c1d74f202d2565e0f3102f/examples/pacman.rs

use clap::{Arg, ArgAction, Command};

fn main() {
    let matches = Command::new(&quot;pacman&quot;)
        .subcommand(
            Command::new(&quot;query&quot;)
                .short_flag(&#x27;Q&#x27;)
                .long_flag(&quot;query&quot;)
                .arg(
                    Arg::new(&quot;search&quot;)
                        .short(&#x27;s&#x27;)
                        .long(&quot;search&quot;)
                        .conflicts_with(&quot;info&quot;)
                        .action(ArgAction::Set)
                        .num_args(1..),
                )
                .arg(
                    Arg::new(&quot;info&quot;)
                        .long(&quot;info&quot;)
                        .short(&#x27;i&#x27;)
                        .conflicts_with(&quot;search&quot;)
                        .action(ArgAction::Set)
                        .num_args(1..),
                ),
        )
        .subcommand(
            Command::new(&quot;sync&quot;)
                .short_flag(&#x27;S&#x27;)
                .long_flag(&quot;sync&quot;)
                .arg(
                    Arg::new(&quot;search&quot;)
                        .short(&#x27;s&#x27;)
                        .long(&quot;search&quot;)
                        .conflicts_with(&quot;info&quot;)
                        .action(ArgAction::Set)
                        .num_args(1..),
                )
                .arg(
                    Arg::new(&quot;info&quot;)
                        .long(&quot;info&quot;)
                        .conflicts_with(&quot;search&quot;)
                        .short(&#x27;i&#x27;)
                        .action(ArgAction::SetTrue),
                ),
        )
        .get_matches();

    dbg!(matches.subcommand());
}
</code></pre>
Steps to reproduce the bug with the above code
<p><code>cargo r --example pacman -- -Ssi</code></p>
Actual Behaviour
<p>The above command arguments (<code>-Ssi</code>) are interpreted as <code>-S -s i</code>, the <code>s</code> flag takes <code>i</code> as an argument.</p>
Expected Behaviour
<p>This behavior did confuse me honestly. I expected same output as from <code>-Sis test</code>:</p>
<pre><code>error: The argument &#x27;--info&#x27; cannot be used with &#x27;--search &lt;search&gt;...&#x27;

Usage: pacman {sync|--sync|-S} --info

For more information try &#x27;--help&#x27;
</code></pre>
<p>(To be fair, I also expected <code>-Sis</code> to fail, but it errors with <code>error: The argument &#x27;--search &lt;search&gt;...&#x27; requires a value but none was supplied</code>, I think it should <em>first</em> check for conflicts and then try to parse flag&#x27;s params.)</p>
Additional Context
<p>Command with these args | Works? | Should? | Notes
:- | :-: | :-: | :-
<code>-Si</code> | Yes | Yes :white_check_mark:|
<code>-Ss</code> | No | No :white_check_mark:| Errors with <code>The argument &#x27;--search &lt;search&gt;...&#x27; requires a value but none was supplied</code>
<code>-Sis</code> | No | No :white_check_mark: | Errors with <code>The argument &#x27;--search &lt;search&gt;...&#x27; requires a value but none was supplied</code>
<code>-Ssi</code> | Yes | No :x:| What this issue is about
<code>-Sis test</code> | No | No :white_check_mark:| Errors with <code>The argument &#x27;--info&#x27; cannot be used with &#x27;--search &lt;search&gt;...&#x27;</code>
<code>-Ssi test</code> | No | No :grey_question: | But, here it errors with <code>Found argument &#x27;test&#x27; which wasn&#x27;t expected, or isn&#x27;t valid in this context</code>, but <em>really</em> it should say <code>The argument &#x27;--info&#x27; cannot be used with &#x27;--search &lt;search&gt;...&#x27;</code>
<code>-S -i</code> | Yes | Yes :white_check_mark:|
<code>-S -s</code> | No | No :white_check_mark:| Errors with <code>The argument &#x27;--search &lt;search&gt;...&#x27; requires a value but none was supplied</code>
<code>-S -i -s</code> | No | No :white_check_mark: | Errors with <code>The argument &#x27;--search &lt;search&gt;...&#x27; requires a value but none was supplied</code>
<code>-S -s -i</code> | No | No ~:white_check_mark:~ :grey_question: | Errors with <code>The argument &#x27;--search &lt;search&gt;...&#x27; requires a value but none was supplied</code>, ~which should happen with <code>-Ssi</code> too~, it should error with <code>The argument &#x27;--info&#x27; cannot be used with &#x27;--search &lt;search&gt;...&#x27;</code></p>
<p>I apologize for possibly incorrect terminology in the issue title.</p>
Debug Output
<pre><code>cargo r --features debug --example pacman -- -Ssi test
   Compiling adler v1.0.2
   Compiling gimli v0.26.2
   Compiling object v0.29.0
   Compiling rustc-demangle v0.1.21
   Compiling miniz_oxide v0.5.3
   Compiling addr2line v0.17.0
   Compiling backtrace v0.3.66
   Compiling clap v4.0.26 (/home/zohnannor/clap)
    Finished dev [unoptimized + debuginfo] target(s) in 11.34s
     Running `target/debug/examples/pacman -Ssi test`
[      clap::builder::command] 	Command::_do_parse
[      clap::builder::command] 	Command::_build: name=&quot;pacman&quot;
[      clap::builder::command] 	Command::_propagate:pacman
[      clap::builder::command] 	Command::_check_help_and_version:pacman expand_help_tree=false
[      clap::builder::command] 	Command::long_help_exists
[      clap::builder::command] 	Command::_check_help_and_version: Building default --help
[      clap::builder::command] 	Command::_check_help_and_version: Building help subcommand
[      clap::builder::command] 	Command::_propagate_global_args:pacman
[clap::builder::debug_asserts] 	Command::_debug_asserts
[clap::builder::debug_asserts] 	Arg::_debug_asserts:help
[clap::builder::debug_asserts] 	Command::_verify_positionals
[        clap::parser::parser] 	Parser::get_matches_with
[        clap::parser::parser] 	Parser::get_matches_with: Begin parsing &#x27;RawOsStr(&quot;-Ssi&quot;)&#x27; ([45, 83, 115, 105])
[        clap::parser::parser] 	Parser::possible_subcommand: arg=Ok(&quot;-Ssi&quot;)
[        clap::parser::parser] 	Parser::get_matches_with: sc=None
[        clap::parser::parser] 	Parser::parse_short_arg: short_arg=ShortFlags { inner: RawOsStr(&quot;Ssi&quot;), utf8_prefix: CharIndices { front_offset: 0, iter: Chars([&#x27;S&#x27;, &#x27;s&#x27;, &#x27;i&#x27;]) }, invalid_suffix: None }
[        clap::parser::parser] 	Parser::parse_short_arg:iter:S
[        clap::parser::parser] 	Parser::parse_short_arg:iter:S: subcommand=sync
[        clap::parser::parser] 	Parser::parse_short_arg: cur_idx:=1
[        clap::parser::parser] 	Parser::get_matches_with: After parse_short_arg FlagSubCommand(&quot;sync&quot;)
[        clap::parser::parser] 	Parser::get_matches_with:FlagSubCommandShort: subcmd_name=sync, keep_state=true, flag_subcmd_skip=1
[        clap::parser::parser] 	Parser::parse_subcommand
[         clap::output::usage] 	Usage::get_required_usage_from: incls=[], matcher=false, incl_last=true
[         clap::output::usage] 	Usage::get_required_usage_from: unrolled_reqs=[]
[         clap::output::usage] 	Usage::get_required_usage_from: ret_val=[]
[      clap::builder::command] 	Command::_build_subcommand Setting bin_name of sync to &quot;pacman sync&quot;
[      clap::builder::command] 	Command::_build_subcommand Setting display_name of sync to &quot;pacman-sync&quot;
[      clap::builder::command] 	Command::_build: name=&quot;sync&quot;
[      clap::builder::command] 	Command::_propagate:sync
[      clap::builder::command] 	Command::_check_help_and_version:sync expand_help_tree=false
[      clap::builder::command] 	Command::long_help_exists
[      clap::builder::command] 	Command::_check_help_and_version: Building default --help
[      clap::builder::command] 	Command::_propagate_global_args:sync
[clap::builder::debug_asserts] 	Command::_debug_asserts
[clap::builder::debug_asserts] 	Arg::_debug_asserts:search
[clap::builder::debug_asserts] 	Arg::_debug_asserts:info
[clap::builder::debug_asserts] 	Arg::_debug_asserts:help
[clap::builder::debug_asserts] 	Command::_verify_positionals
[        clap::parser::parser] 	Parser::parse_subcommand: About to parse sc=sync
[        clap::parser::parser] 	Parser::get_matches_with
[        clap::parser::parser] 	Parser::get_matches_with: Begin parsing &#x27;RawOsStr(&quot;-Ssi&quot;)&#x27; ([45, 83, 115, 105])
[        clap::parser::parser] 	Parser::possible_subcommand: arg=Ok(&quot;-Ssi&quot;)
[        clap::parser::parser] 	Parser::get_matches_with: sc=None
[        clap::parser::parser] 	Parser::parse_short_arg: short_arg=ShortFlags { inner: RawOsStr(&quot;Ssi&quot;), utf8_prefix: CharIndices { front_offset: 0, iter: Chars([&#x27;S&#x27;, &#x27;s&#x27;, &#x27;i&#x27;]) }, invalid_suffix: None }
[        clap::parser::parser] 	Parser::parse_short_arg:iter:s
[        clap::parser::parser] 	Parser::parse_short_arg:iter:s: Found valid opt or flag
[        clap::parser::parser] 	Parser::parse_short_arg:iter:s: val=RawOsStr(&quot;i&quot;) (bytes), val=[105] (ascii), short_arg=ShortFlags { inner: RawOsStr(&quot;Ssi&quot;), utf8_prefix: CharIndices { front_offset: 2, iter: Chars([&#x27;i&#x27;]) }, invalid_suffix: None }
[        clap::parser::parser] 	Parser::parse_opt_value; arg=search, val=Some(RawOsStr(&quot;i&quot;)), has_eq=false
[        clap::parser::parser] 	Parser::parse_opt_value; arg.settings=ArgFlags(NO_OP)
[        clap::parser::parser] 	Parser::parse_opt_value; Checking for val...
[        clap::parser::parser] 	Parser::react action=Set, identifier=Some(Short), source=CommandLine
[        clap::parser::parser] 	Parser::react: cur_idx:=2
[        clap::parser::parser] 	Parser::remove_overrides: id=&quot;search&quot;
[   clap::parser::arg_matcher] 	ArgMatcher::start_custom_arg: id=&quot;search&quot;, source=CommandLine
[      clap::builder::command] 	Command::groups_for_arg: id=&quot;search&quot;
[        clap::parser::parser] 	Parser::push_arg_values: [&quot;i&quot;]
[        clap::parser::parser] 	Parser::add_single_val_to_arg: cur_idx:=3
[   clap::parser::arg_matcher] 	ArgMatcher::needs_more_vals: o=search, pending=0
[   clap::parser::arg_matcher] 	ArgMatcher::needs_more_vals: expected=1..=18446744073709551615, actual=0
[        clap::parser::parser] 	Parser::react not enough values passed in, leaving it to the validator to complain
[        clap::parser::parser] 	Parser::get_matches_with: After parse_short_arg ValuesDone
[        clap::parser::parser] 	Parser::get_matches_with: Begin parsing &#x27;RawOsStr(&quot;test&quot;)&#x27; ([116, 101, 115, 116])
[        clap::parser::parser] 	Parser::possible_subcommand: arg=Ok(&quot;test&quot;)
[        clap::parser::parser] 	Parser::get_matches_with: sc=None
[        clap::parser::parser] 	Parser::get_matches_with: Positional counter...1
[        clap::parser::parser] 	Parser::get_matches_with: Low index multiples...false
[         clap::output::usage] 	Usage::create_usage_with_title
[         clap::output::usage] 	Usage::create_usage_no_title
[         clap::output::usage] 	Usage::create_help_usage; incl_reqs=true
[         clap::output::usage] 	Usage::needs_options_tag
[         clap::output::usage] 	Usage::needs_options_tag:iter: f=search
[      clap::builder::command] 	Command::groups_for_arg: id=&quot;search&quot;
[         clap::output::usage] 	Usage::needs_options_tag:iter: [OPTIONS] required
[         clap::output::usage] 	Usage::get_args: incls=[]
[         clap::output::usage] 	Usage::get_args: unrolled_reqs=[]
[         clap::output::usage] 	Usage::get_args: ret_val=[]
[         clap::output::usage] 	Usage::create_help_usage: usage=pacman {sync|--sync|-S} [OPTIONS]
[      clap::builder::command] 	Command::color: Color setting...
[      clap::builder::command] 	Auto
[      clap::builder::command] 	Command::color: Color setting...
[      clap::builder::command] 	Auto
error: Found argument &#x27;test&#x27; which wasn&#x27;t expected, or isn&#x27;t valid in this context

Usage: pacman {sync|--sync|-S} [OPTIONS]

For more information try &#x27;--help&#x27;
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">C-bug</span> added by <a href="https://github.com/zohnannor">@zohnannor</a> on 2022-11-21 20:44</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2022-11-22 00:29</div>
            <div class="timeline-body"><blockquote>
<p>The above command arguments (<code>-Ssi</code>) are interpreted as <code>-S -s i</code>, the s flag takes i as an argument.</p>
</blockquote>
<p><code>-s</code> takes a value and short flags are allowed to have an implicitly attached value, so this is expected.  I think you can set <code>requires_equals</code> to bypass the implicitly attached value but that will require an <code>=</code> always and not just disable implicitly attached values.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zohnannor">@zohnannor</a> on 2022-11-22 16:53</div>
            <div class="timeline-body"><p>Yes, it is working as it is written in the code, as expected. What I&#x27;m saying is (I guess, https://github.com/clap-rs/clap/labels/C-bug label is incorrect here, sorry), shouldn&#x27;t there be <strong>at least</strong> an option to forbid attached values for arguments? Also, regarding <code>-S -s -i</code>, shouldn&#x27;t it check for conflicts first? <code>pacman</code> itself works like that:</p>
<pre><code>$ sudo pacman -Sis
error: invalid option: &#x27;--info&#x27; and &#x27;--search&#x27; may not be used together
$ sudo pacman -Ssi
error: invalid option: &#x27;--info&#x27; and &#x27;--search&#x27; may not be used together
$ sudo pacman -S -s -i
error: invalid option: &#x27;--info&#x27; and &#x27;--search&#x27; may not be used together
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2022-11-22 18:07</div>
            <div class="timeline-body"><blockquote>
<p>shouldn&#x27;t there be at least an option to forbid attached values for arguments?</p>
</blockquote>
<p>Unsure, will have to give it some thought.  It seems like some more flexibility around implicitly attached, explicitly attached, and detached values could help with some cases.  See also #3030</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">C-bug</span> removed by <a href="https://github.com/epage">@epage</a> on 2022-11-22 18:08</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">C-enhancement</span> added by <a href="https://github.com/epage">@epage</a> on 2022-11-22 18:08</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">A-parsing</span> added by <a href="https://github.com/epage">@epage</a> on 2022-11-22 18:08</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">S-waiting-on-design</span> added by <a href="https://github.com/epage">@epage</a> on 2022-11-22 18:08</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from &quot;Flag takes next flag as value (pacman example)&quot; to &quot;Allow short options to not accept implicitly attached values (`-sfoo`)&quot; by <a href="https://github.com/epage">@epage</a> on 2022-11-22 18:08</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2023-02-13 14:27</div>
            <div class="timeline-body"><p>btw by disallowing attached values, you might not get</p>
<pre><code>error: The argument &#x27;--info&#x27; cannot be used with &#x27;--search &lt;search&gt;...&#x27;

Usage: pacman {sync|--sync|-S} --info

For more information try &#x27;--help&#x27;
</code></pre>
<p>but instead an error about <code>--search</code> missing a value</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a>clap-rs/clap#4702</a> on 2023-02-13 16:03</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zohnannor">@zohnannor</a> on 2023-02-14 22:44</div>
            <div class="timeline-body"><p>Yes, and I&#x27;ve also mentioned that in the table for entry <code>-S -s -i</code>, it is counter-intuitive and possibly even deserves its own issue. I presume it depends on the order in which <code>clap</code> parses arguments and it would be a breaking change to modify it.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:59:30 UTC
    </footer>
</body>
</html>
