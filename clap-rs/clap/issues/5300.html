<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>behavior change regarding `possible_values` on derived boolean args in 4.4.14 - clap-rs/clap #5300</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>behavior change regarding <code>possible_values</code> on derived boolean args in 4.4.14</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/clap-rs/clap/issues/5300">#5300</a>
        opened by <a href="https://github.com/ahl">@ahl</a>
        on 2024-01-12 16:56
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ahl">@ahl</a></div>
            <div class="timeline-body">Please complete the following tasks
<ul>
<li>[X] I have searched the <a href="https://github.com/clap-rs/clap/discussions">discussions</a></li>
<li>[X] I have searched the <a href="https://github.com/clap-rs/clap/issues">open</a> and <a href="https://github.com/clap-rs/clap/issues?q=is%3Aissue+label%3AS-wont-fix+is%3Aclosed">rejected</a> issues</li>
</ul>
Rust Version
<p>rustc 1.75.0 (82e1608df 2023-12-21)</p>
Clap Version
<p>4.4.14</p>
Minimal reproducible code
<pre><code>use clap::{CommandFactory, Parser};

#[derive(Parser)]
pub struct Args {
    #[clap(long)]
    ok: bool,
}

fn main() {
    let values = Args::command()
        .get_arguments()
        .next()
        .expect(&quot;no arguments&quot;)
        .get_possible_values();
    println!(&quot;{:#?}&quot;, values);
}
</code></pre>
Steps to reproduce the bug with the above code
<p>Use 4.4.13; cargo run:</p>
<pre><code>[]
</code></pre>
<p>Use 4.4.14; cargo run:</p>
<pre><code>[
    PossibleValue {
        name: &quot;true&quot;,
        help: None,
        aliases: [],
        hide: false,
    },
    PossibleValue {
        name: &quot;false&quot;,
        help: None,
        aliases: [],
        hide: false,
    },
]
</code></pre>
Actual Behaviour
<p>Behavior change from 4.4.13 to 4.4.14</p>
Expected Behaviour
<p>No behavior change? Unless this was intentional. I didn&#x27;t see it mentioned in the release notes.</p>
Additional Context
<p><em>No response</em></p>
Debug Output
<p><em>No response</em></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">C-bug</span> added by <a href="https://github.com/ahl">@ahl</a> on 2024-01-12 16:56</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a>oxidecomputer/oxide.rs#513</a> on 2024-01-12 16:56</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2024-01-12 18:29</div>
            <div class="timeline-body"><p>This change of behavior is expected but there is something you can do on your side to address it.</p>
<p>In clap, args have two settings that describe whether a value is accepted or not</p>
<ul>
<li><code>num_args</code></li>
<li><code>action</code></li>
</ul>
<p>When an argument doesn&#x27;t take a value, we don&#x27;t return the possible values.</p>
<p>With 4.4.14, we added support for <code>.action(ArgAction::Set).num_args(0)</code> which introduced a discrepancy, <code>action</code> only describe if an arg <em>might</em> take a value.</p>
<p>To do this, we needed to change out &quot;takes value&quot; tracking which is mostly unnoticeable because we auto-fill in properties when parsing.</p>
<p>The problem is that you are looking at the possible values without the auto-fill of properties.  <strong>If you call <code>Command::build</code>, the problem goes away.</strong></p>
<p>See</p>
<pre><code>#!/usr/bin/env nargo
---
[dependencies]
clap = { path = &quot;../clap&quot;, features = [&quot;derive&quot;] }
---

use clap::{CommandFactory, Parser};

#[derive(Parser)]
pub struct Args {
    #[clap(long)]
    ok: bool,
}

fn main() {
    let mut cmd = Args::command();
    cmd.build();
    let values = cmd
        .get_arguments()
        .next()
        .expect(&quot;no arguments&quot;)
        .get_possible_values();
    println!(&quot;{:#?}&quot;, values);
}
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2024-01-12 18:30</div>
            <div class="timeline-body"><p>#2911 covers some of this problem in the API</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ahl">@ahl</a> on 2024-01-12 19:05</div>
            <div class="timeline-body"><p>This is extremely helpful. Thanks very much. Feel free to close this, or leave it open if there&#x27;s some work item such as updating the release notes that might be relevant.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a>oxidecomputer/oxide.rs#519</a> on 2024-01-12 19:20</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/epage">@epage</a> on 2024-01-12 19:34</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 20:00:03 UTC
    </footer>
</body>
</html>
