<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Some clap v3.x Subcommand derives cause clippy errors since Rust 1.69.0 - clap-rs/clap #4857</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Some clap v3.x Subcommand derives cause clippy errors since Rust 1.69.0</h1>

    <div class="meta">
        <span class="state state-closed">Closed</span>
        <a href="https://github.com/clap-rs/clap/issues/4857">#4857</a>
        opened by <a href="https://github.com/hds">@hds</a>
        on 2023-04-25 13:35
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/hds">@hds</a> on 2023-04-25 13:35</div>
            <div class="timeline-body"><h3>Please complete the following tasks</h3>
<ul>
<li>[X] I have searched the <a href="https://github.com/clap-rs/clap/discussions">discussions</a></li>
<li>[X] I have searched the <a href="https://github.com/clap-rs/clap/issues">open</a> and <a href="https://github.com/clap-rs/clap/issues?q=is%3Aissue+label%3AS-wont-fix+is%3Aclosed">rejected</a> issues</li>
</ul>
<h3>Rust Version</h3>
<p>rustc 1.69.0 (84c898d65 2023-04-16)</p>
<h3>Clap Version</h3>
<p>clap 3.2.23, clap_derive 3.2.18</p>
<h3>Minimal reproducible code</h3>
<pre><code class="language-rust">#[derive(clap::Subcommand)]
enum Command {
    One,
}

fn main() {}
</code></pre>
<h3>Steps to reproduce the bug with the above code</h3>
<p>Run clippy with defaults:</p>
<pre><code class="language-sh">cargo clippy
</code></pre>
<h3>Actual Behaviour</h3>
<p>This results in the following error in clippy.</p>
<pre><code>error: this looks like you are trying to swap `__clap_subcommand` and `clap::Subcommand`
 --&gt; src/main.rs:1:10
  |
1 | #[derive(clap::Subcommand)]
  |          ^^^^^^^^^^^^^^^^
  |
  = note: or maybe you should use `std::mem::replace`?
  = help: for further information visit https://rust-lang.github.io/rust-clippy/master/index.html#almost_swapped
note: the lint level is defined here
 --&gt; src/main.rs:1:10
  |
1 | #[derive(clap::Subcommand)]
  |          ^^^^^^^^^^^^^^^^
  = note: `#[deny(clippy::almost_swapped)]` implied by `#[deny(clippy::correctness)]`
  = note: this error originates in the derive macro `clap::Subcommand` (in Nightly builds, run with -Z macro-backtrace for more info)

error: could not compile `clap-deny-correctness` due to previous error
</code></pre>
<h3>Expected Behaviour</h3>
<p>The clippy error is problematic because the attribute that specifies <code>deny</code> is inside the macro itself. That means that as a user of Clap, I'm not able to override the deny.</p>
<p>Specifically this attribute:</p>
<pre><code class="language-rust">#[deny(clippy::correctness)]
</code></pre>
<p>Which is present in 7 specific places in <code>clap_derive</code>.</p>
<h3>Additional Context</h3>
<p>For Clap v4.x, these attributes were already removed in #4739.</p>
<p>Doing the same in the <code>v3-master</code> branch is probably sufficient</p>
<h3>Debug Output</h3>
<p><em>No response</em></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">C-bug</span> added by @hds on 2023-04-25 13:35</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">E-easy</span> added by @epage on 2023-04-25 13:41</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">A-derive</span> added by @epage on 2023-04-25 13:41</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2023-04-25 13:41</div>
            <div class="timeline-body"><p>I am fine with someone fixing this in v3-master.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/4858.html">clap-rs/clap#4858</a> on 2023-04-25 13:44</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../near/nearcore/pulls/8937.html">near/nearcore#8937</a> on 2023-04-25 14:34</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/guswynn">@guswynn</a> on 2023-04-26 23:40</div>
            <div class="timeline-body"><p>@epage Can we <code>#[allow(almost_swapped)]</code> in v3 instead of just removing the deny clause? It's quite onerous to allow these warnings, as annotating the struct/enum with <code>#[allow(clippy::almost_swapped)]</code> doesn't work, you have to use a <code>#![allow(clippy::almost_swapped)]</code> at the module level. If one wants to limit the scope of this allow, they have to introduce a new submodule for all their clap-derived types.</p>
<p>I'm willing to make the pr to do this!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../MaterializeInc/materialize/pulls/18992.html">MaterializeInc/materialize#18992</a> on 2023-04-26 23:42</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2023-04-27 00:38</div>
            <div class="timeline-body"><p>I will say that the idea is to match clap v4.  We should treat anything in v3 as backports.  I should have looked more closely to confirm that.  I would be open to a PR if it makes things more aligned with v4.  If someone wants something that is not in v4, we should put it in v4 first.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/hds">@hds</a> on 2023-04-27 08:42</div>
            <div class="timeline-body"><p>Adding <code>#![allow(clippy::almost_swapped)]</code> was already done in v4 (in #4735). I didn't include it in #4858 for the sake of keeping it as small as possible. If @epage is happy for this to also be backported, then I can create the PR.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2023-04-27 14:09</div>
            <div class="timeline-body"><p>I would be fine with that</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/guswynn">@guswynn</a> on 2023-04-27 14:40</div>
            <div class="timeline-body"><p>Thanks for following up here @hds !</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../spinframework/spin/pulls/1426.html">spinframework/spin#1426</a> on 2023-04-27 14:55</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/4866.html">clap-rs/clap#4866</a> on 2023-04-27 21:12</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/hds">@hds</a> on 2023-04-27 21:26</div>
            <div class="timeline-body"><p>I've backported the v4 change #4735 to <code>v3-master</code>, now available in #4866.</p>
<p>The same docs test is failing that failed in the previous PR on that branch.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2023-06-14 13:37</div>
            <div class="timeline-body"><p>I believe this is now resolved, so I'm going to close this.  If there is something specific to this issue that still isn't resolved, let us know!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @epage on 2023-06-14 13:37</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:35:09 UTC
    </footer>
</body>
</html>
