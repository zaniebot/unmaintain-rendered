<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>#[clap(flatten, next_help_heading)] affects adjacent fields - clap-rs/clap #4957</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>#[clap(flatten, next_help_heading)] affects adjacent fields</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/clap-rs/clap/issues/4957">#4957</a>
        opened by <a href="https://github.com/fsandhei">@fsandhei</a>
        on 2023-06-08 07:13
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/fsandhei">@fsandhei</a> on 2023-06-08 07:13</div>
            <div class="timeline-body"><h3>Please complete the following tasks</h3>
<ul>
<li>[X] I have searched the <a href="https://github.com/clap-rs/clap/discussions">discussions</a></li>
<li>[X] I have searched the <a href="https://github.com/clap-rs/clap/issues">open</a> and <a href="https://github.com/clap-rs/clap/issues?q=is%3Aissue+label%3AS-wont-fix+is%3Aclosed">rejected</a> issues</li>
</ul>
<h3>Rust Version</h3>
<p>rustc 1.69.0 (84c898d65 2023-04-16)</p>
<h3>Clap Version</h3>
<p>clap = { version = &quot;4.2.4&quot;, features = [&quot;derive&quot;] }</p>
<h3>Minimal reproducible code</h3>
<pre><code class="language-rust">use clap::{Args, Parser};

#[derive(Parser)]
struct Cli {
    #[arg(long = &quot;version&quot;)]
    show_version: bool,
    #[clap(flatten, next_help_heading = &quot;Miscellaneous options&quot;)]
    misc: MiscOpts,
    #[clap(long)]
    velocity: u16,
}

#[derive(Args)]
struct MiscOpts {
    #[arg(long)]
    pressure: u16,
    #[arg(long)]
    altitude: u16,
}

fn main() {
    let _cli = Cli::parse();
}
</code></pre>
<h3>Steps to reproduce the bug with the above code</h3>
<pre><code class="language-rust">cargo run -- -h
</code></pre>
<h3>Actual Behaviour</h3>
<p>When using <code>next_help_heading</code> with <code>flatten</code> on a struct, it seems that the fields below that field will also be enveloped under the same help heading. This does not seem right.</p>
<p><img src="https://github.com/clap-rs/clap/assets/25849957/190b1eac-51e2-44d6-8b66-42ec11786f1a" alt="image" /></p>
<h3>Expected Behaviour</h3>
<p>I would expect that clap would recognize that the fields that are declared under the flattened struct are the only fields that should be enveloped by that helper heading, not fields not related to it:</p>
<pre><code class="language-rust">frsa@frsa-linux:~/dev/github/clap-flatten-test$ cargo run -- -h
   Compiling clap-flatten-test v0.1.0 (/home/frsa/dev/github/clap-flatten-test)
    Finished dev [unoptimized + debuginfo] target(s) in 0.76s
     Running `target/debug/clap-flatten-test -h`
Usage: clap-flatten-test --pressure &lt;PRESSURE&gt; --altitude &lt;ALTITUDE&gt; --velocity &lt;VELOCITY&gt;

Options:
      --version
  -h, --help     Print help

Miscellaneous options:
      --pressure &lt;PRESSURE&gt;
      --altitude &lt;ALTITUDE&gt;

      --velocity &lt;VELOCITY&gt;
</code></pre>
<p>I don't know how much this makes sense to do, but it does seem a bit misleading that fields not under <code>MiscOpts</code> in this context appears to be represented under &quot;Miscellaneous options&quot;. This can be &quot;circumvented&quot; by declaring <code>velocity</code> before <code>misc</code>.</p>
<h3>Additional Context</h3>
<p><em>No response</em></p>
<h3>Debug Output</h3>
<pre><code class="language-rust">[clap_builder::builder::command]Command::_do_parse
[clap_builder::builder::command]Command::_build: name=&quot;clap-flatten-test&quot;
[clap_builder::builder::command]Command::_propagate:clap-flatten-test
[clap_builder::builder::command]Command::_check_help_and_version:clap-flatten-test expand_help_tree=false
[clap_builder::builder::command]Command::long_help_exists
[clap_builder::builder::command]Command::_check_help_and_version: Building default --help
[clap_builder::builder::command]Command::_propagate_global_args:clap-flatten-test
[clap_builder::builder::debug_asserts]Command::_debug_asserts
[clap_builder::builder::debug_asserts]Arg::_debug_asserts:show_version
[clap_builder::builder::debug_asserts]Arg::_debug_asserts:pressure
[clap_builder::builder::debug_asserts]Arg::_debug_asserts:altitude
[clap_builder::builder::debug_asserts]Arg::_debug_asserts:velocity
[clap_builder::builder::debug_asserts]Arg::_debug_asserts:help
[clap_builder::builder::debug_asserts]Command::_verify_positionals
[clap_builder::parser::parser]Parser::get_matches_with
[clap_builder::parser::parser]Parser::get_matches_with: Begin parsing '&quot;-h&quot;'
[clap_builder::parser::parser]Parser::possible_subcommand: arg=Ok(&quot;-h&quot;)
[clap_builder::parser::parser]Parser::get_matches_with: sc=None
[clap_builder::parser::parser]Parser::parse_short_arg: short_arg=ShortFlags { inner: &quot;h&quot;, utf8_prefix: CharIndices { front_offset: 0, iter: Chars(['h']) }, invalid_suffix: None }
[clap_builder::parser::parser]Parser::parse_short_arg:iter:h
[clap_builder::parser::parser]Parser::parse_short_arg:iter:h: Found valid opt or flag
[clap_builder::parser::parser]Parser::react action=Help, identifier=Some(Short), source=CommandLine
[clap_builder::parser::parser]Help: use_long=false
[clap_builder::builder::command]Command::write_help_err: clap-flatten-test, use_long=false
[  clap_builder::output::help]write_help
[clap_builder::output::help_template]HelpTemplate::new cmd=clap-flatten-test, use_long=false
[clap_builder::output::help_template]should_show_arg: use_long=false, arg=show_version
[clap_builder::output::help_template]HelpTemplate::write_templated_help
[clap_builder::output::help_template]HelpTemplate::write_before_help
[ clap_builder::output::usage]Usage::create_usage_no_title
[ clap_builder::output::usage]Usage::create_help_usage; incl_reqs=true
[ clap_builder::output::usage]Usage::needs_options_tag
[ clap_builder::output::usage]Usage::needs_options_tag:iter: f=show_version
[ clap_builder::output::usage]Usage::needs_options_tag:iter Option is built-in
[ clap_builder::output::usage]Usage::needs_options_tag:iter: f=pressure
[ clap_builder::output::usage]Usage::needs_options_tag:iter Option is required
[ clap_builder::output::usage]Usage::needs_options_tag:iter: f=altitude
[ clap_builder::output::usage]Usage::needs_options_tag:iter Option is required
[ clap_builder::output::usage]Usage::needs_options_tag:iter: f=velocity
[ clap_builder::output::usage]Usage::needs_options_tag:iter Option is required
[ clap_builder::output::usage]Usage::needs_options_tag:iter: f=help
[ clap_builder::output::usage]Usage::needs_options_tag:iter Option is built-in
[ clap_builder::output::usage]Usage::needs_options_tag: [OPTIONS] not required
[ clap_builder::output::usage]Usage::get_args: incls=[]
[ clap_builder::output::usage]Usage::get_args: unrolled_reqs=[&quot;pressure&quot;, &quot;altitude&quot;, &quot;velocity&quot;]
[ clap_builder::output::usage]Usage::get_args: ret_val=[StyledStr(&quot;\u{1b}[1m--pressure\u{1b}[0m &lt;PRESSURE&gt;&quot;), StyledStr(&quot;\u{1b}[1m--altitude\u{1b}[0m &lt;ALTITUDE&gt;&quot;), StyledStr(&quot;\u{1b}[1m--velocity\u{1b}[0m &lt;VELOCITY&gt;&quot;)]
[ clap_builder::output::usage]Usage::create_help_usage: usage=clap-flatten-test --pressure &lt;PRESSURE&gt; --altitude &lt;ALTITUDE&gt; --velocity &lt;VELOCITY&gt;
[clap_builder::output::help_template]HelpTemplate::write_all_args
[clap_builder::output::help_template]should_show_arg: use_long=false, arg=show_version
[clap_builder::output::help_template]should_show_arg: use_long=false, arg=help
[clap_builder::output::help_template]HelpTemplate::write_args Options
[clap_builder::output::help_template]should_show_arg: use_long=false, arg=show_version
[clap_builder::output::help_template]HelpTemplate::write_args: arg=&quot;show_version&quot; longest=9
[clap_builder::output::help_template]should_show_arg: use_long=false, arg=help
[clap_builder::output::help_template]HelpTemplate::write_args: arg=&quot;help&quot; longest=9
[clap_builder::output::help_template]should_show_arg: use_long=false, arg=show_version
[clap_builder::output::help_template]HelpTemplate::spec_vals: a=--version
[clap_builder::output::help_template]should_show_arg: use_long=false, arg=help
[clap_builder::output::help_template]HelpTemplate::spec_vals: a=--help
[clap_builder::output::help_template]HelpTemplate::spec_vals: a=--version
[clap_builder::output::help_template]HelpTemplate::short
[clap_builder::output::help_template]HelpTemplate::long
[clap_builder::output::help_template]HelpTemplate::align_to_about: arg=show_version, next_line_help=false, longest=9
[clap_builder::output::help_template]HelpTemplate::align_to_about: positional=false arg_len=9, spaces=2
[clap_builder::output::help_template]HelpTemplate::help
[clap_builder::output::help_template]HelpTemplate::help: help_width=17, spaces=0, avail=83
[clap_builder::output::help_template]HelpTemplate::spec_vals: a=--help
[clap_builder::output::help_template]HelpTemplate::short
[clap_builder::output::help_template]HelpTemplate::long
[clap_builder::output::help_template]HelpTemplate::align_to_about: arg=help, next_line_help=false, longest=9
[clap_builder::output::help_template]HelpTemplate::align_to_about: positional=false arg_len=6, spaces=5
[clap_builder::output::help_template]HelpTemplate::help
[clap_builder::output::help_template]HelpTemplate::help: help_width=17, spaces=10, avail=83
[clap_builder::output::help_template]should_show_arg: use_long=false, arg=pressure
[clap_builder::output::help_template]should_show_arg: use_long=false, arg=altitude
[clap_builder::output::help_template]should_show_arg: use_long=false, arg=velocity
[clap_builder::output::help_template]HelpTemplate::write_args Miscellaneous options
[clap_builder::output::help_template]should_show_arg: use_long=false, arg=pressure
[clap_builder::output::help_template]HelpTemplate::write_args: arg=&quot;pressure&quot; longest=21
[clap_builder::output::help_template]should_show_arg: use_long=false, arg=altitude
[clap_builder::output::help_template]HelpTemplate::write_args: arg=&quot;altitude&quot; longest=21
[clap_builder::output::help_template]should_show_arg: use_long=false, arg=velocity
[clap_builder::output::help_template]HelpTemplate::write_args: arg=&quot;velocity&quot; longest=21
[clap_builder::output::help_template]should_show_arg: use_long=false, arg=pressure
[clap_builder::output::help_template]HelpTemplate::spec_vals: a=--pressure &lt;PRESSURE&gt;
[clap_builder::output::help_template]should_show_arg: use_long=false, arg=altitude
[clap_builder::output::help_template]HelpTemplate::spec_vals: a=--altitude &lt;ALTITUDE&gt;
[clap_builder::output::help_template]should_show_arg: use_long=false, arg=velocity
[clap_builder::output::help_template]HelpTemplate::spec_vals: a=--velocity &lt;VELOCITY&gt;
[clap_builder::output::help_template]HelpTemplate::spec_vals: a=--pressure &lt;PRESSURE&gt;
[clap_builder::output::help_template]HelpTemplate::short
[clap_builder::output::help_template]HelpTemplate::long
[clap_builder::output::help_template]HelpTemplate::align_to_about: arg=pressure, next_line_help=false, longest=21
[clap_builder::output::help_template]HelpTemplate::align_to_about: positional=false arg_len=21, spaces=2
[clap_builder::output::help_template]HelpTemplate::help
[clap_builder::output::help_template]HelpTemplate::help: help_width=29, spaces=0, avail=71
[clap_builder::output::help_template]HelpTemplate::spec_vals: a=--altitude &lt;ALTITUDE&gt;
[clap_builder::output::help_template]HelpTemplate::short
[clap_builder::output::help_template]HelpTemplate::long
[clap_builder::output::help_template]HelpTemplate::align_to_about: arg=altitude, next_line_help=false, longest=21
[clap_builder::output::help_template]HelpTemplate::align_to_about: positional=false arg_len=21, spaces=2
[clap_builder::output::help_template]HelpTemplate::help
[clap_builder::output::help_template]HelpTemplate::help: help_width=29, spaces=0, avail=71
[clap_builder::output::help_template]HelpTemplate::spec_vals: a=--velocity &lt;VELOCITY&gt;
[clap_builder::output::help_template]HelpTemplate::short
[clap_builder::output::help_template]HelpTemplate::long
[clap_builder::output::help_template]HelpTemplate::align_to_about: arg=velocity, next_line_help=false, longest=21
[clap_builder::output::help_template]HelpTemplate::align_to_about: positional=false arg_len=21, spaces=2
[clap_builder::output::help_template]HelpTemplate::help
[clap_builder::output::help_template]HelpTemplate::help: help_width=29, spaces=0, avail=71
[clap_builder::output::help_template]HelpTemplate::write_after_help
[clap_builder::builder::command]Command::color: Color setting...
[clap_builder::builder::command]Auto
[clap_builder::builder::command]Command::color: Color setting...
[clap_builder::builder::command]Auto
Usage: clap-flatten-test --pressure &lt;PRESSURE&gt; --altitude &lt;ALTITUDE&gt; --velocity &lt;VELOCITY&gt;

Options:
      --version
  -h, --help     Print help

Miscellaneous options:
      --pressure &lt;PRESSURE&gt;
      --altitude &lt;ALTITUDE&gt;
      --velocity &lt;VELOCITY&gt;
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">C-bug</span> added by @fsandhei on 2023-06-08 07:13</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2023-06-08 09:53</div>
            <div class="timeline-body"><p><code>next_help_heading</code> is a &quot;sticky&quot; value even so far as if you use it inside the flattened struct, it will leak out to the parent struct.  We used to prevent that latter case but pulled it out, see https://github.com/clap-rs/clap/pull/4222/commits/14c6ce0e838ef8d84c896254f02716e9e3c57c50.</p>
<p>Any change of this would be a breaking change and would have to wait until 5.0.</p>
<p>However, with us already having tried stuff in this direction and pulled it out, I'm inclined to say we shouldn't do this.  If there is a reason for us to re-evaluate this, let us know!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @epage on 2023-06-08 09:53</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">A-derive</span> added by @epage on 2023-06-08 09:53</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">S-wont-fix</span> added by @epage on 2023-06-08 09:53</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 01:35:25 UTC
    </footer>
</body>
</html>
