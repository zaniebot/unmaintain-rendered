<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Compile regression with nested subcommands in 3.0.0-beta.4 - clap-rs/clap #2754</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Compile regression with nested subcommands in 3.0.0-beta.4</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/clap-rs/clap/issues/2754">#2754</a>
        opened by <a href="https://github.com/asomers">@asomers</a>
        on 2021-09-05 01:11
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/asomers">@asomers</a></div>
            <div class="timeline-body"><h3>Please complete the following tasks</h3>
<ul>
<li>[X] I have searched the <a href="https://github.com/clap-rs/clap/discussions">discussions</a></li>
<li>[X] I have searched the existing issues</li>
</ul>
<h3>Rust Version</h3>
<p>rustc 1.56.0-nightly (2f662b140 2021-08-29) or rustc 1.54.0 (a178d0322 2021-07-26)</p>
<h3>Clap Version</h3>
<p>3.0.0-beta.4</p>
<h3>Minimal reproducible code</h3>
<p>Cargo.toml:</p>
<pre><code class="language-toml">[package]
name = &quot;clap-subsubcommand&quot;
version = &quot;0.1.0&quot;
edition = &quot;2018&quot;

[dependencies]
clap_derive = &quot;=3.0.0-beta.4&quot;
clap = &quot;=3.0.0-beta.4&quot;
</code></pre>
<p>src/main.rs:</p>
<pre><code class="language-rust">use clap::*;

#[derive(Clap, Clone, Debug)]
struct First {
    #[clap(short, long)]
    verbose: bool
}

// Fails identically whether we derive Clap or Subcommand
#[derive(Clap, Clone, Debug)]
enum MySubSubCommand {
    First(First),
    Second
}

// Fails identically whether we derive Clap or Subcommand
#[derive(Clap, Clone, Debug)]
enum MySubCommand {
    SubSub(MySubSubCommand)
}

#[derive(Clap, Clone, Debug)]
struct MyApp {
    #[clap(subcommand)]
    cmd: MySubCommand
}

fn main() {
    MyApp::parse();
}
</code></pre>
<h3>Steps to reproduce the bug with the above code</h3>
<p><code>cargo check</code></p>
<h3>Actual Behaviour</h3>
<p>With Clap 3.0.0-beta.4 it fails like this:</p>
<pre><code>    Checking clap-subsubcommand v0.1.0 (/usr/home/somers/src/rust/clap-subsubcommand)
error[E0277]: the trait bound `MySubSubCommand: clap::Args` is not satisfied
   --&gt; src/main.rs:19:12
    |
19  |     SubSub(MySubSubCommand)
    |            ^^^^^^^^^^^^^^^ the trait `clap::Args` is not implemented for `MySubSubCommand`
    |
note: required by `augment_args`
   --&gt; /home/somers/.cargo/registry/src/github.com-1ecc6299db9ec823/clap-3.0.0-beta.4/src/derive.rs:213:5
    |
213 |     fn augment_args(app: App&lt;'_&gt;) -&gt; App&lt;'_&gt;;
    |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

error[E0277]: the trait bound `MySubSubCommand: clap::Args` is not satisfied
   --&gt; src/main.rs:19:12
    |
19  |     SubSub(MySubSubCommand)
    |            ^^^^^^^^^^^^^^^ the trait `clap::Args` is not implemented for `MySubSubCommand`
    |
note: required by `augment_args_for_update`
   --&gt; /home/somers/.cargo/registry/src/github.com-1ecc6299db9ec823/clap-3.0.0-beta.4/src/derive.rs:219:5
    |
219 |     fn augment_args_for_update(app: App&lt;'_&gt;) -&gt; App&lt;'_&gt;;
    |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

For more information about this error, try `rustc --explain E0277`.
error: could not compile `clap-subsubcommand` due to 2 previous errors
</code></pre>
<h3>Expected Behaviour</h3>
<p>With clap-3.0.0-beta.2, the build passes and the app works as expected.</p>
<h3>Additional Context</h3>
<p><em>No response</em></p>
<h3>Debug Output</h3>
<p>No change in output when using the <code>debug</code> feature.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">T: bug</span> added by @asomers on 2021-09-05 01:11</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @epage by @pksunkara on 2021-09-05 04:22</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/pksunkara">@pksunkara</a> on 2021-09-05 06:08</div>
            <div class="timeline-body"><p>I think your local dependency has not resolved clap derive to beta.4. try deleting target folder and recompiling</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @pksunkara on 2021-09-05 06:08</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/asomers">@asomers</a> on 2021-09-05 13:24</div>
            <div class="timeline-body"><p>@pksunkara No, that's not it.  The crates definitely resolve fine, and Clap works as long as I don't use nested subcommands.  Also, it works if I add <code>#[clap(flatten)]</code> like this:</p>
<pre><code class="language-rust">#[derive(Clap, Clone, Debug)]
enum MySubCommand {
    #[clap(flatten)]
    SubSub(MySubSubCommand)
}
</code></pre>
<p>but the resulting CLI is not what I want when I use flatten.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2021-09-05 14:02</div>
            <div class="timeline-body"><p>With the latest version of clap, you need <code>#[subcommand]</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/asomers">@asomers</a> on 2021-09-05 14:31</div>
            <div class="timeline-body"><p>I used <code>#[subcommand]</code> in structs with subcommands before.  Are you saying that with 3.0.0-beta.4 I need it in enums with subcommands, too?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/pksunkara">@pksunkara</a> on 2021-09-05 14:38</div>
            <div class="timeline-body"><p>Yup.</p>
<p>On Sun, Sep 5, 2021, 20:01 Alan Somers <em><strong>@</strong></em>.***&gt; wrote:</p>
<blockquote>
<p>I used #[subcommand] in structs with subcommands before. Are you saying
that with 3.0.0-beta.4 I need it in enums with subcommands, too?</p>
<p>â€”
You are receiving this because you were mentioned.
Reply to this email directly, view it on GitHub
<a href="https://github.com/clap-rs/clap/issues/2754#issuecomment-913165514">https://github.com/clap-rs/clap/issues/2754#issuecomment-913165514</a>, or
unsubscribe
<a href="https://github.com/notifications/unsubscribe-auth/AABKU3ZS3D4TQC5FSQP5THDUAN5N5ANCNFSM5DN2XVQA">https://github.com/notifications/unsubscribe-auth/AABKU3ZS3D4TQC5FSQP5THDUAN5N5ANCNFSM5DN2XVQA</a>
.</p>
</blockquote>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/asomers">@asomers</a> on 2021-09-05 14:44</div>
            <div class="timeline-body"><p>Ok.  Thanks for the help.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2021-09-05 15:13</div>
            <div class="timeline-body"><p>The old trait that was being derived was a bit of a catch-all, providing functions that did nothing but allowed the derive to implicitly allow mixing of types.  We switched it to be more strict, allowing compile time checking.  This meant we can't infer whether a variant is an <code>Args</code> or a <code>Subcommand</code> , so we had to mirror how deriving <code>Args</code> does it.</p>
<p>This also opens us up to allowing an enum to derive <code>Args</code> for creating mutually exclusive arguments,</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:48:03 UTC
    </footer>
</body>
</html>
