<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Context-Aware Multiple Usage from Argument Groups - clap-rs/clap #4191</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Context-Aware Multiple Usage from Argument Groups</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/clap-rs/clap/issues/4191">#4191</a>
        opened by <a href="https://github.com/andersonjwan">@andersonjwan</a>
        on 2022-09-07 19:11
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/andersonjwan">@andersonjwan</a></div>
            <div class="timeline-body"><h3>Please complete the following tasks</h3>
<ul>
<li>[X] I have searched the <a href="https://github.com/clap-rs/clap/discussions">discussions</a></li>
<li>[X] I have searched the <a href="https://github.com/clap-rs/clap/issues">open</a> and <a href="https://github.com/clap-rs/clap/issues?q=is%3Aissue+label%3AS-wont-fix+is%3Aclosed">rejected</a> issues</li>
</ul>
<h3>Clap Version</h3>
<p>3.2.20</p>
<h3>Describe your use case</h3>
<p>Currently, the only method, as far as I am aware, to generate a USAGE section with more than two usage statements from a set of grouped positional arguments is to explicitly pass a string to <code>clap::builder::Command::override_usage</code>.</p>
<p>However, opting-in for this solution disables the useful context-aware capabilities that the library has to offer. For example, if a new set of positional arguments are added, the resulting USAGE section does not reflect these changes without explicitly adjusting the call to <code>override_usage</code>.</p>
<p>To provide a small working example, a small demonstration of the <code>grep</code> tool usage without overriding the usage section would be as follows:</p>
<pre><code class="language-rust">fn main() {
    Command::new(&quot;jrep&quot;)
        .arg(
            Arg::new(&quot;BASIC&quot;)
                .required(true)
                .value_name(&quot;PATTERNS&quot;)
        )
        .arg(
            Arg::new(&quot;EXTENDED&quot;)
                .required(true)
                .long(&quot;regexp&quot;)
                .short('e')
                .value_name(&quot;PATTERNS&quot;),
        )
        .arg(
            Arg::new(&quot;PATTERN FILE&quot;)
                .required(true),
                .long(&quot;file&quot;)
                .short('f')
                .takes_value(true),
        )
        .group(
            ArgGroup::new(&quot;pattern-input&quot;)
                .arg(&quot;BASIC&quot;)
                .arg(&quot;EXTENDED&quot;)
                .arg(&quot;PATTERN FILE&quot;)
                .required(true),
        )
        .arg(
            Arg::new(&quot;FILE&quot;)
                .required(true)
                .takes_value(true)
                .multiple_values(true),
        )
        .arg(
            Arg::new(&quot;count&quot;)
                .long(&quot;count&quot;)
                .short('c')
                .action(ArgAction::SetTrue),
        )
        .get_matches();
}
</code></pre>
<p>This results in the following USAGE section:</p>
<pre><code class="language-bash">USAGE:
    jrep [OPTIONS] &lt;PATTERNS|--regexp &lt;PATTERNS&gt;|--file &lt;PATTERN FILE&gt;&gt; &lt;FILE&gt;...
</code></pre>
<p>However, the desirable output, only acquirable by overriding the usage string and losing context-aware generation is:</p>
<pre><code class="language-bash">USAGE:
    jrep [OPTIONS] &lt;PATTERN&gt; &lt;FILE&gt;
    jrep [OPTIONS] --regexp &lt;PATTERNS&gt; &lt;FILE&gt;
    jrep [OPTIONS] --file &lt;PATTERN FILE&gt; &lt;FILE&gt;
</code></pre>
<h3>Describe the solution you'd like</h3>
<p>As a result, grouped arguments (especially positional), should be given the option to generate multiple USAGE statements for every possible combination (i.e., perform the cartesian product over each <code>ArgGroup</code>).</p>
<p>The interface for this option could look as follows:</p>
<pre><code class="language-rust">fn main() {
    Command::new(&quot;jrep&quot;)
        .display_all_possible_usages(true)
        ...
}
</code></pre>
<p>Which, would generate the following USAGE section (assuming the same arguments as defined in the previous section):</p>
<pre><code class="language-bash">USAGE:
    jrep [OPTIONS] &lt;PATTERN&gt; &lt;FILE&gt;
    jrep [OPTIONS] --regexp &lt;PATTERNS&gt; &lt;FILE&gt;
    jrep [OPTIONS] --file &lt;PATTERN FILE&gt; &lt;FILE&gt;
</code></pre>
<h3>Alternatives, if applicable</h3>
<p>The only alternative to this is to use the <code>clap::build::Command::override_usage</code> which, as stated above, inhibits the context-aware generation of the USAGE section.</p>
<h3>Additional Context</h3>
<p>From my own search, there are only two instances where multiple usage statements are discussed:</p>
<ol>
<li>#3413</li>
</ol>
<p>The issue above only discusses making the USAGE string more intuitive to write and does not discuss the matter of deriving a USAGE section from the context-aware <code>ArgGroup</code>s.</p>
<ol start="2">
<li>#2103</li>
</ol>
<p>This discussion is over two years old. However, I would argue that the use-case and need for the feature are still relevant and possibly more feasible with the more recent versions.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">C-enhancement</span> added by @andersonjwan on 2022-09-07 19:11</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">A-help</span> added by @epage on 2022-09-07 19:21</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">S-waiting-on-design</span> added by @epage on 2022-09-07 19:21</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2022-09-07 19:29</div>
            <div class="timeline-body"><blockquote>
<p>As a result, grouped arguments (especially positional), should be given the option to generate multiple USAGE statements for every possible combination (i.e., perform the cartesian product over each ArgGroup).</p>
</blockquote>
<p>Rather than applying a cartesian product across every <code>ArgGroup</code>, I think it'd work better if instead we had <code>group.multiple_usage(true)</code> (ie you opt-in on a per-group basis.   We'll need to make sure that we render the arg in its dedicated line rather than being elided in <code>[OPTIONS]</code> (if its optional).</p>
<p>We'll also want to look at several clap users today that use groups to verify any assumptions of how well this would work and if any tweaks might be needed.</p>
<p>A challenge for this will be balancing a usability improvement like this with our efforts to reduce compile time (https://github.com/clap-rs/clap/issues/2037) and binary size (https://github.com/clap-rs/clap/issues/1365) which are top complaints of clap today.</p>
<blockquote>
<p>Currently, the only method, as far as I am aware, to generate a USAGE section with more than two usage statements from a set of grouped positional arguments is to explicitly pass a string to clap::builder::Command::override_usage.</p>
</blockquote>
<p>clap will automatically generate two usage statements if <code>args_conflicts_with_subcommands</code> is used (<a href="https://github.com/clap-rs/clap/blob/master/tests/builder/help.rs#L1104">example</a>).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/andersonjwan">@andersonjwan</a> on 2022-09-07 20:00</div>
            <div class="timeline-body"><blockquote>
<p>Rather than applying a cartesian product across every <code>ArgGroup</code>, I think it'd work better if instead we had <code>group.multiple_usage(true)</code> (ie you opt-in on a per-group basis. We'll need to make sure that we render the arg in its dedicated line rather than being elided in <code>[OPTIONS]</code> (if its optional).</p>
</blockquote>
<p>Agreed. Having per-<code>ArgGroup</code> control over generating additional usage statements is a more concise and minimal assumption-based approach for this feature.</p>
<p>I would say, it may be possible to be even more granular and supply a per-argument within a group usage generation option. For example, the method <code>ArgGroup::usage(mut self, arg_id)</code> to specify which arguments generate separate usage statements. Of course, the breaking change would be to modify <code>ArgGroup::arg(..., usage: bool)</code> to specify during addition of a new argument.</p>
<blockquote>
<p>We'll also want to look at several clap users today that use groups to verify any assumptions of how well this would work and if any tweaks might be needed.</p>
</blockquote>
<p>I can perform a preliminary search of this and report back some results here.</p>
<blockquote>
<p>A challenge for this will be balancing a usability improvement like this with our efforts to reduce compile time (https://github.com/clap-rs/clap/issues/2037) and binary size (https://github.com/clap-rs/clap/issues/1365) which are top complaints of clap today.</p>
</blockquote>
<p>Noted. Extending the interface of the <code>ArgGroup</code> struct to support this option is trivial. However, to generate the actual USAGE section is a bit more work. Do you mind pointing me in the direction where the USAGE section gets generated? I would like to have a look and possibly, if feasible, to provide this feature. Else, if someone is better suited, such as yourself, by all means!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2022-09-07 20:17</div>
            <div class="timeline-body"><blockquote>
<p>Do you mind pointing me in the direction where the USAGE section gets generated?</p>
</blockquote>
<p>https://github.com/clap-rs/clap/blob/master/src/output/usage.rs</p>
<p>Tests would either go in</p>
<ul>
<li>https://github.com/clap-rs/clap/blob/master/tests/builder/groups.rs</li>
<li>https://github.com/clap-rs/clap/blob/master/tests/builder/help.rs</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/4132.html">clap-rs/clap#4132</a> on 2023-07-13 12:43</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/5625.html">clap-rs/clap#5625</a> on 2025-02-27 16:48</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../rust-lang/cargo/issues/15363.html">rust-lang/cargo#15363</a> on 2025-03-28 19:43</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2025-12-19 16:01</div>
            <div class="timeline-body"><p>As pointed out in #6199, we should also support <code>exclusive</code> for this</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:48:45 UTC
    </footer>
</body>
</html>
