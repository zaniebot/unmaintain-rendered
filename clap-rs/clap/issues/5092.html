<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>#[command(flatten)] on optional field makes it required - clap-rs/clap #5092</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>#[command(flatten)] on optional field makes it required</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/clap-rs/clap/issues/5092">#5092</a>
        opened by <a href="https://github.com/smessmer">@smessmer</a>
        on 2023-08-27 19:10
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/smessmer">@smessmer</a> on 2023-08-27 19:10</div>
            <div class="timeline-body"><h3>Please complete the following tasks</h3>
<ul>
<li>[X] I have searched the <a href="https://github.com/clap-rs/clap/discussions">discussions</a></li>
<li>[X] I have searched the <a href="https://github.com/clap-rs/clap/issues">open</a> and <a href="https://github.com/clap-rs/clap/issues?q=is%3Aissue+label%3AS-wont-fix+is%3Aclosed">rejected</a> issues</li>
</ul>
<h3>Rust Version</h3>
<p>1.72</p>
<h3>Clap Version</h3>
<p>4.3.4</p>
<h3>Minimal reproducible code</h3>
<pre><code class="language-rust">use clap::{Args, Parser};

fn main() {
    MainArgs::parse();
}

#[derive(Parser, Debug)]
pub struct MainArgs {
    #[arg(short = 'V', long)]
    pub version: bool,

    #[command(flatten)]
    pub specific_args: Option&lt;SpecificArgs&gt;,
}

#[derive(Args, Debug)]
pub struct SpecificArgs {
    pub positional: String,
}
</code></pre>
<h3>Steps to reproduce the bug with the above code</h3>
<pre><code>cargo r -- --version
</code></pre>
<h3>Actual Behaviour</h3>
<pre><code>error: the following required arguments were not provided:
  &lt;POSITIONAL&gt;

Usage: test-executable --version &lt;POSITIONAL&gt;

For more information, try '--help'.
</code></pre>
<h3>Expected Behaviour</h3>
<p>No error because the <code>SpecificArgs</code> is optional.</p>
<h3>Additional Context</h3>
<p>I want to use this to have a top level <code>Parser</code> with a few global args (e.g. <code>--version</code> but also some others), and I want to reuse this across different CLI tools, each with their own <code>ConcreteArgs</code>. The <code>ConcreteArgs</code> are usually written as mandatory in their corresponding <code>#[derive(Args)]</code> parser, but they should only be mandatory if none of the global flags are present. To do this, I made <code>SpecificArgs</code> optional in the <code>#[command(flatten)]</code> but that doesn't seem to have the intended effect.</p>
<p>Similar discussion: https://github.com/clap-rs/clap/discussions/4954</p>
<h3>Debug Output</h3>
<p><em>No response</em></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">C-bug</span> added by @smessmer on 2023-08-27 19:10</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">M-breaking-change</span> added by @epage on 2023-08-28 13:53</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">A-validators</span> added by @epage on 2023-08-28 13:53</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">S-waiting-on-design</span> added by @epage on 2023-08-28 13:53</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2023-08-28 13:57</div>
            <div class="timeline-body"><p>We have a discrepancy in how we treat <code>Option</code> between <code>Arg</code> (required, no required) and <code>ArgGroup</code> (no-op, track whether present).</p>
<p>A lot of this depends on how people are using an <code>ArgGroup</code></p>
<ul>
<li>Composing structs: lack of <code>Option</code> shouldn't mean anything</li>
<li>Require or don't require an <code>ArgGroup</code></li>
<li>Override required Args within an <code>ArgGroup</code> (what this issue wants</li>
</ul>
<p>Can we pick a one-size-fits all option?  If not, how do we allow variability of this?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/jannschu">@jannschu</a> on 2023-09-02 20:13</div>
            <div class="timeline-body"><p>Is there a workaround?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2023-09-03 01:30</div>
            <div class="timeline-body"><p>The way to workaround this heavily depends on your use case.  If you want one argument to be present when the group is, you can use <a href="https://docs.rs/clap/latest/clap/struct.ArgGroup.html#method.requires">ArgGroup::requires</a>.</p>
<p>As an example, let's take the reproduction case and change it to use that:</p>
<pre><code class="language-rust">use clap::{Args, Parser};

fn main() {
    MainArgs::parse();
}

#[derive(Parser, Debug)]
pub struct MainArgs {
    #[arg(short = 'V', long)]
    pub version: bool,

    #[command(flatten)]
    pub specific_args: Option&lt;SpecificArgs&gt;,
}

#[derive(Args, Debug)]
#[group(requires = &quot;positional&quot;)]
pub struct SpecificArgs {
    #[arg(required = false)]
    pub positional: String,
}
</code></pre>
<p><code>SpecificArgs</code> will only be instantiated if the group is present and if the group is present then <code>positional</code> must be present as well, so you can skip using <code>Option</code> for it and just override the default <code>required = true</code> with <code>required = false</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../Analog-Labs/timechain/pulls/518.html">Analog-Labs/timechain#518</a> on 2023-09-22 15:35</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../mullvad/mullvadvpn-app/pulls/5366.html">mullvad/mullvadvpn-app#5366</a> on 2023-10-26 09:05</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/5292.html">clap-rs/clap#5292</a> on 2024-01-08 21:27</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../cowprotocol/services/pulls/2909.html">cowprotocol/services#2909</a> on 2024-08-19 15:43</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/JMLX42">@JMLX42</a> on 2025-01-27 21:59</div>
            <div class="timeline-body"><blockquote>
<p>SpecificArgs will only be instantiated if the group is present and if the group is present then positional must be present as well, so you can skip using Option for it and just override the default required = true with required = false.</p>
</blockquote>
<p>I might be missing something, but there is not much value in flattening a struct with a single field. And the proposal does not scale well with multiple fields.</p>
<p>Here is an example:</p>
<pre><code class="language-rust">#[derive(Debug, Clone, Default, Deserialize, Serialize, clap::Args)]
#[group(conflicts_with = &quot;camera_node&quot;)]
#[group(requires = &quot;x&quot;)]
pub struct CameraCoordinates {
    /// X position of the camera
    #[arg(long, required = false)]
    pub x: f32,
    /// Y position of the camera
    #[arg(long, required = false)]
    pub y: f32,
    /// Z position of the camera
    #[arg(long, required = false)]
    pub z: f32,
    /// X target of the camera
    #[arg(long, required = false)]
    pub target_x: f32,
    /// Y target of the camera
    #[arg(long, required = false)]
    pub target_y: f32,
    /// Z target of the camera
    #[arg(long, required = false)]
    pub target_z: f32,
    /// Z far of the camera
    #[arg(long, required = false, default_value = &quot;1000.0&quot;)]
    pub z_far: f32,
}

#[derive(Parser, Debug, Default, Clone)]
pub struct Args {
    #[clap(flatten)]
    pub camera_coordinates: Option&lt;CameraCoordinates&gt;,
    #[clap(long)]
    pub camera_node: Option&lt;Uuid&lt;GltfLiveNode&gt;&gt;,
}
</code></pre>
<blockquote>
<p>The way to workaround this heavily depends on your use case. If you want one argument to be present when the group is, you can use <a href="https://docs.rs/clap/latest/clap/struct.ArgGroup.html#method.requires">ArgGroup::requires</a>.</p>
</blockquote>
<p>In this case, if <code>--x</code> is present, all the arguments in the group become required.</p>
<pre><code>$ cargo run --target=x86_64-unknown-linux-gnu --target-dir=target/x86_64-unknown-linux-gnu --profile=dev --bin=gltf-live open --gltf 0194a8cb-fc67-70a3-836b-7b900dbeb5f7 --x 10
    Finished `dev` profile [optimized + debuginfo] target(s) in 20.04s
     Running `target/x86_64-unknown-linux-gnu/x86_64-unknown-linux-gnu/debug/gltf-live open --gltf 0194a8cb-fc67-70a3-836b-7b900dbeb5f7 --x 10`
Error: error: The following required argument was not provided: y

Usage: gltf_live_app [OPTIONS] &lt;COMMAND&gt;

For more information, try '--help'.
</code></pre>
<p>Yet, IMHO the code says the exact opposite:</p>
<ul>
<li><code>camera_coordinates: Option&lt;CameraCoordinates&gt;</code> suggests the entire group is optional</li>
<li><code>required = false</code> on all fields of <code>CameraCoordinates</code> suggests all fields of the group are optional</li>
<li><code>requires = &quot;x&quot;</code> suggests only the <code>x</code> field is required when the group is present</li>
</ul>
<p>And yet, all the other fields of <code>CameraCoordinates</code> are treated as required...</p>
<p>Ironically, the behavior is the one I want. But unless I missed something, it's not the expected behavior.</p>
<p>Am I missing something?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/iamjpotts">@iamjpotts</a> on 2025-01-27 23:03</div>
            <div class="timeline-body"><blockquote>
<p>camera_coordinates: Option<CameraCoordinates> suggests the entire group is optional</p>
</blockquote>
<p>I would like to be able to do that, without having to mark <code>required = false</code> on the individual fields or mark <code>requires_all</code> on the group. It would be nice if both of those were respectively derived from a) the fields on <code>FooConfig</code> not being optional, and b) <code>Option&lt;FooConfig&gt;</code>.</p>
<pre><code class="language-rust">#[derive(clap::Parser)]
#[group(requires_all = [&quot;bar&quot;, &quot;qux&quot;, &quot;baz&quot;])]
pub struct FooConfig {
    #[arg(env, required = false)]
    pub bar: String,

    #[arg(env, required = false)]
    pub qux: String,

    #[arg(env, required = false)]
    pub baz: String
}
</code></pre>
<p>The single field variant is also useful if FooConfig is used elsewhere in the code base either as a type wrapper or on other cli tools with subsets or different combinations of config from each other.</p>
<pre><code class="language-rust">#[derive(Parser, Debug, Default, Clone)]
pub struct CliEnv {
    #[clap(flatten)]
    pub foo: Option&lt;FooConfig&gt;,

    pub abc: String,
}

#[derive(Parser, Debug, Default, Clone)]
pub struct SomeOtherCliEnv {
    #[clap(flatten)]
    pub foo: Option&lt;FooConfig&gt;,

    pub xyz: String,
}

</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../scroll-tech/rollup-node/pulls/65.html">scroll-tech/rollup-node#65</a> on 2025-04-23 17:16</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 01:35:29 UTC
    </footer>
</body>
</html>
