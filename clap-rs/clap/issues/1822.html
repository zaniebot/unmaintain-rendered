<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>zsh: optional flag with takes_value breaks completions - clap-rs/clap #1822</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>zsh: optional flag with takes_value breaks completions</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/clap-rs/clap/issues/1822">#1822</a>
        opened by <a href="https://github.com/kpcyrd">@kpcyrd</a>
        on 2020-04-14 14:34
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/kpcyrd">@kpcyrd</a></div>
            <div class="timeline-body">Make sure you completed the following tasks
<ul>
<li>[X] Searched the <a href="https://github.com/clap-rs/clap/discussions">discussions</a></li>
<li>[X] Searched the closes issues</li>
</ul>
Code
<pre><code>use std::io::stdout;
use clap::{App, Arg, SubCommand, Shell};

fn app() -&gt; App&lt;&#x27;static, &#x27;static&gt; {
    App::new(&quot;completion-bug&quot;)
        .arg(
            Arg::with_name(&quot;foo&quot;)
                .short(&quot;f&quot;)
                .long(&quot;foo&quot;)
                .takes_value(true)
        )
        .subcommand(SubCommand::with_name(&quot;zsh&quot;))
        .subcommand(SubCommand::with_name(&quot;bash&quot;))
}

fn main() {
    let args = app().get_matches();
    eprintln!(&quot;{:?}&quot;, args);

    let shell = match args.subcommand() {
        (&quot;zsh&quot;, _) =&gt; Shell::Zsh,
        (&quot;bash&quot;, _) =&gt; Shell::Bash,
        _ =&gt; unreachable!(),
    };

    app().gen_completions_to(&quot;completion-bug&quot;, shell, &amp;mut stdout());
}
</code></pre>
Steps to reproduce the issue
<pre><code>cargo run -- zsh &gt; ~/.zsh_completions/_completion-bug # you might need to tweak this for your setup
zsh

# this works
completion-bug z&lt;tab&gt;
# this doesn&#x27;t
completion-bug -f x z&lt;tab&gt;
# this does something unexpected
completion-bug -f z&lt;tab&gt;
</code></pre>
Version
<ul>
<li><strong>Rust</strong>: 1.42.0</li>
<li><strong>Clap</strong>: 2.33.0</li>
</ul>
Actual Behavior Summary
<p><code>completion-bug -f x z&lt;tab&gt;</code> doesn&#x27;t complete anything.</p>
<p>This affects https://github.com/kpcyrd/sn0int because it has a lot of nested subcommands but it&#x27;s very common to start the command with <code>sn0int -w foo</code> which breaks the completions for everything afterwards.</p>
<p>The bash completions work correctly.</p>
Expected Behavior Summary
<p><code>completion-bug -f x z&lt;tab&gt;</code> should complete to <code>completion-bug -f x zsh</code></p>
Additional context
<p>This bug was originally reported as <a href="https://github.com/TeXitoi/structopt/issues/369">TeXitoi/structopt#369</a> and then ported over to pure clap. The completions generated by the structopt program and the clap program are identical.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">T: bug</span> added by <a href="https://github.com/kpcyrd">@kpcyrd</a> on 2020-04-14 14:34</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">C: generator</span> added by <a href="https://github.com/CreepySkeleton">@CreepySkeleton</a> on 2020-06-30 09:57</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone &quot;3.1&quot; by <a href="https://github.com/CreepySkeleton">@CreepySkeleton</a> on 2020-06-30 09:57</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/pksunkara">@pksunkara</a> on 2020-08-16 07:57</div>
            <div class="timeline-body"><p>@intgr I couldn&#x27;t reproduce this when this issue was created. Do you want to take a look at this?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/intgr">@intgr</a> on 2020-08-16 18:05</div>
            <div class="timeline-body"><p>This is a bug indeed, the same issue affects zsh built-in <code>git</code> completions too, for example:</p>
<p><code>git --git-dir .git commi&lt;TAB&gt;</code> should complete to <code>commit</code> but doesn&#x27;t.</p>
<p>~~A workaround is using <code>=</code> in <code>--arg=</code> to separate argument value.~~</p>
<p>~~This works: <code>git --git-dir=.git commi&lt;TAB&gt;</code>~~</p>
<p><strong>EDIT:</strong> Sorry, my bad, the above works with <code>git</code> but not clap&#x27;s generated completions file.</p>
<p>I&#x27;ll have to dig some more in zsh documentation to see if this is can be fixed in clap or if it&#x27;s a bug in zsh itself.</p>

If this is helpful for anyone, here&#x27;s clap 3.x compatible version of the bug report&#x27;s code:

<pre><code>use clap::{App, Arg};
use clap_generate::generators::{Bash, Zsh};
use std::io::stdout;

fn app() -&gt; App&lt;&#x27;static&gt; {
    App::new(&quot;completion-bug&quot;)
        .arg(Arg::new(&quot;foo&quot;).short(&#x27;f&#x27;).long(&quot;foo&quot;).takes_value(true))
        .subcommand(App::new(&quot;zsh&quot;))
        .subcommand(App::new(&quot;bash&quot;))
}

fn main() {
    let args = app().get_matches();
    eprintln!(&quot;{:?}&quot;, args);

    match args.subcommand() {
        (&quot;zsh&quot;, _) =&gt; {
            let mut app = app();
            clap_generate::generate::&lt;Zsh, _&gt;(&amp;mut app, &quot;completion-bug&quot;, &amp;mut stdout());
        }
        (&quot;bash&quot;, _) =&gt; {
            let mut app = app();
            clap_generate::generate::&lt;Bash, _&gt;(&amp;mut app, &quot;completion-bug&quot;, &amp;mut stdout());
        }
        _ =&gt; unreachable!(),
    };
}
</code></pre>


</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/intgr">@intgr</a> on 2020-08-16 19:03</div>
            <div class="timeline-body"><p>As far as I can tell, clap is annotating the arguments correctly per zsh documentation (http://zsh.sourceforge.net/Doc/Release/Completion-System.html)</p>
<p>From the generated file:</p>
<pre><code>&#x27;-f+[]&#x27; \
</code></pre>
<p>Documentation:</p>
<blockquote>
<p>The first argument may appear immediately after optname in the same word, or may appear as a separate word after the option. For example, ‘-foo+:...’ specifies that the completed option and argument will look like either ‘-fooarg’ or ‘-foo arg’.</p>
</blockquote>
<pre><code>&#x27;--foo=[]&#x27; \
</code></pre>
<blockquote>
<p>The argument may appear as the next word, or in same word as the option name provided that it is separated from it by an equals sign, for example ‘-foo=arg’ or ‘-foo arg’.</p>
</blockquote>
<hr>
<p>I looked at git completions and I still don&#x27;t understand why <code>--git-dir=.git</code> works with git completions but <code>--foo=x</code> doesn&#x27;t work with clap&#x27;s generated file. But in any case the behavior of <code>--git-dir .git</code> is wrong in zsh&#x27;s built-in git completions as well.</p>
<p>I don&#x27;t consume the sort of hard drugs necessary to get in the same frame of mind as zsh developers, I don&#x27;t wish to investigate this further, sorry. :)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/pksunkara">@pksunkara</a> on 2020-08-16 20:07</div>
            <div class="timeline-body"><p>Thanks for your help @intgr</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">:money_with_wings: $5</span> added by <a href="https://github.com/pksunkara">@pksunkara</a> on 2020-09-28 08:06</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to <a href="https://github.com/pksunkara">@pksunkara</a> by <a href="https://github.com/pksunkara">@pksunkara</a> on 2020-10-25 20:01</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Unassigned <a href="https://github.com/pksunkara">@pksunkara</a> by <a href="https://github.com/pksunkara">@pksunkara</a> on 2020-10-25 20:01</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a>Macchina-CLI/macchina#68</a> on 2021-04-16 08:03</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a>clap-rs/clap#3022</a> on 2021-11-14 01:52</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a>clap-rs/clap#1232</a> on 2021-11-15 14:31</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a>epage/clapng#92</a> on 2021-12-06 17:34</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a>epage/clapng#155</a> on 2021-12-06 20:15</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a>epage/clapng#238</a> on 2021-12-06 22:24</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">E-medium</span> added by <a href="https://github.com/epage">@epage</a> on 2021-12-10 21:36</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Removed from milestone &quot;3.1&quot; by <a href="https://github.com/epage">@epage</a> on 2021-12-10 21:36</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a>clap-rs/clap#3166</a> on 2021-12-13 17:55</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/RubixDev">@RubixDev</a> on 2023-07-08 09:13</div>
            <div class="timeline-body"><p>It seems to work fine for me using the latest versions (clap v4.3.11, clap_complete v4.3.2).</p>

Here is the updated code I used

<pre><code>use clap::{value_parser, Arg, Command};
use clap_complete::Shell;
use std::{io::stdout, path::PathBuf};

fn app() -&gt; Command {
    Command::new(&quot;completion-bug&quot;)
        .arg(
            Arg::new(&quot;foo&quot;)
                .short(&#x27;f&#x27;)
                .long(&quot;foo&quot;)
                .value_parser(value_parser!(PathBuf)),
        )
        .subcommand(Command::new(&quot;zsh&quot;))
        .subcommand(Command::new(&quot;bash&quot;))
}

fn main() {
    let args = app().get_matches();
    eprintln!(&quot;{:?}&quot;, args);

    let shell = match args.subcommand() {
        Some((&quot;zsh&quot;, _)) =&gt; Shell::Zsh,
        Some((&quot;bash&quot;, _)) =&gt; Shell::Bash,
        _ =&gt; unreachable!(),
    };

    clap_complete::generate(shell, &amp;mut app(), &quot;completion-bug&quot;, &amp;mut stdout());
}
</code></pre>


</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/kpcyrd">@kpcyrd</a> on 2023-07-08 12:41</div>
            <div class="timeline-body"><p>I also tried again and can confirm zsh tab completions are now working correctly.</p>
<p>Thanks whoever did this! :heart:</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/kpcyrd">@kpcyrd</a> on 2023-07-08 12:41</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a>aome510/spotify-player#310</a> on 2023-12-04 07:52</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:57:45 UTC
    </footer>
</body>
</html>
