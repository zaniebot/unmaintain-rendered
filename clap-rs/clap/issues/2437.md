```yaml
number: 2437
title: "`#[clap(parse(try_from_str))]` doesn't use `try_from(&str)`"
type: issue
state: closed
author: TilCreator
labels:
  - C-bug
  - A-derive
  - S-wont-fix
assignees: []
created_at: 2021-04-09T11:02:55Z
updated_at: 2022-01-11T18:27:35Z
url: https://github.com/clap-rs/clap/issues/2437
synced_at: 2026-01-10T01:57:44Z
```

# `#[clap(parse(try_from_str))]` doesn't use `try_from(&str)`

---

_Issue opened by @TilCreator on 2021-04-09 11:02_

### Please complete the following tasks

I have searched the [discussions](https://github.com/clap-rs/clap/discussions)
I have searched the existing issues

### Rust Version

rustc 1.50.0 (cb75ad5db 2021-02-10)

### Clap Version

3.0.0-beta.2

### Minimal reproducible code

```rust
use reqwest::Url;
use scraper::Selector;

/*
Available functions:
reqwest::Url::try_from(s: &'a str) -> Result<Self, Self::Error>
reqwest::Url::from_str(input: &str) -> Result<Url, crate::ParseError>
scraper::Selector::try_from(s: &'i str) -> Result<Self, Self::Error>
*/

#[derive(Clap, Debug)]
#[clap(name = env!("CARGO_PKG_NAME"))]
struct Args {
    // There is no problem with parsing url. it's just a working example
    #[clap(
        takes_value = true,
        parse(try_from_str)
    )]
    url: Url,
    #[clap(
        takes_value = true,
        parse(try_from_str),
    )]
    selector: Selector,
}

fn main() {
    let args = Args::parse().unwrap();
}
```


### Steps to reproduce the bug with the above code

`cargo run -- https://exameple.com body`

### Actual Behaviour

It does not compile because `#[clap(parse(try_from_str))]` doesn't find `Selector::try_from(&str)`.

### Expected Behaviour

It compiles and finds the `try_from(&str)` of `Selector`.

### Additional Context

From the name `try_from_str` I would expect Clap to use `try_from(&str) -> Result<_>` rather than (/both) `from(&str) -> Result<_>`.
#1661 

### Debug Output

```toml
[dependencies]
reqwest = "0.11.2"
scraper = "0.12.0"
clap = "3.0.0-beta.2"
```

---

_Label `T: bug` added by @TilCreator on 2021-04-09 11:02_

---

_Renamed from "`#[clap(parse(try_from_str)]` doesn't use `try_from(&str)`" to "`#[clap(parse(try_from_str))]` doesn't use `try_from(&str)`" by @TilCreator on 2021-04-09 11:04_

---

_Added to milestone `3.0` by @pksunkara on 2021-04-09 18:19_

---

_Referenced in [clap-rs/clap#2683](../../clap-rs/clap/issues/2683.md) on 2021-08-13 01:05_

---

_Label `C: derive macros` added by @pksunkara on 2021-10-16 18:57_

---

_Comment by @epage on 2021-10-16 19:42_

It looks like this also exists in [structopt](https://docs.rs/structopt/0.3.23/structopt/#custom-string-parsers).

The challenge is naming.  For our `From<T>` versions, we need to differentiate `T`, which leads to `from_str` for `From<&str>` and `from_os_str` for `From<&OsStr>`.  That then conflicts with using `from_str` for `FromStr`.

Granted, if we did auto-detection like #2298, this problem goes away except when the user wants to override for a specific case.

---

_Comment by @epage on 2021-10-16 19:47_

Forgot to add, from observation, it looks like the naming scheme has less to do with what trait is the default but describes what the function signature is when providing a version of it.

From that perspective, I'd be tempted to Close this as Won't Fix.

---

_Comment by @epage on 2021-10-16 19:49_

I've not confirmed it but I believe the user workaround would be `parse(try_from_str = Url::try_from)`

---

_Removed from milestone `3.0` by @epage on 2021-10-16 19:54_

---

_Comment by @TilCreator on 2021-10-16 20:29_

The workaround works for most cases, but some use weird types where a wrapper is still necessary. Here are examples for both:
My original example with the workaround:
```rust
use clap::Clap;
use reqwest::Url;
use scraper::Selector;
use std::convert::TryFrom;

/*
Available functions:
reqwest::Url::try_from(s: &'a str) -> Result<Self, Self::Error>
reqwest::Url::from_str(input: &str) -> Result<Url, crate::ParseError>
scraper::Selector::try_from(s: &'i str) -> Result<Self, Self::Error>
*/

#[derive(Clap, Debug)]
#[clap(name = env!("CARGO_PKG_NAME"))]
struct Args {
    // There is no problem with parsing url. it's just a working example (also from `try_from`)
    #[clap(
        takes_value = true,
        parse(try_from_str = Url::try_from),
    )]
    url: Url,
    #[clap( // Fails with many compile errors
        takes_value = true,
        parse(try_from_str = Selector::try_from),
    )]
    selector: Selector,
}

fn main() {
    let args = Args::parse();

    println!("{:#?}", args);
}


```
That sadly doesn't fix it completely, because the `Selector` type doesn't play nice. 
For such cases a wrapper case can be used, here an example from one of my projects for that:
[Wrapper definition](https://gitlab.com/TilCreator/rustycomicscraper/-/blob/fa7b3f0de6f96229a88d56232df483035bb25678/src/main.rs#L454-470)
[Wrapper usage](https://gitlab.com/TilCreator/rustycomicscraper/-/blob/fa7b3f0de6f96229a88d56232df483035bb25678/src/main.rs#L377-390)

If you don't have to add anything this can be closed, thx

---

_Comment by @pksunkara on 2021-10-16 20:38_

Let's keep this open since I have the impression of tackling this as part of #2683.

---

_Comment by @epage on 2021-10-16 20:39_

```rust
    url: Url,
    #[clap( // Fails with many compile errors
        takes_value = true,
        parse(try_from_str = Selector::try_from),
    )]
    selector: Selector,*/
```

The errors have less to do with `TryFrom` vs `FromStr` and more to do with the fact that `scraper`s error type does not `impl Error`, making it incompatible with most of the Rust ecosystem.

Technically, you do not need a full wrapper type to resolve this.  You can do it just by defining a function and passing that in instead.

---

_Referenced in [epage/clapng#184](../../epage/clapng/issues/184.md) on 2021-12-06 21:14_

---

_Comment by @epage on 2021-12-13 16:38_

Since the names are intended to convey the signature, not the trait, this is working as intended and I'm going to go ahead and close this.

@pksunkara if there are parts of this you want to resolve in #2683, please comment in that issue with it.

If there are any concerns about this, let us know!

---

_Closed by @epage on 2021-12-13 16:38_

---

_Label `S-wont-fix` added by @epage on 2022-01-11 18:27_

---

_Referenced in [collabora/bmap-rs#41](../../collabora/bmap-rs/pulls/41.md) on 2022-11-09 12:09_

---
