```yaml
number: 1611
title: Empty $ENV triggers error message
type: issue
state: closed
author: ensc
labels:
  - C-bug
  - E-help-wanted
assignees: []
created_at: 2019-12-23T12:22:49Z
updated_at: 2020-04-27T08:29:13Z
url: https://github.com/clap-rs/clap/issues/1611
synced_at: 2026-01-10T01:57:43Z
```

# Empty $ENV triggers error message

---

_Issue opened by @ensc on 2019-12-23 12:22_

### Rust Version

rustc 1.40.0 (73528e339 2019-12-16)


### Affected Version of clap

git+https://github.com/clap-rs/clap#fc359e3c4692c2e99deaa21209259b8811c556b6


### Expected Behavior Summary

When an option can both come command line and from env, the environment should be completely ignored when the option has been given on CLI.


### Actual Behavior Summary

Actually, programs fails in this situation when the environment variable is empty.

### Steps to Reproduce the issue

1. `env -u DB cargo --quiet run -- --database foo`

    is ok and works as expected.

2. `env DB= cargo --quiet run -- --database foo`

    fails with

     ```
    error: The argument '--database <database>' requires a value but none was supplied
     ```

### Sample Code or Link to Sample Code

```rust
extern crate clap;

fn main() {
    clap::App::new("test")
	.arg(clap::Arg::with_name("database")
	     .long("database")
	     .env("DB")
	     .takes_value(true))
	.get_matches();
}
```

### Debug output

<details>
<summary> Debug Output </summary>
<pre>
<code>
DEBUG:clap:App::_do_parse;
DEBUG:clap:App::_build;
DEBUG:clap:App::_derive_display_order:test
DEBUG:clap:App::_create_help_and_version;
DEBUG:clap:App::_create_help_and_version: Building --help
DEBUG:clap:App::_create_help_and_version: Building --version
DEBUG:clap:App::_arg_debug_asserts:database
DEBUG:clap:App::_arg_debug_asserts:help
DEBUG:clap:App::_arg_debug_asserts:version
DEBUG:clap:App::_app_debug_asserts;
DEBUG:clap:Parser::get_matches_with;
DEBUG:clap:Parser::_build;
DEBUG:clap:Parser::_verify_positionals;
DEBUG:clap:Parser::get_matches_with: Begin parsing '"--database"' ([45, 45, 100, 97, 116, 97, 98, 97, 115, 101])
DEBUG:clap:Parser::is_new_arg:"--database":NotFound
DEBUG:clap:Parser::is_new_arg: arg_allows_tac=false
DEBUG:clap:Parser::is_new_arg: -- found
DEBUG:clap:Parser::is_new_arg: starts_new_arg=true
DEBUG:clap:Parser::possible_subcommand: arg="--database"
DEBUG:clap:Parser::get_matches_with: possible_sc=false, sc=None
DEBUG:clap:Parser::parse_long_arg;
DEBUG:clap:Parser::parse_long_arg: Does it contain '='...No
DEBUG:clap:Parser::parse_long_arg: Found valid opt or flag '--database <database>'
DEBUG:clap:Parser::parse_opt; opt=database, val=None
DEBUG:clap:Parser::parse_opt; opt.settings=ArgFlags(TAKES_VAL | DELIM_NOT_SET)
DEBUG:clap:Parser::parse_opt; Checking for val...None
DEBUG:clap:ArgMatcher::inc_occurrence_of: arg=10007437080733436389
DEBUG:clap:ArgMatcher::inc_occurrence_of: first instance
DEBUG:clap:Parser::groups_for_arg: name=10007437080733436389
DEBUG:clap:Parser::parse_opt: More arg vals required...
DEBUG:clap:Parser:get_matches_with: After parse_long_arg Opt(10007437080733436389)
DEBUG:clap:Parser::get_matches_with: Begin parsing '"foo"' ([102, 111, 111])
DEBUG:clap:Parser::is_new_arg:"foo":Opt(10007437080733436389)
DEBUG:clap:Parser::is_new_arg: arg_allows_tac=false
DEBUG:clap:Parser::is_new_arg: probably value
DEBUG:clap:Parser::is_new_arg: starts_new_arg=false
DEBUG:clap:Parser::add_val_to_arg; arg=database, val="foo"
DEBUG:clap:Parser::add_val_to_arg; trailing_vals=false, DontDelimTrailingVals=false
DEBUG:clap:Parser::add_single_val_to_arg;
DEBUG:clap:Parser::add_single_val_to_arg: adding val..."foo"
DEBUG:clap:Parser::groups_for_arg: name=10007437080733436389
DEBUG:clap:ArgMatcher::needs_more_vals: o=database
DEBUG:clap:Parser::remove_overrides;
DEBUG:clap:Parser::remove_overrides:iter:10007437080733436389;
DEBUG:clap:Validator::validate;
DEBUG:clap:Parser::add_val_to_arg; arg=database, val=""
DEBUG:clap:Parser::add_val_to_arg; trailing_vals=false, DontDelimTrailingVals=false
DEBUG:clap:Parser::add_single_val_to_arg;
DEBUG:clap:Parser::add_single_val_to_arg: adding val...""
DEBUG:clap:Parser::groups_for_arg: name=10007437080733436389
DEBUG:clap:ArgMatcher::needs_more_vals: o=database
DEBUG:clap:Parser::add_defaults;
DEBUG:clap:Parser::add_defaults:iter:database: doesn't have conditional defaults
DEBUG:clap:Parser::add_defaults:iter:database: doesn't have default vals
DEBUG:clap:Validator::validate_conflicts;
DEBUG:clap:Validator::gather_conflicts;
DEBUG:clap:Validator::gather_conflicts:iter:10007437080733436389;
DEBUG:clap:Parser::groups_for_arg: name=10007437080733436389
DEBUG:clap:Validator::validate_required: required=ChildGraph([]);
DEBUG:clap:Validator::gather_requirements;
DEBUG:clap:Validator::gather_requirements:iter:10007437080733436389;
DEBUG:clap:Validator::validate_required_unless;
DEBUG:clap:Validator::validate_matched_args;
DEBUG:clap:Validator::validate_matched_args:iter:10007437080733436389: vals=[
    "foo",
    "",
]
DEBUG:clap:Validator::validate_arg_num_vals;
DEBUG:clap:Validator::validate_arg_values: arg="database"
DEBUG:clap:Validator::validate_arg_values: illegal empty val found
DEBUG:clap:usage::create_usage_with_title;
DEBUG:clap:usage::create_usage_no_title;
DEBUG:clap:Usage::create_help_usage; incl_reqs=true
DEBUG:clap:Usage::get_required_usage_from: incls=[], matcher=false, incl_last=false
DEBUG:clap:Usage::get_required_usage_from: ret_val=[]
DEBUG:clap:usage::needs_flags_tag;
DEBUG:clap:usage::needs_flags_tag:iter: f=help;
DEBUG:clap:usage::needs_flags_tag:iter: f=version;
DEBUG:clap:usage::needs_flags_tag: [FLAGS] not required
DEBUG:clap:usage::create_help_usage: usage=bin [OPTIONS]
DEBUG:clap:App::color;
DEBUG:clap:App::color: Color setting...Auto
DEBUG:clap:is_a_tty;
DEBUG:clap:Colorizer::error;
DEBUG:clap:Colorizer::warning;
DEBUG:clap:Colorizer::good;
</code>
</pre>
</details>


---

_Comment by @craigpastro on 2020-01-07 04:53_

I tried to reproduce this, but in both cases
```
env -u DB cargo --quiet run -- --database foo
env DB= cargo --quiet run -- --database foo
```
if I `println!` the following
```
 matches.value_of("database").unwrap()
```
I get `foo`, as expected...?

rustc 1.40.0
clap 2.33.0

---

_Comment by @ensc on 2020-01-07 10:58_

@siyopao  I used 3.0.0-beta resp. recent git HEAD

---

_Comment by @craigpastro on 2020-01-08 00:29_

@ensc Ah, sorry, how silly, I should have tried that. Reproduced with git HEAD.

---

_Added to milestone `3.0` by @CreepySkeleton on 2020-02-01 10:53_

---

_Label `help wanted` added by @CreepySkeleton on 2020-02-01 10:55_

---

_Label `T: bug` added by @CreepySkeleton on 2020-02-01 10:55_

---

_Label `W: 3.x` added by @CreepySkeleton on 2020-02-01 10:55_

---

_Label `C: environment variable` added by @CreepySkeleton on 2020-02-01 10:56_

---

_Comment by @CreepySkeleton on 2020-04-27 08:29_

This was fixed by https://github.com/clap-rs/clap/pull/1850

---

_Closed by @CreepySkeleton on 2020-04-27 08:29_

---
