<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mutable app functions are confusing to users and awkward to work with - clap-rs/clap #2911</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Mutable app functions are confusing to users and awkward to work with</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/clap-rs/clap/issues/2911">#2911</a>
        opened by <a href="https://github.com/epage">@epage</a>
        on 2021-10-19 15:33
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/epage">@epage</a></div>
            <div class="timeline-body">Please complete the following tasks
<ul>
<li>[X] I have searched the <a href="https://github.com/clap-rs/clap/discussions">discussions</a></li>
<li>[X] I have searched the existing issues</li>
</ul>
Rust Version
<p>rustc 1.55.0 (c8dfcfe04 2021-09-06)</p>
Clap Version
<p>master</p>
Minimal reproducible code
<pre><code>let mut app = ...;
app.render_usage();
</code></pre>
Steps to reproduce the bug with the above code
<p>Program with the <code>&amp;mut</code> API</p>
Actual Behaviour
<p>Its awkward and exposing of implementation details.  I&#x27;ve seen user confusion akin to &quot;Why does rendering need to modify the app?&quot;</p>
<p>Other uses of this API, like <code>clap_generate</code>, need to use the hidden <code>_build</code></p>
Expected Behaviour
<p>The types are clean and understandable for a user without ambiguous &quot;modify after build&quot;</p>
Additional Context
<p>I propose we add a <code>struct AppParser</code> that derefs to <code>App</code>.</p>
<ul>
<li><code>get_matches</code> will consume <code>App</code> and use <code>_build</code> (only build what is needed for parsing)</li>
<li><code>App::build(self) -&gt; AppParser</code> will call <code>_build_all</code><ul>
<li>Contains all of the existing <code>&amp;mut</code> functions, but without the <code>mut</code></li>
</ul>
</li>
</ul>
<p>We can implement the additions without breaking behavior; we just add deprecations.  Then on the next breaking release, we remove the deprecated behavior.</p>
Debug Output
<p><em>No response</em></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">T: bug</span> added by <a href="https://github.com/epage">@epage</a> on 2021-10-19 15:33</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">E: breaking change</span> added by <a href="https://github.com/epage">@epage</a> on 2021-10-19 15:33</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">C: app</span> added by <a href="https://github.com/epage">@epage</a> on 2021-10-19 15:33</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone &quot;3.0&quot; by <a href="https://github.com/epage">@epage</a> on 2021-10-19 15:33</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to <a href="https://github.com/epage">@epage</a> by <a href="https://github.com/epage">@epage</a> on 2021-10-19 15:33</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Removed from milestone &quot;3.0&quot; by <a href="https://github.com/epage">@epage</a> on 2021-10-19 15:33</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/pksunkara">@pksunkara</a> on 2021-10-19 19:08</div>
            <div class="timeline-body"><p>Same issue as <code>print_*_help</code> and <code>write_*_help</code> methods. I wanted them to be non-mut but couldn&#x27;t find a way to do it without quickly blowing up the scope of it. IIRC there were some discussions around this when those signatures were implemented which might be useful here.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2021-10-19 19:36</div>
            <div class="timeline-body"><p>What are your thoughts on the proposal for solving the <code>mut</code> problem?</p>
<blockquote>
<p>IIRC there were some discussions around this when those signatures were implemented which might be useful here.</p>
</blockquote>
<p>At least in my initial search, I found <a href="https://github.com/clap-rs/clap/pull/540">clap-rs/clap#540</a> which didn&#x27;t have any useful conversation on the subject.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/pksunkara">@pksunkara</a> on 2021-10-19 19:41</div>
            <div class="timeline-body"><p>It would be a good approach to explore definitely. Will have to evaluate it properly when we are finalising the design though.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/pksunkara">@pksunkara</a> on 2021-10-19 19:46</div>
            <div class="timeline-body"><p>Heh, weird. Couldn&#x27;t find the discussion now. Maybe it was on something else that was related? ðŸ¤·</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a>clap-rs/clap#2924</a> on 2021-11-05 13:27</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a>epage/clapng#224</a> on 2021-12-06 22:21</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a>clap-rs/clap#3089</a> on 2021-12-08 19:48</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a>clap-rs/clap#992</a> on 2021-12-10 18:31</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a>clap-rs/clap#2218</a> on 2021-12-13 15:10</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone &quot;4.0&quot; by <a href="https://github.com/epage">@epage</a> on 2021-12-13 22:02</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">E-medium</span> added by <a href="https://github.com/epage">@epage</a> on 2021-12-13 22:03</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2021-12-14 15:30</div>
            <div class="timeline-body"><p>~~We should probably do <a href="https://github.com/clap-rs/clap/issues/3089">clap-rs/clap#3089</a> first.~~
Done</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a>clap-rs/clap#3322</a> on 2022-01-21 14:52</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a>clap-rs/clap#3221</a> on 2022-01-25 15:51</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a>clap-rs/clap#950</a> on 2022-02-15 15:48</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2022-02-15 15:49</div>
            <div class="timeline-body"><p>#950 needs us to rename the <code>get_matches</code> functions.  We should coordinate these changes together to reduce user churn.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a>clap-rs/clap#3602</a> on 2022-04-03 01:10</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a>clap-rs/clap#3642</a> on 2022-04-19 15:14</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Removed from milestone &quot;4.0&quot; by <a href="https://github.com/epage">@epage</a> on 2022-06-01 21:12</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone &quot;5.0&quot; by <a href="https://github.com/epage">@epage</a> on 2022-06-01 21:12</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a>clap-rs/clap#4183</a> on 2022-09-06 14:08</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2022-09-07 14:41</div>
            <div class="timeline-body"><p>A simple way we can handle this is if we add the type</p>
<pre><code>pub struct Built&lt;T&gt;(T);

impl Built&lt;Command&gt; {
   pub fn get_arguments(&amp;self) -&gt; impl Iterator&lt;Item=Built&lt;Arg&gt;&gt;;

   pub fn get_subcommands(&amp;self) -&gt; impl Iterator&lt;Item=Built&lt;Command&gt;&gt;;
}

impl Built&lt;&amp;&#x27;_ Command&gt; {
   pub fn get_arguments(&amp;self) -&gt; impl Iterator&lt;Item=Built&lt;Arg&gt;&gt;;

   pub fn get_subcommands(&amp;self) -&gt; impl Iterator&lt;Item=Built&lt;Command&gt;&gt;;
}

impl&lt;T&gt; AsRef&lt;T&gt; for Built&lt;T&gt;{
    #[inline]
    fn as_ref(&amp;self) -&gt; &amp;T{
        &amp;self.0
    }
}

impl&lt;T&gt; Borrow&lt;T&gt; for Built&lt;T&gt;{
    #[inline]
    fn borrow(&amp;self) -&gt; &amp;T{
        &amp;self.0
    }
}

impl&lt;T&gt; :Deref for Built&lt;T&gt; {
    type Target = T;

    #[inline]
    fn deref(&amp;self) -&gt; &amp;T{
        &amp;self.0
    }
}
</code></pre>
<p>We would also remove the <code>get_arguments</code> getters on <code>Command</code> in favor of <code>get_arguments_mut</code> to keep clear that <code>Command</code> isn&#x27;t built</p>
<p>This still leaves trying to re-work the parser so it can work off of <code>mut</code> and immutable <code>Command</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a>clap-rs/clap#4685</a> on 2023-02-01 16:56</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a>clap-rs/clap#5065</a> on 2023-08-17 17:50</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a>clap-rs/clap#5300</a> on 2024-01-12 18:30</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a>clap-rs/clap#5815</a> on 2024-11-13 22:23</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:58:24 UTC
    </footer>
</body>
</html>
