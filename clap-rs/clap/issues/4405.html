<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Option to disable runtime-validation in debug release? - clap-rs/clap #4405</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Option to disable runtime-validation in debug release?</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/clap-rs/clap/issues/4405">#4405</a>
        opened by <a href="https://github.com/fanzeyi">@fanzeyi</a>
        on 2022-10-19 21:47
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/fanzeyi">@fanzeyi</a></div>
            <div class="timeline-body">Please complete the following tasks
<ul>
<li>[X] I have searched the <a href="https://github.com/clap-rs/clap/discussions">discussions</a></li>
<li>[X] I have searched the <a href="https://github.com/clap-rs/clap/issues">open</a> and <a href="https://github.com/clap-rs/clap/issues?q=is%3Aissue+label%3AS-wont-fix+is%3Aclosed">rejected</a> issues</li>
</ul>
Rust Version
<p>rust playground 1.64.0</p>
Clap Version
<p>4.0.6</p>
Minimal reproducible code
<pre><code>use clap::Parser;
use std::path::PathBuf;
use std::io::Result;

fn foobar(input: &amp;str) -&gt; Result&lt;PathBuf&gt; {
    println!(&quot;got input: {input}&quot;);
    if input.is_empty() {
        Ok(PathBuf::from(&quot;/&quot;))
        // Err(std::io::Error::last_os_error())
    } else {
        Ok(PathBuf::from(&quot;/&quot;))
    }
}

#[derive(Parser, Debug)]
#[clap(about = &quot;Test&quot;)]
struct Args {
    #[clap(value_parser = foobar, default_value = &quot;&quot;)]
    path: PathBuf,
}

fn main() {
    let args = Args::parse_from(vec![&quot;binary&quot;, &quot;/etc&quot;]);
}
</code></pre>
<p>https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2021&amp;gist=42894c861ebd752bb5d6f8624cdb88ca</p>
Steps to reproduce the bug with the above code
<p>Click Run button in playground.</p>
Actual Behaviour
<p><code>got input</code> got called twice, once with the default empty string and once with supplied string.</p>
Expected Behaviour
<p>When the user supplies any value, the default value should not be used and parsed.</p>
<p>It looks like this happens in debug mode for validating supplied default values. Specifically this call here:</p>
<p>https://github.com/clap-rs/clap/blob/6328c14c0c1ef256f7b40024289123da9dc2f40d/src/builder/command.rs#L3905-L3906</p>
<p>Would it be possible to consider at least making this configurable? We run tests in both debug and release mode and this discrepancy is hard to work around. I can either write code in my parse function to cheat in debug mode (which is kinda awkward) or to avoid using <code>default_value</code> entirely. :(</p>
Additional Context
<p><em>No response</em></p>
Debug Output
<p><em>No response</em></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">C-bug</span> added by <a href="https://github.com/fanzeyi">@fanzeyi</a> on 2022-10-19 21:47</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2022-10-19 22:18</div>
            <div class="timeline-body"><p>Could you expand on why parsing the default twice in debug builds is a problem?</p>
<blockquote>
<p>Would it be possible to consider at least making this configurable?</p>
</blockquote>
<p>One way of doing this is feature flags but they have <a href="https://github.com/clap-rs/clap/issues/4398">problems</a> and should be limited in when we use them.</p>
<p>We do have <code>help_expected</code> and could add another flag like that but we need to make sure this feature pulls its weight for adding more noise to the API (something we are working on reducing).</p>
<p>The original issue is #3202 and PR is #3423.  The big problem we are trying to address is that users can only catch some invalid cases by exhaustive testing of their CLI.  Doing this in debug asserts lets users detect this sooner.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/fanzeyi">@fanzeyi</a> on 2022-10-19 22:36</div>
            <div class="timeline-body"><blockquote>
<p>Could you expand on why parsing the default twice in debug builds is a problem?</p>
</blockquote>
<p>So we are currently using <code>default_value</code> in combination with <code>try_parse_str</code> to compute a default_value if the user has not supplied it. It depends on where the user&#x27;s current working directory is and as a result it may produce an error depending on where the user runs it.</p>
<p>I guess our setup isn&#x27;t really using clap APIs &quot;correctly&quot;. The X problem here is that there isn&#x27;t an API to supply a function to calculate the default value without implementing <code>Display</code> or being <code>OsString</code> (I&#x27;m guessing this is for including the default value in help messages?). We want something like that since computing the default is nontrivial so we want to defer it as late as possible.</p>
<blockquote>
<p>The big problem we are trying to address is that users can only catch some invalid cases by exhaustive testing of their CLI. Doing this in debug asserts lets users detect this sooner.</p>
</blockquote>
<p>I understand the motivation of having this validation and I agree that having clap to validate it before it making to production is very helpful. I&#x27;m wondering if we can do the validation separately if we were to have an option disabling this runtime check.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2022-10-20 01:36</div>
            <div class="timeline-body"><blockquote>
<p>So we are currently using default_value in combination with try_parse_str to compute a default_value if the user has not supplied it. It depends on where the user&#x27;s current working directory is and as a result it may produce an error depending on where the user runs it.</p>
</blockquote>
<p>If there isn&#x27;t a default value to show in help, why give the default to clap instead of making the value optional and calculating it after parsing?</p>
<p>btw we are looking at generalizing how defaulting works.  We&#x27;ve started brainstorming it at https://github.com/clap-rs/clap/discussions/3476</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a>clap-rs/clap#4409</a> on 2022-11-03 03:17</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">S-triage</span> added by <a href="https://github.com/epage">@epage</a> on 2022-11-08 04:27</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">A-builder</span> added by <a href="https://github.com/epage">@epage</a> on 2022-11-08 04:27</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2022-11-08 04:47</div>
            <div class="timeline-body"><p>As the original request is about providing clap with a sentinel default value that could just as well be handled by not providing a default, I&#x27;m inclined to close this.  As listed above, we also are looking at allowing defaults to be handled in a different way.  If people have input on that, see #3476.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/epage">@epage</a> on 2022-11-08 04:47</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">S-triage</span> removed by <a href="https://github.com/epage">@epage</a> on 2022-11-08 04:47</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">S-wont-fix</span> added by <a href="https://github.com/epage">@epage</a> on 2022-11-08 04:47</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:59:25 UTC
    </footer>
</body>
</html>
