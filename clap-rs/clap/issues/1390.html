<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>--version output should go to the clap::Error instead of directly to stdout - clap-rs/clap #1390</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>--version output should go to the clap::Error instead of directly to stdout</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/clap-rs/clap/issues/1390">#1390</a>
        opened by <a href="https://github.com/m-ou-se">@m-ou-se</a>
        on 2018-12-02 17:13
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/m-ou-se">@m-ou-se</a></div>
            <div class="timeline-body">Affected Version of clap
<p>2.32.0</p>
Bug or Feature Request Summary
<p>I&#x27;m using <code>get_matches_from_safe</code> to avoid exits and writing to stdout and stderr, because I&#x27;m using Clap not to parse arguments to the program itself, but somewhere inside the program (say, for commands submitted by connecting clients, or an internal command line interface in a gui):</p>
<pre><code>let foo = app.get_matches_from_safe(client_args).map_err(|e| writeln!(client_output, &quot;{}&quot;, e).unwrap())?;
</code></pre>
<p>This works fine, except that the output of <code>--version</code> ends up in stdout, instead of in <code>client_output</code>. It works fine for <code>--help</code>.</p>
Expected Behaviour Summary
<p>I would expect the output from <code>--version</code> to not be written directly to stdout, but to end up in a <code>clap::Error</code>. This looks like the originally intended behaviour, seeing that <code>clap::Error::use_stderr</code> returns true for <code>ErrorKind::VersionDisplayed</code>.</p>
Actual Behaviour Summary
<p>The version is not printed to the stream that I print the <code>clap::Error</code> to, but is always sent to stdout.</p>
Sample Code
<pre><code>extern crate clap;

use std::fmt::Write;

fn main() {
	let mut buf = String::new();

	let _ = clap::App::new(&quot;test&quot;).version(&quot;1&quot;)
		.get_matches_from_safe(&amp;[&quot;test&quot;, &quot;--version&quot;])
		.map_err(|e| writeln!(&amp;mut buf, &quot;{}&quot;, e).unwrap());

	assert_eq!(buf, &quot;test 1\n&quot;);
}
</code></pre>
Debug output

 Debug Output 

<pre><code>DEBUG:clap:Parser::propagate_settings: self=test, g_settings=AppFlags(
    (empty)
)
DEBUG:clap:Parser::get_matches_with;
DEBUG:clap:Parser::create_help_and_version;
DEBUG:clap:Parser::create_help_and_version: Building --help
DEBUG:clap:Parser::create_help_and_version: Building --version
DEBUG:clap:Parser::get_matches_with: Begin parsing &#x27;&quot;--version&quot;&#x27; ([45, 45, 118, 101, 114, 115, 105, 111, 110])
DEBUG:clap:Parser::is_new_arg:&quot;--version&quot;:NotFound
DEBUG:clap:Parser::is_new_arg: arg_allows_tac=false
DEBUG:clap:Parser::is_new_arg: -- found
DEBUG:clap:Parser::is_new_arg: starts_new_arg=true
DEBUG:clap:Parser::possible_subcommand: arg=&quot;--version&quot;
DEBUG:clap:Parser::get_matches_with: possible_sc=false, sc=None
DEBUG:clap:ArgMatcher::process_arg_overrides:None;
DEBUG:clap:Parser::parse_long_arg;
DEBUG:clap:Parser::parse_long_arg: Does it contain &#x27;=&#x27;...No
DEBUG:clap:Parser::parse_long_arg: Found valid flag &#x27;--version&#x27;
DEBUG:clap:Parser::check_for_help_and_version_str;
DEBUG:clap:Parser::check_for_help_and_version_str: Checking if --version is help or version...Version
DEBUG:clap:Parser::_version: 
test 1thread &#x27;main&#x27; panicked at &#x27;assertion failed: `(left == right)`
  left: `&quot;\n\n&quot;`,
 right: `&quot;test 1\n&quot;`&#x27;, src/main.rs:12:2
</code></pre>


</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a>watchexec/cargo-watch#114</a> on 2019-02-14 22:25</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a>clap-rs/clap#1477</a> on 2019-05-25 15:24</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a>clap-rs/clap#1602</a> on 2019-11-26 16:34</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/Dylan-DPC-zz">@Dylan-DPC-zz</a> on 2019-11-26 17:39</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a>d-e-s-o/nitrocli#97</a> on 2020-01-08 12:29</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a>d-e-s-o/nitrocli#114</a> on 2020-08-31 09:23</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:57:19 UTC
    </footer>
</body>
</html>
