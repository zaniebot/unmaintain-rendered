```yaml
number: 4362
title: "`TypedValueParser` cannot parse/validate an `OsStr` with full error context"
type: issue
state: closed
author: kpreid
labels:
  - C-bug
assignees: []
created_at: 2022-10-09T04:24:39Z
updated_at: 2022-10-11T02:12:44Z
url: https://github.com/clap-rs/clap/issues/4362
synced_at: 2026-01-10T01:57:48Z
```

# `TypedValueParser` cannot parse/validate an `OsStr` with full error context

---

_Issue opened by @kpreid on 2022-10-09 04:24_

### Please complete the following tasks

- [X] I have searched the [discussions](https://github.com/clap-rs/clap/discussions)
- [X] I have searched the [open](https://github.com/clap-rs/clap/issues) and [rejected](https://github.com/clap-rs/clap/issues?q=is%3Aissue+label%3AS-wont-fix+is%3Aclosed) issues

### Clap Version

4.0.11 (and also 3.2)

### Describe your use case

There seems to be no way to simultaneously:

* run custom parsing or validation code on an argument (via `value_parser = ...`),
* accept `OsStr` input (non-UTF-8) rather than `str`, and
* produce errors with `context` information identifying the erroneous value etc.

There is [an implementation](https://docs.rs/clap/latest/clap/builder/trait.TypedValueParser.html#impl-TypedValueParser-for-F) of `TypedValueParser` for functions which adds context for the error but it only accepts `&str` input, and if one is writing one's own `impl TypedValueParser for …` then it is not possible to access the `Error` operations to add context. The documentation recommends `Command::error()`, but that takes a mutable `Command` which is not available from within a `TypedValueParser`.

### Describe the solution you'd like

It should be possible to construct a `clap::Error`, while implementing a parser, that has all the usual context.

### Alternatives, if applicable

A second implementation for functions that take `&OsStr` would work, but does not seem an ideal solution to me since it doesn't allow composing `TypedValueParser`s.

### Additional Context

In [previous discussion](https://github.com/clap-rs/clap/discussions/4140), epage wrote:

> But we should also support people writing their own value parsers and this is a bug hole for it. Can you create an issue?

No one filed that issue yet, so I am now. ([Another discussion post](https://github.com/clap-rs/clap/discussions/4029).)



---

_Label `C-enhancement` added by @kpreid on 2022-10-09 04:24_

---

_Comment by @kpreid on 2022-10-09 04:26_

(I think this should be labeled a bug rather than an enhancement, since it's functionality that existed in clap 3, but the "enhancement" issue template was more fitting for what there was to say about it.)

---

_Label `C-enhancement` removed by @epage on 2022-10-10 13:53_

---

_Label `C-bug` added by @epage on 2022-10-10 13:53_

---

_Comment by @epage on 2022-10-10 14:02_

For anyone else reading this, I would recommend double checking if you need to implement `TypedValueParser`.  Too frequently people immediately jump to implementing it when that is the harder and more verbose route

Current alternatives:
- Any `Fn(&str) -> Result<T, E>` already implements it
- `value_parser!` can adapt types that implement `FromStr`, `From<&str>`, `From<String>`, `From<&OsStr>` and `From<OsString>`
- You can take existing `TypedValueParser`s and call `TypedValueParser::map` on them

---

_Comment by @epage on 2022-10-10 14:03_

@kpreid could you expand on your use case?  I'm curious in what situations someone needs to parse `OsStr` or `OsString` types.  That'll also help in understanding if we should also look into supporting `TryFrom`, `TypedValueParser::try_map`, or a host of additional solutions on top of exposing more error context.

---

_Comment by @epage on 2022-10-10 14:09_

For this issue, there are two core problems
- We don't expose a way to set `Error::context`
- We don't expose a way to enable coloring and other similar features

---

_Referenced in [clap-rs/clap#4365](../../clap-rs/clap/pulls/4365.md) on 2022-10-10 14:46_

---

_Comment by @kpreid on 2022-10-10 14:54_

> could you expand on your use case?

In the particular case, I want to validate that `--output <FILE>` has a recognizable filename extension. I could do this validation on the final struct post-`clap`-parsing of course, but then I still don't have the ability to provide all the nice formatted error context, at least without doing a lot of digging to get an `&mut Command` (which, besides being inelegant, also doesn't fit well the `clap` derive system which allows the code that runs after `clap` parsing to not care about anything but the struct fields).

A more elaborate case of actual _parsing_ involving `OsStr` input might be, say, expecting a glob pattern or a numeric-sequence pattern.

> That'll also help in understanding if we should also look into supporting…

Prior to `clap` 3.2 I was using the `validator_os` option. So, `TypedValueParser::try_map` would be perhaps a good option, _if_ it then supports returning an error that will be given context (as opposed to the map function having to assemble the desired context itself). While setting arbitrary `context` would be _sufficient_, it would be _preferable_ to be able to express “this is a validation error; please insert all the context you would for that” without having to duplicate that fragment of clap's internal logic. That way, good and **consistent** messages appear by default.

---

_Closed by @epage on 2022-10-10 15:53_

---

_Referenced in [clap-rs/clap#4366](../../clap-rs/clap/pulls/4366.md) on 2022-10-10 15:54_

---

_Comment by @kpreid on 2022-10-11 02:12_

I just confirmed that release 4.0.12 solves the problem I had. Thanks!

---

_Referenced in [clap-rs/clap#5065](../../clap-rs/clap/issues/5065.md) on 2023-08-03 22:50_

---

_Referenced in [clap-rs/clap#5066](../../clap-rs/clap/pulls/5066.md) on 2023-08-08 00:40_

---
