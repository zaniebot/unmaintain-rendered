<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>`args_conflicts_with_subcommands` is not overriding `subcommand_required = true` - clap-rs/clap #5358</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1><code>args_conflicts_with_subcommands</code> is not overriding <code>subcommand_required = true</code></h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/clap-rs/clap/issues/5358">#5358</a>
        opened by <a href="https://github.com/foobl42">@foobl42</a>
        on 2024-02-16 19:12
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/foobl42">@foobl42</a></div>
            <div class="timeline-body"><h3>Discussed in https://github.com/clap-rs/clap/discussions/5353</h3>
<div type='discussions-op-text'>

<p><sup>Originally posted by <strong>fooblinator</strong> February 15, 2024</sup>
I have a flag (&quot;--about&quot;) at the &quot;top level&quot;, meaning as a child argument of the program's command. It's a bool so is optional. I don't need it to be required. I also have a subcommand at the same level, which points to an enum of subcommands, whose variants point to other enums (nested subcommands).</p>
<p>As a config option, I have &quot;args_conflicts_with_subcommands&quot; set to true. Also, I have &quot;arg_required_else_help&quot; set to false, so I can see the generated error, when I fail to provide a command name. The error and usage makes good sense, and when not providing a subcommand, this message makes good suggestions about what to try:</p>
<blockquote>
<p>error: 'expenses' requires a subcommand but one was not provided
[subcommands: manage, track, help]</p>
<p>Usage: expenses [OPTIONS]
expenses  &lt;COMMAND&gt;</p>
<p>For more information, try '--help'.</p>
</blockquote>
<p>The above happens when my subcommand is configured to be required (through <em>not</em> configuring it as an Option&lt;T&gt;).</p>
<p>Question is: is there a way to have the functionality where:</p>
<ol>
<li>If you pass &quot;--about&quot; and NOT a subcommand, this is valid, and the program displays the about message.</li>
<li>If you pass a subcommand (and its' nested subcommands/args), this is valid, and the program will execute that subcommand functionality.</li>
<li>If you pass NOTHING, get the same error response you would get if the subcommand were required (like quoted above).</li>
</ol>
<p>Here's some code I'm using:</p>
<pre><code class="language-rust">[derive(Parser)]
#[command(about, version)]
#[command(
    arg_required_else_help = false,
    args_conflicts_with_subcommands = true,
)]
struct Cli {
    /// Print about
    #[arg(long, short)]
    about: bool,

    #[command(subcommand)]
    commands: CliCmds, // or `commands: Option&lt;CliCmds&gt;,` ???
}

#[derive(Subcommand)]
enum CliCmds {
    #[command(subcommand)]
    Manage(CliManageCmds),

    #[command(subcommand)]
    Track(CliTrackCmds),
}

/// Manage expense definitions
#[derive(Subcommand)]
#[command(arg_required_else_help = false)]
enum CliManageCmds {
    /// List existing expense definitions
    List,

    /// Search for existing expense definitions
    Search,

    /// Modify an existing expense definition
    Modify,

    /// Register a new expense definition
    Register,

    /// Archive an existing expense definition
    Archive,
}

/// Track defined expenses
#[derive(Subcommand, Debug)]
#[command(arg_required_else_help = false)]
enum CliTrackCmds {
    /// Mark an expense as staged to be paid
    Staged,

    /// Mark an expense as deferred (until a future pay period)
    Deferred,

    /// Mark an expense as paid (either fully or partially)
    Paid,
}
</code></pre>
<p>In summary, when I make my top-level commands required (&quot;commands: CliCmds&quot;), I can't use the &quot;--about&quot; top-level flag. But when I make those subcommands optional (&quot;command: Option&lt;CliCmds&gt;&quot;), then I can use the flag, but the helpful error doesn't display (when neither &quot;--about&quot; nor a subcommand is passed).</div></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">M-breaking-change</span> added by @epage on 2024-02-19 19:10</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">A-parsing</span> added by @epage on 2024-02-19 19:10</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "Optional flag at top-level conflicts with required top-level subcommands" to "`args_conflicts_with_subcommands` is not overriding `subcommand_required = true`" by @epage on 2024-02-19 19:11</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2024-02-19 19:13</div>
            <div class="timeline-body"><p>This is the other half of #3974  / #3940.  We considered that a breaking change and, out of a preponderance of caution, I'm taking that as a default stance here as well.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">E-easy</span> added by @epage on 2024-02-19 19:13</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:49:18 UTC
    </footer>
</body>
</html>
