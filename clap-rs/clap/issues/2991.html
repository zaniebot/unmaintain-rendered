<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Derive attribute that specializes a user-provided function that gets to modify `Arg` - clap-rs/clap #2991</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Derive attribute that specializes a user-provided function that gets to modify <code>Arg</code></h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/clap-rs/clap/issues/2991">#2991</a>
        opened by <a href="https://github.com/marjakm">@marjakm</a>
        on 2021-11-04 21:24
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/marjakm">@marjakm</a> on 2021-11-04 21:24</div>
            <div class="timeline-body"><h3>Please complete the following tasks</h3>
<ul>
<li>[X] I have searched the <a href="https://github.com/clap-rs/clap/discussions">discussions</a></li>
<li>[X] I have searched the existing issues</li>
</ul>
<h3>Clap Version</h3>
<p>master  879dd23963f6ed968535d6ed7bc6f192f02a0a16</p>
<h3>Describe your use case</h3>
<p>I have a bunch of messages defined in protobuf, I'd like to make a CLI to send those messages - <code>clap</code> should be able to parse the messages from terminal. I generate rust structs from protobuf definitions using <a href="https://crates.io/crates/prost">prost</a> and I can automatically add <code>clap_derive</code> attributes, but I can't specify the attributes flexibly enough to solve my use-case.</p>
<p>Problematic cases are when one struct contains another optional struct:</p>
<pre><code class="language-rust">struct A {
   simple: u32,
   inner: Option&lt;B&gt;
}

struct B {
   a: u32,
   b: String,
}
</code></pre>
<p>When automatically adding attributes, I can differentiate between protobuf native (u32, bool, ..) types and complex types (another struct), but I don't know if the complex type is <code>Option&lt;B&gt;</code> or <code>Option&lt;C&gt;</code>.</p>
<p>What I want is to parse these complex types (for example <code>A::inner</code>) from from json string from the command line. The default value in this case should be None (empty string), which is simple enough to implement currently. But, I'd also like to generate an example json value for the Some case in the CLI help. But what annotation can I add to the field <code>A::inner</code>, where I only know that its a optional struct, but don't know which struct type (B or C) it actually is?</p>
<p>Its really easy for me to write a function to generate the string:</p>
<pre><code class="language-rust">fn example_json&lt;T: serde::Serialize&gt;(t: T) -&gt; &amp;'static str { todo!() } 
</code></pre>
<p>All I'd need to have some attribute in <code>clap_derive</code> to call that function and I don't need to know which type is <code>A::inner</code></p>
<pre><code class="language-rust">#[derive(clap::Parser)]
struct A {
   simple: u32,
   #[clap(about = example_json]
   inner: Option&lt;B&gt;
}
</code></pre>
<p>which should call something like this in the right place:</p>
<pre><code class="language-rust">Arg::about(arg, example_json::&lt;Option&lt;B&gt;&gt;())
</code></pre>
<p><code>default_value_t</code> attribute actually does exactly the type-based fn specialization - I'd just like to be able to provide the generic fn and have it specialized by the field type.</p>
<h3>Describe the solution you'd like</h3>
<p>I implemented something that would solve my problems here:</p>
<p>https://github.com/clap-rs/clap/pull/2990</p>
<h3>Alternatives, if applicable</h3>
<p><em>No response</em></p>
<h3>Additional Context</h3>
<p>Conversation started on #2813</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">T: new feature</span> added by @marjakm on 2021-11-04 21:24</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/2990.html">clap-rs/clap#2990</a> on 2021-11-04 21:25</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2021-11-04 21:39</div>
            <div class="timeline-body"><p>Thank you! This context helps a lot!</p>
<p>So you are wanting to determine the value for an attribute based on the type of the field it is applied to, with the example being given of dynamically generating <code>about</code>, instead of manually doing it, to help with your code-gen use case.</p>
<p>This seems quite specialized.  The first question to answer is if this is needed and then the second is how.</p>
<p>A key part stuck out in your comment</p>
<blockquote>
<p>I don't know if the complex type is <code>Option&lt;B&gt;</code> or <code>Option&lt;C&gt;</code>.</p>
</blockquote>
<p>This is what is leading you to wanting to defer to clap to generate this information.  Could you help me understand this problem a little more?  I'm wanting to learn more about how this clap struct generation is happening to see how all of this fits together and if there is a better, more general solution here.</p>
<p>If we do move forward with this,  <code>clap::Arg::modify_fn</code>  doesn't quite make sense on its own, only in the context of <code>clap_derive</code>.  I wonder if we can instead do this purely within <code>clap_derive</code>.</p>
<p>Its also unclear how https://github.com/clap-rs/clap/issues/2683 might impact any API design on <code>clap</code> in the future.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../epage/clapng/issues/233.html">epage/clapng#233</a> on 2021-12-06 22:23</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">T: new feature</span> removed by @epage on 2021-12-08 21:08</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">C-enhancement</span> added by @epage on 2021-12-08 21:08</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">A-derive</span> added by @epage on 2021-12-13 22:10</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">S-waiting-on-author</span> added by @epage on 2021-12-13 22:10</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2022-01-11 18:49</div>
            <div class="timeline-body"><p>At this time, this seems too specialized.  Going to close in this in favor of other options helping in the future, like #2683</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @epage on 2022-01-11 18:49</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">S-waiting-on-author</span> removed by @epage on 2022-01-11 18:49</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">S-wont-fix</span> added by @epage on 2022-01-11 18:49</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 12:31:45 UTC
    </footer>
</body>
</html>
