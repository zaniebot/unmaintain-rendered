```yaml
number: 5986
title: Bash completion offers subcommand suggestions ahead of time
type: issue
state: closed
author: mernen
labels:
  - C-bug
  - E-hard
  - A-completion
assignees: []
created_at: 2025-05-05T21:30:24Z
updated_at: 2025-05-06T15:57:37Z
url: https://github.com/clap-rs/clap/issues/5986
synced_at: 2026-01-10T01:57:49Z
```

# Bash completion offers subcommand suggestions ahead of time

---

_Issue opened by @mernen on 2025-05-05 21:30_

### Please complete the following tasks

- [x] I have searched the [discussions](https://github.com/clap-rs/clap/discussions)
- [x] I have searched the [open](https://github.com/clap-rs/clap/issues) and [rejected](https://github.com/clap-rs/clap/issues?q=is%3Aissue+label%3AS-wont-fix+is%3Aclosed) issues

### Rust Version

rustc 1.86.0 (05f9846f8 2025-03-31)

### Clap Version

v4.5.48

### Minimal reproducible code

```rust
use clap::{CommandFactory, Parser, Subcommand};
use clap_complete::{CompleteEnv, Shell};

#[derive(Parser)]
#[command(version, about, long_about = None)]
struct Cli {
    #[command(subcommand)]
    action: Action,
}

#[derive(Subcommand)]
enum Action {
    Complete(CompleteArgs),
}

#[derive(Parser)]
struct CompleteArgs {
    /// The shell to generate completion for
    #[arg(long, value_enum)]
    shell: Shell,
}

fn main() {
    CompleteEnv::with_factory(Cli::command).complete();

    let cli = Cli::parse();

    match cli.action {
        Action::Complete(args) => {
            let mut cmd = Cli::command();
            let name = cmd.get_name().to_string();
            clap_complete::generate(args.shell, &mut cmd, name, &mut std::io::stdout());
        }
    }
}
```


### Steps to reproduce the bug with the above code

1. Use Bash
2. `source <(cargo run -- complete --shell bash)`
3. Type `<app-name> -- complete` in the shell (don't run it)
4. Position caret immediately after `--` and press Tab twice

### Actual Behaviour

Suggestions:

    --shell  --help   

`--shell` is only valid *after* `complete`, so it shouldn't be an option.

### Expected Behaviour

Only global flags should be available in this position:

    --help     --version  


### Additional Context

This also applies to nested subcommands. For example, for [`exhaustive`](https://github.com/clap-rs/clap/blob/v4.5.37/clap_complete/examples/exhaustive.rs), `exhaustive â‡¥ pacman` would suggest `one`, `two` and `help`, which are subcommands of `pacman`.

The fix is to only consider `$COMP_WORDS` that come before `$COMP_CWORD`. This does not affect dynamic completion.

### Debug Output

_No response_

---

_Label `C-bug` added by @mernen on 2025-05-05 21:30_

---

_Referenced in [clap-rs/clap#5987](../../clap-rs/clap/pulls/5987.md) on 2025-05-05 21:42_

---

_Label `A-completion` added by @epage on 2025-05-05 21:42_

---

_Label `E-hard` added by @epage on 2025-05-05 21:43_

---

_Closed by @epage on 2025-05-06 15:57_

---
