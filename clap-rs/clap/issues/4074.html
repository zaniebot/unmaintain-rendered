<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Implement convenient helper methods for `PathBufValueParser` to reduce boilerplate - clap-rs/clap #4074</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Implement convenient helper methods for <code>PathBufValueParser</code> to reduce boilerplate</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/clap-rs/clap/issues/4074">#4074</a>
        opened by <a href="https://github.com/SupImDos">@SupImDos</a>
        on 2022-08-13 15:45
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/SupImDos">@SupImDos</a></div>
            <div class="timeline-body">Please complete the following tasks
<ul>
<li>[X] I have searched the <a href="https://github.com/clap-rs/clap/discussions">discussions</a></li>
<li>[X] I have searched the <a href="https://github.com/clap-rs/clap/issues">open</a> and <a href="https://github.com/clap-rs/clap/issues?q=is%3Aissue+label%3AS-wont-fix+is%3Aclosed">rejected</a> issues</li>
</ul>
Clap Version
<p>3.2.17</p>
Describe your use case
Summary
<p>Popular command-line argument parser libraries for other languages implement validation helpers for paths for more convenient and terse CLI construction.</p>
Example
<p>For example, Python&#x27;s <a href="https://github.com/pallets/click"><code>click</code></a> provides a <a href="https://click.palletsprojects.com/en/8.1.x/api/?highlight=click%20path#click.Path"><code>click.Path</code></a> type for validation, with which you can do things like:</p>
<pre><code>click.Path(exists=True, file_okay=True, dir_okay=False, writable=False, readable=True)
</code></pre>
Why?
<p>This would allow for a reduction of boilerplate for common use-cases (i.e., existing files, existing directories, etc), and ultimately provide a more friendly and convenient &quot;batteries-included&quot; developer experience.</p>
TOCTOU?
<p>The TOCTOU issue will still be present for the validated paths, but in my opinion this enhancement would still allow for a more convenient &quot;fail-fast&quot; approach for CLI applications.</p>
Describe the solution you&#x27;d like
Existing Helpers
<p>The existing integer value parsers appear to already provide a <a href="https://github.com/clap-rs/clap/blob/v3.2.17/src/builder/value_parser.rs#L1103"><code>.range(x..y)</code></a> helper method to simplify parsing of narrowed integer ranges.</p>
<p>This allows for usage such as (as per the <a href="https://docs.rs/clap/latest/clap/_derive/_tutorial/index.html#validated-values">tutorial</a>):</p>
<pre><code>#[derive(Parser)]
#[clap(author, version, about, long_about = None)]
struct Cli {
    /// Network port to use
    #[clap(value_parser = clap::value_parser!(u16).range(1..))]
    port: u16,
}
</code></pre>
Possible Solution
<p>I would like similar helper methods for <em>other</em> types, in this case specifically the <a href="https://github.com/clap-rs/clap/blob/v3.2.17/src/builder/value_parser.rs#L768"><code>PathBufValueParser</code></a>.</p>
<p>For example, this could allow usage such as the follows (exact form up for discussion):</p>
<pre><code>#[derive(Parser)]
#[clap(author, version, about, long_about = None)]
struct Cli {
    /// Example 1: existing file only
    #[clap(value_parser = clap::value_parser!(PathBuf).exists(PathType::File)]
    file: PathBuf,

    /// Example 2: existing directory only
    #[clap(value_parser = clap::value_parser!(PathBuf).exists(PathType::Dir)]
    dir: PathBuf,

    /// Example 3: existing file or directory
    #[clap(value_parser = clap::value_parser!(PathBuf).exists(PathType::FileOrDir)]
    file_or_dir: PathBuf,
}
</code></pre>
Future Scope
<p>There are other less common use cases - such as checking for readability and writability, or checking that a file/directory does <em>not</em> currently exist - that could also be implemented (possibly with more enums, or method chaining?).</p>
<p>For example:</p>
<pre><code>/// Example: Possible method chaining approach
clap::value_parser!(PathBuf).exists(PathType::File).permissions(Permissions::Read)
</code></pre>
Alternatives, if applicable
<p><em>No response</em></p>
Additional Context
<p><em>No response</em></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">C-enhancement</span> added by <a href="https://github.com/SupImDos">@SupImDos</a> on 2022-08-13 15:45</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">A-builder</span> added by <a href="https://github.com/epage">@epage</a> on 2022-08-13 17:04</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">S-waiting-on-design</span> added by <a href="https://github.com/epage">@epage</a> on 2022-08-13 17:04</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2022-08-14 02:57</div>
            <div class="timeline-body"><p>Huh, I don&#x27;t think I ever created an issue for this but I had designed this with click&#x27;s features in mind.  Specifically, we have <code>ValueParserFactory</code> which will let us define field types that you can just put in your struct and clap will then automatically do the right thing, including</p>
<ul>
<li><code>FileReader</code><ul>
<li>Eagerly opens the file</li>
<li>Supports <code>-</code></li>
</ul>
</li>
<li><code>FileWriter</code><ul>
<li>Lazily opens the file</li>
<li>Supports <code>-</code></li>
<li>Option to do atomic writes (default?)</li>
<li>Eagerly error if parent directory doesn&#x27;t exist (maybe an option to create it instead?)</li>
</ul>
</li>
</ul>
<p>Also supporting customization on <code>Path</code> would be useful.</p>
<p>To allow extra dependencies to be pulled in and for faster iteration, we might start this off in a <code>clap_fs</code> crate</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2022-09-09 19:24</div>
            <div class="timeline-body"><p>Something I saw that is important to keep in mind for <code>-</code> support from <a href="https://clig.dev/#help">clig.dev</a></p>
<blockquote>
<p>If your command is expecting to have something piped to it and stdin is an interactive terminal, display help immediately and quit. This means it doesnâ€™t just hang, like cat. Alternatively, you could print a log message to stderr.</p>
</blockquote>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a>pacak/bpaf#61</a> on 2022-09-16 16:51</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">S-waiting-on-design</span> removed by <a href="https://github.com/epage">@epage</a> on 2022-09-20 14:44</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">E-easy</span> added by <a href="https://github.com/epage">@epage</a> on 2022-09-20 14:44</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">:money_with_wings: $5</span> added by <a href="https://github.com/epage">@epage</a> on 2022-09-20 14:44</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">E-help-wanted</span> added by <a href="https://github.com/epage">@epage</a> on 2022-09-20 14:44</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a>clap-rs/clap#4564</a> on 2022-12-20 02:50</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a>clap-rs/clap#4643</a> on 2023-01-16 16:46</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a>clap-rs/clap#4686</a> on 2023-01-30 04:34</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/max-sixty">@max-sixty</a> on 2023-06-09 03:11</div>
            <div class="timeline-body"><p>IIUC, it&#x27;s worth checking out https://github.com/aj-bagwell/clio, which does some of these...</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a>aj-bagwell/clio#11</a> on 2023-06-09 14:50</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2023-06-09 14:57</div>
            <div class="timeline-body"><p>Thanks for letting us know of that!</p>
<p>I&#x27;ve created</p>
<ul>
<li>aj-bagwell/clio#12</li>
<li>aj-bagwell/clio#11</li>
</ul>
<p>which I <em>think</em> would bring it to parity with clap</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/aj-bagwell">@aj-bagwell</a> on 2023-06-21 09:20</div>
            <div class="timeline-body"><p>Thanks for the great ideas and opening the issues. I have implemented most of them.</p>
<a href="https://docs.rs/clio/latest/clio/clapers/struct.OsStrParser.html">parser/validator</a>
<p>I have added a bunch of validation options to <a href="https://docs.rs/clio/latest/clio/clapers/struct.OsStrParser.html">parser/validator</a></p>
<p>There is also <a href="https://docs.rs/clio/latest/clio/struct.InputPath.html"><code>InputPath</code></a> which require the path to exist and be a readable file, and <a href="https://docs.rs/clio/latest/clio/struct.OutputPath.html"><code>OutputPath</code></a> which requres the parent directory to exist and the file to be writeable if it exists.</p>
<pre><code>#[derive(Parser)]
#[clap(author, version, about, long_about = None)]
struct Cli {
    /// Example 1: existing file or pipe only, must not be interactive tty
    #[clap(value_parser = clap::value_parser!(PathBuf).exists().is_file().not_tty())]
    file: ClioPath,

    /// Example 2: existing directory only
    #[clap(value_parser = clap::value_parser!(PathBuf).exists().is_dir()]
    dir: PathBuf,

    /// Example 3: existing file or directory
    #[clap(value_parser = clap::value_parser!(PathBuf).exists()]
    file_or_dir: PathBuf,
}
</code></pre>
<a href="https://docs.rs/clio/latest/clio/struct.Input.html">Input</a>
<ul>
<li>Eagerly opens the file</li>
<li>Supports <code>-</code></li>
<li>has <a href="https://docs.rs/clio/latest/clio/struct.Input.html#method.is_tty"><code>is_tty</code></a> method to check for interactive terminals</li>
</ul>
<pre><code>#[derive(Parser)]
struct Cli {
    /// must be existing readable file, default to stdin
    #[clap(value_parser, default = &quot;-&quot;)]
    input: Input,
}
</code></pre>
<a href="https://docs.rs/clio/latest/clio/struct.OutputPath.html">OutputPath</a>
<ul>
<li>Defers opening/creating the file</li>
<li>Supports <code>-</code></li>
<li>Option to do <a href="https://docs.rs/clio/0.3.2/clio/clapers/struct.OsStrParser.html#method.atomic">atomic</a> writes (not default)</li>
<li>Eagerly error if parent directory doesn&#x27;t exist</li>
<li>has <a href="https://docs.rs/clio/latest/clio/struct.OutputPath.html#method.is_tty"><code>is_tty</code></a> method to check for interactive terminals</li>
</ul>
<pre><code>#[derive(Parser)]
struct Cli {
    /// If path is a directory output will be file with default name in that directory, must not be interactive tty
    /// if the file exists it must be writeable
    #[clap(value_parser = clap::value_parser!(OutputPath).not_tty().default_name(&quot;out.log&quot;), default = &quot;-&quot;)]
    output: OutputPath,
}

fn main() -&gt; Result&lt;()&gt; {
    let mut cli = Cli::parse();
    if cli.output.is_tty() {
        // enable colors, or show an error or whatever
    }
    cli.output.create()?
}
</code></pre>
<a href="https://docs.rs/clio/latest/clio/struct.Output.html">Output</a>
<ul>
<li>Eagerly opens/creats the file (but using <a href="https://docs.rs/clio/0.3.2/clio/clapers/struct.OsStrParser.html#method.atomic">atomic</a> will mean it will clean up any partialy written files on exit)</li>
<li>Supports <code>-</code></li>
<li>Option to do <a href="https://docs.rs/clio/0.3.2/clio/clapers/struct.OsStrParser.html#method.atomic">atomic</a> writes (not default)</li>
<li>has <a href="https://docs.rs/clio/latest/clio/struct.OutputPath.html#method.is_tty"><code>is_tty</code></a> method to check for interactive terminals</li>
</ul>
<pre><code>#[derive(Parser)]
struct Cli {
    /// Atomic output using tempfile and atomic rename.
    #[clap(value_parser = clap::value_parser!(Output).atomic().default_name(&quot;out.log&quot;), default = &quot;-&quot;)]
    output: Output,
}
</code></pre>
<p>Pull requests to clio are always welcome, or if this looks useful enough to get pulled into clap proper that would be excelent too.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2023-06-23 17:59</div>
            <div class="timeline-body"><p>clap v4.3.6 is released which sugests using clio.</p>
<p>I&#x27;d love to hear people&#x27;s thoughts on it over time to decide where to go from here.</p>
<p>Personally, I would lean towards this being kept as a separate crate so we have more flexibility regarding the implementation.  If anything (and with the author&#x27;s go ahead), I could see it being renamed to <code>clap_io</code> / <code>clap_fs</code> and moved into the clap repo or at least <code>clap-rs</code> org once we feel comfortable with it.</p>
<p>Personally, I&#x27;d prefer not to have HTTP support.  imo arguments that accept URLs should explicitly opt-in, at minimum.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/aj-bagwell">@aj-bagwell</a> on 2023-06-24 11:50</div>
            <div class="timeline-body"><p>Thank you for the official recommendation @epage!</p>
<p>I agree that HTTP support should be opt in which is why it is behind a feature that is off by default. For most uses piping via curl is a better choice. I added it because I needed to stream to S3 which needs to be told the content size when starting the upload, also knowing the size of the input turned out to give nicer progress bars.</p>
<p>If enough people show interest and want to help work on it then we can look into moving the code into the clap-rs.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2023-06-26 14:20</div>
            <div class="timeline-body"><blockquote>
<p>I agree that HTTP support should be opt in which is why it is behind a feature that is off by default. For most uses piping via curl is a better choice. I added it because I needed to stream to S3 which needs to be told the content size when starting the upload, also knowing the size of the input turned out to give nicer progress bars.</p>
</blockquote>
<p>What I mean is it should be opt-in on a per-argument basis rather than on an application level basis with feature flags</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a>paritytech/polkadot-sdk#1641</a> on 2024-11-18 11:03</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:59:13 UTC
    </footer>
</body>
</html>
