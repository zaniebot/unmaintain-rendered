<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3.0.0 beta: proc-macro derive panicked - clap-rs/clap #1574</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>3.0.0 beta: proc-macro derive panicked</h1>

    <div class="meta">
        <span class="state state-closed">Closed</span>
        <a href="https://github.com/clap-rs/clap/issues/1574">#1574</a>
        opened by <a href="https://github.com/Walther">@Walther</a>
        on 2019-10-17 22:03
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/Walther">@Walther</a> on 2019-10-17 22:03</div>
            <div class="timeline-body"><!--
Please use the following template to assist with creating an issue and to ensure a speedy resolution. If an area is not applicable, feel free to delete the area or mark with `N/A`
-->

<h3>Rust Version</h3>
<p><code>rustc 1.38.0 (625451e37 2019-09-23)</code></p>
<h3>Affected Version of clap</h3>
<pre><code>[[package]]
name = &quot;clap&quot;
version = &quot;3.0.0-beta.1&quot;
source = &quot;git+https://github.com/clap-rs/clap#b8819130de876c4abbd451c34df89161a98d23ef&quot;
</code></pre>
<h3>Expected Behavior Summary</h3>
<p><code>#[derive(Clap, Debug)]</code> and <code>#[clap()]</code> macros should work</p>
<h3>Actual Behavior Summary</h3>
<p><code>proc-macro derive panicked</code>. Screenshots help here for showing how it varies when commenting out macros; it seems to fail in different ones too.</p>
<img width="841" alt="Screen Shot 2019-10-18 at 00 56 57" src="https://user-images.githubusercontent.com/2943750/67050944-6ec43a00-f142-11e9-8e26-c81307aada0d.png">
<img width="828" alt="Screen Shot 2019-10-18 at 00 57 07" src="https://user-images.githubusercontent.com/2943750/67050945-6ec43a00-f142-11e9-9815-1720cbf4636b.png">

<h3>Steps to Reproduce the issue</h3>
<ol>
<li>Use <code>clap</code> from git master</li>
<li>Follow the instructions in readme; use <code>#[derive(Clap, Debug)]</code> and <code>#[clap()]</code> macros</li>
<li>Observe compile errors from <code>rustc</code></li>
</ol>
<h3>Sample Code or Link to Sample Code</h3>
<p>Tiny pet project pull request here for upgrading to <code>clap</code> 3.0.0 here, with a very minimal reproduction of the issue: https://github.com/Walther/wordcrab/pull/1</p>
<h3>Debug output</h3>
<details>
<summary> Debug Output </summary>
<pre>
<code>

<p>cargo build --verbose
Fresh unicode-xid v0.1.0
Fresh unicode-width v0.1.6
Fresh strsim v0.9.2
Fresh indexmap v1.2.0
Fresh ansi_term v0.11.0
Fresh vec_map v0.8.1
Fresh itoa v0.4.4
Fresh textwrap v0.11.0
Fresh proc-macro2 v0.4.30
Fresh libc v0.2.64
Fresh bitflags v1.2.1
Fresh ryu v1.0.2
Fresh serde v1.0.101
Fresh quote v0.6.13
Fresh atty v0.2.13
Fresh serde_json v1.0.41
Fresh syn v0.15.44
Fresh clap_derive v0.3.0 (https://github.com/clap-rs/clap_derive#4a46684b)
Fresh clap v3.0.0-beta.1 (https://github.com/clap-rs/clap#b8819130)
Compiling wordcrab v0.2.1 (/Users/veeti/git/wordcrab)
Running <code>rustc --edition=2018 --crate-name wordcrab src/main.rs --color always --crate-type bin --emit=dep-info,link -C debuginfo=2 -C metadata=94f2349a0e5cbdc7 -C extra-filename=-94f2349a0e5cbdc7 --out-dir /Users/veeti/git/wordcrab/target/debug/deps -C incremental=/Users/veeti/git/wordcrab/target/debug/incremental -L dependency=/Users/veeti/git/wordcrab/target/debug/deps --extern clap=/Users/veeti/git/wordcrab/target/debug/deps/libclap-5caa4c477358f1f8.rlib --extern serde=/Users/veeti/git/wordcrab/target/debug/deps/libserde-e483c8ba7a1e6576.rlib --extern serde_json=/Users/veeti/git/wordcrab/target/debug/deps/libserde_json-098c2405408937ce.rlib</code>
error: proc-macro derive panicked
--&gt; src/main.rs:9:10
|
9 | #[derive(Clap, Debug)]
|          ^^^^
|
= help: message: unsupported option: short</p>
<p>error: aborting due to previous error</p>
<p>error: Could not compile <code>wordcrab</code>.</p>
<p>Caused by:
process didn't exit successfully: <code>rustc --edition=2018 --crate-name wordcrab src/main.rs --color always --crate-type bin --emit=dep-info,link -C debuginfo=2 -C metadata=94f2349a0e5cbdc7 -C extra-filename=-94f2349a0e5cbdc7 --out-dir /Users/veeti/git/wordcrab/target/debug/deps -C incremental=/Users/veeti/git/wordcrab/target/debug/incremental -L dependency=/Users/veeti/git/wordcrab/target/debug/deps --extern clap=/Users/veeti/git/wordcrab/target/debug/deps/libclap-5caa4c477358f1f8.rlib --extern serde=/Users/veeti/git/wordcrab/target/debug/deps/libserde-e483c8ba7a1e6576.rlib --extern serde_json=/Users/veeti/git/wordcrab/target/debug/deps/libserde_json-098c2405408937ce.rlib</code> (exit code: 1)</p>
</code>
</pre>
</details>

</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Walther">@Walther</a> on 2019-10-17 22:23</div>
            <div class="timeline-body"><p>On a quick search through the codebase, I don't think I found any tests that are using either of the macros? Only mentions of the macros are in the Readme:
<img width="960" alt="Screen Shot 2019-10-18 at 01 22 53" src="https://user-images.githubusercontent.com/2943750/67052097-d760e600-f145-11e9-99b4-4dc63191da48.png"></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Dylan-DPC-zz">@Dylan-DPC-zz</a> on 2019-10-17 22:25</div>
            <div class="timeline-body"><p>The macros are declared in clap_derive crate so you can check there</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Walther">@Walther</a> on 2019-10-17 22:26</div>
            <div class="timeline-body"><p>Ah, this issue would probably belong into that repo then ü§î  Sorry about that!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Walther">@Walther</a> on 2019-10-17 22:45</div>
            <div class="timeline-body"><p>Found some more leads: I was trying to use this deduced-form, from structopt documentation: <a href="https://docs.rs/structopt/0.3.3/structopt/">https://docs.rs/structopt/0.3.3/structopt/</a></p>
<pre><code>// short and long flags (-d, --debug) will be deduced from the field's name
    #[structopt(short, long)]
</code></pre>
<p>whereas <code>clap_derive</code> tests and Readme only uses the explicit form <code>short = &quot;x&quot;</code>. Converting all of those uses is fairly easy, not sure if clap 3 intends to offer the deduced short form from structopt.</p>
<hr />
<p>Another lead: through reduction,I noticed <code>possible_values = &amp;[&quot;text&quot;, &quot;json&quot;]</code> within a <code>#[clap()</code> macro also makes it fail. Ditto for <code>global_settings = &amp;[AppSettings::ColoredHelp]</code>.</p>
<p>Removing those two and converting all the short,long uses into explicit form makes it work again.</p>
<p>Pushed an additional commit to my example PR to show the required changes. https://github.com/Walther/wordcrab/pull/1/commits/7a676569e9da447e7ea734062cf6c12172e5fe43</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/CreepySkeleton">@CreepySkeleton</a> on 2019-10-18 15:15</div>
            <div class="timeline-body"><p>@Walther please, don't look at <code>structopt</code>'s docs when dealing with <code>clap_derive</code>. <code>clap_derive</code> is essentially a year-old <code>structopt</code>, more importantly,  in utilizes <code>structopt v0.2.x</code>. <code>structopt v0.3</code> (current) is not backward compatible with <code>v0.2</code>.</p>
<p>@Dylan-DPC what are the plan for <code>clap_derive</code> release? Are you going to continue using <code>v0.2</code>? I this case we will end up with situation when we have an &quot;official&quot; derive (<code>clap_derive</code>) and &quot;third-party&quot; derive (<code>structopt</code>), worst part, incompatible. I would really love to evade this situation. Any thoughts?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Dylan-DPC-zz">@Dylan-DPC-zz</a> on 2019-10-18 17:49</div>
            <div class="timeline-body"><p>@CreepySkeleton</p>
<blockquote>
<p>Are you going to continue using v0.2?
I didn't get this part.</p>
</blockquote>
<p>Also clap-derive is just coincidentally compatible with structopt. This isn't a guarantee and both could diverge at any time in the future.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/CreepySkeleton">@CreepySkeleton</a> on 2019-10-18 18:40</div>
            <div class="timeline-body"><blockquote>
<p>I didn't get this part.</p>
</blockquote>
<p>@Dylan-DPC I mean, <code>clap-derive</code> was started as a <code>structopt 0.2</code>'s fork, even now its codebase is very very similar to <code>structopt</code>'s. I thought (and still think) the intention was to make a &quot;better&quot; structopt, more closely tied to <code>clap</code> and offer some additional features. Even in the readme you mention that derive_clap is essentially an import and, eventually, replacement for structopt, but for now this is simply not true.</p>
<p><code>structopt</code> has released a new minor version, which is, in my opinion, a big improvement, it offers a number of additional features <code>clap-derive</code> lacks (not to mention bug fixes). Also, community is moving to <code>0.3</code> version, see the <a href="https://crates.io/crates/structopt">downloads statistic</a>, so when <code>clap-derive</code> will be eventually released, community is going to have a hard time adapting their codebase to <code>clap-derive</code>. Or, more likely, they'll just stay with <code>structopt</code>, because <code>clap-derive</code> doesn't really offer anything that one can't have with <code>structopt</code>.</p>
<p>That said, I propose to meld the <strong>current</strong> <code>structopt</code> into <code>clap_derive</code> thus having new features/bugfixes in the clap itself and make them more-or-less compatible so people could migrate with not much effort.</p>
<blockquote>
<p>Also clap-derive is just coincidentally compatible with structopt. This isn't a guarantee and both could diverge at any time in the future.</p>
</blockquote>
<p>Quoting the readme:
&quot;Since structopt already used clap under the hood, the transition was nearly painless, and is 100% feature compatible.&quot;</p>
<p>Who's to believe? :smile:</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Walther">@Walther</a> on 2019-10-19 11:01</div>
            <div class="timeline-body"><p>What would be the ideal end result? Can I help in getting towards that direction? üôÇ</p>
<p>Additionally, is is possible to somehow improve the error messages of the proc macro failures, or is there some technical limitation in how they work?</p>
<p>I understand now that fundamentally, this issue was caused by trying to use structopt 0.3 features in clap 3.0 beta, and some of the features and uses not aligning. Took a bit of figuring out though, as the proc macros did not provide in-editor hints about existing properties or specific error messages.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/CreepySkeleton">@CreepySkeleton</a> on 2019-10-19 11:09</div>
            <div class="timeline-body"><blockquote>
<p>Additionally, is is possible to somehow improve the error messages of the proc macro failures, or is there some technical limitation in how they work?</p>
</blockquote>
<p>This is done in <a href="https://github.com/TeXitoi/structopt/blob/master/CHANGELOG.md#significantly-improve-error-reporting-by-creepyskeleton-225"><code>structopt v0.3</code></a> as one of the new features I was talking about. That's why I'm trying to encourage people to move for v0.3 - most of the asked improvements are already done in the new structopt.</p>
<blockquote>
<p>Took a bit of figuring out though, as the proc macros did not provide in-editor hints about existing properties or specific error messages.</p>
</blockquote>
<p>If you think that some error message in <code>structopt</code> isn't clear enough or points to a wrong location - please <a href="https://github.com/TeXitoi/structopt/issues">file an issue</a>.</p>
<blockquote>
<p>What would be the ideal end result?</p>
</blockquote>
<p>IMHO: the ideal result would be merging the latest <code>structopt</code> into <code>clap_derive</code> and deprecating <code>structopt</code> entirely.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/1584.html">clap-rs/clap#1584</a> on 2019-10-25 11:39</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/pksunkara">@pksunkara</a> on 2020-01-18 15:43</div>
            <div class="timeline-body"><p>This has been fixed with the recent import of structopt into clap_derive. But it still doesn't solve the issue of structopt vs clap. I propose that either @CreepySkeleton or @TeXitoi make a plan to merge structopt into clap_derive and combine the efforts.</p>
<p>Does structopt support clap v3? Because clap_derive does</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/TeXitoi">@TeXitoi</a> on 2020-01-18 15:58</div>
            <div class="timeline-body"><p>Structopt is for clap 2, clap-derive for clap 3</p>
<p>18 janv. 2020 16:43:20 Pavan Kumar Sunkara <a href="mailto:notifications@github.com">notifications@github.com</a>:</p>
<blockquote>
<p>This has been fixed with the recent import of structopt into clap_derive. But it still doesn't solve the issue of structopt vs clap. I propose that either @CreepySkeleton [https://github.com/CreepySkeleton] or @TeXitoi [https://github.com/TeXitoi] make a plan to merge structopt into clap_derive and combine the efforts.</p>
<p>Does structopt support clap v3? Because clap_derive does</p>
<p>‚Äî
You are receiving this because you were mentioned.
Reply to this email directly, view it on GitHub [https://github.com/clap-rs/clap/issues/1574?email_source=notifications&amp;email_token=ABME3OUDQLGAUSJ6BUK4JHLQ6MPRNA5CNFSM4JB77IGKYY3PNVWWK3TUL52HS4DFVREXG43VMVBW63LNMVXHJKTDN5WW2ZLOORPWSZGOEJJ3BIA#issuecomment-575910048] , or unsubscribe [https://github.com/notifications/unsubscribe-auth/ABME3OV4CN7CX4LPG2L45L3Q6MPRNANCNFSM4JB77IGA] . [https://github.com/notifications/beacon/ABME3OSXA65EVP3CB6KKSDLQ6MPRNA5CNFSM4JB77IGKYY3PNVWWK3TUL52HS4DFVREXG43VMVBW63LNMVXHJKTDN5WW2ZLOORPWSZGOEJJ3BIA.gif]</p>
</blockquote>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/CreepySkeleton">@CreepySkeleton</a> on 2020-01-18 17:12</div>
            <div class="timeline-body"><h3>&quot;<code>clap_derive</code> release&quot; plan</h3>
<p>The first thing we need is to import all the &quot;not yet imported&quot; commits, including the two pending PRs.</p>
<p>Then we need to decide if we want to keep <code>no_version</code>, I believe it must be done before the &quot;beta&quot; release. I highly encourage you <strong>not to keep it</strong>. It doesn't work well, we've already got few bugs because of it, see <a href="https://github.com/TeXitoi/structopt/issues/243">this</a>, <a href="https://github.com/TeXitoi/structopt/issues/242">that</a>, and <a href="https://github.com/TeXitoi/structopt/issues/324">those</a> <a href="https://github.com/TeXitoi/structopt/issues/283">two</a> bug reports. All of them were fixed by <em>dirty hacks</em> in the code. Let's just replace it with explicit <code>#[clap(version)]</code> to be consistent with <code>#[clap(author, about)]</code>.</p>
<p>Once this is resolved, we're making the &quot;beta&quot; release (including on crates.io) to gather some early feedback (we may need some sort of announce for that). All the problems outlined <a href="https://rust-lang.zulipchat.com/#narrow/stream/220302-wg-cli/topic/clap-vs-structopt">there</a> will be resolved based on this feedback (except for the refactoring, we need it most certainly and desperately but I admit it can be postponed for a bit).</p>
<p>@Dylan-DPC any thoughts?</p>
<h3>&quot;After <code>clap_derive</code> release&quot; plan</h3>
<p>@TeXitoi and I had a short conversation about it and we came up with the following:</p>
<p>Once <code>clap_derive</code> is released, <code>structopt</code> will become &quot;softly deprecated&quot;. This means that both @TeXitoi and I will be continue maintaining it in &quot;passively maintained&quot; mode.</p>
<p>We will be merging bugfixes and the like but <code>structopt</code> will not receive future evolution. We will not be merging feature requests and neither we will work on our own ones. Such issues/PRs will be transferred to the <code>clap_derive</code> repository (or <code>clap</code>, whatever).</p>
<p>I may be interested in backporting certain features from <code>clap_derive</code> to <code>structopt</code> in the future on personal basis if the feature in question is a commonly requested one; but this won't be my priority and I don't guarantee anything.</p>
<p>I would like to empathize here that neither @TeXitoi nor I are interested in providing support for <code>clap v3</code> in structopt, <code>structopt</code> will stay on <code>clap v2.33</code>. We will not backport such requests, let's move forward, not backward.</p>
<p>@TeXitoi does it sound good to you?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/TeXitoi">@TeXitoi</a> on 2020-01-18 17:40</div>
            <div class="timeline-body"><p>Yup, I agree. I also recommend to remove the no_version thing. Also, There might have other breaking changes that might be wanted, that's the time to talk about that before the beta, or it will be too late.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/CreepySkeleton">@CreepySkeleton</a> on 2020-01-18 17:49</div>
            <div class="timeline-body"><p>Hmm, I thought &quot;beta&quot; release are not the &quot;final one&quot;, and the breaking changes are possible after it.</p>
<p>If not, we will also need to come to an agreement on &quot;multiple traits&quot; thing and <code>Parse</code> trait thing.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/pksunkara">@pksunkara</a> on 2020-01-18 17:50</div>
            <div class="timeline-body"><p>I am not a contributor to structopt but the plan sounds good to me.</p>
<p>Regarding breaking, I think as long as we haven't released the major version, it should be okay breaking things between pre releases. At least that's what I understand from Denver. Please correct me if I'm wrong.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/pksunkara">@pksunkara</a> on 2020-01-18 17:51</div>
            <div class="timeline-body"><p>I meant semver. Not Denver. :smile:</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/CreepySkeleton">@CreepySkeleton</a> on 2020-01-18 17:54</div>
            <div class="timeline-body"><p>Citing semver  (emphasis mine)</p>
<blockquote>
<p>A pre-release version MAY be denoted by appending a hyphen and a series of dot separated identifiers immediately following the patch version. Identifiers MUST comprise only ASCII alphanumerics and hyphen [0-9A-Za-z-]. Identifiers MUST NOT be empty. Numeric identifiers MUST NOT include leading zeroes. Pre-release versions have a lower precedence than the associated normal version. <strong>A pre-release version indicates that the version is unstable and might not satisfy the intended compatibility requirements as denoted by its associated normal version</strong>. Examples: 1.0.0-alpha, 1.0.0-alpha.1, 1.0.0-0.3.7, 1.0.0-x.7.z.92.</p>
</blockquote>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/TeXitoi">@TeXitoi</a> on 2020-01-18 17:54</div>
            <div class="timeline-body"><p>Even if that's true, breaking changes on beta should be more about fixing from feedback on the beta than continuing breaking because we're not yet fixed on what we think is good.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/CreepySkeleton">@CreepySkeleton</a> on 2020-01-18 17:55</div>
            <div class="timeline-body"><p>@TeXitoi good point üëç Let's settle this &quot;traits&quot; things up today.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/CreepySkeleton">@CreepySkeleton</a> on 2020-01-18 17:58</div>
            <div class="timeline-body"><p>Or tomorrow üòÑ</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Dylan-DPC-zz">@Dylan-DPC-zz</a> on 2020-01-18 18:35</div>
            <div class="timeline-body"><p>Okay a few things:</p>
<p>First, let's discuss release policies separately and not here.</p>
<blockquote>
<p>Let's just replace it with explicit #[clap(version)] to be consistent with #[clap(author, about)].</p>
</blockquote>
<p>@TeXitoi  agree with this</p>
<blockquote>
<p>Hmm, I thought &quot;beta&quot; release are not the &quot;final one&quot;, and the breaking changes are possible after it.</p>
</blockquote>
<p>Yes generally the design and the API remains the same and the (breaking) changes are for bug fixes and other things that were overlook rather than adding new features.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/CreepySkeleton">@CreepySkeleton</a> on 2020-02-01 11:29</div>
            <div class="timeline-body"><p>Fixed by <code>structopt</code>'s partial import.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @CreepySkeleton on 2020-02-01 11:29</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../mozilla/grcov/pulls/648.html">mozilla/grcov#648</a> on 2021-07-22 14:13</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../databendlabs/openraft/pulls/116.html">databendlabs/openraft#116</a> on 2022-01-16 15:05</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:35:07 UTC
    </footer>
</body>
</html>
