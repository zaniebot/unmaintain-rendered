<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[derive] Argument `test`'s selected action SetTrue contradicts `takes_value` - clap-rs/clap #5421</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[derive] Argument <code>test</code>'s selected action SetTrue contradicts <code>takes_value</code></h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/clap-rs/clap/issues/5421">#5421</a>
        opened by <a href="https://github.com/hasezoey">@hasezoey</a>
        on 2024-03-24 16:14
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/hasezoey">@hasezoey</a></div>
            <div class="timeline-body"><h3>Please complete the following tasks</h3>
<ul>
<li>[X] I have searched the <a href="https://github.com/clap-rs/clap/discussions">discussions</a></li>
<li>[X] I have searched the <a href="https://github.com/clap-rs/clap/issues">open</a> and <a href="https://github.com/clap-rs/clap/issues?q=is%3Aissue+label%3AS-wont-fix+is%3Aclosed">rejected</a> issues</li>
</ul>
<h3>Rust Version</h3>
<p>rustc 1.76.0 (07dca489a 2024-02-04)</p>
<h3>Clap Version</h3>
<p>4.5.3</p>
<h3>Minimal reproducible code</h3>
<pre><code class="language-rust">use clap::Parser;

#[derive(Parser, Debug)]
#[clap(name = &quot;testing&quot;)]
pub struct TestArg {
    #[arg(
        long = &quot;test&quot;,
        default_missing_value = &quot;true&quot;,
        num_args = 0..=1,
        require_equals = true,
    )]
    pub test: bool,
}

fn main() {
    let args = cli::TestArg::parse();

    println!(&quot;{:#?}&quot;, args);
}
</code></pre>
<h3>Steps to reproduce the bug with the above code</h3>
<p><code>cargo run -- --test=false</code></p>
<h3>Actual Behaviour</h3>
<p>Panic:</p>
<pre><code class="language-txt">thread 'main' panicked at /home/hasezoey/.local/cargo/registry/src/index.crates.io-6f17d22bba15001f/clap_builder-4.5.2/src/builder/debug_asserts.rs:708:9:
Argument `test`'s selected action SetTrue contradicts `takes_value
</code></pre>
<h3>Expected Behaviour</h3>
<p>No panic, as per documentation <a href="https://docs.rs/clap/latest/clap/struct.Arg.html#method.default_missing_value"><code>default_missing_value</code></a>.</p>
<h3>Additional Context</h3>
<p>i know that <code>default_missing_value</code> is currently not documented in <a href="https://docs.rs/clap/latest/clap/_derive/index.html#arg-attributes">derive attributes</a>, but i thought it would work anyway.</p>
<p>in case it is not clear, i am trying to do the following without problems:</p>
<pre><code class="language-txt">cargo run --  # test = false
cargo run --  --test # test = true
cargo run --  --test=true # test = true
cargo run --  --test=false # test = false
</code></pre>
<h3>Debug Output</h3>
<pre><code class="language-txt">[clap_builder::builder::command]Command::_do_parse
[clap_builder::builder::command]Command::_build: name=&quot;testing&quot;
[clap_builder::builder::command]Command::_propagate:testing
[clap_builder::builder::command]Command::_check_help_and_version:testing expand_help_tree=false
[clap_builder::builder::command]Command::long_help_exists
[clap_builder::builder::command]Command::_check_help_and_version: Building default --help
[clap_builder::builder::command]Command::_propagate_global_args:testing
[clap_builder::builder::debug_asserts]Command::_debug_asserts
[clap_builder::builder::debug_asserts]Arg::_debug_asserts:test
thread 'main' panicked at /home/hasezoey/.local/cargo/registry/src/index.crates.io-6f17d22bba15001f/clap_builder-4.5.2/src/builder/debug_asserts.rs:708:9:
Argument `test`'s selected action SetTrue contradicts `takes_value`

</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">C-bug</span> added by @hasezoey on 2024-03-24 16:14</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../tramhao/termusic/pulls/265.html">tramhao/termusic#265</a> on 2024-03-24 16:20</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2024-03-25 15:22</div>
            <div class="timeline-body"><p>There are attributes that are implied by the data type, see https://docs.rs/clap/latest/clap/_derive/index.html#arg-types and if you aren't using the data type in the built-in way, then you have to override those.  In this case, you need to set <code>action = ArgAction::Set</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/hasezoey">@hasezoey</a> on 2024-03-25 17:16</div>
            <div class="timeline-body"><blockquote>
<p>and if you aren't using the data type in the built-in way, then you have to override those. In this case, you need to set action = ArgAction::Set.</p>
</blockquote>
<p>to my knowledge i am using data type <code>bool</code>, which is documented as <code>.action(ArgAction::SetTrue)</code>, and <a href="https://docs.rs/clap/latest/clap/enum.ArgAction.html#variant.SetTrue"><code>ArgAction::SetTrue</code></a> has documented</p>
<blockquote>
<p>No value is allowed. To optionally accept a value, see <a href="https://docs.rs/clap/latest/clap/struct.Arg.html#method.default_missing_value">Arg::default_missing_value</a></p>
</blockquote>
<p>and <code>default_missing_value</code> writes:</p>
<blockquote>
<p>NOTE: using this configuration option requires the use of the <a href="https://docs.rs/clap/latest/clap/struct.Arg.html#method.num_args">.num_args(0..N)</a> and the <a href="https://docs.rs/clap/latest/clap/struct.Arg.html#method.require_equals">.require_equals(true)</a> configuration option. These are required in order to unambiguously determine what, if any, value was supplied for the argument.</p>
</blockquote>
<p>and also a example:</p>
<pre><code class="language-rs">fn cli() -&gt; Command {
    Command::new(&quot;prog&quot;)
        .arg(Arg::new(&quot;create&quot;).long(&quot;create&quot;)
            .value_name(&quot;BOOL&quot;)
            .value_parser(value_parser!(bool))
            .num_args(0..=1)
            .require_equals(true)
            .default_missing_value(&quot;true&quot;)
        )
}
</code></pre>
<p>Note: i just discovered <code>default_missing_value</code> has a example for bools which has <code>.value_parser(value_parser!(bool))</code> set, is this something i would also need to do in derive?</p>
<hr />
<p>I have now tested using <code>action = ArgAction::Set</code>, and yes this resolves the error. Maybe some documentation updates would be good?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2024-03-25 17:47</div>
            <div class="timeline-body"><p>The discrepancy is Builder vs Derive APIs.  The Builder API defaults to <code>Set</code> unconditionally while the Derive API tries to be a little smarter.</p>
<p>I've tried to avoid as much talk about the Derive API in the Builder API.  Part of this was from a negative experience as a user when clap had the Builder, YAML, and Usage APIs and each entry point was documented with the schema for them which made the docs more bloated and harder to follow.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/hasezoey">@hasezoey</a> on 2024-03-25 18:27</div>
            <div class="timeline-body"><blockquote>
<p>I've tried to avoid as much talk about the Derive API in the Builder API.</p>
</blockquote>
<p>i can understand that, so maybe add it as a note when <code>default_missing_value</code> gets mentioned in the derive API (as it currently is not listed there)?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2024-03-25 18:42</div>
            <div class="timeline-body"><p><code>default_missing_value</code> is covered by a blanket statement on <a href="https://docs.rs/clap/latest/clap/_derive/index.html#terminology">raw attributes</a>.  Its not great but neither are the alternatives.  #4090 is for exploring ways of improving that.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @epage on 2024-07-29 13:39</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:49:19 UTC
    </footer>
</body>
</html>
