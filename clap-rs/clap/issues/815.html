<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add support for automatic negation flags - clap-rs/clap #815</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Add support for automatic negation flags</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/clap-rs/clap/issues/815">#815</a>
        opened by <a href="https://github.com/kbknapp">@kbknapp</a>
        on 2017-01-14 02:17
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/kbknapp">@kbknapp</a></div>
            <div class="timeline-body"><p>Add a way to automatically generate flags that override (or negate) other flags. This can be done manually already, but doing so for an entire CLI can be tedious, painful, and error prone. Manually doing so will also pollute the <code>--help</code> output.</p>
<p>This proposal offers a way to automatically have these negation flags generated on a case by case basis, or across all flags in the command. This proposal also offers a way to have these negation flags listed in the <code>--help</code> message or hidden.</p>
<h3>Design</h3>
<p>A negation flag would simply take the long version of the regular flag and pre-pend <code>no</code>; for exmaple <code>--follow</code> would get a <code>--no-follow</code>. If a flag only specifies a short version, the <code>no</code> would be prepended to the short such as <code>-L</code> gets <code>--no-L</code>.</p>
<p>When parsing occurs, if a negation flag is found, and the negat<strong>ed</strong> argument was used, it functions exactly like a override that is already supported.</p>
<p>Functionally the following two examples are equivilant:</p>
<pre><code class="language-rust">app.arg(Arg::with_name(&quot;regular&quot;)
        .long(&quot;follow-links&quot;)
        .help(&quot;follows symlinks&quot;)
        .overrides_with(&quot;override&quot;))
    .arg(Arg::with_name(&quot;override)
        .long(&quot;no-follow-links&quot;)
        .help(&quot;does not follow symlinks&quot;))
</code></pre>
<p>New proposal:</p>
<pre><code class="language-rust">app.arg(Arg::with_name(&quot;regular&quot;)
        .long(&quot;follow-links&quot;)
        .help(&quot;follows symlinks&quot;)
        .overridable(true))
</code></pre>
<h3>Concerns</h3>
<p>There are two primary concerns with this approach.</p>
<h4>Flags that already contian &quot;no&quot;</h4>
<p>A flag which already starts with <code>no</code> such as <code>--no-ignore</code> would end up getting a double <code>no</code> in the form of <code>--no-no-ignore</code>. This actually makes sense and is consistent, but looks strange at first glance. An alternative would be to check if a flag starts with <code>no</code> and simply remove the <code>no</code>, i.e. <code>--no-ignore</code> becomes <code>--ignore</code> but this has the downside of additional processing at runtime, becomes slightly more confusing, and has a higher chance of a conflict.</p>
<h4>Conflicting names</h4>
<p>If a user has selected to auto-generate a negation flag, and the negating flag long conflicts with a flag already in use, a <code>panic!</code> will occur. Example, <code>--ignore</code> and <code>--no-ignore</code> is already defined elsewhere, and the user has selected to automaticlly generate negation flags, this will cause <code>--ignore</code> to generate a <code>--no-ignore</code> flag which already exists causing a <code>panic!</code>. The fix is to either <em>not</em> use a sweeping setting that applies ot all flags indescriminantly, or to change/remove the already defined <code>--no-ignore</code> flag.</p>
<hr />
<h3>Progress</h3>
<ul>
<li>[ ] Add <code>AppSettings::GenerateNegationFlags</code> which does the above, but automatically for all flags.<ul>
<li>[ ] docs</li>
<li>[ ] tests</li>
</ul>
</li>
<li>[ ] Add <code>AppSettings:GenerateHiddenNegationFlags</code> which hides all these negation flags.<ul>
<li>[ ] docs</li>
<li>[ ] tests</li>
</ul>
</li>
</ul>
<hr />
<p>See the discussion in burntsushi/ripgrep#196</p>
<p>Relates to #748</p>
<hr />
<p>Edit: Removed <code>Arg::overridable(bool)</code> because this can already be done manually by making another flag.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">C: args</span> added by @kbknapp on 2017-01-14 02:18</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">C: settings</span> added by @kbknapp on 2017-01-14 02:18</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">D: easy</span> added by @kbknapp on 2017-01-14 02:18</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">P3: want to have</span> added by @kbknapp on 2017-01-14 02:18</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">T: new feature</span> added by @kbknapp on 2017-01-14 02:18</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">T: new setting</span> added by @kbknapp on 2017-01-14 02:18</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">W: 2.x</span> added by @kbknapp on 2017-01-14 02:18</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone "2.21.0" by @kbknapp on 2017-01-30 04:37</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">C: flags</span> added by @kbknapp on 2017-01-30 15:31</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">C: args</span> removed by @kbknapp on 2017-01-30 15:31</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">D: intermediate</span> added by @kbknapp on 2017-02-19 18:51</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">D: easy</span> removed by @kbknapp on 2017-02-19 18:51</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/1037.html">clap-rs/clap#1037</a> on 2018-02-15 14:51</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../TeXitoi/structopt/issues/93.html">TeXitoi/structopt#93</a> on 2018-04-18 16:34</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">W: 3.x</span> added by @kbknapp on 2018-07-22 01:06</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">W: 2.x</span> removed by @kbknapp on 2018-07-22 01:06</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Removed from milestone "2.21.0" by @kbknapp on 2018-07-22 01:06</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone "v3.0" by @kbknapp on 2018-07-22 01:06</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../habitat-sh/habitat/pulls/6114.html">habitat-sh/habitat#6114</a> on 2019-03-13 21:53</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../TeXitoi/structopt/issues/280.html">TeXitoi/structopt#280</a> on 2019-11-20 12:06</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../TeXitoi/structopt/issues/320.html">TeXitoi/structopt#320</a> on 2020-01-06 03:39</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/1728.html">clap-rs/clap#1728</a> on 2020-03-06 15:16</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Removed from milestone "3.0" by @pksunkara on 2020-04-10 13:17</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone "3.1" by @pksunkara on 2020-04-10 13:17</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../dandavison/delta/issues/307.html">dandavison/delta#307</a> on 2020-10-06 15:40</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../dandavison/delta/issues/492.html">dandavison/delta#492</a> on 2021-01-07 01:17</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/1649.html">clap-rs/clap#1649</a> on 2021-02-05 07:17</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../ducaale/xh/issues/84.html">ducaale/xh#84</a> on 2021-03-03 15:20</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/jacobsvante">@jacobsvante</a> on 2021-05-21 08:31</div>
            <div class="timeline-body"><p>Great proposal @kbknapp. Having a <code>--no-*</code> equivalent just feels natural when it comes to boolean values.</p>
<p>Perhaps this could even be the default, considering that v3 is still in beta? The user would then have to call <code>.overridable(false)</code> instead to get the old behavior.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/pksunkara">@pksunkara</a> on 2021-05-21 13:26</div>
            <div class="timeline-body"><p>Not all single flags are need overridable flags. From looking at the clis, this is a minority use case. Which is why this won't be a default behaviour.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">:money_with_wings: $10</span> added by @pksunkara on 2021-05-21 13:26</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../ducaale/xh/issues/142.html">ducaale/xh#142</a> on 2021-05-23 13:37</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Emerentius">@Emerentius</a> on 2021-06-08 18:21</div>
            <div class="timeline-body"><p>It's actually quite useful if all flags have negation flags because you can effectively switch the default of a flag via aliases or wrappers without hardcoding the behavior, because the user can still override the choice.
It even works with nested wrappers.</p>
<p>For some prior art, the very popular python command line argument library <code>click</code> pushes users to always define a positive and a negative flag (but allows having just one):
https://click.palletsprojects.com/en/8.0.x/options/#boolean-flags</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Mange">@Mange</a> on 2021-06-08 18:28</div>
            <div class="timeline-body"><p>I usually also always add a <code>no</code> variant for almost all my options, but it's that little &quot;almost&quot; that make me not want this to be automatic. If there was a simple opt-in argument you could set (<code>toggleable(true)</code> maybe?) then that would be enough for me.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../TeXitoi/structopt/issues/482.html">TeXitoi/structopt#482</a> on 2021-06-08 18:31</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2021-07-22 08:39</div>
            <div class="timeline-body"><p>Random thoughts:</p>
<ul>
<li>I don't think I normally see <code>--no-L</code>.  Instead what I tend to see is either no short form or toggling of the case (e.g. <code>-l</code> vs <code>-L</code>).  Having this be different makes this a bit more complicated.</li>
<li>Sometimes I want the <code>no</code> format to be the default, so I'd want the <code>no-</code> prefix stripped.</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">W: 3.x</span> removed by @pksunkara on 2021-08-13 10:40</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/mkayaalp">@mkayaalp</a> on 2021-11-15 06:29</div>
            <div class="timeline-body"><p>There are also instances of complementary flags using <code>+</code>/<code>-</code> as their prefix. Aside from the <code>bash shopt</code> and <code>Xwayland</code> mentioned in #2468, <a href="https://linux.die.net/man/1/xterm"><code>xterm</code></a> and <a href="https://www.gnu.org/software/bash/manual/html_node/The-Set-Builtin.html"><code>set</code></a> (shell builtin) have many such options:</p>
<pre><code>usage:  xterm [-/+132] [-/+ah] [-/+ai] [-/+aw]
    [-/+bc] [-/+bdc] [-/+cb] [-/+cjk_width] [-/+cm] [-/+cn] 
    [-/+cu] [-/+dc] [-/+fbb] [-/+fbx] [-/+fullscreen]
    [-/+hm] [-/+hold] [-/+ie] [-/+im] [-/+itc]
    [-/+j] [-/+k8] [-/+l] [-/+lc] [-/+ls] [-/+maximized] [-/+mb]
    [-/+mesg] [-/+mk_width] [-/+nul] [-/+pc] [-/+pob] [-/+rv]
    [-/+rvc] [-/+rw] [-/+s] [-/+samename] [-/+sb] [-/+sf]
    [-/+si] [-/+sk] [-/+sm] [-/+sp] [-/+t] [-/+u8] [-/+uc]
    [-/+ulc] [-/+ulit] [-/+ut] [-/+vb] [-/+wc] [-/+wf]
    &lt;omitted other options&gt;
</code></pre>
<pre><code>set [--abefhkmnptuvxBCEHPT] [-o option-name] [argument …]
set [+abefhkmnptuvxBCEHPT] [+o option-name] [argument …]
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2021-11-15 14:35</div>
            <div class="timeline-body"><p>Though that is a whole different argument scheme and is more related to #1210, especially with <a href="https://github.com/clap-rs/clap/issues/1210#issuecomment-956656955">my comment</a>.</p>
<p>However, that also points out the general challenge with trying to support automatic negation flags: there are a lot of different styles. I think the most important thing is we don't get in the way of people writing their CLI, even if it requires more boiler palte.  After that is us making the core workflows and common / best practices easy to take advantage of.  I think we should define the scope of what kind of automatic flags we support and limit ourselves to that or else I fear it'll either be too complicated by supporting all types or won't be present for anyone.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../epage/clapng/issues/69.html">epage/clapng#69</a> on 2021-12-06 16:32</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">C: settings</span> removed by @epage on 2021-12-08 20:18</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">C: flags</span> removed by @epage on 2021-12-08 20:18</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">A-builder</span> added by @epage on 2021-12-08 20:18</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">A-parsing</span> added by @epage on 2021-12-08 20:18</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">C-enhancement</span> added by @epage on 2021-12-08 20:38</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">T: new feature</span> removed by @epage on 2021-12-08 20:39</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">T: new setting</span> removed by @epage on 2021-12-08 20:39</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">D: medium</span> removed by @epage on 2021-12-09 17:00</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">P3: want to have</span> removed by @epage on 2021-12-09 17:00</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">A-derive</span> added by @epage on 2021-12-09 17:00</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">S-waiting-on-design</span> added by @epage on 2021-12-09 17:00</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Removed from milestone "3.1" by @epage on 2021-12-09 17:00</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/3146.html">clap-rs/clap#3146</a> on 2021-12-10 21:34</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../ducaale/xh/pulls/234.html">ducaale/xh#234</a> on 2022-02-15 20:58</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/blyxxyz">@blyxxyz</a> on 2022-02-15 22:12</div>
            <div class="timeline-body"><p><strong>EDIT:</strong> This can be done more cleanly nowadays, see https://github.com/clap-rs/clap/issues/815#issuecomment-1808282085</p>
<p>We're currently using this workaround to generate negation flags for all options:</p>
<pre><code class="language-rust">    use once_cell::sync::OnceCell;

    let opts: Vec&lt;_&gt; = app.get_arguments().filter(|a| !a.is_positional()).collect();

    // We use a OnceCell to make strings 'static. Watch out that you don't
    // construct the app multiple times with different arguments because it'll
    // only be initialized once and reused thereafter.
    // Box::leak() would also work, but it makes valgrind unhappy.
    static ARG_STORAGE: OnceCell&lt;Vec&lt;String&gt;&gt; = OnceCell::new();
    let arg_storage = ARG_STORAGE.get_or_init(|| {
        opts.iter()
            .map(|opt| format!(&quot;--no-{}&quot;, opt.get_long().expect(&quot;long option&quot;)))
            .collect()
    });

    let negations: Vec&lt;_&gt; = opts
        .into_iter()
        .zip(arg_storage)
        .map(|(opt, flag)| {
            clap::Arg::new(&amp;flag[2..])
                .long(flag)
                .hide(true)
                .overrides_with(opt.get_name())
        })
        .collect();

    app = app.args(negations);
</code></pre>
<p>(It also creates <code>--no-help</code> and <code>--no-version</code>, which is weird but harmless.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/3405.html">clap-rs/clap#3405</a> on 2022-05-09 21:54</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2022-06-13 17:45</div>
            <div class="timeline-body"><p>With the new <code>ArgAction</code> API, one approach we could take for this:</p>
<pre><code class="language-rust">Arg::new(&quot;force&quot;)
    .action(clap::builder::SetBool)
    .long(&quot;force&quot;)
    .alias(&quot;no-force&quot;)
</code></pre>
<p>The <code>SetBool</code> action would effectively be</p>
<pre><code>let alias: &amp;str = ...;  // either `force` or `no-force`
let default_missing_value = if alias.starts_with(&quot;no-&quot;) {
    &quot;false&quot;
} else {
    &quot;true&quot;
};
...
</code></pre>
<p>The downside is you wouldn't be able to control whether shorts would set true or false.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/blyxxyz">@blyxxyz</a> on 2022-06-13 18:04</div>
            <div class="timeline-body"><p>In <a href="https://github.com/ducaale/xh">xh</a> we support negating all options, not just boolean options. <code>--style=solarized --no-style</code> becomes a no-op. I don't know how common that is (we imitated it from HTTPie), but it would be nice to have as a supported case.</p>
<p>The prefix check feels too magical, if I found that example in the wild I wouldn't know where to look for an explanation.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2022-06-13 18:27</div>
            <div class="timeline-body"><blockquote>
<p>In <a href="https://github.com/ducaale/xh">xh</a> we support negating all options, not just boolean options. --style=solarized --no-style becomes a no-op. I don't know how common that is (we imitated it from HTTPie), but it would be nice to have as a supported case.</p>
</blockquote>
<p>Thanks for bringing up this use case.  I don't tend to see this too often.  Even if we don't provide a native way of supporting it, there would always be <code>overrides_with</code> for clearing it out.</p>
<p>Speaking of, how are you implementing that today?  I looked at your <code>Parser</code> didn't see a <code>--no-style</code> defined.</p>
<blockquote>
<p>The prefix check feels too magical, if I found that example in the wild I wouldn't know where to look for an explanation.</p>
</blockquote>
<p>I can understand.  It is dependent on people thinking to check the the documentation for <code>SetBool</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/blyxxyz">@blyxxyz</a> on 2022-06-13 19:01</div>
            <div class="timeline-body"><blockquote>
<p>Speaking of, how are you implementing that today?</p>
</blockquote>
<p>See a few comments back: https://github.com/clap-rs/clap/issues/815#issuecomment-1040848452</p>
<p>The new reflection came in very handy!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2022-06-13 19:33</div>
            <div class="timeline-body"><p>Oh, I had overlooked in that comment that you meant negations for all options and not just flags.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvkb">@dhruvkb</a> on 2022-08-07 08:43</div>
            <div class="timeline-body"><p>Coming from the Python <code>argparse</code> camp, I heavily used the <code>--*/--no-*</code> pattern in my apps. This feature would be very helpful for me.</p>
<blockquote>
<p>With the new ArgAction API, one approach we could take for this</p>
</blockquote>
<p>@epage is it possible to define our own actions apart from <a href="https://docs.rs/clap/latest/clap/builder/enum.ArgAction.html">the included standard ones</a>? I couldn't find any examples for this so if you could point me to one, that'd be very helpful.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/tmccombs">@tmccombs</a> on 2022-08-07 18:36</div>
            <div class="timeline-body"><blockquote>
<p>is it possible to define our own actions apart from <a href="https://docs.rs/clap/latest/clap/builder/enum.ArgAction.html">the included standard ones</a>?</p>
</blockquote>
<p>Not currently. but I think I saw something saying that was on the roadmap.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2022-08-08 14:03</div>
            <div class="timeline-body"><p>@dhruvkb the plan is to eventually support it but not yet.</p>
<p>Current blockers:</p>
<ul>
<li>Seeing how actions interact with the parser and other systems as the project evolves to make sure the we expose the right behavior.</li>
<li>Work through how to interact with parts of the system that are currently internal.</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvkb">@dhruvkb</a> on 2022-08-08 14:09</div>
            <div class="timeline-body"><p>I'll subscribe to the issue for updates. In the meantime I've got a variant of @blyxxyz's snippet working for me. Thanks!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2022-08-25 21:58</div>
            <div class="timeline-body"><p>While I don't think this is the way we should go, I thought I'd record how CLI11 solves this problem: runtime parsing of a declaration string.  See https://cliutils.github.io/CLI11/book/chapters/flags.html</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../n0-computer/beetle/issues/156.html">n0-computer/beetle#156</a> on 2022-10-10 11:24</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../dandavison/delta/issues/1280.html">dandavison/delta#1280</a> on 2023-01-13 14:12</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../orogene/orogene/issues/219.html">orogene/orogene#219</a> on 2023-03-30 19:56</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../neovide/neovide/pulls/1885.html">neovide/neovide#1885</a> on 2023-06-02 21:50</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../jwillinghalpern/fm_rainbow_log/issues/41.html">jwillinghalpern/fm_rainbow_log#41</a> on 2023-09-11 00:12</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../astral-sh/ruff/pulls/7504.html">astral-sh/ruff#7504</a> on 2023-09-19 02:36</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/fzyzcjy">@fzyzcjy</a> on 2023-11-13 14:08</div>
            <div class="timeline-body"><p>Hi, is there any updates? Thanks! Especially, it would be great to have one in Parser derivation mode, instead of the builder mode.</p>
<p>P.S. I found https://jwodder.github.io/kbits/posts/clap-bool-negate/ but the workaround is not super neat IMHO</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/blyxxyz">@blyxxyz</a> on 2023-11-13 14:35</div>
            <div class="timeline-body"><p>FWIW, in xh we've moved to a <a href="https://github.com/ducaale/xh/blob/1a74a521e1f1def2f9463abcfe05b448f04c27be/src/cli.rs#L583">still cleaner implementation</a> by enabling clap's <code>string</code> feature and doing this:</p>
<pre><code class="language-rust">let negations: Vec&lt;_&gt; = app
    .get_arguments()
    .filter(|a| !a.is_positional())
    .map(|opt| {
        let long = opt.get_long().expect(&quot;long option&quot;);
        clap::Arg::new(format!(&quot;no-{}&quot;, long))
            .long(format!(&quot;no-{}&quot;, long))
            .hide(true)
            .action(ArgAction::SetTrue)
            // overrides_with is enough to make the flags take effect
            // We never have to check their values, they'll simply
            // unset previous occurrences of the original flag
            .overrides_with(opt.get_id())
    })
    .collect();

app.args(negations)
    .after_help(&quot;Each option can be reset with a --no-OPTION argument.&quot;)
</code></pre>
<p>It no longer feels like a hacky workaround so I'm pretty happy with it. It's cool how flexible clap has become.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/spenserblack">@spenserblack</a> on 2023-11-13 14:58</div>
            <div class="timeline-body"><p>For my specific use-case, it would be perfect for me if I could use <code>#[derive(Parser)]</code> and use this feature to create an <code>Option&lt;bool&gt;</code> which would automatically have <code>--foo</code> and <code>--no-foo</code> combined as a single <code>--[no-]foo</code> in the help message. IMO <code>--[no-]foo</code> is a very readable and concise way to say &quot;there are two mutually exclusive flags, and the app will decide if neither are specified.&quot; For example, <code>--[no-]color</code> to either force colors to be included or excluded in a CLI output, and the executable would try to detect color support if neither are specified.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/pacak">@pacak</a> on 2023-11-13 15:41</div>
            <div class="timeline-body"><blockquote>
<p>use this feature to create an <code>Option&lt;bool&gt;</code> which would automatically have</p>
</blockquote>
<p>In my experience you only use <code>Option&lt;bool&gt;</code> if you want to handle case when user did not specify a value differently than from it being <code>true</code> or <code>false</code>, otherwise you just stick to <code>bool</code> and populate the default value from the parser. <code>Option&lt;bool&gt;</code> works on small examples but if you share configurations between apps or even use it in multiple places in the same app you can get into cases where different parts of the app treat <code>None</code> differently.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/fzyzcjy">@fzyzcjy</a> on 2023-11-13 23:39</div>
            <div class="timeline-body"><p>Thank you! That looks helpful</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/kenchou">@kenchou</a> on 2023-11-23 10:39</div>
            <div class="timeline-body"><p>If the #[derive(Parser)] could implement a boolean flag like <a href="https://click.palletsprojects.com/en/8.1.x/options/#boolean-flags">Python click</a>,
it would be perfect, combining both readability and flexibility.</p>
<pre><code class="language-python">@click.option('--color/--no-color', default=False)
@click.option('--enable-option/--disable-option', default=False)
@click.option('--with-something/--without-something', default=False)
</code></pre>
<p>Imagine:</p>
<pre><code class="language-rust">    /// Given that the default value is true, providing a short option should be considered as false. And vice versa.
    #[arg(short = &quot;C&quot;, long = &quot;--color/--no-color&quot;, default_value = &quot;true&quot;)]
    color_flag: bool,

    /// Explicitly providing a short option maps to true/false.
    #[arg(short = &quot;o/O&quot;, long = &quot;--enable-option/--disable-option&quot;, default_value = &quot;true&quot;)]
    some_option_flag: bool,
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../MercuryTechnologies/ghciwatch/pulls/186.html">MercuryTechnologies/ghciwatch#186</a> on 2023-12-13 18:46</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../mozilla/neqo/pulls/1753.html">mozilla/neqo#1753</a> on 2024-03-17 01:52</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../neovide/neovide/pulls/2441.html">neovide/neovide#2441</a> on 2024-03-25 20:22</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../tummychow/git-absorb/pulls/110.html">tummychow/git-absorb#110</a> on 2024-04-11 22:53</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/esemeniuc">@esemeniuc</a> on 2024-05-18 04:44</div>
            <div class="timeline-body"><p>Would love to see this added!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">:money_with_wings: $10</span> removed by @pksunkara on 2024-06-07 06:53</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/5543.html">clap-rs/clap#5543</a> on 2024-06-21 18:18</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/joshtriplett">@joshtriplett</a> on 2024-08-06 15:01</div>
            <div class="timeline-body"><p>I would love this as well. Like others in this thread, I don't think we should try to do this <em>automatically</em>; I'd be happy to see an explicit way for the builder and declarative APIs to add a <code>--no-</code> option for a given option.</p>
<p>This option could work for a boolean, as well as for an <code>Option&lt;T&gt;</code> that has a default of <code>Some(default_value)</code> (with the <code>--no-</code> option setting <code>None</code>).</p>
<pre><code class="language-rust">    #[arg(long, negation)]
    pub auto: bool,

    #[arg(long, default_value = &quot;hello&quot;, negation)]
    pub value: Option&lt;String&gt;,
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2024-08-06 15:07</div>
            <div class="timeline-body"><p>@joshtriplett interesting to also include  this for options.</p>
<p>We also would need to define the builder API and what the semantics for this would be (parser, help, etc).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ia0">@ia0</a> on 2024-08-06 15:27</div>
            <div class="timeline-body"><p>If <code>negation</code> should not be automatically enabled, I would also argue that <code>negation</code> should also not automatically add <code>default_value_t = true</code> for booleans (even though I agree it would make a lot of sense). If we want to be explicit with unsurprising syntax, I expect the <code>--auto/--no-auto</code> use-case to look like:</p>
<pre><code class="language-rust">#[arg(long, default_value_t = true, negation)]
pub auto: bool,
</code></pre>
<p>In some way, <code>negation</code> only make sense if <code>long</code> is already present and if <code>default_value</code> is already present. If <code>long</code> is not implicitly added, then <code>default_value</code> shouldn't either. And since we want to support <code>Option</code>, then we can't implicitly add <code>default-value</code> (unless we use the syntax <code>support_negation_of_default = &lt;default&gt;</code>, in which case both <code>long</code> and <code>default_value</code> can be inferred).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2024-08-06 19:14</div>
            <div class="timeline-body"><blockquote>
<p>If negation should not be automatically enabled, I would also argue that negation should also not automatically add default_value_t = true for booleans (even though I agree it would make a lot of sense).</p>
</blockquote>
<p><code>default_value_t</code> (what to do when no flag is present) and <code>default_missing_value_t</code> (what to do when the flag is present) are both customizable for flags.  I don't think I'd want to say <code>default_value_t</code> should be required though.</p>
<p><code>Option&lt;bool&gt;</code> (as mentioned earlier) is also a good way of handling the &quot;not present&quot; state.</p>
<blockquote>
<p>In some way, negation only make sense if long is already present and if default_value is already present. If long is not implicitly added, then default_value shouldn't either. And since we want to support Option, then we can't implicitly add default-value (unless we use the syntax support_negation_of_default = <default>, in which case both long and default_value can be inferred).</p>
</blockquote>
<p>I don't quite get this.  Flags already require long/short.  This is a modification to flag state.  For someone to add <code>negation</code> to an existing flag to now have to explicitly set flags that they were ok with before this doesn't make sense to me.</p>
<blockquote>
<p>And since we want to support Option, then we can't implicitly add default-value (unless we use the syntax support_negation_of_default = <default>, in which case both long and default_value can be inferred).</p>
</blockquote>
<p>There are lots of ways of implementing this and they don't necessarily preclude this:</p>
<ul>
<li>We can support <code>Option</code> and implicit <code>default_value_t</code> by checking the <code>ValueSource</code></li>
<li>We could skip the implicit default if <code>Option</code> is present</li>
</ul>
<p>Overall though, this discussion has a fatal flaw: we are designing a feature around derive semantics and discussing what is or isn't possible.  We need to focus on the builder semantics and then decide what automatic behavior we want to the derive semantics to have on top of that.  There can be some back and forth on that (the derive influencing the builder design).  Thats a big value-add of merging structopt into clap!  We've run into many problems where the builder API made choices that work well in isolation but don't work well for builder and have worked to correct them.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ia0">@ia0</a> on 2024-08-07 06:52</div>
            <div class="timeline-body"><blockquote>
<p>I don't think I'd want to say <code>default_value_t</code> should be required though.</p>
</blockquote>
<p>Maybe I'm misunderstanding what you imply. I didn't say that <code>default_value_t</code> should be required. I said that <code>negation</code> should not act as an implicit <code>default_value_t</code>, and thus correct usage of <code>negation</code> should specify a <code>default_value_t</code> (it's not required, it's just probably wrong to not do it). Not sure about <code>default_missing_value_t</code> though, some specified semantics (as you mention at the end of your comment) would indeed be useful. What I inferred from @joshtriplett comment would be a semantic like:</p>
<ul>
<li>If <code>negation</code> is specified, then an additional conflicting flag is added.</li>
<li>It is named <code>--no-LONG</code> where <code>LONG</code> is the long name of the negated flag (which must thus have a long name).</li>
<li>It doesn't have a short name.</li>
<li>When present it behaves by setting the field to <code>false</code> if it is a <code>bool</code> and to <code>None</code> if it is an <code>Option</code>.</li>
</ul>
<blockquote>
<p><code>Option&lt;bool&gt;</code> (as mentioned earlier) is also a good way of handling the &quot;not present&quot; state.</p>
</blockquote>
<p>This doesn't have the same user experience. The best workaround right now is to explictly define the additional <code>--no-</code> flag and make it conflicting with the negated one (<a href="https://github.com/google/magika/blob/cbc2cb861b7b54ee7c9a6dfff3fa23ecf94a6007/rust/cli/src/main.rs#L61-L71">real-life example</a>). Then in the code, check both flags and behave accordingly (<a href="https://github.com/google/magika/blob/cbc2cb861b7b54ee7c9a6dfff3fa23ecf94a6007/rust/cli/src/main.rs#L156-L161">real-life example</a>). Note that in this example, the &quot;default value&quot; (i.e. when none of those flags is present) is context-dependent. In that sense, it is similar to the <code>Option&lt;bool&gt;</code> except that it's implemented with 2 <code>bool</code>s where <code>(true, true)</code> is unreachable (thus having exactly the same number of values, namely 3).</p>
<blockquote>
<p>I don't quite get this.</p>
</blockquote>
<p>That's probably related to the misunderstanding above. What if @joshtriplett example was actually the following?</p>
<pre><code class="language-rust">    #[arg(negation)]
    pub auto: bool,
</code></pre>
<p>What would it mean? What is the name of the added flag? And similarly if it was <code>#[arg(short, negation)]</code>. But as you said at the end, we need a clear semantics, which I provided a candidate at the beginning of this comment. Hopefully it makes things clearer.</p>
<blockquote>
<p>We need to focus on the builder semantics and then decide what automatic behavior we want to the derive semantics to have on top of that</p>
</blockquote>
<p>I thought the builder and derive semantics were isomorphic since it seems derive attributes cover all builder functions. I never used the builder so maybe I'm missing some functionalities. That said, I agree that proposals need a clear semantics, and I hope the one I gave above is clear enough (for both builder and derive).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/emilyyyylime">@emilyyyylime</a> on 2024-08-07 06:53</div>
            <div class="timeline-body"><p>More generally it might be desirable to support multiple argument names controlling the same value (with different actions) that are all automatically exclusive with eachother, with some shorthands to better support more common use cases (bools, options).</p>
<p>Working out all of the semantics of this more general approach could make it much easier to define the semantics of the shorthand forms, as simply being equivalent to some usage of the general API.</p>
<p>Admittedly the current API is very value-centric, making it a bit hard to imagine how this feature could be used, but being able to assign multiple flag-action pairings to the same value would be your starting point.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../catppuccin/delta/issues/12.html">catppuccin/delta#12</a> on 2024-08-30 23:00</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../smheidrich/snoozed-todos/issues/1.html">smheidrich/snoozed-todos#1</a> on 2024-09-08 21:47</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../starcoinorg/starcoin/pulls/4289.html">starcoinorg/starcoin#4289</a> on 2024-11-19 10:39</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../pls-rs/pls/pulls/118.html">pls-rs/pls#118</a> on 2024-12-20 07:04</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../tealdeer-rs/tealdeer/pulls/396.html">tealdeer-rs/tealdeer#396</a> on 2024-12-30 22:35</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../esp-rs/espflash/pulls/717.html">esp-rs/espflash#717</a> on 2024-12-31 07:22</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../YaLTeR/niri/pulls/975.html">YaLTeR/niri#975</a> on 2025-01-14 09:49</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../hashintel/hash/pulls/7329.html">hashintel/hash#7329</a> on 2025-06-04 19:56</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../hermit-os/uhyve/pulls/1034.html">hermit-os/uhyve#1034</a> on 2025-08-02 22:07</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/RReverser">@RReverser</a> on 2025-09-15 14:44</div>
            <div class="timeline-body"><blockquote>
<p>I would love this as well. Like others in this thread, I don't think we should try to do this <em>automatically</em>; I'd be happy to see an explicit way for the builder and declarative APIs to add a <code>--no-</code> option for a given option.</p>
<p>This option could work for a boolean, as well as for an <code>Option&lt;T&gt;</code> that has a default of <code>Some(default_value)</code> (with the <code>--no-</code> option setting <code>None</code>).</p>
<pre><code>#[arg(long, negation)]
pub auto: bool,

#[arg(long, default_value = &quot;hello&quot;, negation)]
pub value: Option&lt;String&gt;,</code></pre>
</blockquote>
<p>TBH I don't think we even need a separate <code>negation</code>, it would be more natural to just allow multiple <code>arg()</code> on the same field.</p>
<p>For example:</p>
<pre><code class="language-rust">#[arg(long)]
#[arg(long = &quot;no-auto&quot;, action = ArgAction::SetFalse)]
pub auto: bool,
</code></pre>
<p>could allow negation quite cleanly, where the CLI interface shows these as individual options, user can apply own conversion rules for each of them, yet when parsing they all map back to the same field.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2025-09-16 18:11</div>
            <div class="timeline-body"><p>The initial Issue asked for <code>no-</code> variants to be added automatically.  Specifying a <code>no-</code> alias explicitly is a variant of that.</p>
<p>In https://github.com/clap-rs/clap/issues/815#issuecomment-884746951 I mentioned</p>
<blockquote>
<p>Sometimes I want the no format to be the default, so I'd want the no- prefix stripped.</p>
</blockquote>
<p>Doing this automatically, there wouldn't be a way to determine it.  If we added the <code>no-</code> variants explicitly, that would be:</p>
<pre><code class="language-rust">Arg::new(&quot;flag&quot;).long)&quot;no-flag&quot;).alias(&quot;flag&quot;).action(ArgAction::SetTrue)
</code></pre>
<p>The <code>no-</code> variant is what would primarily show up in the help while still allowing the positive variant.</p>
<blockquote>
<p>I don't think I normally see --no-L. Instead what I tend to see is either no short form or toggling of the case (e.g. -l vs -L). Having this be different makes this a bit more complicated.</p>
</blockquote>
<p>Short flags become an issue.  How do we know whether they are a negation or not?  There are many different styles, from changing case to changing letters, depending on the circumstances.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/RReverser">@RReverser</a> on 2025-09-16 18:34</div>
            <div class="timeline-body"><p>I agree automatic / dedicated negation can have its merits too, but what I like about my proposal is that I, too, often wished for this request by @emilyyyylime above:</p>
<blockquote>
<p>More generally it might be desirable to support multiple argument names controlling the same value (with different actions) that are all automatically exclusive with eachother, with some shorthands to better support more common use cases (bools, options).</p>
</blockquote>
<p>and allowing multiple <code>arg()</code> would cover these, more universal, usecases as well as plain negation.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2025-09-16 18:43</div>
            <div class="timeline-body"><p>In case its relevant,</p>
<ul>
<li>#3146 is our issue for having the same destination.</li>
<li>#2621 is our issue for declaring multiple arguments mutually exclusive through being an enum</li>
</ul>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:46:48 UTC
    </footer>
</body>
</html>
