<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>bash generated completions invalid when command name contains spaces - clap-rs/clap #4822</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>bash generated completions invalid when command name contains spaces</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/clap-rs/clap/issues/4822">#4822</a>
        opened by <a href="https://github.com/mjpieters">@mjpieters</a>
        on 2023-04-03 19:05
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/mjpieters">@mjpieters</a> on 2023-04-03 19:05</div>
            <div class="timeline-body"><h3>Please complete the following tasks</h3>
<ul>
<li>[X] I have searched the <a href="https://github.com/clap-rs/clap/discussions">discussions</a></li>
<li>[X] I have searched the <a href="https://github.com/clap-rs/clap/issues">open</a> and <a href="https://github.com/clap-rs/clap/issues?q=is%3Aissue+label%3AS-wont-fix+is%3Aclosed">rejected</a> issues</li>
</ul>
<h3>Rust Version</h3>
<p>rustc 1.67.0 (fc594f156 2023-01-24)</p>
<h3>Clap Version</h3>
<p>4.2.1</p>
<h3>Minimal reproducible code</h3>
<p><strong><code>Cargo.toml</code></strong></p>
<pre><code class="language-toml">[package]
name = &quot;mcre_clap_generate&quot;
version = &quot;0.1.0&quot;
edition = &quot;2021&quot;
[dependencies]
clap = { version = &quot;4.2.1&quot;, features = [&quot;derive&quot;] }
clap_complete = &quot;4.2.0&quot;
</code></pre>
<p><strong><code>main.rs</code></strong>:</p>
<pre><code class="language-rust">use std::path::PathBuf;
use clap::{CommandFactory, Parser, ValueHint, error::Result};
use clap_complete::{generate_to, shells};

#[derive(Parser)]
pub enum SubCommand {
    Completions {
        /// The output directory to which the file should be written.
        #[arg(value_hint = ValueHint::DirPath)]
        output_directory: PathBuf,
    },
}

#[derive(Parser)]
#[command(
    name = &quot;MCRE for clap generate output&quot;,
    about = &quot;This is minimal, complete reproducible example for clap generate output producing invalid Bash completions&quot;,
)]
struct Cli {
    #[command(subcommand)]
    pub cmd: Option&lt;SubCommand&gt;,
}

fn main() -&gt; Result&lt;()&gt; {
    let opt = Cli::parse();
    if let Some(SubCommand::Completions {
        output_directory,
    }) = &amp;opt.cmd
    {
        generate_to(shells::Bash, &amp;mut Cli::command(), &quot;mcre_clap_generate&quot;, output_directory)?;
        generate_to(shells::Zsh, &amp;mut Cli::command(), &quot;mcre_clap_generate&quot;, output_directory)?;
    }
    Ok(())
}
</code></pre>
<h3>Steps to reproduce the bug with the above code</h3>
<pre><code>$ cargo build
...
$ mkdir -p /tmp/sample_output; ./target/debug/mcre_clap_generate completions /tmp/sample_output
</code></pre>
<h3>Actual Behaviour</h3>
<p>The generated bash and zsh completions files are not valid, because either generator uses <code>cmd.get_name()</code> instead of <code>cmd.get_bin_name()</code> as the parent command.</p>
<p>You can see this most easily when trying to execute the generated bash output:</p>
<pre><code class="language-sh">$ bash /tmp/sample_output/mcre_clap_generate.bash
/tmp/sample_output/mcre_clap_generate.bash: line 15: syntax error near unexpected token `for'
/tmp/sample_output/mcre_clap_generate.bash: line 15: `            MCRE for clap generate output,completions)'
$ head -n30 /tmp/sample_output/mcre_clap_generate.bash
_mcre_clap_generate() {
    local i cur prev opts cmd
    COMPREPLY=()
    cur=&quot;${COMP_WORDS[COMP_CWORD]}&quot;
    prev=&quot;${COMP_WORDS[COMP_CWORD-1]}&quot;
    cmd=&quot;&quot;
    opts=&quot;&quot;

    for i in ${COMP_WORDS[@]}
    do
        case &quot;${cmd},${i}&quot; in
            &quot;,$1&quot;)
                cmd=&quot;mcre_clap_generate&quot;
                ;;
            MCRE for clap generate output,completions)
                cmd=&quot;MCRE for clap generate output__completions&quot;
                ;;
            MCRE for clap generate output,help)
                cmd=&quot;MCRE for clap generate output__help&quot;
                ;;
            MCRE for clap generate output__help,completions)
                cmd=&quot;MCRE for clap generate output__help__completions&quot;
                ;;
            MCRE for clap generate output__help,help)
                cmd=&quot;MCRE for clap generate output__help__help&quot;
                ;;
            *)
                ;;
        esac
    done
</code></pre>
<p>The Zsh generated output is similarly broken; using the <code>shellcheck</code> linter:</p>
<pre><code>$ shellcheck /tmp/sample_output/_mcre_clap_generate 

In /tmp/sample_output/_mcre_clap_generate line 23:
    case $state in
    ^-- SC1009 (info): The mentioned syntax error was in this case expression.


In /tmp/sample_output/_mcre_clap_generate line 24:
    (MCRE for clap generate output)
    ^-- SC1073 (error): Couldn't parse this case item. Fix to allow more checks.
          ^-- SC1072 (error): Expected ) to open a new case item. Fix any mentioned problems and try again.
          ^-- SC1085 (error): Did you forget to move the ;; after extending this case item?

For more information:
  https://www.shellcheck.net/wiki/SC1085 -- Did you forget to move the ;; aft...
  https://www.shellcheck.net/wiki/SC1072 -- Expected ) to open a new case ite...
  https://www.shellcheck.net/wiki/SC1073 -- Couldn't parse this case item. Fi...
</code></pre>
<h3>Expected Behaviour</h3>
<p>The parent name for a completion subcommand should be <code>cmd.get_bin_name()</code> (in the MRCE: <code>mrce_clap_generate</code>), and not <code>cmd.get_name()</code> (<code>MCRE for clap generate output</code> in the MRCE).</p>
<p>If I manually replace <code>MCRE for clap generate output</code> with <code>mcre_clap_generate</code> in the generated output, the completions work as expected.</p>
<h3>Additional Context</h3>
<p><em>No response</em></p>
<h3>Debug Output</h3>
<pre><code>[clap_builder::builder::command]        Command::_do_parse
[clap_builder::builder::command]        Command::_build: name=&quot;MCRE for clap generate output&quot;
[clap_builder::builder::command]        Command::_propagate:MCRE for clap generate output
[clap_builder::builder::command]        Command::_check_help_and_version:MCRE for clap generate output expand_help_tree=false
[clap_builder::builder::command]        Command::long_help_exists
[clap_builder::builder::command]        Command::_check_help_and_version: Building default --help
[clap_builder::builder::command]        Command::_check_help_and_version: Building help subcommand
[clap_builder::builder::command]        Command::_propagate_global_args:MCRE for clap generate output
[clap_builder::builder::debug_asserts]  Command::_debug_asserts
[clap_builder::builder::debug_asserts]  Arg::_debug_asserts:help
[clap_builder::builder::debug_asserts]  Command::_verify_positionals
[clap_builder::parser::parser]  Parser::get_matches_with
[clap_builder::parser::parser]  Parser::get_matches_with: Begin parsing '&quot;completions&quot;'
[clap_builder::parser::parser]  Parser::possible_subcommand: arg=Ok(&quot;completions&quot;)
[clap_builder::parser::parser]  Parser::get_matches_with: sc=Some(&quot;completions&quot;)
[clap_builder::parser::parser]  Parser::parse_subcommand
[ clap_builder::output::usage]  Usage::get_required_usage_from: incls=[], matcher=false, incl_last=true
[ clap_builder::output::usage]  Usage::get_required_usage_from: unrolled_reqs=[]
[ clap_builder::output::usage]  Usage::get_required_usage_from: ret_val=[]
[clap_builder::builder::command]        Command::_build_subcommand Setting bin_name of completions to &quot;mcre_clap_generate completions&quot;
[clap_builder::builder::command]        Command::_build_subcommand Setting display_name of completions to &quot;MCRE for clap generate output-completions&quot;
[clap_builder::builder::command]        Command::_build: name=&quot;completions&quot;
[clap_builder::builder::command]        Command::_propagate:completions
[clap_builder::builder::command]        Command::_check_help_and_version:completions expand_help_tree=false
[clap_builder::builder::command]        Command::long_help_exists
[clap_builder::builder::command]        Command::_check_help_and_version: Building default --help
[clap_builder::builder::command]        Command::_propagate_global_args:completions
[clap_builder::builder::debug_asserts]  Command::_debug_asserts
[clap_builder::builder::debug_asserts]  Arg::_debug_asserts:output_directory
[clap_builder::builder::debug_asserts]  Arg::_debug_asserts:help
[clap_builder::builder::debug_asserts]  Command::_verify_positionals
[clap_builder::parser::parser]  Parser::parse_subcommand: About to parse sc=completions
[clap_builder::parser::parser]  Parser::get_matches_with
[clap_builder::parser::parser]  Parser::get_matches_with: Begin parsing '&quot;/tmp/sample_output&quot;'
[clap_builder::parser::parser]  Parser::possible_subcommand: arg=Ok(&quot;/tmp/sample_output&quot;)
[clap_builder::parser::parser]  Parser::get_matches_with: sc=None
[clap_builder::parser::parser]  Parser::get_matches_with: Positional counter...1
[clap_builder::parser::parser]  Parser::get_matches_with: Low index multiples...false
[clap_builder::parser::parser]  Parser::resolve_pending: id=&quot;output_directory&quot;
[clap_builder::parser::parser]  Parser::react action=Set, identifier=Some(Index), source=CommandLine
[clap_builder::parser::parser]  Parser::remove_overrides: id=&quot;output_directory&quot;
[clap_builder::parser::arg_matcher]     ArgMatcher::start_custom_arg: id=&quot;output_directory&quot;, source=CommandLine
[clap_builder::builder::command]        Command::groups_for_arg: id=&quot;output_directory&quot;
[clap_builder::parser::arg_matcher]     ArgMatcher::start_custom_arg: id=&quot;Completions&quot;, source=CommandLine
[clap_builder::parser::parser]  Parser::push_arg_values: [&quot;/tmp/sample_output&quot;]
[clap_builder::parser::parser]  Parser::add_single_val_to_arg: cur_idx:=1
[clap_builder::parser::arg_matcher]     ArgMatcher::needs_more_vals: o=output_directory, pending=0
[clap_builder::parser::arg_matcher]     ArgMatcher::needs_more_vals: expected=1, actual=0
[clap_builder::parser::parser]  Parser::react not enough values passed in, leaving it to the validator to complain
[clap_builder::parser::parser]  Parser::add_defaults
[clap_builder::parser::parser]  Parser::add_defaults:iter:output_directory:
[clap_builder::parser::parser]  Parser::add_default_value: doesn't have conditional defaults
[clap_builder::parser::parser]  Parser::add_default_value:iter:output_directory: doesn't have default vals
[clap_builder::parser::parser]  Parser::add_defaults:iter:help:
[clap_builder::parser::parser]  Parser::add_default_value: doesn't have conditional defaults
[clap_builder::parser::parser]  Parser::add_default_value:iter:help: doesn't have default vals
[clap_builder::parser::validator]       Validator::validate
[clap_builder::builder::command]        Command::groups_for_arg: id=&quot;output_directory&quot;
[clap_builder::parser::validator]       Conflicts::gather_direct_conflicts id=&quot;output_directory&quot;, conflicts=[]
[clap_builder::parser::validator]       Conflicts::gather_direct_conflicts id=&quot;Completions&quot;, conflicts=[]
[clap_builder::parser::validator]       Validator::validate_conflicts
[clap_builder::parser::validator]       Validator::validate_exclusive
[clap_builder::parser::validator]       Validator::validate_conflicts::iter: id=&quot;output_directory&quot;
[clap_builder::parser::validator]       Conflicts::gather_conflicts: arg=&quot;output_directory&quot;
[clap_builder::parser::validator]       Conflicts::gather_conflicts: conflicts=[]
[clap_builder::parser::validator]       Validator::validate_required: required=ChildGraph([Child { id: &quot;output_directory&quot;, children: [] }])
[clap_builder::parser::validator]       Validator::gather_requires
[clap_builder::parser::validator]       Validator::gather_requires:iter:&quot;output_directory&quot;
[clap_builder::parser::validator]       Validator::gather_requires:iter:&quot;Completions&quot;
[clap_builder::parser::validator]       Validator::gather_requires:iter:&quot;Completions&quot;:group
[clap_builder::parser::validator]       Validator::validate_required: is_exclusive_present=false
[clap_builder::parser::parser]  Parser::add_defaults
[clap_builder::parser::parser]  Parser::add_defaults:iter:help:
[clap_builder::parser::parser]  Parser::add_default_value: doesn't have conditional defaults
[clap_builder::parser::parser]  Parser::add_default_value:iter:help: doesn't have default vals
[clap_builder::parser::validator]       Validator::validate
[clap_builder::parser::validator]       Validator::validate_conflicts
[clap_builder::parser::validator]       Validator::validate_exclusive
[clap_builder::parser::validator]       Validator::validate_required: required=ChildGraph([])
[clap_builder::parser::validator]       Validator::gather_requires
[clap_builder::parser::validator]       Validator::validate_required: is_exclusive_present=false
[clap_builder::parser::arg_matcher]     ArgMatcher::get_global_values: global_arg_vec=[]
[clap_builder::builder::command]        Command::_build: name=&quot;MCRE for clap generate output&quot;
[clap_builder::builder::command]        Command::_propagate:MCRE for clap generate output
[clap_builder::builder::command]        Command::_check_help_and_version:MCRE for clap generate output expand_help_tree=true
[clap_builder::builder::command]        Command::long_help_exists
[clap_builder::builder::command]        Command::_check_help_and_version: Building default --help
[clap_builder::builder::command]        Command::_check_help_and_version: Building help subcommand
[clap_builder::builder::command]        Command::_propagate_global_args:MCRE for clap generate output
[clap_builder::builder::debug_asserts]  Command::_debug_asserts
[clap_builder::builder::debug_asserts]  Arg::_debug_asserts:help
[clap_builder::builder::debug_asserts]  Command::_verify_positionals
[clap_builder::builder::command]        Command::_build: name=&quot;completions&quot;
[clap_builder::builder::command]        Command::_propagate:completions
[clap_builder::builder::command]        Command::_check_help_and_version:completions expand_help_tree=true
[clap_builder::builder::command]        Command::long_help_exists
[clap_builder::builder::command]        Command::_check_help_and_version: Building default --help
[clap_builder::builder::command]        Command::_propagate_global_args:completions
[clap_builder::builder::debug_asserts]  Command::_debug_asserts
[clap_builder::builder::debug_asserts]  Arg::_debug_asserts:output_directory
[clap_builder::builder::debug_asserts]  Arg::_debug_asserts:help
[clap_builder::builder::debug_asserts]  Command::_verify_positionals
[clap_builder::builder::command]        Command::_build: name=&quot;help&quot;
[clap_builder::builder::command]        Command::_propagate:help
[clap_builder::builder::command]        Command::_check_help_and_version:help expand_help_tree=true
[clap_builder::builder::command]        Command::long_help_exists
[clap_builder::builder::command]        Command::_propagate_global_args:help
[clap_builder::builder::debug_asserts]  Command::_debug_asserts
[clap_builder::builder::debug_asserts]  Command::_verify_positionals
[clap_builder::builder::command]        Command::_build: name=&quot;completions&quot;
[clap_builder::builder::command]        Command::_propagate:completions
[clap_builder::builder::command]        Command::_check_help_and_version:completions expand_help_tree=true
[clap_builder::builder::command]        Command::long_help_exists
[clap_builder::builder::command]        Command::_propagate_global_args:completions
[clap_builder::builder::debug_asserts]  Command::_debug_asserts
[clap_builder::builder::debug_asserts]  Command::_verify_positionals
[clap_builder::builder::command]        Command::_build: name=&quot;help&quot;
[clap_builder::builder::command]        Command::_propagate:help
[clap_builder::builder::command]        Command::_check_help_and_version:help expand_help_tree=true
[clap_builder::builder::command]        Command::long_help_exists
[clap_builder::builder::command]        Command::_propagate_global_args:help
[clap_builder::builder::debug_asserts]  Command::_debug_asserts
[clap_builder::builder::debug_asserts]  Command::_verify_positionals
[clap_builder::builder::command]        Command::_build_bin_names
[ clap_builder::output::usage]  Usage::get_required_usage_from: incls=[], matcher=false, incl_last=true
[ clap_builder::output::usage]  Usage::get_required_usage_from: unrolled_reqs=[]
[ clap_builder::output::usage]  Usage::get_required_usage_from: ret_val=[]
[clap_builder::builder::command]        Command::_build_bin_names:iter: bin_name set...
[clap_builder::builder::command]        Command::_build_bin_names:iter: Setting usage_name of completions to &quot;mcre_clap_generate completions&quot;
[clap_builder::builder::command]        Command::_build_bin_names:iter: Setting bin_name of completions to &quot;mcre_clap_generate completions&quot;
[clap_builder::builder::command]        Command::_build_bin_names:iter: Setting display_name of completions to &quot;MCRE for clap generate output-completions&quot;
[clap_builder::builder::command]        Command::_build_bin_names
[ clap_builder::output::usage]  Usage::get_required_usage_from: incls=[], matcher=false, incl_last=true
[ clap_builder::output::usage]  Usage::get_required_usage_from: unrolled_reqs=[&quot;output_directory&quot;]
[ clap_builder::output::usage]  Usage::get_required_usage_from:iter:&quot;output_directory&quot; arg is_present=false
[ clap_builder::output::usage]  Usage::get_required_usage_from: ret_val=[StyledStr(&quot;&lt;OUTPUT_DIRECTORY&gt;&quot;)]
[clap_builder::builder::command]        Command::_build_bin_names:iter: bin_name set...
[clap_builder::builder::command]        Command::_build_bin_names:iter: Setting usage_name of help to &quot;mcre_clap_generate help&quot;
[clap_builder::builder::command]        Command::_build_bin_names:iter: Setting bin_name of help to &quot;mcre_clap_generate help&quot;
[clap_builder::builder::command]        Command::_build_bin_names:iter: Setting display_name of help to &quot;MCRE for clap generate output-help&quot;
[clap_builder::builder::command]        Command::_build_bin_names
[ clap_builder::output::usage]  Usage::get_required_usage_from: incls=[], matcher=false, incl_last=true
[ clap_builder::output::usage]  Usage::get_required_usage_from: unrolled_reqs=[]
[ clap_builder::output::usage]  Usage::get_required_usage_from: ret_val=[]
[clap_builder::builder::command]        Command::_build_bin_names:iter: bin_name set...
[clap_builder::builder::command]        Command::_build_bin_names:iter: Setting usage_name of completions to &quot;mcre_clap_generate help completions&quot;
[clap_builder::builder::command]        Command::_build_bin_names:iter: Setting bin_name of completions to &quot;mcre_clap_generate help completions&quot;
[clap_builder::builder::command]        Command::_build_bin_names:iter: Setting display_name of completions to &quot;MCRE for clap generate output-help-completions&quot;
[clap_builder::builder::command]        Command::_build_bin_names
[ clap_builder::output::usage]  Usage::get_required_usage_from: incls=[], matcher=false, incl_last=true
[ clap_builder::output::usage]  Usage::get_required_usage_from: unrolled_reqs=[]
[ clap_builder::output::usage]  Usage::get_required_usage_from: ret_val=[]
[clap_builder::builder::command]        Command::_build_bin_names:iter: bin_name set...
[clap_builder::builder::command]        Command::_build_bin_names:iter: Setting usage_name of help to &quot;mcre_clap_generate help help&quot;
[clap_builder::builder::command]        Command::_build_bin_names:iter: Setting bin_name of help to &quot;mcre_clap_generate help help&quot;
[clap_builder::builder::command]        Command::_build_bin_names:iter: Setting display_name of help to &quot;MCRE for clap generate output-help-help&quot;
[clap_builder::builder::command]        Command::_build_bin_names
[ clap_builder::output::usage]  Usage::get_required_usage_from: incls=[], matcher=false, incl_last=true
[ clap_builder::output::usage]  Usage::get_required_usage_from: unrolled_reqs=[]
[ clap_builder::output::usage]  Usage::get_required_usage_from: ret_val=[]
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">C-bug</span> added by @mjpieters on 2023-04-03 19:05</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2023-04-03 19:40</div>
            <div class="timeline-body"><p><code>bin_name</code> would not work for this</p>
<ul>
<li>Its for usage and includes all parents</li>
<li>It can be affected by what the current process is called</li>
</ul>
<p>What we should do is add an assert that <code>name</code> does not have a space.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">M-breaking-change</span> added by @epage on 2023-04-03 19:40</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">A-builder</span> added by @epage on 2023-04-03 19:40</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone "5.0" by @epage on 2023-04-03 19:40</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/mjpieters">@mjpieters</a> on 2023-04-03 19:48</div>
            <div class="timeline-body"><blockquote>
<p><code>bin_name</code> would not work for this</p>
<ul>
<li>Its for usage and includes all parents</li>
<li>It can be affected by what the current process is called</li>
</ul>
</blockquote>
<p>Then why is the second half of the generated output using <code>get_bin_name()</code>, via <code>utils::subcommands()</code>? Because <em>those</em> are valid:</p>
<pre><code>$ tail -n75 /tmp/sample_output/mcre_clap_generate.bash
    case &quot;${cmd}&quot; in
        mcre_clap_generate)
            opts=&quot;-h --help completions help&quot;
            if [[ ${cur} == -* || ${COMP_CWORD} -eq 1 ]] ; then
                COMPREPLY=( $(compgen -W &quot;${opts}&quot; -- &quot;${cur}&quot;) )
                return 0
            fi
            case &quot;${prev}&quot; in
                *)
                    COMPREPLY=()
                    ;;
            esac
            COMPREPLY=( $(compgen -W &quot;${opts}&quot; -- &quot;${cur}&quot;) )
            return 0
            ;;
        mcre_clap_generate__completions)
            opts=&quot;-h --help &lt;OUTPUT_DIRECTORY&gt;&quot;
            if [[ ${cur} == -* || ${COMP_CWORD} -eq 2 ]] ; then
                COMPREPLY=( $(compgen -W &quot;${opts}&quot; -- &quot;${cur}&quot;) )
                return 0
            fi
            case &quot;${prev}&quot; in
                *)
                    COMPREPLY=()
                    ;;
            esac
            COMPREPLY=( $(compgen -W &quot;${opts}&quot; -- &quot;${cur}&quot;) )
            return 0
            ;;
        mcre_clap_generate__help)
            opts=&quot;completions help&quot;
            if [[ ${cur} == -* || ${COMP_CWORD} -eq 2 ]] ; then
                COMPREPLY=( $(compgen -W &quot;${opts}&quot; -- &quot;${cur}&quot;) )
                return 0
            fi
            case &quot;${prev}&quot; in
                *)
                    COMPREPLY=()
                    ;;
            esac
            COMPREPLY=( $(compgen -W &quot;${opts}&quot; -- &quot;${cur}&quot;) )
            return 0
            ;;
        mcre_clap_generate__help__completions)
            opts=&quot;&quot;
            if [[ ${cur} == -* || ${COMP_CWORD} -eq 3 ]] ; then
                COMPREPLY=( $(compgen -W &quot;${opts}&quot; -- &quot;${cur}&quot;) )
                return 0
            fi
            case &quot;${prev}&quot; in
                *)
                    COMPREPLY=()
                    ;;
            esac
            COMPREPLY=( $(compgen -W &quot;${opts}&quot; -- &quot;${cur}&quot;) )
            return 0
            ;;
        mcre_clap_generate__help__help)
            opts=&quot;&quot;
            if [[ ${cur} == -* || ${COMP_CWORD} -eq 3 ]] ; then
                COMPREPLY=( $(compgen -W &quot;${opts}&quot; -- &quot;${cur}&quot;) )
                return 0
            fi
            case &quot;${prev}&quot; in
                *)
                    COMPREPLY=()
                    ;;
            esac
            COMPREPLY=( $(compgen -W &quot;${opts}&quot; -- &quot;${cur}&quot;) )
            return 0
            ;;
    esac
}
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/mjpieters">@mjpieters</a> on 2023-04-03 20:07</div>
            <div class="timeline-body"><p>I've understood the structure of the bash completion function to be roughly this:</p>
<pre><code>    for i in ${COMP_WORDS[@]}
    do
        case &quot;${cmd},${i}&quot; in
            # expand cmd to cmd__possible_part2_word
        esac
    done

    case &quot;${cmd}&quot; in
        # provide completion words for each group and subcommand
    esac
</code></pre>
<p>The first part is generated by <code>shells::bash::Bash::all_subcommands()</code>, the second part mostly by <code>shells::bash::Bash::subcommand_details()</code> (the first option uses <code>cmd.get_bin_name()</code>). The latter uses <code>crate::generator::utils::all_subcommands()</code>, a method that produces a vector of <code>vec![sc.get_name().to_string(), sc.get_bin_name().unwrap().to_string()]</code> two-value vectors, and the details are generated using only the second element from those (so <code>sc.get_bin_name().unwrap().to_string()</code>).</p>
<p>Hence my assumption that the first part should also use those exact same strings.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../Nukesor/pueue/issues/426.html">Nukesor/pueue#426</a> on 2023-04-03 20:52</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/tv42">@tv42</a> on 2023-11-12 04:02</div>
            <div class="timeline-body"><p>I triggered something very similar by having a crate named <code>foo_bar</code> (because <code>foo</code> was taken), with the binary in <code>src/bin/foo/main.rs</code> and thus named simply <code>foo</code>. I called <code>clap_complete::generate(&quot;bash&quot;, &amp;mut command, &quot;foo&quot;, &amp;mut std::io::stdout());</code> and the completion looked like</p>
<pre><code>    for i in ${COMP_WORDS[@]}
    do
        case &quot;${cmd},${i}&quot; in
            &quot;,$1&quot;)
                cmd=&quot;foo&quot;
                ;;
            foo__bar,quux)
                cmd=&quot;foo__bar__quux&quot;
                ;;
</code></pre>
<p>Once I added <code>#[command(name = &quot;foo&quot;)]</code> into my derived <code>clap::Parser</code> struct, the completion script switched from <code>foo__bar</code> to <code>foo</code>.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 01:35:22 UTC
    </footer>
</body>
</html>
