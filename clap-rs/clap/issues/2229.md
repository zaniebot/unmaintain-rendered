```yaml
number: 2229
title: "`number_of_values(n)` incorrectly allows argument counts that are integer multiples of `n`"
type: issue
state: closed
author: elldritch
labels:
  - C-bug
assignees: []
created_at: 2020-11-28T07:24:50Z
updated_at: 2021-02-18T21:07:27Z
url: https://github.com/clap-rs/clap/issues/2229
synced_at: 2026-01-10T01:57:44Z
```

# `number_of_values(n)` incorrectly allows argument counts that are integer multiples of `n`

---

_Issue opened by @elldritch on 2020-11-28 07:24_

## Reproducing the bug

Okay, this one is a bit of a headscratcher. I've been digging into this with Rust `1.48.0` and Clap `3.0.0-beta.2`, although I bet `2.x.x` suffers from the same problem given its definition of `struct MatchedArg`.

First, a test case:

```rust
use clap::*;

fn main() {
    let m = App::new("multiple_values")
        .arg(
            Arg::new("pos")
                .about("multiple positionals")
                .number_of_values(3),
        )
        .try_get_matches_from(vec![
            "myprog", "val1", "val2", "val3", "val4", "val5", "val6",
        ]);

    assert!(m.is_err()); // This panics, because `m.is_err() == false`.
    assert_eq!(m.unwrap_err().kind, ErrorKind::WrongNumberOfValues);
}
```

This test case should obviously fail: specifying `number_of_values(3)` should not allow a successful parse if I pass 6 values. If you play around with this, you find a couple of other interesting symptoms. In general, if I call `number_of_values(x)` and pass `N` values:

- When `N == 0`, the parse incorrectly succeeds. (This is because `N % x == 0` - see below where I explain what's going on here).
- When `x > 1`:
  - When `0 < N < x`, the parse correctly fails.
  - When `N == x`, the parse correctly succeeds.
  - When `N > x && N % x == 0`, the parse incorrectly succeeds.
- When `x == 1 && N > 1`, the parse correctly fails, but returns an `UnknownArgument` error instead of the `WrongNumberOfValues` error, which is interesting but actually I think correct (because the parser is trying to interpret the extra value as a new, unknown argument rather than an additional value to the previous argument).

This is also different from setting `max_values(3)` and `min_values(3)`, which does what I want (only allow exactly three argument values), but also does so incorrectly (by ignoring multiple occurrences altogether!) and renders a different error message (`max_values` returns `TooManyValues` and `min_values` returns `TooFewValues` instead of `WrongNumberOfValues`).

## What's going on?

The issue is that validation of argument counts for multiple values and multiple occurrences of arguments is fundamentally broken because Clap doesn't store which argument values were matched in which occurrences.

I have some failing test cases set up in my fork at https://github.com/clap-rs/clap/compare/master...liftM:bug/number-of-values-multioccurrence. I tried to put together a PR patch, but I'm not sure I understand all the implications for how multiple values and occurrences are handled.

For some reason, calling `number_of_values` sends us down the path to https://github.com/clap-rs/clap/blob/08b2f4d4289eca8a9225bbc56d5a5ad1e99e38e1/src/build/arg/mod.rs#L4219-L4239 and sets `ArgSettings::MultipleValues` and `ArgSettings::MultipleOccurrences`. When the `number_of_values` validator then runs, it goes down the code path at https://github.com/clap-rs/clap/blob/08b2f4d4289eca8a9225bbc56d5a5ad1e99e38e1/src/parse/validator.rs#L445-L466 which checks that `((ma.vals.len() as u64) % num) != 0`.

I _assume_ this is happening as a hack in order to support multiple values and multiple occurrences. Unfortunately, this doesn't work:

- Documentation on the meaning of `MultipleValues` seems to be incorrect (see #1828), but I _think_ the intention of this setting is to allow multiple values to be passed into a single occurrence of an argument.
- The documentation for [`MultipleOccurrences`](https://docs.rs/clap/3.0.0-beta.2/clap/struct.Arg.html#method.multiple_occurrences) says that this setting is intended to allow multiple occurrences of an argument.
- Therefore, I think the _correct, intended_ behavior for validating argument counts should be: (1) if `MultipleOccurrences` is set, allow any number of occurrences per argument, and (2) if `MultipleValues` is set, allow a validated number of values _per argument occurrence._

Unfortunately, the current definition of `MatchedArg` at https://github.com/clap-rs/clap/blob/08b2f4d4289eca8a9225bbc56d5a5ad1e99e38e1/src/parse/matches/matched_arg.rs#L12-L18 makes this impossible, because we cannot determine which values were passed through which occurrence. I believe the correct fix here is to refactor `MatchedArg` so that we not only _count_ occurrences, but we in fact store each vector of occurrences (so that we can validate the correct _count of values per occurrence_).

Alternatively, another option is to make the design call to drop support for either multiple values or multiple occurrences. I think #2031 makes a pretty compelling argument that supporting _both_ of them is confusing for both developers and users.

---

_Label `T: bug` added by @elldritch on 2020-11-28 07:24_

---

_Renamed from "`number_of_values` incorrectly allows argument counts that are integer multiples handles combinations of _multiple values_ and _multiple occurrences_ of an argument" to "`number_of_values(n)` incorrectly allows argument counts that are integer multiples of `n`" by @elldritch on 2020-11-28 07:25_

---

_Comment by @elldritch on 2020-11-28 08:00_

~~Oh no, I accidentally hit shift-enter. Give me a moment to fix up the issue.~~

Issue is ready now. Sorry for the extra noise!

---

_Added to milestone `3.0` by @pksunkara on 2020-11-28 11:50_

---

_Comment by @pksunkara on 2020-11-28 11:52_

Yeah, I still need to go through all the `multiple` related issues and do a proper design for v3. Just short of time. If someone wants to pick this up and do a proper design and implement it, I would really appreciate it.

---

_Referenced in [clap-rs/clap#2297](../../clap-rs/clap/pulls/2297.md) on 2021-01-20 06:10_

---

_Referenced in [pop-os/system76-power#197](../../pop-os/system76-power/pulls/197.md) on 2021-01-26 18:04_

---

_Referenced in [clap-rs/clap#2350](../../clap-rs/clap/pulls/2350.md) on 2021-02-16 04:11_

---

_Closed by @pksunkara on 2021-02-18 21:07_

---
