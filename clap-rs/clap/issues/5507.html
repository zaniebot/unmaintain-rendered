<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>`exclusive` fails to take priority over `required_unless_present` flags - clap-rs/clap #5507</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>`exclusive` fails to take priority over `required_unless_present` flags</h1>

    <div class="meta">
        <span class="state state-closed">Closed</span>
        <a href="https://github.com/clap-rs/clap/issues/5507">#5507</a>
        opened by <a href="https://github.com/obskyr">@obskyr</a>
        on 2024-05-26 02:44
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/obskyr">@obskyr</a> on 2024-05-26 02:44</div>
            <div class="timeline-body"><h3>Please complete the following tasks</h3>
<ul>
<li>[X] I have searched the <a href="https://github.com/clap-rs/clap/discussions">discussions</a></li>
<li>[X] I have searched the <a href="https://github.com/clap-rs/clap/issues">open</a> and <a href="https://github.com/clap-rs/clap/issues?q=is%3Aissue+label%3AS-wont-fix+is%3Aclosed">rejected</a> issues</li>
</ul>
<h3>Rust Version</h3>
<p>rustc 1.77.2 (25ef9e3d8 2024-04-09)</p>
<h3>Clap Version</h3>
<p>4.5.4</p>
<h3>Minimal reproducible code</h3>
<p>The flags I have found to eschew <code>exclusive</code> are:</p>
<ul>
<li><p><code>required_unless_present</code></p>
<pre><code class="language-rust">#[derive(clap::Parser)]
struct Args {
    #[arg(required_unless_present(&quot;alternative_arg&quot;))]
    required_arg: Option&lt;String&gt;,
    alternative_arg: Option&lt;String&gt;,

    #[arg(exclusive = true, long, default_value_t = false)]
    exclusive_arg: bool
}

fn main() {
    let _args: Args = clap::Parser::parse();
}
</code></pre>
</li>
<li><p><code>required_unless_present_any</code></p>
<pre><code class="language-rust">#[derive(clap::Parser)]
struct Args {
    #[arg(required_unless_present_any([&quot;alternative_arg&quot;]))]
    required_arg: Option&lt;String&gt;,
    alternative_arg: Option&lt;String&gt;,

    #[arg(exclusive = true, long, default_value_t = false)]
    exclusive_arg: bool
}

fn main() {
    let _args: Args = clap::Parser::parse();
}
</code></pre>
</li>
<li><p><code>required_unless_present_all</code></p>
<pre><code class="language-rust">#[derive(clap::Parser)]
struct Args {
    #[arg(required_unless_present_all([&quot;alternative_arg&quot;]))]
    required_arg: Option&lt;String&gt;,
    alternative_arg: Option&lt;String&gt;,

    #[arg(exclusive = true, long, default_value_t = false)]
    exclusive_arg: bool
}

fn main() {
    let _args: Args = clap::Parser::parse();
}
</code></pre>
</li>
</ul>
<h3>Steps to reproduce the bug with the above code</h3>
<p><code>cargo run -- --exclusive-arg</code></p>
<h3>Actual Behaviour</h3>
<p>Clap fails to recognize that an exclusive argument has been supplied, and still requires the required arguments with an error message akin to:</p>
<pre><code>error: the following required arguments were not provided:
  &lt;REQUIRED_ARG&gt;

Usage: clap-test.exe --exclusive-arg &lt;REQUIRED_ARG&gt; [ALTERNATIVE_ARG]

For more information, try '--help'.
</code></pre>
<h3>Expected Behaviour</h3>
<p>The exclusive argument should take priority, and allow not supplying the required arguments. (If it doesn't, it makes <code>exclusive</code> useless in these cases – since it's impossible to use the exclusive argument without adding the required arguments, and if you add the required arguments, you get an error due to supplying arguments along with the exclusive one.)</p>
<h3>Additional Context</h3>
<p>Using <a href="https://docs.rs/clap/4.5.4/clap/struct.Arg.html#method.exclusive">the <code>exclusive</code> flag</a> for an argument allows it to override required arguments, as long as those arguments can be initialized without. This code that sets <code>required = true</code> on an argument still runs without error if <code>--exclusive-arg</code> is specified:</p>
<pre><code class="language-rust">#[derive(clap::Parser)]
struct Args {
    #[arg(required = true)]
    required_arg: Option&lt;String&gt;,

    #[arg(exclusive = true, long, default_value_t = false)]
    exclusive_arg: bool
}

fn main() {
    let _args: Args = clap::Parser::parse();
}
</code></pre>
<p>To match this, the same should be true for the other, more specified ways to require an argument!</p>
<p>Note that the <code>required_unless_present</code> and <code>required_unless_present_any</code> (though crucially, <em>not</em> <code>required_unless_present_all</code>) cases can be worked around by adding a special case – for example, switching out <code>required_unless_present(&quot;blah&quot;)</code> for <code>required_unless_present_any([&quot;blah&quot;, &quot;exclusive&quot;])</code>.</p>
<h3>Debug Output</h3>
<p><em>No response</em></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">C-bug</span> added by @obskyr on 2024-05-26 02:44</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">A-validators</span> added by @epage on 2024-05-27 14:35</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">E-easy</span> added by @epage on 2024-05-27 14:35</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/5520.html">clap-rs/clap#5520</a> on 2024-06-06 20:02</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @epage on 2024-06-06 20:12</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:35:09 UTC
    </footer>
</body>
</html>
