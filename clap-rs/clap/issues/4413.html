<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>clap 3.0 needs a stricter dependency on clap_derive - clap-rs/clap #4413</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>clap 3.0 needs a stricter dependency on clap_derive</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/clap-rs/clap/issues/4413">#4413</a>
        opened by <a href="https://github.com/dimo414">@dimo414</a>
        on 2022-10-21 07:45
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dimo414">@dimo414</a></div>
            <div class="timeline-body"><h3>Please complete the following tasks</h3>
<ul>
<li>[X] I have searched the <a href="https://github.com/clap-rs/clap/discussions">discussions</a></li>
<li>[X] I have searched the <a href="https://github.com/clap-rs/clap/issues">open</a> and <a href="https://github.com/clap-rs/clap/issues?q=is%3Aissue+label%3AS-wont-fix+is%3Aclosed">rejected</a> issues</li>
</ul>
<h3>Rust Version</h3>
<p>rustc 1.63.0 (4b91a6ea7 2022-08-08)</p>
<h3>Clap Version</h3>
<p>3.0.14</p>
<h3>Minimal reproducible code</h3>
<pre><code class="language-rust">use clap::Parser;

#[derive(Parser)]
struct Cli {
    #[clap(long)]
    foo: bool,
}

fn main() {
    let cli = Cli::parse();
    println!(&quot;foo:{:?}&quot;, cli.foo);
}
</code></pre>
<h3>Steps to reproduce the bug with the above code</h3>
<p>The above compiles and runs with the following dependencies:</p>
<pre><code>[dependencies]
clap = { version = &quot;~3.0&quot;, features = [&quot;derive&quot;] }
clap_derive = &quot;~3.0&quot;
</code></pre>
<p>But removing the <code>clap_derive</code> dependency and clearing <code>Cargo.lock</code> causes the build to fail:</p>
<h3>Actual Behaviour</h3>
<pre><code>$ cargo build
    Updating crates.io index
   Compiling clap_derive v3.2.18
   Compiling clap v3.0.14
   Compiling clap-demo v0.1.0
error[E0407]: method `from_arg_matches_mut` is not a member of trait `clap::FromArgMatches`
 --&gt; src/main.rs:3:10
  |
3 | #[derive(Parser)]
  |          ^^^^^^
  |          |
  |          not a member of trait `clap::FromArgMatches`
  |          help: there is an associated function with a similar name: `from_arg_matches`
  |
  = note: this error originates in the derive macro `Parser` (in Nightly builds, run with -Z macro-backtrace for more info)

error[E0407]: method `update_from_arg_matches_mut` is not a member of trait `clap::FromArgMatches`
 --&gt; src/main.rs:3:10
  |
3 | #[derive(Parser)]
  |          ^^^^^^
  |          |
  |          not a member of trait `clap::FromArgMatches`
  |          help: there is an associated function with a similar name: `update_from_arg_matches`
  |
  = note: this error originates in the derive macro `Parser` (in Nightly builds, run with -Z macro-backtrace for more info)

error[E0405]: cannot find trait `CommandFactory` in crate `clap`
 --&gt; src/main.rs:3:10
  |
3 | #[derive(Parser)]
  |          ^^^^^^ not found in `clap`
  |
  = note: this error originates in the derive macro `Parser` (in Nightly builds, run with -Z macro-backtrace for more info)

error[E0412]: cannot find type `Command` in crate `clap`
 --&gt; src/main.rs:3:10
  |
3 | #[derive(Parser)]
  |          ^^^^^^ not found in `clap`
  |
  = note: this error originates in the derive macro `Parser` (in Nightly builds, run with -Z macro-backtrace for more info)
help: consider importing this struct
  |
1 | use std::process::Command;
  |
help: if you import `Command`, refer to it directly
  |
3 - #[derive(Parser)]
3 + #[derive(Parser)]
  |

error[E0433]: failed to resolve: could not find `Command` in `clap`
 --&gt; src/main.rs:3:10
  |
3 | #[derive(Parser)]
  |          ^^^^^^ not found in `clap`
  |
  = note: this error originates in the derive macro `Parser` (in Nightly builds, run with -Z macro-backtrace for more info)
help: consider importing this struct
  |
1 | use std::process::Command;
  |
help: if you import `Command`, refer to it directly
  |
3 - #[derive(Parser)]
3 + #[derive(Parser)]
  |

Some errors have detailed explanations: E0405, E0407, E0412, E0433.
For more information about an error, try `rustc --explain E0405`.
error: could not compile `clap-demo` due to 5 previous errors
</code></pre>
<h3>Expected Behaviour</h3>
<p>I expected to be able to specify a <a href="https://doc.rust-lang.org/cargo/reference/specifying-dependencies.html#tilde-requirements">tilde requirement</a> on 3.0 and be able to use clap_derive, but because <a href="https://github.com/clap-rs/clap/blob/dc035de4094e2f336fe90bd6d3332c9711137766/Cargo.toml#L121">clap's <code>Cargo.toml</code></a> doesn't restrict the upgrade path for its <code>clap_derive</code> dep it pulls down newer, incompatible versions of <code>clap_derive</code>.</p>
<h3>Additional Context</h3>
<p>I'm planning to <a href="https://github.com/EmbarkStudios/cargo-deny/pull/431">upgrade to 3.2 eventually</a>, but for the time being I'm trying to keep a few different projects using the same syntax+version for ease of maintenance. An older project happened to migrate to 3.0 when clap_derive was on 3.1.4 and that worked without issue, but setting up a new project with clap:3.0 failed unexpectedly and confusingly, until I realized a different version of clap_derive was being linked in.</p>
<p>It looks like as of <a href="https://github.com/clap-rs/clap/blob/7598c000f9da5698fc00985dea1b8ba17e9572c5/Cargo.toml#L121">3.1.9</a> the dependency on clap_derive was constrained to a nearby version (ed57342b), but the 3.0 branch is still broken. It'd be great if a 3.0.15 patch could be cut that fixes this dep.</p>
<h3>Debug Output</h3>
<p>LMK if you need this.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">C-bug</span> added by @dimo414 on 2022-10-21 07:45</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2022-10-21 11:48</div>
            <div class="timeline-body"><p>Especially as this is an old release and there is a workaround, I don't see sufficient justification for branching and updating 3.0.x when we've already moved on to 3.1.x, 3.2.x, and 4.0.x.  As-is, 3.2.x is in maintenance mode.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @epage on 2022-10-21 11:48</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dimo414">@dimo414</a> on 2022-10-23 04:29</div>
            <div class="timeline-body"><p>I feel it's still worth cutting a new release so that it continues to compile, as this is a regression from the behavior when the release was published. Although the workaround is straightforward it's totally opaque at the error-site - you have to recognize the compilation errors indicate a bug in a longstanding release of Clap, which isn't intuitive or expected.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:48:52 UTC
    </footer>
</body>
</html>
