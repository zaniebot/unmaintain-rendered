<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CLI subcommand flags arguments not recognised after switching from NON-YAML approach to using the YAML file approach  - clap-rs/clap #1255</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>CLI subcommand flags arguments not recognised after switching from NON-YAML approach to using the YAML file approach </h1>

    <div class="meta">
        <span class="state state-closed">Closed</span>
        <a href="https://github.com/clap-rs/clap/issues/1255">#1255</a>
        opened by <a href="https://github.com/ltfschoen">@ltfschoen</a>
        on 2018-04-19 10:41
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/ltfschoen">@ltfschoen</a> on 2018-04-19 10:41</div>
            <div class="timeline-body"><h3>Rust Version</h3>
<ul>
<li>Use the output of <code>rustc -V</code></li>
</ul>
<pre><code>$ rustc -V
rustc 1.27.0-nightly (ad610bed8 2018-04-11)
</code></pre>
<h3>Affected Version of clap</h3>
<ul>
<li>Can be found in Cargo.lock of your project (i.e. <code>grep clap Cargo.lock</code>)</li>
</ul>
<pre><code>$ grep clap Cargo.lock
name = &quot;clap&quot;
 &quot;clap 2.31.2 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
&quot;checksum clap 2.31.2 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;f0f16b89cbb9ee36d87483dc939fe9f1e13c05898d56d7b230a0d4dff033a536&quot;
</code></pre>
<h3>Expected Behavior Summary</h3>
<p>I had originally implemented the <strong>first method from the documentation link that offered the advanced configuration options</strong> by following the documentation here https://docs.rs/clap/2.31.2/clap/ and my code ran successfully:</p>
<p><strong>lib.rs</strong></p>
<pre><code class="language-rust">extern crate clap;
#[macro_use] extern crate log;
extern crate env_logger;

use clap::{Arg, App, SubCommand};

pub fn main() {
	let matches = App::new(&quot;Polkadot-clone&quot;)
		.version(&quot;0.1&quot;)
		.author(&quot;Luke S. &lt;ltfschoen@gmail.com&gt;&quot;)
		.about(&quot;Implementation Polkadot node in Rust&quot;)
		.arg(Arg::with_name(&quot;log&quot;)
			.short(&quot;l&quot;)
			.value_name(&quot;LOG&quot;)
			.help(&quot;Sets logging.&quot;)
			.required(false)
			.takes_value(true))
		.subcommand(SubCommand::with_name(&quot;collator&quot;))
			.arg(Arg::with_name(&quot;c&quot;)
				.short(&quot;c&quot;)
				.help(&quot;collator in debug mode&quot;))
		.subcommand(SubCommand::with_name(&quot;validator&quot;))
			.arg(Arg::with_name(&quot;v&quot;)
				.short(&quot;v&quot;)
				.help(&quot;validator in debug mode&quot;))
		.get_matches();
</code></pre>
<p>When I ran my code with any of the following commands it worked successfully:</p>
<pre><code>```bash
cargo run -- --help

RUST_LOG=trace RUST_LOG_STYLE=auto \
cargo run -- -c -l &quot;default.conf&quot; collator

RUST_LOG=error RUST_LOG_STYLE=auto \
cargo run -- -c -l &quot;default.conf&quot; validator
```</code></pre>
<p>And it output the following when I ran <code>cargo run -- --help</code>. <strong>NOTE IMPORTANTLY</strong> how the <code>-c</code> and <code>-v</code> flags are shown listed</p>
<pre><code>$ RUST_BACKTRACE=1 cargo run -- --help
   Compiling polkadot-cli v0.1.0 (file:///Users/Me/code/blockchain/polkadot-clone/polkadot-clone/cli)
   Compiling polkadot-clone v0.1.0 (file:///Users/Me/code/blockchain/polkadot-clone/polkadot-clone)
    Finished dev [unoptimized + debuginfo] target(s) in 9.53 secs
     Running `target/debug/polkadot-clone --help`
Welcome to Polkadot Clone
Polkadot-clone 0.1
Luke S. &lt;ltfschoen@gmail.com&gt;
Implementation Polkadot node in Rust

USAGE:
    polkadot-clone [FLAGS] [OPTIONS] [SUBCOMMAND]

FLAGS:
    -c               collator in debug mode
    -h, --help       Prints help information
    -v               validator in debug mode
    -V, --version    Prints version information

OPTIONS:
    -l &lt;LOG&gt;        Sets logging.

SUBCOMMANDS:
    collator     
    help         Prints this message or the help of the given subcommand(s)
    validator  
</code></pre>
<p>And additionally it outputs the following when I run <code>cargo run -- -c -l &quot;default.conf&quot; collator</code>. <strong>NOTE IMPORTANTLY</strong> how I'm using the <code>-c</code> flag and it's working without any errors:</p>
<pre><code>$ cargo run -- -c -l &quot;default.conf&quot; collator
    Finished dev [unoptimized + debuginfo] target(s) in 0.0 secs
     Running `target/debug/polkadot-clone -c -l default.conf collator`
Welcome to Polkadot Clone
ERROR 2018-04-19T10:27:38Z: polkadot_cli: Example Error message
 WARN 2018-04-19T10:27:38Z: polkadot_cli: Example Error message
 INFO 2018-04-19T10:27:38Z: polkadot_cli: Example Info message
Value for config log pattern: default.conf
Running as collator in debug mode...
</code></pre>
<p>But then I decided to refactor my code to use the <strong>third method from the documentation of using a YAML file to build the CLI</strong></p>
<p><strong>lib.rs</strong></p>
<pre><code class="language-rust">extern crate env_logger;

#[macro_use]
extern crate clap;
#[macro_use]
extern crate log;

pub fn main() {
	let yaml = load_yaml!(&quot;cli.yml&quot;);
	let matches = clap::App::from_yaml(yaml).get_matches();
...
</code></pre>
<p><strong>cli.yml</strong></p>
<pre><code class="language-yaml">name: polkadot-clone
version: &quot;0.1&quot;
author: Luke S. &lt;ltfschoen@gmail.com&gt;
about: Implementation of Polkadot node in Rust
args:
  - log:
      short: l
      value_name: LOG
      help: Sets custom logging
      required: false
      takes_value: true
subcommands:
  - collator:
      about: Run collator node
      args:
        - c:
            short: c
            help: collator in debug mode
  - validator:
      about: Run validator node
      args:
        - v:
            short: v
            help: validator in debug mode
</code></pre>
<p>When I ran my code with the following commands that I used previously, it doesn't give me the same outputs:</p>
<pre><code>```bash
cargo run -- --help

RUST_LOG=trace RUST_LOG_STYLE=auto \
cargo run -- -c -l &quot;default.conf&quot; collator

RUST_LOG=error RUST_LOG_STYLE=auto \
cargo run -- -c -l &quot;default.conf&quot; validator
```</code></pre>
<p>And it output the following when I ran <code>cargo run -- --help</code>. <strong>NOTE IMPORTANTLY</strong> how the <code>-c</code> and <code>-v</code> flags <strong>MISSING</strong> whereas before they were shown</p>
<pre><code>$ RUST_BACKTRACE=1 cargo run -- --help
   Compiling polkadot-cli v0.1.0 (file:///Users/Me/code/blockchain/polkadot-clone/polkadot-clone/cli)
   Compiling polkadot-clone v0.1.0 (file:///Users/Me/code/blockchain/polkadot-clone/polkadot-clone)
    Finished dev [unoptimized + debuginfo] target(s) in 9.53 secs
     Running `target/debug/polkadot-clone --help`
Welcome to Polkadot Clone
Polkadot-clone 0.1
Luke S. &lt;ltfschoen@gmail.com&gt;
Implementation Polkadot node in Rust

USAGE:
    polkadot-clone [OPTIONS] [SUBCOMMAND]

FLAGS:
    -h, --help       Prints help information
    -V, --version    Prints version information

OPTIONS:
    -l &lt;LOG&gt;        Sets custom logging

SUBCOMMANDS:
    collator     Run collator node
    help         Prints this message or the help of the given subcommand(s)
    validator    Run validator node
</code></pre>
<p>And  it outputs the following when I run <code>cargo run -- -c -l &quot;default.conf&quot; collator</code>. <strong>NOTE IMPORTANTLY</strong> how because the <code>-c</code> option isn't appearing in the help menu it's failing, whereas before without using the .yaml file it worked:</p>
<pre><code>$ cargo run -- -c -l &quot;default.conf&quot; collator

error: Found argument '-c' which wasn't expected, or isn't valid in this context

USAGE:
    polkadot-clone [OPTIONS] [SUBCOMMAND]
</code></pre>
<p>I expected it to work the same way with both the non-yaml file approach as with the yaml file approach.</p>
<h3>Actual Behavior Summary</h3>
<p>I've mentioned the actual  behaviour in the expected behaviour section above</p>
<h3>Steps to Reproduce the issue</h3>
<ul>
<li>Clone my repo https://github.com/ltfschoen/polkadot-clone</li>
<li>View the NON-YAML version in the &quot;master&quot; branch</li>
<li>Switch to the &quot;clap-yaml&quot; branch where I've uploaded the version where I tried to replicate the same outputs using the YML file https://github.com/ltfschoen/polkadot-clone/compare/clap-yaml?expand=1</li>
</ul>
<h3>Sample Code or Link to Sample Code</h3>
<ul>
<li>Link to code that I was using before switching to using the approach with the cli.yml file https://github.com/ltfschoen/polkadot-clone/blob/master/cli/src/lib.rs</li>
</ul>
<h3>Debug output</h3>
<p>Compile clap with cargo features <code>&quot;debug&quot;</code> such as:</p>
<pre><code class="language-toml">[dependencies]
clap = { version = &quot;2.31.2&quot;, features = [&quot;yaml&quot;, &quot;debug&quot;] } 
</code></pre>
<pre><code>$ cargo build
   Compiling clap v2.31.2
   Compiling polkadot-cli v0.1.0 (file:///Users/Me/code/blockchain/polkadot-clone/polkadot-clone/cli)
   Compiling polkadot-clone v0.1.0 (file:///Users/Me/code/blockchain/polkadot-clone/polkadot-clone)
    Finished dev [unoptimized + debuginfo] target(s) in 18.17 secs
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/kbknapp">@kbknapp</a> on 2018-06-05 02:26</div>
            <div class="timeline-body"><p>Sorry for taking so long, I've been away with my day job for a few weeks.</p>
<p>In your original code, there is a mistake which probably led to this confusion. But let's check it out to make sure.</p>
<p>This is what you had:</p>
<pre><code class="language-rust">.subcommand(SubCommand::with_name(&quot;collator&quot;))  // &lt;-- Error! Extra &quot;)&quot; mean subcommand is done
	.arg(Arg::with_name(&quot;c&quot;)
		.short(&quot;c&quot;)
		.help(&quot;collator in debug mode&quot;))
</code></pre>
<p>How clap interprets the above:</p>
<pre><code class="language-rust">.subcommand(SubCommand::with_name(&quot;collator&quot;))
.arg(Arg::with_name(&quot;c&quot;)
	.short(&quot;c&quot;)
	.help(&quot;collator in debug mode&quot;))
</code></pre>
<p>I.e. argument <code>c</code> is actually part of the parent command and <em>not</em> part of the subcommand.</p>
<p>The correct way to make <code>c</code> a part of the subcommand is like this:</p>
<pre><code class="language-rust">.subcommand(SubCommand::with_name(&quot;collator&quot;)  // &lt;--- Notice no &quot;)&quot;
			.arg(Arg::with_name(&quot;c&quot;)
				.short(&quot;c&quot;)
				.help(&quot;collator in debug mode&quot;)))  // &lt;--- Notice extra &quot;)&quot; closing off the subcommand
</code></pre>
<p>I'm going to close this, but please let me know if I'm totally missing the issue!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @kbknapp on 2018-06-05 02:26</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/kbknapp">@kbknapp</a> on 2018-06-05 02:27</div>
            <div class="timeline-body"><p>To be more clear, in the YAML version you did it correct and the <code>c</code> arg was defined as part of the subcommand and could have been seen by <code>cargo run -- collator --help</code> or used with <code>cargo run -- collator -c</code></p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:35:07 UTC
    </footer>
</body>
</html>
