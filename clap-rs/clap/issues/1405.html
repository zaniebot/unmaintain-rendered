<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>`requires_all` on SubCommand names causes a fatal error - clap-rs/clap #1405</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1><code>requires_all</code> on SubCommand names causes a fatal error</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/clap-rs/clap/issues/1405">#1405</a>
        opened by <a href="https://github.com/drozdziak1">@drozdziak1</a>
        on 2019-01-25 22:09
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/drozdziak1">@drozdziak1</a> on 2019-01-25 22:09</div>
            <div class="timeline-body"><!--
Please use the following template to assist with creating an issue and to ensure a speedy resolution. If an area is not applicable, feel free to delete the area or mark with `N/A`
-->

<h3>Rust Version</h3>
<p>1.33 nightly</p>
<ul>
<li>Use the output of <code>rustc -V</code></li>
</ul>
<h3>Affected Version of clap</h3>
<p>2.32.0</p>
<h3>Bug or Feature Request Summary</h3>
<p>The title sums it up pretty well.</p>
<h3>Expected Behavior Summary</h3>
<p><strong>tl;dr: This behavior may be intended.</strong>
I have args common for certain subcommands. I'd expect mentioning those subcommands in <code>requires_all</code> would deny the use of those options  unless with the listed subcommands.</p>
<p>I understand why this might be a misuse of the library, it's just the error is fatal and I thought this might not be the way you'd like <code>clap</code> to handle my weird ideas.</p>
<h3>Actual Behavior Summary</h3>
<p>I get a fatal error encouraging me to write this issue :P</p>
<h3>Sample Code or Link to Sample Code</h3>
<p>My <code>App</code>:</p>
<pre><code class="language-rust">    let cli_matches = App::new(&quot;pinreq-matrix&quot;)
        .version(env!(&quot;CARGO_PKG_VERSION&quot;))
        .about(&quot;Request a pin for an IPFS hash&quot;)
        .arg(
            Arg::with_name(&quot;homeserver&quot;)
                .short(&quot;s&quot;)
                .long(&quot;server&quot;)
                .value_name(&quot;HOMESERVER&quot;)
                .help(&quot;The Matrix homeserver to use; has to be HTTPS&quot;)
                .default_value(&quot;https://matrix.org&quot;)
                .requires_all(&amp;[&quot;request&quot;, &quot;listen&quot;]),
        )
        .arg(
            Arg::with_name(&quot;room_alias&quot;)
                .help(&quot;The Matrix room to use; has to exist and be public&quot;)
                .short(&quot;r&quot;)
                .long(&quot;room&quot;)
                .value_name(&quot;ROOM_ALIAS&quot;)
                .default_value(DEFAULT_PINREQ_MATRIX_ROOM_ALIAS)
                .requires_all(&amp;[&quot;request&quot;, &quot;listen&quot;]),
        )
        .subcommand(
            SubCommand::with_name(&quot;request&quot;)
                .about(&quot;Request pinning of the specified hash&quot;)
                .arg(
                    Arg::with_name(&quot;ipfs_hash&quot;)
                        .help(&quot;The IPFS/IPNS hash to pin-request&quot;)
                        .required(true)
                        .index(1),
                ),
        )
        .subcommand(SubCommand::with_name(&quot;listen&quot;).about(&quot;Listen for pin requests&quot;))
        .get_matches();
</code></pre>
<h3>Debug output</h3>
<p><strong>Note:</strong> The line 41 mentioned in the backtrace is where <code>get_matches</code> is called for my <code>App</code> (pasted above).</p>
<details>
<summary> Debug Output </summary>
<pre>
<code>

<p>DEBUG:clap:Parser::add_subcommand: term_w=None, name=request
DEBUG:clap:Parser::add_subcommand: term_w=None, name=listen
DEBUG:clap:Parser::propagate_settings: self=pinreq-matrix, g_settings=AppFlags(
(empty)
)
DEBUG:clap:Parser::propagate_settings: sc=request, settings=AppFlags(
NEEDS_LONG_HELP | NEEDS_LONG_VERSION | NEEDS_SC_HELP | UTF8_NONE | COLOR_AUTO
), g_settings=AppFlags(
(empty)
)
DEBUG:clap:Parser::propagate_settings: self=request, g_settings=AppFlags(
(empty)
)
DEBUG:clap:Parser::propagate_settings: sc=listen, settings=AppFlags(
NEEDS_LONG_HELP | NEEDS_LONG_VERSION | NEEDS_SC_HELP | UTF8_NONE | COLOR_AUTO
), g_settings=AppFlags(
(empty)
)
DEBUG:clap:Parser::propagate_settings: self=listen, g_settings=AppFlags(
(empty)
)
DEBUG:clap:Parser::get_matches_with;
DEBUG:clap:Parser::create_help_and_version;
DEBUG:clap:Parser::create_help_and_version: Building --help
DEBUG:clap:Parser::create_help_and_version: Building --version
DEBUG:clap:Parser::create_help_and_version: Building help
DEBUG:clap:ArgMatcher::process_arg_overrides:None;
DEBUG:clap:Parser::remove_overrides:[];
DEBUG:clap:Validator::validate;
DEBUG:clap:Parser::add_defaults;
DEBUG:clap:Parser::add_defaults:iter:homeserver: doesn't have conditional defaults
DEBUG:clap:Parser::add_defaults:iter:homeserver: has default vals
DEBUG:clap:Parser::add_defaults:iter:homeserver: wasn't used
DEBUG:clap:Parser::add_val_to_arg; arg=homeserver, val=&quot;https://matrix.org&quot;
DEBUG:clap:Parser::add_val_to_arg; trailing_vals=false, DontDelimTrailingVals=false
DEBUG:clap:Parser::add_single_val_to_arg;
DEBUG:clap:Parser::add_single_val_to_arg: adding val...&quot;https://matrix.org&quot;
DEBUG:clap:Parser::groups_for_arg: name=homeserver
DEBUG:clap:Parser::groups_for_arg: No groups defined
DEBUG:clap:ArgMatcher::needs_more_vals: o=homeserver
DEBUG:clap:Parser::add_defaults:iter:room_alias: doesn't have conditional defaults
DEBUG:clap:Parser::add_defaults:iter:room_alias: has default vals
DEBUG:clap:Parser::add_defaults:iter:room_alias: wasn't used
DEBUG:clap:Parser::add_val_to_arg; arg=room_alias, val=&quot;ipfs-pinreq&quot;
DEBUG:clap:Parser::add_val_to_arg; trailing_vals=false, DontDelimTrailingVals=false
DEBUG:clap:Parser::add_single_val_to_arg;
DEBUG:clap:Parser::add_single_val_to_arg: adding val...&quot;ipfs-pinreq&quot;
DEBUG:clap:Parser::groups_for_arg: name=room_alias
DEBUG:clap:Parser::groups_for_arg: No groups defined
DEBUG:clap:ArgMatcher::needs_more_vals: o=room_alias
DEBUG:clap:Validator::validate_blacklist;
DEBUG:clap:Validator::validate_blacklist:iter:homeserver;
DEBUG:clap:Parser::groups_for_arg: name=homeserver
DEBUG:clap:Parser::groups_for_arg: No groups defined
DEBUG:clap:Validator::validate_blacklist:iter:room_alias;
DEBUG:clap:Parser::groups_for_arg: name=room_alias
DEBUG:clap:Parser::groups_for_arg: No groups defined
DEBUG:clap:Validator::validate_required: required=[];
DEBUG:clap:Validator::validate_matched_args;
DEBUG:clap:Validator::validate_matched_args:iter:homeserver: vals=[
&quot;https://matrix.org&quot;
]
DEBUG:clap:Validator::validate_arg_num_vals:homeserver
DEBUG:clap:Validator::validate_arg_values: arg=&quot;homeserver&quot;
DEBUG:clap:Validator::validate_arg_requires:homeserver;
DEBUG:clap:Validator::missing_required_error: extra=Some(&quot;request&quot;)
DEBUG:clap:Parser::color;
DEBUG:clap:Parser::color: Color setting...Auto
DEBUG:clap:is_a_tty: stderr=true
DEBUG:clap:Validator::missing_required_error: reqs=[
&quot;request&quot;
]
DEBUG:clap:usage::get_required_usage_from: reqs=[&quot;request&quot;], extra=Some(&quot;request&quot;)
DEBUG:clap:usage::get_required_usage_from: after init desc_reqs=[&quot;request&quot;]
DEBUG:clap:usage::get_required_usage_from: no more children
DEBUG:clap:usage::get_required_usage_from: final desc_reqs=[&quot;request&quot;]
DEBUG:clap:usage::get_required_usage_from: args_in_groups=[]
DEBUG:clap:usage::get_required_usage_from:iter:request:
thread 'main' panicked at 'Fatal internal error. Please consider filing a bug report at https://github.com/kbknapp/clap-rs/issues', src/libcore/option.rs:1038:5
note: Run with <code>RUST_BACKTRACE=1</code> environment variable to display a backtrace.
✘ ⚙ drozdziak1@Arcydiakon  ~/rust/pinreq   master ●✚  RUST_BACKTRACE=1 cargo run --bin pinreq-matrix
Finished dev [unoptimized + debuginfo] target(s) in 0.22s
Running <code>target/debug/pinreq-matrix</code>
DEBUG:clap:Parser::add_subcommand: term_w=None, name=request
DEBUG:clap:Parser::add_subcommand: term_w=None, name=listen
DEBUG:clap:Parser::propagate_settings: self=pinreq-matrix, g_settings=AppFlags(
(empty)
)
DEBUG:clap:Parser::propagate_settings: sc=request, settings=AppFlags(
NEEDS_LONG_HELP | NEEDS_LONG_VERSION | NEEDS_SC_HELP | UTF8_NONE | COLOR_AUTO
), g_settings=AppFlags(
(empty)
)
DEBUG:clap:Parser::propagate_settings: self=request, g_settings=AppFlags(
(empty)
)
DEBUG:clap:Parser::propagate_settings: sc=listen, settings=AppFlags(
NEEDS_LONG_HELP | NEEDS_LONG_VERSION | NEEDS_SC_HELP | UTF8_NONE | COLOR_AUTO
), g_settings=AppFlags(
(empty)
)
DEBUG:clap:Parser::propagate_settings: self=listen, g_settings=AppFlags(
(empty)
)
DEBUG:clap:Parser::get_matches_with;
DEBUG:clap:Parser::create_help_and_version;
DEBUG:clap:Parser::create_help_and_version: Building --help
DEBUG:clap:Parser::create_help_and_version: Building --version
DEBUG:clap:Parser::create_help_and_version: Building help
DEBUG:clap:ArgMatcher::process_arg_overrides:None;
DEBUG:clap:Parser::remove_overrides:[];
DEBUG:clap:Validator::validate;
DEBUG:clap:Parser::add_defaults;
DEBUG:clap:Parser::add_defaults:iter:homeserver: doesn't have conditional defaults
DEBUG:clap:Parser::add_defaults:iter:homeserver: has default vals
DEBUG:clap:Parser::add_defaults:iter:homeserver: wasn't used
DEBUG:clap:Parser::add_val_to_arg; arg=homeserver, val=&quot;https://matrix.org&quot;
DEBUG:clap:Parser::add_val_to_arg; trailing_vals=false, DontDelimTrailingVals=false
DEBUG:clap:Parser::add_single_val_to_arg;
DEBUG:clap:Parser::add_single_val_to_arg: adding val...&quot;https://matrix.org&quot;
DEBUG:clap:Parser::groups_for_arg: name=homeserver
DEBUG:clap:Parser::groups_for_arg: No groups defined
DEBUG:clap:ArgMatcher::needs_more_vals: o=homeserver
DEBUG:clap:Parser::add_defaults:iter:room_alias: doesn't have conditional defaults
DEBUG:clap:Parser::add_defaults:iter:room_alias: has default vals
DEBUG:clap:Parser::add_defaults:iter:room_alias: wasn't used
DEBUG:clap:Parser::add_val_to_arg; arg=room_alias, val=&quot;ipfs-pinreq&quot;
DEBUG:clap:Parser::add_val_to_arg; trailing_vals=false, DontDelimTrailingVals=false
DEBUG:clap:Parser::add_single_val_to_arg;
DEBUG:clap:Parser::add_single_val_to_arg: adding val...&quot;ipfs-pinreq&quot;
DEBUG:clap:Parser::groups_for_arg: name=room_alias
DEBUG:clap:Parser::groups_for_arg: No groups defined
DEBUG:clap:ArgMatcher::needs_more_vals: o=room_alias
DEBUG:clap:Validator::validate_blacklist;
DEBUG:clap:Validator::validate_blacklist:iter:homeserver;
DEBUG:clap:Parser::groups_for_arg: name=homeserver
DEBUG:clap:Parser::groups_for_arg: No groups defined
DEBUG:clap:Validator::validate_blacklist:iter:room_alias;
DEBUG:clap:Parser::groups_for_arg: name=room_alias
DEBUG:clap:Parser::groups_for_arg: No groups defined
DEBUG:clap:Validator::validate_required: required=[];
DEBUG:clap:Validator::validate_matched_args;
DEBUG:clap:Validator::validate_matched_args:iter:homeserver: vals=[
&quot;https://matrix.org&quot;
]
DEBUG:clap:Validator::validate_arg_num_vals:homeserver
DEBUG:clap:Validator::validate_arg_values: arg=&quot;homeserver&quot;
DEBUG:clap:Validator::validate_arg_requires:homeserver;
DEBUG:clap:Validator::missing_required_error: extra=Some(&quot;request&quot;)
DEBUG:clap:Parser::color;
DEBUG:clap:Parser::color: Color setting...Auto
DEBUG:clap:is_a_tty: stderr=true
DEBUG:clap:Validator::missing_required_error: reqs=[
&quot;request&quot;
]
DEBUG:clap:usage::get_required_usage_from: reqs=[&quot;request&quot;], extra=Some(&quot;request&quot;)
DEBUG:clap:usage::get_required_usage_from: after init desc_reqs=[&quot;request&quot;]
DEBUG:clap:usage::get_required_usage_from: no more children
DEBUG:clap:usage::get_required_usage_from: final desc_reqs=[&quot;request&quot;]
DEBUG:clap:usage::get_required_usage_from: args_in_groups=[]
DEBUG:clap:usage::get_required_usage_from:iter:request:
thread 'main' panicked at 'Fatal internal error. Please consider filing a bug report at https://github.com/kbknapp/clap-rs/issues', src/libcore/option.rs:1038:5
stack backtrace:
0: std::sys::unix::backtrace::tracing::imp::unwind_backtrace
at src/libstd/sys/unix/backtrace/tracing/gcc_s.rs:39
1: std::sys_common::backtrace::_print
at src/libstd/sys_common/backtrace.rs:70
2: std::panicking::default_hook::{{closure}}
at src/libstd/sys_common/backtrace.rs:58
at src/libstd/panicking.rs:200
3: std::panicking::default_hook
at src/libstd/panicking.rs:215
4: std::panicking::rust_panic_with_hook
at src/libstd/panicking.rs:478
5: std::panicking::continue_panic_fmt
at src/libstd/panicking.rs:385
6: rust_begin_unwind
at src/libstd/panicking.rs:312
7: core::panicking::panic_fmt
at src/libcore/panicking.rs:85
8: core::option::expect_failed
at src/libcore/option.rs:1038
9: &lt;core::option::Option<T>&gt;::expect
at /rustc/4c2be9c97fb60a01c545b8e8fa61e4247ae5c9b2/src/libcore/option.rs:312
10: clap::app::usage::get_required_usage_from::{{closure}}
at /home/drozdziak1/.cargo/registry/src/github.com-1ecc6299db9ec823/clap-2.32.0/src/app/usage.rs:457
11: &lt;core::option::Option<T>&gt;::unwrap_or_else
at /rustc/4c2be9c97fb60a01c545b8e8fa61e4247ae5c9b2/src/libcore/option.rs:386
12: clap::app::usage::get_required_usage_from
at /home/drozdziak1/.cargo/registry/src/github.com-1ecc6299db9ec823/clap-2.32.0/src/app/usage.rs:454
13: clap::app::validator::Validator::missing_required_error
at /home/drozdziak1/.cargo/registry/src/github.com-1ecc6299db9ec823/clap-2.32.0/src/app/validator.rs:551
14: clap::app::validator::Validator::validate_arg_requires
at /home/drozdziak1/.cargo/registry/src/github.com-1ecc6299db9ec823/clap-2.32.0/src/app/validator.rs:436
15: clap::app::validator::Validator::validate_matched_args
at /home/drozdziak1/.cargo/registry/src/github.com-1ecc6299db9ec823/clap-2.32.0/src/app/validator.rs:285
16: clap::app::validator::Validator::validate
at /home/drozdziak1/.cargo/registry/src/github.com-1ecc6299db9ec823/clap-2.32.0/src/app/validator.rs:77
17: clap::app::parser::Parser::get_matches_with
at /home/drozdziak1/.cargo/registry/src/github.com-1ecc6299db9ec823/clap-2.32.0/src/app/parser.rs:1199
18: clap::app::App::get_matches_from_safe_borrow
at /home/drozdziak1/.cargo/registry/src/github.com-1ecc6299db9ec823/clap-2.32.0/src/app/mod.rs:1633
19: clap::app::App::get_matches_from
at /home/drozdziak1/.cargo/registry/src/github.com-1ecc6299db9ec823/clap-2.32.0/src/app/mod.rs:1513
20: clap::app::App::get_matches
at /home/drozdziak1/.cargo/registry/src/github.com-1ecc6299db9ec823/clap-2.32.0/src/app/mod.rs:1455
21: pinreq_matrix::main
at src/pinreq_matrix.rs:41
22: std::rt::lang_start::{{closure}}
at /rustc/4c2be9c97fb60a01c545b8e8fa61e4247ae5c9b2/src/libstd/rt.rs:64
23: std::panicking::try::do_call
at src/libstd/rt.rs:49
at src/libstd/panicking.rs:297
24: __rust_maybe_catch_panic
at src/libpanic_unwind/lib.rs:92
25: std::rt::lang_start_internal
at src/libstd/panicking.rs:276
at src/libstd/panic.rs:388
at src/libstd/rt.rs:48
26: std::rt::lang_start
at /rustc/4c2be9c97fb60a01c545b8e8fa61e4247ae5c9b2/src/libstd/rt.rs:64
27: main
28: __libc_start_main
29: _start</p>
</code>
</pre>
</details>

</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/drozdziak1">@drozdziak1</a> on 2019-01-26 12:14</div>
            <div class="timeline-body"><p>There's no way someone might want to use clap that way, I misunderstood what <code>requires_all()</code> does, closing.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @CreepySkeleton on 2020-02-01 15:14</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">T: RFC / question</span> added by @pksunkara on 2020-02-01 19:17</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 12:31:41 UTC
    </footer>
</body>
</html>
