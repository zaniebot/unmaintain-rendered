<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Issue when inferring lifetimes when used with serde. - clap-rs/clap #4349</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Issue when inferring lifetimes when used with serde.</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/clap-rs/clap/issues/4349">#4349</a>
        opened by <a href="https://github.com/0xForerunner">@0xForerunner</a>
        on 2022-10-05 08:02
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/0xForerunner">@0xForerunner</a> on 2022-10-05 08:02</div>
            <div class="timeline-body"><h3>Please complete the following tasks</h3>
<ul>
<li>[X] I have searched the <a href="https://github.com/clap-rs/clap/discussions">discussions</a></li>
<li>[X] I have searched the <a href="https://github.com/clap-rs/clap/issues">open</a> and <a href="https://github.com/clap-rs/clap/issues?q=is%3Aissue+label%3AS-wont-fix+is%3Aclosed">rejected</a> issues</li>
</ul>
<h3>Rust Version</h3>
<p>rustc 1.66.0-nightly (01af5040f 2022-10-04)</p>
<h3>Clap Version</h3>
<p>clap = { version = &quot;4.0.8&quot;, features = [&quot;derive&quot;] }</p>
<h3>Minimal reproducible code</h3>
<pre><code class="language-rust">#[derive(Serialize, Deserialize, Clone, Debug, PartialEq, JsonSchema, Subcommand)]
#[serde(rename_all = &quot;snake_case&quot;)]
pub enum QueryMsg {
    GetPrice {
        #[arg(value_parser = serde_json::from_str::&lt;AssetInfo&gt;)]
        asset:  AssetInfo,
    },
    GetPrices {
        #[arg(value_parser = serde_json::from_str::&lt;Vec&lt;AssetInfo&gt;&gt;)]
        assets: Vec&lt;AssetInfo&gt;,
    },
    GetAllPrices {
        #[arg(value_parser = serde_json::from_str::&lt;Option&lt;AssetInfo&gt;&gt;)]
        start_after:    Option&lt;AssetInfo&gt;,
        limit:          Option&lt;u32&gt;,
    },
}

#[derive(Serialize, Deserialize, Clone, Debug, Hash, PartialEq, Eq, JsonSchema, PartialOrd, Ord)]
#[serde(rename_all = &quot;snake_case&quot;)]
#[repr(u8)]
pub enum AssetInfo {
    Token { contract_addr: Addr },
    NativeToken { denom: String },
}
</code></pre>
<pre><code class="language-toml">clap = { version = &quot;4.0.8&quot;, features = [&quot;derive&quot;] }
serde_json = &quot;1.0&quot;
serde = { version = &quot;1.0.137&quot;, default-features = false, features = [&quot;derive&quot;] }
</code></pre>
<h3>Steps to reproduce the bug with the above code</h3>
<p>This won't compile.</p>
<h3>Actual Behaviour</h3>
<pre><code>error: implementation of `FnOnce` is not general enough
  --&gt; packages/lending/src/price_oracle.rs:42:71
   |
42 | #[derive(Serialize, Deserialize, Clone, Debug, PartialEq, JsonSchema, Subcommand)]
   |                                                                       ^^^^^^^^^^ implementation of `FnOnce` is not general enough
   |
   = note: `fn(&amp;'2 str) -&gt; Result&lt;AssetInfo, serde_json::Error&gt; {serde_json::from_str::&lt;'2, AssetInfo&gt;}` must implement `FnOnce&lt;(&amp;'1 str,)&gt;`, for any lifetime `'1`...
   = note: ...but it actually implements `FnOnce&lt;(&amp;'2 str,)&gt;`, for some specific lifetime `'2`
   = note: this error originates in the derive macro `Subcommand` (in Nightly builds, run with -Z macro-backtrace for more info)

error[E0308]: mismatched types
   --&gt; packages/lending/src/price_oracle.rs:42:71
    |
42  | #[derive(Serialize, Deserialize, Clone, Debug, PartialEq, JsonSchema, Subcommand)]
    |                                                                       ^^^^^^^^^^ one type is more general than the other
    |
    = note: expected trait `for&lt;'a&gt; Fn&lt;(&amp;'a str,)&gt;`
               found trait `Fn&lt;(&amp;str,)&gt;`
note: the lifetime requirement is introduced here
   --&gt; /Users/ewoolsey/.cargo/registry/src/github.com-1ecc6299db9ec823/clap-4.0.8/src/builder/arg.rs:943:48
    |
943 |     pub fn value_parser(mut self, parser: impl IntoResettable&lt;super::ValueParser&gt;) -&gt; Self {
    |                                                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    = note: this error originates in the derive macro `Subcommand` (in Nightly builds, run with -Z macro-backtrace for more info)

error: implementation of `FnOnce` is not general enough
  --&gt; packages/lending/src/price_oracle.rs:42:71
   |
42 | #[derive(Serialize, Deserialize, Clone, Debug, PartialEq, JsonSchema, Subcommand)]
   |                                                                       ^^^^^^^^^^ implementation of `FnOnce` is not general enough
   |
   = note: `fn(&amp;'2 str) -&gt; Result&lt;std::vec::Vec&lt;AssetInfo&gt;, serde_json::Error&gt; {serde_json::from_str::&lt;'2, std::vec::Vec&lt;AssetInfo&gt;&gt;}` must implement `FnOnce&lt;(&amp;'1 str,)&gt;`, for any lifetime `'1`...
   = note: ...but it actually implements `FnOnce&lt;(&amp;'2 str,)&gt;`, for some specific lifetime `'2`
   = note: this error originates in the derive macro `Subcommand` (in Nightly builds, run with -Z macro-backtrace for more info)

error: implementation of `FnOnce` is not general enough
  --&gt; packages/lending/src/price_oracle.rs:42:71
   |
42 | #[derive(Serialize, Deserialize, Clone, Debug, PartialEq, JsonSchema, Subcommand)]
   |                                                                       ^^^^^^^^^^ implementation of `FnOnce` is not general enough
   |
   = note: `fn(&amp;'2 str) -&gt; Result&lt;std::option::Option&lt;AssetInfo&gt;, serde_json::Error&gt; {serde_json::from_str::&lt;'2, std::option::Option&lt;AssetInfo&gt;&gt;}` must implement `FnOnce&lt;(&amp;'1 str,)&gt;`, for any lifetime `'1`...
   = note: ...but it actually implements `FnOnce&lt;(&amp;'2 str,)&gt;`, for some specific lifetime `'2`
   = note: this error originates in the derive macro `Subcommand` (in Nightly builds, run with -Z macro-backtrace for more info)

For more information about this error, try `rustc --explain E0308`.
warning: `lending` (lib) generated 1 warning
error: could not compile `lending` due to 4 previous errors; 1 warning emitted
</code></pre>
<h3>Expected Behaviour</h3>
<p>This is significantly above my head. Not sure what the solution is.</p>
<h3>Additional Context</h3>
<p><em>No response</em></p>
<h3>Debug Output</h3>
<p>nothing changed.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">C-bug</span> added by @0xForerunner on 2022-10-05 08:02</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2022-10-05 13:21</div>
            <div class="timeline-body"><ol>
<li>Could you provide a complete reproduction case?</li>
<li>Is that the full list of errors?  We've sometimes seen a different error was actually the cause of that specific error</li>
<li>Are all of your field types <code>Clone</code>?</li>
</ol>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/0xForerunner">@0xForerunner</a> on 2022-10-05 15:41</div>
            <div class="timeline-body"><ol>
<li>right I forgot Addr.</li>
</ol>
<pre><code>#[derive(
    Serialize, Deserialize, Clone, Debug, PartialEq, Eq, PartialOrd, Ord, Hash, JsonSchema,
)]
pub struct Addr(String);
</code></pre>
<ol start="2">
<li>yes this was the full list of errors.</li>
<li>Yes they are.</li>
</ol>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2022-10-05 16:04</div>
            <div class="timeline-body"><p>Please next time, include a full reproduction case so I don't have to work backwards to create all of the scaffolding that was elided.</p>
<p>Below is what I&quot;m using for this issue.  It goes a step further and uses <code>rust-script</code> to include the manifest.</p>
<pre><code class="language-rust">#!/usr/bin/env -S rust-script

//! ```cargo
//! [dependencies]
//! clap = { version = &quot;4.0.8&quot;, features = [&quot;derive&quot;, &quot;wrap_help&quot;, &quot;env&quot;] }
//! serde_json = &quot;1.0&quot;
//! serde = { version = &quot;1.0.137&quot;, features = [&quot;derive&quot;] }
//! ```

use clap::Parser;
use clap::Subcommand;
use serde::Deserialize;
use serde::Serialize;

#[derive(Parser, Debug)]
#[clap(author, version, about, long_about = None)]
struct Cli {
    #[command(subcommand)]
    command: QueryMsg,
}

#[derive(Serialize, Deserialize, Clone, Debug, PartialEq, Subcommand)]
#[serde(rename_all = &quot;snake_case&quot;)]
pub enum QueryMsg {
    GetPrice {
        #[arg(value_parser = serde_json::from_str::&lt;AssetInfo&gt;)]
        asset: AssetInfo,
    },
    GetPrices {
        #[arg(value_parser = serde_json::from_str::&lt;Vec&lt;AssetInfo&gt;&gt;)]
        assets: Vec&lt;AssetInfo&gt;,
    },
    GetAllPrices {
        #[arg(value_parser = serde_json::from_str::&lt;Option&lt;AssetInfo&gt;&gt;)]
        start_after: Option&lt;AssetInfo&gt;,
        limit: Option&lt;u32&gt;,
    },
}

#[derive(Serialize, Deserialize, Clone, Debug, Hash, PartialEq, Eq, PartialOrd, Ord)]
#[serde(rename_all = &quot;snake_case&quot;)]
#[repr(u8)]
pub enum AssetInfo {
    Token { contract_addr: Addr },
    NativeToken { denom: String },
}

#[derive(Serialize, Deserialize, Clone, Debug, PartialEq, Eq, PartialOrd, Ord, Hash)]
pub struct Addr(String);

fn main() {
    let args: Cli = Cli::parse();
    println!(&quot;{:?}&quot;, args);
}
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2022-10-05 16:08</div>
            <div class="timeline-body"><p>Still double checking some things but the following works around the problem:</p>
<pre><code class="language-rust">#!/usr/bin/env -S rust-script

//! ```cargo
//! [dependencies]
//! clap = { version = &quot;4.0.8&quot;, features = [&quot;derive&quot;, &quot;wrap_help&quot;, &quot;env&quot;] }
//! serde_json = &quot;1.0&quot;
//! serde = { version = &quot;1.0.137&quot;, features = [&quot;derive&quot;] }
//! ```

use clap::Parser;
use clap::Subcommand;
use serde::Deserialize;
use serde::Serialize;

#[derive(Parser, Debug)]
#[clap(author, version, about, long_about = None)]
struct Cli {
    #[command(subcommand)]
    command: QueryMsg,
}

#[derive(Serialize, Deserialize, Clone, Debug, PartialEq, Subcommand)]
#[serde(rename_all = &quot;snake_case&quot;)]
pub enum QueryMsg {
    GetPrice {
        #[arg(value_parser = asset_parser)]
        asset: AssetInfo,
    },
    GetPrices {
        #[arg(value_parser = asset_parser)]
        assets: Vec&lt;AssetInfo&gt;,
    },
    GetAllPrices {
        #[arg(value_parser = asset_parser)]
        start_after: Option&lt;AssetInfo&gt;,
        limit: Option&lt;u32&gt;,
    },
}

fn asset_parser(s: &amp;str) -&gt; Result&lt;AssetInfo, serde_json::Error&gt; {
    serde_json::from_str::&lt;AssetInfo&gt;(s)
}

#[derive(Serialize, Deserialize, Clone, Debug, Hash, PartialEq, Eq, PartialOrd, Ord)]
#[serde(rename_all = &quot;snake_case&quot;)]
#[repr(u8)]
pub enum AssetInfo {
    Token { contract_addr: Addr },
    NativeToken { denom: String },
}

#[derive(Serialize, Deserialize, Clone, Debug, PartialEq, Eq, PartialOrd, Ord, Hash)]
pub struct Addr(String);

fn main() {
    let args: Cli = Cli::parse();
    println!(&quot;{:?}&quot;, args);
}
</code></pre>
<p>Besides breaking out <code>asset_parser</code>, this fixes the <code>value_parser</code> so it generates the actual type (<code>AssetInfo</code>).  <code>Vec</code> and <code>Option</code> are handled by clap as part of the parsing arguments.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2022-10-05 16:13</div>
            <div class="timeline-body"><p>I think this error is key:</p>
<pre><code>error[E0308]: mismatched types
   --&gt; clap-4349.rs:22:59
    |
22  | #[derive(Serialize, Deserialize, Clone, Debug, PartialEq, Subcommand)]
    |                                                           ^^^^^^^^^^ one type is more general than the other
    |
    = note: expected trait `for&lt;'r&gt; Fn&lt;(&amp;'r str,)&gt;`
               found trait `Fn&lt;(&amp;str,)&gt;`
</code></pre>
<p><code>from_str</code> is defined as:</p>
<pre><code class="language-rust">pub fn from_str&lt;'a, T&gt;(s: &amp;'a str) -&gt; Result&lt;T&gt; where
    T: Deserialize&lt;'a&gt;,
</code></pre>
<p>and I suspect the <code>T: Deserialize&lt;'a&gt;</code> bound is confusing things.</p>
<p>I am not aware of a way to loosen things so we can work with <code>serde_json::from_str</code> without something clarifying the types to the compiler, like an intermediate function.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">E-hard</span> added by @epage on 2022-10-05 16:13</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">A-derive</span> added by @epage on 2022-10-05 16:13</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">E-help-wanted</span> added by @epage on 2022-10-05 16:13</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/0xForerunner">@0xForerunner</a> on 2022-10-05 16:25</div>
            <div class="timeline-body"><p>Thanks for your hard work! Really appreciate it. If you have any ideas, let me know!</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 01:35:12 UTC
    </footer>
</body>
</html>
