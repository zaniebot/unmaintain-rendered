<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fatal internal error - clap-rs/clap #2197</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Fatal internal error</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/clap-rs/clap/issues/2197">#2197</a>
        opened by <a href="https://github.com/AldaronLau">@AldaronLau</a>
        on 2020-11-01 18:41
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AldaronLau">@AldaronLau</a></div>
            <div class="timeline-body">Code
<p>https://github.com/fornwall/rust-script</p>
Steps to reproduce the issue
<ol>
<li>Run <code>cargo install rust-script</code></li>
<li>Run <code>rust-script --build-only script-name.rs</code></li>
</ol>
Version
<ul>
<li><strong>Rust</strong>: rustc 1.47.0 (18bf6b4f0 2020-10-07)</li>
<li><strong>Clap</strong>: 2.33.3</li>
</ul>
Actual Behavior Summary
<p>When I add <code>--build-only</code> option before the next argument, it crashes on internal error, and I think it shouldn&#x27;t.  Interestingly, this doesn&#x27;t happen for other options like <code>--debug</code> (leaving everything else the same).</p>
<p><strong>I would like to use rust-script (which depends on clap) for stick, and this makes it so I can&#x27;t use the --build-only option.</strong></p>
Expected Behavior Summary
<p>It should not crash internally within the clap library, even if it is a rust-script bug.</p>
Debug output

 Debug Output 
<pre>
<code>

<p>DEBUG:clap:Parser::propagate_settings: self=rust-script, g_settings=AppFlags(
(empty),
)
DEBUG:clap:Parser::get_matches_with;
DEBUG:clap:Parser::create_help_and_version;
DEBUG:clap:Parser::create_help_and_version: Building --help
DEBUG:clap:Parser::create_help_and_version: Building --version
DEBUG:clap:Parser::get_matches_with: Begin parsing &#x27;&quot;--build-only&quot;&#x27; ([45, 45, 98, 117, 105, 108, 100, 45, 111, 110, 108, 121])
DEBUG:clap:Parser::is_new_arg:&quot;--build-only&quot;:NotFound
DEBUG:clap:Parser::is_new_arg: arg_allows_tac=false
DEBUG:clap:Parser::is_new_arg: -- found
DEBUG:clap:Parser::is_new_arg: starts_new_arg=true
DEBUG:clap:Parser::possible_subcommand: arg=&quot;--build-only&quot;
DEBUG:clap:Parser::get_matches_with: possible_sc=false, sc=None
DEBUG:clap:ArgMatcher::process_arg_overrides:None;
DEBUG:clap:Parser::parse_long_arg;
DEBUG:clap:Parser::parse_long_arg: Does it contain &#x27;=&#x27;...No
DEBUG:clap:Parser::parse_long_arg: Found valid flag &#x27;--build-only&#x27;
DEBUG:clap:Parser::check_for_help_and_version_str;
DEBUG:clap:Parser::check_for_help_and_version_str: Checking if --build-only is help or version...Neither
DEBUG:clap:Parser::parse_flag;
DEBUG:clap:ArgMatcher::inc_occurrence_of: arg=build_only
DEBUG:clap:ArgMatcher::inc_occurrence_of: first instance
DEBUG:clap:Parser::groups_for_arg: name=build_only
DEBUG:clap:Parser::groups_for_arg: Searching through groups...
DEBUG:clap:Parser:get_matches_with: After parse_long_arg Flag
DEBUG:clap:Parser::get_matches_with: Begin parsing &#x27;&quot;fmt_db.rs&quot;&#x27; ([102, 109, 116, 95, 100, 98, 46, 114, 115])
DEBUG:clap:Parser::is_new_arg:&quot;fmt_db.rs&quot;:Flag
DEBUG:clap:Parser::is_new_arg: arg_allows_tac=false
DEBUG:clap:Parser::is_new_arg: probably value
DEBUG:clap:Parser::is_new_arg: starts_new_arg=false
DEBUG:clap:Parser::possible_subcommand: arg=&quot;fmt_db.rs&quot;
DEBUG:clap:Parser::get_matches_with: possible_sc=false, sc=None
DEBUG:clap:Parser::get_matches_with: Positional counter...1
DEBUG:clap:Parser::get_matches_with: Low index multiples...false
DEBUG:clap:ArgMatcher::process_arg_overrides:Some(&quot;build_only&quot;);
DEBUG:clap:Parser::add_val_to_arg; arg=command, val=&quot;fmt_db.rs&quot;
DEBUG:clap:Parser::add_val_to_arg; trailing_vals=true, DontDelimTrailingVals=false
DEBUG:clap:Parser::add_single_val_to_arg;
DEBUG:clap:Parser::add_single_val_to_arg: adding val...&quot;fmt_db.rs&quot;
DEBUG:clap:Parser::groups_for_arg: name=command
DEBUG:clap:Parser::groups_for_arg: Searching through groups...
DEBUG:clap:ArgMatcher::needs_more_vals: o=command
DEBUG:clap:ArgMatcher::inc_occurrence_of: arg=command
DEBUG:clap:Parser::groups_for_arg: name=command
DEBUG:clap:Parser::groups_for_arg: Searching through groups...
DEBUG:clap:ArgMatcher::process_arg_overrides:Some(&quot;command&quot;);
DEBUG:clap:Parser::remove_overrides:[];
DEBUG:clap:Validator::validate;
DEBUG:clap:Parser::add_defaults;
DEBUG:clap:Parser::add_defaults:iter:dep: doesn&#x27;t have conditional defaults
DEBUG:clap:Parser::add_defaults:iter:dep: doesn&#x27;t have default vals
DEBUG:clap:Parser::add_defaults:iter:dep_extern: doesn&#x27;t have conditional defaults
DEBUG:clap:Parser::add_defaults:iter:dep_extern: doesn&#x27;t have default vals
DEBUG:clap:Parser::add_defaults:iter:extern: doesn&#x27;t have conditional defaults
DEBUG:clap:Parser::add_defaults:iter:extern: doesn&#x27;t have default vals
DEBUG:clap:Parser::add_defaults:iter:features: doesn&#x27;t have conditional defaults
DEBUG:clap:Parser::add_defaults:iter:features: doesn&#x27;t have default vals
DEBUG:clap:Parser::add_defaults:iter:unstable_features: doesn&#x27;t have conditional defaults
DEBUG:clap:Parser::add_defaults:iter:unstable_features: doesn&#x27;t have default vals
DEBUG:clap:Parser::add_defaults:iter:pkg_path: doesn&#x27;t have conditional defaults
DEBUG:clap:Parser::add_defaults:iter:pkg_path: doesn&#x27;t have default vals
DEBUG:clap:Parser::add_defaults:iter:template: doesn&#x27;t have conditional defaults
DEBUG:clap:Parser::add_defaults:iter:template: doesn&#x27;t have default vals
DEBUG:clap:Parser::add_defaults:iter:command: doesn&#x27;t have conditional defaults
DEBUG:clap:Parser::add_defaults:iter:command: doesn&#x27;t have default vals
DEBUG:clap:Validator::validate_blacklist;
DEBUG:clap:Validator::validate_blacklist:iter:build_only;
DEBUG:clap:Parser::groups_for_arg: name=build_only
DEBUG:clap:Parser::groups_for_arg: Searching through groups...
DEBUG:clap:Validator::validate_blacklist:iter:command;
DEBUG:clap:Parser::groups_for_arg: name=command
DEBUG:clap:Parser::groups_for_arg: Searching through groups...
DEBUG:clap:Validator::validate_required: required=[&quot;command&quot;];
DEBUG:clap:Validator::validate_required:iter:command:
DEBUG:clap:Validator::validate_matched_args;
DEBUG:clap:Validator::validate_matched_args:iter:build_only: vals=[]
DEBUG:clap:Validator::validate_arg_requires:build_only;
DEBUG:clap:Validator::missing_required_error: extra=Some(&quot;script&quot;)
DEBUG:clap:Parser::color;
DEBUG:clap:Parser::color: Color setting...Auto
DEBUG:clap:is_a_tty: stderr=true
DEBUG:clap:Validator::missing_required_error: reqs=[
&quot;script&quot;,
]
DEBUG:clap:usage::get_required_usage_from: reqs=[&quot;script&quot;], extra=Some(&quot;script&quot;)
DEBUG:clap:usage::get_required_usage_from: after init desc_reqs=[&quot;script&quot;]
DEBUG:clap:usage::get_required_usage_from: no more children
DEBUG:clap:usage::get_required_usage_from: final desc_reqs=[&quot;script&quot;]
DEBUG:clap:usage::get_required_usage_from: args_in_groups=[]
DEBUG:clap:usage::get_required_usage_from:iter:script:
thread &#x27;main&#x27; panicked at &#x27;Fatal internal error. Please consider filing a bug report at https://github.com/clap-rs/clap/issues&#x27;, /home/aldaronlau/.cargo/registry/src/github.com-1ecc6299db9ec823/clap-2.33.3/src/app/usage.rs:475:22
note: run with <code>RUST_BACKTRACE=1</code> environment variable to display a backtrace</p>
</code>
</pre>


</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">T: bug</span> added by <a href="https://github.com/AldaronLau">@AldaronLau</a> on 2020-11-01 18:41</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/pksunkara">@pksunkara</a> on 2020-11-02 14:54</div>
            <div class="timeline-body"><p>Can you please try to provide us with a minimal reproducible example?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">:money_with_wings: $5</span> added by <a href="https://github.com/pksunkara">@pksunkara</a> on 2020-11-02 14:54</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">C: usage strings</span> added by <a href="https://github.com/pksunkara">@pksunkara</a> on 2020-11-02 14:54</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AldaronLau">@AldaronLau</a> on 2020-11-03 00:42</div>
            <div class="timeline-body"><p>@pksunkara I have never used this library before - I have no idea how to do anything with it, I only found this bug by using @fornwall&#x27;s rust-script project.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/pksunkara">@pksunkara</a> on 2020-11-03 06:48</div>
            <div class="timeline-body"><p>In that case, what was the command you were running?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AldaronLau">@AldaronLau</a> on 2020-11-03 06:58</div>
            <div class="timeline-body"><p>@pksunkara  <code>rust-script --build-only script-name.rs</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a>fornwall/rust-script#7</a> on 2020-11-03 21:33</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/wfraser">@wfraser</a> on 2020-11-03 21:35</div>
            <div class="timeline-body"><p><code>rust-script</code> is referencing arguments that don&#x27;t exist in the <code>.requires()</code> and <code>.conflicts_with()</code> constraints for these flags. Clap probably just needs to panic with a better error message here.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/pksunkara">@pksunkara</a> on 2020-11-03 21:40</div>
            <div class="timeline-body"><p>We should have asserts now in v3 master which produce better error messages. Thanks for looking into it @wfraser.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/pksunkara">@pksunkara</a> on 2020-11-03 21:40</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">:money_with_wings: $5</span> removed by <a href="https://github.com/pksunkara">@pksunkara</a> on 2020-11-03 21:40</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">T: bug</span> removed by <a href="https://github.com/pksunkara">@pksunkara</a> on 2020-11-03 21:40</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">C: usage strings</span> removed by <a href="https://github.com/pksunkara">@pksunkara</a> on 2020-11-03 21:40</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:57:56 UTC
    </footer>
</body>
</html>
