<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>`arg_required_else_help` does not show help when env variables are present - clap-rs/clap #3572</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>`arg_required_else_help` does not show help when env variables are present</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/clap-rs/clap/issues/3572">#3572</a>
        opened by <a href="https://github.com/willbuckner">@willbuckner</a>
        on 2022-03-24 11:57
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/willbuckner">@willbuckner</a> on 2022-03-24 11:57</div>
            <div class="timeline-body"><h3>Please complete the following tasks</h3>
<ul>
<li>[X] I have searched the <a href="https://github.com/clap-rs/clap/discussions">discussions</a></li>
<li>[X] I have searched the <a href="https://github.com/clap-rs/clap/issues">open</a> and <a href="https://github.com/clap-rs/clap/issues?q=is%3Aissue+label%3AS-wont-fix+is%3Aclosed">rejected</a> issues</li>
</ul>
<h3>Rust Version</h3>
<p>rustc 1.58.1 (db9d1b20b 2022-01-20)</p>
<h3>Clap Version</h3>
<p>clap = { version = &quot;3.1.6&quot;, features = [&quot;env&quot;, &quot;std&quot;, &quot;cargo&quot;] }</p>
<h3>Minimal reproducible code</h3>
<h3>Cargo.toml</h3>
<pre><code class="language-toml">[package]
name = &quot;claptest&quot;
version = &quot;0.1.0&quot;
edition = &quot;2021&quot;

[[bin]]
name = &quot;broken&quot;
path = &quot;src/broken.rs&quot;

[[bin]]
name = &quot;working&quot;
path = &quot;src/working.rs&quot;

[[bin]]
name = &quot;deprecated-working&quot;
path = &quot;src/deprecated-working.rs&quot;

[dependencies]
clap = { version = &quot;3.1.6&quot;, features = [&quot;env&quot;, &quot;std&quot;, &quot;cargo&quot;] }
</code></pre>
<h3>src/broken.rs</h3>
<pre><code class="language-rust">use clap::{Arg, Command};
use std::env;

fn main() {
    env::set_var(&quot;CLAPTEST&quot;, &quot;test&quot;);
    println!(&quot;CLAPTEST: {}&quot;, env::var(&quot;CLAPTEST&quot;).unwrap());

    println!(&quot;Broken:&quot;);
    let cmd = Command::new(&quot;test&quot;)
        .subcommand_required(true)
        .arg_required_else_help(true)
        .arg(
            Arg::new(&quot;WUT2&quot;)
                .short('W')
                .takes_value(true)
                .env(&quot;CLAPTEST&quot;),
        )
        .subcommand(Command::new(&quot;sub&quot;).arg(Arg::new(&quot;SUBARG&quot;).short('s')));

    let _args = cmd.get_matches();
}
</code></pre>
<h3>src/working.rs</h3>
<pre><code class="language-rust">use clap::{Arg, Command};
use std::env;

fn main() {
    env::set_var(&quot;CLAPTEST&quot;, &quot;test&quot;);
    println!(&quot;CLAPTEST: {}&quot;, env::var(&quot;CLAPTEST&quot;).unwrap());

    println!(&quot;Working:&quot;);
    let cmd = Command::new(&quot;test&quot;)
        .subcommand_required(true)
        .arg_required_else_help(true)
        .arg(
            Arg::new(&quot;WUT2&quot;)
                .short('W')
                .takes_value(true)
        )
        .subcommand(Command::new(&quot;sub&quot;).arg(Arg::new(&quot;SUBARG&quot;).short('s')));

    let _args = cmd.get_matches();
}
</code></pre>
<h3>src/deprecated-working.rs</h3>
<pre><code class="language-rust">use clap::{AppSettings, Arg, Command};
use std::env;

fn main() {
    env::set_var(&quot;CLAPTEST&quot;, &quot;test&quot;);
    println!(&quot;CLAPTEST: {}&quot;, env::var(&quot;CLAPTEST&quot;).unwrap());

    println!(&quot;Deprecated:&quot;);
    #[allow(deprecated)]
    let cmd = Command::new(&quot;test&quot;)
        .setting(AppSettings::SubcommandRequiredElseHelp)
        .arg(
            Arg::new(&quot;WUT2&quot;)
                .short('W')
                .takes_value(true)
                .env(&quot;CLAPTEST&quot;),
        )
        .subcommand(Command::new(&quot;sub&quot;).arg(Arg::new(&quot;SUBARG&quot;).short('s')));

    let _args = cmd.get_matches();
}
</code></pre>
<h3>Steps to reproduce the bug with the above code</h3>
<h3>src/deprecated-working.rs</h3>
<pre><code class="language-shell">[*]~/dev/claptest[master #]⦕ cargo run --bin deprecated-working
    Finished dev [unoptimized + debuginfo] target(s) in 0.04s
     Running `target/debug/deprecated-working`
CLAPTEST: test
Deprecated:
test

USAGE:
    deprecated-working [OPTIONS] &lt;SUBCOMMAND&gt;

OPTIONS:
    -h, --help       Print help information
    -W &lt;WUT2&gt;        [env: CLAPTEST=test]

SUBCOMMANDS:
    help    Print this message or the help of the given subcommand(s)
    sub
[*]~/dev/claptest[master #]⦕
</code></pre>
<h3>src/working.rs</h3>
<pre><code class="language-shell">[*]~/dev/claptest[master #]⦕ cargo run --bin working
   Compiling claptest v0.1.0 (/Users/will/dev/claptest)
    Finished dev [unoptimized + debuginfo] target(s) in 1.31s
     Running `target/debug/working`
CLAPTEST: test
Working:
test

USAGE:
    working [OPTIONS] &lt;SUBCOMMAND&gt;

OPTIONS:
    -h, --help       Print help information
    -W &lt;WUT2&gt;

SUBCOMMANDS:
    help    Print this message or the help of the given subcommand(s)
    sub
[*]~/dev/claptest[master #]⦕
</code></pre>
<h3>src/broken.rs</h3>
<pre><code class="language-shell">[*]~/dev/claptest[master #]⦕ cargo run --bin broken
   Compiling claptest v0.1.0 (/Users/will/dev/claptest)
    Finished dev [unoptimized + debuginfo] target(s) in 1.22s
     Running `target/debug/broken`
CLAPTEST: test
Broken:
error: 'broken' requires a subcommand but one was not provided

USAGE:
    broken [OPTIONS] &lt;SUBCOMMAND&gt;

For more information try --help
[*]~/dev/claptest[master #]⦕
</code></pre>
<h3>Actual Behaviour</h3>
<p>When I use <code>.env(&quot;ENV_VAR&quot;)</code> on an <code>Arg</code>, and I have <code>.subcommand_required(true).arg_required_else_help(true)</code>, and <code>ENV_VAR</code> is set, help is not output, instead a short usage message appears without help.</p>
<p>This is what happens:</p>
<h3>src/broken.rs</h3>
<pre><code class="language-shell">[*]~/dev/claptest[master #]⦕ cargo run --bin broken
   Compiling claptest v0.1.0 (/Users/will/dev/claptest)
    Finished dev [unoptimized + debuginfo] target(s) in 1.22s
     Running `target/debug/broken`
CLAPTEST: test
Broken:
error: 'broken' requires a subcommand but one was not provided

USAGE:
    broken [OPTIONS] &lt;SUBCOMMAND&gt;

For more information try --help
[*]~/dev/claptest[master #]⦕
</code></pre>
<h3>Expected Behaviour</h3>
<p>When I use <code>.env(&quot;ENV_VAR&quot;)</code> on an <code>Arg</code>, and I have <code>.subcommand_required(true).arg_required_else_help(true)</code>, and <code>ENV_VAR</code> is set, <strong>help should be output, instead of a short usage message without help</strong>.</p>
<p>This is what should happen:</p>
<h3>src/deprecated-working.rs</h3>
<pre><code class="language-shell">[*]~/dev/claptest[master #]⦕ cargo run --bin deprecated-working
    Finished dev [unoptimized + debuginfo] target(s) in 0.04s
     Running `target/debug/deprecated-working`
CLAPTEST: test
Deprecated:
test

USAGE:
    deprecated-working [OPTIONS] &lt;SUBCOMMAND&gt;

OPTIONS:
    -h, --help       Print help information
    -W &lt;WUT2&gt;        [env: CLAPTEST=test]

SUBCOMMANDS:
    help    Print this message or the help of the given subcommand(s)
    sub
[*]~/dev/claptest[master #]⦕
</code></pre>
<p>Said another way, **I should be able to emulate the behavior of <code>AppSettings::SubcommandRequiredElseHelp</code> without using a deprecated setting.</p>
<h3>Additional Context</h3>
<p>Maybe this is a new builder setting; <code>.subcommand_required_else_help()</code>, or perhaps <code>.env_provides_user_arg(false)</code>, or similar.</p>
<p>Awesome work on Clap btw :)</p>
<h3>Debug Output</h3>
<h3>src/broken.rs</h3>
<pre><code class="language-shell">[*]~/dev/claptest[master #]⦕ cargo run --bin broken
    Finished dev [unoptimized + debuginfo] target(s) in 0.03s
     Running `target/debug/broken`
CLAPTEST: test
Broken:
[        clap::build::command] 	App::_do_parse
[        clap::build::command] 	App::_build
[        clap::build::command] 	App::_propagate:test
[        clap::build::command] 	App::_check_help_and_version: test
[        clap::build::command] 	App::_check_help_and_version: Removing generated version
[        clap::build::command] 	App::_check_help_and_version: Building help subcommand
[        clap::build::command] 	App::_propagate_global_args:test
[        clap::build::command] 	App::_derive_display_order:test
[        clap::build::command] 	App::_derive_display_order:sub
[        clap::build::command] 	App::_derive_display_order:help
[  clap::build::debug_asserts] 	Command::_debug_asserts
[  clap::build::debug_asserts] 	Arg::_debug_asserts:help
[  clap::build::debug_asserts] 	Arg::_debug_asserts:WUT2
[  clap::build::debug_asserts] 	Command::_verify_positionals
[         clap::parse::parser] 	Parser::get_matches_with
[      clap::parse::validator] 	Validator::validate
[         clap::parse::parser] 	Parser::add_env: Checking arg `--help`
[         clap::parse::parser] 	Parser::add_env: Checking arg `-W &lt;WUT2&gt;`
[         clap::parse::parser] 	Parser::add_env: Found an opt with value=RawOsStr(&quot;test&quot;), trailing=false
[         clap::parse::parser] 	Parser::add_val_to_arg; arg=WUT2, val=RawOsStr(&quot;test&quot;)
[         clap::parse::parser] 	Parser::add_val_to_arg; trailing_values=false, DontDelimTrailingVals=false
[         clap::parse::parser] 	Parser::add_single_val_to_arg: adding val...&quot;test&quot;
[         clap::parse::parser] 	Parser::add_single_val_to_arg: cur_idx:=1
[        clap::build::command] 	App::groups_for_arg: id=WUT2
[    clap::parse::arg_matcher] 	ArgMatcher::needs_more_vals: o=WUT2
[         clap::parse::parser] 	Parser::add_defaults
[         clap::parse::parser] 	Parser::add_defaults:iter:WUT2:
[         clap::parse::parser] 	Parser::add_value: doesn't have conditional defaults
[         clap::parse::parser] 	Parser::add_value:iter:WUT2: doesn't have default vals
[         clap::parse::parser] 	Parser::add_value:iter:WUT2: doesn't have default missing vals
[         clap::output::usage] 	Usage::create_usage_with_title
[         clap::output::usage] 	Usage::create_usage_no_title
[         clap::output::usage] 	Usage::create_help_usage; incl_reqs=true
[         clap::output::usage] 	Usage::get_required_usage_from: incls=[], matcher=false, incl_last=false
[         clap::output::usage] 	Usage::get_required_usage_from: unrolled_reqs={}
[         clap::output::usage] 	Usage::get_required_usage_from: ret_val=[]
[         clap::output::usage] 	Usage::needs_options_tag
[         clap::output::usage] 	Usage::needs_options_tag:iter: f=help
[         clap::output::usage] 	Usage::needs_options_tag:iter Option is built-in
[         clap::output::usage] 	Usage::needs_options_tag:iter: f=WUT2
[        clap::build::command] 	App::groups_for_arg: id=WUT2
[         clap::output::usage] 	Usage::needs_options_tag:iter: [OPTIONS] required
[         clap::output::usage] 	Usage::create_help_usage: usage=broken [OPTIONS] &lt;SUBCOMMAND&gt;
[        clap::build::command] 	App::color: Color setting...
[        clap::build::command] 	Auto
error: 'broken' requires a subcommand but one was not provided

USAGE:
    broken [OPTIONS] &lt;SUBCOMMAND&gt;

For more information try --help
</code></pre>
<h3>src/working.rs</h3>
<pre><code class="language-shell">[*]~/dev/claptest[master #]⦕ cargo run --bin working
   Compiling claptest v0.1.0 (/Users/will/dev/claptest)
    Finished dev [unoptimized + debuginfo] target(s) in 0.56s
     Running `target/debug/working`
CLAPTEST: test
Working:
[        clap::build::command] 	App::_do_parse
[        clap::build::command] 	App::_build
[        clap::build::command] 	App::_propagate:test
[        clap::build::command] 	App::_check_help_and_version: test
[        clap::build::command] 	App::_check_help_and_version: Removing generated version
[        clap::build::command] 	App::_check_help_and_version: Building help subcommand
[        clap::build::command] 	App::_propagate_global_args:test
[        clap::build::command] 	App::_derive_display_order:test
[        clap::build::command] 	App::_derive_display_order:sub
[        clap::build::command] 	App::_derive_display_order:help
[  clap::build::debug_asserts] 	Command::_debug_asserts
[  clap::build::debug_asserts] 	Arg::_debug_asserts:help
[  clap::build::debug_asserts] 	Arg::_debug_asserts:WUT2
[  clap::build::debug_asserts] 	Command::_verify_positionals
[         clap::parse::parser] 	Parser::get_matches_with
[      clap::parse::validator] 	Validator::validate
[         clap::parse::parser] 	Parser::add_env: Checking arg `--help`
[         clap::parse::parser] 	Parser::add_env: Checking arg `-W &lt;WUT2&gt;`
[         clap::parse::parser] 	Parser::add_defaults
[         clap::parse::parser] 	Parser::add_defaults:iter:WUT2:
[         clap::parse::parser] 	Parser::add_value: doesn't have conditional defaults
[         clap::parse::parser] 	Parser::add_value:iter:WUT2: doesn't have default vals
[         clap::parse::parser] 	Parser::add_value:iter:WUT2: doesn't have default missing vals
[        clap::build::command] 	App::color: Color setting...
[        clap::build::command] 	Auto
[          clap::output::help] 	Help::new
[          clap::output::help] 	Help::write_help
[          clap::output::help] 	should_show_arg: use_long=false, arg=help
[          clap::output::help] 	Help::write_templated_help
[          clap::output::help] 	Help::write_before_help
[          clap::output::help] 	Help::write_bin_name
[         clap::output::usage] 	Usage::create_usage_no_title
[         clap::output::usage] 	Usage::create_help_usage; incl_reqs=true
[         clap::output::usage] 	Usage::get_required_usage_from: incls=[], matcher=false, incl_last=false
[         clap::output::usage] 	Usage::get_required_usage_from: unrolled_reqs={}
[         clap::output::usage] 	Usage::get_required_usage_from: ret_val=[]
[         clap::output::usage] 	Usage::needs_options_tag
[         clap::output::usage] 	Usage::needs_options_tag:iter: f=help
[         clap::output::usage] 	Usage::needs_options_tag:iter Option is built-in
[         clap::output::usage] 	Usage::needs_options_tag:iter: f=WUT2
[        clap::build::command] 	App::groups_for_arg: id=WUT2
[         clap::output::usage] 	Usage::needs_options_tag:iter: [OPTIONS] required
[         clap::output::usage] 	Usage::create_help_usage: usage=working [OPTIONS] &lt;SUBCOMMAND&gt;
[          clap::output::help] 	Help::write_all_args
[          clap::output::help] 	should_show_arg: use_long=false, arg=help
[          clap::output::help] 	should_show_arg: use_long=false, arg=WUT2
[          clap::output::help] 	Help::write_args
[          clap::output::help] 	should_show_arg: use_long=false, arg=help
[          clap::output::help] 	Help::write_args: Current Longest...2
[          clap::output::help] 	Help::write_args: New Longest...6
[          clap::output::help] 	should_show_arg: use_long=false, arg=WUT2
[          clap::output::help] 	Help::write_args: Current Longest...6
[          clap::output::help] 	Help::write_args: New Longest...9
[          clap::output::help] 	should_show_arg: use_long=false, arg=help
[          clap::output::help] 	Help::spec_vals: a=--help
[          clap::output::help] 	should_show_arg: use_long=false, arg=WUT2
[          clap::output::help] 	Help::spec_vals: a=-W &lt;WUT2&gt;
[          clap::output::help] 	Help::spec_vals: a=--help
[          clap::output::help] 	Help::short
[          clap::output::help] 	Help::long
[          clap::output::help] 	Help::val: arg=help
[          clap::output::help] 	Help::align_to_about: arg=help
[          clap::output::help] 	Help::align_to_about: Has switch...
[          clap::output::help] 	Yes
[          clap::output::help] 	Help::align_to_about: nlh...false
[          clap::output::help] 	Help::help
[          clap::output::help] 	Help::help: Next Line...false
[          clap::output::help] 	Help::help: Too long...
[          clap::output::help] 	No
[          clap::output::help] 	Help::spec_vals: a=-W &lt;WUT2&gt;
[          clap::output::help] 	Help::short
[          clap::output::help] 	Help::long
[          clap::output::help] 	Help::val: arg=WUT2
[          clap::output::help] 	Help::align_to_about: arg=WUT2
[          clap::output::help] 	Help::align_to_about: Has switch...
[          clap::output::help] 	Yes
[          clap::output::help] 	Help::align_to_about: nlh...false
[          clap::output::help] 	Help::help
[          clap::output::help] 	Help::help: Next Line...false
[          clap::output::help] 	Help::help: Too long...
[          clap::output::help] 	No
[          clap::output::help] 	Help::write_subcommands
[          clap::output::help] 	Help::write_subcommands longest = 4
[          clap::output::help] 	Help::sc_spec_vals: a=sub
[          clap::output::help] 	Help::sc_spec_vals: a=help
[          clap::output::help] 	Help::write_subcommand
[          clap::output::help] 	Help::sc_spec_vals: a=help
[          clap::output::help] 	Help::help
[          clap::output::help] 	Help::help: Next Line...false
[          clap::output::help] 	Help::help: Too long...
[          clap::output::help] 	No
[          clap::output::help] 	Help::write_subcommand
[          clap::output::help] 	Help::sc_spec_vals: a=sub
[          clap::output::help] 	Help::help
[          clap::output::help] 	Help::help: Next Line...false
[          clap::output::help] 	Help::help: Too long...
[          clap::output::help] 	No
[          clap::output::help] 	Help::write_after_help
[        clap::build::command] 	App::color: Color setting...
[        clap::build::command] 	Auto
test

USAGE:
    working [OPTIONS] &lt;SUBCOMMAND&gt;

OPTIONS:
    -h, --help       Print help information
    -W &lt;WUT2&gt;

SUBCOMMANDS:
    help    Print this message or the help of the given subcommand(s)
    sub
</code></pre>
<h3>src/deprecated-working.rs</h3>
<pre><code class="language-shell">[*]~/dev/claptest[master #]⦕ cargo run --bin deprecated-working
   Compiling claptest v0.1.0 (/Users/will/dev/claptest)
    Finished dev [unoptimized + debuginfo] target(s) in 0.55s
     Running `target/debug/deprecated-working`
CLAPTEST: test
Deprecated:
[        clap::build::command] 	App::_do_parse
[        clap::build::command] 	App::_build
[        clap::build::command] 	App::_propagate:test
[        clap::build::command] 	App::_check_help_and_version: test
[        clap::build::command] 	App::_check_help_and_version: Removing generated version
[        clap::build::command] 	App::_check_help_and_version: Building help subcommand
[        clap::build::command] 	App::_propagate_global_args:test
[        clap::build::command] 	App::_derive_display_order:test
[        clap::build::command] 	App::_derive_display_order:sub
[        clap::build::command] 	App::_derive_display_order:help
[  clap::build::debug_asserts] 	Command::_debug_asserts
[  clap::build::debug_asserts] 	Arg::_debug_asserts:help
[  clap::build::debug_asserts] 	Arg::_debug_asserts:WUT2
[  clap::build::debug_asserts] 	Command::_verify_positionals
[         clap::parse::parser] 	Parser::get_matches_with
[      clap::parse::validator] 	Validator::validate
[         clap::parse::parser] 	Parser::add_env: Checking arg `--help`
[         clap::parse::parser] 	Parser::add_env: Checking arg `-W &lt;WUT2&gt;`
[         clap::parse::parser] 	Parser::add_env: Found an opt with value=RawOsStr(&quot;test&quot;), trailing=false
[         clap::parse::parser] 	Parser::add_val_to_arg; arg=WUT2, val=RawOsStr(&quot;test&quot;)
[         clap::parse::parser] 	Parser::add_val_to_arg; trailing_values=false, DontDelimTrailingVals=false
[         clap::parse::parser] 	Parser::add_single_val_to_arg: adding val...&quot;test&quot;
[         clap::parse::parser] 	Parser::add_single_val_to_arg: cur_idx:=1
[        clap::build::command] 	App::groups_for_arg: id=WUT2
[    clap::parse::arg_matcher] 	ArgMatcher::needs_more_vals: o=WUT2
[         clap::parse::parser] 	Parser::add_defaults
[         clap::parse::parser] 	Parser::add_defaults:iter:WUT2:
[         clap::parse::parser] 	Parser::add_value: doesn't have conditional defaults
[         clap::parse::parser] 	Parser::add_value:iter:WUT2: doesn't have default vals
[         clap::parse::parser] 	Parser::add_value:iter:WUT2: doesn't have default missing vals
[      clap::parse::validator] 	Validator::new::get_matches_with: SubcommandRequiredElseHelp=true
[        clap::build::command] 	App::color: Color setting...
[        clap::build::command] 	Auto
[          clap::output::help] 	Help::new
[          clap::output::help] 	Help::write_help
[          clap::output::help] 	should_show_arg: use_long=false, arg=help
[          clap::output::help] 	Help::write_templated_help
[          clap::output::help] 	Help::write_before_help
[          clap::output::help] 	Help::write_bin_name
[         clap::output::usage] 	Usage::create_usage_no_title
[         clap::output::usage] 	Usage::create_help_usage; incl_reqs=true
[         clap::output::usage] 	Usage::get_required_usage_from: incls=[], matcher=false, incl_last=false
[         clap::output::usage] 	Usage::get_required_usage_from: unrolled_reqs={}
[         clap::output::usage] 	Usage::get_required_usage_from: ret_val=[]
[         clap::output::usage] 	Usage::needs_options_tag
[         clap::output::usage] 	Usage::needs_options_tag:iter: f=help
[         clap::output::usage] 	Usage::needs_options_tag:iter Option is built-in
[         clap::output::usage] 	Usage::needs_options_tag:iter: f=WUT2
[        clap::build::command] 	App::groups_for_arg: id=WUT2
[         clap::output::usage] 	Usage::needs_options_tag:iter: [OPTIONS] required
[         clap::output::usage] 	Usage::create_help_usage: usage=deprecated-working [OPTIONS] &lt;SUBCOMMAND&gt;
[          clap::output::help] 	Help::write_all_args
[          clap::output::help] 	should_show_arg: use_long=false, arg=help
[          clap::output::help] 	should_show_arg: use_long=false, arg=WUT2
[          clap::output::help] 	Help::write_args
[          clap::output::help] 	should_show_arg: use_long=false, arg=help
[          clap::output::help] 	Help::write_args: Current Longest...2
[          clap::output::help] 	Help::write_args: New Longest...6
[          clap::output::help] 	should_show_arg: use_long=false, arg=WUT2
[          clap::output::help] 	Help::write_args: Current Longest...6
[          clap::output::help] 	Help::write_args: New Longest...9
[          clap::output::help] 	should_show_arg: use_long=false, arg=help
[          clap::output::help] 	Help::spec_vals: a=--help
[          clap::output::help] 	should_show_arg: use_long=false, arg=WUT2
[          clap::output::help] 	Help::spec_vals: a=-W &lt;WUT2&gt;
[          clap::output::help] 	Help::spec_vals: Found environment variable...[&quot;CLAPTEST&quot;:Some(&quot;test&quot;)]
[          clap::output::help] 	Help::spec_vals: a=--help
[          clap::output::help] 	Help::short
[          clap::output::help] 	Help::long
[          clap::output::help] 	Help::val: arg=help
[          clap::output::help] 	Help::align_to_about: arg=help
[          clap::output::help] 	Help::align_to_about: Has switch...
[          clap::output::help] 	Yes
[          clap::output::help] 	Help::align_to_about: nlh...false
[          clap::output::help] 	Help::help
[          clap::output::help] 	Help::help: Next Line...false
[          clap::output::help] 	Help::help: Too long...
[          clap::output::help] 	No
[          clap::output::help] 	Help::spec_vals: a=-W &lt;WUT2&gt;
[          clap::output::help] 	Help::spec_vals: Found environment variable...[&quot;CLAPTEST&quot;:Some(&quot;test&quot;)]
[          clap::output::help] 	Help::short
[          clap::output::help] 	Help::long
[          clap::output::help] 	Help::val: arg=WUT2
[          clap::output::help] 	Help::align_to_about: arg=WUT2
[          clap::output::help] 	Help::align_to_about: Has switch...
[          clap::output::help] 	Yes
[          clap::output::help] 	Help::align_to_about: nlh...false
[          clap::output::help] 	Help::help
[          clap::output::help] 	Help::help: Next Line...false
[          clap::output::help] 	Help::help: Too long...
[          clap::output::help] 	No
[          clap::output::help] 	Help::write_subcommands
[          clap::output::help] 	Help::write_subcommands longest = 4
[          clap::output::help] 	Help::sc_spec_vals: a=sub
[          clap::output::help] 	Help::sc_spec_vals: a=help
[          clap::output::help] 	Help::write_subcommand
[          clap::output::help] 	Help::sc_spec_vals: a=help
[          clap::output::help] 	Help::help
[          clap::output::help] 	Help::help: Next Line...false
[          clap::output::help] 	Help::help: Too long...
[          clap::output::help] 	No
[          clap::output::help] 	Help::write_subcommand
[          clap::output::help] 	Help::sc_spec_vals: a=sub
[          clap::output::help] 	Help::help
[          clap::output::help] 	Help::help: Next Line...false
[          clap::output::help] 	Help::help: Too long...
[          clap::output::help] 	No
[          clap::output::help] 	Help::write_after_help
[        clap::build::command] 	App::color: Color setting...
[        clap::build::command] 	Auto
test

USAGE:
    deprecated-working [OPTIONS] &lt;SUBCOMMAND&gt;

OPTIONS:
    -h, --help       Print help information
    -W &lt;WUT2&gt;        [env: CLAPTEST=test]

SUBCOMMANDS:
    help    Print this message or the help of the given subcommand(s)
    sub
[*]~/dev/claptest[master #]⦕
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">C-bug</span> added by @willbuckner on 2022-03-24 11:58</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2022-03-24 14:29</div>
            <div class="timeline-body"><p>#3421 changed <code>arg_required_else_help</code> to ignore defaults to align with #3420 where all our requirement and conflict handling was updated to ignore defaults.  #3420 was a continuation of #3020 and #2950.</p>
<p>In #2950, we <a href="https://github.com/clap-rs/clap/pull/2950#discussion_r736905259">discussed</a> how we should handle env variables and it was proposed that we treat them like user supplied values.</p>
<p>So the questions for this issue</p>
<ul>
<li>What is the ideal behavior of <code>arg_required_else_help</code> be when env variables are set and how important is that?<ul>
<li>Show <code>--help</code> if there is no <code>ValueSource::CommandLine</code> value<ul>
<li>Note: this would be a breaking change as this is dependent on the context while checking for defaults was not because that is static and turned a non-working case to a working case</li>
</ul>
</li>
<li>Fallback to any errors associated with values being set to <code>ValueSource::EnvVariable</code></li>
<li>Show <code>--help</code> if <code>is_subcommand_required</code> and there is no subcommand</li>
</ul>
</li>
<li>If we want to reconsider the handling of <code>ValueSource::EnvVariable</code> here, should we do it elsewhere?<ul>
<li>Note: this would be a breaking change as this is dependent on the context while checking for defaults was not because that is static and turned a non-working case to a working case</li>
</ul>
</li>
</ul>
<p>@pksunkara since you were involved in the past discussion, I'd be curious to know what your thoughts are?  I think showing <code>--help</code> on a missing required subcommand is an easy choice but also wondering about the larger picture on this about env variables.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2022-03-24 14:58</div>
            <div class="timeline-body"><blockquote>
<p>I think showing --help on a missing required subcommand is an easy choice but also wondering about the larger picture on this about env variables.</p>
</blockquote>
<p>Got ahead of myself on this.  The intention was to be explicit about a subcommand being required when args are present but not a subcommand rather than the user having to infer that from the help message.</p>
<p>So if we did anything with this option, we'd have to explicitly check for if any CLI args are present.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">A-help</span> added by @epage on 2022-03-24 14:59</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">S-waiting-on-design</span> added by @epage on 2022-03-24 14:59</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/willbuckner">@willbuckner</a> on 2022-03-24 17:04</div>
            <div class="timeline-body"><p>Thanks for the response!</p>
<blockquote>
<p>In https://github.com/clap-rs/clap/pull/2950, we https://github.com/clap-rs/clap/pull/2950#discussion_r736905259 how we should handle env variables and it was proposed that we treat them like user supplied values.</p>
</blockquote>
<p>The best option might just be to let the user decide, which would also avoid a breaking change. Leave the default as it is, and add a <code>.env_satisfies_arg_requirements()</code> or <code>.env_satisfies_user_args()</code> (naming things is hard, but you get the idea :) ). I don't have an opinion as to whether this should be the <em>default</em> behavior, but I just need some way to do it. A good compromise might be to leave the default behavior as is, have an opt-in setting, then flip the default for the breaking change in a major release if that's the consensus.</p>
<p>The main issue right now is that I have no way to distinguish whether a user typed anything after <code>./mybinary</code> or not, including after <code>./mybinary subcommand</code> if my subcommand requires another subcommand. This effectively means I can't use Clap to use env values as defaults and I'll have to find another way to inject ENV vars. My usecase requires me to know whether or not the user manually specified any args.</p>
<p>In general, I'd also expect a user-supplied arg to take precedence over one provided from ENV, which I believe is the current behavior.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2022-03-28 19:12</div>
            <div class="timeline-body"><blockquote>
<p>The best option might just be to let the user decide, which would also avoid a breaking change. Leave the default as it is, and add a .env_satisfies_arg_requirements() or .env_satisfies_user_args() (naming things is hard, but you get the idea :) ). I don't have an opinion as to whether this should be the default behavior, but I just need some way to do it. A good compromise might be to leave the default behavior as is, have an opt-in setting, then flip the default for the breaking change in a major release if that's the consensus.</p>
</blockquote>
<p>We are trying to limit the amount of configuration we provide.  The more configuration, the more cases we have to be documented and tested, and the worse our build times and code size are.  It also becomes overwhelming in the documentation, making it hard to be aware of what features clap has.  We are working on reducing the amount of configuration we have at this point.</p>
<blockquote>
<p>The main issue right now is that I have no way to distinguish whether a user typed anything after ./mybinary or not, including after ./mybinary subcommand if my subcommand requires another subcommand. This effectively means I can't use Clap to use env values as defaults and I'll have to find another way to inject ENV vars. My usecase requires me to know whether or not the user manually specified any args.</p>
</blockquote>
<p>To double check, your concern is with what error we show the user?  The difference in error messages is enough to avoid that message?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/willbuckner">@willbuckner</a> on 2022-03-29 02:00</div>
            <div class="timeline-body"><blockquote>
<p>To double check, your concern is with what error we show the user? The difference in error messages is enough to avoid that message?</p>
</blockquote>
<p>No, the behavior I want (shown in expected output in the issue above) is for <code>mybinary mysubcommand</code> to show the full help for <code>mysubcommand</code>, rather than the usage message. I want the behavior we had before with <code>SubcommandRequiredElseHelp</code>. Now it shows a usage error, before it showed the help message.</p>
<blockquote>
<p>We are trying to limit the amount of configuration we provide.</p>
</blockquote>
<p>This makes sense and I definitely understand.</p>
<p>I just wish there was some way to achieve the previous functionality of <code>SubcommandRequiredElseHelp</code> without forgoing use of <code>.env()</code>. IMO, an env value is not a &quot;user supplied argument&quot;. Really, I want to specifically require a subcommand, not just &quot;any arg&quot; or else show the help message (not the usage error). Thanks!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2022-03-29 18:47</div>
            <div class="timeline-body"><blockquote>
<p>No, the behavior I want (shown in expected output in the issue above) is for mybinary mysubcommand to show the full help for mysubcommand, rather than the usage message. I want the behavior we had before with SubcommandRequiredElseHelp. Now it shows a usage error, before it showed the help message.</p>
</blockquote>
<p>Sorry, I was speaking for a clap internals perspective: those are both error messages.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from ".arg_required_else_help() + .subcommand_required() does not replicate SubcommandRequiredElseHelp" to "`.arg_required_else_help().subcommand_required()` does not replicate SubcommandRequiredElseHelp with env variables" by @epage on 2022-05-04 18:18</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Kinrany">@Kinrany</a> on 2022-11-14 20:27</div>
            <div class="timeline-body"><p>I ran into this with the derive API. Now that the deprecated feature was removed in clap v4, it seems <code>Option&lt;Command&gt;</code> and a manual help printing is the only workaround.</p>
<p>Agree that when a required subcommand is missing, the list of possible subcommands should be shown. If this is a breaking change, adding a configuration option and changing the behavior in the next major version seems like the only path forward.</p>
<p>Edit: though perhaps missing or invalid arguments should have precedence over a missing subcommand. So that the CLI can be explored like this:</p>
<ol>
<li><code>foo</code> -&gt; <code>error: --bar is required</code></li>
<li><code>foo --bar</code> -&gt; <code>error: --bar needs a value</code></li>
<li><code>foo --bar baz</code> -&gt; <code>help: list of all the possible subcommands</code></li>
</ol>
<p>This way at step 3 the user will know that they are passing the correct arguments and can proceed to choosing a subcommand.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2022-11-14 22:19</div>
            <div class="timeline-body"><blockquote>
<p>foo -&gt; error: --bar is required</p>
</blockquote>
<p>Mixing a required <code>--bar</code> with a required subcommand seems like a fairly uncommon case for us to optimize for.  I also feel like showing help is the more natural thing to do in this case.</p>
<blockquote>
<p>foo --bar baz -&gt; help: list of all the possible subcommands</p>
</blockquote>
<p>The user made a best effort and it still failed.  We should be more specific about what failed rather than sending them back to the beginning with help. We could prefix help with a message but that will most likely get lost in the noise.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Kinrany">@Kinrany</a> on 2022-11-15 00:54</div>
            <div class="timeline-body"><blockquote>
<p>Mixing a required --bar with a required subcommand seems like a fairly uncommon case for us to optimize for.</p>
</blockquote>
<p>I'm thinking of environment variables, specifically database or other credentials needed for a collection of similar operations.</p>
<blockquote>
<p>The user made a best effort and it still failed.</p>
</blockquote>
<p>Sorry, I meant that it shows the list of subcommands that can follow <em>after</em> <code>foo</code>, like <code>foo --bar baz fizz</code>.</p>
<p>Getting a help message with new information instead of an error seems like an intuitive sign of progress.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2022-11-15 02:38</div>
            <div class="timeline-body"><blockquote>
<p>Sorry, I meant that it shows the list of subcommands that can follow after foo, like foo --bar baz fizz.</p>
<p>Getting a help message with new information instead of an error seems like an intuitive sign of progress.</p>
</blockquote>
<p>Shows the list of subcommands or shows the help?  Maybe we are using terms slightly differently but its not clear to me what you are looking for.</p>
<p>As a possible guess as to what you mean, some similar cases</p>
<ul>
<li>When required arguments are missing, we show all required arguments to the user in the error message</li>
<li>When a flag is missing a required value associated with it, we show all of the <code>PossibleValue</code>s in the error message</li>
</ul>
<p>Similarly, for required subcommands, we could show all of the available subcommands in the error message when one is missing.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Kinrany">@Kinrany</a> on 2022-11-15 07:41</div>
            <div class="timeline-body"><p>Yeah, showing the list of subcommands in the error would fix the main problem: that the user needs to type another shell command just to look at the list.</p>
<p>Another reason I prefer help here is that it looks more consistent in a tree of subcommands: it's weird that between <code>foo</code>, <code>foo baz</code> and <code>foo baz fizz</code> the first and the last look the same but the middle one looks different because of an argument that was filled by an env var.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/4482.html">clap-rs/clap#4482</a> on 2022-11-15 16:19</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/litcc">@litcc</a> on 2022-11-23 01:42</div>
            <div class="timeline-body"><p><img src="https://user-images.githubusercontent.com/13202561/203453809-86dae4c9-3f79-42ee-9b97-5c75b99300e3.png" alt="image" /></p>
<p>a little different understanding here, when <code>arg_required_else_help(true)</code> is specified, theoretically the missing subcommand should display help information and exit normally.</p>
<p>When the env function is not used, he works normally and does show the help message, the
but when the env function is used, he just shows the available subcommands and does not show the help message, which I think is a logical problem because the user has specified the arg_required_else_help(true) argument and the subcommands are considered arg.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/5113.html">clap-rs/clap#5113</a> on 2023-09-06 16:05</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">A-parsing</span> added by @epage on 2024-08-13 20:49</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "`.arg_required_else_help().subcommand_required()` does not replicate SubcommandRequiredElseHelp with env variables" to "`arg_required_else_help` does not show help when env variables are present" by @epage on 2024-08-13 20:50</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/5673.html">clap-rs/clap#5673</a> on 2024-08-13 20:53</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/benluelo">@benluelo</a> on 2024-11-02 00:06</div>
            <div class="timeline-body"><p>is there any progress here? this is quite annoying/frustrating to work around</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2024-11-04 15:38</div>
            <div class="timeline-body"><p>If there is no posts, then there are no updates.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 01:34:57 UTC
    </footer>
</body>
</html>
