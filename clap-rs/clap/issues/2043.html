<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>specifying default value makes field required - clap-rs/clap #2043</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>specifying default value makes field required</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/clap-rs/clap/issues/2043">#2043</a>
        opened by <a href="https://github.com/jgarvin">@jgarvin</a>
        on 2020-07-31 21:22
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/jgarvin">@jgarvin</a></div>
            <div class="timeline-body">How to reproduce
<p>With this declaration passing the argument is not required:</p>
<pre><code>#[clap(short, long)]
cores: Vec&lt;u32&gt;,</code></pre>
<p>with this declaration it is:</p>
<pre><code>#[clap(short, long, default_value = &quot;&quot;)]
cores: Vec&lt;u32&gt;,</code></pre>
<p>I would expect specifying a default value to imply optional, so this doesn&#x27;t seem like it can be intentional.</p>
Version
<ul>
<li><strong>Rust</strong>: rustc 1.46.0-nightly (16957bd4d 2020-06-30)</li>
<li><strong>Clap</strong>: &quot;3.0.0-beta.1&quot;</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">T: bug</span> added by <a href="https://github.com/jgarvin">@jgarvin</a> on 2020-07-31 21:22</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/pksunkara">@pksunkara</a> on 2020-07-31 21:56</div>
            <div class="timeline-body"><p>I think you are trying to assign your own semantics to clap here. Having a default value makes the arg optional but the value of the arg will not be undefined but will instead be the default value.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/CreepySkeleton">@CreepySkeleton</a> on 2020-08-03 09:34</div>
            <div class="timeline-body"><p><code>default_value</code> doesn&#x27;t work with <code>Vec</code>. I don&#x27;t think it should because it implies &quot;only one value&quot; while Vec is all about multiple values. Ideally, this should be a compile time error.</p>
<p>But <code>default_valueS</code> must work as described - its presence should not affect requiredness. This is a bug in derive.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to <a href="https://github.com/CreepySkeleton">@CreepySkeleton</a> by <a href="https://github.com/CreepySkeleton">@CreepySkeleton</a> on 2020-08-03 09:34</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">C: derive macros</span> added by <a href="https://github.com/CreepySkeleton">@CreepySkeleton</a> on 2020-08-03 09:35</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/CreepySkeleton">@CreepySkeleton</a> on 2020-08-03 09:36</div>
            <div class="timeline-body"><p>@jgarvin The temporary workaround is <code>#[clap(required = false)]</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/pksunkara">@pksunkara</a> on 2020-08-11 01:10</div>
            <div class="timeline-body"><p>@CreepySkeleton can you explain what exactly the problem is and what the solution should be. I am afraid that I don&#x27;t understand.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/CreepySkeleton">@CreepySkeleton</a> on 2020-08-12 02:50</div>
            <div class="timeline-body"><p>@pksunkara</p>
<pre><code>#[derive(Clap)]
struct Opts {
    // this option is required because it&#x27;s not Option (please excuse the pun)
    a: u32,

    // this option is NOT required, despite the fact it&#x27;s not Option
    // if absent, the default value will be used
    #[clap(default_value = &quot;1&quot;)]
    b: u32,

    // this should be a compile time error because default_value (singular)
    // is kinda meaningless with `Vec`
    //
    // This case is what OP complained about: it turns out the field somehow becomes required (WTF???).
    #[clap(default_value = &quot;1&quot;)]
    c: Vec&lt;u32&gt;,

    // this should be a legit - and preferable! - usage
    // the field is not required
    #[clap(default_values = &amp;[&quot;1&quot;])]
    d: Vec&lt;u32&gt;
}
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone &quot;3.0&quot; by <a href="https://github.com/pksunkara">@pksunkara</a> on 2020-08-12 08:38</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Unassigned <a href="https://github.com/CreepySkeleton">@CreepySkeleton</a> by <a href="https://github.com/ldm0">@ldm0</a> on 2021-03-13 13:19</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to <a href="https://github.com/ldm0">@ldm0</a> by <a href="https://github.com/ldm0">@ldm0</a> on 2021-03-13 13:19</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/pitschr">@pitschr</a> on 2021-04-23 20:12</div>
            <div class="timeline-body"><p>I figured out that <code>#[clap(required = false)]</code> is not working when you have like:</p>
<pre><code>#[derive(Clap)]
struct Write {
    #[clap(short = &#x27;g&#x27;, long)]
    group_address: String,

    #[clap(short = &#x27;d&#x27;, long, required = false)]
    data: String
}
</code></pre>
<p>as the compiler issues with:</p>
<pre><code>thread &#x27;main&#x27; panicked at &#x27;called `Option::unwrap()` on a `None` value&#x27;, src/main.rs:40:11
</code></pre>
<p>Resolution:</p>
<pre><code>    #[clap(short = &#x27;d&#x27;, long)]
    data: Option&lt;String&gt;
</code></pre>
<p>This works and also makes <code>required = false</code> obsolete.</p>
<p>My point here is that setting like <code>#[clap(required = false)]</code> is obsolete as it is sufficient to use <code>Option</code> so rather fixing it perhaps drop the <code>required</code> as obsolete?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/abonander">@abonander</a> on 2021-08-25 19:53</div>
            <div class="timeline-body"><p>I was about to open my own issue for this, but I think it might be a bug when you specify an empty string for <code>default_value</code>.</p>
<p>For example, instead of using <code>Option&lt;String&gt;</code> I wanted a value to default to the empty string:</p>
<pre><code>#[derive(Clap)]
struct Opts {
    #[clap(long, env, default_value = &quot;&quot;)]
    some_api_key: String
}
</code></pre>
<p>This will cause <code>some_api_key</code> to be <em>required</em>, whereas specifying a non-empty default value does not:</p>
<pre><code>#[derive(Clap)]
struct Opts {
    #[clap(long, env, default_value = &quot;blah&quot;)]
    some_api_key: String
}
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2021-08-25 20:10</div>
            <div class="timeline-body"><p>@abonander I think I&#x27;m missing something.  On <code>master</code> I tried</p>
<pre><code>fn main() {
    use clap::Clap;
    #[derive(Clap, Debug)]
    struct Opts {
        #[clap(long, env, default_value = &quot;&quot;)]
        nothing: String,
        #[clap(long, env, default_value = &quot;something&quot;)]
        something: String,
    }
    let m = Opts::parse();
    dbg!(m);
}
</code></pre>
<p>and got</p>
<pre><code>❯ cargo run
   Compiling clap v3.0.0-beta.4 (/home/epage/src/personal/clap)
   Compiling foo-bin v0.1.0 (/home/epage/src/personal/foo)
    Finished dev [unoptimized + debuginfo] target(s) in 4.27s
     Running `target/debug/foo-bin`
[src/main.rs:67] m = Opts {
    nothing: &quot;&quot;,
    something: &quot;something&quot;,
}
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/abonander">@abonander</a> on 2021-08-25 20:16</div>
            <div class="timeline-body"><p>@epage ah, just checked the <code>Cargo.lock</code> of the project, it was specifically <code>3.0.0-beta.2</code> that I encountered this issue and I was just now able to reproduce it on that version but it seems to have been fixed by <code>3.0.0-beta.4</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2021-10-05 15:06</div>
            <div class="timeline-body"><p>With <code>master</code>, I can&#x27;t reproduce this issue</p>
<pre><code>use clap::Clap;

#[derive(Clap, Debug)]
struct Opts {
    // this option is required because it&#x27;s not Option (please excuse the pun)
    //a: u32,

    // this option is NOT required, despite the fact it&#x27;s not Option
    // if absent, the default value will be used
    //#[clap(default_value = &quot;1&quot;)]
    //b: u32,

    // this should be a compile time error because default_value (singular)
    // is kinda meaningless with `Vec`
    //
    // This case is what OP complained about: it turns out the field somehow becomes required (WTF???).
    #[clap(default_value = &quot;1&quot;)]
    c: Vec&lt;u32&gt;,
    // this should be a legit - and preferable! - usage
    // the field is not required
    //#[clap(default_values = &amp;[&quot;1&quot;])]
    //d: Vec&lt;u32&gt;,
}

fn main() {
    let opts = Opts::parse(); // panics
    dbg!(opts);
}
</code></pre>
<pre><code>❯ cargo run
   Compiling test-clap v0.1.0 (/home/epage/src/personal/test-clap)
    Finished dev [unoptimized + debuginfo] target(s) in 0.60s
     Running `target/debug/test-clap`
[src/main.rs:27] opts = Opts {
    c: [
        1,
    ],
}
</code></pre>
<pre><code>❯ cargo run -- --help
    Finished dev [unoptimized + debuginfo] target(s) in 0.01s
     Running `target/debug/test-clap --help`
test-clap 

USAGE:
    test-clap [C]...

ARGS:
    &lt;C&gt;...    [default: 1]

FLAGS:
    -h, --help       Print help information
    -V, --version    Print version information
</code></pre>
<p>Am I doing something wrong?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/pksunkara">@pksunkara</a> on 2021-10-09 02:09</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:57:52 UTC
    </footer>
</body>
</html>
