<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Subcommand bin_name on Windows contains &quot;.exe&quot; in the middle instead of at the end (or not at all) - clap-rs/clap #992</title>
    <link rel="stylesheet" href="../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../index.html">Back to index</a>
    </div>

    <h1>Subcommand bin_name on Windows contains &quot;.exe&quot; in the middle instead of at the end (or not at all)</h1>

    <div class="meta">
        <span class="state state-closed">Closed</span>
        <a href="https://github.com/clap-rs/clap/issues/992">#992</a>
        opened by <a href="https://github.com/Arnavion">@Arnavion</a>
        on 2017-06-30 18:45
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/Arnavion">@Arnavion</a> on 2017-06-30 18:45</div>
            <div class="timeline-body"><h3>Rust Version</h3>
<p><code>rustc 1.20.0-nightly (f590a44ce 2017-06-27)</code></p>
<h3>Affected Version of clap</h3>
<p><code>2.25.0</code></p>
<h3>Steps to Reproduce the issue</h3>
<ol>
<li><p><code>Cargo.toml</code>:</p>
<pre><code class="language-toml">[package]
name = &quot;foo&quot;
version = &quot;0.1.0&quot;

[dependencies]
clap = &quot;*&quot;
</code></pre>
</li>
<li><p><code>src/main.rs</code>:</p>
<pre><code class="language-rust">#[macro_use]
extern crate clap;

fn main() {
    let app = clap_app!(
        @app (app_from_crate!())
        (@subcommand bar =&gt; )
    );
    let _matches = app.get_matches();
}
</code></pre>
</li>
<li><p><code>cargo run -- bar --help</code> (This runs <code>target\debug\foo.exe bar --help</code>. Note the <code>.exe</code>). Alternatively, run <code>.\target\debug\foo.exe bar --help</code> in cmd or PS. Both these will set <code>argv[0]</code> to something ending with <code>foo.exe</code></p>
<p>Also, running <code>.\target\debug\foo bar --help</code> in PS (note doesn't have <code>.exe</code>) will still have <code>argv[0]</code> ending with <code>foo.exe</code> because PS adds it automatically when spawning the process. cmd does not have this behavior so <code>.\target\debug\foo bar --help</code> in cmd will have <code>argv[0]</code> ending in <code>foo</code></p>
</li>
</ol>
<h3>Expected Behavior Summary</h3>
<p>Output should say <code>foo-bar</code> or <code>foo-bar.exe</code> as the name above the usage.</p>
<h3>Actual Behavior Summary</h3>
<p>Output says <code>foo.exe-bar</code> as the name above the usage. Note that the usage itself prints <code>foo.exe bar</code> which is fine, just the name printed above the usage is the problem.</p>
<pre><code>foo.exe-bar

USAGE:
    foo.exe bar

FLAGS:
    -h, --help       Prints help information
    -V, --version    Prints version information
</code></pre>
<h3>Debug output</h3>
<blockquote>
<p>Compile clap with cargo features <code>&quot;debug&quot;</code> such as:</p>
</blockquote>
<p><a href="https://github.com/kbknapp/clap-rs/blob/e27a6ffb/src/app/parser.rs#L6-L7">The <code>debug</code> feature does not build on Windows.</a></p>
<h3>Workaround</h3>
<p>Provide the <code>bin_name</code> manually instead of letting clap <a href="https://github.com/kbknapp/clap-rs/blob/e27a6ffb/src/app/mod.rs#L1610">parse it from <code>std::env::args_os()</code>.</a></p>
<pre><code>    let app = clap_app!(
        @app (app_from_crate!()) (bin_name: &quot;foo&quot;)
        (@subcommand bar =&gt; )
    );
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Arnavion">@Arnavion</a> on 2017-06-30 19:01</div>
            <div class="timeline-body"><p>Just stripping <code>.exe</code> from the end of <code>argv[0]</code> if <code>#[cfg(windows)]</code> should be fine, I think.</p>
<p>Of course this will lead to the wrong output from <code>foo.exe --help</code> if someone names their binary <code>foo.exe.exe</code> (it'll strip the <code>.exe</code> and print <code>foo</code>, which won't work), but that is an unlikely situation.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">C: help message</span> added by @kbknapp on 2017-10-04 02:28</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">C: subcommands</span> added by @kbknapp on 2017-10-04 02:28</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">P4: nice to have</span> added by @kbknapp on 2017-10-04 02:28</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">T: bug</span> added by @kbknapp on 2017-10-04 02:28</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/kbknapp">@kbknapp</a> on 2017-10-04 02:30</div>
            <div class="timeline-body"><p>When building the subcommand name, I'd be fine with stripping the <code>.exe</code> <em>only</em> when we do the &quot;concat with subcommands&quot; titling. This would be a very easy fix if someone wants a quick PR.</p>
<p><a href="https://github.com/kbknapp/clap-rs/blob/3224e2e1cd4927935f44081c1ca686d95f267790/src/app/help.rs#L614-L634">Relevant function to fix</a></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone "3.0" by @pksunkara on 2020-04-09 07:06</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">D: easy</span> added by @pksunkara on 2020-04-09 07:07</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">Z: good first issue</span> added by @pksunkara on 2020-04-09 07:07</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">Z: mentored</span> added by @pksunkara on 2020-04-09 07:07</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Removed from milestone "3.0" by @pksunkara on 2020-04-23 07:58</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone "3.1" by @pksunkara on 2020-04-23 07:58</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/retep998">@retep998</a> on 2020-05-20 03:49</div>
            <div class="timeline-body"><p>To avoid issues with whether the shell included the <code>.exe</code> in <code>argv[0]</code> you can just get the executable name directly on Windows via <code>GetModuleFileNameW</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/CreepySkeleton">@CreepySkeleton</a> on 2020-05-20 07:33</div>
            <div class="timeline-body"><blockquote>
<p>To avoid issues with whether the shell included the <code>.exe</code> in <code>argv[0]</code> you can just get the executable name directly on Windows via <code>GetModuleFileNameW</code>.</p>
</blockquote>
<p>Are there safe bindings to it?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/retep998">@retep998</a> on 2020-05-20 07:46</div>
            <div class="timeline-body"><p>Actually, it turns out <code>std::env::current_exe()</code> on Windows already does exactly that.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/pksunkara">@pksunkara</a> on 2020-05-20 14:11</div>
            <div class="timeline-body"><p>Will you be sending a PR?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/CreepySkeleton">@CreepySkeleton</a> on 2020-05-20 15:23</div>
            <div class="timeline-body"><p>It's actually more complicated than it sounds.</p>
<p>With <code>current_exe</code> in mind, we have two competing sources for the application name:</p>
<ul>
<li>The first element of the iterator (if <code>NoBinaryName</code> wasn't set)</li>
<li><code>current_exe()</code></li>
</ul>
<p>Which one to choose? Do we just discard the element and use <code>current_exe</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/retep998">@retep998</a> on 2020-05-20 15:42</div>
            <div class="timeline-body"><p>What are the reasons for using <code>argv[0]</code> instead of <code>current_exe()</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/CreepySkeleton">@CreepySkeleton</a> on 2020-05-20 15:52</div>
            <div class="timeline-body"><p>The iterator <code>clap</code> parser gets may or may not be from <code>env::args()</code>. It can be a user-provided array with it's own first item which is <em>supposed</em> to be used &quot;as if&quot; it was <code>argv[0]</code>. It should probably be prioritized over <code>current_exe</code>.</p>
<p><code>get_matches</code> must use <code>current_exe</code> and <code>get_matches_from</code> must use <code>iter.nth(0)</code>, I think.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/kbknapp">@kbknapp</a> on 2020-05-26 22:33</div>
            <div class="timeline-body"><blockquote>
<p>The first element of the iterator (if <code>NoBinaryName</code> wasn't set)</p>
</blockquote>
<p>The purpose of that setting was to start parsing immediately as arguments, instead of skipping <code>argv[0]</code>. i.e. such as a REPL or other prompt where the consumer code is continually passing an <code>argv</code> direct to clap that doesn't include the binary.</p>
<blockquote>
<p>which is supposed to be used &quot;as if&quot; it was <code>argv[0]</code></p>
</blockquote>
<p>That's the incorrect bit :wink: clap assumes the binary name was set manually when <code>NoBinaryName</code> is used, it doesn't re-interpret <code>argv[0]</code> as a new binary name.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/kotx">@kotx</a> on 2021-07-03 05:42</div>
            <div class="timeline-body"><p>Any update on this?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../epage/clapng/issues/74.html">epage/clapng#74</a> on 2021-12-06 16:34</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/3073.html">clap-rs/clap#3073</a> on 2021-12-08 00:16</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2021-12-08 00:30</div>
            <div class="timeline-body"><p>We've also run into this when testing examples, like the former <code>08_subcommands[.exe-add</code></p>
<pre><code>$ 08_subcommands help add
08_subcommands[.exe-add 0.1

Kevin K.

Adds files to myapp

USAGE:
    08_subcommands.exe add &lt;input&gt;

ARGS:
    &lt;input&gt;    the file to add

OPTIONS:
    -h, --help       Print help information
    -V, --version    Print version information
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">C: subcommands</span> removed by @epage on 2021-12-08 20:15</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2021-12-09 17:04</div>
            <div class="timeline-body"><p>Why would we not just strip <code>std::env::consts::EXE_SUFFIX</code> from argv[0] when setting the bin name?  Do we really need <code>.exe</code> everywhere else?  If <code>get_matches_from</code> is meant to act like <code>get_matches</code>, it seems like it should be fine for us to strip it from there to.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">P4: nice to have</span> removed by @epage on 2021-12-09 17:04</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">D: easy</span> removed by @epage on 2021-12-09 17:04</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">E-medium</span> removed by @epage on 2021-12-09 17:04</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">S-waiting-on-decision</span> added by @epage on 2021-12-09 17:04</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">S-waiting-on-decision</span> removed by @epage on 2021-12-09 17:05</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">S-waiting-on-design</span> added by @epage on 2021-12-09 17:05</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/pksunkara">@pksunkara</a> on 2021-12-10 02:02</div>
            <div class="timeline-body"><blockquote>
<p>Do we really need .exe everywhere else?</p>
</blockquote>
<p>I am under the impression that we do. <strong>bin name</strong> has always been about the actual binary name and I think it's been used in other places with that assumption which is why Kevin suggested a new variable to hold this name in the first place.</p>
<blockquote>
<p>I'd be fine with stripping the .exe only when we do the &quot;concat with subcommands&quot; titling.</p>
</blockquote>
<p>If you were to audit the usage of it and decide that it's okay setting bin name without <code>.exe</code>, then I am good with your proposal.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2021-12-10 18:31</div>
            <div class="timeline-body"><blockquote>
<p>If you were to audit the usage of it and decide that it's okay setting bin name without .exe, then I am good with your proposal.</p>
</blockquote>
<p>Looking around, it looks like its only used for display purposes, like help and error messages.  I'm not seeing anything doing processing based on the name.  We don't expose the <code>bin_name</code> from <code>arg_matches</code>.  We do mutate the <code>App</code> with the bin name from the last parse, so someone could do</p>
<pre><code class="language-rust">let matches = app.get_matches_mut();
let  bin = app.get_bin_name()
</code></pre>
<p>Personally, that feels hacky; imo all parse results should be coming from <code>ArgMatches</code>.   In considering this, a naiive implementation of #2911 would make it so people would never be able to look up the <code>bin_name</code> found from parsing.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/3041.html">clap-rs/clap#3041</a> on 2021-12-10 20:58</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/2861.html">clap-rs/clap#2861</a> on 2021-12-13 15:24</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/3096.html">clap-rs/clap#3096</a> on 2021-12-14 21:59</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/1474.html">clap-rs/clap#1474</a> on 2021-12-14 22:02</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/spenserblack">@spenserblack</a> on 2022-01-03 21:30</div>
            <div class="timeline-body"><blockquote>
<p>Do we really need <code>.exe</code> everywhere else?</p>
</blockquote>
<p>Are you asking if <code>.exe</code> should be removed <em>everywhere</em>?
I think it's slightly useful in the usage section, since it's possible for command prompt to prioritize <code>my-app.bat</code> over <code>my-app.exe</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Removed from milestone "3.x" by @epage on 2022-02-02 19:53</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone "3.1" by @epage on 2022-02-02 19:53</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Removed from milestone "3.1" by @epage on 2022-02-08 20:44</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone "3.2" by @epage on 2022-02-08 20:44</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/3515.html">clap-rs/clap#3515</a> on 2022-03-07 20:51</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../rust-lang/cargo/issues/10561.html">rust-lang/cargo#10561</a> on 2022-04-13 14:22</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/3680.html">clap-rs/clap#3680</a> on 2022-05-03 19:35</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Removed from milestone "3.2" by @epage on 2022-05-05 01:14</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone "4.0" by @epage on 2022-05-05 01:14</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2022-05-05 01:14</div>
            <div class="timeline-body"><p>We're close enough to when we can start working on 4.0, I'm going to play it safe and push it off to then</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/3693.html">clap-rs/clap#3693</a> on 2022-05-05 01:25</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @epage on 2022-05-05 17:01</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/4132.html">clap-rs/clap#4132</a> on 2022-08-27 02:18</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dbsxdbsx">@dbsxdbsx</a> on 2022-12-26 02:27</div>
            <div class="timeline-body"><blockquote>
<p>Why would we not just strip <code>std::env::consts::EXE_SUFFIX</code> from argv[0] when setting the bin name? Do we really need <code>.exe</code> everywhere else? If <code>get_matches_from</code> is meant to act like <code>get_matches</code>, it seems like it should be fine for us to strip it from there to.</p>
</blockquote>
<p>(I am using clap 3.2.14)
I wonder how to eliminate the <code>exe</code> suffix output after running command on windows when using clap under <code>derive</code>.
Currently,
with cargo.toml:</p>
<pre><code class="language-toml">[[bin]]
name = &quot;app_name&quot;
path = &quot;src/main.rs&quot;
</code></pre>
<p>and a struct using clap:</p>
<pre><code class="language-rust">#[derive(Parser, Debug, PartialEq, Eq, Deserialize, Default)]
#[clap(version, setting(clap::AppSettings::DeriveDisplayOrder))]
pub struct MyStruct {
...
}
</code></pre>
<p>after running <code>cargo run --manifest-path [project_path]/Cargo.toml -- --help &gt; book/src/help.txt </code>
the <code>USAGE</code> section of help.txt is like:</p>
<pre><code class="language-log">USAGE:
    app_name.exe [OPTIONS] ...
</code></pre>
<p>I do can eliminate the <code>exe</code> by changing the derivative to :</p>
<pre><code class="language-rust">#[clap(bin_name = &quot;app_name&quot;, version, setting(clap::AppSettings::DeriveDisplayOrder))]
</code></pre>
<p>But is there a way without changing the derivative macro?  Meanwhile, I also wonder how to output like so:</p>
<pre><code class="language-log">USAGE:
    app_name[EXE] [OPTIONS] ...
</code></pre>
<p>with <code>[EXE]</code> instead of <code>.exe</code> whatever platform I am running.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2022-12-26 18:26</div>
            <div class="timeline-body"><p>Specifying attributes is how you customize clap via the derive and setting <code>bin_name</code> is exactly the way to resolve this.</p>
<p><code>[EXE]</code> is in our documentation due to our <a href="https://docs.rs/trycmd/latest/trycmd/">testing framework</a> for our docs.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../trunk-rs/trunk/issues/556.html">trunk-rs/trunk#556</a> on 2023-06-16 16:35</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:28:32 UTC
    </footer>
</body>
</html>
