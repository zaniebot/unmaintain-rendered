<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Setting flag argument's env var to `flase` still flagged as conflicting - clap-rs/clap #5591</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Setting flag argument's env var to <code>flase</code> still flagged as conflicting</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/clap-rs/clap/issues/5591">#5591</a>
        opened by <a href="https://github.com/elichai">@elichai</a>
        on 2024-07-21 15:24
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/elichai">@elichai</a></div>
            <div class="timeline-body"><h3>Please complete the following tasks</h3>
<ul>
<li>[X] I have searched the <a href="https://github.com/clap-rs/clap/discussions">discussions</a></li>
<li>[X] I have searched the <a href="https://github.com/clap-rs/clap/issues">open</a> and <a href="https://github.com/clap-rs/clap/issues?q=is%3Aissue+label%3AS-wont-fix+is%3Aclosed">rejected</a> issues</li>
</ul>
<h3>Rust Version</h3>
<p>1.79.0</p>
<h3>Clap Version</h3>
<p>4.5.9</p>
<h3>Minimal reproducible code</h3>
<pre><code class="language-rust">use clap::{arg, value_parser, ArgGroup, Command};

fn main() {
    std::env::set_var(&quot;MEMORY_STORAGE&quot;, &quot;false&quot;);
    std::env::set_var(
        &quot;POSTGRES_CONNECTION_STRING&quot;,
        &quot;postgres://user:password@localhost:5432/db&quot;,
    );

    let matches = Command::new(&quot;sample&quot;)
        .group(
            ArgGroup::new(&quot;storage&quot;)
                .args([&quot;memory-storage&quot;, &quot;postgres&quot;])
                .multiple(false)
                .required(true),
        )
        .arg(
            arg!(--&quot;memory-storage&quot; &quot;Use an in-memory storage backend&quot;)
                .value_parser(value_parser!(bool))
                .env(&quot;MEMORY_STORAGE&quot;),
        )
        .arg(
            arg!(-p --postgres &lt;CONNECTION_STRING&gt; &quot;A postgreSQL connection string&quot;)
                .env(&quot;POSTGRES_CONNECTION_STRING&quot;),
        )
        .get_matches();

    println!(&quot;{matches:?}&quot;);
}
</code></pre>
<h3>Steps to reproduce the bug with the above code</h3>
<pre><code>cargo add clap --features env
</code></pre>
<h3>Actual Behaviour</h3>
<pre><code>error: the argument '--memory-storage' cannot be used with '--postgres &lt;CONNECTION_STRING&gt;'

Usage: sample &lt;--memory-storage|--postgres &lt;CONNECTION_STRING&gt;&gt;

For more information, try '--help'.
</code></pre>
<h3>Expected Behaviour</h3>
<p>When I set a flag's env variable to <code>false</code> I expect it to not be flagged as conflicting and that it will properly use the postgres connection string</p>
<h3>Additional Context</h3>
<p><em>No response</em></p>
<h3>Debug Output</h3>
<pre><code>[clap_builder::builder::command]Command::_do_parse
[clap_builder::builder::command]Command::_build: name=&quot;sample&quot;
[clap_builder::builder::command]Command::_propagate:sample
[clap_builder::builder::command]Command::_check_help_and_version:sample expand_help_tree=false
[clap_builder::builder::command]Command::long_help_exists
[clap_builder::builder::command]Command::_check_help_and_version: Building default --help
[clap_builder::builder::command]Command::_propagate_global_args:sample
[clap_builder::builder::debug_asserts]Command::_debug_asserts
[clap_builder::builder::debug_asserts]Arg::_debug_asserts:memory-storage
[clap_builder::builder::debug_asserts]Arg::_debug_asserts:postgres
[clap_builder::builder::debug_asserts]Arg::_debug_asserts:help
[clap_builder::builder::debug_asserts]Command::_verify_positionals
[clap_builder::parser::parser]Parser::get_matches_with
[clap_builder::parser::parser]Parser::add_env
[clap_builder::parser::parser]Parser::add_env: Checking arg `--memory-storage`
[clap_builder::parser::parser]Parser::add_env: Found an opt with value=&quot;false&quot;
[clap_builder::parser::parser]Parser::react action=SetTrue, identifier=None, source=EnvVariable
[clap_builder::parser::arg_matcher]ArgMatcher::start_custom_arg: id=&quot;memory-storage&quot;, source=EnvVariable
[clap_builder::builder::command]Command::groups_for_arg: id=&quot;memory-storage&quot;
[clap_builder::parser::arg_matcher]ArgMatcher::start_custom_arg: id=&quot;storage&quot;, source=EnvVariable
[clap_builder::parser::parser]Parser::push_arg_values: [&quot;false&quot;]
[clap_builder::parser::parser]Parser::add_single_val_to_arg: cur_idx:=1
[clap_builder::parser::parser]Parser::add_env: Checking arg `--postgres &lt;CONNECTION_STRING&gt;`
[clap_builder::parser::parser]Parser::add_env: Found an opt with value=&quot;postgres://user:password@localhost:5432/db&quot;
[clap_builder::parser::parser]Parser::react action=Set, identifier=None, source=EnvVariable
[clap_builder::parser::arg_matcher]ArgMatcher::start_custom_arg: id=&quot;postgres&quot;, source=EnvVariable
[clap_builder::builder::command]Command::groups_for_arg: id=&quot;postgres&quot;
[clap_builder::parser::arg_matcher]ArgMatcher::start_custom_arg: id=&quot;storage&quot;, source=EnvVariable
[clap_builder::parser::parser]Parser::push_arg_values: [&quot;postgres://user:password@localhost:5432/db&quot;]
[clap_builder::parser::parser]Parser::add_single_val_to_arg: cur_idx:=2
[clap_builder::parser::arg_matcher]ArgMatcher::needs_more_vals: o=postgres, pending=0
[clap_builder::parser::arg_matcher]ArgMatcher::needs_more_vals: expected=1, actual=0
[clap_builder::parser::parser]Parser::react not enough values passed in, leaving it to the validator to complain
[clap_builder::parser::parser]Parser::add_env: Checking arg `--help`
[clap_builder::parser::parser]Parser::add_defaults
[clap_builder::parser::parser]Parser::add_defaults:iter:memory-storage:
[clap_builder::parser::parser]Parser::add_default_value: doesn't have conditional defaults
[clap_builder::parser::parser]Parser::add_default_value:iter:memory-storage: has default vals
[clap_builder::parser::parser]Parser::add_default_value:iter:memory-storage: was used
[clap_builder::parser::parser]Parser::add_defaults:iter:postgres:
[clap_builder::parser::parser]Parser::add_default_value: doesn't have conditional defaults
[clap_builder::parser::parser]Parser::add_default_value:iter:postgres: doesn't have default vals
[clap_builder::parser::parser]Parser::add_defaults:iter:help:
[clap_builder::parser::parser]Parser::add_default_value: doesn't have conditional defaults
[clap_builder::parser::parser]Parser::add_default_value:iter:help: doesn't have default vals
[clap_builder::parser::validator]Validator::validate
[clap_builder::builder::command]Command::groups_for_arg: id=&quot;memory-storage&quot;
[clap_builder::parser::validator]Conflicts::gather_direct_conflicts id=&quot;memory-storage&quot;, conflicts=[&quot;postgres&quot;]
[clap_builder::parser::validator]Conflicts::gather_direct_conflicts id=&quot;storage&quot;, conflicts=[]
[clap_builder::builder::command]Command::groups_for_arg: id=&quot;postgres&quot;
[clap_builder::parser::validator]Conflicts::gather_direct_conflicts id=&quot;postgres&quot;, conflicts=[&quot;memory-storage&quot;]
[clap_builder::parser::validator]Validator::validate_conflicts
[clap_builder::parser::validator]Validator::validate_exclusive
[clap_builder::parser::validator]Validator::validate_exclusive:iter:&quot;memory-storage&quot;
[clap_builder::parser::validator]Validator::validate_exclusive:iter:&quot;storage&quot;
[clap_builder::parser::validator]Validator::validate_exclusive:iter:&quot;postgres&quot;
[clap_builder::parser::validator]Validator::validate_conflicts::iter: id=&quot;memory-storage&quot;
[clap_builder::parser::validator]Conflicts::gather_conflicts: arg=&quot;memory-storage&quot;
[clap_builder::parser::validator]Conflicts::gather_conflicts: conflicts=[&quot;postgres&quot;, &quot;postgres&quot;]
[clap_builder::parser::validator]Validator::build_conflict_err: name=&quot;memory-storage&quot;
[ clap_builder::output::usage]Usage::create_usage_with_title
[ clap_builder::output::usage]Usage::create_usage_no_title
[ clap_builder::output::usage]Usage::create_smart_usage
[ clap_builder::output::usage]Usage::write_arg_usage; incl_reqs=true
[ clap_builder::output::usage]Usage::write_args: incls=[&quot;memory-storage&quot;]
[ clap_builder::output::usage]Usage::get_args: unrolled_reqs=[&quot;storage&quot;]
[clap_builder::builder::command]Command::unroll_args_in_group: group=&quot;storage&quot;
[clap_builder::builder::command]Command::unroll_args_in_group:iter: entity=&quot;memory-storage&quot;
[clap_builder::builder::command]Command::unroll_args_in_group:iter: this is an arg
[clap_builder::builder::command]Command::unroll_args_in_group:iter: entity=&quot;postgres&quot;
[clap_builder::builder::command]Command::unroll_args_in_group:iter: this is an arg
[clap_builder::builder::command]Command::unroll_args_in_group: group=&quot;storage&quot;
[clap_builder::builder::command]Command::unroll_args_in_group:iter: entity=&quot;memory-storage&quot;
[clap_builder::builder::command]Command::unroll_args_in_group:iter: this is an arg
[clap_builder::builder::command]Command::unroll_args_in_group:iter: entity=&quot;postgres&quot;
[clap_builder::builder::command]Command::unroll_args_in_group:iter: this is an arg
[ clap_builder::output::usage]Usage::create_usage_with_title: usage=Usage: wat &lt;--memory-storage|--postgres &lt;CONNECTION_STRING&gt;&gt;
[clap_builder::builder::command]Command::color: Color setting...
[clap_builder::builder::command]Auto
[clap_builder::builder::command]Command::color: Color setting...
[clap_builder::builder::command]Auto
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">C-bug</span> added by @elichai on 2024-07-21 15:24</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2025-05-13 07:12</div>
            <div class="timeline-body"><p>We have a similar problem in uv, where boolean env vars cannot be reset, causing conflicts (https://github.com/astral-sh/uv/issues/13385). This affects a number of arguments in uv that have both a default value and conflict with another argument.</p>
<pre><code class="language-rust">use clap::Parser;

#[derive(Debug, Parser)]
pub struct Args {
    /// Don't resolve.
    #[arg(long, env = &quot;FROZEN&quot;, value_parser = clap::builder::BoolishValueParser::new(), conflicts_with_all = [&quot;check&quot;])]
    frozen: bool,

    /// Check that the resolution is valid.
    #[arg(long, env = &quot;CHECK&quot;, value_parser = clap::builder::BoolishValueParser::new())]
    check: bool,
}

fn main() {
    let args = Args::parse();
    println!(&quot;Args: {args:?}&quot;);
}
</code></pre>
<pre><code>$ CHECK=0 mini-uv --frozen
error: the argument '--frozen' cannot be used with '--check'

Usage: clap-conflicts --frozen

For more information, try '--help'.
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../astral-sh/uv/issues/13385.html">astral-sh/uv#13385</a> on 2025-05-13 07:13</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/NellyWhads">@NellyWhads</a> on 2025-05-14 22:10</div>
            <div class="timeline-body"><p>Is there perhaps a high level suggested change? I could try to take a look over the weekend?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../astral-sh/uv/pulls/17321.html">astral-sh/uv#17321</a> on 2026-01-05 12:47</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/6211.html">clap-rs/clap#6211</a> on 2026-01-05 15:00</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">A-parsing</span> added by @epage on 2026-01-05 15:04</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2026-01-05 15:10</div>
            <div class="timeline-body"><p>This very much ties into #3572</p>
<p>From https://github.com/clap-rs/clap/issues/3572#issuecomment-1077690873</p>
<blockquote>
<p><a href="https://github.com/clap-rs/clap/pull/3421">#3421</a> changed <code>arg_required_else_help</code> to ignore defaults to align with <a href="https://github.com/clap-rs/clap/pull/3420">#3420</a> where all our requirement and conflict handling was updated to ignore defaults. <a href="https://github.com/clap-rs/clap/pull/3420">#3420</a> was a continuation of <a href="https://github.com/clap-rs/clap/pull/3020">#3020</a> and <a href="https://github.com/clap-rs/clap/pull/2950">#2950</a>.</p>
<p>In <a href="https://github.com/clap-rs/clap/pull/2950">#2950</a>, we <a href="https://github.com/clap-rs/clap/pull/2950#discussion_r736905259">discussed</a> how we should handle env variables and it was proposed that we treat them like user supplied values.</p>
<p>So the questions for this issue</p>
<pre><code>* What is the ideal behavior of `arg_required_else_help` be when env variables are set and how important is that?
  
  * Show `--help` if there is no `ValueSource::CommandLine` value
    
    * Note: this would be a breaking change as this is dependent on the context while checking for defaults was not because that is static and turned a non-working case to a working case
  * Fallback to any errors associated with values being set to `ValueSource::EnvVariable`
  * Show `--help` if `is_subcommand_required` and there is no subcommand

* If we want to reconsider the handling of `ValueSource::EnvVariable` here, should we do it elsewhere?
  
  * Note: this would be a breaking change as this is dependent on the context while checking for defaults was not because that is static and turned a non-working case to a working case</code></pre>
<p><a href="https://github.com/pksunkara">@pksunkara</a> since you were involved in the past discussion, I'd be curious to know what your thoughts are? I think showing <code>--help</code> on a missing required subcommand is an easy choice but also wondering about the larger picture on this about env variables.</p>
</blockquote>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">S-waiting-on-decision</span> added by @epage on 2026-01-05 15:10</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">M-breaking-change</span> added by @epage on 2026-01-05 15:10</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2026-01-05 15:11</div>
            <div class="timeline-body"><p>Marking this as a breaking change as a pre-caution and if anyone wants to do this before clap v5, you'll need to make the case for why this isn't a breaking change.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:49:24 UTC
    </footer>
</body>
</html>
