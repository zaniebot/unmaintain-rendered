<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>(clap_complete) Make `Shell` ValueEnum Parser also Accept $SHELL Output (Path Prefixed Shell Names)  - clap-rs/clap #5370</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>(clap_complete) Make <code>Shell</code> ValueEnum Parser also Accept $SHELL Output (Path Prefixed Shell Names)</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/clap-rs/clap/issues/5370">#5370</a>
        opened by <a href="https://github.com/ultrabear">@ultrabear</a>
        on 2024-02-20 23:39
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ultrabear">@ultrabear</a></div>
            <div class="timeline-body">Please complete the following tasks
<ul>
<li>[X] I have searched the <a href="https://github.com/clap-rs/clap/discussions">discussions</a></li>
<li>[X] I have searched the <a href="https://github.com/clap-rs/clap/issues">open</a> and <a href="https://github.com/clap-rs/clap/issues?q=is%3Aissue+label%3AS-wont-fix+is%3Aclosed">rejected</a> issues</li>
</ul>
Clap Version
<p>clap v4.5.1</p>
Describe your use case
<p>I am developing a CLI using clap and have added completions support under <code>cmdname completions &lt;SHELL&gt;</code>, this uses clap_complete::Shell ValueEnum parsing.
When trying to document how to use these completions, I tried writing:</p>
<pre><code># to add completions for common shells (bash/zsh/fish) simply write
cmdname completions $SHELL | source
</code></pre>
<p>Basically, the issue is that <code>Shell</code> only accepts the name of the shell alone, and the $SHELL env var is a path on my system (in my case its <code>/bin/fish</code>).</p>
Describe the solution you&#x27;d like
<p>The solution I came up with was modifying the ValueEnum trait implementation of Shell to make from_str split out the last / (probably best done with str::rsplit_once) and then parse the value after that:</p>
<pre><code>    fn from_str(mut input: &amp;str, ignore_case: bool) -&gt; Result&lt;Self, String&gt; {
        input = input.rsplit_once(&#x27;/&#x27;).map_or(input, |(_, after)| after);
        ... 
        // insert basically the default impl after this, though it would be nice if it didn&#x27;t
        // need to be copied, trying to handwrite it to use a match is a bad experience, the 
        // root of the issue being that eq_ignore_case is a clap internal api, which is feature 
        // flagged on the unicode feature: that feature would need to be added to clap_complete 
        // to handwrite it fully. copying the current implementation is the lowest impact change
    }
</code></pre>
Alternatives, if applicable
<p>implementing TypedValueParser or another higher level method on Shell instead, this seems like considerably more work even if it may be more correct than &quot;hacking&quot; the way that ValueEnum is normally meant to be used</p>
Additional Context
<p>Initially I was going to write a PR for this, but after seeing the clap unicode feature (generally just handling ignore_case without copy pasting the default impl) blocked a &quot;simple&quot; solution I decided to write up an issue to gauge interest instead, if any of the proposed solutions looks good to maintainership I can totally write the functionality in myself as a PR (I want this feature afterall), I just didn&#x27;t want to jump the gun on something that may affect maintainability depending on how its implemented</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">C-enhancement</span> added by <a href="https://github.com/ultrabear">@ultrabear</a> on 2024-02-20 23:39</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">A-completion</span> added by <a href="https://github.com/epage">@epage</a> on 2024-02-21 01:19</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2024-02-21 01:25</div>
            <div class="timeline-body"><p>Closing as a duplicate of #4300 which was implemented in #4447.  If after reading the background in and linked to from #4300, you think we should revisit this, I&#x27;d recommend saying so in there and we can re-evaluate opening that issue.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/epage">@epage</a> on 2024-02-21 01:25</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ultrabear">@ultrabear</a> on 2024-02-21 01:38</div>
            <div class="timeline-body"><p>Uh, this is not actually a duplicate of that issue? That issue adds a method to implicitly parse Shell from the env, but does not add it to the ValueEnum implementation</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2024-02-21 01:40</div>
            <div class="timeline-body"><p>The PR did that but the issue was more broad and was spawned from #4296.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ultrabear">@ultrabear</a> on 2024-02-21 01:43</div>
            <div class="timeline-body"><p>Yeah, I see that was closed as not planned, but that was because it was reading the env, no?
The proposed implementation here would be so that users may pass $SHELL themselves, have their shell expand it, and then have eg <code>/bin/fish</code> be parsed as a valid shell by Shell::from_str (it does no env var reading, and crucially Just Works with the derive API when you mark something with the type Shell)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ultrabear">@ultrabear</a> on 2024-02-21 01:49</div>
            <div class="timeline-body"><p>If the conclusion here is that the implicit Shell::from_env method should be used, then thats fine, but personally I dont like reading env vars without being obvious about it, and this feature req aims to have less implicit state handled by the resulting binary, while still retaining a serviceable api</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2024-02-21 02:15</div>
            <div class="timeline-body"><blockquote>
<p>If the conclusion here is that the implicit Shell::from_env method should be used, then thats fine, but personally I dont like reading env vars without being obvious about it, and this feature req aims to have less implicit state handled by the resulting binary, while still retaining a serviceable api</p>
</blockquote>
<p>We do provide <a href="https://docs.rs/clap_complete/latest/clap_complete/shells/enum.Shell.html#method.from_shell_path"><code>Shell::from_shell_path</code></a>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2024-02-21 02:16</div>
            <div class="timeline-body"><blockquote>
<p>Yeah, I see that was closed as not planned, but that was because it was reading the env, no?
The proposed implementation here would be so that users may pass $SHELL themselves, have their shell expand it, and then have eg /bin/fish be parsed as a valid shell by Shell::from_str (it does no env var reading, and crucially Just Works with the derive API when you mark something with the type Shell)</p>
</blockquote>
<p>Yes, the difference is in whether the application reads <code>SHELL</code> directly or gets it via the command-line.  That is probably enough distinction to keep this separate.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Reopened by <a href="https://github.com/epage">@epage</a> on 2024-02-21 02:16</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">S-waiting-on-decision</span> added by <a href="https://github.com/epage">@epage</a> on 2024-02-21 02:16</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2024-02-21 02:19</div>
            <div class="timeline-body"><p>This can be worked around by using <code>Shell::from_shell_path</code> inside of a value parser function.  It would take some work to also have completions work.</p>
<p>Whether we provide this is all or nothing, so I would like to sit on this a bit to see what input we receive to get a better idea of whether this is a good direction to go.</p>
<p>If we go this route, it isn&#x27;t as simple as putting this in the <code>FromStr</code>.  We&#x27;d have to write a custom <code>TypedValueParser</code> impl as that is what is used for parsing the argument, not <code>FromStr</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ultrabear">@ultrabear</a> on 2024-02-21 02:32</div>
            <div class="timeline-body"><blockquote>
<p>If we go this route, it isn&#x27;t as simple as putting this in the <code>FromStr</code>. We&#x27;d have to write a custom <code>TypedValueParser</code> impl as that is what is used for parsing the argument, not <code>FromStr</code>.</p>
</blockquote>
<p>To be clear, I meant overriding the method in ValueEnum called from_str, not FromStr (which isn&#x27;t implemented for Shell regardless)
This lets us keep the value hinting, if I understand how the machinery all fits together</p>
<p>However, as I mentioned above, this feels a little hacky for what ValueEnum is normally meant to be used for</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2024-08-12 17:25</div>
            <div class="timeline-body"><p>I&#x27;ve added a new way to register shell completions in #5671 and it supports parsing <code>$SHELL</code>.  I lean towards closing in favor if that being our preferred solution.  If there is a reason for us to re-evaluate this, let us know!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/epage">@epage</a> on 2024-08-12 17:25</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 20:00:05 UTC
    </footer>
</body>
</html>
