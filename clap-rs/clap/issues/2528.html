<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Derived ArgEnum::from_str should not panic on invalid input  - clap-rs/clap #2528</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Derived ArgEnum::from_str should not panic on invalid input </h1>

    <div class="meta">
        <span class="state state-closed">Closed</span>
        <a href="https://github.com/clap-rs/clap/issues/2528">#2528</a>
        opened by <a href="https://github.com/edlanglois">@edlanglois</a>
        on 2021-06-08 17:30
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/edlanglois">@edlanglois</a> on 2021-06-08 17:30</div>
            <div class="timeline-body"><h3>Please complete the following tasks</h3>
<ul>
<li>[X] I have searched the <a href="https://github.com/clap-rs/clap/discussions">discussions</a></li>
<li>[X] I have searched the existing issues</li>
</ul>
<h3>Rust Version</h3>
<p>rustc 1.52.1</p>
<h3>Clap Version</h3>
<p>clap 3.0.0-beta.2</p>
<h3>Minimal reproducible code</h3>
<pre><code class="language-rust">use clap::ArgEnum;

#[derive(ArgEnum)]
pub enum MyEnum {
    Foo,
    Bar,
}

fn main() {
    let _ = MyEnum::from_str(&quot;baz&quot;, true).unwrap_or(MyEnum::Foo);
}
</code></pre>
<h3>Steps to reproduce the bug with the above code</h3>
<p><code>cargo run</code></p>
<h3>Actual Behaviour</h3>
<p>thread 'main' panicked at 'internal error: entered unreachable code: The impossible variant have been spotted: baz', src/main.rs:3:10</p>
<h3>Expected Behaviour</h3>
<p>The code completes without crashing and <code>MyEnum::Foo</code> is assigned to <code>_</code>.</p>
<h3>Additional Context</h3>
<p><code>ArgEnum::from_str</code> is defined as returning a <code>Result</code> so the derived implementation should follow that interface and return an <code>Err</code> on failure. Currently the derived implementation always returns <code>Ok</code> or panics with the <code>unreachable!</code> macro.</p>
<p>Since <code>ArgEnum</code> is public, it is not correct to assume that clap code will be the only caller, so the invalid input code-path is not actually unreachable.</p>
<p>In my case, I am defining an argument type that internally contains an enum and when implementing <code>FromStr</code> it is convenient to re-use <code>ArgEnum::from_str</code> so that I do not have to duplicate the enum parsing. However, this panics when passed an invalid argument on the command line.</p>
<h3>Debug Output</h3>
<p>No change, but here is the output with <code>RUST_BACKTRACE=1</code>:</p>
<pre><code>thread 'main' panicked at 'internal error: entered unreachable code: The impossible variant have been spotted: baz', src/main.rs:3:10
stack backtrace:
   0: rust_begin_unwind
             at /build/rust/src/rustc-1.52.1-src/library/std/src/panicking.rs:493:5
   1: core::panicking::panic_fmt
             at /build/rust/src/rustc-1.52.1-src/library/core/src/panicking.rs:92:14
   2: &lt;clap_bug::MyEnum as clap::derive::ArgEnum&gt;::from_str
             at ./src/main.rs:3:10
   3: clap_bug::main
             at ./src/main.rs:10:14
   4: core::ops::function::FnOnce::call_once
             at /build/rust/src/rustc-1.52.1-src/library/core/src/ops/function.rs:227:5
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">T: bug</span> added by @edlanglois on 2021-06-08 17:30</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/2529.html">clap-rs/clap#2529</a> on 2021-06-08 17:55</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone "3.0" by @pksunkara on 2021-06-08 22:13</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">C: derive macros</span> added by @pksunkara on 2021-06-08 22:13</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @pksunkara on 2021-06-08 23:08</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:35:08 UTC
    </footer>
</body>
</html>
