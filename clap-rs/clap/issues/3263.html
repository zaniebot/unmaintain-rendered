<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>External subcommands that alias built-in subccommands cause panics - clap-rs/clap #3263</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>External subcommands that alias built-in subccommands cause panics</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/clap-rs/clap/issues/3263">#3263</a>
        opened by <a href="https://github.com/epage">@epage</a>
        on 2022-01-05 19:59
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/epage">@epage</a></div>
            <div class="timeline-body">Please complete the following tasks
<ul>
<li>[X] I have searched the <a href="https://github.com/clap-rs/clap/discussions">discussions</a></li>
<li>[X] I have searched the existing issues</li>
</ul>
Rust Version
<p>rustc 1.57.0 (f1edd0429 2021-11-29)</p>
Clap Version
<p>master</p>
Minimal reproducible code
<pre><code>use clap::{app_from_crate, arg, App, AppSettings};

fn main() {
    let matches = app_from_crate!()
        .global_setting(AppSettings::PropagateVersion)
        .global_setting(AppSettings::UseLongFormatForHelpSubcommand)
        .setting(AppSettings::SubcommandRequiredElseHelp)
        .setting(AppSettings::AllowExternalSubcommands)
        .subcommand(
            App::new(&quot;add&quot;)
                .about(&quot;Adds files to myapp&quot;)
                .arg(arg!([NAME])),
        )
        .get_matches();

    match matches.subcommand() {
        Some((&quot;add&quot;, sub_matches)) =&gt; println!(
            &quot;&#x27;myapp add&#x27; was used, name is: {:?}&quot;,
            sub_matches.value_of(&quot;NAME&quot;)
        ),
        _ =&gt; unreachable!(),
    }
}

</code></pre>
Steps to reproduce the bug with the above code
<p>See below</p>
Actual Behaviour
<pre><code>$ cargo run -- add name
   Compiling test-clap v0.1.0 (/home/epage/src/personal/test-clap)
    Finished dev [unoptimized + debuginfo] target(s) in 0.80s
     Running `target/debug/test-clap add name`
&#x27;myapp add&#x27; was used, name is: Some(&quot;name&quot;)

$ cargo run -- -- add name
    Finished dev [unoptimized + debuginfo] target(s) in 0.01s
     Running `target/debug/test-clap -- add name`
thread &#x27;main&#x27; panicked at &#x27;`NAME` is not a name of an argument or a group.
Make sure you&#x27;re using the name of the argument itself and not the name of short or long flags.&#x27;, /home/epage/src/personal/clap/src/parse/matches/arg_matches.rs:119:24
note: run with `RUST_BACKTRACE=1` environment variable to display a backtrace
</code></pre>
<p>This happens because <code>--</code> is escaping the command so it becomes an external subcommand that aliases the built-in.  A simple <code>match</code> does not catch this and we then try to access <code>&quot;NAME&quot;</code> in an <code>ArgMatches</code> meant for external subcommands (only <code>&quot;&quot;</code> exists)</p>
Expected Behaviour
<p>Its a bit unclear.  <code>cargo</code> just passes the <code>ArgMatches</code> along, warning about the contents, like:</p>
<pre><code>$ cargo run -- -- check --invalid_argument -some-other-argument
    Finished dev [unoptimized + debuginfo] target(s) in 0.05s
     Running `target/debug/cargo -- check --invalid_argument -some-other-argument`
warning: trailing arguments after built-in command `check` are ignored: `--invalid_argument -some-other-argument`
    Checking cargo v0.60.0 (/home/epage/src/personal/cargo)
^C  Building [=======================&gt; ] 169/171: cargo                                                           
</code></pre>
<p>So with the above problem, that&#x27;d look like:</p>
<pre><code>$ cargo run -- add name
   Compiling test-clap v0.1.0 (/home/epage/src/personal/test-clap)
    Finished dev [unoptimized + debuginfo] target(s) in 0.80s
     Running `target/debug/test-clap add name`
&#x27;myapp add&#x27; was used, name is: Some(&quot;name&quot;)

$ cargo run -- -- add name
    Finished dev [unoptimized + debuginfo] target(s) in 0.01s
     Running `target/debug/test-clap -- add name`
&#x27;myapp add&#x27; was used, name is: None
</code></pre>
Additional Context
<p>Ran into this when porting cargo to clap3 with a test failure from <code>cargo_alias_config::weird_check</code>.  <code>cargo</code> takes the approach of running the escaped command but ignoring the arguments.  This means we pass an external subcommand&#x27;s <code>ArgMatches</code> into a function assuming its getting <code>check</code>s <code>ArgMatches</code> and panics when it accesses an &quot;undefined&quot; field.</p>
<p>Builder users can detect that its an external subcommand by checking for <code>values_of(&quot;&quot;)</code> but derive users can&#x27;t do that.</p>
<p>You have to even know to do that.</p>
<p>Once you do that, the question is what is next.  Pass it through? Error?  Fallback to the built-in like cargo?  Seems like this should be the users choice.  The challenge is with the fallback.  They now need an <code>ArgMatches</code> that has the same shape (ie won&#x27;t panic) when passing to that part of their program.</p>
Debug Output
<p><em>No response</em></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">C-bug</span> added by <a href="https://github.com/epage">@epage</a> on 2022-01-05 19:59</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone &quot;3.x&quot; by <a href="https://github.com/epage">@epage</a> on 2022-01-05 20:00</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2022-01-05 20:02</div>
            <div class="timeline-body"><p>So my thoughts</p>
<ul>
<li>Call this out in in the <code>AllowExternalSubcommands</code> documentation</li>
<li>Add an extra check to the derive to ensure we actually populate external subcommands.</li>
</ul>
<p>Unsure what I&#x27;ll do for cargo to maintain behavior.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a>rust-lang/cargo#10253</a> on 2022-01-05 20:12</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2022-01-05 21:02</div>
            <div class="timeline-body"><p>A big problem with detecting this is the fact that we only populate <code>&quot;&quot;</code> in <code>ArgMatches</code> if there are arguments for the external subcommand.  The mere presence of <code>&quot;&quot;</code> causes <code>cargo</code> to issue a warning so others, in theory, could be relying on that and it&#x27;d be breaking to start populating it.</p>
<p>Without a way to detect this until 4.0:</p>
<ul>
<li>We can&#x27;t fix the derive until then</li>
<li>We are limited in what we can say in the docs.</li>
</ul>
<p>So the choice is go straight for 4.0 already or apply a surgical hack to unblock cargo until 4.0.</p>
<p>I&#x27;m leaning towards the surgical hack.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">A-derive</span> added by <a href="https://github.com/epage">@epage</a> on 2022-01-05 21:02</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">A-docs</span> added by <a href="https://github.com/epage">@epage</a> on 2022-01-05 21:02</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">A-parsing</span> added by <a href="https://github.com/epage">@epage</a> on 2022-01-05 21:02</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">E-medium</span> added by <a href="https://github.com/epage">@epage</a> on 2022-01-05 21:02</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">M-breaking-change</span> added by <a href="https://github.com/epage">@epage</a> on 2022-01-05 21:02</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Removed from milestone &quot;3.x&quot; by <a href="https://github.com/epage">@epage</a> on 2022-01-05 21:02</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone &quot;4.0&quot; by <a href="https://github.com/epage">@epage</a> on 2022-01-05 21:02</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a>clap-rs/clap#3264</a> on 2022-01-05 21:56</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a>rust-lang/cargo#10265</a> on 2022-01-06 15:33</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a>clap-rs/clap#3703</a> on 2022-05-06 20:53</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/epage">@epage</a> on 2022-05-06 21:18</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:58:42 UTC
    </footer>
</body>
</html>
