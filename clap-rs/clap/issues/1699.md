```yaml
number: 1699
title: Our benchmarks seem to be useless 
type: issue
state: closed
author: CreepySkeleton
labels: []
assignees: []
created_at: 2020-02-17T19:29:48Z
updated_at: 2020-03-02T07:07:49Z
url: https://github.com/clap-rs/clap/issues/1699
synced_at: 2026-01-10T01:57:43Z
```

# Our benchmarks seem to be useless 

---

_Issue opened by @CreepySkeleton on 2020-02-17 19:29_

<!--
Please use the following template to assist with creating an issue and to ensure a speedy resolution. If an area is not applicable, feel free to delete the area or mark with `N/A`
-->

### Rust Version

`rustc 1.43.0-nightly (5e7af4669 2020-02-16)`

### Affected Version of `clap*`

`master`

### Additional context

The benches we have in `benches/*` have very high variance on my machine. Here are some results:

```shell
# the benches were executed on bbb14f8bd47ef201b315d367922343577ee60718
$ cargo +nightly bench > first
# this run was made right after the first one
$ cargo +nightly bench > second
```

```shell
$ cargo benchcmp first second --variance
 name                                 first ns/iter           second ns/iter          diff ns/iter   diff %  speedup
 add_flag                             1,307 (+/- 67)          1,294 (+/- 62)                   -13   -0.99%   x 1.01
 add_flag_ref                         1,498 (+/- 401)         1,468 (+/- 77)                   -30   -2.00%   x 1.02
 add_opt                              1,592 (+/- 41)          1,583 (+/- 345)                   -9   -0.57%   x 1.01
 add_opt_ref                          2,004 (+/- 668)         1,982 (+/- 135)                  -22   -1.10%   x 1.01
 add_pos                              980 (+/- 144)           990 (+/- 40)                      10    1.02%   x 0.99
 add_pos_ref                          1,265 (+/- 26)          1,286 (+/- 508)                   21    1.66%   x 0.98
 build_app                            405 (+/- 50)            414 (+/- 341)                      9    2.22%   x 0.98
 build_app                            4,269 (+/- 258)         4,267 (+/- 324)                   -2   -0.05%   x 1.00
 build_app                            88,996 (+/- 9666)       90,604 (+/- 16990)             1,608    1.81%   x 0.98
 build_app_long                       79,712 (+/- 5233)       79,501 (+/- 6875)               -211   -0.26%   x 1.00
 build_app_short                      79,858 (+/- 6200)       78,592 (+/- 3058)             -1,266   -1.59%   x 1.02
 build_help_long                      944,130 (+/- 141827)    957,430 (+/- 197130)          13,300    1.41%   x 0.99
 build_help_short                     549,125 (+/- 116692)    549,975 (+/- 224372)             850    0.15%   x 1.00
 create_app_builder                   14,597 (+/- 870)        14,718 (+/- 562)                 121    0.83%   x 0.99
 create_app_from_usage                29,241 (+/- 2401)       29,269 (+/- 1726)                 28    0.10%   x 1.00
 create_app_macros                    15,487 (+/- 774)        15,455 (+/- 3048)                -32   -0.21%   x 1.00
 example1                             147,325 (+/- 17399)     143,311 (+/- 12303)           -4,014   -2.72%   x 1.03
 example10                            739,433 (+/- 265150)    757,083 (+/- 253344)          17,650    2.39%   x 0.98
 example2                             756,970 (+/- 273591)    633,967 (+/- 217335)        -123,003  -16.25%   x 1.19
 example3                             151,568 (+/- 26869)     149,051 (+/- 34332)           -2,517   -1.66%   x 1.02
 example4                             110,219 (+/- 21906)     109,568 (+/- 12062)             -651   -0.59%   x 1.01
 example4_template                    102,569 (+/- 32353)     100,698 (+/- 9406)            -1,871   -1.82%   x 1.02
 example5                             828,108 (+/- 304115)    843,943 (+/- 325922)          15,835    1.91%   x 0.98
 example6                             96,979 (+/- 7597)       96,767 (+/- 22036)              -212   -0.22%   x 1.00
 example7                             117,435 (+/- 35798)     116,560 (+/- 21418)             -875   -0.75%   x 1.01
 example8                             116,666 (+/- 21774)     117,232 (+/- 25033)              566    0.49%   x 1.00
 parse_clean                          10,878 (+/- 4563)       10,889 (+/- 810)                  11    0.10%   x 1.00
 parse_clean                          26,587 (+/- 2355)       26,341 (+/- 4566)               -246   -0.93%   x 1.01
 parse_clean                          104,580 (+/- 9778)      49,006 (+/- 6181)            -55,574  -53.14%   x 2.13
 parse_clean                          151,186 (+/- 29439)     152,107 (+/- 22410)              921    0.61%   x 0.99
 parse_clean                          114,083 (+/- 18347)     116,902 (+/- 22756)            2,819    2.47%   x 0.98
 parse_complex                        54,535 (+/- 9188)       55,696 (+/- 5289)              1,161    2.13%   x 0.98
 parse_complex                        198,458 (+/- 47214)     196,613 (+/- 18124)           -1,845   -0.93%   x 1.01
 parse_complex1                       162,703 (+/- 16937)     99,532 (+/- 9264)            -63,171  -38.83%   x 1.63
 parse_complex2                       174,246 (+/- 16822)     105,731 (+/- 6838)           -68,515  -39.32%   x 1.65
 parse_complex2_with_args_negate_scs  171,067 (+/- 12010)     104,995 (+/- 22075)          -66,072  -38.62%   x 1.63
 parse_flag                           37,061 (+/- 2927)       37,610 (+/- 8846)                549    1.48%   x 0.99
 parse_flag                           81,323 (+/- 17512)      58,640 (+/- 2605)            -22,683  -27.89%   x 1.39
 parse_lots                           4,184,975 (+/- 409036)  4,038,630 (+/- 339288)      -146,345   -3.50%   x 1.04
 parse_option                         33,248 (+/- 4137)       33,070 (+/- 3280)               -178   -0.54%   x 1.01
 parse_option                         66,665 (+/- 1554)       59,603 (+/- 3951)             -7,062  -10.59%   x 1.12
 parse_positional                     42,295 (+/- 4197)       41,552 (+/- 1350)               -743   -1.76%   x 1.02
 parse_positional                     80,555 (+/- 7287)       58,376 (+/- 6422)            -22,179  -27.53%   x 1.38
 parse_sc_clean                       98,795 (+/- 22008)      68,236 (+/- 9565)            -30,559  -30.93%   x 1.45
 parse_sc_complex                     122,980 (+/- 8171)      85,848 (+/- 14153)           -37,132  -30.19%   x 1.43
 parse_sc_flag                        85,566 (+/- 20564)      77,000 (+/- 5742)             -8,566  -10.01%   x 1.11
 parse_sc_option                      114,395 (+/- 2514)      77,012 (+/- 17307)           -37,383  -32.68%   x 1.49
 parse_sc_positional                  82,638 (+/- 9540)       74,239 (+/- 5346)             -8,399  -10.16%   x 1.11
 parse_subcommands                    115,679 (+/- 17007)     117,044 (+/- 4337)             1,365    1.18%   x 0.99
```

```shell
$ cargo benchcmp first second --variance --threshold 3
 name                                 first ns/iter           second ns/iter          diff ns/iter   diff %  speedup
 example2                             756,970 (+/- 273591)    633,967 (+/- 217335)        -123,003  -16.25%   x 1.19
 parse_clean                          104,580 (+/- 9778)      49,006 (+/- 6181)            -55,574  -53.14%   x 2.13
 parse_complex1                       162,703 (+/- 16937)     99,532 (+/- 9264)            -63,171  -38.83%   x 1.63
 parse_complex2                       174,246 (+/- 16822)     105,731 (+/- 6838)           -68,515  -39.32%   x 1.65
 parse_complex2_with_args_negate_scs  171,067 (+/- 12010)     104,995 (+/- 22075)          -66,072  -38.62%   x 1.63
 parse_flag                           81,323 (+/- 17512)      58,640 (+/- 2605)            -22,683  -27.89%   x 1.39
 parse_lots                           4,184,975 (+/- 409036)  4,038,630 (+/- 339288)      -146,345   -3.50%   x 1.04
 parse_option                         66,665 (+/- 1554)       59,603 (+/- 3951)             -7,062  -10.59%   x 1.12
 parse_positional                     80,555 (+/- 7287)       58,376 (+/- 6422)            -22,179  -27.53%   x 1.38
 parse_sc_clean                       98,795 (+/- 22008)      68,236 (+/- 9565)            -30,559  -30.93%   x 1.45
 parse_sc_complex                     122,980 (+/- 8171)      85,848 (+/- 14153)           -37,132  -30.19%   x 1.43
 parse_sc_flag                        85,566 (+/- 20564)      77,000 (+/- 5742)             -8,566  -10.01%   x 1.11
 parse_sc_option                      114,395 (+/- 2514)      77,012 (+/- 17307)           -37,383  -32.68%   x 1.49
 parse_sc_positional                  82,638 (+/- 9540)       74,239 (+/- 5346)             -8,399  -10.16%   x 1.11
```

What's more, this results are largely inconsistent, I've been observing them vary +-60%. The only useful test is `parse_lots` which keeps giving consistent runtime.

@pksunkara Could you please check on your machine? I think we need to rethink what we really want to benchmark.

---

_Comment by @BurntSushi on 2020-02-17 19:57_

A few ideas:

* Make sure the machine you're running them on is otherwise reasonable quiet.
* If you're on a laptop, it might have CPU frequency scaling set to `powersave`. Setting it to `performance` might help reduce variance.
* Switch to Criterion, which "does stats" to determine whether the variance is statistically significant or not.

---

_Comment by @pksunkara on 2020-02-17 20:14_

The variance is very low for me. (I had chrome in the background though)

```
$ cargo benchcmp first second --variance --threshold 3
 name               first ns/iter         second ns/iter        diff ns/iter   diff %  speedup 
 add_pos            233 (+/- 14)          247 (+/- 24)                    14    6.01%   x 0.94 
 build_app_short    12,279 (+/- 559)      14,710 (+/- 1694)            2,431   19.80%   x 0.83 
 example10          340,100 (+/- 220547)  295,395 (+/- 187392)       -44,705  -13.14%   x 1.15 
 example2           131,500 (+/- 125706)  167,914 (+/- 157811)        36,414   27.69%   x 0.78 
 example3           22,879 (+/- 755)      22,005 (+/- 1030)             -874   -3.82%   x 1.04 
 example4           16,391 (+/- 1672)     15,774 (+/- 933)              -617   -3.76%   x 1.04 
 example4_template  14,433 (+/- 1028)     13,927 (+/- 707)              -506   -3.51%   x 1.04 
 example5           418,119 (+/- 260180)  339,603 (+/- 268060)       -78,516  -18.78%   x 1.23 
 example6           13,623 (+/- 486)      13,156 (+/- 484)              -467   -3.43%   x 1.04 
 example8           16,793 (+/- 718)      16,222 (+/- 1211)             -571   -3.40%   x 1.04 
 parse_clean        3,597 (+/- 184)       3,725 (+/- 245)                128    3.56%   x 0.97 
 parse_clean        32,844 (+/- 1881)     35,512 (+/- 2745)            2,668    8.12%   x 0.92 
 parse_complex      46,120 (+/- 3851)     48,994 (+/- 2179)            2,874    6.23%   x 0.94 
 parse_complex1     22,828 (+/- 8652)     22,045 (+/- 1169)             -783   -3.43%   x 1.04 
```

---

_Comment by @pksunkara on 2020-02-17 20:20_

And I agree with @BurntSushi, we should move to Criterion. It looks good.

---

_Closed by @pksunkara on 2020-02-17 20:20_

---

_Reopened by @pksunkara on 2020-02-17 20:20_

---

_Referenced in [clap-rs/clap#1714](../../clap-rs/clap/pulls/1714.md) on 2020-03-01 22:41_

---

_Closed by @bors[bot] on 2020-03-02 07:07_

---
