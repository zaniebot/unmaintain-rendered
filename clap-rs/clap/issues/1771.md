```yaml
number: 1771
title: impl Send for App
type: issue
state: closed
author: amesgen
labels:
  - C-enhancement
  - M-breaking-change
assignees: []
created_at: 2020-03-31T00:52:40Z
updated_at: 2020-08-12T14:58:05Z
url: https://github.com/clap-rs/clap/issues/1771
synced_at: 2026-01-10T01:57:43Z
```

# impl Send for App

---

_Issue opened by @amesgen on 2020-03-31 00:52_

### Use case

Sometimes, it is useful to run clap in "daemon-mode", e.g. for a chat bot. If concurrency comes in, having `App: Send` would be useful, e.g. as it enables cloning the `App` for concurrent tasks or having `Mutex<App>: Send + Sync`.

### Potential solutions

 1. Use `Arc` instead of `Rc` [here](https://github.com/clap-rs/clap/blob/37889c661134e8286102f7d2ab3267965d010403/src/build/arg/mod.rs#L28-L29), and require `Send + Sync` for `F` in `Arg::validator{_os}`.
   - Performance: might be impacted (awaiting benchmark set up)
   - Breaking: Yes, `F` now requires`Send + Sync`.
   - No new feature is introduced.
 2. Put 1. behind a feature flag (`app-send`).
   - Performance: only impacted if necessary
   - Breaking: No
   - Feature is additive: No, if one crate without `app-send` uses a non-`Send + Sync` `validator{_os}` and another crate enables `app-send`.
 3. As 2., but also change the bounds for `F` when `app-send` is *not* enabled.
   - Performance: only impacted if necessary
   - Breaking: Yes, `F` now requires`Send + Sync`.
   - Feature is additive: Yes (unless someone depends on `App` *not being `Send` (very contrived))

 4. Something different, maybe even enabling `App: Sync`.

### Implementation

I implemented 2. [here](https://github.com/amesgen/clap/commit/2e8ce0d70f21fbe725fe97669a6014b24c0a2c98) (documentation not yet updated).


---

_Label `T: new feature` added by @amesgen on 2020-03-31 00:52_

---

_Label `C: other` added by @CreepySkeleton on 2020-03-31 10:19_

---

_Label `E: breaking change` added by @CreepySkeleton on 2020-03-31 10:19_

---

_Label `T: enhancement` added by @CreepySkeleton on 2020-03-31 10:19_

---

_Label `W: 3.x` added by @CreepySkeleton on 2020-03-31 10:19_

---

_Added to milestone `3.0` by @CreepySkeleton on 2020-03-31 10:20_

---

_Label `P2: need to have` added by @pksunkara on 2020-04-01 14:51_

---

_Comment by @pksunkara on 2020-04-01 14:51_

@amesgen Would love to see a PR. We very much do want this.

---

_Comment by @CreepySkeleton on 2020-04-01 15:33_

@pksunkara We want this, indeed, but please consider that it would penalize the common cases in favor of uncommon ones since atomics aren't exactly free. I would like to wait until after we have the benchmarking set up. Also, features are supposed to be purely additive, and this change alters our API (`Send + Sync` part); so I would like to **not** introduce a feature. 

---

_Comment by @amesgen on 2020-04-01 16:25_

I updated the descriptions of the potential solutions above (from [Gitter](https://gitter.im/kbknapp/clap-rs?at=5e8333418058e148e938d43a)).

---

_Comment by @pksunkara on 2020-04-01 16:54_

Yeah, definitely wait for benchmarking to finish. But I am pretty sure we can make this feature additive.

---

_Comment by @TeXitoi on 2020-04-01 17:37_

I've lightly looked at the usage of Rc, and that's just to have Clone for Arg with the validator functions. Thus I don't think there will really be any performance implication ti switching to Arc.

But it will change the interface a bit: with Arc, the function provided by the user must be Send+Sync. Not really a big deal IMHO, as most validator should just be plain functions 99.9% of the time (they already need 'static).

---

_Comment by @Dylan-DPC-zz on 2020-04-01 17:39_

We can definitely expose a feature that allows you to add some concurrency bits to it, but this won't happen for the 3.0 release. It will happen later. Thanks for the request. 

---

_Comment by @TeXitoi on 2020-04-01 17:42_

It can't be implemented by a feature, as activating the 'send-sync' feature will break code with validators not Send+Sync, so that's 3.0 or 4.0.

The only solution would be to force the Validators to be Send+Sync for 3.0, even if we still use Rc and Arg is not Send+Sync

---

_Comment by @CreepySkeleton on 2020-04-01 18:26_

> We can definitely expose a feature that allows you to add some concurrency bits to it

Honestly, I don't see need for a feature for such a small deal, we've got plenty of them already.

> but this won't happen for the 3.0 release. It will happen later. T

Why not?

___

If it's only about cloning `Arg`, I think we can proceed even without benches.

---

_Comment by @CreepySkeleton on 2020-04-18 18:12_

Yay! Benches are set up!

Btw, maybe just require the validators (and possibly other user-facing hooks as we introduce them) to be `Send + Sync + Clone`? I *guess* most of those functions are clonable and sendable.

---

_Assigned to @CreepySkeleton by @CreepySkeleton on 2020-06-30 10:07_

---

_Referenced in [clap-rs/clap#1998](../../clap-rs/clap/pulls/1998.md) on 2020-07-02 03:35_

---

_Closed by @bors[bot] on 2020-08-12 14:58_

---

_Referenced in [clap-rs/clap#2305](../../clap-rs/clap/issues/2305.md) on 2021-01-22 10:39_

---
