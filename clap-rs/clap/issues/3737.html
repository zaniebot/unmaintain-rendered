<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Although `version` derive is not set, the `--version` logic is exist - clap-rs/clap #3737</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Although `version` derive is not set, the `--version` logic is exist</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/clap-rs/clap/issues/3737">#3737</a>
        opened by <a href="https://github.com/greenhat616">@greenhat616</a>
        on 2022-05-19 11:15
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/greenhat616">@greenhat616</a> on 2022-05-19 11:15</div>
            <div class="timeline-body"><h3>Please complete the following tasks</h3>
<ul>
<li>[X] I have searched the <a href="https://github.com/clap-rs/clap/discussions">discussions</a></li>
<li>[X] I have searched the <a href="https://github.com/clap-rs/clap/issues">open</a> and <a href="https://github.com/clap-rs/clap/issues?q=is%3Aissue+label%3AS-wont-fix+is%3Aclosed">rejected</a> issues</li>
</ul>
<h3>Rust Version</h3>
<p>rustc 1.63.0-nightly (cd282d7f7 2022-05-18)</p>
<h3>Clap Version</h3>
<p>3.1.18</p>
<h3>Minimal reproducible code</h3>
<pre><code class="language-rust">use clap::Parser;
use std::error::Error;
use colored::Colorize;

#[derive(Parser, Debug)]
#[clap(about, long_about = None)]
pub struct Args {
    #[clap(short = 'D', long, help = &quot;Run in development mode&quot;)]
    pub dev: bool, // development mode
    #[clap(short, long, help = &quot;Specify config file path&quot;)]
    pub config_path: Option&lt;String&gt;, // manual set config path
    #[clap(short, long, help = &quot;Print version information&quot;)]
    pub version: bool, // show version info
}

pub enum Command {
    Test,
}

fn print_version() -&gt; () {
    println!(&quot;{} v{}&quot;, env!(&quot;CARGO_PKG_NAME&quot;).bright_black(), env!(&quot;CARGO_PKG_VERSION&quot;).red());
}

pub fn handle_args() -&gt; Result&lt;Args, Box&lt;dyn Error&gt;&gt; {
    let args = Args::parse(); // this line will block the `--version` process and exit program with 0
    if args.version { // this line will not run
        print_version();
        std::process::exit(0);
    }
    Ok(args)
}
</code></pre>
<h3>Steps to reproduce the bug with the above code</h3>
<p><code>cargo run -- --version</code></p>
<h3>Actual Behaviour</h3>
<p>While run <code>cargo run -- --version</code> the command get processed by clap lib itself. It will ruturn <code>PKG_NAME </code> with no version specified and exit.</p>
<p>LIKE :</p>
<pre><code>hitokoto_reviewer 
</code></pre>
<h3>Expected Behaviour</h3>
<p>It should works like:
<img src="https://user-images.githubusercontent.com/41122242/169280521-812cccc3-66bc-43c9-bafa-ef9d98a2d5c4.png" alt="image" /></p>
<h3>Additional Context</h3>
<p>Because <code>derive mode</code> is not support dynamic string/function, we should to use a custom <code>version</code> flag to run custom code.</p>
<h3>Debug Output</h3>
<pre><code>warning: `hitokoto_reviewer` (bin &quot;hitokoto_reviewer&quot;) generated 3 warnings
    Finished dev [unoptimized + debuginfo] target(s) in 0.64s
     Running `target\debug\hitokoto_reviewer.exe --version`
[        clap::build::command]  Command::_do_parse
[        clap::build::command]  Command::_build: name=&quot;hitokoto_reviewer&quot;
[        clap::build::command]  Command::_propagate:hitokoto_reviewer
[        clap::build::command]  Command::_check_help_and_version: hitokoto_reviewer
[        clap::build::command]  Command::_check_help_and_version: Removing generated version
[        clap::build::command]  Command::_propagate_global_args:hitokoto_reviewer
[        clap::build::command]  Command::_derive_display_order:hitokoto_reviewer
[  clap::build::debug_asserts]  Command::_debug_asserts
[  clap::build::debug_asserts]  Arg::_debug_asserts:help
[  clap::build::debug_asserts]  Arg::_debug_asserts:dev
[  clap::build::debug_asserts]  Arg::_debug_asserts:config-path
[  clap::build::debug_asserts]  Arg::_debug_asserts:version
[  clap::build::debug_asserts]  Command::_verify_positionals
[         clap::parse::parser]  Parser::get_matches_with
[         clap::parse::parser]  Parser::get_matches_with: Begin parsing 'RawOsStr(&quot;--version&quot;)' ([45, 45, 118, 101, 114, 115, 105, 111, 110])
[         clap::parse::parser]  Parser::get_matches_with: Positional counter...1
[         clap::parse::parser]  Parser::get_matches_with: Low index multiples...false
[         clap::parse::parser]  Parser::possible_subcommand: arg=Ok(&quot;--version&quot;)
[         clap::parse::parser]  Parser::get_matches_with: sc=None
[         clap::parse::parser]  Parser::parse_long_arg
[         clap::parse::parser]  Parser::parse_long_arg: cur_idx:=1
[         clap::parse::parser]  Parser::parse_long_arg: Does it contain '='...
[         clap::parse::parser]  Parser::parse_long_arg: Found valid opt or flag '--version'
[         clap::parse::parser]  Parser::check_for_help_and_version_str
[         clap::parse::parser]  Parser::check_for_help_and_version_str: Checking if --RawOsStr(&quot;version&quot;) is help or version...
[         clap::parse::parser]  Version
[         clap::parse::parser]  Parser::get_matches_with: After parse_long_arg VersionFlag
[         clap::parse::parser]  Parser::version_err
[        clap::build::command]  Command::_render_version
[        clap::build::command]  Command::color: Color setting...
[        clap::build::command]  Auto
[        clap::build::command]  Command::color: Color setting...
[        clap::build::command]  Auto
hitokoto_reviewer
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">C-bug</span> added by @greenhat616 on 2022-05-19 11:15</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "While `version` derive is not set, the `--version` logic is exist yet" to "Although `version` derive is not set, the `--version` logic is exist" by @greenhat616 on 2022-05-19 11:16</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2022-05-19 12:33</div>
            <div class="timeline-body"><blockquote>
<p>While run cargo run -- --version the command get processed by clap lib itself. It will ruturn PKG_NAME with no version specified and exit.</p>
<p>LIKE :</p>
<p><code>hitokoto_reviewer</code></p>
</blockquote>
<p>I can see in <code>clap v4</code> to drop the <code>--version</code> flag if no version is specified.</p>
<blockquote>
<p>It should works like:
<code>hitokoto_reviewer  v0.1.0</code></p>
</blockquote>
<p>When transitioning from structopt, we intentionally stopped implicitly reading the manifest's version and adding it, instead requiring users to specify <code>version</code> (no parameter) to opt-in to reading the manifest.  In structopt, reading it implicitly led to having to need an opt-out via <code>no_version</code> and we'd rather not have that.</p>
<blockquote>
<p>Because derive mode is not support dynamic string/function,</p>
</blockquote>
<p>If it doesn't support a function call, then that is a bug that should be reported</p>
<p>As for runtime strings, we plan to fix that with https://github.com/clap-rs/clap/issues/2150.  A short-term workaround is to leak the memory to give it a <code>'static</code> lifetime (<code>clap_derive</code> actually does this under the hood in a couple of places)</p>
<blockquote>
<p>we should to use a custom version flag to run custom code.</p>
</blockquote>
<p>We have <a href="https://docs.rs/clap/latest/clap/enum.AppSettings.html#variant.NoAutoVersion">NoAutoVersion</a> for disabling the built-in semantics when a version flag is specified by the user so you can provide your own.  I can't remember if it will still auto-add a version flag or not.  With https://github.com/clap-rs/clap/issues/3405, we plan to add <code>Action</code>s to define the behavior of a flag.  At some point, we expect to support custom actions where the user can do what they want, including whatever clap does natively.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/greenhat616">@greenhat616</a> on 2022-05-19 13:51</div>
            <div class="timeline-body"><blockquote>
</blockquote>
<p>Thanks for your patient reply.
I have tried the measures you referred. <strong>They are all work!</strong> How kind you are. Sincerely thank you for your help.</p>
<blockquote>
<p>We have <a href="https://docs.rs/clap/latest/clap/enum.AppSettings.html#variant.NoAutoVersion">NoAutoVersion</a> for disabling the built-in semantics when a version flag is specified by the user so you can provide your own. I can't remember if it will still auto-add a version flag or not. With https://github.com/clap-rs/clap/issues/3405, we plan to add Actions to define the behavior of a flag. At some point, we expect to support custom actions where the user can do what they want, including whatever clap does natively.</p>
</blockquote>
<p>With <code>global_setting(AppSettings::NoAutoVersion)</code> is set, we can process the logic by myself. It will not auto add a version flag #:smiley:</p>
<blockquote>
<p>If it doesn't support a function call, then that is a bug that should be reported</p>
<p>As for runtime strings, we plan to fix that with https://github.com/clap-rs/clap/issues/2150. A short-term workaround is to leak the memory to give it a 'static lifetime (clap_derive actually does this under the hood in a couple of places)</p>
</blockquote>
<p>It's my fault. The custom function is work. What make me wrong is that the custom function should return <code>&amp;'static str</code>. I think it  would be <code>&amp;str</code>, like <code>serde</code>. So I described it as not support.</p>
<pre><code class="language-rust">#[derive(Parser, Debug)]
#[clap(author, version = print_version(), about, long_about = None)]
pub struct Args {}

fn print_version() -&gt; &amp;'static str {
    Box::leak(format!(&quot;{} v{}&quot;, env!(&quot;CARGO_PKG_NAME&quot;).bright_black(), env!(&quot;CARGO_PKG_VERSION&quot;).red()).into())
}
</code></pre>
<p>I will close the issue. Thank you again.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @greenhat616 on 2022-05-19 13:51</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2022-05-19 19:26</div>
            <div class="timeline-body"><blockquote>
<p>I can see in clap v4 to drop the --version flag if no version is specified.</p>
</blockquote>
<p>We already do this</p>
<pre><code class="language-rust">        // Determine if we should remove the generated --version flag
        //
        // Note that if only mut_arg() was used, the first expression will evaluate to `true`
        // however inside the condition block, we only check for Generated args, not
        // GeneratedMutated args, so the `mut_arg(&quot;version&quot;, ..) will be skipped and fall through
        // to the following condition below (Adding the short `-V`)
        if self.settings.is_set(AppSettings::DisableVersionFlag)
            || (self.version.is_none() &amp;&amp; self.long_version.is_none())
</code></pre>
<p>What I had missed is the reproduction case had</p>
<pre><code class="language-rust">    #[clap(short, long, help = &quot;Print version information&quot;)]
    pub version: bool, // show version info
</code></pre>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 01:35:00 UTC
    </footer>
</body>
</html>
