<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>new `arg!` macro throws a lot of clippy nursery debug_assert_with_mut_call lints - clap-rs/clap #3254</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>new `arg!` macro throws a lot of clippy nursery debug_assert_with_mut_call lints</h1>

    <div class="meta">
        <span class="state state-closed">Closed</span>
        <a href="https://github.com/clap-rs/clap/issues/3254">#3254</a>
        opened by <a href="https://github.com/TDHolmes">@TDHolmes</a>
        on 2022-01-04 18:17
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/TDHolmes">@TDHolmes</a> on 2022-01-04 18:17</div>
            <div class="timeline-body"><h3>Please complete the following tasks</h3>
<ul>
<li>[X] I have searched the <a href="https://github.com/clap-rs/clap/discussions">discussions</a></li>
<li>[X] I have searched the existing issues</li>
</ul>
<h3>Rust Version</h3>
<p>rustc 1.57.0 (f1edd0429 2021-11-29)</p>
<h3>Clap Version</h3>
<p>3.0.1</p>
<h3>Minimal reproducible code</h3>
<p>Using the <code>cargo</code> example:</p>
<pre><code class="language-rust">fn main() {
    let app = clap::App::new(&quot;cargo&quot;)
        .bin_name(&quot;cargo&quot;)
        .setting(clap::AppSettings::SubcommandRequired)
        .subcommand(
            clap::app_from_crate!().name(&quot;example&quot;).arg(
                clap::arg!(--&quot;manifest-path&quot; &lt;PATH&gt;)
                    .required(false)
                    .allow_invalid_utf8(true),
            ),
        );
    let matches = app.get_matches();
    let matches = match matches.subcommand() {
        Some((&quot;example&quot;, matches)) =&gt; matches,
        _ =&gt; unreachable!(&quot;clap should ensure we don't get here&quot;),
    };
    let manifest_path = matches
        .value_of_os(&quot;manifest-path&quot;)
        .map(std::path::PathBuf::from);
    println!(&quot;{:?}&quot;, manifest_path);
}
</code></pre>
<h3>Steps to reproduce the bug with the above code</h3>
<p>run <code>cargo clippy -- -W clippy::nursery</code> or <code>cargo clippy -- -W clippy::debug-assert-with-mut-call</code></p>
<pre><code>$ clap-repro git:(main) âœ— cargo clippy -- -W clippy::nursery
    Checking clap-repro v0.1.0 (/Users/tdh/projects/tmp/clap-repro)

warning: do not call a function with mutable arguments inside of `debug_assert!`
 --&gt; src/main.rs:7:17
  |
7 |                 clap::arg!(--&quot;manifest-path&quot; &lt;PATH&gt;)
  |                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  |
  = note: `-W clippy::debug-assert-with-mut-call` implied by `-W clippy::nursery`
  = help: for further information visit https://rust-lang.github.io/rust-clippy/master/index.html#debug_assert_with_mut_call
  = note: this warning originates in the macro `$crate::arg_impl` (in Nightly builds, run with -Z macro-backtrace for more info)
</code></pre>
<p>Adding macro backtrace we get:</p>
<pre><code>warning: do not call a function with mutable arguments inside of `debug_assert!`
   --&gt; /Users/tdh/.cargo/registry/src/github.com-1ecc6299db9ec823/clap-3.0.3/src/macros.rs:401:14
    |
338 |  / macro_rules! arg_impl {
339 |  |     ( @string $val:ident ) =&gt; {
340 |  |         stringify!($val)
341 |  |     };
...    |
401 |  |             ({
    |  |______________^
402 | ||                 debug_assert_eq!($arg.get_value_names(), None, &quot;Flags should precede values&quot;);
403 | ||                 debug_assert!(!$arg.is_set($crate::ArgSettings::MultipleOccurrences), &quot;Flags should precede `...`&quot;);
404 | ||
...   ||
410 | ||                 arg.long(long)
411 | ||             })
    | ||_____________^
...    |
533 |  |     };
534 |  | }
    |  |_- in this expansion of `$crate::arg_impl!` (#2)
...
615 | /  macro_rules! arg {
616 | |      ( $name:ident: $($tail:tt)+ ) =&gt; {
617 | |          $crate::arg_impl! {
618 | |              @arg ($crate::Arg::new($crate::arg_impl! { @string $name })) $($tail)+
...   |
622 |            let arg = $crate::arg_impl! {
    |  ____________________-
623 |                @arg ($crate::Arg::default()) $($tail)+
624 | |          };
    | |__________- in this macro invocation (#2)
...
627 | |      }};
628 | |  }
    | |__- in this expansion of `clap::arg!` (#1)
    |
   ::: src/main.rs:7:17
    |
7   |                    clap::arg!(--&quot;manifest-path&quot; &lt;PATH&gt;)
    |                    ------------------------------------ in this macro invocation (#1)
    |
    = note: `-W clippy::debug-assert-with-mut-call` implied by `-W clippy::nursery`
    = help: for further information visit https://rust-lang.github.io/rust-clippy/master/index.html#debug_assert_with_mut_call
</code></pre>
<h3>Actual Behaviour</h3>
<p>I get a clippy warning for each instance of <code>arg!</code> in my repo.</p>
<h3>Expected Behaviour</h3>
<p>No (or as few as possible) clippy lints trigger.</p>
<h3>Additional Context</h3>
<p>I couldn't find which function takes a mutable argument... not sure why this lint is triggering.</p>
<h3>Debug Output</h3>
<p>N/A - clippy issue</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">C-bug</span> added by @TDHolmes on 2022-01-04 18:17</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/TDHolmes">@TDHolmes</a> on 2022-01-04 18:19</div>
            <div class="timeline-body"><p><a href="https://rust-lang.github.io/rust-clippy/master/index.html#debug_assert_with_mut_call">clippy link for this lint</a></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/TDHolmes">@TDHolmes</a> on 2022-01-04 18:21</div>
            <div class="timeline-body"><p>ah.. sounds like there are <a href="https://github.com/rust-lang/rust-clippy/issues/5112">known cases of false positives</a>. Perhaps this is another instance of a false positive?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2022-01-04 18:25</div>
            <div class="timeline-body"><p>If that backtrace is accurate, I think so</p>
<p>The two calls in the span do not take <code>&amp;mut</code></p>
<ul>
<li>https://docs.rs/clap/latest/clap/struct.Arg.html#method.get_value_names</li>
<li>https://docs.rs/clap/latest/clap/struct.Arg.html#method.is_set</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">A-builder</span> added by @epage on 2022-01-11 17:10</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">S-triage</span> added by @epage on 2022-01-11 17:10</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2022-01-11 17:10</div>
            <div class="timeline-body"><p>Assuming this is a false positive and closing this out.  If there is new information otherwise, let us know and we can re-open!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @epage on 2022-01-11 17:10</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:35:08 UTC
    </footer>
</body>
</html>
