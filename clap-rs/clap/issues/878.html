<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Suggestions of a subcommand shadowing valid input - clap-rs/clap #878</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Suggestions of a subcommand shadowing valid input</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/clap-rs/clap/issues/878">#878</a>
        opened by <a href="https://github.com/fredszaq">@fredszaq</a>
        on 2017-02-27 16:53
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/fredszaq">@fredszaq</a> on 2017-02-27 16:53</div>
            <div class="timeline-body"><p>Hello,</p>
<p>I have a problem with sub-commands when the app also expects a parameter</p>
<h3>Rust Version</h3>
<p><code>rustc 1.15.0 (10893a9a3 2017-01-19)</code></p>
<h3>Affected Version of clap</h3>
<p><code>clap 2.20.5 </code></p>
<h3>Bug Summary</h3>
<p>In some cases, the suggestion feature will kick in and make the arguments parsing fail on an error even if the provided input is valid</p>
<h3>Steps to Reproduce the issue</h3>
<p>Here is a small app demonstrating the issue (basically a stripped down version of the example in the doc, the problem also happens with it)</p>
<pre><code class="language-rust">#[macro_use]
extern crate clap;

fn main() {
    let matches = clap_app!(myapp =&gt;
        (about: &quot;Does awesome things&quot;)
        (@arg TEXT: +required &quot;The text to be processed&quot;)
        (@subcommand test =&gt;
            (about: &quot;Run some tests&quot;)
        )
    ).get_matches();

    println!(&quot;text = {:?}, subcommand = {:?}&quot;, matches.value_of(&quot;TEXT&quot;), matches.subcommand_name());
}
</code></pre>
<p>if we run this with these arguments</p>
<pre><code>$ target/debug/clap-test foobar test
</code></pre>
<p>we get the expected output</p>
<pre><code>text = Some(&quot;foobar&quot;), subcommand = Some(&quot;test&quot;)
</code></pre>
<p>Now the problem arises when instead of <code>foobar</code> we pass <code>hello</code></p>
<pre><code>$ target/debug/clap-test hello test
</code></pre>
<p><code>hello</code> is to close to the generated subcommand <code>help</code></p>
<pre><code>error: The subcommand 'hello' wasn't recognized
	Did you mean 'help'?

If you believe you received this message in error, try re-running with 'clap-test -- hello'

USAGE:
    clap-test &lt;TEXT&gt; [SUBCOMMAND]

For more information try --help
</code></pre>
<p>The problem disappears when deactivating the <code>suggestion</code> feature</p>
<h3>Debug output</h3>
<pre><code>$ target/debug/clap-test hello test 
DEBUG:clap:Parser::add_subcommand: term_w=None, name=test
DEBUG:clap:Parser::propogate_settings: self=myapp, g_settings=AppFlags(
    NEEDS_LONG_HELP | NEEDS_LONG_VERSION | NEEDS_SC_HELP | UTF8_NONE | COLOR_AUTO
)
DEBUG:clap:Parser::propogate_settings: sc=test, settings=AppFlags(
    NEEDS_LONG_HELP | NEEDS_LONG_VERSION | NEEDS_SC_HELP | UTF8_NONE | COLOR_AUTO
), g_settings=AppFlags(
    NEEDS_LONG_HELP | NEEDS_LONG_VERSION | NEEDS_SC_HELP | UTF8_NONE | COLOR_AUTO
)
DEBUG:clap:Parser::propogate_settings: self=test, g_settings=AppFlags(
    NEEDS_LONG_HELP | NEEDS_LONG_VERSION | NEEDS_SC_HELP | UTF8_NONE | COLOR_AUTO
)
DEBUG:clap:Parser::get_matches_with;
DEBUG:clap:Parser::create_help_and_version;
DEBUG:clap:Parser::create_help_and_version: Building --help
DEBUG:clap:Parser::create_help_and_version: Building --version
DEBUG:clap:Parser::create_help_and_version: Building help
DEBUG:clap:Parser::get_matches_with: Begin parsing '&quot;hello&quot;' ([104, 101, 108, 108, 111])
DEBUG:clap:Parser::is_new_arg: arg=&quot;hello&quot;, Needs Val of=None
DEBUG:clap:Parser::is_new_arg: Does arg allow leading hyphen...false
DEBUG:clap:Parser::is_new_arg: Starts new arg...Probable value
DEBUG:clap:Parser::is_new_arg: Starts new arg...false
DEBUG:clap:Parser::possible_subcommand: arg=&quot;hello&quot;
DEBUG:clap:Parser::create_usage;
DEBUG:clap:Parser::create_usage_no_title;
DEBUG:clap:Parser::get_required_from: reqs=[&quot;TEXT&quot;], extra=None
DEBUG:clap:Parser::get_required_from: args_in_groups=[]
DEBUG:clap:Parser::needs_flags_tag;
DEBUG:clap:Parser::needs_flags_tag:iter: f=hclap_help;
DEBUG:clap:Parser::needs_flags_tag:iter: f=vclap_version;
DEBUG:clap:Parser::needs_flags_tag: [FLAGS] not required
DEBUG:clap:Parser::color;
DEBUG:clap:Parser::color: Color setting...Auto
DEBUG:clap:Colorizer::error;
DEBUG:clap:is_a_tty: stderr=true
DEBUG:clap:Colorizer::warning;
DEBUG:clap:is_a_tty: stderr=true
DEBUG:clap:Colorizer::good;
DEBUG:clap:is_a_tty: stderr=true
DEBUG:clap:Colorizer::good;
DEBUG:clap:is_a_tty: stderr=true
DEBUG:clap:Colorizer::good;
DEBUG:clap:is_a_tty: stderr=true
error: The subcommand 'hello' wasn't recognized
	Did you mean 'help'?

If you believe you received this message in error, try re-running with 'clap-test -- hello'

USAGE:
    clap-test &lt;TEXT&gt; [SUBCOMMAND]

For more information try --help
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/kbknapp">@kbknapp</a> on 2017-02-28 05:01</div>
            <div class="timeline-body"><p>Thanks for the details and taking the time to file this!</p>
<p>Depending on the design of the CLI you may be able to use <a href="https://docs.rs/clap/2.20.5/clap/enum.AppSettings.html#variant.ArgsNegateSubcommands"><code>AppSettings::ArgsNegateSubcommands</code></a> which basically says, 'If you find a valid arg, no subcommand is possible so don't try to make suggestions.&quot;</p>
<p>Of course, this means an arg (not potentially matching a subcommand) must be used, which may not be possible depending on the design.</p>
<p>If by coincidence the problem only occurs with the <code>help</code> subcommand, you can disable it with <a href="https://docs.rs/clap/2.20.5/clap/enum.AppSettings.html#variant.DisableHelpSubcommand"><code>AppSettings::DisableHelpSubcommand</code></a> which still leaves <code>--help</code> and <code>-h</code>.</p>
<p>Unfortunately, there isn't much more that can be done, short of:</p>
<ul>
<li>Disabling the <code>suggestions</code> feature as you found</li>
<li>Picking subcommand names that won't be similar to possible argument values</li>
</ul>
<p>If you'd like to, I can take a look at your CLI as a whole and give a more specific suggestion, or perhaps find a valid workaround.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">T: RFC / question</span> added by @kbknapp on 2017-02-28 05:01</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/fredszaq">@fredszaq</a> on 2017-02-28 12:52</div>
            <div class="timeline-body"><p>I our case, we ended up using a <code>--text</code> to pass the argument and remove any ambiguity, as the value of this argument is a free text for the user, so we cannot take chances an user would want to pass a value similar to one of our sub-commands. I mainly wrote the bug repport because that's a behaviour that exists in the doc example, and maybe it could be a good idea to modify it so that it doesn't have this problem (maybe by moving the <code>INPUT</code> arg to the subcommand )</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/kbknapp">@kbknapp</a> on 2017-02-28 13:48</div>
            <div class="timeline-body"><p>I agree, I'll mark this as a doc issue! Thanks again for taking the time to file this!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">C: docs</span> added by @kbknapp on 2017-02-28 13:48</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">D: easy</span> added by @kbknapp on 2017-02-28 13:48</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">P3: want to have</span> added by @kbknapp on 2017-02-28 13:48</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">T: enhancement</span> added by @kbknapp on 2017-02-28 13:48</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">W: 2.x</span> added by @kbknapp on 2017-02-28 13:48</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">T: RFC / question</span> removed by @kbknapp on 2017-02-28 13:48</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Freyskeyd">@Freyskeyd</a> on 2017-11-29 20:48</div>
            <div class="timeline-body"><p>I'm facing the same problem and none of the solution worked :/</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/kbknapp">@kbknapp</a> on 2017-11-29 21:27</div>
            <div class="timeline-body"><p>@Freyskeyd can you give me more details. Each CLI is unique with different constraints and solutions.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Freyskeyd">@Freyskeyd</a> on 2017-11-29 22:03</div>
            <div class="timeline-body"><p>@kbknapp
here's the cli.yml:</p>
<pre><code class="language-yaml">name: cli
version: &quot;0.1&quot;

settings:
  - ArgRequiredElseHelp
  - DisableHelpSubcommand
  - ArgsNegateSubcommands

args:
  - track:
      help: environment + track
      required: true

subcommands:
  - deploy:
      about: Deploy command
</code></pre>
<p>If I use: <code>cli depl.main deploy</code> it suggest deploy command.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone "v3.0" by @kbknapp on 2018-07-22 01:28</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/1389.html">clap-rs/clap#1389</a> on 2018-12-13 16:54</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/aurelien-naldi">@aurelien-naldi</a> on 2019-01-18 14:19</div>
            <div class="timeline-body"><p>I am running into a similar problem. Disabling suggestions helps, but not fully: if the value of a required argument (which MUST thus be given before a subcommand) matches a subcommand, clap will select the subcommand and then complain that the required argument is missing or that it does not recognise the actual subcommand name.</p>
<p>To give some context, my CLI aims to load a datastructure from an input file, optionally apply one or several transformations and then run a subcommand on the result. A call would look like this:</p>
<p><code>prog input_file -m modifier subcommand -f --option=value</code></p>
<p>Here the input file is a required argument, while the modifiers are optional. The order of arguments, flags and subcommands is meant to describe the execution in a logical way.</p>
<p>I guess I could duplicate the &quot;load and modify&quot; part in all subcommands, but</p>
<ul>
<li>It would duplicate the information in the help and parser, for no good reason</li>
<li>I would like to be able to reuse the same short flags in both parts (I have several modifiers and subcommands)</li>
<li>It would break the logical meaning of the command: I want to see the input file <em>before</em> the actions performed on it</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">Z: good first issue</span> added by @pksunkara on 2020-04-10 13:58</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/1750.html">clap-rs/clap#1750</a> on 2020-04-11 10:17</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">W: 2.x</span> removed by @pksunkara on 2020-04-11 10:18</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">Z: good first issue</span> removed by @pksunkara on 2020-04-11 10:18</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">C: positional args</span> added by @pksunkara on 2020-04-11 10:18</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">C: subcommands</span> added by @pksunkara on 2020-04-11 10:18</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/kamilogorek">@kamilogorek</a> on 2020-04-14 12:08</div>
            <div class="timeline-body"><p>Answering question from https://github.com/clap-rs/clap/issues/1750</p>
<blockquote>
<p>@kamilogorek Could you check that issue and try the options that are mentioned there?</p>
</blockquote>
<p>As mentioned in the original issue, when <code>InferSubcommands</code> or <code>AllowExternalSubcommands</code> is used it works just fine. However, we cannot use them, as our CLI requires multiple subcommands, as well as arguments and it's too easy to miss incorrect input.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">P3: want to have</span> removed by @pksunkara on 2020-04-14 12:37</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">P1: urgent</span> added by @pksunkara on 2020-04-14 12:37</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/1825.html">clap-rs/clap#1825</a> on 2020-04-15 06:17</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/CreepySkeleton">@CreepySkeleton</a> on 2020-04-15 22:28</div>
            <div class="timeline-body"><p>Hm ,weird name. I doubt it's easy since it's a bug in parsing algorithm.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../wfxr/code-minimap/issues/6.html">wfxr/code-minimap#6</a> on 2020-10-16 02:38</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/wfxr">@wfxr</a> on 2020-10-16 03:06</div>
            <div class="timeline-body"><p>I also encountered the same problem. As reported in https://github.com/wfxr/code-minimap/issues/6:</p>
<pre><code class="language-bash">$ touch compiler.rs
$ code-minimap compiler.rs
error: The subcommand 'compiler.rs' wasn't recognized
        Did you mean 'completion'?

If you believe you received this message in error, try re-running with 'code-minimap -- compiler.rs'

USAGE:
    code-minimap [OPTIONS] [FILE] [SUBCOMMAND]

For more information try --help
</code></pre>
<p>Add <code>--</code> not works:</p>
<pre><code class="language-bash">$ code-minimap -- compiler.rs
error: The subcommand 'compiler.rs' wasn't recognized
        Did you mean 'completion'?

If you believe you received this message in error, try re-running with 'code-minimap -- compiler.rs'

USAGE:
    code-minimap [OPTIONS] [FILE] [SUBCOMMAND]

For more information try --help
</code></pre>
<p>I tried to build app with <code>AppSettings::ArgsNegateSubcommands</code> but it still doesn't seem to work.</p>
<p>Is there any way to solve the problem without disable <code>suggestion</code> feature for now? Or this will be fixed in the future?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/pksunkara">@pksunkara</a> on 2020-11-07 07:41</div>
            <div class="timeline-body"><p>@ldm0 Would you like to take this one next?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ldm0">@ldm0</a> on 2020-11-07 08:38</div>
            <div class="timeline-body"><p>Yep.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/2203.html">clap-rs/clap#2203</a> on 2020-11-07 12:38</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @bors[bot] on 2020-11-07 13:23</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 01:33:28 UTC
    </footer>
</body>
</html>
