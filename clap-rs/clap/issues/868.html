<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Questions about zsh completion generated for ripgrep - clap-rs/clap #868</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Questions about zsh completion generated for ripgrep</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/clap-rs/clap/issues/868">#868</a>
        opened by <a href="https://github.com/kastiglione">@kastiglione</a>
        on 2017-02-21 23:38
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/kastiglione">@kastiglione</a></div>
            <div class="timeline-body">Rust Version
<p>N/A</p>
Affected Version of clap
<p>2.20.5</p>
Expected Behavior Summary
<p>Case 1:</p>
<p><code>rg &lt;TAB&gt;</code></p>
<p>will either complete flags, or complete nothing (because completing a search pattern isn&#x27;t feasible)</p>
<p>Case 2:</p>
<p><code>rg somepattern &lt;TAB&gt;</code></p>
<p>will complete a path</p>
Actual Behavior Summary
<p>Case 1:</p>
<p><code>rg &lt;TAB&gt;</code></p>
<p>will produce two incorrect completions: <code>PATTERN</code>, <code>PATH</code>.</p>
<p>Case 2:</p>
<p><code>rg somepattern &lt;TAB&gt;</code></p>
<p>will produce flag/option completions (completion path is expected)</p>
Steps to Reproduce the issue
<p>Use ripgrep&#x27;s build to generate the zsh completion script.</p>
<p>See: https://github.com/BurntSushi/ripgrep/blob/3f515afbb4cb3d22520729453bea5af050c0eb00/build.rs</p>
Sample Code or Link to Sample Code
<p>Here is the generated zsh completion for <code>_rg</code>:</p>
<p>https://gist.github.com/kastiglione/c9e09a89ca547d1f2288a62af7a8f439</p>
Debug output
<p>N/A</p>
Reference
<p>https://github.com/BurntSushi/ripgrep/issues/375</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/kbknapp">@kbknapp</a> on 2017-02-22 03:41</div>
            <div class="timeline-body"><p>I think this has to do with ZSH completion scripts in general and not specifically how clap is generating them. Of course, if I&#x27;m wrong I&#x27;m more than happy to fix or be told where the actual error lies.</p>
<p>What I observe (appears correct to me):</p>
<pre><code>$ rg &lt;tab&gt;
PAT

$ rg -&lt;tab&gt;
[.. list of flags/options]

$ rg --&lt;tab&gt;
[ .. list of flags/options that start with --]
</code></pre>
<p>Of course, completing paths is perhaps possible, but not everyone is accepting a path as an argument. Bash <em>does</em> however fallback to path completion when nothing else fits (I&#x27;m unsure of how to do this in Zsh though).</p>
<p>The final bit is I&#x27;m working on allowing arbitrary Rust code to run during a completion (Issue #568) but it hasn&#x27;t been implemented yet. I&#x27;m also not sure which shells will allow this and which ones won&#x27;t.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">T: RFC / question</span> added by <a href="https://github.com/kbknapp">@kbknapp</a> on 2017-02-22 03:41</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/kbknapp">@kbknapp</a> on 2017-02-22 04:03</div>
            <div class="timeline-body"><p>As for completing <code>$ rg somepattern &lt;tab&gt;</code>, yes, this should be either the literal <code>PATH</code> (see comments above) or list options/flags if no other positional/free args exist. However, unlike in Bash I&#x27;m not aware of a way to say, &quot;This arg comes first, this one second, etc.&quot; in Zsh. If someone knows a way, I&#x27;d love to hear it! (Seriously. I&#x27;m not being facetious)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/kbknapp">@kbknapp</a> on 2017-02-22 04:23</div>
            <div class="timeline-body"><p>I forgot to say it above, but</p>
<blockquote>
<p>Case 1:
<code>rg &lt;TAB&gt;</code>
will produce two incorrect completions: <code>PATTERN</code>, <code>PATH</code>.
[ ... ] It should produce either options/flags or nothing (because completing a pattern isn&#x27;t feasible)</p>
</blockquote>
<p>I think comleting nothing is highly subjective, as some would then assume completion scripts are totally broken at that point. As for completing flags/options, I believe ZSH requires a leading <code>-</code> to complete flags/options (unless no positiona/free args exist, or all have been used). This isn&#x27;t something clap is choosing.</p>
<p>The same can be seen if you try:</p>
<pre><code>$ cp &lt;tab&gt;
[ .. files ]

$ cp -&lt;tab&gt;
[.. options/flags]
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2017-02-22 12:06</div>
            <div class="timeline-body"><blockquote>
<p>As for completing $ rg somepattern , yes, this should be either the literal PATH (see comments above) or list options/flags if no other positional/free args exist.</p>
</blockquote>
<p>I think I&#x27;m with you on everything except for this. It seems like the <em>expected</em> behavior from a user&#x27;s perspective in this case would be to complete file paths instead? Or will it start completing file paths if you type <code>$ rg somepattern ./&lt;tab&gt;</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/kbknapp">@kbknapp</a> on 2017-02-22 13:55</div>
            <div class="timeline-body"><p>I totally agree, but there&#x27;s not a way for clap to know, &quot;this positional arg accepts file paths&quot; and to therefore tell ZSH such. Right now clap is dumb and just tells ZSH to complete the arg name since it can&#x27;t know what that arg actually represents. #568 would remedy that.</p>
<p>There&#x27;s also the possibility of adding either a special case to clap to use file path completion based on arg names or to have a standard set of completion possibilities in lieu of #568 such as <code>Completion::RelativeFilePath</code> where a particular she&#x27;ll may or may not support such (in which case the shell would just ignore it).</p>
<p>I&#x27;m less inclined to support special casing based on arg names, but adding a specific setting that tells clap what to generate may be doable.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/kbknapp">@kbknapp</a> on 2017-02-22 13:59</div>
            <div class="timeline-body"><p>I should also say the positional arg index issue listed above (telling ZSH which args are which indexes) would also need to be fixed...And the ZSH completion documentation is...&quot;Interesting&quot; to say the least.</p>
<p>Finally, if there&#x27;s a similar method to bash of which I&#x27;m currently unaware that says to fallback file path completion, that would work as well.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/kastiglione">@kastiglione</a> on 2017-02-23 23:16</div>
            <div class="timeline-body"><p>I&#x27;m rather unfamiliar with the context of clap, and the context of bash. But a positive I can bring to the discussion is how other similar completions behave.</p>
<p>The completion for <code>grep</code> does the following:</p>
<pre><code>$ grep &lt;tab&gt;
[ no output / bell ]

$ grep somepattern &lt;tab&gt;
[ .. files ]
</code></pre>
<p>The <code>_rg</code> completion provided by <a href="https://github.com/zsh-users/zsh-completions">zsh-completions</a>, also follows this behavior of no completion for the pattern (first positional argument), completing files after (second positional argument).</p>
<p>I love that this functionality exists. Since we&#x27;re looking at behavior, I&#x27;d love it if clap could do one thing that the other <a href="https://github.com/zsh-users/zsh-completions/blob/72af5d08f1c07507d74103af039e98a2791fccb5/src/_rg">rg completion</a> does: complete file types for the <code>-t</code> option.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from &quot;Zsh completion generated for ripgrep is not usable&quot; to &quot;Questions about zsh completion generated for ripgrep&quot; by <a href="https://github.com/kastiglione">@kastiglione</a> on 2017-02-24 06:05</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/kastiglione">@kastiglione</a> on 2017-02-24 06:07</div>
            <div class="timeline-body"><p>In hindsight the original title I used was a bit pompous, so I&#x27;ve tried to make it a little better. Sorry about that, I thought the behavior was unexpected. It&#x27;s mainly the lack of file completion that led me to say it&#x27;s not usable, since I had come to expect that functionality from the zsh-completions implementation.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/kbknapp">@kbknapp</a> on 2017-02-24 14:56</div>
            <div class="timeline-body"><p>A custom made completion script will nearly always be better than a purely generic auto-generated one. There are pros and cons to both approaches. A custom script must ALWAYS be kept up to date with changes to the base program, whereas an auto-generated one doesn&#x27;t have that issue at the expense of being slightly more generic.</p>
<p>I do think there is some things we can do to make our ZSH completions better, such as specifying <em>what</em> needs to be completed. I&#x27;m also going to start looking back into the index issue. So I&#x27;ll mark this is a improvement issue and post back here with whatever I find :wink:</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/kbknapp">@kbknapp</a> on 2017-02-24 14:58</div>
            <div class="timeline-body"><p>In fact, when I originally started implementing the auto-generation scripts I intended them to be used as a base script that could then be customized a little. I.e. just get the boiler plate out of the way and I&#x27;ll add the last 5% polish. But it turned out they worked good enough (minus this issue you&#x27;ve encountered) that adding that extra 5% polish wasn&#x27;t really worth it given the drawbacks of having to stay in sync again, over what you actually gain.</p>
<p>I think in this case in particular we can close that gap a few more percent!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">C: completion gen</span> added by <a href="https://github.com/kbknapp">@kbknapp</a> on 2017-02-24 14:59</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">C: positional args</span> added by <a href="https://github.com/kbknapp">@kbknapp</a> on 2017-02-24 14:59</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">D: intermediate</span> added by <a href="https://github.com/kbknapp">@kbknapp</a> on 2017-02-24 14:59</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">P3: want to have</span> added by <a href="https://github.com/kbknapp">@kbknapp</a> on 2017-02-24 14:59</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">T: enhancement</span> added by <a href="https://github.com/kbknapp">@kbknapp</a> on 2017-02-24 14:59</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">W: 2.x</span> added by <a href="https://github.com/kbknapp">@kbknapp</a> on 2017-02-24 14:59</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">T: RFC / question</span> removed by <a href="https://github.com/kbknapp">@kbknapp</a> on 2017-02-24 14:59</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/kbknapp">@kbknapp</a> on 2017-02-24 15:00</div>
            <div class="timeline-body"><blockquote>
<p>I love that this functionality exists. Since we&#x27;re looking at behavior, I&#x27;d love it if clap could do one thing that the other rg completion does: complete file types for the -t option.</p>
</blockquote>
<p>This should be totally possible if I add that <code>CompleterValue</code> type enum. Stay tuned to see how this goes!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">C: positional args</span> removed by <a href="https://github.com/kbknapp">@kbknapp</a> on 2017-02-24 15:04</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/kbknapp">@kbknapp</a> on 2017-02-24 18:46</div>
            <div class="timeline-body"><p>@kastiglione I hadn&#x27;t seen the <code>zsh-completions</code> page before and they actually have some great tips for how I could improve the generated ZSH script. So thanks for that link!</p>
<p>Here&#x27;s my thoughts on what I could realistically provide over the next few days (and longer):</p>
<ul>
<li>[ ] Improve the positional/free argument indexes (I&#x27;d actually go so far as to say this would be a bug-fix)</li>
<li>[ ] Add some sort of <code>CompletionValue</code> enum with some generic options and be passed to a <code>Arg::completion_value</code>. Some of these values will be supported by some shells, but not others and that&#x27;s OK.</li>
<li>[ ] Longer term (my time will be the limiting factor here) add #568 implemented via passing a function/closure to <code>Arg::complete_with</code> which has a different signature such as <code>|clap::Shell, &amp;ArgMatches, &amp;str| -&gt; String</code> i.e. something with more context about what is trying to be completed (think completing different values based off what has already been passed to the command line in previous args)</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">W: 3.x blocker</span> added by <a href="https://github.com/kbknapp">@kbknapp</a> on 2017-05-09 19:00</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">W: 2.x</span> removed by <a href="https://github.com/kbknapp">@kbknapp</a> on 2017-05-09 19:00</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a>BurntSushi/ripgrep#496</a> on 2017-05-29 20:07</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/segevfiner">@segevfiner</a> on 2018-01-06 09:28</div>
            <div class="timeline-body"><p>The way, I think, you are supposed to handle positional arguments that you don&#x27;t know how to complete is to complete nothing  but popup a message, or better yet, default to completing files (Which is what most bash completion scripts do by using <code>-o default</code>). Like this (For <code>_arguments</code>, not <code>_describe</code> that is used now):</p>
<pre><code>:Some message that explain that you need to enter X:()

# or

:Some message that explain that you need to enter X:_files
</code></pre>
<p>This is what most completions that I know of do. Completing the metavar/placeholder is sub-optimal it&#x27;s never a valid argument.</p>
<p>For arguments that you do know what the completions are, you should complete that, of course. If you know that an argument doesn&#x27;t take files than completing nothing with a message is better of course. But if you don&#x27;t know, it&#x27;s best to default to completing files since that&#x27;s common and often less aggravating than trying to complete a file and getting nothing.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a>clap-rs/clap#1147</a> on 2018-01-14 05:13</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/kbknapp">@kbknapp</a> on 2018-02-05 16:19</div>
            <div class="timeline-body"><p>This should be closed - the generated zsh script even for ripgrep is working and falls back to file completion as one would expect (this is all thanks to @segevfiner !)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/kbknapp">@kbknapp</a> on 2018-02-05 16:19</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a>BurntSushi/ripgrep#775</a> on 2018-02-05 16:22</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:56:46 UTC
    </footer>
</body>
</html>
