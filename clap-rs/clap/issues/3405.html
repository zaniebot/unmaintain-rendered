<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Confusing how to override `version` or `help`s behavior - clap-rs/clap #3405</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Confusing how to override <code>version</code> or <code>help</code>s behavior</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/clap-rs/clap/issues/3405">#3405</a>
        opened by <a href="https://github.com/bcantrill">@bcantrill</a>
        on 2022-02-05 04:39
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/bcantrill">@bcantrill</a></div>
            <div class="timeline-body"><p>Maintainer&#x27;s notes</p>
<ul>
<li>We&#x27;d remove the pre-generated help / version arguments<ul>
<li>Instead we&#x27;d add a version and help flag if needed.</li>
<li>This makes it so we have one way to customize</li>
</ul>
</li>
<li>We&#x27;d switch to an <code>Action</code> system where you set an arguments action to <code>Action::Set</code>, <code>Action::Extend</code>, <code>Action::SetTrue</code>, <code>Action::Count</code>, etc.  The ones relevant here would be <code>Action::Help</code> and <code>Action::Version</code>.<ul>
<li>We&#x27;d default arguments to <code>Action::Set</code> or <code>Action::SetTrue</code> (depending on other settings) unless they were named <code>version</code> or <code>help</code> for which we&#x27;d default their actions to <code>Action::Help</code> and <code>Action::Version</code></li>
<li>We can leverage Actions for also giving users control over short vs long help</li>
</ul>
</li>
</ul>
<p>Original title: &quot;cannot have an option named &quot;version&quot;&quot;</p>
<ul>
<li>See <code>#[clap(global_setting(AppSettings::NoAutoVersion))]</code> for solving that</li>
</ul>
<hr>
Please complete the following tasks
<ul>
<li>[X] I have searched the <a href="https://github.com/clap-rs/clap/discussions">discussions</a></li>
<li>[X] I have searched the existing issues</li>
</ul>
Rust Version
<p>rustc 1.59.0-nightly (34926f0a1 2021-12-22)</p>
Clap Version
<p>3.0.14</p>
Minimal reproducible code
<pre><code>use clap::Parser;

#[derive(Parser)]                                                                  
#[clap(name = &quot;foobar&quot;)]
pub struct Args {
    /// verbose messages
    #[clap(long, short)]
    pub verbose: bool,

    /// version the thing
    #[clap(long, short = &#x27;x&#x27;)]
    pub version: bool,
}

fn main() {
    let args = Args::parse();
    println!(&quot;verbose is {:?}, version is {:?}&quot;, args.verbose, args.version);
}
</code></pre>
Steps to reproduce the bug with the above code
<p><code>cargo run -- -x</code> or <code>cargo run -- --version</code></p>
Actual Behaviour
<pre><code>foobar
</code></pre>
Expected Behaviour
<pre><code>verbose is false, version is true
</code></pre>
Additional Context
<p>We need to have a <code>--version</code> option that does more than the Clap default.  Currently, Clap special-cases the string <code>version</code>, and seemingly overrides its behavior (changing the option name to anything else results in the expected behavior).  This seems to be a <code>version</code> manifestation of behavior similar to <a href="https://github.com/clap-rs/clap/issues/3403">clap-rs/clap#3403</a>.</p>
Debug Output
<pre><code>[            clap::build::app] 	App::_do_parse
[            clap::build::app] 	App::_build
[            clap::build::app] 	App::_propagate:foobar
[            clap::build::app] 	App::_check_help_and_version
[            clap::build::app] 	App::_check_help_and_version: Removing generated version
[            clap::build::app] 	App::_propagate_global_args:foobar
[            clap::build::app] 	App::_derive_display_order:foobar
[clap::build::app::debug_asserts] 	App::_debug_asserts
[clap::build::arg::debug_asserts] 	Arg::_debug_asserts:help
[clap::build::arg::debug_asserts] 	Arg::_debug_asserts:verbose
[clap::build::arg::debug_asserts] 	Arg::_debug_asserts:version
[clap::build::app::debug_asserts] 	App::_verify_positionals
[         clap::parse::parser] 	Parser::get_matches_with
[         clap::parse::parser] 	Parser::get_matches_with: Begin parsing &#x27;RawOsStr(&quot;--version&quot;)&#x27; ([45, 45, 118, 101, 114, 115, 105, 111, 110])
[         clap::parse::parser] 	Parser::get_matches_with: Positional counter...1
[         clap::parse::parser] 	Parser::get_matches_with: Low index multiples...false
[         clap::parse::parser] 	Parser::possible_subcommand: arg=RawOsStr(&quot;--version&quot;)
[         clap::parse::parser] 	Parser::get_matches_with: sc=None
[         clap::parse::parser] 	Parser::parse_long_arg
[         clap::parse::parser] 	Parser::parse_long_arg: cur_idx:=1
[         clap::parse::parser] 	Parser::parse_long_arg: Does it contain &#x27;=&#x27;...
[         clap::parse::parser] 	No
[         clap::parse::parser] 	Parser::parse_long_arg: Found valid opt or flag &#x27;--version&#x27;
[         clap::parse::parser] 	Parser::check_for_help_and_version_str
[         clap::parse::parser] 	Parser::check_for_help_and_version_str: Checking if --RawOsStr(&quot;version&quot;) is help or version...
[         clap::parse::parser] 	Version
[         clap::parse::parser] 	Parser::get_matches_with: After parse_long_arg VersionFlag
[         clap::parse::parser] 	Parser::version_err
[            clap::build::app] 	App::_render_version
[            clap::build::app] 	App::color: Color setting...
[            clap::build::app] 	Auto
foobar 
</code></pre>
<p>The debug output is very helpful about indicating what it&#x27;s doing, it&#x27;s just that this is behavior that we do not want.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">C-bug</span> added by <a href="https://github.com/bcantrill">@bcantrill</a> on 2022-02-05 04:39</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/bcantrill">@bcantrill</a> on 2022-02-05 05:11</div>
            <div class="timeline-body"><p>For anyone else that runs across this: you can disable this behavior by adding this:</p>
<pre><code>#[clap(global_setting(AppSettings::NoAutoVersion))]
</code></pre>
<p>Even though this behavior can be disabled, I would argue that the existing behavior violates the Principle of Least Surprise -- not least because it exits without providing any real indicator as to why. (I would also note that StructOpt seems to have had <code>no_version</code> that seems to not have made the transition to Clap 3.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2022-02-05 15:26</div>
            <div class="timeline-body"><p>The intent of the current behavior is to allow you to custmize the flag while still getting the same behavior.  We also offer customization by, behind the scenes, pre-creating some flags for you to modify with <code>mut_arg</code>.</p>
<p>That said, this is still not great.</p>
<p>My current thought</p>
<ul>
<li>We&#x27;d remove the pre-generated help / version arguments<ul>
<li>Instead we&#x27;d add a version and help flag if needed.</li>
<li>This makes it so we have one way to customize</li>
</ul>
</li>
<li>We&#x27;d switch to an <code>Action</code> system where you set an arguments action to <code>Action::Set</code>, <code>Action::Extend</code>, <code>Action::SetTrue</code>, <code>Action::Count</code>, etc.  The ones relevant here would be <code>Action::Help</code> and <code>Action::Version</code>.<ul>
<li>We&#x27;d default arguments to <code>Action::Set</code> or <code>Action::SetTrue</code> (depending on other settings) unless they were named <code>version</code> or <code>help</code> for which we&#x27;d default their actions to <code>Action::Help</code> and <code>Action::Version</code></li>
</ul>
</li>
</ul>
<p>The main concern is the discoverability of the defaults but I think this moves us in the right direction.</p>
<p>Going to rename this Issue to reflect the confusion over the existing API.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from &quot;cannot have an option named &quot;version&quot;&quot; to &quot;Confusing how to override `version` or `help`s behavior&quot; by <a href="https://github.com/epage">@epage</a> on 2022-02-05 15:27</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">C-bug</span> removed by <a href="https://github.com/epage">@epage</a> on 2022-02-05 15:27</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">A-builder</span> added by <a href="https://github.com/epage">@epage</a> on 2022-02-05 15:27</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">C-enhancement</span> added by <a href="https://github.com/epage">@epage</a> on 2022-02-05 15:27</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">E-medium</span> added by <a href="https://github.com/epage">@epage</a> on 2022-02-05 15:27</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">M-breaking-change</span> added by <a href="https://github.com/epage">@epage</a> on 2022-02-05 15:27</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/bcantrill">@bcantrill</a> on 2022-02-06 01:11</div>
            <div class="timeline-body"><p>Totally agreed about the change in issue name (as one might guess, I had not yet discovered <code>NoAutoVersion</code> when I filed it!) and about the course of action.  Thank you -- and thank you for your work on Clap which has been a pleasure to use!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a>clap-rs/clap#3425</a> on 2022-02-09 00:57</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a>clap-rs/clap#2717</a> on 2022-02-10 16:38</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a>clap-rs/clap#3451</a> on 2022-02-11 18:51</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a>clap-rs/clap#1015</a> on 2022-04-18 12:20</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2022-05-09 21:54</div>
            <div class="timeline-body"><p>The change in pre-generated <code>help</code> and <code>version</code> cannot be done until clap 4.  We have the <code>unstable-v4</code> flag but I worry this would be too invasive of a change for that flag.  Might still be worth experimenting with.</p>
<p>I&#x27;d like to get Actions in for clap v3 users, independent of whats going on for clap 4.  In that case, we should probably do it first so we don&#x27;t couple the design to any changes for v4.</p>
<p>Python has</p>
<ul>
<li><code>store</code>: overwrite current entry</li>
<li><code>store_const</code>:  overwrite with a hardcoded value</li>
<li><code>store_true</code>: overwrite with <code>true</code></li>
<li><code>store_false</code>: overwrite with <code>false</code></li>
<li><code>append</code></li>
<li><code>append_const</code></li>
<li><code>count</code>: increment value stored</li>
<li><code>help</code>: display help<ul>
<li>We&#x27;d probably want <code>Action::Help</code>, <code>Action::HelpShort</code>, and <code>Action::HelpLong</code></li>
</ul>
</li>
<li><code>version</code>: display version<ul>
<li>Ditto about short and long</li>
</ul>
</li>
<li><code>extend</code></li>
<li>custom ones by sub-classing<code>Action</code></li>
</ul>
<p>Python also includes a non-native action, <code>BooleanOptionalAction </code> which implicitly creates a <code>--no-</code> variant and stores <code>true</code>/<code>false</code>.</p>
<p>Items like <code>store_true</code> and <code>count</code> can&#x27;t be done until <a href="https://github.com/clap-rs/clap/issues/2683">clap-rs/clap#2683</a>.</p>
<p>https://github.com/clap-rs/clap/issues/815 could be implemented like <code>BooleanOptionalAction</code> using  aliases without having to get into #3146.  We&#x27;d need to pass to the action what flag or arg was used.  This then helps with other cases like <code>Help</code>.</p>
<p>So the question is what can be supported without blocking on #2683 and is it worth going ahead without it?</p>
<p>Without inheritance exposed, removing of pre-generated help, or support for #2683, I&#x27;m thinking there isn&#x27;t a use case that makes this worth it enough.  Going to focus on those other areas first.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone &quot;4.0&quot; by <a href="https://github.com/epage">@epage</a> on 2022-05-09 21:55</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a>clap-rs/clap#3737</a> on 2022-05-19 12:33</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a>clap-rs/clap#3748</a> on 2022-05-25 12:23</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a>clap-rs/clap#2317</a> on 2022-05-25 12:27</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2022-05-26 19:53</div>
            <div class="timeline-body"><p>To implement this sanely, I&#x27;m going to need to do a major parser refactor</p>
<p>Random notes</p>
<ul>
<li>With multiple values<ul>
<li>Attached values (e.g. after <code>=</code>) disallow any further values</li>
<li>A delmited value (e.g. <code>bar,baz</code>) disallows any further values (so <code>foo bar,baz</code> is legal)</li>
</ul>
</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a>clap-rs/clap#3765</a> on 2022-05-27 18:47</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a>clap-rs/clap#3772</a> on 2022-05-31 14:48</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a>clap-rs/clap#3773</a> on 2022-05-31 19:11</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a>clap-rs/clap#3774</a> on 2022-06-01 02:09</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2022-06-01 19:50</div>
            <div class="timeline-body"><p>Working on integrating actions (#3774, #3775, #3777) into the derive API and hitting a hurdle.</p>
<ul>
<li>Users are currently defining whatever type they want for storing occurrences (i8, u32, usize, etc)</li>
<li>We&#x27;ll define the value parser and <code>get_one::&lt;T&gt;</code> based on that type</li>
<li>As-implemented, <code>Count</code> only supports <code>u64</code> for the stored type</li>
<li>We want to support users providing their own value parsers for <code>Count</code> so they can do custom validation (range restrictions)</li>
</ul>
<p>How do we support the user using whatever type they want like they can today?</p>
<p>Ideas</p>
<ul>
<li>~~When no parser is specified, we could ask the action for a parser and then fallback to <code>value_types!</code>.~~<ul>
<li>but we won&#x27;t know what type to use with <code>get_one</code></li>
</ul>
</li>
<li>We bake counting directly into <code>ValueParser</code> so we don&#x27;t have to know about it</li>
<li><code>Count</code> supports multiple storage types, one for each integer type</li>
<li>We key off of the type name to do custom logic for <code>Count</code><ul>
<li>This runs into issues with whether the user typed it in the way we expect (is it fully qualified?)</li>
</ul>
</li>
<li>We make each action a distinct type with <code>Action</code> just being a &quot;box&quot; for them (internally, just an enum).  We use deref specialization on the passed-in type to customize <code>Count</code>s behavior<ul>
<li>If someone uses <code>Action</code> rather than <code>CountAction</code>, then we won&#x27;t be able to help them</li>
<li>Really wish types could have associated types</li>
</ul>
</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a>rust-lang/rustfmt#5395</a> on 2022-06-21 22:23</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a>rust-lang/rustfmt#5396</a> on 2022-06-21 23:04</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a>clap-rs/clap#4056</a> on 2022-08-11 00:51</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/epage">@epage</a> on 2022-08-11 01:46</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a>clap-rs/clap#4687</a> on 2023-01-30 18:15</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/thewh1teagle">@thewh1teagle</a> on 2024-05-06 16:21</div>
            <div class="timeline-body"><p>For anyone who look to override default version:</p>
<pre><code>#[derive(Parser, Debug)]
#[command(author, version, about, long_about = None, disable_version_flag = true)]
struct Args {
  ...
}
</code></pre>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:58:48 UTC
    </footer>
</body>
</html>
