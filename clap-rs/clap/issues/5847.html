<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PowerShell dynamic completion script is not valid PowerShell - clap-rs/clap #5847</title>
    <link rel="stylesheet" href="../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../index.html">Back to index</a>
    </div>

    <h1>PowerShell dynamic completion script is not valid PowerShell</h1>

    <div class="meta">
        <span class="state state-closed">Closed</span>
        <a href="https://github.com/clap-rs/clap/issues/5847">#5847</a>
        opened by <a href="https://github.com/jennings">@jennings</a>
        on 2024-12-17 00:05
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/jennings">@jennings</a> on 2024-12-17 00:05</div>
            <div class="timeline-body"><h3>Please complete the following tasks</h3>
<ul>
<li>[X] I have searched the <a href="https://github.com/clap-rs/clap/discussions">discussions</a></li>
<li>[X] I have searched the <a href="https://github.com/clap-rs/clap/issues">open</a> and <a href="https://github.com/clap-rs/clap/issues?q=is%3Aissue+label%3AS-wont-fix+is%3Aclosed">rejected</a> issues</li>
</ul>
<h3>Rust Version</h3>
<p>rustc 1.83.0 (90b35a623 2024-11-26)</p>
<h3>Clap Version</h3>
<p>master</p>
<h3>Minimal reproducible code</h3>
<pre><code class="language-rust"># Sorry for the lack of example, but I think the issue is clear without this.
</code></pre>
<h3>Steps to reproduce the bug with the above code</h3>
<p>Follow the given instructions to install PowerShell dynamic completion:</p>
<pre><code class="language-powershell">echo &quot;COMPLETE=powershell your_program | Invoke-Expression&quot; &gt;&gt; $PROFILE
</code></pre>
<h3>Actual Behaviour</h3>
<p>Using the PowerShell dynamic completion installation instructions results in the PowerShell error when the profile loads:</p>
<pre><code>COMPLETE=powershell: The term 'COMPLETE=powershell' is not recognized as a name of a cmdlet, function, script file, or executable program.
Check the spelling of the name, or if a path was included, verify that the path is correct and try again.
</code></pre>
<h3>Expected Behaviour</h3>
<p>The argument completer should be added to the PowerShell environment successfully.</p>
<h3>Additional Context</h3>
<p>The <a href="https://github.com/clap-rs/clap/blob/ed2360f9cdf9bb51477ace5cd79ac47794758086/clap_complete/src/env/shells.rs#L283">PowerShell dynamic completion profile script</a> is not valid PowerShell:</p>
<pre><code class="language-powershell">$results = Invoke-Expression &quot;{var}=powershell &amp;{completer} -- $($commandAst.ToString())&quot;;
</code></pre>
<p>These are the main problems:</p>
<ul>
<li><code>COMPLETE=powershell mycommand</code> does not work in PowerShell, there is no way to set environment variables inline like this. Unfortunately, the best solution is probably to assign the env var, run the command, then restore the previous value.</li>
<li><code>&amp;{completer}</code> may have double-quotes from the <code>shlex::try_quote(completer)</code> above, which results in a syntax error like this: <code>Invoke-Expression &quot;COMPLETE=powershell &quot;C:\path\to\binary.exe&quot; -- ...&quot;</code></li>
<li>When a command is quoted, it needs to be prefixed with the call operator <code>&amp;</code>.</li>
<li>The AST may include characters that PowerShell interprets, so we need the stop processing operator <code>--%</code></li>
</ul>
<p>This should instead be written something like this:</p>
<pre><code>    $completer = {completer}
    $prev = $env:{var}
    $results = Invoke-Expression &quot;&amp; $completer -- --% $commandAst&quot;;
    if ($null -eq $prev) {{
        Remove-Item Env:\{var}
    }} else {{
        $env:{var} = $prev
    }}    
</code></pre>
<p>In addition, the instructions to install this in the profile are not correct:</p>
<pre><code class="language-powershell">echo &quot;COMPLETE=powershell your_program | Invoke-Expression&quot; &gt;&gt; $PROFILE
</code></pre>
<p>This has the same inline env var problem, but also PowerShell tries to execute this line by line. It needs to be piped to <code>Out-String</code>:</p>
<pre><code class="language-powershell">//! $env:COMPLETE = &quot;powershell&quot;
//! echo &quot;your_program | Out-String | Invoke-Expression&quot; &gt;&gt; $PROFILE
//! Remove-Item Env:\COMPLETE
</code></pre>
<h3>Debug Output</h3>
<p><em>No response</em></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">C-bug</span> added by @jennings on 2024-12-17 00:05</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">A-completion</span> added by @epage on 2024-12-17 01:49</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">E-medium</span> added by @epage on 2024-12-17 01:49</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">E-help-wanted</span> added by @epage on 2024-12-17 01:49</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2024-12-17 01:50</div>
            <div class="timeline-body"><p>I knew PowerShell support was under-developed when I merged it but I figured it would get overlooked otherwise.  For moving this forward, we need someone with PowerShell experience to finish it up.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/jennings">@jennings</a> on 2024-12-17 02:54</div>
            <div class="timeline-body"><p>I don’t think it’s far off, if I put the corrected script in my profile, dynamic completions in <a href="https://github.com/martinvonz/jj">jj</a> start working.</p>
<p>I started trying to write the patch, but haven’t had time to figure out how to test it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2024-12-17 03:23</div>
            <div class="timeline-body"><p>Let's not hold up working for the sake of testing.  All of our old script generators had no tests anyways.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/5848.html">clap-rs/clap#5848</a> on 2024-12-17 06:43</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @epage on 2024-12-17 18:05</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @epage on 2024-12-17 18:05</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:28:35 UTC
    </footer>
</body>
</html>
