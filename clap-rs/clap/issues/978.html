<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>`ArgMatches::value_of` should include arguments to subcommands - clap-rs/clap #978</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1><code>ArgMatches::value_of</code> should include arguments to subcommands</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/clap-rs/clap/issues/978">#978</a>
        opened by <a href="https://github.com/sgrif">@sgrif</a>
        on 2017-06-03 13:38
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sgrif">@sgrif</a></div>
            <div class="timeline-body"><p>In Diesel CLI we are using a global argument in combination with subcommands. I&#x27;d expect <code>matches.value_of(&quot;ARG&quot;)</code> to return the argument regardless of where it appeared. However, in Diesel CLI (which is using clap 2.24.2), running <code>diesel migration run --database-url something</code> will complain that the argument isn&#x27;t present. Running <code>diesel migration --database-url something run</code> works.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/kbknapp">@kbknapp</a> on 2017-06-16 14:41</div>
            <div class="timeline-body"><p>@sgrif apologies for the late reply, I&#x27;ve been out of town. Looking at the diesel source, this looks like a bug on clap&#x27;s end. It should be a quick fix though. Let me see if I can get it put together today.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">C: args</span> added by <a href="https://github.com/kbknapp">@kbknapp</a> on 2017-06-16 14:41</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">D: easy</span> added by <a href="https://github.com/kbknapp">@kbknapp</a> on 2017-06-16 14:41</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">P2: need to have</span> added by <a href="https://github.com/kbknapp">@kbknapp</a> on 2017-06-16 14:41</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">T: bug</span> added by <a href="https://github.com/kbknapp">@kbknapp</a> on 2017-06-16 14:41</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">W: 2.x</span> added by <a href="https://github.com/kbknapp">@kbknapp</a> on 2017-06-16 14:41</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/kbknapp">@kbknapp</a> on 2017-06-16 15:20</div>
            <div class="timeline-body"><p>@sgrif can you add <a href="https://docs.rs/clap/2.24.2/clap/enum.AppSettings.html#variant.PropagateGlobalValuesDown"><code>AppSettings::PropagateGlobalValuesDown</code></a> and see if it still gives you an error?</p>
<p>Why isn&#x27;t this the default you ask? It wasn&#x27;t possible a long time ago, so it was added after the fact üòú</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sgrif">@sgrif</a> on 2017-06-17 20:32</div>
            <div class="timeline-body"><p>I won&#x27;t get to it for a few days, but yes I will see if that works. :)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a>diesel-rs/diesel#1201</a> on 2017-09-25 18:29</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sgrif">@sgrif</a> on 2017-09-25 21:24</div>
            <div class="timeline-body"><p>It&#x27;s been a lot of days, but I finally got around to trying this. The setting improves things, but still doesn&#x27;t fix the problem.</p>
<p>| Command | <code>diesel --db-url=&quot;&quot; db drop</code> | <code>diesel db --db-url=&quot;&quot; drop</code> | <code>diesel db drop --db-url=&quot;&quot;</code> |
| --- | --- | --- | --- |
| Without Setting | Arg not found | Arg not found | Fine |
| With Setting | Fine | Arg not found | Fine |</p>
<p>| Command | <code>diesel --db-url=&quot;&quot; migration run</code> | <code>diesel migration --db-url=&quot;&quot; run</code> | <code>diesel migration run --db-url=&quot;&quot;</code> |
| --- | --- | --- | --- |
| Without Setting | Arg not found | Fine | Arg not found |
| With Setting | Fine | Fine | Arg not found |</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/kbknapp">@kbknapp</a> on 2017-09-25 22:22</div>
            <div class="timeline-body"><p>No worries, I&#x27;ve been incredibly busy too. Thanks for all the details, once I&#x27;m back at a computer (I&#x27;m on mobile) I should be able to figure this one out quickly</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/willmurphyscode">@willmurphyscode</a> on 2017-09-28 11:34</div>
            <div class="timeline-body"><p>Do you know whether anyone is already working on this? If not, I&#x27;d like to try to fix it over the next few days.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/kbknapp">@kbknapp</a> on 2017-09-28 14:02</div>
            <div class="timeline-body"><p>@willmurphyscode</p>
<p>I get home from my travel tomorrow and was planning on checking it out then, but if you&#x27;d like to take a swing at it I&#x27;d be more than happy to mentor it and assist where needed. :+1:</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/willmurphyscode">@willmurphyscode</a> on 2017-09-29 11:49</div>
            <div class="timeline-body"><p>@kbknapp I&#x27;ll take a swing at it. I confirmed the issue locally with diesel, so I was going to write some failing tests to start with. What&#x27;s the best place to reach out if I need hand or have a question?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a>rust-lang/crates.io#1058</a> on 2017-09-29 22:17</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/willmurphyscode">@willmurphyscode</a> on 2017-10-02 12:12</div>
            <div class="timeline-body"><p>@kbknapp I&#x27;ve written some failing tests that show the issue: https://github.com/willmurphyscode/clap-rs/blob/propagate-values-down/tests/propagate_globals_down.rs#L52 but I&#x27;m a little bit lost trying to figure out exactly what to change needs to be made to make them pass. I&#x27;ve commented the tests in that link. Would you mind providing a little help when you have a chance?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/kbknapp">@kbknapp</a> on 2017-10-04 02:23</div>
            <div class="timeline-body"><p>@willmurphyscode</p>
<blockquote>
<p>first_subcommand_can_access_global_arg_if_global_arg_is_last</p>
</blockquote>
<p><a href="https://github.com/willmurphyscode/clap-rs/blob/9872a82ff9618f45a54907e8961ba29ddd383896/tests/propagate_globals_down.rs#L66">Your hypothesis</a> is correct which was initially by design.</p>
<p>To fix it, you&#x27;ll have to bubble all these values back up just <a href="https://github.com/kbknapp/clap-rs/blob/3224e2e1cd4927935f44081c1ca686d95f267790/src/app/parser.rs#L1074">prior to validation occurring</a>.</p>
<p>Some edge cases to watch out for would be <code>program --global-arg some_value outer --global-arg other_value</code> where multiple values aren&#x27;t true. But this <em>should</em> just work because validation will occur <em>after</em> propagation.</p>
<blockquote>
<p>second_subcommand_can_access_global_arg_if_global_arg_is_in_the_middle</p>
</blockquote>
<p><a href="https://github.com/willmurphyscode/clap-rs/blob/propagate-values-down/tests/propagate_globals_down.rs#L78">You&#x27;re probably right</a> here too.</p>
<p>To solve it, you&#x27;ll probably just need to add some recursive calls to <a href="https://github.com/kbknapp/clap-rs/blob/3224e2e1cd4927935f44081c1ca686d95f267790/src/args/arg_matcher.rs#L23"><code>ArgMatcher::propagate</code></a> down through all subcommands.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/kbknapp">@kbknapp</a> on 2017-10-04 02:24</div>
            <div class="timeline-body"><p>I believe one or both of these cases are actually already fixed in 3.x just due to being a more clean code base...but I&#x27;ll add this to the 3.x issue tracker just in case.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a>clap-rs/clap#1010</a> on 2017-10-04 02:45</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/willmurphyscode">@willmurphyscode</a> on 2017-10-06 21:27</div>
            <div class="timeline-body"><p>@kbknapp You say &quot;one or both of these is fixed in 3.x.&quot; Does that mean that there&#x27;s nothing to do here and people should just wait for 3.x? I&#x27;ve opened a PR with the tests (<a href="https://github.com/kbknapp/clap-rs/pull/1060">kbknapp/clap-rs#1060</a>) in case someone else wants to follow up, but beyond that I&#x27;m probably out of time to work on this issue.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a>clap-rs/clap#1060</a> on 2017-10-06 21:34</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/kbknapp">@kbknapp</a> on 2017-10-07 17:01</div>
            <div class="timeline-body"><blockquote>
<p>You say &quot;one or both of these is fixed in 3.x.&quot; Does that mean that there&#x27;s nothing to do here and people should just wait for 3.x?</p>
</blockquote>
<p>Since I&#x27;m not sure when I&#x27;ll be able to finalize 3.x with my crazy work schedule right now, I&#x27;d rather fix them in 2.x in the mean time. I saw your comment in the PR about lack of time as well, so I can pick up where you left off. Thanks for starting this though üëç</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a>clap-rs/clap#1061</a> on 2017-10-07 17:03</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Freyskeyd">@Freyskeyd</a> on 2017-10-10 17:11</div>
            <div class="timeline-body"><p>@kbknapp I also can contribute to this issue.</p>
<p>I need some input to get started.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/kbknapp">@kbknapp</a> on 2017-10-10 17:42</div>
            <div class="timeline-body"><p>@Freyskeyd thanks! üëç</p>
<p>I would take the failing tests in #1060 and start with <code>second_subcommand_can_access_global_arg_if_global_arg_is_in_the_middle</code> as it will probably be easier to solve. It <em>may</em> be as easy as looping through all <em>matched</em> subcommands and recursively calling <code>propagate</code>.</p>
<p>If you run into any questions, feel free to ping me on Gitter since I&#x27;ll get those notifications on my cell phone as well.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/kbknapp">@kbknapp</a> on 2017-10-10 17:43</div>
            <div class="timeline-body"><p>@willmurphyscode off topic, I saw your name on the upcoming Meetup this week I didn&#x27;t know you were in the area! Looking forward to meeting you guys. üòÑ</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone &quot;2.27.0&quot; by <a href="https://github.com/kbknapp">@kbknapp</a> on 2017-10-12 21:42</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a>clap-rs/clap#1070</a> on 2017-10-18 11:40</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/kbknapp">@kbknapp</a> on 2017-10-18 14:45</div>
            <div class="timeline-body"><p>#1070 fixes this. @sgrif could you test your use case against the current master branch? If it&#x27;s good to go I can put out another version here soon.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sgrif">@sgrif</a> on 2017-10-22 19:05</div>
            <div class="timeline-body"><p>Yes, this resolves my issue</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/sgrif">@sgrif</a> on 2017-10-22 19:05</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sgrif">@sgrif</a> on 2017-10-22 19:05</div>
            <div class="timeline-body"><p>Would love a ping when a new version is released. :)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/kbknapp">@kbknapp</a> on 2017-10-24 01:47</div>
            <div class="timeline-body"><p>@sgrif will do! The goal is to release before I leave for Rust Belt Rust :wink:</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/kbknapp">@kbknapp</a> on 2017-10-25 01:57</div>
            <div class="timeline-body"><p>@sgrif v2.27.0 is out on crates.io and contains these fixes :)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a>clap-rs/clap#1037</a> on 2017-11-12 17:53</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:56:54 UTC
    </footer>
</body>
</html>
