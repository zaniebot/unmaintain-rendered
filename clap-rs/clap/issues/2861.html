<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stabilise `AppSettings::Multicall` Tracking Issue - clap-rs/clap #2861</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Stabilise <code>AppSettings::Multicall</code> Tracking Issue</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/clap-rs/clap/issues/2861">#2861</a>
        opened by <a href="https://github.com/fishface60">@fishface60</a>
        on 2021-10-12 19:51
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/fishface60">@fishface60</a></div>
            <div class="timeline-body"><p>Original request: https://github.com/clap-rs/clap/issues/1120</p>
<p>Original PR: https://github.com/clap-rs/clap/pull/2817</p>
<p>Feature flag: <code>unstable-multicall</code></p>
<p>Known issues:</p>
<ul>
<li>[x] https://github.com/clap-rs/clap/issues/2862</li>
<li>[x] https://github.com/clap-rs/clap/issues/2864</li>
<li>[x] https://github.com/clap-rs/clap/issues/2865</li>
<li>[x] https://github.com/clap-rs/clap/issues/2866</li>
<li>[x] https://github.com/clap-rs/clap/issues/3074</li>
<li>[x] Should we strip all suffixes or just <a href="https://doc.rust-lang.org/std/env/consts/constant.EXE_SUFFIX.html">EXE_SUFFIX</a>?  We should be consistent with #992</li>
<li>[x] Demonstrate we can generate completions</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/pksunkara">@pksunkara</a> on 2021-10-12 19:54</div>
            <div class="timeline-body"><p>Can you please fill up the known issues that are unresolved from the pr?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/fishface60">@fishface60</a> on 2021-10-12 19:56</div>
            <div class="timeline-body"><blockquote>
<p>Can you please fill up the known issues that are unresolved from the pr?</p>
</blockquote>
<p>Working on it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">T: stabilisation</span> added by @pksunkara on 2021-10-12 20:05</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">C: settings</span> added by @pksunkara on 2021-10-12 20:06</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/2817.html">clap-rs/clap#2817</a> on 2021-10-12 21:55</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2021-10-14 12:41</div>
            <div class="timeline-body"><p><em>Note: I had assumed #2817 was merged when preparing to write this.  I've intentionally not posted it on #2817 after finding out because I don't think we should gate resolution of that PR on further design discussions</em></p>
<p>For #2864, #2865, and #2866, I wonder if we should make some simplifying assumptions.  Currently, #2817 bakes in one multi-call policy and these are about the impact of that or for supporting a variety of other multi-call policies.  Instead on taking on the burden to support all multi-call policies, what if we generalize multi-call policy in clap and put the burden on the developer?</p>
<p>Proposal: <code>Multicall</code> unconditionally treat the bin as a subcommand?</p>
<ul>
<li>No subcommand search, resolving #2866</li>
<li>Busybox style multicall would be implemented by duplicating the subcommands between the top-level and a <code>busybox</code> subcommand<ul>
<li>Programs that want prefix stripping would just give the top-level subcommands a prefix</li>
</ul>
</li>
<li>hostname-style multi-call would be implemented as just subcommands, no duplicating needed</li>
</ul>
<p>Benefits</p>
<ul>
<li>This keeps the API smaller, making it easier to discover what features are available in clap for all clap users</li>
<li>It keeps the code smaller, helping keep out bloat from non-multi-call users</li>
</ul>
<p>Downside</p>
<ul>
<li>A little more boilerplate for multi-call users.<ul>
<li>I assume only a little because someone can use functions (builder) or structs (derive) to reuse the subcommands</li>
</ul>
</li>
</ul>
<p>I'm assuming a trade off like this is worth it because the percentage of multicall users is probably fairly low and so the cost of taking on that extra boiler plate is low, in aggregate across users, compared to the cost for everyone else.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2021-10-14 14:03</div>
            <div class="timeline-body"><p>I added a checklist item</p>
<blockquote>
<p>Demonstrate we can generate completions</p>
</blockquote>
<p>I didn't create an issue because I think it might strictly be possible but its going to be non-obvious.  More work might be needed around this.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/fishface60">@fishface60</a> on 2021-10-16 22:08</div>
            <div class="timeline-body"><blockquote>
<p>For #2864, #2865, and #2866, I wonder if we should make some simplifying assumptions. Currently, #2817 bakes in one multi-call policy and these are about the impact of that or for supporting a variety of other multi-call policies. Instead on taking on the burden to support all multi-call policies, what if we generalize multi-call policy in clap and put the burden on the developer?</p>
<p>Proposal: <code>Multicall</code> unconditionally treat the bin as a subcommand?</p>
<ul>
<li>No subcommand search, resolving <a href="https://github.com/clap-rs/clap/issues/2866">Multicall has a performance impact on start-up #2866</a></li>
</ul>
</blockquote>
<p>So… no matching against base program name, no checking whether the applet exists before <code>_do_parse</code>.</p>
<p>I think the way that differs from AppSettings::NoBinaryName is that <code>app.name</code> should be cleared, and preferably help output should describe it as applets rather than subcommands.</p>
<blockquote>
<ul>
<li><p>Busybox style multicall would be implemented by duplicating the subcommands between the top-level and a <code>busybox</code> subcommand</p>
<ul>
<li>Programs that want prefix stripping would just give the top-level subcommands a prefix</li>
</ul>
</li>
</ul>
</blockquote>
<p>So you mean something like this?</p>
<pre><code class="language-rust">#[derive(Parser)]
struct ConnectCommand(SocketAddr);

#[derive(Parser)]
enum DeceaseCommand {
    GenerateKeys,
    Connect(ConnectCommand),
    Handshake,
    Listen,
}

#[derive(Parser)]
enum Applet {
    #[clap(name = concat!(env!(&quot;PROGRAM_PREFIX&quot;), &quot;decease&quot;))]
    Decease(DeceaseCommand),
    #[clap(name = concat!(env!(&quot;PROGRAM_PREFIX&quot;), &quot;decease-generate-keys&quot;))]
    DeceaseGenerateKeys,
    #[clap(name = concat!(env!(&quot;PROGRAM_PREFIX&quot;), &quot;decease-connect&quot;))]
    DeceaseConnect(ConnectCommand),
    #[clap(name = concat!(env!(&quot;PROGRAM_PREFIX&quot;), &quot;decease-handshake&quot;))]
    DeceaseHandshake,
    #[clap(name = concat!(env!(&quot;PROGRAM_PREFIX&quot;), &quot;decease-listen&quot;))]
    DeceaseListen,
}
</code></pre>
<pre><code class="language-sh">$ export PROGRAM_PREFIX=dcs-
$ cargo build
$ for name in decease decease-generate-keys decease-connect decease-handshake decease-listen; do ln target/debug/decease ~/bin/&quot;$PROGRAM_PREFIX$name&quot;; done
</code></pre>
<p>I think this would work okay for derive-style, since the subcommand names get mapped to an enum variant internally, though I think it could be a lot of work for builder-style to keep adding the prefix.</p>
<p>I think native support for prefixes would be nice to add later to reduce the duplication in the definition, but isn't needed.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/3041.html">clap-rs/clap#3041</a> on 2021-11-19 22:17</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../epage/clapng/issues/215.html">epage/clapng#215</a> on 2021-12-06 22:18</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">C: settings</span> removed by @epage on 2021-12-08 20:17</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">A-parsing</span> added by @epage on 2021-12-08 20:17</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">S-blocked</span> added by @epage on 2021-12-13 21:23</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2021-12-16 15:46</div>
            <div class="timeline-body"><p>@fishface60 something I was considering is how should a user provide a sane fallback if the binary is not a recognized name?</p>
<p>We have #2862 about the error message but that isn't always what a user will want.</p>
<p>We could tell users to setup an &quot;external subcommand&quot; and then re-parse it with their default subcommand name.  This might be rare enough that the performance hit is acceptable.  This also gives users the opportunity to report it to the user as they wish (log a warning, custom error, etc).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/3008.html">clap-rs/clap#3008</a> on 2022-01-13 20:03</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/3668.html">clap-rs/clap#3668</a> on 2022-05-02 09:24</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2022-05-02 18:19</div>
            <div class="timeline-body"><p>#3677 polished up a lot about multicall.  My main concern at this point is the fallback on unrecognized binary.  We are still just showing a regular &quot;Unrecognized subcommand&quot; error (#2862).</p>
<p>Possible directions the user might want to go</p>
<ul>
<li>Report to the user what commands the binary can be named<ul>
<li>Can check the error kind but it might be for a deeply nested subcommand</li>
<li>Options:<ul>
<li>Provide a new ErrorKind: user can provide whatever behavior they want</li>
<li>Treat it the same as <code>arg_required_else_help</code> and print help with a failing exit code (<code>DisplayHelpOnMissingArgumentOrSubcommand</code> error kind): works well for actual binaries but doesn't for REPLs</li>
</ul>
</li>
</ul>
</li>
<li>Provide a fallback command:<ul>
<li>Can be implemented manually with <code>allow_external_subcommand(true)</code></li>
</ul>
</li>
</ul>
<p>I feel like a new error kind is probably the only reasonable way to go.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2022-05-02 18:26</div>
            <div class="timeline-body"><p>Actually, can't <code>allow_external_subcommand(true)</code> be used for resolving all the cases?  You can use it to detect an unrecognized subcommand was used on a specific part of the hierarchy and provide print help as needed, you get the default help, or you can provide custom fallback logic.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2022-05-03 21:45</div>
            <div class="timeline-body"><p>I think we'll stablize as-is.  If we get feedback that this needs a dedicated <code>ErrorKind</code>, then we can just wait until 4.0.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/3684.html">clap-rs/clap#3684</a> on 2022-05-03 21:54</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @epage on 2022-05-20 17:42</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:48:07 UTC
    </footer>
</body>
</html>
