<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ability to control `--help` coloring using CLI args (e.g. `--color`) with derive syntax - clap-rs/clap #6013</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Ability to control <code>--help</code> coloring using CLI args (e.g. <code>--color</code>) with derive syntax</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/clap-rs/clap/issues/6013">#6013</a>
        opened by <a href="https://github.com/ivan-aksamentov">@ivan-aksamentov</a>
        on 2025-05-23 22:19
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ivan-aksamentov">@ivan-aksamentov</a></div>
            <div class="timeline-body"><h3>Please complete the following tasks</h3>
<ul>
<li>[x] I have searched the <a href="https://github.com/clap-rs/clap/discussions">discussions</a></li>
<li>[x] I have searched the <a href="https://github.com/clap-rs/clap/issues">open</a> and <a href="https://github.com/clap-rs/clap/issues?q=is%3Aissue+label%3AS-wont-fix+is%3Aclosed">rejected</a> issues</li>
</ul>
<h3>Clap Version</h3>
<p>4.4.2</p>
<h3>Describe your use case</h3>
<p>While clap can handle TTY and non-TTY outputs as well the environment variables co control color well, many applications also have additional CLI args for that, typically  ``</p>
<p>Demonstrate --color has no effect on --help</p>
<pre><code class="language-rust">use clap::{ArgEnum, Parser};

#[derive(Parser)]
struct Cli {
  #[clap(long, global = true, arg_enum)]
  color: Option&lt;ColorOption&gt;,
}

#[derive(Copy, Clone, ArgEnum)]
enum ColorOption {
  Auto,
  Always,
  Never,
}

fn main() {
  let args = Cli::parse(); // No way to account for color mode in `--help`
}

</code></pre>
<p>When running</p>
<pre><code>cli --help --color=never
</code></pre>
<p>it prints color output, because clap does not know about my custom <code>--color</code> arg.</p>
<h3>Describe the solution you'd like</h3>
<p>It seems parsing and printing help should not be a monolithic function call. I'd like parsing and help (without re-implementing manually) to be distinct operations, such that I could insert color logic between them:</p>
<pre><code class="language-rust"># Hypothetical code
let args = CLI::parse();
let is_colored = calculate_is_colored_based_on(&amp;args, &amp;env);
let style = if is_colored { Some(my_style) } else { None };
args.maybe_print_help(style); # need to handle subcommands too
</code></pre>
<p>I would also enjoy built-in <code>--color=always|never|auto</code> and <code>--no-color</code> (shortcut flag for <code>--color=never</code>), similarly to built-in <code>--help</code>. Clap already detects TTY and env vars, so half of the work is already done. Plus, the color args are virtually ubiquitous. Though not sure how the result would be exposed for usage (<code>--help</code> does not expose any result, because it does not have any).</p>
<h3>Alternatives, if applicable</h3>
<p><em>No response</em></p>
<h3>Additional Context</h3>
<p><em>No response</em></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">C-enhancement</span> added by @ivan-aksamentov on 2025-05-23 22:19</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">A-help</span> added by @epage on 2025-05-26 17:35</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">S-waiting-on-design</span> added by @epage on 2025-05-26 17:35</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2025-05-26 17:43</div>
            <div class="timeline-body"><p>Cargo's issue for this is rust-lang/cargo#9012</p>
<p>You can disable the built-in help and provide your own help flag (of type <code>bool</code>) and render the help directly.  There are limitations and annoyances with this.</p>
<p>A more out-there approach could be</p>
<ol>
<li>Parse using <code>try_parse</code></li>
<li>If the error is &quot;help&quot;, get a command-factory and re-parse with a custom help flag</li>
<li>Check the <code>--color</code> flag and then decide how to render the error returned by <code>try_parse</code></li>
</ol>
<p>Overall, the some challenges for a more built-in way are:</p>
<ul>
<li>Help is acted on immediately so we don't see any later flags</li>
<li>Help bypasses any other forms of validation</li>
<li>Help uses information from the parser for being rendered</li>
</ul>
<p>Especially when it comes to the derive, the first two can mean that the derive can't populate the struct, preventing you from acting on it.</p>
<p>The last makes it more difficult to have this be a separate operation.  There is also the convenience factor for users in having them combined.  Splitting them might come at the risk of specialized APIs that might go counter to our efforts for shrinking and focusing the API for easier discoverability and better binary size.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ivan-aksamentov">@ivan-aksamentov</a> on 2025-05-26 19:59</div>
            <div class="timeline-body"><blockquote>
<p>You can disable the built-in help and provide your own help flag (of type bool) and render the help directly. There are limitations and annoyances with this.</p>
</blockquote>
<p>In my particular case, I have many subcommands, and I am not sure how to handle help for all of them.</p>
<p>And I tried 2-step parsing, but this is where I got stuck:</p>
<blockquote>
<p>Help is acted on immediately so we don't see any later flags</p>
</blockquote>
<p>It seems if <code>--help</code> is present, <code>--color</code> is not being parsed.</p>
<hr />
<blockquote>
<p>There is also the convenience factor for users in having them combined.</p>
</blockquote>
<p>Just to clarify, I am not proposing removing the combined function, but rather to expose some hooks to do things in userspace</p>
<hr />
<blockquote>
<p>might go counter to our efforts for shrinking and focusing the API</p>
</blockquote>
<p>Fair enough</p>
<hr />
<p>Thanks for detailed reply!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../nextstrain/nextclade/issues/1629.html">nextstrain/nextclade#1629</a> on 2025-05-27 06:47</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:49:35 UTC
    </footer>
</body>
</html>
