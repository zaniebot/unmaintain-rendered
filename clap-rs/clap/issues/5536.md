```yaml
number: 5536
title: "value_parser un-nests Option<Option<Foo>> multiple times"
type: issue
state: closed
author: mwlon
labels:
  - C-bug
assignees: []
created_at: 2024-06-16T23:11:04Z
updated_at: 2024-06-21T19:16:36Z
url: https://github.com/clap-rs/clap/issues/5536
synced_at: 2026-01-10T01:57:49Z
```

# value_parser un-nests Option<Option<Foo>> multiple times

---

_Issue opened by @mwlon on 2024-06-16 23:11_

### Please complete the following tasks

- [X] I have searched the [discussions](https://github.com/clap-rs/clap/discussions)
- [X] I have searched the [open](https://github.com/clap-rs/clap/issues) and [rejected](https://github.com/clap-rs/clap/issues?q=is%3Aissue+label%3AS-wont-fix+is%3Aclosed) issues

### Rust Version

1.79

### Clap Version

4.5.3

### Minimal reproducible code

```rust
use clap::Parser;

fn parse_foo(s: &str) -> Option<usize> {
  if s == "auto" {
    None
  } else {
    usize::from_str(s).unwrap()
  }
}

#[derive(Parser)]
struct Opt {
  #[arg(long, value_parser=parse_foo, default_value="auto")]
  foo: Option<Option<usize>>
}

fn main() {
  Opt::parse();
}
```

### Steps to reproduce the bug with the above code

`cargo run -- --foo=auto`

### Actual Behaviour

something like

```
Mismatch between definition and access of `delta_encoding_order`. Could not downcast to TypeId { t: (8519994227001858441, 10522819541147869382) }, need to downcast to TypeId { t: (10946805347594816691, 17696603323637579145) }
```

### Expected Behaviour

happy 0 exit code

### Additional Context

It appears that clap derive expects `parse_foo` to just return `usize` instead of `Option<usize>`, and if we change it to do that, the above code compiles. This might make sense for singly-nested `Option<usize>`, but definitely seems wrong for `Option<Option<usize>>`. I assume this isn't the desired behavior; if it is, I think an explanation is warranted. I couldn't find any mention of how `value_parser` interacts with `Option<>` typing from the docs, but it's always possible I missed something.

Side question: if I want the above behavior where `"auto"` or no arg => `None`, int_string => `Some(int)`, is there a better way to do it? I would prefer not to define an enum.

### Debug Output

_No response_

---

_Label `C-bug` added by @mwlon on 2024-06-16 23:11_

---

_Comment by @epage on 2024-06-20 01:17_

This isn't `value_parser` but our derive code which is [inferring behavior based on types](https://docs.rs/clap/latest/clap/_derive/index.html#arg-types).  You can workaround it by fully qualifying `Option`.

See #4626 for improving this.

---

_Comment by @mwlon on 2024-06-21 19:16_

Thanks, I was able to work around it using that trick. I'll close this issue since #4626 probably covers it.

---

_Closed by @mwlon on 2024-06-21 19:16_

---
