<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>verbatim_doc_comment should provide ability to escape newlines with \ like in string literals - clap-rs/clap #3198</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>verbatim_doc_comment should provide ability to escape newlines with \ like in string literals</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/clap-rs/clap/issues/3198">#3198</a>
        opened by <a href="https://github.com/I60R">@I60R</a>
        on 2021-12-18 18:16
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/I60R">@I60R</a></div>
            <div class="timeline-body"><h3>Please complete the following tasks</h3>
<ul>
<li>[X] I have searched the <a href="https://github.com/clap-rs/clap/discussions">discussions</a></li>
<li>[x] I have searched the existing issues</li>
</ul>
<h3>Rust Version</h3>
<ul>
<li></li>
</ul>
<h3>Clap Version</h3>
<p>3.0.0.rc7</p>
<h3>Minimal reproducible code</h3>
<pre><code class="language-rust">/// This is a very long line which I'd like to split in code \
/// but keep wrapped in terminal
/// This text should be on a new line
#[clap(verbatim_doc_comment)]
...
</code></pre>
<h3>Steps to reproduce the bug with the above code</h3>
<ul>
<li></li>
</ul>
<h3>Actual Behaviour</h3>
<p>This is a very long line which I'd like to split in code \
but keep wrapped in terminal
This text should be on a new line</p>
<h3>Expected Behaviour</h3>
<p>This is a very long line which I'd like to split in code but keep wrapped in terminal
This text should be on a new line</p>
<h3>Additional Context</h3>
<p>Previously <code>{n}</code> allowed to achieve the expected effect</p>
<h3>Debug Output</h3>
<p><em>No response</em></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">C-bug</span> added by @I60R on 2021-12-18 18:16</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2021-12-18 18:57</div>
            <div class="timeline-body"><p>Di you see this as different than https://github.com/clap-rs/clap/issues/2389?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/I60R">@I60R</a> on 2021-12-19 04:50</div>
            <div class="timeline-body"><p>Yes. That issue was about preserving newlines and <code>verbatim_doc_comment</code> seems to be a proper solution.</p>
<p>This is about escaping newlines away with <code>verbatim_doc_comment</code> using slash</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "verbatim_doc_comment should provide ability to escape newlines like in string literals" to "verbatim_doc_comment should provide ability to escape newlines with \ like in string literals" by @I60R on 2021-12-19 04:51</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/I60R">@I60R</a> on 2021-12-20 08:48</div>
            <div class="timeline-body"><p>Alternatively, could be the support for <code>{n}</code> restored? It worked perfectly with <code>help_wrap</code> and with it migration from structopt may be easier for some people.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/1810.html">clap-rs/clap#1810</a> on 2021-12-20 14:40</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">A-help</span> added by @epage on 2021-12-20 14:40</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">S-waiting-on-design</span> added by @epage on 2021-12-20 14:40</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2021-12-20 14:41</div>
            <div class="timeline-body"><p>I missed that, thanks!</p>
<p>I went back to try to see why <code>{n}</code> was removed but the PR doesn't have an explanation.  I've pinged the people involved at that time to see if we can learn from what was done before.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/pksunkara">@pksunkara</a> on 2021-12-20 15:18</div>
            <div class="timeline-body"><p>Can you try replacing <code>\</code> with <code>\n</code> and see if it works?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/I60R">@I60R</a> on 2021-12-20 23:05</div>
            <div class="timeline-body"><p>Nope, either with <code>verbatim_doc_comment</code> and without it's rendered as <code>\n</code> without newline being added</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/I60R">@I60R</a> on 2021-12-28 01:27</div>
            <div class="timeline-body"><p>@pksunkara <code>\n</code> works when inserted into <code>help</code> attribute e.g. <code>help=&quot;string\n&quot;</code> but is stripped when placed in doc comment, so the problem is on derive side I guess?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/3228.html">clap-rs/clap#3228</a> on 2021-12-28 04:14</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/pksunkara">@pksunkara</a> on 2021-12-28 04:28</div>
            <div class="timeline-body"><p>Yup, check the comment I made on that PR. Approach is correct but we need to check for the <code>verbatim_doc_comment</code> attribute first.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2021-12-28 15:15</div>
            <div class="timeline-body"><p>So to double check what you are ultimately trying to accomplish, you are wanting one line to be able to overflow onto following lines and you want another line immediately after it without a paragraph break, right?</p>
<p>You originally did this with</p>
<pre><code class="language-rust">/// This is a very long line which I'd like to split in code
/// but keep wrapped in terminal {n}
/// This text should be on a new line
...
</code></pre>
<p>Your thought is to either implement this with</p>
<pre><code class="language-rust">/// This is a very long line which I'd like to split in code \
/// but keep wrapped in terminal
/// This text should be on a new line
#[clap(verbatim_doc_comment)]
...
</code></pre>
<p>or</p>
<pre><code class="language-rust">/// This is a very long line which I'd like to split in code
/// but keep wrapped in terminal \n
/// This text should be on a new line
...
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2021-12-28 15:19</div>
            <div class="timeline-body"><p>btw something I've been meaning to do is to explore the feature set and API design of other CLI parsers to see what we can learn or to help open us up on the problem space.</p>
<p><a href="https://click.palletsprojects.com/en/8.0.x/documentation/#preventing-rewrapping">Click uses escape sequences to customize the help</a></p>
<ul>
<li><code>\b</code> to turn off wrapping for a paragraph</li>
<li><code>\f</code> to cut off the <code>help</code>, leaving the rest for the doc comment</li>
</ul>
<p>A key difference is that these are just control codes in a doc string that are probably being ignored by the documentation tools while, as pointed out, Rust doc comments are raw strings so escape sequences are ignored.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone "3.0" by @epage on 2021-12-28 15:51</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/I60R">@I60R</a> on 2021-12-28 18:50</div>
            <div class="timeline-body"><p>@epage correct. It seems that <code>\n</code> will be a proper approach because it's very similar to <code>&lt;br&gt;</code> in markdown.</p>
<p>When talking about other CLI parsers, Python's argparse allows custom help formatting via <a href="https://docs.python.org/3/library/argparse.html#formatter-class">HelpFormatter</a> class, so maybe clap should externalize help preprocessing as well? There could be 4 functions for <code>long_/short_/help/about</code> and they could take <code>Vec&lt;String&gt;</code> from <code>syn</code> plus <code>Vec&lt;(String, String)&gt;</code> of metadata e.g. <code>env.</code>, <code>default</code> etc. and users then could implement whatever formatting they want</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/pksunkara">@pksunkara</a> on 2021-12-28 21:16</div>
            <div class="timeline-body"><blockquote>
<pre><code class="language-rust">/// This is a very long line which I'd like to split in code
/// but keep wrapped in terminal \n
/// This text should be on a new line
</code></pre>
</blockquote>
<p>How is this shown on rust docs?</p>
<p>As specified in #2389, our default help text should behave similarly to rust docs. And <code>verbatim_doc_comment</code> allows people to escape that behaviour.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/I60R">@I60R</a> on 2021-12-28 21:35</div>
            <div class="timeline-body"><p>This will be rendered as <code>\n</code> in rustdoc...</p>
<p><strong>Okay, another proposal</strong>: in markdown <a href="https://www.markdownguide.org/basic-syntax/#line-break-best-practices">we can place slash at the end of line to preserve newline</a> which is opposite to what slash does in Rust str literals (weird!). Although this feature isn't recommended for use and is relatively unknown, it still a part of markdown specification and thus supported by rustdoc, so</p>
<pre><code>/// This is a very long line which I'd like to split in code
/// but keep wrapped in terminal \
/// This text should be on a new line
</code></pre>
<p>Will be rendered by rustdoc as</p>
<pre><code>This is a very long line which I'd like to split in code but keep wrapped in terminal
This text should be on a new line
</code></pre>
<p>If we aim to make --help as most close as possible to rustdoc then turning slash followed by newline into <code>{n}</code> replacement should be the most compatible option</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/I60R">@I60R</a> on 2021-12-29 00:33</div>
            <div class="timeline-body"><p>So, I've implemented that behavior in #3228, let's continue discussion there</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @I60R on 2021-12-29 00:33</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/2389.html">clap-rs/clap#2389</a> on 2021-12-29 02:51</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2021-12-30 12:17</div>
            <div class="timeline-body"><p>In considering the motivating case for this issue being a regression in functionality in clap3 and the relative size of the various proposed replacements for the clap2 behavior, I'm thinking of restoring <code>{n}</code> for the life of clap3, assuming we get markdown support in during the clap3 release.  @I60R thoughts?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/3230.html">clap-rs/clap#3230</a> on 2021-12-30 17:44</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2021-12-30 21:03</div>
            <div class="timeline-body"><p>@I60R can you report back if  <code>{n}</code> in 3.0.0-rc.11 unblocks you?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/I60R">@I60R</a> on 2021-12-31 00:07</div>
            <div class="timeline-body"><p>Sorry for being silent.</p>
<p>Yes, I like to have <code>{n}</code> during clap3 or until markdown would be ready</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/tmccombs">@tmccombs</a> on 2022-11-11 08:38</div>
            <div class="timeline-body"><p>I want this feature as originally described, but <code>{n}</code> doesn't work, because I need to use verbatim_doc_comment in order to get proper indentation (because without verbatim_doc_comment whitespace gets compressed).</p>
<p>AFAICT currently I either have to use really long lines in the comments with verbatim_doc_comment, or pass it in directly to long_help (i.e. don't use the doc comment functionality). Or I suppose break the line myself, and then if the screen is too narrow, it will wrap weirdly.</p>
<p>Alternatively, having a way to toggle between verbatim and non-verbatim mode. I wonder if it would make sense to switch into verbatim mode inside of a code block delimited with triple backticks (and remove those backticks). Or maybe if a line starts with three or more spaces (2 after removing the initial space), then treat it as a new line, and don't remove the initial whitespace?</p>
<p>Full markdown support isn't really necessary for me here.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2022-11-11 14:04</div>
            <div class="timeline-body"><blockquote>
<p>without verbatim_doc_comment whitespace gets compressed</p>
</blockquote>
<p>What do you mean by this?  We should only be stripping off a single leading space that would be between the <code>///</code> and the text.</p>
<blockquote>
<p>Full markdown support isn't really necessary for me here.</p>
</blockquote>
<p>Except a lot of what you are describing either adds a lot of complexity or is us basically implementing a poor mans version of markdown.   A lot of these  doc comments people post are because of that gulf; they expect to be able to write markdown and we don't support it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/tmccombs">@tmccombs</a> on 2022-11-12 06:03</div>
            <div class="timeline-body"><blockquote>
<p>what do you mean by this?</p>
</blockquote>
<p>I am referring to:</p>
<blockquote>
<p>Strip leading and trailing whitespace from every line, if present.</p>
</blockquote>
<p>So if verbatim_doc_comment is true, you lose any indentation at the beginning of the line. Initially, I didn't think there was any way to get that back, but actually I did figure out a way to do it. If I put &quot;{n}&quot; at the beginning of the line, then put the space between that and the text of the line, the whitespace is preserved.</p>
<blockquote>
<p>they expect to be able to write markdown and we don't support it.</p>
</blockquote>
<p>No, not really. My example isn't even really markdown. It looks something like:</p>
<pre><code>Do something special that requires quite a bit of explanation
that is in a paragraph that should be on multiple
lines in the doc comment, but ideally would be treated
as a single line for wrapping.

Examples:
    --do-something value1
    --do-something 1124
</code></pre>
<p>If I were to write that in markdown, I suppose I could put the  examples inside triple backquotes. Would that be included in the scope of the markdown support feature?</p>
<p>But as is, it isn't really markdown, just text with some indentation. And it really doesn't need things like headers, emphasis, links, etc. (although such things certainly could be useful in general).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2022-11-13 03:47</div>
            <div class="timeline-body"><p>Ah, I had missed the trim on non-verbatim lines.  That seems odd that we trim leading whitespace.</p>
<p>In general</p>
<ul>
<li>We need some format for normalizing the text (paragraphs)</li>
<li>We need some format for knowing to know how to leave things alone</li>
<li>There is the general expectation that doc comments are comments and doing a format that is anything else will likely lead to more problems</li>
</ul>
<p>This leads to us supporting markdown, even if its not the most thorough parser.   This is why I created <a href="https://github.com/rosetta-rs/md-rosetta-rs">md-rosetta-rs</a> was to look for the cheapest parser that gets things done.</p>
<blockquote>
<p>And it really doesn't need things like headers, emphasis, links, etc. (although such things certainly could be useful in general).</p>
</blockquote>
<p>I strongly expect <a href="https://github.com/clap-rs/clap/issues/3108">headers will be needed</a>.  While we are talking about doc comments, I expect people will want to write markdown for others parts as well and we should consider how we can support that for people.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/3367.html">clap-rs/clap#3367</a> on 2024-05-23 14:21</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/obskyr">@obskyr</a> on 2024-05-23 14:27</div>
            <div class="timeline-body"><p>This issue should probably be reopened â€“ unless there's a different way to escape newlines when using <code>verbatim_doc_comment</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2024-06-06 20:20</div>
            <div class="timeline-body"><p>The original person's issue was solved a different way.</p>
<p>I am hesitant for us to muck much like this with verbatim because then its no longer verbatim.  It is like saying you need a string literal but allow escaping in one specific case.</p>
<p>What I would recommend is focusing on what your underlying need for this is and we can then explore how to resolve that need.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/tmccombs">@tmccombs</a> on 2024-07-06 22:36</div>
            <div class="timeline-body"><p>What if any part of the doc comment that is between code fences (&quot;```&quot;) is treated as verbatim, if it is in a non-verbatim doc comment?</p>
<p>That way it is possible to temporarily suppress the pre-processing in a way that works both in a rustdoc output and the help output.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/obskyr">@obskyr</a> on 2024-07-07 07:28</div>
            <div class="timeline-body"><blockquote>
<p>The original person's issue was solved a different way.</p>
<p>I am hesitant for us to muck much like this with verbatim because then its no longer verbatim. It is like saying you need a string literal but allow escaping in one specific case.</p>
<p>What I would recommend is focusing on what your underlying need for this is and we can then explore how to resolve that need.</p>
</blockquote>
<p>My need is to not have the final period removed (#3367). Currently, there is no way to avoid having the final period removed without also putting every paragraph of the doc comment on a single line (making for lines of hundreds of characters) or introducing manual line breaks to the text (meaning the text will no longer fit the user's terminal window).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2024-07-08 15:17</div>
            <div class="timeline-body"><p>@obskyr then any discussion should be on #3367 and from there we should decide whether to further tweak our rules, rather than asking for an unrelated issue to be re-opened.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:48:20 UTC
    </footer>
</body>
</html>
