<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Using a required ArgGroup with a positional arg, prints that arg twice in Usage String - clap-rs/clap #1292</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Using a required ArgGroup with a positional arg, prints that arg twice in Usage String</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/clap-rs/clap/issues/1292">#1292</a>
        opened by <a href="https://github.com/kbknapp">@kbknapp</a>
        on 2018-06-10 19:03
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/kbknapp">@kbknapp</a> on 2018-06-10 19:03</div>
            <div class="timeline-body"><h3>Rust Version</h3>
<ul>
<li>1.26.2 Stable</li>
<li>rustc 1.28.0-nightly (29f48ccf3 2018-06-03)</li>
</ul>
<h3>Affected Version of clap</h3>
<ul>
<li>2.31.2</li>
</ul>
<h3>Expected Behavior Summary</h3>
<p>Additional positional args aren't printed in usage</p>
<p>Such as <code>foo &lt;--opt &lt;val&gt;|arg&gt;</code></p>
<h3>Actual Behavior Summary</h3>
<p><code>arg</code> gets printed twice</p>
<p>such as <code>foo &lt;--opt val|arg&gt; [arg]</code></p>
<h3>Sample Code or Link to Sample Code</h3>
<pre><code class="language-rust">let matches = App::new(&quot;foo&quot;)
        .arg(Arg::with_name(&quot;fd&quot;)
                .long(&quot;fd&quot;)
                .takes_value(true))
        .arg(Arg::with_name(&quot;target&quot;))
        .arg(Arg::with_name(&quot;target_args&quot;)
                .multiple(true)
                .requires(&quot;target&quot;))
        .group(ArgGroup::with_name(&quot;target_fd&quot;)
                .arg(&quot;fd&quot;)
                .arg(&quot;target&quot;)
                .required(true))
        .get_matches_from(vec![&quot;foo&quot;, &quot;--help&quot;]);
</code></pre>
<h3>Debug output</h3>
<details>
<summary> Debug output</summary>
<pre><code>
DEBUG:clap:Parser::propagate_settings: self=foo, g_settings=AppFlags(
    (empty)
)
DEBUG:clap:Parser::get_matches_with;
DEBUG:clap:Parser::create_help_and_version;
DEBUG:clap:Parser::create_help_and_version: Building --help
DEBUG:clap:Parser::create_help_and_version: Building --version
DEBUG:clap:Parser::get_matches_with: Begin parsing '"--help"' ([45, 45, 104, 101, 108, 112])
DEBUG:clap:Parser::is_new_arg:"--help":NotFound
DEBUG:clap:Parser::is_new_arg: arg_allows_tac=false
DEBUG:clap:Parser::is_new_arg: -- found
DEBUG:clap:Parser::is_new_arg: starts_new_arg=true
DEBUG:clap:Parser::possible_subcommand: arg="--help"
DEBUG:clap:Parser::get_matches_with: possible_sc=false, sc=None
DEBUG:clap:ArgMatcher::process_arg_overrides:None;
DEBUG:clap:Parser::parse_long_arg;
DEBUG:clap:Parser::parse_long_arg: Does it contain '='...No
DEBUG:clap:Parser::parse_long_arg: Found valid flag '--help'
DEBUG:clap:Parser::check_for_help_and_version_str;
DEBUG:clap:Parser::check_for_help_and_version_str: Checking if --help is help or version...Help
DEBUG:clap:Parser::_help: use_long=true
DEBUG:clap:Help::write_parser_help;
DEBUG:clap:Help::write_parser_help;
DEBUG:clap:Parser::color;
DEBUG:clap:Parser::color: Color setting...Auto
DEBUG:clap:is_a_tty: stderr=false
DEBUG:clap:Help::new;
DEBUG:clap:Help::write_help;
DEBUG:clap:Help::write_default_help;
DEBUG:clap:Help::write_bin_name;
DEBUG:clap:Help::write_version;
DEBUG:clap:usage::create_usage_no_title;
DEBUG:clap:usage::get_required_usage_from: reqs=["target_fd"], extra=None
DEBUG:clap:usage::get_required_usage_from: after init desc_reqs=[]
DEBUG:clap:usage::get_required_usage_from: no more children
DEBUG:clap:usage::get_required_usage_from: final desc_reqs=["target_fd"]
DEBUG:clap:usage::get_required_usage_from: args_in_groups=["fd", "target"]
DEBUG:clap:OptBuilder::fmt:fd
DEBUG:clap:usage::needs_flags_tag;
DEBUG:clap:usage::needs_flags_tag:iter: f=hclap_help;
DEBUG:clap:usage::needs_flags_tag:iter: f=vclap_version;
DEBUG:clap:usage::needs_flags_tag: [FLAGS] not required
DEBUG:clap:usage::get_args_tag;
DEBUG:clap:usage::get_args_tag:iter:target:
DEBUG:clap:Parser::groups_for_arg: name=target
DEBUG:clap:Parser::groups_for_arg: Searching through groups...
        Found 'target_fd'
DEBUG:clap:usage::get_args_tag:iter:target:iter:target_fd;
DEBUG:clap:usage::get_args_tag:iter:target_args:
DEBUG:clap:Parser::groups_for_arg: name=target_args
DEBUG:clap:Parser::groups_for_arg: Searching through groups...
DEBUG:clap:usage::get_args_tag:iter: 1 Args not required or hidden
DEBUG:clap:usage::get_args_tag:iter: Exactly one, returning 'target'
DEBUG:clap:PosBuilder::name_no_brackets;
DEBUG:clap:PosBuilder:name_no_brackets: just name
DEBUG:clap:usage::create_help_usage: usage=foo [OPTIONS] <--fd <fd>|target> [target]
DEBUG:clap:Help::write_all_args;
DEBUG:clap:Help::write_args;
DEBUG:clap:Help::write_args: Current Longest...2
DEBUG:clap:Help::write_args: New Longest...6
DEBUG:clap:Help::write_args: Current Longest...6
DEBUG:clap:Help::write_args: New Longest...9
DEBUG:clap:Help::write_arg;
DEBUG:clap:Help::short;
DEBUG:clap:Help::long;
DEBUG:clap:Help::val: arg=--help
DEBUG:clap:Help::spec_vals: a=--help
DEBUG:clap:Help::val: Has switch...Yes
DEBUG:clap:Help::val: force_next_line...false
DEBUG:clap:Help::val: nlh...false
DEBUG:clap:Help::val: taken...21
DEBUG:clap:Help::val: help_width > (width - taken)...23 > (120 - 21)
DEBUG:clap:Help::val: longest...9
DEBUG:clap:Help::val: next_line...No
DEBUG:clap:write_spaces!: num=7
DEBUG:clap:Help::help;
DEBUG:clap:Help::help: Next Line...false
DEBUG:clap:Help::help: Too long...No
DEBUG:clap:Help::write_arg;
DEBUG:clap:Help::short;
DEBUG:clap:Help::long;
DEBUG:clap:Help::val: arg=--version
DEBUG:clap:Help::spec_vals: a=--version
DEBUG:clap:Help::val: Has switch...Yes
DEBUG:clap:Help::val: force_next_line...false
DEBUG:clap:Help::val: nlh...false
DEBUG:clap:Help::val: taken...21
DEBUG:clap:Help::val: help_width > (width - taken)...26 > (120 - 21)
DEBUG:clap:Help::val: longest...9
DEBUG:clap:Help::val: next_line...No
DEBUG:clap:write_spaces!: num=4
DEBUG:clap:Help::help;
DEBUG:clap:Help::help: Next Line...false
DEBUG:clap:Help::help: Too long...No
DEBUG:clap:Help::write_args;
DEBUG:clap:Help::write_args: Current Longest...2
DEBUG:clap:OptBuilder::fmt:fd
DEBUG:clap:Help::write_args: New Longest...9
DEBUG:clap:Help::write_arg;
DEBUG:clap:Help::short;
DEBUG:clap:Help::long;
DEBUG:clap:Help::val: arg=DEBUG:clap:OptBuilder::fmt:fd
--fd <fd>
DEBUG:clap:Help::spec_vals: a=DEBUG:clap:OptBuilder::fmt:fd
--fd <fd>
DEBUG:clap:Help::val: Has switch...Yes
DEBUG:clap:Help::val: force_next_line...false
DEBUG:clap:Help::val: nlh...false
DEBUG:clap:Help::val: taken...21
DEBUG:clap:Help::val: help_width > (width - taken)...0 > (120 - 21)
DEBUG:clap:Help::val: longest...9
DEBUG:clap:Help::val: next_line...No
DEBUG:clap:OptBuilder::fmt:fd
DEBUG:clap:write_spaces!: num=4
DEBUG:clap:Help::help;
DEBUG:clap:Help::help: Next Line...false
DEBUG:clap:Help::help: Too long...No
DEBUG:clap:Help::write_args_unsorted;
DEBUG:clap:Help::write_arg;
DEBUG:clap:Help::short;
DEBUG:clap:Help::long;
DEBUG:clap:Help::val: arg=<target>
DEBUG:clap:Help::spec_vals: a=<target>
DEBUG:clap:Help::val: Has switch...No, and not next_line
DEBUG:clap:write_spaces!: num=12
DEBUG:clap:Help::help;
DEBUG:clap:Help::help: Next Line...false
DEBUG:clap:Help::help: Too long...No
DEBUG:clap:Help::write_arg;
DEBUG:clap:Help::short;
DEBUG:clap:Help::long;
DEBUG:clap:Help::val: arg=<target_args>...
DEBUG:clap:Help::spec_vals: a=<target_args>...
DEBUG:clap:Help::val: Has switch...No, and not next_line
DEBUG:clap:write_spaces!: num=4
DEBUG:clap:Help::help;
DEBUG:clap:Help::help: Next Line...false
DEBUG:clap:Help::help: Too long...No
foo 

<p>USAGE:
foo [OPTIONS] &lt;--fd <fd>|target&gt; [target]</p>
<p>FLAGS:
-h, --help       Prints help information
-V, --version    Prints version information</p>
<p>OPTIONS:
--fd <fd></p>
<p>ARGS:
<target><br />
&lt;target_args&gt;...</p>
<p></code></pre></p>
</details>

</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">T: bug</span> added by @kbknapp on 2018-06-10 19:04</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">P2: need to have</span> added by @kbknapp on 2018-06-10 19:04</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">D: easy</span> added by @kbknapp on 2018-06-10 19:04</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">W: 2.x</span> added by @kbknapp on 2018-06-10 19:04</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">C: usage strings</span> added by @kbknapp on 2018-06-10 19:04</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/1291.html">clap-rs/clap#1291</a> on 2018-06-10 19:05</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/gcp">@gcp</a> on 2018-06-21 15:14</div>
            <div class="timeline-body"><blockquote>
<p>Additional positional args aren't printed in usage</p>
</blockquote>
<p>Why would this be expected? I would expect something like:</p>
<p><code>foo &lt;--fd &lt;fd&gt; | target [target_args]&gt;</code></p>
<p>That is, it should print the positional arg that depends on target. Right now it prints <code>target</code> twice, i.e. the thing that gets printed twice is not the positional argument which would be <code>target_args</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Telzhaak">@Telzhaak</a> on 2018-09-17 17:55</div>
            <div class="timeline-body"><p>Can confirm that the bug is still there in v2.32, futhermore the order of displayed arg-names get mixed up.</p>
<p>Used <code>yaml</code> for my CLI: https://gist.github.com/Telzhaak/fea65096ea5fffd78efd2a35c27ea87d
Expect <code>--help</code> to show something like: <code>tool.exe &lt;name&gt; &lt;storage_type|--tag&gt; &lt;fields&gt;...</code></p>
<p>Instead I get:</p>
<pre><code>./target/release/tool.exe --help
//snip
USAGE:
    tool.exe &lt;name&gt; &lt;storage_type|--tag&gt; [storage_type]

//snip
</code></pre>
<p>Running the app with missing arguments delivers wrong order in some cases, <code>&lt;fields&gt;...</code> should've been behind <code>&lt;storage_type|--tag&gt;</code>:</p>
<pre><code>./target/release/tool.exe compi Vec
error: The following required arguments were not provided:
    &lt;fields&gt;...

USAGE:
    tool.exe &lt;name&gt; &lt;fields&gt;... &lt;storage_type|--tag&gt;
</code></pre>
<p>If argument is not in possibility list, the last arg gets omitted completely:</p>
<pre><code>./target/release/tool.exe compi qwe Vec
error: 'qwe' isn't a valid value for '&lt;storage_type&gt;'
        [possible values: Anti, BTree, DenseVec, Flagged, HashMap, Masked, Restricted, Vec]

USAGE:
    tool.exe &lt;name&gt; &lt;storage_type|--tag&gt;
</code></pre>
<p>It looks like this behaviour is connected to the resolving of the group?
I'm grouping a flag and an arg (multiple), which might not be properly supported yet.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone "3.1" by @pksunkara on 2020-04-28 18:41</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/2121.html">clap-rs/clap#2121</a> on 2020-08-31 05:57</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">W: 2.x</span> removed by @pksunkara on 2020-10-26 07:58</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ldm0">@ldm0</a> on 2021-08-13 18:40</div>
            <div class="timeline-body"><pre><code class="language-rust">use clap::*;
fn main() {
    let matches = App::new(&quot;foo&quot;)
        .arg(Arg::new(&quot;fd&quot;).long(&quot;fd&quot;).takes_value(true))
        .arg(Arg::new(&quot;target&quot;))
        .group(
            ArgGroup::new(&quot;target_fd&quot;)
                .arg(&quot;fd&quot;)
                .arg(&quot;target&quot;)
                .required(true),
        )
        .get_matches_from(vec![&quot;foo&quot;, &quot;--help&quot;]);
}
</code></pre>
<p>Current output(master):</p>
<pre><code class="language-txt">foo 

USAGE:
    foo [OPTIONS] &lt;--fd &lt;fd&gt;|target&gt;

ARGS:
    &lt;target&gt;    

FLAGS:
    -h, --help       Print help information
    -V, --version    Print version information

OPTIONS:
        --fd &lt;fd&gt;   
</code></pre>
<p>I think the problem is resolved now.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @ldm0 on 2021-08-13 18:40</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 01:33:49 UTC
    </footer>
</body>
</html>
