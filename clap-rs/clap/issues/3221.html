<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add an env_prefix derive option for a consistent prefix for environment variables - clap-rs/clap #3221</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Add an env_prefix derive option for a consistent prefix for environment variables</h1>

    <div class="meta">
        <span class="state state-open">Open</span>
        <a href="https://github.com/clap-rs/clap/issues/3221">#3221</a>
        opened by <a href="https://github.com/gibfahn">@gibfahn</a>
        on 2021-12-27 01:12
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/gibfahn">@gibfahn</a> on 2021-12-27 01:12</div>
            <div class="timeline-body"><p>Maintainer's notes</p>
<ul>
<li>Proposed fix is to add a <code>Command::next_env_prefix</code> and <code>Arg::env_prefix</code> and is modeled after <code>help_heading</code><ul>
<li><code>Command::next_env_prefix</code>applies to all future <code>Arg</code>s and is set during <code>.arg()</code></li>
<li>An explicit <code>Arg::env_prefix</code> takes precedence over <code>Command::next_env_prefix</code></li>
<li>Derives will need to capture and restore state</li>
<li>https://github.com/clap-rs/clap/issues/1807 will allow derives to change the <code>Command::next_env_prefix</code> part-way through struct definition</li>
<li>Either we generate the env variables during <code>_build</code> (<code>env</code> will internally need to be a <code>Cow</code>), leaving help generation and env variable look up unchanged or we do it on lookup/display</li>
</ul>
</li>
</ul>
<hr />
<h3>Please complete the following tasks</h3>
<ul>
<li>[X] I have searched the <a href="https://github.com/clap-rs/clap/discussions">discussions</a></li>
<li>[X] I have searched the existing issues</li>
</ul>
<h3>Clap Version</h3>
<p>v3.0.0-rc.8</p>
<h3>Describe your use case</h3>
<p>This was previously discussed in https://github.com/TeXitoi/structopt/issues/370.</p>
<p>Basically the request is to be able to allow a specific prefix to be appended to all <code>#[clap(env)]</code> derived environment variable names.</p>
<h3>Describe the solution you'd like</h3>
<p>Before:</p>
<pre><code class="language-rust">#[derive(Parser)]
pub struct Opts {
    #[clap(long, env = &quot;FOO_CONFIG_DIR&quot;)]
    pub config_dir: String,
    #[clap(long, env = &quot;FOO_TEMP_DIR&quot;)]
    pub temp_dir: String,
    #[clap(long, env = &quot;FOO_CACHE_DIR&quot;)]
    pub cache_dir: String,
    #[clap(long)]
    pub isolated: bool
}
</code></pre>
<p>After:</p>
<pre><code class="language-rust">#[derive(Parser)]
#[clap(env_prefix)]
pub struct Opts {
    #[clap(long, env)]
    pub config_dir: String,
    #[clap(long, env)]
    pub temp_dir: String,
    #[clap(long, env)]
    pub cache_dir: String,
    #[clap(long)]
    pub isolated: bool
}
</code></pre>
<p>(where a custom prefix could be set by <code>#[clap(env_prefix=&quot;foo&quot;)]</code>, but the default was the <code>#[clap(name)]</code>)</p>
<h3>Alternatives, if applicable</h3>
<p>I don't think there's an alternative solution to manually setting the environment variable for every option that needs it.</p>
<p>There was a suggestion in the above issue about allowing this to be calculated via a function vs a string literal, but I can't think of a good use-case for it, so it seems unnecessary for this feature.</p>
<h3>Additional Context</h3>
<p>Examples from the above issue:</p>
<p><a href="https://github.com/rust-analyzer/rust-analyzer/pull/4424"><code>rust-analyzer</code></a> looks for <code>RA_LOG</code> var, <a href="https://internals.rust-lang.org/t/rust-log-vs-rustc-log/4297"><code>rustc</code></a> looks for <code>RUSC_LOG</code> var, <a href="https://github.com/mozilla/sccache#storage-options"><code>sccache</code></a> looks for <code>SCCACHE_ENDPOINT</code>, <code>SCCACHE_CACHE_SIZE</code>, <code>SCCACHE_REDIS</code> and other....</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">C-enhancement</span> added by @gibfahn on 2021-12-27 01:12</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2021-12-27 14:50</div>
            <div class="timeline-body"><p>Wanted to double check.  Did you mean for your &quot;after&quot; to be:</p>
<pre><code class="language-rust">#[derive(Parser)]
#[clap(env_prefix)]
pub struct Opts {
    #[clap(long, env)]
    pub config_dir: String,
    #[clap(long, env)]
    pub temp_dir: String,
    #[clap(long, env)]
    pub cache_dir: String,
    #[clap(long)]
    pub isolated: bool
}
</code></pre>
<ul>
<li><code>#[clap(env)]</code> is being specified</li>
<li>I added <code>--isolated</code> to contrast with the use of <code>env</code></li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">A-derive</span> added by @epage on 2021-12-27 14:50</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">S-waiting-on-author</span> added by @epage on 2021-12-27 14:50</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2021-12-27 14:52</div>
            <div class="timeline-body"><p>If we do this, we'd need to make clear that <code>env_prefix</code> would <strong>not</strong> propagate through <code>flatten</code> / <code>subcommand</code> unlike most other attributes that get set.  I'm assuming this limitation isn't enough to hold back making it easier to follow common env variable practices.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/gibfahn">@gibfahn</a> on 2021-12-30 19:17</div>
            <div class="timeline-body"><blockquote>
<p>Wanted to double check. Did you mean for your &quot;after&quot; to be:</p>
</blockquote>
<p>Whoops, yes my bad, you'd still specify <code>env</code>. I updated the original example to match your correction.</p>
<blockquote>
<p>If we do this, we'd need to make clear that env_prefix would not propagate through flatten / subcommand unlike most other attributes that get set.</p>
</blockquote>
<p>Why wouldn't we want it to propagate? I can see that making the user be explicit is probably a better idea, but I could also see <code>mycmd mysubccmd --myarg</code> being converted to <code>$MYCMD_MYSUBCMD_MYARG</code> (for example), and I'm not sure what the issue would be with flatten used outside of subcommands.</p>
<blockquote>
<p>I'm assuming this limitation isn't enough to hold back making it easier to follow common env variable practices.</p>
</blockquote>
<p>Definitely not an issue to specify <code>env_prefix</code> in more places either way, especially if the default values mostly work.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2021-12-30 19:34</div>
            <div class="timeline-body"><blockquote>
<blockquote>
<p>If we do this, we'd need to make clear that env_prefix would not propagate through flatten / subcommand unlike most other attributes that get set.</p>
</blockquote>
<p>Why wouldn't we want it to propagate? I can see that making the user be explicit is probably a better idea, but I could also see <code>mycmd mysubccmd --myarg</code> being converted to <code>$MYCMD_MYSUBCMD_MYARG</code> (for example), and I'm not sure what the issue would be with flatten used outside of subcommands.</p>
</blockquote>
<p>Sorry I didn't go into more details on this.  We can't make derives for different structs interact at build-time.  We have to do all of this at runtime.</p>
<p>Our options are</p>
<ul>
<li>Balloon out the derive API for each new piece of information we want to communicate, either breaking compatibility or having the new functions on the trait call into the old ones with defaults</li>
<li>Try to figure out which arguments were added during the flatten and modify them accordingly</li>
<li>Make this a part of the builder API.</li>
</ul>
<p>In thinking about this, maybe it could be worthwhile to add this to the builder API.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">S-waiting-on-author</span> removed by @epage on 2021-12-30 20:36</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">S-waiting-on-design</span> added by @epage on 2021-12-30 20:36</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/gibfahn">@gibfahn</a> on 2022-01-17 14:59</div>
            <div class="timeline-body"><blockquote>
<p>In thinking about this, maybe it could be worthwhile to add this to the builder API.</p>
</blockquote>
<p>Adding this to the builder API would basically mean that <code>#[clap(env)]</code> would call something like <code>.env(default_env!())</code> the way <code>#[clap(version)]</code> calls <code>.version(crate_version!())</code> today?</p>
<p>If so that seems reasonable to me.</p>
<blockquote>
<p>Sorry I didn't go into more details on this. We can't make derives for different structs interact at build-time. We have to do all of this at runtime.</p>
</blockquote>
<p>For what it's worth I think it would be fine to just have <code>#[clap(env)]</code> work for top-level options, and leave it as a future enhancement to deal with propagating.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2022-01-17 15:17</div>
            <div class="timeline-body"><blockquote>
<p>For what it's worth I think it would be fine to just have <code>#[clap(env)]</code> work for top-level options, and leave it as a future enhancement to deal with propagating.</p>
</blockquote>
<p>We want to avoid this.  Someone refactoring their app from a single <code>Struct</code> to multiple <code>Struct</code>s would then get surprised by it breaking.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">S-waiting-on-design</span> removed by @epage on 2022-01-25 15:43</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">S-waiting-on-mentor</span> added by @epage on 2022-01-25 15:43</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">S-waiting-on-mentor</span> removed by @epage on 2022-01-25 15:44</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">S-waiting-on-design</span> added by @epage on 2022-01-25 15:44</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2022-01-25 15:51</div>
            <div class="timeline-body"><p>Alright, so the proposal is we add an <code>App::env_prefix</code>.</p>
<p>Questions</p>
<ul>
<li>How should <code>Arg</code>s override this, e.g. reading from a <a href="https://clig.dev/#environment-variables">general purpose env variable</a></li>
<li>Should we allow changing the env prefix?  Maybe like we do with <code>help_heading</code> where its stateful?<ul>
<li>Modeling after <code>help_heading</code> would allow overriding the prefix in limited cases</li>
<li>For derive users, in https://github.com/clap-rs/clap/issues/1807 we propose a <code>clap::app</code> attribute on fields so <code>App::env_prefix</code> can be called</li>
</ul>
</li>
<li>Should we apply this during <code>_build</code> or when doing look ups<ul>
<li><code>_build</code> is better for sharing logic with help, man pages, etc</li>
<li>On lookup is better for performance</li>
<li>We could switch to a two-tier build model where <code>get_matches</code> does a minimal build and everything else (like https://github.com/clap-rs/clap/issues/2911) gets a full build.</li>
</ul>
</li>
</ul>
<p>So in writing up these questions, I think we've got our answers.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">S-waiting-on-design</span> removed by @epage on 2022-01-25 15:52</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">E-medium</span> added by @epage on 2022-01-25 15:52</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/3513.html">clap-rs/clap#3513</a> on 2022-02-26 10:14</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/3517.html">clap-rs/clap#3517</a> on 2022-02-28 03:31</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Stargateur">@Stargateur</a> on 2022-05-20 11:44</div>
            <div class="timeline-body"><blockquote>
<p>If we do this, we'd need to make clear that <code>env_prefix</code> would <strong>not</strong> propagate through <code>flatten</code> / <code>subcommand</code> unlike most other attributes that get set. I'm assuming this limitation isn't enough to hold back making it easier to follow common env variable practices.</p>
</blockquote>
<p>It's would be amazing that flatten to do it automatically for example I would like:</p>
<pre><code class="language-rust">#[derive(Debug, Args, Deserialize)]
pub struct PostgreSQL {
  #[clap(long, env)]
  pub host: Option&lt;String&gt;,
}

#[derive(Parser, Debug)]
#[clap(author, version, about)]
#[clap(env_prefix)]
pub struct ConfigArgs {
  #[clap(flatten)]
  pub postgresql: PostgreSQL,
}
</code></pre>
<p>This mean host would have the env <code>{NAME}_POSTGRESQL_HOST</code>, if it's not possible it would be great to be able to use <code>env_prefix</code> more than one like:</p>
<pre><code class="language-rust">#[derive(Debug, Args, Deserialize)]
#[clap(env_prefix(name, struct_name))]
pub struct PostgreSQL {
  #[clap(long, env)]
  pub host: Option&lt;String&gt;,
}
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2022-05-20 12:22</div>
            <div class="timeline-body"><blockquote>
<p>It's would be amazing that flatten to do it automatically for example I would like:</p>
</blockquote>
<p>Note that my later post shifted this from being a derive feature to a builder feature which means it could work across <code>flatten</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../MaterializeInc/materialize/pulls/12765.html">MaterializeInc/materialize#12765</a> on 2022-05-30 13:14</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Maher4Ever">@Maher4Ever</a> on 2022-07-18 09:05</div>
            <div class="timeline-body"><p>@epage Is this planned to be implemented soon?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2022-07-18 12:29</div>
            <div class="timeline-body"><p>It has the <code>E-medium</code> tag which means the current design is accepted for moving forward.   However, my focus is on other area (iterating on the API for reducing binary size, reducing compile times, and improving flexibility).  If someone is willing to step up to implement it, I'd be willing to review and merge the PRs.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/eighty4">@eighty4</a> on 2023-02-28 21:29</div>
            <div class="timeline-body"><p>I've been using <code>#[arg(...)]</code> macro yet have seen use of <code>clap</code> interchangeably in other sources. Although it's not on docs.rs, switching out <code>arg</code> for <code>clap</code> works. However, neither <code>arg</code> nor <code>clap</code> permits an <code>env</code> flag (yet I've also seen <code>env</code> used in other sources). Quite confused!</p>
<p>Is there currently a way to permit a required option to be specified with an environment variable or is the environment variable feature included with <code>env_prefix</code>?</p>
<p>Here's an example of my current usage:</p>
<p>https://github.com/eighty4/cquill/blob/main/src/main.rs</p>
<p>Looking for this <code>env_prefix</code> feature led me to this ticket, hoping to have <code>CQUILL_CQL_DIR=</code> override the <code>--cql-dir</code> arg. Is this currently possible with an <code>env</code> flag that would support <code>CQL_DIR=</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2023-02-28 22:02</div>
            <div class="timeline-body"><blockquote>
<p>I've been using #[arg(...)] macro yet have seen use of clap interchangeably in other sources. Although it's not on docs.rs, switching out arg for clap works.</p>
</blockquote>
<p><code>clap</code> is deprecated in favor of the more specialized attributes</p>
<blockquote>
<p>However, neither arg nor clap permits an env flag (yet I've also seen env used in other sources). Quite confused!</p>
</blockquote>
<p>If you search on docs.rs, you will find <a href="https://docs.rs/clap/latest/clap/builder/struct.Arg.html#method.env"><code>Arg::env</code></a> which is documented as being behind the <code>env</code> feature flag.  If you run <code>cargo add clap -F env</code>, it should start to work.  As for any derive aspect of this documentation, see the <a href="https://github.com/clap-rs/clap/discussions/4090">discussion on the topic</a></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../cartesi/rollups/issues/27.html">cartesi/rollups#27</a> on 2023-04-20 01:55</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2023-08-01 00:57</div>
            <div class="timeline-body"><p>Alternatively, #5050 would allow doing this without any other new feature</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/5050.html">clap-rs/clap#5050</a> on 2023-08-01 01:06</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../surrealdb/surrealdb/issues/2696.html">surrealdb/surrealdb#2696</a> on 2023-09-14 17:04</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/4556.html">clap-rs/clap#4556</a> on 2023-11-09 16:11</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/SpiderUnderUrBed">@SpiderUnderUrBed</a> on 2025-04-01 10:00</div>
            <div class="timeline-body"><p>Any update? I think a env option as gibfahn suggested would be the easiest and best solution, I dont know how exactly #5050 would solve this.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:35:08 UTC
    </footer>
</body>
</html>
