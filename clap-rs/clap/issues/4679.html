<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ranged values for Vec&lt;usize&gt; or any number Vec type like 1-10 or 1..10 - clap-rs/clap #4679</title>
    <link rel="stylesheet" href="../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../index.html">Back to index</a>
    </div>

    <h1>Ranged values for Vec&lt;usize&gt; or any number Vec type like 1-10 or 1..10</h1>

    <div class="meta">
        <span class="state state-closed">Closed</span>
        <a href="https://github.com/clap-rs/clap/issues/4679">#4679</a>
        opened by <a href="https://github.com/Atreyagaurav">@Atreyagaurav</a>
        on 2023-01-27 19:12
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/Atreyagaurav">@Atreyagaurav</a> on 2023-01-27 19:12</div>
            <div class="timeline-body"><h3>Please complete the following tasks</h3>
<ul>
<li>[X] I have searched the <a href="https://github.com/clap-rs/clap/discussions">discussions</a></li>
<li>[X] I have searched the <a href="https://github.com/clap-rs/clap/issues">open</a> and <a href="https://github.com/clap-rs/clap/issues?q=is%3Aissue+label%3AS-wont-fix+is%3Aclosed">rejected</a> issues</li>
</ul>
<h3>Clap Version</h3>
<p>4.1.4</p>
<h3>Describe your use case</h3>
<p>I have a program that can skip certain lines based on their line numbers. Consider it similar to head command, but instead of just head 5 lines, it can also skip certain lines. I'm made it skip the line numbers provided to it.</p>
<p>For example if I do: <code>program --skip 1,3,4 file.csv</code> it'll skip lines 1,3 and 4, with <code>value_delimiter = ','</code> in the clap arg. Problem is if I want to skip a range support 1-5, I have to either make a different argument that takes a number and skips everything larger than or smaller than that number, or make it take a range separately and then parse it into a different variable. A way to just pass the numbers from CLI in the same argument would be perfect.</p>
<h3>Describe the solution you'd like</h3>
<p>The solution I'd like is a feauture in args like &quot;<code>expand_range</code> that you can set true&quot; or &quot;<code>range_delimiter</code> you can give a string&quot; and if it's a Vec number argument (or similar) then it'll expand the range from the input.</p>
<p>Just like how <code>value_delimiter</code> works. But those two should work in the same argument. For example: <code>1,4-10,15</code> should be expanded into <code>[1,4,5,6,7,8,9,10,15]</code>. If it's easy to implement only using rust syntax range <code>..</code> and <code>..=</code> works too. But it shouldn't be infinite.</p>
<pre><code>use clap::Parser;

#[derive(Parser)]
#[command(name = &quot;test&quot;)]
struct Cli {
    #[arg(short, long, value_delimiter = ',', range_delimiter='-')]
    lines: Vec&lt;usize&gt;,
}

fn main() {
    let args: Cli = Cli::parse();
    println!(&quot;{:?}&quot;, args.lines);
}
</code></pre>
<h3>Alternatives, if applicable</h3>
<p>Once you have the range character like <code>-</code>, you just have to split by the <code>range_delimiter</code> expand the range, and then flatten it.</p>
<pre><code>use clap::Parser;

#[derive(Parser)]
#[command(name = &quot;test&quot;)]
struct Cli {
    #[arg(short, long, value_delimiter = ',')]
    lines: Vec&lt;String&gt;,
}

fn main() {
    let args: Cli = Cli::parse();
    let lines: Vec&lt;usize&gt; = args
        .lines
        .iter()
        .map(|r| {
            let mut spl = r.split('-');
            let start: usize = spl.next().unwrap().parse().unwrap();
            if let Some(end) = spl.next() {
                (start..=end.parse().unwrap()).collect()
            } else {
                vec![start]
            }
        })
        .flatten()
        .collect();
    println!(&quot;{:?}&quot;, lines);
}
</code></pre>
<h3>Additional Context</h3>
<p><em>No response</em></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">C-enhancement</span> added by @Atreyagaurav on 2023-01-27 19:12</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2023-01-27 19:41</div>
            <div class="timeline-body"><p>What do you feel is the value of doing this natively within clap vs providing a function to <code>value_parser</code> that parses numbers and ranges?</p>
<p>For me, this feel specialized with a lot of potential customization when we are working to remove those in favor of general solutions to hep with #2037 and #1365</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Atreyagaurav">@Atreyagaurav</a> on 2023-01-31 21:59</div>
            <div class="timeline-body"><p>Providing function would work, but I considered this one of a common use case to get the vector of integers hence thought it might be better to implement from the clap side. But if there is the problem with reducing the overall size for compilation then I don't know. I'm not from CS so not that knowledgeable about that.</p>
<p>Maybe making these kind of functions into helper functions that you can include from the clap features might work to keep the main parser lightweight. But again those things are totally outside of my expertise.</p>
<p>Main reason I made this issue is because I thought &quot;there should be range feature, if there is delimiter for multiple values&quot;. But if you guys are working on keeping those things minimal, then feel free to ignore this.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2023-01-31 22:03</div>
            <div class="timeline-body"><p>If you feel this should be general, I'd recommend starting something like this out in a crate.  We can use that go gain interest to gauge if we should bring it into clap proper.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @epage on 2023-01-31 22:03</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Atreyagaurav">@Atreyagaurav</a> on 2023-02-04 04:14</div>
            <div class="timeline-body"><p>I made a package but couldn't figure out how to use it as a value parser for clap properly. I'd like it to parse the values into vector, then flatten that vector into the <code>arg.skip</code>.</p>
<p>My parser is here: https://github.com/Atreyagaurav/number_range</p>
<p>Cargo.toml</p>
<pre><code>[dependencies]
number_range = &quot;0.1.3&quot;
clap = { version = &quot;4.0&quot;, features = [&quot;derive&quot;] }
</code></pre>
<p>So the parser works as expected, with something like this:</p>
<pre><code>use clap::Parser;
use number_range::NumberRangeOptions;

#[derive(Parser)]
struct Cli {
    /// List of numbers for processing
    #[arg(
        short,
        long,
        value_name = &quot;N1,N2,…&quot;,
        // value_parser(number_range_parser)
    )]
    skip: String,
}

fn number_range_parser(num: &amp;str) -&gt; Result&lt;Vec&lt;usize&gt;, String&gt; {
    let mut rng_parser = NumberRangeOptions::default();
    let rng = rng_parser.with_range_sep('-').parse::&lt;usize&gt;(num)?;
    Ok(rng.collect())
}

fn main() {
    let cli: Cli = Cli::parse();
    println!(&quot;{:?}&quot;, number_range_parser(&amp;cli.skip));
}
</code></pre>
<p>Compiling and running:</p>
<pre><code>     Running `target/debug/clap-rng -s 1,3-5`
Ok([1, 3, 4, 5])
</code></pre>
<p>But trying to use it as <code>value_parser</code>:</p>
<pre><code>use clap::Parser;
use number_range::NumberRangeOptions;

#[derive(Parser)]
struct Cli {
    /// List of numbers for processing
    #[arg(short, long, value_name = &quot;N1,N2,…&quot;, value_parser(number_range_parser))]
    skip: Vec&lt;usize&gt;,
}

fn number_range_parser(num: &amp;str) -&gt; Result&lt;Vec&lt;usize&gt;, String&gt; {
    let mut rng_parser = NumberRangeOptions::default();
    let rng = rng_parser.with_range_sep('-').parse::&lt;usize&gt;(num)?;
    Ok(rng.collect())
}

fn main() {
    let cli: Cli = Cli::parse();
    println!(&quot;{:?}&quot;, cli.skip);
}
</code></pre>
<p>Gives this:</p>
<pre><code>     Running `target/debug/clap-rng -s 1,3-5`
thread 'main' panicked at 'Mismatch between definition and access of `skip`. Could not downcast to usize, need to downcast to alloc::vec::Vec&lt;usize&gt;
', src/main.rs:8:11
note: run with `RUST_BACKTRACE=1` environment variable to display a backtrace
</code></pre>
<p>Which seems to me like clap assumes since it's <code>Vec&lt;usize&gt;</code> it'll have multiple occurrences of that flag and the parser is only supposed to parse one of them. Even if I do <code>number_of_values(1)</code>, <code>num_args(1)</code> and <code>action(ArgAction::Set)</code> it still gives the same error. <code>multiple(false)</code> doesn't work in the <code>clap=&quot;4.0&quot;</code> not sure if that'd have fixed it.</p>
<p>Making it <code>skip: Vec&lt;Vec&lt;usize&gt;&gt;</code>, does give me <code>[[1, 3, 4, 5]]</code>, so the parser is working.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2023-02-06 15:49</div>
            <div class="timeline-body"><p>The problem is we need to look up the value with the right type and convert it to our type.  We have no attributes for this at the time (see #3912).  As for how to workaround it, we textually check that your type is <code>&quot;Vec&quot;</code>, so just doing <code>std::vec::Vec</code> will bypass it (see #4626)</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:28:34 UTC
    </footer>
</body>
</html>
