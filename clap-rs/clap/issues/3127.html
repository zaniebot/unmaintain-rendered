<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>`flatten` causes the wrong doc-comment to be respected - clap-rs/clap #3127</title>
    <link rel="stylesheet" href="../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../index.html">Back to index</a>
    </div>

    <h1>`flatten` causes the wrong doc-comment to be respected</h1>

    <div class="meta">
        <span class="state state-closed">Closed</span>
        <a href="https://github.com/clap-rs/clap/issues/3127">#3127</a>
        opened by <a href="https://github.com/epage">@epage</a>
        on 2021-12-09 16:17
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/epage">@epage</a> on 2021-12-09 16:17</div>
            <div class="timeline-body"><p><a href="https://github.com/epage"><img src="https://avatars.githubusercontent.com/u/60961?v=4" align="left" width="96" height="96" hspace="10"></img></a> <strong>Issue by <a href="https://github.com/epage">epage</a></strong>
<em>Thursday Jan 16, 2020 at 13:46 GMT</em>
<em>Originally opened as https://github.com/TeXitoi/structopt/issues/333</em></p>
<hr />
<p>With <code>clap-verbosity-flag</code> &quot;3.0.0&quot;</p>
<pre><code>use structopt::StructOpt;
use clap_verbosity_flag::Verbosity;

#[derive(Debug, StructOpt)]
/// Foo
struct Cli {
    #[structopt(flatten)]
    verbose: Verbosity,
}

fn main() {
    Cli::from_args();
}
</code></pre>
<p>will cause clap-verbosity-flag's documentation to be used for the help instead of the user-specified one</p>
<pre><code>‚ùØ ./target/debug/examples/simple --help
clap-verbosity-flag 0.3.0
Easily add a `--verbose` flag to CLIs using Structopt

# Examples

```rust use structopt::StructOpt; use clap_verbosity_flag::Verbosity;

/// Le CLI #[derive(Debug, StructOpt)] struct Cli { #[structopt(flatten)] verbose: Verbosity, } # # fn main() {} ```

USAGE:
    simple [FLAGS]

FLAGS:
    -h, --help
            Prints help information

    -q, --quiet
            Pass many times for less log output

    -V, --version
            Prints version information

    -v, --verbose
            Pass many times for more log output

            By default, it'll only report errors. Passing `-v` one time also prints warnings, `-vv` enables info
            logging, `-vvv` debug, and `-vvvv` trace.
</code></pre>
<p>I am working around it in clap-verbosity-flag by. not providing a doc comment (https://github.com/rust-cli/clap-verbosity-flag/pull/21).</p>
<p>A workaround is explained in https://github.com/TeXitoi/structopt/issues/333#issuecomment-712265332</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2021-12-09 16:17</div>
            <div class="timeline-body"><p><a href="https://github.com/epage"><img src="https://avatars.githubusercontent.com/u/60961?v=4" align="left" width="48" height="48" hspace="10"></img></a> <strong>Comment by <a href="https://github.com/epage">epage</a></strong>
<em>Thursday Jan 16, 2020 at 13:46 GMT</em></p>
<hr />
<p>Based on reports (https://github.com/rust-cli/clap-verbosity-flag/issues/20) I'm guessing  https://github.com/TeXitoi/structopt/commit/e2270deae2c9b930541afecd4c28f41ddd1d669b broke this</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2021-12-09 16:17</div>
            <div class="timeline-body"><p><a href="https://github.com/CreepySkeleton"><img src="https://avatars.githubusercontent.com/u/50968528?v=4" align="left" width="48" height="48" hspace="10"></img></a> <strong>Comment by <a href="https://github.com/CreepySkeleton">CreepySkeleton</a></strong>
<em>Thursday Jan 16, 2020 at 15:23 GMT</em></p>
<hr />
<blockquote>
<p>will cause clap-verbosity-flag's documentation to be used for the help instead of the user-specified one</p>
</blockquote>
<p>But there's no user specified help here as far as I can see üòï</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2021-12-09 16:17</div>
            <div class="timeline-body"><p><a href="https://github.com/epage"><img src="https://avatars.githubusercontent.com/u/60961?v=4" align="left" width="48" height="48" hspace="10"></img></a> <strong>Comment by <a href="https://github.com/epage">epage</a></strong>
<em>Thursday Jan 16, 2020 at 15:24 GMT</em></p>
<hr />
<pre><code class="language-rust">/// Foo
struct Cli {
</code></pre>
<p>The user's doc-comment is being overridden by the doc-comment from the chain.  Instead of &quot;Foo&quot;, we're getting library documentation</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2021-12-09 16:17</div>
            <div class="timeline-body"><p><a href="https://github.com/CreepySkeleton"><img src="https://avatars.githubusercontent.com/u/50968528?v=4" align="left" width="48" height="48" hspace="10"></img></a> <strong>Comment by <a href="https://github.com/CreepySkeleton">CreepySkeleton</a></strong>
<em>Wednesday Jan 22, 2020 at 13:30 GMT</em></p>
<hr />
<p>This is caused by #290 since doc comments on top of struct/enum are top level attributes too :(</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2021-12-09 16:17</div>
            <div class="timeline-body"><p><a href="https://github.com/ssokolow"><img src="https://avatars.githubusercontent.com/u/46915?v=4" align="left" width="48" height="48" hspace="10"></img></a> <strong>Comment by <a href="https://github.com/ssokolow">ssokolow</a></strong>
<em>Monday Jun 22, 2020 at 21:31 GMT</em></p>
<hr />
<p>I just noticed that this also causes the doc comment on my boilerplate opts (which get flattened into the main struct) to override the <code>about</code> attribute on the main struct.</p>
<p>I'm really starting to feel like I need to write a regression/integration suite on my <code>--help</code> output just to feel safe using <code>--help</code> generation.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2021-12-09 16:17</div>
            <div class="timeline-body"><p><a href="https://github.com/pizzamig"><img src="https://avatars.githubusercontent.com/u/57148?v=4" align="left" width="48" height="48" hspace="10"></img></a> <strong>Comment by <a href="https://github.com/pizzamig">pizzamig</a></strong>
<em>Wednesday Jul 22, 2020 at 19:29 GMT</em></p>
<hr />
<blockquote>
<p>This is caused by #290 since doc comments on top of struct/enum are top level attributes too :(</p>
</blockquote>
<p>Is there any update or way to fix this?
Currently I cannot document a struct and re-use it flattened and the workaround to move documentation to the lib doesn't work for me now, it would require quite some changes in my code.</p>
<p>The complexity of structopt is too high for me right now to try to find a fix.</p>
<p>thanks in advance</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2021-12-09 16:17</div>
            <div class="timeline-body"><p><a href="https://github.com/CreepySkeleton"><img src="https://avatars.githubusercontent.com/u/50968528?v=4" align="left" width="48" height="48" hspace="10"></img></a> <strong>Comment by <a href="https://github.com/CreepySkeleton">CreepySkeleton</a></strong>
<em>Wednesday Jul 22, 2020 at 20:49 GMT</em></p>
<hr />
<p>I tried to fix it. I couldn't. I'll take another round a bit later.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2021-12-09 16:17</div>
            <div class="timeline-body"><p><a href="https://github.com/vorner"><img src="https://avatars.githubusercontent.com/u/11783500?v=4" align="left" width="48" height="48" hspace="10"></img></a> <strong>Comment by <a href="https://github.com/vorner">vorner</a></strong>
<em>Saturday Oct 17, 2020 at 09:22 GMT</em></p>
<hr />
<p>Hello</p>
<p>I guess the ‚Äûproper‚Äú way to fix it will be hard and will take time (I'm not sure if reordering the calls inside the <code>StructOptInternal::augment_clap</code> to call these after descending into flattened fields instead of at the beginning would work ‚Äí it seems <code>version</code> is called at the end, so possibly the <code>.about</code> and similar could too?).</p>
<p>But if it is hard, would it make sense to add some kind of <code>#[no_about]</code> parameter that would skip all the auto-generated application information, like <code>about</code> and <code>version</code>? I guess most people know that a struct will be used as flattened field and could annotate them.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2021-12-09 16:17</div>
            <div class="timeline-body"><p><a href="https://github.com/TeXitoi"><img src="https://avatars.githubusercontent.com/u/5787066?v=4" align="left" width="48" height="48" hspace="10"></img></a> <strong>Comment by <a href="https://github.com/TeXitoi">TeXitoi</a></strong>
<em>Saturday Oct 17, 2020 at 10:30 GMT</em></p>
<hr />
<p>By default, there is no about, but doc comment are <code>about</code>, so the workaround would be no doc comment on these structs.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2021-12-09 16:17</div>
            <div class="timeline-body"><p><a href="https://github.com/vorner"><img src="https://avatars.githubusercontent.com/u/11783500?v=4" align="left" width="48" height="48" hspace="10"></img></a> <strong>Comment by <a href="https://github.com/vorner">vorner</a></strong>
<em>Saturday Oct 17, 2020 at 10:40 GMT</em></p>
<hr />
<p>I've figured that, but it is kind of bad for structs provided by libraries. I want to have doc comment to render on <a href="https://docs.rs">docs.rs</a>, I also tend to <code>#[warn(missing_docs)]</code>. But then <code>structdoc</code> tries to interpret it and hijacks it if someone flattens the structure into their top-level <code>Opts</code> structure, which is bad.</p>
<p>But as the author of the library I know my struct should not be used directly and that it should never provide the <code>about</code> and <code>--version</code>. I want to mark it as just a source of more fields, not to do anything with the <code>App</code> at all.</p>
<p>https://docs.rs/spirit-daemonize/0.3.2/spirit_daemonize/struct.Opts.html</p>
<p>Maybe the right name would be <code>#[ignore_doc_comment]</code> or <code>#[flattenable]</code> or like that? Or is this orthogonal to this bug?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2021-12-09 16:17</div>
            <div class="timeline-body"><p><a href="https://github.com/vorner"><img src="https://avatars.githubusercontent.com/u/11783500?v=4" align="left" width="48" height="48" hspace="10"></img></a> <strong>Comment by <a href="https://github.com/vorner">vorner</a></strong>
<em>Monday Oct 19, 2020 at 15:59 GMT</em></p>
<hr />
<p>Just for the record, I've figured a workaround that keeps them for the docs.rs, but doesn't hijacks them for the about:</p>
<pre><code>#[cfg_attr(not(doc), allow(missing_docs))]
#[cfg_attr(doc, doc = r#&quot;
The doc comment goes here

Following the doc comment
&quot;#)]
</code></pre>
<p>It simply enables the doc comment only for the documentation generation (and seems to work with doc tests too)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2021-12-09 16:17</div>
            <div class="timeline-body"><p><a href="https://github.com/TeXitoi"><img src="https://avatars.githubusercontent.com/u/5787066?v=4" align="left" width="48" height="48" hspace="10"></img></a> <strong>Comment by <a href="https://github.com/TeXitoi">TeXitoi</a></strong>
<em>Monday Oct 19, 2020 at 16:36 GMT</em></p>
<hr />
<p>I've put a link to your workaround in the description of the issue for ease of access.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">A-derive</span> added by @epage on 2021-12-09 16:30</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">C-bug</span> added by @epage on 2021-12-09 16:30</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/3129.html">clap-rs/clap#3129</a> on 2021-12-09 16:36</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2021-12-10 20:06</div>
            <div class="timeline-body"><p>Assuming this is a valid reproduction case, this is fixed</p>
<pre><code class="language-rust">use clap::StructOpt;

#[derive(Debug, StructOpt)]
#[structopt(name = &quot;structopt-bug&quot;, about = &quot;Show a bug in Structopt&quot;)]
struct Opt {
    #[structopt(flatten)]
    v: Verbose,
}

/// Re-usable Verbose flag
#[derive(Debug, StructOpt)]
struct Verbose {
    /// Enable the verbosity messages
    #[structopt(short)]
    verbose: bool,
}
fn main() {
    let opt = Opt::from_args();
    println!(&quot;{:?}&quot;, opt);
}
</code></pre>
<pre><code>structopt-bug 

Show a bug in Structopt

USAGE:
    test-clap [OPTIONS]

OPTIONS:
    -h, --help    Print help information
    -v            Enable the verbosity messages
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @epage on 2021-12-10 20:06</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2021-12-10 20:07</div>
            <div class="timeline-body"><p>To add, we still have https://github.com/clap-rs/clap/issues/2983 which is about about/long_about interactions being weird</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:28:33 UTC
    </footer>
</body>
</html>
