<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Optional positional arguments that get skipped if corresponding validation fails - clap-rs/clap #2122</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Optional positional arguments that get skipped if corresponding validation fails</h1>

    <div class="meta">
        <span class="state state-open">Open</span>
        <a href="https://github.com/clap-rs/clap/issues/2122">#2122</a>
        opened by <a href="https://github.com/ducaale">@ducaale</a>
        on 2020-09-01 18:51
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/ducaale">@ducaale</a> on 2020-09-01 18:51</div>
            <div class="timeline-body"><h3>Describe your use case</h3>
<p>I am trying re-implement <a href="https://httpie.org/">HTTPie</a> cli using clap-rs/structopt. I would like to have something like this</p>
<pre><code>yahc.exe [METHOD] &lt;URL&gt; [REQUEST_ITEM]...
</code></pre>
<p>where <code>METHOD</code> is an optional positional arg enum with a default value</p>
<h3>Describe the solution you'd like</h3>
<p>It would be good if clap-rs allowed multiple optional positional arguments that get filled with a default value whenever the corresponding value fails to parse. For example, if we had:</p>
<pre><code>test.exe [arg1] [arg2] [arg3]...
</code></pre>
<p>where:</p>
<ul>
<li><code>arg1</code> has a type of <code>enum Arg1 { Foo, Bar }</code> and defaults to <code>Arg1::Bar</code></li>
<li><code>arg2</code> has a type of <code>u32</code> and defaults to 0</li>
<li><code>arg3</code> has a type of <code>Vec&lt;String&gt;</code></li>
</ul>
<p>a user can use the CLI app in the following ways:</p>
<ul>
<li><code>test.exe</code>: <code>arg1</code> = <code>default_value</code>, <code>arg2</code> = <code>default_value</code>, <code>arg3</code> = <code>default_value</code></li>
<li><code>test.exe foo</code>: <code>arg1</code> = <code>foo</code>, <code>arg2</code> = <code>default_value</code>, <code>arg3</code> = <code>default_value</code></li>
<li><code>test.exe 1</code>: <code>arg1</code> = <code>default_value</code>, <code>arg2</code> = <code>1</code>, <code>arg3</code> = <code>default_value</code></li>
<li><code>test.exe hello</code>: <code>arg1</code> = <code>default_value</code>, <code>arg2</code> = <code>default_value</code>, <code>arg3</code> = <code>[hello]</code></li>
<li><code>test.exe foo hello</code>: <code>arg1</code> = <code>foo</code>, <code>arg2</code> = <code>default_value</code>, <code>arg3</code> = <code>[hello]</code></li>
</ul>
<h3>Alternatives, if applicable</h3>
<p>I tried using the following but they didn't fit my use case:</p>
<ul>
<li><code>AllowMissingPositional</code> can only be used when the last positional argument is required</li>
<li>optional subcommands cannot be followed by positional args if the subcommand is omitted</li>
</ul>
<h3>Additional context</h3>
<p>https://github.com/clap-rs/clap/discussions/2120</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">T: new feature</span> added by @ducaale on 2020-09-01 18:51</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">C: parsing</span> added by @pksunkara on 2020-09-01 18:52</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">D: medium</span> added by @pksunkara on 2020-09-01 18:52</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">C: validators</span> added by @CreepySkeleton on 2020-09-15 10:40</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../TeXitoi/structopt/issues/430.html">TeXitoi/structopt#430</a> on 2020-09-15 10:47</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../ducaale/xh/issues/2.html">ducaale/xh#2</a> on 2020-12-04 20:38</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../ridhoq/af/pulls/2.html">ridhoq/af#2</a> on 2021-02-08 06:48</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/pksunkara">@pksunkara</a> on 2021-05-20 18:28</div>
            <div class="timeline-body"><p>Might be related to #975</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../epage/clapng/issues/164.html">epage/clapng#164</a> on 2021-12-06 20:18</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">T: new feature</span> removed by @epage on 2021-12-08 21:12</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">C-enhancement</span> added by @epage on 2021-12-08 21:12</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">D: medium</span> removed by @epage on 2021-12-10 22:26</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2021-12-13 15:02</div>
            <div class="timeline-body"><p>This is reminding me of https://github.com/clap-rs/clap/discussions/3035</p>
<p>Currently, value validation happens in a distinct phase.  We are looking at modifying it so people are more likely to put in more type information, see https://github.com/clap-rs/clap/issues/2683.</p>
<p>Granted, relying on value validation can only work in fairly limited cases.</p>
<p>Personally, I think I'd provide custom usage statements and parse as all <code>Vec&lt;String&gt;</code>.  You can get clap like errors now with <code>App::error</code>.</p>
<p>I am curious how HTTPie, an app built on argparse, is doing this.  Understanding other parsers provides us opportunities to learn from others rather than reinvent the wheel.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">S-waiting-on-design</span> added by @epage on 2021-12-13 15:03</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ducaale">@ducaale</a> on 2021-12-13 17:08</div>
            <div class="timeline-body"><blockquote>
<p>Personally, I think I'd provide custom usage statements and parse as all Vec<String>. You can get clap like errors now with App::error.</p>
</blockquote>
<p>Yes. In the end, we ended up with something like that</p>
<pre><code class="language-rust">#[derive(StructOpt, Debug)]
#[structopt(
    name = &quot;xh&quot;,
    long_version = long_version(),
    settings = &amp;[
        AppSettings::AllArgsOverrideSelf,
    ],
)]
pub struct Cli {
 
    /// HTTP version to use
    #[structopt(long, value_name = &quot;VERSION&quot;, possible_values = &amp;[&quot;1&quot;, &quot;1.0&quot;, &quot;1.1&quot;, &quot;2&quot;])]
    pub http_version: Option&lt;HttpVersion&gt;,

    /// The request URL, preceded by an optional HTTP method.
    ///
    /// METHOD can be `get`, `post`, `head`, `put`, `patch`, `delete` or `options`.
    /// If omitted, either a GET or a POST will be done depending on whether the
    /// request sends data.
    /// {n}{n}{n}
    #[structopt(value_name = &quot;[METHOD] URL&quot;)]
    raw_method_or_url: String,

    /// Optional key-value pairs to be included in the request
    ///
    ///   - key==value to add a parameter to the URL
    ///   - key=value to add a JSON field (--json) or form field (--form)
    ///   - key:=value to add a complex JSON value (e.g. `numbers:=[1,2,3]`)
    ///   - key@filename to upload a file from filename (with --form)
    ///   - @filename to use a file as the request body
    ///   - header:value to add a header
    ///   - header: to unset a header
    ///   - header; to add a header with an empty value
    ///
    /// A backslash can be used to escape special characters (e.g. weird\:key=value).
    #[structopt(value_name = &quot;REQUEST_ITEM&quot;, verbatim_doc_comment)]
    raw_rest_args: Vec&lt;String&gt;,

    /// The HTTP method, if supplied.
    #[structopt(skip)]
    pub method: Option&lt;Method&gt;,

    /// The request URL.
    #[structopt(skip = (&quot;http://placeholder&quot;.parse::&lt;Url&gt;().unwrap()))]
    pub url: String,

    /// Optional key-value pairs to be included in the request.
    #[structopt(skip)]
    pub request_items: RequestItems,
}
</code></pre>
<p>Notice how <code>method</code>, <code>url</code>, and <code>request_items</code> are all skipped. Later, we are parsing the <code>raw_rest_args</code> and filling any skipped args as appropriate.</p>
<pre><code class="language-rust">pub fn from_iter_safe&lt;I&gt;(iter: I) -&gt; clap::Result&lt;Self&gt;
where
    I: IntoIterator,
    I::Item: Into&lt;OsString&gt; + Clone,
{
    let mut app = Self::clap();
    let matches = app.get_matches_from_safe_borrow(iter)?;
    let mut cli = Self::from_clap(&amp;matches);

    let mut rest_args = mem::take(&amp;mut cli.raw_rest_args).into_iter();
    let raw_url = match parse_method(&amp;cli.raw_method_or_url) {
        Some(method) =&gt; {
            cli.method = Some(method);
            rest_args.next().ok_or_else(|| {
                Error::with_description(&quot;Missing URL&quot;, ErrorKind::MissingArgumentOrSubcommand)
            })?
        }
        None =&gt; {
            cli.method = None;
            mem::take(&amp;mut cli.raw_method_or_url)
        }
    };
    for request_item in rest_args {
        cli.request_items.items.push(request_item.parse()?);
    }
}
</code></pre>
<p>This is the file that contains all sorts of workarounds around structopt/clap: https://github.com/ducaale/xh/blob/master/src/cli.rs</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/1761.html">clap-rs/clap#1761</a> on 2022-11-08 04:44</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../ducaale/xh/pulls/393.html">ducaale/xh#393</a> on 2025-01-05 12:37</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/6105.html">clap-rs/clap#6105</a> on 2025-08-15 13:50</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:35:07 UTC
    </footer>
</body>
</html>
