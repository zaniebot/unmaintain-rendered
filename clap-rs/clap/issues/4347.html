<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>clap4 requires that options implement `Send` and `Sync` - clap-rs/clap #4347</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>clap4 requires that options implement `Send` and `Sync`</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/clap-rs/clap/issues/4347">#4347</a>
        opened by <a href="https://github.com/alexcrichton">@alexcrichton</a>
        on 2022-10-04 15:20
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/alexcrichton">@alexcrichton</a> on 2022-10-04 15:20</div>
            <div class="timeline-body"><p>Maintainer's notes</p>
<ul>
<li>For Clone, see #4286</li>
</ul>
<hr />
<h3>Please complete the following tasks</h3>
<ul>
<li>[X] I have searched the <a href="https://github.com/clap-rs/clap/discussions">discussions</a></li>
<li>[X] I have searched the <a href="https://github.com/clap-rs/clap/issues">open</a> and <a href="https://github.com/clap-rs/clap/issues?q=is%3Aissue+label%3AS-wont-fix+is%3Aclosed">rejected</a> issues</li>
</ul>
<h3>Rust Version</h3>
<p>rustc 1.64.0 (a55dd71d5 2022-09-19)</p>
<h3>Clap Version</h3>
<p>3.2.22 and  4.0.9</p>
<h3>Minimal reproducible code</h3>
<pre><code class="language-rust">use std::cell::Cell;

fn main() {}

fn parse_option(_: &amp;str) -&gt; Result&lt;Cell&lt;u32&gt;, Box&lt;dyn std::error::Error + Send + Sync&gt;&gt; {
    loop {}
}

mod clap3 {
    use clap3 as clap;
    use std::cell::Cell;

    #[derive(clap::Parser)]
    struct MyApp {
        #[clap(long, parse(try_from_str = super::parse_option))]
        option: Cell&lt;u32&gt;,
    }
}

mod clap4 {
    use clap4 as clap;
    use std::cell::Cell;

    #[derive(clap::Parser)]
    struct MyApp {
        #[clap(long, value_parser = super::parse_option)]
        option: Cell&lt;u32&gt;,
    }
}
</code></pre>
<h3>Steps to reproduce the bug with the above code</h3>
<p>With this manifest:</p>
<pre><code class="language-toml">[package]
name = &quot;tmp&quot;
version = &quot;0.1.0&quot;
edition = &quot;2021&quot;

[dependencies]
clap3 = { version = &quot;3&quot;, features = [&quot;derive&quot;], package = 'clap' }
clap4 = { version = &quot;4&quot;, features = [&quot;derive&quot;], package = 'clap' }
</code></pre>
<p>run <code>cargo build</code></p>
<h3>Actual Behaviour</h3>
<p>The <code>clap4</code> module fails to compile but the <code>clap3</code> module succeeds.</p>
<h3>Expected Behaviour</h3>
<p>This application has no need to require that <code>MyApp</code> is either <code>Send</code> or <code>Sync</code> hence the usage off <code>Cell</code>, and ideally upgrading to clap 4 would preserve the ability to have this same type structure in options.</p>
<h3>Additional Context</h3>
<p><em>No response</em></p>
<h3>Debug Output</h3>
<p>No extra output is printed at this time. (this is a compile error not a runtime error)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">C-bug</span> added by @alexcrichton on 2022-10-04 15:20</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2022-10-04 15:32</div>
            <div class="timeline-body"><p>This is a byproduct of the value parser work we did in clap 3.2.  We were wanting to overhaul how part of the derive worked, including parsing only once rather than once for validation and once to store in the struct.  As part of this, we moved the relevant processing down into <a href="https://docs.rs/clap/latest/clap/struct.ArgMatches.html">ArgMatches</a>.  As <code>ArgMatches</code> is <code>Clone + Send + Sync</code>, we had to force these traits onto the derived field types during clap 3.2.  Since then, we have only received feedback on <code>Clone</code> which we are fairly limited on resolving.</p>
<p>If there is interest in relaxing <code>Send + Sync</code>, we can look into that for clap v5.  The hard part will be understanding how important those traits are for builder users.  I was already surprised when we <a href="https://github.com/clap-rs/clap/issues/3876">accidentally removed an auto-trait I had never heard of and broke people</a></p>
<p>It'd be great if we could come up with a &quot;choose your own adventure / constraints&quot; API so the derive would require the minimal constraints while users can opt-in to greater constraints.  As a feature flag, <code>clone</code> wouldn't work because adding it both adds constraints and removes constraints, so its breaking as either <code>clone</code> or <code>no_clone</code> (I also am wanting to keep feature flags to a minimum since they aren't always easy to work with).</p>
<p>Another option is if we can come up with a design for #3912, then users can workaround this by separating out what the parsed type is (<code>u32</code>) from the stored type (<code>Cell&lt;u32&gt;</code>).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">A-derive</span> added by @epage on 2022-10-04 15:33</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">S-waiting-on-design</span> added by @epage on 2022-10-04 15:33</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/4286.html">clap-rs/clap#4286</a> on 2022-10-04 16:24</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../bytecodealliance/wasm-tools/pulls/789.html">bytecodealliance/wasm-tools#789</a> on 2022-10-04 17:55</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/4995.html">clap-rs/clap#4995</a> on 2023-07-05 15:22</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 01:35:12 UTC
    </footer>
</body>
</html>
