<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Switch native completions to encourage env var initialization - clap-rs/clap #3930</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Switch native completions to encourage env var initialization</h1>

    <div class="meta">
        <span class="state state-closed">Closed</span>
        <a href="https://github.com/clap-rs/clap/issues/3930">#3930</a>
        opened by <a href="https://github.com/epage">@epage</a>
        on 2022-07-13 22:37
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/epage">@epage</a> on 2022-07-13 22:37</div>
            <div class="timeline-body"><p>Maintainer's notes</p>
<p>We should document each solution (flag, subcommand, env var) and the trade offs.  We should probably make env variable the default.</p>
<hr />
<h3>Discussed in https://github.com/clap-rs/clap/discussions/3926</h3>
<div type='discussions-op-text'>

<p><sup>Originally posted by <strong>AndreasBackx</strong> July 13, 2022</sup>
We have a nice macro that automatically adds autocomplete to your Clap CLI. We are currently doing this via a subcommand <code>generate-completions</code>. Though we realise that this approach makes it impossible to automatically generate completions for certain CLIs:</p>
<pre><code class="language-rust">#[derive(Parser, Debug)]
pub struct Args {
    foo: String,
}
</code></pre>
<p>Imagine we have that very simple CLI and we want to add a subcommand. <code>foo</code> is a required argument so if we want to automate the autocomplete generation by adding <code>eval $(cli generate-completions)</code> or by exporting it to <code>/usr/share/bash-completion/completions/cli</code> for Bash, the CLI will complain that <code>foo</code> wasn't passed.</p>
<p>Therefore it seems right now that we should avoid depending on Clap parsing as part of autocomplete generation. Perhaps the people at Click realised this earlier as that is what they are doing: https://click.palletsprojects.com/en/8.1.x/shell-completion/.</p>
<p>So I have a few questions that spring from this:</p>
<ol>
<li>Is my understanding correct? Would love to hear there might be a mistake.</li>
<li>What do you think of the solution, can you perhaps think of another solution?</li>
<li>Should the documentations surrounding this perhaps be updated?</li>
<li>With this in mind, perhaps we could integrate clap_complete into clap as a feature? If enabled, you can get autocomplete automatically in your CLI in a similar way to Click.</li>
</ol>
<p><em>Funnily enough we didn't initially face this problem because of how <code>command_for_update</code> sets required to false, see #3924.</em></div></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">C-enhancement</span> added by @epage on 2022-07-13 22:37</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">A-docs</span> added by @epage on 2022-07-13 22:37</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">A-completion</span> added by @epage on 2022-07-13 22:37</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">E-easy</span> added by @epage on 2022-07-13 22:37</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2024-08-10 02:43</div>
            <div class="timeline-body"><p>We now offer a subcommand for rust-native completions.  Closing in favor of that.  Stabilizing this is tracked in #3166</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @epage on 2024-08-10 02:43</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Reopened by @epage on 2024-08-10 12:02</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2024-08-10 12:07</div>
            <div class="timeline-body"><p>As we are no longer documenting but providing a solution, I'm going to repurpose this to change native completions to use the env variable approach</p>
<ul>
<li>Good for performance:; don't need to go through application initialization, <code>Command</code> initialization, etc</li>
<li>Good for build times / implementation complexity: we don't need to use the derive or hand implement the derive traits</li>
</ul>
<p>What we could do is offer both approaches, each behind a feature.</p>
<p>Steps</p>
<ol>
<li>Re-organize <code>shells/</code> where all shells are in <code>shells.rs</code> and the trait, trait impls, complete args, complete commands are in a <code>cmd.rs</code></li>
<li>Add a <code>impl&lt;F: Fn() -&gt; Command&gt; CommandFactory for F</code></li>
<li>Add an <code>env.rs</code> with a builder for env var handling that takes an env var and a <code>CommandFactory</code> type, and a <code>try_eval</code> and a <code>eval</code></li>
<li>Put Each of the above behind a feature</li>
</ol>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "Document different options for activating completions" to "Switch native completions to encourage env var initialization" by @epage on 2024-08-10 12:07</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/3166.html">clap-rs/clap#3166</a> on 2024-08-10 12:07</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/5671.html">clap-rs/clap#5671</a> on 2024-08-12 16:17</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @epage on 2024-08-12 16:54</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:35:08 UTC
    </footer>
</body>
</html>
