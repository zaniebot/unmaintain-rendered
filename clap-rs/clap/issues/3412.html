<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Derive ArgGroup errors when arguments take values - clap-rs/clap #3412</title>
    <link rel="stylesheet" href="../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../index.html">Back to index</a>
    </div>

    <h1>Derive ArgGroup errors when arguments take values</h1>

    <div class="meta">
        <span class="state state-closed">Closed</span>
        <a href="https://github.com/clap-rs/clap/issues/3412">#3412</a>
        opened by <a href="https://github.com/malthesr">@malthesr</a>
        on 2022-02-07 14:46
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/malthesr">@malthesr</a> on 2022-02-07 14:46</div>
            <div class="timeline-body"><h3>Please complete the following tasks</h3>
<ul>
<li>[X] I have searched the <a href="https://github.com/clap-rs/clap/discussions">discussions</a></li>
<li>[X] I have searched the <a href="https://github.com/clap-rs/clap/issues">open</a> and <a href="https://github.com/clap-rs/clap/issues?q=is%3Aissue+label%3AS-wont-fix+is%3Aclosed">rejected</a> issues</li>
</ul>
<h3>Rust Version</h3>
<p>rustc 1.58.1 (db9d1b20b 2022-01-20)</p>
<h3>Clap Version</h3>
<p>3.0.14</p>
<h3>Minimal reproducible code</h3>
<pre><code class="language-rust">use std::path::PathBuf;

use clap::{ArgGroup, Parser};

#[derive(Debug, Parser)]
#[clap(group(ArgGroup::new(&quot;mygroup&quot;).required(true)))]
struct Cli {
    #[clap(long, group = &quot;mygroup&quot;)]
    mypath: PathBuf,

    #[clap(long, group = &quot;mygroup&quot;)]
    myusize: usize,
}

fn main() {
    let cli = Cli::parse();

    println!(&quot;{cli:#?}&quot;);
}
</code></pre>
<h3>Steps to reproduce the bug with the above code</h3>
<pre><code class="language-shell">cargo run -- --myusize 1
</code></pre>
<h3>Actual Behaviour</h3>
<p>When I run <code>cargo run -- --myusize 1</code>, <code>clap</code> reports the following error:</p>
<pre><code>error: The following required arguments were not provided:

USAGE:
    playground &lt;--mypath &lt;MYPATH&gt;|--myusize &lt;MYUSIZE&gt;&gt;

For more information try --help
</code></pre>
<p>The same happens if I run <code>cargo run -- --mypath some/path</code>.</p>
<h3>Expected Behaviour</h3>
<p>I thought this would create a group such that <code>--myusize</code> could be set, or <code>--mypath</code> could be set, but not neither and not both. Instead, it fails if neither is set, if exactly one of them is set, or if both are set.</p>
<p>The error reported by clap also seems to miss some context: it says the &quot;following&quot; required arguments were not provided, but lists none.</p>
<h3>Additional Context</h3>
<p>This seems to work as expected with <code>bool</code>, as also demonstrated by the relevant example <a href="https://github.com/clap-rs/clap/blob/master/examples/tutorial_derive/04_03_relations.rs"><code>clap/04_03_relations.rs</code></a>. E.g., the following version seems to work as I'd expect (except of course that I can't provide any values):</p>
<pre><code class="language-rust">use clap::{ArgGroup, Parser};

#[derive(Debug, Parser)]
#[clap(group(ArgGroup::new(&quot;mygroup&quot;).required(true)))]
struct Cli {
    #[clap(long, group = &quot;mygroup&quot;)]
    mypath: bool,

    #[clap(long, group = &quot;mygroup&quot;)]
    myusize: bool,
}

fn main() {
    let cli = Cli::parse();

    println!(&quot;{cli:#?}&quot;);
}
</code></pre>
<h3>Debug Output</h3>
<pre><code>[            clap::build::app] 	App::_do_parse
[            clap::build::app] 	App::_build
[            clap::build::app] 	App::_propagate:playground
[            clap::build::app] 	App::_check_help_and_version
[            clap::build::app] 	App::_check_help_and_version: Removing generated version
[            clap::build::app] 	App::_propagate_global_args:playground
[            clap::build::app] 	App::_derive_display_order:playground
[clap::build::app::debug_asserts] 	App::_debug_asserts
[clap::build::arg::debug_asserts] 	Arg::_debug_asserts:help
[clap::build::arg::debug_asserts] 	Arg::_debug_asserts:mypath
[clap::build::arg::debug_asserts] 	Arg::_debug_asserts:myusize
[clap::build::app::debug_asserts] 	App::_verify_positionals
[         clap::parse::parser] 	Parser::get_matches_with
[         clap::parse::parser] 	Parser::get_matches_with: Begin parsing 'RawOsStr(&quot;--myusize&quot;)' ([45, 45, 109, 121, 117, 115, 105, 122, 101])
[         clap::parse::parser] 	Parser::get_matches_with: Positional counter...1
[         clap::parse::parser] 	Parser::get_matches_with: Low index multiples...false
[         clap::parse::parser] 	Parser::possible_subcommand: arg=RawOsStr(&quot;--myusize&quot;)
[         clap::parse::parser] 	Parser::get_matches_with: sc=None
[         clap::parse::parser] 	Parser::parse_long_arg
[         clap::parse::parser] 	Parser::parse_long_arg: cur_idx:=1
[         clap::parse::parser] 	Parser::parse_long_arg: Does it contain '='...
[         clap::parse::parser] 	No
[         clap::parse::parser] 	Parser::parse_long_arg: Found valid opt or flag '--myusize &lt;MYUSIZE&gt;'
[         clap::parse::parser] 	Parser::parse_long_arg: Found an opt with value 'None'
[         clap::parse::parser] 	Parser::parse_opt; opt=myusize, val=None
[         clap::parse::parser] 	Parser::parse_opt; opt.settings=ArgFlags(REQUIRED | TAKES_VAL)
[         clap::parse::parser] 	Parser::parse_opt; Checking for val...
[         clap::parse::parser] 	Parser::parse_opt: More arg vals required...
[         clap::parse::parser] 	Parser::remove_overrides: id=myusize
[    clap::parse::arg_matcher] 	ArgMatcher::inc_occurrence_of_arg: id=myusize
[            clap::build::app] 	App::groups_for_arg: id=myusize
[    clap::parse::arg_matcher] 	ArgMatcher::inc_occurrence_of_group: id=mygroup
[            clap::build::app] 	App::groups_for_arg: id=myusize
[         clap::parse::parser] 	Parser::get_matches_with: After parse_long_arg Opt(myusize)
[         clap::parse::parser] 	Parser::get_matches_with: Begin parsing 'RawOsStr(&quot;1&quot;)' ([49])
[         clap::parse::parser] 	Parser::get_matches_with: Positional counter...1
[         clap::parse::parser] 	Parser::get_matches_with: Low index multiples...false
[         clap::parse::parser] 	Parser::add_val_to_arg; arg=myusize, val=RawOsStr(&quot;1&quot;)
[         clap::parse::parser] 	Parser::add_val_to_arg; trailing_values=false, DontDelimTrailingVals=false
[         clap::parse::parser] 	Parser::add_single_val_to_arg: adding val...&quot;1&quot;
[         clap::parse::parser] 	Parser::add_single_val_to_arg: cur_idx:=2
[            clap::build::app] 	App::groups_for_arg: id=myusize
[    clap::parse::arg_matcher] 	ArgMatcher::needs_more_vals: o=myusize
[      clap::parse::validator] 	Validator::validate
[         clap::parse::parser] 	Parser::add_defaults
[         clap::parse::parser] 	Parser::add_defaults:iter:mypath:
[         clap::parse::parser] 	Parser::add_value: doesn't have conditional defaults
[         clap::parse::parser] 	Parser::add_value:iter:mypath: doesn't have default vals
[         clap::parse::parser] 	Parser::add_value:iter:mypath: doesn't have default missing vals
[         clap::parse::parser] 	Parser::add_defaults:iter:myusize:
[         clap::parse::parser] 	Parser::add_value: doesn't have conditional defaults
[         clap::parse::parser] 	Parser::add_value:iter:myusize: doesn't have default vals
[         clap::parse::parser] 	Parser::add_value:iter:myusize: doesn't have default missing vals
[      clap::parse::validator] 	Validator::validate_conflicts
[      clap::parse::validator] 	Validator::validate_exclusive
[      clap::parse::validator] 	Validator::validate_exclusive:iter:myusize
[      clap::parse::validator] 	Validator::validate_exclusive:iter:mygroup
[      clap::parse::validator] 	Validator::validate_conflicts::iter: id=myusize
[      clap::parse::validator] 	Conflicts::gather_conflicts
[            clap::build::app] 	App::groups_for_arg: id=myusize
[      clap::parse::validator] 	Conflicts::gather_direct_conflicts id=myusize, conflicts=[mypath]
[      clap::parse::validator] 	Conflicts::gather_direct_conflicts id=mygroup, conflicts=[]
[      clap::parse::validator] 	Validator::validate_required: required=ChildGraph([Child { id: mypath, children: [] }, Child { id: myusize, children: [] }, Child { id: mygroup, children: [] }])
[      clap::parse::validator] 	Validator::gather_requirements
[      clap::parse::validator] 	Validator::gather_requirements:iter:myusize
[      clap::parse::validator] 	Validator::gather_requirements:iter:mygroup
[      clap::parse::validator] 	Validator::gather_requirements:iter:mygroup:group
[      clap::parse::validator] 	Validator::validate_required:iter:aog=mypath
[      clap::parse::validator] 	Validator::validate_required:iter: This is an arg
[      clap::parse::validator] 	Validator::is_missing_required_ok: mypath
[      clap::parse::validator] 	Validator::validate_arg_conflicts: a=&quot;mypath&quot;
[      clap::parse::validator] 	Validator::missing_required_error; incl=[]
[      clap::parse::validator] 	Validator::missing_required_error: reqs=ChildGraph([Child { id: mypath, children: [] }, Child { id: myusize, children: [] }, Child { id: mygroup, children: [] }])
[         clap::output::usage] 	Usage::get_required_usage_from: incls=[], matcher=true, incl_last=true
[         clap::output::usage] 	Usage::get_required_usage_from: unrolled_reqs={mypath, myusize, mygroup}
[            clap::build::app] 	App::unroll_args_in_group: group=mygroup
[            clap::build::app] 	App::unroll_args_in_group:iter: entity=mypath
[            clap::build::app] 	App::unroll_args_in_group:iter: this is an arg
[            clap::build::app] 	App::unroll_args_in_group:iter: entity=myusize
[            clap::build::app] 	App::unroll_args_in_group:iter: this is an arg
[            clap::build::app] 	App::unroll_args_in_group: group=mygroup
[            clap::build::app] 	App::unroll_args_in_group:iter: entity=mypath
[            clap::build::app] 	App::unroll_args_in_group:iter: this is an arg
[            clap::build::app] 	App::unroll_args_in_group:iter: entity=myusize
[            clap::build::app] 	App::unroll_args_in_group:iter: this is an arg
[         clap::output::usage] 	Usage::get_required_usage_from: ret_val=[]
[      clap::parse::validator] 	Validator::missing_required_error: req_args=[]
[         clap::output::usage] 	Usage::create_usage_with_title
[         clap::output::usage] 	Usage::create_usage_no_title
[         clap::output::usage] 	Usage::create_smart_usage
[         clap::output::usage] 	Usage::get_required_usage_from: incls=[mygroup], matcher=false, incl_last=true
[         clap::output::usage] 	Usage::get_required_usage_from: unrolled_reqs={mypath, myusize, mygroup}
[            clap::build::app] 	App::unroll_args_in_group: group=mygroup
[            clap::build::app] 	App::unroll_args_in_group:iter: entity=mypath
[            clap::build::app] 	App::unroll_args_in_group:iter: this is an arg
[            clap::build::app] 	App::unroll_args_in_group:iter: entity=myusize
[            clap::build::app] 	App::unroll_args_in_group:iter: this is an arg
[            clap::build::app] 	App::unroll_args_in_group: group=mygroup
[            clap::build::app] 	App::unroll_args_in_group:iter: entity=mypath
[            clap::build::app] 	App::unroll_args_in_group:iter: this is an arg
[            clap::build::app] 	App::unroll_args_in_group:iter: entity=myusize
[            clap::build::app] 	App::unroll_args_in_group:iter: this is an arg
[         clap::output::usage] 	Usage::get_required_usage_from: ret_val=[&quot;&lt;--mypath &lt;MYPATH&gt;|--myusize &lt;MYUSIZE&gt;&gt;&quot;]
[            clap::build::app] 	App::color: Color setting...
[            clap::build::app] 	Auto
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">C-bug</span> added by @malthesr on 2022-02-07 14:46</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/malthesr">@malthesr</a> on 2022-02-07 14:51</div>
            <div class="timeline-body"><p>Aha, did manage to find an <a href="https://github.com/clap-rs/clap/discussions/3184">earlier discussion</a> after all. Seems the solution is to wrap in option.</p>
<p>I'll close this - apologies for the noise.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @malthesr on 2022-02-07 14:51</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:28:33 UTC
    </footer>
</body>
</html>
