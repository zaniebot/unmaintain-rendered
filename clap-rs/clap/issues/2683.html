<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Provide data in the application domain rather than the CLI domain - clap-rs/clap #2683</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Provide data in the application domain rather than the CLI domain</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/clap-rs/clap/issues/2683">#2683</a>
        opened by <a href="https://github.com/pksunkara">@pksunkara</a>
        on 2021-08-13 01:05
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/pksunkara">@pksunkara</a></div>
            <div class="timeline-body"><p>Currently, clap&#x27;s API is focused on the CLI domain, with data being tracked as <code>OsString</code> with specialized helpers for <code>String</code>.  At the tale-end of the builder API, we provide the <code>value_of_t</code> API.  We do gloss over this in the derive API.</p>
<p>Problems with the current approach</p>
<ul>
<li>Bloat of functions in <code>ArgMatches</code> to handle every case</li>
<li>It is easy to use <code>_os</code> functions but disallow non-UTF8 during validation (<a href="https://github.com/clap-rs/clap/pull/2677">clap-rs/clap#2677</a>)</li>
<li>Derive API parses data twice, once as part of validation and then when giving it to the user (#2206, #3589)</li>
<li>Most builder users won&#x27;t bother with the extra development effort of validating like the derive API and instead will not get first class clap errors for their parse errors</li>
</ul>
<p>See also https://github.com/clap-rs/clap/discussions/2832, #1185</p>
<p>Roll out</p>
<ol>
<li>Change the data structure for <code>ArgMatches</code> to store <code>Box&lt;Any + Send + Sync + &#x27;static&gt;</code></li>
<li>Add a generic getter, gated behind a feature flag</li>
<li>Add a builder function for setting a custom value, gated behind a feature flag</li>
<li>Change the default parser from <code>OsString</code> to <code>String</code>, deprecating <code>AllowInvalidUtf8</code>, gated behind a feature flag</li>
<li>Mark old API deprecated, gated behind a feature flag</li>
<li>On next breaking release, remove deprecated APIs and remove feature gates</li>
</ol>
<p>Other considerations / open questions</p>
<ul>
<li>For <code>multiple_values</code>, users also have to set <code>default_values</code>, <code>value_names</code>, and <code>value_hints</code>, should we follow <code>possible_values</code> and avoid users passing in parallel arrays?</li>
<li>How do we handle default values?<ul>
<li>Users will want to set their defaults according to their application data type</li>
<li>To show a default in help, we need it to be <code>Display</code></li>
<li><code>clap_derive</code> currently punts on this by providing both a <code>default_value</code> and <code>default_value_t</code> where the latter has to support <code>Display</code> and it gets forwarded to <code>default_value</code>, see <a href="https://github.com/clap-rs/clap/pull/2635">clap-rs/clap#2635</a></li>
</ul>
</li>
<li>How many feature gates and when do we remove them?<ul>
<li>The sooner its public, the better, for collecting feedback</li>
<li>The more people using it, the more impacted by subtle behavior changes (default parser)<ul>
<li>We could put in hacks to make the old API work along side the new API and set the default parser according to <code>AllowInvalidUtf8</code></li>
</ul>
</li>
</ul>
</li>
<li>How do we handle optional vs required, especially in light of #2505?<ul>
<li>We have to deal with present / not-present, invalid cast of <code>Any</code>, etc.</li>
</ul>
</li>
<li>For the parser, how do we balance flexibility and performance<ul>
<li>We could make the parser a <code>trait ValueParser</code> and provide a <code>struct BoxedValueParser</code> that contains an enum for common function-pointer signatures (wrapped with converters for the error types) and people can explicitly construct a <code>BoxedValueParser</code> for their custom type</li>
</ul>
</li>
<li>In designing the API, we should keep in mind that people are also wanting access to what authored a value (env, default, CLI) (<strong>TODO</strong> Find Issue)<ul>
<li>Unsure how this feature would even fit into <code>clap_derive</code></li>
</ul>
</li>
<li>Long term, we will want to morph the <code>ArgMatches</code> API to be more map-like<ul>
<li>#1206</li>
<li>Having a <code>remove</code> function would allow <code>clap_derive</code> to move values, instead of clone them.</li>
</ul>
</li>
<li>Long term, we need to consider other type-related features besides <code>default_value</code>:<ul>
<li><code>ValueHint</code>: if we can detect and set a default for <code>Path</code> that would provide a better default experience</li>
<li><code>value_name</code> for named arguments: the default (of <code>--name &lt;name&gt;</code>) is redundant.  If we could provide type related defaults (e.g. <code>PATH</code> for <code>PathBuf</code>, <code>NUM</code> for numbers), it would  also provide a better default experience</li>
<li>See https://github.com/clap-rs/clap/discussions/2637 for prior discussion</li>
</ul>
</li>
</ul>
<hr>
<p><em>Original</em></p>
<p>Basically, there are two things that need to be solved here.</p>
<ul>
<li>We should be keeping the parsed values during validation stage of parsing instead of throwing them away</li>
<li>We should be storing the types directly in ArgMatches</li>
</ul>
<p>I have to dig into the code to write a longer description of issues with the current behaviour and design.</p>
<ul>
<li>[ ] #2505</li>
<li>[ ] #2206</li>
<li>[ ] #2298</li>
<li>[x] #3589</li>
<li>[x] #2437</li>
</ul>
<p>See also https://github.com/clap-rs/clap/discussions/2832</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">C: matches</span> added by <a href="https://github.com/pksunkara">@pksunkara</a> on 2021-08-13 01:05</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">C: validators</span> added by <a href="https://github.com/pksunkara">@pksunkara</a> on 2021-08-13 01:05</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone &quot;3.0&quot; by <a href="https://github.com/pksunkara">@pksunkara</a> on 2021-08-13 01:05</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from &quot;Validator &amp; ArgMatches issues epic&quot; to &quot;Validator &amp; ArgMatches need to be reworked?&quot; by <a href="https://github.com/pksunkara">@pksunkara</a> on 2021-08-13 01:08</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a>clap-rs/clap#2505</a> on 2021-10-13 17:50</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Removed from milestone &quot;3.0&quot; by <a href="https://github.com/epage">@epage</a> on 2021-10-16 20:03</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone &quot;4.0&quot; by <a href="https://github.com/epage">@epage</a> on 2021-10-16 20:03</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2021-10-16 20:11</div>
            <div class="timeline-body"><p>Sounds like this is related to https://github.com/clap-rs/clap/discussions/2832</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a>clap-rs/clap#2437</a> on 2021-10-16 20:38</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a>clap-rs/clap#2908</a> on 2021-10-18 21:23</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from &quot;Validator &amp; ArgMatches need to be reworked?&quot; to &quot;Provide data in the application domain rather than the CLI comain&quot; by <a href="https://github.com/epage">@epage</a> on 2021-10-18 21:25</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from &quot;Provide data in the application domain rather than the CLI comain&quot; to &quot;Provide data in the application domain rather than the CLI domain&quot; by <a href="https://github.com/epage">@epage</a> on 2021-10-18 21:31</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">E: breaking change</span> added by <a href="https://github.com/epage">@epage</a> on 2021-10-18 22:08</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2021-10-18 22:25</div>
            <div class="timeline-body"><p>@pksunkara just captured in the Issue my thoughts from not being able to sleep last night :)  I&#x27;m sure you also have some and would love to hear and see how we can synthesize the two.</p>
<p>The only linked issue I&#x27;m seeing this directly help with is #2206.  I thought it would help with #2505 but it sounds like we just repeat the same problem after exploring the idea.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/pksunkara">@pksunkara</a> on 2021-10-18 22:55</div>
            <div class="timeline-body"><p>Looks good to me. I would actually make this the main product objective for 4.0. I will add more if needed once I get into this context later (which I still have in my todo)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a>clap-rs/clap#2813</a> on 2021-11-04 16:10</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a>clap-rs/clap#1506</a> on 2021-11-04 16:12</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a>clap-rs/clap#1365</a> on 2021-11-04 16:47</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a>clap-rs/clap#2924</a> on 2021-11-04 18:40</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a>clap-rs/clap#2991</a> on 2021-11-04 21:39</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2021-11-05 16:48</div>
            <div class="timeline-body"><p>From https://github.com/clap-rs/clap/discussions/2832</p>
<p>@ssokolow</p>
<blockquote>
<p>Hmm. My main concern there is that this line looks like it could easily become a footgun if not handled carefully:</p>
<blockquote>
<p>Change the default parser from <code>OsString</code> to <code>String</code>, deprecating <code>AllowInvalidUtf8</code>, gated behind a feature flag.</p>
</blockquote>
<p>Windows may make it difficult to get paths with un-paired surrogates, but I&#x27;ve found <a href="https://en.wikipedia.org/wiki/Mojibake">mojibake</a>&#x27;d filenames to be easy on POSIX platforms... to the point where it led me to report a bug in Serde because a mojibake&#x27;d Japanese ID3 tag had put mojibake&#x27;d characters in media file names during auto-renaming and Serde doesn&#x27;t complain if you want to put a <code>PathBuf</code> into a JSON file without explicitly specifying how to handle un-UTF8-able contents. (Was it ID3v1 that left the tag&#x27;s encoding to be communicated out-of-band? I think Audacious Media Player actually has a browser-style encoding detector for that.)</p>
</blockquote>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2021-11-05 16:50</div>
            <div class="timeline-body"><blockquote>
<p>Hmm. My main concern there is that this line looks like it could easily become a footgun if not handled carefully:</p>
</blockquote>
<p>With the proposed API, if you want a path, you&#x27;d be specifying it as a <code>PathBuf</code> and we would parse from <code>OsStr</code>.  Just if you didn&#x27;t specify any custom type, we&#x27;d be choosing <code>String</code> by default which seems to be what people want in most cases.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ssokolow">@ssokolow</a> on 2021-11-05 17:05</div>
            <div class="timeline-body"><p>Ahh. By &quot;if not handled carefully&quot;, I meant &quot;this could turn into a footgun for end users if clap doesn&#x27;t handle it carefully&quot;, and that should fit the definition of &quot;clap handling it carefully&quot; well enough.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a>clap-rs/clap#3029</a> on 2021-11-15 19:10</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a>clap-rs/clap#2943</a> on 2021-11-22 18:52</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a>epage/clapng#36</a> on 2021-11-28 01:40</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a>epage/clapng#196</a> on 2021-12-06 21:19</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a>epage/clapng#211</a> on 2021-12-06 22:15</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a>epage/clapng#229</a> on 2021-12-06 22:22</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a>epage/clapng#233</a> on 2021-12-06 22:23</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">C: matches</span> removed by <a href="https://github.com/epage">@epage</a> on 2021-12-08 20:21</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">C: validators</span> removed by <a href="https://github.com/epage">@epage</a> on 2021-12-08 20:21</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">A-builder</span> added by <a href="https://github.com/epage">@epage</a> on 2021-12-08 20:21</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">A-derive</span> added by <a href="https://github.com/epage">@epage</a> on 2021-12-08 20:21</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">A-parsing</span> added by <a href="https://github.com/epage">@epage</a> on 2021-12-08 20:21</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a>clap-rs/clap#1704</a> on 2021-12-08 21:02</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a>clap-rs/clap#1723</a> on 2021-12-08 21:15</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a>clap-rs/clap#1185</a> on 2021-12-09 18:10</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a>clap-rs/clap#1682</a> on 2021-12-09 20:40</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a>clap-rs/clap#2122</a> on 2021-12-13 15:02</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">S-waiting-on-mentor</span> added by <a href="https://github.com/epage">@epage</a> on 2021-12-13 17:09</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">C-enhancement</span> added by <a href="https://github.com/epage">@epage</a> on 2021-12-13 22:44</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a>clap-rs/clap#3008</a> on 2022-01-10 16:24</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a>clap-rs/clap#3266</a> on 2022-01-11 16:56</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a>clap-rs/clap#3344</a> on 2022-01-25 18:44</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a>clap-rs/clap#3199</a> on 2022-02-02 20:07</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a>clap-rs/clap#3459</a> on 2022-02-13 02:43</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a>clap-rs/clap#3496</a> on 2022-02-22 15:22</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a>clap-rs/clap#3589</a> on 2022-03-29 14:30</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a>clap-rs/clap#3405</a> on 2022-05-09 21:54</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AndreasBackx">@AndreasBackx</a> on 2022-05-11 12:59</div>
            <div class="timeline-body"><p>@epage requested I share our usecases after a short chat.</p>
<p>We are logging various aspects of CLI usage across the company. This is to give CLI owners an understanding of how their CLIs are used. This discoverability gives various teams the insights to improve their CLIs and see where they could improve. One example of this is the ability to see which subcommands are most often used and how long they take. This can help a team prioritise making improvements to a CLI. Saying &quot;We saved 1000 engineers a total of 50 hours a week.&quot; is more impactful and provides incentives towards CLI improvements.</p>
<p>Additionally this information can be useful when debugging errors as well. We are currently working towards providing automated error logging. This means that when their CLI crashes, the user doesn&#x27;t have to do anything and it&#x27;ll be appropriately logged and can be followed up on. Having a better understanding of the state of the CLI can be beneficial. Maybe your parsing of a CLI argument lead to the eventual error? We&#x27;d know if that data was included as metadata while logging the error.</p>
<p>Either of these usecases would require data access in the application layer. Let me know if you have any questions.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2022-05-11 14:30</div>
            <div class="timeline-body"><p>I had been wondering if we should offer look up functions that panic instead of returning bad type errors.</p>
<p>To allow what @AndreasBackx brought up, we either need</p>
<ul>
<li>Allow people to query every known data type for an argument without panicing</li>
<li>Store the &quot;raw&quot; version of arguments<ul>
<li>This might get messy if we are able to support untyped defaults as there won&#x27;t be a raw version.</li>
</ul>
</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2022-05-13 00:21</div>
            <div class="timeline-body"><p>So my current implementation offers a <code>get_raw</code> (on top of <code>get_one</code> and <code>get_many</code>).  At times I am tempted to remove it but at least for the current implementation, its actually a help to track the raw values.</p>
<p>Progress</p>
<ul>
<li>[x] Replace <code>allow_invalid_utf8</code> with <code>ValueParser</code>, internally</li>
<li>[x] Allow users to set <code>ValueParser</code> on an <code>Arg</code> and look up the typed and raw values</li>
<li>[x] Provide alternative boolean <code>ValueParser</code>s that handle env-like truthiness</li>
<li>[x] Support for an <code>ArgEnum</code> <code>ValueParser</code></li>
<li>[x] Generalize possible values so bools can specify them to help with completion support (will require native bool support)</li>
<li>[x] Document why types are natively supported</li>
<li>[x] Support a possible-values <code>ValueParser</code></li>
<li>[x] Explore replacing <code>forbid_empty_value</code> with a <code>ValueParser</code></li>
<li>[x] Numeric range support (maybe use this as the basis for native numbers?).</li>
<li>[ ] Deprecate <code>possible_values</code> in favor of <code>value_parser</code></li>
<li>[ ] Deprecate <code>allow_invalid_utf8</code> in favor of <code>ValueParser</code></li>
<li>[ ] Deprecate arg value validators in favor of <code>ValueParser</code></li>
<li>[ ] Deprecate <code>forbid_empty_values</code></li>
<li>[ ] Add <code>default_value_raw</code> / <code>default_values_raw</code> etc and deprecate the current forms</li>
</ul>
<p>Deferred work</p>
<ul>
<li>Switch subcommands to <code>ValueParser</code> and away from <code>allow_invalid_utf8_for_external_subcommands</code></li>
<li><code>clap_derive</code> support (fixing #3589) because we need a way to get values out of <code>ArgMatches</code> and it&#x27;d be a breaking change to require <code>Clone</code> and a breaking change for <code>FromArgMatches</code> to accept <code>&amp;mut ArgMatches</code> so we can remove the already-allocated items<ul>
<li>I took another approach of having <code>_mut</code> variants of the <code>FromArgMatches</code> functions that have inherent implementations to maintain compatibility but the <code>update</code> version with subcommands processes subcommands then if it fails, it falls back to <code>from_arg_matches</code> on the original matcher, so removing the sub matches breaks it</li>
</ul>
</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2022-05-13 18:34</div>
            <div class="timeline-body"><p>I was considering moving <code>ignore_case</code> into the <code>ValueParser</code> as each type that it matters for, like <code>ArgEnumValueParser</code> could implement it and it could be left off all the others.</p>
<p>However, <code>required_if_eq</code> and friends complicate this because they use <code>ignore_case</code> and I don&#x27;t want to move it from <code>Arg</code> to every <code>ValueParser</code>, so for now, I&#x27;m leaving it on the <code>Arg</code>.  Maybe as we move special required rules out, we can re-evaluate this.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2022-05-16 20:45</div>
            <div class="timeline-body"><p>Currently, clap allows you accessing all of the values for a group.  The new implementation limits that to groups where all present values are of the same type.  For more background on why this was added, see <a href="https://github.com/clap-rs/clap/pull/283">clap-rs/clap#283</a></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a>clap-rs/clap#3732</a> on 2022-05-17 21:47</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/epage">@epage</a> on 2022-05-18 00:15</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AndreasBackx">@AndreasBackx</a> on 2022-05-18 08:32</div>
            <div class="timeline-body"><p>@epage I like the new API, do you think this would allow for some way to implement #1206? Happy to make a PR as well, let me know if you had something in mind.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2022-05-18 11:34</div>
            <div class="timeline-body"><p>That is still blocked on another issue; I&#x27;ve updated the issue description to summarize what it is blocked on</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a>clap-rs/clap#3792</a> on 2022-06-06 14:23</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a>clap-rs/clap#5156</a> on 2023-10-02 17:47</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:58:13 UTC
    </footer>
</body>
</html>
