<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>debug_assert fails with PropagateVersion in 3.0.8/3.0.9, but get_matches does not - clap-rs/clap #3310</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>debug_assert fails with PropagateVersion in 3.0.8/3.0.9, but get_matches does not</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/clap-rs/clap/issues/3310">#3310</a>
        opened by <a href="https://github.com/Roguelazer">@Roguelazer</a>
        on 2022-01-18 20:07
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Roguelazer">@Roguelazer</a></div>
            <div class="timeline-body">Please complete the following tasks
<ul>
<li>[X] I have searched the <a href="https://github.com/clap-rs/clap/discussions">discussions</a></li>
<li>[X] I have searched the existing issues</li>
</ul>
Rust Version
<p>rustc 1.57.0 (f1edd0429 2021-11-29)</p>
Clap Version
<p>3.0.9</p>
Minimal reproducible code
<pre><code>fn cli() -&gt; clap::App&lt;&#x27;static&gt; {
    clap::App::new(env!(&quot;CARGO_PKG_NAME&quot;))
        .version(env!(&quot;CARGO_PKG_VERSION&quot;))
        .global_setting(clap::AppSettings::PropagateVersion)
        .subcommand(clap::App::new(&quot;subcommand&quot;))
}

fn main() {
    let cli = cli();
    cli.get_matches();
}

#[cfg(test)]
mod tests {
    #[test]
    fn test_cli() {
        super::cli().debug_assert();
    }
}
</code></pre>
Steps to reproduce the bug with the above code
<p><code>cargo run -- --help</code> succeeds, but <code>cargo test</code> fails</p>
Actual Behaviour
<p>PropagateVersion should work in debug_assert</p>
Expected Behaviour
<p>PropagateVersion seems to not work in debug_assert</p>
Additional Context
<p>If I pin <code>clap</code> to <code>=3.0.7</code>, this works, so this is a regression in 3.0.8</p>
Debug Output
<pre><code>running 1 test
[            clap::build::app] 	App::_build
[            clap::build::app] 	App::_propagate:clp-test
[            clap::build::app] 	App::_check_help_and_version
[            clap::build::app] 	App::_check_help_and_version: Building help subcommand
[            clap::build::app] 	App::_propagate_global_args:clp-test
[            clap::build::app] 	App::_derive_display_order:clp-test
[            clap::build::app] 	App::_derive_display_order:subcommand
[            clap::build::app] 	App::_derive_display_order:help
[clap::build::app::debug_asserts] 	App::_debug_asserts
[clap::build::arg::debug_asserts] 	Arg::_debug_asserts:help
[clap::build::arg::debug_asserts] 	Arg::_debug_asserts:version
[clap::build::app::debug_asserts] 	App::_verify_positionals
[            clap::build::app] 	App::_build
[            clap::build::app] 	App::_propagate:subcommand
[            clap::build::app] 	App::_check_help_and_version
[            clap::build::app] 	App::_propagate_global_args:subcommand
[            clap::build::app] 	App::_derive_display_order:subcommand
[clap::build::app::debug_asserts] 	App::_debug_asserts
[clap::build::arg::debug_asserts] 	Arg::_debug_asserts:help
[clap::build::arg::debug_asserts] 	Arg::_debug_asserts:version
[clap::build::app::debug_asserts] 	App::_verify_positionals
[            clap::build::app] 	App::_build
[            clap::build::app] 	App::_propagate:help
[            clap::build::app] 	App::_check_help_and_version
[            clap::build::app] 	App::_check_help_and_version: Removing generated help
[            clap::build::app] 	App::_check_help_and_version: Removing generated version
[            clap::build::app] 	App::_propagate_global_args:help
[            clap::build::app] 	App::_derive_display_order:help
[clap::build::app::debug_asserts] 	App::_debug_asserts
test tests::test_cli ... FAILED

failures:

---- tests::test_cli stdout ----
thread &#x27;tests::test_cli&#x27; panicked at &#x27;App help: No version information via App::version or App::long_version to propagate&#x27;, /Users/jbrown/.cargo/registry/src/github.com-1ecc6299db9ec823/clap-3.0.9/src/build/app/debug_asserts.rs:18:9
note: run with `RUST_BACKTRACE=1` environment variable to display a backtrace

</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">C-bug</span> added by <a href="https://github.com/Roguelazer">@Roguelazer</a> on 2022-01-18 20:07</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from &quot;debug_assert fails with PropagateVersion in 3.0.9, but get_matches does not&quot; to &quot;debug_assert fails with PropagateVersion in 3.0.8/3.0.9, but get_matches does not&quot; by <a href="https://github.com/Roguelazer">@Roguelazer</a> on 2022-01-18 20:21</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a>clap-rs/clap#3311</a> on 2022-01-18 20:40</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/epage">@epage</a> on 2022-01-18 20:58</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2022-01-18 21:03</div>
            <div class="timeline-body"><p>Sorry about that.  v3.0.10 is out with the fix</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:58:45 UTC
    </footer>
</body>
</html>
