<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Parsing crashes with stack overflow if group name matches item name - clap-rs/clap #1491</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Parsing crashes with stack overflow if group name matches item name</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/clap-rs/clap/issues/1491">#1491</a>
        opened by <a href="https://github.com/Dentosal">@Dentosal</a>
        on 2019-06-13 22:50
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Dentosal">@Dentosal</a></div>
            <div class="timeline-body">Rust Version
<p><code>rustc 1.37.0-nightly (400b409ef 2019-06-09)</code> on macOS 10.14.4.</p>
Affected Version of clap
<p>Both <code>2.33.0</code> and current master (784524f7eb193e35f81082cc69454c8c21b948f7).</p>
Bug Summary
<p>Crashes with stack overflow if group name matches item name. At least I think that&#x27;s the issue here.</p>
Expected Behavior Summary
<p>Successful parse.</p>
Actual Behavior Summary
<pre><code>thread &#x27;main&#x27; has overflowed its stack
fatal runtime error: stack overflow
Abort trap: 6
</code></pre>
Steps to Reproduce the issue
<p>Create new binary crate, paste sample code to <code>src/main.rs</code> and run <code>cargo run -- -a</code>. Uses edition 2018 features.</p>
Sample Code or Link to Sample Code
<pre><code>fn main() {
    clap::App::new(&quot;name&quot;).arg(
        clap::Arg::with_name(&quot;a&quot;)
            .short(&quot;a&quot;) // the actual short flag doesn&#x27;t matter
            .group(&quot;a&quot;),
    ).get_matches();
}
</code></pre>
Debug output

 Debug Output 
<pre>
<code>
DEBUG:clap:Parser::propagate_settings: self=name, g_settings=AppFlags(
    (empty),
)
DEBUG:clap:Parser::get_matches_with;
DEBUG:clap:Parser::create_help_and_version;
DEBUG:clap:Parser::create_help_and_version: Building --help
DEBUG:clap:Parser::create_help_and_version: Building --version
DEBUG:clap:Parser::get_matches_with: Begin parsing &#x27;&quot;-a&quot;&#x27; ([45, 97])
DEBUG:clap:Parser::is_new_arg:&quot;-a&quot;:NotFound
DEBUG:clap:Parser::is_new_arg: arg_allows_tac=false
DEBUG:clap:Parser::is_new_arg: - found
DEBUG:clap:Parser::is_new_arg: starts_new_arg=true
DEBUG:clap:Parser::possible_subcommand: arg=&quot;-a&quot;
DEBUG:clap:Parser::get_matches_with: possible_sc=false, sc=None
DEBUG:clap:ArgMatcher::process_arg_overrides:None;
DEBUG:clap:Parser::parse_short_arg: full_arg=&quot;-a&quot;
DEBUG:clap:Parser::parse_short_arg:iter:a
DEBUG:clap:Parser::parse_short_arg:iter:a: Found valid flag
DEBUG:clap:Parser::check_for_help_and_version_char;
DEBUG:clap:Parser::check_for_help_and_version_char: Checking if -a is help or version...Neither
DEBUG:clap:Parser::parse_flag;
DEBUG:clap:ArgMatcher::inc_occurrence_of: arg=a
DEBUG:clap:ArgMatcher::inc_occurrence_of: first instance
DEBUG:clap:Parser::groups_for_arg: name=a
DEBUG:clap:Parser::groups_for_arg: Searching through groups...
	Found &#x27;a&#x27;
DEBUG:clap:ArgMatcher::inc_occurrences_of: args=[&quot;a&quot;]
DEBUG:clap:ArgMatcher::inc_occurrence_of: arg=a
DEBUG:clap:Parser:get_matches_with: After parse_short_arg Flag
DEBUG:clap:ArgMatcher::process_arg_overrides:Some(&quot;a&quot;);
DEBUG:clap:Parser::remove_overrides:[];
DEBUG:clap:Validator::validate;
DEBUG:clap:Parser::add_defaults;
DEBUG:clap:Validator::validate_blacklist;
DEBUG:clap:Validator::validate_blacklist:iter:a;
DEBUG:clap:Parser::groups_for_arg: name=a
DEBUG:clap:Parser::groups_for_arg: Searching through groups...
	Found &#x27;a&#x27;
DEBUG:clap:Validator::validate_required: required=[];
DEBUG:clap:Validator::validate_matched_args;
DEBUG:clap:Validator::validate_matched_args:iter:a: vals=[]
DEBUG:clap:Validator::validate_arg_requires:a;
DEBUG:clap:Validator::validate_arg_num_occurs: a=a;
DEBUG:clap:usage::create_usage_with_title;
DEBUG:clap:usage::create_usage_no_title;
DEBUG:clap:usage::smart_usage;
DEBUG:clap:usage::get_required_usage_from: reqs=[&quot;a&quot;], extra=None
DEBUG:clap:usage::get_required_usage_from: after init desc_reqs=[]
DEBUG:clap:usage::get_required_usage_from: no more children
DEBUG:clap:usage::get_required_usage_from: final desc_reqs=[&quot;a&quot;]

<p>thread &#x27;main&#x27; has overflowed its stack
fatal runtime error: stack overflow
Abort trap: 6
</code>
</pre></p>


</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/jcdyer">@jcdyer</a> on 2019-06-17 14:38</div>
            <div class="timeline-body"><p>I would not expect a successful parse for this.  Groups can be used in the same context as Args, so successfully parsing this would lead to ambiguous behavior when calling (for example) <code>matches.is_present(&quot;a&quot;)</code>.  I agree that a stack overflow here is a bug, but I think a better solution would be to fail with a panic, as is already done for duplicate arguments.</p>
<pre><code>thread &#x27;main&#x27; panicked at &#x27;Non-unique argument name: a is already in use&#x27;, ~/.cargo/registry/src/github.com-1ecc6299db9ec823/clap-2.33.0/src/app/parser.rs:174:9
</code></pre>
<p>The error message would need to be a little different, of course.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a>TeXitoi/structopt#203</a> on 2019-06-17 21:55</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone &quot;v3.0.0-alpha.3&quot; by <a href="https://github.com/CreepySkeleton">@CreepySkeleton</a> on 2020-02-01 13:26</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">C: args</span> added by <a href="https://github.com/CreepySkeleton">@CreepySkeleton</a> on 2020-02-01 13:28</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">C: options</span> added by <a href="https://github.com/CreepySkeleton">@CreepySkeleton</a> on 2020-02-01 13:28</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">help wanted</span> added by <a href="https://github.com/CreepySkeleton">@CreepySkeleton</a> on 2020-02-01 13:28</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">P1: urgent</span> added by <a href="https://github.com/CreepySkeleton">@CreepySkeleton</a> on 2020-02-01 13:28</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">T: bug</span> added by <a href="https://github.com/CreepySkeleton">@CreepySkeleton</a> on 2020-02-01 13:28</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">W: 2.x</span> added by <a href="https://github.com/CreepySkeleton">@CreepySkeleton</a> on 2020-02-01 13:28</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">W: 3.x</span> added by <a href="https://github.com/CreepySkeleton">@CreepySkeleton</a> on 2020-02-01 13:28</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Removed from milestone &quot;3.0.0-beta.2&quot; by <a href="https://github.com/pksunkara">@pksunkara</a> on 2020-04-07 13:59</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone &quot;3.0&quot; by <a href="https://github.com/pksunkara">@pksunkara</a> on 2020-04-07 13:59</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">C: asserts</span> added by <a href="https://github.com/pksunkara">@pksunkara</a> on 2020-04-09 07:58</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">W: 2.x</span> removed by <a href="https://github.com/pksunkara">@pksunkara</a> on 2020-04-09 07:58</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">W: 3.x</span> removed by <a href="https://github.com/pksunkara">@pksunkara</a> on 2020-04-09 07:58</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">help wanted</span> removed by <a href="https://github.com/pksunkara">@pksunkara</a> on 2020-04-09 07:58</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/bors[bot]">@bors[bot]</a> on 2020-04-10 02:00</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a>TeXitoi/structopt#384</a> on 2020-05-01 17:16</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:57:25 UTC
    </footer>
</body>
</html>
