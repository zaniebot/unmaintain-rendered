<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>clap_complete generates invalid powershell code when docs have RIGHT_SINGLE_QUOTATION_MARK - clap-rs/clap #5820</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>clap_complete generates invalid powershell code when docs have RIGHT_SINGLE_QUOTATION_MARK</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/clap-rs/clap/issues/5820">#5820</a>
        opened by <a href="https://github.com/fnando">@fnando</a>
        on 2024-11-15 22:06
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/fnando">@fnando</a> on 2024-11-15 22:06</div>
            <div class="timeline-body"><h3>Please complete the following tasks</h3>
<ul>
<li>[X] I have searched the <a href="https://github.com/clap-rs/clap/discussions">discussions</a></li>
<li>[X] I have searched the <a href="https://github.com/clap-rs/clap/issues">open</a> and <a href="https://github.com/clap-rs/clap/issues?q=is%3Aissue+label%3AS-wont-fix+is%3Aclosed">rejected</a> issues</li>
</ul>
<h3>Rust Version</h3>
<p>rustc 1.81.0 (eeb90cda1 2024-09-04)</p>
<h3>Clap Version</h3>
<p>4.5.21</p>
<h3>Minimal reproducible code</h3>
<pre><code class="language-rust">use std::io;

use clap::{CommandFactory, Parser};
use clap_complete::{generate, Shell};

fn main() {
    let cmd = Cmd::parse();
    cmd.run();
}

#[derive(Parser, Debug)]
struct Cmd {
    /// This doesn’t work on powershell.
    #[arg(long)]
    shell: Shell,
}

impl Cmd {
    fn run(&amp;self) {
        let cmd = &amp;mut Cmd::command();
        generate(self.shell, cmd, &quot;sample&quot;, &amp;mut io::stdout());
    }
}
</code></pre>
<h3>Steps to reproduce the bug with the above code</h3>
<p>On Windows (PowerShell), run:</p>
<pre><code class="language-sh">cargo run -- --shell powershell &gt; bug.ps1
</code></pre>
<p>Then try to load this file:</p>
<pre><code class="language-console">$ . .\bug.ps1
ParserError: C:\Users\fnando\Downloads\bug.ps1:24
Line |
  24 |  … --shell', [CompletionResultType]::ParameterName, 'This doesn’t work o …
     |                                                                 ~
     | Missing ')' in method call.
</code></pre>
<h3>Actual Behaviour</h3>
<p>When trying to load the generated completion code, I get an exception because it's not properly escaping <code>’</code>.</p>
<h3>Expected Behaviour</h3>
<p>clap_complete escapes <code>’</code></p>
<h3>Additional Context</h3>
<p><em>No response</em></p>
<h3>Debug Output</h3>
<pre><code class="language-console">$ cargo run -- --shell powershell
[clap_builder::builder::command]Command::_do_parse
[clap_builder::builder::command]Command::_build: name=&quot;clap_complete_bug&quot;
[clap_builder::builder::command]Command::_propagate:clap_complete_bug
[clap_builder::builder::command]Command::_check_help_and_version:clap_complete_bug expand_help_tree=false
[clap_builder::builder::command]Command::long_help_exists
[clap_builder::builder::command]Command::_check_help_and_version: Building default --help
[clap_builder::builder::command]Command::_propagate_global_args:clap_complete_bug
[clap_builder::builder::debug_asserts]Command::_debug_asserts
[clap_builder::builder::debug_asserts]Arg::_debug_asserts:shell
[clap_builder::builder::debug_asserts]Arg::_debug_asserts:help
[clap_builder::builder::debug_asserts]Command::_verify_positionals
[clap_builder::parser::parser]Parser::get_matches_with
[clap_builder::parser::parser]Parser::parse
[clap_builder::parser::parser]Parser::get_matches_with: Begin parsing '&quot;--shell&quot;'
[clap_builder::parser::parser]Parser::possible_subcommand: arg=Ok(&quot;--shell&quot;)
[clap_builder::parser::parser]Parser::get_matches_with: sc=None
[clap_builder::parser::parser]Parser::parse_long_arg
[clap_builder::parser::parser]Parser::parse_long_arg: Does it contain '='...
[clap_builder::parser::parser]Parser::parse_long_arg: Found valid arg or flag '--shell &lt;SHELL&gt;'
[clap_builder::parser::parser]Parser::parse_long_arg(&quot;shell&quot;): Found an arg with value 'None'
[clap_builder::parser::parser]Parser::parse_opt_value; arg=shell, val=None, has_eq=false
[clap_builder::parser::parser]Parser::parse_opt_value; arg.settings=ArgFlags(1)
[clap_builder::parser::parser]Parser::parse_opt_value; Checking for val...
[clap_builder::parser::parser]Parser::parse_opt_value: More arg vals required...
[clap_builder::parser::parser]Parser::get_matches_with: After parse_long_arg Opt(&quot;shell&quot;)
[clap_builder::parser::parser]Parser::get_matches_with: Begin parsing '&quot;powershell&quot;'
[clap_builder::parser::arg_matcher]ArgMatcher::needs_more_vals: o=shell, pending=1
[clap_builder::parser::arg_matcher]ArgMatcher::needs_more_vals: expected=1, actual=1
[clap_builder::parser::parser]Parser::resolve_pending: id=&quot;shell&quot;
[clap_builder::parser::parser]Parser::react action=Set, identifier=Some(Long), source=CommandLine
[clap_builder::parser::parser]Parser::react: cur_idx:=1
[clap_builder::parser::parser]Parser::remove_overrides: id=&quot;shell&quot;
[clap_builder::parser::arg_matcher]ArgMatcher::start_custom_arg: id=&quot;shell&quot;, source=CommandLine
[clap_builder::builder::command]Command::groups_for_arg: id=&quot;shell&quot;
[clap_builder::parser::arg_matcher]ArgMatcher::start_custom_arg: id=&quot;Cmd&quot;, source=CommandLine
[clap_builder::parser::parser]Parser::push_arg_values: [&quot;powershell&quot;]
[clap_builder::parser::parser]Parser::add_single_val_to_arg: cur_idx:=2
[clap_builder::parser::arg_matcher]ArgMatcher::needs_more_vals: o=shell, pending=0
[clap_builder::parser::arg_matcher]ArgMatcher::needs_more_vals: expected=1, actual=0
[clap_builder::parser::parser]Parser::react not enough values passed in, leaving it to the validator to complain
[clap_builder::parser::parser]Parser::add_defaults
[clap_builder::parser::parser]Parser::add_defaults:iter:shell:
[clap_builder::parser::parser]Parser::add_default_value: doesn't have conditional defaults
[clap_builder::parser::parser]Parser::add_default_value:iter:shell: doesn't have default vals
[clap_builder::parser::parser]Parser::add_defaults:iter:help:
[clap_builder::parser::parser]Parser::add_default_value: doesn't have conditional defaults
[clap_builder::parser::parser]Parser::add_default_value:iter:help: doesn't have default vals
[clap_builder::parser::validator]Validator::validate
[clap_builder::builder::command]Command::groups_for_arg: id=&quot;shell&quot;
[clap_builder::parser::validator]Conflicts::gather_direct_conflicts id=&quot;shell&quot;, conflicts=[]
[clap_builder::parser::validator]Conflicts::gather_direct_conflicts id=&quot;Cmd&quot;, conflicts=[]
[clap_builder::parser::validator]Validator::validate_conflicts
[clap_builder::parser::validator]Validator::validate_exclusive
[clap_builder::parser::validator]Validator::validate_conflicts::iter: id=&quot;shell&quot;
[clap_builder::parser::validator]Conflicts::gather_conflicts: arg=&quot;shell&quot;
[clap_builder::parser::validator]Conflicts::gather_conflicts: conflicts=[]
[clap_builder::parser::validator]Validator::validate_required: required=ChildGraph([Child { id: &quot;shell&quot;, children: [] }])
[clap_builder::parser::validator]Validator::gather_requires
[clap_builder::parser::validator]Validator::gather_requires:iter:&quot;shell&quot;
[clap_builder::parser::validator]Validator::gather_requires:iter:&quot;Cmd&quot;
[clap_builder::parser::validator]Validator::gather_requires:iter:&quot;Cmd&quot;:group
[clap_builder::parser::validator]Validator::validate_required: is_exclusive_present=false
[clap_builder::parser::arg_matcher]ArgMatcher::get_global_values: global_arg_vec=[]
[clap_builder::builder::command]Command::_build: name=&quot;clap_complete_bug&quot;
[clap_builder::builder::command]Command::_propagate:clap_complete_bug
[clap_builder::builder::command]Command::_check_help_and_version:clap_complete_bug expand_help_tree=true
[clap_builder::builder::command]Command::long_help_exists
[clap_builder::builder::command]Command::_check_help_and_version: Building default --help
[clap_builder::builder::command]Command::_propagate_global_args:clap_complete_bug
[clap_builder::builder::debug_asserts]Command::_debug_asserts
[clap_builder::builder::debug_asserts]Arg::_debug_asserts:shell
[clap_builder::builder::debug_asserts]Arg::_debug_asserts:help
[clap_builder::builder::debug_asserts]Command::_verify_positionals
[clap_builder::builder::command]Command::_build_bin_names
[ clap_builder::output::usage]Usage::get_required_usage_from: incls=[], matcher=false, incl_last=true
[ clap_builder::output::usage]Usage::get_required_usage_from: unrolled_reqs=[&quot;shell&quot;]
[ clap_builder::output::usage]Usage::get_required_usage_from:iter:&quot;shell&quot; arg is_present=false
[ clap_builder::output::usage]Usage::get_required_usage_from: ret_val=[StyledStr(&quot;\u{1b}[1m--shell\u{1b}[0m &lt;SHELL&gt;&quot;)]

using namespace System.Management.Automation
using namespace System.Management.Automation.Language

Register-ArgumentCompleter -Native -CommandName 'sample' -ScriptBlock {
    param($wordToComplete, $commandAst, $cursorPosition)

    $commandElements = $commandAst.CommandElements
    $command = @(
        'sample'
        for ($i = 1; $i -lt $commandElements.Count; $i++) {
            $element = $commandElements[$i]
            if ($element -isnot [StringConstantExpressionAst] -or
                $element.StringConstantType -ne [StringConstantType]::BareWord -or
                $element.Value.StartsWith('-') -or
                $element.Value -eq $wordToComplete) {
                break
        }
        $element.Value
    }) -join ';'

    $completions = @(switch ($command) {
        'sample' {
            [CompletionResult]::new('--shell', '--shell', [CompletionResultType]::ParameterName, 'This doesn’t work on powershell')
            [CompletionResult]::new('-h', '-h', [CompletionResultType]::ParameterName, 'Print help')
            [CompletionResult]::new('--help', '--help', [CompletionResultType]::ParameterName, 'Print help')
            break
        }
    })

    $completions.Where{ $_.CompletionText -like &quot;$wordToComplete*&quot; } |
        Sort-Object -Property ListItemText
}
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">C-bug</span> added by @fnando on 2024-11-15 22:06</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../stellar/stellar-cli/pulls/1730.html">stellar/stellar-cli#1730</a> on 2024-11-15 22:07</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">A-completion</span> added by @epage on 2024-11-15 22:13</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">E-medium</span> added by @epage on 2024-11-15 22:13</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">E-help-wanted</span> added by @epage on 2024-11-15 22:13</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/5892.html">clap-rs/clap#5892</a> on 2025-01-25 10:20</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @epage on 2025-01-27 15:21</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 01:35:41 UTC
    </footer>
</body>
</html>
