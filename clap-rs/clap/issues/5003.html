<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>mangen: verbatim_doc_comment has no effect - clap-rs/clap #5003</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>mangen: verbatim_doc_comment has no effect</h1>

    <div class="meta">
        <span class="state state-open">Open</span>
        <a href="https://github.com/clap-rs/clap/issues/5003">#5003</a>
        opened by <a href="https://github.com/WhyNotHugo">@WhyNotHugo</a>
        on 2023-07-10 09:27
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/WhyNotHugo">@WhyNotHugo</a> on 2023-07-10 09:27</div>
            <div class="timeline-body"><h3>Please complete the following tasks</h3>
<ul>
<li>[X] I have searched the <a href="https://github.com/clap-rs/clap/discussions">discussions</a></li>
<li>[X] I have searched the <a href="https://github.com/clap-rs/clap/issues">open</a> and <a href="https://github.com/clap-rs/clap/issues?q=is%3Aissue+label%3AS-wont-fix+is%3Aclosed">rejected</a> issues</li>
</ul>
<h3>Rust Version</h3>
<p>rustc 1.70.0 (90c541806 2023-05-31) (Alpine Linux 1.70.0-r4)</p>
<h3>Clap Version</h3>
<p>version = &quot;4.1.4&quot;</p>
<h3>Minimal reproducible code</h3>
<pre><code class="language-rust">use std::io::Write;

use clap::{Parser, CommandFactory};

/// *shotman* takes a screenshot and shows it in a small floating thumbnail window.
///
/// Screenshots are saved immediately. The first of the following locations that is
/// defined is used (i.e.: if the environment variable is undefined, the next one on
/// the list is used).
///
/// - _$XDG_SCREENSHOTS_DIR/_
/// - _$XDG_PICTURES_DIR/screenshots/_
/// - _$HOME/screenshots/_
/// - The current directory.
///
/// *shotman* requires a compositor that supports *wlr_screencopy* and
/// *wlr_layer_shell*.
#[derive(Parser)]
#[clap(author, about, long_about, verbatim_doc_comment)]
pub struct Cli {
}

fn main() {
            let man = clap_mangen::Man::new(Cli::command());
            let mut buffer: Vec&lt;u8&gt; = Default::default();
            man.render_title(&amp;mut buffer).expect(&quot;Render man page to buffer&quot;);
            man.render_name_section(&amp;mut buffer).expect(&quot;Render man page to buffer&quot;);
            man.render_synopsis_section(&amp;mut buffer).expect(&quot;Render man page to buffer&quot;);
            man.render_description_section (&amp;mut buffer).expect(&quot;Render man page to buffer&quot;);

            let stdout = std::io::stdout();
            stdout
                .lock()
                .write_all(&amp;buffer)
                .expect(&quot;Write buffer with rendered manpage to stdout&quot;);
}
</code></pre>
<h3>Steps to reproduce the bug with the above code</h3>
<pre><code class="language-sh">cargo add clap --features=derive
cargo run &gt; tmp.man &amp;&amp; man ./tmp.man
</code></pre>
<h3>Actual Behaviour</h3>
<p>Text is mangled up due to pre-processing.</p>
<h3>Expected Behaviour</h3>
<p><code>verbatim_doc_comment</code> should minimise pre-processing when converting doc comments.</p>
<h3>Additional Context</h3>
<p>The <code>--help</code> output of this example prints fine:</p>
<pre><code>*shotman* takes a screenshot and shows it in a small floating thumbnail window.

Screenshots are saved immediately. The first of the following locations that is
defined is used (i.e.: if the environment variable is undefined, the next one on
the list is used).

- _$XDG_SCREENSHOTS_DIR/_
- _$XDG_PICTURES_DIR/screenshots/_
- _$HOME/screenshots/_
- The current directory.

*shotman* requires a compositor that supports *wlr_screencopy* and
*wlr_layer_shell*.
</code></pre>
<p>https://github.com/clap-rs/clap/pull/4444 seems remotely related, but not quite the same.</p>
<h3>Debug Output</h3>
<pre><code>[clap_builder::builder::command]Command::_build: name=&quot;ma&quot;
[clap_builder::builder::command]Command::_propagate:ma
[clap_builder::builder::command]Command::_check_help_and_version:ma expand_help_tree=true
[clap_builder::builder::command]Command::long_help_exists
[clap_builder::builder::command]Command::_check_help_and_version: Building default --help
[clap_builder::builder::command]Command::_propagate_global_args:ma
[clap_builder::builder::debug_asserts]Command::_debug_asserts
[clap_builder::builder::debug_asserts]Arg::_debug_asserts:help
[clap_builder::builder::debug_asserts]Command::_verify_positionals
[clap_builder::builder::command]Command::_build_bin_names
[ clap_builder::output::usage]Usage::get_required_usage_from: incls=[], matcher=false, incl_last=true
[ clap_builder::output::usage]Usage::get_required_usage_from: unrolled_reqs=[]
[ clap_builder::output::usage]Usage::get_required_usage_from: ret_val=[]
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">C-bug</span> added by @WhyNotHugo on 2023-07-10 09:27</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2023-07-10 14:27</div>
            <div class="timeline-body"><p>For easier reproduction with cargo-script (with <code>nargo</code> being a wrapper around <code>env -S cargo -Zscript</code></p>
<pre><code class="language-rust">#!/usr/bin/env nargo
/*!
```cargo
[dependencies]
clap = { version = &quot;4&quot;, features = [&quot;derive&quot;] }
clap_mangen = &quot;0.2&quot;
```
*/

use std::io::Write;

use clap::{CommandFactory, Parser};

/// *shotman* takes a screenshot and shows it in a small floating thumbnail window.
///
/// Screenshots are saved immediately. The first of the following locations that is
/// defined is used (i.e.: if the environment variable is undefined, the next one on
/// the list is used).
///
/// - _$XDG_SCREENSHOTS_DIR/_
/// - _$XDG_PICTURES_DIR/screenshots/_
/// - _$HOME/screenshots/_
/// - The current directory.
///
/// *shotman* requires a compositor that supports *wlr_screencopy* and
/// *wlr_layer_shell*.
#[derive(Parser)]
#[clap(author, about, long_about, verbatim_doc_comment)]
pub struct Cli {}

fn main() {
    Cli::parse();
    let man = clap_mangen::Man::new(Cli::command());
    let mut buffer: Vec&lt;u8&gt; = Default::default();
    man.render_title(&amp;mut buffer)
        .expect(&quot;Render man page to buffer&quot;);
    man.render_name_section(&amp;mut buffer)
        .expect(&quot;Render man page to buffer&quot;);
    man.render_synopsis_section(&amp;mut buffer)
        .expect(&quot;Render man page to buffer&quot;);
    man.render_description_section(&amp;mut buffer)
        .expect(&quot;Render man page to buffer&quot;);

    let stdout = std::io::stdout();
    stdout
        .lock()
        .write_all(&amp;buffer)
        .expect(&quot;Write buffer with rendered manpage to stdout&quot;);
}
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2023-07-10 14:27</div>
            <div class="timeline-body"><p>The <code>--help</code> output</p>
<pre><code>*shotman* takes a screenshot and shows it in a small floating thumbnail window.

Screenshots are saved immediately. The first of the following locations that is
defined is used (i.e.: if the environment variable is undefined, the next one on
the list is used).

- _$XDG_SCREENSHOTS_DIR/_
- _$XDG_PICTURES_DIR/screenshots/_
- _$HOME/screenshots/_
- The current directory.

*shotman* requires a compositor that supports *wlr_screencopy* and
*wlr_layer_shell*.

Usage: clap-5003

Options:
  -h, --help
          Print help (see a summary with '-h')
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2023-07-10 14:28</div>
            <div class="timeline-body"><p>The ROFF</p>
<pre><code class="language-roff">.ie \n(.g .ds Aq \(aq
.el .ds Aq '
.TH clap-5003 1  &quot;clap-5003 &quot;
.ie \n(.g .ds Aq \(aq
.el .ds Aq '
.SH NAME
clap\-5003 \- *shotman* takes a screenshot and shows it in a small floating thumbnail window.
.ie \n(.g .ds Aq \(aq
.el .ds Aq '
.SH SYNOPSIS
\fBclap\-5003\fR [\fB\-h\fR|\fB\-\-help\fR]
.ie \n(.g .ds Aq \(aq
.el .ds Aq '
.SH DESCRIPTION
*shotman* takes a screenshot and shows it in a small floating thumbnail window.
.PP
Screenshots are saved immediately. The first of the following locations that is
defined is used (i.e.: if the environment variable is undefined, the next one on
the list is used).
.PP
\- _$XDG_SCREENSHOTS_DIR/_
\- _$XDG_PICTURES_DIR/screenshots/_
\- _$HOME/screenshots/_
\- The current directory.
.PP
*shotman* requires a compositor that supports *wlr_screencopy* and
*wlr_layer_shell*.
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2023-07-10 14:29</div>
            <div class="timeline-body"><p>An approx of what the man page looks like</p>
<pre><code>  1 clap-5003(1)                                  General Commands Manual                                  clap-5003(&gt;
  2
  3 NAME
  4        clap-5003 - *shotman* takes a screenshot and shows it in a small floating thumbnail window.
  5
  6 SYNOPSIS
  7        clap-5003 [-h|--help]
  8
  9 DESCRIPTION
 10        *shotman* takes a screenshot and shows it in a small floating thumbnail window.
 11
 12        Screenshots  are  saved  immediately. The first of the following locations that is defined is used (i.e.: &gt;
 13        the environment variable is undefined, the next one on the list is used).
 14
 15        - _$XDG_SCREENSHOTS_DIR/_ - _$XDG_PICTURES_DIR/screenshots/_ - _$HOME/screenshots/_ - The current director&gt;
 16
 17        *shotman* requires a compositor that supports *wlr_screencopy* and *wlr_layer_shell*.
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2023-07-10 14:37</div>
            <div class="timeline-body"><p>Based on <code>--help</code>, I feel like <code>verbatim_doc_comment</code> is doing what it says.  The only question is about <code>clap_mangen</code>s behavior of only inserting paragraph markers on blank lines which is independent of any derive behavior.</p>
<p>The challenge is knowing hard line breaks from soft line breaks</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/WhyNotHugo">@WhyNotHugo</a> on 2023-07-20 07:44</div>
            <div class="timeline-body"><p>I think that you're right; strictly speaking, <code>verbatim_doc_comment</code> is doing what it says.</p>
<p>I expected <code>verbatim_doc_comment</code> to apply for <code>clap_mangen</code> in the same way it applies to <code>--help</code>. It really doesn't make sense that it would apply to one and not the other since that means parsing the exact same text with different rules for both usages.</p>
<p>Do you have any thoughts here? Should <code>verbatim_doc_comment</code> also apply to <code>clap_mangen</code>, or should some new/different flag be used instead?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2023-07-20 14:07</div>
            <div class="timeline-body"><p>I lean towards keeping <code>verbatim_doc_comment</code> as a derive-only concern.</p>
<p>We could add a <code>clap_mangen</code> setting that is verbatim-ish.  This would most likely be blocked on the in-work plugin system being made public so we can add this config to an <code>Arg</code> without <code>clap</code> knowing about <code>clap_mangen</code>-specific behavior.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">A-man</span> added by @epage on 2023-07-20 14:07</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">C-bug</span> removed by @epage on 2023-07-20 14:07</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">C-enhancement</span> added by @epage on 2023-07-20 14:07</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">S-blocked</span> added by @epage on 2023-07-20 14:07</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/pamburus">@pamburus</a> on 2025-12-08 21:50</div>
            <div class="timeline-body"><p>I was wondering if it might be possible to implement this on the <code>Man</code> struct directly, rather than waiting for the plugin system to attach it to an <code>Arg</code>?</p>
<p>By placing the option on the <code>Man</code> builder in the <code>clap_mangen</code>, the configuration remains external to the <code>clap</code> crate, keeping it unaware of <code>mangen</code> behavior.</p>
<p>For example:</p>
<pre><code class="language-rust">let man = clap_mangen::Man::new(cli::Opt::command()).verbatim(true);
</code></pre>
<p>The proposed change can be found <a href="https://github.com/clap-rs/clap/compare/53a69215e481c237bff5599f93bbcc7bdc6218c5...pamburus:rust-clap:1926fb0f1dafbaf47721ddc107ca1a39863b2890?expand=1">here</a>.</p>
<p>@epage
Would an approach like this be acceptable?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/6190.html">clap-rs/clap#6190</a> on 2025-12-10 20:02</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:35:09 UTC
    </footer>
</body>
</html>
