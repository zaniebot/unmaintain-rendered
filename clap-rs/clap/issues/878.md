```yaml
number: 878
title: Suggestions of a subcommand shadowing valid input
type: issue
state: closed
author: fredszaq
labels:
  - C-enhancement
  - A-docs
assignees: []
created_at: 2017-02-27T16:53:35Z
updated_at: 2020-11-07T13:23:29Z
url: https://github.com/clap-rs/clap/issues/878
synced_at: 2026-01-10T01:57:41Z
```

# Suggestions of a subcommand shadowing valid input

---

_Issue opened by @fredszaq on 2017-02-27 16:53_

Hello,

I have a problem with sub-commands when the app also expects a parameter

### Rust Version

`rustc 1.15.0 (10893a9a3 2017-01-19)`

### Affected Version of clap

`clap 2.20.5 `

### Bug Summary
In some cases, the suggestion feature will kick in and make the arguments parsing fail on an error even if the provided input is valid

### Steps to Reproduce the issue
Here is a small app demonstrating the issue (basically a stripped down version of the example in the doc, the problem also happens with it)
```rust
#[macro_use]
extern crate clap;

fn main() {
    let matches = clap_app!(myapp =>
        (about: "Does awesome things")
        (@arg TEXT: +required "The text to be processed")
        (@subcommand test =>
            (about: "Run some tests")
        )
    ).get_matches();

    println!("text = {:?}, subcommand = {:?}", matches.value_of("TEXT"), matches.subcommand_name());
}
```
if we run this with these arguments 
```
$ target/debug/clap-test foobar test
```
we get the expected output 
```
text = Some("foobar"), subcommand = Some("test")
``` 
Now the problem arises when instead of `foobar` we pass `hello`
```
$ target/debug/clap-test hello test
```
`hello` is to close to the generated subcommand `help` 
```
error: The subcommand 'hello' wasn't recognized
	Did you mean 'help'?

If you believe you received this message in error, try re-running with 'clap-test -- hello'

USAGE:
    clap-test <TEXT> [SUBCOMMAND]

For more information try --help
```
The problem disappears when deactivating the `suggestion` feature 

### Debug output
```
$ target/debug/clap-test hello test 
DEBUG:clap:Parser::add_subcommand: term_w=None, name=test
DEBUG:clap:Parser::propogate_settings: self=myapp, g_settings=AppFlags(
    NEEDS_LONG_HELP | NEEDS_LONG_VERSION | NEEDS_SC_HELP | UTF8_NONE | COLOR_AUTO
)
DEBUG:clap:Parser::propogate_settings: sc=test, settings=AppFlags(
    NEEDS_LONG_HELP | NEEDS_LONG_VERSION | NEEDS_SC_HELP | UTF8_NONE | COLOR_AUTO
), g_settings=AppFlags(
    NEEDS_LONG_HELP | NEEDS_LONG_VERSION | NEEDS_SC_HELP | UTF8_NONE | COLOR_AUTO
)
DEBUG:clap:Parser::propogate_settings: self=test, g_settings=AppFlags(
    NEEDS_LONG_HELP | NEEDS_LONG_VERSION | NEEDS_SC_HELP | UTF8_NONE | COLOR_AUTO
)
DEBUG:clap:Parser::get_matches_with;
DEBUG:clap:Parser::create_help_and_version;
DEBUG:clap:Parser::create_help_and_version: Building --help
DEBUG:clap:Parser::create_help_and_version: Building --version
DEBUG:clap:Parser::create_help_and_version: Building help
DEBUG:clap:Parser::get_matches_with: Begin parsing '"hello"' ([104, 101, 108, 108, 111])
DEBUG:clap:Parser::is_new_arg: arg="hello", Needs Val of=None
DEBUG:clap:Parser::is_new_arg: Does arg allow leading hyphen...false
DEBUG:clap:Parser::is_new_arg: Starts new arg...Probable value
DEBUG:clap:Parser::is_new_arg: Starts new arg...false
DEBUG:clap:Parser::possible_subcommand: arg="hello"
DEBUG:clap:Parser::create_usage;
DEBUG:clap:Parser::create_usage_no_title;
DEBUG:clap:Parser::get_required_from: reqs=["TEXT"], extra=None
DEBUG:clap:Parser::get_required_from: args_in_groups=[]
DEBUG:clap:Parser::needs_flags_tag;
DEBUG:clap:Parser::needs_flags_tag:iter: f=hclap_help;
DEBUG:clap:Parser::needs_flags_tag:iter: f=vclap_version;
DEBUG:clap:Parser::needs_flags_tag: [FLAGS] not required
DEBUG:clap:Parser::color;
DEBUG:clap:Parser::color: Color setting...Auto
DEBUG:clap:Colorizer::error;
DEBUG:clap:is_a_tty: stderr=true
DEBUG:clap:Colorizer::warning;
DEBUG:clap:is_a_tty: stderr=true
DEBUG:clap:Colorizer::good;
DEBUG:clap:is_a_tty: stderr=true
DEBUG:clap:Colorizer::good;
DEBUG:clap:is_a_tty: stderr=true
DEBUG:clap:Colorizer::good;
DEBUG:clap:is_a_tty: stderr=true
error: The subcommand 'hello' wasn't recognized
	Did you mean 'help'?

If you believe you received this message in error, try re-running with 'clap-test -- hello'

USAGE:
    clap-test <TEXT> [SUBCOMMAND]

For more information try --help
```


---

_Comment by @kbknapp on 2017-02-28 05:01_

Thanks for the details and taking the time to file this!

Depending on the design of the CLI you may be able to use [`AppSettings::ArgsNegateSubcommands`](https://docs.rs/clap/2.20.5/clap/enum.AppSettings.html#variant.ArgsNegateSubcommands) which basically says, 'If you find a valid arg, no subcommand is possible so don't try to make suggestions."

Of course, this means an arg (not potentially matching a subcommand) must be used, which may not be possible depending on the design.

If by coincidence the problem only occurs with the `help` subcommand, you can disable it with [`AppSettings::DisableHelpSubcommand`](https://docs.rs/clap/2.20.5/clap/enum.AppSettings.html#variant.DisableHelpSubcommand) which still leaves `--help` and `-h`.

Unfortunately, there isn't much more that can be done, short of:

* Disabling the `suggestions` feature as you found
* Picking subcommand names that won't be similar to possible argument values

If you'd like to, I can take a look at your CLI as a whole and give a more specific suggestion, or perhaps find a valid workaround.

---

_Label `T: RFC / question` added by @kbknapp on 2017-02-28 05:01_

---

_Comment by @fredszaq on 2017-02-28 12:52_

I our case, we ended up using a `--text` to pass the argument and remove any ambiguity, as the value of this argument is a free text for the user, so we cannot take chances an user would want to pass a value similar to one of our sub-commands. I mainly wrote the bug repport because that's a behaviour that exists in the doc example, and maybe it could be a good idea to modify it so that it doesn't have this problem (maybe by moving the `INPUT` arg to the subcommand )

---

_Comment by @kbknapp on 2017-02-28 13:48_

I agree, I'll mark this as a doc issue! Thanks again for taking the time to file this!

---

_Label `C: docs` added by @kbknapp on 2017-02-28 13:48_

---

_Label `D: easy` added by @kbknapp on 2017-02-28 13:48_

---

_Label `P3: want to have` added by @kbknapp on 2017-02-28 13:48_

---

_Label `T: enhancement` added by @kbknapp on 2017-02-28 13:48_

---

_Label `W: 2.x` added by @kbknapp on 2017-02-28 13:48_

---

_Label `T: RFC / question` removed by @kbknapp on 2017-02-28 13:48_

---

_Comment by @Freyskeyd on 2017-11-29 20:48_

I'm facing the same problem and none of the solution worked :/

---

_Comment by @kbknapp on 2017-11-29 21:27_

@Freyskeyd can you give me more details. Each CLI is unique with different constraints and solutions. 

---

_Comment by @Freyskeyd on 2017-11-29 22:03_

@kbknapp 
here's the cli.yml:

```yaml
name: cli
version: "0.1"

settings:
  - ArgRequiredElseHelp
  - DisableHelpSubcommand
  - ArgsNegateSubcommands

args:
  - track:
      help: environment + track
      required: true

subcommands:
  - deploy:
      about: Deploy command
```

If I use: `cli depl.main deploy` it suggest deploy command.

---

_Added to milestone `v3.0` by @kbknapp on 2018-07-22 01:28_

---

_Referenced in [clap-rs/clap#1389](../../clap-rs/clap/issues/1389.md) on 2018-12-13 16:54_

---

_Comment by @aurelien-naldi on 2019-01-18 14:19_

I am running into a similar problem. Disabling suggestions helps, but not fully: if the value of a required argument (which MUST thus be given before a subcommand) matches a subcommand, clap will select the subcommand and then complain that the required argument is missing or that it does not recognise the actual subcommand name.

To give some context, my CLI aims to load a datastructure from an input file, optionally apply one or several transformations and then run a subcommand on the result. A call would look like this:

`prog input_file -m modifier subcommand -f --option=value`

Here the input file is a required argument, while the modifiers are optional. The order of arguments, flags and subcommands is meant to describe the execution in a logical way.

I guess I could duplicate the "load and modify" part in all subcommands, but
* It would duplicate the information in the help and parser, for no good reason
* I would like to be able to reuse the same short flags in both parts (I have several modifiers and subcommands)
* It would break the logical meaning of the command: I want to see the input file _before_ the actions performed on it



---

_Label `Z: good first issue` added by @pksunkara on 2020-04-10 13:58_

---

_Referenced in [clap-rs/clap#1750](../../clap-rs/clap/issues/1750.md) on 2020-04-11 10:17_

---

_Label `W: 2.x` removed by @pksunkara on 2020-04-11 10:18_

---

_Label `Z: good first issue` removed by @pksunkara on 2020-04-11 10:18_

---

_Label `C: positional args` added by @pksunkara on 2020-04-11 10:18_

---

_Label `C: subcommands` added by @pksunkara on 2020-04-11 10:18_

---

_Comment by @kamilogorek on 2020-04-14 12:08_

Answering question from https://github.com/clap-rs/clap/issues/1750

> @kamilogorek Could you check that issue and try the options that are mentioned there?

As mentioned in the original issue, when `InferSubcommands` or `AllowExternalSubcommands` is used it works just fine. However, we cannot use them, as our CLI requires multiple subcommands, as well as arguments and it's too easy to miss incorrect input.



---

_Label `P3: want to have` removed by @pksunkara on 2020-04-14 12:37_

---

_Label `P1: urgent` added by @pksunkara on 2020-04-14 12:37_

---

_Referenced in [clap-rs/clap#1825](../../clap-rs/clap/issues/1825.md) on 2020-04-15 06:17_

---

_Comment by @CreepySkeleton on 2020-04-15 22:28_

Hm ,weird name. I doubt it's easy since it's a bug in parsing algorithm.

---

_Referenced in [wfxr/code-minimap#6](../../wfxr/code-minimap/issues/6.md) on 2020-10-16 02:38_

---

_Comment by @wfxr on 2020-10-16 03:06_

I also encountered the same problem. As reported in https://github.com/wfxr/code-minimap/issues/6:

```bash
$ touch compiler.rs
$ code-minimap compiler.rs
error: The subcommand 'compiler.rs' wasn't recognized
        Did you mean 'completion'?

If you believe you received this message in error, try re-running with 'code-minimap -- compiler.rs'

USAGE:
    code-minimap [OPTIONS] [FILE] [SUBCOMMAND]

For more information try --help
```

Add `--` not works:

```bash
$ code-minimap -- compiler.rs
error: The subcommand 'compiler.rs' wasn't recognized
        Did you mean 'completion'?

If you believe you received this message in error, try re-running with 'code-minimap -- compiler.rs'

USAGE:
    code-minimap [OPTIONS] [FILE] [SUBCOMMAND]

For more information try --help
```

I tried to build app with `AppSettings::ArgsNegateSubcommands` but it still doesn't seem to work.

Is there any way to solve the problem without disable `suggestion` feature for now? Or this will be fixed in the future?

---

_Comment by @pksunkara on 2020-11-07 07:41_

@ldm0 Would you like to take this one next?

---

_Comment by @ldm0 on 2020-11-07 08:38_

Yep.

---

_Referenced in [clap-rs/clap#2203](../../clap-rs/clap/pulls/2203.md) on 2020-11-07 12:38_

---

_Closed by @bors[bot] on 2020-11-07 13:23_

---
