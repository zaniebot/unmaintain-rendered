<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>add flatten prefix to allow same options to be reused. - clap-rs/clap #3443</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>add flatten prefix to allow same options to be reused.</h1>

    <div class="meta">
        <span class="state state-closed">Closed</span>
        <a href="https://github.com/clap-rs/clap/issues/3443">#3443</a>
        opened by <a href="https://github.com/dan-da">@dan-da</a>
        on 2022-02-11 01:03
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/dan-da">@dan-da</a> on 2022-02-11 01:03</div>
            <div class="timeline-body"><h3>Please complete the following tasks</h3>
<ul>
<li>[X] I have searched the <a href="https://github.com/clap-rs/clap/discussions">discussions</a></li>
<li>[X] I have searched the <a href="https://github.com/clap-rs/clap/issues">open</a> and <a href="https://github.com/clap-rs/clap/issues?q=is%3Aissue+label%3AS-wont-fix+is%3Aclosed">rejected</a> issues</li>
</ul>
<h3>Clap Version</h3>
<p>master</p>
<h3>Describe your use case</h3>
<p>#3117 and #2293 ask for a flatten prefix in order to group related options together.</p>
<p>I have a related but different use-case for the same prefix feature, which I do not see an easy workaround for.</p>
<p>In short, I want to be able to use the same set of options multiple times, with different prefixes.   This is needed for specifying different types of connection endpoints.</p>
<h3>Describe the solution you'd like</h3>
<p>So I am using a third party crate which defines a struct Config and derives StructOpt.  For simplicity, we will say it is just Config {host, port}, eg:</p>
<pre><code>#[derive(StructOpt)]
struct Config {
  #[structopt(short = &quot;p&quot;, long = &quot;port&quot;)]
  port: u16,
  #[structopt(short = &quot;a&quot;, long = &quot;address&quot;)]
  addr: IpAddr
}
</code></pre>
<p>I need to fill this Config multiple times. eg, I want to have a server-config and a p2p-config.  So I want to do something like:</p>
<pre><code>#[derive(StructOpt)]
struct Opts {
  #[structopt(flatten, prefix = &quot;p2p-&quot;)]
  p2p_config: Config,
  #[structopt(flatten, prefix = &quot;server-&quot;)]
  server_config: Config,
}
</code></pre>
<p>So the behavior i need is to:</p>
<ol>
<li>prefix the long opts of Config with the value of prefix so they are grouped and do not conflict.</li>
<li>disable the short opts of Config.</li>
</ol>
<p>If there is some existing workaround or way to do this, keeping in mind that Config is defined in a third party crate, please let me know.</p>
<p>I see that both the above-referenced issues were closed without fixing.  I hope that by describing this additional use-case and adding my voice to the choir, that decision might be re-visited.</p>
<h3>Alternatives, if applicable</h3>
<p><em>No response</em></p>
<h3>Additional Context</h3>
<p>The desired code will actually build today (minus prefix attribute), eg:</p>
<pre><code>#[derive(StructOpt)]
struct Opts {
  #[structopt(flatten)]
  p2p_config: Config,
  #[structopt(flatten)]
  server_config: Config,
}
</code></pre>
<p>but it panics at startup with:</p>
<pre><code>Non-unique argument name: port is already in use
</code></pre>
<p>This is expected because Config is used twice and flatten prefix is not supported.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">C-enhancement</span> added by @dan-da on 2022-02-11 01:03</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2022-02-11 01:19</div>
            <div class="timeline-body"><p>Unfortunately, #3117 wasn't rejected because of the use case but because of the feasibility of the implementation</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @epage on 2022-02-11 01:19</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">A-derive</span> added by @epage on 2022-02-11 01:19</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">S-duplicate</span> added by @epage on 2022-02-11 01:19</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dan-da">@dan-da</a> on 2022-02-11 03:14</div>
            <div class="timeline-body"><p>I understand if that is the case, but what about this <a href="https://github.com/clap-rs/clap/issues/3117#issuecomment-989997423">comment you made</a>?</p>
<blockquote>
<p>The real blocker here (apart from the lack of inter-expansion communication in proc-macros as mentioned above) is clap's API. To implement this we would need Arg::get_long(), Arg::get_short(), and Arg::get/set_name(&amp;str) methods.
...
But there is still a blink of light in the darkness: structopt is being imported directly into clap and, since it will be technically one repo, <strong>we could implement it with no problem</strong>.</p>
</blockquote>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2022-02-11 03:19</div>
            <div class="timeline-body"><p>I did not make that comment.  I used my account for importing comments from the structopt repo.  In the header of that comment, it says who wrote it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dan-da">@dan-da</a> on 2022-02-11 13:28</div>
            <div class="timeline-body"><p>sorry, my mistake.  SInce this is still closed, I guess you disagree with the commenter about being able to impl it &quot;with no problem&quot; once integrated into clap...?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2022-02-11 13:33</div>
            <div class="timeline-body"><p>Yes.  That commenter only addressed half the problem and didn't get into dealing with <code>FromArgMatches</code> as I talk about in my <a href="https://github.com/clap-rs/clap/issues/3117#issuecomment-991257659">comment</a>.  That or they take the approach &quot;its software, you can do anything&quot;.  It is possible for us to implement this but we'd then be burdened with large implementation complexity, the door open for  cross-derive communication which will require a breaking change for each new feature along this line, and a nearly impossible-to-implement trait design (which is one of our goals with the current trait design).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dan-da">@dan-da</a> on 2022-02-11 23:08</div>
            <div class="timeline-body"><p>ok, thanks for sharing these insights.  I will take another approach.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:35:08 UTC
    </footer>
</body>
</html>
