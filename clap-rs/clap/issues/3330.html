<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Conflicting args both present - clap-rs/clap #3330</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Conflicting args both present</h1>

    <div class="meta">
        <span class="state state-closed">Closed</span>
        <a href="https://github.com/clap-rs/clap/issues/3330">#3330</a>
        opened by <a href="https://github.com/nissaofthesea">@nissaofthesea</a>
        on 2022-01-22 23:19
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/nissaofthesea">@nissaofthesea</a> on 2022-01-22 23:19</div>
            <div class="timeline-body"><h3>Please complete the following tasks</h3>
<ul>
<li>[X] I have searched the <a href="https://github.com/clap-rs/clap/discussions">discussions</a></li>
<li>[X] I have searched the existing issues</li>
</ul>
<h3>Rust Version</h3>
<p>rustc 1.58.1 (db9d1b20b 2022-01-20)</p>
<h3>Clap Version</h3>
<p>3.0.10</p>
<h3>Minimal reproducible code</h3>
<pre><code class="language-rust">use clap::Parser;

#[derive(Debug, Parser)]
struct Args {
    /// Simulate instead of using USB
    #[clap(short = 's', conflicts_with = &quot;usb&quot;)]
    sim: bool,

    /// Sets the USB device to use
    #[clap(
        short = 'd',
        required_unless_present = &quot;sim&quot;,
        group = &quot;usb&quot;
    )]
    device: Option&lt;u32&gt;,

    /// Sets the time in milliseconds to wait for USB reads and writes
    #[clap(
        short = 't',
        default_value_t = 1000,
        required_unless_present = &quot;sim&quot;,
        group = &quot;usb&quot;
    )]
    timeout: u64,
}

fn main() {
    dbg!(Args::parse());
}
</code></pre>
<p>In <code>Cargo.toml</code>, the &quot;derive&quot; and &quot;debug&quot; features are enabled.</p>
<h3>Steps to reproduce the bug with the above code</h3>
<pre><code class="language-console">$ cargo run -- -s -d 123 # arbitrary number
&lt;output from clap &quot;debug&quot; feature is omitted&gt;
[src/main.rs:28] Args::parse() = Args {
    sim: true,
    device: Some(
        123,
    ),
    timeout: 1000,
}
</code></pre>
<h3>Actual Behaviour</h3>
<p>The <code>sim</code> option conflicts with the group <code>usb</code> (members: <code>device</code>, <code>timeout</code>). But when <code>sim</code> is present alongside <code>device</code>, clap doesn't give any errors. In the output of the program, you can see <code>sim</code> is true, and <code>device</code> has some value.</p>
<h3>Expected Behaviour</h3>
<p>I expect that <code>sim</code> and <code>device</code> both being present is an error, since <code>sim</code> conflicts with the group that <code>device</code> is a member of.</p>
<h3>Additional Context</h3>
<p>Interestingly, <code>sim</code> and <code>timeout</code> both present gives an error as expected. Also, if <code>timeout</code> is changed to not have a default value, everything works as expected.</p>
<p>Lastly, explicitly listing conflicting args using <code>conflicts_with_all</code> works.</p>
<h3>Debug Output</h3>
<pre><code class="language-console">$ cargo run -- -s -d 123
[            clap::build::app] 	App::_do_parse
[            clap::build::app] 	App::_build
[            clap::build::app] 	App::_propagate:reproducable-example
[            clap::build::app] 	App::_check_help_and_version
[            clap::build::app] 	App::_check_help_and_version: Removing generated version
[            clap::build::app] 	App::_propagate_global_args:reproducable-example
[            clap::build::app] 	App::_derive_display_order:reproducable-example
[clap::build::app::debug_asserts] 	App::_debug_asserts
[clap::build::arg::debug_asserts] 	Arg::_debug_asserts:help
[clap::build::arg::debug_asserts] 	Arg::_debug_asserts:sim
[clap::build::arg::debug_asserts] 	Arg::_debug_asserts:device
[clap::build::arg::debug_asserts] 	Arg::_debug_asserts:timeout
[clap::build::app::debug_asserts] 	App::_verify_positionals
[         clap::parse::parser] 	Parser::get_matches_with
[         clap::parse::parser] 	Parser::_build
[         clap::parse::parser] 	Parser::get_matches_with: Begin parsing 'RawOsStr(&quot;-s&quot;)' ([45, 115])
[         clap::parse::parser] 	Parser::get_matches_with: Positional counter...1
[         clap::parse::parser] 	Parser::get_matches_with: Low index multiples...false
[         clap::parse::parser] 	Parser::possible_subcommand: arg=RawOsStr(&quot;-s&quot;)
[         clap::parse::parser] 	Parser::get_matches_with: sc=None
[         clap::parse::parser] 	Parser::parse_short_arg: short_arg=RawOsStr(&quot;s&quot;)
[         clap::parse::parser] 	Parser::parse_short_arg:iter:s
[         clap::parse::parser] 	Parser::parse_short_arg:iter:s: cur_idx:=1
[         clap::parse::parser] 	Parser::parse_short_arg:iter:s: Found valid opt or flag
[         clap::parse::parser] 	Parser::check_for_help_and_version_char
[         clap::parse::parser] 	Parser::check_for_help_and_version_char: Checking if -s is help or version...
[         clap::parse::parser] 	Neither
[         clap::parse::parser] 	Parser::parse_flag
[         clap::parse::parser] 	Parser::remove_overrides: id=sim
[    clap::parse::arg_matcher] 	ArgMatcher::inc_occurrence_of_arg: id=sim
[            clap::build::app] 	App::groups_for_arg: id=sim
[         clap::parse::parser] 	Parser::get_matches_with: After parse_short_arg ValuesDone
[         clap::parse::parser] 	Parser::get_matches_with: Begin parsing 'RawOsStr(&quot;-d&quot;)' ([45, 100])
[         clap::parse::parser] 	Parser::get_matches_with: Positional counter...1
[         clap::parse::parser] 	Parser::get_matches_with: Low index multiples...false
[         clap::parse::parser] 	Parser::possible_subcommand: arg=RawOsStr(&quot;-d&quot;)
[         clap::parse::parser] 	Parser::get_matches_with: sc=None
[         clap::parse::parser] 	Parser::parse_short_arg: short_arg=RawOsStr(&quot;d&quot;)
[         clap::parse::parser] 	Parser::parse_short_arg:iter:d
[         clap::parse::parser] 	Parser::parse_short_arg:iter:d: cur_idx:=2
[         clap::parse::parser] 	Parser::parse_short_arg:iter:d: Found valid opt or flag
[         clap::parse::parser] 	Parser::parse_short_arg:iter:d: val=RawOsStr(&quot;&quot;) (bytes), val=[] (ascii), short_arg=RawOsStr(&quot;d&quot;)
[         clap::parse::parser] 	Parser::parse_opt; opt=device, val=None
[         clap::parse::parser] 	Parser::parse_opt; opt.settings=ArgFlags(TAKES_VAL)
[         clap::parse::parser] 	Parser::parse_opt; Checking for val...
[         clap::parse::parser] 	Parser::parse_opt: More arg vals required...
[         clap::parse::parser] 	Parser::remove_overrides: id=device
[    clap::parse::arg_matcher] 	ArgMatcher::inc_occurrence_of_arg: id=device
[            clap::build::app] 	App::groups_for_arg: id=device
[    clap::parse::arg_matcher] 	ArgMatcher::inc_occurrence_of_group: id=usb
[            clap::build::app] 	App::groups_for_arg: id=device
[         clap::parse::parser] 	Parser::get_matches_with: After parse_short_arg Opt(device)
[         clap::parse::parser] 	Parser::get_matches_with: Begin parsing 'RawOsStr(&quot;123&quot;)' ([49, 50, 51])
[         clap::parse::parser] 	Parser::get_matches_with: Positional counter...1
[         clap::parse::parser] 	Parser::get_matches_with: Low index multiples...false
[         clap::parse::parser] 	Parser::add_val_to_arg; arg=device, val=RawOsStr(&quot;123&quot;)
[         clap::parse::parser] 	Parser::add_val_to_arg; trailing_values=false, DontDelimTrailingVals=false
[         clap::parse::parser] 	Parser::add_single_val_to_arg: adding val...&quot;123&quot;
[         clap::parse::parser] 	Parser::add_single_val_to_arg: cur_idx:=3
[            clap::build::app] 	App::groups_for_arg: id=device
[    clap::parse::arg_matcher] 	ArgMatcher::needs_more_vals: o=device
[      clap::parse::validator] 	Validator::validate
[         clap::parse::parser] 	Parser::add_defaults
[         clap::parse::parser] 	Parser::add_defaults:iter:device:
[         clap::parse::parser] 	Parser::add_value: doesn't have conditional defaults
[         clap::parse::parser] 	Parser::add_value:iter:device: doesn't have default vals
[         clap::parse::parser] 	Parser::add_value:iter:device: doesn't have default missing vals
[         clap::parse::parser] 	Parser::add_defaults:iter:timeout:
[         clap::parse::parser] 	Parser::add_value: doesn't have conditional defaults
[         clap::parse::parser] 	Parser::add_value:iter:timeout: has default vals
[         clap::parse::parser] 	Parser::add_value:iter:timeout: wasn't used
[            clap::build::app] 	App::groups_for_arg: id=timeout
[         clap::parse::parser] 	Parser::add_single_val_to_arg: adding val...&quot;1000&quot;
[         clap::parse::parser] 	Parser::add_single_val_to_arg: cur_idx:=4
[            clap::build::app] 	App::groups_for_arg: id=timeout
[         clap::parse::parser] 	Parser::add_value:iter:timeout: doesn't have default missing vals
[      clap::parse::validator] 	Validator::validate_conflicts
[      clap::parse::validator] 	Validator::validate_exclusive
[      clap::parse::validator] 	Validator::validate_exclusive:iter:sim
[      clap::parse::validator] 	Validator::validate_exclusive:iter:device
[      clap::parse::validator] 	Validator::validate_exclusive:iter:usb
[      clap::parse::validator] 	Validator::validate_exclusive:iter:timeout
[      clap::parse::validator] 	Validator::validate_conflicts::iter: id=sim
[      clap::parse::validator] 	Conflicts::gather_conflicts
[            clap::build::app] 	App::groups_for_arg: id=sim
[      clap::parse::validator] 	Conflicts::gather_direct_conflicts id=sim, conflicts=[usb]
[            clap::build::app] 	App::groups_for_arg: id=device
[      clap::parse::validator] 	Conflicts::gather_direct_conflicts id=device, conflicts=[timeout]
[      clap::parse::validator] 	Validator::validate_conflicts::iter: id=device
[      clap::parse::validator] 	Conflicts::gather_conflicts
[      clap::parse::validator] 	Validator::validate_required: required=ChildGraph([])
[      clap::parse::validator] 	Validator::gather_requirements
[      clap::parse::validator] 	Validator::gather_requirements:iter:sim
[      clap::parse::validator] 	Validator::gather_requirements:iter:device
[      clap::parse::validator] 	Validator::gather_requirements:iter:usb
[      clap::parse::validator] 	Validator::gather_requirements:iter:usb:group
[      clap::parse::validator] 	Validator::gather_requirements:iter:timeout
[      clap::parse::validator] 	Validator::validate_required_unless
[      clap::parse::validator] 	Validator::validate_matched_args
[      clap::parse::validator] 	Validator::validate_matched_args:iter:sim: vals=Flatten {
    inner: FlattenCompat {
        iter: Fuse {
            iter: Some(
                Iter(
                    [],
                ),
            ),
        },
        frontiter: None,
        backiter: None,
    },
}
[      clap::parse::validator] 	Validator::validate_arg_num_vals
[      clap::parse::validator] 	Validator::validate_arg_values: arg=&quot;sim&quot;
[      clap::parse::validator] 	Validator::validate_arg_num_occurs: &quot;sim&quot;=1
[      clap::parse::validator] 	Validator::validate_matched_args:iter:device: vals=Flatten {
    inner: FlattenCompat {
        iter: Fuse {
            iter: Some(
                Iter(
                    [
                        [
                            &quot;123&quot;,
                        ],
                    ],
                ),
            ),
        },
        frontiter: None,
        backiter: None,
    },
}
[      clap::parse::validator] 	Validator::validate_arg_num_vals
[      clap::parse::validator] 	Validator::validate_arg_values: arg=&quot;device&quot;
[      clap::parse::validator] 	Validator::validate_arg_values: checking validator...
[      clap::parse::validator] 	good
[      clap::parse::validator] 	Validator::validate_arg_num_occurs: &quot;device&quot;=1
[      clap::parse::validator] 	Validator::validate_matched_args:iter:usb: vals=Flatten {
    inner: FlattenCompat {
        iter: Fuse {
            iter: Some(
                Iter(
                    [
                        [
                            &quot;123&quot;,
                        ],
                        [
                            &quot;1000&quot;,
                        ],
                    ],
                ),
            ),
        },
        frontiter: None,
        backiter: None,
    },
}
[      clap::parse::validator] 	Validator::validate_matched_args:iter:timeout: vals=Flatten {
    inner: FlattenCompat {
        iter: Fuse {
            iter: Some(
                Iter(
                    [
                        [
                            &quot;1000&quot;,
                        ],
                    ],
                ),
            ),
        },
        frontiter: None,
        backiter: None,
    },
}
[      clap::parse::validator] 	Validator::validate_arg_num_vals
[      clap::parse::validator] 	Validator::validate_arg_values: arg=&quot;timeout&quot;
[      clap::parse::validator] 	Validator::validate_arg_values: checking validator...
[      clap::parse::validator] 	good
[      clap::parse::validator] 	Validator::validate_arg_num_occurs: &quot;timeout&quot;=0
[    clap::parse::arg_matcher] 	ArgMatcher::get_global_values: global_arg_vec=[help]
&lt;output from actual program is omitted&gt;
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">C-bug</span> added by @nissaofthesea on 2022-01-22 23:19</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2022-01-23 01:32</div>
            <div class="timeline-body"><p>So not dug into the debug output (which should have some useful stuff because I had to debug and rewrite conflicts right before release) or the code but my guess is that the core of the issue is using a flag.</p>
<p>For an arg, we track presence, occurrences, and values.  A lot of these rules only work on a value but flags never set a value and rely purely on presence.</p>
<p>This and several related issues has been building in me a sense that special casing flags like this is a mistake and that we should instead define an action that can be performed when a flag is present, like setting a value to true, counting, etc.  Maybe I'm just biased from my CLI background being heavily in Python and this is how <code>argparse</code> does it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">A-validators</span> added by @epage on 2022-01-23 01:32</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">S-triage</span> added by @epage on 2022-01-23 01:32</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/mzagrabe">@mzagrabe</a> on 2022-01-24 14:51</div>
            <div class="timeline-body"><p>On Sat, Jan 22, 2022 at 7:32 PM Ed Page <em><strong>@</strong></em>.***&gt; wrote:</p>
<blockquote>
<p>So not dug into the debug output (which should have some useful stuff
because I had to debug and rewrite conflicts right before release) or the
code but my guess is that the core of the issue is using a flag.</p>
<p>For an arg, we track presence, occurrences, and values. A lot of these
rules only work on a value but flags never set a value and rely purely on
presence.</p>
<p>This and several related issues has been building in me a sense that
special casing flags like this is a mistake and that we should instead
define an action that can be performed when a flag is present, like setting
a value to true, counting, etc. Maybe I'm just biased from my CLI
background being heavily in Python and this is how argparse does it.</p>
</blockquote>
<p>I think imitating argparse is sensible. Not only does it give a general
roadmap for decisions making when encountering design considerations, but
also provides familiarity and reduces friction for those of us with arparse
backgrounds now relying on clap.</p>
<p>-m</p>
<blockquote>
<p>Message ID: <em><strong>@</strong></em>.***&gt;</p>
</blockquote>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../pwinckles/rocfl/issues/18.html">pwinckles/rocfl#18</a> on 2022-01-24 15:02</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2022-01-24 16:21</div>
            <div class="timeline-body"><p>Ok, looks like this is unrelated to that problem.</p>
<p>We are incorrectly handling defaults in groups.  We track the source of a group (command-line, env, defaults).  Unfortunately, defaults are overriding any prior source.  So instead of treating the <code>usb</code> group as being from the command line, we are treating it as being from defaults (because they are the last one to write the source) and so there is no conflict (we don't conflict with defaults).</p>
<p>A workaround until this is fixed is to not use clap-defined defaults.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">S-triage</span> removed by @epage on 2022-01-24 16:22</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">E-medium</span> added by @epage on 2022-01-24 16:22</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/pwinckles">@pwinckles</a> on 2022-01-24 16:26</div>
            <div class="timeline-body"><blockquote>
<p>Ok, looks like this is unrelated to that problem.</p>
</blockquote>
<p>Whoops, sorry. I clearly only skimmed this issue and did not read. :blush: I'll create a new issue for the problem I'm seeing.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/3334.html">clap-rs/clap#3334</a> on 2022-01-24 16:36</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @epage on 2022-01-24 16:51</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2022-01-24 16:55</div>
            <div class="timeline-body"><p>v3.0.11 is released with the fix</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/3337.html">clap-rs/clap#3337</a> on 2022-01-25 06:22</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../uutils/coreutils/issues/3262.html">uutils/coreutils#3262</a> on 2022-03-17 10:10</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:35:08 UTC
    </footer>
</body>
</html>
