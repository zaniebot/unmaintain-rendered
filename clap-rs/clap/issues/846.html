<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shell completion generation fails in loop with global flags/options - clap-rs/clap #846</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Shell completion generation fails in loop with global flags/options</h1>

    <div class="meta">
        <span class="state state-closed">Closed</span>
        <a href="https://github.com/clap-rs/clap/issues/846">#846</a>
        opened by <a href="https://github.com/Fleshgrinder">@Fleshgrinder</a>
        on 2017-02-08 22:06
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/Fleshgrinder">@Fleshgrinder</a> on 2017-02-08 22:06</div>
            <div class="timeline-body"><h3>Rust Version</h3>
<p><code>N/A</code></p>
<h3>Affected Version of clap</h3>
<p>Probably all but 2.20.3 was the one where the bug was encountered.</p>
<h3>Expected Behavior Summary</h3>
<p>Build and compilation should succeed.</p>
<h3>Actual Behavior Summary</h3>
<p>Build fails with the following output:</p>
<pre><code>$ cargo build
   Compiling mwe v0.1.0 (file:///D:/GitHub/rust-phpup)
error: failed to run custom build command for `mwe v0.1.0 (file:///D:/GitHub/rust-phpup)`
process didn't exit successfully: `D:\GitHub\rust-phpup\target\debug\build\mwe-563482c66f20550f\build-script-build` (exit code: 101)
--- stderr
thread 'main' panicked at 'Non-unique argument name: quiet is already in use', C:\Users\Fleshgrinder\.cargo\registry\src\github.com-1ecc6299db9ec823\clap-2.20.3\src\app\parser.rs:147
note: Run with `RUST_BACKTRACE=1` for a backtrace.
</code></pre>
<h3>Steps to Reproduce the issue</h3>
<p><code>cargo build</code> the code linked in the Gist</p>
<h3>Sample Code or Link to Sample Code</h3>
<p>https://gist.github.com/Fleshgrinder/3b562bb6c91deb49635543e68f720651</p>
<h3>Reason</h3>
<p>The problem occurs due to <code>gen_completion</code> and <code>build.rs</code> where <a href="https://gist.github.com/Fleshgrinder/3b562bb6c91deb49635543e68f720651#file-build-rs-L8-L15">the <em>app</em> is reused in the loop</a> as you discovered already in a short Gitter chat.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/kbknapp">@kbknapp</a> on 2017-02-09 16:00</div>
            <div class="timeline-body"><p>Thanks, as per our discussion on gitter, I shuold have this fixed soon ðŸ˜„</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/kbknapp">@kbknapp</a> on 2017-02-09 16:04</div>
            <div class="timeline-body"><p>Also, incase anyone else is running into this calling the <code>gen_completions</code> causes all global <code>Arg</code>s to be propogated, on second and further iterations of the loop, this causes duplicate <code>Arg</code>s to be built which is an error.</p>
<p>This is a bug, and those duplicate <code>Arg</code>s should be ignored in this case.</p>
<p>The temporary fix is to rebuild the <code>App</code> struct with each iteration of the loop (which takes nanoseconds, so isn't a big deal).</p>
<pre><code class="language-rust">for shell in &amp;[Shell::Bash, Shell::PowerShell] {
    let mut app = build_cli();
    app.gen_completions(env!(&quot;CARGO_PKG_NAME&quot;), *shell, env!(&quot;OUT_DIR&quot;));
}
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">C: completion gen</span> added by @kbknapp on 2017-02-09 16:04</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">D: easy</span> added by @kbknapp on 2017-02-09 16:04</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">P3: want to have</span> added by @kbknapp on 2017-02-09 16:04</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">T: bug</span> added by @kbknapp on 2017-02-09 16:04</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">W: 2.x</span> added by @kbknapp on 2017-02-09 16:04</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone "2.20.4" by @kbknapp on 2017-02-09 16:04</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @homu on 2017-02-15 18:24</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:35:07 UTC
    </footer>
</body>
</html>
