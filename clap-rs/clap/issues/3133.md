```yaml
number: 3133
title: "Duplicate short option (and other misconfigurations) gives runtime error, wouldn't it be cool, if it was compile time error"
type: issue
state: open
author: epage
labels:
  - C-enhancement
  - S-waiting-on-decision
  - A-derive
assignees: []
created_at: 2021-12-09T16:34:15Z
updated_at: 2022-12-15T13:19:43Z
url: https://github.com/clap-rs/clap/issues/3133
synced_at: 2026-01-10T01:57:46Z
```

# Duplicate short option (and other misconfigurations) gives runtime error, wouldn't it be cool, if it was compile time error

---

_Issue opened by @epage on 2021-12-09 16:34_

<a href="https://github.com/typetetris"><img src="https://avatars.githubusercontent.com/u/1983821?v=4" align="left" width="96" height="96" hspace="10"></img></a> **Issue by [typetetris](https://github.com/typetetris)**
_Tuesday Oct 05, 2021 at 13:32 GMT_
_Originally opened as https://github.com/TeXitoi/structopt/issues/500_

----

Something like
```
use structopt::StructOpt;

#[derive(Debug,StructOpt)]
struct Opt {
      #[structopt(short, long)]
      fnord: u16,

      #[structopt(short, long)]
      file: String
}
```
gives an error at runtime of the program.

It would be way cooler, if it was a compile time error.

If you agree, I could look into trying to implement this.


---

_Comment by @epage on 2021-12-09 16:34_

<a href="https://github.com/TeXitoi"><img src="https://avatars.githubusercontent.com/u/5787066?v=4" align="left" width="48" height="48" hspace="10"></img></a> **Comment by [TeXitoi](https://github.com/TeXitoi)**
_Tuesday Oct 05, 2021 at 15:15 GMT_

----

I doubt this particular example will panic. Edit: ho, OK, short argument, yep, it'll panic.

There is no easy way of checking you use the same name several times. Basic case is double, bit when you add flatten and friends, it can become a nightmare. I don't want complicated code to do compile time check that would be catch in all case with a basic test. Now, if the code is really trivial, why not, but I doubt.


---

_Label `A-derive` added by @epage on 2021-12-09 16:39_

---

_Label `C-enhancement` added by @epage on 2021-12-09 16:39_

---

_Comment by @pksunkara on 2021-12-10 01:55_

This is panic during development runtime now. But looks the issue is talking about compile time.

---

_Comment by @epage on 2021-12-10 19:34_

Yes.  As TeXitoi says, we can do this in the trivial case though it won't scale to complex caes (`flatten`).

For the trivial case, the main complication is how we currently have the code structured.  We take the raw attributes and convert them straight to `Method`s.

Our options for implementing this:
- Select specific `Method`s that we check for duplicates across fields.  This seems more straightforward but is more brittle.
- Preserve all of the `ClapAttr`s we parsed and compare those.  Requires some restructuring of the code but less brittle.

---

_Referenced in [clap-rs/clap#2740](../../clap-rs/clap/issues/2740.md) on 2021-12-13 17:49_

---

_Comment by @epage on 2021-12-13 17:50_

Note: we have #2740 which is about supporting all of the debug assets at compile time.

---

_Label `S-waiting-on-decision` added by @epage on 2021-12-13 22:39_

---

_Referenced in [clap-rs/clap#3202](../../clap-rs/clap/issues/3202.md) on 2021-12-22 19:19_

---

_Comment by @martinvonz on 2022-03-23 17:26_

A workaround seems to be to use `clap_complete`. That seems to catch the cases I've cared about. I don't know what the complication caused by `flatten` is, but it seems feasible to at least catch the things that generation of command-line-completion scripts will catch, right?

---

_Comment by @epage on 2022-03-23 17:34_

Could you expand on how `clap_complete` is catching these cases?  It seems like it only be able to report them at runtime as well, and not compile time.

We do recommend creating tests out of the runtime checks which will catch it during development and will check every subcommand possible, rather than what was run by the user.  See https://github.com/clap-rs/clap/blob/v3.1.6/examples/tutorial_builder/README.md#tips

---

_Comment by @martinvonz on 2022-03-23 17:42_

Ah, sorry, I was unclear. What I meant is that I used `clap_complete` at runtime to catch *all* (AFAICT) errors instead of having to test-run each command and subcommand to see if its definition is valid. So it seems `debug_assert()` is a better way of doing that then (thanks!). I guess what I (and @typetetris?) were expecting was for that to run at compile-time instead.

---

_Comment by @epage on 2022-03-23 17:50_

> I guess what I (and @typetetris?) were expecting was for that to run at compile-time instead.

Yes, I understand that but that increases our maintenance burden because we have to support and test the checks at both compile time and runtime.  We also would need to detect and limit what checks we run when the user `#[clap(flatten)]`s one struct into another ([example](https://github.com/clap-rs/clap/blob/master/examples/git-derive.rs#L43)) because we only have knowledge of the struct we are currently processing.  I'm also concerned that having different behavior for with and without `flatten` will confuse users.

---

_Comment by @martinvonz on 2022-03-23 17:56_

Makes sense. I understand the issue with `flatten` now. It's also much less of a concern to me now that I have added that `debug_assert()` test case you suggested.

---

_Referenced in [clap-rs/clap#3592](../../clap-rs/clap/issues/3592.md) on 2022-03-30 18:16_

---

_Renamed from "Duplicate short option gives runtime error, wouldn't it be cool, if it was compile time error" to "Duplicate short option (and other misconfigurations) gives runtime error, wouldn't it be cool, if it was compile time error" by @epage on 2022-12-15 13:19_

---

_Referenced in [clap-rs/clap#4556](../../clap-rs/clap/issues/4556.md) on 2022-12-15 13:21_

---

_Referenced in [clap-rs/clap#4715](../../clap-rs/clap/issues/4715.md) on 2023-02-19 01:49_

---

_Referenced in [clap-rs/clap#4816](../../clap-rs/clap/issues/4816.md) on 2023-03-31 19:54_

---

_Referenced in [clap-rs/clap#4837](../../clap-rs/clap/issues/4837.md) on 2023-04-17 15:28_

---

_Referenced in [clap-rs/clap#4467](../../clap-rs/clap/issues/4467.md) on 2023-05-08 11:55_

---

_Referenced in [clap-rs/clap#5215](../../clap-rs/clap/issues/5215.md) on 2023-11-15 14:21_

---

_Referenced in [clap-rs/clap#5690](../../clap-rs/clap/issues/5690.md) on 2024-08-21 14:22_

---

_Referenced in [esp-rs/espflash#746](../../esp-rs/espflash/pulls/746.md) on 2025-02-06 12:30_

---

_Referenced in [clap-rs/clap#6174](../../clap-rs/clap/issues/6174.md) on 2025-11-03 16:17_

---
