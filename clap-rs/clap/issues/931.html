<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Error with Powershell tab completion script - clap-rs/clap #931</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Error with Powershell tab completion script</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/clap-rs/clap/issues/931">#931</a>
        opened by <a href="https://github.com/elirnm">@elirnm</a>
        on 2017-04-11 19:53
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/elirnm">@elirnm</a></div>
            <div class="timeline-body"><p>Reposted from <a href="https://github.com/BurntSushi/ripgrep/issues/445">BurntSushi/ripgrep#445</a></p>
<hr>
<p>Attempting to import the _rg.ps1 tab completion script into Powershell throws an exception:</p>
<pre><code>At C:\PathTools\_rg.ps1:10 char:41
+                 switch ($_.ToString()) {
+                                         ~
Missing condition in switch statement clause.
    + CategoryInfo          : ParserError: (:) [], ParseException
    + FullyQualifiedErrorId : MissingSwitchConditionExpression
</code></pre>
<p>There&#x27;s an empty switch statement there that seems like the cause.</p>
<p>$PSVersionTable:</p>
<pre><code>Name                           Value
----                           -----
PSVersion                      5.1.14409.1005
PSEdition                      Desktop
PSCompatibleVersions           {1.0, 2.0, 3.0, 4.0...}
BuildVersion                   10.0.14409.1005
CLRVersion                     4.0.30319.42000
WSManStackVersion              3.0
PSRemotingProtocolVersion      2.3
SerializationVersion           1.1.0.1

</code></pre>
<p>This is with ripgrep version 0.5.1</p>
<p>Here&#x27;s the ps1 file.</p>
<pre><code>@(&#x27;rg&#x27;, &#x27;./rg&#x27;, &#x27;rg.exe&#x27;, &#x27;.\rg&#x27;, &#x27;.\rg.exe&#x27;, &#x27;./rg.exe&#x27;) | %{
    Register-ArgumentCompleter -Native -CommandName $_ -ScriptBlock {
        param($wordToComplete, $commandAst, $cursorPosition)

        $command = &#x27;_rg&#x27;
        $commandAst.CommandElements |
            Select-Object -Skip 1 |
            %{
                switch ($_.ToString()) {

                }
            }

        $completions = @()

        switch ($command) {

            &#x27;_ripgrep&#x27; {
                $completions = @(&#x27;-a&#x27;, &#x27;-c&#x27;, &#x27;-F&#x27;, &#x27;-i&#x27;, &#x27;-n&#x27;, &#x27;-N&#x27;, &#x27;-q&#x27;, &#x27;-u&#x27;, &#x27;-v&#x27;, &#x27;-w&#x27;, &#x27;-l&#x27;, &#x27;-H&#x27;, &#x27;-L&#x27;, &#x27;-0&#x27;, &#x27;-o&#x27;, &#x27;-p&#x27;, &#x27;-s&#x27;, &#x27;-S&#x27;, &#x27;-h&#x27;, &#x27;-V&#x27;, &#x27;-e&#x27;, &#x27;-E&#x27;, &#x27;-g&#x27;, &#x27;-t&#x27;, &#x27;-T&#x27;, &#x27;-A&#x27;, &#x27;-B&#x27;, &#x27;-C&#x27;, &#x27;-f&#x27;, &#x27;-m&#x27;, &#x27;-r&#x27;, &#x27;-j&#x27;, &#x27;-M&#x27;, &#x27;--files&#x27;, &#x27;--type-list&#x27;, &#x27;--text&#x27;, &#x27;--count&#x27;, &#x27;--fixed-strings&#x27;, &#x27;--ignore-case&#x27;, &#x27;--line-number&#x27;, &#x27;--no-line-number&#x27;, &#x27;--quiet&#x27;, &#x27;--unrestricted&#x27;, &#x27;--invert-match&#x27;, &#x27;--word-regexp&#x27;, &#x27;--column&#x27;, &#x27;--debug&#x27;, &#x27;--files-with-matches&#x27;, &#x27;--files-without-match&#x27;, &#x27;--with-filename&#x27;, &#x27;--no-filename&#x27;, &#x27;--heading&#x27;, &#x27;--no-heading&#x27;, &#x27;--hidden&#x27;, &#x27;--follow&#x27;, &#x27;--mmap&#x27;, &#x27;--no-messages&#x27;, &#x27;--no-mmap&#x27;, &#x27;--no-ignore&#x27;, &#x27;--no-ignore-parent&#x27;, &#x27;--no-ignore-vcs&#x27;, &#x27;--null&#x27;, &#x27;--only-matching&#x27;, &#x27;--pretty&#x27;, &#x27;--case-sensitive&#x27;, &#x27;--smart-case&#x27;, &#x27;--sort-files&#x27;, &#x27;--vimgrep&#x27;, &#x27;--help&#x27;, &#x27;--version&#x27;, &#x27;--regexp&#x27;, &#x27;--color&#x27;, &#x27;--colors&#x27;, &#x27;--encoding&#x27;, &#x27;--glob&#x27;, &#x27;--type&#x27;, &#x27;--type-not&#x27;, &#x27;--after-context&#x27;, &#x27;--before-context&#x27;, &#x27;--context&#x27;, &#x27;--context-separator&#x27;, &#x27;--file&#x27;, &#x27;--ignore-file&#x27;, &#x27;--max-count&#x27;, &#x27;--max-filesize&#x27;, &#x27;--maxdepth&#x27;, &#x27;--path-separator&#x27;, &#x27;--replace&#x27;, &#x27;--threads&#x27;, &#x27;--max-columns&#x27;, &#x27;--type-add&#x27;, &#x27;--type-clear&#x27;)
            }

        }

        $completions |
            ?{ $_ -like &quot;$wordToComplete*&quot; } |
            Sort-Object |
            %{ New-Object System.Management.Automation.CompletionResult $_, $_, &#x27;ParameterValue&#x27;, $_ }
    }
}
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/kbknapp">@kbknapp</a> on 2017-04-18 00:59</div>
            <div class="timeline-body"><p>Thanks for reporting! This is because ripgrep has no subcommands. I think simply adding a default will fix this. If someone wants an easy first PR this is one!</p>
<p>So adding <a href="https://github.com/kbknapp/clap-rs/blob/3f44dd4b91d15ec9287eb236e2d3a2fd068afad1/src/completions/powershell.rs#L44-L46">a line here</a>:</p>
<pre><code> default { }
</code></pre>
<p>or <code>default { break }</code> if PowerShell doesn&#x27;t support empty braces (can&#x27;t remember).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">C: completion gen</span> added by <a href="https://github.com/kbknapp">@kbknapp</a> on 2017-04-18 01:00</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">D: easy</span> added by <a href="https://github.com/kbknapp">@kbknapp</a> on 2017-04-18 01:00</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">M: mentored</span> added by <a href="https://github.com/kbknapp">@kbknapp</a> on 2017-04-18 01:00</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">P1: urgent</span> added by <a href="https://github.com/kbknapp">@kbknapp</a> on 2017-04-18 01:00</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">T: bug</span> added by <a href="https://github.com/kbknapp">@kbknapp</a> on 2017-04-18 01:00</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">W: 2.x</span> added by <a href="https://github.com/kbknapp">@kbknapp</a> on 2017-04-18 01:00</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/elirnm">@elirnm</a> on 2017-04-18 04:43</div>
            <div class="timeline-body"><p>Hmm, adding <code>default { }</code> into the script makes it load without throwing exceptions, but I still don&#x27;t get any tab completion functionality.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/kbknapp">@kbknapp</a> on 2017-04-18 16:43</div>
            <div class="timeline-body"><p>Ok, I did some testing and it looks like it&#x27;s a double issue.</p>
<ul>
<li>Adding <code>default { break }</code> works but the second bug prevents the completions...</li>
<li>it&#x27;s using the <code>App</code> name (<code>ripgrep</code>) and not the binary name (<code>rg</code>) which is <a href="https://github.com/kbknapp/clap-rs/blob/3f44dd4b91d15ec9287eb236e2d3a2fd068afad1/src/completions/powershell.rs#L74">a bug here</a> (should be using <code>bin_name</code> not <code>name</code>)</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/kbknapp">@kbknapp</a> on 2017-04-18 16:45</div>
            <div class="timeline-body"><p>Here&#x27;s the excerpt of the generated script using the name, when it should be using the bin name:</p>
<pre><code>switch ($command) {
    &#x27;_ripgrep&#x27; {
        $completions = @(&#x27;-a&#x27;, &#x27;-c&#x27;, &#x27;-F&#x27;, &#x27;-i&#x27;, &#x27;-n&#x27;, &#x27;-N&#x27;, &#x27;-q&#x27;, &#x27;-u&#x27;, &#x27;-v&#x27;, &#x27;-w&#x27;, &#x27;-l&#x27;, &#x27;-H&#x27;, &#x27;-L&#x27;, &#x27;-0&#x27;, &#x27;-o&#x27;, &#x27;-p&#x27;, &#x27;-s&#x27;, &#x27;-S&#x27;, &#x27;-h&#x27;, &#x27;-V&#x27;, &#x27;-e&#x27;, &#x27;-E&#x27;, &#x27;-g&#x27;, &#x27;-t&#x27;, &#x27;-T&#x27;, &#x27;-A&#x27;, &#x27;-B&#x27;, &#x27;-C&#x27;, &#x27;-f&#x27;, &#x27;-m&#x27;, &#x27;-r&#x27;, &#x27;-j&#x27;, &#x27;-M&#x27;, &#x27;--files&#x27;, &#x27;--type-list&#x27;, &#x27;--text&#x27;, &#x27;--count&#x27;, &#x27;--fixed-strings&#x27;, &#x27;--ignore-case&#x27;, &#x27;--line-number&#x27;, &#x27;--no-line-number&#x27;, &#x27;--quiet&#x27;, &#x27;--unrestricted&#x27;, &#x27;--invert-match&#x27;, &#x27;--word-regexp&#x27;, &#x27;--column&#x27;, &#x27;--debug&#x27;, &#x27;--files-with-matches&#x27;, &#x27;--files-without-match&#x27;, &#x27;--with-filename&#x27;, &#x27;--no-filename&#x27;, &#x27;--heading&#x27;, &#x27;--no-heading&#x27;, &#x27;--hidden&#x27;, &#x27;--follow&#x27;, &#x27;--mmap&#x27;, &#x27;--no-messages&#x27;, &#x27;--no-mmap&#x27;, &#x27;--no-ignore&#x27;, &#x27;--no-ignore-parent&#x27;, &#x27;--no-ignore-vcs&#x27;, &#x27;--null&#x27;, &#x27;--only-matching&#x27;, &#x27;--pretty&#x27;, &#x27;--case-sensitive&#x27;, &#x27;--smart-case&#x27;, &#x27;--sort-files&#x27;, &#x27;--vimgrep&#x27;, &#x27;--help&#x27;, &#x27;--version&#x27;, &#x27;--regexp&#x27;, &#x27;--color&#x27;, &#x27;--colors&#x27;, &#x27;--encoding&#x27;, &#x27;--glob&#x27;, &#x27;--type&#x27;, &#x27;--type-not&#x27;, &#x27;--after-context&#x27;, &#x27;--before-context&#x27;, &#x27;--context&#x27;, &#x27;--context-separator&#x27;, &#x27;--dfa-size-limit&#x27;, &#x27;--file&#x27;, &#x27;--ignore-file&#x27;, &#x27;--max-count&#x27;, &#x27;--max-filesize&#x27;, &#x27;--maxdepth&#x27;, &#x27;--path-separator&#x27;, &#x27;--replace&#x27;, &#x27;--regex-size-limit&#x27;, &#x27;--threads&#x27;, &#x27;--max-columns&#x27;, &#x27;--type-add&#x27;, &#x27;--type-clear&#x27;)
    }
}
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/homu">@homu</a> on 2017-04-19 12:35</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/kbknapp">@kbknapp</a> on 2017-04-19 12:36</div>
            <div class="timeline-body"><p>Fixed in 2.23.3</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a>BurntSushi/ripgrep#472</a> on 2017-05-04 04:40</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a>7BIndustries/sliderule-cli#36</a> on 2019-02-06 11:52</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:56:49 UTC
    </footer>
</body>
</html>
