<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Expand template macros found in Rust comments [feature request] - clap-rs/clap #2033</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Expand template macros found in Rust comments [feature request]</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/clap-rs/clap/issues/2033">#2033</a>
        opened by <a href="https://github.com/sjackman">@sjackman</a>
        on 2020-07-24 17:53
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sjackman">@sjackman</a></div>
            <div class="timeline-body">Make sure you completed the following tasks
<ul>
<li>[x] Searched the <a href="https://github.com/clap-rs/clap/discussions">discussions</a></li>
<li>[x] Searched the closed issues</li>
</ul>
Describe your use case
<p>I&#x27;m using the <code>clap</code> with its derive macros. The same library code is used with two separate executables. I&#x27;d like to include the name of the executable in the about text of a command line argument. For example.</p>
Describe the solution you&#x27;d like
<pre><code>    /// Path to the JSON file produced by &#x27;{bin} clean --out=JSON INPUT.TXT&#x27;
    #[clap(long = &quot;json&quot;)]
    pub json: CliPath,
</code></pre>
<p>where <code>{bin}</code> is the name of one of the two executables that uses this library code.</p>
Alternatives, if applicable
<p>We could convert the program to use builder notation rather than the derive macros, which would make it easier to programmatically format the text of an about option. All of our projects use the derive macros though, so this would be a deviation from our other projects. Is either the YAML or macro mode appropriate?</p>
Additional context
<p>Thank you very much for Clap! It&#x27;s fantastic!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">T: new feature</span> added by <a href="https://github.com/sjackman">@sjackman</a> on 2020-07-24 17:53</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/CreepySkeleton">@CreepySkeleton</a> on 2020-07-24 20:36</div>
            <div class="timeline-body"><p>I think this is one of those feature requests which are, while unquestionably useful, very hard to design and implement properly.</p>
Why derive-only won&#x27;t do
<p>For starters, this cannot be derive macro only feature because</p>
<ul>
<li>The binary name (for example) is unknown until runtime, and <code>#[derive(Clap)]</code> works at &quot;macro expansion time&quot;. There&#x27;s no <code>{bin}</code>  we could replace the placeholder with, or rather, it&#x27;s to be determined when you actually run the program (aliases and stuff). The derive code doesn&#x27;t have the data simply because the data... doesn&#x27;t exist yet.</li>
<li>I see people often make the same mistake when they talk about derive macros - they don&#x27;t understand that &quot;one <code>#[derive]</code>, one expansion&quot;. You want to reuse the generated code in two different places (you wrote about two executables), but you expect the generated code to differ (you want different help messages). It won&#x27;t.</li>
</ul>
Alternative proposal
<p>Build it in clap itself:</p>
<pre><code>Arg::new(&quot;json&quot;)
    .long(&quot;json&quot;)
    .help(&quot;Path to the JSON file produced by &#x27;{bin} clean --out=JSON INPUT.TXT&#x27;&quot;)
</code></pre>
<p>Then clap scans the help messages at runtime seeking for <code>{placeholder}</code>, replaces it, and prints it (or does whatever was requested).</p>
List of placeholders
<p>Anything other than <code>{bin}</code>? I would like a list here.</p>
Runtime overhead
<p>If this is implemented, clap will have to scan through <em>all</em> help messages at runtime. Good news is, the scanning will run only when generating help messages, and that ain&#x27;t the part you expect to be amazingly fast. We may run the scan step only if <code>AppSettings::HelpPlaceholders</code> is set, but I don&#x27;t think it worth expanding public API.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">C: help message</span> added by <a href="https://github.com/CreepySkeleton">@CreepySkeleton</a> on 2020-07-24 20:37</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">D: hard</span> added by <a href="https://github.com/CreepySkeleton">@CreepySkeleton</a> on 2020-07-24 20:37</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">P4: nice to have</span> added by <a href="https://github.com/CreepySkeleton">@CreepySkeleton</a> on 2020-07-24 20:37</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sjackman">@sjackman</a> on 2020-07-24 22:20</div>
            <div class="timeline-body"><blockquote>
<p>If this is implemented, clap will have to scan through all help messages at runtime. Good news is, the scanning will run only when generating help messages, and that ain&#x27;t the part you expect to be amazingly fast.</p>
</blockquote>
<p>Yes, I agree that the expansion would happen at run time.
Thanks for your quick response!</p>
<p>I specifically want this feature when using Clap with its derive macros. When using the builder pattern, <code>format!</code> can easily be used.</p>
<pre><code>Arg::new(&quot;json&quot;)
    .long(&quot;json&quot;)
    .help(format!(&quot;Path to the JSON file produced by &#x27;{} clean --out=JSON INPUT.TXT&#x27;&quot;), bin_name)
</code></pre>
<p>When using the derive macro</p>
<pre><code>    /// Path to the JSON file produced by &#x27;{bin} clean --out=JSON INPUT.TXT&#x27;
    #[clap(long = &quot;json&quot;)]
    pub json: CliPath,
</code></pre>
<p>the expansion of <code>{bin}</code> would be done at run time when the user invokes <code>command --help</code>.</p>
<pre><code>pub fn get_help&lt;T: IntoApp&gt;() -&gt; String {
    let mut output = Vec::new();
    &lt;T as IntoApp&gt;::into_app().write_help(&amp;mut output).unwrap();
-   let output = String::from_utf8(output).unwrap();
+   let output = String::from_utf8(output).unwrap().replace(&quot;{bin}&quot;, self.get_bin_name()?);

    eprintln!(&quot;\n%%% HELP %%%:=====\n{}\n=====\n&quot;, output);
    eprintln!(&quot;\n%%% HELP (DEBUG) %%%:=====\n{:?}\n=====\n&quot;, output);

    output
}
</code></pre>
<blockquote>
<p>Anything other than {bin}? I would like a list here.</p>
</blockquote>
<p>https://docs.rs/clap/2.33.1/clap/struct.App.html#method.template</p>
<p>I looked through the other template macros, and <code>{bin}</code> seemed like the only one that would be useful to me.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/pksunkara">@pksunkara</a> on 2020-07-24 22:22</div>
            <div class="timeline-body"><p>You should be able to use <code>format!</code> with derive macros too since doc strings are just syntactic sugar for <code>#[doc = &quot;&quot;]</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sjackman">@sjackman</a> on 2020-07-24 23:04</div>
            <div class="timeline-body"><p>@CreepySkeleton pointed out aboveâ€¦</p>
<blockquote>
<p>The binary name (for example) is unknown until runtime, and #[derive(Clap)] works at &quot;macro expansion time&quot;. There&#x27;s no {bin} we could replace the placeholder with, or rather, it&#x27;s to be determined when you actually run the program (aliases and stuff). The derive code doesn&#x27;t have the data simply because the data... doesn&#x27;t exist yet.</p>
</blockquote>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/TeXitoi">@TeXitoi</a> on 2020-07-27 17:29</div>
            <div class="timeline-body"><p>That&#x27;s not totally true: the code is generated at expantiin time, but the given string can be generated at run time. See the lazy_static hack</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/pickfire">@pickfire</a> on 2020-08-09 05:45</div>
            <div class="timeline-body"><p>Templating doc comments is a bit hard even when using a macro but there is a tool on that https://github.com/dtolnay/paste. Not sure if this is useful.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a>epage/clapng#159</a> on 2021-12-06 20:16</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">T: new feature</span> removed by <a href="https://github.com/epage">@epage</a> on 2021-12-08 21:12</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">C-enhancement</span> added by <a href="https://github.com/epage">@epage</a> on 2021-12-08 21:12</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2021-12-10 21:59</div>
            <div class="timeline-body"><p>Agreed that we&#x27;d want to implement this feature in the Builder for the Derive API to use.</p>
<p>#2914&#x27;s idea for code-genning help messages would open the door for us doing this without incurring runtime costs.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">P4: nice to have</span> removed by <a href="https://github.com/epage">@epage</a> on 2021-12-10 21:59</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">E-hard</span> removed by <a href="https://github.com/epage">@epage</a> on 2021-12-10 21:59</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">S-waiting-on-decision</span> added by <a href="https://github.com/epage">@epage</a> on 2021-12-10 21:59</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:57:51 UTC
    </footer>
</body>
</html>
