<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>bug(clap_complete):  shell.generate  function always panic - clap-rs/clap #5171</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>bug(clap_complete):  shell.generate  function always panic</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/clap-rs/clap/issues/5171">#5171</a>
        opened by <a href="https://github.com/ahaoboy">@ahaoboy</a>
        on 2023-10-12 07:56
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ahaoboy">@ahaoboy</a></div>
            <div class="timeline-body">Please complete the following tasks
<ul>
<li>[X] I have searched the <a href="https://github.com/clap-rs/clap/discussions">discussions</a></li>
<li>[X] I have searched the <a href="https://github.com/clap-rs/clap/issues">open</a> and <a href="https://github.com/clap-rs/clap/issues?q=is%3Aissue+label%3AS-wont-fix+is%3Aclosed">rejected</a> issues</li>
</ul>
Rust Version
<p>rustc 1.74.0-nightly (65ea825f4 2023-09-18)</p>
Clap Version
<p>[[package]] name = &quot;clap&quot; version = &quot;4.4.6&quot; -- dependencies = [  &quot;clap_builder&quot;,  &quot;clap_derive&quot;, ] -- [[package]] name = &quot;clap_builder&quot; version = &quot;4.4.6&quot; --  &quot;anstyle&quot;,  &quot;clap_lex&quot;,  &quot;strsim&quot;, -- [[package]] name = &quot;clap_complete&quot; version = &quot;4.4.3&quot; -- dependencies = [  &quot;clap&quot;, ] -- [[package]] name = &quot;clap_derive&quot; version = &quot;4.4.2&quot; -- [[package]] name = &quot;clap_lex&quot; version = &quot;0.5.1&quot; -- dependencies = [  &quot;clap&quot;,  &quot;clap_complete&quot;,  &quot;futures&quot;,</p>
Minimal reproducible code
<pre><code>use clap::{CommandFactory, Parser};
use clap_complete::{generate, Shell, Generator};
#[derive(Parser, Debug, PartialEq)]
#[clap(name = &quot;bug&quot;, version = env!(&quot;CARGO_PKG_VERSION&quot;), bin_name = &quot;bug&quot;)]
struct Opt {
    #[arg(long = &quot;generate&quot;, value_enum)]
    generator: Option&lt;Shell&gt;,
}
fn main() {
    let opt = Opt::parse();

    if let Some(shell) = opt.generator {
        let mut cmd = Opt::command();
        let name = cmd.get_name().to_string();

        // error
        // shell.generate(&amp;cmd, &amp;mut std::io::stdout());

        // ok
        generate(shell, &amp;mut cmd, name, &amp;mut std::io::stdout())
    } else {
        println!(&quot;{opt:#?}&quot;);
    }
}

</code></pre>
Steps to reproduce the bug with the above code
<pre><code> cargo run  -- --generate fish
</code></pre>
Actual Behaviour
<pre><code>thread &#x27;main&#x27; panicked at ---rsproxy.cn-8f6827c7555bfaf8\clap_complete-4.4.3\src\shells\fish.rs:158:31:
built
note: run with `RUST_BACKTRACE=1` environment variable to display a backtrace
error: process didn&#x27;t exit successfully: `target\debug\x.exe --generate fish` (exit code: 101)

</code></pre>
Expected Behaviour
<p>Both ways should succeed</p>
<pre><code>
let mut cmd = Opt::command();
let name = cmd.get_name().to_string();

// error
// shell.generate(&amp;cmd, &amp;mut std::io::stdout());

// ok
generate(shell, &amp;mut cmd, name, &amp;mut std::io::stdout())

</code></pre>
Additional Context
<p><em>No response</em></p>
Debug Output
<p><em>No response</em></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">C-bug</span> added by <a href="https://github.com/ahaoboy">@ahaoboy</a> on 2023-10-12 07:56</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ahaoboy">@ahaoboy</a> on 2023-10-12 12:35</div>
            <div class="timeline-body"><p>Run build first</p>
<pre><code>let mut cmd = Opt::command();
cmd.build();
shell.generate(&amp;cmd, &amp;mut std::io::stdout());
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/ahaoboy">@ahaoboy</a> on 2023-10-12 12:35</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2023-10-12 12:53</div>
            <div class="timeline-body"><p>Its generally expected that you use <a href="https://docs.rs/clap_complete/latest/clap_complete/generator/fn.generate.html">generate</a></p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:59:58 UTC
    </footer>
</body>
</html>
