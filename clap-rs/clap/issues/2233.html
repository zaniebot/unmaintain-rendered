<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multiple set to false fails - clap-rs/clap #2233</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Multiple set to false fails</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/clap-rs/clap/issues/2233">#2233</a>
        opened by <a href="https://github.com/crowlKats">@crowlKats</a>
        on 2020-11-29 13:38
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/crowlKats">@crowlKats</a></div>
            <div class="timeline-body">Make sure you completed the following tasks
<ul>
<li>[x] Searched the <a href="https://github.com/clap-rs/clap/discussions">discussions</a></li>
<li>[x] Searched the closed issues</li>
</ul>
Code
<pre><code>let app = App::new(&quot;test&quot;).arg(
  Arg::new(&quot;foo&quot;)
    .long(&quot;foo&quot;)
    .takes_value(true)
    .multiple(false),
);

println!(&quot;{}&quot;, app.get_matches().value_of(&quot;foo&quot;).unwrap());
</code></pre>
Steps to reproduce the issue
<p>Run <code>cargo run -- --foo=bar</code> or <code>cargo run -- --foo bar</code></p>
Version
<ul>
<li><strong>Rust</strong>: 1.48.0</li>
<li><strong>Clap</strong>: master</li>
</ul>
Actual Behavior Summary
<p>using <code>=</code> it crashes with</p>
<pre><code>thread &#x27;main&#x27; panicked at &#x27;called `Option::unwrap()` on a `None` value&#x27;, src/main.rs:11:52
note: run with `RUST_BACKTRACE=1` environment variable to display a backtrace
</code></pre>
<p>whereas without it, it fails with</p>
<pre><code>error: Found argument &#x27;bar&#x27; which wasn&#x27;t expected, or isn&#x27;t valid in this context

If you tried to supply `bar` as a PATTERN use `-- bar`

USAGE:
    untitled [FLAGS]

For more information try --help
</code></pre>
<p>This currently hinders Deno to upgrade clap to 3.0.0-beta.2. <a href="https://github.com/denoland/deno/pull/8485">denoland/deno#8485</a></p>
Expected Behavior Summary
<p>It should behave as it did in v2, so not fail and give the actual value</p>
Additional context
<p>Add any other context about the problem here.</p>
Debug output

 Debug Output without = 
<pre>
<code>
[            clap::build::app]  App::_do_parse
[            clap::build::app]  App::_build
[            clap::build::app]  App::_propagate:test
[            clap::build::app]  App::_derive_display_order:test
[            clap::build::app]  App::_create_help_and_version
[            clap::build::app]  App::_create_help_and_version: Building --help
[            clap::build::app]  App::_create_help_and_version: Building --version
[clap::build::app::debug_asserts]       App::_debug_asserts
[            clap::build::arg]  Arg::_debug_asserts:foo
[            clap::build::arg]  Arg::_debug_asserts:help
[            clap::build::arg]  Arg::_debug_asserts:version
[         clap::parse::parser]  Parser::get_matches_with
[         clap::parse::parser]  Parser::_build
[         clap::parse::parser]  Parser::_verify_positionals
[         clap::parse::parser]  Parser::get_matches_with: Begin parsing &#x27;&quot;--foo&quot;&#x27; ([45, 45, 102, 111, 111])
[         clap::parse::parser]  Parser::is_new_arg: &quot;--foo&quot;:NotFound
[         clap::parse::parser]  Parser::is_new_arg: want_value=false
[         clap::parse::parser]  Parser::is_new_arg: -- found
[         clap::parse::parser]  Parser::possible_subcommand: arg=&quot;--foo&quot;
[         clap::parse::parser]  Parser::get_matches_with: possible_sc=false, sc=None
[         clap::parse::parser]  Parser::parse_long_arg
[         clap::parse::parser]  Parser::parse_long_arg: Does it contain &#x27;=&#x27;...
[         clap::parse::parser]  No
[         clap::parse::parser]  Parser::parse_long_arg: Found valid opt or flag &#x27;--foo&#x27;
[         clap::parse::parser]  Parser::check_for_help_and_version_str
[         clap::parse::parser]  Parser::check_for_help_and_version_str: Checking if --&quot;foo&quot; is help or version...
[         clap::parse::parser]  Neither
[         clap::parse::parser]  Parser::parse_flag
[    clap::parse::arg_matcher]  ArgMatcher::inc_occurrence_of: arg=foo
[    clap::parse::arg_matcher]  ArgMatcher::inc_occurrence_of: first instance
[            clap::build::app]  App::groups_for_arg: id=foo
[         clap::parse::parser]  Parser::get_matches_with: After parse_long_arg Flag(foo)
[         clap::parse::parser]  Parser::maybe_inc_pos_counter: arg = foo
[         clap::parse::parser]  Parser::maybe_inc_pos_counter: is it positional?
[         clap::parse::parser]  No
[            clap::build::app]  App::groups_for_arg: id=foo
[         clap::parse::parser]  Parser::get_matches_with: Begin parsing &#x27;&quot;bar&quot;&#x27; ([98, 97, 114])
[         clap::parse::parser]  Parser::is_new_arg: &quot;bar&quot;:Flag(foo)
[         clap::parse::parser]  Parser::is_new_arg: want_value=false
[         clap::parse::parser]  Parser::is_new_arg: value
[         clap::parse::parser]  Parser::possible_subcommand: arg=&quot;bar&quot;
[         clap::parse::parser]  Parser::get_matches_with: possible_sc=false, sc=None
[         clap::parse::parser]  Parser::get_matches_with: Positional counter...1
[         clap::parse::parser]  Parser::get_matches_with: Low index multiples...false
[         clap::output::usage]  Usage::create_usage_with_title
[         clap::output::usage]  Usage::create_usage_no_title
[         clap::output::usage]  Usage::create_help_usage; incl_reqs=true
[         clap::output::usage]  Usage::get_required_usage_from: incls=[], matcher=false, incl_last=false
[         clap::output::usage]  Usage::get_required_usage_from: unrolled_reqs=[]
[         clap::output::usage]  Usage::get_required_usage_from: ret_val=[]
[         clap::output::usage]  Usage::needs_flags_tag
[         clap::output::usage]  Usage::needs_flags_tag:iter: f=foo
[            clap::build::app]  App::groups_for_arg: id=foo
[         clap::output::usage]  Usage::needs_flags_tag:iter: [FLAGS] required
[         clap::output::usage]  Usage::create_help_usage: usage=untitled [FLAGS]
[            clap::build::app]  App::color: Color setting...
[            clap::build::app]  Auto
[           clap::output::fmt]  is_a_tty: stderr=true
</code>
</pre>



 Debug Output with = 
<pre>
<code>
[            clap::build::app]  App::_do_parse
[            clap::build::app]  App::_build
[            clap::build::app]  App::_propagate:test
[            clap::build::app]  App::_derive_display_order:test
[            clap::build::app]  App::_create_help_and_version
[            clap::build::app]  App::_create_help_and_version: Building --help
[            clap::build::app]  App::_create_help_and_version: Building --version
[clap::build::app::debug_asserts]       App::_debug_asserts
[            clap::build::arg]  Arg::_debug_asserts:foo
[            clap::build::arg]  Arg::_debug_asserts:help
[            clap::build::arg]  Arg::_debug_asserts:version
[         clap::parse::parser]  Parser::get_matches_with
[         clap::parse::parser]  Parser::_build
[         clap::parse::parser]  Parser::_verify_positionals
[         clap::parse::parser]  Parser::get_matches_with: Begin parsing &#x27;&quot;--foo=bar&quot;&#x27; ([45, 45, 102, 111, 111, 61, 98, 97, 114])
[         clap::parse::parser]  Parser::is_new_arg: &quot;--foo=bar&quot;:NotFound
[         clap::parse::parser]  Parser::is_new_arg: want_value=false
[         clap::parse::parser]  Parser::is_new_arg: -- found
[         clap::parse::parser]  Parser::possible_subcommand: arg=&quot;--foo=bar&quot;
[         clap::parse::parser]  Parser::get_matches_with: possible_sc=false, sc=None
[         clap::parse::parser]  Parser::parse_long_arg
[         clap::parse::parser]  Parser::parse_long_arg: Does it contain &#x27;=&#x27;...
[         clap::parse::parser]  Yes &#x27;&quot;=bar&quot;&#x27;
[         clap::parse::parser]  Parser::parse_long_arg: Found valid opt or flag &#x27;--foo&#x27;
[         clap::parse::parser]  Parser::check_for_help_and_version_str
[         clap::parse::parser]  Parser::check_for_help_and_version_str: Checking if --&quot;foo&quot; is help or version...
[         clap::parse::parser]  Neither
[         clap::parse::parser]  Parser::parse_flag
[    clap::parse::arg_matcher]  ArgMatcher::inc_occurrence_of: arg=foo
[    clap::parse::arg_matcher]  ArgMatcher::inc_occurrence_of: first instance
[            clap::build::app]  App::groups_for_arg: id=foo
[         clap::parse::parser]  Parser::get_matches_with: After parse_long_arg Flag(foo)
[         clap::parse::parser]  Parser::maybe_inc_pos_counter: arg = foo
[         clap::parse::parser]  Parser::maybe_inc_pos_counter: is it positional?
[         clap::parse::parser]  No
[            clap::build::app]  App::groups_for_arg: id=foo
[         clap::parse::parser]  Parser::remove_overrides
[         clap::parse::parser]  Parser::remove_overrides:iter:foo
[      clap::parse::validator]  Validator::validate
[         clap::parse::parser]  Parser::add_defaults
[      clap::parse::validator]  Validator::validate_conflicts
[      clap::parse::validator]  Validator::validate_exclusive
[      clap::parse::validator]  Validator::validate_exclusive:iter:foo
[      clap::parse::validator]  Validator::gather_conflicts
[      clap::parse::validator]  Validator::gather_conflicts:iter: id=foo
[            clap::build::app]  App::groups_for_arg: id=foo
[      clap::parse::validator]  Validator::validate_required: required=ChildGraph([])
[      clap::parse::validator]  Validator::gather_requirements
[      clap::parse::validator]  Validator::gather_requirements:iter:foo
[      clap::parse::validator]  Validator::validate_required_unless
[      clap::parse::validator]  Validator::validate_matched_args
[      clap::parse::validator]  Validator::validate_matched_args:iter:foo: vals=[]
[      clap::parse::validator]  Validator::validate_arg_num_vals
[      clap::parse::validator]  Validator::validate_arg_values: arg=&quot;foo&quot;
[      clap::parse::validator]  Validator::validate_arg_requires:&quot;foo&quot;
[      clap::parse::validator]  Validator::validate_arg_num_occurs: &quot;foo&quot;=1
[    clap::parse::arg_matcher]  ArgMatcher::get_global_values: global_arg_vec=[]
</code>
</pre>


</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">T: bug</span> added by <a href="https://github.com/crowlKats">@crowlKats</a> on 2020-11-29 13:38</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a>denoland/deno#8485</a> on 2020-11-29 13:39</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone &quot;3.0&quot; by <a href="https://github.com/pksunkara">@pksunkara</a> on 2020-11-29 13:39</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ldm0">@ldm0</a> on 2020-12-09 19:26</div>
            <div class="timeline-body"><p>Well, this sounds strange but currently the order of clap&#x27;s settings does matter. This works:</p>
<pre><code>let app = App::new(&quot;test&quot;).arg(
  Arg::new(&quot;foo&quot;)
    .long(&quot;foo&quot;)
    .multiple(false)
    .takes_value(true)
);
</code></pre>
<p>That&#x27;s becase disable <code>multiple</code> actually disables <code>takes_value</code> and <code>multiple</code>, which shares the same logic that enable <code>multiple</code> actually enables <code>takes_value</code> and <code>multiple</code>. What do you think? @pksunkara</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/pksunkara">@pksunkara</a> on 2020-12-09 20:00</div>
            <div class="timeline-body"><p>We need to fix all these inter linking changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">C: args</span> added by <a href="https://github.com/pksunkara">@pksunkara</a> on 2020-12-09 20:01</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ldm0">@ldm0</a> on 2020-12-10 05:38</div>
            <div class="timeline-body"><p>@pksunkara  I don&#x27;t think currently removing all interlinking changes is a good idea, it may introduces quite a bit resistance on upgrading v2 to v3.</p>
<p>What&#x27;s about changing the behaviour of setting false. I mean enabling <code>multiple</code> enables <code>takes_value</code> and <code>multiple</code>, while disabling <code>multiple</code> only disables <code>multiple</code>. It&#x27;s less surprising for users.</p>
<p>This changes maintains backward compatibility, since nobody(I guess...) depends on the behaviour that disabling <code>multiple</code> disables <code>takes_value</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/pksunkara">@pksunkara</a> on 2020-12-14 02:30</div>
            <div class="timeline-body"><p>We will have https://github.com/pksunkara/cargo-up ready. We shouldn&#x27;t concern ourselves with either backward compatibility or user churn.</p>
<p>But we can definitely improve the user experience by asserting that <code>multiple = true, takes_value = false</code> doesn&#x27;t happen.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a>clap-rs/clap#2360</a> on 2021-02-23 16:38</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ldm0">@ldm0</a> on 2021-02-23 16:43</div>
            <div class="timeline-body"><blockquote>
<p>We will have https://github.com/pksunkara/cargo-up ready. We shouldn&#x27;t concern ourselves with either backward compatibility or user churn.</p>
<p>But we can definitely improve the user experience by asserting that <code>multiple = true, takes_value = false</code> doesn&#x27;t happen.</p>
</blockquote>
<p>Opinion syncing: so removing all interlinking flags, and check them in <code>assert_app</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/pksunkara">@pksunkara</a> on 2021-02-23 16:45</div>
            <div class="timeline-body"><p>Yup.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a>clap-rs/clap#2362</a> on 2021-02-24 15:45</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/pksunkara">@pksunkara</a> on 2021-03-09 17:49</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a>SeaQL/sea-orm#664</a> on 2022-04-13 11:23</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a>solana-labs/solana-program-library#4511</a> on 2023-06-08 23:26</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:57:58 UTC
    </footer>
</body>
</html>
