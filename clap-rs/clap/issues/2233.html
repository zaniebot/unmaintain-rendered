<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multiple set to false fails - clap-rs/clap #2233</title>
    <link rel="stylesheet" href="../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../index.html">Back to index</a>
    </div>

    <h1>Multiple set to false fails</h1>

    <div class="meta">
        <span class="state state-closed">Closed</span>
        <a href="https://github.com/clap-rs/clap/issues/2233">#2233</a>
        opened by <a href="https://github.com/crowlKats">@crowlKats</a>
        on 2020-11-29 13:38
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/crowlKats">@crowlKats</a> on 2020-11-29 13:38</div>
            <div class="timeline-body"><h3>Make sure you completed the following tasks</h3>
<ul>
<li>[x] Searched the <a href="https://github.com/clap-rs/clap/discussions">discussions</a></li>
<li>[x] Searched the closed issues</li>
</ul>
<h3>Code</h3>
<pre><code class="language-rust">let app = App::new(&quot;test&quot;).arg(
  Arg::new(&quot;foo&quot;)
    .long(&quot;foo&quot;)
    .takes_value(true)
    .multiple(false),
);

println!(&quot;{}&quot;, app.get_matches().value_of(&quot;foo&quot;).unwrap());
</code></pre>
<h3>Steps to reproduce the issue</h3>
<p>Run <code>cargo run -- --foo=bar</code> or <code>cargo run -- --foo bar</code></p>
<h3>Version</h3>
<ul>
<li><strong>Rust</strong>: 1.48.0</li>
<li><strong>Clap</strong>: master</li>
</ul>
<h3>Actual Behavior Summary</h3>
<p>using <code>=</code> it crashes with</p>
<pre><code>thread 'main' panicked at 'called `Option::unwrap()` on a `None` value', src/main.rs:11:52
note: run with `RUST_BACKTRACE=1` environment variable to display a backtrace
</code></pre>
<p>whereas without it, it fails with</p>
<pre><code>error: Found argument 'bar' which wasn't expected, or isn't valid in this context

If you tried to supply `bar` as a PATTERN use `-- bar`

USAGE:
    untitled [FLAGS]

For more information try --help
</code></pre>
<p>This currently hinders Deno to upgrade clap to 3.0.0-beta.2. https://github.com/denoland/deno/pull/8485</p>
<h3>Expected Behavior Summary</h3>
<p>It should behave as it did in v2, so not fail and give the actual value</p>
<h3>Additional context</h3>
<p>Add any other context about the problem here.</p>
<h3>Debug output</h3>
<details>
<summary> Debug Output without = </summary>
<pre>
<code>
[            clap::build::app]  App::_do_parse
[            clap::build::app]  App::_build
[            clap::build::app]  App::_propagate:test
[            clap::build::app]  App::_derive_display_order:test
[            clap::build::app]  App::_create_help_and_version
[            clap::build::app]  App::_create_help_and_version: Building --help
[            clap::build::app]  App::_create_help_and_version: Building --version
[clap::build::app::debug_asserts]       App::_debug_asserts
[            clap::build::arg]  Arg::_debug_asserts:foo
[            clap::build::arg]  Arg::_debug_asserts:help
[            clap::build::arg]  Arg::_debug_asserts:version
[         clap::parse::parser]  Parser::get_matches_with
[         clap::parse::parser]  Parser::_build
[         clap::parse::parser]  Parser::_verify_positionals
[         clap::parse::parser]  Parser::get_matches_with: Begin parsing '"--foo"' ([45, 45, 102, 111, 111])
[         clap::parse::parser]  Parser::is_new_arg: "--foo":NotFound
[         clap::parse::parser]  Parser::is_new_arg: want_value=false
[         clap::parse::parser]  Parser::is_new_arg: -- found
[         clap::parse::parser]  Parser::possible_subcommand: arg="--foo"
[         clap::parse::parser]  Parser::get_matches_with: possible_sc=false, sc=None
[         clap::parse::parser]  Parser::parse_long_arg
[         clap::parse::parser]  Parser::parse_long_arg: Does it contain '='...
[         clap::parse::parser]  No
[         clap::parse::parser]  Parser::parse_long_arg: Found valid opt or flag '--foo'
[         clap::parse::parser]  Parser::check_for_help_and_version_str
[         clap::parse::parser]  Parser::check_for_help_and_version_str: Checking if --"foo" is help or version...
[         clap::parse::parser]  Neither
[         clap::parse::parser]  Parser::parse_flag
[    clap::parse::arg_matcher]  ArgMatcher::inc_occurrence_of: arg=foo
[    clap::parse::arg_matcher]  ArgMatcher::inc_occurrence_of: first instance
[            clap::build::app]  App::groups_for_arg: id=foo
[         clap::parse::parser]  Parser::get_matches_with: After parse_long_arg Flag(foo)
[         clap::parse::parser]  Parser::maybe_inc_pos_counter: arg = foo
[         clap::parse::parser]  Parser::maybe_inc_pos_counter: is it positional?
[         clap::parse::parser]  No
[            clap::build::app]  App::groups_for_arg: id=foo
[         clap::parse::parser]  Parser::get_matches_with: Begin parsing '"bar"' ([98, 97, 114])
[         clap::parse::parser]  Parser::is_new_arg: "bar":Flag(foo)
[         clap::parse::parser]  Parser::is_new_arg: want_value=false
[         clap::parse::parser]  Parser::is_new_arg: value
[         clap::parse::parser]  Parser::possible_subcommand: arg="bar"
[         clap::parse::parser]  Parser::get_matches_with: possible_sc=false, sc=None
[         clap::parse::parser]  Parser::get_matches_with: Positional counter...1
[         clap::parse::parser]  Parser::get_matches_with: Low index multiples...false
[         clap::output::usage]  Usage::create_usage_with_title
[         clap::output::usage]  Usage::create_usage_no_title
[         clap::output::usage]  Usage::create_help_usage; incl_reqs=true
[         clap::output::usage]  Usage::get_required_usage_from: incls=[], matcher=false, incl_last=false
[         clap::output::usage]  Usage::get_required_usage_from: unrolled_reqs=[]
[         clap::output::usage]  Usage::get_required_usage_from: ret_val=[]
[         clap::output::usage]  Usage::needs_flags_tag
[         clap::output::usage]  Usage::needs_flags_tag:iter: f=foo
[            clap::build::app]  App::groups_for_arg: id=foo
[         clap::output::usage]  Usage::needs_flags_tag:iter: [FLAGS] required
[         clap::output::usage]  Usage::create_help_usage: usage=untitled [FLAGS]
[            clap::build::app]  App::color: Color setting...
[            clap::build::app]  Auto
[           clap::output::fmt]  is_a_tty: stderr=true
</code>
</pre>
</details>

<details>
<summary> Debug Output with = </summary>
<pre>
<code>
[            clap::build::app]  App::_do_parse
[            clap::build::app]  App::_build
[            clap::build::app]  App::_propagate:test
[            clap::build::app]  App::_derive_display_order:test
[            clap::build::app]  App::_create_help_and_version
[            clap::build::app]  App::_create_help_and_version: Building --help
[            clap::build::app]  App::_create_help_and_version: Building --version
[clap::build::app::debug_asserts]       App::_debug_asserts
[            clap::build::arg]  Arg::_debug_asserts:foo
[            clap::build::arg]  Arg::_debug_asserts:help
[            clap::build::arg]  Arg::_debug_asserts:version
[         clap::parse::parser]  Parser::get_matches_with
[         clap::parse::parser]  Parser::_build
[         clap::parse::parser]  Parser::_verify_positionals
[         clap::parse::parser]  Parser::get_matches_with: Begin parsing '"--foo=bar"' ([45, 45, 102, 111, 111, 61, 98, 97, 114])
[         clap::parse::parser]  Parser::is_new_arg: "--foo=bar":NotFound
[         clap::parse::parser]  Parser::is_new_arg: want_value=false
[         clap::parse::parser]  Parser::is_new_arg: -- found
[         clap::parse::parser]  Parser::possible_subcommand: arg="--foo=bar"
[         clap::parse::parser]  Parser::get_matches_with: possible_sc=false, sc=None
[         clap::parse::parser]  Parser::parse_long_arg
[         clap::parse::parser]  Parser::parse_long_arg: Does it contain '='...
[         clap::parse::parser]  Yes '"=bar"'
[         clap::parse::parser]  Parser::parse_long_arg: Found valid opt or flag '--foo'
[         clap::parse::parser]  Parser::check_for_help_and_version_str
[         clap::parse::parser]  Parser::check_for_help_and_version_str: Checking if --"foo" is help or version...
[         clap::parse::parser]  Neither
[         clap::parse::parser]  Parser::parse_flag
[    clap::parse::arg_matcher]  ArgMatcher::inc_occurrence_of: arg=foo
[    clap::parse::arg_matcher]  ArgMatcher::inc_occurrence_of: first instance
[            clap::build::app]  App::groups_for_arg: id=foo
[         clap::parse::parser]  Parser::get_matches_with: After parse_long_arg Flag(foo)
[         clap::parse::parser]  Parser::maybe_inc_pos_counter: arg = foo
[         clap::parse::parser]  Parser::maybe_inc_pos_counter: is it positional?
[         clap::parse::parser]  No
[            clap::build::app]  App::groups_for_arg: id=foo
[         clap::parse::parser]  Parser::remove_overrides
[         clap::parse::parser]  Parser::remove_overrides:iter:foo
[      clap::parse::validator]  Validator::validate
[         clap::parse::parser]  Parser::add_defaults
[      clap::parse::validator]  Validator::validate_conflicts
[      clap::parse::validator]  Validator::validate_exclusive
[      clap::parse::validator]  Validator::validate_exclusive:iter:foo
[      clap::parse::validator]  Validator::gather_conflicts
[      clap::parse::validator]  Validator::gather_conflicts:iter: id=foo
[            clap::build::app]  App::groups_for_arg: id=foo
[      clap::parse::validator]  Validator::validate_required: required=ChildGraph([])
[      clap::parse::validator]  Validator::gather_requirements
[      clap::parse::validator]  Validator::gather_requirements:iter:foo
[      clap::parse::validator]  Validator::validate_required_unless
[      clap::parse::validator]  Validator::validate_matched_args
[      clap::parse::validator]  Validator::validate_matched_args:iter:foo: vals=[]
[      clap::parse::validator]  Validator::validate_arg_num_vals
[      clap::parse::validator]  Validator::validate_arg_values: arg="foo"
[      clap::parse::validator]  Validator::validate_arg_requires:"foo"
[      clap::parse::validator]  Validator::validate_arg_num_occurs: "foo"=1
[    clap::parse::arg_matcher]  ArgMatcher::get_global_values: global_arg_vec=[]
</code>
</pre>
</details>

</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">T: bug</span> added by @crowlKats on 2020-11-29 13:38</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../denoland/deno/pulls/8485.html">denoland/deno#8485</a> on 2020-11-29 13:39</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone "3.0" by @pksunkara on 2020-11-29 13:39</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ldm0">@ldm0</a> on 2020-12-09 19:26</div>
            <div class="timeline-body"><p>Well, this sounds strange but currently the order of clap's settings does matter. This works:</p>
<pre><code class="language-rust">let app = App::new(&quot;test&quot;).arg(
  Arg::new(&quot;foo&quot;)
    .long(&quot;foo&quot;)
    .multiple(false)
    .takes_value(true)
);
</code></pre>
<p>That's becase disable <code>multiple</code> actually disables <code>takes_value</code> and <code>multiple</code>, which shares the same logic that enable <code>multiple</code> actually enables <code>takes_value</code> and <code>multiple</code>. What do you think? @pksunkara</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/pksunkara">@pksunkara</a> on 2020-12-09 20:00</div>
            <div class="timeline-body"><p>We need to fix all these inter linking changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">C: args</span> added by @pksunkara on 2020-12-09 20:01</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ldm0">@ldm0</a> on 2020-12-10 05:38</div>
            <div class="timeline-body"><p>@pksunkara  I don't think currently removing all interlinking changes is a good idea, it may introduces quite a bit resistance on upgrading v2 to v3.</p>
<p>What's about changing the behaviour of setting false. I mean enabling <code>multiple</code> enables <code>takes_value</code> and <code>multiple</code>, while disabling <code>multiple</code> only disables <code>multiple</code>. It's less surprising for users.</p>
<p>This changes maintains backward compatibility, since nobody(I guess...) depends on the behaviour that disabling <code>multiple</code> disables <code>takes_value</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/pksunkara">@pksunkara</a> on 2020-12-14 02:30</div>
            <div class="timeline-body"><p>We will have https://github.com/pksunkara/cargo-up ready. We shouldn't concern ourselves with either backward compatibility or user churn.</p>
<p>But we can definitely improve the user experience by asserting that <code>multiple = true, takes_value = false</code> doesn't happen.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/2360.html">clap-rs/clap#2360</a> on 2021-02-23 16:38</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ldm0">@ldm0</a> on 2021-02-23 16:43</div>
            <div class="timeline-body"><blockquote>
<p>We will have https://github.com/pksunkara/cargo-up ready. We shouldn't concern ourselves with either backward compatibility or user churn.</p>
<p>But we can definitely improve the user experience by asserting that <code>multiple = true, takes_value = false</code> doesn't happen.</p>
</blockquote>
<p>Opinion syncing: so removing all interlinking flags, and check them in <code>assert_app</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/pksunkara">@pksunkara</a> on 2021-02-23 16:45</div>
            <div class="timeline-body"><p>Yup.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/2362.html">clap-rs/clap#2362</a> on 2021-02-24 15:45</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @pksunkara on 2021-03-09 17:49</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../SeaQL/sea-orm/issues/664.html">SeaQL/sea-orm#664</a> on 2022-04-13 11:23</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../solana-labs/solana-program-library/issues/4511.html">solana-labs/solana-program-library#4511</a> on 2023-06-08 23:26</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:28:33 UTC
    </footer>
</body>
</html>
