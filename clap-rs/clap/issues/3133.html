<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Duplicate short option (and other misconfigurations) gives runtime error, wouldn't it be cool, if it was compile time error - clap-rs/clap #3133</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Duplicate short option (and other misconfigurations) gives runtime error, wouldn't it be cool, if it was compile time error</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/clap-rs/clap/issues/3133">#3133</a>
        opened by <a href="https://github.com/epage">@epage</a>
        on 2021-12-09 16:34
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/epage">@epage</a></div>
            <div class="timeline-body"><p><a href="https://github.com/typetetris"><img src="https://avatars.githubusercontent.com/u/1983821?v=4" align="left" width="96" height="96" hspace="10"></img></a> <strong>Issue by <a href="https://github.com/typetetris">typetetris</a></strong>
<em>Tuesday Oct 05, 2021 at 13:32 GMT</em>
<em>Originally opened as https://github.com/TeXitoi/structopt/issues/500</em></p>
<hr />
<p>Something like</p>
<pre><code>use structopt::StructOpt;

#[derive(Debug,StructOpt)]
struct Opt {
      #[structopt(short, long)]
      fnord: u16,

      #[structopt(short, long)]
      file: String
}
</code></pre>
<p>gives an error at runtime of the program.</p>
<p>It would be way cooler, if it was a compile time error.</p>
<p>If you agree, I could look into trying to implement this.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2021-12-09 16:34</div>
            <div class="timeline-body"><p><a href="https://github.com/TeXitoi"><img src="https://avatars.githubusercontent.com/u/5787066?v=4" align="left" width="48" height="48" hspace="10"></img></a> <strong>Comment by <a href="https://github.com/TeXitoi">TeXitoi</a></strong>
<em>Tuesday Oct 05, 2021 at 15:15 GMT</em></p>
<hr />
<p>I doubt this particular example will panic. Edit: ho, OK, short argument, yep, it'll panic.</p>
<p>There is no easy way of checking you use the same name several times. Basic case is double, bit when you add flatten and friends, it can become a nightmare. I don't want complicated code to do compile time check that would be catch in all case with a basic test. Now, if the code is really trivial, why not, but I doubt.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">A-derive</span> added by @epage on 2021-12-09 16:39</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">C-enhancement</span> added by @epage on 2021-12-09 16:39</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/pksunkara">@pksunkara</a> on 2021-12-10 01:55</div>
            <div class="timeline-body"><p>This is panic during development runtime now. But looks the issue is talking about compile time.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2021-12-10 19:34</div>
            <div class="timeline-body"><p>Yes.  As TeXitoi says, we can do this in the trivial case though it won't scale to complex caes (<code>flatten</code>).</p>
<p>For the trivial case, the main complication is how we currently have the code structured.  We take the raw attributes and convert them straight to <code>Method</code>s.</p>
<p>Our options for implementing this:</p>
<ul>
<li>Select specific <code>Method</code>s that we check for duplicates across fields.  This seems more straightforward but is more brittle.</li>
<li>Preserve all of the <code>ClapAttr</code>s we parsed and compare those.  Requires some restructuring of the code but less brittle.</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/2740.html">clap-rs/clap#2740</a> on 2021-12-13 17:49</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2021-12-13 17:50</div>
            <div class="timeline-body"><p>Note: we have #2740 which is about supporting all of the debug assets at compile time.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">S-waiting-on-decision</span> added by @epage on 2021-12-13 22:39</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/3202.html">clap-rs/clap#3202</a> on 2021-12-22 19:19</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/martinvonz">@martinvonz</a> on 2022-03-23 17:26</div>
            <div class="timeline-body"><p>A workaround seems to be to use <code>clap_complete</code>. That seems to catch the cases I've cared about. I don't know what the complication caused by <code>flatten</code> is, but it seems feasible to at least catch the things that generation of command-line-completion scripts will catch, right?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2022-03-23 17:34</div>
            <div class="timeline-body"><p>Could you expand on how <code>clap_complete</code> is catching these cases?  It seems like it only be able to report them at runtime as well, and not compile time.</p>
<p>We do recommend creating tests out of the runtime checks which will catch it during development and will check every subcommand possible, rather than what was run by the user.  See https://github.com/clap-rs/clap/blob/v3.1.6/examples/tutorial_builder/README.md#tips</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/martinvonz">@martinvonz</a> on 2022-03-23 17:42</div>
            <div class="timeline-body"><p>Ah, sorry, I was unclear. What I meant is that I used <code>clap_complete</code> at runtime to catch <em>all</em> (AFAICT) errors instead of having to test-run each command and subcommand to see if its definition is valid. So it seems <code>debug_assert()</code> is a better way of doing that then (thanks!). I guess what I (and @typetetris?) were expecting was for that to run at compile-time instead.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2022-03-23 17:50</div>
            <div class="timeline-body"><blockquote>
<p>I guess what I (and @typetetris?) were expecting was for that to run at compile-time instead.</p>
</blockquote>
<p>Yes, I understand that but that increases our maintenance burden because we have to support and test the checks at both compile time and runtime.  We also would need to detect and limit what checks we run when the user <code>#[clap(flatten)]</code>s one struct into another (<a href="https://github.com/clap-rs/clap/blob/master/examples/git-derive.rs#L43">example</a>) because we only have knowledge of the struct we are currently processing.  I'm also concerned that having different behavior for with and without <code>flatten</code> will confuse users.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/martinvonz">@martinvonz</a> on 2022-03-23 17:56</div>
            <div class="timeline-body"><p>Makes sense. I understand the issue with <code>flatten</code> now. It's also much less of a concern to me now that I have added that <code>debug_assert()</code> test case you suggested.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/3592.html">clap-rs/clap#3592</a> on 2022-03-30 18:16</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "Duplicate short option gives runtime error, wouldn't it be cool, if it was compile time error" to "Duplicate short option (and other misconfigurations) gives runtime error, wouldn't it be cool, if it was compile time error" by @epage on 2022-12-15 13:19</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/4556.html">clap-rs/clap#4556</a> on 2022-12-15 13:21</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/4715.html">clap-rs/clap#4715</a> on 2023-02-19 01:49</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/4816.html">clap-rs/clap#4816</a> on 2023-03-31 19:54</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/4837.html">clap-rs/clap#4837</a> on 2023-04-17 15:28</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/4467.html">clap-rs/clap#4467</a> on 2023-05-08 11:55</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/5215.html">clap-rs/clap#5215</a> on 2023-11-15 14:21</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/5690.html">clap-rs/clap#5690</a> on 2024-08-21 14:22</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../esp-rs/espflash/pulls/746.html">esp-rs/espflash#746</a> on 2025-02-06 12:30</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/6174.html">clap-rs/clap#6174</a> on 2025-11-03 16:17</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:48:17 UTC
    </footer>
</body>
</html>
