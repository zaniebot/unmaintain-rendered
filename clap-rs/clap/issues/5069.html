<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[clap_complete] Not working on zsh - clap-rs/clap #5069</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[clap_complete] Not working on zsh</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/clap-rs/clap/issues/5069">#5069</a>
        opened by <a href="https://github.com/liby">@liby</a>
        on 2023-08-12 09:43
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/liby">@liby</a> on 2023-08-12 09:43</div>
            <div class="timeline-body"><h3>Please complete the following tasks</h3>
<ul>
<li>[X] I have searched the <a href="https://github.com/clap-rs/clap/discussions">discussions</a></li>
<li>[X] I have searched the <a href="https://github.com/clap-rs/clap/issues">open</a> and <a href="https://github.com/clap-rs/clap/issues?q=is%3Aissue+label%3AS-wont-fix+is%3Aclosed">rejected</a> issues</li>
</ul>
<h3>Rust Version</h3>
<p>rustc 1.73.0-nightly (a6f8aa5a0 2023-08-11)</p>
<h3>Clap Version</h3>
<p>4.3.21</p>
<h3>Minimal reproducible code</h3>
<p>https://github.com/malwaredb/malwaredb-rs</p>
<pre><code class="language-rust">//! How to generate shell completions.
//! Instructions based on [Clap](https://github.com/clap-rs/clap/blob/master/clap_complete/examples/completion-derive.rs).
//!
//! Usage with zsh:
//! ```console
//! $ cargo run --features=admin --bin mdb_server -- --generate=zsh &gt; /usr/local/share/zsh/site-functions/_completion_derive
//! $ compinit
//! $ ./target/debug/mdb_server --&lt;TAB&gt;
//! ```
//! fish:
//! ```console
//! $ cargo run --features=admin --bin mdb_server -- --generate=fish &gt; completion_derive.fish
//! $ . ./completion_derive.fish
//! $ ./target/debug/mdb_server --&lt;TAB&gt;
//! ```
//! bash:
//! ```console
//! $ cargo run --features=admin --bin mdb_server -- --generate=bash &gt; completion_derive.bash
//! $ source completion_derive.bash
//! $ ./target/debug/mdb_server --&lt;TAB&gt;
//! ```

#[cfg(feature = &quot;admin&quot;)]
mod admin;
mod config;
mod run;

use std::process::ExitCode;

use clap::{Command, Parser, Subcommand};
use clap_complete::{generate, Generator, Shell};

/// Malware Database
///
/// Malware Database maintains the bookkeeping for unknown, malicious, and benign binaries
/// using a database, and optionally storing the files in a given location for later retrieval.
#[derive(Parser, Debug, Clone, PartialEq)]
#[command(author, version, about)]
pub struct Options {
    #[arg(long = &quot;generate&quot;, value_enum)]
    pub(crate) generator: Option&lt;Shell&gt;,
    /// Subcommands (with their own options)
    #[clap(subcommand)]
    cmd: Option&lt;Subcommands&gt;,
}

impl Options {
    pub async fn execute(self) -&gt; anyhow::Result&lt;ExitCode&gt; {
        match self.cmd {
            Some(Subcommands::Run(cmd)) =&gt; cmd.execute().await,
            #[cfg(feature = &quot;admin&quot;)]
            Some(Subcommands::Admin(cmd)) =&gt; cmd.execute().await,
            None =&gt; {
                eprintln!(&quot;Please run with `--help` for options.&quot;);
                Ok(ExitCode::FAILURE)
            }
        }
    }
}

#[derive(Subcommand, Clone, Debug, PartialEq)]
enum Subcommands {
    #[command(visible_alias = &quot;hint&quot;)]
    Run(run::Run),
    #[cfg(feature = &quot;admin&quot;)]
    Admin(admin::Admin),
}

pub fn print_completions&lt;G: Generator&gt;(gen: G, cmd: &amp;mut Command) {
    generate(gen, cmd, cmd.get_name().to_string(), &amp;mut std::io::stdout());
}

#[cfg(test)]
mod tests {
    use super::Options;

    use clap::CommandFactory;

    #[test]
    fn verify_cli() {
        Options::command().debug_assert();
    }
}
</code></pre>
<h3>Steps to reproduce the bug with the above code</h3>
<pre><code>$ cargo run --features=admin --bin mdb_server -- --generate=zsh
&gt; /// '/usr/local/share/zsh/site-functions/_completion_derive' does not exist
$ compinit
$ ./target/debug/mdb_server --&lt;TAB&gt;
</code></pre>
<h3>Actual Behaviour</h3>
<p>No auto-complete available</p>
<h3>Expected Behaviour</h3>
<p>Auto-completion working properly.</p>
<h3>Additional Context</h3>
<p>There is no <em>share</em> folder under the <em>/usr/local/</em> folder.
<img width="686" alt="image" src="https://github.com/clap-rs/clap/assets/38807139/5bccb8e0-4db5-4ba4-9a49-5e9b2b0552e7"></p>
<h3>Debug Output</h3>
<pre><code>[clap_builder::builder::command]Command::_do_parse
[clap_builder::builder::command]Command::_build: name=&quot;malwaredb&quot;
[clap_builder::builder::command]Command::_propagate:malwaredb
[clap_builder::builder::command]Command::_check_help_and_version:malwaredb expand_help_tree=false
[clap_builder::builder::command]Command::long_help_exists
[clap_builder::builder::command]Command::_check_help_and_version: Building default --help
[clap_builder::builder::command]Command::_check_help_and_version: Building default --version
[clap_builder::builder::command]Command::_check_help_and_version: Building help subcommand
[clap_builder::builder::command]Command::_propagate_global_args:malwaredb
[clap_builder::builder::debug_asserts]Command::_debug_asserts
[clap_builder::builder::debug_asserts]Arg::_debug_asserts:generator
[clap_builder::builder::debug_asserts]Arg::_debug_asserts:help
[clap_builder::builder::debug_asserts]Arg::_debug_asserts:version
[clap_builder::builder::debug_asserts]Command::_verify_positionals
[clap_builder::parser::parser]Parser::get_matches_with
[clap_builder::parser::parser]Parser::get_matches_with: Begin parsing '&quot;--generate=zsh&quot;'
[clap_builder::parser::parser]Parser::possible_subcommand: arg=Ok(&quot;--generate=zsh&quot;)
[clap_builder::parser::parser]Parser::get_matches_with: sc=None
[clap_builder::parser::parser]Parser::parse_long_arg
[clap_builder::parser::parser]Parser::parse_long_arg: Does it contain '='...
[clap_builder::parser::parser]Parser::parse_long_arg: Found valid arg or flag '--generate &lt;GENERATOR&gt;'
[clap_builder::parser::parser]Parser::parse_long_arg(&quot;generate&quot;): Found an arg with value 'Some(&quot;zsh&quot;)'
[clap_builder::parser::parser]Parser::parse_opt_value; arg=generator, val=Some(&quot;zsh&quot;), has_eq=true
[clap_builder::parser::parser]Parser::parse_opt_value; arg.settings=ArgFlags(0)
[clap_builder::parser::parser]Parser::parse_opt_value; Checking for val...
[clap_builder::parser::parser]Parser::react action=Set, identifier=Some(Long), source=CommandLine
[clap_builder::parser::parser]Parser::react: cur_idx:=1
[clap_builder::parser::parser]Parser::remove_overrides: id=&quot;generator&quot;
[clap_builder::parser::arg_matcher]ArgMatcher::start_custom_arg: id=&quot;generator&quot;, source=CommandLine
[clap_builder::builder::command]Command::groups_for_arg: id=&quot;generator&quot;
[clap_builder::parser::arg_matcher]ArgMatcher::start_custom_arg: id=&quot;Options&quot;, source=CommandLine
[clap_builder::parser::parser]Parser::push_arg_values: [&quot;zsh&quot;]
[clap_builder::parser::parser]Parser::add_single_val_to_arg: cur_idx:=2
[clap_builder::parser::arg_matcher]ArgMatcher::needs_more_vals: o=generator, pending=0
[clap_builder::parser::arg_matcher]ArgMatcher::needs_more_vals: expected=1, actual=0
[clap_builder::parser::parser]Parser::react not enough values passed in, leaving it to the validator to complain
[clap_builder::parser::parser]Parser::get_matches_with: After parse_long_arg ValuesDone
[clap_builder::parser::parser]Parser::add_defaults
[clap_builder::parser::parser]Parser::add_defaults:iter:generator:
[clap_builder::parser::parser]Parser::add_default_value: doesn't have conditional defaults
[clap_builder::parser::parser]Parser::add_default_value:iter:generator: doesn't have default vals
[clap_builder::parser::parser]Parser::add_defaults:iter:help:
[clap_builder::parser::parser]Parser::add_default_value: doesn't have conditional defaults
[clap_builder::parser::parser]Parser::add_default_value:iter:help: doesn't have default vals
[clap_builder::parser::parser]Parser::add_defaults:iter:version:
[clap_builder::parser::parser]Parser::add_default_value: doesn't have conditional defaults
[clap_builder::parser::parser]Parser::add_default_value:iter:version: doesn't have default vals
[clap_builder::parser::validator]Validator::validate
[clap_builder::builder::command]Command::groups_for_arg: id=&quot;generator&quot;
[clap_builder::parser::validator]Conflicts::gather_direct_conflicts id=&quot;generator&quot;, conflicts=[]
[clap_builder::parser::validator]Conflicts::gather_direct_conflicts id=&quot;Options&quot;, conflicts=[]
[clap_builder::parser::validator]Validator::validate_conflicts
[clap_builder::parser::validator]Validator::validate_exclusive
[clap_builder::parser::validator]Validator::validate_conflicts::iter: id=&quot;generator&quot;
[clap_builder::parser::validator]Conflicts::gather_conflicts: arg=&quot;generator&quot;
[clap_builder::parser::validator]Conflicts::gather_conflicts: conflicts=[]
[clap_builder::parser::validator]Validator::validate_required: required=ChildGraph([])
[clap_builder::parser::validator]Validator::gather_requires
[clap_builder::parser::validator]Validator::gather_requires:iter:&quot;generator&quot;
[clap_builder::parser::validator]Validator::gather_requires:iter:&quot;Options&quot;
[clap_builder::parser::validator]Validator::gather_requires:iter:&quot;Options&quot;:group
[clap_builder::parser::validator]Validator::validate_required: is_exclusive_present=false
[clap_builder::parser::arg_matcher]ArgMatcher::get_global_values: global_arg_vec=[]
Generating completion file for Zsh...
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">C-bug</span> added by @liby on 2023-08-12 09:43</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2023-08-12 11:19</div>
            <div class="timeline-body"><p>If I'm understanding your reproduction steps and code, you are printing the completions to stdout and not putting them in a file for zsh to read. Is that correct?</p>
<p>FYI please in the future provide minimal examples of a problem; the included example can't be run on its own</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/liby">@liby</a> on 2023-08-12 12:10</div>
            <div class="timeline-body"><blockquote>
<p>If I'm understanding your reproduction steps and code, you are printing the completions to stdout and not putting them in a file for zsh to read. Is that correct?</p>
</blockquote>
<p>Oh, I think I understand where the issue lies now. Thank you.</p>
<blockquote>
<p>FYI please in the future provide minimal examples of a problem; the included example can't be run on its own</p>
</blockquote>
<p>Sorry, I will pay attention next time. Since this issue was not caused by a clap, I will close it. Sorry again.</p>
<p>I know this might be a bit off-topic, but if possible, I'd like to ask a question.</p>
<img width="691" alt="image" src="https://github.com/clap-rs/clap/assets/38807139/29e53f3e-4c97-4d34-a95b-bdacb9994a1d">

<p>I encountered two issues while trying to generate a completion script for Zsh and redirect the output to a file within the directories specified by the <code>$fpath</code> variable.</p>
<ol>
<li>Permission Denied: When attempting to write the completion script to <em>/usr/share/zsh/site-functions/_completion_derive</em>, I received a &quot;permission denied&quot; error. This likely occurred because the directory requires higher permissions to write to. A common solution to this problem might be to run the command with elevated permissions, such as using <code>sudo</code>. However, this approach might not be suitable for all users.</li>
<li>Directory Not Found: When trying to write to <em>/usr/local/share/zsh/site-functions/_completion_derive</em>, I encountered a &quot;no such file or directory&quot; error. This indicates that the specified path does not exist. A potential solution could be to create the directory first and then append it to the <code>$fpath</code> variable. However, this approach might be considered overly complex for some users.</li>
</ol>
<p>In both cases, I was attempting to use the <code>&gt;</code> operator to redirect the completed result into the specified folder within the <code>$fpath</code> variable. I'm looking for a better approach that can handle these issues without requiring users to manually create directories or modify permissions. Any suggestions would be appreciated.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @liby on 2023-08-12 12:10</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2023-08-12 14:03</div>
            <div class="timeline-body"><p>You likely want to put the completions in your home directory, rather than in <code>/usr</code>. I don't use zsh so my understanding is limited for how to do that.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 01:35:28 UTC
    </footer>
</body>
</html>
