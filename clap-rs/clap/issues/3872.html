<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Environment variable sometimes overrides global arg, new in 3.2 - clap-rs/clap #3872</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Environment variable sometimes overrides global arg, new in 3.2</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/clap-rs/clap/issues/3872">#3872</a>
        opened by <a href="https://github.com/pbevin">@pbevin</a>
        on 2022-06-26 14:59
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/pbevin">@pbevin</a></div>
            <div class="timeline-body"><h3>Please complete the following tasks</h3>
<ul>
<li>[X] I have searched the <a href="https://github.com/clap-rs/clap/discussions">discussions</a></li>
<li>[X] I have searched the <a href="https://github.com/clap-rs/clap/issues">open</a> and <a href="https://github.com/clap-rs/clap/issues?q=is%3Aissue+label%3AS-wont-fix+is%3Aclosed">rejected</a> issues</li>
</ul>
<h3>Rust Version</h3>
<p>rustc 1.61.0 (fe5b13d68 2022-05-18)</p>
<h3>Clap Version</h3>
<p>3.2.6</p>
<h3>Minimal reproducible code</h3>
<pre><code class="language-rust">use clap::{Parser, Subcommand};

#[derive(Debug, Parser)]
struct Opts {
    #[clap(short, long, global = true, env = &quot;MY_ENV_VAR&quot;)]
    name: Option&lt;String&gt;,

    #[clap(subcommand)]
    command: Commands,
}

#[derive(Debug, Subcommand)]
enum Commands {
    Hello,
    Goodbye,
}

fn main() {
    let opts = Opts::parse();
    let name = opts.name.unwrap_or_else(|| &quot;World&quot;.to_string());
    match opts.command {
        Commands::Hello =&gt; println!(&quot;Hello, {name}!&quot;),
        Commands::Goodbye =&gt; println!(&quot;Goodbye, {name}!&quot;),
    }
}


</code></pre>
<h3>Steps to reproduce the bug with the above code</h3>
<pre><code class="language-shell">MY_ENV_VAR=from_env cargo run -- --name from_arg hello
</code></pre>
<h3>Actual Behaviour</h3>
<p>Prints &quot;Hello, from_env!&quot;</p>
<h3>Expected Behaviour</h3>
<p>Prints &quot;Hello, from_arg!&quot;</p>
<h3>Additional Context</h3>
<p>With clap 3.1.18, the output was &quot;Hello, from_arg&quot; in both these cases:</p>
<pre><code>MY_ENV_VAR=from_env cargo run -- hello --name from_arg # &quot;Hello, from_arg&quot;
MY_ENV_VAR=from_env cargo run -- --name from_arg hello # &quot;Hello, from_arg&quot;
</code></pre>
<p>With clap 3.2.6, the output is different:</p>
<pre><code>MY_ENV_VAR=from_env cargo run -- hello --name from_arg # &quot;Hello, from_arg&quot;
MY_ENV_VAR=from_env cargo run -- --name from_arg hello # &quot;Hello, from_env&quot;
</code></pre>
<h3>Debug Output</h3>
<pre><code class="language-toml">[dependencies]
clap = { version = &quot;3.2.6&quot;, features = [&quot;env&quot;, &quot;derive&quot;, &quot;debug&quot;] }
</code></pre>
<pre><code>    Finished dev [unoptimized + debuginfo] target(s) in 0.02s
     Running `target/debug/clap3 --name from_arg hello`
[      clap::builder::command] 	Command::_do_parse
[      clap::builder::command] 	Command::_build: name=&quot;clap3&quot;
[      clap::builder::command] 	Command::_propagate:clap3
[      clap::builder::command] 	Command::_check_help_and_version: clap3
[      clap::builder::command] 	Command::_check_help_and_version: Removing generated version
[      clap::builder::command] 	Command::_check_help_and_version: Building help subcommand
[      clap::builder::command] 	Command::_propagate_global_args:clap3
[      clap::builder::command] 	Command::_propagate removing hello's help
[      clap::builder::command] 	Command::_propagate pushing help to hello
[      clap::builder::command] 	Command::_propagate pushing name to hello
[      clap::builder::command] 	Command::_propagate removing goodbye's help
[      clap::builder::command] 	Command::_propagate pushing help to goodbye
[      clap::builder::command] 	Command::_propagate pushing name to goodbye
[      clap::builder::command] 	Command::_propagate removing help's help
[      clap::builder::command] 	Command::_propagate pushing help to help
[      clap::builder::command] 	Command::_propagate pushing name to help
[      clap::builder::command] 	Command::_derive_display_order:clap3
[      clap::builder::command] 	Command::_derive_display_order:hello
[      clap::builder::command] 	Command::_derive_display_order:goodbye
[      clap::builder::command] 	Command::_derive_display_order:help
[clap::builder::debug_asserts] 	Command::_debug_asserts
[clap::builder::debug_asserts] 	Arg::_debug_asserts:help
[clap::builder::debug_asserts] 	Arg::_debug_asserts:name
[clap::builder::debug_asserts] 	Command::_verify_positionals
[        clap::parser::parser] 	Parser::get_matches_with
[        clap::parser::parser] 	Parser::get_matches_with: Begin parsing 'RawOsStr(&quot;--name&quot;)' ([45, 45, 110, 97, 109, 101])
[        clap::parser::parser] 	Parser::get_matches_with: Positional counter...1
[        clap::parser::parser] 	Parser::get_matches_with: Low index multiples...false
[        clap::parser::parser] 	Parser::possible_subcommand: arg=Ok(&quot;--name&quot;)
[        clap::parser::parser] 	Parser::get_matches_with: sc=None
[        clap::parser::parser] 	Parser::parse_long_arg
[        clap::parser::parser] 	Parser::parse_long_arg: Does it contain '='...
[        clap::parser::parser] 	Parser::parse_long_arg: Found valid arg or flag '--name &lt;NAME&gt;'
[        clap::parser::parser] 	Parser::parse_long_arg(&quot;name&quot;): Found an arg with value 'None'
[        clap::parser::parser] 	Parser::parse_opt_value; arg=name, val=None, has_eq=false
[        clap::parser::parser] 	Parser::parse_opt_value; arg.settings=ArgFlags(GLOBAL | TAKES_VAL)
[        clap::parser::parser] 	Parser::parse_opt_value; Checking for val...
[        clap::parser::parser] 	Parser::parse_opt_value: More arg vals required...
[        clap::parser::parser] 	Parser::get_matches_with: After parse_long_arg Opt(name)
[        clap::parser::parser] 	Parser::get_matches_with: Begin parsing 'RawOsStr(&quot;from_arg&quot;)' ([102, 114, 111, 109, 95, 97, 114, 103])
[        clap::parser::parser] 	Parser::get_matches_with: Positional counter...1
[        clap::parser::parser] 	Parser::get_matches_with: Low index multiples...false
[        clap::parser::parser] 	Parser::split_arg_values; arg=name, val=RawOsStr(&quot;from_arg&quot;)
[        clap::parser::parser] 	Parser::split_arg_values; trailing_values=false, DontDelimTrailingVals=false
[   clap::parser::arg_matcher] 	ArgMatcher::needs_more_vals: o=name, resolved=0, pending=1
[        clap::parser::parser] 	Parser::get_matches_with: Begin parsing 'RawOsStr(&quot;hello&quot;)' ([104, 101, 108, 108, 111])
[        clap::parser::parser] 	Parser::get_matches_with: Positional counter...1
[        clap::parser::parser] 	Parser::get_matches_with: Low index multiples...false
[        clap::parser::parser] 	Parser::possible_subcommand: arg=Ok(&quot;hello&quot;)
[        clap::parser::parser] 	Parser::get_matches_with: sc=Some(&quot;hello&quot;)
[        clap::parser::parser] 	Parser::parse_subcommand
[         clap::output::usage] 	Usage::get_required_usage_from: incls=[], matcher=false, incl_last=true
[         clap::output::usage] 	Usage::get_required_usage_from: unrolled_reqs={}
[         clap::output::usage] 	Usage::get_required_usage_from: ret_val={}
[      clap::builder::command] 	Command::_build_subcommand Setting bin_name of hello to &quot;clap3 hello&quot;
[      clap::builder::command] 	Command::_build_subcommand Setting display_name of hello to &quot;clap3-hello&quot;
[      clap::builder::command] 	Command::_build: name=&quot;hello&quot;
[      clap::builder::command] 	Command::_propagate:hello
[      clap::builder::command] 	Command::_check_help_and_version: hello
[      clap::builder::command] 	Command::_check_help_and_version: Removing generated version
[      clap::builder::command] 	Command::_propagate_global_args:hello
[      clap::builder::command] 	Command::_derive_display_order:hello
[clap::builder::debug_asserts] 	Command::_debug_asserts
[clap::builder::debug_asserts] 	Arg::_debug_asserts:help
[clap::builder::debug_asserts] 	Arg::_debug_asserts:name
[clap::builder::debug_asserts] 	Command::_verify_positionals
[        clap::parser::parser] 	Parser::parse_subcommand: About to parse sc=hello
[        clap::parser::parser] 	Parser::get_matches_with
[        clap::parser::parser] 	Parser::add_env
[        clap::parser::parser] 	Parser::add_env: Checking arg `--help`
[        clap::parser::parser] 	Parser::add_env: Checking arg `--name &lt;NAME&gt;`
[        clap::parser::parser] 	Parser::add_env: Found an opt with value=RawOsStr(&quot;from_env&quot;), trailing=false
[        clap::parser::parser] 	Parser::split_arg_values; arg=name, val=RawOsStr(&quot;from_env&quot;)
[        clap::parser::parser] 	Parser::split_arg_values; trailing_values=false, DontDelimTrailingVals=false
[        clap::parser::parser] 	Parser::react action=StoreValue, identifier=None, source=EnvVariable
[   clap::parser::arg_matcher] 	ArgMatcher::start_custom_arg: id=name, source=EnvVariable
[      clap::builder::command] 	Command::groups_for_arg: id=name
[        clap::parser::parser] 	Parser::push_arg_values: [&quot;from_env&quot;]
[        clap::parser::parser] 	Parser::add_single_val_to_arg: cur_idx:=1
[      clap::builder::command] 	Command::groups_for_arg: id=name
[   clap::parser::arg_matcher] 	ArgMatcher::needs_more_vals: o=name, resolved=1, pending=0
[        clap::parser::parser] 	Parser::add_defaults
[        clap::parser::parser] 	Parser::add_defaults:iter:help:
[        clap::parser::parser] 	Parser::add_default_value:iter:help: doesn't have default missing vals
[        clap::parser::parser] 	Parser::add_default_value: doesn't have conditional defaults
[        clap::parser::parser] 	Parser::add_default_value:iter:help: doesn't have default vals
[        clap::parser::parser] 	Parser::add_defaults:iter:name:
[        clap::parser::parser] 	Parser::add_default_value:iter:name: doesn't have default missing vals
[        clap::parser::parser] 	Parser::add_default_value: doesn't have conditional defaults
[        clap::parser::parser] 	Parser::add_default_value:iter:name: doesn't have default vals
[     clap::parser::validator] 	Validator::validate
[     clap::parser::validator] 	Validator::validate_conflicts
[     clap::parser::validator] 	Validator::validate_exclusive
[     clap::parser::validator] 	Validator::validate_conflicts::iter: id=name
[     clap::parser::validator] 	Conflicts::gather_conflicts: arg=name
[     clap::parser::validator] 	Conflicts::gather_conflicts: conflicts=[]
[     clap::parser::validator] 	Validator::validate_required: required=ChildGraph([])
[     clap::parser::validator] 	Validator::gather_requires
[     clap::parser::validator] 	Validator::gather_requires:iter:name
[     clap::parser::validator] 	Validator::validate_required: is_exclusive_present=false
[     clap::parser::validator] 	Validator::validate_required_unless
[     clap::parser::validator] 	Validator::validate_matched_args
[     clap::parser::validator] 	Validator::validate_matched_args:iter:name: vals=Flatten {
    inner: FlattenCompat {
        iter: Fuse {
            iter: Some(
                Iter(
                    [
                        [
                            AnyValue {
                                inner: alloc::string::String,
                            },
                        ],
                    ],
                ),
            ),
        },
        frontiter: None,
        backiter: None,
    },
}
[     clap::parser::validator] 	Validator::validate_arg_num_vals
[     clap::parser::validator] 	Validator::validate_arg_values: arg=&quot;name&quot;
[     clap::parser::validator] 	Validator::validate_arg_values: checking validator...
[     clap::parser::validator] 	good
[     clap::parser::validator] 	Validator::validate_arg_num_occurs: &quot;name&quot;=0
[        clap::parser::parser] 	Parser::resolve_pending: id=name
[        clap::parser::parser] 	Parser::react action=StoreValue, identifier=Some(Long), source=CommandLine
[        clap::parser::parser] 	Parser::react: cur_idx:=1
[        clap::parser::parser] 	Parser::remove_overrides: id=name
[   clap::parser::arg_matcher] 	ArgMatcher::start_occurrence_of_arg: id=name
[      clap::builder::command] 	Command::groups_for_arg: id=name
[        clap::parser::parser] 	Parser::push_arg_values: [&quot;from_arg&quot;]
[        clap::parser::parser] 	Parser::add_single_val_to_arg: cur_idx:=2
[      clap::builder::command] 	Command::groups_for_arg: id=name
[   clap::parser::arg_matcher] 	ArgMatcher::needs_more_vals: o=name, resolved=1, pending=0
[        clap::parser::parser] 	Parser::add_env
[        clap::parser::parser] 	Parser::add_env: Checking arg `--help`
[        clap::parser::parser] 	Parser::add_env: Skipping existing arg `--name &lt;NAME&gt;`
[        clap::parser::parser] 	Parser::add_defaults
[        clap::parser::parser] 	Parser::add_defaults:iter:help:
[        clap::parser::parser] 	Parser::add_default_value:iter:help: doesn't have default missing vals
[        clap::parser::parser] 	Parser::add_default_value: doesn't have conditional defaults
[        clap::parser::parser] 	Parser::add_default_value:iter:help: doesn't have default vals
[        clap::parser::parser] 	Parser::add_defaults:iter:name:
[        clap::parser::parser] 	Parser::add_default_value:iter:name: doesn't have default missing vals
[        clap::parser::parser] 	Parser::add_default_value: doesn't have conditional defaults
[        clap::parser::parser] 	Parser::add_default_value:iter:name: doesn't have default vals
[     clap::parser::validator] 	Validator::validate
[     clap::parser::validator] 	Validator::validate_conflicts
[     clap::parser::validator] 	Validator::validate_exclusive
[     clap::parser::validator] 	Validator::validate_conflicts::iter: id=name
[     clap::parser::validator] 	Conflicts::gather_conflicts: arg=name
[     clap::parser::validator] 	Conflicts::gather_conflicts: conflicts=[]
[     clap::parser::validator] 	Validator::validate_required: required=ChildGraph([])
[     clap::parser::validator] 	Validator::gather_requires
[     clap::parser::validator] 	Validator::gather_requires:iter:name
[     clap::parser::validator] 	Validator::validate_required: is_exclusive_present=false
[     clap::parser::validator] 	Validator::validate_required_unless
[     clap::parser::validator] 	Validator::validate_matched_args
[     clap::parser::validator] 	Validator::validate_matched_args:iter:name: vals=Flatten {
    inner: FlattenCompat {
        iter: Fuse {
            iter: Some(
                Iter(
                    [
                        [
                            AnyValue {
                                inner: alloc::string::String,
                            },
                        ],
                    ],
                ),
            ),
        },
        frontiter: None,
        backiter: None,
    },
}
[     clap::parser::validator] 	Validator::validate_arg_num_vals
[     clap::parser::validator] 	Validator::validate_arg_values: arg=&quot;name&quot;
[     clap::parser::validator] 	Validator::validate_arg_values: checking validator...
[     clap::parser::validator] 	good
[     clap::parser::validator] 	Validator::validate_arg_num_occurs: &quot;name&quot;=1
[   clap::parser::arg_matcher] 	ArgMatcher::get_global_values: global_arg_vec=[help, name, help, name]
Hello, from_env!
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">C-bug</span> added by @pbevin on 2022-06-26 14:59</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2022-06-28 02:48</div>
            <div class="timeline-body"><p>Huh, this only seems to affect env and not defaults</p>
<pre><code>#!/usr/bin/env -S rust-script --debug

//! ```cargo
//! [dependencies]
//! clap = { path = &quot;../clap&quot;, features = [&quot;env&quot;, &quot;derive&quot;] }
//! ```

use clap::{Parser, Subcommand};

#[derive(Debug, Parser)]
struct Opts {
    #[clap(short, long, global = true, default_value = &quot;from_default&quot;)]
    name: String,

    #[clap(subcommand)]
    command: Commands,
}

#[derive(Debug, Subcommand)]
enum Commands {
    Hello,
    Goodbye,
}

fn main() {
    let opts = Opts::parse();
    let name = opts.name;
    match opts.command {
        Commands::Hello =&gt; println!(&quot;Hello, {name}!&quot;),
        Commands::Goodbye =&gt; println!(&quot;Goodbye, {name}!&quot;),
    }
}
</code></pre>
<pre><code class="language-console">$ ./clap-3872.rs --name from_arg hello
Hello, from_arg!
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/3879.html">clap-rs/clap#3879</a> on 2022-06-28 03:41</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @epage on 2022-06-28 13:01</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2022-06-28 13:06</div>
            <div class="timeline-body"><p>The fix is now available in v3.2.7</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:48:37 UTC
    </footer>
</body>
</html>
