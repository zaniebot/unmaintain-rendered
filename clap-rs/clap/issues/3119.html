<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Parse different arguments to the same field from &amp;ArgMatches - clap-rs/clap #3119</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Parse different arguments to the same field from &amp;ArgMatches</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/clap-rs/clap/issues/3119">#3119</a>
        opened by <a href="https://github.com/epage">@epage</a>
        on 2021-12-09 16:13
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/epage">@epage</a></div>
            <div class="timeline-body"><p><a href="https://github.com/I60R"><img src="https://avatars.githubusercontent.com/u/9143774?v=4" align="left" width="96" height="96" hspace="10"></img></a> <strong>Issue by <a href="https://github.com/I60R">I60R</a></strong>
<em>Sunday Jul 22, 2018 at 06:15 GMT</em>
<em>Originally opened as https://github.com/TeXitoi/structopt/issues/126</em></p>
<hr />
<p>Example: there is <code>-v</code> which increases log verbosity, and <code>-q</code> which decreases it, and that should be backed by single <code>log_level</code> field in <code>Options</code> struct.</p>
<p>Alacritty <a href="https://github.com/jwilm/alacritty/blob/ea512cb0f3cb159707eb29fdbf2e31bbb1c1b902/src/cli.rs#L45">implements that pattern</a> with use of <code>clap</code> and manually filled struct; but with use of structopt there will be no other way as split <code>log_level</code> into two fields: <code>q</code> and <code>v</code>.</p>
<p>I propose something like <code>parse(from_matches = &quot;parser&quot;)</code> to avoid that.</p>
<pre><code class="language-rust">
#[derive(StructOpt))]
struct Options {
    #[structopt(parse(from_matches = &quot;parse_log_level&quot;))]
    log_level: log::LevelFilter,

    ...
}

fn parse_log_level(matches: &amp;ArgMatches) -&gt; log::LevelFilter {
    match matches.occurrences_of(&quot;v&quot;) {
        0 =&gt; match matches.occurrences_of(&quot;q&quot;) {
            0 =&gt; log::LevelFilter::Warn,
            1 =&gt; log::LevelFilter::Error,
            2 | _ =&gt; log::LevelFilter::Off
        },
        1 =&gt; log::LevelFilter::Info,
        2 =&gt; log::LevelFilter::Debug,
        3 | _ =&gt; log::LevelFilter::Trace
    }
}

</code></pre>
<hr />
<p>Also, <a href="https://github.com/I60R/page/blob/2d8ff2eb99cf6ce2b256d2c24471c5d372fcfa71/src/cli.rs#L65-L95">I have a use case</a> where parser like that may greatly simplify my code</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2021-12-09 16:13</div>
            <div class="timeline-body"><p><a href="https://github.com/TeXitoi"><img src="https://avatars.githubusercontent.com/u/5787066?v=4" align="left" width="48" height="48" hspace="10"></img></a> <strong>Comment by <a href="https://github.com/TeXitoi">TeXitoi</a></strong>
<em>Monday Jul 23, 2018 at 14:15 GMT</em></p>
<hr />
<p>That's a quite complicated feature to design. Maybe using the parse feature, giving a custom parsing command that takes the 2 parameters and returns the value, with a way to list on a struct field that this field is linked to 2 options.</p>
<p>Fuzzy try:</p>
<pre><code class="language-rust">fn parse_log_level(quiet: u32, verbose: u32) -&gt; log::LevelFilter {
    match (quiet, verbose) {
        (0, 0) =&gt; log::LevelFilter::Warn,
        (0, 1) =&gt; log::LevelFilter::Error,
        (0, _) =&gt; log::LevelFilter::Off,
        (1, _) =&gt; log::LevelFilter::Info,
        (2, _) =&gt; log::LevelFilter::Debug,
        (_, _) =&gt; log::LevelFilter::Trace,
    }
}

#[derive(StructOpt)]
struct Opt {
    #[structopt(
        multiarg(short = &quot;v&quot;, long = &quot;verbose&quot;, parse(from_occurence)),
        multiarg(short = &quot;q&quot;, long = &quot;quiet&quot;, parse(from_occurence)),
        parse(from_multiargs = &quot;parse_log_level&quot;),
    )]
    verbose: log::LevelFilter,
}
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2021-12-09 16:13</div>
            <div class="timeline-body"><p><a href="https://github.com/I60R"><img src="https://avatars.githubusercontent.com/u/9143774?v=4" align="left" width="48" height="48" hspace="10"></img></a> <strong>Comment by <a href="https://github.com/I60R">I60R</a></strong>
<em>Monday Jul 23, 2018 at 19:17 GMT</em></p>
<hr />
<p>What are your thoughts about delegating <code>q</code> and <code>v</code> fields into separate struct?
That will be very similar to <code>flatten</code> feature that additionally invokes <code>.from()</code> on flattened struct:</p>
<pre><code class="language-rust">#[derive(StructOpt)]
struct Opt {
    #[structopt(collapse(LogLevelOpt)]
    verbose: log::LevelFilter,

    ...
}

#[derive(StructOpt)]
struct LogLevelOpt {
    #[structopt(short = &quot;v&quot;, long = &quot;verbose&quot;, parse(from_occurences)]
    verbose: u8,

    #[structopt(short = &quot;q&quot;, long = &quot;quiet&quot;, parse(from_occurences)]
    quiet: u8,
}

impl Into&lt;log::LevelFilter&gt; for LogLevelOpt {
    fn into(self) -&gt; log::LevelFilter {
        match (self.quiet, self.verbose) {
            (0, 0) =&gt; log::LevelFilter::Warn,
            (0, 1) =&gt; log::LevelFilter::Error,
            (0, _) =&gt; log::LevelFilter::Off,
            (1, _) =&gt; log::LevelFilter::Info,
            (2, _) =&gt; log::LevelFilter::Debug,
            (_, _) =&gt; log::LevelFilter::Trace,
        }
    }
}
</code></pre>
<p>Also, there might be other version that uses custom function instead of <code>from</code>:</p>
<pre><code class="language-rust">#[derive(StructOpt)]
struct Opt {
    #[structopt(collapse(LogLevelOpt), parse(from_collapsed = &quot;custom_function&quot;)]
    verbose: log::LevelFilter,

    ...
}

#[derive(StructOpt)]
struct LogLevelOpt {
    ...
}

fn custom_function(opt: LogLevelOpt) -&gt; log::LevelFilter {
   ...
}

</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2021-12-09 16:13</div>
            <div class="timeline-body"><p><a href="https://github.com/TeXitoi"><img src="https://avatars.githubusercontent.com/u/5787066?v=4" align="left" width="48" height="48" hspace="10"></img></a> <strong>Comment by <a href="https://github.com/TeXitoi">TeXitoi</a></strong>
<em>Tuesday Jul 24, 2018 at 15:02 GMT</em></p>
<hr />
<p>@I60R That's another path that looks promising. I prefer it to my proposition.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2021-12-09 16:13</div>
            <div class="timeline-body"><p><a href="https://github.com/eugmes"><img src="https://avatars.githubusercontent.com/u/447040?v=4" align="left" width="48" height="48" hspace="10"></img></a> <strong>Comment by <a href="https://github.com/eugmes">eugmes</a></strong>
<em>Monday Jul 26, 2021 at 20:36 GMT</em></p>
<hr />
<p>I have another use case that I think may benefit from having multiple arguments apply to the same field, and it is hard or impossible to implement this using multiple separate arguments.</p>
<p>I have a program that's processes some Unicode characters, user should be able to enable or disable processing of some ranges, multiple enable/disable arguments are possible, they should be processes in order they are supplied. For example:</p>
<pre><code class="language-console">--include-range 100-200 --exclude-range 120-130
</code></pre>
<p>The result should be the same as:</p>
<pre><code class="language-console">--include-range 100-119 --include-range 131-200
</code></pre>
<p>I would like to model this as follows:</p>
<pre><code class="language-rust">enum UnicodeRange {...}

enum RangeSpec {
    Included {
        include_range: UnicodeRange,
    },
    Excluded {
        exclude_range: UnicodeRange,
    },
}

struct Opt {
    ...
    #[structopt(???)]
    ranges: Vec[RangeSpec],
    ...
}
</code></pre>
<p>I could not find any good way to do this. Note that separate arguments would not work because the order is important.</p>
<p>I've tried to use <code>flatten</code>, but <code>structopt</code> insists on adding subcommands :/.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2021-12-09 16:13</div>
            <div class="timeline-body"><p><a href="https://github.com/TeXitoi"><img src="https://avatars.githubusercontent.com/u/5787066?v=4" align="left" width="48" height="48" hspace="10"></img></a> <strong>Comment by <a href="https://github.com/TeXitoi">TeXitoi</a></strong>
<em>Monday Jul 26, 2021 at 21:19 GMT</em></p>
<hr />
<p>@eugmes this is similar to your use case: https://github.com/TeXitoi/structopt/issues/476</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2021-12-09 16:13</div>
            <div class="timeline-body"><p><a href="https://github.com/eugmes"><img src="https://avatars.githubusercontent.com/u/447040?v=4" align="left" width="48" height="48" hspace="10"></img></a> <strong>Comment by <a href="https://github.com/eugmes">eugmes</a></strong>
<em>Monday Jul 26, 2021 at 21:53 GMT</em></p>
<hr />
<p>@TeXitoi indeed it is. Thanks a lot!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">A-derive</span> added by @epage on 2021-12-09 16:20</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">C-enhancement</span> added by @epage on 2021-12-09 16:20</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2021-12-13 22:28</div>
            <div class="timeline-body"><p>This is a duplicate of #3146.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @epage on 2021-12-13 22:28</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/3146.html">clap-rs/clap#3146</a> on 2021-12-13 22:28</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">S-duplicate</span> added by @epage on 2022-01-11 18:25</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:48:16 UTC
    </footer>
</body>
</html>
