<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Consider relaxing the bounds of Send + Sync on TypedValueParser - clap-rs/clap #5347</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Consider relaxing the bounds of Send + Sync on TypedValueParser</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/clap-rs/clap/issues/5347">#5347</a>
        opened by <a href="https://github.com/csmclaren">@csmclaren</a>
        on 2024-02-09 14:35
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/csmclaren">@csmclaren</a></div>
            <div class="timeline-body">Please complete the following tasks
<ul>
<li>[X] I have searched the <a href="https://github.com/clap-rs/clap/discussions">discussions</a></li>
<li>[X] I have searched the <a href="https://github.com/clap-rs/clap/issues">open</a> and <a href="https://github.com/clap-rs/clap/issues?q=is%3Aissue+label%3AS-wont-fix+is%3Aclosed">rejected</a> issues</li>
</ul>
Clap Version
<p>4.5.0</p>
Describe your use case
<ol>
<li>It&#x27;s quite ergonomic that the value_parser attribute allows one to express the following in a single line, delegating option argument parsing to their library&#x27;s existing parsing functionality without any extra code:</li>
</ol>
<p>#[arg(long, short, value_parser = |s: &amp;str| MyObject::try_from(s))]
my_object: MyObject</p>
<ol>
<li>If an error is encountered during a call to Cli::parse(), Clap will print the first line of the error message, which includes the option name &quot;--my-object&quot; and option argument name &quot;MY_OBJECT&quot;. This is elegant, as it decouples the option and option argument names from the user&#x27;s library. Then, clap will print the Error returned by my TryFrom implementation which can contain more detailed information that only the user&#x27;s library knows.</li>
</ol>
<p>error: invalid value &#x27;123&#x27; for &#x27;--my-object &lt;MY_OBJECT&gt;&#x27;:  &lt;- from clap</p>
<p><em>detailed information</em>  &lt;- from the error returned by TryFrom</p>
<p>Because TypedValueParser enforces Send + Sync, one can&#x27;t compile any value_parser function which does not adhere to these bounds.</p>
<p>In my case, one component of the Error object returned by TryFrom contains an instance of RefCell. This is a requirement of the implementation of my particular library and non-trivial to work around. As such, it&#x27;s impossible for me to use the above pattern.</p>
Describe the solution you&#x27;d like
<p>Please consider, if possible, relaxing the bounds on TypedValueParser.</p>
Alternatives, if applicable
<p><em>No response</em></p>
Additional Context
<p><em>No response</em></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">C-enhancement</span> added by <a href="https://github.com/csmclaren">@csmclaren</a> on 2024-02-09 14:35</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2024-02-09 14:57</div>
            <div class="timeline-body"><p>I assume you mean <code>Send + Sync</code> on the error type?</p>
<p>Loosening that would be a breaking change because clap&#x27;s error type would no longer be <code>Send + Sync</code> which can then affect using it with other parts of the Rust ecosystem.</p>
<p>There is a general assumption that errors are <code>Send + Sync</code>, e.g. <a href="https://docs.rs/anyhow/latest/anyhow/struct.Error.html#impl-From%3CE%3E-for-Error">anyhow requires it</a>.</p>
<p>A workaround is to render the error before passing it back up to clap by using <code>.to_string()</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">M-breaking-change</span> added by <a href="https://github.com/epage">@epage</a> on 2024-02-09 14:57</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">A-help</span> added by <a href="https://github.com/epage">@epage</a> on 2024-02-09 14:57</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/csmclaren">@csmclaren</a> on 2024-02-09 16:15</div>
            <div class="timeline-body"><p>Yes, thank you, I did mean Send + Sync on the Error.</p>
<p>While I&#x27;m reticent to say that <em>all</em> errors should implement Send + Sync, I can see now that this is a general assumption in a number of libraries and why you might not wish to consider the change.</p>
<p>Furthermore, I think the workaround you suggested is ultimately the better option, in part because it&#x27;s so short to implement.</p>
<p>For others who might encounter this issue, the workaround for my example above is as follows:</p>
<p>#[arg(long, short, value_parser = |s: &amp;str| MyObject::try_from(s).map_err(|e| e.to_string()))]
my_object: MyObject,</p>
<p>And here is a variation on the workaround that does not use a closure and is explicit about the error type:</p>
<p>#[arg(long, short, value_parser = parse_my_object))]
my_object: MyObject,</p>
<p>fn parse_my_object(s: &amp;str) -&gt; Result&lt;MyObject, Box&lt;dyn std::error::Error + Send + Sync&gt;&gt; {
MyObject::try_from(s).map_err(|e| e.to_string().into())
}</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/csmclaren">@csmclaren</a> on 2024-02-09 16:15</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 20:00:04 UTC
    </footer>
</body>
</html>
