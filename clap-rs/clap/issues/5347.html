<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Consider relaxing the bounds of Send + Sync on TypedValueParser - clap-rs/clap #5347</title>
    <link rel="stylesheet" href="../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../index.html">Back to index</a>
    </div>

    <h1>Consider relaxing the bounds of Send + Sync on TypedValueParser</h1>

    <div class="meta">
        <span class="state state-closed">Closed</span>
        <a href="https://github.com/clap-rs/clap/issues/5347">#5347</a>
        opened by <a href="https://github.com/csmclaren">@csmclaren</a>
        on 2024-02-09 14:35
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/csmclaren">@csmclaren</a> on 2024-02-09 14:35</div>
            <div class="timeline-body"><h3>Please complete the following tasks</h3>
<ul>
<li>[X] I have searched the <a href="https://github.com/clap-rs/clap/discussions">discussions</a></li>
<li>[X] I have searched the <a href="https://github.com/clap-rs/clap/issues">open</a> and <a href="https://github.com/clap-rs/clap/issues?q=is%3Aissue+label%3AS-wont-fix+is%3Aclosed">rejected</a> issues</li>
</ul>
<h3>Clap Version</h3>
<p>4.5.0</p>
<h3>Describe your use case</h3>
<ol>
<li>It's quite ergonomic that the value_parser attribute allows one to express the following in a single line, delegating option argument parsing to their library's existing parsing functionality without any extra code:</li>
</ol>
<p>#[arg(long, short, value_parser = |s: &amp;str| MyObject::try_from(s))]
my_object: MyObject</p>
<ol start="2">
<li>If an error is encountered during a call to Cli::parse(), Clap will print the first line of the error message, which includes the option name &quot;--my-object&quot; and option argument name &quot;MY_OBJECT&quot;. This is elegant, as it decouples the option and option argument names from the user's library. Then, clap will print the Error returned by my TryFrom implementation which can contain more detailed information that only the user's library knows.</li>
</ol>
<p>error: invalid value '123' for '--my-object &lt;MY_OBJECT&gt;':  &lt;- from clap</p>
<p><em>detailed information</em>  &lt;- from the error returned by TryFrom</p>
<p>Because TypedValueParser enforces Send + Sync, one can't compile any value_parser function which does not adhere to these bounds.</p>
<p>In my case, one component of the Error object returned by TryFrom contains an instance of RefCell. This is a requirement of the implementation of my particular library and non-trivial to work around. As such, it's impossible for me to use the above pattern.</p>
<h3>Describe the solution you'd like</h3>
<p>Please consider, if possible, relaxing the bounds on TypedValueParser.</p>
<h3>Alternatives, if applicable</h3>
<p><em>No response</em></p>
<h3>Additional Context</h3>
<p><em>No response</em></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">C-enhancement</span> added by @csmclaren on 2024-02-09 14:35</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2024-02-09 14:57</div>
            <div class="timeline-body"><p>I assume you mean <code>Send + Sync</code> on the error type?</p>
<p>Loosening that would be a breaking change because clap's error type would no longer be <code>Send + Sync</code> which can then affect using it with other parts of the Rust ecosystem.</p>
<p>There is a general assumption that errors are <code>Send + Sync</code>, e.g. <a href="https://docs.rs/anyhow/latest/anyhow/struct.Error.html#impl-From%3CE%3E-for-Error">anyhow requires it</a>.</p>
<p>A workaround is to render the error before passing it back up to clap by using <code>.to_string()</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">M-breaking-change</span> added by @epage on 2024-02-09 14:57</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">A-help</span> added by @epage on 2024-02-09 14:57</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/csmclaren">@csmclaren</a> on 2024-02-09 16:15</div>
            <div class="timeline-body"><p>Yes, thank you, I did mean Send + Sync on the Error.</p>
<p>While I'm reticent to say that <em>all</em> errors should implement Send + Sync, I can see now that this is a general assumption in a number of libraries and why you might not wish to consider the change.</p>
<p>Furthermore, I think the workaround you suggested is ultimately the better option, in part because it's so short to implement.</p>
<p>For others who might encounter this issue, the workaround for my example above is as follows:</p>
<p>#[arg(long, short, value_parser = |s: &amp;str| MyObject::try_from(s).map_err(|e| e.to_string()))]
my_object: MyObject,</p>
<p>And here is a variation on the workaround that does not use a closure and is explicit about the error type:</p>
<p>#[arg(long, short, value_parser = parse_my_object))]
my_object: MyObject,</p>
<p>fn parse_my_object(s: &amp;str) -&gt; Result&lt;MyObject, Box&lt;dyn std::error::Error + Send + Sync&gt;&gt; {
MyObject::try_from(s).map_err(|e| e.to_string().into())
}</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @csmclaren on 2024-02-09 16:15</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:28:34 UTC
    </footer>
</body>
</html>
