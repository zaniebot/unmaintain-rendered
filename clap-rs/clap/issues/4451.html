<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Usage shows erroneous message - clap-rs/clap #4451</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Usage shows erroneous message</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/clap-rs/clap/issues/4451">#4451</a>
        opened by <a href="https://github.com/hectorruiz-it">@hectorruiz-it</a>
        on 2022-11-04 23:43
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/hectorruiz-it">@hectorruiz-it</a> on 2022-11-04 23:43</div>
            <div class="timeline-body"><h3>Please complete the following tasks</h3>
<ul>
<li>[X] I have searched the <a href="https://github.com/clap-rs/clap/discussions">discussions</a></li>
<li>[X] I have searched the <a href="https://github.com/clap-rs/clap/issues">open</a> and <a href="https://github.com/clap-rs/clap/issues?q=is%3Aissue+label%3AS-wont-fix+is%3Aclosed">rejected</a> issues</li>
</ul>
<h3>Rust Version</h3>
<p>rustc 1.63.0 (4b91a6ea7 2022-08-08)</p>
<h3>Clap Version</h3>
<p>&quot;4.0.18&quot;</p>
<h3>Minimal reproducible code</h3>
<pre><code class="language-rust">use std::process::exit;

use clap::{Parser, Subcommand};
use clap::ArgAction::SetTrue;

mod list;
mod new;
mod setup;

#[derive(Parser)]
#[clap(about, version, author)]
struct Value {
    #[clap(subcommand)]
    command: Commands,
}

#[derive(Subcommand)]
enum Commands {
    /// List client platforms and repositories
    List {
        #[clap(long = &quot;ssh&quot;, action = SetTrue, exclusive = true, required_unless_present_any = [&quot;clients&quot;])]
        /// List all platform ssh key alias
        ssh: bool,

        #[clap(long = &quot;clients&quot;, action = SetTrue, exclusive = true, required_unless_present_any = [&quot;ssh&quot;])]
        /// List all clients)]
        clients: bool,
    }

}

fn main() {
    let value = Value::parse();
    match &amp;value.command {
        Commands::List {
            ssh,
            clients,
        } =&gt; {
            if ssh.to_string() == &quot;true&quot; {
                match list::platforms() {
                    Ok(_) =&gt; exit(0),
                    Err(err) =&gt; {
                        eprintln!(&quot;ERROR: {}&quot;, err);
                        exit(1);
                    }
                };
            }
            if clients.to_string() == &quot;true&quot; {
                match list::clients() {
                    Ok(_) =&gt; exit(0),
                    Err(err) =&gt; {
                        eprintln!(&quot;ERROR: {}&quot;, err);
                        exit(1);
                    }
                }
            }
        }
    }
}


</code></pre>
<h3>Steps to reproduce the bug with the above code</h3>
<p>cargo run list</p>
<h3>Actual Behaviour</h3>
<pre><code class="language-rust">error: The following required arguments were not provided:
  --ssh
  --clients

Usage: grabber list --ssh --clients

For more information try '--help'
</code></pre>
<h3>Expected Behaviour</h3>
<pre><code class="language-rust">error: One of the following required arguments were not provided:
  --ssh
  --clients

Usage: grabber list --ssh  || grabber list --clients

For more information try '--help'
</code></pre>
<h3>Additional Context</h3>
<p>With the exclusive method, <code>--ssh</code> and <code>--clients</code> arguments can't be used together. The usage message doesn't representate this behaviour.
If you run the usage message works as expected printing that it can't be used with one or more of the other specified arguments:</p>
<pre><code class="language-rust">error: The argument '--ssh' cannot be used with one or more of the other specified arguments

Usage: grabber list [OPTIONS]

For more information try '--help'

</code></pre>
<h3>Debug Output</h3>
<p><em>No response</em></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">C-bug</span> added by @hectorruiz-it on 2022-11-04 23:43</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2022-11-05 01:25</div>
            <div class="timeline-body"><p>imo this is a fairly complicated state for clap to infer that we are unlikely to support it.</p>
<p>However, another way of expressing this is by putting the two arguments into an <code>ArgGroup</code> and marking the <code>ArgGroup</code> as required.</p>
<p>Something like</p>
<pre><code class="language-rust">use std::process::exit;

use clap::{Parser, Subcommand};
use clap::ArgAction::SetTrue;

mod list;
mod new;
mod setup;

#[derive(Parser)]
#[clap(about, version, author)]
struct Value {
    #[clap(subcommand)]
    command: Commands,
}

#[derive(Subcommand)]
enum Commands {
    /// List client platforms and repositories
    #[command(group = ArgGroup::new(&quot;action&quot;).required(true))]
    List {
        #[clap(group = &quot;action&quot;)]
        /// List all platform ssh key alias
        ssh: bool,

        #[clap(group = &quot;action&quot;)]
        /// List all clients)]
        clients: bool,
    }

}

fn main() {
    let value = Value::parse();
    match &amp;value.command {
        Commands::List {
            ssh,
            clients,
        } =&gt; {
            if ssh.to_string() == &quot;true&quot; {
                match list::platforms() {
                    Ok(_) =&gt; exit(0),
                    Err(err) =&gt; {
                        eprintln!(&quot;ERROR: {}&quot;, err);
                        exit(1);
                    }
                };
            }
            if clients.to_string() == &quot;true&quot; {
                match list::clients() {
                    Ok(_) =&gt; exit(0),
                    Err(err) =&gt; {
                        eprintln!(&quot;ERROR: {}&quot;, err);
                        exit(1);
                    }
                }
            }
        }
    }
}
</code></pre>
<p>https://github.com/clap-rs/clap/issues/2621 will make this even easier</p>
<p>Side notes</p>
<ul>
<li><code>long</code> can be inferred from the field name</li>
<li><code>bool</code> fields automatically get <code>ArgAction::SetTrue</code></li>
<li>exclusive should automatically disable <code>required = true</code></li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2022-11-05 01:26</div>
            <div class="timeline-body"><p>Due to the complexity of supporting the inferring of this while we provide a more direct way for users to request this, I'm going to go ahead and close this.  If there is something I missed, we can look into re-opening this.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @epage on 2022-11-05 01:26</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 01:35:15 UTC
    </footer>
</body>
</html>
