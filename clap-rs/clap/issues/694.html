<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Combination of options causes clap to apply validator to both default and user-specified option - clap-rs/clap #694</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Combination of options causes clap to apply validator to both default and user-specified option</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/clap-rs/clap/issues/694">#694</a>
        opened by <a href="https://github.com/ssokolow">@ssokolow</a>
        on 2016-10-18 01:50
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ssokolow">@ssokolow</a></div>
            <div class="timeline-body"><p>rustc version: rustc 1.12.0 (3191fbae9 2016-09-23)
clap Version: 2.14.0</p>
<p>In one of my new projects, I noticed that it was dying with an error about the default argument value failing &quot;path is readable&quot; validation, even when I was trying to override it with an explicit argument.</p>
<p>I started working on a simplified testcase and found that this bug is very picky. If any of these conditions aren&#x27;t met, it will act properly and validate either the default or the user-provided value but not both:</p>
<ul>
<li><code>global(true)</code> must be specified</li>
<li>A <code>default_value</code> must be specified</li>
<li>A <code>validator</code> must be provided</li>
<li>A subcommand must be defined and passed on the command line</li>
</ul>
<p>...but, if all of them are, it insists on validating both the default and the user-provided value.</p>
<p>It&#x27;s possible there&#x27;s more I could discover, but I&#x27;m sick and it&#x27;s getting late, so here&#x27;s how far I managed to minimize and pin down the test case so far:</p>
<pre><code>extern crate clap;
use clap::{App,Arg,SubCommand};

const DEFAULT_INPATH: &amp;&#x27;static str = &quot;/dev/sr1&quot;;

fn main() {
    App::new(&quot;testcase&quot;)
        .arg(Arg::with_name(&quot;inpath&quot;)
            .global(true)
            .default_value(DEFAULT_INPATH)
            .validator(|x| {
                print!(&quot;Testing {}\n&quot;, x);
                if x == DEFAULT_INPATH {
                    print!(&quot;ERROR: Validator ran on default string\n&quot;);
                }
                Ok(())
            }))
        .subcommand(SubCommand::with_name(&quot;test&quot;))
        .get_matches_from(&amp;[&quot;testcase&quot;, &quot;/dev/sr0&quot;, &quot;test&quot;]);
}
</code></pre>
<p><strong>EDIT:</strong> I also just noticed that it&#x27;s validating the default <em>after</em> the user-provided value:</p>
<pre><code>ssokolow@monolith testcase % cargo run            
    Finished debug [unoptimized + debuginfo] target(s) in 0.0 secs
     Running `target/debug/testcase`
Testing /dev/sr0
Testing /dev/sr1
ERROR: Validator ran on default string
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ssokolow">@ssokolow</a> on 2016-10-18 02:43</div>
            <div class="timeline-body"><p>Oh, I almost forgot to mention. If the <code>Arg</code> is a flag like <code>--inpath=[inpath]</code> rather than a positional argument, the <code>--inpath=/dev/sr0</code> must come after the subcommand on the command line to trigger the bug.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/kbknapp">@kbknapp</a> on 2016-10-18 14:14</div>
            <div class="timeline-body"><p>Thanks for all the detail! This will certainly help in getting this bug fixed quickly! I should be able to mock up a solution and test tonight when I get home. I&#x27;ll post back here with the solution. Once this bug is fixed, and the few PRs waiting to be merged are done I&#x27;ll put out the new version on crates.io (should be 2.14.1).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">T: bug</span> added by <a href="https://github.com/kbknapp">@kbknapp</a> on 2016-10-18 14:14</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">P2: need to have</span> added by <a href="https://github.com/kbknapp">@kbknapp</a> on 2016-10-18 14:14</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">C: parsing</span> added by <a href="https://github.com/kbknapp">@kbknapp</a> on 2016-10-18 14:14</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">W: 2.x</span> added by <a href="https://github.com/kbknapp">@kbknapp</a> on 2016-10-18 14:14</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to <a href="https://github.com/kbknapp">@kbknapp</a> by <a href="https://github.com/kbknapp">@kbknapp</a> on 2016-10-18 14:14</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone &quot;2.14.1&quot; by <a href="https://github.com/kbknapp">@kbknapp</a> on 2016-10-18 14:16</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ssokolow">@ssokolow</a> on 2016-10-18 20:47</div>
            <div class="timeline-body"><p>You&#x27;re welcome. Aside from a fast resolution benefiting me too, it&#x27;s the least I can do as thanks for offering up an enviable argument parser under a free license.</p>
<p>(And I do mean enviable. I really wish Python&#x27;s argparse could generate bash completions for my non-Rust projects.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/kbknapp">@kbknapp</a> on 2016-10-19 17:47</div>
            <div class="timeline-body"><p>I was having computer issues last night and wasn&#x27;t able to test this earlier. But now I&#x27;ve tested it.</p>
<p>As your minimal test is written, clap is functioning <em>somewhat</em> as intended. Here&#x27;s what&#x27;s happening in the test case above:</p>
<ul>
<li>clap gets an explicit value for <code>inpath</code>, and validates it</li>
<li>clap then reaches the subcommand <code>test</code></li>
<li>because <code>inpath</code> is global, there is effectively a <code>test &lt;inpath&gt;</code> as well.</li>
<li>Since <code>inpath</code> isn&#x27;t required, the subcommand&#x27;s <code>inpath</code> is empty and therefore gets the default value applied to it</li>
<li>clap then validates the default value of the <em>subcommand&#x27;s</em> <code>inpath</code></li>
</ul>
<p>Correct me if I&#x27;m wrong, but what you&#x27;d like is for the value to propagated down through child subcommands? If so, that&#x27;s a feature that could probably be added as an optional setting.</p>
<p>Edit: Incorrect data (fixed now)...</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ssokolow">@ssokolow</a> on 2016-10-19 17:53</div>
            <div class="timeline-body"><p>Hmm. I&#x27;ll want to offer you another testcase then (probably later tonight), since I don&#x27;t see how your explanation of the behaviour would make sense for what I observed when using <code>--inpath=[inpath]</code> rather than a positional argument.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/kbknapp">@kbknapp</a> on 2016-10-19 17:55</div>
            <div class="timeline-body"><p>I haven&#x27;t tested the <code>--inpath=[inpath]</code> yet, that&#x27;s next :wink:</p>
<p>Edit: Just ran the tests with <code>--inpath=[inpath]</code> and it appears to function the same for me.</p>
<p>Using</p>
<pre><code>extern crate clap;
use clap::{App,Arg,SubCommand};

const DEFAULT_INPATH: &amp;&#x27;static str = &quot;/dev/sr1&quot;;

fn main() {
    App::new(&quot;testcase&quot;)
        .arg(Arg::with_name(&quot;inpath&quot;)
            .global(true)
            .long(&quot;inpath&quot;) // added this
            .takes_value(true) // and this
            .default_value(DEFAULT_INPATH)
            .validator(|x| {
                print!(&quot;Testing {}\n&quot;, x);
                if x == DEFAULT_INPATH {
                    print!(&quot;ERROR: Validator ran on default string\n&quot;);
                }
                Ok(())
            }))
        .subcommand(SubCommand::with_name(&quot;test&quot;))
        .get_matches_from(&amp;[&quot;testcase&quot;, &quot;--inpath=/dev/sr0&quot;, &quot;test&quot;]); // changed this
}
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/kbknapp">@kbknapp</a> on 2016-10-19 17:56</div>
            <div class="timeline-body"><p>Also, if you compile clap with <code>features = [&quot;debug&quot;]</code> it&#x27;ll spit out tons of data while parsing.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ssokolow">@ssokolow</a> on 2016-10-19 17:59</div>
            <div class="timeline-body"><p>I probably would have thought to look for ways to produce debugging output, but, while I was working on the testcase, I had a very bad cold and wasn&#x27;t really thinking clearly. (It didn&#x27;t even occur to me to keep the <code>--inpath</code> testcase while reducing the problem in case they turned out to be two related bugs.)</p>
<p>Thankfully, I seem to be past the worst of it now.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">T: RFC / question</span> added by <a href="https://github.com/kbknapp">@kbknapp</a> on 2016-10-19 18:57</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">C: parsing</span> removed by <a href="https://github.com/kbknapp">@kbknapp</a> on 2016-10-19 18:57</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">P2: need to have</span> removed by <a href="https://github.com/kbknapp">@kbknapp</a> on 2016-10-19 18:57</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">T: bug</span> removed by <a href="https://github.com/kbknapp">@kbknapp</a> on 2016-10-19 18:57</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">W: 2.x</span> removed by <a href="https://github.com/kbknapp">@kbknapp</a> on 2016-10-19 18:57</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Removed from milestone &quot;2.14.1&quot; by <a href="https://github.com/kbknapp">@kbknapp</a> on 2016-10-19 18:57</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/kbknapp">@kbknapp</a> on 2016-11-02 02:59</div>
            <div class="timeline-body"><p>@ssokolow I&#x27;m going to close this. Please let me know if this is still an issue and we can re-open.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/kbknapp">@kbknapp</a> on 2016-11-02 02:59</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ssokolow">@ssokolow</a> on 2016-11-02 03:37</div>
            <div class="timeline-body"><p>Will do. I&#x27;ve been meaning to test for days but more pressing concerns just keep popping up.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ssokolow">@ssokolow</a> on 2016-11-25 08:05</div>
            <div class="timeline-body"><p>Sorry for the wait. What version was this supposed to be fixed in? I&#x27;m still getting test failures under 2.19.0.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/kbknapp">@kbknapp</a> on 2016-11-26 20:59</div>
            <div class="timeline-body"><p>@ssokolow can you provide your failing test case?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Reopened by <a href="https://github.com/kbknapp">@kbknapp</a> on 2016-11-26 20:59</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ssokolow">@ssokolow</a> on 2016-11-27 03:29</div>
            <div class="timeline-body"><p>Here&#x27;s the &quot;not yet beyond clap boilerplate&quot; project that&#x27;s failing.</p>
<p>https://github.com/ssokolow/rip_media</p>
<p><code>cargo test</code> will illustrate the problem very clearly.</p>
<p><strong>EDIT:</strong> ...assuming you&#x27;re running a Linux system with at least one CD/DVD/BluRay drive. Otherwise, you&#x27;ll need to replace the hard-coded <code>/dev/sr0</code> default path with something else.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/kbknapp">@kbknapp</a> on 2016-11-28 16:34</div>
            <div class="timeline-body"><p>I&#x27;ve taken a look at this, and it looks like my original explanation stands. Propagating those values down through the child <code>--inpath</code> args would solve this issue. But my hesitation some users may not want that behavior due to conflicting uses of a global argument. Imagine a command which uses a global arg, but the implementation means the context is different depending on which subcommand the value was provided to.</p>
<p>What I would suggest is one of two things:</p>
<ol>
<li>Don&#x27;t use global args in this instance, and instead confine the <code>--inpath</code> to parent command</li>
<li>Instead of subcommands, use a single positional argument with predefined values (<a href="https://docs.rs/clap/2.19.0/clap/struct.Arg.html#method.possible_values"><code>Arg::possible_values</code></a>) since you&#x27;re not defining additional arguments on those subcommands and merely using them to differentiate between values.</li>
</ol>
<p>Both of those approaches have their pros and cons. If you were planning on adding additional unique args to those subcommands option 2 isn&#x27;t as feasible. Option 1 provides a slightly less flexible CLI.</p>
<p>Of course there&#x27;s also the ability to add another <code>AppSettings</code> variant which allows propagating values down through subcommands. The only problem with this, is due to how it&#x27;s implemented, it&#x27;s not easily possible to propagate values <em>up</em> or <em>sideways</em> only down in the tree. So this setting could be a potential point of confusion.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ssokolow">@ssokolow</a> on 2016-11-28 16:47</div>
            <div class="timeline-body"><p>Option 2 is unfeasible for exactly the reason you stated. Processing CleanRip dumps from a Wii SD card is going to have options different from those for <code>/media/ssokolow/RETRODE</code> which, again, will be different from optical media, which will have their own special options if they&#x27;re being dumped as audio or audio+data CDs. I just happened to nail down the common schema first.</p>
<p>As for option 1, it&#x27;s not an acceptable user experience for when I dogfood it. I&#x27;d sooner include two separate argument parsers into my program with the first one&#x27;s only purpose being to recognize global arguments and reposition them in the command line before passing it on to clap.</p>
<p>(I&#x27;m the &quot;good user experience at any cost&quot; type. The whole reason I&#x27;m using Rust is because the compile-time checks help me accomplish that goal.)</p>
<p>For comparison with another parser&#x27;s solution, when I do this with <a href="https://docs.python.org/dev/library/argparse.html"><code>argparse</code></a> in Python, it&#x27;s accomplished via a mechanism analogous to OOP inheritance where an <code>ArgumentParser</code> is defined for the common arguments and then passed via a <code>parents=[]</code> argument when instantiating each subcommand&#x27;s <code>ArgumentParser</code> instance.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/kbknapp">@kbknapp</a> on 2016-11-28 17:58</div>
            <div class="timeline-body"><p>Ok, I&#x27;m good adding the settings variant which propagates values down, that&#x27;d actually be a decently easy addition. I&#x27;ll play with some implementations once I&#x27;ve got a little bit of time and post back here.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">C: settings</span> added by <a href="https://github.com/kbknapp">@kbknapp</a> on 2016-11-28 17:59</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">D: easy</span> added by <a href="https://github.com/kbknapp">@kbknapp</a> on 2016-11-28 17:59</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">P4: nice to have</span> added by <a href="https://github.com/kbknapp">@kbknapp</a> on 2016-11-28 17:59</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">T: new setting</span> added by <a href="https://github.com/kbknapp">@kbknapp</a> on 2016-11-28 17:59</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">W: 2.x</span> added by <a href="https://github.com/kbknapp">@kbknapp</a> on 2016-11-28 17:59</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">T: RFC / question</span> removed by <a href="https://github.com/kbknapp">@kbknapp</a> on 2016-11-28 17:59</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone &quot;2.20.0&quot; by <a href="https://github.com/kbknapp">@kbknapp</a> on 2016-12-27 04:36</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/homu">@homu</a> on 2017-01-03 06:56</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:56:35 UTC
    </footer>
</body>
</html>
