<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Unexpected behavior combining `AppSettings::TrailingVarArg` and `env` fallbacks - clap-rs/clap #2641</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Unexpected behavior combining `AppSettings::TrailingVarArg` and `env` fallbacks</h1>

    <div class="meta">
        <span class="state state-closed">Closed</span>
        <a href="https://github.com/clap-rs/clap/issues/2641">#2641</a>
        opened by <a href="https://github.com/eadwu">@eadwu</a>
        on 2021-07-29 21:58
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/eadwu">@eadwu</a> on 2021-07-29 21:58</div>
            <div class="timeline-body"><h3>Please complete the following tasks</h3>
<ul>
<li>[X] I have searched the <a href="https://github.com/clap-rs/clap/discussions">discussions</a></li>
<li>[X] I have searched the existing issues</li>
</ul>
<h3>Rust Version</h3>
<p>rustc 1.56.0-nightly (b70888601 2021-07-28)</p>
<h3>Clap Version</h3>
<p>2.33.3</p>
<h3>Minimal reproducible code</h3>
<pre><code class="language-rust">use structopt::{clap::AppSettings, StructOpt};

#[derive(StructOpt, Debug)]
#[structopt(
    setting = AppSettings::TrailingVarArg,
)]
struct Arguments {
    #[structopt(env = &quot;SHELL&quot;, raw(true), multiple(true), use_delimiter(false))]
    cmd: Vec&lt;String&gt;,
}

pub fn main() {
    let args = Arguments::from_args();

    println!(&quot;{:?}&quot;, args);
}
</code></pre>
<h3>Steps to reproduce the bug with the above code</h3>
<pre><code class="language-bash">❯  result/bin/binary --
❯  result/bin/binary -- $SHELL
❯  result/bin/binary -- $SHELL -i
❯  result/bin/binary -- -i
❯  result/bin/binary -- -i $SHELL
</code></pre>
<h3>Actual Behaviour</h3>
<pre><code class="language-bash">❯  result/bin/binary --
Arguments { cmd: [&quot;/nix/store/pfk6bllfmp7k939wwd6l3iycb500mvz2-zsh-5.8/bin/zsh&quot;] }
❯  result/bin/binary -- $SHELL
Arguments { cmd: [&quot;/nix/store/pfk6bllfmp7k939wwd6l3iycb500mvz2-zsh-5.8/bin/zsh&quot;, &quot;/nix/store/pfk6bllfmp7k939wwd6l3iycb500mvz2-zsh-5.8/bin/zsh&quot;] }
❯  result/bin/binary -- $SHELL -i
Arguments { cmd: [&quot;/nix/store/pfk6bllfmp7k939wwd6l3iycb500mvz2-zsh-5.8/bin/zsh&quot;, &quot;-i&quot;, &quot;/nix/store/pfk6bllfmp7k939wwd6l3iycb500mvz2-zsh-5.8/bin/zsh&quot;] }
❯  result/bin/binary -- -i
Arguments { cmd: [&quot;-i&quot;, &quot;/nix/store/pfk6bllfmp7k939wwd6l3iycb500mvz2-zsh-5.8/bin/zsh&quot;] }
❯  result/bin/binary -- -i $SHELL
Arguments { cmd: [&quot;-i&quot;, &quot;/nix/store/pfk6bllfmp7k939wwd6l3iycb500mvz2-zsh-5.8/bin/zsh&quot;, &quot;/nix/store/pfk6bllfmp7k939wwd6l3iycb500mvz2-zsh-5.8/bin/zsh&quot;] }
</code></pre>
<h3>Expected Behaviour</h3>
<pre><code class="language-bash">❯  result/bin/binary --
Arguments { cmd: [&quot;/nix/store/pfk6bllfmp7k939wwd6l3iycb500mvz2-zsh-5.8/bin/zsh&quot;] }
❯  result/bin/binary -- $SHELL
Arguments { cmd: [&quot;/nix/store/pfk6bllfmp7k939wwd6l3iycb500mvz2-zsh-5.8/bin/zsh&quot;] }
❯  result/bin/binary -- $SHELL -i
Arguments { cmd: [&quot;/nix/store/pfk6bllfmp7k939wwd6l3iycb500mvz2-zsh-5.8/bin/zsh&quot;, &quot;-i&quot;] }
❯  result/bin/binary -- -i
Arguments { cmd: [&quot;-i&quot;] }
❯  result/bin/binary -- -i $SHELL
Arguments { cmd: [&quot;-i&quot;, &quot;/nix/store/pfk6bllfmp7k939wwd6l3iycb500mvz2-zsh-5.8/bin/zsh&quot;] }
</code></pre>
<h3>Additional Context</h3>
<p>https://github.com/TeXitoi/structopt/issues/487</p>
<p><code>default_value = &quot;SHELL&quot;</code> works fine though</p>
<pre><code class="language-bash">❯  result/bin/binary --
Arguments { cmd: [&quot;SHELL&quot;] }
❯  result/bin/binary -- $SHELL
Arguments { cmd: [&quot;/nix/store/pfk6bllfmp7k939wwd6l3iycb500mvz2-zsh-5.8/bin/zsh&quot;] }
❯  result/bin/binary -- $SHELL -i
Arguments { cmd: [&quot;/nix/store/pfk6bllfmp7k939wwd6l3iycb500mvz2-zsh-5.8/bin/zsh&quot;, &quot;-i&quot;] }
❯  result/bin/binary -- -i
Arguments { cmd: [&quot;-i&quot;] }
❯  result/bin/binary -- -i $SHELL
Arguments { cmd: [&quot;-i&quot;, &quot;/nix/store/pfk6bllfmp7k939wwd6l3iycb500mvz2-zsh-5.8/bin/zsh&quot;] }
</code></pre>
<h3>Debug Output</h3>
<p><em>No response</em></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">T: bug</span> added by @eadwu on 2021-07-29 21:58</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2021-07-30 01:07</div>
            <div class="timeline-body"><p>Just taking notes on this:</p>
<ul>
<li>When you call <code>Arg::env</code>, we read the variable at that time and store both name and value</li>
<li><code>Validator::validate</code> calls <code>add_env</code> and then immediately <code>add_default</code><ul>
<li><code>add_env</code> loops through all args<ul>
<li>If it takes a value, we call <code>add_single_val</code></li>
<li>If it doesn't, we first check if the env var's value is help or version?  That is surprising.  Then we call <code>add_index_to</code>.  I'm, assuming this just marks it as present</li>
</ul>
</li>
<li><code>add_default</code> loops through <code>get_opts</code> and then <code>get_positionals</code><ul>
<li><code>add_value</code></li>
</ul>
</li>
</ul>
</li>
</ul>
<p>What stands out for this particular issue is:</p>
<pre><code class="language-rust">            // Use env only if the arg was not present among command line args
            if matcher.get(&amp;a.id).map_or(true, |a| a.occurs == 0) {
...
            if matcher.get(&amp;arg.id).is_some() {
                debug!(&quot;Parser::add_value:iter:{}: was used&quot;, arg.name);
</code></pre>
<p>They are checking for what is &quot;present&quot; in different ways.  Seems like we should unify this.</p>
<p>(note: all of this was researched on clap3, I've not verified if this problem still exists on clap3 so this is all speculation so far)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2021-07-30 01:33</div>
            <div class="timeline-body"><p>Looks like this <strong>is</strong> fixed in clapv3</p>
<p>clapv2</p>
<pre><code class="language-rust">
#[test]
fn trailing_var_arg() {
    let env_name = &quot;CLP_TEST_TRAILING_VAR_ARG&quot;;
    let env_value = &quot;zsh&quot;;
    env::set_var(env_name, env_value);
    let app = App::new(&quot;df&quot;)
        .setting(clap::AppSettings::TrailingVarArg)
        .arg(
            Arg::with_name(&quot;cmd&quot;)
                .env(env_name)
                .takes_value(true)
                .multiple(true)
                .use_delimiter(false),
        );

    let m = app.clone().get_matches_from_safe(vec![&quot;df&quot;, &quot;--&quot;]).unwrap();
    assert!(m.is_present(&quot;cmd&quot;));
    assert_eq!(m.occurrences_of(&quot;cmd&quot;), 0);
    assert_eq!(
        m.values_of(&quot;cmd&quot;).unwrap().collect::&lt;Vec&lt;_&gt;&gt;(),
        vec![env_value]
    );

    let m = app
        .clone()
        .get_matches_from_safe(vec![&quot;df&quot;, &quot;--&quot;, &quot;-i&quot;])
        .unwrap();
    assert!(m.is_present(&quot;cmd&quot;));
    assert_eq!(m.occurrences_of(&quot;cmd&quot;), 1);
    assert_eq!(m.values_of(&quot;cmd&quot;).unwrap().collect::&lt;Vec&lt;_&gt;&gt;(), vec![&quot;-i&quot;]);
}
</code></pre>
<p>Gives</p>
<pre><code>thread 'trailing_var_arg' panicked at 'assertion failed: `(left == right)`
  left: `[&quot;-i&quot;, &quot;zsh&quot;]`,
 right: `[&quot;-i&quot;]`', tests/env.rs:293:5
note: run with `RUST_BACKTRACE=1` environment variable to display a backtrace
</code></pre>
<p>while clap3 passes</p>
<pre><code class="language-rust">
#[test]
fn trailing_var_arg() {
    let env_name = &quot;CLP_TEST_TRAILING_VAR_ARG&quot;;
    let env_value = &quot;zsh&quot;;
    env::set_var(env_name, env_value);
    let app = App::new(&quot;df&quot;).setting(AppSettings::TrailingVarArg).arg(
        Arg::new(&quot;cmd&quot;)
            .env(env_name)
            .takes_value(true)
            .multiple_values(true)
            .use_delimiter(false),
    );

    let m = app.clone().try_get_matches_from(vec![&quot;df&quot;, &quot;--&quot;]).unwrap();
    assert!(m.is_present(&quot;cmd&quot;));
    assert_eq!(m.occurrences_of(&quot;cmd&quot;), 0);
    assert_eq!(
        m.values_of(&quot;cmd&quot;).unwrap().collect::&lt;Vec&lt;_&gt;&gt;(),
        vec![env_value]
    );

    let m = app
        .clone()
        .try_get_matches_from(vec![&quot;df&quot;, &quot;--&quot;, &quot;-i&quot;])
        .unwrap();
    assert!(m.is_present(&quot;cmd&quot;));
    assert_eq!(m.occurrences_of(&quot;cmd&quot;), 1);
    assert_eq!(m.values_of(&quot;cmd&quot;).unwrap().collect::&lt;Vec&lt;_&gt;&gt;(), vec![&quot;-i&quot;]);
}
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @pksunkara on 2021-07-30 09:31</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:35:08 UTC
    </footer>
</body>
</html>
