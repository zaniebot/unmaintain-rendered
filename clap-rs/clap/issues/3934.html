<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ability to generate help output golden test file? - clap-rs/clap #3934</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Ability to generate help output golden test file?</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/clap-rs/clap/issues/3934">#3934</a>
        opened by <a href="https://github.com/SUPERCILEX">@SUPERCILEX</a>
        on 2022-07-14 03:54
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/SUPERCILEX">@SUPERCILEX</a></div>
            <div class="timeline-body">Please complete the following tasks
<ul>
<li>[X] I have searched the <a href="https://github.com/clap-rs/clap/discussions">discussions</a></li>
<li>[X] I have searched the <a href="https://github.com/clap-rs/clap/issues">open</a> and <a href="https://github.com/clap-rs/clap/issues?q=is%3Aissue+label%3AS-wont-fix+is%3Aclosed">rejected</a> issues</li>
</ul>
Clap Version
<p>3.x</p>
Describe your use case
<p>It&#x27;s extremely helpful for reviewers to be able to see the changes to your CLI&#x27;s interface from the user&#x27;s point of view. It&#x27;s also helpful to have what&#x27;s essentially a rendered man page autogenerated for users to browse.</p>
Describe the solution you&#x27;d like
<p>Offer some way to generate one string with every commands help page concatenated together. Maybe also offer easy golden testing though honestly that should just be left to the user with an example using the goldenfile crate.</p>
Alternatives, if applicable
<p>Maybe trycmd, but I don&#x27;t know how you automatically get all the help pages.</p>
Additional Context
<p><em>No response</em></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/SUPERCILEX">@SUPERCILEX</a> on 2022-07-14 03:57</div>
            <div class="timeline-body"><p>Extending this idea a little further, you could potentially output the help as markdown with header sections for each command which could then be used as an autogenerated docs website.</p>
<p>I guess that means the interface should actually return a map with the command path to its help output (so you can be flexible and output one page per command for example) and some way to specify what that output should look like. Then I can concatenate it myself and pass it through a golden test.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2022-07-14 15:08</div>
            <div class="timeline-body"><p>Created a quick example of what this could potentially look like</p>
<pre><code>#!/usr/bin/env -S rust-script --debug

//! ```cargo
//! [dependencies]
//! clap = { version = &quot;3.2.8&quot;, features = [&quot;env&quot;, &quot;derive&quot;] }
//! ```

use std::ffi::OsString;
use std::path::PathBuf;

use clap::{Args, Parser, Subcommand};

/// A fictional versioning CLI
#[derive(Debug, Parser)]
#[clap(name = &quot;git&quot;)]
#[clap(about = &quot;A fictional versioning CLI&quot;, long_about = None)]
struct Cli {
    #[clap(subcommand)]
    command: Commands,
}

#[derive(Debug, Subcommand)]
enum Commands {
    /// Clones repos
    #[clap(arg_required_else_help = true)]
    Clone {
        /// The remote to clone
        #[clap(value_parser)]
        remote: String,
    },
    /// pushes things
    #[clap(arg_required_else_help = true)]
    Push {
        /// The remote to target
        #[clap(value_parser)]
        remote: String,
    },
    /// adds things
    #[clap(arg_required_else_help = true)]
    Add {
        /// Stuff to add
        #[clap(required = true, value_parser)]
        path: Vec&lt;PathBuf&gt;,
    },
    Stash(Stash),
    #[clap(external_subcommand)]
    External(Vec&lt;OsString&gt;),
}

#[derive(Debug, Args)]
#[clap(args_conflicts_with_subcommands = true)]
struct Stash {
    #[clap(subcommand)]
    command: Option&lt;StashCommands&gt;,

    #[clap(flatten)]
    push: StashPush,
}

#[derive(Debug, Subcommand)]
enum StashCommands {
    Push(StashPush),
    Pop {
        #[clap(value_parser)]
        stash: Option&lt;String&gt;,
    },
    Apply {
        #[clap(value_parser)]
        stash: Option&lt;String&gt;,
    },
}

#[derive(Debug, Args)]
struct StashPush {
    #[clap(short, long, value_parser)]
    message: Option&lt;String&gt;,
}

fn main() {
    use clap::CommandFactory;
    let mut command = Cli::command();

    let mut buffer: Vec&lt;u8&gt; = Default::default();
    command.build();
    write_help(&amp;mut buffer, &amp;mut command, 0);
    let buffer = String::from_utf8(buffer).unwrap();
    println!(&quot;{}&quot;, buffer);
}

fn write_help(buffer: &amp;mut impl std::io::Write, cmd: &amp;mut clap::Command&lt;&#x27;_&gt;, depth: usize) {
    let header = (0..=depth).map(|_| &#x27;#&#x27;).collect::&lt;String&gt;();
    let _ = writeln!(buffer, &quot;{} {}&quot;, header, cmd.get_name());
    let _ = writeln!(buffer);
    let _ = cmd.write_long_help(buffer);

    for sub in cmd.get_subcommands_mut() {
        let _ = writeln!(buffer);
        write_help(buffer, sub, depth + 1);
    }
}
</code></pre>
<p>EDIT: Updated to capture it in-memory</p>
<p>Note: you could use snapbox to do snapshot testing.  It is the core of trycmd, so you&#x27;d save on compile times.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">A-docs</span> added by <a href="https://github.com/epage">@epage</a> on 2022-07-14 15:13</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">E-easy</span> added by <a href="https://github.com/epage">@epage</a> on 2022-07-14 15:13</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2022-07-14 15:13</div>
            <div class="timeline-body"><p>While I can understand the importance of this and the value of a happy path to it to encourage it, I feel like there is too much policy involved in this to have clap involved atm.</p>
<p>I could see us adding an example of this though.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/SUPERCILEX">@SUPERCILEX</a> on 2022-07-31 19:46</div>
            <div class="timeline-body"><p>This is really great, thank you! Implemented it here for the curious: https://github.com/SUPERCILEX/ftzz/commit/734d0e39d5671e75fae6e984c0e740b4adfbc68a</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/SUPERCILEX">@SUPERCILEX</a> on 2022-07-31 20:55</div>
            <div class="timeline-body"><p>Some notes: using the <code>wrap_help</code> feature breaks things â€” this could probably be fixed by disabling wrapping when some env var is detected, but eh that&#x27;ll be finicky.</p>
<p>A gitattribute needs to be added to the golden file that checks it out with LN endings on windows. (Or use a golden library that ignores different line endings.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2022-08-01 16:53</div>
            <div class="timeline-body"><p>Re-opening to track adding an example</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Reopened by <a href="https://github.com/epage">@epage</a> on 2022-08-01 16:53</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/SUPERCILEX">@SUPERCILEX</a> on 2022-11-16 03:57</div>
            <div class="timeline-body"><p>Here&#x27;s the latest that I&#x27;ve settled on if you want to copypasta. I&#x27;m quite happy with it:</p>
<pre><code>    #[test]
    #[cfg_attr(miri, ignore)] // wrap_help breaks miri
    fn help_for_review() {
        let mut command = Ftzz::command();

        command.build();

        let mut long = String::new();
        let mut short = String::new();

        write_help(&amp;mut long, &amp;mut command, LongOrShortHelp::Long);
        write_help(&amp;mut short, &amp;mut command, LongOrShortHelp::Short);

        expect_file![&quot;../command-reference.golden&quot;].assert_eq(&amp;long);
        expect_file![&quot;../command-reference-short.golden&quot;].assert_eq(&amp;short);
    }

    #[derive(Copy, Clone)]
    enum LongOrShortHelp {
        Long,
        Short,
    }

    fn write_help(buffer: &amp;mut impl Write, cmd: &amp;mut Command, long_or_short_help: LongOrShortHelp) {
        write!(
            buffer,
            &quot;{}&quot;,
            match long_or_short_help {
                LongOrShortHelp::Long =&gt; cmd.render_long_help(),
                LongOrShortHelp::Short =&gt; cmd.render_help(),
            }
        )
        .unwrap();

        for sub in cmd.get_subcommands_mut() {
            writeln!(buffer).unwrap();
            writeln!(buffer, &quot;---&quot;).unwrap();
            writeln!(buffer).unwrap();

            write_help(buffer, sub, long_or_short_help);
        }
    }
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a>aciba90/cloud-config-validator#23</a> on 2024-04-01 11:02</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:59:10 UTC
    </footer>
</body>
</html>
