<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>infer_subcommands should not fail if the ambiguity is over aliases - clap-rs/clap #5021</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>infer_subcommands should not fail if the ambiguity is over aliases</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/clap-rs/clap/issues/5021">#5021</a>
        opened by <a href="https://github.com/Xophmeister">@Xophmeister</a>
        on 2023-07-19 14:19
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/Xophmeister">@Xophmeister</a> on 2023-07-19 14:19</div>
            <div class="timeline-body"><h3>Please complete the following tasks</h3>
<ul>
<li>[X] I have searched the <a href="https://github.com/clap-rs/clap/discussions">discussions</a></li>
<li>[X] I have searched the <a href="https://github.com/clap-rs/clap/issues">open</a> and <a href="https://github.com/clap-rs/clap/issues?q=is%3Aissue+label%3AS-wont-fix+is%3Aclosed">rejected</a> issues</li>
</ul>
<h3>Rust Version</h3>
<p>rustc 1.70.0 (90c541806 2023-05-31) (built from a source tarball)</p>
<h3>Clap Version</h3>
<p>4.3.12</p>
<h3>Minimal reproducible code</h3>
<pre><code class="language-rust">use clap::{Parser, Subcommand};

#[derive(Parser, Debug)]
#[command(infer_subcommands = true)]
struct TestCli {
    #[command(subcommand)]
    command: Commands,
}

#[derive(Debug, Subcommand)]
enum Commands {
    #[command(alias = &quot;config&quot;)]
    Cfg,
}

fn main() {
    let cli = TestCli::parse();
    println!(&quot;{:?}&quot;, cli);
}
</code></pre>
<h3>Steps to reproduce the bug with the above code</h3>
<pre><code>cargo run -- c
</code></pre>
<h3>Actual Behaviour</h3>
<p>It recognises the ambiguity between <code>config</code> and <code>cfg</code>:</p>
<pre><code>error: unrecognized subcommand 'c'

  tip: some similar subcommands exist: 'config', 'cfg'
  tip: to pass 'c' as a value, use 'example -- c'

Usage: example &lt;COMMAND&gt;

For more information, try '--help'.
</code></pre>
<h3>Expected Behaviour</h3>
<p>When an ambiguity only spans a single subcommand and its aliases, then it should resolve to that subcommand:</p>
<pre><code>TestCli { command: Cfg }
</code></pre>
<h3>Additional Context</h3>
<p><code>infer_long_args</code> may also have the same behaviour; I haven't checked.</p>
<h3>Debug Output</h3>
<pre><code>[clap_builder::builder::command]Command::_do_parse
[clap_builder::builder::command]Command::_build: name=&quot;example&quot;
[clap_builder::builder::command]Command::_propagate:example
[clap_builder::builder::command]Command::_check_help_and_version:example expand_help_tree=false
[clap_builder::builder::command]Command::long_help_exists
[clap_builder::builder::command]Command::_check_help_and_version: Building default --help
[clap_builder::builder::command]Command::_check_help_and_version: Building help subcommand
[clap_builder::builder::command]Command::_propagate_global_args:example
[clap_builder::builder::debug_asserts]Command::_debug_asserts
[clap_builder::builder::debug_asserts]Arg::_debug_asserts:help
[clap_builder::builder::debug_asserts]Command::_verify_positionals
[clap_builder::parser::parser]Parser::get_matches_with
[clap_builder::parser::parser]Parser::get_matches_with: Begin parsing '&quot;c&quot;'
[clap_builder::parser::parser]Parser::possible_subcommand: arg=Ok(&quot;c&quot;)
[clap_builder::parser::parser]Parser::get_matches_with: sc=None
[clap_builder::parser::parser]Parser::get_matches_with: Positional counter...1
[clap_builder::parser::parser]Parser::get_matches_with: Low index multiples...false
[ clap_builder::output::usage]Usage::create_usage_with_title
[ clap_builder::output::usage]Usage::create_usage_no_title
[ clap_builder::output::usage]Usage::create_help_usage; incl_reqs=true
[ clap_builder::output::usage]Usage::needs_options_tag
[ clap_builder::output::usage]Usage::needs_options_tag:iter: f=help
[ clap_builder::output::usage]Usage::needs_options_tag:iter Option is built-in
[ clap_builder::output::usage]Usage::needs_options_tag: [OPTIONS] not required
[ clap_builder::output::usage]Usage::get_args: incls=[]
[ clap_builder::output::usage]Usage::get_args: unrolled_reqs=[]
[ clap_builder::output::usage]Usage::get_args: ret_val=[]
[ clap_builder::output::usage]Usage::create_help_usage: usage=example &lt;COMMAND&gt;
[clap_builder::builder::command]Command::color: Color setting...
[clap_builder::builder::command]Auto
[clap_builder::builder::command]Command::color: Color setting...
[clap_builder::builder::command]Auto
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">C-bug</span> added by @Xophmeister on 2023-07-19 14:19</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/4815.html">clap-rs/clap#4815</a> on 2023-07-19 14:51</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2023-07-19 14:53</div>
            <div class="timeline-body"><p>#4815 has some more information on this though that was covering multiple issues with inferring, so I've closed it out for one specific one, pointing here.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">A-parsing</span> added by @epage on 2023-07-19 14:54</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/SUPERCILEX">@SUPERCILEX</a> on 2023-07-19 18:45</div>
            <div class="timeline-body"><p>Won't be able to do research anytime soon, but if it's decided that this issue should be fixed, I can put up my PR.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2023-07-19 19:26</div>
            <div class="timeline-body"><p>When there is ambiguity between a subcommand and its alias, it would be an error today.  Turning error cases into success is not a breaking change.</p>
<p>We have three different inference checks</p>
<ul>
<li>subcommand names: doesn't handle aliases</li>
<li>subcommand longs: handles aliases</li>
<li>longs: handles aliases</li>
</ul>
<p>(based on code inspection and experimentation in #4815)</p>
<p>So resolving this would resolve an inconsistency.</p>
<p>Deciding on the consistency to error (prefer subcommand names approach) would likely be considered a breaking change.  It is also an overall lesser user experience.  The only reason we may consider it is if we felt it would offer enough binary size savings that we weigh that out over the impact of people affected by this behavior.   I have a hard time seeing how this would make a significant difference in binary size; many similar size changes go in without being measured.</p>
<p>So from that, I'd be willing to merge a fix for this.  I would ask that the fix ensure that tests exist for subcommand longs and longs, adding them if they don't.  A nice to have is to have the first commit add the test, verifying the existing behavior (error) and the second commit fixes the bug and updates the test.  This helps show confirm to reviewers (1) the test is testing the right thing and (2) the change has the intended afect.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">E-easy</span> added by @epage on 2023-07-19 19:27</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @epage on 2023-09-25 20:56</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 01:35:27 UTC
    </footer>
</body>
</html>
