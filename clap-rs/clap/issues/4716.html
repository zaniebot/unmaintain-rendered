<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>error messages should textwrap like `--help` - clap-rs/clap #4716</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>error messages should textwrap like <code>--help</code></h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/clap-rs/clap/issues/4716">#4716</a>
        opened by <a href="https://github.com/cbs228">@cbs228</a>
        on 2023-02-18 22:11
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/cbs228">@cbs228</a> on 2023-02-18 22:11</div>
            <div class="timeline-body"><h3>Please complete the following tasks</h3>
<ul>
<li>[X] I have searched the <a href="https://github.com/clap-rs/clap/discussions">discussions</a></li>
<li>[X] I have searched the <a href="https://github.com/clap-rs/clap/issues">open</a> and <a href="https://github.com/clap-rs/clap/issues?q=is%3Aissue+label%3AS-wont-fix+is%3Aclosed">rejected</a> issues</li>
</ul>
<h3>Clap Version</h3>
<p>4.1.6</p>
<h3>Describe your use case</h3>
<p>I am attempting to use <a href="https://docs.rs/clap/4.1.6/clap/builder/struct.Command.html#method.error"><code>clap::Command::error()</code></a> to harmonize my crate's startup error messages. In addition to normal argument-parsing errors, I also use clap to report &quot;<em>can't open file XXXX</em>&quot; and similar types of startup errors. This permits them to be printed with the red <code>error:</code> prefix provided by the <code>color</code> feature.</p>
<p>When built with the <code>wrap_help</code> feature, the output of <code>--help</code> is automatically wrapped to the terminal size (or to <code>max_term_width</code>). I would expect this text-wrapping to also be applied to errors, but it is not.</p>
<h3>Describe the solution you'd like</h3>
<p>The following minimal example reproduces one of my crate's error messages:</p>
<pre><code class="language-rs">extern crate clap;

use clap::Command;

const ERR : &amp;str = &quot;cowardly refusing to read audio samples from a terminal.\n\nPipe a source of raw uncompressed audio from sox, parec, rtl_fm, or similar into this program.&quot;;

fn main() {
    Command::new(&quot;test&quot;)
        .max_term_width(91)
        .error(clap::error::ErrorKind::Io, ERR)
        .exit();
}
</code></pre>
<p><a href="https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2021&amp;gist=fc88a36dd627ae3e79572946c1ed5ad2">Playground link</a></p>
<p>On my terminal, which is 91-characters wide, this renders as:</p>
<pre><code class="language-txt">error: cowardly refusing to read audio samples from a terminal.

Pipe a source of raw uncompressed audio from sox, parec, rtl_fm, or similar into this progr
am.
</code></pre>
<p>The naive line-wrapping of my terminal emulator splits a word, making it hard to read.</p>
<p>The output could be improved by applying the logic already used to wrap <code>--help</code> text to error messages as well. Then the output would wrap neatly at word boundaries, like this:</p>
<pre><code class="language-txt">error: cowardly refusing to read audio samples from a terminal.

Pipe a source of raw uncompressed audio from sox, parec, rtl_fm, or similar into this
program.
</code></pre>
<h3>Alternatives, if applicable</h3>
<p>The wrapping behavior could be implemented in a custom <code>ErrorFormatter</code>. As far as I know, the logic for detecting terminal presence, terminal width, and for performing text wrapping appears to be internal to clap. Re-implementing this logic in the client crate would probably result in several more direct dependencies (like <code>atty</code>).</p>
<h3>Additional Context</h3>
<p>Rust has excellent error-handling and error tracing. When it comes to actually <em>reporting</em> the error to the CLI user, however, crates and their authors are mostly left to their own devices. I welcome other alternatives for performing this operation in a systematic, abstracted way.</p>
<p>EDIT: made example more concrete based on feedback in discussion.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">C-enhancement</span> added by @cbs228 on 2023-02-18 22:11</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2023-02-19 01:34</div>
            <div class="timeline-body"><p>Huh, doesn't look like this has come up before.  I suspect its because most people are relying on the terminal width and just using wrapping for clean indentation for argument descriptions or if they care about max_term_width, their errors just aren't hitting that enough to notice.</p>
<p>How much of your example is artificaly (e.g. the text is)?  Like, is that width artificial?  What I'm interested in is ascertaining the impact of this problem.  What would be helpful to know is what you are setting the term width to, why you are setting it to that, and what your errors look like with and without it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">S-waiting-on-decision</span> added by @epage on 2023-02-19 01:34</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">A-help</span> added by @epage on 2023-02-19 01:34</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/cbs228">@cbs228</a> on 2023-02-19 02:14</div>
            <div class="timeline-body"><blockquote>
<p>Like, is that width artificial?</p>
</blockquote>
<p>Yes, the width in the example is artificial. It is merely to demonstrate on Playground that <code>--help</code> is wrapped but that errors are not. In reality, I would probably use a <code>max_term_width</code> of 100 or so.</p>
<p>The example output stderr is</p>
<pre><code class="language-txt">error: Lorem ipsum dolor sit amet, consectetur adipiscing elit. Nullam pellentesque vehicula purus at lobortis. Class aptent taciti sociosqu ad litora torquent per conubia nostra, per inceptos himenaeos. In porta facilisis commodo. Etiam consectetur dui vitae varius finibus. Nunc a urna urna. Nullam a porta tellus. Nulla eu ipsum vitae felis ornare pretium. Sed ornare, sem ac tempus vestibulum, est turpis congue lectus, nec vulputate est ipsum vitae ante.
</code></pre>
<p>Terminals will of course dutifully wrap long lines, but the wrapping is dumb and can split words.</p>
<p>The above example might be &quot;better&quot; as</p>
<pre><code class="language-txt">error: Lorem ipsum dolor sit amet, 
consectetur adipiscing elit. Nullam 
pellentesque vehicula purus at 
lobortis. Class aptent taciti sociosqu 
ad litora torquent per conubia nostra, 
per inceptos himenaeos. In porta 
facilisis commodo. Etiam consectetur 
dui vitae varius finibus. Nunc a urna 
urna. Nullam a porta tellus. Nulla eu 
ipsum vitae felis ornare pretium. Sed 
ornare, sem ac tempus vestibulum, est 
turpis congue lectus, nec vulputate est 
ipsum vitae ante.
</code></pre>
<p>Here &quot;better&quot; is error text which is wrapped to the terminal width or the <code>max_term_width</code>.</p>
<p>Most error messages won't be long enough to need wrapping on reasonably-sized terminals (i.e., wider than half a punch-card). I'm not sure that any of clap's built-in errors get that long. In my actual use-case, my error message gets a bit long-winded because it provides advice on how to correct the error condition.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2023-02-19 02:25</div>
            <div class="timeline-body"><blockquote>
<p>Lorem ipsum</p>
</blockquote>
<p>FYI I'm looking for more concrete use cases.  I brought up the artifical 40 but using lorem ipsum also keeps this conversation less concrete.</p>
<blockquote>
<p>my error message gets a bit long-winded because it provides advice on how to correct the error condition.</p>
</blockquote>
<p>Is there a reason you are putting the advice in the same paragraph?  Seems like that would be best to split out.  You also could format the error according to some only-documented-in-code rules and use clap's advice formatting.</p>
<p>Also, this is why I am looking for concrete examples, so we can look at the problem holistically and not just one narrow angle of it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/cbs228">@cbs228</a> on 2023-02-19 03:10</div>
            <div class="timeline-body"><blockquote>
<p>Is there a reason you are putting the advice in the same paragraph?</p>
</blockquote>
<p>It is split out into its own paragraph, but terminals do not break long lines of text neatly. The actual error message I am printing is:</p>
<pre><code class="language-rs">const ERR : &amp;str = &quot;error: cowardly refusing to read audio samples from a terminal.\n\nPipe a source of raw uncompressed audio from sox, parec, rtl_fm, or similar into this program.&quot;;
</code></pre>
<p>The second line is 94 characters wide. My terminal's current width is 91 characters, which leads to ugly output:</p>
<pre><code class="language-txt">Pipe a source of raw uncompressed audio from sox, parec, rtl_fm, or similar into this progr
am.
</code></pre>
<blockquote>
<p>You also could format the error according to some only-documented-in-code rules</p>
</blockquote>
<p>Can you point me in the right direction for these rules?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2023-02-23 18:25</div>
            <div class="timeline-body"><blockquote>
<p>It is split out into its own paragraph, but terminals do not break long lines of text neatly. The actual error message I am printing is:</p>
</blockquote>
<p>Thanks for the example!</p>
<blockquote>
<p>Can you point me in the right direction for these rules?</p>
</blockquote>
<p>Check out the source for <a href="https://github.com/clap-rs/clap/blob/master/src/error/format.rs#L54"><code>RichFormatter</code></a> as it reads the <code>Error</code> data structure and formats the text.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/cbs228">@cbs228</a> on 2023-02-25 19:16</div>
            <div class="timeline-body"><p>I've seen the <code>RichFormatter</code>, but the existing functions for <a href="https://github.com/clap-rs/clap/blob/v4.1.6/src/builder/styled_str.rs#L112">wrapping text</a> are <code>pub(crate)</code>. There doesn't appear to be any way to get at them or to express the &quot;this should be wrapped&quot; intent.</p>
<p>I could write a custom formatter which performs its own terminal queries and wrapping, without clapâ€¦ but at that point it would probably be more efficient to not involve clap in my error-printing process at all.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/epage">@epage</a> on 2023-02-26 02:04</div>
            <div class="timeline-body"><p><code>StyledStr::wrap</code> will remain private for now as we continue to work out what the <code>StyledStr</code> API will be.  I've started back on improving <code>StyledStr</code>, so hopefully in the next couple of months we;'ll have a better idea of where it is at.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 12:31:49 UTC
    </footer>
</body>
</html>
