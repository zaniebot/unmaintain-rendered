<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>feat(complete): Add dynamic completion for nushell - clap-rs/clap #5841</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>feat(complete): Add dynamic completion for nushell</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/clap-rs/clap/pull/5841">#5841</a>
        opened by <a href="https://github.com/chklauser">@chklauser</a>
        on 2024-12-11 23:31
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/chklauser">@chklauser</a> on 2024-12-11 23:31</div>
            <div class="timeline-body"><p>Adds an implementation of dynamic completion to <code>clap_complete_nushell</code> under the <code>unstable-dynamic</code> feature flag. Corresponding issue #5840. The issue description has more context and a more complete solution sketch. This PR doesn't implement the full solution sketched there. Ideally, we'd first agree that that solution is the way to go.</p>
<p>With this PR (and the <code>unstable-dynamic</code> feature flag), clap tools can generate a nushell module that offers three commands:</p>
<ul>
<li><code>complete</code>, which performs the actual completion</li>
<li><code>handles</code>, which asks the module whether it is the correct  completer for a particular command line</li>
<li><code>install</code>, which globally registers a completer that falls back to whatever completer was previously installed if <code>handles</code> rejects completing a command line.</li>
</ul>
<p>The idea is that user's who already have a custom external completer can integrate the generated module's <code>handles</code> and <code>complete</code> commands into their completer.</p>
<p>Everyone else just puts</p>
<pre><code class="language-nushell">use my-app-completer.nu
my-app-completer install
</code></pre>
<p>into their nushell config.</p>
<p>To test it, I have integrated it into a local build of the relatively complex clap-based tool, <a href="https://github.com/martinvonz/jj">JJ (Jujutsu)</a>, and it worked very well so far.</p>
<h1>TODO</h1>
<ul>
<li>[ ] Consensus for solution</li>
<li>[ ] Automated tests</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/epage">@epage</a> reviewed on 2025-10-24 00:41</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/epage">@epage</a> on <code>clap_complete_nushell/src/dynamic.rs</code>:20 on 2025-10-24 00:41</div>
            <div class="timeline-body"><p>nit: prefer grouping by std, external, internal</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/epage">@epage</a> on <code>clap_complete_nushell/src/dynamic.rs</code>:82 on 2025-10-24 00:41</div>
            <div class="timeline-body"><p>nit: prefer newline between items</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/epage">@epage</a> reviewed on 2025-10-24 00:41</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/epage">@epage</a> reviewed on 2025-10-24 00:42</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/epage">@epage</a> on <code>clap_complete_nushell/src/dynamic.rs</code>:81 on 2025-10-24 00:42</div>
            <div class="timeline-body"><p>Please put the top-level item at the top of the file</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/epage">@epage</a> reviewed on 2025-10-24 00:43</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/epage">@epage</a> on <code>clap_complete_nushell/src/dynamic.rs</code>:81 on 2025-10-24 00:43</div>
            <div class="timeline-body"><p>For <code>clap_complete</code>, we defined separate types.  Is there a reason you haven't done that here?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/epage">@epage</a> reviewed on 2025-10-24 00:43</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/epage">@epage</a> on <code>clap_complete_nushell/src/dynamic.rs</code>:81 on 2025-10-24 00:43</div>
            <div class="timeline-body"><p>Also, not a fan of trait impls being separated from the type they are a part of</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/epage">@epage</a> reviewed on 2025-10-24 00:44</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/epage">@epage</a> on <code>clap_complete_nushell/src/dynamic.rs</code>:87 on 2025-10-24 00:44</div>
            <div class="timeline-body"><p>How come this is case ignoring and accepting both names?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/epage">@epage</a> reviewed on 2025-10-24 00:46</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/epage">@epage</a> on <code>clap_complete_nushell/src/dynamic.rs</code>:115 on 2025-10-24 00:46</div>
            <div class="timeline-body"><p><code>args.len()</code> is a <code>usize</code>, so doing a <code>(usize - 1).max(0)</code>  isn't too meaningful.  You likely need <code>args.len().saturating_sub(1)</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/epage">@epage</a> reviewed on 2025-10-24 00:47</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/epage">@epage</a> on <code>clap_complete_nushell/src/dynamic.rs</code>:128 on 2025-10-24 00:47</div>
            <div class="timeline-body"><p>Why do we buffer before writing?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/epage">@epage</a> reviewed on 2025-10-24 00:48</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/epage">@epage</a> on <code>clap_complete_nushell/src/dynamic.rs</code>:98 on 2025-10-24 00:48</div>
            <div class="timeline-body"><p>Isn't that a <code>ModeVar(var).to_string()</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/epage">@epage</a> reviewed on 2025-10-24 00:49</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/epage">@epage</a> on <code>clap_complete_nushell/src/dynamic.rs</code>:99 on 2025-10-24 00:49</div>
            <div class="timeline-body"><p>Creating an internal environment variable in what is needing to be a public interface is something we'll need to consider more thoroughly</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/chklauser">@chklauser</a> reviewed on 2025-10-27 20:38</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/chklauser">@chklauser</a> on <code>clap_complete_nushell/src/dynamic.rs</code>:87 on 2025-10-27 20:38</div>
            <div class="timeline-body"><p>The primary motivation was the <a href="https://en.wikipedia.org/wiki/Robustness_principle">robustness principle</a> (and I'm well aware of the downsides/criticism of the principle). As a user of nu/nushell, I get the impression that they cannot make up their mind as to what the official name for their shell is. The binary and the repository are called <code>nu</code>, the website, social media accounts, etc. are all called <code>nushell</code></p>
<p>So the question is: what do we want people to type <code>COMPLETE=nu their-clap-binary</code> (to match the name of the binary/command used to launch nushell) or do we want people to type <code>COMPLETE=nushell their-clap-binary</code> (to match the marketing name for nushell)?</p>
<p>I personally tend towards <code>nushell</code>, but I don't have a very strong opinion.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/epage">@epage</a> reviewed on 2025-10-27 20:50</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/epage">@epage</a> on <code>clap_complete_nushell/src/dynamic.rs</code>:87 on 2025-10-27 20:50</div>
            <div class="timeline-body"><blockquote>
<p>The primary motivation was the <a href="https://en.wikipedia.org/wiki/Robustness_principle">robustness principle</a> (and I'm well aware of the downsides/criticism of the principle).</p>
</blockquote>
<p>In terms of case insensitivity, that is best left to a wider conversation on how we should handle this for all shells while this PR conforms to our existing practices.</p>
<p>As for names, so far we only accept the file stem stored in <code>SHELL</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/chklauser">@chklauser</a> reviewed on 2025-10-27 20:55</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/chklauser">@chklauser</a> on <code>clap_complete_nushell/src/dynamic.rs</code>:81 on 2025-10-27 20:55</div>
            <div class="timeline-body"><p>No, I simply didn't realize the types for dynamic completion were distinct from the aot ones. I'll create a separate type then.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/chklauser">@chklauser</a> reviewed on 2025-10-27 20:56</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/chklauser">@chklauser</a> on <code>clap_complete_nushell/src/dynamic.rs</code>:128 on 2025-10-27 20:56</div>
            <div class="timeline-body"><p>The crate I used to serialize JSON <a href="https://docs.rs/write-json/latest/write_json/fn.array.html">(write_json) only offers an API that takes a String</a>. If you'd rather avoid this buffering, we can go look for a an alternative way to serialize JSON (without going full serde)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/chklauser">@chklauser</a> reviewed on 2025-10-27 21:03</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/chklauser">@chklauser</a> on <code>clap_complete_nushell/src/dynamic.rs</code>:99 on 2025-10-27 21:03</div>
            <div class="timeline-body"><p>One alternative would be to re-use the <code>COMPLETE</code> variable. We could register two &quot;shells&quot; (or maybe dispatch based on the name used?)</p>
<p><code>COMPLETE=nushell your-clap-tool</code> generates the auto-update code; <code>COMPLETE=nushell-registration your-clap-tool</code> generates the actual integration code.</p>
<p>Seems a bit more of a hack on the one hand, but it would be safer in the sense that the two are mutually exclusive and in that we don't use some other, undocumented variable.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/epage">@epage</a> reviewed on 2025-10-27 21:04</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/epage">@epage</a> on <code>clap_complete_nushell/src/dynamic.rs</code>:128 on 2025-10-27 21:04</div>
            <div class="timeline-body"><p>Ugh.  We can probably pass for now.  Maybe we can eventually switch it to <a href="https://docs.rs/json-write/latest/json_write/trait.JsonWrite.html">json_write</a> (which I maintain) as it matures.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/epage">@epage</a> reviewed on 2025-10-27 21:08</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/epage">@epage</a> on <code>clap_complete_nushell/src/dynamic.rs</code>:99 on 2025-10-27 21:08</div>
            <div class="timeline-body"><p>Yeah, I want to switch all completions to a two-step process for #5668 and have been wondering about doing something like that.  This is all unstable so we can change it over time so we don't need to block on it but we will eventually need to figure it out.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/chklauser">@chklauser</a> reviewed on 2025-10-27 21:16</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/chklauser">@chklauser</a> on <code>clap_complete_nushell/src/dynamic.rs</code>:87 on 2025-10-27 21:16</div>
            <div class="timeline-body"><p>I saw that the powershell integration also uses <code>powershell</code> (instead of the binary name <code>pwsh</code>) =&gt; I'll change it to just match <code>nushell</code> (case sensitive)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/epage">@epage</a> on <code>clap_complete_nushell/src/dynamic.rs</code>:87 on 2025-10-27 21:22</div>
            <div class="timeline-body"><p>That is again related to the <code>SHELL</code> lookup (#4447).  If that is incorrect, then that is a bug.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/epage">@epage</a> reviewed on 2025-10-27 21:22</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/epage">@epage</a> reviewed on 2025-10-28 15:58</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/epage">@epage</a> on <code>clap_complete_nushell/src/dynamic.rs</code>:87 on 2025-10-28 15:58</div>
            <div class="timeline-body"><p>To re-iterate differently, since <code>SHELL</code> would end up pointing to <code>nu</code>, that is the name we should use</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/epage">@epage</a> reviewed on 2025-10-28 15:59</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/epage">@epage</a> on <code>clap_complete_nushell/src/dynamic.rs</code>:22 on 2025-10-28 15:59</div>
            <div class="timeline-body"><p>Please don't comment the groupings</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/epage">@epage</a> on <code>clap_complete_nushell/src/lib.rs</code>:31 on 2025-10-28 16:02</div>
            <div class="timeline-body"><p>Is this still needed?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/epage">@epage</a> reviewed on 2025-10-28 16:02</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/epage">@epage</a> reviewed on 2025-10-28 16:03</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/epage">@epage</a> on <code>clap_complete_nushell/src/dynamic.rs</code>:26 on 2025-10-28 16:03</div>
            <div class="timeline-body"><p>Is there a reason you have all of these traits implemented?</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 01:36:27 UTC
    </footer>
</body>
</html>
