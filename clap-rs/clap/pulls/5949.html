<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fix arbitrary-cardinality positionals shadowing option name completion - clap-rs/clap #5949</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Fix arbitrary-cardinality positionals shadowing option name completion</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/clap-rs/clap/pull/5949">#5949</a>
        opened by <a href="https://github.com/krobelus">@krobelus</a>
        on 2025-03-15 13:39
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/krobelus">@krobelus</a></div>
            <div class="timeline-body"><p>NOTE This text is outdated; see commit messages.</p>
<p>TODO: should double-check the root cause and add automated tests</p>
<p>jj dynamic completions of option names work as expected ...</p>
<pre><code>$ COMPLETE=fish jj -- jj abandon --ignore-
--ignore-working-copy
--ignore-immutable</code></pre>
<p>... unless there is a positional argument</p>
<pre><code>$ COMPLETE=fish jj -- jj abandon @ --ignore-</code></pre>
<p>The positional arguments are defined in the &quot;abandon&quot; subcommand as:</p>
<pre><code class="language-rust">#[derive(clap::Args, Clone, Debug)]
pub(crate) struct AbandonArgs {
    /// The revision(s) to abandon (default: @)
    #[arg(
        value_name = &quot;REVSETS&quot;,
        add = ArgValueCandidates::new(complete::mutable_revisions)
    )]
    revisions_pos: Vec&lt;RevisionArg&gt;,
}
</code></pre>
<p>After clap_complete sees the first positional argument (&quot;@&quot;) we are stuck
in &quot;ParseState::Pos(..)&quot; even when we get to parsing &quot;--ignore-&quot;.  This is
because &quot;revisions_pos&quot; accepts an arbitrary number of positionals.</p>
<p>While in &quot;ParseState::Pos(..)&quot;, we only produce completions for positionals
(via &quot;complete_arg_value()&quot;).  This means we fail to produce option-name
completions like &quot;--ignore-immutable&quot;.</p>
<p>This was introduced in f0bd4750 (feat(clap_complete): Support
multi-values of positional argument with <code>num_arg(N)</code>, 2024-07-26).
Presumably, the main intention of that commit was to allow options
with multiple, but finitely many arguments.</p>
<p>For the case where arbitrarily many arguments are allowed, let's get rid of
this restriction, to fix the false negative.</p>
<p>Ref: https://github.com/fish-shell/fish-shell/pull/11046#discussion_r1921501251</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/krobelus">@krobelus</a> reviewed on 2025-03-16 17:51</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/krobelus">@krobelus</a> on <code>clap_complete/src/engine/complete.rs</code>:636 on 2025-03-16 17:51</div>
            <div class="timeline-body"><p>cc @shannmu @epage</p>
<p>FWIW the interpretation of <em>positional</em> that have <code>num_args&gt;1</code> seems a
bit weird. I have never seen a CLI that uses them <em>and</em> disallows
interspersing it with options. But I guess I don't super care.</p>
<p>I mainly care about getting this bug fixed - let me know what I can do.</p>
<p>I'm pushing a more narrow fix that figures out whether our
multi-arg-positional is allowed to be non-contiguous (i.e. interspersed
with options).  The derived <code>Vec</code> above is one example.</p>
<p>Maybe the criteria can check max_value==infinity but the behavior
of max_value=infinity is super odd: it kinda supports non-contiguous
positionals but also not. Given</p>
<pre><code class="language-rust">fn main() {
    use clap;
    clap::Command::new(&quot;dynamic&quot;)
        .arg(
            clap::Arg::new(&quot;positional&quot;)
                .value_parser([&quot;pos_a&quot;, &quot;pos_b&quot;, &quot;pos_c&quot;])
                .index(1)
                .num_args(2..),
        )
        .arg(
            clap::Arg::new(&quot;--format&quot;)
                .long(&quot;format&quot;)
                .short('F')
                .value_parser([&quot;json&quot;, &quot;yaml&quot;, &quot;toml&quot;]),
        )
        .get_matches();
}
</code></pre>
<p>More than two arguments can be collected even with options interspersed.
But each run of arguments needs to have at least two:</p>
<pre><code>$ my-app pos_a pos_a --format=json pos_a pos_a
$ my-app pos_a --format json pos_a pos_a
error: 2 values required by '[positional] [positional]...'; only 1 was provided</code></pre>
<p>And if I replace <code>2..</code> with <code>2</code>, the first one weirdly no longer works:</p>
<pre><code>$ my-app pos_a pos_a --format=json pos_a pos_a
error: the argument '[positional] [positional]' cannot be used multiple times</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/epage">@epage</a> reviewed on 2025-03-17 16:01</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/epage">@epage</a> on <code>clap_complete/src/engine/complete.rs</code>:636 on 2025-03-17 16:01</div>
            <div class="timeline-body"><p>Adding new <code>Arg</code> settings are not something done lightly and if a proposal is to have that, an issue should be made first that makes a clear case for the problem being solved, why it is needed, and what the full semantics should be.</p>
<p>And in fact, it shouldn't be needed here.  <code>.action(Set).num_args(..)</code> is contiguous and <code>action(Append).num_args(..)</code> is non-contiguous.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/krobelus">@krobelus</a> reviewed on 2025-03-17 17:41</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/krobelus">@krobelus</a> on <code>clap_complete/src/engine/complete.rs</code>:636 on 2025-03-17 17:41</div>
            <div class="timeline-body"><blockquote>
<p>if a proposal is to have that, an issue should be made first that makes a clear case for the problem being solved</p>
</blockquote>
<p>I'm not trying to add a new feature, I only want to fix the regression.
I don't expect an issue would have helped me achieve my goal.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/epage">@epage</a> reviewed on 2025-03-17 17:59</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/epage">@epage</a> on <code>clap_complete/src/engine/complete.rs</code>:636 on 2025-03-17 17:59</div>
            <div class="timeline-body"><blockquote>
<p>I'm not trying to add a new feature,</p>
</blockquote>
<p>Like it or not, <code>Arg::non_contiguous</code> is a new feature.</p>
<blockquote>
<p>I don't expect an issue would have helped me achieve my goal.</p>
</blockquote>
<p>Our general expectation is that Issues should be made and accepted before moving on to PRs.  Frequently, we've seen</p>
<ul>
<li>People waste time by going with solutions that don't align with the project</li>
<li>Issues lost track of because a PR gets abandoned which contained the only report</li>
<li>Information fragmented as a contributor switches between PRs or they abandon an effort and someone else picks it up</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/epage">@epage</a> reviewed on 2025-03-17 18:08</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/epage">@epage</a> on <code>clap_complete/tests/testsuite/engine.rs</code>:694 on 2025-03-17 18:08</div>
            <div class="timeline-body"><p>Why is <code>required</code> added?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/epage">@epage</a> reviewed on 2025-03-17 18:10</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/epage">@epage</a> on <code>clap_complete/tests/testsuite/engine.rs</code>:698 on 2025-03-17 18:10</div>
            <div class="timeline-body"><p>The values were chosen to make it obvious which positional argument they are associated with.  If you are reusing this test, we should probably change things to make that clearer, like adding a refactor commit before this one that changes the values to <code>pos_&lt;num&gt;_&lt;letter&gt;</code> so <code>positional</code> has <code>[&quot;pos_1_a&quot;]</code>, <code>positional-2</code> has <code>[&quot;pos_2_a&quot;, &quot;pos_2_b&quot;]</code>.</p>
<p>Then in this commit, you'd have <code>[&quot;pos_3_a&quot;, &quot;pos_3_b&quot;]</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/epage">@epage</a> on <code>clap_complete/src/engine/complete.rs</code>:636 on 2025-03-17 18:11</div>
            <div class="timeline-body"><p>Also, I forgot that I added to the builder the automatic use of <code>Append</code> for unbounded <code>num_args</code>.  So unbounded positionals are always non-contiguous.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/epage">@epage</a> reviewed on 2025-03-17 18:11</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/epage">@epage</a> on <code>clap_complete/tests/testsuite/engine.rs</code>:793 on 2025-03-17 18:12</div>
            <div class="timeline-body"><p>The old test specifically had a case to verify that there was nothing more to complete.  We lose that by extending this test.  Instead, can you add a separate test for unbounded positionals?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/epage">@epage</a> reviewed on 2025-03-17 18:12</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/epage">@epage</a> reviewed on 2025-03-17 18:13</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/epage">@epage</a> on <code>clap_complete/tests/testsuite/engine.rs</code>:831 on 2025-03-17 18:13</div>
            <div class="timeline-body"><p>We should also have test cases for</p>
<ul>
<li><code>&quot;pos_1 pos_a pos_b pos_c pos_d [TAB]&quot;</code></li>
<li><code>&quot;pos_1 pos_a pos_b pos_c pos_d --format json [TAB]&quot;</code></li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/epage">@epage</a> reviewed on 2025-03-17 18:14</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/epage">@epage</a> on <code>clap_complete/tests/testsuite/engine.rs</code>:793 on 2025-03-17 18:14</div>
            <div class="timeline-body"><p>(in doing this, we'd make <code>positional-2</code> unbounded)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/krobelus">@krobelus</a> reviewed on 2025-03-17 20:12</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/krobelus">@krobelus</a> on <code>clap_complete/src/engine/complete.rs</code>:636 on 2025-03-17 20:12</div>
            <div class="timeline-body"><p>Are you seriously suggesting I should have created an issue?
I have lots of points on this but I guess I'll try not to waste everyone's time.</p>
<p>Another general expectation is &quot;you broke it, you fix it&quot;</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/krobelus">@krobelus</a> reviewed on 2025-03-17 20:12</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/krobelus">@krobelus</a> on <code>clap_complete/tests/testsuite/engine.rs</code>:694 on 2025-03-17 20:12</div>
            <div class="timeline-body"><p>no idea</p>
<pre><code>thread 'engine::suggest_multi_positional' panicked at clap_builder/src/builder/debug_asserts.rs:570:9:
Positional argument `[positional-3] [positional-3]...` *must* have `required(true)` or `last(true)` set because a prior positional argument (`&lt;positional-2&gt; &lt;positional-2&gt; &lt;positional-2&gt;`) has `num_args(1..)`
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/krobelus">@krobelus</a> reviewed on 2025-03-17 20:15</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/krobelus">@krobelus</a> on <code>clap_complete/tests/testsuite/engine.rs</code>:694 on 2025-03-17 20:15</div>
            <div class="timeline-body"><p>I guess if I create a second test I am not forced to find out what's going on. The error message is contradictory for sure</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/krobelus">@krobelus</a> reviewed on 2025-03-17 20:27</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/krobelus">@krobelus</a> on <code>clap_complete/tests/testsuite/engine.rs</code>:831 on 2025-03-17 20:27</div>
            <div class="timeline-body"><p>well tests show my change is broken</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/krobelus">@krobelus</a> reviewed on 2025-03-17 20:27</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/krobelus">@krobelus</a> on <code>clap_complete/tests/testsuite/engine.rs</code>:831 on 2025-03-17 20:27</div>
            <div class="timeline-body"><p>I guess I have to figure this out myself?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/epage">@epage</a> reviewed on 2025-03-17 20:56</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/epage">@epage</a> on <code>clap_complete/src/engine/complete.rs</code>:636 on 2025-03-17 20:56</div>
            <div class="timeline-body"><blockquote>
<p>Are you seriously suggesting I should have created an issue?</p>
</blockquote>
<p>Yes.  Consider that your first solution wasn't going to be accepted and your second solution was found to have holes in it.  This is the kind of thing we can talk through before putting in time.  Or I might have jumped in and just fixed it.</p>
<blockquote>
<p>Another general expectation is &quot;you broke it, you fix it&quot;</p>
</blockquote>
<p>Sometimes that works, but sometimes contributors aren't still around to take care of that.  This is open source where people give what they can and putting pressure on contributors like that can burn them out fairly quickly.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/epage">@epage</a> on <code>clap_complete/tests/testsuite/engine.rs</code>:831 on 2025-03-17 21:03</div>
            <div class="timeline-body"><blockquote>
<p>I guess I have to figure this out myself?</p>
</blockquote>
<p>Thats up to you.</p>
<p>imo the crux of this problem is that for variable <code>num_args</code>, it is both valid to have a positional <em>and</em> a flag.  <code>complete_arg</code>s <a href="https://github.com/clap-rs/clap/blob/master/clap_complete/src/engine/complete.rs#L248-L255"><code>ParseState::Pos</code></a> should take that into account.  Just copying the code over could end up making things messy, so a separate refactor of some kind should probably done first once we understand what the final state of the function should look like.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/epage">@epage</a> reviewed on 2025-03-17 21:03</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/krobelus">@krobelus</a> reviewed on 2025-03-17 21:24</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/krobelus">@krobelus</a> on <code>clap_complete/tests/testsuite/engine.rs</code>:831 on 2025-03-17 21:24</div>
            <div class="timeline-body"><blockquote>
<p>Thats up to you.</p>
</blockquote>
<p>I have a preference for someone else doing it</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/krobelus">@krobelus</a> reviewed on 2025-03-17 22:56</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/krobelus">@krobelus</a> on <code>clap_complete/tests/testsuite/engine.rs</code>:831 on 2025-03-17 22:56</div>
            <div class="timeline-body"><p>LMK if you can do it in reasonable time (like a week) else I'll try to</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/krobelus">@krobelus</a> reviewed on 2025-03-19 07:48</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/krobelus">@krobelus</a> on <code>clap_complete/tests/testsuite/engine.rs</code>:831 on 2025-03-19 07:48</div>
            <div class="timeline-body"><p>any response?
I'm not sure what are the conventions of this project</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/epage">@epage</a> reviewed on 2025-03-19 12:43</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/epage">@epage</a> on <code>clap_complete/tests/testsuite/engine.rs</code>:831 on 2025-03-19 12:43</div>
            <div class="timeline-body"><p>I'll possibly get to it.</p>
<p>Thanks for opening the issue</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/krobelus">@krobelus</a> reviewed on 2025-03-19 16:00</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/krobelus">@krobelus</a> on <code>clap_complete/tests/testsuite/engine.rs</code>:831 on 2025-03-19 16:00</div>
            <div class="timeline-body"><blockquote>
<p>Just copying the code over could end up making things messy, so a separate refactor of some kind should probably done first</p>
</blockquote>
<p>Are you saying that code clones are bad? Okay. I'm very sorry that you think you have to say that</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/epage">@epage</a> on <code>clap_complete/tests/testsuite/engine.rs</code>:685 on 2025-03-19 16:56</div>
            <div class="timeline-body"><p>Please either revert this commit or switch to what I suggested in https://github.com/clap-rs/clap/pull/5949#discussion_r1999363225</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/epage">@epage</a> reviewed on 2025-03-19 16:56</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/epage">@epage</a> reviewed on 2025-03-19 16:58</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/epage">@epage</a> on <code>clap_complete/src/engine/complete.rs</code>:160 on 2025-03-19 16:58</div>
            <div class="timeline-body"><p>The other intermediate completion functions return a <code>Vec</code>. The performance of doing so here is unlikely to make a difference such that we should probably do so here</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/epage">@epage</a> reviewed on 2025-03-19 17:55</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/epage">@epage</a> on <code>clap_complete/src/engine/complete.rs</code>:168 on 2025-03-19 17:55</div>
            <div class="timeline-body"><p>This works by happenstance for the current test cases but isn't the actual condition we should be checking for.  If <code>num_args(3..=10)</code>, then after <code>3</code> values, we should also report options.</p>
<p>We need to check if we have exceeded the minimum number of arguments for the positional.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/epage">@epage</a> reviewed on 2025-03-19 17:56</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/epage">@epage</a> on <code>clap_complete/src/engine/complete.rs</code>:168 on 2025-03-19 17:56</div>
            <div class="timeline-body"><p>Actually, the current test cases demonstrate this bug.  <code>&quot;pos_1 [TAB]&quot;</code> hasn't met the minimum of <code>2</code> yet, and so should only report positionals.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/epage">@epage</a> on <code>clap_complete/tests/testsuite/engine.rs</code>:685 on 2025-03-19 20:57</div>
            <div class="timeline-body"><p>In the scenario I gave, we would still have multiple options for <code>positional-1</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/epage">@epage</a> reviewed on 2025-03-19 20:57</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/epage">@epage</a> reviewed on 2025-03-19 21:00</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/epage">@epage</a> on <code>clap_complete/tests/testsuite/engine.rs</code>:685 on 2025-03-19 21:00</div>
            <div class="timeline-body"><p>Eh, minor enough at this point</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:49:45 UTC
    </footer>
</body>
</html>
