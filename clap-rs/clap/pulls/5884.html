<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teach dynamic fish completions to expand variables - clap-rs/clap #5884</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Teach dynamic fish completions to expand variables</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/clap-rs/clap/pull/5884">#5884</a>
        opened by <a href="https://github.com/krobelus">@krobelus</a>
        on 2025-01-19 09:44
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/krobelus">@krobelus</a> on 2025-01-19 09:44</div>
            <div class="timeline-body"><p>In fish, the command line</p>
<pre><code>cargo b --manifest-path $PWD/clap_complete/Cargo.toml --example</code></pre>
<p>wrongly gets example-name completions from $PWD/Cargo.toml instead of
$PWD/clap_complete/Cargo.toml.</p>
<p>This is because fish's &quot;commandline --tokenize&quot; option produces tokens
like &quot;$PWD/clap_complete/Cargo.toml&quot;, which clap cannot see through.</p>
<p>Starting in the upcoming fish version 4, there is a new option,
&quot;--tokens-expanded&quot;<a href="https://github.com/fish-shell/fish-shell/pull/10212">^1</a> to output the expanded arguments, matching
what the program would see during execution.</p>
<p>If an expansion of a token like {1,2,3}{1,2,3} would produce too
many results, the unexpanded token is forwarded, thus falling back to
existing behavior. Similarly, command substitutions (&quot;$()&quot;) present
on the command line are forwarded as-is, because they are not deemed
safe to expand given that the user hasn't agreed to running them.</p>
<p>Use this option if available, to fix the above example.</p>
<p>I have not checked if any existing clap user tries to expand variables
on their own. If this is a real possibility, we could let users
opt into the new behavior.</p>
<p>While at it, break up this overlong line.  Add redundant semicolons,
in case a preexisting completion accidentally joins these lines with
spaces<a href="https://github.com/fish-shell/fish-shell/pull/11046#discussion_r1917875912">^2</a>, like</p>
<pre><code>if set -l completions (COMPLETE=fish myapp 2&gt;/dev/null)
	echo &quot;$completions&quot; | source
end</code></pre>
<p>I have not updated clap_complete/tests/snapshots/register_dynamic.fish
(not sure how?) or tested this but I'm happy to do so.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/epage">@epage</a> reviewed on 2025-01-20 15:25</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/epage">@epage</a> on <code>clap_complete/src/env/shells.rs</code>:233 on 2025-01-20 15:25</div>
            <div class="timeline-body"><p>Could you split this into two commits</p>
<ol>
<li>Reformats the output</li>
<li>Adds the new flag</li>
</ol>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/epage">@epage</a> reviewed on 2025-01-20 15:26</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/epage">@epage</a> on <code>clap_complete/src/env/shells.rs</code>:233 on 2025-01-20 15:26</div>
            <div class="timeline-body"><p>Could you add a test for this?</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 01:36:27 UTC
    </footer>
</body>
</html>
